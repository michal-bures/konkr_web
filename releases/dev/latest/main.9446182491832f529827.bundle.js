(()=>{var e,t={57680:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScalingPOC=t.TestScene=void 0;const s=i(60925),n=i(91025),a=i(47038),o=i(11930),r=i(68736),c=i(97866),l=i(88865),d=i(58592);class h extends r.BaseUIScene{constructor(){super({key:"testScene"}),this.preUpdate=(0,c.whenDirty)((()=>{this.contentAreaRectangle.setOrigin(0,0).setPosition(this.bounds.contentLeft,0).setSize(this.bounds.contentWidth,this.bounds.height);const e=this.cameras.main;l.inject.debugData.set("game.device",`\n  screenWidth/Height=${d.app.device.screenHeight}x${d.app.device.screenWidth}\nBaseUiScene.bounds:\n  width/height=${this.bounds.width}x${this.bounds.height}\n  center=${this.bounds.centerX},${this.bounds.centerY}\n  contentArea=${this.bounds.contentLeft}-${this.bounds.contentRight} (width ${this.bounds.contentWidth})\nCamera:\n zoom=${e.zoom}\n x,y=${e.x},${e.y}\n size=${e.width}x${e.height}\n worldView=from ${e.worldView.x},${e.worldView.y} size ${e.worldView.width}x${e.worldView.height}\n`)}))}create(){super.create(),this.contentAreaRectangle=this.add.rectangle().setStrokeStyle(4,65280)}}t.TestScene=h,t.ScalingPOC=class{constructor(){this.initialized=!1}getScenes(){return[s.PreloadScene,h,a.DebugScene]}run(){l.inject.events.on(n.SystemEvents.EngineInitialized,(()=>{d.app.game.scene.run(o.Scenes.Debug),d.app.game.scene.run("testScene"),l.inject.debugData.set("---------------","")})),this.initialized=!0}}},97060:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.selectStrategy=t.AIController=t.MIN_WAR_SUPPORT_THRESHOLD=void 0;const s=i(48500),n=i(79516),a=i(97654),o=i(35895),r=i(88865),c=i(47610),l=i(91025),d=i(97197),h=s.logger.for("ai:controller");function u(e){return a.defaultStrategy}t.MIN_WAR_SUPPORT_THRESHOLD=15,t.AIController=class{constructor(){this.dataLayer=new o.DefaultAIDataLayer,this.allowSurrender=!0,this.debug=!1}async play(e){r.inject.events.trigger(l.SystemEvents.FactionAiBegin({factionId:e.id})),this.gameController=r.inject.gameStateController,r.inject.gameStateModel.stateEngine.activate(...c.EXPENSIVE_AI_PROJECTIONS),this.gameController.beginTransaction(),this.debug=!0===r.inject.config.debug.ai;const t=e.getRegions().filter((e=>e.isAlive())).sort(((e,t)=>e.hexes.length-t.hexes.length));for(let i of t){i.updateFrom(r.inject.gameStateController.currentState),r.inject.events.trigger(l.SystemEvents.RegionAiBegin({regionId:i.id}));const t=u();if(!i.exists)continue;r.inject.debugData.set("AI",`faction ${e.id}, region ${i.id}`);const s=new n.RegionAIContext(i);s.maxAllowedUnitMight=this.maxAllowedUnitMight,s.debug=!0===r.inject.config.debug.ai||r.inject.config.debug.ai===i.id,h.info(`> AI playing region #${i.id}`);try{await t(s)}catch(e){if((0,d.isLevelSessionEndError)(e))return void h.warning("> AI interrupted by new session, aborting.");throw e}}const i=this.gameController.scheduledPlays.length;return this.gameController.commitTransaction(),r.inject.events.trigger(l.SystemEvents.FactionAiEnd({factionId:e.id})),i}},t.selectStrategy=u},35895:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateAttritionImpact=t.ApprovalShiftReason=t.DefaultAIDataLayer=t.DummyAIDataLayer=void 0;const s=i(30420),n=i(12678),a=i(23441),o=i(40108),r=i(20666),c=i(48500),l=i(47610),d=i(88865),h=i(91025),u=i(54812),p=i(1591),g=i(96486);var m;function y(e){const{from:t,to:i,mutator:s,reason:n}=e,a=t.approvalOf(i);o.AI.changeFactionApproval(t.state,t.id,i.id,s);const r=s(a);return h.GameStateEvents.FactionApprovalChanged({fromFactionId:t.id,towardsFactionId:i.id,oldApproval:a,newApproval:r,delta:r-a,reason:n})}function f({model:e,destroyedPawns:t,victimRegions:i,regionWasAlive:s,regionWasBankrupt:n}){if(s){const s=i.filter((e=>!e.isAlive())),o=i.filter((e=>e.isAlive())),r=t.map(v).reduce(a.sum,0),c=1+s.map((e=>e.size)).reduce(a.sum,0),l=s.map((t=>e.warfare.getUnitsByRegion(t).map(w).reduce(a.sum,0))).reduce(a.sum,0),d=function(e,t){e.sort(((e,t)=>e.size-t.size));const i=e.slice(1).map((e=>e.budget.incomeFromHexes)).reduce(a.sum,0)/10,s=e.filter((e=>e.isBankrupt()));return i+(t?0:s.map((e=>-1*e.budget.balance)).reduce(a.sum,0))}(o,n);return Math.floor(10*(c+r+l+d))}return 0}function w(e){return v(e.type)}function v(e){const t=d.inject.gameStateModel.rules.pawns(e);return t.hasTrait(r.PawnTraits.Unit)?t.upkeep:t.type===s.PawnType.Town?10:0}c.logger.for("AiDataLayer"),t.DummyAIDataLayer=class{onHexConquered(e){}onTurnEnd(e,t){}onTurnStart(e,t){}onReceivedGift(e){}},t.DefaultAIDataLayer=class{onHexConquered(e){const{model:t,attackerFaction:i,destroyedPawns:a,victimRegions:r,regionWasAlive:c,regionWasBankrupt:l,stateBeforeAttack:d}=e,h=[];(0,n.assert)(r.length>0,"victimRegions should never be empty");const w=r[0].faction;return w?.isNeutral()||!c?[]:(t.stateEngine.transaction((()=>{const n=o.AI.getFactionAttrition(t.state,i.id,w.id),a=r.filter((e=>e.isAlive())),l=f(e),v=(b=l,S=w.scaledPower,Math.ceil(b/(0,u.cropNumber)(S,1,10)*10));var b,S;a.length>0&&o.AI.inflictRegionAttrition(t.stateEngine.currentState,a.map((e=>e.id)),i.id,l),h.push(y({from:w,to:i,mutator:e=>function(e,t,i){let s=t;return t>0&&i>=10&&(s=Math.floor(t/(i/10+1))),s-=i,s}(0,e,v),reason:m.Attacked}));const x=o.AI.getFactionApproval(t.state,i.id,w.id);if(x>0&&c){const e=Math.max(0,x-v/2);h.push(y({from:i,to:w,reason:m.Attacking,mutator:()=>e}))}if(l>=10){const e=t.factions.all().filter((e=>e.controller!==s.FactionController.None&&e!==w&&e!==i&&e.isAlive()));for(let t of e){const e=(0,g.round)(p.AIPolitics.getApprovalReactionToThirdPartyConquest({stateBeforeAttack:d,attritionImpact:v,casusBeliStrength:n,victimFaction:w,attackerFaction:i,me:t}));0!==e&&h.push(y({from:t,to:i,mutator:t=>t+e,reason:m.ObservedAttack}))}}})),h)}onTurnEnd(e,t){if(t.controller===s.FactionController.None)return[];const i=[];return e.stateEngine.activate(...l.EXPENSIVE_AI_PROJECTIONS),e.stateEngine.transaction((()=>{!function(e,t){o.AI.changeFactionAttrition(e.state,t.id,(e=>Math.floor(.5*e)))}(e,t),i.push(...function(e,t){const i=[];return e.factions.all().filter((e=>e.controller!==s.FactionController.None&&e!==t&&e.isAlive())).forEach((e=>{i.push(y({from:e,to:t,mutator:()=>function(e,t){const i=e.state,s=e.approvalOf(t);let n=0;s>100&&(n-=(s-100)/2),s<-100&&(n-=(s+100)/2),n-=.1*Math.floor(s);const a=d.inject.views.behaviorSummary.get(i,t.id);if(a.mightUsedForConquest[e.id]>0)return s+n;if(0===a.totalMight)return s+n;const r=a.totalMightUsed/a.totalMight/2,c=a.unusedMight/a.totalMight*2,l=d.inject.views.factionNeighboursView.get(i,t.id)[e.id]??0,h=d.inject.views.fear.get(i,{fromFactionId:e.id,towardsFactionId:t.id}),p=h>0?1-(0,u.cropNumber)(h/100*e.aiPersonality.ambitious,0,1):1,g=o.AI.getFactionAttrition(i,e.id,t.id),m=g>0?(0,u.cropNumber)(1/(g-1),0,1):1,y=n+((f=(r+c)*l)<=20?f:20+Math.sqrt(f-20))*m*p;var f;return Math.floor(s+y)}(e,t),reason:m.EndOfTurnAdjustment}))})),i}(e,t))})),i}onTurnStart(e,t){}onReceivedGift(e){if(e.fromFaction===e.toFaction)return[];const t=5*e.giftValue/e.toFaction.powerFactors.economic,i=o.AI.getFactionAttrition(e.model.state,e.toFaction.id,e.fromFaction.id),s=(0,u.cropNumber)(200*t-i,0,50);return[y({from:e.toFaction,to:e.fromFaction,reason:m.ReceivedGift,mutator:e=>e+s})]}},function(e){e.EndOfTurnAdjustment="end-of-turn-adjustment",e.Attacked="attacked",e.ObservedAttack="observed-attack",e.Attacking="attacking",e.ReceivedGift="received-gift"}(m=t.ApprovalShiftReason||(t.ApprovalShiftReason={})),t.calculateAttritionImpact=f},57840:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.describeFrontline=t.createDefensePlanDebugLayer=t.createPlacementDebugLayer=t.createDebugLayer=t.Frontlines=void 0;const n=i(78179),a=i(16972),o=i(41707),r=i(88865),c=s(i(20504)),l=i(52937),d=i(48500),h=i(40108),u=i(85656),p=i(23441),g=i(42297),m=i(15496),y=s(i(54485)),f=i(88261),w=i(24794),v=i(54444),b=i(20666),S=i(30420),x=i(12678),T=i(98512),P=i(65955),M=i(29791),I=d.logger.for("Frontlines");var A;!function(e){e.safe="safe",e.frontline="frontline",e.vulnerable="vulnerable"}(A||(A={}));const C={defenseContribution:0,pestEradicationBonus:0,expansionBonus:0,total:0,orphansPenaltyMultiplier:1,exposedUnitPenaltyMultiplier:1,diplomacyMultiplier:1};function B(e){return{name:"frontline",onChange:(0,l.signal)(),getGroups:()=>e.state.groups.getGroups(),getMap(){let t=new a.CustomHexGroupValuation("");const i=e.state.groups.byKey(A.safe),s=e.state.groups.byKey(A.frontline);for(let s of i.hexes)t.set(s.id,e.state.alreadySecureHexes.has(s)?o.GLYPH.blueFlag:o.GLYPH.whiteFlag);for(let i of s.hexes)t.set(i.id,e.isSecure(i)?o.GLYPH.defense:o.GLYPH.redFlag);return t},getDetail:t=>e.state.groups.getOwnerOf(t)?.toString()}}function E(e,t){return{name:"frontline defender placement",onChange:(0,l.signal)(),getGroups:()=>[e.gap.without(n.HexGroup.from(e.coveredHexes))],getMap:()=>t.map((e=>e.total.toFixed(1))),getDetail:e=>(0,v.prettyPrintObject)(t.get(e.id))}}function R(e){return{name:"frontline defender placement",onChange:(0,l.signal)(),getGroups:()=>[e.gap],getMap(){let t=new a.CustomHexGroupValuation("");const i=e.safeHexes,s=e.gap;for(let e of i)t.set(e.id,o.GLYPH.whiteFlag);for(let e of s)t.set(e.id,o.GLYPH.defense);for(let[i,s]of Object.entries(e.plan))t.set(Number(i),`${s}${o.GLYPH.pawn}`);return t},getDetail(e){}}}t.Frontlines=class{constructor(e,t,i){this.context=e,this.views=t,this.defenseLevel=i,this.threatAssessment=t.threatAssessment,this.region=e.region,this.myAssets=m.RegionAssets.fromMyRegion(e.region),this.warfare=g.Warfare.model(e.state),this.regionAssetsValue=P.AssetValue.total(h.AI.getRegionAssetsValue(e.state,e.region.id)),this.availableMight=this.myAssets.getRemainingAvailableMight()}async calculate(){let e,t;this.initialSetup(),await this.updateDefendedHexes(),await this.breakpoint("initial setup");do{do{e=this.safeHexes.size,this.optimizeFrontline(),await this.breakpoint("optimized frontline"),t=this.safeHexes.size,e!==t&&(await this.updateDefendedHexes(),await this.breakpoint("updated defended hexes"))}while(e!==t);await this.saveCandidateFrontline(),await this.breakpoint("candidate frontline"),e=this.vulnerableHexes.size,await this.advanceFrontline(),t=this.vulnerableHexes.size}while(e!==t);I.debug(`CANDIDATES:\n${this.candidates.map((e=>{const t=((this.region.hexes.length-e.vulnerableHexes.length)/this.region.hexes.length*100).toFixed(0),i=(e.safeAssets/this.regionAssetsValue*100).toFixed(0);return` - ${e.gap.map((e=>e.id)).join(",")} to level ${e.toLevel} protects ${t}% hexes (${this.region.hexes.length-e.vulnerableHexes.length}/${this.region.hexes.length}) and ${i}% assets (${e.safeAssets}/${this.regionAssetsValue}), spending ${e.requiredMight} might`})).join("\n")}`);for(let e of this.candidates)await this.processCandidateFront(e)?await this.defensePlanBreakpoint(e,`frontlines: candidate plan L${e.toLevel} with score ${e.score}\ncost ${e.requiredMight} coverage ${this.region.hexes.length-e.vulnerableHexes.length} hexes, ${e.safeAssets} might`):await this.defensePlanBreakpoint(e,`frontlines: DISCARDED plan L${e.toLevel} with score ${e.score}\ncost ${e.requiredMight} coverage ${this.region.hexes.length-e.vulnerableHexes.length} hexes, ${e.safeAssets} might`);const i=this.bestFronts.peek();if(i){const e=i;await this.defensePlanBreakpoint(e,`frontlines: best plan L${e.toLevel} with score ${e.score}\ncost ${e.requiredMight} coverage ${this.region.hexes.length-e.vulnerableHexes.length} hexes, ${e.safeAssets} might`)}}scoreCandidate(e){if(0===e.requiredMight)return 0;const t=2===e.toLevel?20:5;return e.defendedHexes*t/e.requiredMight*(e.safeAssets/this.regionAssetsValue)*(e.finalAssets?T.AIMetrics.economyHealth(e.finalAssets,this.context.focus):1)}async breakpoint(e){"number"==typeof r.inject.config.debug.ai&&this.region.id!==r.inject.config.debug.ai||await r.inject.debugBreakpoint("frontlines: "+e,(()=>({debugLayer:B(this)})))}async defensePlanBreakpoint(e,t){"number"==typeof r.inject.config.debug.ai&&this.region.id!==r.inject.config.debug.ai||await r.inject.debugBreakpoint(t,(()=>({hexes:n.HexGroup.fromIds(Object.keys(e.plan).map((e=>Number(e)))),debugLayer:R(e)})))}async saveCandidateFrontline(){const e=1-this.vulnerableHexes.size/this.state.regionHexes.length;let t,i=new Set;for(let e of this.frontlineHexes)this.isSecure(e)||i.add(e);if(t=0===i.size?this.defenseLevel:0,0===i.size)return;const s=function(e){let t=0;return n.HexGroup.from(e).components().forEach((e=>t+=Math.ceil(e.size/3))),t}(i)*this.defenseLevel,a=this.region.hexes.without(n.HexGroup.from(this.vulnerableHexes));this.candidates.push({hexes:n.HexGroup.from(this.frontlineHexes),safeHexes:a,vulnerableHexes:n.HexGroup.from(this.vulnerableHexes),safeAssets:this.state.protectedAssetValue+this.state.alreadySecureAssetValue,defendedAssets:this.state.protectedAssetValue,defendedHexes:a.length-this.state.alreadySecureHexes.size,plan:{},finalAssets:null,fromLevel:0,toLevel:this.defenseLevel,requiredMight:s,coveredHexes:new Set,gap:n.HexGroup.from(i),score:100*e/(1+s)})}async processCandidateFront(e){const t=this.bestFronts.peek()?.score??0;if(2*this.scoreCandidate(e)<t)return;if(e.requiredMight*(2===e.toLevel?3:2)>=this.safeHexes.size)return;if(e.requiredMight>2*this.availableMight)return;if(1===e.toLevel&&3*e.requiredMight<2*this.myAssets.remainingUnits.countOf(1))return;const i=this,s=e.toLevel,n={};let a=e.gap.with(e.gap.neighbours()).filter((e=>h.AI.canPlaceDefenderAt(this.region.state,e,this.region,s)));const o=new Set(e.gap.toArray());let c=this.myAssets,l=0;const d=new f.HexGroupValuationWithHeap(C,(e=>-e.total));let u;for(p(a);u=await g();){x.assert.defined(c);const t=this.choosePawnType(u,s,e,c);if(!t)return;if(n[u.id]=t,c=t===S.PawnType.Castle?c.remainingIncome>=2?c.buildCastle({fortificationGain:M.Fortification.getDeltaAfterCastleBuilt(this.context.state,u.id)}):void 0:c.useUnit({requiredMight:s,allowNegativeIncome:!1,maxAllowedMight:r.inject.ai.maxAllowedUnitMight})?.assets,!c)return;if(c.remainingIncome<=0)return;e.coveredHexes.add(u),o.delete(u),l+=e.toLevel;const i=u.floodFillOut(((e,t,i)=>i<=2)).filter((e=>d.get(e.id).defenseContribution>0));for(let t of u.neighbours())e.coveredHexes.add(t),o.delete(t);for(let e of i)d.unset(e.id);p(i.filter((e=>o.has(e)||!!e.neighbours().find((e=>o.has(e))))))}return e.plan=n,e.requiredMight=l,e.finalAssets=c,e.score=this.scoreCandidate(e),this.bestFronts.push(e),n;function p(t){for(let s of t){const t=i.calculateDefenderPlacementScore(e,s);d.set(s.id,t)}}async function g(){const t=d.pop()?.id;if(void 0===t)return;const i=(0,w.getHex)(t);return await r.inject.debugBreakpoint(`frontlines: defensePlan ${e.fromLevel} -> ${e.toLevel}`,(()=>({hexes:(0,w.getHex)(i.id),debugLayer:E(e,d)}))),i}}choosePawnType(e,t,i,s){return 1===t?S.PawnType.Villager:2===t?g.Warfare.canBuildCastleAt(this.context.state,e,this.context.region.id)&&s.remainingGold>=20?S.PawnType.Castle:S.PawnType.Pikeman:void 0}calculateDefenderPlacementScore(e,t){const i=t.with(t.neighbours()).neighbours().filter((t=>e.gap.has(t)&&!e.coveredHexes.has(t)));let s=0;for(let t of i)t.neighbours().find((t=>e.gap.has(t)&&!e.coveredHexes.has(t)))||++s;const n=t.with(t.neighbours()).filter((e=>this.region.hexes.has(e))).map((t=>{if(e.coveredHexes.has(t))return 0;const i=this.warfare.getHexDefenseWithoutMovableUnits(t),s=this.threatAssessment.get(t.id).strongestUnit,n=(0,p.pickSmaller)(s,e.toLevel);return n<=i?0:(n-i)*(e.hexes.has(t)?1:.1)})),a=this.context.region.parentModel.byHex(t);let o,c;a!==this.region&&a?(o=(0,p.pickSmaller)(1,2*r.inject.views.hostility.get(this.context.state,{attackerContext:this.context,targetRegion:a})),c=.5):(o=1,c=0);const l=this.warfare.getOccupyingUnit(t)?.hasTrait(b.PawnTraits.Pest),d={expansionBonus:c,pestEradicationBonus:l?1:0,defenseContribution:n.reduce(p.sum,0),diplomacyMultiplier:o,exposedUnitPenaltyMultiplier:this.getExposedUnitPenalty(e,t),orphansPenaltyMultiplier:1/(1+s)};return{...d,total:(d.defenseContribution+d.pestEradicationBonus+d.expansionBonus)*d.diplomacyMultiplier*d.exposedUnitPenaltyMultiplier*d.orphansPenaltyMultiplier}}getExposedUnitPenalty(e,t){const i=e.toLevel;let s;return s=this.threatAssessment.get(t.id)?.riskByDefenderMight[i]??0,0===s||this.safeHexes.has(t)?1:g.Warfare.getHexStaticDefense(this.region.state,t.id)>0?.9:(0,p.pickLarger)(.5,1-s)}isSecure(e){const t=g.Warfare.getHexDefenseWithoutMovableUnits(this.region.state,e);return t>=this.defenseLevel||t>=this.threatAssessment.get(e.id).strongestUnit}initialSetup(){this.state={groups:new c.default,regionHexes:this.region.hexes,hostileBorderHexes:this.region.getHostileBorderHexes(),protectedAssetValue:0,alreadySecureHexes:new Set,alreadySecureAssetValue:0},this.candidates=[],this.bestFronts=new y.default(((e,t)=>t.score-e.score));const{groups:e,regionHexes:t,hostileBorderHexes:i}=this.state;for(let i of t)e.addToGroup(A.vulnerable,i);for(let e of this.region.getTownHexes())this.addToFrontline(e)}async updateDefendedHexes(){const{groups:e}=this.state,t=this.state.hostileBorderHexes.filter((t=>!!this.threatAssessment.get(t.id).strongestUnit&&!!this.isStillThreatened(t)&&e.getOwnerOf(t)===A.vulnerable)).floodFillOut((t=>e.getOwnerOf(t)===A.vulnerable)),i=n.HexGroup.from(e.byKey(A.vulnerable).hexes).without(t);this.addToSafeHexes(...i)}isStillThreatened(e){const t=e.neighbours((e=>!this.safeHexes.has(e)&&!this.frontlineHexes.has(e)));for(let i of t){const t=h.AI.getHexInfluence(this.region.state,i.id).entrySeq();for(let[s,n]of t)if(this.threatAssessment.get(e.id).regions.includes(s)&&!this.isAttackVectorPassingThroughFrontline(i,s))return!0}return!1}isAttackVectorPassingThroughFrontline(e,t,i=new Set){if(this.frontlineHexes.has(e))return!0;if(i.has(e))throw new Error(`Cycle detected while following influence vector of region ${t} passing through hex ${e.id}!`);i.add(e);const s=h.AI.getHexInfluence(this.context.state,e.id,t)?.parent;return!!s&&this.isAttackVectorPassingThroughFrontline(s,t,i)}addToSafeHexes(...e){this.countProtectedUnitsAndHexesFrom(e),this.state.groups.addToGroup(A.safe,...e)}countProtectedUnitsAndHexesFrom(e){for(let t of e){if(!this.vulnerableHexes.has(t))continue;const e=h.AI.getTotalHexAssetValue(this.region.state,t.id);this.isSecure(t)?(this.state.alreadySecureHexes.add(t),this.state.alreadySecureAssetValue+=e):this.state.protectedAssetValue+=e}}addToFrontline(...e){this.countProtectedUnitsAndHexesFrom(e),this.state.groups.addToGroup(A.frontline,...e)}optimizeFrontline(){const e=new Set(this.frontlineHexes),{groups:t,hostileBorderHexes:i}=this.state;for(;e.size>0;){const s=e[Symbol.iterator]().next().value;e.delete(s);const n=s.neighbours((e=>t.getOwnerOf(e)===A.vulnerable)),a=n.filter((e=>!this.isSecure(e))),o=n.filter((e=>this.isSecure(e)));if(o&&(this.addToFrontline(...o),o.forEach((t=>e.add(t)))),i.has(s)&&this.isStillThreatened(s));else if(0===n.length)this.addToSafeHexes(s);else if(0===a.length)n.forEach((e=>this.addToFrontline(e))),this.addToSafeHexes(s);else if(1===n.length){const t=n.first();this.isSecure(s)&&!this.isSecure(t)||(this.addToSafeHexes(s),this.addToFrontline(t),t.neighbours((e=>this.frontlineHexes.has(e))).forEach((t=>e.add(t))),e.add(t))}}}async advanceFrontline(){const{groups:e,hostileBorderHexes:t}=this.state,i=n.HexGroup.from(this.frontlineHexes).neighbours().filter((t=>e.getOwnerOf(t)===A.vulnerable)).components().map((e=>({hexes:n.HexGroup.from(e)}))).filter((({hexes:e})=>e.length>0)),s=(0,u.findMax)(i,(e=>e.hexes.members.reduce(((e,t)=>{const i=h.AI.getHexImportance(this.region.state,t.id);if(!i)return e;const s=i.value/(5+i.distanceFromTown);return(0,p.pickLarger)(e,s)}),0)));if(!s)return;await r.inject.debugBreakpoint("frontlines: to advance",(()=>({hexes:s.hexes,debugLayer:B(this)})));const a=s.hexes;a.members.filter((e=>this.frontlineHexes.has(e)&&this.isSecure(e))).forEach((e=>this.addToSafeHexes(e))),a.forEach((e=>this.addToFrontline(e)))}get frontlineHexes(){return this.state.groups.byKey(A.frontline).hexes}get safeHexes(){return this.state.groups.byKey(A.safe).hexes}get vulnerableHexes(){return this.state.groups.byKey(A.vulnerable).hexes}},t.createDebugLayer=B,t.createPlacementDebugLayer=E,t.createDefensePlanDebugLayer=R,t.describeFrontline=function(e){return`${e.toLevel}@${Object.keys(e.plan).join(",")}`}},86024:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getCostPerUnitOfMight=t.Marshal=void 0;const s=i(20666),n=i(91025),a=i(48500),o=i(30420),r=i(12678),c=i(15496),l=a.logger.for("ai:Marshal");t.Marshal=class{constructor(e){this.ctx=e,this.model=this.ctx.game.model}moveUnit(e,t){try{return this.tryMoveUnit(e,t),!0}catch(e){return l.warning(`Failed to execute plan ${(0,c.describePlan)(t)}: ${e.message}`),!1}}tryMoveUnit(e,t){const i=[...t.recipe];let s=null,a=e;for(let e of i)switch(e.action){case"buy":if(s)throw new Error("invalid recipe: two buy unit steps in a row");s=e.might;break;case"merge":const t=this.grabUnit(a,e.might);if(r.assert.defined(t,`invalid recipe: cannot find first unit with might ${e.might} for merge`),a=t.hex,s){if(e.might!==s)throw new Error(`invalid recipe: merge units of might ${e.might} cannot follow buying of unit with might ${s}`);const i=this.model.rules.unitByMight(s)?.type;if(!i)throw new Error(`invalid recipe: cannot buy unit with might ${s}`);this.ctx.addPlay(n.Plays.BuyPawn({pawnType:i,buyerRegionId:this.ctx.region.id,destinationHexId:t.hex.id,tapUnit:!1})),s=null}else{const i=this.grabUnit(a,e.might,t);r.assert.defined(i,`invalid recipe: cannot find second unit with might ${e.might} for merge`),this.ctx.addPlay(n.Plays.MovePawn({pawnId:i.id,destinationHexId:t.hex.id,tapUnit:!1}))}}if(s){(0,r.assert)(s===t.might,`invalid recipe: last step is buying unit with might ${s}, but required might is ${t.might}`);const i=this.model.rules.unitByMight(s)?.type;r.assert.defined(i,`invalid recipe: cannot buy unit with might ${s}`),this.freeUpHexIfObstructed(e),this.ctx.addPlay(n.Plays.BuyPawn({pawnType:i,buyerRegionId:this.ctx.region.id,destinationHexId:e.id,tapUnit:!0}),e)}else{const i=this.grabUnit(a,t.might);r.assert.defined(i,`invalid recipe: failed to find any unit with might ${t.might}`),this.ctx.addPlay(n.Plays.MovePawn({pawnId:i.id,destinationHexId:e.id,tapUnit:!0}),e)}return!0}grabUnit(e,t,i){const s=this.model.pawns.findClosest(e,this.ctx.region.hexes,(e=>e!==i&&this.model.currentPhase.isMovable(e)&&e.might===t));return s?.hex!==e&&i?.hex!==e&&this.freeUpHexIfObstructed(e),s}freeUpHexIfObstructed(e){if(this.model.regions.byHex(e)!==this.ctx.region)return!0;const t=this.model.pawns.findOne({hexes:e,traits:[s.PawnTraits.Unit]});if(t){const i=this.ctx.region.hexes.findClosest(e,(e=>!this.model.warfare.isOccupied(e)));return i?(this.ctx.addPlay(n.Plays.MovePawn({pawnId:t.id,destinationHexId:i.id,tapUnit:!1})),!0):(l.warning(`Unable to free up space for defender on hex ${e} - there's nowhere to move obstructing unit ${t}`),!1)}return!0}buildCastle(e,t){try{const i=this.model.rules.castleByMight(t).type;return!!this.freeUpHexIfObstructed(e)&&(this.ctx.addPlay(n.Plays.BuyPawn({pawnType:i,buyerRegionId:this.ctx.region.id,destinationHexId:e.id,tapUnit:!0})),!0)}catch(t){return l.warning(`Failed to build castle at ${e}: ${t.message}`),!1}}},t.getCostPerUnitOfMight=function(e){return e.rules.pawns(o.PawnType.Villager).cost}},79516:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createAiContext=t.RegionAIContext=void 0;const s=i(86024),n=i(48500),a=i(77874),o=i(88865),r=i(97654),c=i(97197);n.logger.for("ai:context");class l{get faction(){return this.region.faction}get state(){return this.game.currentState}constructor(e){this.region=e,this.game=o.inject.gameStateController,this.debug=!1,this.plays=[],this.marshal=new s.Marshal(this),this.abortWatcher=new c.LevelSessionEndWatcher,this.aiPersonality=this.region.faction.aiPersonality,this.focus=this.aiPersonality,this.blacklistedPlans=new Set,this.uniqueId=Math.random(),this.expansionTarget=0,this.forceAction=!1,this.initialRegionSize=e.size}isOffensiveActionRequired(){return this.forceAction&&this.initialRegionSize===this.region.size}async breakpoint(e,t=(()=>({}))){this.debug&&await o.inject.debugBreakpoint(e,(()=>({...t(),region:this.region})))}addPlay(e,t){this.plays.push({play:e,gameCheckpoint:this.game.createCheckpoint()}),this.game.executePlay(e),this.updateAfterStateChange()}updateAfterStateChange(){this.region.updateFrom(this.game.currentState)}}t.RegionAIContext=l,t.createAiContext=function(e){const t=new l(e),i=o.inject.views.situationScoreByRegion.getComponents({context:t,views:(0,a.createAiViews)(t)});return t.aiPersonality=(0,r.adjustPersonalityBasedOnSituation)(t,i),t.focus=t.aiPersonality,t}},77874:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createAiViews=t.SituationExplorer=void 0;const s=i(48500),n=i(7080),a=i(53190),o=i(88865),r=i(675),c=i(94621),l=i(3557),d=i(54444),h=s.logger.for("SituationExplorer");function u(e){const t=new n.ThreatAssessment(e.faction),i=new c.SecurityView({faction:e.faction,threatAssessment:t,recklessness:e.focus.daring},"planning");return{threatAssessment:t,planningSecurity:i,evaluationSecurity:new c.SecurityView({faction:e.faction,threatAssessment:t,recklessness:e.aiPersonality.daring},"evaluation"),conquestValue:new r.ConquestValue(e,{planningSecurity:i}),defenderBenefit:new l.DefenderBenefitView(e,i)}}t.SituationExplorer=class{constructor(e){this.context=e,this.situationStack=[],this.situationCache=new Map;const t=u(e);this.situationStack=[{label:"start",...e.game.createCheckpoint(),score:Number.NEGATIVE_INFINITY,views:t}],this.bestOutcomeSoFar=this.situationStack[0]}async tryBest(e,t){this.context.abortWatcher.throwIfAborted();let i=new a.CompositePlanner({allowedTactics:t});this.context.focus={...this.context.aiPersonality,daring:e},this.currentSituation.views.planningSecurity.setRecklessness(e),this.refreshViewsAffectedByFocus();const s=this.context.region.size-this.context.initialRegionSize;return await this.executeBestPlan(i,`CR ${e} EX ${s}/${this.context.expansionTarget}`)}async explore(e,t){this.context.abortWatcher.throwIfAborted();let i,s=new a.CompositePlanner({allowedTactics:t});this.context.focus={...this.context.aiPersonality,daring:e},this.currentSituation.views.planningSecurity.setRecklessness(e),this.refreshViewsAffectedByFocus();do{const t=this.context.region.size-this.context.initialRegionSize;if(i=await this.executeBestPlan(s,`CR ${e} EX ${t}/${this.context.expansionTarget}`),i?.endsTurn)return}while(i&&!i.endsTurn)}async executeBestPlan(e,t=""){this.context.abortWatcher.throwIfAborted();const i=e.generatePlans(this.context,this.currentSituation.views);let s=!1,n=(await i.next()).value;for(;n;){const a=n.hash(),o=(await i.next()).value;if(this.context.blacklistedPlans.has(a)){n=o;continue}await this.context.breakpoint(`ai:chosen-plan (${t}): ${n}`,(()=>({debugLayer:e.getDebugLayer(),hexes:n.hexes??n.hex})));const r=this.context.game.createCheckpoint();if(s=n.execute(this.context,o?.score/2??0),await(0,d.sleep)(0),this.context.abortWatcher.throwIfAborted(),s)return this.addSituation(n.constructor.name),n;h.warning(`Failed to execute ${n}`),this.context.blacklistedPlans.add(a),await this.context.breakpoint("ai:next-plan FAILED",(()=>({debugLayer:e.getDebugLayer(),hexes:n.hex??n.hexes}))),this.context.game.restoreCheckpoint(r),n=o}}get currentSituation(){return this.situationStack[this.situationStack.length-1]}backtrack(e=1){const t=this.situationStack[0].score,i=this.situationStack[this.situationStack.length-1].score;if(i<=t)this.goTo(this.situationStack[0]);else{const s=i-(i-t)/e,n=this.situationStack.find((e=>e.score>=s));this.situationStack.splice(this.situationStack.indexOf(n)+1),this.context.game.restoreCheckpoint(n)}}rollback(e){let t=this.situationStack.length-1;for(;t>e.keep;)--t;this.situationStack.splice(t+1),this.context.game.restoreCheckpoint(this.situationStack[this.situationStack.length-1]),this.updateDebugData()}rollbackPointlessMoves(e){let t=this.situationStack.length-1;const i=t;for(;t>e.keepAtLeast&&(i-t<e.rollbackAtLeast||this.situationStack[t].score-this.situationStack[t-1].score<e.scoreThreshold);)--t;this.situationStack.splice(t+1),this.context.game.restoreCheckpoint(this.situationStack[this.situationStack.length-1]),this.updateDebugData()}goToBestOutcomeSoFar(){this.goTo(this.bestOutcomeSoFar)}goTo(e){this.context.game.restoreCheckpoint(e),this.updateDebugData();const t=this.situationStack.indexOf(e);-1===t?this.situationStack=[e]:this.situationStack.splice(t+1)}addSituation(e){let t;if(this.situationCache.has(this.context.game.currentState))t=this.situationCache.get(this.context.game.currentState),this.refreshViewsAffectedByFocus(t.views);else{const i=u(this.context),s=this.appraiseCurrentSituation(i);t={...this.context.game.createCheckpoint(),score:s,label:e,views:i}}this.situationStack.push(t),this.situationCache.set(this.context.game.currentState,t),this.updateDebugData()}async considerCurrentSituation(){this.context.abortWatcher.throwIfAborted(),this.currentSituation.score>this.bestOutcomeSoFar.score?(this.bestOutcomeSoFar=this.currentSituation,await this.context.breakpoint(`ai: considering: 🏆 NEW BEST RESULT: ${this.currentSituation.label} ${(0,d.formatNumber)(this.currentSituation.score)}`,(()=>({debugLayer:o.inject.views.situationScoreByRegion.getDebugLayer(this.context)})))):await this.context.breakpoint(`ai: considering: 👎 worse result: ${this.currentSituation.label} ${(0,d.formatNumber)(this.currentSituation.score)} (vs ${this.bestOutcomeSoFar.label} ${this.bestOutcomeSoFar.score})`,(()=>({debugLayer:o.inject.views.situationScoreByRegion.getDebugLayer(this.context)})))}updateDebugData(){o.inject.config.debug.ai&&o.inject.debugData.set("SituationExplorer","\n"+this.situationStack.map((e=>` - ${e.label}(${e.score})`)).join("\n")+`\nWinner: ${this.bestOutcomeSoFar.label}(${this.bestOutcomeSoFar.score})`)}appraiseCurrentSituation(e){if(this.context.isOffensiveActionRequired())return 0;const t=this.context.focus;this.context.focus=this.context.aiPersonality,this.refreshViewsAffectedByFocus(e),o.inject.views.situationScoreByRegion.cache.flush();const i=o.inject.views.situationScoreByRegion.get(this.context.state,{views:e,context:this.context});return this.context.focus=t,this.refreshViewsAffectedByFocus(e),i}refreshViewsAffectedByFocus(e=this.currentSituation.views){e.planningSecurity.setRecklessness(this.context.focus.daring)}},t.createAiViews=u},51019:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AI_PERSONALITY_PRESETS=t.adjustMultiplierByFocus=t.DEFAULT_AI_PERSONALITY=void 0,t.DEFAULT_AI_PERSONALITY={combative:.4,daring:.5,honorable:.5,thrifty:.5,ambitious:.5,attackSkill:1,defenseSkill:1},t.adjustMultiplierByFocus=function(e,t){const i=2*t;return Math.pow(e,i)},t.AI_PERSONALITY_PRESETS={competitive:t.DEFAULT_AI_PERSONALITY,roleplaying:{...t.DEFAULT_AI_PERSONALITY,ambitious:0,defenseSkill:.3,attackSkill:.3},maniac:{...t.DEFAULT_AI_PERSONALITY,daring:1,combative:.75,ambitious:1},neutral:{...t.DEFAULT_AI_PERSONALITY,ambitious:0,honorable:0}}},98512:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getObviousGameEndingThreat=t.getJoinRegionsBonus=t.AIMetrics=void 0;const s=i(83081),n=i(15496),a=i(51019),o=i(23441),r=i(54812),c=i(40108),l=i(50264),d=i(14344),h=i(42297),u=i(1591),p=i(88865),g=i(44031);function m(e,t){const i=e.region,s=i.state,n=i.faction,a=l.Regions.model(s).byHex(t),o={incomeGain:0,conquestValueBonus:0};return c.AI.getHexInfluence(s,t.id).map(((t,r)=>{const d=l.Regions.model(s).byId(r);if(!d||d.faction!==n||d===i||d===a)return o;const h=c.AI.getRegionInfluence(s,d.id,i.id)?.proximity??Number.POSITIVE_INFINITY;if(t.distance>h)return o;const u=1===t.distance,p=u?1:1/(20+t.resistance*t.resistance);return d.isAlive()?{conquestValueBonus:Math.floor(5*p*(d.treasury+Math.abs(d.budget?.balance||0)))*e.focus.daring,incomeGain:u?d.budget?.balance??0:0}:{conquestValueBonus:Math.floor(50*p*d.hexes.length)*e.focus.daring,incomeGain:u?d.budget.potentialIncome:0}})).reduce(((e,t)=>({conquestValueBonus:e.conquestValueBonus+t.conquestValueBonus,incomeGain:e.incomeGain+t.incomeGain})),o)}function y(e){return 0===e?1:e>=1?.05/e:.95*(1-e)}var f;function w(e,t){const i=e.getTownHexes();if(1!==i.length)return 0;const s=i.first(),n=h.Warfare.getHexDefenseWithoutMovableUnits(e.state,s),a=p.inject.views.powerBalance.get(e.state),r=t.calculateComponents(s.id).find((i=>{const r=d.Factions.getByRegion(e.state,i.regionId),l=d.Factions.model(e.state).byId(r),h=u.AIPolitics.is1v1BattleBetween(a,e.faction,l),p=c.AI.getHexInfluence(e.state,s.id,i.regionId);return!!p&&!(!r||!i.riskByDefenderMight[n]||t.getPerceivedThreat(i.regionId,e.id)<.2)&&(p.distance<=1||p.cost<=(0,o.pickSmaller)(e.size,30)||!(!h&&!c.AI.isUnderAttackByRegion(e.state,e.id,r))&&i.riskByDefenderMight[n]>.2)}));return r?r.riskByDefenderMight[n]:0}t.AIMetrics={unitMightAverage:function(e){const t=e.totalUnits.getTotalMight()+e.getBuyableMight();if(0===t)return 1;return t/(e.totalUnits.count()+Math.floor(e.remainingGold/s.CHEAPEST_UNIT_COST))},economyHealth:function(e,t){if(1===t.daring)return 1;const i=2*e.regionSize;let s=g.RegionForecast.getTotal(e);return e.remainingGold<20&&e.remainingGold+e.remainingIncome>=20&&(s*=1.5),(0,r.cropNumber)(s/i,0,100)},riskToVulnerabilityPenalty:function(e,t){const i=(0,o.pickLarger)(0,e-1);return i?.875-i/16*t:1},getDefenseContribution:function(e){const{isFrontlineHex:t,hexExistingDefense:i,hexThreat:s,hexImportance:n,hasTown:a,defenderMight:r,expansionFocus:c}=e,l=t?1:.1;if(i>=r||i>s.strongestUnit)return 0;const d=(0,o.pickSmaller)(i,s.strongestUnit),h=(0,o.pickSmaller)(r,s.strongestUnit);let u=0;for(let e=d+1;e<=h;e++){const t=s.riskByDefenderMight[e-1]??0;u+=n*(t>0&&a?1:t)*(1-c)*l}return u},getJoinRegionsBonus:m,focusMismatchPenaltyV2:function(e,t,i){const s=(t.regionSize-e.initialRegionSize)/e.expansionTarget;return"defense"===i?(0,r.cropNumber)(s,.1,1):s<1?1:(0,r.cropNumber)(1/s,.5,1)},getRiskTolerance:e=>(0,a.adjustMultiplierByFocus)(.2,1-e),riskToSecurity:y,riskToTownSecurity:function(e,t){if(0===e)return 1;let i=(0,r.cropNumber)(.5-e,.01,.5);return t&&(i/=1.5),y(e)*i},getBaseAttackProbability:function(e,t,i,s,a){const c=a-(0,n.mightToUpkeep)(i+1)+(0,n.mightToUpkeep)(t),l=1===s&&e.totalUnits.getStrongest()>=t,d=e.getRawIncome()+1-(0,o.pickSmaller)(e.remainingIncome,0),h=d-c,u=((0,o.pickLarger)(h/2,0)+s)/e.regionSize,p=e.regionSize<10?1:2*u;return e.getMaxAvailableMight()<t?0:l?1:(0,r.cropNumber)((1-c/(d+6))*p,.01,1)},getObviousGameEndingThreat:w,defenseSkillToMaxThreatAwarenessRange:function(e){return 1===e?Number.POSITIVE_INFINITY:e<=.5?Math.ceil(10*e):Math.ceil(5+20*(e-.5))},attackSkillToPlanningRange:function(e){return 1===e?Number.POSITIVE_INFINITY:e<=.5?Math.ceil(15*e):Math.ceil(5+30*(e-.5))},snowballScale:function(e,t=1.1){return e<0?0:Math.pow(e,t)},getExpansionTarget:function(e){const t=.75*e.region.getMyAssets().getObtainableUnitCount();return Math.round(t*e.focus.daring)},getExpansionTargetScoreMultiplier:function(e){const t=e.expansionTarget,i=e.region.size-e.initialRegionSize;return i>=t?1:(0,o.pickLarger)(.01,i/t)}},t.getJoinRegionsBonus=m,function(e){e[e.AlreadyHasUnit=0]="AlreadyHasUnit",e[e.CanAfford=1]="CanAfford",e[e.CanAffordButNotSupport=2]="CanAffordButNotSupport",e[e.CannotAfford=3]="CannotAfford"}(f||(f={})),t.getObviousGameEndingThreat=w},1591:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getPerceivedThreat=t.AIPolitics=void 0;const s=i(84587),n=i(208),a=i(14344),o=i(40108),r=i(54812),c=i(23441),l=i(88865),d=i(12678),h=i(50264);function u(e,i){let a=i instanceof n.FactionModel?i:i.faction,r=i instanceof n.FactionModel?void 0:i;const c=a.id,d=a.state;let u=function(e,t){if(t instanceof s.RegionModel)return t.isAlive()?t.faction:void 0;if(t instanceof n.FactionModel)return t;{const i=h.Regions.model(e).byHex(t);return i?.isAlive()?i.faction:void 0}}(d,e);if(!u||!u.isAlive())return;const p=l.inject.views.powerBalance.get(d),g=p.dominantFaction===u?p.dominance:0;return{focus:r?r.focus:a.aiPersonality,isUnderAttack:r?o.AI.isUnderAttackByRegion(d,r.region.id,u.id):o.AI.isUnderAttackByFaction(d,c,u.id),sufferedAttrition:o.AI.getFactionAttrition(d,c,u.id),theirTotalAttrition:o.AI.getFactionTotalAttrition(d,u.id),approval:o.AI.getFactionApproval(d,c,u.id),fear:o.AI.getFactionFear(d,c,u.id),theirDominance:g,is1v1battle:t.AIPolitics.is1v1BattleBetween(p,a,u)}}function p(e){const t=e.sufferedAttrition>5;let i=-(t?(0,c.pickSmaller)(e.approval,0):e.approval)*e.focus.honorable,s=0,n=0,a=0,o=100*(e.focus.combative-.5);if(e.fear>0&&e.theirDominance>0){const t=e.theirDominance/100;o*=(0,r.cropNumber)(1-t,0,1),s=Math.floor((0,r.cropNumber)(2*e.fear*e.focus.ambitious*t,0,100)),a=Math.floor((0,r.cropNumber)(e.theirTotalAttrition*t*.5*e.focus.ambitious,0,50))}return e.is1v1battle&&(i=(0,c.pickLarger)(0,i),o=(0,c.pickLarger)(0,o),s+=100*e.focus.ambitious),t&&(n=(0,r.cropNumber)(e.sufferedAttrition/2,0,100),o=(0,c.pickLarger)(0,o)),{approvalBased:i,fearBoost:s,bloodInTheWaterBoost:a,disruptiveFocusBoost:o,fightBackBoost:n}}function g(e,i){const s=e.parentModel.state,n=a.Factions.model(s).byRegion(e),h=i.faction;if(d.assert.defined(h),!n||!e.isAlive())return 0;const u=l.inject.views.powerBalance.get(s),p=t.AIPolitics.is1v1BattleBetween(u,n,h),g=o.AI.getRegionAttrition(i.state,i.id,e.faction.id),m=o.AI.getRegionAttrition(i.state,e.id,h.id),y=function(e,t){const i=e.faction;return Object.entries(o.AI.getRegionAttrition(e.state,t.id)).reduce(((e,[t,s])=>Number(t)===i.id?e:e+s),0)}(i,e),f=e.getUnitsByMight().count(),w=0===f?0:(0,r.cropNumber)(y/(10*f),0,.5);if(p)return g>5?3:1.5;if(g>5||m>5)return 1+(0,c.pickSmaller)(2,(g+m)/50*(1-w));{const t=function(e,t,i){return(0,r.cropNumber)(o.AI.getFactionApproval(e,i.id,t.id)/100,-2,1-function(e,t){return.25*(0,r.cropNumber)((100-2*l.inject.views.powerBalance.get(e).dominance*t.aiPersonality.ambitious)/100,0,1)}(e,t))}(s,i.faction,n),a=l.inject.views.expansionOptions.get(s,e.id),c=a.without(i.getHostileBorderHexes()),d=e.getUnitsByMight().count();return(1-t)*(1-(0===a.length?0:(0,r.cropNumber)(Math.pow(c.length/a.length,d),0,.5))*w)}}i(48500).logger.for("AIPolitics"),t.AIPolitics={getHostilityTowards:function(e,t){const i=u(e,t);return i?function(e){const t=p(e),i=t.approvalBased+t.fearBoost+t.fightBackBoost+t.bloodInTheWaterBoost+t.disruptiveFocusBoost;return(0,r.cropNumber)(i+50,0,100)/100}(i):.5},getHostilityFactors:function(e,t){const i=u(e,t);return i?p(i):void 0},getPerceivedThreat:g,is1v1BattleBetween(e,t,i){const s=e.factionsByPower.slice(0,2);return e.is1v1situation&&s.includes(t)&&s.includes(i)},getApprovalReactionToThirdPartyConquest:function({casusBeliStrength:e,me:t,victimFaction:i,attackerFaction:s,attritionImpact:n,stateBeforeAttack:a}){const c=s.state,l=o.AI.getFactionFear(a,t.id,s.id),d=o.AI.getFactionFear(a,t.id,i.id),h=o.AI.getFactionAttrition(a,t.id,i.id)>5,u=d-l,p=(0,r.cropNumber)(u/100,-1,1),g=(0,r.cropNumber)(e/n*4,0,1),m=o.AI.getFactionApproval(c,t.id,i.id);let y=(p+(0-(0,r.cropNumber)(m/200,-.5,.5))+(h?(0,r.cropNumber)(d/2/100,.1,1):0))/4;return y<0&&(y*=(1-g)/2+.5),(0,r.cropNumber)((f=n*y,Math.pow(Math.abs(f),.75)*(f>=0?1:-1)),-50,50);var f},getDiplomaticPenalty:function(e,i){const s=2*(t.AIPolitics.getHostilityTowards(i,e)-.5);return s<0?-400*-s*e.focus.honorable*e.focus.honorable:0}},t.getPerceivedThreat=g},65955:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.assetValueToDebugStr=t.NO_ASSET_VALUE=t.createAssetValueDebugLayer=t.AssetValue=void 0;const s=i(62977),n=i(30420),a=i(52937),o=i(16972),r=i(88865),c=i(54444),l=i(41707),d=i(20666),h={offensive:0,defensive:0,economic:10},u={[n.PawnType.Coins]:{defensive:1,offensive:1,economic:3},[n.PawnType.Town]:{offensive:0,defensive:60,economic:0},[n.PawnType.Villager]:{offensive:10,defensive:10,economic:30},[n.PawnType.Pikeman]:{offensive:60,defensive:60,economic:-30},[n.PawnType.Knight]:{offensive:160,defensive:80,economic:-90},[n.PawnType.Hero]:{offensive:200,defensive:80,economic:-270},[n.PawnType.Castle]:{offensive:0,defensive:120,economic:-20},[n.PawnType.Bandit]:{offensive:0,defensive:0,economic:-5}};t.AssetValue={HEX_BASE_VALUE:h.defensive+h.economic+h.offensive,getTotal(e,t,i=!0){const s=this.getFactors(e,t,i);return s.offensive+s.defensive+s.economic},getFactors(e,i,n=!0,a=!1){let o={...h};for(let r of s.Pawns.model(e).byHex(i))!n&&r.isMovable()||a&&r.hasTrait(d.PawnTraits.Unit)||(o=t.AssetValue.sum(o,this.getPawnFactors(r.type,r.count)));return o},getPawnFactors(e,i){const s=u[e];return s?{offensive:s.offensive*i,defensive:s.defensive*i,economic:s.economic*i}:t.NO_ASSET_VALUE},total:e=>e.economic+e.defensive+e.offensive,sum:(...e)=>e.reduce(((e,t)=>({economic:e.economic+t.economic,offensive:e.offensive+t.offensive,defensive:e.defensive+t.defensive})),{...t.NO_ASSET_VALUE}),subtract:(e,t)=>({economic:e.economic-t.economic,offensive:e.offensive-t.offensive,defensive:e.defensive-t.defensive})},t.createAssetValueDebugLayer=function(){let e=(0,a.signal)();const i=()=>e.fire();return{name:"assetValue",onChange:e,getMap(){let e=new o.CustomHexGroupValuation("");for(let i of r.inject.gameStateModel.regions.allRegionsHexes())e.set(i.id,t.AssetValue.getTotal(r.inject.currentGameState,i).toFixed(0));return e},getDetail(e){const i=t.AssetValue.getFactors(r.inject.currentGameState,e);return(0,c.prettyPrintObject)(i)},activate(){r.inject.gameStateModel.stateEngine.watchAll(i)},deactivate(){r.inject.gameStateModel.stateEngine.stopWatching(i)}}},t.NO_ASSET_VALUE=Object.freeze({offensive:0,economic:0,defensive:0}),t.assetValueToDebugStr=function(e){return`${t.AssetValue.total(e)}\n(${l.GLYPH.sword}${e.offensive} ${l.GLYPH.defense}${e.defensive} ${l.GLYPH.coin}${e.economic})`}},11689:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConquestSim=void 0;const n=s(i(35369)),a=i(42297),o=i(50264),r=i(23441),c=i(20666);class l{static fromState(e){return new l(e,{dirtyHexes:n.default.Set(),defenderOverrides:n.default.Map(),latestBreachedDefense:0})}constructor(e,t){this.state=e,this.overrides=t}get latestBreachedDefense(){return this.overrides.latestBreachedDefense}getHexDefense(e){if(!this.overrides.dirtyHexes.has(e))return a.Warfare.getHexDefense(this.state,e);const t=a.Warfare.getHexLocalDefense(this.state,e.id);return o.Regions.getSameRegionNeighbours(this.state,e).map((e=>this.overrides.defenderOverrides.get(e)??a.Warfare.getHexProjectedDefense(this.state,e.id))).reduce(r.pickLarger,t)}conquerHex(e){const t=this.overrides.defenderOverrides.get(e)??a.Warfare.getHexLocalDefense(this.state,e.id);if(!t)return new l(this.state,{...this.overrides,latestBreachedDefense:0});const i=a.Warfare.getOccupyingPawn(this.state,e),s=a.Warfare.getHexStaticDefense(this.state,e.id)>0&&i?.hasTrait(c.PawnTraits.Unit)&&a.Warfare.model(this.state).getRetreatDestination(i);return new l(this.state,{dirtyHexes:this.overrides.dirtyHexes.concat(e.neighbours()),defenderOverrides:s?this.overrides.defenderOverrides:this.overrides.defenderOverrides.set(e,0),latestBreachedDefense:t})}}t.ConquestSim=l},9750:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EconomySim=void 0;const s=i(23441);i(48500).logger.for("EconomySim");class n{constructor(e){this.turnsSimulated=0,this.state=e}simulateTurn(e){++this.turnsSimulated;const t=2*this.state.fortification+4*this.state.unitCount,i=Math.ceil((0,s.pickLarger)(this.state.regionSize-t,0)*(.2*(1-e))),n=this.state.netIncome-i,a={regionSize:this.state.regionSize-i,netIncome:this.state.netIncome-i,treasury:this.state.treasury+n,unitCount:this.state.unitCount,fortification:this.state.fortification,bankrupt:!1};a.treasury<0&&(a.unitCount=0,a.treasury=0,a.netIncome=0,a.bankrupt=!0);const o=(0,s.pickSmaller)(Math.floor(a.treasury/10),Math.floor(a.netIncome/2));o>0&&(a.unitCount+=o,a.netIncome-=2*o,a.treasury-=10*o);const r=Math.ceil(a.unitCount*e);a.netIncome+=r,a.regionSize+=r,this.state=a}simulateTurns(e,t=.5){for(let i=0;i<e;++i)this.simulateTurn(t)}getState(){return this.state}getScore(){return this.state.netIncome+5*this.state.unitCount+3*Math.floor(this.state.treasury/10)}static fromRegion(e){return this.fromRegionAssets(e.getMyAssets())}static fromRegionAssets(e){return new n({regionSize:e.regionSize,unitCount:e.totalUnits.count(),netIncome:e.remainingIncome,treasury:e.remainingGold,fortification:e.fortification,bankrupt:!1})}}t.EconomySim=n},15496:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mightToUpkeep=t.RegionAssets=t.describePlan=void 0;const s=i(23206),n=i(83081),a=i(88865),o=i(23441),r=i(54444),c=i(48500),l=i(9750),d=i(42297),h=i(5032),u=i(12678),p=c.logger.for("RegionAssets");function g(e){switch(e.action){case"buy":return`buy ${e.might}`;case"merge":return`2x${e.might}=>${e.might+1}`}}t.describePlan=function(e){return e.recipe.length?`obtain and use ${e.might} (${e.recipe.map(g).join(", ")})`:`use ${e.might}`};class m{static fromMyRegion(e){return new m({regionSize:e.size,remainingIncome:e.budget?.balance||0,remainingGold:e.treasury,remainingUnits:e.getMovableUnitsByMight(),totalUnits:e.getUnitsByMight(),fortification:e.fortification})}static safeAssetsFromMyRegion(e,t,i){function s(s){return 0===d.Warfare.getHexStaticDefense(e.state,s.hex.id)?t.get(s.hex.id)>=i:t.get(s.hex.id)>=.01}const n=e.getUnitsByMight((e=>!s(e))),a=n.countOf(1)+3*n.countOf(2)+4*n.countOf(3)+8*n.countOf(4),r=e.hexes.filter((i=>t.get(i.id)<=.01&&h.Economy.getIncomeFromHex(e.state,i.id)>0));return new m({regionSize:e.size-r.length,remainingIncome:(e.budget?.balance??0)+(0,o.pickSmaller)(a/2,4)-r.length,remainingGold:e.treasury,remainingUnits:e.getUnitsByMight((e=>e.isMovable()&&s(e))),totalUnits:e.getUnitsByMight((e=>s(e))),fortification:e.fortification})}toString(){return`[RegionAssets fort/size=${this.fortification}/${this.regionSize} gold=${this.remainingGold}${(0,r.withSign)(this.remainingIncome)} units=${this.remainingUnits.count()}/${this.totalUnits.count()} units]`}static fromEnemyRegion(e){const t=e.treasury+(e.budget?.balance||0);return new m(t<0?{regionSize:e.size,remainingIncome:e.budget.incomeFromHexes-e.getUnitsByMight().count(),remainingGold:0,totalUnits:s.UnitsByMight.empty,remainingUnits:s.UnitsByMight.empty,fortification:e.fortification}:{regionSize:e.size,remainingIncome:e.budget?.balance||0,remainingGold:t,remainingUnits:e.getUnitsByMight(),totalUnits:e.getUnitsByMight(),fortification:e.fortification})}constructor(e){this._remaininingAvailableMight=void 0,this._maxRemainingSustainableMight=void 0,this._maxSustainableMight=void 0,this.fortification=e.fortification,this.totalUnits=e.totalUnits,this.remainingUnits=e.remainingUnits,this.remainingGold=e.remainingGold,this.remainingIncome=e.remainingIncome,this.regionSize=e.regionSize}useUnit(e){return f(this,e)}buildCastle(e){return function(e,t){const i=a.inject.gameStateModel.rules.castleByMight(2),s=e.remainingGold-i.cost,n=e.remainingIncome-i.upkeep;return s<0?void 0:new m({regionSize:e.regionSize,totalUnits:e.totalUnits,remainingUnits:e.remainingUnits,remainingGold:s,remainingIncome:n,fortification:e.fortification+t.fortificationGain})}(this,e)}getRemainingAvailableMight(){return this._remaininingAvailableMight||(this._remaininingAvailableMight=this.remainingUnits.getTotalMight()+this.getBuyableMight()),this._remaininingAvailableMight}getTotalAvailableMight(){return this.totalUnits.getTotalMight()+this.getBuyableMight()}getBuyableMight(){const e=Math.floor(this.remainingGold/n.CHEAPEST_UNIT_COST);return(0,o.pickLarger)(0,e)}getMaxRemainingAvailableMight(e=(e=>!0)){let t=this.remainingUnits.getStrongest();if(t===s.MAX_UNIT_MIGHT)return s.MAX_UNIT_MIGHT;let i=this,n=!0;do{i=f(this,{requiredMight:t+1})?.assets,n=!!i&&e(i),n&&++t}while(n&&t<s.MAX_UNIT_MIGHT);return t||0}getMaxAvailableMight(e=(e=>!0)){return new m({regionSize:this.regionSize,remainingIncome:this.remainingIncome,remainingUnits:this.totalUnits,totalUnits:this.totalUnits,remainingGold:this.remainingGold,fortification:this.fortification}).getMaxRemainingAvailableMight(e)}getRawIncome(){return this.regionSize}getTotalUnitUpkeep(){return this.totalUnits.map(((e,t)=>a.inject.gameStateModel.rules.unitByMight(t).upkeep*e)).reduce(o.sum,0)}getMaxRemainingSustainableMight(){return this._maxRemainingSustainableMight||(this._maxRemainingSustainableMight=this.getMaxRemainingAvailableMight((e=>e.remainingIncome>=0))),this._maxRemainingSustainableMight}getMaxSustainableMight(){return this._maxSustainableMight||(this._maxSustainableMight=this.getMaxAvailableMight((e=>e.remainingIncome>=0))),this._maxSustainableMight}getObtainableMightLevels(e){return[1,2,3,4].filter((t=>!!this.remainingUnits.has(t)||!!this.useUnit({...e,allowOverkill:!1,requiredMight:t})))}getObtainableUnitCount(){return this.remainingUnits.count()+Math.floor(this.remainingGold/n.CHEAPEST_UNIT_COST)}override(e){return new m({regionSize:this.regionSize,totalUnits:this.totalUnits,remainingUnits:this.remainingUnits,remainingIncome:this.remainingIncome,remainingGold:this.remainingGold,fortification:this.fortification,...e})}turnsToBankruptcy(e=.5){const t=l.EconomySim.fromRegionAssets(this);if(0!==t.state.unitCount){for(t.simulateTurn(e);t.state.netIncome<=0&&!t.state.bankrupt;)t.simulateTurn(e);return t.state.bankrupt?t.turnsSimulated:void 0}}isHeadedForBankruptcy(e=.5){return void 0!==this.turnsToBankruptcy(e)}spendGold(e){return this.override({remainingGold:this.remainingGold-e})}}t.RegionAssets=m;const y={1:2,2:6,3:18,4:54};function f(e,t){if(t.requiredMight>(t.maxAllowedMight??Number.POSITIVE_INFINITY))return;void 0===t.allowOverkill&&(t.allowOverkill=!0);const i=e.remainingUnits.getOneWithMightAtLeast(t.requiredMight);if(i===t.requiredMight)return w(e,t,i);if(t.requiredMight>1){const i=function(e,t){let i=f(e,{requiredMight:t.requiredMight-1,allowOverkill:!1,willSacrifice:!0,loot:0,incomeGain:0});if(!i)return;let s=f(i.assets,{requiredMight:t.requiredMight-1,allowOverkill:!1,willSacrifice:!0,loot:0,incomeGain:0});if(!s)return;const n=[...i.recipe,...s.recipe,{action:"merge",might:t.requiredMight-1}],a=s.assets.remainingIncome+2*y[t.requiredMight-1]-y[t.requiredMight];return 1!==i.recipe.length||"buy"!==i.recipe[0].action||1!==s.recipe.length||"buy"!==s.recipe[0].action?{...s,might:t.requiredMight,recipe:n,assets:v({regionSize:e.regionSize,totalUnits:t.willSacrifice?s.assets.totalUnits:s.assets.totalUnits.with(t.requiredMight),remainingUnits:s.assets.remainingUnits,remainingGold:s.assets.remainingGold,remainingIncome:a,fortification:s.assets.fortification},t)}:void 0}(e,t);if(i)return i}const s=function(e,t){const i=a.inject.gameStateModel.rules.unitByMight(t.requiredMight);if(!i)return void p.warning(`Invalid attempt to buy unit with might ${t.requiredMight}`);const s=e.remainingGold-i.cost,n=e.remainingIncome-i.upkeep;return i.might>(t.maxAllowedMight??Number.POSITIVE_INFINITY)||s<0||n<0&&!1===t.allowNegativeIncome?void 0:{recipe:[{action:"buy",might:t.requiredMight}],assets:v({regionSize:e.regionSize,totalUnits:t.willSacrifice?e.totalUnits:e.totalUnits.add(t.requiredMight),remainingUnits:e.remainingUnits,remainingGold:s,remainingIncome:n,fortification:e.fortification},t),might:t.requiredMight}}(e,t);return s||(i&&t.allowOverkill?w(e,t,i):void 0)}function w(e,t,i){return{recipe:[],might:i,assets:v({regionSize:e.regionSize,totalUnits:t.willSacrifice?e.totalUnits.withoutUnit(i):e.totalUnits,remainingUnits:e.remainingUnits.withoutUnit(i),remainingGold:e.remainingGold,remainingIncome:e.remainingIncome,fortification:e.fortification},t)}}function v(e,t){return new m({regionSize:e.regionSize+(t.incomeGain??0),remainingGold:e.remainingGold+(t.loot??0),remainingIncome:e.remainingIncome+(t.incomeGain??0),remainingUnits:e.remainingUnits,totalUnits:e.totalUnits,fortification:e.fortification})}t.mightToUpkeep=function(e){return(0,u.assert)(e>=0||e<=4,"invalid might "+e),y[e]??0}},44031:(e,t)=>{"use strict";function i(e){const t=s(e);if(1===t.turnsToBankruptcy)return 1e-5;let i=t.treasuryScore+t.unitsScore+t.incomeScore+t.fortificationScore;return void 0!==t.turnsToBankruptcy&&(i*=.001*t.turnsToBankruptcy),i}function s(e){const t=e.remainingIncome>=1?e.remainingIncome:1/-(e.remainingIncome-1);return{turnsToBankruptcy:e.turnsToBankruptcy(),incomeScore:t,unitsScore:5*e.totalUnits.countOf(1)+2*e.totalUnits.countOf(2),treasuryScore:3*Math.floor(e.remainingGold/10),fortificationScore:e.fortification/2}}Object.defineProperty(t,"__esModule",{value:!0}),t.getFactors=t.getTotal=t.RegionForecast=void 0,t.RegionForecast={getTotal:i,getFactors:s},t.getTotal=i,t.getFactors=s},23206:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.UnitsByMight=t.MAX_UNIT_MIGHT=void 0;const n=s(i(35369)),a=i(12678),o=i(23441),r=i(15496);t.MAX_UNIT_MIGHT=4;const c=n.default.Map();class l{constructor(e=c){this.data=e}getOneWithMightAtLeast(e){for(let i=e;i<=t.MAX_UNIT_MIGHT;++i)if(this.data.get(i))return i}has(e){return!!this.data.get(e)}withoutUnit(e){const t=this.data.get(e,0);return(0,a.assert)(t>0,`cannot take unit with might ${e} from ${this.toString()}`),new l(t-1>0?this.data.update(e,(e=>e-1)):this.data.delete(e))}hasUnitsWeakerThan(e){for(let t=1;t<e;++t)if(this.data.get(t))return!0;return!1}getTotalMight(){return this.data.map(((e,t)=>t*e)).reduce(o.sum,0)}static fromUnitList(e){return new l(n.default.Map().withMutations((t=>{e.forEach((e=>t.set(e,t.get(e,0)+1)))})))}toString(){let e="[";for(let t=1;t<4;++t)e+=t.toString().repeat(this.data.get(t,0));return e+="]",e}add(e,t=1){return new l(this.data.set(e,this.data.get(e,0)+t))}getStrongest(){for(let e=4;e>0;--e)if(this.data.get(e))return e;return 0}getAvailableMightLevels(){return Array.from(this.data.keys())}map(e){return this.data.map(e)}count(){return this.data.valueSeq().reduce(o.sum,0)}countOf(e){return this.data.get(e,0)}without(...e){return new l(this.data.withMutations((t=>{e.forEach((i=>{const s=t.get(i,0);if(s<1)throw new Error(`cannot take units ${e} from ${this.toString()}`);1===s?t.remove(i):t.set(i,s-1)}))})))}with(...e){return new l(this.data.withMutations((t=>{e.forEach((e=>{const i=t.get(e,0);t.set(e,i+1)}))})))}setCount(e,t){return new l(this.data.set(e,t))}listIndividualUnits(){const e=[];for(let[t,i]of this.data.entrySeq().sort((([e],[t])=>e-t)))for(let s=0;s<i;++s)e.push(t);return e}getUpkeep(){return this.map(((e,t)=>(0,r.mightToUpkeep)(t)*e)).reduce(o.sum,0)}}t.UnitsByMight=l,l.empty=new l},34898:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BasicDefensePlanner=void 0;const s=i(15496),n=i(42297),a=i(40108),o=i(62977),r=i(30420),c=i(66845),l=i(52956),d=i(48500),h=i(34966),u=i(78179),p=i(20666),g=i(88865),m=i(78329),y=i(98512),f=i(675),w=i(50264),v=i(1591),b=i(54812),S=i(23441),x=i(29791);d.logger.for("BasicDefensePlanner"),t.BasicDefensePlanner=class{constructor(e){this.paranoidTownProtection=e,this.isConquest=!1,this.name=this.constructor.name}async*generatePlans(e,t){this.context=e,this.views=t,this.focus=e.focus,this.state=e.state,this.regionAssets=s.RegionAssets.fromMyRegion(e.region);const i=this.getObtainableCastles(this.regionAssets),o=this.regionAssets.getObtainableMightLevels({allowNegativeIncome:!0}),r=(0,S.pickLarger)(o[o.length-1]??0,i[i.length-1]??0);if(this.focus.daring<1){let t=this.context.region.hexes.filter((t=>n.Warfare.getOccupyingPawn(e.state,t)?.hasTrait(p.PawnTraits.Pest)||this.views.planningSecurity.get(t.id)<1&&n.Warfare.getHexDefenseWithoutMovableUnits(e.state,t)<r));const s=n.Warfare.getConquerableHexes(this.state,e.region.id,this.regionAssets.getMaxRemainingAvailableMight());if(e.isOffensiveActionRequired()&&(t=u.HexGroup.empty),t.length||s.length){const r=u.HexGroup.from([...s,...t,...t.neighbours()]);for(const t of r){const s=w.Regions.getByHex(this.state,t.id)===this.context.region.id,r=n.Warfare.getOccupyingPawn(this.state,t),d=r&&!r.isMovable();for(let i=1;i<=4;++i){if(!o.includes(i))continue;if(i>=3&&s)continue;if(!a.AI.canPlaceDefenderAt(this.state,t,e.region,i))continue;const n=this.calculateFactorsForPlacingDefender(t,i);n&&this.isReasonableDefensiveMove(t,i,n)&&(yield new c.PlaceUnitPlan(t,i,n))}if(s&&!d)for(const e of i){const i=this.calculateFactorsForPlacingDefender(t,e,!0);i&&i.threatReduction>0&&(yield new l.PlaceCastlePlan(t,e,i))}}}}if(0===this.regionAssets.remainingUnits.count()&&(yield new h.EndTurnPlan(this.context,this.regionAssets)),g.inject.gameStateModel.plugins.zombies&&this.regionAssets.remainingUnits.getTotalMight()>0){const e=o[0],t=(0,m.getDangerousZombies)(this.context.region);for(let i of t){const t=this.calculateFactorsForPlacingDefender(i,e);t&&(yield new c.PlaceUnitPlan(i,e,{...t,conquestValue:{...t.conquestValue,factors:{...t.conquestValue.factors,loot:500}},focusMismatchPenalty:1}))}}}isReasonableDefensiveMove(e,t,i){return 1===t||!(!this.regionAssets.remainingUnits.has(t)&&i.conquestValue.factors.damageToEnemy<10&&i.threatReduction<10)}getObtainableCastles(e){return e.remainingGold>=20&&e.remainingIncome>=2?[2]:[]}calculateFactorsForPlacingDefender(e,t,i=!1){const o=n.Warfare.model(this.context.state).getOccupyingUnit(e),r=o?.hasTrait(p.PawnTraits.Pest),c=o?.hasTrait(p.PawnTraits.Unit)&&o?.might===t;c&&++t;const l=!this.context.region.hexes.has(e);if(l&&n.Warfare.getHexDefenseWithoutMovableUnits(this.context.state,e)>=t)return;const d=r?10:0,h=y.AIMetrics.getJoinRegionsBonus(this.context,e)??{conquestValueBonus:0,incomeGain:0},u=s.RegionAssets.fromMyRegion(this.context.region);let m;if(m=i?u.buildCastle({fortificationGain:x.Fortification.getDeltaAfterCastleBuilt(this.context.state,e.id)}):u.useUnit({requiredMight:t,incomeGain:l||r?1+h.incomeGain:this.getDefenderLootBonus(e,t),loot:n.Warfare.getPotentialLoot(this.context.state,e,l),willSacrifice:!1,allowOverkill:!1,maxAllowedMight:g.inject.ai.maxAllowedUnitMight})?.assets,!m)return;const w=this.views.threatAssessment.get(e.id).riskByDefenderMight[t]??0,S=n.Warfare.getHexStaticDefense(this.context.state,e.id)>=1,T=this.protectsImportantTown(e,t),P=1===t&&a.AI.getHexImportance(this.context.state,e.id).value>100&&u.regionSize>10?.75:1;return{conquestValue:l?this.views.conquestValue.get(e.id):f.NO_CONQUEST_VALUE,downstreamMovesBonus:0,joinRegionsBonus:l?h.conquestValueBonus:0,threatReduction:this.views.defenderBenefit.getForMight(e.id,t)*P,eradicatePestBonus:d,diplomacyPenalty:l?v.AIPolitics.getDiplomaticPenalty(this.context,e):0,mightInvestment:c?t-1:t,vulnerabilityPenalty:S&&!i?1:y.AIMetrics.riskToVulnerabilityPenalty(w,this.context.focus.daring),economyHealth:y.AIMetrics.economyHealth(m,this.context.focus),focusMismatchPenalty:T?10:(0,b.cropNumber)(y.AIMetrics.focusMismatchPenaltyV2(this.context,m,l?"offense":"defense"),.1,1)}}protectsImportantTown(e,t){if(!this.paranoidTownProtection)return!1;const i=this.context.region.getTownHexes();if(1!==i.length)return!1;const s=i.first(),a=n.Warfare.getHexDefenseWithoutMovableUnits(this.context.state,s);return!(a>=t||this.views.threatAssessment.get(s.id).strongestUnit<=a)}getDefenderLootBonus(e,t){const i=o.Pawns.model(this.state).findOne({traits:[p.PawnTraits.Pest],hexes:e});if(i?.type===r.PawnType.Zombie){const t=e.neighbours((e=>this.context.region.getTownHexes().has(e))).first();return t?10*(a.AI.getHexImportance(this.state,t.id).value||1):10}return i?10:0}}},89799:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BlockTownAccessPlan=void 0;const s=i(88865),n=i(15496),a=i(31524),o=i(7080),r=i(94621),c=i(48500),l=i(42297),d=i(52048),h=i(23441),u=i(40108),p=i(54444),g=i(78179),m=c.logger.for("BlockTownAccessPlan");t.BlockTownAccessPlan=class{constructor(e){this.endsTurn=!1,this.isConquest=!0,this.score=e.isLifeOrDeath?1e3:(0,a.aggregateScoreFactors)(e.utilityFactors),this.hex=e.hex,this.hexes=g.HexGroup.from(e.candidateHexes),this.townHex=e.townHex,this.might=e.might,this.maxMight=e.maxMight,this.townSecurityBaseline=e.townSecurityBaseLine,this.isLifeOrDeath=e.isLifeOrDeath,this.candidateHexes=e.candidateHexes,this.utilityFactors=e.utilityFactors}execute(e){for(let t=this.might;t<=(0,h.pickSmaller)(this.maxMight,e.maxAllowedUnitMight??99);++t)if(this.tryWithMight(e,t,t===this.maxMight))return this.isLifeOrDeath&&(e.forceAction=!1),!0;return!1}tryWithMight(e,t,i){const a=this.candidateHexes.filter((i=>!(e.region.hexes.has(i)&&l.Warfare.getHexDefenseWithoutMovableUnits(e.state,i)>t)&&l.Warfare.canConquerHexWith(e.state,i,t))),c=e.faction,d=n.RegionAssets.fromMyRegion(e.region).useUnit({requiredMight:t,allowOverkill:!0,maxAllowedMight:s.inject.ai.maxAllowedUnitMight});if(!d)return m.warning(`discarding invalid plan - unable to gather might ${t}`),!1;let h=e.game.createCheckpoint(),u=h,p=this.townSecurityBaseline,g=0,y=!1;for(;a.length&&(g<1||!y);){const s=a.shift();if(y=!1,!(2===t&&l.Warfare.canBuildCastleAt(e.state,s,e.region.id)?e.marshal.buildCastle(s,2):e.marshal.moveUnit(s,d))){e.game.restoreCheckpoint(h);continue}const n=new o.ThreatAssessment(c),m=new r.SecurityView({faction:c,threatAssessment:n,recklessness:e.focus.daring},"block town access helper");g=m.get(this.townHex.id),g<=.99?(g>p&&i&&this.isViableDefense(e,m,s,t)&&(y=!0,u=e.game.createCheckpoint(),p=g),e.game.restoreCheckpoint(h)):this.isViableDefense(e,m,s,t)?y=!0:e.game.restoreCheckpoint(h)}return!(!y||1!==g)||(p>this.townSecurityBaseline?(e.game.restoreCheckpoint(u),!0):(e.game.restoreCheckpoint(h),!1))}isViableDefense(e,t,i,s){if(this.isLifeOrDeath)return!0;const n=u.AI.getHexImportance(e.state,i.id).distanceFromTown;return!(n<=1&&s>=3&&!this.isLifeOrDeath)&&!(e.region.hexes.floodFillFrom(this.townHex,(i=>t.get(i.id)>=.5||u.AI.getHexImportance(e.state,i.id).distanceFromTown<n)).length<(d.Rules.model(e.state).unitByMight(s)?.upkeep??0))}hash(){return`Block town access ${this.candidateHexes.map((e=>e.id)).join("->")} with might range ${this.might}-${this.maxMight} #${this.hex.id} ${this.isLifeOrDeath?"(DESPERATE)":""}`}toString(){return`[${(0,p.formatNumber)(this.score)} | ${this.hash()}]`}toDebugString(){return(0,a.describeScoreFactors)(this.utilityFactors)+`security baseline: ${this.townSecurityBaseline.toFixed(2)}\ncandidates: ${this.candidateHexes.map((e=>e.id)).join("->")}\nmight range: ${this.might}..${this.maxMight}\nis life or death: ${this.isLifeOrDeath}\n`}}},44080:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BlockTownAccessPlanner=void 0;const s=i(42297),n=i(48500),a=i(23441),o=i(40108),r=i(85656),c=i(50264),l=i(89799),d=i(24794),h=i(98512),u=i(54812),p=i(78179),g=i(1591),m=i(14344),y=i(88865),f=n.logger.for("BlockDefensePlanner");t.BlockTownAccessPlanner=class{constructor(e=3){this.maxAllowedMight=e,this.name="Block",this.isConquest=!1}async*generatePlans(e,t){if(e.aiPersonality.defenseSkill<.5)return;const i=e.region.getTownHexes().filter((e=>t.planningSecurity.get(e.id)<1));this.regionAssets=e.region.getMyAssets(),this.context=e,this.views=t,this.plans=[];for(let e of i)this.protectTown(e);for(let e of this.plans)yield e}protectTown(e){const t=this.context.state,i=s.Warfare.getHexDefenseWithoutMovableUnits(t,e),n=o.AI.getHexImportance(t,e.id).value,g=[],m=this.views.threatAssessment.calculateComponents(e.id).filter((e=>e.riskByDefenderMight[i]&&this.views.threatAssessment.getPerceivedThreat(e.regionId,this.context.region.id)>=.4*this.context.focus.daring)).map((e=>e.regionId)),w=!!h.AIMetrics.getObviousGameEndingThreat(this.context.region,this.views.threatAssessment),v=w?this.regionAssets.getMaxAvailableMight():(0,a.pickSmaller)(this.regionAssets.getMaxRemainingSustainableMight(),2),b=(0,u.cropNumber)((0,a.pickSmaller)(this.views.threatAssessment.get(e.id).strongestUnit,v),1,2);if(0===b||0===m.length)return;let S=e.id;for(;!m.includes(c.Regions.getByHex(t,S));){const e=m.map((e=>o.AI.getHexInfluence(t,S,e)?.parent)).filter((e=>e));if(1!==(0,r.stripDuplicatesFrom)(e).length)break;S=e[0].id,this.isHexSuitableForDefender((0,d.getHex)(S))&&g.push((0,d.getHex)(S))}const x=c.Regions.getByHex(t,S)===this.context.region.id,T=this.regionAssets.useUnit({requiredMight:b,allowNegativeIncome:w,incomeGain:x?0:1,maxAllowedMight:Math.min(this.maxAllowedMight,v,y.inject.ai.maxAllowedUnitMight??99),allowOverkill:!0});if(!T)return void f.warning(`BlockDefense plan creation aborted for town at hex #${e.id}, could not muster unit with might ${b}`);const P=g.slice(-2).reverse(),M=g[0]?g[0].with(g[0].neighbours()):p.HexGroup.empty,I=e.neighbours().filter((e=>!(this.context.region.hexes.has(e)&&s.Warfare.getHexDefenseWithoutMovableUnits(this.context.state,e)>v)&&s.Warfare.canConquerHexWith(this.context.state,e,v))).sort(((e,t)=>M.has(e)!=M.has(t)?M.has(e)?-1:1:this.views.defenderBenefit.get(t.id)[v]-this.views.defenderBenefit.get(e.id)[v]));this.plans.push(new l.BlockTownAccessPlan({hex:(0,d.getHex)(S),townSecurityBaseLine:this.views.planningSecurity.get(e.id),candidateHexes:[...P,...I],townHex:e,might:b,maxMight:(0,a.pickSmaller)(this.maxAllowedMight,v),isLifeOrDeath:w,utilityFactors:{threatReduction:n-70,conquestValue:this.views.conquestValue.get(S),joinRegionsBonus:0,eradicatePestBonus:0,diplomacyPenalty:0,mightInvestment:T.might,downstreamMovesBonus:0,economyHealth:h.AIMetrics.economyHealth(T.assets,this.context.focus),focusMismatchPenalty:1,vulnerabilityPenalty:1}}))}isHexSuitableForDefender(e){const t=this.context.state,i=c.Regions.getByHex(t,e.id),s=m.Factions.getByHex(t,e.id);if(i===this.context.region.id)return!0;const n=e.neighbours().members.some((e=>c.Regions.getByHex(t,e.id)===this.context.region.id)),a=!s||o.AI.isUnderAttackByRegion(t,this.context.region.id,s)||g.AIPolitics.getHostilityTowards(e,this.context)>=.4;return n&&a}}},53190:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CompositePlanner=void 0;const n=s(i(54485)),a=i(52937),o=i(16972),r=i(8352),c=i(23441),l=i(48500),d=i(88865),h=i(69905);l.logger.for("ai:CompositePlanner"),t.CompositePlanner=class{get isConquest(){return this.options.allowedTactics.some((e=>e.isConquest))}constructor(e){this.options=e,this.name="CompositePlanner",this.candidatePlans=[],this.candidatePlansHeap=new n.default(((e,t)=>t.score-e.score))}async*generatePlans(e,t){this.candidatePlans=[],this.candidatePlansHeap=new n.default(((e,t)=>t.score-e.score));for(const i of this.options.allowedTactics)for await(const s of i.generatePlans(e,t))this.candidatePlans.push(s),this.candidatePlansHeap.push(s);for(d.inject.config.debug.ai&&d.inject.debugData.set("Top candidate plans:","\n"+this.candidatePlans.slice(0,10).map((e=>" - "+e.toString())).join("\n"));!this.candidatePlansHeap.empty();)yield this.candidatePlansHeap.pop()}getDebugLayer(){return{onChange:(0,a.signal)(),getMap:()=>{const e=new o.CustomHexGroupValuation([]);return this.candidatePlans.forEach((t=>{const i=t.hex;i&&e.set(i.id,[...e.get(i.id),t])})),new r.ProxyHexGroupValuation(e,(e=>e.map((e=>e.score)).reduce(c.pickLarger,-1/0).toFixed(0)))},getDetail:e=>this.candidatePlans.filter((t=>t.hex===e)).sort(((e,t)=>t.score-e.score)).map((e=>e.toString()+"\n"+(0,h.prefixEachLineWith)("  ",e.toDebugString()))).join("\n")}}}},7660:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConquestPlan=void 0;const s=i(15496),n=i(40108),a=i(48500),o=i(23441),r=i(31524),c=i(50264),l=i(42297),d=i(54444),h=i(29791),u=a.logger.for("ConquestPlan");t.ConquestPlan=class{constructor(e,t,i){this.hex=e,this.path=t,this.scoreFactors=i,this.endsTurn=!1,this.isConquest=!0,this.score=(0,r.aggregateScoreFactors)(this.scoreFactors)}doExecute(e,t){const i=(0,o.pickLarger)(this.scoreFactors.conquestValue.factors.damageToEnemy-20,0),n=e.game.model.factions.byHex(this.hex),a=e.game.model.regions.byHex(this.hex),r=n?.rawPower??0;let l=0;for(let t of this.path){const i=e.game.model.warfare.getHexDefense(t);if(c.Regions.getByHex(e.state,t.id)===e.region.id)continue;const n=s.RegionAssets.fromMyRegion(e.region).useUnit({requiredMight:i+1,allowOverkill:!0,maxAllowedMight:e.maxAllowedUnitMight});if(!n)return!1;if(l+=n.might,!e.marshal.moveUnit(t,n))return!1}const d=r-(n?.rawPower??0),h=this.calculateRealScore(d,l);return!(a?.isAlive()&&i>0&&h<this.score)||h>t||this.extendPlanFrom(e,this.hex,a,{damageSoFar:d,investmentSoFar:l,minimalScore:t,latestExpectedDamage:i})}execute(e,t){return this.doExecute(e,t)}calculateRealScore(e,t){if(0===this.scoreFactors.conquestValue.factors.damageToEnemy)return this.score;const i=this.scoreFactors.mightInvestment/t,s=e/this.scoreFactors.conquestValue.factors.damageToEnemy;return this.score*i*s}extendPlanFrom(e,t,i,s){if(!i.faction)return!1;const a=i.faction.rawPower,o=t.neighbours((t=>c.Regions.getByHex(e.state,t.id)===i.id)).members.reduce(((t,i)=>{const s=n.AI.getHexImportance(e.state,i.id).value;if(s>t.importance){const n=l.Warfare.getHexDefense(e.state,i),a=e.region.getMyAssets().useUnit({requiredMight:n+1,allowOverkill:!0,incomeGain:1,maxAllowedMight:e.maxAllowedUnitMight,fortificationGain:h.Fortification.getDeltaAfterConquest(e.state,i.id,e.region.id)});return a?{hex:i,importance:s,plan:a}:t}return t}),{importance:0});if(!o.hex)return u.warning("Conquest plan failed: failed to extend plan"),!1;const r=o.importance,d=s.investmentSoFar+o.plan.might;if(r<s.latestExpectedDamage)return u.warning(`Conquest plan canceled: estimated damage if continued to hex ${o.hex} has downward gradient (${r}<${s.latestExpectedDamage})`),!1;if(!e.marshal.moveUnit(o.hex,o.plan))return!1;const p=a-i.faction.rawPower,g=s.damageSoFar+p;return!(this.calculateRealScore(g,d)<s.minimalScore)||this.extendPlanFrom(e,o.hex,i,{minimalScore:s.minimalScore,damageSoFar:g,investmentSoFar:d,latestExpectedDamage:r})}hash(){const e=this.path.slice(0,this.path.length-1);return`Conquer #${this.hex.id}${e.length>0?` through ${e.map((e=>"#"+e.id)).join(", ")}]`:""}`}toString(){return`[${(0,d.formatNumber)(this.score)} | ${this.hash()}`}toDebugString(){return(0,r.describeScoreFactors)(this.scoreFactors)}}},65024:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConquestPlanner=void 0;const s=i(7660),n=i(15496),a=i(42297),o=i(83081),r=i(23441),c=i(40108),l=i(98512),d=i(1591),h=i(29243),u=i(88865);t.ConquestPlanner=class{constructor(e=Number.POSITIVE_INFINITY){this.hardRangeLimit=e,this.name=this.constructor.name,this.isConquest=!0}async*generatePlans(e,t){this.regionAssets=n.RegionAssets.fromMyRegion(e.region),this.state=e.state,this.context=e,this.views=t,this.plans=[],this.maxPlanningRange=(0,r.pickSmaller)(this.hardRangeLimit,l.AIMetrics.attackSkillToPlanningRange(e.aiPersonality.attackSkill));const i=this.regionAssets.remainingUnits.add(1,Math.trunc(this.regionAssets.remainingGold/o.CHEAPEST_UNIT_COST)),s=(i.count(),i.getTotalMight()),c=a.Warfare.getConquerableHexes(this.state,e.region.id,(0,r.pickSmaller)(4,s)).filter((t=>!e.region.hexes.has(t))).members;for(let e of c)this.explore(e,[],this.regionAssets,0,0);for(let e of this.plans)yield e}explore(e,t,i,n,o,p=0,g=0){if(p>=this.maxPlanningRange)return 0;const m=c.AI.getHexInfluence(this.context.state,e.id,this.context.region.id)?.hexDefense??0,y=m+1,f=l.AIMetrics.getJoinRegionsBonus(this.context,e)??{conquestValueBonus:0,incomeGain:0};p+=m+1;const w=a.Warfare.getPotentialLoot(this.state,e);let v;if(m>=0){const e=i.useUnit({requiredMight:m+1,allowOverkill:!0,loot:w,incomeGain:1+f.incomeGain,maxAllowedMight:u.inject.ai.maxAllowedUnitMight});if(!e)return 0;v=e.assets}else v=i;const b=[...t,e],S=(0,r.pickLarger)(this.views.threatAssessment.get(e.id).riskByDefenderMight[m]??0,n),x=o+this.views.defenderBenefit.getForMight(e.id,y),T=(0,r.pickSmaller)(d.AIPolitics.getDiplomaticPenalty(this.context,e),g);let P=0;const M=c.AI.getHexInfluence(this.state,e.id,this.context.region.id);for(let e of M?.children||[]){const t=this.explore(e,b,v,S,x,p,T);t>P&&(P=t)}let I=this.views.conquestValue.get(e.id);I.factors.damageToEnemy=(0,h.estimateDamage)(this.context.state,b),I.total=I.factors.damageToEnemy*I.factors.damageMultiplier+I.factors.valueForMe+I.factors.loot;let A=this.regionAssets.getRemainingAvailableMight()-v.getRemainingAvailableMight();return A<=0&&(A=.1/(1-A)),this.plans.push(new s.ConquestPlan(e,b,{conquestValue:I,diplomacyPenalty:T,downstreamMovesBonus:Math.floor(P/10),joinRegionsBonus:f.conquestValueBonus,threatReduction:x,eradicatePestBonus:0,mightInvestment:A,vulnerabilityPenalty:l.AIMetrics.riskToVulnerabilityPenalty(S,this.context.focus.daring),economyHealth:l.AIMetrics.economyHealth(v,this.context.focus),focusMismatchPenalty:l.AIMetrics.focusMismatchPenaltyV2(this.context,v,"offense")})),Math.max(I.total/b.length,P)}}},34966:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EndTurnPlan=void 0;const s=i(54444),n=i(98512),a=i(54812);t.EndTurnPlan=class{constructor(e,t){this.endsTurn=!0,this.isConquest=!1,this.hex=e.region.getTownHexes().first(),this.utilityFactors={base:10,economyMultiplier:n.AIMetrics.economyHealth(t,e.focus),unusedUnitsPenalty:20*t.remainingUnits.getTotalMight(),focusMultiplier:2*e.focus.thrifty,focusMismatchPenalty:n.AIMetrics.focusMismatchPenaltyV2(e,t,"defense"),unusedGoldPenalty:this.getUnusedGoldMultiplier(t)},this.score=(this.utilityFactors.base-this.utilityFactors.unusedUnitsPenalty)*this.utilityFactors.economyMultiplier*this.utilityFactors.focusMultiplier*this.utilityFactors.focusMismatchPenalty*this.utilityFactors.unusedGoldPenalty}getUnusedGoldMultiplier(e){const t=e.remainingGold+e.remainingIncome;if(e.remainingIncome<0){const t=Math.floor(e.remainingGold/-e.remainingIncome);return 0===t?.01/-e.remainingIncome:-e.remainingIncome/e.totalUnits.count()>t?.1:1}return e.remainingGold<20&&t>=20?2:t>20?(0,a.cropNumber)(.1-(t-20)/50,.01,.1):1}execute(e){return!0}hash(){return"end turn"}toString(){return`[${(0,s.formatNumber)(this.score)} | End Turn]`}toDebugString(){return(0,s.prettyPrintObject)(this.utilityFactors,2)}}},79994:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FrontlineDefensePlan=void 0;const s=i(54444),n=i(85656),a=i(57840),o=i(24794),r=i(78179),c=i(15496),l=i(30420),d=i(88865);t.FrontlineDefensePlan=class{constructor(e,t){this.front=e,this.focusMismatchPenalty=t,this.endsTurn=!1,this.isConquest=!1,this.score=Math.floor(e.score*t),this.hexes=r.HexGroup.fromIds(Object.keys(this.front.plan).map((e=>Number(e)))),this.hex=this.hexes.first()}execute(e){if(0===this.hexes.length)return!1;const t=this.hexes;for(let i of t){const t=this.front.plan[i.id],s=c.RegionAssets.fromMyRegion(e.region);if(t===l.PawnType.Castle){if(!e.marshal.buildCastle((0,o.getHex)(i.id),2))return!1}else{let t=s.useUnit({requiredMight:this.front.toLevel,allowOverkill:!1,maxAllowedMight:d.inject.ai.maxAllowedUnitMight});if(t||1!==this.front.toLevel||(t=s.useUnit({requiredMight:this.front.toLevel,allowOverkill:!0,maxAllowedMight:d.inject.ai.maxAllowedUnitMight})),!t)return!1;if(!e.marshal.moveUnit((0,o.getHex)(i.id),t))return!1}}return!0}hash(){return`${(0,a.describeFrontline)(this.front)}`}toString(){return`[${(0,s.formatNumber)(this.score)} | ${(0,a.describeFrontline)(this.front)}]`}toDebugString(){return(0,s.prettyPrintObject)((0,n.filterDictionary)(this.front,(e=>0!=e)))+`\nfocus mismatch multiplier: ${this.focusMismatchPenalty.toPrecision(2)}\ncovers ${this.front.coveredHexes.size} hexes`}}},89327:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FrontlineDefensePlanner=void 0;const s=i(48500),n=i(57840),a=i(79994),o=i(98512);s.logger.for("ai:FrontlineDefense"),t.FrontlineDefensePlanner=class{constructor(){this.name=this.constructor.name,this.isConquest=!1}async*generatePlans(e,t){if(1===e.focus.daring||e.isOffensiveActionRequired())return;const i=new n.Frontlines(e,t,1),s=new n.Frontlines(e,t,2),r=e.region.getMyAssets();if(0!==r.getRemainingAvailableMight()){for(await i.calculate();!i.bestFronts.empty();)yield new a.FrontlineDefensePlan(i.bestFronts.pop(),o.AIMetrics.focusMismatchPenaltyV2(e,r,"defense"));for(await s.calculate();!s.bestFronts.empty();)yield new a.FrontlineDefensePlan(s.bestFronts.pop(),o.AIMetrics.focusMismatchPenaltyV2(e,r,"defense"))}}}},23874:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ObviousMovesPlanner=void 0;const s=i(15496),n=i(66845),a=i(48500),o=i(20666),r=i(675),c=i(88865),l=i(30420);a.logger.for("ai:SimpleDefensePlanner"),t.ObviousMovesPlanner=class{constructor(){this.isConquest=!0,this.name=this.constructor.name}async*generatePlans(e,t){if(!s.RegionAssets.fromMyRegion(e.region).getObtainableMightLevels().includes(1))return;let i=e.region.getPawns().find((e=>e.hasTrait(o.PawnTraits.Treasure)));c.inject.gameStateModel.map.plugins.zombies&&(i=c.inject.gameStateModel.pawns.findOne({hexes:e.region.getTownHexes().neighbours(),type:[l.PawnType.Zombie]})),i&&(yield new n.PlaceUnitPlan(i.hex,1,{conquestValue:{total:1e3,factors:{...r.NO_CONQUEST_VALUE.factors,loot:1e3}},eradicatePestBonus:0,downstreamMovesBonus:0,joinRegionsBonus:0,threatReduction:0,diplomacyPenalty:0,mightInvestment:1,economyHealth:1,focusMismatchPenalty:1,vulnerabilityPenalty:1}))}}},52956:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaceCastlePlan=void 0;const s=i(88865),n=i(48500),a=i(31524),o=i(54444),r=n.logger.for("ai:PlaceCastlePlan");t.PlaceCastlePlan=class{constructor(e,t,i){this.hex=e,this.might=t,this.scoreFactors=i,this.endsTurn=!1,this.isConquest=!1,this.score=(0,a.aggregateScoreFactors)(i)}execute(e){try{return e.marshal.buildCastle(this.hex,this.might)}catch(e){return r.error(`Failed attempt to place castle at #${this.hex.id}`,e),!1}}hash(){return`Place ${s.inject.gameStateModel.rules.castleByMight(this.might).type} at #${this.hex.id}`}toString(){return`[${(0,o.formatNumber)(this.score)} | ${this.hash()}]`}toDebugString(){return(0,a.describeScoreFactors)(this.scoreFactors)}}},66845:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaceUnitPlan=void 0;const s=i(88865),n=i(15496),a=i(31524),o=i(54444);t.PlaceUnitPlan=class{constructor(e,t,i){this.hex=e,this.might=t,this.utilityFactors=i,this.endsTurn=!1,this.isConquest=!1,this.score=(0,a.aggregateScoreFactors)(i)}execute(e){const t=n.RegionAssets.fromMyRegion(e.region).useUnit({requiredMight:this.might,allowOverkill:!1,maxAllowedMight:s.inject.ai.maxAllowedUnitMight});return!!t&&e.marshal.moveUnit(this.hex,t)}hash(){return`Defend with ${s.inject.gameStateModel.rules.unitByMight(this.might)?.type} at #${this.hex.id}`}toString(){return`[${(0,o.formatNumber)(this.score)} | Defend with ${s.inject.gameStateModel.rules.unitByMight(this.might)?.type} at #${this.hex.id}]`}toDebugString(){return(0,a.describeScoreFactors)(this.utilityFactors)}}},31524:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.describeScoreFactors=t.aggregateScoreFactors=void 0;const s=i(54444);t.aggregateScoreFactors=function(e){return(e.conquestValue.total+e.joinRegionsBonus+e.downstreamMovesBonus+e.threatReduction+e.eradicatePestBonus)*(e.focusMismatchPenalty*e.economyHealth*e.vulnerabilityPenalty/e.mightInvestment)+e.diplomacyPenalty},t.describeScoreFactors=function(e){return`from conquered hex: ${e.conquestValue.total} \n${(0,s.prettyPrintObject)(e.conquestValue.factors,2)} \nfrom downstream potential: ${e.downstreamMovesBonus} \nfrom connecting regions: ${e.joinRegionsBonus}\nfrom threat reduction: ${e.threatReduction}\nfrom eradicating bandit: ${e.eradicatePestBonus}\n---\nmight investment: ${e.mightInvestment}\nfocus mismatch penalty: x${e.focusMismatchPenalty.toPrecision(2)}\neconomy health multiplier: x${e.economyHealth.toPrecision(2)}\nvulnerability multiplier: x${e.vulnerabilityPenalty.toPrecision(2)}\n---\ndiplomatic penalty: ${e.diplomacyPenalty}\n`}},98199:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Planners=void 0;const s=i(34898),n=i(89327),a=i(65024),o=i(44080),r=i(23874);t.Planners={BasicDefense:new s.BasicDefensePlanner(!1),BasicDefenseWithTownProtection:new s.BasicDefensePlanner(!0),FrontlineDefense:new n.FrontlineDefensePlanner,BlockTownAccess:new o.BlockTownAccessPlanner(3),BlockTownAccessMaxPikeman:new o.BlockTownAccessPlanner(2),Conquest:new a.ConquestPlanner,LimitedConquest:new a.ConquestPlanner(5),ObviousMoves:new r.ObviousMovesPlanner}},97654:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shouldForceAction=t.applySituationModifierToFocus=t.adjustPersonalityBasedOnSituation=t.defaultStrategy=void 0;const s=i(48500),n=i(77874),a=i(88865),o=i(54812),r=i(23441),c=i(98199),l=i(54941),d=i(98512);function h(e,t){const i=e.faction.aiPersonality,s=(0,r.pickLarger)(1-t.forecast,.5),n=(t.power+(1-t.forecast))/2,a=(0,r.pickLarger)(n,.4);return{...e.aiPersonality,daring:u(i.daring,s,e.aiPersonality.ambitious),combative:u(i.combative,a,e.aiPersonality.ambitious)}}function u(e,t,i){const s=4*(t-.5)*i;return(0,o.cropNumber)(e+s,(0,r.pickSmaller)(e,.1),(0,r.pickLarger)(e,.98))}function p(e,t){const i=e.faction.getLargestLiveRegion()===e.region,s=a.inject.views.situationScoreByRegion.getComponents({views:t,context:e}).forecast<=.5,n=a.inject.views.powerBalance.get(e.state);return i&&s&&n.isIn1v1Battle(e.faction.id)}s.logger.for("ai:strategy"),t.defaultStrategy=async e=>{const t=new n.SituationExplorer(e);for(;await t.tryBest(1,[c.Planners.ObviousMoves]););const i=t.currentSituation,s=a.inject.views.situationScoreByRegion.getComponents({context:e,views:i.views});e.aiPersonality=h(e,s),e.forceAction=p(e,i.views),e.expansionTarget=d.AIMetrics.getExpansionTarget(e),await e.breakpoint(`ai:strategy: start for region ${e.region.id} (force action=${e.forceAction})`);const o=l.timing.start("executing turn");await t.tryBest(1,[c.Planners.Conquest,c.Planners.ObviousMoves]);const r=t.currentSituation;if(o.complete("done with aggressive opening"),await t.explore(1,[c.Planners.Conquest,c.Planners.BasicDefense,c.Planners.FrontlineDefense,c.Planners.ObviousMoves]),await t.considerCurrentSituation(),e.aiPersonality.daring<1){t.goTo(r),await t.explore(e.aiPersonality.daring,[c.Planners.BasicDefense,c.Planners.FrontlineDefense,c.Planners.ObviousMoves]),await t.considerCurrentSituation(),t.goTo(i);const s=(1+e.aiPersonality.daring)/2;await t.explore(s,[c.Planners.LimitedConquest,c.Planners.BasicDefense,c.Planners.FrontlineDefense,c.Planners.ObviousMoves]),await t.considerCurrentSituation(),t.goTo(i),await t.explore(e.aiPersonality.daring,[c.Planners.LimitedConquest,c.Planners.BasicDefense,c.Planners.FrontlineDefense,c.Planners.BlockTownAccessMaxPikeman,c.Planners.ObviousMoves]),await t.considerCurrentSituation(),t.goTo(i),await t.explore(.75*e.aiPersonality.daring,[c.Planners.LimitedConquest,c.Planners.BasicDefense,c.Planners.BlockTownAccess,c.Planners.ObviousMoves]),await t.considerCurrentSituation()}t.goToBestOutcomeSoFar(),o.complete()},t.adjustPersonalityBasedOnSituation=h,t.applySituationModifierToFocus=u,t.shouldForceAction=p},675:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConquestValueDebugLayer=t.ConquestValue=t.NO_CONQUEST_VALUE=void 0;const s=i(23441),n=i(50264),a=i(40108),o=i(24794),r=i(14344),c=i(5032),l=i(92065),d=i(78179),h=i(54444),u=i(88865),p=i(42297),g=i(29243);t.NO_CONQUEST_VALUE=Object.freeze({total:0,factors:{damageMultiplier:1,damageToEnemy:0,loot:0,valueForMe:0}}),t.ConquestValue=class{constructor(e,t){this.context=e,this.views=t,this.state=this.context.state}get(e){const t="number"==typeof e?[(0,o.getHex)(e)]:e,i=t[t.length-1],n=this.calculateDamageMultiplier(i),a={damageToEnemy:0!==n?(0,g.estimateDamage)(this.state,t):0,damageMultiplier:n,valueForMe:this.calculateHexValueForMe(i),loot:t.map((e=>2*p.Warfare.getPotentialLoot(this.state,e,!0))).reduce(s.sum)};return{total:a.valueForMe+a.damageToEnemy*a.damageMultiplier+a.loot,factors:a}}calculateDamageMultiplier(e){const t=n.Regions.model(this.state).byHex(e);if(!t||t===this.context.region)return 0;const i=(0,s.pickLarger)(1-this.context.aiPersonality.honorable,u.inject.views.hostility.get(this.state,{attackerContext:this.context,targetRegion:t}));return Math.pow(i,3)}calculateHexValueForMe(e){if(this.context.region.hexes.has(e))return 0;const t=(0,s.pickLarger)(1-this.context.focus.daring,.5),i=p.Warfare.getHexDefenseWithoutMovableUnits(this.state,e)+1;return 40*(.5+.5*this.views.planningSecurity.afterPlacingDefender(e.id,i))+e.neighbours((e=>r.Factions.getByHex(this.state,e.id)===this.context.faction.id)).map((e=>{const t=a.AI.getHexImportance(this.state,e.id),n=.5+1/(0,s.pickLarger)(t.distanceFromTown,1),o=.25+.75*this.views.planningSecurity.calculate(e.id,{defense:i});return t.value*o*n})).reduce(s.sum,0)*t/2}calculateLootValue(e){return 2*((p.Warfare.getOccupyingPawn(this.state,e)?.rules.loot??0)+c.Economy.model(this.state).numberOfCoinsAt(e))}getDebugLayer(){return new m(this)}};class m extends l.GameStateDebugLayer{constructor(e){super({getValue(t,i){const s=e.get(i);if(s&&0!==s.total)return s.total.toFixed()},getDetail(t,i){const s=e.get(i);if(s&&0!==s.total)return`${(0,h.prettyPrintObject)(s.factors)}`},getHexes:e=>d.HexGroup.union(n.Regions.model(e).all().map((e=>e.hexes)))}),this.conquestValue=e}}t.ConquestValueDebugLayer=m},3557:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefenderBenefitView=void 0;const s=i(95437),n=i(24794),a=i(40108),o=i(85656),r=i(92065),c=i(50921),l=i(54444),d=i(23441),h=i(42297),u=i(78179),p=.01;class g extends s.CalculatedHexGroupValuationWithCache{constructor(e,t){super(),this.context=e,this.security=t,this.isDisjointedCache={}}calculate(e){return(0,o.mapDictionary)({1:0,2:0,3:0},((t,i)=>this.calculateForMight(e,i)))}calculateForMight(e,t){const i=(0,n.getHex)(e);if(this.isDisjointed(i))return 0;let s=0;if(this.context.region.hexes.has(i)){const n=this.security.afterPlacingDefender(e,t);s+=this.getBenefit(i,n,t)}for(let e of this.context.region.hexes.neighboursOf(i)){const i=this.security.calculate(e.id,{defense:t});s+=this.getBenefit(e,i,t)}return s}isDisjointed(e){return void 0===this.isDisjointedCache[e.id]&&(this.isDisjointedCache[e.id]=this.calculateIsDisjointed(e)),this.isDisjointedCache[e.id]}calculateIsDisjointed(e){if(this.security.get(e.id)>p)return!1;const t=this.context.region.hexes.has(e)?a.AI.getHexImportance(this.context.state,e.id).parents:e.neighbours((e=>this.context.region.hexes.has(e))).members;return!t.some((e=>this.security.get(e.id)>p))&&!u.HexGroup.union(t.map((e=>u.HexGroup.from(a.AI.getHexImportance(this.context.state,e.id).parents)))).members.some((e=>this.security.get(e.id)>p))}getBenefit(e,t,i){const s=this.security.get(e.id),o=h.Warfare.getHexDefenseWithoutMovableUnits(this.context.state,(0,n.getHex)(e.id)),r=((0,d.pickLarger)(0,i-o),(0,d.pickLarger)(t,0));return(0,d.pickLarger)(0,r-s)*a.AI.getHexImportance(this.context.state,e.id).value}getDebugLayer(){const e=this;return new r.GameStateDebugLayer((0,c.hexBasedAdapter)({getValue:(t,i)=>Object.entries(e.get(i)).reduce(((e,t)=>t[1]>e[1]?t:e))[1].toFixed(),getDetail:(t,i)=>(0,l.prettyPrintObject)(e.get(i))}))}getForMight(e,t){return this.get(e)[t]??0}}t.DefenderBenefitView=g},5957:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PowerBalanceView=void 0;const s=i(54379),n=i(47610),a=i(14344),o=(i(48500).logger.for("PowerBalanceView"),Object.freeze({dominance:0,factionsByPower:[],totalPower:0,dominantFaction:null,is1v1situation:!1,isIn1v1Battle:e=>!1}));class r extends s.LazyView{constructor(){super([n.GameState.ai.powerByFaction,n.GameState.ai.approval])}calculate(e){const t=a.Factions.model(e).all().filter((e=>e.isAlive()&&!e.isNeutral())).sort(((e,t)=>t.scaledPower-e.scaledPower)),i=t.reduce(((e,t)=>e+t.scaledPower),0),s=t[0];if(!s)return o;const n=t[0].scaledPower,r=t[1]?.scaledPower??0,c=Math.floor(100*(s.scaledPower/r-1)),l=(n+r)/i>.75;return{totalPower:i,dominantFaction:s,dominance:c,is1v1situation:l,factionsByPower:t,isIn1v1Battle:e=>l&&(e===s.id||e===t[1]?.id)}}getCacheKey(){}}t.PowerBalanceView=r},94621:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createSecurityDebugLayer=t.SecurityView=void 0;const s=i(42297),n=i(52937),a=i(47610),o=i(16972),r=i(40108),c=i(41707),l=i(88865),d=i(23441),h=i(95437),u=i(24794),p=i(98512),g=i(54812),m=i(14344),y=i(50264),f=i(12678),w=i(85656),v=i(30420),b=i(51019);class S extends h.CalculatedHexGroupValuationWithCache{constructor(e,t){super(),this.params=e,this.tag=t}calculate(e,t){const{isTownHex:i,parentsSecurity:s,hexSecurity:n}=this.getFactors(e,t);return i?n:0===s.length?0:g.Probability.ofEvery(n,Math.max(...s))}getFactors(e,t){const i=this.params.faction.state,n=y.Regions.getByHex(i,e);f.assert.defined(n);const a=s.Warfare.getOccupyingPawn(i,(0,u.getHex)(e))?.type===v.PawnType.Town,o=this.params.threatAssessment.get(e),c=(0,d.pickLarger)(s.Warfare.getHexDefenseWithoutMovableUnits(i,(0,u.getHex)(e)),t?.defense??0);if(a){const e=(0,w.stripDuplicatesFrom)(o.regions.map((e=>m.Factions.getByRegion(i,e)))).some((e=>e&&r.AI.getRegionAttrition(i,n,e)>2));return{isTownHex:!0,parentsSecurity:[],hexSecurity:(0,b.adjustMultiplierByFocus)(p.AIMetrics.riskToTownSecurity(o.riskByDefenderMight[c]??0,e),1-this.params.recklessness)}}{const s=r.AI.getHexImportance(i,e);return{isTownHex:!1,parentsSecurity:(t?.parents??s.parents).map((e=>this.get(e.id))),hexSecurity:(0,b.adjustMultiplierByFocus)(p.AIMetrics.riskToSecurity(o.riskByDefenderMight[c]??0),1-this.params.recklessness)}}}afterPlacingDefender(e,t){const i=this.params.faction.state;let n;n=m.Factions.getByHex(i,e)===this.params.faction.id?r.AI.getHexImportance(i,e).parents:(0,u.getHex)(e).neighbours((e=>m.Factions.getByHex(i,e.id)===this.params.faction.id)).members;const a=this.getFactors(e,{defense:s.Warfare.getHexDefenseAfterCapturedBy(i,(0,u.getHex)(e),this.params.faction.id,t),parents:n}),o=n.map((e=>this.calculate(e.id,{defense:t})));return 0===o.length&&o.push(1),g.Probability.ofEvery(a.hexSecurity,Math.max(...o))}getDebugLayer(){return x(this)}setRecklessness(e){e!==this.params.recklessness&&(this.params.recklessness=e,this.flush())}}function x(e){let t=(0,n.signal)();const i=l.inject.gameStateModel;return i.stateEngine.watchDataSet(a.GameState.ai.regionInfluenceByHex,(()=>{t.fire()})),i.stateEngine.watchDataSet(a.GameState.ai.hexImportance,(()=>{t.fire()})),{name:"ai.exposedAssets",onChange:t,getMap(){let t=new o.CustomHexGroupValuation("");return e.params.faction.hexes.forEach((i=>{const s=100*e.get(i.id);t.set(i.id,100===s?c.GLYPH.defense:s.toFixed())})),t},getDetail(t){const n=e.getFactors(t.id);return`this hex total risk: ${e.params.threatAssessment.get(t.id).risk}            \nthis hex relevant risk: ${e.params.threatAssessment.get(t.id).riskByDefenderMight[s.Warfare.getHexDefense(i.state,t)]}\nthis hex security: ${n.hexSecurity.toFixed(2)}\nparents: ${n.parentsSecurity.map((e=>e.toFixed(2))).join(", ")}\ntotal: ${e.get(t.id)}\nwith villager: ${e.afterPlacingDefender(t.id,1)}\nwith pikeman: ${e.afterPlacingDefender(t.id,2)}\n`}}}t.SecurityView=S,t.createSecurityDebugLayer=x},7080:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.estimateStrongestUnitAtRange=t.ThreatAssessmentDebugLayer=t.ThreatAssessment=void 0;const s=i(40108),n=i(14344),a=i(24794),o=i(42297),r=i(92065),c=i(95437),l=i(50264),d=i(54812),h=i(23441),u=i(48500),p=i(88865),g=i(41707),m=i(96486),y=i(1591),f=i(98512),w=i(14008);u.logger.for("ai:ThreatAssessment");class v extends c.CalculatedHexGroupValuationWithCache{constructor(e){super(),this.faction=e,this.perceivedThreat={}}getPerceivedThreat(e,t){const i=e+"->"+t;if(void 0===this.perceivedThreat[i]){const s=l.Regions.model(this.faction.state),n=s.byId(e),a=s.byId(t);this.perceivedThreat[i]=y.AIPolitics.getPerceivedThreat(n,a)}return this.perceivedThreat[i]}calculate(e){const t=this.calculateComponents(e),i=[0,0,0,0];for(const e of t)for(let t=0;t<e.riskByDefenderMight.length;++t)i[t]=d.Probability.ofEither(i[t],e.riskByDefenderMight[t]);const s=i.map(((e,t)=>e/(t+1)*3)).reduce(h.pickLarger);return{riskByDefenderMight:i,regions:t.map((e=>e.regionId)),strongestUnit:t.map((e=>e.riskByDefenderMight.length)).reduce(h.pickLarger,0),risk:s}}getDebugLayer(){return new b(this)}calculateComponents(e){const t=this.faction.parentModel.state,i=l.Regions.model(t),r=n.Factions.getByHex(t,e);if(void 0===r)return[];const c=s.AI.getHexInfluence(t,e).filter(((e,s)=>{const a=n.Factions.getByRegion(t,s);return e&&a&&a!==this.faction.id&&a!==r&&i.byId(s)?.isAlive()})).map(((i,s)=>{const n=l.Regions.model(t).byId(s);if(!n)return{regionId:s,riskByDefenderMight:[]};const c=o.Warfare.getHexDefenseWithoutMovableUnits(t,(0,a.getHex)(e)),d=l.Regions.model(t).byHex(e),h=n.getEnemyAssets(),u=S({totalMight:h.getTotalAvailableMight(),maxUnitMight:h.getMaxAvailableMight(),maxUnitCount:h.getObtainableUnitCount(),resistance:i.resistance-(0,w.defenseToResistance)(c)-1,distance:i.distance,cost:i.cost,skill:this.faction.aiPersonality.defenseSkill});return u<=c?{regionId:s,riskByDefenderMight:[]}:{regionId:s,riskByDefenderMight:[1,2,3,4].filter((e=>e<=u)).map((e=>{if(e<=c)return 0;const t=f.AIMetrics.getBaseAttackProbability(h,e,c,i.distance,i.cost);let s=1;r===this.faction.id&&(s=this.getPerceivedThreat(n.id,d.id));const a=s*t;return a<.01?0:a>1?1:a}))}})).valueSeq().toArray().filter((({regionId:e,riskByDefenderMight:t})=>t.length>0)),d=i.byHex((0,a.getHex)(e));if(d.faction?.id!==this.faction.id&&d.isAlive()){const i=d.getEnemyAssets(),s=i.getMaxAvailableMight(),n=i.getMaxSustainableMight();c.push({regionId:l.Regions.getByHex(t,e),riskByDefenderMight:[1,2,3,4].filter((e=>e<=s)).map((e=>e>n?.1:1))})}return c}}t.ThreatAssessment=v;class b extends r.GameStateDebugLayer{constructor(e){super({getValue(t,i){const s=e.get(i);if(s&&0!==s.strongestUnit)return`${(0,m.round)(s.risk,2)}`},getDetail(t,i){const s=p.inject.gameStateModel;if(!s.regions.byHex((0,a.getHex)(i)))return;const o=e.calculateComponents(i).sort(((e,t)=>e.regionId-t.regionId)).map((e=>{const i=n.Factions.getByRegion(t,e.regionId)??0;return e.riskByDefenderMight.map(((t,s)=>`  ${g.GLYPH.sword}${s+1} (${(100*t).toFixed(0)}%) from ${g.GLYPH.factions[i]}${e.regionId}`)).join("\n")})),r=Object.entries(e.get(i).riskByDefenderMight).filter((([e,t])=>t>0)).map((([e,t])=>`  ${g.GLYPH.sword}${Number(e)+1} ${(100*t).toFixed(0)}%`));return o.join("\n")+"\n----- total -----\n"+r.join("\n")+"\n"+`game ending threat: ${f.AIMetrics.getObviousGameEndingThreat(s.regions.byHex((0,a.getHex)(i)),e)}`},getHexes:e=>l.Regions.model(e).allRegionsHexes()}),this.assessment=e}}function S(e){const t=.5+.5*e.skill,i=Math.ceil((e.maxUnitCount-(e.distance-1))*t),s=e.totalMight*t-e.resistance;return i<=0?0:(0,h.pickLarger)(0,(0,h.pickSmaller)(Math.ceil(s),e.maxUnitMight))}t.ThreatAssessmentDebugLayer=b,t.estimateStrongestUnitAtRange=S},29243:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createDamageSimDebugLayer=t.estimateDamage=void 0;const s=i(50264),n=i(5032),a=i(42297),o=i(65955),r=i(40108),c=i(78179),l=i(92065),d=i(50921),h=i(24794),u=i(30420),p=i(20666),g=i(88865),m=i(14344);function y(e,t){if(0===t.length)return 0;const i=s.Regions.getByHex(e,t[t.length-1].id);if(void 0===i||!n.Economy.isRegionAlive(e,i))return 0;const l=c.HexGroup.from(t.filter((t=>s.Regions.getByHex(e,t.id)===i))),d=l.find((t=>s.Regions.isPotentialChokePoint(e,t.id)))?c.HexGroup.fromIds(s.Regions.getRegionHexes(e,i).toArray()).without(l).components():void 0;return d&&d.length>0?function(e,t,i){const s=o.AssetValue.total(r.AI.getRegionAssetsValue(e,t));let c=0;for(let t of i){let i=0,s=0,r=0,l=0,d=0,h=!1;for(let c of t){const t=a.Warfare.getOccupyingPawn(e,c);if(i+=o.AssetValue.HEX_BASE_VALUE,r+=n.Economy.getIncomeFromHex(e,c.id),t){l+=t?.upkeep??0;const a=o.AssetValue.total(o.AssetValue.getPawnFactors(t.type,t.count));t.hasTrait(p.PawnTraits.Unit)?s+=a:i+=a,t?.type===u.PawnType.Town&&(d+=n.Economy.getNumberOfCoinsAt(e,c.id),h=!0)}}const g=!h||d+r<0;h&&(c+=g?i:i+s)}return s-c}(e,i,d.getGroups()):function(e,t,i){let s=0,c=0,l=0,d=0;for(let t of i){const i=a.Warfare.getOccupyingPawn(e,t);i?.type===u.PawnType.Town&&++d;const r=i?i.upkeep:0;s+=o.AssetValue.getTotal(e,t),c=n.Economy.getIncomeFromHex(e,t.id)-r,l+=n.Economy.getNumberOfCoinsAt(e,t.id)}const h=n.Economy.getTreasuryOf(e,t),p=n.Economy.getRegionBudget(e,t).balance,y=n.Economy.getTownHexesByRegion(e,t).size,f=h-l,w=p-c,v=y-d==0,b=n.Economy.isRegionBankrupt(e,t),S=f+w<0||y-d==0;return v&&function(e,t){const i=m.Factions.getByRegion(e,t);if(!i)return!1;const s=m.Factions.getFactionRegions(e,i);return 2===g.inject.views.powerBalance.get(e).factionsByPower.length&&1===s.length}(e,t)?1e6:!b&&S?o.AssetValue.total(r.AI.getRegionAssetsValue(e,t)):b&&!S?-o.AssetValue.total(r.AI.getRegionAssetsValue(e,t)):s}(e,i,l)}t.estimateDamage=y,t.createDamageSimDebugLayer=function(){return new l.GameStateDebugLayer((0,d.hexBasedAdapter)({getValue:(e,t)=>y(e,[(0,h.getHex)(t)]),getDetail:(e,t)=>y(e,[(0,h.getHex)(t)]).toString()}))}},48361:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getAppController=void 0;const s=i(14472),n=i(79928),a=i(57680),o=i(2662);t.getAppController=function(e){switch(e){case"standard":default:return new s.GameAppController;case"storybook":return new n.StorybookAppController;case"scalingpoc":return new a.ScalingPOC;case"replaybrowser":return new o.ReplayBrowserAppController}}},14472:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getTotalBytesTransferred=t.getServiceWorkerStatus=t.GameAppController=void 0;const s=i(11930),n=i(48500),a=i(91025),o=i(77705),r=i(59674),c=i(82966),l=i(65953),d=i(69965),h=i(60925),u=i(57492),p=i(1215),g=i(23979),m=i(90797),y=i(47038),f=i(24592),w=i(44906),v=i(90571),b=i(19132),S=i(10298),x=i(300),T=i(84370),P=i(93440),M=i(53270),I=i(75071),A=i(81590),C=i(11041),B=i(12678),E=i(16310),R=i(54941),O=i(60807),_=i(54427),H=i(53994),D=i(70942),k=i(39835),j=i(75326),L=i(88865),F=i(58592),U=i(68338),G=i(24275),N=i(97520),V=i(83742),z=i(30258),W=i(82169),$=i(80682),Y=i(99896),X=i(60536),q=i(58586),K=n.logger.for("AppController");function J(){try{return navigator.serviceWorker?.controller?.state||"none"}catch(e){return`error: ${e}`}}function Q(){try{return performance.getEntriesByType("resource").reduce(((e,t)=>e+t.transferSize),0)}catch(e){return console.error("Failed to measure total bytes transferred",e),0}}t.GameAppController=class{constructor(){this.initialized=!1}getScenes(){return[h.PreloadScene,b.LevelSelectUIScene,x.LevelDetailUIScene,u.WorldMapScene,p.PlayScene,g.MapEditorScene,m.PlayUIScene,S.MenuHeaderUIScene,v.TitleScreenUIScene,P.VictoryScene,_.DefeatScene,D.RandomMapSelectScene,U.SidePanelScene,M.GlobalUIScene,l.ModalWindowScene,y.DebugScene,w.DebugHistoryScene]}run(){const{events:e,gameStateController:t}=L.inject,{game:i}=F.app;console.info("GameAppController running"),this.initialized=!0,L.inject.config.watch((e=>{(0,H.setDatGUIVisible)(e.debug.datgui),e.debug.overlay?(i.scene.isSleeping(s.Scenes.Debug)?i.scene.resume(s.Scenes.Debug):i.scene.run(s.Scenes.Debug),"string"==typeof e.debug.overlay&&c.commands.debug.dataSet(e.debug.overlay)):i.scene.isActive(s.Scenes.Debug)&&i.scene.sleep(s.Scenes.Debug)})),e.setDefaultHandler((e=>{I.ErrorTracking.logEvent(e)})),e.on(a.SystemEvents.EngineInitialized,(async()=>{if(O.track.bootComplete({total_load_time_ms:R.timing.since(window.tStart),local_storage_available:F.app.device.hasLocalStorage,service_worker_status:J(),map_registry_load_time_ms:L.inject.mapRegistry.loadTime,total_transferred_bytes:Q()}),A.ActivityWatcher.start(),L.inject.ui.spectatingSpeed.set(L.inject.userData.recallChoice("spectatingSpeed")||L.SpectatingPlaybackSpeed.Normal),(0,V.setupFileDropZone)("phaser-game"),F.app.reporting.setupTelemetryReporting(),L.inject.ui.session.initialize(),i.scene.run(s.Scenes.GlobalUI),i.scene.run(s.Scenes.SidePanel),L.inject.config.debug.overlay&&i.scene.run(s.Scenes.Debug),!await(0,N.parseUrlHash)())if(0!==Object.keys(L.inject.userData.current.levels).length||L.inject.config.flags.skipTutorial)await F.app.navigator.goTo(F.app.screen.title);else{k.NewsBox.hide();const e=L.inject.mapRegistry.getCampaignById("intro");B.assert.defined(e),L.inject.events.trigger(a.UserActions.PlayLevel({levelId:e.levels[0].id,origin:"deep-link"}))}if(!F.app.device.hasLocalStorage){const e="https://www.konkr.io"===F.app.device.url;F.app.notifications.warning("Saving unavailable","Your browser privacy settings don't allow the game to save progress between sessions while playing on this website. If you want to save your progress, review your browser settings"+(e?".":" or try playing at https://www.konkr.io."))}})),e.on(a.UserActions.OpenExportMapDialog,(()=>{const e=(0,W.compressGameState)(L.inject.gameStateController.currentState),t=(0,f.encodeGameState)(e),i=e.map.levelId;(0,z.downloadAsTextFile)(`${i}.konkr`,t)})),e.on(a.UserActions.EditMapJSON,(()=>{const e=L.inject.gameStateModel.exportState();F.app.modals.show(d.UI.editMapJSONDialog,{gameState:e})})),e.on(a.UserActions.OpenLoadGameDialog,(()=>{F.app.modals.show(d.UI.loadGame,{onLoad:e=>{try{(0,q.parseKonkrData)(e)}catch(e){F.app.modals.message("Looks like the save data is corrupted or incompatible\nwith this version of the game. Sorry!")}}})})),e.on(a.UserActions.EditMap,(()=>{try{L.inject.userData.saveLevelProgress()}catch(e){K.error(e)}F.app.navigator.goTo(F.app.screen.mapEditor)})),e.on(a.UserActions.PlayLevel,(async({levelId:e,origin:t})=>{const i=C.LevelModel.for(e);let s,n;const a=i.getLevelStatus();a===C.LevelStatus.InProgress||a==C.LevelStatus.Replaying?(s=await i.getCurrentState(),B.assert.defined(s),n=L.inject.ui.session.levelId===e?T.NewGameStateContext.ResumingGame:T.NewGameStateContext.LoadingGame,L.inject.ui.session.startNew({levelId:e,sessionId:i.userData?.inProgress?.levelSessionId,remainingLives:i.userData?.inProgress?.lives,origin:t,turnNumber:s.currentPhase.turnNumber})):(n=T.NewGameStateContext.StartingNewGame,i.parentCampaign||L.inject.userData.saveConquestLevelStartingState(),s=await i.getStartingState(),B.assert.defined(s),L.inject.ui.session.startNew({levelId:i.id,origin:t,turnNumber:s.currentPhase.turnNumber})),L.inject.config.flags.zombiesEverywhere&&(s=(0,X.zombifyLevel)(s)),L.inject.gameStateController.loadState(s,n),F.app.navigator.goTo(F.app.screen.play,n)})),e.on(a.UserActions.InternalLoadGame,(e=>{const i=(0,o.loadGame)(e);t.loadState(i,T.NewGameStateContext.LoadingGame),L.inject.ui.session.startNew({levelId:$.WorldMap.get(t.currentState).levelId,remainingLives:E.DEFAULT_LIVES_PER_LEVEL,origin:"debug-tool",turnNumber:Y.CurrentPhase.getTurnNumber(t.currentState)}),L.inject.config.autoSaveOnTurnStart&&"auto"!==e&&L.inject.userData.saveLevelProgress(),F.app.navigator.goTo(F.app.screen.play,T.NewGameStateContext.LoadingGame),F.app.scene.worldMap.cameraController.center()})),e.on(a.UserActions.CreateBlankMap,(async e=>{(0,j.createBlankMap)(30,30),L.inject.gameStateModel.activateAllProjections(),F.app.scene.worldMap.syncState()})),e.on(a.UserActions.SyncWithModel,(e=>{t.loadState(t.currentState,T.NewGameStateContext.LoadingGameStateForDebug)})),e.on(a.UserActions.SaveGame,(e=>{(0,r.saveGame)(e)})),e.on(a.UserActions.DebugGameState,(e=>{t.loadState(e,T.NewGameStateContext.LoadingGameStateForDebug)})),e.on(a.UserActions.SendTweet,(()=>{O.track.interaction("feedback_twitter"),window.open(L.inject.config.socials.twitterUrl,"_blank")})),e.on(a.UserActions.JoinDiscord,(()=>{O.track.interaction("feedback_discord"),window.open(L.inject.config.socials.discordUrl,"_blank")})),e.on(a.UserActions.SendEmail,(()=>{O.track.interaction("feedback_email"),window.open("mailto:"+L.inject.config.socials.email,"_blank")})),e.on(a.UserActions.SetSpectatingPlayBackSpeed,(e=>{L.inject.ui.spectatingSpeed.set(e),e!==L.SpectatingPlaybackSpeed.Paused&&L.inject.userData.rememberChoice("spectatingSpeed",e)})),e.on(a.UserActions.GoToMapGeneration,(()=>{F.app.navigator.goTo(F.app.screen.mapGeneration)})),e.on(a.UserActions.GoToRandomMapSelect,(()=>{F.app.navigator.goTo(F.app.screen.randomMapSelect)})),e.on(a.UserActions.ShowHowToPlay,(()=>{O.track.interaction("how_to_play"),L.inject.ui.sidebarMode.set(G.SideBarButtonKeys.Help)}))}},t.getServiceWorkerStatus=J,t.getTotalBytesTransferred=Q},2662:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReplayBrowserAppController=void 0;const s=i(60925),n=i(57492),a=i(1215),o=i(90797),r=i(10298),c=i(53270),l=i(65953),d=i(47038),h=i(44906),u=i(73685),p=i(13010),g=i(11930),m=i(58592),y=i(91025),f=i(88865),w=i(39835);t.ReplayBrowserAppController=class{getScenes(){return[s.PreloadScene,n.WorldMapScene,a.PlayScene,o.PlayUIScene,r.MenuHeaderUIScene,c.GlobalUIScene,l.ModalWindowScene,d.DebugScene,h.DebugHistoryScene]}run(){this.initialized=!0,f.inject.events.on(y.SystemEvents.EngineInitialized,(async()=>{const{game:e}=m.app;var t;w.NewsBox.hide(),e.scene.run(g.Scenes.GlobalUI),t=e=>{"IFRAME.LOAD_REPLAY"===e.name&&(f.inject.ui.spectatingSpeed.set(f.SpectatingPlaybackSpeed.Paused),(0,p.loadReplay)(e.payload.replayData))},window.addEventListener("message",(e=>{"object"==typeof e&&"object"==typeof e.data&&(0,u.isMessage)(e.data)&&t(e.data)})),parent.postMessage(u.Messages.ReadyToReceiveReplay(),{targetOrigin:"*"})})),f.inject.events.on(y.UserActions.SetSpectatingPlayBackSpeed,(e=>{f.inject.ui.spectatingSpeed.set(e)}))}}},79928:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StorybookAppController=void 0;const s=i(48500),n=i(91025),a=i(65953),o=i(69965),r=i(60925),c=i(82169),l=i(39835),d=i(88865),h=i(58592);s.logger.for("AppController"),t.StorybookAppController=class{constructor(){this.initialized=!1}getScenes(){return[r.PreloadScene,a.ModalWindowScene]}run(){d.inject.events.on(n.SystemEvents.EngineInitialized,(()=>{l.NewsBox.hide(),h.app.modals.show(o.UI.editMapJSONDialog,{gameState:(0,c.compressGameState)(d.inject.currentGameState)},(e=>console.info("RESULT",e)))})),this.initialized=!0}}},82966:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CUSTOM_WORLD_DEBUG_LAYERS=t.createHexHistoryDebugLayer=t.createPawnsByHexDebugLayer=t.createHexIdDebugLayer=t.registerConsoleCommands=t.commands=void 0;const n=i(91025),a=i(47610),o=i(30420),r=i(12678),c=s(i(11227)),l=i(98030),d=i(69905),h=i(14008),u=i(40108),p=i(54444),g=i(65025),m=i(14344),y=i(92065),f=i(74064),w=i(79738),v=i(7080),b=i(50921),S=i(15802),x=i(77874),T=i(7407),P=i(24592),M=i(82169),I=i(75071),A=i(3910),C=i(50264),B=i(91989),E=i(88865),R=i(58592),O=i(97520),_=i(57840),H=i(79516),D=i(62977),k=i(41707),j=i(675),L=i(24794),F=i(54941),U=i(84370),G=i(31129),N=i(42297),V=i(36473),z=i(23979),W=s(i(35369)),$=i(29243),Y=i(92578),X=i(30258),q=i(22766),K=i(5427),J=i(13010);function Q(){return new y.GameStateDebugLayer((0,b.hexBasedAdapter)({getValue:(e,t)=>t.toString(),getDetail:(e,t)=>t.toString()}))}function Z(){return new y.GameStateDebugLayer((0,b.hexBasedAdapter)({getValue(e,t){const i=D.Pawns.getByHex(e,t);if(0!==i.length)return i.join(" ")},getDetail:(e,t)=>D.Pawns.model(e).byHex(t).map((e=>e.toString())).join("\n")}))}function ee(){return new y.GameStateDebugLayer((0,b.hexBasedAdapter)({getValue(e,t){const i=u.AI.getHexHistory(e,t);if(0!==i.capturedAt)return`${u.AI.getHexAge(e,t)}${function(e){switch(e.spoils){case"deadHex":return"";case"liveHex":return k.GLYPH.whiteFlag;default:return k.GLYPH.redFlag}}(i)}`},getDetail(e,t){const i=u.AI.getHexHistory(e,t);if(0!==i.capturedAt)return(0,p.prettyPrintObject)(i)}}))}function te(e){const t=E.inject.gameStateModel.stateEngine;let i=`${(0,l.isProjectionDataSet)(e)?t.isDataSetActive(e)?"●":"○":"■"} ${e.key} (${e.constructor.name})`;return(0,l.isProjectionDataSet)(e)&&(i+=`\nbased on:\n${e.parents.map((e=>`  ${ie(e)} ${e.key}`)).join("\n")}`),i+=`\nused by:\n${t.childrenOf(e).map((e=>`  ${ie(e)} ${e.key}`)).join("\n")}`,i}function ie(e){return(0,l.isProjectionDataSet)(e)?E.inject.gameStateModel.stateEngine.isDataSetActive(e)?"●":"○":"■"}t.commands={game:{save:(e="auto")=>{E.inject.events.trigger(n.UserActions.SaveGame(e)),(0,O.updateUrlHash)("quickload")},resume:()=>{E.inject.events.trigger(n.UserActions.ResumeGame())},load:(e="auto")=>{E.inject.events.trigger(n.UserActions.InternalLoadGame(e))},decode(e){const t=(0,P.decodeGameState)(e);console.log(JSON.stringify(t,null,2))},export(){const e=JSON.stringify((0,M.compressGameState)(E.inject.gameStateModel.state));console.log(e)},import(e){const t=JSON.parse(e);E.inject.gameStateModel.restore(t),E.inject.events.trigger(n.UserActions.DebugGameState(E.inject.currentGameState))},rewind:()=>{E.inject.events.trigger(n.UserActions.StartRewind())},endTurn:()=>{E.inject.gameStateController.executePlay(n.Plays.EndTurn())},setFaction:(e,t)=>{E.inject.gameStateModel.stateEngine.apply(a.GameState.factions.byId.createMutation({set:{[e]:{...E.inject.gameStateModel.stateEngine.get(a.GameState.factions.byId,e),controller:t}}},"command"))},setTheme(e){E.inject.userData.rememberChoice("preferredTheme","themeId"),E.inject.events.trigger(n.UserActions.SyncWithModel())},takeOver(e){if(void 0===e)for(let e of E.inject.gameStateModel.factions.all().filter((e=>e.controller===o.FactionController.Ai)))t(e.id);else t(e);function t(e){E.inject.gameStateModel.stateEngine.apply(a.GameState.factions.byId.createMutation({set:{[e]:{...E.inject.gameStateModel.stateEngine.get(a.GameState.factions.byId,e),controller:o.FactionController.LocalUser}}},"command"))}},sync:()=>{E.inject.events.trigger(n.UserActions.SyncWithModel())},get state(){return E.inject.gameStateModel.stateEngine.serialize()},get rawState(){return E.inject.gameStateModel.stateEngine.currentState},get stateModel(){return E.inject.gameStateModel},get stateController(){return E.inject.gameStateController},win(){E.inject.config.debug.cheats&&(E.inject.gameStateModel.pawns.select({type:[o.PawnType.Town]}).filter((e=>1!==e.faction?.id)).forEach((e=>e.destroy())),R.app.scene.worldMap.syncState())}},debug:{off(){const e=E.inject.config.debug;e.tweenSpeedFactor=1,e.overlay=!1,e.recordStateChanges=!1,e.integrityChecks=void 0,e.ai=!1,e.datgui=!1,E.inject.debugLayers.activate(void 0)},on(){E.inject.config.debug.overlay=!0},edit:()=>{R.app.navigator.goTo(R.app.screen.mapEditor)},logs(e){c.default.enable(e)},history(){R.app.navigator.goTo(R.app.screen.debugHistory)},gameHistory(){console.log(E.inject.gameStateController.history.debugDump(1e3))},borders(){E.inject.debugLayers.activate("TileBordersManager")},layer(e){(0,r.assert)(E.inject.debugLayers.get(e),`unknown debug layer ${e}`),E.inject.debugLayers.activate(e)},dataSet(e){const i=E.inject.gameStateModel.stateEngine.getDataSetByKey(e);if(!i)throw new Error(`No dataset found for key "${e}"`);if(!E.inject.debugLayers.get(e)){const s=t.CUSTOM_WORLD_DEBUG_LAYERS[e],n=s?s():new y.GameStateDebugLayer((0,w.dataSetAdapter)(i));E.inject.debugLayers.register(e,n)}E.inject.debugLayers.activate(e),console.log(te(i))},dataSets(){const e=E.inject.gameStateModel.stateEngine;console.log(e.getAllDataSets().toArray().sort((function(e,t){let i=e.key.split(".")[0],s=t.key.split(".")[0],n=i+"."+((0,l.isProjectionDataSet)(e)?"Z":"A")+"."+e.key,a=s+"."+((0,l.isProjectionDataSet)(t)?"Z":"A")+"."+t.key;return(0,d.compareStrings)(n,a)})).map((t=>`${(0,l.isProjectionDataSet)(t)?e.isDataSetActive(t)?"●":"○":"■"} ${t.key} (${t.constructor.name})`)).join("\n"))},factionDataSet(e){const t=E.inject.gameStateModel.stateEngine,i=E.inject.gameStateModel.stateEngine.getDataSetByKey(e);if(!i)throw new Error(`No dataset found for key "${e}"`);console.log(te(i));const s=(0,l.selectFromState)(t.currentState,i).entrySeq(),n=s.map((([e])=>e)).toJS(),a=s.map((([e,t])=>t)).toJS();console.table({faction:n,value:a})},hexImportance(){E.inject.debugLayers.activate("ai.hexImportance")},threatAssessment(e=E.inject.gameStateModel.currentPhase.faction?.id||1){const t=E.inject.gameStateModel.factions.byId(e),i=new v.ThreatAssessment(t);E.inject.debugLayers.registerAndActivate("threatAssessment",i.getDebugLayer())},benchmarkRegionInfluence(){const e=(0,P.decodeGameState)(G.BUILT_IN_MAPS.benchmark);E.inject.gameStateController.loadState(e,U.NewGameStateContext.LoadingGameStateForDebug);for(let e=0;e<=4;++e){const t=F.timing.start(`REGION INFLUENCE BENCHMARK RUN #${e}`);for(let e=0;e<10;++e)a.GameState.ai.regionInfluenceByHex.bootstrap(E.inject.currentGameState);t.complete()}},benchmarkThreatAssessment(){const e=(0,P.decodeGameState)(G.BUILT_IN_MAPS.benchmark);E.inject.gameStateController.loadState(e,U.NewGameStateContext.LoadingGameStateForDebug);for(let e=0;e<=4;++e){const t=F.timing.start(`THREAT ASSESSMENT BENCHMARK RUN #${e}`);for(let e=0;e<10;++e)for(let e of E.inject.gameStateModel.factions.all()){const t=new v.ThreatAssessment(e);for(let i of e.hexes)t.calculate(i.id)}t.complete()}},conquestValue(e=E.inject.gameStateModel.currentPhase.faction?.id||1){const t=E.inject.gameStateModel.factions.byId(e),i=new H.RegionAIContext(t.getRegions()[0]),s=new j.ConquestValue(i,(0,x.createAiViews)(i));E.inject.debugLayers.registerAndActivate("conquestValue",s.getDebugLayer())},security(e,t){e||(e=E.inject.gameStateModel.regions.byId(E.inject.ui.session.selectedRegionId)?.faction?.id);const i=E.inject.gameStateModel.factions.byId(e);r.assert.defined(i,"invalid faction id");const s=(0,x.createAiViews)((0,H.createAiContext)(i.getLargestLiveRegion()));t&&s.planningSecurity.setRecklessness(t),E.inject.debugLayers.registerAndActivate("security",s.planningSecurity.getDebugLayer())},regionInfluence(e=E.inject.ui.session.selectedRegionId){r.assert.defined(e);const t=E.inject.gameStateModel.regions.byId(e);r.assert.defined(t),E.inject.debugLayers.registerAndActivate("regionInfluence",(0,h.createHexInfluenceDebugLayer)(e))},factionInfluenceByRegion:function(e,t=B.PowerMeasurement.MilitaryMight,i=1/0){E.inject.debugLayers.registerAndActivate(`factionInfluenceByRegion(${e})`,E.inject.views.factionInfluenceByRegion.getDebugLayer(e,t,i))},fear:function(e){E.inject.debugLayers.registerAndActivate(`fear(faction=${e})`,E.inject.views.fear.getDebugLayer(e))},hexIds(){E.inject.debugLayers.activate("hexIds",t.CUSTOM_WORLD_DEBUG_LAYERS.hexIds)},regionAssets(){E.inject.debugLayers.registerAndActivate("regionAssets",new y.GameStateDebugLayer((0,T.regionBasedAdapter)({getValue:(e,t)=>{const i=E.inject.gameStateModel.regions.byId(t);if(i)return`${i.getAssets().totalUnits.toString()}`},getDetail:(e,t)=>{const i=E.inject.gameStateModel.regions.byId(t);if(!i)return;const s=i.getAssets();return`total units: ${s.remainingUnits.toString()}\nremaining units: ${s.totalUnits.toString()}\nremaining gold: ${s.remainingGold}\nremaining income: ${s.remainingIncome}\ntotal might: ${s.getRemainingAvailableMight()}/${s.getTotalAvailableMight()}\ntotal unit upkeep: ${s.getTotalUnitUpkeep()}\nmax available might: ${s.getMaxRemainingAvailableMight()}/${s.getMaxAvailableMight()}                    \nmax sustainable might: ${s.getMaxRemainingSustainableMight()}\nobtainable unit count: ${s.getObtainableUnitCount()}\nobtainable might levels: ${s.getObtainableMightLevels()}\nbuyable might: ${s.getBuyableMight()}\n`}})))},regionForecast(){E.inject.debugLayers.registerAndActivate("regionForecast",E.inject.views.regionForecast.getDebugLayer())},approval(e=1){const t=E.inject.gameStateModel,i=t.factions.byId(e);r.assert.defined(i);const s=t.factions.all().filter((e=>e.controller!==o.FactionController.None));let n=[["from \\ towards",...s.map((e=>e.id))]],a=1;for(let e of s){n[a]=[e.id];for(let i of s)n[a].push(u.AI.getFactionApproval(t.state,e.id,i.id));++a}console.table(n),E.inject.debugLayers.registerAndActivate("approval",new y.GameStateDebugLayer((0,f.factionBasedAdapter)({getValue:(e,t)=>u.AI.getFactionApproval(e,t,i.id),getDetail:(e,t)=>(0,p.prettyPrintObject)(u.AI.getFactionApproval(e,t))})))},async frontlines(e=2,t=E.inject.ui.session.selectedRegionId){const i=E.inject.gameStateModel.regions.byId(t);r.assert.defined(i);const s=new v.ThreatAssessment(i.faction),n=new _.Frontlines(new H.RegionAIContext(i),{threatAssessment:s},e);await n.calculate()},situationScore(){E.inject.debugLayers.registerAndActivate("situationScore",E.inject.views.situationScoreByRegion.getDebugLayer())},factionAttrition(){E.inject.debugLayers.registerAndActivate("factionAttrition",E.inject.views.attritionByFaction.getDebugLayer())},politics(){E.inject.debugLayers.registerAndActivate("regionPolitics",E.inject.views.regionPoliticsView.getDebugLayer())},expansionOptions(){E.inject.debugLayers.registerAndActivate("expansionOptions",E.inject.views.expansionOptions.getDebugLayer())},diplomacy(){E.inject.debugLayers.activate("diplomacy",(()=>(0,S.createDiplomacyDebugLayer)()))},diplomacyScore(){E.inject.debugLayers.activate("dipomacyScore",(()=>E.inject.views.factionDiplomacyScore.getDebugLayer()))},hostility(e=E.inject.ui.session.selectedRegionId){r.assert.defined(e),E.inject.debugLayers.registerAndActivate("hostility",E.inject.views.hostility.getDebugLayer(e))},defenderBenefit(e=E.inject.ui.session.selectedRegionId){const t=E.inject.gameStateModel.regions.byId(e),i=new H.RegionAIContext(t),s=(0,x.createAiViews)(i);E.inject.debugLayers.registerAndActivate("defenderBenefit",s.defenderBenefit.getDebugLayer())},defenseWithoutMovable(){E.inject.debugLayers.registerAndActivate("defenseWithoutMovable",new y.GameStateDebugLayer((0,b.hexBasedAdapter)({getValue:(e,t)=>N.Warfare.getHexDefenseWithoutMovableUnits(e,(0,L.getHex)(t)),getDetail:(e,t)=>""})))},safeAssets(e=E.inject.ui.session.selectedRegionId){const t=(0,H.createAiContext)(C.Regions.model(E.inject.currentGameState).byId(e)),i=(0,x.createAiViews)(t),s=new y.GameStateDebugLayer((0,T.regionBasedAdapter)({getValue:(e,s)=>C.Regions.model(e).byId(s).getMySafeAssets(i.planningSecurity,t.focus.daring).toString(),getDetail(e,t){}}));E.inject.debugLayers.registerAndActivate("safeAssets",s)},estimateDamage(){E.inject.debugLayers.registerAndActivate("estimateDamage",(0,$.createDamageSimDebugLayer)())},powerBalance(){const e=E.inject.views.powerBalance.get(E.inject.currentGameState);return{...e,dominantFaction:e.dominantFaction?.id,factionsByPower:e.factionsByPower.map((e=>e.id))}},behaviorSummary(){E.inject.debugLayers.registerAndActivate("behaviorSummary",E.inject.views.behaviorSummary.getDebugLayer())},factionNeighbours(e){void 0===e&&(e=R.app.screen.play.selectedRegion?.faction?.id),r.assert.defined(e),E.inject.debugLayers.registerAndActivate("factionNeighbours",E.inject.views.factionNeighboursView.getDebugLayer(e))},attitude(e=1){const t=E.inject.gameStateModel,i=t.factions.byId(e);r.assert.defined(i);const s=t.factions.all().filter((e=>e.controller!==o.FactionController.None));let n=[["from \\ towards",...s.map((e=>e.id))]],a=1;for(let e of s){n[a]=[e.id];for(let i of s)n[a].push(u.AI.getFactionAttitude(t.state,e.id,i.id));++a}console.table(n),E.inject.debugLayers.registerAndActivate("approval",new y.GameStateDebugLayer((0,f.factionBasedAdapter)({getValue(e,t){if(t===i.id)return"";const{fear:s,approval:n,attitude:a}=E.inject.views.attitude.getComponents(e,{fromFactionId:t,towardsFactionId:i.id});return`${a}\n(A${n};F${s})`},getDetail:(e,t)=>m.Factions.model(e).all().filter((e=>e.controller!==o.FactionController.None&&e!==i&&e.id!==t)).map((i=>{const s=E.inject.views.attitude.getComponents(e,{fromFactionId:t,towardsFactionId:i.id});return`${s.attitude} towards F${i.id} (A${s.approval};F${s.fear})`})).join("\n")})))},testVictoryPrompt(){R.app.notifications.claimVictory()},downloadReplay(){const e=E.inject.gameStateController.history.export({snapshotPolicy:["initial","p1-rewind-checkpoints","final"],includeRewinds:!0,sizeLimit:1e3}),t=(0,P.encodeReplay)(e);(0,X.downloadAsTextFile)("replay.konkr",t)},testReporting(){I.ErrorTracking.captureException(new Error("Test Error (triggered by commands.testReporting())")),(0,A.reportFeedback)({comment:"Testing Feedback Message",email:"commands.testReporting()",mood:4})},testLevelFeedback(){R.app.notifications.askForLevelFeedback("123")},testError(){setTimeout((()=>myUndefinedFunction2()),0)},exportReplay(){const e=E.inject.gameStateController.history.export({snapshotPolicy:["initial"],includeRewinds:!0,sizeLimit:2e3}),t=(0,P.encodeReplay)(e);console.log(e),console.log(`ENCODED (${(t.length/1e3).toFixed()} KB)`,t),console.log("DECODED",(0,P.decodeReplay)(t))},importReplay(e){(0,J.loadReplay)(e)},inspectHistory(){const e=E.inject.gameStateController.history;console.log(e.debugDump(Number.POSITIVE_INFINITY))},replay(){const e=R.app.scene.play.cursor;R.app.scene.play.setMode(new Y.SpectatorMode(R.app.scene.play,K.SpectatingContext.LiveReplay)),e.seekBackTag("turnStart",1),e.stepBack(),e.seekBackTag("turnStart",2),R.app.scene.worldMap.syncState(e.currentState),R.app.scene.worldMap.overlays.selectedRegionHighlight.clear(),R.app.scene.worldMap.overlays.conquerableHexesHighlight.clear(),E.inject.events.trigger(n.UserActions.SetSpectatingPlayBackSpeed(E.SpectatingPlaybackSpeed.Paused))},getLocalStorageUsage(){console.log(`${(0,q.getSizeByKey)(E.inject.storage).map((([e,t])=>`${(0,d.padRight)(e,30)} ${(0,p.describeSize)(t)}`)).join("\n")}\n---\n${(0,d.padRight)("TOTAL",30)} ${(0,p.describeSize)(E.inject.storage.getSizeInBytes())}`)}},get rec(){return E.inject.history},get config(){return E.inject.config},get ui(){return E.inject.ui},edit:{setFactionColor:(e,t)=>{const i=E.inject.gameStateModel.factions.byId(e);r.assert.defined(i,`Invalid faction id ${e}`),i.setLandColor(t),E.inject.events.trigger(n.UserActions.SyncWithModel())},approval(e,t,i){const s=u.AI.changeFactionApproval(E.inject.currentGameState,e,t,(e=>e+i));console.log(`Approval from ${e} to ${t} now ${u.AI.getFactionApproval(s,e,t)}`)},equalizeCoins(e,t){E.inject.events.trigger(z.MapEditorActions.ResetStartingCoins({base:e,income:t}))},resetPolitics(){E.inject.gameStateController.loadState(E.inject.currentGameState.set(a.GameState.ai.approval.key,W.default.Map()).set(a.GameState.ai.attritionByRegion.key,W.default.Map()),U.NewGameStateContext.LoadingGameStateForDebug)}}},t.registerConsoleCommands=function(){const e=t.commands,i=window;i.commands=e,i.game=e.game,i.debug=e.debug,i.rec=e.rec,i.config=e.config,i.edit=e.edit,i.ui=e.ui,i.inject=E.inject,i.app=R.app,i.GameState=a.GameState},t.createHexIdDebugLayer=Q,t.createPawnsByHexDebugLayer=Z,t.createHexHistoryDebugLayer=ee,t.CUSTOM_WORLD_DEBUG_LAYERS={hexIds:Q,[a.GameState.regions.edgeHexes.key]:g.createBorderHexesDebugLayer,[a.GameState.warfare.borderHexes.key]:g.createBorderHexesDebugLayer,[a.GameState.pawns.byHex.key]:Z,[a.GameState.regions.byHex.key]:()=>new y.GameStateDebugLayer((0,w.dataSetAdapter)(a.GameState.regions.byHex,{getGroups:e=>C.Regions.model(e).all().map((e=>e.hexes))})),[a.GameState.ai.capitalTown.key]:V.createCapitalTownDebugLayer,[a.GameState.ai.hexImportance.key]:()=>new y.GameStateDebugLayer((0,w.dataSetAdapter)(a.GameState.ai.hexImportance,{getValue(e){const t=0===e.distanceFromTown,i=e.factors.multiplier>=1;return`${t?k.GLYPH.redFlag:i?k.GLYPH.whiteFlag:""}${Math.floor(e.factors.fromConnectedHexes+e.factors.fromHex)}`},getDetail:e=>`from hex: ${e.factors.fromHex}\nfrom connected hexes: ${e.factors.fromConnectedHexes}\nfrom townProximity: ${e.factors.fromTownProximity} (distance ${e.distanceFromTown})\nmultiplier: ${e.factors.multiplier}\nconnectivity: ${e.connectivity}`})),[a.GameState.ai.hexHistory.key]:ee},[a.GameState.pawns.byRegion,a.GameState.regions.hexes,a.GameState.economy.budgetByRegion,a.GameState.economy.treasuryByRegion,a.GameState.economy.townsByRegion,a.GameState.ai.attritionByRegion,a.GameState.ai.regionInfluenceByRegion,a.GameState.currentPhase.movableUnits,a.GameState.bandits.campsByRegion,a.GameState.ai.assetsValueByRegion,a.GameState.warfare.fortificationByRegion].forEach((e=>{t.CUSTOM_WORLD_DEBUG_LAYERS[e.key]=()=>new y.GameStateDebugLayer((0,w.regionDataSetAdapter)(e))})),[a.GameState.ai.approval,a.GameState.ai.powerByFaction,a.GameState.units.byFaction].forEach((e=>{t.CUSTOM_WORLD_DEBUG_LAYERS[e.key]=()=>new y.GameStateDebugLayer((0,w.factionDataSetAdapter)(e))}))},48972:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.configProfiles=void 0;const s=i(116),n={reporting:{slack:{enabled:!0,feedbackHook:atob("aHR0cHM6Ly9ob29rcy5zbGFjay5jb20vc2VydmljZXMvVE0xQk01UzVCL0IwM0dVUkY4M0Q1L25YWGEwdHlraG1CNjBEYXExY3I3UzVHdg==")},sentry:{enabled:!0,dsn:"https://63ec8bedbe5345db9b76689cadb81eea@o364314.ingest.sentry.io/6446750"},googleAnalytics:{enabled:!0}},socials:{twitterUrl:"https://twitter.com/intent/tweet?text="+encodeURIComponent("@konkr_dev"),discordUrl:"https://discord.gg/C9HucB9arH",email:"dev@konkr.io"},canonicalUrl:"https://www.konkr.io"};t.configProfiles={dev:{...n,mode:"standard",mapRegistryUrls:["assets/test-maps.json","assets/maps.json"],debug:{datgui:{expand:!0,sections:{debug:"expanded",factions:"on",level:"expanded",mapgen:"on"}},overlay:!0,dataFilter:"",ai:!1,breakpoints:[],cheats:!0,chunkBorders:!1,gameObjects:!0,objectPools:!0,recordStateChanges:!1,uiLayout:!1,integrityChecks:{pawns:!1,gameState:!1},checkWorldMapIntegrity:!1,tweenSpeedFactor:1,tileTextureAtlas:!1,loadTestMaps:!0,gameHistory:!0},allowEditing:!0,autoSaveOnTurnStart:!1,autoSaveOnTurnEnd:!0,serviceWorker:{enabled:!0,scope:"http://localhost:3000/"},antialiasing:!0,screenTransitionDuration:300,flags:{cloudSync:!0,skipTutorial:!1,seeEnemyAttitudes:!0,mergeMutations:!0,rainingGifts:!1,buyGifts:!1,avoidBottomRightCorner:(0,s.isRunningAt)("itch"),fullScreenToggleButton:!(0,s.isRunningAt)("itch"),telemetry:!0,zombiesEverywhere:!1},reporting:{...n.reporting,sentry:{enabled:!1,dsn:"https://63ec8bedbe5345db9b76689cadb81eea@o364314.ingest.sentry.io/6446750"},googleAnalytics:{enabled:!1}},remoteConfigDefaults:{replaysSampleRate:1,levelTelemetrySampleRate:1}},production:{...n,mode:"standard",mapRegistryUrls:["assets/maps.json"],debug:{datgui:!1,overlay:!1,dataFilter:void 0,ai:!1,breakpoints:!1,cheats:!1,gameObjects:!1,objectPools:!1,chunkBorders:!1,recordStateChanges:!1,integrityChecks:void 0,checkWorldMapIntegrity:!1,tweenSpeedFactor:1,loadTestMaps:!1},allowEditing:!0,autoSaveOnTurnStart:!0,autoSaveOnTurnEnd:!0,serviceWorker:{enabled:!0,scope:"https://www.konkr.io/"},antialiasing:!0,screenTransitionDuration:300,flags:{cloudSync:!(0,s.isRunningAt)("kongregate"),skipTutorial:!1,seeEnemyAttitudes:!1,mergeMutations:!0,rainingGifts:!1,buyGifts:!1,zombiesEverywhere:!1,fullScreenToggleButton:!(0,s.isRunningAt)("itch","newgrounds"),avoidBottomRightCorner:(0,s.isRunningAt)("itch"),telemetry:!0},remoteConfigDefaults:{replaysSampleRate:0,levelTelemetrySampleRate:1}}}},31129:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BUILT_IN_MAPS=void 0,t.BUILT_IN_MAPS={titleScreenLevel:"konkrmap.v7.eyJtYXAiOnsid2lkdGgiOjIwLCJoZWlnaHTGDHRoZW1lIjoiZGVmYXVsdCJ9LCJ2ZXJzaW9uIjo3LCJyZWdpb25zIjpbeyJpZCI6MSwibmHFMWtpbmdkb20ixE94ZcQiNjEwLDYxMSw2MTIsNjEzXX0sxjQy2zQxNTA0LDE1MDXEBTfEBTgsMTbGFDnECjXEBTfEBTgsMTLEDzPGBTYsMTTEKDTEDzTEDzUwynQ03HQzMTIsMTMxMywxNMQKNTEwxAUxxAUyLDEyxA8yxA8yxigxyVY121Y3MDUsNzA2LOQAzDUwNizkAMXkAL82MDbJQDfcQDEyLDcxMyw4MTIsODEzLDnFDDEsODEwLDfrAIQ420Q5MDYsOTA3LDkwOCw55AFAMOQBGDDkAUAw5AFAMeQBLDDEGTHEGTHEGTHGGTnkAV42xAU3yWsx/AG6NTE2LDUxNyw2MeoA4DH8AOE4MDQsOcUE5QCFM8QFNMk7MvwCWjExxC8x5AHvMsYF6wJeM9w5M8Q5M8xo/QIaMeQB9zExMMov/ADSMTfkAUE35AFBOMQKODA4yjn8Aag4MDgsODA5LDnMajndMTUsOOsCSTT8AS43y1Y0/AEeNzE0LDcxNcot/AEc5ADs5ADrNzA5LDjrAiU0/AMVMTAwy1822yo07AO9/AF1OeYCOjLKLvwBajE17AE2/AFjMTTrANU1MNwqMuQDLjPrAWY1/QK9M8RZXSwiZmFjdO0FTcplbmF0dXJlIucFj0luZGV4xR9jb250cm9sbGVyxCVvbsQj6gWT5ASjLDQ0LDQ1LDQ2LDQ3LDQ4LDQ5LDUwLDLqAU3qAJtQbGF5ZXIgMSLPWGxvY2FsLXVzZXLyAIHKbTIsNDMsMeoBI+oEHMdYMtBYYWnPUDHMUDQsNDEsNeoE2OoCqcdQM99Q5QCDylAyNywy6gN/6gLKx040307lAIHKTjUsMjEsMuoEN+oC5cdQNd9Q5QCDylA3LDI5yU3qAwjHTTbfTeUAgMpN6gDnLeoB3v8CQ/cCQ+UCmXBhd+4H43R5cMRTdG93buYCySI65AepyHYy1SI2MDXIITPWQzMxMsgiNNYiMjA3yCI11SI5MTPIITbJIWNhc3Rs5ADYxkU1MMkkN9gkNOoAizjLJG1wyCI2MTDIITHkCSfSIuQGXMkj6gE1Y29pbnPJJOQI3yJjb3VudMRIyS/qAULOLzIwN9Qv6gFQzi/kCMnTL+oBXc0v5AhS0y7qAWnNLuQIvMgu6QEsMeoBdWZvcmVzdMku6gGY5AgF1yTKSOoBddAkMckkOdckNTE2yCTlCsLUJDcwOckk6gGc0CQ4ySTqAZHQJOkCkeQIadUkOMsk6gF7ziTkBwnJJeoBcs4lNOoCUTL4AWnkBvvJJfgBajnLSfgBauQJFskl+AFr5Ac/yCUz+AFs5Ac6ySX4AW3kBzDJJfgBbuQHWskl6gFLcGlrZW1h6gQmNOsEauoBA2tu5QzWyCUx6wCV6gEEdmlsbGFn5QbqxSc46gJwM+oBBdAm5AwPyCc06gEH0Cc36gCY5Amh1yY5MDnkBXVydWxlU2V06w17LCJjdXJyZW50UGhhc2XkDbR0dXJuTnVtYuQFvDHpCEHsBaPHEy3EKuQF/GFwcGVkVW5pdOYF3X0=",benchmark:"konkrmap.v7.eyJtYXAiOnsid2lkdGgiOjIxLCJoZWlnaHQiOjI0LCJsZXZlbElkIjoibC1leHBhbnNpb24iLCJwbHVnaW5zIjpbXX0sInZlcsUYOjcsInJlZ2lvxRp7ImlkIjoxLCJuYW1lxEJhbmQixF94ZcQfMTgwOV19LMYmMskmU3VubWlsZcspNzA0LDYwOSw3MDUsNjEwLDcwNiw4MDMsNzA4LDgwNCw3xBwxMCw4xRg3LDgwOCw5MDQsODA5LDkwOSwxMTAsMTExLDIwOSwyMTAsMzExLDUwNCw1MDUsNDEwLDUwNiw0MTEsNsVoNSw1MTAsNjA2LDXFFDddLCJhdHRyaXTlAOJ7IjIiOjUsIjMiOjB96AC+M+kAvkdyYXlydeQBIugAvjQxNiw2xHLFCDIsNjE1LDfEWjE2LDcxMiw3MTMsOOQAvjExLDcxNiw4xRQ3LDjFGDQsODE1LDgxNiw5MTIsOTEzLDkxNSw5MTYsMTAxMsQFNOQA3DPEBTTwAKo0IjoxOOkApTTpAKVEZWVwdHVja2V07AGPNDA4LDE05AEw5AEZMeQBFjE1MDfEBTgsMeQBHTE1xB7kARsxNsQZNsQZ5AGWMeQBkznEE+QBlDnGFzksMTjEHOQBlzExMDMsMTDEIjHESeQBozEwxAUxxh43LDEyxCPFRTHEGTLEKMVLMcRLMsRLMzAxxBQ5xAoyxBQ3xAozxAo4xAo0xAXFKDbEBcUe5QDVNMQFNcQFNsQF8QHUNuwBzjXpASlMYWR5bGVkZ+wCjjEy5AF9M+QBfTPkAX0zMcRYxg83xAozxAXEccYZ5AFBxBQwMTHkAaXFBeQAvMQKMsYKNMQF5AC3MTHzAm00LCI1Ijox6gCgN+kAoEtpbmdiYW5r6wCfMuUC5uQC5zHkAtQx5ALNMeQCyjE1xG3kA0gx5ANFMeQClDHkApExNuQAnzbkAIbkA0Yx5AKdMeQCmjHkApsxN8QZ5AKhMTfkAKTkAqcx5AKcMeQCnTE5xBk5xBTkAqAx5AKhMjDEZDkxNCwyMDEwxAUzLDIxMTDzAp4yLOQBejHpANox6gQHUmljaHJheewA2jE0LDMxNekEMzE2yS1TYWdlaW5s7gLQNzAyyizqATREZWFkYnJh7ASK5AGlNDE4LDUxNyw1MTgsNjE3LDYxOCw3xQQ5LDjlA484LDkxNyw5MTgs5QICMDE2LDIxNyzkAfYzMTjKazjJa0FsZG9yZstpMTIwNskpMjDJKVF1aWV0d2lsbMssNzA3yivqBUVNYXNzd29v7QVJ5ACHMTMx5ALqxAU16wCOMuoEm0FnYXRlc2917QWFNTHqASXkBfDHLEhlYXJ0aGJyae4C/OQB1TEwMTPKM+oDLFdoaXRlcuUGOsox5AQiMzEwLOQEV+QETOQESzXsBffqAS1FYm9ud2XtAQMyMTHKKjnJKkJlbGx0b3duc2hpcMsuMctYM+oBXEJhbGR1cnPlBrbIK+QC1DfrAksz6gFgV2lsZHNoaW7sAPc4MMsr6gKjUHJpbmNlc3RlcHDMLjEy5AMeM+sBJjPqAYXkBFJob23NMOQF4jE4MeoCGjPqAVZIaWxsc2dhcuwBtDIxzFzqAtpSYXZlbu8EDzEyMOoBRDPqAW7kA19jcm9zc3Jv7QMLMTUwNMow6gF0Q2VkYXJqb+wDkDHkB2QyMMYFNcQF6gDCNOoBgFN0cmF0aHNoYXLuASYw5AXCMDAzXX1dLCJmYWPkBBfqCDbKQG5hdHVyxDp0aGVtZUluZGV4xR9jb250cm9sbGVyxCVv5QGx6gh8MzIsMSwzMywzNSwzNywzOCwzOSw0MCzlBO8s5AMvOCwyMCwyMSwyMywyNCwyNSwyOCwyOSwz5Agf5ASqcHByb3ZhbOQEqTEiOi00NTAwLOQFji0zMzYw5Qf/LTMxODAs5ATHLTE5OTDlBaYtMjc1MOUE1S3kBPPqBNnqAjVsYXllciAx/wDRbG9jYWwtdXNlcu0A1zLvAJsyIjoxNC43MDU5MzEyMDk2MjU3NzTlAJ42Mi4wMjE0NDQ4NzgxNjU1NOUAqjLmAKYx5QCjNekAn+sC1OYAnzLvAJ8x7wCfYWnuAW7yATI1Ny4xNDU0ODgxNTI4MOQD6OQBMzHmATAzMC4wMTI1MDc4MjIyODA5MeYG4y4wMDA0MTY5Mjc0MDkzNuQC2zYiOjbzCWfnAKcz7wCnMv4Ap+UJIe4ApzQwLjQyMDYzNTM5OTY55Qgg5QHm5AaKNCI6NC4xM80B5QCpMy4xNjXkB9Y4OTkxMTY3OeYAqTLzCWvnAKk07wCpM/4AqTXzAoIxNOcCgDIuNDQ1NTYyNzM5ODk3NTHlAVoyLjE1NzEyMjc5NDA1NzY5MzbnAeowLjcxNjk4NzYwMzk5MjQ35wCr8ADYM/MI/ucAvDXvALw0/gC85Qlc8AC85gFWNy40MTc2NjEzNjE4NjYwODblALs0Mi7kA1Q4NzkyNTE2OTU15QF6MTAuMzk2MDc4MDU0MzcxMeQEvOUDV+oDVeoIAOcAqjbvAKo1/gCq9ACpOOYBZTIwLjXvAfjlAr825ACH5QLCLuQJrssB5gFvODB95ATPcGF37g0CdHlw5ACoZm9yZXPnByDkB9Yx6wOB1SM3MDfIIzTXIzkxNMgjNdcj5AezyCQ22CQyMDbIJDEw1yU3ymzkAPLXJDXJJDfXJDQxOMkkONkk6QD7MTnXJDXKJOQH8tUk5AeKySX4ALXkB7TJJfgBauQJXskl+AFsNeoBsuQEwNUkN8tI+AD/OOoA2zQz1yQ5yyT5ALUwMekB2DT4ALU4MOkBtDT4AiEy6gH8NOoAteQJiMlr6wLR5AcG0yM4MDnJIuoBjM1FMcsj6gD5zSM1y2jqAPjMIzkxMski+AGG5BCAySX5AobLJPgChjMxMMgk5Agb1SQ1ykg2+AKFNTDpAhc2+AQRNssk+AIXNeoA/TbqAR9jYW3nCy7lA+3pAUI26gIVzSM16gKlNuoCFM0j6wDU6gFlzCIy6gKhNuoBYs4i6wSb6gFhY2/kEl3LJOQFynVudCI6yXM36gFrzS7kALnJLukC++QJqscudmlsbGFn5QlZxTE1MOkC2eQGkvcB4+kDITj5AlA3MOkBeDjqAO5iYW5kacolMOoEIDnqAeXPJTfqARU56gHm8AC5N+oAuTnqAejQJjXqBAAx5ArE1nI06wXaMMpzzyY26gJa5BHH9QGA5BN26AF/MuoGCzDrAiLML+URCcgw6gXyxEX2AIQz6gSs5BFJ1iY36wD1MeoC4c9LN+oESDHrBqzQcesG0esGrvABaDjqAY4x5A/b1yfkE2LKKOoAwHBpa2VtYeoE5DDrAJwy6gCczyc4zCbqAJzQTTHqBDYx5A9J+ACc6wReMeQI9PgBN+oCBuQKaPUB1+sCBuoBGOsG7s4uMjDqAgXqAbrkDkbVL+sEejHrBvrxAKjKeusG12Nhc3ToFmDkAbfqAPPrBtjtBOgz6wiv6waU8gIC6QO2MesGmNAn5BUkyijqAdvRKDTrAnnrBn3tBT8w6wm26wZZ7gVAMOQM1ugDk8ov+AE5MusDPe0Ft+wBODbqBvUx6wW58QDFMOsCLesFs9AoNMt0N+oAyNFPNuoFPzE3+QKiMusDjOQPENdOOcwn6wcH7AE95BTX6AE86gG3N+oCT/EDkuoCBeQNbdd75BdGyij3AnjrBz8xN/cHHcQl8wHd6wbwzi/rCTwxOPsBaTTMKPkCKjDrBY04+AVo7AM/6wc+ziXkES7JJfcEJ+wBEDj4ARDMbuQQWfcFEzTrAknrB2TPJ+wBpvsHZOQX9soo+QIc5BcVyif7Ah05MTDkDkdydWxlU2V0IjoiZGVmYXVs5AEtY3VycmVudFBoYXNl5A62dHVybk51bWLkDuHkAqvnE0rtDnbGEy3EK+QPImFwcGVkVW5pdOYbv30="}},5715:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Colors=void 0,t.Colors={woodenUi:{primaryText:5781794,redText:8388608,pergamen:16379880},glassUi:{background:11656690,primaryText:3355442,secondaryText:2710903,disabledText:7972541,backgroundText:5460817,errorText:8388608,shape:12969202,shapeDarkAccent:11590124,shapeShadow:9027030,shapeLightAccent:14412786,alert:{shadow:13118720,main:16749944,lightAccent:16773357},success:{shadow:4496950,main:8376178,lightAccent:12445366}},tooltip:{text:14540253,background:2697512,mightCounter:3648456,coinsCounter:16763904},speechBubble:{text:2697512,background:15723242},highlight:{friendlyRegion:5438464,ownedRegion:16577024,hostileRegion:16721920},ocean:10213106,oceanLight:11591925,darker:(e,t=10)=>Phaser.Display.Color.IntegerToColor(e).darken(t).color,brighter:(e,t=10)=>Phaser.Display.Color.IntegerToColor(e).brighten(t).color,lighter:(e,t=10)=>Phaser.Display.Color.IntegerToColor(e).lighten(t).color}},41707:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GLYPH=void 0,t.GLYPH={defense:String.fromCodePoint(57344),sword:String.fromCodePoint(57345),pawn:String.fromCodePoint(57346),kingdom:String.fromCodePoint(57347),coin:String.fromCodePoint(57348),hex:String.fromCodePoint(57349),checkMark:String.fromCodePoint(57350),crossMark:String.fromCodePoint(57351),pawns:{milita:"",pikeman:"",knight:"",hero:""},whiteFlag:"",redFlag:"",blueFlag:"",blackFlag:"",greenFlag:"",factions:[0,1,2,3,4,5,6].map((e=>String.fromCodePoint(57360+e))),source:"",movable:"",error:""}},77821:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.TransitionsSpeed=t.TIMING=void 0,t.TIMING={pawnPickupTransition:100,pawnDropTransition:100,pawnJumpDuration:500,defenseMarkersShowDuration:300,defenseMarkersHideDuration:100},(i=t.TransitionsSpeed||(t.TransitionsSpeed={}))[i.Normal=600]="Normal",i[i.Fast=300]="Fast",i[i.Instant=0]="Instant"},73685:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isMessage=t.Messages=void 0;const s=i(34758);function n(){return(0,s.createEventFactory)(s.EventCategory.IFrame)}t.Messages={ReadyToReceiveReplay:n()("READY_TO_RECEIVE_REPLAY"),LoadReplay:n()("LOAD_REPLAY"),GoToTurn:n()("GO_TO_TURN")},t.isMessage=function(e){return(0,s.isEvent)(e)&&e.category===s.EventCategory.IFrame}},116:(e,t,i)=>{"use strict";function s(){if(!i.g.window)return null;const e=new URLSearchParams(window.location.search);return"iframe"===e.get("utm_medium")?e.get("utm_source"):e.get("kongregate_game_id")?"kongregate":null}Object.defineProperty(t,"__esModule",{value:!0}),t.isRunningAt=t.getFrameParent=void 0,t.getFrameParent=s,t.isRunningAt=function(...e){const t=s();return!(!t||!e.includes(t))}},1041:(e,t,i)=>{"use strict";i(82260);const s=i(48780),n=i(48500),a=i(82966),o=i(48972),r=i(48361),c=i(75071),l=i(39139),d=i(60807),h=i(5715),u=i(97520),p=i(58592),g=i(120),m=i(88865),y=i(70697),f=i(116),w=o.configProfiles.production,v=(0,f.getFrameParent)()??window.location.href;function b(e){window.devicePixelRatio;const{width:t,height:i}=S();e.width===t&&e.height===i||(console.warn(`Window size changed. Adjusting viewport size to ${t}x${i}`),p.app.game.scale.setGameSize(t,i))}function S(){return{width:1*window.innerWidth,height:1*window.innerHeight}}console.info(`⚔ Konkr.io production build 2.10.0-build-5143612584 (master) running on ${v}`),c.ErrorTracking.setup(w),g.Firebase.initialize(w),window.launchGame=async()=>{n.logger.addTransport("console",new l.ConsoleLogger),n.logger.for("game").info("starting");const e=new URLSearchParams(window.location.search).get("mode"),t=(0,r.getAppController)(e??w.mode),i=(o=t.getScenes(),{type:Phaser.AUTO,backgroundColor:h.Colors.ocean,fps:{limit:60},scale:{parent:"phaser-game",mode:Phaser.Scale.FIT,fullscreenTarget:"phaser-game",...S()},dom:{createContainer:!0},scene:o,pixelArt:!w.antialiasing,antialias:w.antialiasing});var o;const g=new Phaser.Game(i);(0,s.setupInjectionContainer)(g,w,t),c.ErrorTracking.initializeContext(),p.app.device.updateScreenSize(),p.app.cloudSync.initialize(),await(0,y.migrateUserData)(),m.inject.login.initialize(),(0,u.instrumentBrowserHistory)(),(0,a.registerConsoleCommands)(),p.app.analytics.setDefaultEventParams({build_number:"2.10.0-build-5143612584",real_dpr:window.devicePixelRatio||1,logical_dpr:p.app.device.dpr,ui_variant:p.app.device.uiVariant(),os:p.app.device.os(),parent_frame:p.app.device.frameParent}),d.track.pageView(),g.scale.on("resize",b),t.run()}},47610:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EXPENSIVE_AI_PROJECTIONS=t.createAIDataSets=t.createWarfareDataSets=t.createEconomyDataSets=t.createUnitsDataSets=t.createPawnDataSets=t.createFactionDataSets=t.createRegionDataSets=t.GameState=void 0;const s=i(98853),n=i(88380),a=i(30420),o=i(1873),r=i(83081),c=i(44175),l=i(66206),d=i(52880),h=i(41141),u=i(18302),p=i(63078),g=i(69038),m=i(65283),y=i(40085),f=i(9516),w=i(27499),v=i(65025),b=i(651),S=i(66091),x=i(56691),T=i(42727),P=i(14008),M=i(86585),I=i(35442),A=i(50720),C=i(59716),B=i(27122),E=i(62361),R=i(62960),O=i(328),_=i(71406),H=i(36473),D=i(28778),k=new c.SingletonDataSet("map",{levelId:"",width:10,height:10,plugins:[]}),j=new c.SingletonDataSet("ruleSet",r.ruleSets.default),L=Y(),F=q(),U=X(),G=K(),N=function(){const e={data:new c.SingletonDataSet("currentPhase",{type:a.PhaseTypes.FactionTurn,turnNumber:1,faction:1}),tappedUnits:new p.SetDataSet("currentPhase.tappedUnits")};return{...e,movableUnits:new g.MovableUnitsProjection("currentPhase.movableUnits",{currentPhase:e.data,currentPhaseTappedUnits:e.tappedUnits,unitsByFaction:G.byFaction})}}(),V=J(),z=Q(),W=Z(),$=function(){const e=new h.HexesByPawnTypeAndRegionProjection("bandits.campsByRegion",a.PawnType.Camp,{pawnsByRegion:F.byRegion});return{campsByRegion:e,nearestCamp:new B.NearestCampByHexProjection("bandits.nearestCamp",{campsByRegion:e,regionsByHex:L.byHex,regionsHexes:L.hexes}),nearestLoot:new O.NearestLootProjection("bandits.nearestLoot",{pawnsByHex:F.byHex,regionsByHex:L.byHex,townsByRegion:V.townsByRegion})}}();function Y(){const e=new l.MapDataSet("regions"),t=new l.MapDataSet("regions.byHex"),i=new s.InvertedMapProjection("regions.hexes",t);return{byId:e,byHex:t,hexes:i,edgeHexes:new v.RegionEdgeHexesProjection("regions.edgeHexes",i),nextId:new n.NextIdProjection("regions.nextId",e)}}function X(){const e={byId:new l.MapDataSet("factions"),byRegion:new l.MapDataSet("factions.byRegion")},t=new s.InvertedMapProjection("factions.regions",e.byRegion);return{...e,regions:t,nextId:new n.NextIdProjection("factions.nextId",e.byId)}}function q(){const e={byId:new l.MapDataSet("pawns"),hex:new l.MapDataSet("pawns.hex"),count:new l.MapDataSet("pawns.count")},t=new s.InvertedMapProjection("pawns.byHex",e.hex);return{...e,byHex:t,nextId:new n.NextIdProjection("pawns.nextId",e.byId),byRegion:new o.PawnsByRegionProjection("pawns.byRegion",{pawnsByHex:t,regionsByHex:L.byHex,pawnsHex:e.hex})}}function K(){return{byFaction:new u.UnitsByFactionProjection("units.byFaction",{factionRegions:U.regions,pawnsByRegion:F.byRegion,rules:j})}}function J(){const e=new h.HexesByPawnTypeAndRegionProjection("economy.townsByRegion",a.PawnType.Town,{pawnsByRegion:F.byRegion}),t=new E.NearestTownProjection("economy.nearestTown",{townsByRegion:e,regionByHex:L.byHex,regionsHexes:L.hexes}),i=new w.CoinsByHexProjection("economy.coinsByHex",{pawnsByHex:F.byHex,pawns:F.byId,pawnsCount:F.count}),s=new y.BudgetByRegionProjection("economy.budgetByRegion",{regionHexes:L.hexes,townsByRegion:e,pawnsByRegion:F.byRegion,regions:L.byId});return{coinsByHex:i,townsByRegion:e,nearestTown:t,treasuryByRegion:new f.TreasuryByRegionProjection("economy.treasuryByRegion",{coinsByHex:i,townsByRegion:e,regionsByHex:L.byHex}),budgetByRegion:s}}function Q(){const e=new m.HexDefenseSourcesProjection("warfare.hexDefenseSources",{rules:j,movableUnits:N.movableUnits,pawns:F.byId,pawnsByHex:F.byHex,regionByHex:L.byHex}),t=new b.RegionBorderHexesProjection("warfare.borderHexes",{regionsEdgeHexes:L.edgeHexes,pawnsByHex:F.byHex}),i=new C.HexStaticDefenseProjection("warfare.hexStaticDefense",{hexDefenseSources:e,regionByHex:L.byHex});return{borderHexes:t,hexDefenseSources:e,hexDefense:new A.HexDefenseProjection("warfare.hexDefense",{hexDefenseSources:e,regionByHex:L.byHex}),hexStaticDefense:i,fortificationByRegion:new D.FortificationByRegion("warfare.fortificationByRegion",{regionByHex:L.byHex,regionHexes:L.hexes,hexStaticDefense:i})}}function Z(){const e=new M.AttritionByRegionDataSet("ai.attritionByRegion"),t=new l.MapDataSet("ai.approval"),i=new l.MapDataSet("ai.hexHistory"),s=new S.HexDepthProjection("ai.hexDepth",{regionHexes:L.hexes,borderHexes:z.borderHexes}),n=new x.HexAssetValueProjection("ai.hexAssetValue",{pawnsByHex:F.byHex,coinsByHex:V.coinsByHex,regionsByHex:L.byHex,budgetByRegion:V.budgetByRegion,treasuryByRegion:V.treasuryByRegion,movableUnits:N.movableUnits}),a=new P.RegionInfluenceByHexProjection("ai.regionInfluenceByHex",{factionsByRegion:U.byRegion,regionsByHex:L.byHex,borderHexes:z.borderHexes,hexDefense:z.hexDefense}),o=new H.CapitalTownProjection("ai.capitalTown",{townsByRegion:V.townsByRegion,regionInfluenceByHex:a}),r=new d.HexImportanceProjection("ai.hexImportance",{regionsHexes:L.hexes,townsByRegion:V.townsByRegion,hexAssetValue:n,capitalTown:o}),c=new _.AssetsValueByRegionProjection("ai.assetsValueByRegion",{hexAssetValue:n,regionHexes:L.hexes});return{attritionByRegion:e,approval:t,hexHistory:i,hexDepth:s,hexAssetValue:n,hexImportance:r,regionInfluenceByHex:a,capitalTown:o,powerByFaction:new T.PowerByFactionProjection("ai.powerByFaction",{factionRegions:U.regions,factions:U.byId,movableUnits:N.movableUnits,currentPhaseData:N.data,assetsValueByRegion:c}),regionInfluenceByRegion:new I.RegionInfluenceByRegionProjection("ai.regionInfluenceByRegion",{regionInfluenceByHex:a,regionHexes:L.hexes}),assetsValueByRegion:c}}t.GameState={version:new c.SingletonDataSet("version",R.CORE_GAMESTATE_SCHEMA_VERSION),map:k,regions:L,factions:U,pawns:F,ruleSet:j,units:G,currentPhase:N,economy:V,warfare:z,ai:W,bandits:$},t.createRegionDataSets=Y,t.createFactionDataSets=X,t.createPawnDataSets=q,t.createUnitsDataSets=K,t.createEconomyDataSets=J,t.createWarfareDataSets=Q,t.createAIDataSets=Z,t.EXPENSIVE_AI_PROJECTIONS=[t.GameState.ai.hexImportance,t.GameState.ai.regionInfluenceByHex,t.GameState.ai.regionInfluenceByRegion]},20666:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.PawnTraits=void 0,(i=t.PawnTraits||(t.PawnTraits={})).NegatesTileIncome="negates-tile-income",i.Unit="unit",i.Impenetrable="impenetrable",i.Building="building",i.Pest="pest",i.Treasure="treasure",i.GuardsAdjacentTiles="protects-adjacent",i.OccupiesTile="occupies-tile"},21999:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getDefaultFactionConfig=t.createBlankGameState=t.SpecialFaction=void 0;const s=i(30420),n=i(14711),a=i(85656),o=i(62960),r=i(88865),c=i(36307);var l;function d(e){return{name:`Player ${e}`,themeIndex:e-1,controller:1===e?s.FactionController.LocalUser:s.FactionController.Ai,regions:[]}}!function(e){e[e.neutral=0]="neutral"}(l=t.SpecialFaction||(t.SpecialFaction={})),t.createBlankGameState=function(e={width:0,height:0}){return{version:o.CORE_GAMESTATE_SCHEMA_VERSION,map:{width:e.width,height:e.height,plugins:[],levelId:r.inject.random.id(n.ID_TYPE.Level)},regions:[],factions:[{id:l.neutral,name:"nature",themeIndex:0,controller:s.FactionController.None,regions:[]},...(0,a.range)(1,c.MAX_FACTIONS_COUNT).map((e=>({id:e,...d(e)})))],pawns:[],currentPhase:{type:s.PhaseTypes.FactionTurn,turnNumber:1,faction:1},hexHistory:{},ruleSet:"default"}},t.getDefaultFactionConfig=d},82169:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addIds=t.decompressGameState=t.compressGameState=void 0;const s=i(85656),n=i(47610),a=i(48500),o=i(83081),r=i(58089),c=i(50264),l=i(62960),d=i(96486),h=i(51019);function u(e,t,i){return e.get(t,i)?.toArray()||[]}a.logger.for("decompressGameState"),t.compressGameState=function(e){const t=new r.StateEngine;t.add(n.GameState.version,n.GameState.map,n.GameState.ruleSet,n.GameState.ai.attritionByRegion,n.GameState.ai.hexHistory,...Object.values(n.GameState.regions),...Object.values(n.GameState.factions),...Object.values(n.GameState.pawns),...Object.values(n.GameState.units),...Object.values(n.GameState.currentPhase)),t.setState(e),t.activateAllProjections(),c.Regions.destroyAllEmptyRegions(t.currentState);const i=t.serialize();return{map:i.map,version:i.version,regions:Object.values(i.regions).map((e=>({...e,hexes:u(t,n.GameState.regions.hexes,e.id),attrition:t.get(n.GameState.ai.attritionByRegion,e.id)}))),factions:Object.values(i.factions).map((e=>({...e,aiPersonality:(0,d.isEqual)(e.aiPersonality,h.DEFAULT_AI_PERSONALITY)?void 0:e.aiPersonality,regions:u(t,n.GameState.factions.regions,e.id),approval:t.get(n.GameState.ai.approval,e.id)}))),pawns:Object.values(i.pawns).map((e=>{return{...e,hex:t.get(n.GameState.pawns.hex,e.id),count:(i=t.get(n.GameState.pawns.count,e.id),1===i?void 0:i)};var i})),currentPhase:{...i.currentPhase,tappedUnits:t.get(n.GameState.currentPhase.tappedUnits).keySeq().toArray()},hexHistory:i["ai.hexHistory"],ruleSet:"default"}},t.decompressGameState=function(e){let t;const i={},n={},a={};t=(0,s.dictionaryOf)(e.regions.map((e=>(0,s.omit)(e,"hexes","attrition"))),"id"),e.regions.forEach((e=>{e.hexes.forEach((t=>i[t]=e.id)),e.attrition&&(n[e.id]=e.attrition)}));let r={};const c={};r=(0,s.dictionaryOf)(e.factions.map((e=>({...(0,s.omit)(e,"regions"),aiPersonality:{...h.DEFAULT_AI_PERSONALITY,...e.aiPersonality}}))),"id"),e.factions.forEach((e=>{e.regions.forEach((t=>c[t]=e.id)),e.approval&&(a[e.id]=e.approval)}));let d={};const u={},p={};d=(0,s.dictionaryOf)(e.pawns.map((e=>(0,s.omit)(e,"hex","count"))),"id"),e.pawns.forEach((e=>{u[e.id]=e.hex,p[e.id]=e.count||1}));const g=(0,s.omit)(e.currentPhase,"tappedUnits");e.pawns.forEach((e=>{u[e.id]=e.hex,p[e.id]=e.count||1}));const m=o.ruleSets.default;return{map:{...e.map,plugins:e.map.plugins??[]},version:l.CORE_GAMESTATE_SCHEMA_VERSION,ruleSet:m,regions:t,"regions.byHex":i,factions:r,"factions.byRegion":c,pawns:d,"pawns.count":p,"pawns.hex":u,currentPhase:g,"currentPhase.tappedUnits":e.currentPhase.tappedUnits||[],"ai.approval":a,"ai.attritionByRegion":n,"ai.hexHistory":e.hexHistory??{}}},t.addIds=function(e){return(0,s.mapDictionary)(e,((e,t)=>({...e,id:Number(t)})))}},36307:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MAX_FACTIONS_COUNT=void 0,t.MAX_FACTIONS_COUNT=6},9603:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.findLatestInteractiveState=t.GameStateController=t.UndoAvailability=void 0;const s=i(34758),n=i(52937),a=i(52643),o=i(91025),r=i(48500),c=i(47613),l=i(84370),d=i(21103),h=i(88865),u=i(26452),p=i(51262),g=i(59006),m=i(82169),y=i(75071),f=r.logger.for("GameStateController");var w;!function(e){e.Unavailable="unavailable",e.RollbackOnly="rollback-only",e.Available="available"}(w=t.UndoAvailability||(t.UndoAvailability={})),t.GameStateController=class{get rollbackAvailable(){return this.history.getCursor().canRollback()}constructor(){this.onEvent=(0,n.signal)(),this.eventsPaused=!1,this.scheduledPlays=[],this.history=new p.GameHistory,this.undoAvailable=(0,d.watchable)(w.RollbackOnly),this.movesCache=new u.MovesCache,this.model=new c.GameStateModel}updateUndoAvailability(){const e=this.history.getCursor();e.canUndo()?this.setUndoAvailable(w.Available):e.canRollback()?this.setUndoAvailable(w.RollbackOnly):this.setUndoAvailable(w.Unavailable)}setUndoAvailable(e){this.undoAvailable.set(e)}getEventQueue(){const e=new a.EventQueue;return e.addSource(this.onEvent),e}loadState(e,t){if(this.model.restore(e),this.model.activateAllProjections(),this.fireEvent(o.GameStateEvents.NewGameState({state:this.model.state,context:t})),this.scheduledPlays=[],t.startFactionTurn&&this.fireEvent(o.GameStateEvents.FactionTurnStarted({state:this.model.state,factionId:this.model.currentPhase.faction.id})),t.flushHistory){this.clearHistory();const i=e.replay;if(i)try{this.history.import(i,{unpackRewinds:t.unpackRewinds})}catch(e){y.ErrorTracking.captureNonFatalError(`Failed to parse replay from CompressedState: ${e.message}`,"GameStateController.loadState")}}this.updateUndoAvailability()}exportStateWithHistory(e){const t=(0,m.compressGameState)(this.currentState),i=this.history.export(e);return t.replay=i,t}undo(){const e=this.history.getCursor();e.canUndo()?(e.stepBack(),this.history.rewindTo(e,{storeAsRewind:!1}),this.loadState(this.history.latestState,l.NewGameStateContext.Undo)):f.error("Undo not available in current state")}rewindTo(e){this.history.rewindTo(e,{storeAsRewind:!0}),this.loadState(this.history.latestState,l.NewGameStateContext.Rewind)}clearHistory(){this.history.reset(this.currentState),this.updateUndoAvailability()}beginTransaction(){this.eventsPaused=!0}commitTransaction(){this.eventsPaused=!1,this.scheduledPlays.forEach((e=>this.fireEventsAfterPlay(e.play,e.events))),this.scheduledPlays=[]}createCheckpoint(){return{state:this.currentState,plays:[...this.scheduledPlays]}}restoreCheckpoint(e){this.model.restore(e.state),this.scheduledPlays=[...e.plays],h.inject.config.debug.ai&&this.onEvent.fire(o.GameStateEvents.NewGameState({state:this.currentState,context:l.NewGameStateContext.LoadingGameStateForDebug}))}get currentState(){return this.model?.stateEngine.currentState}handlePlay(e){const t=this.movesCache.get(this.model.state,e);if(t)this.model.restore(t.state),this.fireEventsAfterPlay(e,t.events);else{const t=this.model.state,i=(0,g.gameStateReducer)(this.model,e);this.movesCache.set(t,e,this.model.state,i),this.fireEventsAfterPlay(e,i)}(0,s.isEvent)(e,o.Plays.EndTurn)&&this.movesCache.flush()}fireEventsAfterPlay(e,t){if(this.eventsPaused&&!h.inject.config.debug.ai)this.scheduledPlays.push({play:e,events:t});else for(let e of t)this.fireEvent(e);this.eventsPaused||this.history.addPlay(e,t,this.currentState),this.updateUndoAvailability()}fireEvent(e){this.onEvent.fire(e)}executePlay(e){if(e.category!=s.EventCategory.Play)throw new Error(`cannot execute ${e.name} - does not appear to be a Play`);this.handlePlay(e)}isOnTurnStart(){return this.history.getCursor().currentStep.tags.has("turnStart")}},t.findLatestInteractiveState=function(e){const t=e.history.getCursor();if(t.seekBack((t=>!!e.model.factions.byId(t.activeFaction)?.isLocalPlayer())))return t.currentState}},26452:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MovesCache=void 0;const s=i(96486);t.MovesCache=class{constructor(){this.data=new Map}get(e,t){const i=this.data.get(e);if(i)for(let e of i)if((0,s.isEqual)(e.play,t))return e.result}set(e,t,i,s){let n=this.data.get(e);n||(n=[],this.data.set(e,n)),n.push({play:t,result:{state:i,events:s}})}flush(){this.data.clear()}}},83439:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.captureHex=void 0;const s=i(91025),n=i(58257),a=i(20666),o=i(30420),r=i(12678),c=i(90737),l=i(33174),d=i(78179),h=i(88865);function u(e,t,i){return e.pawns.findClosest(t,d.HexGroup.union([t,i.hexes]),(e=>e.type===o.PawnType.Town))?.hex}t.captureHex=function(e,t,i,o,d){const p=new l.WorldUpdateBuilder(e),g=e.state;r.assert.defined(t);const m=e.regions.byHex(t);r.assert.defined(m),r.assert.defined(i);const y=m.faction;let f;const w=o instanceof n.PawnModel?o.hex:void 0,v=m.isAlive(),b=m.isBankrupt();return e.stateEngine.transaction((()=>{const r=function(){const i=e.pawns.findOne({hexes:t,traits:[a.PawnTraits.OccupiesTile]});if(!i)return;if(!(i.hasTrait(a.PawnTraits.Unit)&&e.warfare.getHexStaticDefense(t)>0))return{pawnId:i.id};const s=e.warfare.getRetreatDestination(i,w);return s?{pawnId:i.id,retreatHex:s.id}:{pawnId:i.id}}(),l=r?[e.pawns.byId(r.pawnId).type]:[];let S;if(o instanceof n.PawnModel)S=p.move({pawnId:o.id,destHex:t,defeatedUnit:r,captureHex:!0,tapUnit:d}).hexCaptured;else{f=e.economy.payForNewPawn(t,i,o),p.addCoinTransaction(f),e.stateEngine.commitTransaction();const s=p.create({type:o,hex:t,defeatedUnit:r,sourceHex:u(e,t,i),regionId:i.id,captureHex:!0,tapUnit:d});S=s.hexCaptured,e.stateEngine.commitTransaction(),o=e.pawns.byId(s.pawns[0].pawnId)}const x=p.getUpdates(),T=h.inject.ai.dataLayer.onHexConquered({model:e,stateBeforeAttack:g,attackerFaction:i.faction,destroyedPawns:l,victimRegions:[m,...S.splitOffRegions.map((t=>e.regions.byId(t)))],regionWasAlive:v,regionWasBankrupt:b});return[s.GameStateEvents.HexCaptured({capturedHexId:t.id,capturingPawnId:o.id,capturingPawnType:o.type,capturingRegionId:i.id,capturingFactionId:i.faction.id,boughtPawnTransactions:f,newRegionId:i.id,victimRegionId:m.id,victimFactionId:y?.id,originatingHexId:w?.id,defeatedUnit:r,worldUpdates:x}),...T,...e.currentPhase.faction?.isLocalPlayer()?(0,c.checkWinConditions)(e):[]]}))}},37289:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shouldOfferSurrender=void 0;const s=i(14344),n=i(88865),a=i(23441);t.shouldOfferSurrender=function(e){const t=s.Factions.model(e),i=t.all().filter((e=>e.isAlive()&&e.isLocalPlayer()));if(n.inject.gameStateModel.plugins.zombies)return!1;if(1!==i.length)return!1;const o=i[0],r=n.inject.views.powerBalance.get(e);if(r.dominantFaction!==o)return!1;if(o.scaledPower/r.totalPower<.8)return!1;const c=t.all().map((e=>e.size)).reduce(a.sum);return!(o.size/c<.7)}},90737:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.checkWinConditions=void 0;const s=i(91025),n=i(30420);t.checkWinConditions=function(e){const t=e.factions.all().filter((e=>e.isAlive()));return 1===t.length?e.map.plugins.zombies&&e.pawns.findOne({type:[n.PawnType.HauntedTown]})?[]:[s.GameStateEvents.GameOver({winningFactionId:t[0].id,state:e.state})]:t.find((e=>e.isLocalPlayer()))?[]:[s.GameStateEvents.GameOver({winningFactionId:void 0,state:e.state})]}},88487:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeAcceptSurrender=void 0;const s=i(91025);t.executeAcceptSurrender=function(e){return[s.GameStateEvents.GameOver({state:e.state,winningFactionId:e.currentPhase.faction?.id})]}},17912:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeBanditsAct=void 0;const s=i(39710),n=i(21999),a=i(30420),o=i(91025),r=i(55668),c=i(48500),l=i(12678),d=i(24794),h=i(85656),u=i(64748),p=i(59575),g=i(33174),m=i(88865),y=i(66202);c.logger.for("bandits"),t.executeBanditsAct=function(e){const t=e.pawns.select({type:[a.PawnType.Bandit]}),i=new Set(t),c=new g.WorldUpdateBuilder(e),f=[],w={baseIncome:new s.CoinTransactionBuilder,buyUnits:new s.CoinTransactionBuilder,pillage:new s.CoinTransactionBuilder};for(let s of t){if(!s.exists)continue;const t=e.regions.byHex(s.hex);l.assert.defined(t);const a=t?.id;if(!t?.isAlive()&&!t?.faction?.isNeutral()){const t=s.hex;c.takeOverHex(s.hex,e.factions.byId(n.SpecialFaction.neutral)),f.push({hexId:s.hex.id,originalRegionId:a});const o=(0,u.getOrCreateNearestCamp)(e,s.hex,c);o?.hex===t?w.pillage.from(t).spawn(1):void 0!==o&&w.pillage.from(t).spawn(1).send(o.hex),i.delete(s)}}e.restore(w.pillage.apply(e.state)),(0,p.moveBandits)(e,i,c);const v=e.factions.byId(n.SpecialFaction.neutral).getRegions().map((t=>Array.from(r.Bandits.getCampsByRegion(e.state,t.id)))).flat().map(d.getHex);v.forEach((t=>{if(e.economy.numberOfCoinsAt(t)>=3){const i=(0,p.pickHexToEnter)(e,t);if(i){const s=e.warfare.getOccupyingUnit(i)?.id;c.create({hex:i,sourceHex:t,type:a.PawnType.Bandit,captureHex:!1,defeatedUnit:s?{pawnId:s}:void 0,tapUnit:!1}),w.buyUnits.from(t).consume(3)}}})),w.buyUnits.apply(e.state),v.forEach((e=>{w.baseIncome.from(e).spawn(1)})),w.baseIncome.apply(e.state),m.inject.config.flags.rainingGifts&&(0,y.spawnPresents)(e,c);const b=(0,h.mapDictionary)(w,(e=>e.getTransactions()));return c.addCoinTransaction(b.pillage),c.addCoinTransaction(b.buyUnits),c.addCoinTransaction(b.baseIncome),[o.GameStateEvents.BanditsActed({pillagedHexes:f,coinTransactions:b,worldUpdates:c.getUpdates()})]}},17370:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeBuyPawn=void 0;const s=i(91025),n=i(83439),a=i(42297),o=i(12678),r=i(24794),c=i(33174),l=i(30420),d=i(88865);t.executeBuyPawn=function(e,t){const i=(0,r.getHex)(t.destinationHexId),h=e.regions.byId(t.buyerRegionId);o.assert.defined(i),o.assert.defined(h);let u=[];return e.stateEngine.transaction((()=>{const o=e.warfare.getDropPawnResult(i,t.pawnType,h),r=e.regions.byHex(i);switch(t.pawnType===l.PawnType.Present&&r?.isAlive()&&r!==h&&u.push(...d.inject.ai.dataLayer.onReceivedGift({giftValue:e.rules.pawns(l.PawnType.Present).loot,model:e,fromFaction:h.faction,toFaction:r.faction})),o.type){case a.DropPawnResultType.Conquest:return(0,n.captureHex)(e,i,h,t.pawnType,t.tapUnit);case a.DropPawnResultType.Reposition:case a.DropPawnResultType.EradicatePest:case a.DropPawnResultType.Combine:let r,l;o.type===a.DropPawnResultType.EradicatePest&&(l={pawnId:o.pest.id}),o.type===a.DropPawnResultType.Combine&&(r={outputType:o.combineInto,mergedWith:o.combineWith.id});const d=e.economy.payForNewPawn(i,h,t.pawnType);e.stateEngine.commitTransaction();const p=new c.WorldUpdateBuilder(e);p.addCoinTransaction(d);const g=p.create({type:t.pawnType,hex:i,regionId:h.id,sourceHex:e.economy.nearestTownHexFrom(i),mergeData:r,defeatedUnit:l,captureHex:!1,tapUnit:t.tapUnit}),m={...t,payment:d,pawnId:g.merged?.newPawnId??g.pawns[0].pawnId,buyerRegionId:h.id,eradicatedPest:o.type===a.DropPawnResultType.EradicatePest,worldUpdates:p.getUpdates()};return[s.GameStateEvents.PawnBought(m),...u];case a.DropPawnResultType.Invalid:default:throw new Error(`Invalid buy attempt (${o.reason})`)}}))}},30423:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeEndTurn=void 0;const s=i(93808),n=i(91025),a=i(30420),o=i(12678),r=i(20666),c=i(33174),l=i(90737),d=i(88865);t.executeEndTurn=function(e){(0,o.assert)(e.currentPhase.type===a.PhaseTypes.FactionTurn,`Cannot end turn in phase ${e.currentPhase.type}`);const t=[],i=e.currentPhase.faction;o.assert.defined(i);const h=d.inject.ai.dataLayer.onTurnEnd(e,e.currentPhase.faction);return function(e){const t=e.currentPhase.getNextFaction();0===t&&e.currentPhase.incrementTurnNumber(),e.currentPhase.set({type:a.PhaseTypes.FactionTurn,faction:t})}(e),t.push(n.GameStateEvents.FactionTurnOver({state:e.state,factionId:i.id}),...h,function(e){const t=new c.WorldUpdateBuilder(e),i=e.state;return e.regions.all().filter((e=>!e.isAlive())).forEach((i=>{i.getPawns().filter((e=>e.hasTrait(r.PawnTraits.Unit))).forEach((i=>t.replace(i,e.rules.getBanditUnitType()))),i.getPawns().filter((e=>e.type===a.PawnType.Castle)).forEach((i=>{t.takeOverHex(i.hex,e.factions.neutral),t.replace(i,e.rules.getBanditCampUnitType())}))})),n.GameStateEvents.CutOffUnitsTurnedBandits({stateBefore:i,stateAfter:e.state,worldUpdates:t.getUpdates()})}(e),...(0,s.startPhase)(e),n.GameStateEvents.FactionTurnStarted({state:e.state,factionId:e.currentPhase.faction.id}),...(0,l.checkWinConditions)(e)),t}},63611:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidMoveError=t.executeMovePawn=void 0;const s=i(91025),n=i(42297),a=i(83439),o=i(12678),r=i(24794),c=i(33174),l=i(99896);t.executeMovePawn=function(e,t){const i=e.pawns.byId(t.pawnId),h=new c.WorldUpdateBuilder(e);if(!i?.isMovable())throw new d({reason:"the pawn is not movable in the current game state"},t);return e.stateEngine.transaction((()=>{o.assert.defined(i);const c=i.region,u=i.hex,p=(0,r.getHex)(t.destinationHexId);if(o.assert.defined(c),o.assert.defined(p),u===p)return t.tapUnit&&l.CurrentPhase.tapPawn(e.state,i.id),[];const g=e.warfare.getDropPawnResult(p,i.type,c);switch(g.type){case n.DropPawnResultType.Conquest:return(0,a.captureHex)(e,p,c,i,t.tapUnit);case n.DropPawnResultType.Reposition:h.move({pawnId:i.id,destHex:p,captureHex:!0,tapUnit:t.tapUnit});const o=h.getUpdates();return[s.GameStateEvents.PawnMoved({...t,sourceHexId:u.id,worldUpdates:o})];case n.DropPawnResultType.EradicatePest:return h.move({pawnId:i.id,destHex:p,defeatedUnit:{pawnId:g.pest.id},captureHex:!0,tapUnit:t.tapUnit}),[s.GameStateEvents.PawnMoved({...t,sourceHexId:u.id,eradicatedPest:!0,worldUpdates:h.getUpdates()})];case n.DropPawnResultType.Combine:const r=g.combineWith.type;return g.combineWith.isMovable(),h.move({pawnId:i.id,destHex:p,mergeData:{mergedWith:g.combineWith.id,outputType:g.combineInto},captureHex:!0,tapUnit:t.tapUnit}),[s.GameStateEvents.PawnMoved({...t,sourceHexId:u.id,mergedWith:r,mergedInto:g.combineInto,worldUpdates:h.getUpdates()})];case n.DropPawnResultType.Invalid:default:throw new d(g,t)}}))};class d extends Error{constructor(e,t){super(`Invalid move of pawn #${t.pawnId} to hex #${t.destinationHexId}: ${e?.reason}`),this.moveResult=e,this.context=t}}t.InvalidMoveError=d},59006:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gameStateReducer=void 0;const s=i(91025),n=i(30423),a=i(63611),o=i(17370),r=i(17912),c=i(84370),l=i(88487),d=i(78329);t.gameStateReducer=function(e,t){switch(t.name){case s.Plays.EndTurn.eventName:return(0,n.executeEndTurn)(e);case s.Plays.EditMap.eventName:return[s.GameStateEvents.NewGameState({state:t.payload.stateAfter,context:c.NewGameStateContext.ResumingGame})];case s.Plays.BuyPawn.eventName:return(0,o.executeBuyPawn)(e,t.payload);case s.Plays.MovePawn.eventName:return(0,a.executeMovePawn)(e,t.payload);case s.Plays.BanditsAct.eventName:return e.plugins.zombies?(0,d.executeZombiesAct)(e):(0,r.executeBanditsAct)(e);case s.Plays.AcceptSurrender.eventName:return(0,l.executeAcceptSurrender)(e)}}},93808:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.startPhase=void 0;const s=i(91025),n=i(30420),a=i(12678),o=i(33174),r=i(39710);t.startPhase=function(e){if(e.currentPhase.type===n.PhaseTypes.FactionTurn){const t=e.currentPhase.faction;return a.assert.defined(t),function(e,t){const i=[],n=e.state;t.getRegions().forEach((t=>{a.assert.defined(t);const s=e.economy.gatherIncomeAndPayUpkeep(e,t);(s.worldUpdates.updates.length>0||Object.keys(s.coinTransfers).length>0)&&i.push(s)}));const c=i.flatMap((e=>e.worldUpdates.updates)),l=i.length>0?i.map((e=>e.coinTransfers)).reduce(r.mergeTransactions):void 0;return l&&c.push({type:o.UpdateType.CoinTransaction,coinTransaction:l}),[s.GameStateEvents.FactionEconomyUpdated({stateAfter:e.state,factionId:t.id,regionReports:i,worldUpdates:{stateBefore:n,stateAfter:e.state,affectedRegions:i.map((e=>e.regionId)),updates:c}})]}(e,t)}return[]}},84370:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NewGameStateContext=void 0,t.NewGameStateContext={StartingNewGame:{name:"starting new game",startFactionTurn:!0,flushHistory:!0,resetCamera:!1,resetSurrender:!0,unpackRewinds:!1},LoadingGame:{name:"loading game",startFactionTurn:!0,flushHistory:!0,resetCamera:!0,resetSurrender:!0,unpackRewinds:!1},ResumingGame:{name:"resuming game",startFactionTurn:!0,flushHistory:!1,resetCamera:!1,resetSurrender:!0,unpackRewinds:!1},LoadingGameStateForDebug:{name:"loading game state for debug",startFactionTurn:!1,flushHistory:!1,resetCamera:!1,resetSurrender:!1,unpackRewinds:!1},Preview:{name:"loading game state for preview",startFactionTurn:!1,flushHistory:!1,resetCamera:!1,resetSurrender:!1,unpackRewinds:!1},Undo:{name:"undo",startFactionTurn:!1,flushHistory:!1,resetCamera:!1,resetSurrender:!1,unpackRewinds:!1},Rewind:{name:"rewind",startFactionTurn:!1,flushHistory:!1,resetCamera:!1,resetSurrender:!1,unpackRewinds:!1},ViewReplayAfterGameOver:{name:"view replay after gameover",startFactionTurn:!1,flushHistory:!1,resetCamera:!0,resetSurrender:!1,unpackRewinds:!1},LoadReplay:{name:"load replay",startFactionTurn:!1,flushHistory:!0,resetCamera:!0,resetSurrender:!1,unpackRewinds:!1}}},91025:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.describeEvent=t.WorldMapEvents=t.pointerEventFlagsToString=t.PointerEventFlags=t.SystemEvents=t.UiEvents=t.UserActions=t.GameStateEvents=t.Plays=void 0;const s=i(34758);var n;function a(e){let t=[];return e&n.Ctrl&&t.push("CTRL"),e&n.Alt&&t.push("ALT"),e&n.Shift&&t.push("SHIFT"),e&n.MiddleButton&&t.push("Middle"),e&n.RightButton&&t.push("Right"),e&n.Touch&&t.push("Touch"),t.length?t.join("+"):"none"}t.Plays={EndTurn:(0,s.playEvent)()("END_TURN"),MovePawn:(0,s.playEvent)()("MOVE_PAWN"),BuyPawn:(0,s.playEvent)()("BUY_PAWN"),BanditsAct:(0,s.playEvent)()("BANDITS_ACT"),EditMap:(0,s.playEvent)()("EDIT_MAP"),AcceptSurrender:(0,s.playEvent)()("ACCEPT_SURRENDER")},t.GameStateEvents={NewGameState:(0,s.gameStateEvent)()("NEW_GAME_STATE"),FactionApprovalChanged:(0,s.gameStateEvent)()("FACTION_APPROVAL_CHANGED"),FactionTurnStarted:(0,s.gameStateEvent)()("FACTION_TURN_STARTED"),FactionTurnOver:(0,s.gameStateEvent)()("FACTION_TURN_OVER"),BanditsActed:(0,s.gameStateEvent)()("BANDITS_ACTED"),FactionEconomyUpdated:(0,s.gameStateEvent)()("FACTION_ECONOMY_UPDATED"),PawnMoved:(0,s.gameStateEvent)()("PAWN_MOVED"),PawnBought:(0,s.gameStateEvent)()("PAWN_BOUGHT"),HexCaptured:(0,s.gameStateEvent)()("HEX_CAPTURED"),CutOffUnitsTurnedBandits:(0,s.gameStateEvent)()("CUTOFF_UNITS_TURNED_BANDITS"),GameOver:(0,s.gameStateEvent)()("GAME_OVER")},t.UserActions={CreateBlankMap:(0,s.userAction)()("CREATE_BLANK_MAP"),EditMapJSON:(0,s.userAction)()("EDIT_MAP_JSON"),OpenExportMapDialog:(0,s.userAction)()("OPEN_SAVE_GAME_DIALOG"),OpenLoadGameDialog:(0,s.userAction)()("OPEN_LOAD_GAME_DIALOG"),SaveGame:(0,s.userAction)()("SAVE_GAME"),InternalLoadGame:(0,s.userAction)()("LOAD_GAME_INTERNAL"),ResumeGame:(0,s.userAction)()("RESUME_GAME"),ViewReplay:(0,s.userAction)()("VIEW_REPLAY"),DeselectRegion:(0,s.userAction)()("DESELECT_REGION"),SelectNextRegion:(0,s.userAction)()("SELECT_NEXT_REGION"),SelectPreviousRegion:(0,s.userAction)()("SELECT_PREVIOUS_REGION"),SelectNextPendingRegion:(0,s.userAction)()("SELECT_NEXT_PENDING_REGION"),EndTurn:(0,s.userAction)()("END_TURN"),Undo:(0,s.userAction)()("UNDO"),OpenRollbackMenu:(0,s.userAction)()("OPEN_ROLLBACK_MENU"),BuyablePawnPointerDown:(0,s.userAction)()("BUYABLE_PAWN_POINTER_DOWN"),BuyablePawnPointerUp:(0,s.userAction)()("BUYABLE_PAWN_POINTER_UP"),ReturnHeldPawn:(0,s.userAction)()("RETURN_HELD_PAWN"),ShopAreaPointerDown:(0,s.userAction)()("SHOP_AREA_POINTER_DOWN"),ShopAreaPointerUp:(0,s.userAction)()("SHOP_AREA_POINTER_UP"),DebugGameState:(0,s.userAction)()("DEBUG_GAME_STATE"),EditMap:(0,s.userAction)()("EDIT_MAP"),SyncWithModel:(0,s.userAction)()("SYNC_WITH_MODEL"),SetSpectatingPlayBackSpeed:(0,s.userAction)()("SET_SPECTATING_PLAYBACK_SPEED"),SkipSpectating:(0,s.userAction)()("SKIP_SPECTATING"),GoToStart:(0,s.userAction)()("GO_TO_START"),GoToPreviousTurn:(0,s.userAction)()("GO_TO_PREVIOUS_TURN"),GoToNextTurn:(0,s.userAction)()("GO_TO_NEXT_TURN"),GoToEnd:(0,s.userAction)()("GO_TO_END"),ExitSpectatingMode:(0,s.userAction)()("EXIT_SPECTATING_MODE"),SaveReplay:(0,s.userAction)()("SAVE_REPLAY"),StartRewind:(0,s.userAction)()("START_REWIND"),RewindBack:(0,s.userAction)()("REWIND_BACK"),RewindForward:(0,s.userAction)()("REWIND_FORWARD"),RewindStepForward:(0,s.userAction)()("REWIND_STEP_FORWARD"),RewindStepBack:(0,s.userAction)()("REWIND_STEP_BACK"),ConfirmRewind:(0,s.userAction)()("CONFIRM_REWIND"),GoToMapGeneration:(0,s.userAction)()("GOTO_MAP_GENERATION"),GoToCampaigns:(0,s.userAction)()("GOTO_CAMPAIGNS"),GoToLevelSelect:(0,s.userAction)()("GOTO_LEVEL_SELECT"),GoToLevelDetail:(0,s.userAction)()("GOTO_LEVEL_DETAIL"),GoToQuickGame:(0,s.userAction)()("GOTO_QUICK_GAME"),GoToRandomMapSelect:(0,s.userAction)()("GOTO_RANDOM_MAP_SELECT"),PreviewLevel:(0,s.userAction)()("PREVIEW_LEVEL"),PlayLevel:(0,s.userAction)()("PLAY_LEVEL"),RestartLevel:(0,s.userAction)()("RESTART_LEVEL"),AbandonLevelProgress:(0,s.userAction)()("ABANDON_LEVEL_PROGRESS"),Escape:(0,s.userAction)()("ESCAPE"),SubmitForm:(0,s.userAction)()("SUBMIT_FORM"),GoBack:(0,s.userAction)()("GO_BACK"),Cancel:(0,s.userAction)()("CANCEL"),GenerateNewIsland:(0,s.userAction)()("GENERATE_NEW_ISLAND"),AcceptSurrender:(0,s.userAction)()("ACCEPT_SURRENDER"),SendTweet:(0,s.userAction)()("SEND_TWEET"),SendEmail:(0,s.userAction)()("SEND_EMAIL"),JoinDiscord:(0,s.userAction)()("JOIN_DISCORD"),ToggleTooltip:(0,s.userAction)()("TOGGLE_TOOLTIP"),ShowHowToPlay:(0,s.userAction)()("SHOW_HOW_TO_PLAY"),SignInWithGoogle:(0,s.userAction)()("SIGN_IN_WITH_GOOGLE"),SignInWithFacebook:(0,s.userAction)()("SIGN_IN_WITH_FACEBOOK"),SignInWithEmail:(0,s.userAction)()("SIGN_IN_WITH_EMAIL"),SignOut:(0,s.userAction)()("SIGN_OUT")},t.UiEvents={PawnReturnedToShop:(0,s.uiEvent)()("PAWN_RETURNED_TO_SHOP"),RollbackMenuClosed:(0,s.uiEvent)()("ROLLBACK_MENU_CLOSED"),PawnPickedUp:(0,s.uiEvent)()("PAWN_PICKED_UP"),RegionSelected:(0,s.uiEvent)()("REGION_SELECTED"),RewindConfirmed:(0,s.uiEvent)()("REWIND_CONFIRMED")},t.SystemEvents={EngineInitialized:(0,s.systemEvent)()("ENGINE_INITIALIZED"),ScreenActivated:(0,s.systemEvent)()("SCREEN_ACTIVATED"),RequestLevelFeedback:(0,s.systemEvent)()("REQUEST_LEVEL_FEEDBACK"),UserBecameInactive:(0,s.systemEvent)()("USER_INACTIVE"),UserBecameActive:(0,s.systemEvent)()("USER_ACTIVE"),LevelSessionStarted:(0,s.systemEvent)()("LEVEL_SESSION_STARTED"),LevelSessionOver:(0,s.systemEvent)()("LEVEL_SESSION_OVER"),UserDataLoaded:(0,s.systemEvent)()("USER_DATA_LOADED"),LevelRecordUpdated:(0,s.systemEvent)()("LEVEL_RECORD_UPDATED"),LevelRecordDeleted:(0,s.systemEvent)()("LEVEL_RECORD_DELETED"),UserSignedIn:(0,s.systemEvent)()("USER_SIGNED_IN"),FactionAiBegin:(0,s.systemEvent)()("FACTION_AI_BEGIN"),RegionAiBegin:(0,s.systemEvent)()("REGION_AI_BEGIN"),FactionAiEnd:(0,s.systemEvent)()("FACTION_AI_END"),FatalError:(0,s.systemEvent)()("FATAL_ERROR"),ShowGameOverScreen:(0,s.systemEvent)()("SHOW_GAME_OVER_SCREEN")},function(e){e[e.MiddleButton=1]="MiddleButton",e[e.RightButton=2]="RightButton",e[e.Shift=4]="Shift",e[e.Alt=8]="Alt",e[e.Ctrl=16]="Ctrl",e[e.Touch=32]="Touch"}(n=t.PointerEventFlags||(t.PointerEventFlags={})),t.pointerEventFlagsToString=a,t.WorldMapEvents={StartInteraction:(0,s.worldMapAction)()("START_INTERACTION"),AbortInteraction:(0,s.worldMapAction)()("ABORT_INTERACTION"),CompleteInteraction:(0,s.worldMapAction)()("COMPLETE_INTERACTION"),StartDrag:(0,s.worldMapAction)()("START_DRAG"),EndDrag:(0,s.worldMapAction)()("END_DRAG"),StartPinch:(0,s.worldMapAction)()("START_PINCH"),EndPinch:(0,s.worldMapAction)()("END_PINCH")},t.describeEvent=function(e){return`${e.name}(${String(function(e){switch(e.name){case"SYSTEM.FACTION_AI_BEGIN":case"SYSTEM.FACTION_AI_END":case"GAME_STATE.FACTION_TURN_OVER":case"GAME_STATE.FACTION_TURN_STARTED":case"GAME_STATE.FACTION_ECONOMY_UPDATED":return e.payload.factionId;case"GAME_STATE.GAME_OVER":return`winner=${e.payload.winningFactionId}`;case"GAME_STATE.PAWN_MOVED":return`#${e.payload.pawnId} -> hex #${e.payload.destinationHexId}`;case"GAME_STATE.HEX_CAPTURED":return`${e.payload.capturedHexId}, using ${e.payload.capturingPawnType}#${e.payload.capturingPawnId}, faction ${e.payload.victimFactionId}=>${e.payload.capturingFactionId}, `;case"GAME_STATE.FACTION_APPROVAL_CHANGED":return`${e.payload.fromFactionId} -> ${e.payload.towardsFactionId}: ${e.payload.delta}, ${e.payload.reason}`;case"GAME_STATE.NEW_GAME_STATE":return e.payload.context.name;case"USER_ACTION.PLAY_LEVEL":return`${e.payload.levelId}, ${e.payload.origin}`;case"USER_ACTION.ABANDON_LEVEL_PROGRESS":case"USER_ACTION.RESTART_LEVEL":case"USER_ACTION.GOTO_LEVEL_DETAIL":case"USER_ACTION.PREVIEW_LEVEL":return e.payload.levelId;case"USER_ACTION.GOTO_LEVEL_SELECT":return`campaignId=${e.payload.campaignId}`;case"USER_ACTION.GENERATE_NEW_ISLAND":return e.payload?e.payload.name:"";case"SYSTEM.FATAL_ERROR":return`${e.payload.correlationId}, ${e.payload.message}`;case"SYSTEM.SHOW_GAME_OVER_SCREEN":return e.payload;case"UI_EVENT.PAWN_PICKED_UP":return`${e.payload.pawnType} from hex ${e.payload.hexId}`;case"UI_EVENT.REWIND_CONFIRMED":return`${e.payload.turns} turns back to turn ${e.payload.targetTurn}`;case"UI_EVENT.REGION_SELECTED":return e.payload??"none";case"SYSTEM.SCREEN_ACTIVATED":return e.payload.previousScreen?`${e.payload.screen.name}, previous=${e.payload.previousScreen.name}`:e.payload.screen.name;case"SYSTEM.LEVEL_SESSION_STARTED":return`${e.payload.sessionId}, origin=${e.payload.origin}, levelId=${e.payload.levelId}, turn=${e.payload.turnNumber}`;case"SYSTEM.LEVEL_SESSION_OVER":return`${e.payload.sessionId}, origin=${e.payload.origin}, levelId=${e.payload.levelId}`;case"SYSTEM.USER_SIGNED_IN":return e.payload.previousUserId?`${e.payload.userId}, previous=${e.payload.previousUserId}`:e.payload.userId;case"SYSTEM.REGION_AI_BEGIN":return e.payload.regionId;default:return e.category===s.EventCategory.WorldMap?`${e.payload.hexId??"no hex"}, flags=${a(e.payload.flags)}`:"object"==typeof e.payload?"...":void 0===e.payload?"":e.payload}}(e))})`}},24592:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.gzipDecode=t.gzipEncode=t.isEncodedReplay=t.isEncodedGameState=t.decodeReplay=t.decodeGameState=t.encodeReplay=t.encodeGameState=void 0;const n=s(i(4037)),a=i(62960),o=`konkrmap.v${a.CORE_GAMESTATE_SCHEMA_VERSION}.`,r=`konkrreplay.v${a.CORE_GAMESTATE_SCHEMA_VERSION}.`;function c(e,t){const i=JSON.stringify(t);return e+n.default.compress(i,{inputEncoding:"String",outputEncoding:"Base64"})}function l(e,t){if(!t.startsWith(e))throw new Error(`Invalid data: "${t.substring(0,50)}..." does not start with ${r}`);const i=t.substring(e.length),s=n.default.decompress(i,{inputEncoding:"Base64",outputEncoding:"String"}).toString();return JSON.parse(s)}t.encodeGameState=function(e){return c(o,e)},t.encodeReplay=function(e){return c(r,e)},t.decodeGameState=function(e){return l(o,e)},t.decodeReplay=function(e){return l(r,e)},t.isEncodedGameState=function(e){return e.startsWith(o)},t.isEncodedReplay=function(e){return e.startsWith(r)},t.gzipEncode=c,t.gzipDecode=l},38764:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LINT_RULES=t.shiftMap=t.lintLevel=void 0;const s=i(47613),n=i(78179),a=i(24794),o=i(30420),r=i(21999),c=i(54444),l=i(96486);function d(e,t,i){const s=!!(i%2);function n(e){let n=Math.trunc(e/a.GRID_MAX_DIMENSION)%2==0&&s?1:0;return e+t+a.GRID_MAX_DIMENSION*i+n}return e.map.height+=i,e.regions=e.regions.map((e=>({...e,hexes:e.hexes.map((e=>n(e)))}))),e.pawns=e.pawns.map((e=>({...e,hex:n(e.hex)}))),e}t.lintLevel=function(e,i){const s=i.rules??Object.values(t.LINT_RULES),n=i.fix??!1,a=i.log??console.log;let o=[];for(const t of s){const s=t(e,i);s&&(n&&s.fix?(a("fixing: "+s.error),e=s.fix()):o.push(s.error??"unknown error"))}return{fixedState:e,errors:o}},t.shiftMap=d,t.LINT_RULES={CorrectLevelId:(e,t)=>t.assertLevelId?e.map.levelId===t.assertLevelId?null:{error:`CorrectLevelId: expected levelId "${t.assertLevelId}", found "${e.map.levelId}"`,fix:()=>({...e,map:{...e.map,levelId:t.assertLevelId}})}:null,NoEmptyRegions:e=>{const t=e.regions.filter((e=>e.hexes.length>0));return t.length===e.regions.length?null:{error:"NoEmptyRegions: map contains empty regions",fix:()=>({...e,regions:t})}},NoExtraSpace:e=>{const t=new s.GameStateModel(e);t.activateAllProjections();let i=n.HexGroup.union(t.regions.all().map((e=>e.hexes)));const a=i.getHex(n.HexFromGroupSelection.Topmost).r-1,o=i.getHex(n.HexFromGroupSelection.Leftmost).c-1,r=i.getHex(n.HexFromGroupSelection.Rightmost).c+1,c=i.getHex(n.HexFromGroupSelection.Bottommost).r+1;return a>0||o>1||r+1<t.map.width||c+1<t.map.height?(console.log(o,r,a,c,t.map),{error:"NoExtraSpace: map can be cropped",fix:function(){(a>0||o>0)&&(e=d(e,-o,-a)),i=n.HexGroup.union(t.restore(e).regions.all().map((e=>e.hexes)));const s=i.getHex(n.HexFromGroupSelection.Rightmost).c+1+1,r=i.getHex(n.HexFromGroupSelection.Bottommost).r+1+1;return e.map={...e.map,width:s,height:r},e}}):null},InitialPhaseSet:(e,t)=>{const i={...(0,r.createBlankGameState)().currentPhase,tappedUnits:[]};return(0,l.isEqual)(e.currentPhase,i)?null:{error:`InitialPhaseSet: found unexpected data in currentPhase\n ${(0,c.prettyPrintObject)(e.currentPhase)}"`,fix:()=>({...e,currentPhase:i})}},NoInvalidForests:e=>{const t=e.pawns.filter((e=>e.type===o.PawnType.Forest)),i=[];for(const s of t){const t=e.regions.find((e=>e.hexes.includes(s.hex)));if(!t){i.push(s);continue}const n=e.factions.find((e=>e.regions.includes(t.id)));n&&0===n.id||i.push(s)}return i.length?{error:`NoInvalidForest: found ${i.length} forests outside of neutral regions`,fix:()=>({...e,pawns:e.pawns.filter((e=>!i.includes(e)))})}:null},NoReplayAttached:(e,t)=>e.replay?{error:"Level contains a replay history",fix:()=>{const t={...e};return delete t.replay,t}}:null,MapOptionsV2:e=>e.map.theme||!e.map.plugins?{error:"MapOptionsV2: map contains old metadata (theme instead of plugins)",fix:()=>{const t=(0,l.cloneDeep)(e.map);return delete t.theme,t.plugins=t.plugins??[],{...e,map:t}}}:null}},78166:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseEntityModel=void 0;const s=i(12678);t.BaseEntityModel=class{constructor(e,t){this.parentModel=e,s.assert.defined(t),this.id=t}updateFrom(e){return this.parentModel.state=e,this}get state(){return this.parentModel.state}set state(e){this.parentModel.state=e}}},27379:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseModel=t.MutableStateProvider=t.ReadonlyStateProvider=void 0;const s=i(58089);class n{constructor(e){this.state=e}get(){return this.state}set(e){throw new Error("Attempt to mutate read-only state model is read only")}}t.ReadonlyStateProvider=n;class a{constructor(e){this.stateEngine=e}get(){return this.stateEngine.currentState}set(e){this.stateEngine.setState(e)}}t.MutableStateProvider=a,t.BaseModel=class{constructor(e){this.stateProvider=e instanceof s.StateEngine?new a(e):new n(e)}get state(){return this.stateProvider.get()}set state(e){this.stateProvider.set(e)}}},47613:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readOnlyModelOf=t.describePhase=t.describeState=t.checkForInvalidReferences=t.GameStateModel=t.StaticGameStateModel=t.ProjectionPresets=void 0;const s=i(48500),n=i(52937),a=i(47610),o=i(58089),r=i(42297),c=i(82169),l=i(52048),d=i(50264),h=i(98030),u=i(62977),p=i(14344),g=i(5032),m=i(99896),y=i(80682),f=i(40108),w=i(88865),v=i(24794),b=i(12678);s.logger.for("GameStateModel");let S=!1;t.ProjectionPresets={coreEntities:[...Object.values(a.GameState.regions),...Object.values(a.GameState.factions),...Object.values(a.GameState.pawns)],coreEntitiesAndSystems:[...Object.values(a.GameState.regions),...Object.values(a.GameState.factions),...Object.values(a.GameState.pawns),...Object.values(a.GameState.units),...Object.values(a.GameState.warfare),...Object.values(a.GameState.currentPhase)],all:[...Object.values(a.GameState.regions),...Object.values(a.GameState.factions),...Object.values(a.GameState.pawns),...Object.values(a.GameState.units),...Object.values(a.GameState.currentPhase),...Object.values(a.GameState.warfare),...Object.values(a.GameState.economy),...Object.values(a.GameState.ai),...Object.values(a.GameState.bandits)]};class x{constructor(e){this.state=e}get map(){return y.WorldMap.model(this.state)}get rules(){return l.Rules.model(this.state)}get regions(){return d.Regions.model(this.state)}get factions(){return p.Factions.model(this.state)}get pawns(){return u.Pawns.model(this.state)}get currentPhase(){return m.CurrentPhase.model(this.state)}get warfare(){return r.Warfare.model(this.state)}get economy(){return g.Economy.model(this.state)}get ai(){return f.AI.model(this.state)}get plugins(){return this.map.plugins}}function T(e){!function(e,t){const i=t.getEntryIds(e).map((i=>({hexId:i,entry:t.getEntryById(e,i)})));for(let e of i)for(let[t,i]of e.entry.entries())s(t,e.hexId,i);function s(i,s,a){const o=(0,v.getHex)(s);if(n(!a.parent||!a.children.has(a.parent),`Cyclical dependency found between hexes #${o.id} and ${a.parent?.id} for region ${i}`),a.parent){const s=t.getEntryById(e,a.parent.id)?.get(i);n(s?.children.has(o),`Hex #${o.id} has parent #${a.parent.id}, but it's not among this hexes children (${a.children.map((e=>e.id))})`)}for(let s of a.children){const r=t.getEntryById(e,s.id)?.get(i);n(r,`Hex #${o.id} has children [${a.children.map((e=>e.id)).join(",")}] for region #${i}, but child #${s.id} has no entry in the dataset for this region`),n(r.parent===o,`Hex #${o.id} has children [${a.children.map((e=>e.id)).join(",")}] for region #${i}, but child #${s.id} has parent ${r?.parent}`)}}function n(e,i){(0,b.assert)(e,`State integrity check failure in ${t.key}: ${i}`)}}(e,a.GameState.ai.regionInfluenceByHex)}function P(e){return`${e.type}`&&e.faction?`/${e.faction}`:""}t.StaticGameStateModel=x,t.GameStateModel=class{get map(){return y.WorldMap.model(this.state)}get rules(){return l.Rules.model(this.state)}get plugins(){return this.map.plugins}get regions(){return d.Regions.model(this.stateEngine)}get factions(){return p.Factions.model(this.stateEngine)}get pawns(){return u.Pawns.model(this.stateEngine)}get currentPhase(){return m.CurrentPhase.model(this.stateEngine)}get warfare(){return r.Warfare.model(this.stateEngine)}get economy(){return g.Economy.model(this.stateEngine)}get ai(){return f.AI.model(this.stateEngine)}get state(){return this.stateEngine.currentState}constructor(e){this.onNewState=(0,n.signal)(),this.stateEngine=new o.StateEngine,this.loadDataSets(),e&&((0,h.isImmutableState)(e)?this.stateEngine.setState(e):this.stateEngine.deserialize((0,c.decompressGameState)(e)))}suspendAllProjections(){this.stateEngine.suspendAllProjections()}useProjections(e){return this.stateEngine.activateOnly(...e),this}activateAllProjections(){return this.stateEngine.activateAllProjections(),this}loadDataSets(){this.stateEngine.add(a.GameState.version,a.GameState.map,a.GameState.ruleSet,...Object.values(a.GameState.regions),...Object.values(a.GameState.factions),...Object.values(a.GameState.pawns),...Object.values(a.GameState.units),...Object.values(a.GameState.currentPhase),...Object.values(a.GameState.warfare),...Object.values(a.GameState.economy),...Object.values(a.GameState.ai),...Object.values(a.GameState.bandits)),this.stateEngine.watchAll(((e,t)=>this.stateUpdated(t)))}restore(e){return(0,h.isImmutableState)(e)?this.stateEngine.setState(e):this.stateEngine.deserialize((0,c.decompressGameState)(e)),w.inject.config.debug.recordStateChanges&&!S&&w.inject.history.add("restored state"),this}stateUpdated(e){S||(w.inject.config.debug.integrityChecks?.gameState&&this.protectStateIntegrity(),w.inject.config.debug.recordStateChanges&&w.inject.history.add(function(e){return e&&0!==e.length?e[0].context:"state updated (no mutation)"}(e)),this.onNewState.fire(this.stateEngine.currentState))}protectStateIntegrity(){S=!0,T(this.stateEngine.currentState),S=!1}exportState(){return(0,c.compressGameState)(this.state)}withTemporaryBranch(e){const t=this.state;e(),this.restore(t)}},t.checkForInvalidReferences=T,t.describeState=function(e){return`[GameState (${e.map.width}x${e.map.height}⬡, ${e.factions.length}👤, ${e.regions.length}♖,${P(e.currentPhase)})]`},t.describePhase=P,t.readOnlyModelOf=function(e){return new x(e)}},81439:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelsCache=void 0;const s=i(58089),n=i(98030);t.ModelsCache=class{constructor(e){this.factory=e,this.cache=new WeakMap}get(e){if(!(e instanceof s.StateEngine)){const t=(0,n.getParentEngine)(e);t.currentState===e&&(e=t)}let t=this.cache.get(e);return t||(t=this.factory(e),this.cache.set(e,t)),t}}},33174:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldUpdateBuilder=t.UpdateType=void 0;const s=i(62977),n=i(12678),a=i(24794),o=i(84587),r=i(40108),c=i(50264),l=i(39710),d=i(99896),h=i(5032);var u;!function(e){e.PawnsMoved="pawn-moved",e.PawnsDestroyed="pawns-destroyed",e.PawnReplaced="pawn-replaced",e.HexTakeover="hex-takeover",e.CoinTransaction="coin-transaction"}(u=t.UpdateType||(t.UpdateType={})),t.WorldUpdateBuilder=class{constructor(e){this.model=e,this.updateList=[],this.affectedRegions=new Set,this.coinTransaction=void 0,this.stateBefore=e.state,this.nextPawnId=s.Pawns.getNextId(this.stateBefore)}getNextPawnId(){let e=this.nextPawnId;const t=s.Pawns.getNextId(this.model.state);return t>e&&(e=t),this.nextPawnId=e+1,e}create(e){const t=this.getNextPawnId();s.Pawns.create(this.model.state,{...e,id:t});const i=e.regionId??c.Regions.getByHex(this.model.state,e.hex.id);return this.affectedRegions.add(i),this.move({pawnId:t,created:{pawnType:e.type,hex:e.sourceHex?.id??e.hex.id,regionId:i},destHex:e.hex,defeatedUnit:e.defeatedUnit,mergeData:e.mergeData,captureHex:e.captureHex,tapUnit:e.tapUnit})}getUpdates(){return this.model.stateEngine.commitTransaction(),this.coinTransaction&&(this.updateList.push({type:u.CoinTransaction,coinTransaction:this.coinTransaction}),this.coinTransaction=void 0),{stateAfter:this.model.state,stateBefore:this.stateBefore,updates:this.updateList,affectedRegions:Array.from(this.affectedRegions)}}replace(e,t){const i=e.id,n=e.type,a=e.hex.id;this.affectedRegions.add(e.region.id);const o=this.getNextPawnId();s.Pawns.replacePawn(this.model.state,e.id,t,o);const r={type:u.PawnReplaced,hexId:a,oldPawnId:i,newPawnId:o,newType:t,oldType:n};return this.updateList.push(r),r}destroy(...e){e.forEach((e=>{this.affectedRegions.add(e.region.id),this.updateList.push({type:u.PawnsDestroyed,pawnId:e.id})})),s.Pawns.destroy(this.model.state,...e.map((e=>e.id)))}takeOverHex(e,t){const i=this.buildTakeOverHexUpdate(e,t);return this.updateList.push(i),i.affectedRegions.forEach((e=>this.affectedRegions.add(e))),i}buildTakeOverHexUpdate(e,t){let i,s;t instanceof o.RegionModel?(i=t.faction,s=t):(i=t,s=void 0);const a=i.takeOverHex(e,s);return n.assert.defined(a),a}move(e){const{pawnId:t,destHex:i,defeatedUnit:o,mergeData:p,created:g,captureHex:m,tapUnit:y}=e;let f=this.model.pawns.byId(t),w=t;const v=new l.CoinTransactionBuilder,b=g?.regionId?this.model.regions.byId(g.regionId):f?.region,S=this.model.regions.byHex(i),x=S?.isAlive();n.assert.defined(b),this.affectedRegions.add(b.id);let T,P,M=y;m&&b!==this.model.regions.byHex(i)&&(M=!0,T=this.buildTakeOverHexUpdate(i,b));const I=g?(0,a.getHex)(g.hex):f.hex;let A,C=0;if(o){M=!0;let e=this.model.pawns.byId(o.pawnId);o.retreatHex?e.moveTo((0,a.getHex)(o.retreatHex)):(A=e.type,C=e.rules.loot??0,e.destroy())}if(h.Economy.loot(this.model.state,i,b,C,v),p){const e=this.model.pawns.byId(p.mergedWith);n.assert.defined(e),e.hex;const i=!e.isMovable();w=this.getNextPawnId(),s.Pawns.replacePawn(this.model.state,e.id,p.outputType,w),P={...p,newPawnId:w},s.Pawns.destroy(this.model.state,t),i&&(M=!0)}else s.Pawns.movePawn(this.model.state,t,i.id);if(M&&d.CurrentPhase.tapPawn(this.model.state,w),T){T.affectedRegions.forEach((e=>this.affectedRegions.add(e))),r.AI.setHexHistory(this.model.state,i.id,{capturedAt:this.model.currentPhase.turnNumber,spoils:A||(x?"liveHex":"deadHex"),previousFactionId:S?.faction?.id??0});const e=T.connectedHexes.filter((e=>!c.Regions.model(this.model.state).byHex(e)?.isAlive()));for(let t of e)r.AI.setHexHistory(this.model.state,t,{capturedAt:this.model.currentPhase.turnNumber,spoils:"deadHex",previousFactionId:b.faction?.id??0})}const B={type:u.PawnsMoved,pawns:[{pawnId:t,srcHex:I.id,created:g}],destHex:i.id,defeatedUnit:o,hexCaptured:T,merged:P};return this.updateList.push(B),v.isEmpty()||(v.apply(this.model.state),this.updateList.push({type:u.CoinTransaction,coinTransaction:v.getTransactions()})),B}addCoinTransaction(e){this.coinTransaction?this.coinTransaction=(0,l.mergeTransactions)(e,this.coinTransaction):this.coinTransaction=e}}},40108:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.AIMutations=t.AI=t.BLANK_HISTORY_RECORD=void 0;const o=i(47610),r=i(52880),c=i(98030),l=a(i(35369)),d=i(14344),h=i(85656),u=i(42279),p=i(91989),g=i(88865),m=i(65955),y=i(42297),f=i(50264),w=i(23441),v=i(20666),b=i(99896),S=i(81439);t.BLANK_HISTORY_RECORD=Object.freeze({capturedAt:0,previousFactionId:0,spoils:"deadHex"});class x{static model(e){return this.models.get(e)}static getHexDepth(e,t){return(0,c.selectFromState)(e,o.GameState.ai.hexDepth,t)??Number.POSITIVE_INFINITY}static getHexImportance(e,t){return(0,c.selectFromState)(e,o.GameState.ai.hexImportance,t)??r.NO_IMPORTANCE}static getRegionAssetsValue(e,t){return(0,c.selectFromState)(e,o.GameState.ai.assetsValueByRegion,t)??m.NO_ASSET_VALUE}static getFactionPower(e,t){return(0,c.selectFromState)(e,o.GameState.ai.powerByFaction,t)?.factors??m.NO_ASSET_VALUE}static getFactionScaledPower(e,t){return(0,c.selectFromState)(e,o.GameState.ai.powerByFaction,t)?.scaledTotal??0}static getFactionRawPower(e,t){return(0,c.selectFromState)(e,o.GameState.ai.powerByFaction,t)?.rawTotal??0}static getRegionAttrition(e,t,i){const s=(0,c.selectFromState)(e,o.GameState.ai.attritionByRegion,t)||{};return void 0===i?s:s[i]||0}static getHexInfluence(e,t,i){if(void 0===i)return(0,c.selectFromState)(e,o.GameState.ai.regionInfluenceByHex,t)||l.Map();{const s=(0,c.selectFromState)(e,o.GameState.ai.regionInfluenceByHex,t)||l.Map();return void 0===i?s:s.get(i)}}static inflictRegionAttrition(e,t,i,s){return(0,c.applyMutations)(e,T.inflictRegionAttrition(e,t,i,s))}static setHexHistory(e,t,i){return(0,c.applyMutations)(e,T.setHexHistory(e,t,i))}static changeFactionAttrition(e,t,i){const s=T.updateAllRegionAttrition(e,d.Factions.getFactionRegions(e,t),i);return(0,c.applyMutations)(e,s)}static changeFactionApproval(e,t,i,s){return(0,c.applyMutations)(e,T.changeApproval(e,t,i,s))}static getFactionApproval(e,t,i){const s=(0,c.selectFromState)(e,o.GameState.ai.approval,t);return s?void 0===i?s:s[i]||0:0}static getFactionTotalAttrition(e,t){const i=g.inject.views.attritionByFaction.get(e,t);return Object.values(i).reduce(w.sum,0)}static getFactionAttrition(e,t,i){const s=g.inject.views.attritionByFaction.get(e,t);return s?void 0===i?s:s[i]||0:void 0===i?{}:0}static getFactionFear(e,t,i){return g.inject.views.fear.get(e,{fromFactionId:t,towardsFactionId:i})}static getRegionInfluence(e,t,i){const s=(0,c.selectFromState)(e,o.GameState.ai.regionInfluenceByRegion,i);if(s)return s.get(t)}static getFactionInfluenceByRegion(e,t,i,s=p.PowerMeasurement.MilitaryMight,n=1/0){return g.inject.views.factionInfluenceByRegion.get(e,{influencingFaction:t,targetRegion:i,maxDistance:n,powerMeasurement:s})}static getFactionAttitude(e,t,i){return g.inject.views.attitude.get(e,{fromFactionId:t,towardsFactionId:i})}static getHexAssetValue(e,t){return o.GameState.ai.hexAssetValue.getEntryById(e,t)??m.NO_ASSET_VALUE}static getTotalHexAssetValue(e,t){return m.AssetValue.total(o.GameState.ai.hexAssetValue.getEntryById(e,t)??m.NO_ASSET_VALUE)}static getRegionCapitalHex(e,t){return o.GameState.ai.capitalTown.getEntryById(e,t)?.townHexId}static isCapitalTown(e,t){const i=f.Regions.getByHex(e,t);return!!i&&x.getRegionCapitalHex(e,i)===t}static canPlaceDefenderAt(e,t,i,s){const n=f.Regions.getByHex(e,t.id);if(!n)return!1;if(n===i.id){const i=y.Warfare.getOccupyingPawn(e,t);return!i||i.isMovable()||i.hasTrait(v.PawnTraits.Pest)}return y.Warfare.getHexDefense(e,t)<s}static isUnderAttackByRegion(e,t,i){return x.getRegionAttrition(e,t,i)>5}static isUnderAttackByFaction(e,t,i){return x.getFactionAttrition(e,t,i)>5}static getHexHistory(e,i){return(0,c.selectFromState)(e,o.GameState.ai.hexHistory,i)??t.BLANK_HISTORY_RECORD}static getHexAge(e,t){const i=d.Factions.getByHex(e,t)??0;return 0===this.getHexHistory(e,t).capturedAt?Number.POSITIVE_INFINITY:(i<=(b.CurrentPhase.getFaction(e)??0)?b.CurrentPhase.getTurnNumber(e):b.CurrentPhase.getTurnNumber(e)-1)-this.getHexHistory(e,t).capturedAt}}t.AI=x,x.models=new S.ModelsCache((e=>new u.AIModel(e)));class T{static inflictRegionAttrition(e,t,i,s){const n={};return t.forEach((t=>{const a=(0,c.selectFromState)(e,o.GameState.ai.attritionByRegion,t)||{},r={...a,[i]:(a[i]||0)+s};n[t]=r})),o.GameState.ai.attritionByRegion.createMutation({set:n},"inflictRegionAttrition")}static updateAllRegionAttrition(e,t,i){const s={};return t.forEach((t=>{const n=(0,c.selectFromState)(e,o.GameState.ai.attritionByRegion,t)||{},a=(0,h.mapDictionary)(n,i);s[t]=a})),o.GameState.ai.attritionByRegion.createMutation({set:s},"updateRegionAttrition")}static setHexHistory(e,t,i){return o.GameState.ai.hexHistory.createMutation({set:{[t]:i}},"updateHexHistory")}static changeApproval(e,t,i,s){const n=(0,c.selectFromState)(e,o.GameState.ai.approval,t)||{},a=s(n[i]||0),r={...n,[i]:a};return o.GameState.ai.approval.createMutation({set:{[t]:r}},"changeApproval")}}t.AIMutations=T},42279:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AIModel=void 0;const s=i(47610),n=i(27379),a=i(98030);class o extends n.BaseModel{getHexDepth(e){return(0,a.selectFromState)(this.state,s.GameState.ai.hexDepth,e.id)||0}getHexImportance(e){return(0,a.selectFromState)(this.state,s.GameState.ai.hexImportance,e.id)?.value||0}}t.AIModel=o},86585:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AttritionByRegionDataSet=void 0;const s=i(66206),n=i(23441);class a extends s.MapDataSet{entryToString(e){return Object.values(e).reduce(n.sum,0).toString()}entryToDebugString(e){return Object.entries(e).filter((([e,t])=>t>0)).map((([e,t])=>`${t} inflicted by faction ${e}`)).join("\n")}}t.AttritionByRegionDataSet=a},55668:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Bandits=void 0;const n=i(98030),a=s(i(35369)),o=i(47610);t.Bandits=class{static getCampsByRegion(e,t){return(0,n.selectFromState)(e,o.GameState.bandits.campsByRegion,t)||a.default.Set()}static getNearestCampHex(e,t){return(0,n.selectFromState)(e,o.GameState.bandits.nearestCamp,t)?.rootId}static getNearestCampDistance(e,t){return(0,n.selectFromState)(e,o.GameState.bandits.nearestCamp,t)?.distance??Number.POSITIVE_INFINITY}static getNearestLootDistance(e,t){return(0,n.selectFromState)(e,o.GameState.bandits.nearestLoot,t)?.distance??Number.POSITIVE_INFINITY}}},328:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NearestLootUpdater=t.NearestLootProjection=t.UNREACHABLE=void 0;const r=i(66206),c=a(i(35369)),l=i(48500),d=i(17281),h=i(50264),u=i(24794),p=o(i(54485)),g=i(54444),m=i(78179),y=i(12678),f=i(5032),w=i(41707),v=i(42297);l.logger.for("NearestLootProjection"),t.UNREACHABLE=Object.freeze({rootId:0,distance:Number.POSITIVE_INFINITY});class b extends r.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new S(this).update}bootstrap(e){const t=new S(this);return t.initFromState(e),h.Regions.getAll(e).forEach((e=>{t.addRootsFromRegion(e)})),t.getMap()}entryToString(e){return 0===e.distance?w.GLYPH.whiteFlag:e.distance}entryToDebugString(e){return(0,g.prettyPrintObject)(e)}}t.NearestLootProjection=b;class S extends d.BaseUpdater{constructor(){super(...arguments),this.builder=new r.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.sources=new Set,this}registerHandlers(e){e(this.dataSet.sources.townsByRegion,this.handleTownsByRegionChange),e(this.dataSet.sources.regionsByHex,this.handleRegionByHexChange)}handleTownsByRegionChange(e){e.updated?.forEach((e=>{e.added?.forEach((e=>{this.addNewRoot((0,u.getHex)(e))})),e.removed?.forEach((e=>{this.invalidateFrom((0,u.getHex)(e))}))}))}handleRegionByHexChange(e){e.updated?.forEach((([e,t])=>{this.invalidateFrom((0,u.getHex)(e))}))}addRootsFromRegion(e){h.Regions.model(this.newState).byId(e)&&f.Economy.getTownHexesByRegion(this.newState,e).forEach((e=>this.addNewRoot((0,u.getHex)(e))))}updateInvalidated(){this.addSourcesFromInvalidatedHexes();const e=new p.default(((e,t)=>e.distance-t.distance));for(this.sources.forEach((t=>{const i=this.builder.getCurrent(t.id);y.assert.defined(i),e.push({hex:t,rootHex:(0,u.getHex)(i.rootId),distance:i?.distance})}));!e.empty();){const t=e.pop(),i=t.hex;this.getCurrentDistanceFrom(i)<=t.distance||(this.invalidatedHexes.delete(i),this.builder.set(i.id,{distance:t.distance,rootId:t.rootHex.id}),i.neighbours((e=>{const i=h.Regions.getByHex(this.newState,e.id);return!v.Warfare.model(this.newState).isImpassable(e)&&void 0!==i&&this.getCurrentDistanceFrom(e)>=t.distance+1})).forEach((i=>{e.push({hex:i,rootHex:t.rootHex,distance:t.distance+1})})))}this.invalidatedHexes.forEach((e=>this.builder.delete(e.id)))}addSourcesFromInvalidatedHexes(){m.HexGroup.from(Array.from(this.invalidatedHexes)).neighbours().filter((e=>this.getCurrentDistanceFrom(e)<Number.POSITIVE_INFINITY)).forEach((e=>{this.sources.add(e),this.invalidatedHexes.add(e)}))}getMap(){return this.updateInvalidated(),c.Map(this.builder.getEntries()).mapKeys((e=>Number(e)))}createMutation(){return this.updateInvalidated(),super.createMutation()}invalidateFrom(e){if(this.invalidatedHexes.has(e))return;this.invalidatedHexes.add(e);const i=this.builder.getCurrent(e.id);i&&e.neighbours((e=>{const s=this.builder.getCurrent(e.id)??t.UNREACHABLE;return i.rootId==s.rootId&&s.distance===i.distance+1})).forEach((e=>this.invalidateFrom(e)))}getCurrentDistanceFrom(e){return this.invalidatedHexes.has(e)?Number.POSITIVE_INFINITY:this.builder.getCurrent(e.id)?.distance??Number.POSITIVE_INFINITY}addNewRoot(e){this.sources.add(e),this.builder.set(e.id,{rootId:e.id,distance:0}),this.invalidatedHexes.add(e)}}t.NearestLootUpdater=S},64748:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOrCreateNearestCamp=void 0;const s=i(50264),n=i(14344),a=i(21999),o=i(20666),r=i(30420),c=i(55668);i(48500).logger.for("bandits"),t.getOrCreateNearestCamp=function(e,t,i){const l=c.Bandits.getNearestCampHex(e.state,t.id);if(c.Bandits.getNearestCampDistance(e.state,t.id)>5){const c=function(e,t){const i=t.floodFillOut(((t,i,c)=>c<5&&function(e,t){const i=s.Regions.getByHex(e.state,t.id);if(!i)return!1;if(n.Factions.getByRegion(e.state,i)===a.SpecialFaction.neutral)return!0;const c=e.pawns.findOne({hexes:t,traits:[o.PawnTraits.OccupiesTile]});return!c||c.type===r.PawnType.Bandit}(e,t))).filter((t=>function(e,t){if(!e.factions.byHex(t)?.isNeutral())return!1;const i=e.warfare.getOccupyingUnit(t);return!i||i.type===r.PawnType.Bandit}(e,t)));let c,l=Number.NEGATIVE_INFINITY;return i.forEach((t=>{const i=function(e,t){const i=t.neighbours().filter((t=>function(e,t){const i=e.regions.byHex(t)?.faction;return void 0!==i&&!i.isNeutral()}(e,t))).length;return 2*t.neighbours().filter((t=>!!e.pawns.findOne({hexes:t,type:[r.PawnType.Forest]}))).length+t.neighbours().filter((t=>!e.regions.byHex(t))).length-2*i+(e.pawns.findOne({hexes:t,type:[r.PawnType.Bandit]})?3:0)}(e,t);i>l&&(c=t,l=i)})),c}(e,t);if(c){const t=e.pawns.findOne({hexes:c,type:[r.PawnType.Bandit]});if(t){const{newPawnId:s}=i.replace(t,r.PawnType.Camp);return e.pawns.byId(s)}{const t=i.create({hex:c,type:r.PawnType.Camp,captureHex:!1,tapUnit:!1});return e.pawns.byId(t.pawns[0].pawnId)}}return l?e.pawns.byHex(l,r.PawnType.Camp):void 0}return l?e.pawns.byHex(l,r.PawnType.Camp):void 0}},59575:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pickHexToEnter=t.moveBandits=void 0;const s=i(21999),n=i(50264),a=i(20666),o=i(48500),r=i(30420),c=i(14711);function l(e,t,i=new Set){const o=t.neighbours().filter((s=>function(e,t,i,s=new Set){if(!n.Regions.getByHex(e.state,i.id))return!1;if(function(e,t,i){const s=e.warfare.getHexStaticDefense(i)>0,n=e.regions.byHex(t)!==e.regions.byHex(i),a=!(e.warfare.getOccupyingUnit(t)?.type===r.PawnType.Camp)&&e.warfare.getHexStaticDefense(t)>0;return a!==s||(a||s)&&n}(e,t,i))return!1;const o=e.pawns.findOne({hexes:i,traits:[a.PawnTraits.OccupiesTile]});return!o||s.has(o)||o.hasTrait(a.PawnTraits.Treasure)}(e,t,s,i))),l=o.filter((t=>{const i=e.warfare.getOccupyingUnit(t);return Boolean(i?.hasTrait(a.PawnTraits.Treasure))})),d=o.filter((t=>e.regions.byHex(t)?.faction?.id!==s.SpecialFaction.neutral));return l.length>0?(0,c.deterministicRandomHexFrom)(e,l):d.length>0?(0,c.deterministicRandomHexFrom)(e,d):o.length>0?(0,c.deterministicRandomHexFrom)(e,o):void 0}o.logger.for("bandits"),t.moveBandits=function(e,t,i){for(;t.size;)s(t[Symbol.iterator]().next().value);function s(n){if(t.delete(n),!n.exists)return;const o=l(e,n.hex,t);if(o){const r=function(i){const s=e.pawns.findOne({hexes:i,traits:[a.PawnTraits.OccupiesTile]});return s&&t.has(s)?s:void 0}(o);if(r)s(r),s(n);else{const t=e.warfare.getOccupyingUnit(o)?.id;i.move({pawnId:n.id,destHex:o,captureHex:!1,defeatedUnit:t?{pawnId:t}:void 0,tapUnit:!1})}}}},t.pickHexToEnter=l},99896:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurrentPhase=void 0;const s=i(47610),n=i(98030),a=i(63290),o=i(63078),r=i(81439);class c{static model(e){return this.models.get(e)}static getFaction(e){return(0,n.selectFromState)(e,s.GameState.currentPhase.data)?.faction}static getType(e){return(0,n.selectFromState)(e,s.GameState.currentPhase.data)?.type}static getTurnNumber(e){return(0,n.selectFromState)(e,s.GameState.currentPhase.data)?.turnNumber}static isMovable(e,t){return(0,n.selectFromState)(e,s.GameState.currentPhase.movableUnits).has(t)}static getMovableUnits(e){return(0,n.selectFromState)(e,s.GameState.currentPhase.movableUnits).toArray()}static getTappedUnits(e){return(0,n.selectFromState)(e,s.GameState.currentPhase.tappedUnits).toArray()}static isTapped(e,t){return(0,n.selectFromState)(e,s.GameState.currentPhase.tappedUnits).has(t)}static tapPawn(e,t){return(0,n.applyMutations)(e,s.GameState.currentPhase.tappedUnits.createMutation({add:[t]},"currentPhase.tapPawn"))}static unTapPawn(e,t){return(0,n.applyMutations)(e,s.GameState.currentPhase.tappedUnits.createMutation({delete:[t]},"currentPhase.unTapPawn"))}static set(e,t){const i=(0,n.selectFromState)(e,s.GameState.currentPhase.data),a=new o.SetDataSetMutationBuilder(s.GameState.currentPhase.tappedUnits);return a.init(e),a.clear(),(0,n.applyMutations)(e,s.GameState.currentPhase.data.createMutation({...i,...t},"currentPhase.set"),a.createMutation("currentPhase.set"))}}t.CurrentPhase=c,c.models=new r.ModelsCache((e=>new a.CurrentPhaseModel(e)))},63290:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurrentPhaseModel=void 0;const s=i(30420),n=i(12678),a=i(99896),o=i(14344),r=i(62977),c=i(27379),l=i(17093),d=i(36307);class h extends c.BaseModel{constructor(){super(...arguments),this.tappedUnits=(0,l.lazyAdapter)({source:()=>a.CurrentPhase.getTappedUnits(this.state),transform:e=>e.map((e=>r.Pawns.model(this.state).byId(e)))})}get type(){return a.CurrentPhase.getType(this.state)}get turnNumber(){return a.CurrentPhase.getTurnNumber(this.state)}get faction(){const e=a.CurrentPhase.getFaction(this.state);if(void 0!==e)return o.Factions.model(this.state).byId(e)}isTapped(e){return a.CurrentPhase.isTapped(this.state,e.id)}isMovable(e){return a.CurrentPhase.isMovable(this.state,e.id)}isLocalPlayerTurn(){return this.type===s.PhaseTypes.FactionTurn&&this.faction?.controller===s.FactionController.LocalUser}getMovablePawns(){if(this.type!==s.PhaseTypes.FactionTurn)return[];n.assert.defined(this.faction);const e=r.Pawns.model(this.state);return a.CurrentPhase.getMovableUnits(this.state).map((t=>e.byId(t)))}getNextFaction(){const e=a.CurrentPhase.getFaction(this.state)||0,t=o.Factions.model(this.state);for(let i=(e+1)%(d.MAX_FACTIONS_COUNT+1);i!==e;i=(i+1)%(d.MAX_FACTIONS_COUNT+1)){const e=t.byId(i);if(e&&(e.isNeutral()||e.isAlive()))return i}return e}tapPawn(e){this.state=a.CurrentPhase.tapPawn(this.state,e.id)}unTapPawn(e){this.state=a.CurrentPhase.unTapPawn(this.state,e.id)}set(e){this.state=a.CurrentPhase.set(this.state,e)}is(e){return this.type===e}incrementTurnNumber(){this.set({turnNumber:this.turnNumber+1})}}t.CurrentPhaseModel=h},39710:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.mergeTransactions=t.CoinTransactionBuilder=void 0;const n=i(85656),a=i(30420),o=i(12678),r=i(98030),c=i(62977),l=i(24794),d=s(i(96486));function h(){return{consume:0,send:{},spawn:0}}t.CoinTransactionBuilder=class{constructor(){this.data={}}isEmpty(){return 0===Object.keys(this.data).length}from(e){return this.currentHex=e,this}spawn(e){return o.assert.defined(this.currentHex,"no hex selected"),(0,n.getOrCreate)(this.data,this.currentHex.id,h).spawn+=e,this.currentAmount=e,this}send(e,t=this.currentAmount){o.assert.defined(this.currentHex,"no hex selected"),o.assert.defined(t,"amount not specified");const i=(0,n.getOrCreate)(this.data,this.currentHex.id,h);return i.send[e.id]=(i.send[e.id]||0)+t,this.currentHex=e,this.currentAmount=t,this}consume(e=this.currentAmount){return o.assert.defined(e,"amount not specified"),o.assert.defined(this.currentHex,"no hex selected"),(0,n.getOrCreate)(this.data,this.currentHex.id,h).consume+=e,this}getTransactions(){return this.data}reset(){this.currentHex=void 0,this.currentAmount=void 0,this.data={}}apply(e){return function(e,t){const i={};Object.entries(t).forEach((([e,t])=>{i[e]=i[e]||0,i[e]+=t.spawn,i[e]-=t.consume,Object.entries(t.send).forEach((([t,s])=>{i[e]-=s,i[t]=(i[t]||0)+s}))}));const s=c.Pawns.model((0,r.getParentEngine)(e));return Object.entries(i).forEach((([e,t])=>{const i=(0,l.getHex)(Number(e));o.assert.defined(i),s.adjustCount(i,a.PawnType.Coins,t)})),s.state}(e,this.getTransactions())}},t.mergeTransactions=function(e,t){const i=d.default.cloneDeep(e);for(const e of Object.keys(t)){const s=Number(e),n=t[s];if(i[s]){i[s].consume+=n.consume;for(const e of Object.keys(n.send)){const t=Number(e);i[s].send[t]=(i[s].send[t]||0)+n.send[t]}i[s].spawn+=n.spawn}else i[s]=n}return i}},5032:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Economy=t.EMPTY_BUDGET=void 0;const o=i(47610),r=i(98030),c=i(20666),l=i(30420),d=i(39710),h=i(78179),u=i(52048),p=i(62977),g=i(50264),m=i(48500),y=i(77838),f=a(i(35369)),w=i(14344),v=i(21999),b=i(55668),S=i(24794),x=i(81439),T=m.logger.for("Economy");t.EMPTY_BUDGET={balance:0,upkeep:0,incomeFromHexes:0,potentialIncome:0};class P{static model(e){return this.models.get(e)}static getTownHexesByRegion(e,t){return(0,r.selectFromState)(e,o.GameState.economy.townsByRegion,t)||f.Set()}static getBaseIncomePerHex(e){return u.Rules.getEconomyRules(e).baseIncomePerTile}static getIncomeFromHex(e,t){return p.Pawns.model(e).byHex(t).find((e=>e.hasTrait(c.PawnTraits.NegatesTileIncome)))?0:this.getBaseIncomePerHex(e)}static getTreasuryOf(e,t){return(0,r.selectFromState)(e,o.GameState.economy.treasuryByRegion,t)||0}static getNumberOfCoinsAt(e,t){return(0,r.selectFromState)(e,o.GameState.economy.coinsByHex,t)||0}static isRegionBankrupt(e,t){return this.getTreasuryOf(e,t)+this.getRegionBudget(e,t).balance<0}static isRegionAlive(e,t){if(0===P.getTownHexesByRegion(e,t).size)return!1;const i=w.Factions.getByRegion(e,t);if(!i)return!1;const s=w.Factions.getData(e,i);return!(!s?.controller||s?.controller===l.FactionController.None)}static payForNewPawn(e,t,i,s){return this.payToHex(e,t,i,u.Rules.getPawnRules(e,s)?.cost||0)}static payToHex(e,t,i,s,n=new d.CoinTransactionBuilder){const a=g.Regions.model(e).byId(t);let o=s;n.from(i).consume(s);let r=new Set;for(;o>0;){const t=a.hexes.with(i).findClosest(i,(t=>!r.has(t)&&P.getNumberOfCoinsAt(e,t.id)>0));if(!t)throw new Error(`Unable to find enough gold to pay ${s}g to hex ${i} in region ${a}`);const c=P.getNumberOfCoinsAt(e,t.id),l=Math.min(c,o);o-=l,r.add(t),n.from(t).send(i,l)}return n}static loot(e,t,i,s=0,n=new d.CoinTransactionBuilder){const a=n,o=function(){if(w.Factions.getByRegion(e,i.id)===v.SpecialFaction.neutral){const i=b.Bandits.getNearestCampHex(e,t.id);return i?(0,S.getHex)(i):void 0}{const s=P.getTownHexesByRegion(e,i.id);return h.HexGroup.from([...i.hexes.members,t]).findClosest(t,(e=>e!==t&&s.includes(e.id)))}}();s&&a.from(t).spawn(s);const r=this.getNumberOfCoinsAt(e,t.id)+s;return 0===r||(o?a.from(t).send(o,r):(T.warning(`did not find any town in ${i} that could receive loot from ${t}, the money will just disappear`),a.from(t).consume(r))),a}static getRegionBudget(e,i){return(0,r.selectFromState)(e,o.GameState.economy.budgetByRegion,i)||t.EMPTY_BUDGET}}t.Economy=P,P.models=new x.ModelsCache((e=>new y.EconomyModel(e)))},77838:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EconomyModel=void 0;const s=i(98030),n=i(85696),a=i(20666),o=i(52048),r=i(62977),c=i(48500),l=i(5032),d=i(27379),h=i(24794),u=i(47610);c.logger.for("EconomyModel");class p extends d.BaseModel{townHexesOf(e){const t=l.Economy.getTownHexesByRegion(this.state,e.id);return(0,h.getHexes)(t.toArray())}nearestTownHexFrom(e){const t=(0,s.selectFromState)(this.state,u.GameState.economy.nearestTown,e.id)?.rootId;if(t)return(0,h.getHex)(t)}distanceToTownFrom(e){return 0}baseIncomePerHex(){return o.Rules.getEconomyRules(this.state).baseIncomePerTile}incomeFromHex(e){return r.Pawns.model(this.state).byHex(e).find((e=>e.hasTrait(a.PawnTraits.NegatesTileIncome)))?0:l.Economy.getBaseIncomePerHex(this.state)}gatherIncomeAndPayUpkeep(e,t){return new n.RegionEconomyCalculator(e,t).run({gatherIncome:!0,payUpkeep:!0})}treasuryOf(e){return l.Economy.getTreasuryOf(this.state,e.id)}numberOfCoinsAt(e){return l.Economy.getNumberOfCoinsAt(this.state,e.id)}payForNewPawn(e,t,i){const s=l.Economy.payToHex(this.state,t.id,e,o.Rules.getPawnRules(this.state,i)?.cost||0);return s.apply(this.state),s.getTransactions()}payToHex(e,t,i,s){const n=l.Economy.payToHex(this.state,i.id,t,s);return n.apply(this.state),n.getTransactions()}loot(e,t,i=0){const s=l.Economy.loot(this.state,e,t,i);return s.apply(this.state),s.getTransactions()}budgetOf(e){return l.Economy.getRegionBudget(this.state,e.id)}}t.EconomyModel=p},85696:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionEconomyCalculator=void 0;const s=i(48500),n=i(39710),a=i(30420),o=i(12678),r=i(5032),c=i(24794),l=i(20666),d=i(21999),h=i(64748),u=i(33174);s.logger.for("RegionEconomyCalculator"),t.RegionEconomyCalculator=class{constructor(e,t){this.model=e,this.region=t,this.sinks=[],this.builder=new n.CoinTransactionBuilder,this.worldUpdateBuilder=new u.WorldUpdateBuilder(this.model)}run({gatherIncome:e,payUpkeep:t}){this.allRegionHexes=this.region.hexes,this.builder.reset();const i=r.Economy.getTownHexesByRegion(this.model.state,this.region.id).toArray();if(this.townHexes=(0,c.getHexes)(i).members,this.goldByHex={},this.spawnGoldInTreasury(),e&&this.spawnIncome(),t)for(this.assembleSinks();this.sinks.length;){const e=this.sinks[0],t=this.allRegionHexes.findClosest(e.pawn.hex,(e=>(this.goldByHex[e.id]||0)>0));if(!t)break;{const i=this.goldByHex[t.id];i>e.demand?this.sendMoneyToSink(t,0,e.demand):this.sendMoneyToSink(t,0,i)}}Object.entries(this.goldByHex).map((([e,t])=>({hexId:Number(e),remainingIncome:t}))).filter((({hexId:e})=>!i.includes(e))).forEach((({hexId:e,remainingIncome:t})=>{const i=(0,c.getHex)(e),s=this.model.economy.nearestTownHexFrom(i);s&&this.sendMoneyToTown(i,s,t)}));let s=!1;if(this.sinks.length>0){const e=this.model.pawns.select({hexes:this.region.hexes,traits:[l.PawnTraits.Unit]});s=e.length>0,e.forEach((e=>{this.worldUpdateBuilder.replace(e,this.model.rules.getBanditUnitType())})),0===this.townHexes.length&&(s=!0,this.model.pawns.select({hexes:this.region.hexes,type:[a.PawnType.Castle]}).forEach((e=>{const t=e.hex;this.worldUpdateBuilder.replace(e,this.model.rules.getBanditCampUnitType()),this.worldUpdateBuilder.takeOverHex(t,this.model.factions.byId(d.SpecialFaction.neutral))})))}return this.builder.apply(this.model.state),{regionId:this.region.id,sufferedRebellion:s,coinTransfers:this.builder.getTransactions(),worldUpdates:this.worldUpdateBuilder.getUpdates()}}assembleSinks(){this.model.pawns.select({hexes:this.region.hexes}).filter((e=>e.upkeep&&e.upkeep>0)).forEach((e=>{this.sinks.push({pawn:e,demand:e.upkeep})}))}sendMoneyToSink(e,t,i){const s=this.sinks[t];this.builder.from(e).send(s.pawn.hex,i).consume(),s.demand-=i,this.removeGoldFromHex(e,i),0===s.demand&&this.sinks.splice(t,1)}sendMoneyToTown(e,t,i){this.builder.from(e).send(t,i),this.removeGoldFromHex(e,i),this.addGoldToHex(t,i)}spawnIncome(){0!==this.townHexes.length&&(this.allRegionHexes.forEach((e=>{const t=this.model.economy.incomeFromHex(e.id);t>0&&(this.addGoldToHex(e,t),this.builder.from(e).spawn(t))})),this.evalBanditLooting())}spawnGoldInTreasury(){for(const e of this.townHexes)this.addGoldToHex(e,this.model.economy.numberOfCoinsAt(e)||0)}addGoldToHex(e,t){this.goldByHex[e.id]=(this.goldByHex[e.id]||0)+t}removeGoldFromHex(e,t){(0,o.assert)(this.goldByHex[e.id]>0),this.goldByHex[e.id]=this.goldByHex[e.id]-t,this.goldByHex[e.id]<=0&&delete this.goldByHex[e.id]}evalBanditLooting(){this.model.pawns.select({hexes:this.allRegionHexes,type:[a.PawnType.Bandit]}).map((e=>e.hex)).forEach((e=>{const t=(0,h.getOrCreateNearestCamp)(this.model,e,this.worldUpdateBuilder);t&&this.builder.from(e).spawn(1).send(t.hex)}))}}},208:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EMPTY_SPLIT_REGION_OUTPUT=t.FactionModel=void 0;const s=i(78179),n=i(78166),a=i(48500),o=i(58257),r=i(30420),c=i(12678),l=i(14344),d=i(50264),h=i(17093),u=i(85656),p=i(80682),g=i(70448),m=i(40108),y=i(21999),f=i(33174),w=i(88865),v=i(51019),b=i(23441),S=i(98512),x=i(66206),T=i(47610),P=i(98030),M=i(58089);a.logger.for("FactionsModel");class I extends n.BaseEntityModel{constructor(){super(...arguments),this.getRegions=(0,h.lazyAdapter)({source:()=>l.Factions.getFactionRegions(this.state,this.id),transform:e=>e.map((e=>d.Regions.model(this.state).byId(e)))}),this.getLiveRegions=(0,h.lazyAdapter)({source:()=>l.Factions.getFactionRegions(this.state,this.id),transform:e=>e.map((e=>d.Regions.model(this.state).byId(e))).filter((e=>e.isAlive()))})}data(){return l.Factions.getData(this.state,this.id)}get exists(){return!!this.data()}get name(){return this.data()?.name||""}get themeIndex(){return this.data()?.themeIndex||0}get landColorLight(){return Phaser.Display.Color.IntegerToColor(this.landColor).lighten(10).color}get landColor(){return p.WorldMap.model(this.state).theme.colors[this.themeIndex]||13421772}get landColorDark(){return Phaser.Display.Color.IntegerToColor(this.landColor).darken(20).color}get size(){return this.getLiveRegions().map((e=>e.size)).reduce(b.sum,0)}get controller(){return this.data()?.controller}get powerFactors(){return m.AI.getFactionPower(this.state,this.id)}get scaledPower(){return m.AI.getFactionScaledPower(this.state,this.id)}get rawPower(){return m.AI.getFactionRawPower(this.state,this.id)}get income(){return this.getRegions().reduce(((e,t)=>e+(0,b.pickLarger)(0,t.budget.balance)),0)}get forecast(){return this.isAlive()?this.getRegions().reduce(((e,t)=>e+(0,b.pickLarger)(0,S.AIMetrics.snowballScale(t.forecast,1.25))),0):0}get aiPersonality(){return this.data()?.aiPersonality??v.DEFAULT_AI_PERSONALITY}setAiPersonality(e){this.state=l.Factions.setData(this.state,this.id,{controller:r.FactionController.Ai,aiPersonality:{...this.aiPersonality,...e}})}get hexes(){return s.HexGroup.union(this.getRegions().map((e=>e.hexes)))}get liveHexes(){return s.HexGroup.union(this.getRegions().filter((e=>e.isAlive())).map((e=>e.hexes)))}isAlive(){return this.controller!==r.FactionController.None&&this.getRegions().find((e=>e.isAlive()))}isLocalPlayer(){return this.controller===r.FactionController.LocalUser}isNeutral(){return this.id==y.SpecialFaction.neutral}getPawns(e){const t=(0,u.mergeArrays)(...this.getRegions().map((e=>e.getPawns())));return e?(0,o.filterPawns)(this.state,t,e):t}addNewRegion(e,t){const i=d.Regions.getNextId(this.state);return this.state=l.Factions.addNewRegion(this.state,this.id,e,t.toIdsArray()),d.Regions.model(this.state).byId(i)}disownRegions(...e){return this.state=l.Factions.disownRegions(this.state,...e.map((e=>e.id))),this}captureRegions(...e){return this.state=l.Factions.captureRegions(this.state,this.id,...e.map((e=>e.id))),this}takeOverHex(e,i){const n=d.Regions.model(this.state),a=this.parentModel,o=n.byHex(e),r=o?.id;let h=i?.id;const p=!!o?.isAlive();if(o?.faction===this)return;let g=e.neighbours().map((e=>({region:n.byHex(e),faction:a.byHex(e)}))).filter((({region:e,faction:t})=>t===this)).map((({region:e,faction:t})=>e));g=(0,u.stripDuplicatesFrom)(g);const m=new x.MapMutationBuilder(T.GameState.regions.byHex).init(this.state);h?g=g.filter((e=>e.id!==i.id)):(h=g.pop()?.id,h||(h=d.Regions.getNextId(this.state),l.Factions.addNewRegion(this.state,this.id,w.inject.random.townName(),[e.id]))),m.set(e.id,h);let y=s.HexGroup.empty;const v=g.map((e=>e.id));if(g.length>0){y=s.HexGroup.union(g.map((e=>e.hexes)));for(let e of y)m.set(e.id,h)}const b=r?function(e,i,s,n=d.Regions.getNextId(e)){const a=s;if(!a)return t.EMPTY_SPLIT_REGION_OUTPUT;c.assert.defined(a);const o=l.Factions.getByRegion(e,a);c.assert.defined(o);const r=[],h=[],u=[];if(i.disjointedNeighbourGroups((t=>d.Regions.getByHex(e,t.id)===a)).getGroups().length<2)return t.EMPTY_SPLIT_REGION_OUTPUT;const p=d.Regions.model(e).byId(a).hexes.without(i).components();if(p.length>1)for(p.popLargestGroup();p.length>0;){let e=p.popLargestGroup(),t=n++;u.push(t),h.push(...e),r.push(d.RegionMutations.createRegion(t,w.inject.random.townName()),d.RegionMutations.addHexesToRegion(t,e.toIdsArray()),l.FactionMutations.captureRegions(o,[t]))}return{splitOffHexes:h,mutations:r,splitOffRegionIds:u}}(this.state,e,r):t.EMPTY_SPLIT_REGION_OUTPUT;return(0,P.applyMutations)(this.state,...(0,M.mergeMutations)([m.createMutation("faction.takeOverHex")],b.mutations)),{type:f.UpdateType.HexTakeover,newFactionId:this.id,newRegionId:h,conqueredHex:e.id,connectedHexes:y.toIdsArray(),affectedHexes:s.HexGroup.union([e,y,s.HexGroup.from(b.splitOffHexes)]).toIdsArray(),victimRegionId:r,victimRegionWasAlive:p,splitOffRegions:b.splitOffRegionIds,affectedRegions:[h,...[o?.id].filter((e=>e)),...v,...b.splitOffRegionIds]}}ownsHex(e){return l.Factions.getByHex(this.state,e.id)===this.id}absorbOwnRegionsAdjacentTo(e){(0,c.assert)(this.ownsHex(e),`${e} is not owned by ${this}!`);const t=d.Regions.model(this.state),i=t.byHex(e);c.assert.defined(i);const s=Array.from(new Set(e.neighbours().map((e=>t.byHex(e))).filter((e=>e&&e!==i&&e.faction===this))));if(0===s.length)return[];const n=s.map((e=>({originalRegionId:e.id,hexes:e.hexes})));return i.absorbRegions(s),n}splitRegionIfDisconnected(e){const t=e.hexes.components(),i=[];if(t.length>1)for(t.popLargestGroup();t.length>0;){let e=t.popLargestGroup();i.push(this.addNewRegion(w.inject.random.townName(),e))}return i}setController(e){this.state=l.Factions.setController(this.state,this.id,e)}toString(){return`[Faction #${this.id} "${this.name}"]`}getLargestLiveRegion(){const e=this.getLiveRegions();if(0!==e.length)return e.reduce(((e,t)=>t.hexes.length>e.hexes.length?t:e))}setLandColor(e){g.THEMES.default.colors[this.themeIndex]=e}fearOf(e){return m.AI.getFactionFear(this.state,this.id,e.id)}approvalOf(e){return m.AI.getFactionApproval(this.state,this.id,e.id)}attitudeTowards(e){return m.AI.getFactionAttitude(this.state,this.id,e.id)}mergeAdjacentRegions(){for(let e of this.getRegions()){let t=e.getNeighbours().filter((e=>e.faction===this));for(;t.length;)e.addHexes(s.HexGroup.union(t.map((e=>e.hexes)))),e.parentModel.destroy(...t),t=e.getNeighbours().filter((e=>e.faction===this))}}}t.FactionModel=I,t.EMPTY_SPLIT_REGION_OUTPUT={mutations:[],splitOffHexes:[],splitOffRegionIds:[]}},14344:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionMutations=t.Factions=void 0;const s=i(47610),n=i(50264),a=i(30420),o=i(98030),r=i(41280),c=i(12678),l=i(81439);class d{static model(e){return this.models.get(e)}static getAll(e){return(0,o.selectFromState)(e,s.GameState.factions.byId).keySeq().toArray()}static getData(e,t){return(0,o.selectFromState)(e,s.GameState.factions.byId,t)}static getByRegion(e,t){return(0,o.selectFromState)(e,s.GameState.factions.byRegion,t)}static getByHex(e,t){const i=n.Regions.getByHex(e,t);if(i)return d.getByRegion(e,i)}static getNextId(e){return(0,o.selectFromState)(e,s.GameState.factions.nextId)}static getFactionRegions(e,t){return(0,o.selectFromState)(e,s.GameState.factions.regions,t)?.toArray()||[]}static setThemeIndex(e,t,i){const n=d.getData(e,t);return c.assert.defined(n),(0,o.applyMutations)(e,s.GameState.factions.byId.createMutation({set:{[t]:{...n,themeIndex:i}}},"faction.setLandColor"))}static setController(e,t,i){const n=d.getData(e,t);return c.assert.defined(n),(0,o.applyMutations)(e,s.GameState.factions.byId.createMutation({set:{[t]:{...n,controller:i}}},"faction.setController"))}static setData(e,t,i){const n=d.getData(e,t);return c.assert.defined(n),(0,o.applyMutations)(e,s.GameState.factions.byId.createMutation({set:{[t]:{...n,...i}}},"faction.setData"))}static createFaction(e,{name:t,regions:i,themeIndex:n,controller:r}){const c=this.getNextId(e),l={id:c,name:t,controller:r??a.FactionController.None,themeIndex:n??0};return(0,o.applyMutations)(e,s.GameState.factions.byId.createMutation({set:{[c]:l}},"createFaction"),h.captureRegions(c,i||[]))}static captureRegions(e,t,...i){return 0===i.length?e:(0,o.applyMutations)(e,h.captureRegions(t,i))}static addNewRegion(e,t,i,s,a){const r=a??n.Regions.getNextId(e);return(0,o.applyMutations)(e,n.RegionMutations.createRegion(r,i),n.RegionMutations.addHexesToRegion(r,s),h.captureRegions(t,[r]))}static disownRegions(e,...t){const i=t.filter((t=>void 0!==this.getByRegion(e,t)));return(0,o.applyMutations)(e,s.GameState.factions.byRegion.createMutation({delete:i},"faction.disownRegions"))}static getSameFactionNeighbours(e,t,i){const s=i??this.getByHex(e,t.id);return t.neighbours((t=>this.getByHex(e,t.id)===s))}}t.Factions=d,d.models=new l.ModelsCache((e=>new r.FactionsDataSetModel(e)));class h{static captureRegions(e,t){const i={};return t.forEach((t=>i[t]=e)),s.GameState.factions.byRegion.createMutation({set:i},"faction.captureRegions")}}t.FactionMutations=h},41280:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionsDataSetModel=void 0;const s=i(208),n=i(14344),a=i(50264),o=i(27379),r=i(21999);class c extends o.BaseModel{constructor(){super(...arguments),this.factionModels={}}byId(e){let t=this.factionModels[e];if(t||(t=new s.FactionModel(this,e),this.factionModels[t.id]=t),t.exists)return t}get neutral(){return this.byId(r.SpecialFaction.neutral)}get localPlayer(){return this.byId(1)}byRegion(e){const t=n.Factions.getByRegion(this.state,e.id);if(void 0!==t)return this.byId(t)}byHex(e){const t=a.Regions.getByHex(this.state,e.id);if(!t)return;const i=n.Factions.getByRegion(this.state,t);return void 0!==i?this.byId(i):void 0}nextId(){return n.Factions.getNextId(this.state)}all(){return n.Factions.getAll(this.state).map((e=>this.byId(e)))}create(e){const t=this.nextId();return this.state=n.Factions.createFaction(this.state,{...e,regions:e.regions?.map((e=>e.id))}),this.byId(t)}}t.FactionsDataSetModel=c},17093:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazyAdapter=void 0,t.lazyAdapter=function(e){let t,i;return()=>{const s=e.source();return void 0!==s&&s===i||(t=e.transform(s),i=s),t}}},58257:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.filterPawns=t.PawnModel=void 0;const s=i(78166),n=i(20666),a=i(62977),o=i(52048),r=i(50264),c=i(14344),l=i(99896),d=i(24794);class h extends s.BaseEntityModel{get exists(){return!!a.Pawns.getPawnData(this.state,this.id)}get name(){return a.Pawns.getPawnData(this.state,this.id)?.name||""}get type(){return a.Pawns.getPawnData(this.state,this.id).type}get count(){return a.Pawns.getPawnCount(this.state,this.id)||0}get traits(){return this.rules?.traits}get cost(){return this.rules?.cost}get upkeep(){return this.rules?.upkeep}get might(){return this.rules.might}get defenseMight(){return this.rules.defenseMight}get protection(){return this.hasTrait(n.PawnTraits.GuardsAdjacentTiles)?this.rules.defenseMight:0}get rules(){return o.Rules.model(this.state).pawns(this.type)}get region(){return r.Regions.model(this.state).byHex(this.hex)}get faction(){return c.Factions.model(this.state).byHex(this.hex)}hasTrait(e){return this.traits.includes(e)}get hex(){return(0,d.getHex)(a.Pawns.getPawnHex(this.state,this.id))}replaceWith(e){const t=this.hex;return this.state=a.Pawns.replacePawn(this.state,this.id,e),this.parentModel.byHex(t,e)}isMovable(){return l.CurrentPhase.isMovable(this.state,this.id)}isInvincible(){return this.might>=10}moveTo(e){return this.state=a.Pawns.movePawn(this.state,this.id,e.id),this}setCount(e){return this.state=a.Pawns.setPawnCount(this.state,this.id,e),this}toString(){const e=this.type+(void 0!==this.count&&1!==this.count?`×${this.count}`:"");return`[Pawn #${this.id} (${e} at ${this.hex})]`}destroy(){this.parentModel.destroy(this)}}t.PawnModel=h,t.filterPawns=function(e,t,i){return i.type&&(t=t.filter((e=>i.type.includes(e.type)))),i.traits&&(t=t.filter((e=>i.traits.every((t=>e.hasTrait(t)))))),t}},62977:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnMutations=t.Pawns=void 0;const s=i(98030),n=i(47610),a=i(12678),o=i(72953),r=i(24794),c=i(81439);class l{static model(e){return this.models.get(e)}static getPawnData(e,t){return(0,s.selectFromState)(e,n.GameState.pawns.byId,t)}static getPawnType(e,t){return this.getPawnData(e,t)?.type}static getPawnCount(e,t){return(0,s.selectFromState)(e,n.GameState.pawns.count,t)||0}static getByHex(e,t,i){return void 0===i?(0,s.selectFromState)(e,n.GameState.pawns.byHex,t)?.toArray()||[]:(0,s.selectFromState)(e,n.GameState.pawns.byHex,t)?.filter((t=>l.getPawnData(e,t)?.type===i)).first()}static getPawnHex(e,t){return(0,s.selectFromState)(e,n.GameState.pawns.hex,t)}static getByRegion(e,t){return(0,s.selectFromState)(e,n.GameState.pawns.byRegion,t)?.toArray()||[]}static getNextId(e){return(0,s.selectFromState)(e,n.GameState.pawns.nextId)}static getAll(e){return(0,s.selectFromState)(e,n.GameState.pawns.byId).keySeq().toArray()}static destroy(e,...t){return 0===t.length?e:(0,s.applyMutations)(e,...d.destroyPawns(t))}static create(e,t){return(0,s.applyMutations)(e,...d.createPawn(e,t))}static setPawnCount(e,t,i){return(0,a.assert)(i>=0,`attempt to set count of pawn #${t} to negative value (${i})`),(0,s.applyMutations)(e,...d.setPawnCount(t,i))}static replacePawn(e,t,i,n){const o=l.getPawnHex(e,t),c=l.getByHex(e,o,i),h={...l.getPawnData(e,t),type:i};return a.assert.undefined(c,`Cannot replace pawn ${t} with ${i}, pawn ${c} on the same hex already has this type`),(0,s.applyMutations)(e,...d.replacePawn(e,t,{...h,hex:(0,r.getHex)(o),id:n}))}static movePawn(e,t,i){return(0,s.applyMutations)(e,n.GameState.pawns.hex.createMutation({set:{[t]:i}},"pawn.moveTo"))}}t.Pawns=l,l.models=new c.ModelsCache((e=>new o.PawnsDataSetModel(e)));class d{static setPawnCount(e,t){return(0,a.assert)(t>=0,`attempt to set count of pawn #${e} to negative value (${t})`),0===t?this.destroyPawns([e]):[n.GameState.pawns.count.createMutation({set:{[e]:t}},"setPawnCount")]}static destroyPawns(e){return[n.GameState.pawns.count.createMutation({delete:e},"pawns.destroy"),n.GameState.pawns.hex.createMutation({delete:e},"pawns.destroy"),n.GameState.pawns.byId.createMutation({delete:e},"pawns.destroy")]}static createPawn(e,t){const i=t.id??l.getNextId(e),s={id:i,type:t.type,name:t.name};return[n.GameState.pawns.byId.createMutation({set:{[i]:s}},"pawns.create"),n.GameState.pawns.hex.createMutation({set:{[i]:t.hex.id}},"pawns.create"),n.GameState.pawns.count.createMutation({set:{[i]:t.count||1}},"pawns.create")]}static replacePawn(e,t,i){const s=i.id??l.getNextId(e),a={id:s,type:i.type,name:i.name};return[n.GameState.pawns.byId.createMutation({set:{[s]:a},delete:[t]},"pawns.replace"),n.GameState.pawns.hex.createMutation({set:{[s]:i.hex.id},delete:[t]},"pawns.replace"),n.GameState.pawns.count.createMutation({set:{[s]:i.count||1},delete:[t]},"pawns.replace")]}}t.PawnMutations=d},72953:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsDataSetModel=void 0;const s=i(85656),n=i(12678),a=i(58257),o=i(62977),r=i(27379),c=i(24794),l=i(80682);class d extends r.BaseModel{constructor(){super(...arguments),this.pawnModels={}}byId(e){let t=this.pawnModels[e];if(t||(t=new a.PawnModel(this,e),this.pawnModels[e]=t),t.exists)return t}byType(e,t){return this.select({hexes:e,type:[t]})}select(e){const t=e.hexes||l.WorldMap.getAllHexes(this.state);let i=(0,s.mergeArrays)(...t.map((e=>o.Pawns.getByHex(this.state,e.id)))).map((e=>this.byId(e)));return e.type&&(i=i.filter((t=>e.type.includes(t.type)))),e.traits&&(i=i.filter((t=>e.traits.every((e=>t.hasTrait(e)))))),void 0!==e.movable&&(i=i.filter((t=>t.isMovable()===e.movable))),i}findOne(e){return this.select(e)[0]}findClosest(e,t,i){let s;return t.bfsFrom(e,(e=>!s&&(s=this.byHex(e).filter(i)[0],!s))),s}byHex(e,t){return"number"==typeof e&&(e=(0,c.getHex)(e)),t?this.select({hexes:e,type:[t]})[0]:this.select({hexes:e})}byRegion(e){return o.Pawns.getByRegion(this.state,e.id).map((e=>this.byId(e)))}adjustCount(e,t,i){if(0===i)return;const s=this.byHex(e,t);s?s.setCount(s.count+i):((0,n.assert)(i>=0,`attempt to reduce ${t} count at ${e} below 0 (0-${-i}=${i})`),this.create({hex:e,type:t,count:i}))}setCount(e,t,i){const s=this.byHex(e,t);if(s)s.setCount(i);else{if(0===i)return;this.create({hex:e,type:t,count:i})}}presentAtHex(e,...t){return this.select({hexes:e,type:t.length>0?t:void 0}).length>0}nextId(){return o.Pawns.getNextId(this.state)}all(){return o.Pawns.getAll(this.state).map((e=>this.byId(e)))}create(e){const t=this.nextId();return this.state=o.Pawns.create(this.state,e),this.byId(t)}destroy(...e){this.state=o.Pawns.destroy(this.state,...e.map((e=>e.id)))}clear(){this.destroy(...this.all())}getCount(e,t){const i=this.byHex(e,t);return i?i.count:0}}t.PawnsDataSetModel=d},84587:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionModel=void 0;const s=i(78179),n=i(17093),a=i(30420),o=i(50264),r=i(14344),c=i(5032),l=i(78166),d=i(62977),h=i(24794),u=i(42297),p=i(99896),g=i(85656),m=i(23206),y=i(54812),f=i(88865),w=i(20666),v=i(23441),b=i(15496);class S extends l.BaseEntityModel{constructor(){super(...arguments),this._hexes=(0,n.lazyAdapter)({source:()=>o.Regions.getRegionHexes(this.state,this.id),transform:e=>(0,h.getHexes)(e.toArray())}),this.getTownHexes=(0,n.lazyAdapter)({source:()=>c.Economy.getTownHexesByRegion(this.state,this.id),transform:e=>(0,h.getHexes)(e.toArray())}),this.getBorderHexes=(0,n.lazyAdapter)({source:()=>o.Regions.getRegionEdgeHexes(this.state,this.id),transform:e=>(0,h.getHexes)(e.toArray())}),this.getHostileBorderHexes=(0,n.lazyAdapter)({source:()=>o.Regions.getRegionBorderHexes(this.state,this.id),transform:e=>(0,h.getHexes)(e.toArray())}),this.getPawns=(0,n.lazyAdapter)({source:()=>d.Pawns.getByRegion(this.state,this.id),transform:e=>e.map((e=>d.Pawns.model(this.state).byId(e)))}),this.getAssets=(0,n.lazyAdapter)({source:()=>this.state,transform:e=>p.CurrentPhase.model(e).faction===this.faction?b.RegionAssets.fromMyRegion(this):b.RegionAssets.fromEnemyRegion(this)}),this.getMyAssets=(0,n.lazyAdapter)({source:()=>this.state,transform:e=>b.RegionAssets.fromMyRegion(this)}),this.getEnemyAssets=(0,n.lazyAdapter)({source:()=>this.state,transform:e=>b.RegionAssets.fromEnemyRegion(this)})}get name(){return o.Regions.getRegionData(this.state,this.id)?.name||""}get exists(){return!!o.Regions.getRegionData(this.state,this.id)}get hexes(){return this._hexes()}get fortification(){return u.Warfare.getRegionFortification(this.state,this.id)}getNeighbours(){let e=new Set;for(let t of this.getHostileBorderHexes().neighbours()){const i=this.parentModel.byHex(t);i&&e.add(i)}return e.delete(this),Array.from(e)}getMySafeAssets(e,t){return b.RegionAssets.safeAssetsFromMyRegion(this,e,t)}get faction(){const e=r.Factions.getByRegion(this.state,this.id);if(void 0!==e)return r.Factions.model(this.state).byId(e)}get budget(){return c.Economy.getRegionBudget(this.state,this.id)}get treasury(){return c.Economy.getTreasuryOf(this.state,this.id)}isBankrupt(){return this.treasury+this.budget.balance<0}get forecast(){return this.isAlive()?f.inject.views.regionForecast.get(this.state,this.id):0}get size(){return o.Regions.getRegionHexes(this.state,this.id)?.size||0}getUnitsByMight(e=(()=>!0)){return this.faction&&this.faction?.controller!==a.FactionController.None&&this.isAlive()?m.UnitsByMight.fromUnitList(u.Warfare.model(this.state).getUnitsByRegion(this).filter(e).map((e=>e.might)).sort(g.ascendingSortFn)):m.UnitsByMight.empty}getMovableUnitsByMight(){return this.getUnitsByMight((e=>p.CurrentPhase.isMovable(this.state,e.id)))}isAlive(){return c.Economy.isRegionAlive(this.state,this.id)}isActionable(){const e=this.getMovableUnitsByMight().getStrongest(),t=Math.floor(this.treasury/10),i=(0,v.pickLarger)(e,t);if(0===i)return!1;const s=u.Warfare.model(this.state);return this.hexes.find((e=>!s.getOccupyingUnit(e)||!!s.getOccupyingUnit(e)?.hasTrait(w.PawnTraits.Pest)))||s.getConquerableHexes(this,i).length>0}getLevel(){return this.isBankrupt()?1:(0,y.cropNumber)(this.getAssets().getMaxAvailableMight()??1,1,4)}addHexes(e){return this.state=o.Regions.addHexesToRegion(this.state,this.id,e.toIdsArray()),this}removeHexes(e){return this.state=o.Regions.removeHexesFromRegion(this.state,e.toIdsArray()),this}absorbRegions(e){if(e.includes(this))throw new Error(`Invalid absorbRegion arguments - region ${this} cannot absorb itself`);return this.addHexes(s.HexGroup.union(e.map((e=>e.hexes)))),this.parentModel.destroy(...e),this}splitIntoComponents(){return o.Regions.splitRegionIntoComponents(this.state,this.id),this}toString(){return`[Region #${this.id} (${this.hexes.length}⬡)]`}sameRegionNeighboursOf(e){return o.Regions.getSameRegionNeighbours(this.state,e)}isControllable(){return this.faction?.id===p.CurrentPhase.getFaction(this.state)&&this.getTownHexes().length>0}}t.RegionModel=S},50264:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RegionMutations=t.Regions=void 0;const n=i(47610),a=s(i(35369)),o=i(14344),r=i(98030),c=i(22467),l=i(12678),d=i(66206),h=i(88865),u=i(24794),p=i(81439);class g{static model(e){return this.models.get(e)}static getAll(e){return(0,r.selectFromState)(e,n.GameState.regions.byId).keySeq().toArray()}static getByHex(e,t){return(0,r.selectFromState)(e,n.GameState.regions.byHex,t)}static getRegionData(e,t){return(0,r.selectFromState)(e,n.GameState.regions.byId,t)}static getRegionHexes(e,t){return(0,r.selectFromState)(e,n.GameState.regions.hexes,t)||r.EMPTY_SET}static getRegionEdgeHexes(e,t){return(0,r.selectFromState)(e,n.GameState.regions.edgeHexes,t)||r.EMPTY_SET}static getRegionBorderHexes(e,t){return(0,r.selectFromState)(e,n.GameState.warfare.borderHexes,t)||r.EMPTY_SET}static destroyRegions(e,...t){if(0===t.length)return e;const i=a.default.Set.union(t.map((t=>g.getRegionHexes(e,t)))).toArray();return e=o.Factions.disownRegions(e,...t),e=(0,r.applyMutations)(e,n.GameState.regions.byHex.createMutation({delete:i},"destroyRegions"),n.GameState.regions.byId.createMutation({delete:t},"destroyRegions"),n.GameState.ai.attritionByRegion.createMutation({delete:t},"destroyRegions"))}static destroyAllEmptyRegions(e){const t=g.getAll(e).filter((t=>g.getRegionHexes(e,t).isEmpty()));return this.destroyRegions(e,...t)}static getSameRegionNeighbours(e,t){const i=this.getByHex(e,t.id);return t.neighbours((t=>this.getByHex(e,t.id)===i))}static getAdjacentForeignHexes(e,t){return this.model(e).byId(t).getHostileBorderHexes().neighbours().filter((i=>{const s=this.getByHex(e,i.id);return void 0!==s&&s!==t}))}static getNextId(e){return(0,r.selectFromState)(e,n.GameState.regions.nextId)}static createRegion(e,t,i){const s=g.getNextId(e),n=[m.createRegion(s,t)];return i&&n.push(m.addHexesToRegion(s,i)),(0,r.applyMutations)(e,...n)}static addHexesToRegion(e,t,i){const s=[m.addHexesToRegion(t,i)];return(0,r.applyMutations)(e,...s)}static removeHexesFromRegion(e,t){return(0,r.applyMutations)(e,n.GameState.regions.byHex.createMutation({delete:t},"removeHexesFromRegion"))}static isPotentialChokePoint(e,t){const i=(0,u.getHex)(t),s=this.getByHex(e,t);return i.disjointedNeighbourGroups((t=>this.getByHex(e,t.id)===s)).getGroups().length>1}static splitRegionIntoComponents(e,t){const i=this.model(e).byId(t),s=o.Factions.getByRegion(e,t);l.assert.defined(i,`no region found for id ${t}`);const a=i.hexes.components(),c=a.getLargestGroupKey();if(!c)return;a.removeGroup(c);const u=new d.MapMutationBuilder(n.GameState.regions.byId).init(e),p=new d.MapMutationBuilder(n.GameState.regions.byHex).init(e),m=new d.MapMutationBuilder(n.GameState.factions.byRegion).init(e);let y=g.getNextId(e);return a.forEach((e=>{u.set(y,{id:y,name:h.inject.random.townName()}),p.setAll(Array.from(e).map((e=>e.id)),y),void 0!==s&&m.set(y,s),y++})),(0,r.applyMutations)(e,p.createMutation("regions.splitRegionIntoComponents"),u.createMutation("regions.splitRegionIntoComponents"),m.createMutation("regions.splitRegionIntoComponents"))}}t.Regions=g,g.models=new p.ModelsCache((e=>new c.RegionsDataSetModel(e)));class m{static createRegion(e,t){return n.GameState.regions.byId.createMutation({set:{[e]:{id:e,name:t}}},"createRegion")}static addHexesToRegion(e,t){const i={};return t.forEach((t=>{i[t]=e})),n.GameState.regions.byHex.createMutation({set:i},"addHexesToRegion")}}t.RegionMutations=m},22467:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionsDataSetModel=void 0;const s=i(98030),n=i(84587),a=i(47610),o=i(85656),r=i(78179),c=i(50264),l=i(27379);class d extends l.BaseModel{constructor(){super(...arguments),this.regionModels={}}all(){return(0,s.selectFromState)(this.state,a.GameState.regions.byId).keySeq().toArray().map((e=>this.byId(e)))}allRegionsHexes(){return r.HexGroup.union(this.all().map((e=>e.hexes)))}byHex(e){let t="number"==typeof e?e:e.id;const i=c.Regions.getByHex(this.state,t);return i?this.byId(i):void 0}byId(e){if(c.Regions.getRegionData(this.state,e))return(0,o.getOrCreate)(this.regionModels,e,(()=>new n.RegionModel(this,e)))}nextId(){return(0,s.selectFromState)(this.state,a.GameState.regions.nextId)}create(e,t=r.HexGroup.empty){const i=this.nextId();return this.state=c.Regions.createRegion(this.state,e,t.toIdsArray()),this.byId(i)}destroy(...e){this.state=c.Regions.destroyRegions(this.state,...e.map((e=>e.id)))}clear(){this.destroy(...this.all())}}t.RegionsDataSetModel=d},52048:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rules=void 0;const s=i(47610),n=i(65829),a=i(20666),o=i(97884),r=i(98030),c=i(62977);class l{static get(e){return(0,r.selectFromState)(e,s.GameState.ruleSet)}static model(e){const t=this.get(e);return this.modelFactory.getOrCreateFor(t)}static getEconomyRules(e){return l.get(e).economy}static getPawnRules(e,t){return(0,r.selectFromState)(e,s.GameState.ruleSet).pawns[t]}static getPawnCost(e,t){return this.getPawnRules(e,t).cost||0}static getMergeResult(e,t,i){const s=c.Pawns.model(e).select({hexes:t,traits:[a.PawnTraits.OccupiesTile]})[0];if(!s)return i;const n=this.model(e).pawns(s.type).mergeRules;return n&&n[i]}}t.Rules=l,l.modelFactory=new o.FactoryWithCache((e=>new n.RulesModel(e)))},65829:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RulesModel=t.PawnTypeRulesModel=void 0;const s=i(20666),n=i(30420),a=i(88865);class o{constructor(e,t){this.pawnRules=e,this.type=t}get state(){return this.pawnRules}get cost(){return this.state?.cost??0}get upkeep(){return this.state?.upkeep??0}get loot(){return this.state?.loot??0}get might(){return this.state?.might??0}get defenseMight(){return this.state?.defenseMight??this.state?.might??0}get traits(){return this.state?.traits??[]}get mergeRules(){return this.state?.merge??{}}isInvincible(){return this.might>=10}hasTrait(e){return this.traits.includes(e)}toString(){return`[PawnType ${this.type}]`}}t.PawnTypeRulesModel=o,t.RulesModel=class{constructor(e){this.rules=e,this.pawnModels={},this.unitsByMight={},this.castlesByMight={},this.getAllPawnTypes().forEach((e=>{e.hasTrait(s.PawnTraits.Unit)&&e.might&&(this.unitsByMight[e.might]=e),e.hasTrait(s.PawnTraits.Building)&&e.cost&&e.might&&(this.castlesByMight[e.might]=e)}))}get economy(){return this.state.economy}get state(){return this.rules}pawns(e){let t=this.pawnModels[e];return t||(t=new o(this.state.pawns[e],e),this.pawnModels[e]=t),t}unitByMight(e){return this.unitsByMight[e]}castleByMight(e){return this.castlesByMight[e]}getAllPawnTypes(){return Object.keys(this.state.pawns).map((e=>this.pawns(e)))}getPawnTypesByTrait(e){this.getAllPawnTypes().filter((t=>t.hasTrait(e)))}getBanditUnitType(){return a.inject.gameStateModel.plugins.zombies?n.PawnType.Zombie:n.PawnType.Bandit}getBanditCampUnitType(){return a.inject.gameStateModel.plugins.zombies?n.PawnType.HauntedTown:n.PawnType.Camp}}},42297:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Warfare=t.InvalidDropPawnReason=t.DropPawnResultType=void 0;const s=i(20666),n=i(47610),a=i(23441),o=i(98030),r=i(52048),c=i(50264),l=i(62977),d=i(85656),h=i(83184),u=i(24794),p=i(14344),g=i(5032),m=i(81439);var y,f;(f=t.DropPawnResultType||(t.DropPawnResultType={})).Invalid="invalid",f.Reposition="reposition",f.Conquest="conquest",f.Combine="combine",f.EradicatePest="eradicate-pest",f.PlaceOnForeignLand="place-on-foreign-land",(y=t.InvalidDropPawnReason||(t.InvalidDropPawnReason={})).PreventedByPawn="prevented-by-pawn",y.OutOfRange="out-of-range",y.InvalidRegion="invalid-region";class w{static model(e){return this.models.get(e)}static getConquerableHexes(e,t,i){const n=l.Pawns.getByRegion(e,t).filter((t=>l.Pawns.model(e).byId(t)?.hasTrait(s.PawnTraits.Pest))).map((t=>(0,u.getHex)(l.Pawns.getPawnHex(e,t))));return c.Regions.getAdjacentForeignHexes(e,t).filter((t=>this.getHexDefense(e,t)<i)).with(n)}static getHexDefense(e,t){return(0,o.selectFromState)(e,n.GameState.warfare.hexDefense,t.id)||0}static getHexDefenseWithoutMovableUnits(e,t){return this.getHexDefense(e,t)}static getHexStaticDefense(e,t){return(0,o.selectFromState)(e,n.GameState.warfare.hexStaticDefense,t)||0}static getHexDefenseAfterCapturedBy(e,t,i,s=0){return t.neighbours((t=>p.Factions.getByHex(e,t.id)===i)).map((t=>this.getHexProjectedDefense(e,t.id))).reduce(a.pickLarger,s)}static getHexLocalDefense(e,t){return(0,o.selectFromState)(e,n.GameState.warfare.hexDefenseSources,t)?.totalDefense||0}static getHexLocalStaticDefense(e,t){return(0,o.selectFromState)(e,n.GameState.warfare.hexDefenseSources,t)?.buildingDefense||0}static getHexProjectedDefense(e,t){return(0,o.selectFromState)(e,n.GameState.warfare.hexDefenseSources,t)?.totalProtection||0}static getHexProjectedStaticDefense(e,t){const i=(0,o.selectFromState)(e,n.GameState.warfare.hexDefenseSources,t);return i?i.buildingProtection:0}static getHexDefenders(e,t,i=1){const n=l.Pawns.model(e),a=c.Regions.getSameRegionNeighbours(e,t);return[...n.byHex(t),...n.select({hexes:a,traits:[s.PawnTraits.GuardsAdjacentTiles]})].filter((e=>e.might>=i))}static canConquerHexWith(e,t,i){const s="number"==typeof i?i:r.Rules.model(e).pawns(i).might;return void 0!==c.Regions.getByHex(e,t.id)&&this.getHexDefense(e,t)<s}static canBuildCastleAt(e,t,i){const s=g.Economy.getTreasuryOf(e,i)>=20,n=c.Regions.getByHex(e,t.id)===i,a=void 0===w.getOccupyingPawn(e,(0,u.getHex)(t.id));return s&&n&&a}static getRegionFortification(e,t){return(0,o.selectFromState)(e,n.GameState.warfare.fortificationByRegion,t)??0}static getOccupyingPawn(e,t){return l.Pawns.model(e).findOne({hexes:t,traits:[s.PawnTraits.OccupiesTile]})}static getUnitsByRegion(e,...t){return(0,d.mergeArrays)(...t.map((t=>l.Pawns.getByRegion(e,t).filter((t=>w.isUnit(e,t)))||[])))}static getPotentialLoot(e,t,i=!0){return(w.getOccupyingPawn(e,t)?.rules.loot??0)+(i?g.Economy.model(e).numberOfCoinsAt(t):0)}static isUnit(e,t){return l.Pawns.model(e).byId(t)?.hasTrait(s.PawnTraits.Unit)}}t.Warfare=w,w.models=new m.ModelsCache((e=>new h.WarfareModel(e)))},83184:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WarfareModel=void 0;const s=i(27379),n=i(52048),a=i(20666),o=i(50264),r=i(62977),c=i(42297),l=i(78179),d=i(88865);class h extends s.BaseModel{getUnitsByRegion(e){const t=r.Pawns.model(this.state);return c.Warfare.getUnitsByRegion(this.state,e.id).map((e=>t.byId(e)))}getConquerableHexes(e,t){if(0===t)return l.HexGroup.empty;let i;if("number"==typeof t)i=t;else{const e=n.Rules.model(this.state).pawns(t);i=e.hasTrait(a.PawnTraits.Unit)?e.might:0}return d.inject.views.conquerableHexes.get(this.state,{regionId:e.id,unitMight:i})}getHexLocalDefense(e){return c.Warfare.getHexLocalDefense(this.state,e.id)}getHexDefenders(e,t=1){return c.Warfare.getHexDefenders(this.state,e,t)}getHexDefense(e){return c.Warfare.getHexDefense(this.state,e)}getHexDefenseWithoutMovableUnits(e){return c.Warfare.getHexDefenseWithoutMovableUnits(this.state,e)}getHexStaticDefense(e){return c.Warfare.getHexStaticDefense(this.state,e.id)}canConquerHexWith(e,t){return c.Warfare.canConquerHexWith(this.state,e,t)}getMergeResult(e,t){return n.Rules.getMergeResult(this.state,e,t)}isOccupied(e){return!!this.getOccupyingUnit(e)}isImpassable(e){return!o.Regions.getByHex(this.state,e.id)||!!this.getOccupyingUnit(e)?.isInvincible()}getOccupyingUnit(e){return c.Warfare.getOccupyingPawn(this.state,e)}getMightOf(e){return n.Rules.model(this.state).pawns(e).might}getDropPawnResult(e,t,i,s=!1){const r=o.Regions.model(this.state),l=n.Rules.model(this.state),d=r.byHex(e),h=l.pawns(t);if(d?.id===i.id){const i=this.getOccupyingUnit(e);if(!i)return{type:c.DropPawnResultType.Reposition};if(i.hasTrait(a.PawnTraits.Pest))return l.pawns(t).hasTrait(a.PawnTraits.Unit)&&i.might<this.getMightOf(t)?{type:c.DropPawnResultType.EradicatePest,pest:i}:l.pawns(t).hasTrait(a.PawnTraits.Unit)&&s?{type:c.DropPawnResultType.Reposition,displacedUnit:i}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:[i]};const n=l.pawns(i.type).mergeRules[t];return n?{type:c.DropPawnResultType.Combine,combineWith:i,combineInto:n}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:[i]}}return void 0===d||d.faction===i.faction?{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.InvalidRegion}:h.hasTrait(a.PawnTraits.Unit)||h.hasTrait(a.PawnTraits.Treasure)?e.neighbours().find((e=>r.byHex(e)===i))?this.canConquerHexWith(e,t)?{type:c.DropPawnResultType.Conquest}:h.hasTrait(a.PawnTraits.Treasure)&&!c.Warfare.getOccupyingPawn(this.state,e)?{type:c.DropPawnResultType.Reposition}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:this.getHexDefenders(e,l.pawns(t).might)}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.OutOfRange}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.InvalidRegion}}getRetreatDestination(e,t){const i=e.region;return i.hexes.neighboursOf(e.hex).filter((e=>!this.isOccupied(e))).findMax((e=>100*this.getHexStaticDefense(e)+i.hexes.neighboursOf(e).length))}}t.WarfareModel=h},22968:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PluginsModel=void 0;const s=i(80692),n=i(88865);t.PluginsModel=class{constructor(e){this.plugins=e}has(e){return this.plugins.find((t=>t===e))}get zombies(){return n.inject.config.flags.zombiesEverywhere||this.has(s.PluginKey.Zombies)}getCustomTheme(){if(this.zombies)return"muted"}}},80682:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMap=void 0;const s=i(24794),n=i(98030),a=i(47610),o=i(97884),r=i(97245);class c{static get(e){return(0,n.selectFromState)(e,a.GameState.map)}static getAllHexes(e){return s.HexGrid.getAllHexes(this.get(e))}static update(e,t){const i=this.get(e);return(0,n.applyMutations)(e,a.GameState.map.createMutation({...i,...t},"update"))}static model(e){const t=this.get(e);return this.modelFactory.getOrCreateFor(t)}}t.WorldMap=c,c.modelFactory=new o.FactoryWithCache((e=>new r.WorldMapModel(e)))},97245:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapModel=void 0;const s=i(24794),n=i(22968),a=i(88865),o=i(70448);t.WorldMapModel=class{constructor(e){this.state=e,this.innerWidth=this.state.width-2,this.innerHeight=this.state.height-2,this.width=this.state.width,this.height=this.state.height,this.plugins=new n.PluginsModel(this.state.plugins)}get levelId(){return this.state.levelId}get themeKey(){return this.plugins.getCustomTheme()??a.inject.userData.recallChoice("preferredTheme")??"default"}get theme(){return o.THEMES[this.themeKey]??o.THEMES.default}getAllHexes(){return s.HexGrid.getAllHexes(this.state)}getInnerHexes(){return s.HexGrid.getInnerHexes(this.state)}filter(e){return s.HexGrid.filter(e,this.state)}isWithinBounds(e){return s.HexGrid.isWithinBounds(e,this.state)}}},18837:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AiNoKnightsPlugin=void 0,t.AiNoKnightsPlugin=class{getMaxUnitStrengthAllowedForAI(){return 2}}},80692:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.loadPlugin=t.PluginKey=void 0;const s=i(34519),n=i(18837);var a;!function(e){e.Zombies="zombies",e.AiNoKnights="ai-no-knights"}(a=t.PluginKey||(t.PluginKey={})),t.loadPlugin=function(e){switch(e){case a.Zombies:return new s.ZombiesPlugin;case a.AiNoKnights:return new n.AiNoKnightsPlugin}}},66202:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.spawnPresents=void 0;const s=i(88865),n=i(78179),a=i(30420),o=i(40108),r=i(58592),c=i(81363);t.spawnPresents=function(e,t){const i=e.factions.all().filter((e=>!e.isNeutral()&&function(e){const t=s.inject.views.behaviorSummary.get(e.state,e.id).mightUsedForConquest;return console.log("FOR"+e,t),0===Object.keys(t).length}(e))),l=e.factions.neutral.hexes.filter((t=>o.AI.getHexDepth(e.state,t.id)>1&&!e.warfare.isOccupied(t))),d=n.HexGroup.union([l,...i.map((t=>t.hexes.filter((t=>!e.warfare.isOccupied(t)))))]),h=s.inject.random.hex(d);h&&(t.create({hex:h,type:a.PawnType.Present,captureHex:!1,tapUnit:!1}),r.app.audio.playEffect(c.SoundEffects.TwinkleChimes))}},34519:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ZombiesPlugin=void 0,t.ZombiesPlugin=class{}},78329:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getDangerousZombies=t.executeZombiesAct=void 0;const s=i(21999),n=i(30420),a=i(91025),o=i(48500),r=i(9113),c=i(33174),l=i(20666),d=i(78179),h=i(42297);o.logger.for("bandits"),t.executeZombiesAct=function(e){e.state;const t=e.pawns.select({type:[n.PawnType.Zombie]}),i=new Set(t),o=new c.WorldUpdateBuilder(e),d=e.factions.byId(s.SpecialFaction.neutral).getRegions().map((e=>e.getPawns().filter((e=>e.type===n.PawnType.HauntedTown)))).flat().map((e=>e.hex));return(0,r.moveZombies)(e,i,o),d.forEach((t=>{const i=(0,r.pickHexToEnter)(e,t);if(i){const s=e.warfare.getOccupyingUnit(i);s?.hasTrait(l.PawnTraits.Unit)?o.create({hex:i,sourceHex:t,type:n.PawnType.Zombie,defeatedUnit:{pawnId:s?.id},captureHex:!1,tapUnit:!1}):s?.type===n.PawnType.Town?(o.create({hex:i,sourceHex:t,type:n.PawnType.HauntedTown,defeatedUnit:{pawnId:s.id},captureHex:!1,tapUnit:!1}),o.takeOverHex(i,e.factions.neutral)):o.create({hex:i,sourceHex:t,type:n.PawnType.Zombie,captureHex:!1,tapUnit:!1})}})),[a.GameStateEvents.BanditsActed({pillagedHexes:[],coinTransactions:{baseIncome:{},buyUnits:{},pillage:{}},worldUpdates:o.getUpdates()})]},t.getDangerousZombies=function(e){const t=[];for(let i of e.getTownHexes())for(let s of e.sameRegionNeighboursOf(i))h.Warfare.getOccupyingPawn(e.state,s)?.hasTrait(l.PawnTraits.Pest)&&t.push(s);return d.HexGroup.from(t)}},9113:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pickHexToEnter=t.moveZombies=void 0;const s=i(50264),n=i(20666),a=i(48500),o=i(78179),r=i(30420),c=i(55668),l=i(14711);function d(e,t,i=new Set){const s=t.neighbours().map((s=>({hex:s,score:h(e,t,s,i)}))),n=s.reduce(((e,t)=>t.score>e?t.score:e),0);if(0!==n)return(0,l.deterministicRandomHexFrom)(e,o.HexGroup.from(s.filter((e=>e.score===n)).map((e=>e.hex))))}function h(e,t,i,a=new Set){if(!function(e,t,i,a=new Set){if(!s.Regions.getByHex(e.state,i.id))return!1;const o=e.warfare.getOccupyingUnit(i);return(!o||!u(e,t,i))&&(!o||o.hasTrait(n.PawnTraits.Unit)||o.type===r.PawnType.Town||a.has(o))}(e,t,i,a))return 0;const o=function(e,t,i){const s=e.warfare.getOccupyingUnit(i),a=i.neighbours((t=>e.warfare.getOccupyingUnit(t)?.type===r.PawnType.Zombie)).length;return s?.type===r.PawnType.Town?10:s?.hasTrait(n.PawnTraits.Unit)?9-a:1/c.Bandits.getNearestLootDistance(e.state,i.id)}(e,0,i),l=e.warfare.getOccupyingUnit(i),d=c.Bandits.getNearestLootDistance(e.state,t.id),h=c.Bandits.getNearestLootDistance(e.state,i.id);return!l&&h>d?o/100:u(e,t,i)?o/1e4:o}function u(e,t,i){const s=e.warfare.getHexStaticDefense(i)>0,n=e.regions.byHex(t)!==e.regions.byHex(i),a=!(e.warfare.getOccupyingUnit(t)?.type===r.PawnType.Camp)&&e.warfare.getHexStaticDefense(t)>0;return a!==s||(a||s)&&n}a.logger.for("bandits"),t.moveZombies=function(e,t,i){for(;t.size;)s(t[Symbol.iterator]().next().value);function s(a){if(t.delete(a),!a.exists)return;const o=d(e,a.hex,t);if(o){const c=function(i){const s=e.pawns.findOne({hexes:i,traits:[n.PawnTraits.OccupiesTile]});return s&&t.has(s)?s:void 0}(o);if(c)s(c),s(a);else{const t=e.warfare.getOccupyingUnit(o),s=a.hex;t?.hasTrait(n.PawnTraits.Unit)?(i.move({pawnId:a.id,destHex:o,mergeData:{mergedWith:t.id,outputType:r.PawnType.Zombie},captureHex:!1,tapUnit:!1}),i.create({type:r.PawnType.Zombie,hex:s,captureHex:!1,sourceHex:s,tapUnit:!1})):t?.type===r.PawnType.Town?(i.move({pawnId:a.id,destHex:o,mergeData:{mergedWith:t.id,outputType:r.PawnType.HauntedTown},captureHex:!1,tapUnit:!1}),i.takeOverHex(o,e.factions.neutral)):i.move({pawnId:a.id,destHex:o,captureHex:!1,tapUnit:!1})}}}},t.pickHexToEnter=d},60536:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.zombifyLevel=void 0;const s=i(30420);t.zombifyLevel=function(e){return{...e,pawns:e.pawns?.map((e=>e.type===s.PawnType.Bandit?{...e,type:s.PawnType.Zombie}:e.type===s.PawnType.Camp?{...e,type:s.PawnType.HauntedTown}:e))}}},29791:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fortification=void 0;const s=i(42297),n=i(50264),a=i(24794),o=i(23441);t.Fortification={get:(e,t)=>s.Warfare.getHexStaticDefense(e,t)/2,getDeltaAfterConquest(e,t,i){const r=(0,a.getHex)(t).neighbours((t=>n.Regions.getByHex(e,t.id)===i));let c=0;for(let t of r){const i=s.Warfare.getHexProjectedStaticDefense(e,t.id);c=(0,o.pickLarger)(c,i)}return c},getDeltaAfterCastleBuilt(e,i){const s=n.Regions.getByHex(e,i),o=(0,a.getHex)(i),r=o.with(o.neighbours((t=>n.Regions.getByHex(e,t.id)===s)));let c=0;for(let i of r)c+=1-t.Fortification.get(e,i.id);return c}}},28778:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FortificationUpdater=t.FortificationByRegion=void 0;const n=i(66206),a=i(17281),o=i(50264),r=s(i(35369)),c=i(29791);class l extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new d(this),this.update=this.updater.update.bind(this)}bootstrap(e){return r.default.Map().withMutations((t=>{for(let i of o.Regions.getAll(e)){let s=0;for(let t of o.Regions.getRegionHexes(e,i))s+=c.Fortification.get(e,t);t.set(i,s)}}))}entryToString(e){return e}entryToDebugString(e){return e.toString()}}t.FortificationByRegion=l;class d extends a.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}initialize(){super.initialize(),this.dirtyHexes=new Set}registerHandlers(e){e(this.dataSet.sources.hexStaticDefense,this._handleHexStaticDefenseChange.bind(this)),e(this.dataSet.sources.regionByHex,this._handleRegionByHexChange.bind(this))}_handleHexStaticDefenseChange(e){for(let[t]of e.updated)this.dirtyHexes.add(t)}_handleRegionByHexChange(e){for(let[t]of e.updated)this.dirtyHexes.add(t)}createMutation(){for(let e of this.dirtyHexes){const t=c.Fortification.get(this.oldState,e),i=c.Fortification.get(this.newState,e),s=this.dataSet.sources.regionByHex.getEntryById(this.oldState,e),n=this.dataSet.sources.regionByHex.getEntryById(this.newState,e);t===i&&s===n||(s&&this.builder.set(s,(this.builder.getCurrent(s)??0)-t),n&&this.builder.set(n,(this.builder.getCurrent(n)??0)+i))}return super.createMutation()}}t.FortificationUpdater=d},50720:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexDefenseUpdater=t.HexDefenseProjection=void 0;const n=i(66206),a=s(i(35369)),o=i(24794),r=i(98030),c=i(62977),l=i(23441),d=i(17281),h=i(50264),u=i(42297);i(48500).logger.for("HexDefense");class p extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new g(this).update}bootstrap(e){return a.default.Map().withMutations((t=>{(0,o.getHexes)((0,r.selectFromState)(e,this.sources.regionByHex).keySeq().toArray()).map((i=>{const s=this._calculate(e,i);s>0&&t.set(i.id,s)}))}))}_calculate(e,t){const i=u.Warfare.getHexLocalDefense(e,t.id);return h.Regions.getSameRegionNeighbours(e,t).map((t=>u.Warfare.getHexProjectedDefense(e,t.id))).reduce(l.pickLarger,i)}}t.HexDefenseProjection=p;class g extends d.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}initialize(){this.pawns=c.Pawns.model(this.newState),this.dirtyHexes=new Set}registerHandlers(e){e(this.dataSet.sources.hexDefenseSources,(e=>this._handleHexDefenseSourcesChanged(e))),e(this.dataSet.sources.regionByHex,(e=>this._handleRegionByHexChange(e)))}_handleHexDefenseSourcesChanged(e){e.updated?.forEach((([e,t])=>{const i=(0,o.getHex)(e);this.dirtyHexes.add(i);const s=h.Regions.getSameRegionNeighbours(this.oldState,i).with(h.Regions.getSameRegionNeighbours(this.newState,i));for(let e of s)this.dirtyHexes.add(e)}))}_handleRegionByHexChange(e){e.updated?.forEach((([e,t])=>{const i=(0,o.getHex)(e);this.dirtyHexes.add(i),u.Warfare.getHexProjectedDefense(this.oldState,e)>0&&(h.Regions.getSameRegionNeighbours(this.oldState,i).forEach((e=>this.dirtyHexes.add(e))),h.Regions.getSameRegionNeighbours(this.newState,i).forEach((e=>this.dirtyHexes.add(e))))}))}createMutation(){return this.dirtyHexes.forEach((e=>{const t=this.dataSet._calculate(this.newState,e);t>0?this.builder.set(e.id,t):this.builder.delete(e.id)})),super.createMutation()}}t.HexDefenseUpdater=g},65283:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexDefenseSourcesProjection=t.NO_DEFENSE=void 0;const n=i(66206),a=s(i(35369)),o=i(24794),r=i(20666),c=i(98030),l=i(99896),d=i(62977),h=i(23441),u=i(17281),p=i(12678),g=i(41707);t.NO_DEFENSE=Object.freeze({unitDefense:0,buildingDefense:0,unitProtection:0,buildingProtection:0,totalDefense:0,totalProtection:0});class m extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.eager=!1,this.update=new y(this).update}bootstrap(e){return a.default.Map().withMutations((t=>{(0,o.getHexes)((0,c.selectFromState)(e,this.sources.regionByHex).keySeq().toArray()).forEach((i=>{const s=this._calculate(e,i);s.totalDefense>0&&t.set(i.id,s)}))}))}_calculate(e,t){const i=d.Pawns.model(e).byHex(t).filter((t=>!l.CurrentPhase.isMovable(e,t.id))),s=i.find((e=>e.hasTrait(r.PawnTraits.Unit))),n=i.find((e=>e.hasTrait(r.PawnTraits.Building))),a=i.find((e=>e.hasTrait(r.PawnTraits.OccupiesTile))),o=s?.defenseMight||0,c=s?.protection||0,u=n?.defenseMight||0,p=n?.protection||0;return{unitDefense:o,unitProtection:c,buildingDefense:u,buildingProtection:p,totalDefense:Math.max(o,u,a?.defenseMight||0),totalProtection:(0,h.pickLarger)(c,p)}}entryToString(e){return`${e.totalDefense}${e.buildingDefense>0?g.GLYPH.whiteFlag:""}`}}t.HexDefenseSourcesProjection=m;class y extends u.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}initialize(){this.pawns=d.Pawns.model(this.newState),this.dirtyHexes=new Set}registerHandlers(e){e(this.dataSet.sources.pawnsByHex,(e=>this._handlePawnsByHexChange(e))),e(this.dataSet.sources.movableUnits,(e=>this._handleMovableUnitsChange(e)))}createMutation(){return this.dirtyHexes.forEach((e=>{const t=this.dataSet._calculate(this.newState,e);t.unitDefense||t.buildingDefense?this.builder.set(e.id,t):this.builder.delete(e.id)})),super.createMutation()}invalidate(e){p.assert.defined(e,"attempted to add undefined into dirtyHexes"),this.dirtyHexes.add(e)}_handlePawnsByHexChange(e){e.updated?.forEach((e=>{e.removed?this.invalidate((0,o.getHex)(e.id)):e.added&&this._addDefenders(e.added)}))}_handleMovableUnitsChange(e){e.addedEntries?.forEach((e=>{const t=this.pawns.byId(e)?.hex;this.invalidate(t)})),e.deletedEntries&&this._addDefenders(e.deletedEntries)}_addDefenders(e){e.forEach((e=>{const t=this.pawns.byId(e);if(!t||l.CurrentPhase.isMovable(this.newState,e))return;const i=this.pawns.byId(e)?.hex;if(!i)return;const s=this.builder.getCurrent(i.id);let n=s?.unitDefense||0,a=s?.unitProtection||0,o=s?.buildingDefense||0,c=s?.buildingProtection||0;const d=t.hasTrait(r.PawnTraits.OccupiesTile)?t.defenseMight:0;t.hasTrait(r.PawnTraits.Unit)&&(n=t.defenseMight,a=t.protection),t.hasTrait(r.PawnTraits.Building)&&(o=t.defenseMight,c=t.protection),this.builder.set(i.id,{unitDefense:n,unitProtection:a,buildingDefense:o,buildingProtection:c,totalDefense:Math.max(n,o,d),totalProtection:(0,h.pickLarger)(a,c)})}))}}},59716:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexStaticDefenseProjection=void 0;const n=i(66206),a=s(i(35369)),o=i(24794),r=i(98030),c=i(23441),l=i(50264),d=i(42297),h=i(50720);class u extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new h.HexDefenseUpdater(this).update}bootstrap(e){return a.default.Map().withMutations((t=>{(0,o.getHexes)((0,r.selectFromState)(e,this.sources.regionByHex).keySeq().toArray()).map((i=>{const s=this._calculate(e,i);s>0&&t.set(i.id,s)}))}))}_calculate(e,t){const i=d.Warfare.getHexLocalStaticDefense(e,t.id);return l.Regions.getSameRegionNeighbours(e,t).map((t=>d.Warfare.getHexProjectedStaticDefense(e,t.id))).reduce(c.pickLarger,i)}}t.HexStaticDefenseProjection=u},41141:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexesByPawnTypeAndRegionProjection=void 0;const s=i(98993),n=i(62977);class a extends s.FilteredMultiMapProjection{constructor(e,t,i){super(e,i.pawnsByRegion),this.filteredPawnType=t,this.sources=i}constraint(e,t){return n.Pawns.getPawnType(e,t)===this.filteredPawnType}transform(e,t){return n.Pawns.getPawnHex(e,t)}}t.HexesByPawnTypeAndRegionProjection=a},69038:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MovableUnitsProjection=void 0;const n=s(i(35369)),a=i(30420),o=i(63078),r=i(98030);class c extends o.SetDataSet{constructor(e,t){super(e),this.key=e,this.sources=t,this.parents=Object.values(this.sources),this.builder=new o.SetDataSetMutationBuilder(this)}bootstrap(e){const t=(0,r.selectFromState)(e,this.sources.currentPhase);if(t.type!==a.PhaseTypes.FactionTurn)return n.default.Set();const i=(0,r.selectFromState)(e,this.sources.unitsByFaction,t.faction);return i&&0!==i.size?i.filter((t=>!this._isTapped(e,t))):n.default.Set()}update(e,t,i){this.builder.init(e);const s=t.of(this.sources.currentPhase);return s?(this._handleCurrentPhaseChange(e,s,i),this.builder.createMutation("phase changed")):(this._handleTappedUnitsChange(e,t.of(this.sources.currentPhaseTappedUnits),i),this._handleFactionUnitsChange(e,t.of(this.sources.unitsByFaction),i),this.builder.createMutation("units changed"))}_isTapped(e,t){return(0,r.selectFromState)(e,this.sources.currentPhaseTappedUnits).has(t)}_handleFactionUnitsChange(e,t,i){if(!t)return;const s=(0,r.selectFromState)(e,this.sources.currentPhase).faction;void 0!==s&&t.updated?.forEach((t=>{t.id===s&&(t.added&&this.builder.add(...t.added.filter((t=>!this._isTapped(e,t)))),t.removed&&this.builder.delete(...t.removed.filter((t=>!this._isTapped(e,t)))))}))}_handleTappedUnitsChange(e,t,i){t&&(t.addedEntries?.forEach((e=>this.builder.delete(e))),t.deletedEntries?.forEach((e=>{this.builder.add(e)})))}_handleCurrentPhaseChange(e,t,i){if(t.type!==a.PhaseTypes.FactionTurn)this.builder.clear();else{this.builder.clear();const i=(0,r.selectFromState)(e,this.sources.unitsByFaction,t.faction);i&&this.builder.add(...i.toArray())}return this.builder.createMutation("currentPhaseChanged")}}t.MovableUnitsProjection=c},1873:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsByRegionUpdater=t.PawnsByRegionProjection=void 0;const n=i(85656),a=s(i(35369)),o=i(69225),r=i(98030),c=i(17281),l=i(50264);class d extends o.MultiMapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new h(this),this.update=this.updater.update.bind(this)}bootstrap(e){const t=(0,r.selectFromState)(e,this.sources.pawnsByHex),i=[];for(const[s,a]of t){const t=l.Regions.getByHex(e,s);t&&(0,n.pushIntoArrayByKey)(i,t,...a)}return s=i,a.default.Map().withMutations((e=>{for(let[t,i]of Object.entries(s))e.set(Number(t),a.default.Set(i))}));var s}}t.PawnsByRegionProjection=d;class h extends c.BaseUpdater{constructor(){super(...arguments),this.builder=new o.MultiMapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.pawnsHex,this._handlePawnsHexUpdate.bind(this)),e(this.dataSet.sources.regionsByHex,this._handleRegionsByHexUpdate.bind(this))}_handlePawnsHexUpdate(e){e.updated?.forEach((([e,t])=>{const i=(0,r.selectFromState)(this.oldState,this.dataSet.sources.pawnsHex,e),s=void 0!==t&&(0,r.selectFromState)(this.newState,this.dataSet.sources.regionsByHex,t);let n=void 0!==i&&(0,r.selectFromState)(this.oldState,this.dataSet.sources.regionsByHex,i);n!==s&&(n&&this.builder.remove(n,e),s&&this.builder.add(s,e))}))}_handleRegionsByHexUpdate(e){e.updated?.forEach((([e,t])=>{let i=(0,r.selectFromState)(this.oldState,this.dataSet.sources.regionsByHex,e),s=(0,r.selectFromState)(this.newState,this.dataSet.sources.pawnsByHex,e);s&&(i&&this.builder.remove(i,...s.toArray()),t&&this.builder.add(t,...s.toArray()))}))}}t.PawnsByRegionUpdater=h},651:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionBorderHexesProjection=void 0;const s=i(69225),n=i(50264),a=i(98030),o=i(24794),r=i(78179),c=i(62977),l=i(20666);class d extends s.MultiMapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources)}bootstrap(e){return(0,a.selectFromState)(e,this.sources.regionsEdgeHexes).map(((t,i)=>t.filter((t=>h(e,t,i))))).filter((e=>e.size>0))}update(e,t,i){const a=new s.MultiMapMutationBuilder(this,e);return t.of(this.sources.regionsEdgeHexes)?.updated?.forEach((t=>{const i=t.id;if(t.added){const s=(0,o.getHexes)(t.added);(0,o.getHexes)(a.getCurrent(i).toArray()||[]),a.add(i,...t.added.filter((t=>h(e,t,i)))),s.forEach((t=>{t.neighbours((t=>void 0!==n.Regions.getByHex(e,t.id))).forEach((t=>{const s=n.Regions.getByHex(e,t.id);void 0!==s&&s!==i?a.add(s,t.id):h(e,t.id,i)||a.remove(i,t.id)}))}))}if(t.removed){a.remove(i,...t.removed);const s=(0,o.getHexes)(t.removed),c=r.HexGroup.fromIds(n.Regions.getRegionEdgeHexes(e,i).toArray());s.forEach((t=>{c.neighboursOf(t).forEach((t=>{n.Regions.getByHex(e,t.id)===i&&h(e,t.id,i)&&a.add(i,t.id)}))}))}})),a.createMutation("regionBorderChanged")}entryToString(e){return`[${e.size}]`}}function h(e,t,i){return!!(0,o.getHex)(t).findNeighbour((t=>{const s=n.Regions.getByHex(e,t.id);return void 0!==s&&s!==i&&!c.Pawns.model(e).findOne({hexes:t,traits:[l.PawnTraits.Impenetrable]})}))}t.RegionBorderHexesProjection=d},65025:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createBorderHexesDebugLayer=t.RegionEdgeHexesProjection=void 0;const n=s(i(35369)),a=i(24794),o=i(69225),r=i(50264),c=i(47610),l=i(98030),d=i(92065),h=i(50921),u=i(41707);class p extends o.MultiMapDataSet{constructor(e,t){super(e),this.regionsHexes=t,this.parents=[this.regionsHexes]}bootstrap(e){return n.default.Map().withMutations((t=>{r.Regions.model(e).all().forEach((i=>{const s=i.hexes.filter((t=>g(e,t,i.id))).map((e=>e.id));s.length&&t.set(i.id,n.default.Set(s))}))}))}update(e,t,i){const s=new o.MultiMapMutationBuilder(this,e),n=t.require(this.regionsHexes);for(let t of n.updated??[]){const i=t.id;if(t.added){const n=(0,a.getHexes)(t.added);for(let t of n){const n=r.Regions.model(e).byId(i);g(e,t,i)&&s.add(i,t.id),n.hexes.neighboursOf(t).forEach((t=>{g(e,t,i)||s.remove(i,t.id)}))}}t.removed&&(s.remove(i,...t.removed),t.removed.forEach((t=>{const n=r.Regions.model(e).byId(i);n?n.hexes.neighboursOf((0,a.getHex)(t)).forEach((e=>{s.add(i,e.id)})):s.removeEntry(i)})))}return s.createMutation("regionsByHexChanged")}entryToString(e){return`[${e.size}]`}}function g(e,t,i){return!!t.findNeighbour((t=>r.Regions.getByHex(e,t.id)!==i))}t.RegionEdgeHexesProjection=p,t.createBorderHexesDebugLayer=function(){return new d.GameStateDebugLayer((0,h.hexBasedAdapter)({getValue(e,t){const i=r.Regions.getByHex(e,t);if(!i)return;const s=(0,l.selectFromState)(e,c.GameState.warfare.borderHexes,i)?.has(t),n=(0,l.selectFromState)(e,c.GameState.regions.edgeHexes,i)?.has(t);return s?u.GLYPH.redFlag:n?u.GLYPH.whiteFlag:""},getDetail(e,t){const i=r.Regions.getByHex(e,t);if(!i)return;const s=(0,l.selectFromState)(e,c.GameState.warfare.borderHexes,i)?.has(t),n=(0,l.selectFromState)(e,c.GameState.regions.edgeHexes,i)?.has(t);return`\nregion: ${i}\nborder: ${n?"YES":"NO"}\nhostile: ${s?"YES":"NO"}`}}))}},18302:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.UnitsByFactionUpdater=t.UnitsByFactionProjection=void 0;const n=s(i(35369)),a=i(69225),o=i(98030),r=i(17281),c=i(14344),l=i(42297);class d extends a.MultiMapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new h(this).update}bootstrap(e){const t=(0,o.selectFromState)(e,this.sources.factionRegions);return n.default.Map().withMutations((i=>{t.entrySeq().forEach((([t,s])=>{let a=n.default.Set(l.Warfare.getUnitsByRegion(e,...s.toArray()));a.isEmpty()||i.set(t,a)}))}))}}t.UnitsByFactionProjection=d;class h extends r.BaseUpdater{constructor(){super(...arguments),this.builder=new a.MultiMapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.factionRegions,this._handleFactionRegionsUpdate),e(this.dataSet.sources.pawnsByRegion,this._handlePawnsByRegionUpdate)}_handleFactionRegionsUpdate(e){e.updated?.forEach((e=>{e.removed&&this.builder.remove(e.id,...l.Warfare.getUnitsByRegion(this.newState,...e.removed)),e.added&&this.builder.add(e.id,...l.Warfare.getUnitsByRegion(this.newState,...e.added))}))}_handlePawnsByRegionUpdate(e){e.updated?.forEach((e=>{let t=c.Factions.getByRegion(this.newState,e.id);t&&e.removed&&this.builder.remove(t,...e.removed.filter((e=>l.Warfare.isUnit(this.oldState,e))))})),e.updated?.forEach((e=>{let t=c.Factions.getByRegion(this.newState,e.id);t&&e.added&&this.builder.add(t,...e.added.filter((e=>l.Warfare.isUnit(this.newState,e))))}))}}t.UnitsByFactionUpdater=h},71406:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.AssetsValueByRegionUpdater=t.AssetsValueByRegionProjection=void 0;const o=i(66206),r=a(i(35369)),c=i(54444),l=i(50264),d=i(17281),h=i(48500),u=i(65955),p=i(96486);h.logger.for("AssetsValueByRegionProjection");class g extends o.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new m(this).update}bootstrap(e){const t=l.Regions.model(e);return r.Map().withMutations((e=>{t.all().forEach((t=>{const i=this.calculate(t);i!==u.NO_ASSET_VALUE&&e.set(t.id,i)}))}))}calculate(e){return u.AssetValue.sum(...e.hexes.members.map((t=>this.sources.hexAssetValue.getEntryById(e.state,t.id)??u.NO_ASSET_VALUE)))}entryToString(e){return(0,u.assetValueToDebugStr)(e)}entryToDebugString(e){return(0,c.prettyPrintObject)({...e})}}t.AssetsValueByRegionProjection=g;class m extends d.BaseUpdater{constructor(){super(...arguments),this.builder=new o.MapMutationBuilder(this.dataSet)}initialize(){this.invalidated=new Set}registerHandlers(e){e(this.dataSet.sources.hexAssetValue,this.handleHexAssetValueChange.bind(this)),e(this.dataSet.sources.regionHexes,this.handleRegionHexesChange.bind(this))}handleHexAssetValueChange(e){e.updated?.forEach((([e,t])=>{t||(t=u.NO_ASSET_VALUE);const i=l.Regions.getByHex(this.newState,e);if(l.Regions.getByHex(this.oldState,e)!==i)return;const s=this.dataSet.sources.hexAssetValue.getEntryById(this.oldState,e)??u.NO_ASSET_VALUE;if(!(0,p.isEqual)(s,t)){const e=this.builder.getCurrent(i)??u.NO_ASSET_VALUE;this.builder.set(i,{economic:e.economic-s.economic+t.economic,defensive:e.defensive-s.defensive+t.defensive,offensive:e.offensive-s.offensive+t.offensive})}}))}handleRegionHexesChange(e){e.updated?.forEach((e=>{for(let t of e.added??[]){const i=this.dataSet.sources.hexAssetValue.getEntryById(this.newState,t)??u.NO_ASSET_VALUE;this.builder.set(e.id,u.AssetValue.sum(this.builder.getCurrent(e.id)??u.NO_ASSET_VALUE,i))}for(let t of e.removed??[]){const i=this.dataSet.sources.hexAssetValue.getEntryById(this.oldState,t)??u.NO_ASSET_VALUE;this.builder.set(e.id,u.AssetValue.subtract(this.builder.getCurrent(e.id)??u.NO_ASSET_VALUE,i))}}))}}t.AssetsValueByRegionUpdater=m},36473:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createCapitalTownDebugLayer=t.CapitalTownUpdater=t.CapitalTownProjection=void 0;const n=i(66206),a=s(i(35369)),o=i(48500),r=i(50264),c=i(98030),l=i(17281),d=i(92065),h=i(50921),u=i(47610),p=i(41707);o.logger.for("CapitalTownProjection");class g extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new m(this).update}bootstrap(e){const t=new m(this);return t.initFromState(e),r.Regions.getAll(e).filter((t=>r.Regions.model(e).byId(t).isAlive())).forEach((e=>t.invalidateRegion(e))),t.getMap()}entryToString(e){return e.townHexId.toString()}entryToDebugString(e){return e.townHexId.toString()}}t.CapitalTownProjection=g;class m extends l.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedRegions=new Set,this}registerHandlers(e){e(this.dataSet.sources.townsByRegion,this.handleTownsByRegionChange),e(this.dataSet.sources.regionInfluenceByHex,this.handleHexInfluenceChange)}handleTownsByRegionChange(e){e.updated?.forEach((e=>{this.invalidateRegion(e.id)}))}handleHexInfluenceChange(e){e.updated?.forEach((([e])=>{const t=r.Regions.getByHex(this.newState,e);t&&this.invalidateRegion(t)}))}createMutation(){return this.updateInvalidated(),super.createMutation()}invalidateRegion(e){const t=r.Regions.model(this.newState).byId(e);t&&!this.invalidatedRegions.has(t.id)&&(t.isAlive()?this.invalidatedRegions.add(e):t.hexes.forEach((e=>this.builder.delete(e.id))))}updateInvalidated(){for(let e of this.invalidatedRegions)this.updateForRegion(e)}updateForRegion(e){const t=r.Regions.model(this.newState).byId(e);if(!t)return;const i=this.dataSet.sources.townsByRegion.getEntryById(this.newState,e)??[];let s,n=0;for(let e of i){const i=this.dataSet.sources.regionInfluenceByHex.getEntryById(this.newState,e)||a.default.Map();let o=Number.POSITIVE_INFINITY;for(let[e,s]of i.entries()){const i=r.Regions.model(this.newState).byId(e);i?.isAlive()&&i?.faction!==t.faction&&s.resistance<o&&(o=s.resistance)}(void 0===s||o>n)&&(s=e,n=o)}void 0!==s&&this.builder.get(e)?.townHexId!==s&&this.builder.set(e,{townHexId:s})}getMap(){return this.updateInvalidated(),a.default.Map(this.builder.getEntries()).mapKeys((e=>Number(e)))}}t.CapitalTownUpdater=m,t.createCapitalTownDebugLayer=function(){return new d.GameStateDebugLayer((0,h.hexBasedAdapter)({getValue(e,t){const i=r.Regions.getByHex(e,t);if(i)return(0,c.selectFromState)(e,u.GameState.ai.capitalTown,i)?.townHexId===t?p.GLYPH.redFlag:void 0},getDetail(e,t){}}))}},56691:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexAssetValueUpdater=t.HexAssetValueProjection=void 0;const n=i(66206),a=s(i(35369)),o=i(17281),r=i(50264),c=i(65955),l=i(24794),d=i(54444),h=i(5032),u=i(62977),p=i(78179);class g extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new m(this).update}bootstrap(e){return a.default.Map().withMutations((t=>{const i=r.Regions.model(e).all();for(let s of i){const i=s.isBankrupt();for(let n of s.hexes)t.set(n.id,c.AssetValue.getFactors(e,n,!1,i))}}))}entryToString(e){return e.defensive+e.offensive+e.economic}entryToDebugString(e){return(0,d.prettyPrintObject)(e)}}t.HexAssetValueProjection=g;class m extends o.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet),this.hexesToUpdate=new Set}initialize(){this.hexesToUpdate.clear()}registerHandlers(e){e(this.dataSet.sources.pawnsByHex,this.handlePawnsByHexChanged),e(this.dataSet.sources.coinsByHex,this.handleCoinsByHexChanged),e(this.dataSet.sources.regionsByHex,this.handleHexRegionChanged),e(this.dataSet.sources.treasuryByRegion,this.handleRegionBudgetChanged),e(this.dataSet.sources.budgetByRegion,this.handleRegionBudgetChanged),e(this.dataSet.sources.movableUnits,this.handleMovableUnitsChanged)}handleMovableUnitsChanged(e){for(let t of e.addedEntries??[]){const e=u.Pawns.getPawnHex(this.newState,t);this.hexesToUpdate.add(e)}for(let t of e.deletedEntries??[]){const e=u.Pawns.getPawnHex(this.oldState,t);this.hexesToUpdate.add(e)}}handleRegionBudgetChanged(e){for(let[t]of e.updated??[]){const e=p.HexGroup.fromIds(u.Pawns.getByRegion(this.newState,t).map((e=>u.Pawns.getPawnHex(this.newState,e))));for(let t of e)this.hexesToUpdate.add(t.id)}}handlePawnsByHexChanged(e){e.updated?.forEach((e=>{this.hexesToUpdate.add(e.id)}))}handleCoinsByHexChanged(e){e.updated?.forEach((([e,t])=>{this.hexesToUpdate.add(e)}))}handleHexRegionChanged(e){e.updated?.forEach((([e,t])=>{this.hexesToUpdate.add(e)}))}createMutation(){for(let e of this.hexesToUpdate){const t=r.Regions.getByHex(this.newState,e),i=h.Economy.getTreasuryOf(this.newState,t)+h.Economy.getRegionBudget(this.newState,t).balance<0;this.builder.set(e,c.AssetValue.getFactors(this.newState,(0,l.getHex)(e),!1,i))}return super.createMutation()}}t.HexAssetValueUpdater=m},66091:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexDepthUpdater=t.HexDepthProjection=void 0;const n=i(66206),a=s(i(35369)),o=s(i(54485)),r=i(50264),c=i(98030),l=i(17281),d=i(24794);class h extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new u(this).update.bind(this)}bootstrap(e){return a.default.Map().withMutations((t=>{(0,c.selectFromState)(e,this.sources.regionHexes).forEach(((i,s)=>{const n=r.Regions.model(e).byId(s);n.getHostileBorderHexes().length?n.hexes.bfsFrom(n.getHostileBorderHexes(),((e,i,s)=>(t.set(e.id,s+1),!0))):n.hexes.forEach((e=>t.set(e.id,1/0)))}))}))}}t.HexDepthProjection=h;class u extends l.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.borderHexes,this.handleHostileBorderHexesChanged.bind(this)),e(this.dataSet.sources.regionHexes,this.handleRegionHexesChanged.bind(this))}handleHostileBorderHexesChanged(e){e.updated?.forEach((e=>{const t=e.id,i=r.Regions.model(this.newState).byId(e.id);if(e.removed){const t=(0,d.getHexes)(e.removed),s=t.filter((e=>r.Regions.getByHex(this.newState,e.id)===i.id));this.updateDueToNewlyInternalHexes(i,s);const n=t.without(s);this.updateAfterHexesLost(i,n)}e.added&&r.Regions.getRegionBorderHexes(this.oldState,t).isEmpty()&&i.hexes.bfsFrom(i.getBorderHexes(),((e,t,i)=>(this.builder.set(e.id,i+1),!0)))}))}handleRegionHexesChanged(e){return e.updated?.forEach((e=>{const t=r.Regions.model(this.newState).byId(e.id);e.added,e.removed&&this.updateAfterHexesLost(t,(0,d.getHexes)(e.removed))})),this.builder.createMutation("regionHexes changed")}updateDueToNewlyInternalHexes(e,t){let i=new Set(t),s=new o.default(((e,t)=>e.candidateDepth-t.candidateDepth)),n=[...t.members];const a=r.Regions.getRegionBorderHexes(this.newState,e.id);for(;n.length;){let t=n.shift();for(let o of e.hexes.neighboursOf(t))if(!i.has(o))if(a.has(o.id))s.push({hex:t,candidateDepth:2});else{const a=this.dataSet.getEntryById(this.newState,o.id);this.hexCanJustifyDepth(this.newState,e,o,a,i)?s.push({hex:t,candidateDepth:a+1}):(n.push(o),i.add(o))}}for(i.forEach((e=>this.builder.delete(e.id)));!s.empty()&&i.size;){let t=s.pop();if(i.has(t.hex)){i.delete(t.hex),this.builder.set(t.hex.id,t.candidateDepth);for(let n of e.hexes.neighboursOf(t.hex))i.has(n)&&s.push({hex:n,candidateDepth:t.candidateDepth+1})}}i.forEach((e=>this.builder.set(e.id,1/0)))}updateAfterHexesLost(e,t){e.hexes.bfsFrom(t,((e,t,i)=>!t||(this.dataSet.getEntryById(this.newState,e.id)||1/0)>i&&(this.builder.set(e.id,i),!0)))}isForeignRegion(e,t,i){const s=r.Regions.getByHex(e,t);return void 0!==s&&s!==i}hexCanJustifyDepth(e,t,i,s,n){return 1===s?!!i.findNeighbour((i=>!n.has(i)&&this.isForeignRegion(e,i.id,t.id))):!!t.hexes.neighboursOf(i).find((t=>!n.has(t)&&this.dataSet.getEntryById(e,t.id)===s-1))}}t.HexDepthUpdater=u},52880:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexImportanceUpdater=t.HexImportanceProjection=t.TOWN_HEX_BASE_IMPORTANCE=t.NO_IMPORTANCE=void 0;const n=i(66206),a=s(i(35369)),o=s(i(54485)),r=i(54444),c=i(48500),l=i(23441),d=i(30420),h=i(50264),u=i(12678),p=i(17281),g=i(24794),m=i(65955),y=i(42297),f=i(20666),w=i(40108);t.NO_IMPORTANCE=Object.freeze({distanceFromTown:1/0,value:0,factors:{fromConnectedHexes:0,fromTownProximity:0,fromHex:0,multiplier:.5},parents:[],children:[],connectivity:0});const v=c.logger.for("HexImportanceProjection");t.TOWN_HEX_BASE_IMPORTANCE=40;class b extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new S(this).update}bootstrap(e){const t=new S(this);return t.initFromState(e),h.Regions.getAll(e).filter((t=>h.Regions.model(e).byId(t).isAlive())).forEach((e=>t.invalidateRegion(e))),t.getMap()}entryToString(e){return e.value.toFixed(0)}entryToDebugString(e){return(0,r.prettyPrintObject)(e)}}t.HexImportanceProjection=b;class S extends p.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.invalidatedRegions=new Set,this.roots=new Map,this.regionId=-1,this}registerHandlers(e){e(this.dataSet.sources.townsByRegion,this.handleTownsByRegionChange),e(this.dataSet.sources.regionsHexes,this.handleRegionsHexesChange),e(this.dataSet.sources.hexAssetValue,this.handleHexAssetValueChanged),e(this.dataSet.sources.capitalTown,this.handleCapitalTownChange)}handleCapitalTownChange(e){for(let[t]of e.updated??[])this.invalidateRegion(t)}handleTownsByRegionChange(e){e.updated?.forEach((e=>{this.invalidateRegion(e.id)}))}handleRegionsHexesChange(e){e.updated?.forEach((e=>{const t=e.id;e.added?.forEach((e=>{const i=(0,g.getHex)(e);this.invalidateAfterCapturedHex(i,t)})),e.removed?.forEach((e=>{const i=(0,g.getHex)(e);this.invalidateAfterCapturedHex(i,t)}))}))}handleHexAssetValueChanged(e){for(let[t]of e.updated??[])this.onHexImportanceChanged(t)}onHexImportanceChanged(e){const t=h.Regions.getByHex(this.newState,e);t&&!this.invalidatedRegions.has(t)&&(this.setRegion(t),this.region.isAlive()&&this.invalidateHexAndParents((0,g.getHex)(e)))}createMutation(){return this.updateInvalidated(),super.createMutation()}setRegion(e){e!==this.regionId&&(this.regionId=e,this.region=h.Regions.model(this.newState).byId(this.regionId),u.assert.defined(this.region,`no region matched for id ${this.regionId}`))}invalidateAfterCapturedHex(e,t){if(this.setRegion(t),!this.region.isAlive())return;this.invalidateHex(e);let i=this.region.hexes.neighboursOf(e);for(let e of i)this.invalidateHex(e),this.findNewParents(e).parents.forEach((e=>{this.invalidateHexAndParents(e)}));for(let e of i)this.invalidatePotentialChildren(e)}invalidateHex(e){this.invalidatedHexes.has(e)||(this.invalidatedHexes.add(e),w.AI.isCapitalTown(this.newState,e.id)&&this.addRoot(e))}findNewParents(e){u.assert.defined(this.region,`must first set region before calling findParents (called with ${e})`);let t=1/0,i=[];return this.region.hexes.neighboursOf(e).filter((e=>this.builder.has(e.id)||!this.isInvalidated(e))).forEach((e=>{const s=(this.builder.getCurrent(e.id)?.distanceFromTown??1/0)+(7-(this.builder.getCurrent(e.id)?.connectivity??0));s===t?i.push(e):s<t&&(t=s,i=[e])})),{parents:i,distance:t}}addRoot(e){const t=h.Regions.getByHex(this.newState,e.id),i=this.roots.get(t)||new Set;i.add(e),this.roots.set(t,i)}invalidateParents(e){let t=this.dataSet.getEntryById(this.newState,e.id)?.parents||[];0===t.length&&w.AI.isCapitalTown(this.newState,e.id)&&this.addRoot(e),t.filter((e=>!this.isInvalidated(e))).forEach((e=>{this.invalidateHexAndParents(e)}))}invalidatePotentialParents(e){this.region.hexes.neighboursOf(e).filter((e=>!this.isInvalidated(e))).forEach((e=>{this.invalidateHexAndParents(e)}))}invalidateHexAndParents(e){this.invalidatedHexes.has(e)||(this.invalidateHex(e),this.invalidateParents(e))}invalidatePotentialChildren(e){if(this.invalidatedRegions.has(this.regionId))return;const t=this.dataSet.getEntryById(this.newState,e.id)?.distanceFromTown||0;let i=this.region.hexes.neighboursOf(e).filter((e=>this.dataSet.getEntryById(this.newState,e.id)?.distanceFromTown>t));for(let e of i)this.invalidatedHexes.has(e)||(this.invalidateHex(e),this.invalidatePotentialParents(e),this.invalidatePotentialChildren(e))}invalidateRegion(e){const i=h.Regions.model(this.newState).byId(e);if(i&&!this.invalidatedRegions.has(i.id))if(i.isAlive()){this.invalidatedRegions.add(e);const t=this.dataSet.sources.capitalTown.getEntryById(this.newState,e)?.townHexId;void 0!==t&&this.addRoot((0,g.getHex)(t))}else i.hexes.forEach((e=>this.builder.set(e.id,t.NO_IMPORTANCE)))}updateInvalidated(){for(let[e,t]of this.roots.entries())this.updateForRegion(e,t);this.invalidatedHexes.forEach((e=>this.builder.delete(e.id)))}updateForRegion(e,i){this.setRegion(e);const s=new Set,n=new Map,a=new Set,r=new o.default(((e,t)=>e.distance-t.distance));for(i.forEach((e=>r.push({hex:e,distance:0})));!r.empty();){const e=r.pop(),i=e.hex;if(a.has(i))continue;const o=this.getHexConnectivity(i);if(a.add(i),s.add(i),this.invalidatedHexes.delete(i),0===e.distance)this.builder.set(i.id,{connectivity:o,parents:[],value:0,distanceFromTown:0,factors:{fromHex:this.getHexBaseImportance(i),fromConnectedHexes:0,fromTownProximity:t.TOWN_HEX_BASE_IMPORTANCE,multiplier:1}});else{let{parents:e,distance:a}=this.findNewParents(i);const r={connectivity:o,parents:e,distanceFromTown:a,value:0,factors:{fromHex:this.getHexBaseImportance(i),fromConnectedHexes:0,fromTownProximity:1===a?t.TOWN_HEX_BASE_IMPORTANCE/2:0,multiplier:this.getChokePointMultiplier(i)}};this.builder.set(i.id,r),e.forEach((e=>{const t=(n.get(e)||0)+1;s.delete(e),n.set(e,t)}))}this.region.hexes.neighboursOf(i).filter((e=>(!this.builder.getCurrent(e.id)||this.isInvalidated(e))&&!a.has(e))).forEach((e=>{const t=this.builder.get(i.id);r.push({hex:e,distance:t.distanceFromTown+(7-t.connectivity)})}))}const c=Array.from(s);for(;c.length;){const e=c.pop(),t=this.builder.getCurrent(e.id),i=t.factors;this.addValueFromUnchangedChildren(e),t.value=Math.floor((i.fromHex+i.fromConnectedHexes)*i.multiplier);for(let i of t.parents){const t=n.get(i)??0;0===t&&v.error(`${i} considered parent of ${e.id}, but his children count is ${t}`),t<=1&&c.push(i),n.set(i,(0,l.pickLarger)(0,t-1)),this.addValueToParent(e,i)}}this.invalidatedRegions.delete(this.regionId)}isInvalidated(e){return!!this.invalidatedRegions.has(this.regionId)||this.invalidatedHexes.has(e)}getChokePointMultiplier(e){return h.Regions.isPotentialChokePoint(this.region.state,e.id)||this.doesHexContainVulnerablePawn(e)?1:.5}doesHexContainVulnerablePawn(e){const t=y.Warfare.getOccupyingPawn(this.newState,e);return!!t&&(t.might>0&&t?.hasTrait(f.PawnTraits.Building)||0===y.Warfare.getHexStaticDefense(this.newState,e.id))}addValueToParent(e,t){const i=this.builder.getCurrent(e.id),s=this.builder.getCurrent(t.id);u.assert.defined(s),u.assert.defined(i);const n=i.parents.length,a=((y.Warfare.getOccupyingPawn(this.newState,e)?.type===d.PawnType.Town?m.AssetValue.HEX_BASE_VALUE:i?.factors.fromHex)+i.factors.fromConnectedHexes)/n;s.factors.fromConnectedHexes+=a}getHexConnectivity(e){return 6-e.neighbours((e=>{const t=h.Regions.getByHex(this.newState,e.id);return void 0!==t&&t!==this.regionId})).length}getHexBaseImportance(e){return m.AssetValue.getTotal(this.newState,e,!1)}getMap(){return this.updateInvalidated(),a.default.Map(this.builder.getEntries()).mapKeys((e=>Number(e)))}addValueFromUnchangedChildren(e){this.region.hexes.neighboursOf(e).filter((t=>!this.builder.get(t.id)&&!!this.dataSet.getEntryById(this.newState,t.id)?.parents.includes(e))).forEach((t=>this.addValueToParent(t,e)))}}t.HexImportanceUpdater=S},42727:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.PowerByFactionUpdater=t.PowerByFactionProjection=void 0;const o=i(66206),r=i(30420),c=a(i(35369)),l=i(17281),d=i(14344),h=i(40108),u=i(48500),p=i(65955),g=i(54444),m=i(99896),y=i(62977),f=i(50264),w=i(5032),v=i(23441);u.logger.for("PowerByFactionProjection");class b extends o.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new S(this).update}bootstrap(e){const t=new S(this);return t.initFromState(e),d.Factions.getAll(e).forEach((e=>t.invalidate(e))),t.getMap()}entryToString(e){return(0,p.assetValueToDebugStr)(e.factors)}entryToDebugString(e){return(0,g.prettyPrintObject)(e)}}t.PowerByFactionProjection=b;class S extends l.BaseUpdater{constructor(){super(...arguments),this.builder=new o.MapMutationBuilder(this.dataSet),this.invalidatedFactions=new Set}initialize(){this.invalidatedFactions.clear()}registerHandlers(e){e(this.dataSet.sources.factionRegions,this._handleFactionRegionsChanged),e(this.dataSet.sources.assetsValueByRegion,this.handleRegionAssetValueChanged),e(this.dataSet.sources.currentPhaseData,this.handleCurrentPhaseDataChanged),e(this.dataSet.sources.movableUnits,this.handleMovableUnitsChanged)}invalidate(e){this.invalidatedFactions.add(e)}handleCurrentPhaseDataChanged(e){const t=m.CurrentPhase.getFaction(this.oldState),i=e.faction;t&&this.invalidatedFactions.add(t),i&&this.invalidatedFactions.add(i)}handleMovableUnitsChanged(){}_handleFactionRegionsChanged(e){e.updated?.forEach((e=>{this.invalidate(e.id)}))}handleRegionAssetValueChanged(e){e.updated?.forEach((([e])=>{const t=d.Factions.getByRegion(this.newState,e);void 0!==t&&this.invalidate(t)}))}updateInvalidated(){const e=y.Pawns.model(this.newState);for(let t of this.invalidatedFactions){let i=0,s=0;const n=d.Factions.getFactionRegions(this.newState,t).map((n=>{let a={...h.AI.getRegionAssetsValue(this.newState,n)};if(m.CurrentPhase.getFaction(this.newState)===t){const t=e.byRegion(f.Regions.model(this.newState).byId(n)).filter((e=>e.isMovable()));for(let e of t){const{offensive:t,economic:i,defensive:s}=p.AssetValue.getPawnFactors(e.type,e.count);a.offensive+=t,a.economic+=i,a.defensive+=s}}if(m.CurrentPhase.getFaction(this.newState)!==t){const e=p.AssetValue.getPawnFactors(r.PawnType.Coins,(0,v.pickLarger)(0,w.Economy.getRegionBudget(this.newState,n).balance));a=p.AssetValue.sum(a,e)}const o=1+(f.Regions.getRegionHexes(this.newState,n).size+w.Economy.getTreasuryOf(this.newState,n)/10-10)/20;let c=p.AssetValue.total(a);return i+=Math.trunc(c*o),s+=c,{defensive:a.defensive,economic:a.economic,offensive:a.offensive}}));this.builder.set(t,{scaledTotal:i,rawTotal:s,factors:p.AssetValue.sum(...n)})}}createMutation(){return this.updateInvalidated(),super.createMutation()}getMap(){return this.updateInvalidated(),c.Map(this.builder.getEntries()).mapKeys((e=>Number(e)))}}t.PowerByFactionUpdater=S},14008:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.defenseToResistance=t.createHexInfluenceDebugLayer=t.HexRegionInfluenceUpdater=t.InfluenceSpreadHeap=t.RegionInfluenceByHexProjection=void 0;const n=i(66206),a=s(i(35369)),o=s(i(54485)),r=i(50264),c=i(98030),l=i(17281),d=i(48500),h=i(14344),u=i(24794),p=i(47610),g=i(92065),m=i(79738),y=i(21999),f=i(54444),w=i(11689),v=i(15496),b=i(23441),S=i(88865),x=i(75071),T=d.logger.for("RegionInfluenceByHexProjection");function P(e){if(!e)return 0;let t=(0,b.pickLarger)(e.size,2*e.getEnemyAssets().getObtainableUnitCount());switch(t){case 0:case 1:return 0;case 2:case 3:return 2;case 4:case 5:return 3;case 6:case 7:case 8:case 9:return 5;default:return 5*Math.ceil(t/10)}}class M extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new A(this),this.update=this.updater.update}bootstrap(e){return this.updater.initFromState(e),r.Regions.getAll(e).forEach((t=>{r.Regions.getRegionHexes(e,t).size>=1&&this.updater.addSourcesFromRegion(t)})),this.updater.getMap()}entryToString(e){return e.size?`[${e.size}]`:""}entryToDebugString(e){return e.entrySeq().sort(((e,t)=>e[0]-t[0])).map((([e,t])=>`from ${(0,f.getGlyphForRegionId)(e)}${e} dist ${t.distance} resist ${t.resistance} cost ${t.cost} def ${t.hexDefense} (parent ${t.parent?.id} children ${t.children.toArray().map((e=>e.id)).join(",")} range ${P(S.inject.gameStateModel.regions.byId(e))})`)).join("\n")}}t.RegionInfluenceByHexProjection=M;class I extends o.default{constructor(){super(((e,t)=>e.cost===t.cost?t.sim.latestBreachedDefense-e.sim.latestBreachedDefense:e.cost-t.cost))}}t.InfluenceSpreadHeap=I;class A extends l.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet),this.invalidation=new Map}createMutation(){return this.updateInvalidated(),super.createMutation()}addSourcesFromRegion(e){const t=r.Regions.getRegionBorderHexes(this.newState,e);for(const i of t)this.addRoot(e,w.ConquestSim.fromState(this.newState),(0,u.getHex)(i))}updateInvalidated(){for(const e of this.invalidation.keys())this.updateInvalidatedForRegion(e)}updateInvalidatedForRegion(e){const{roots:t,dirtyHexes:i}=this.getOrCreateInvalidationData(e),s=P(r.Regions.model(this.newState).byId(e));this.updateInfluenceRange(e,s);const n=h.Factions.getByRegion(this.newState,e);if(void 0===n)return T.warning(`[R${e}] ignoring request to generate influence, it has no faction assigned`),void this.invalidation.delete(e);const a=new Set;for(const i of t.toArray())0===i.resistance&&this.updateInfluence(e,i.hex,null,0,0,0,0);for(const t of i)t.neighbours((e=>!i.has(e))).forEach((t=>{const i=this.builder.getCurrent(t.id)?.get(e);void 0!==i?.resistance&&this.addRoot(e,w.ConquestSim.fromState(this.newState).conquerHex(t),t,i.resistance,i.distance,i.cost)}));for(;!t.empty();){const{hex:i,resistance:o,distance:c,sim:l,cost:d}=t.pop();a.add(i);const h=this.builder.getCurrent(i.id)?.get(e);if(!h)continue;const u=i.neighbours((t=>{if(a.has(t))return!1;const i=r.Regions.getByHex(this.newState,t.id);return void 0!==i&&i!==e}));for(let r of u){const h=this.getHexDefense(l,n,r),u=this.getInfluenceSpreadResistance(l,n,r),p=d+(0,v.mightToUpkeep)(h+1),g=o+u,m=this.builder.getCurrent(r.id)?.get(e)?.resistance??1/0;g<=s&&g<m&&(this.updateInfluence(e,r,i,g,c+1,p,h),a.add(r),t.push({sim:l.conquerHex(r),hex:r,resistance:g,distance:c+1,cost:p}))}}this.invalidation.delete(e)}getMap(){return this.updateInvalidated(),a.default.Map(this.builder.getEntries()).mapKeys((e=>Number(e)))}registerHandlers(e){e(this.dataSet.sources.borderHexes,this.handleRegionBorderChange),e(this.dataSet.sources.regionsByHex,this.handleHexRegionChanged),e(this.dataSet.sources.hexDefense,this.handleHexDefenseChanged)}handleRegionBorderChange(e){for(let t of e.updated||[]){const e=t.id;for(let i of t.added||[])this.addRoot(e,w.ConquestSim.fromState(this.newState),(0,u.getHex)(i));for(let i of t.removed||[])this.invalidateSource(e,(0,u.getHex)(i))}}invalidateSource(e,t){r.Regions.getByHex(this.newState,t.id)!==e&&this.markDirty(e,t);const i=this.builder.getCurrent(t.id)?.get(e);if(i){this.removeInfluence(t,e);for(const t of i.children)this.invalidateSource(e,t)}}getOrCreateInvalidationData(e){let t=this.invalidation.get(e);return t||(t={dirtyHexes:new Set,roots:new I},this.invalidation.set(e,t)),t}addRoot(e,t,i,s=0,n=0,a=0){this.getOrCreateInvalidationData(e).roots.push({hex:i,sim:t,resistance:s,distance:n,cost:a})}markDirty(e,t){this.getOrCreateInvalidationData(e).dirtyHexes.add(t)}getParentOf(e,t){return t.findNeighbour((i=>!!this.builder.getCurrent(i.id)?.get(e)?.children.includes(t)))}clearParent(e,t){const i=this.getParentOf(e,t);if(!i)return;const s=this.builder.getCurrent(i.id),n=s?.get(e)?.children??a.default.Set();this.builder.set(i.id,s.set(e,{...s.get(e),children:n.delete(t)})),this.builder.set(t.id,s.set(e,{...s.get(e),parent:null}))}updateInfluence(e,t,i,s,n,o,r){const c=this.builder.getCurrent(t.id)||a.default.Map();if(c.get(e)&&(this.invalidateSource(e,t),this.clearParent(e,t)),this.builder.set(t.id,c.set(e,{parent:i,children:a.default.Set(),hexDefense:r,resistance:s,distance:n,cost:o})),i){const s=this.builder.getCurrent(i.id);if(s){const n=s.get(e)?.children||a.default.Set();this.builder.set(i.id,s.set(e,{...s.get(e),children:n.add(t)}))}else x.ErrorTracking.captureNonFatalError(new Error(`tried to make #${i.id} the parent of #${t.id}, but the parent hex has no influence record for region ${e}!`),"RegionInfluenceByHexProjection")}}removeInfluence(e,t){const i=this.builder.getCurrent(e.id);if(!i)return;this.clearParent(t,e);const s=i.delete(t);0===s.size?this.builder.delete(e.id):this.builder.set(e.id,s)}getHexDefense(e,t,i){return t!==y.SpecialFaction.neutral&&h.Factions.getByHex(this.newState,i.id)===t?-1:e.getHexDefense(i)}getInfluenceSpreadResistance(e,t,i){return C(this.getHexDefense(e,t,i))}handleHexRegionChanged(e){for(let[t,i]of e.updated||[]){const e=(0,u.getHex)(t),s=r.Regions.getByHex(this.oldState,t),n=h.Factions.getByHex(this.oldState,t),o=h.Factions.getByHex(this.newState,t);if(s===i)return;let c;s?(this.getOrCreateInvalidationData(s),this.invalidateSource(s,e),c=this.builder.getCurrent(t)?.keySeq().filter((e=>{const t=h.Factions.getByRegion(this.newState,e);return t===o||t===n||void 0===o})).toArray()):c=e.neighbours().map((e=>this.builder.getCurrent(e.id)?.keySeq().toSet()||a.default.Set())).reduce(((e,t)=>t?.union(e))).toArray(),i&&this.getOrCreateInvalidationData(i),c?.forEach((t=>{this.invalidateSource(t,e)}))}}updateInfluenceRange(e,t){if(!this.oldState)return;const i=P(r.Regions.model(this.oldState).byId(e));t>i?this.addLeafsAsRoots(e):t<i&&this.cullInfluenceRange(e,t)}addLeafsAsRoots(e){const t=w.ConquestSim.fromState(this.newState);let i=r.Regions.getRegionBorderHexes(this.oldState,e).toArray().map((e=>({hexId:e,simState:t})));for(;i.length>0;){const{hexId:t,simState:s}=i.pop(),n=this.builder.getCurrent(t)?.get(e);n&&(n.children.size>0?i.push(...n.children.toArray().map((e=>({hexId:e.id,simState:s.conquerHex(e)})))):this.addRoot(e,s,(0,u.getHex)(t),n.resistance,n.distance,n.cost))}}cullInfluenceRange(e,t){let i=r.Regions.getRegionBorderHexes(this.oldState,e).toArray();for(;i.length>0;){const s=i.pop(),n=this.builder.getCurrent(s)?.get(e);n&&(n.resistance>t?this.removeSubTree(e,(0,u.getHex)(s)):i.push(...n.children.toArray().map((e=>e.id))))}}removeSubTree(e,t){const i=this.builder.getCurrent(t.id)?.get(e)?.children.toArray()||[];this.removeInfluence(t,e),i.forEach((t=>this.removeSubTree(e,t)))}handleHexDefenseChanged(e){for(let[t,i]of e.updated||[])this.invalidateForAllRegionsExceptOwner((0,u.getHex)(t))}invalidateForAllRegionsExceptOwner(e){const t=r.Regions.getByHex(this.newState,e.id),i=new Set(this.builder.getCurrent(e.id)?.keySeq().filter((e=>e!==t)));for(const s of e.neighbours())this.builder.getCurrent(s.id)?.keySeq().filter((e=>e!==t)).forEach((e=>i.add(e)));i?.forEach((t=>this.invalidateSource(t,e)))}}function C(e){switch(e){case-1:return 0;case 0:return 1;case 1:return 2;case 2:return 4;case 3:return 8;default:return 100}}t.HexRegionInfluenceUpdater=A,t.createHexInfluenceDebugLayer=function(e){return new g.GameStateDebugLayer((0,m.dataSetAdapter)(p.GameState.ai.regionInfluenceByHex,{getValue:t=>t.get(e)?.cost?.toString(),arrowDataRetriever:(t,i)=>(0,c.selectFromState)(t,p.GameState.ai.regionInfluenceByHex,i)?.get(e)}))},t.defenseToResistance=C},35442:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createFactionInfluenceDebugLayer=t.RegionInfluenceByRegionUpdater=t.RegionInfluenceByRegionProjection=void 0;const n=i(66206),a=s(i(35369)),o=i(50264),r=i(98030),c=i(17281),l=i(48500),d=i(40108),h=(i(24794),i(52937)),u=i(47610),p=i(8352),g=i(8037),m=i(41707),y=i(88865),f=i(54444);l.logger.for("RegionInfluenceByRegionProjection");class w extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new b(this),this.update=this.updater.update}bootstrap(e){return this.updater.initFromState(e),a.default.Map().withMutations((t=>{for(const i of o.Regions.getAll(e))v(e,i).size>0&&t.set(i,v(e,i))}))}entryToString(e){return e.size?`[${e.size}]`:""}entryToDebugString(e){return e.entrySeq().sort((([e],[t])=>e-t)).map((([e,t])=>`${(0,f.getGlyphForRegionId)(e)}${e}: ${t.total} (proximity ${t.proximity})`)).join("\n")}}function v(e,t){const i=o.Regions.getRegionHexes(e,t);return a.default.Map().withMutations((s=>{for(const n of i)for(const[i,a]of d.AI.getHexInfluence(e,n))i!==t&&s.update(i,{proximity:1/0,total:0},(e=>({proximity:Math.min(e.proximity,a.resistance),total:e.total+Math.floor(10/a.resistance)})));s.map((e=>({...e,total:Math.floor(e.total)}))).filter((e=>e.total>0))}))}t.RegionInfluenceByRegionProjection=w;class b extends c.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet),this.dirtyRegions=new Set}registerHandlers(e){e(this.dataSet.sources.regionHexes,this.handleRegionBorderChange),e(this.dataSet.sources.regionInfluenceByHex,this.handleHexRegionInfluenceChange)}initialize(){super.initialize(),this.dirtyRegions.clear()}createMutation(){return this.dirtyRegions.forEach((e=>{const t=v(this.newState,e);t.size>0?this.builder.set(e,t):this.builder.delete(e)})),super.createMutation()}handleRegionBorderChange(e){for(let t of e.updated||[]){const e=t.id;this.dirtyRegions.add(e)}}handleHexRegionInfluenceChange(e){for(let[t,i]of e.updated||[]){const e=o.Regions.getByHex(this.newState,t);e&&this.dirtyRegions.add(e)}}}t.RegionInfluenceByRegionUpdater=b,t.createFactionInfluenceDebugLayer=function(e){const t=y.inject.gameStateModel.stateEngine;let i=(0,h.signal)();return t.watchDataSet(u.GameState.ai.regionInfluenceByHex,(()=>{i.fire()})),{onChange:i,getMap:()=>new p.ProxyHexGroupValuation(new g.HexGroupValuationFromStateEngine(t,u.GameState.ai.regionInfluenceByHex),((t,i)=>{if(!t)return;const s=t.get(e);return s?0===s?.resistance?m.GLYPH.whiteFlag:s.resistance:void 0})),getArrows(){let i=[];return t.get(u.GameState.ai.regionInfluenceByHex).forEach(((t,s)=>{const n=t.get(e);n?.children&&n.children?.forEach((e=>{i.push([s,e.id])}))})),i},getDetail(i){const s=(0,r.selectFromState)(t.currentState,u.GameState.ai.regionInfluenceByHex,i.id);if(!s)return"";const n=s.get(e);return n?`${n.resistance?.toString()} -> ${n.children?.map((e=>e.id)).join(",")}`:""}}}},40085:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.RegionBudgetUpdater=t.BudgetByRegionProjection=void 0;const o=i(66206),r=a(i(35369)),c=i(54444),l=i(50264),d=i(5032),h=i(17281);class u extends o.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new p(this).update}bootstrap(e){return r.Map().withMutations((t=>{l.Regions.model(e).all().forEach((e=>{t.set(e.id,this.getRegionBudget(e))}))}))}getRegionBudget(e){const t=e.state,i=e.hexes.map((e=>d.Economy.getIncomeFromHex(t,e.id))).reduce(((e,t)=>e+t),0),s=e.getPawns().map((e=>e.upkeep)).reduce(((e,t)=>e+t),0);return{potentialIncome:i,incomeFromHexes:e.isAlive()?i:0,upkeep:s,balance:i-s}}entryToString(e){return`${(0,c.withSign)(e.balance)}`}entryToDebugString(e){return(0,c.prettyPrintObject)(e)}}t.BudgetByRegionProjection=u;class p extends h.BaseUpdater{constructor(){super(...arguments),this.builder=new o.MapMutationBuilder(this.dataSet)}initialize(){this.invalidated=new Set}registerHandlers(e){e(this.dataSet.sources.regionHexes,this._invalidateAffectedRegions),e(this.dataSet.sources.pawnsByRegion,this._invalidateAffectedRegions),e(this.dataSet.sources.regions,this._handleRegionsUpdated)}createMutation(){const e=l.Regions.model(this.newState);return this.invalidated.forEach((t=>{const i=e.byId(t);i?this.builder.set(t,this.dataSet.getRegionBudget(i)):this.builder.delete(t)})),super.createMutation()}_invalidateAffectedRegions(e){e.updated?.forEach((({id:e})=>this.invalidated.add(e)))}_handleRegionsUpdated(e){e.updated?.forEach((([e,t])=>{t?l.Regions.getRegionData(this.oldState,e)||this.invalidated.add(e):this.builder.delete(e)}))}}t.RegionBudgetUpdater=p},27499:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinsByHexProjection=void 0;const s=i(66206),n=i(30420),a=i(98030),o=i(62977);class r extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.builder=new s.MapMutationBuilder(this)}bootstrap(e){return(0,a.selectFromState)(e,this.sources.pawnsByHex).map((t=>t.find((t=>o.Pawns.getPawnType(e,t)===n.PawnType.Coins)))).filter((t=>t&&0!==o.Pawns.getPawnCount(e,t))).map((t=>o.Pawns.getPawnCount(e,t)||0))}update(e,t,i){return this.builder.init(e),this._handlePawnByHexChange(e,t.of(this.sources.pawnsByHex),i),this._handlePawnsCountChange(e,t.of(this.sources.pawnsCount),i),this.builder.createMutation("parent changed")}_handlePawnByHexChange(e,t,i){t?.updated?.forEach((t=>{const s=t.id;t.added?.forEach((t=>{o.Pawns.getPawnType(e,t)===n.PawnType.Coins&&this.builder.set(s,o.Pawns.getPawnCount(e,t)||1)})),t.removed?.forEach((e=>{o.Pawns.getPawnType(i,e)===n.PawnType.Coins&&this.builder.delete(s)}))}))}_handlePawnsCountChange(e,t,i){t?.updated?.forEach((([t,i])=>{if(o.Pawns.getPawnType(e,t)===n.PawnType.Coins){const s=o.Pawns.getPawnHex(e,t);if(!s)return;i?this.builder.set(s,i):this.builder.delete(s)}}))}}t.CoinsByHexProjection=r},27122:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NearestCampUpdater=t.NearestCampByHexProjection=t.UNREACHABLE=void 0;const r=i(66206),c=a(i(35369)),l=i(48500),d=i(17281),h=i(50264),u=i(24794),p=i(55668),g=o(i(54485)),m=i(54444),y=i(78179),f=i(12678),w=i(41707);l.logger.for("NearestCampByHexProjection"),t.UNREACHABLE=Object.freeze({rootId:0,distance:Number.POSITIVE_INFINITY});class v extends r.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new b(this).update}bootstrap(e){const t=new b(this);return t.initFromState(e),h.Regions.getAll(e).filter((t=>h.Regions.model(e).byId(t)?.faction?.isNeutral())).forEach((e=>{t.addRootsFromRegion(e)})),t.getMap()}entryToString(e){return 0===e.distance?w.GLYPH.whiteFlag:e.rootId}entryToDebugString(e){return(0,m.prettyPrintObject)(e)}}t.NearestCampByHexProjection=v;class b extends d.BaseUpdater{constructor(){super(...arguments),this.builder=new r.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.sources=new Set,this}registerHandlers(e){e(this.dataSet.sources.campsByRegion,this.handleCampsByRegionChange)}handleCampsByRegionChange(e){e.updated?.forEach((e=>{e.added?.forEach((e=>{this.addNewRoot((0,u.getHex)(e))})),e.removed?.forEach((e=>{this.invalidateFrom((0,u.getHex)(e))}))}))}addRootsFromRegion(e){const t=h.Regions.model(this.newState).byId(e);t&&t.faction?.isNeutral()&&p.Bandits.getCampsByRegion(this.newState,e).forEach((e=>this.addNewRoot((0,u.getHex)(e))))}updateInvalidated(){this.addSourcesFromInvalidatedHexes();const e=new g.default(((e,t)=>e.distance-t.distance));for(this.sources.forEach((t=>{const i=this.builder.getCurrent(t.id);f.assert.defined(i),e.push({hex:t,rootHex:(0,u.getHex)(i.rootId),distance:i?.distance})}));!e.empty();){const t=e.pop(),i=t.hex;this.getCurrentDistanceFrom(i)<=t.distance||(this.invalidatedHexes.delete(i),this.builder.set(i.id,{distance:t.distance,rootId:t.rootHex.id}),i.neighbours((e=>void 0!==h.Regions.getByHex(this.newState,e.id)&&this.getCurrentDistanceFrom(e)>=t.distance+1)).forEach((i=>{e.push({hex:i,rootHex:t.rootHex,distance:t.distance+1})})))}this.invalidatedHexes.forEach((e=>this.builder.delete(e.id)))}addSourcesFromInvalidatedHexes(){y.HexGroup.from(Array.from(this.invalidatedHexes)).neighbours().filter((e=>this.getCurrentDistanceFrom(e)<Number.POSITIVE_INFINITY)).forEach((e=>{this.sources.add(e),this.invalidatedHexes.add(e)}))}getMap(){return this.updateInvalidated(),c.Map(this.builder.getEntries()).mapKeys((e=>Number(e)))}createMutation(){return this.updateInvalidated(),super.createMutation()}invalidateFrom(e){if(this.invalidatedHexes.has(e))return;this.invalidatedHexes.add(e);const i=this.builder.getCurrent(e.id);i&&e.neighbours((e=>{const s=this.builder.getCurrent(e.id)??t.UNREACHABLE;return i.rootId==s.rootId&&s.distance===i.distance+1})).forEach((e=>this.invalidateFrom(e)))}getCurrentDistanceFrom(e){return this.invalidatedHexes.has(e)?Number.POSITIVE_INFINITY:this.builder.getCurrent(e.id)?.distance??Number.POSITIVE_INFINITY}addNewRoot(e){this.sources.add(e),this.builder.set(e.id,{rootId:e.id,distance:0}),this.invalidatedHexes.add(e)}}t.NearestCampUpdater=b},62361:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NearestTownUpdater=t.NearestTownProjection=t.UNREACHABLE=void 0;const r=i(66206),c=a(i(35369)),l=i(48500),d=i(17281),h=i(50264),u=i(24794),p=o(i(54485)),g=i(54444),m=i(78179),y=i(12678),f=i(5032),w=i(41707);l.logger.for("NearestTownProjection"),t.UNREACHABLE=Object.freeze({rootId:0,distance:Number.POSITIVE_INFINITY});class v extends r.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new b(this).update}bootstrap(e){const t=new b(this);return t.initFromState(e),h.Regions.getAll(e).forEach((e=>{t.addRootsFromRegion(e)})),t.getMap()}entryToString(e){return 0===e.distance?w.GLYPH.whiteFlag:e.rootId}entryToDebugString(e){return(0,g.prettyPrintObject)(e)}}t.NearestTownProjection=v;class b extends d.BaseUpdater{constructor(){super(...arguments),this.builder=new r.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.sources=new Set,this}registerHandlers(e){e(this.dataSet.sources.townsByRegion,this.handleTownsByRegionChange),e(this.dataSet.sources.regionByHex,this.handleRegionByHexChange)}handleTownsByRegionChange(e){e.updated?.forEach((e=>{e.added?.forEach((e=>{this.addNewRoot((0,u.getHex)(e))})),e.removed?.forEach((e=>{this.invalidateFrom((0,u.getHex)(e))}))}))}handleRegionByHexChange(e){e.updated?.forEach((([e,t])=>{this.invalidateFrom((0,u.getHex)(e))}))}addRootsFromRegion(e){h.Regions.model(this.newState).byId(e)&&f.Economy.getTownHexesByRegion(this.newState,e).forEach((e=>this.addNewRoot((0,u.getHex)(e))))}updateInvalidated(){this.addSourcesFromInvalidatedHexes();const e=new p.default(((e,t)=>e.distance-t.distance));for(this.sources.forEach((t=>{const i=this.builder.getCurrent(t.id);y.assert.defined(i),e.push({hex:t,rootHex:(0,u.getHex)(i.rootId),distance:i?.distance})}));!e.empty();){const t=e.pop(),i=t.hex;this.getCurrentDistanceFrom(i)<=t.distance||(this.invalidatedHexes.delete(i),this.builder.set(i.id,{distance:t.distance,rootId:t.rootHex.id}),i.neighbours((e=>h.Regions.getByHex(this.newState,e.id)===h.Regions.getByHex(this.newState,i.id)&&this.getCurrentDistanceFrom(e)>=t.distance+1)).forEach((i=>{e.push({hex:i,rootHex:t.rootHex,distance:t.distance+1})})))}this.invalidatedHexes.forEach((e=>this.builder.delete(e.id)))}addSourcesFromInvalidatedHexes(){m.HexGroup.from(Array.from(this.invalidatedHexes)).neighbours().filter((e=>this.getCurrentDistanceFrom(e)<Number.POSITIVE_INFINITY)).forEach((e=>{this.sources.add(e),this.invalidatedHexes.add(e)}))}getMap(){return this.updateInvalidated(),c.Map(this.builder.getEntries()).mapKeys((e=>Number(e)))}createMutation(){return this.updateInvalidated(),super.createMutation()}invalidateFrom(e){if(this.invalidatedHexes.has(e))return;this.invalidatedHexes.add(e);const i=this.builder.getCurrent(e.id);i&&e.neighbours((e=>{const s=this.builder.getCurrent(e.id)??t.UNREACHABLE;return i.rootId==s.rootId&&s.distance===i.distance+1})).forEach((e=>this.invalidateFrom(e)))}getCurrentDistanceFrom(e){return this.invalidatedHexes.has(e)?Number.POSITIVE_INFINITY:this.builder.getCurrent(e.id)?.distance??Number.POSITIVE_INFINITY}addNewRoot(e){this.sources.add(e),this.builder.set(e.id,{rootId:e.id,distance:0}),this.invalidatedHexes.add(e)}}t.NearestTownUpdater=b},9516:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.TreasuryByRegionProjection=void 0;const o=i(66206),r=a(i(35369)),c=i(50264),l=i(23441),d=i(98030),h=i(21999),u=i(14344),p=i(42297),g=i(24794),m=i(30420);class y extends o.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.builder=new o.MapMutationBuilder(this)}bootstrap(e){return r.Map().withMutations((t=>{(0,d.selectFromState)(e,this.sources.townsByRegion).forEach(((i,s)=>{const n=i.toArray().map((t=>(0,d.selectFromState)(e,this.sources.coinsByHex,t)||0)).reduce(l.sum,0);n>0&&t.set(s,n)}))}))}update(e,t,i){return this.builder.init(e),this._handleCoinsByHexChange(e,t.of(this.sources.coinsByHex),i),this._handleTownsByRegionChange(e,t.of(this.sources.townsByRegion),i),this.builder.createMutation("parent changed")}_handleCoinsByHexChange(e,t,i){t?.updated?.forEach((([t,s])=>{const n=p.Warfare.getOccupyingPawn(i,(0,g.getHex)(t))?.type===m.PawnType.Town,a=p.Warfare.getOccupyingPawn(e,(0,g.getHex)(t))?.type===m.PawnType.Town,o=c.Regions.getByHex(e,t),r=c.Regions.getByHex(i,t);if(!o||u.Factions.getByRegion(e,o)===h.SpecialFaction.neutral)return;void 0===s&&(s=0);const l=r===o&&n?(0,d.selectFromState)(i,this.sources.coinsByHex,t)??0:0;a||(s=0);const y=(this.builder.getCurrent(o)||0)+s-l;y?this.builder.set(o,y):this.builder.delete(o)}))}_handleTownsByRegionChange(e,t,i){t?.updated?.forEach((e=>{const t=e.id;let s=this.builder.getCurrent(t)||0;e.added&&(s+=e.added.map((e=>(0,d.selectFromState)(i,this.sources.coinsByHex,e)||0)).reduce(l.sum,0)),e.removed&&(s-=e.removed.map((e=>(0,d.selectFromState)(i,this.sources.coinsByHex,e)||0)).reduce(l.sum,0)),s>0?this.builder.set(t,s):this.builder.delete(t)}))}}t.TreasuryByRegionProjection=y},98778:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getLivesAdjustmentAfterRewind=t.getTurnDelta=void 0;const s=i(99896);function n(e,t){let i=s.CurrentPhase.getTurnNumber(e);const n=s.CurrentPhase.getTurnNumber(t);return!s.CurrentPhase.model(e).faction?.isLocalPlayer()&&(i+=1),i-n}t.getTurnDelta=n,t.getLivesAdjustmentAfterRewind=function(e,t){const i=n(e,t);return 1===s.CurrentPhase.getTurnNumber(t)?"refill":i>0?"burn-one":"none"}},83081:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ruleSets=t.CHEAPEST_UNIT_COST=void 0;const s=i(20666),n=i(30420);t.CHEAPEST_UNIT_COST=10,t.ruleSets={default:{id:"default",economy:{baseIncomePerTile:1,baseIncomePerRegion:0},pawns:{[n.PawnType.Villager]:{might:1,cost:10,upkeep:2,traits:[s.PawnTraits.Unit,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.OccupiesTile],merge:{[n.PawnType.Villager]:n.PawnType.Pikeman}},[n.PawnType.Pikeman]:{might:2,cost:20,upkeep:6,traits:[s.PawnTraits.Unit,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.OccupiesTile],merge:{[n.PawnType.Pikeman]:n.PawnType.Knight}},[n.PawnType.Knight]:{might:3,cost:40,upkeep:18,traits:[s.PawnTraits.Unit,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.OccupiesTile],merge:{[n.PawnType.Knight]:n.PawnType.Hero}},[n.PawnType.Hero]:{might:4,defenseMight:3,cost:80,upkeep:54,traits:[s.PawnTraits.Unit,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.OccupiesTile],merge:{}},[n.PawnType.Town]:{traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Building,s.PawnTraits.GuardsAdjacentTiles],might:1},[n.PawnType.Camp]:{traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Building],might:1},[n.PawnType.Castle]:{traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Building,s.PawnTraits.GuardsAdjacentTiles],might:2,cost:20,upkeep:2},[n.PawnType.Bandit]:{might:0,upkeep:0,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.NegatesTileIncome,s.PawnTraits.Pest]},[n.PawnType.Forest]:{might:99,upkeep:0,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Impenetrable,s.PawnTraits.NegatesTileIncome]},[n.PawnType.HauntedTown]:{traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Building],might:1},[n.PawnType.Zombie]:{might:0,upkeep:0,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.NegatesTileIncome,s.PawnTraits.Pest]},[n.PawnType.Present]:{might:0,upkeep:0,cost:10,loot:10,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Pest,s.PawnTraits.Treasure]},[n.PawnType.Chest]:{might:0,upkeep:0,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Pest,s.PawnTraits.Treasure]}}}}},30420:(e,t)=>{"use strict";var i,s,n;Object.defineProperty(t,"__esModule",{value:!0}),t.PawnType=t.FactionController=t.PhaseTypes=void 0,(n=t.PhaseTypes||(t.PhaseTypes={})).FactionTurn="faction-turn",n.GameOver="game-over",(s=t.FactionController||(t.FactionController={})).None="none",s.LocalUser="local-user",s.Ai="ai",(i=t.PawnType||(t.PawnType={})).Town="town",i.Castle="castle",i.Camp="camp",i.Forest="forest",i.Villager="villager",i.Pikeman="pikeman",i.Knight="knight",i.Hero="hero",i.Bandit="bandit",i.Coins="coins",i.Chest="chest",i.Present="present",i.Zombie="zombie",i.HauntedTown="haunted-town"},62960:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CORE_GAMESTATE_SCHEMA_VERSION=void 0,t.CORE_GAMESTATE_SCHEMA_VERSION=7},17947:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AttitudeView=t.getAttitudeStr=t.getApprovalColor=t.getAttitudeIndex=t.APPROVAL_MAJOR_THRESHOLD=t.APPROVAL_MINOR_THRESHOLD=t.FEAR_THRESHOLD=t.ATTITUDE_LABELS=void 0;const s=i(47610),n=i(54379),a=i(40108),o=i(48500),r=i(54444),c=i(92065),l=i(74064),d=i(88865),h=i(23441);function u(e,i){return 10*function(e){return e>=t.FEAR_THRESHOLD?0:e>-t.FEAR_THRESHOLD?1:2}(e)+p(i)}function p(e){return e<=-t.APPROVAL_MAJOR_THRESHOLD?0:e<=-t.APPROVAL_MINOR_THRESHOLD?1:e<t.APPROVAL_MINOR_THRESHOLD?2:e<t.APPROVAL_MAJOR_THRESHOLD?3:4}o.logger.for("FearView"),t.ATTITUDE_LABELS=[["defiant","cornered","nervous","friendly/nervous","subservient"],["furious","angry","reserved","friendly","grateful"],["merciless","annoyed","confident","friendly/confident","benevolent"]],t.FEAR_THRESHOLD=25,t.APPROVAL_MINOR_THRESHOLD=10,t.APPROVAL_MAJOR_THRESHOLD=100,t.getAttitudeIndex=u;const g=[16719904,16749346,16776960,13041408,60672];function m(e,i){const s=u(e,i),n=Math.floor(s/10),a=s%10;return t.ATTITUDE_LABELS[n][a]}t.getApprovalColor=function(e,t){const i=e>=10?(0,h.pickSmaller)(t,0):t;return g[p(i)]},t.getAttitudeStr=m;class y extends n.LazyView{constructor(){super([s.GameState.ai.powerByFaction,s.GameState.ai.approval]),this.name="attitude"}calculate(e,t){return this.getComponents(e,t)?.attitude||"-"}getComponents(e,{fromFactionId:t,towardsFactionId:i}){if(t===i)return;const s=d.inject.views.fear.calculate(e,{towardsFactionId:i,fromFactionId:t}),n=a.AI.getFactionApproval(e,t,i);return{fear:s,approval:n,attitude:m(s,n)}}getCacheKey(e){return`${e.fromFactionId}->${e.towardsFactionId}`}getDebugLayer(e){return new c.GameStateDebugLayer((0,l.factionBasedAdapter)({getValue:(t,i)=>{if(i!==e)return this.get(t,{towardsFactionId:e,fromFactionId:i})},getDetail:(t,i)=>{if(i!==e)return(0,r.prettyPrintObject)(this.getComponents(t,{towardsFactionId:e,fromFactionId:i}))}}))}}t.AttitudeView=y},4643:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AttritionByFactionView=void 0;const s=i(47610),n=i(54379),a=i(40108),o=i(23441),r=i(48500),c=i(92065),l=i(74064),d=i(14344);r.logger.for("AttritionByFactionView");class h extends n.LazyView{constructor(){super([s.GameState.ai.attritionByRegion]),this.name="attritionByFaction"}calculate(e,t){const i={};return d.Factions.getFactionRegions(e,t).map((t=>{const s=a.AI.getRegionAttrition(e,t);for(const[e,t]of Object.entries(s))i[Number(e)]=(i[Number(e)]||0)+t})),i}getCacheKey(e){return e}getDebugLayer(){return new c.GameStateDebugLayer((0,l.factionBasedAdapter)({getValue:(e,t)=>Object.values(this.get(e,t)).reduce(o.sum,0),getDetail:(e,t)=>Object.entries(this.get(e,t)).map((([e,t])=>`${t} inflicted by faction ${e}`)).join("\n")}))}}t.AttritionByFactionView=h},21980:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BehaviorSummaryView=void 0;const s=i(47610),n=i(54379),a=i(40108),o=i(23441),r=i(92065),c=i(74064),l=i(14344),d=i(41707),h=i(78179),u=i(42297);class p extends n.LazyView{constructor(){super([s.GameState.ai.hexHistory,s.GameState.ai.assetsValueByRegion]),this.name="behaviorSummary"}calculate(e,t){const i={};let s=0,n=0;const r=l.Factions.model(e).byId(t),c=h.HexGroup.from(r.getPawns().map((e=>e.hex)));for(let t of c){const o=u.Warfare.getOccupyingPawn(e,t)?.might??0,r=a.AI.getHexAge(e,t.id),c=a.AI.getHexHistory(e,t.id);0===r&&(s+=o,"deadHex"!==c.spoils?i[c.previousFactionId]=i[c.previousFactionId]?i[c.previousFactionId]+o:o:n+=o)}const d=r.getRegions().map((e=>e.getMyAssets().getTotalAvailableMight())).reduce(o.sum,0);return{mightUsedForConquest:i,mightUsedForPeacefulExpansion:n,totalMightUsed:s,unusedMight:d-s,totalMight:d}}getCacheKey(e){return e}getDebugLayer(){return new r.GameStateDebugLayer((0,c.factionBasedAdapter)({getValue:(e,t)=>{const i=this.get(e,t);return`${d.GLYPH.sword}${i.totalMightUsed}/${i.totalMight}`},getDetail:(e,t)=>{const i=this.get(e,t);return`${Object.entries(i.mightUsedForConquest).map((([e,t])=>`${t} used vs ${d.GLYPH.factions[Number(e)]}`)).join("\n")}                \n${i.mightUsedForPeacefulExpansion} used to expand\n${i.unusedMight} unused`}}))}}t.BehaviorSummaryView=p},26579:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConquerableHexesView=void 0;const s=i(54379),n=i(42297),a=i(47610);class o extends s.LazyView{constructor(){super([a.GameState.warfare.hexDefense,a.GameState.regions.byHex,a.GameState.factions.byRegion]),this.name="conquerableHexes"}calculate(e,t){return n.Warfare.getConquerableHexes(e,t.regionId,t.unitMight)}getCacheKey(e){return`${e.regionId}/${e.unitMight}`}}t.ConquerableHexesView=o},28271:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExpansionOptionsView=void 0;const s=i(47610),n=i(54379),a=i(48500),o=i(92065),r=i(78179),c=i(50264),l=i(42297),d=i(7407);a.logger.for("AttritionByFactionView");class h extends n.LazyView{constructor(){super([s.GameState.ai.attritionByRegion]),this.name="expansionOptions"}calculate(e,t){const i=c.Regions.model(e).byId(t);if(!i)return r.HexGroup.empty;const s=l.Warfare.model(e);return i.getHostileBorderHexes().neighbours().filter((t=>!s.isImpassable(t)&&!i.hexes.has(t)&&0===l.Warfare.getHexDefense(e,t)))}getCacheKey(e){return e}getDebugLayer(){return new o.GameStateDebugLayer((0,d.regionBasedAdapter)({getValue:(e,t)=>this.calculate(e,t).length,getDetail:(e,t)=>this.calculate(e,t).toIdsArray().join(",")}))}}t.ExpansionOptionsView=h},75828:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionDiplomacyScoreView=void 0;const s=i(47610),n=i(54379),a=i(40108),o=i(48500),r=i(54444),c=i(92065),l=i(74064),d=i(88865),h=i(14344),u=i(23441),p=i(54812);o.logger.for("FearView");class g extends n.LazyView{constructor(){super([s.GameState.ai.powerByFaction,s.GameState.ai.approval]),this.name="factionDiplomacyScore"}calculate(e,t){const i=this.getComponents(e,t);if(0===i.length)return 1e6;const s=i.map((e=>e.score)).reduce(u.sum,0)/(0,u.pickLarger)(1,d.inject.views.powerBalance.get(e).totalPower-a.AI.getFactionScaledPower(e,t));return(0,p.deltaToMultiplier)(s)}getComponents(e,t){const i=h.Factions.model(e);return i.byId(t),i.all().filter((e=>e.id!==t&&e.isAlive()&&!e.isNeutral())).map((i=>{const s=(0,p.cropNumber)(a.AI.getFactionApproval(e,i.id,t)/100,-1,1),n=1-a.AI.getFactionFear(e,t,i.id)/100,o=a.AI.getFactionAttrition(e,t,i.id)+a.AI.getFactionAttrition(e,i.id,t)>5,r=o?-.5:1,c=Math.min(s,n,r)*a.AI.getFactionScaledPower(e,i.id);return{factionId:i.id,score:c,approvalStrength:s,fearCap:n,isAtWar:o,warCap:r}}))}getCacheKey(e){return e}getDebugLayer(){return new c.GameStateDebugLayer((0,l.factionBasedAdapter)({getValue:(e,t)=>this.get(e,t).toFixed(2),getDetail:(e,t)=>(0,r.prettyPrintObject)(this.getComponents(e,t))}))}}t.FactionDiplomacyScoreView=g},91989:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionInfluenceByRegionView=t.PowerMeasurement=void 0;const s=i(47610),n=i(98030),a=i(14344),o=i(54379),r=i(92065),c=i(7407),l=i(50264);var d;!function(e){e.MilitaryMight="might",e.RegionSize="size"}(d=t.PowerMeasurement||(t.PowerMeasurement={}));class h extends o.LazyView{constructor(){super([s.GameState.ai.regionInfluenceByRegion,s.GameState.factions.byRegion,s.GameState.ai.assetsValueByRegion]),this.name="factionInfluenceByRegion"}calculate(e,t){const i=this.getComponents(e,t);return{total:i.reduce(((e,t)=>e+t.influence),0),proximity:i.reduce(((e,t)=>Math.min(e,t.proximity)),1/0)}}getComponents(e,{influencingFaction:t,targetRegion:i,maxDistance:o,powerMeasurement:r}){const c=(0,n.selectFromState)(e,s.GameState.ai.regionInfluenceByRegion,i);return c?c.entrySeq().filter((([i,s])=>a.Factions.getByRegion(e,i)===t&&s.proximity<=o)).map((([t,i])=>({regionId:t,influence:i.total*this.getRegionReach(e,t,r),proximity:i.proximity}))).filter((({influence:e})=>e>0)).toArray():[]}getRegionReach(e,t,i){switch(i){case d.MilitaryMight:return l.Regions.model(e).byId(t).getMyAssets().getTotalAvailableMight();case d.RegionSize:return l.Regions.getRegionHexes(e,t).size}}getCacheKey({influencingFaction:e,targetRegion:t,maxDistance:i,powerMeasurement:s}){return`${e}.${t}.${i}.${s}`}getDebugLayer(e,t,i=99){return new r.GameStateDebugLayer((0,c.regionBasedAdapter)({getValue:(s,n)=>{const a=this.get(s,{influencingFaction:e,targetRegion:n,maxDistance:i,powerMeasurement:t});return`${a.total}\n(${a.proximity})`},getDetail:(s,n)=>this.getComponents(s,{influencingFaction:e,targetRegion:n,maxDistance:i,powerMeasurement:t}).map((e=>`${e.influence} from region ${e.regionId} (proximity ${e.proximity})`)).join("\n")}))}}t.FactionInfluenceByRegionView=h},35602:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionNeighboursView=void 0;const s=i(30420),n=i(47610),a=i(54379),o=i(48500),r=i(92065),c=i(14344),l=i(42297),d=i(50264),h=i(40108),u=i(50921),p=i(24794);o.logger.for("FactionNeighbours");class g extends a.LazyView{constructor(){super([n.GameState.ai.regionInfluenceByHex,n.GameState.regions.byHex,n.GameState.factions.byRegion]),this.name="factionNeighbours"}calculate(e,t){const i={};for(let s of this.getInfluencedHexes(e,t)){const t=h.AI.getHexImportance(e,s.id).value,n=m(l.Warfare.getHexDefense(e,s))*t,a=d.Regions.model(e).byHex(s);if(!a?.isAlive())continue;const o=a.faction.id;i[o]=i[o]?i[o]+n:n}return i}getInfluencedHexes(e,t){const i=new Set,s=c.Factions.model(e).byId(t);for(let t of s.getLiveRegions()){const s=t.getAssets().getMaxSustainableMight(),n=t.getHostileBorderHexes().filter((t=>h.AI.getHexAge(e,t.id)>0)).neighbours().filter((i=>d.Regions.getByHex(e,i.id)!==t.id));for(let t of n)s>l.Warfare.getHexDefense(e,t)&&i.add(t)}return i}getCacheKey(e){return e}getDebugLayer(e){return new r.GameStateDebugLayer((0,u.hexBasedAdapter)({getValue:(t,i)=>{const n=(0,p.getHex)(i);if(c.Factions.model(t).byId(e),c.Factions.getByHex(t,i)!==e&&l.Warfare.getOccupyingPawn(t,n)?.type===s.PawnType.Town){const s=c.Factions.getByHex(t,i);return this.get(t,e)[s]}if(this.getInfluencedHexes(t,e).has(n))return(m(l.Warfare.getHexDefense(t,n))*h.AI.getHexImportance(t,n.id).value).toFixed(1)},getDetail:(t,i)=>{const s=(0,p.getHex)(i);if(this.getInfluencedHexes(t,e).has(s))return`= ${m(l.Warfare.getHexDefense(t,s))} x ${h.AI.getHexImportance(t,s.id).value}`}}))}}function m(e){switch(e){case 0:return 1;case 1:return.25;default:return.05}}t.FactionNeighboursView=g},82251:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateFear=t.FearView=void 0;const s=i(47610),n=i(54379),a=i(40108),o=i(48500),r=i(54444),c=i(92065),l=i(74064),d=i(23441),h=i(96486);o.logger.for("FearView");class u extends n.LazyView{constructor(){super([s.GameState.ai.powerByFaction,s.GameState.ai.approval]),this.name="fear"}calculate(e,{fromFactionId:t,towardsFactionId:i}){return p({myPower:a.AI.getFactionScaledPower(e,t),enemyPower:a.AI.getFactionScaledPower(e,i)})}getCacheKey(e){return`${e.fromFactionId}->${e.towardsFactionId}`}getDebugLayer(e){return new c.GameStateDebugLayer((0,l.factionBasedAdapter)({getValue:(t,i)=>{if(i!==e)return(0,r.withSign)((0,h.round)(this.get(t,{towardsFactionId:e,fromFactionId:i})))},getDetail:(t,i)=>{if(i!==e)return`my power ${a.AI.getFactionScaledPower(t,i)} vs their ${a.AI.getFactionScaledPower(t,e)} => ${(0,r.withSign)(this.get(t,{fromFactionId:i,towardsFactionId:e}))}`}}))}}function p({myPower:e,enemyPower:t}){const i=.75*(e/t-1);return i<0?Math.floor((0,d.pickSmaller)(200*-i,100)):Math.floor((0,d.pickLarger)(100*-i,-100))}t.FearView=u,t.calculateFear=p},95877:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexProximityToRegionView=void 0;const s=i(47610),n=i(98030),a=i(54379),o=i(92065),r=i(23441),c=i(50921);class l extends a.LazyView{constructor(){super([s.GameState.ai.regionInfluenceByHex,s.GameState.regions.byHex,s.GameState.factions.byRegion]),this.name="hexProximityToRegionView"}calculate(e,t){return this.getComponents(e,t).map((e=>e.score)).reduce(r.sum,0)}getComponents(e,t){const i=(0,n.selectFromState)(e,s.GameState.ai.regionInfluenceByHex,t.hexId);return i?i.entrySeq().map((([e,i])=>({regionId:e,distance:i.distance,score:t.scoreCalculator(e,i.distance)}))).toArray():[]}getCacheKey(e){return e.cacheId+"."+e.hexId}getDebugLayer(e){return new o.GameStateDebugLayer((0,c.hexBasedAdapter)({getValue:(t,i)=>this.get(t,{...e,hexId:i}),getDetail:(t,i)=>this.getComponents(t,{...e,hexId:i}).map((({regionId:e,score:t,distance:i})=>`${t} from region ${e} (d=${i})`)).join("\n")}))}}t.HexProximityToRegionView=l},64673:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HostilityView=void 0;const s=i(47610),n=i(54379),a=i(48500),o=i(92065),r=i(88865),c=i(77874),l=i(1591),d=i(79516),h=i(7407),u=i(12678),p=i(54444),g=i(97654);a.logger.for("HostilityView");class m extends n.LazyView{constructor(){super([s.GameState.ai.powerByFaction,s.GameState.ai.approval]),this.name="attitude"}calculate(e,{targetRegion:t,attackerContext:i}){return l.AIPolitics.getHostilityTowards(t,i)}getCacheKey(e){return`${e.attackerContext.uniqueId}->${e.targetRegion.id}`}getDebugLayer(e){function t(e){let t=new d.RegionAIContext(e);const i=r.inject.views.situationScoreByRegion.getComponents({context:t,views:(0,c.createAiViews)(t)});return t.aiPersonality=(0,g.adjustPersonalityBasedOnSituation)(t,i),t.focus=t.aiPersonality,t}const i=r.inject.gameStateModel.regions.byId(e),s=this;return u.assert.defined(i),new o.GameStateDebugLayer((0,h.regionBasedAdapter)({getValue:(n,a)=>{const o=r.inject.gameStateModel.regions.byId(a);if(o&&a!==e)return s.get(n,{targetRegion:i,attackerContext:t(o)}).toFixed(2)},getDetail:(n,a)=>{const o=r.inject.gameStateModel.regions.byId(a);if(!o||a===e)return;const c=t(o);return(0,p.prettyPrintObject)(l.AIPolitics.getHostilityFactors(i,c))+"\nTOTAL: "+s.get(n,{targetRegion:i,attackerContext:c}).toFixed(2)}}))}}t.HostilityView=m},72960:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionForecastView=void 0;const s=i(47610),n=i(54379),a=i(92065),o=i(7407),r=i(50264),c=i(54444),l=i(44031);class d extends n.LazyView{constructor(){super([s.GameState.ai.assetsValueByRegion]),this.name="regionForecastView"}calculate(e,t){const i=r.Regions.model(e).byId(t).getMyAssets();return l.RegionForecast.getTotal(i)}calculateFactors(e,t){const i=r.Regions.model(e).byId(t).getMyAssets();return l.RegionForecast.getFactors(i)}getCacheKey(e){return e}getDebugLayer(){return new a.GameStateDebugLayer((0,o.regionBasedAdapter)({getValue:(e,t)=>this.get(e,t),getDetail:(e,t)=>{const i=this.calculateFactors(e,t);return(0,c.prettyPrintObject)(i)}}))}}t.RegionForecastView=d},41690:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionPoliticsView=t.DiplomaticStatus=void 0;const s=i(30420),n=i(47610),a=i(14344),o=i(54379),r=i(40108),c=i(92065),l=i(7407),d=i(50264),h=i(88865),u=i(17947),p=i(41707);var g;!function(e){e.Alliance="alliance",e.Truce="truce",e.Skirmish="skirmish",e.War="war"}(g=t.DiplomaticStatus||(t.DiplomaticStatus={}));class m extends o.LazyView{constructor(){super([n.GameState.ai.approval,n.GameState.ai.attritionByRegion,n.GameState.ai.assetsValueByRegion]),this.name="regionPoliticsView"}calculate(e,t){const i=a.Factions.getByRegion(e,t),n={};return a.Factions.model(e).all().filter((e=>e.controller!==s.FactionController.None&&e.id!==i&&e.isAlive())).forEach((s=>{const a={fear:h.inject.views.fear.get(e,{fromFactionId:i,towardsFactionId:s.id}),approval:r.AI.getFactionApproval(e,i,s.id),receivedAttrition:r.AI.getRegionAttrition(e,t,s.id),inflictedAttrition:r.AI.getFactionAttrition(e,s.id,i)};n[s.id]={...a,status:this.calculateStatus(d.Regions.model(e).byId(t),a)}})),n}calculateStatus(e,t){const i=e.size;return t.receivedAttrition<10&&t.inflictedAttrition<10?t.approval>u.APPROVAL_MAJOR_THRESHOLD?g.Alliance:g.Truce:t.receivedAttrition<i&&t.approval>-u.APPROVAL_MAJOR_THRESHOLD?g.Skirmish:g.War}getCacheKey(e){return e}getDebugLayer(){return new c.GameStateDebugLayer((0,l.regionBasedAdapter)({getValue:(e,t)=>{const i=this.get(e,t);return`${Object.values(i).map((e=>e.status[0].toUpperCase())).filter((e=>"T"!==e)).join("")}`},getDetail:(e,t)=>{const i=this.get(e,t);return Object.entries(i).map((([e,t])=>`${p.GLYPH.factions[Number(e)]} ${t.status} (${t.inflictedAttrition?p.GLYPH.sword+t.inflictedAttrition+" ":""}${t.receivedAttrition?p.GLYPH.defense+t.receivedAttrition+" ":""}approval ${t.approval.toFixed(0)}, fear ${t.fear})`)).join("\n")}}))}}t.RegionPoliticsView=m},2336:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SituationScoreByRegionView=t.SituationScoreComponentsEvaluation=void 0;const s=i(47610),n=i(54379),a=i(23441),o=i(48500),r=i(92065),c=i(77874),l=i(50264),d=i(79516),h=i(7407),u=i(54444),p=i(51019),g=i(40108),m=i(65955),y=i(97654),f=i(88865),w=i(98512),v=i(44031),b=i(42297),S=i(54812),x=(o.logger.for("AttritionByFactionView"),{factorsByRegion:[],expansionTarget:1,forecast:1,power:1,diplomacy:1,base:0});class T{constructor(e,t){this.context=e,this.views=t,this.factorsByRegion=e.faction.getRegions().filter((e=>e.isAlive())).map((e=>{const t=m.AssetValue.total(g.AI.getRegionAssetsValue(this.context.state,e.id));let i=0;for(let t of e.hexes){const e=1-this.views.evaluationSecurity.get(t.id),s=b.Warfare.getOccupyingPawn(this.context.state,t);let n=m.AssetValue.HEX_BASE_VALUE;if(s){const e=0===g.AI.getHexAge(this.context.state,t.id)?1:.25;n+=m.AssetValue.total(m.AssetValue.getPawnFactors(s.type,s.count))*e}i+=e*n}const s=this.getRegionForecast(e),n=t-i;return{regionId:e.id,safeAssets:n,exposedAssets:i,totalAssets:t,forecast:s,score:n*s}})),this.base=this.factorsByRegion.reduce(((e,t)=>e+t.score),0),this.power=(0,p.adjustMultiplierByFocus)(this.getPowerMultiplier(),this.context.aiPersonality.ambitious),this.forecast=this.getForecastMultiplier(),this.diplomacy=f.inject.views.factionDiplomacyScore.get(e.state,e.faction.id),this.expansionTarget=w.AIMetrics.getExpansionTargetScoreMultiplier(e)}getPowerMultiplier(){const e=this.context.faction.scaledPower,t=this.context.faction.parentModel.all().reduce(((e,t)=>t!==this.context.faction&&t.isAlive()?e.scaledPower>t.scaledPower?e:t:e));return t?e/(e+t.scaledPower):1e5}getRegionForecast(e){const t=w.AIMetrics.getObviousGameEndingThreat(e,this.views.threatAssessment);if(t)return 1/t*1e-5;let i=1;e.treasury>=20&&(i=1-(0,S.cropNumber)((e.treasury-20)/20,0,.999));const s=e.getMySafeAssets(this.views.evaluationSecurity,this.context.focus.daring);return v.RegionForecast.getTotal(s)*i}getForecastMultiplier(){const e=this.context.faction.forecast,t=this.context.faction.parentModel.all().filter((e=>e!==this.context.faction&&!e.isNeutral())).map((e=>e.forecast)).reduce(a.pickLarger,0);return t?e/(e+(0,a.pickLarger)(t,.01)):1e5}}t.SituationScoreComponentsEvaluation=T;class P extends n.LazyView{constructor(){super([s.GameState.ai.powerByFaction,s.GameState.ai.hexImportance,s.GameState.factions.regions,s.GameState.warfare.hexDefense]),this.name="situationScoreByRegion"}calculate(e,t){const i=this.getComponents(t);return this.calculateFromComponents(i)}calculateFromComponents(e){return e.base*e.power*e.expansionTarget+e.diplomacy}getComponents({context:e,views:t}){return e.faction?new T(e,t):x}getCacheKey(e){return e.context.uniqueId}getDebugLayer(e){return new r.GameStateDebugLayer((0,h.regionBasedAdapter)({getValue:(t,i)=>{const s=M(t,i,e);if(!s)return;const n=this.getComponents(s);return this.get(t,s).toFixed(0)+"\n="+`${n.base.toFixed(0)} * P${(100*n.power).toFixed()} * D${(100*n.diplomacy).toFixed()} * T${n.expansionTarget.toFixed()}`},getDetail:(t,i)=>{const s=M(t,i,e);if(!s)return;const n=f.inject.gameStateModel.regions.byId(i),a=this.getComponents(s);return`${a.factorsByRegion.map((e=>`#${e.regionId}: ${e.safeAssets.toFixed(0)}/${e.totalAssets} * ${e.forecast.toPrecision(2)}`)).join("\n")}\n                    \nfaction forecast: ${(0,u.formatNumber)(a.forecast)}                    \nlocal forecast: ${n?.forecast}\nlocal power: ${m.AssetValue.total(g.AI.getRegionAssetsValue(f.inject.currentGameState,i))}\noffensive action required: ${s.context.isOffensiveActionRequired()}\ngame ending threat: ${w.AIMetrics.getObviousGameEndingThreat(n,s.views.threatAssessment)}\npersonality shift: \n  expansion ${n?.faction?.aiPersonality.daring.toFixed(2)} => ${s.context.aiPersonality.daring.toFixed(2)}\n  disruption ${n?.faction?.aiPersonality.combative.toFixed(2)} => ${s.context.aiPersonality.combative.toFixed(2)}`}}))}}function M(e,t,i){const s=l.Regions.model(e).byId(t);if(!s)return;let n,a;if(i?.region===s)n=i,a=(0,c.createAiViews)(n);else{n=new d.RegionAIContext(s),a=(0,c.createAiViews)(n);const e=f.inject.views.situationScoreByRegion.getComponents({context:n,views:a});n.aiPersonality=(0,y.adjustPersonalityBasedOnSituation)(n,e)}return{views:a,context:n}}t.SituationScoreByRegionView=P},88865:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.setCoreContext=t.inject=t.SPECTATING_SPEED_LABELS=t.SpectatingPlaybackSpeed=void 0,function(e){e[e.Paused=0]="Paused",e[e.Normal=1]="Normal",e[e.Fast=2]="Fast",e[e.UltraFast=3]="UltraFast"}(i=t.SpectatingPlaybackSpeed||(t.SpectatingPlaybackSpeed={})),t.SPECTATING_SPEED_LABELS={[i.Paused]:"Paused",[i.Normal]:"Normal",[i.Fast]:"Fast",[i.UltraFast]:"Very Fast"},t.setCoreContext=function(e){t.inject=new Proxy(e,{get(e,t,i){if(e.hasOwnProperty(t))return Reflect.get(e,t,i);throw new Error(`attempted to access unitialized property "${String(t)}"`)}})}},97884:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryWithCache=void 0,t.FactoryWithCache=class{constructor(e){this.maker=e,this.instances=new WeakMap}getOrCreateFor(e){let t=this.instances.get(e);return t||(t=this.maker(e),this.instances.set(e,t)),t}}},35908:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FixedCapacityArray=void 0,t.FixedCapacityArray=class{constructor(e){this.cursor=0,this.data=[],this.size=0,Array.isArray(e)?(this.data=e,this.size=this.data.length):this.size=e}get length(){return this.data.length}push(e){this.data[this.cursor]=e,this.cursor=(this.cursor+1)%this.size}getItems(){return this.data.slice(this.cursor,this.size).concat(...this.data.slice(0,this.cursor))}get(e){return this.data[(this.cursor+e)%this.data.length]}pop(){const e=this.getItems(),t=e[e.length-1];return this.data=this.getItems().slice(0,this.data.length-1),this.cursor=this.data.length,t}clear(){this.data=[],this.cursor=0}last(){const e=this.getItems();return e[e.length-1]}}},22436:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FpsTracker=void 0;const s=i(58592);t.FpsTracker=class{constructor(){this.avgFps=0,this.minFps=0,this.samples=0}reset(){const e=s.app.game.loop.actualFps;this.avgFps=e,this.minFps=e,this.samples=1,this.timer||(this.timer=setInterval(this.update.bind(this),1e3))}update(){const e=s.app.game.loop.actualFps;e<this.minFps&&(this.minFps=e),this.avgFps=(this.avgFps*this.samples+e)/(this.samples+1),this.samples++}}},40909:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ObjectCache=void 0;const s=i(35369);t.ObjectCache=class{constructor(e=s.hash){this.hashFunction=e,this.data={}}find(e){return this.data[this.hashFunction(e)]}store(e,t){this.data[this.hashFunction(e)]=t}flush(){this.data={}}}},43427:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PersistentEntry=void 0;const n=i(88865),a=s(i(95775)),o={serialize:e=>(0,a.default)(e),deserialize:function(e){return JSON.parse(e)}};t.PersistentEntry=class{constructor(e,t=o){this.key=e,this.serializer=t}put(e){n.inject.storage.setItem(this.key,(0,a.default)(e))}discard(){n.inject.storage.removeItem(this.key)}take(){const e=n.inject.storage.getItem(this.key);return e?(n.inject.storage.removeItem(this.key),JSON.parse(e)):null}}},5893:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Pool=void 0;const s=i(48500).logger.for("Pool");t.Pool=class{constructor(e){this.factory=e,this.freeInstances=new Set,this.usedInstances=new Set}preload(e){for(;this.freeInstances.size<e;)this.freeInstances.add(this.factory());return this}take(){let e=this.freeInstances.values().next().value;return e?this.freeInstances.delete(e):e=this.factory(),this.usedInstances.add(e),e}free(e){this.usedInstances.has(e)?(this.usedInstances.delete(e),this.freeInstances.add(e)):s.warning(`redundant attempt to free ${e} - it is not marked as used in the Pool`)}freeAll(){this.usedInstances.forEach((e=>this.freeInstances.add(e))),this.usedInstances.clear()}}},76470:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Stopwatch=void 0,t.Stopwatch=class{constructor(){this.startTime=void 0,this.totalMs=0,this.paused=!1}isRunning(){return this.startTime}isPaused(){return!this.isRunning()}start(){this.startTime=Date.now()}pause(){this.updateTotalMs(),this.startTime=void 0}reset(){this.totalMs=0,this.isRunning()&&(this.startTime=Date.now())}updateTotalMs(){this.startTime&&(this.totalMs+=Date.now()-this.startTime,this.startTime=Date.now())}getElapsedSeconds(){return this.updateTotalMs(),this.totalMs/1e3}}},85656:(e,t)=>{"use strict";function i(e,t){for(var i=0,s=e.length;i<s;){var n=i+s>>>1;e[n]<t?i=n+1:s=n}return i}function s(e,t){let i,s=-1/0;for(let n of e){const e=t(n);e>s&&(i=n,s=e)}return i}Object.defineProperty(t,"__esModule",{value:!0}),t.inverseLookup=t.findMin=t.findMax=t.range=t.ascendingSortFn=t.getInsertionIndexInSortedArray=t.insertIntoSortedArray=t.getOrCreate=t.isObject=t.filterDictionaryInPlace=t.filterDictionary=t.mapDictionary=t.pick=t.omit=t.mergeArrays=t.dictionaryOf=t.removeFromArrayInPlace=t.pushIntoArrayByKey=t.cloneArrayWithoutItemAt=t.cloneArrayWithout=t.stripDuplicatesFrom=t.insertBetween=t.replaceArrayItem=void 0,t.replaceArrayItem=function(e,t,i){if(t<0||t>=e.length)throw new Error(`index out of bounds (array length: ${e.length}, index: ${t})`);return[...e.slice(0,t),i,...e.slice(t+1)]},t.insertBetween=function(e,t){return e.reduce(((e,i,s,n)=>(e.push(i),s<n.length-1&&e.push(t),e)),[])},t.stripDuplicatesFrom=function(e){return Array.from(new Set(e))},t.cloneArrayWithout=function(e,...t){return e.filter((e=>!t.includes(e)))},t.cloneArrayWithoutItemAt=function(e,t){return[...e.slice(0,t),...e.slice(t+1)]},t.pushIntoArrayByKey=function(e,t,...i){void 0===e[t]&&(e[t]=[]),e[t].push(...i)},t.removeFromArrayInPlace=function(e,t){return-1===e.indexOf(t)||e.splice(e.indexOf(t),1),e},t.dictionaryOf=function(e,t){const i={};for(const s of e)i[s[t]]=s;return i},t.mergeArrays=function(...e){return[].concat(...e)},t.omit=function(e,...t){return Object.keys(e).reduce(((i,s)=>(t.includes(s)||(i[s]=e[s]),i)),{})},t.pick=function(e,...t){return Object.keys(e).reduce(((i,s)=>(t.includes(s)&&(i[s]=e[s]),i)),{})},t.mapDictionary=function(e,t){return Object.assign({},...Object.keys(e).map((i=>({[i]:t(e[i],i)}))))},t.filterDictionary=function(e,t){const i={};for(const s in e)t(e[s],s)&&(i[s]=e[s]);return i},t.filterDictionaryInPlace=function(e,t){for(const i in e)t(e[i],i)||delete e[i];return e},t.isObject=function(e){return e&&"object"==typeof e&&!Array.isArray(e)},t.getOrCreate=function(e,t,i){if(void 0!==e[t])return e[t];const s=i();return e[t]=s,s},t.insertIntoSortedArray=function(e,t){const s=i(e,t);return e.splice(s,0,t),e},t.getInsertionIndexInSortedArray=i,t.ascendingSortFn=function(e,t){return e-t},t.range=function(e,t){return t<e||isNaN(e)||isNaN(t)?[]:Array(t-e+1).fill(0).map(((t,i)=>e+i))},t.findMax=s,t.findMin=function(e,t){return s(e,(e=>-t(e)))},t.inverseLookup=function(e,t){return Object.entries(e).find((([e,i])=>i===t))?.[0]}},56175:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncBuffer=void 0,i(48500).logger.for("AsyncBuffer"),t.AsyncBuffer=class{constructor(){this.pendingKeys=new Set}flush(){this.currentPromise&&(this.currentCallback?.(),this.currentPromise=void 0,this.currentCallback=void 0,this.pendingKeys.clear())}async schedule(e,t){if(!this.pendingKeys.has(e))return this.pendingKeys.add(e),this.currentPromise||(this.currentPromise=new Promise((e=>{this.currentCallback=()=>{e()}}))),await this.currentPromise,t()}}},80568:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncJobExclusiveRunner=void 0;const s=i(48500),n=i(52937),a=i(54444),o=s.logger.for("AsyncJobExclusiveRunner");t.AsyncJobExclusiveRunner=class{constructor(e){this.jobRunner=e,this.paused=!1,this.currentInput=null,this.currentPromise=null,this.onJobStarted=(0,n.signal)(),this.onJobFinished=(0,n.signal)()}run(e){this.currentInput!==e&&(this.currentInput=e,this.currentPromise?this.currentPromise=null:this._runPendingJob())}_runPendingJob(){if(this.currentInput&&!this.currentPromise){const e=this.currentInput;this.currentPromise=this.jobRunner(e,(async()=>{this.currentInput!==e?(o.warning("Aborting job"),this._runPendingJob(),await new Promise((()=>{}))):await(0,a.preventFreeze)()})),this.onJobStarted.fire(e),this.currentPromise.then((()=>{this.currentInput===e?(this.currentInput=null,this.currentPromise=null,this.onJobFinished.fire(e)):this._runPendingJob()}))}}isRunning(){return!!this.currentPromise}clear(){this.currentInput=null,this.currentPromise=null}}},91539:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncJobQueue=t.QueueStatus=void 0;const s=i(48500),n=i(32207),a=i(21103);var o;s.logger.for("AsyncJobQueue"),function(e){e.Processing="processing",e.Paused="paused",e.Idle="idle"}(o=t.QueueStatus||(t.QueueStatus={})),t.AsyncJobQueue=class{constructor(e){this.jobRunner=e,this.pendingJobs=[],this.status=(0,a.watchable)(o.Idle),this.paused=!1,this.currentPromise=void 0,this.jobsCompletePromise=(0,n.controlledPromise)()}addJob(e){this.pendingJobs.push((()=>this.jobRunner(e))),this.startNextJobIfIdle()}startNextJobIfIdle(){if(this.currentPromise||this.paused)return;const e=this.pendingJobs.shift();if(!e)return this.status.set(o.Idle),this.jobsCompletePromise?.resolve(),void(this.jobsCompletePromise=void 0);this.jobsCompletePromise||(this.jobsCompletePromise=(0,n.controlledPromise)()),this.status.set(o.Processing),this.currentPromise=e().then((()=>{this.currentPromise=void 0,this.startNextJobIfIdle()}))}async jobsComplete(){if(this.jobsCompletePromise)return this.jobsCompletePromise}pause(){this.paused||(this.status.set(o.Paused),this.paused=!0)}resume(){this.paused&&(this.paused=!1,this.startNextJobIfIdle())}clear(){this.pendingJobs=[]}}},32207:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.controlledPromise=void 0,t.controlledPromise=function(){let e,t;const i=new Promise(((i,s)=>{e=i,t=s}));return i.resolve=()=>e(),i.reject=e=>t(e),i}},81700:(e,t)=>{"use strict";function i(e){try{var t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t),t.focus(),t.select();const i=document.execCommand("copy");if(document.body.removeChild(t),!i)throw Error("failed to copy to clipboard")}catch(t){!function(e){window.prompt("Oops! I failed to access your clipboard directly, but you can still copy the follow link manually with Ctrl+C!",e)}(e)}}Object.defineProperty(t,"__esModule",{value:!0}),t.copyTextToClipboard=void 0,t.copyTextToClipboard=async function(e){try{if(!navigator.clipboard)return void i(e);await navigator.clipboard.writeText(e)}catch(t){i(e)}}},30258:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.downloadAsTextFile=void 0,t.downloadAsTextFile=function(e,t){const i=new Blob([t],{type:"text/plain"}),s=URL.createObjectURL(i),n=document.createElement("a");n.href=s,n.download=e,n.click(),n.remove()}},52643:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventQueue=void 0,t.EventQueue=class{constructor(){this.sources=[],this.pendingEvents=[]}addSource(e){this.sources.push(e((e=>this.push(e))))}push(e){this.pendingEvents.push(e)}hasNext(){return this.pendingEvents.length>0}next(){return this.pendingEvents.shift()}unsubscribe(){this.sources.forEach((e=>e.unsubscribe()))}clear(){this.pendingEvents=[]}}},52937:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.signal=void 0,t.signal=function(){const e=[],t=function(t){return e.push(t),{unsubscribe(){i(t)}}};return t.fire=t=>e.map((e=>e(t))),t.unsubscribe=i,t.unsubscribeAll=()=>e.length=0,t;function i(t){const i=e.indexOf(t);-1!==i&&e.splice(i,1)}}},18327:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TypedEventBus=void 0;const s=i(85656),n=i(48500).logger.for("events");class a{constructor(e){this.parent=e,this.handlers={}}on(e,t){(0,s.pushIntoArrayByKey)(this.handlers,e.eventName,t);const i=this.on.bind(this),n=this.handlers;return{unsubscribe(){(0,s.removeFromArrayInPlace)(n[e.eventName],t)},on:i}}trigger(e){let t=!1,i=!1;for(let s of this.handlers[e.name]||[])if(i=!0,s(e.payload,(()=>t=!0)),t)return;t=!1,this.defaultHandler&&(this.defaultHandler(e,(()=>t=!0)),i=!0),t||(this.parent?this.parent.trigger(e):i||n.warning(`No handler currently registered for event ${e.name} - ignoring.`))}setDefaultHandler(e){this.defaultHandler=e}createChild(){return new a(this)}}t.TypedEventBus=a},34758:(e,t)=>{"use strict";var i;function s(e){return t=>{const i=e+"."+t,s=function(t){return{name:i,payload:t,category:e,isTypedEvent:!0}};return s.eventName=e+"."+t,s.category=e,s}}Object.defineProperty(t,"__esModule",{value:!0}),t.createTypedEventHandler=t.isEvent=t.createEventFactory=t.worldMapAction=t.playEvent=t.uiEvent=t.userAction=t.systemEvent=t.gameStateEvent=t.EventCategory=void 0,function(e){e.GameState="GAME_STATE",e.System="SYSTEM",e.UserAction="USER_ACTION",e.UiEvent="UI_EVENT",e.ReportingEvent="TELEMETRY",e.IFrame="IFRAME",e.MapEditor="UI_MAP_EDITOR",e.WorldMap="UI_WORLD_MAP",e.Play="PLAY",e.News="NEWS"}(i=t.EventCategory||(t.EventCategory={})),t.gameStateEvent=function(){return s(i.GameState)},t.systemEvent=function(){return s(i.System)},t.userAction=function(){return s(i.UserAction)},t.uiEvent=function(){return s(i.UiEvent)},t.playEvent=function(){return s(i.Play)},t.worldMapAction=function(){return s(i.WorldMap)},t.createEventFactory=s,t.isEvent=function(e,t){return!(!e||!e.hasOwnProperty("isTypedEvent")||t&&e.name!==t.eventName)},t.createTypedEventHandler=function(){const e={};return{on(t,i){if(e[t.eventName])throw new Error(`${t.eventName} already has a handler!`);e[t.eventName]=i},handle:t=>e[t.name]?.(t.payload)}}},19098:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.describeEventVerbose=void 0;const s=i(54444);t.describeEventVerbose=function(e){return`${e.name}(${(0,s.str)(e.payload)})`}},23441:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDefined=t.pickSmaller=t.pickLarger=t.sum=void 0,t.sum=(e,t)=>e+t,t.pickLarger=(e,t)=>e>=t?e:t,t.pickSmaller=(e,t)=>e>=t?t:e,t.isDefined=function(e){return void 0!==e}},42526:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBoundingBox=t.getRectMidPoint=t.euclidDistance=t.manhattanDistance=t.multiplyRect=t.enlargeRect=t.rectToPhaser=void 0,t.rectToPhaser=function(e){return new Phaser.Geom.Rectangle(e.x,e.y,e.width,e.height)},t.enlargeRect=function(e,t){return e.x-=t,e.y-=t,e.width+=2*t,e.height+=2*t,e},t.multiplyRect=function(e,t,i){return e.x*=t,e.y*=i,e.width*=t,e.height*=i,e},t.manhattanDistance=function(e,t){return Math.abs(Math.abs(e.x)-Math.abs(t.x))+Math.abs(Math.abs(e.y)-Math.abs(t.y))},t.euclidDistance=function(e,t){const i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)},t.getRectMidPoint=function(e){return{x:e.x+e.width/2,y:e.y+e.height/2}},t.getBoundingBox=function(e){if(0===e.length)return{x:0,y:0,height:0,width:0};let t=Number.MAX_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER,s=-Number.MAX_SAFE_INTEGER,n=-Number.MAX_SAFE_INTEGER;for(let a of e)a.x<t&&(t=a.x),a.x>s&&(s=a.x),a.y<i&&(i=a.y),a.y>n&&(n=a.y);return{x:t,y:i,width:s-t,height:n-i}}},45341:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.neighbourBitmapHasDirection=t.HexDisplayDelegate=t.Hex=t.HEX_CORNER_NEIGHBOURS=t.HEX_CORNER_DIRECTIONS=t.HEX_DIRECTIONS=t.HexCornerDirection=t.HexDirection=void 0;const n=i(24794),a=i(92288),o=i(78179),r=s(i(20504)),c=i(34198),l=i(35935),d=2*Math.PI;var h,u;(u=t.HexDirection||(t.HexDirection={}))[u.UP_LEFT=0]="UP_LEFT",u[u.UP_RIGHT=1]="UP_RIGHT",u[u.RIGHT=2]="RIGHT",u[u.DOWN_RIGHT=3]="DOWN_RIGHT",u[u.DOWN_LEFT=4]="DOWN_LEFT",u[u.LEFT=5]="LEFT",(h=t.HexCornerDirection||(t.HexCornerDirection={}))[h.UP_LEFT=0]="UP_LEFT",h[h.TOP=1]="TOP",h[h.UP_RIGHT=2]="UP_RIGHT",h[h.DOWN_RIGHT=3]="DOWN_RIGHT",h[h.DOWN=4]="DOWN",h[h.DOWN_LEFT=5]="DOWN_LEFT",t.HEX_DIRECTIONS=[0,1,2,3,4,5],t.HEX_CORNER_DIRECTIONS=[0,1,2,3,4,5],t.HEX_CORNER_NEIGHBOURS=[[5,0],[0,1],[1,2],[2,3],[3,4],[4,5]];const p=[-d/3,-d/6,0,d/6,d/3,d/2],g=[[-.5,-1],[.5,-1],[1,0],[.5,1],[-.5,1],[-1,0]],m=[[-.5,-.25],[0,-.5],[.5,-.25],[.5,.25],[0,.5],[-.5,.25]];class y{constructor(e){this.id=e}get tabular(){return void 0===this._tabular&&(this._tabular=(0,a.ordinalToTabular)(this.id)),this._tabular}*[Symbol.iterator](){yield this}get display(){return this._display||(this._display=new f(this)),this._display}get r(){return this.tabular.r}get c(){return this.tabular.c}get x(){return(0,a.tabularToSpatial)(this.tabular).x}get y(){return this.r}get length(){return 1}get members(){return[this]}first(){return this}isAtGridBorder(e){return n.HexGrid.isHexOnGridBorder(this,e)}neighbours(e=(e=>!0)){return o.HexGroup.from(g.map((e=>n.HexGrid.getHex({x:this.x+e[0],y:this.y+e[1]}))).filter((t=>t&&e(t))))}disjointedNeighbourGroups(e){let i=new r.default,s=t.HEX_DIRECTIONS.map((t=>{const i=this.neighbour(t);return i&&e(i)?i:null}));const n=s.indexOf(null);let a=null;if(-1===n)i.addToGroup(s[0].id,...s);else{for(let e=n+1;e<s.length;++e)o(s[e]);for(let e=0;e<n;++e)o(s[e])}function o(e){null===e?a=null:(a||(a=e.id),i.addToGroup(a,e))}return i}neighboursByCornerDirection(e){const[i,s]=t.HEX_CORNER_NEIGHBOURS[e];return[this.neighbour(i),this.neighbour(s)].filter((e=>e))}neighbour(e){const t=g[e];return n.HexGrid.getHex({x:this.x+t[0],y:this.y+t[1]})}getDirectionTowards(e){const t=e.x-this.x,i=e.y-this.y;return g.findIndex((([e,s])=>e===t&&s===i))}getCorner(e){return l.HexCorner.fromHexAndDirection(this,e)}getCorners(){return t.HEX_CORNER_DIRECTIONS.map((e=>this.getCorner(e)))}hasCorner(e){return e.sortedHexes.includes(this)}getAngleTowards(e){return p[this.getDirectionTowards(e)]}bfsFrom(e,t){t(e,void 0,0)}floodFillOut(e=(()=>!0)){return o.HexGroup.from([this]).floodFillOut(e)}findClosest(e,t){return o.HexGroup.from([this]).findClosest(e,t)}neighboursOf(e){return o.HexGroup.from([this]).neighboursOf(e)}toString(){return`[Hex #${this.id} (${this.x},${this.y})]`}asGroup(){return o.HexGroup.from([this])}toIdsArray(){return this.asGroup().toIdsArray()}toArray(){return this.asGroup().toArray()}has(e){return this.asGroup().has(e)}contains(e){return this.id===e?.id}hasId(e){return this.id===e}border(e=!1){return this.asGroup().border(e)}getDisplayBoundingBox(){return{x:this.display.left,y:this.display.top,width:this.display.width,height:this.display.height}}getHex(){return this}components(e=(()=>!0)){return this.asGroup().components(e)}with(e){return Array.isArray(e)?o.HexGroup.from([this,...e]):o.HexGroup.from([this,...e.members])}without(e){return this.asGroup().without(e)}filter(e){return this.asGroup().filter(e)}forEach(e){return this.asGroup().forEach(e)}map(e){return this.asGroup().map(e)}find(e){return this.asGroup().find(e)}sort(e){return this.asGroup().sort(e)}findInnerMostHex(){return this}findMax(e){return this}floodFillFrom(e,t){return e}customSearchFrom(e,t,i){return o.HexGroup.from([this]).customSearchFrom(e,t,i)}findNeighbour(e){for(let t of g){const i=n.HexGrid.getHex({x:this.x+t[0],y:this.y+t[1]});if(i&&e(i))return i}}neighboursBitmap(e){let i=0;for(let s of t.HEX_DIRECTIONS){const t=this.neighbour(s);i<<=1,t&&e(t,s)&&++i}return i}disjointedNeighbourGroupsOf(e){return new r.default}}t.Hex=y;class f{constructor(e){this.hex=e,this.width=c.HEX_WIDTH,this.height=c.HEX_HEIGHT}get left(){return this.hex.x*c.HEX_WIDTH}get right(){return(this.hex.x+1)*c.HEX_WIDTH}get top(){return this.hex.y*c.HEX_INNER_HEIGHT}get bottom(){return this.hex.y*c.HEX_INNER_HEIGHT+c.HEX_HEIGHT}get centerX(){return this.hex.x*c.HEX_WIDTH+c.HALF_HEX_WIDTH}get centerY(){return this.hex.y*c.HEX_INNER_HEIGHT+c.HALF_HEX_HEIGHT}getCornerPoint(e){return{x:this.centerX+m[e][0]*c.HEX_WIDTH,y:this.centerY+m[e][1]*c.HEX_HEIGHT}}}t.HexDisplayDelegate=f,t.neighbourBitmapHasDirection=function(e,t){return!!(e&1<<5-t)}},35935:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexCorner=void 0;const s=i(24794),n=i(12678),a=i(34198);class o{constructor(e){this.sortedHexes=e.sort(((e,t)=>e.id-t.id)),this.id=r(...e),this.variant=this.sortedHexes[0].y===this.sortedHexes[1].y?"V":"A","A"===this.variant?this.display={x:this.sortedHexes[0].display.centerX,y:this.sortedHexes[0].display.centerY+a.HEX_HEIGHT/2}:this.display={x:this.sortedHexes[0].display.centerX+a.HEX_WIDTH/2,y:this.sortedHexes[0].display.centerY+.25*a.HEX_HEIGHT}}static byId(e){if(!this.cache[e]){const t=e.split(".").map((e=>(0,s.getHex)(Number(e))));(0,n.assert)(3===t.length,`invalid cornerId ${e}`),this.cache[e]=new o(t)}return this.cache[e]}static fromHexes(...e){const t=r(...e.sort(((e,t)=>e.id-t.id)));return this.byId(t)}static fromHexAndDirection(e,t){return o.fromHexes(e,...e.neighboursByCornerDirection(t))}}function r(e,t,i){return i?[e,t,i].map((e=>e.id)).sort(((e,t)=>e-t)).join("."):e.id>t.id?`${t.id}.${e.id}`:`${e.id}.${t.id}`}t.HexCorner=o,o.cache={}},24794:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getHexes=t.getHex=t.HexGrid=t.GRID_MAX_DIMENSION=void 0;const s=i(54444),n=i(45341),a=i(92288),o=i(78179);i(48500).logger.for("HexGrid"),t.GRID_MAX_DIMENSION=100;class r{constructor(){}static getHex(e){if(void 0!==e&&this.isWithinBounds(e,{width:t.GRID_MAX_DIMENSION,height:t.GRID_MAX_DIMENSION}))return(0,a.isOrdinal)(e)?(this._hexes[e]||(this._hexes[e]=new n.Hex(e)),this._hexes[e]):this.getHex(this.toOrdinal(e))}static getAllHexes(e){const t=Array(e.width*e.height).fill(void 0);for(let i=0;i<e.height;++i)for(let s=0;s<e.width;++s)t[i*e.width+s]=(0,a.tabularToOrdinal)({r:i,c:s});return o.HexGroup.from(t.map((e=>c(e))))}static getHexes(e){return o.HexGroup.from(e.map((e=>this.getHex(e))))}static filter(e,t){return this.getAllHexes(t).filter(e)}static getInnerHexes(e){return this.getAllHexes(e).filter((t=>!this.isHexOnGridBorder(t,e)))}static isWithinBounds(e,t){if((0,a.isTabular)(e))return!(e.c>=t.width||e.c<0||e.r>=t.height||e.r<0);if((0,a.isOrdinal)(e))return this.isWithinBounds((0,a.ordinalToTabular)(e),t);if((0,a.isSpatial)(e))return this.isWithinBounds((0,a.spatialToTabular)(e),t);throw new Error(`HexGrid.isOutOfBounds called with invalid grid position (${(0,s.str)(e)})`)}static isHexOnGridBorder(e,i){return e.id<t.GRID_MAX_DIMENSION||e.id%t.GRID_MAX_DIMENSION==0||e.id%t.GRID_MAX_DIMENSION==i.width-1||Math.floor(e.id/t.GRID_MAX_DIMENSION)===i.height-1}static toOrdinal(e){if((0,a.isOrdinal)(e))return e;if((0,a.isTabular)(e))return(0,a.tabularToOrdinal)(e);if((0,a.isSpatial)(e))return(0,a.tabularToOrdinal)((0,a.spatialToTabular)(e));throw new Error(`HexGrid.toOrdinal called with invalid grid position (${(0,s.str)(e)})`)}static bfs(e,t=(()=>!0)){let i=[];e.forEach((e=>i.push({hex:e,d:0})));let s=new Set(e);const n=({hex:e,d:n,parent:a})=>{s.add(e),t(e,a,n)&&e.neighbours().filter((e=>!s.has(e))).members.forEach((t=>{s.add(t),i.push({hex:t,d:n+1,parent:e})}))};for(;i.length>0;)n(i.shift())}}function c(e){return r.getHex(e)}t.HexGrid=r,r.upperBound=t.GRID_MAX_DIMENSION*t.GRID_MAX_DIMENSION-1,r._hexes=[],t.getHex=c,t.getHexes=function(e){return r.getHexes(e)}},92288:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.spatialToTabular=t.tabularToOrdinal=t.tabularToSpatial=t.ordinalToTabular=t.isOrdinal=t.isTabular=t.isSpatial=void 0;const s=i(24794);t.isSpatial=function(e){return e.hasOwnProperty("x")},t.isTabular=function(e){return e.hasOwnProperty("r")},t.isOrdinal=function(e){return"number"==typeof e},t.ordinalToTabular=function(e){return{r:Math.floor(e/s.GRID_MAX_DIMENSION),c:Math.floor(e%s.GRID_MAX_DIMENSION)}},t.tabularToSpatial=function({r:e,c:t}){return{x:t-e%2/2,y:e}},t.tabularToOrdinal=function({r:e,c:t}){return e*s.GRID_MAX_DIMENSION+t},t.spatialToTabular=function({x:e,y:t}){return{r:t,c:Math.ceil(e)}}},41295:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexGridSectors=void 0;const s=i(24794);t.HexGridSectors=class{constructor(e){this.sectorSize=e,this.sectorsPerRow=Math.ceil(s.GRID_MAX_DIMENSION/this.sectorSize)}getSectorOf(e){const t=Math.floor(e.r/this.sectorSize),i=Math.floor(e.c/this.sectorSize);return t*this.sectorsPerRow+i}getSectorRect(e){return{x:e%this.sectorsPerRow*this.sectorSize-.5,y:Math.floor(e/this.sectorsPerRow)*this.sectorSize,width:this.sectorSize+.5,height:this.sectorSize+.5}}}},78179:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexGroup=t.HexFromGroupSelection=void 0;const n=s(i(20504)),a=i(85656),o=s(i(54485)),r=i(24794),c=i(12678);var l;!function(e){e.Random="random",e.Leftmost="leftmost",e.Rightmost="rightmost",e.Topmost="topmost",e.Bottommost="bottommost"}(l=t.HexFromGroupSelection||(t.HexFromGroupSelection={}));class d{constructor(e={},t){this.membersByIndex=e,this._membersList=t}get length(){return this.members.length}get members(){return this._membersList||(this._membersList=Object.values(this.membersByIndex),Object.freeze(this._membersList)),this._membersList}first(){return this.members[0]}[Symbol.iterator](){return this.members[Symbol.iterator]()}static from(e){const t={};e instanceof Set&&(e=Array.from(e));const i=e.filter((e=>void 0!==e));for(let e of i)t[e.id]=e;return new d(t,i)}static fromIds(e){return d.from(e.map(r.getHex))}static union(e){const t=(0,a.stripDuplicatesFrom)((0,a.mergeArrays)(...e.map((e=>e.members))));return d.from(t)}getDisplayBoundingBox(){if(0===this.length)return{x:0,y:0,height:0,width:0};let e=Number.MAX_SAFE_INTEGER,t=Number.MAX_SAFE_INTEGER,i=-Number.MAX_SAFE_INTEGER,s=-Number.MAX_SAFE_INTEGER;for(let n of this)(n.display.left<e??Number.MAX_SAFE_INTEGER)&&(e=n.display.left),n.display.right>i&&(i=n.display.right),n.display.top<t&&(t=n.display.top),n.display.bottom>s&&(s=n.display.bottom);return{x:e,y:t,width:i-e,height:s-t}}getHex(e){if(0===this.length)return;if(!e)return this.members[0];let t;switch(e){case l.Leftmost:t=(e,t)=>t.x<e.x?t:e;break;case l.Rightmost:t=(e,t)=>t.x>e.x?t:e;break;case l.Topmost:t=(e,t)=>t.y<e.y?t:e;break;case l.Bottommost:t=(e,t)=>t.y>e.y?t:e}return c.assert.defined(t),this.members.reduce(t)}toIdsArray(){return this.members.map((e=>e.id))}toArray(){return[...this.members]}has(e){return!!this.membersByIndex[e.id]}contains(e){return void 0!==e&&this.hasId(e.id)}hasId(e){return!!this.membersByIndex[e]}border(e=!0){return this.filter((t=>{const i=t.neighbours();return!!(e&&i.length<6)||!!i.find((e=>!this.has(e)))}))}borderIncludingShoreline(){return this.border(!0)}neighbours(){return d.union(this.map((e=>e.neighbours().filter((e=>!this.has(e))))))}neighboursOf(e){return e.neighbours((e=>this.has(e)))}components(e=(()=>!0)){let t=new n.default,i=1;const s=(t,i)=>!i||e(t,i);return this.forEach((e=>{t.getOwnerOf(e)||(t.addToGroup(i,e),t.addToGroup(i,...this.floodFillFrom(e,s)),++i)})),t}with(e){return Array.isArray(e)?d.from([...this.members,...e]):d.from([...this.members,...e.members])}without(e){const t={...this.membersByIndex};return e.forEach((e=>delete t[e.id])),new d(t)}filter(e){return d.from(this.members.filter(e))}forEach(e){return this.members.forEach(e)}map(e){return this.members.map(e)}find(e){return this.members.find(e)}sort(e){return this.members.sort(e)}bfsFrom(e,t=(()=>!0)){let i=[];e.forEach((e=>i.push({hex:e,d:0})));let s=new Set(e);const n=({hex:e,d:n,parent:a})=>{s.add(e),t(e,a,n)&&e.neighbours().filter((e=>this.has(e)&&!s.has(e))).members.forEach((t=>{s.add(t),i.push({hex:t,d:n+1,parent:e})}))};for(;i.length>0;)n(i.shift())}floodFillOut(e=(()=>!0)){let t=[];this.forEach((e=>t.push({hex:e,d:0})));let i=new Set(this);for(;t.length>0;)s(t.shift());return d.from(Array.from(i));function s({hex:s,d:n,parent:a}){if(e(s,a,n)){i.add(s);const e=s.neighbours().filter((e=>!i.has(e))).members;for(let a of e)i.add(a),t.push({hex:a,d:n+1,parent:s})}}}customSearchFrom(e,t,i){let s=new o.default(((e,t)=>t.score-e.score));e.forEach((e=>s.push({hex:e,d:0,score:i(e)})));let n=new Set(e);const a=({hex:e,d:a,parent:o})=>{n.add(e),t(e,o,a)&&e.neighbours().filter((e=>this.has(e)&&!n.has(e))).members.forEach((t=>{n.add(t),s.push({hex:t,d:a+1,score:i(t),parent:e})}))};for(;s.size()>0;)a(s.pop())}findClosest(e,t){let i;return this.bfsFrom(e,(e=>!(i||t(e)&&(i=e,1)))),i}toString(){const e=this.members.slice(0,3).map((e=>e.toString())).join(",")+(this.length>3?",...":"");return`[HexGroup (${this.length}⬡): ${e}]`}findInnerMostHex(){let e=this,t=this;for(;t.length>0;)e=t,t=t.without(t.border());return e.findMax((e=>e.neighbours((e=>this.has(e))).length))}findMax(e){return this.members.reduce(((t,i)=>{const s=e(i);return s>t.score?{score:s,hex:i}:t}),{hex:void 0,score:Number.MIN_SAFE_INTEGER}).hex}floodFillFrom(e,t){const i=[...e.members];return this.bfsFrom(e,((e,s,n)=>!s||!!t(e,s,n)&&(i.push(e),!0))),d.from(i)}getCorners(){return(0,a.stripDuplicatesFrom)(this.members.map((e=>e.getCorners())).flat())}hasCorner(e){return!!e.sortedHexes.find((e=>this.has(e)))}disjointedNeighbourGroupsOf(e){return e.disjointedNeighbourGroups((e=>this.has(e)))}}t.HexGroup=d,d.empty=new d({})},20504:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(78179),n=i(12678);t.default=class{constructor(){this.groups={},this.membership={},this._length=0}get length(){return this._length}addToGroup(e,...t){this.groups[e]?t.forEach((t=>this.groups[e].add(t))):this.groups[e]=new Set(t),t.forEach((t=>{const i=this.membership[t.id];void 0===i?(this.membership[t.id]=e,++this._length):i!==e&&(this.groups[i].delete(t),this.membership[t.id]=e,0===this.groups[i].size&&this.removeGroup(i))}))}getOwnerOf(e){return this.membership[e.id]}removeGroup(e){n.assert.defined(this.groups[e]),this.groups[e].forEach((e=>delete this.membership[e.id])),this._length-=this.groups[e].size,delete this.groups[e]}forEach(e){for(const t in this.groups)e(this.groups[t],t)}find(e){for(const t in this.groups)if(e(this.groups[t],t))return{key:t,hexes:this.groups[t]}}getGroupsAdjacentTo(e){let t={};const i=this.groups[e];if(!i)return[];const n=s.HexGroup.from(i);for(let e of n.neighbours()){const i=this.getOwnerOf(e);i&&(t[i]?t[i]++:t[i]=1)}return Object.entries(t).map((([e,t])=>({key:e,hexes:this.groups[e],borderSize:t})))}map(e){let t=[];return this.forEach(((i,s)=>t.push(e(Array.from(i),s)))),t}getLargestGroup(){const e=this.getLargestGroupKey();if(void 0!==e)return s.HexGroup.from(Array.from(this.groups[e]))}getLargestGroupKey(){let e,t,i=0;return this.forEach(((s,n)=>{s.size>i&&(i=s.size,e=s,t=n)})),t}popLargestGroup(){const e=this.getLargestGroupKey();if(e){const t=this.groups[e];return this.removeGroup(e),s.HexGroup.from(Array.from(t))}throw new Error("Attempt to pop() from empty log groups collection")}getGroups(){return Object.values(this.groups).map((e=>s.HexGroup.from(Array.from(e))))}keys(){return Object.keys(this.groups)}byKey(e){return{key:e,hexes:this.groups[e]||new Set}}toString(){let e=0,t=Object.keys(this.groups).map((t=>{const i=this.groups[t].size;return e+=i,`${t}(${i})`})).join(", ");return`[HexGroupsCollection (${e}): ${t}]`}}},34198:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HEX_POLYGON=t.HEX_COLLAR_HEIGHT=t.HEX_ANGLED_HEIGHT=t.HEX_INNER_HEIGHT=t.HALF_HEX_HEIGHT=t.HEX_HEIGHT=t.HALF_HEX_WIDTH=t.HEX_WIDTH=void 0,t.HEX_WIDTH=48,t.HALF_HEX_WIDTH=t.HEX_WIDTH/2,t.HEX_HEIGHT=48,t.HALF_HEX_HEIGHT=t.HEX_HEIGHT/2,t.HEX_INNER_HEIGHT=36,t.HEX_ANGLED_HEIGHT=t.HEX_HEIGHT-t.HEX_INNER_HEIGHT,t.HEX_COLLAR_HEIGHT=30,t.HEX_POLYGON=[[-.5,-.25],[0,-.5],[.5,-.25],[.5,.25],[0,.5],[-.5,.25]].map((([e,t])=>[e+.5,t+.5])).map((([e,i])=>({x:e*t.HEX_WIDTH,y:i*t.HEX_HEIGHT})))},95437:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CalculatedHexGroupValuationWithCache=void 0,t.CalculatedHexGroupValuationWithCache=class{constructor(){this.values={}}get(e){return this.values[e]||(this.values[e]=this.calculate(e)),this.values[e]}getHexIds(){return Object.keys(this.values).map((e=>Number(e)))}flush(){this.values={}}}},16972:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CustomHexGroupValuation=void 0;const s=i(85656),n=i(54444);class a{constructor(e){this.defaultValue=e,this.values={}}generateFrom(e,t){e.forEach((e=>{const i=t(e);void 0!==i&&i!==this.defaultValue&&this.set(e.id,t(e))}))}generateFromIds(e,t){e.forEach((e=>{const i=t(e);void 0!==i&&i!==this.defaultValue&&this.set(e,t(e))}))}set(e,t){this.values[e]=t}unset(e){delete this.values[e]}get(e){return this.values.hasOwnProperty(e)?this.values[e]:this.defaultValue}map(e){const t=new a(e(this.defaultValue,-1));return t.importDictionary(this.exportDictionary(e)),t}exportDictionary(e){return e?(0,s.mapDictionary)(this.values,e):this.values}toString(){return`[HexGroupValuation (default=${this.defaultValue})]`}dump(){return`{\n${Object.entries(this.values).map((([e,t])=>`${e}: ${(0,n.str)(t)}`)).join("\n")}\n}`}getHexIds(){return Object.keys(this.values).map((e=>Number(e)))}importDictionary(e){Object.keys(e).forEach((t=>this.values[t]=e[t]))}clear(){this.values={}}static fromDictionary(e,t){const i=new a(t);return i.importDictionary(e),i}static fromGroupsCollection(e,t){const i=new a(t);return e.forEach(((e,t)=>{e.forEach((e=>i.set(e.id,t)))})),i}}t.CustomHexGroupValuation=a},8037:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexGroupValuationFromStateEngine=void 0,t.HexGroupValuationFromStateEngine=class{constructor(e,t){this.state=e,this.dataSet=t}get(e){return this.state.get(this.dataSet,e)}getHexIds(){return this.state.getEntryIds(this.dataSet)}}},88261:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexGroupValuationWithHeap=void 0;const n=i(16972),a=s(i(54485));class o extends n.CustomHexGroupValuation{constructor(e,t){super(e),this.rankFn=t,this.clear()}set(e,t){super.set(e,t),this.heap.push({id:e,value:t})}pop(){const e=this.heap.pop();return void 0===e?e:super.get(e.id)!==e.value?this.pop():e}peek(){return this.heap.peek()}size(){return this.heap.size()}unset(e){super.unset(e)}clear(){super.clear(),this.heap=new a.default(((e,t)=>this.rankFn(e.value)-this.rankFn(t.value)))}}t.HexGroupValuationWithHeap=o},8352:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProxyHexGroupValuation=void 0,t.ProxyHexGroupValuation=class{constructor(e,t){this.parent=e,this.proxyFunc=t}get(e){return this.proxyFunc(this.parent.get(e),e)}getHexIds(){return this.parent.getHexIds()}}},39139:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConsoleLogger=void 0;const n=s(i(11227)),a=i(75071),o=i(48500);function r(e){return n.default.enabled("game:"+e)}t.ConsoleLogger=class{log(e,t,i,...s){const c=`[${t}] ${i}`;switch(e){case o.LogLevel.Trace:r(t)&&console.trace(c,...s);break;case o.LogLevel.Debug:(0,n.default)("game:"+t)(i,...s);break;case o.LogLevel.Error:console.error(Error(c),...s),a.ErrorTracking.captureNonFatalError({message:i,data:s},"logger.error");break;case o.LogLevel.Warning:console.warn(c,...s);break;case o.LogLevel.Info:console.info(c,...s)}}group(e,t){r(e)&&console.group(t)}groupEnd(e){r(e)&&console.groupEnd()}}},48500:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.logger=t.NamedLogger=t.RootLogger=t.LogLevel=void 0,function(e){e.Error="error",e.Warning="warning",e.Info="info",e.Debug="debug",e.Trace="trace"}(i=t.LogLevel||(t.LogLevel={}));class s{constructor(){this.transportsByName=new Map,this.loggersByModule=new Map}addTransport(e,t){this.transportsByName.set(e,t)}removeTransport(e){this.transportsByName.delete(e)}for(e){const t=this.loggersByModule.get(e)||new n(e,this);return this.loggersByModule.set(e,t),t}log(e,t,i,...s){for(let n of this.transportsByName.values())n.log(e,t,i,...s)}group(e,t){for(let i of this.transportsByName.values())i.group(e,t)}groupEnd(e){for(let t of this.transportsByName.values())t.groupEnd(e)}}t.RootLogger=s;class n{constructor(e,t){this.name=e,this.parentLogger=t}trace(e,...t){this.parentLogger.log(i.Trace,this.name,e,...t)}debug(e,...t){this.parentLogger.log(i.Debug,this.name,e,...t)}error(e,...t){this.parentLogger.log(i.Error,this.name,e,...t)}info(e,...t){this.parentLogger.log(i.Info,this.name,e,...t)}warning(e,...t){this.parentLogger.log(i.Warning,this.name,e,...t)}group(e){this.parentLogger.group(this.name,e)}groupEnd(){this.parentLogger.groupEnd(this.name)}}t.NamedLogger=n,t.logger=new s},54812:(e,t)=>{"use strict";function i(e,t,i){return Math.min(i,Math.max(t,e))}function s(e,t){return Math.log(t)/Math.log(e)}function n(e){return e>=0?1:-1}Object.defineProperty(t,"__esModule",{value:!0}),t.deltaToMultiplier=t.Probability=t.sign=t.logWithBase=t.cropNumber=void 0,t.cropNumber=i,t.logWithBase=s,t.sign=n,t.Probability={ofEither:(e,t)=>1-(1-e)*(1-t),ofAny:(...e)=>1-e.map((e=>1-e)).reduce(((e,t)=>e*t),1),ofEvery:(...e)=>e.reduce(((e,t)=>e*t),1)},t.deltaToMultiplier=function(e){return i(.8*s(3,Math.pow(Math.abs(e),.7)+1)*n(e)+1,.25,2)}},87262:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Observer=void 0;const s=i(88865);t.Observer=class{constructor(e){this.isActive=e,this._deferredHandlers=new Map,this._subs=[]}wakeUp(){this._deferredHandlers.forEach((e=>e())),this._deferredHandlers.clear()}event(e,t){this._subs.push(s.inject.events.on(e,((e,i)=>{this.isActive()&&t.apply(this,[e,i])})))}signal(e,t){this._subs.push(e(((...e)=>{this.isActive()&&t.apply(this,e)})))}watch(e,t){this._subs.push(e.watch(((e,i)=>{this.isActive()?t.apply(this,[e,i]):this._deferredHandlers.set(t,(()=>t.apply(this,[e,i])))})))}destroy(){this._subs.forEach((e=>e.unsubscribe())),this._deferredHandlers.clear()}}},65375:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.deepWatchable=void 0;const n=s(i(22658));t.deepWatchable=function(e){let t=(0,n.default)(e,(function(){s.forEach((e=>e(t,i))),i=t})),i=e,s=[];function a(){return t}return a.watch=function(e){s.push(e),e(t,void 0)},a.watchFuture=function(e){s.push(e)},new Proxy(a,{get:(e,i,s)=>a.hasOwnProperty(i)?a[i]:t[i]})}},21103:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.watchable=void 0;const s=i(85656);t.watchable=function(e){let t,i=e,n=[];function a(){return i}return a.set=e=>{i!==e&&(i=e,n.forEach((e=>e(i,t))),t=i)},a.watch=e=>{const t=a.watchFuture(e);return setTimeout((()=>e(i,void 0)),0),t},a.watchFuture=e=>(n.push(e),{unsubscribe:()=>(0,s.removeFromArrayInPlace)(n,e)}),a}},14711:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deterministicRandomHexFrom=t.createRandomGenerator=t.ID_TYPE=void 0;const s=i(86020),n=i(64296),a=i(88865),o=i(23441),r=2*Math.PI;t.ID_TYPE={User:{prefix:"u",size:8},Level:{prefix:"l",size:8},Error:{prefix:"e",size:8},Session:{prefix:"s",size:12}},t.createRandomGenerator=function(e){const t=(0,n.customAlphabet)("01234567890qwertzuiopasdfghjklyxcvbnmQWERTZUIOPASDFGHJKLYXCVBNM");function i(t=Math.floor(1e5*Math.random())){e=t}function o(){var t=1e4*Math.sin(e++);return t-Math.floor(t)}function c(e,t){return Math.floor(o()*(t-e+1))+e}return i(e),{reset:i,number:o,numberBetween:function(e,t){return o()*(t-e)+e},oneOf:function(e){return e[c(0,e.length-1)]},popFrom:function(e){return e.splice(c(0,e.length-1),1)[0]},hex:function(e){return e.members[c(0,e.length-1)]},property:function(e){var t,i=0;for(var s in e)o()<1/++i&&(t=s);return t},integerBetween:c,shuffle:function(e){let t,i,s=[...e],n=s.length;for(;0!==n;)i=Math.floor(o()*n),n-=1,t=s[n],s[n]=s[i],s[i]=t;return s},boolean:function(e=.5){return o()<e},point:function(e){const t=e*Math.sqrt(o()),i=o()*r;return{x:t*Math.cos(i),y:t*Math.sin(i)}},townName:function(){return a.inject.random.oneOf(s.townNamePrefixes)+a.inject.random.oneOf(s.townNameSuffixes).toLowerCase()},id:function(e){return e.prefix+"-"+t(e.size)}}},t.deterministicRandomHexFrom=function(e,t){return a.inject.random.reset(e.currentPhase.turnNumber+t.toIdsArray().reduce(o.sum,0)),a.inject.random.hex(t)}},40056:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StateContainer=void 0,i(48500).logger.for("StateContainer"),t.StateContainer=function(e,t){let i=t;function s(){return i}return s.update=t=>{const s={...i,...t};e.applyState(t,s,i),i=s},s}},17281:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseUpdater=void 0,i(48500).logger.for("BaseUpdater"),t.BaseUpdater=class{constructor(e){this.dataSet=e,this.handlers=[],this.initFromState=e=>{this.newState=e,this.oldState=void 0,this.builder.init(e),this.initialize()},this.update=(e,t,i)=>(this.newState=e,this.changeSet=t,this.oldState=i,this.builder.init(e),this.initialize(),this.handlers.forEach((({dataSet:e,handler:t})=>{const i=this.changeSet.of(e);i&&t(i)})),this.createMutation()),this.registerHandlers(((e,t)=>this.handlers.push({dataSet:e,handler:t.bind(this)})))}createMutation(){return this.builder.createMutation("parents changed")}initialize(){}}},84341:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChangeSet=void 0;const s=i(12678),n=i(54444);t.ChangeSet=class{constructor(e){this.mutations=new Map,this.title="empty",e?.forEach((e=>this.add(e)))}add(e){s.assert.undefined(this.mutations.get(e.dataSet),`changeSet already contains mutation for "${e.dataSet.key}" (${(0,n.str)(e)})`),this.title=e.dataSet.key,this.mutations.set(e.dataSet,e)}all(){return Array.from(this.mutations.values())}of(e){return this.mutations.get(e)?.changes}require(e){const t=this.of(e);return s.assert.defined(t,`DataSet "${e.key}" not found in ${this}`),t}toString(){return`[ChangeSet<${Array.from(this.mutations.values()).map((e=>e.dataSet.key)).join(",")}>]`}}},98030:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isImmutableState=t.updateActiveDataSets=t.isProjectionDataSet=t.selectFromSuspendedState=t.selectFromState=t.getActiveProjections=t.getActiveDataSets=t.isDataSetActive=t.assertStateHasDataSet=t.getParentEngine=t.setParentEngine=t.applyMutations=t.createImmutableState=t.PARENT_ENGINE_KEY=t.ACTIVE_DATASETS_KEY=t.EMPTY_SET=void 0;const n=s(i(35369));function a(e){return e.get(t.PARENT_ENGINE_KEY)}function o(e,i){return e.get(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET).has(i)}function r(e){return e.get(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET)}function c(e){return!!e.bootstrap}t.EMPTY_SET=n.default.Set(),t.ACTIVE_DATASETS_KEY="_activeDataSets",t.PARENT_ENGINE_KEY="_parentEngine",t.createImmutableState=function(e,i){return n.default.Map({[t.ACTIVE_DATASETS_KEY]:n.default.Set(i),[t.PARENT_ENGINE_KEY]:e})},t.applyMutations=function(e,...t){const i=a(e);if(i.currentState!==e)throw new Error("Attempt to apply mutation to state that is no longer active in the parent engine");return i.apply(...t),i.currentState},t.setParentEngine=function(e,i){return e.set(t.PARENT_ENGINE_KEY,i)},t.getParentEngine=a,t.assertStateHasDataSet=function(e,t){if(!o(e,t))throw new Error(`dataSet ${t} not available in the state (available dataSets: ${r(e).map((e=>`"${e.key}"`)).join(",")})`)},t.isDataSetActive=o,t.getActiveDataSets=r,t.getActiveProjections=function(e){return r(e).filter((e=>c(e)))},t.selectFromState=function(e,t,i){if(!o(e,t))throw new Error(`dataSet ${t} not available in the state`);return void 0!==i?t.getEntryById(e,i):e.get(t.key)},t.selectFromSuspendedState=function(e,t,i){return t.getEntryById(e,i)},t.isProjectionDataSet=c,t.updateActiveDataSets=function(e,i){return e.update(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET,i)},t.isImmutableState=function(e){return n.default.Map.isMap(e)}},58089:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.mergeMutations=t.Mutator=t.StateEngine=void 0;const n=s(i(35369)),a=i(85656),o=i(48500),r=i(84341),c=i(54941),l=i(96486),d=i(54444),h=i(12678),u=i(98030),p=i(88865),g=o.logger.for("StateEngine");t.StateEngine=class{constructor(){this.roots={},this.projections={},this.pendingMutations=[],this.inTransaction=!1,this.children=new Map,this.watchers={},this.globalListeners=new Set,this.currentState=(0,u.createImmutableState)(this,[])}_addPrimary(e,t){return(0,h.assert)(!this.roots[t.key],`dataSet ${t.key} already exists in the state engine!`),this.roots[t.key]=t,e.set(t.key,t.defaultValue)}add(...e){let t=[];return e.forEach((e=>{(0,u.isProjectionDataSet)(e)?this._addProjection(e):(t.push(e),this.currentState=this._addPrimary(this.currentState,e))})),this._updateState((e=>(0,u.updateActiveDataSets)(e,(e=>e.union(n.default.Set(t)))))),this.updateSequence=this.getProjectionsBootstrapSequence(),this}suspend(...e){if(!e.length)return;const t=e.filter(u.isProjectionDataSet);this._mutateState((e=>{(0,u.updateActiveDataSets)(e,(e=>e.subtract(t)))}))}activate(...e){if(!e.length)return;const t=this.getProjectionsBootstrapSequence(e.filter((e=>!this.isDataSetActive(e))));this.currentState=this.currentState.deleteAll(t.map((e=>e.key)));const i=this.currentState;t.forEach((e=>{const t=e.bootstrap(this.currentState);this.currentState=this.currentState.set(e.key,t),this.currentState=(0,u.updateActiveDataSets)(this.currentState,(t=>t.add(e)))})),this._notifyWatchersAfterChanges(this.currentState,[],i,t)}activateAllProjections(){this.activate(...Object.values(this.projections))}suspendAllProjections(){this.suspend(...Object.values(this.projections))}activateOnly(...e){const t=new Set,i=[...e].filter(u.isProjectionDataSet);for(;i.length;){const e=i.pop();t.add(e),(0,u.isProjectionDataSet)(e)&&e.parents?.filter(u.isProjectionDataSet).forEach((e=>{e&&i.push(e)}))}const s=this.getActiveProjections().subtract(t);this.suspend(...s.toArray()),this.activate(...Array.from(t))}getActiveDataSets(){return(0,u.getActiveDataSets)(this.currentState)}getActiveProjections(){return this.getActiveDataSets().filter((e=>(0,u.isProjectionDataSet)(e)))}isDataSetActive(e){return this.getActiveDataSets().has(e)}_updateState(e){this.currentState=e(this.currentState)}_mutateState(e){this.currentState=this.currentState.withMutations(e)}_addProjection(e){this.projections[e.key]=e,e.parents.forEach((t=>{const i=this.children.get(t);i?i.push(e):this.children.set(t,[e])}))}beginTransaction(){p.inject.config.flags.mergeMutations&&(this.inTransaction=!0)}commitTransaction(){this.inTransaction=!1,this.pendingMutations.length&&(this.apply(...this.pendingMutations),this.pendingMutations.length=0)}apply(...e){if(this.inTransaction)this.pendingMutations&&(this.pendingMutations=y(this.pendingMutations,e));else{for(let t of e){const e=t.dataSet,i=this.roots[e.key];if(i!==e)throw void 0===i?this.projections[e.key]?new Error(`dataSet "${e.key}" is a projection, it cannot be updated manually!`):new Error(`no such dataSet: ${e.key}`):new Error(`dataSet mismatch for key "${e.key}" - registered instance in state engine is different than the instance passed into update()`)}this._applyMutationsAndNotifyWatchers(...e)}}_applyMutationsAndNotifyWatchers(...e){g.group(`New mutations from "${e[0]?.context}"]\n${e.map((e=>` • ${e.dataSet.key}: ${(0,d.str)(e.changes)}`)).join("\n")}`);const t=new m(this,e);return this.currentState=t.apply(),this._notifyWatchersAfterChanges(this.currentState,e,t.startingState,t.getChangedDataSets()),g.groupEnd(),this.currentState}_notifyWatchersAfterChanges(e,t,i,s){if(s[Symbol.iterator]().next().value){this.globalListeners.forEach((s=>s(e,t,i)));for(let n of s){const s=this.watchers[n.key];s&&s.forEach((s=>{s(e,t,i)}))}}}get(e,t){return this.assertActive(e),(0,u.selectFromState)(this.currentState,e,t)}setState(e){const t=this.currentState;this.currentState=(0,u.setParentEngine)(e,this);const i=this.getAllDataSets().filter((i=>e.get(i.key)!==t.get(i.key)));this._notifyWatchersAfterChanges(e,[],t,i)}getEntryIds(e){return e.getEntryIds(this.currentState)}serialize(){return(0,a.mapDictionary)(this.roots,((e,t)=>e.serialize(this.currentState.get(t))))}clear(){this.currentState=(0,u.createImmutableState)(this,this.getActiveDataSets())}watchAll(e){this.globalListeners.add(e)}watchDataSet(e,t){this.assertHas(e),(0,a.pushIntoArrayByKey)(this.watchers,e.key,t)}stopWatching(e,t){t?(0,a.removeFromArrayInPlace)(this.watchers[t.key]||[],e):this.globalListeners.delete(e)}assertActive(e,t){if(!this.isDataSetActive(e))throw this.assertHas(e,t),new Error(`DataSet ${e} is suspended`+(t?` (${t})`:""))}assertHas(e,t){const i=this.getDataSetByKey(e.key);if(i!==e){throw(e=>new Error(e+(t?` (${t})`:"")))(i?`DataSet with key "${e.key}" already exists, but is not the expected instance`:`DataSet with key "${e.key}" not found in the state engine`)}}getAllDataSets(){return n.default.Set([...Object.values(this.roots),...Object.values(this.projections)])}deserialize(e){const t=c.timing.start("ImmutableState deserialization");this.clear();for(let[t,i]of Object.entries(this.roots))try{this.currentState=this.currentState.set(t,i.deserialize(e[t]))}catch(i){throw i.message=`Failed to deserialize ${t} from ${JSON.stringify(e)} \n\n${i.message}`,i}this.getProjectionsBootstrapSequence().forEach((e=>{this.isDataSetActive(e)&&(this.currentState=this.currentState.set(e.key,e.bootstrap(this.currentState)))})),this._notifyWatchersAfterChanges(this.currentState,[],this.currentState,this.getAllDataSets()),t.complete()}sortProjections(e){const t=new Set(e);return this.getProjectionsBootstrapSequence(e).filter((e=>t.has(e)))}getProjectionsBootstrapSequence(e=Object.values(this.projections)){let t=Object.values(this.roots),i=[...t];return e.forEach((e=>{i.includes(e)||this._resolveDeps(e,"<root>",i)})),i.slice(t.length)}getDependencyMap(){let e={};return Object.values(this.roots).forEach((t=>{e[t.key]=this._getDepTree(t)})),e}getParentsMap(e){if((0,u.isProjectionDataSet)(e)){const t={};return e.parents.forEach((e=>t[e.key]=this.getParentsMap(e))),t}return"<root>"}_getDepTree(e){let t={};return this.assertHas(e),(this.children.get(e)||[]).forEach((e=>{t[e.key]=this._getDepTree(e)})),t}_resolveDeps(e,t,i,s=new Set){s.add(e),this.assertHas(e,`required by ${t}`);for(let n of e.parents)if(!i.includes(n)){if(!(0,u.isProjectionDataSet)(n))throw new Error(`missing primary dataSet ${n} (required by ${t})`);if(s.has(n))throw new Error(`circular reference detected: ${e} -> ${n}`);this._resolveDeps(n,e,i,s)}i.push(e),s.delete(e)}getDataSetByKey(e){return this.roots[e]||this.projections[e]}childrenOf(e){return this.children.get(e)||[]}transaction(e){this.beginTransaction();const t=e();return this.commitTransaction(),t}};class m{constructor(e,t){this.stateEngine=e,this.mutations=t,this.dirty=new Set,this.updated=new Set,this.changeSet=new r.ChangeSet,this.startingState=this.stateEngine.currentState,this.currentState=this.startingState}apply(){this.mutations.forEach((e=>{this.applyMutation(e)}));for(let e of this.stateEngine.updateSequence)this.dirty.has(e)&&this.stateEngine.isDataSetActive(e)&&this.resolve(e);return this.currentState}makeChildrenDirty(e){const t=this.stateEngine.childrenOf(e).filter((e=>this.stateEngine.isDataSetActive(e)));t.length,t.forEach((e=>this.dirty.add(e)))}resolve(e){(0,h.assert)(this.stateEngine.isDataSetActive(e),`Attempt to resolve suspended projection ${e}`);const t=e.update(this.currentState,this.changeSet,this.startingState);!t||void 0===t.changes||"object"==typeof t.changes&&(0,l.isEmpty)(t.changes)||this.applyMutation(t)}applyMutation(e){this.currentState=e.dataSet.apply(this.currentState,e.changes),this.changeSet.add(e),this.updated.add(e.dataSet),this.makeChildrenDirty(e.dataSet)}getChangedDataSets(){return this.updated}}function y(e,t){const i=new Map;for(let t of e)i.set(t.dataSet,t);for(let e of t){const t=i.get(e.dataSet);t?i.set(e.dataSet,{dataSet:e.dataSet,context:t.context+" -> "+e.context,changes:e.dataSet.mergeMutations(t.changes,e.changes)}):i.set(e.dataSet,e)}return Array.from(i.values())}t.Mutator=m,t.mergeMutations=y},54379:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LazyView=t.ViewCache=void 0,i(48500).logger.for("Selector");class s{constructor(e){this.parentDataSets=e}handleNewState(e,t=""){e!==this.lastState&&this.didParentDataSetsChangedInNewState(e,t)&&this.flush(),this.lastState=e}didParentDataSetsChangedInNewState(e,t){return this.parentDataSets.find((t=>e.get(t.key)!==this.lastState?.get(t.key)))}flush(){this.data={}}set(e,t){this.data[e]=t}get(e){return this.data[e]}has(e){return this.data.hasOwnProperty(e)}getOrCalculate(e,t){return void 0===e?t():(this.has(e)||this.set(e,t()),this.get(e))}}t.ViewCache=s,t.LazyView=class{constructor(e){this.cache=new s(e)}get(e,t){this.cache.handleNewState(e,this.name);const i=this.getCacheKey(t)?.toString();return this.cache.getOrCalculate(i,(()=>this.calculate(e,t)))}}},66206:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MapMutationBuilder=t.MapDataSet=void 0;const n=s(i(35369)),a=i(96486),o=i(98030),r=i(12678),c=i(85656);t.MapDataSet=class{constructor(e){this.key=e,this.defaultValue=n.default.Map()}deserialize(e){let t=n.default.Map();return Object.entries(e).forEach((([e,i])=>{t=t.set(Number(e),i)})),t}serialize(e){return e.toJS()}apply(e,t){return e.withMutations((e=>{t.updated?.forEach((([t,i])=>{void 0===i?e.deleteIn([this.key,t]):e.setIn([this.key,t],i)}))}))}createMutation(e,t){let i={updated:[]};if(e.set&&!(0,a.isEmpty)(e.set)&&(i.updated=Object.entries(e.set).map((([e,t])=>[Number(e),t]))),e.delete&&!(0,a.isEmpty)(e.delete)){const t=e.delete.map((e=>[e,void 0]));i.updated.push(...t)}return{dataSet:this,changes:i,context:`${this.key}/${t}`}}getEntryById(e,t){return e.getIn([this.key,t])}entryToString(e){return e.toString()}entryToDebugString(e){return JSON.stringify(e)}getEntryIds(e){return e.get(this.key)?.keySeq().toArray()||[]}toString(){return`[MapDataSet "${this.key}"]`}mergeMutations(e,t){const i=(0,c.dictionaryOf)(e.updated??[],0),s=(0,c.dictionaryOf)(t.updated??[],0);return Object.assign(i,s),{updated:Object.values(i)}}},t.MapMutationBuilder=class{constructor(e){this.dataSet=e}init(e){return this.state=e,this._entriesToSet={},this._entriesToDelete=new Set,this}set(e,t){return r.assert.defined(this.state,"builder not initialized!"),this._entriesToDelete.delete(e),this._entriesToSet[e]=t,this}setFromBootstrap(){r.assert.defined(this.state,"builder not initialized!"),(0,r.assert)((0,o.isProjectionDataSet)(this.dataSet),`Cannot call setFromBootstrap on ${this.dataSet} - it's not a projection`),this._entriesToSet=this.dataSet.bootstrap(this.state).toObject()}delete(e){r.assert.defined(this.state,"builder not initialized!"),delete this._entriesToSet[e],this._entriesToDelete.add(e)}getCurrent(e){if(r.assert.defined(this.state,"builder not initialized!"),!this._entriesToDelete.has(e))return this._entriesToSet.hasOwnProperty(e)?this._entriesToSet[e]:this.state.getIn([this.dataSet.key,e])}has(e){return!!this.get(e)}get(e){if(r.assert.defined(this.state,"builder not initialized!"),!this._entriesToDelete.has(e))return this._entriesToSet[e]}getEntries(){return r.assert.defined(this.state,"builder not initialized!"),this._entriesToSet}clear(){throw new Error("Not Implemented")}createMutation(e){return r.assert.defined(this.state,"builder not initialized!"),this.dataSet.createMutation({set:this._entriesToSet,delete:Array.from(this._entriesToDelete).filter((e=>void 0!==this.state.getIn([this.dataSet.key,e])))},e)}setAll(e,t){e.forEach((e=>this.set(e,t)))}}},69225:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MultiMapMutationBuilder=t.MultiMapDataSet=void 0;const n=i(96486),a=s(i(35369)),o=i(98030),r=i(12678),c=i(85656);t.MultiMapDataSet=class{constructor(e){this.key=e,this.defaultValue=a.default.Map()}deserialize(e){let t=a.default.Map();return Object.entries(e).forEach((([e,i])=>{t=t.set(Number(e),a.default.Set(i))})),t}serialize(e){return e.toJS()}apply(e,t){return e.withMutations((e=>{t.updated?.forEach((t=>{t.removed&&(e.updateIn([this.key,t.id],o.EMPTY_SET,(e=>e.subtract(t.removed))),e.getIn([this.key,t.id]).isEmpty()&&e.deleteIn([this.key,t.id])),t.added&&e.updateIn([this.key,t.id],o.EMPTY_SET,(e=>e.union(t.added)))}))}))}createMutation(e,t){let i={},s=e.remove&&Object.entries(e.remove).filter((([e,t])=>t.size)),a=e.add&&Object.entries(e.add).filter((([e,t])=>t.size));return(a&&!(0,n.isEmpty)(a)||s&&!(0,n.isEmpty)(s))&&(i.updated=[],a?.forEach((([t,s])=>{const n={id:Number(t),added:Array.from(s)};e.remove&&e.remove[t]?.size&&(n.removed=Array.from(e.remove[t])),i.updated.push(n)})),s?.forEach((([t,s])=>{const n=Number(t);e.add&&e.add[Number(n)]?.size||i.updated.push({id:Number(n),removed:Array.from(s)})}))),{dataSet:this,changes:i,context:`${this.key}/${t}`}}mergeMutations(e,t){const i=(0,c.dictionaryOf)((e.updated??[]).map((e=>({id:e.id,added:e.added&&[...e.added],removed:e.removed&&[...e.removed]}))),"id");for(let e of t.updated??[]){const t=i[e.id];let s=e.removed,n=e.added;t?(t.added&&e.removed&&(s=e.removed.filter((e=>!t.added.includes(e))),t.added=t.added.filter((t=>!e.removed.includes(t)))),t.removed&&e.added&&(n=e.added.filter((e=>!t.removed.includes(e))),t.removed=t.removed.filter((t=>!e.added.includes(t)))),t.added=t.added?(0,c.stripDuplicatesFrom)([...t.added,...n??[]]):e.added,t.removed=t.removed?(0,c.stripDuplicatesFrom)([...t.removed,...s??[]]):e.removed):i[e.id]=e}return{updated:Object.values(i)}}getEntryById(e,t){return e.getIn([this.key,t])}getEntryIds(e){return e.get(this.key).keySeq().toArray()}entryToString(e){return e.map((e=>e.toString())).toArray().join(",")}entryToDebugString(e){return e.map((e=>e.toString())).toArray().join(",")}toString(){return`[MultiMapDataSet "${this.key}"]`}},t.MultiMapMutationBuilder=class{constructor(e,t){this.dataSet=e,this._itemsToAdd={},this._itemsToRemove={},t&&this.init(t)}init(e){this.state=e,this._itemsToAdd={},this._itemsToRemove={}}add(e,...t){return this._itemsToAdd[e]||(this._itemsToAdd[e]=new Set),t.forEach((t=>{r.assert.defined(t),this._itemsToRemove[e]?.has(t)?this._itemsToRemove[e].delete(t):this.getCurrent(e).has(t)||this._itemsToAdd[e].add(t)})),this}has(e,t){return!this._itemsToRemove[e]?.has(t)&&!!this._itemsToAdd[e]?.has(t)}getCurrent(e){let t=this.dataSet.getEntryById(this.state,e)||o.EMPTY_SET;return this._itemsToRemove[e]&&(t=t.subtract(this._itemsToRemove[e])),this._itemsToAdd[e]&&(t=t.union(this._itemsToAdd[e])),t}currentHas(e,t){return!this._itemsToRemove[e]?.has(t)&&(!!this._itemsToAdd[e]?.has(t)||this.dataSet.getEntryById(this.state,e)?.has(t))}hasRemoved(e,t){return!!this._itemsToRemove[e]?.has(t)}remove(e,...t){this._itemsToRemove[e]||(this._itemsToRemove[e]=new Set),t.forEach((t=>{r.assert.defined(t),this._itemsToAdd[e]?.has(t)?this._itemsToAdd[e].delete(t):this.dataSet.getEntryById(this.state,e)?.has(t)&&this._itemsToRemove[e].add(t)}))}removeEntry(e){const t=this.dataSet.getEntryById(this.state,e);t&&t.size&&(delete this._itemsToAdd[e],this._itemsToRemove[e]=new Set(t.toArray()))}clear(){throw new Error("Not implemented")}createMutation(e){return this.dataSet.createMutation({add:this._itemsToAdd,remove:this._itemsToRemove},e)}}},63078:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SetDataSetMutationBuilder=t.SetDataSet=void 0;const n=s(i(35369)),a=i(98030),o=i(12678);t.SetDataSet=class{constructor(e){this.key=e,this.defaultValue=n.default.Set()}deserialize(e){return n.default.Set(e)}serialize(e){return e.toArray()}apply(e,t){let i=e.get(this.key);return t.addedEntries&&(i=i.union(t.addedEntries)),t.deletedEntries&&(i=i.subtract(t.deletedEntries)),e.set(this.key,i)}getEntryById(e,t){return e.get(this.key).has(t)}getEntryIds(e){return[]}entryToString(e){return e.toString()}entryToDebugString(e){return e.toString()}createMutation(e,t){let i={};return e.add&&e.add.length&&(i.addedEntries=e.add),e.delete&&e.delete.length&&(i.deletedEntries=e.delete),{dataSet:this,changes:i,context:`${this.key}/${t}`}}toString(){return`[SetDataSet "${this.key}"]`}mergeMutations(e,t){const i={addedEntries:e.addedEntries?[...e.addedEntries]:[],deletedEntries:e.deletedEntries?[...e.deletedEntries]:[]};let s=t.deletedEntries,n=t.addedEntries;return i.addedEntries&&t.deletedEntries&&(s=s.filter((e=>!i.addedEntries.includes(e)&&!i.deletedEntries.includes(e))),i.addedEntries=i.addedEntries.filter((e=>!t.deletedEntries?.includes(e)))),i.deletedEntries&&t.addedEntries&&(n=n.filter((e=>!i.deletedEntries.includes(e)&&!i.addedEntries.includes(e))),i.deletedEntries=i.deletedEntries.filter((e=>!t.addedEntries?.includes(e)))),i.addedEntries.push(...n??[]),i.deletedEntries.push(...s??[]),i.addedEntries.length||delete i.addedEntries,i.deletedEntries.length||delete i.deletedEntries,i}},t.SetDataSetMutationBuilder=class{constructor(e){this.dataSet=e}init(e){this.state=e,this._itemsToDelete=new Set,this._itemsToAdd=new Set}add(...e){o.assert.defined(this.state,"builder not initialized!"),e.forEach((e=>{this._itemsToDelete.has(e)?this._itemsToDelete.delete(e):this._itemsToAdd.add(e)}))}delete(...e){o.assert.defined(this.state,"builder not initialized!"),e.forEach((e=>{this._itemsToAdd.has(e)?this._itemsToAdd.delete(e):this._itemsToDelete.add(e)}))}createMutation(e){const t=(0,a.selectFromState)(this.state,this.dataSet);return this.dataSet.createMutation({add:Array.from(this._itemsToAdd).filter((e=>!t.has(e))),delete:Array.from(this._itemsToDelete).filter((e=>t.has(e)))},e)}clear(){o.assert.defined(this.state,"builder not initialized!");const e=this.state.get(this.dataSet.key);this._itemsToDelete=e,this._itemsToAdd.clear()}}},44175:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SingletonDataSet=void 0,t.SingletonDataSet=class{constructor(e,t){this.key=e,this.defaultValue=t}apply(e,t){return e.set(this.key,t)}deserialize(e){return e}serialize(e){return e}createMutation(e,t){return{dataSet:this,changes:e,context:t}}getEntryById(e,t){throw new Error(`Cannot extract entry ${t} from SingletonDataSet ${this.key} (SingletonDataSet has no entries)`)}entryToString(e){return""}entryToDebugString(e){return""}getEntryIds(e){return[]}toString(){return`[SingletonDataSet "${this.key}"]`}mergeMutations(e,t){return t}}},98993:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FilteredMultiMapProjection=void 0;const s=i(69225),n=i(98030);class a extends s.MultiMapDataSet{constructor(e,t,i=[]){super(e),this.key=e,this.filteredDataSet=t,this.parents=[t,...i]}bootstrap(e){return(0,n.selectFromState)(e,this.filteredDataSet).map((t=>t.filter((t=>this.constraint(e,t))))).filter((e=>!e.isEmpty())).map((t=>t.map((t=>this.transform(e,t)))))}update(e,t,i){const n=t.of(this.filteredDataSet);if(!n)return;const a=new s.MultiMapMutationBuilder(this,e);return n.updated?.forEach((t=>{let s=t.id;if(t.added&&a.add(s,...t.added.filter((t=>this.constraint(e,t))).map((t=>this.transform(e,t)))),t.removed){const n=this.getEntryById(e,s);if(!n)return;a.remove(s,...t.removed.filter((e=>this.constraint(i,e))).map((e=>this.transform(i,e))).filter((e=>n.has(e))))}})),a.createMutation(this.filteredDataSet.key)}}t.FilteredMultiMapProjection=a},98853:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.InvertedMapProjection=void 0;const n=i(85656),a=s(i(35369)),o=i(69225),r=i(98030);class c extends o.MultiMapDataSet{constructor(e,t){super(e),this.key=e,this.source=t,this.parents=[this.source]}bootstrap(e){const t=(0,r.selectFromState)(e,this.source);if(!t)return a.default.Map();const i=[];if(!a.default.Map.isMap(t))throw console.error(t),new Error(`${this.source.key} is invalid source for InvertedMapProjection: ${t} is not an Immutable.Map instance`);return t.forEach(((e,t)=>{(0,n.pushIntoArrayByKey)(i,e,t)})),s=i,a.default.Map().withMutations((e=>{for(let[t,i]of Object.entries(s))e.set(Number(t),a.default.Set(i))}));var s}update(e,t,i){const s=t.require(this.source),n=new o.MultiMapMutationBuilder(this,e);return s.updated?.forEach((([e,t])=>{const s=(0,r.selectFromState)(i,this.source,e);void 0!==s&&n.remove(s,e),void 0!==t&&n.add(t,e)})),n.createMutation(this.source.key+" changed")}entryToString(e){return`[${e.size}]`}}t.InvertedMapProjection=c},88380:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NextIdProjection=void 0;const s=i(23441),n=i(44175),a=i(98030);class o extends n.SingletonDataSet{constructor(e,t){super(e,1),this.source=t,this.parents=[this.source]}bootstrap(e){const t=(0,a.selectFromState)(e,this.source);return t?t.keySeq().reduce(s.pickLarger,0)+1:1}update(e,t,i){let s=(0,a.selectFromState)(i,this)||0,n=s;return t.require(this.source).updated?.forEach((e=>{if(Array.isArray(e)){const[t,i]=e;void 0!==i&&t>=n&&(n=t+1)}else{const t=e;t.added&&t.id>=n&&(n=t.id+1)}})),n!==s?this.createMutation(n,this.source.key):void 0}}t.NextIdProjection=o},69905:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stringToHash=t.compareStrings=t.prefixEachLineWith=t.padLeft=t.padRight=void 0,t.padRight=function(e,t){return e.length===t?e:e.length>t?e.slice(0,t):e+" ".repeat(t-e.length)},t.padLeft=function(e,t){return e.length===t?e:e.length>t?e.slice(0,t):" ".repeat(t-e.length)+e},t.prefixEachLineWith=function(e,t){return t.split("\n").map((t=>e+t)).join("\n")},t.compareStrings=function(e,t){return e>t?1:e<t?-1:0},t.stringToHash=function(e){var t,i=0;if(0===e.length)return i;for(e=e.toLowerCase(),t=0;t<e.length;t++)i=(i<<5)-i+e.charCodeAt(t),i|=0;return i}},54941:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timing=t.TimingHandle=t.Timing=void 0,i(48500).logger.for("timing");class s{start(e){return new n(e)}since(e){return Math.floor(performance.now()-e)}}t.Timing=s;class n{constructor(e){this.key=e,this.start=performance.now()}complete(e){return Math.ceil(performance.now()-this.start)}}t.TimingHandle=n,t.timing=new s},86020:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.townNameSuffixes=t.townNamePrefixes=void 0,t.townNamePrefixes=["Agate","Al","Amber","Amethyst","Ametrine","Ander","Apple","Arbor","Ard","Arrow","Ash","Ashen","Auburn","Autumn","Back","Bain","Baldur","Bane","Baron","Barron","Barrow","Basalt","Beach","Bear","Beech","Bell","Belle","Beryl","Big","Birch","Bitter","Black","Blade","Blue","Bog","Bone","Border","Boulder","Brass","Break","Breeze","Briar","Bridge","Brier","Bright","Brim","Burn","Castle","Cedar","Chamber","Chill","Cinder","Clay","Cold","Condor","Corner","Crab","Crag","Craw","Crown","Crystal","Dag","Dark","Day","Dead","Deep","Dire","Dragon","Drake","Draken","Dread","Dusk","Eagle","East","Ebon","Eden","Edge","Edin","Elder","Elm","Ember","Emerald","Ever","Fae","Fair","Faire","Fal","Fall","Fel","Fell","Fey","Fir","Fire","Flint","Fog","Fort","Free","Full","Gay","Gem","Glow","Gold","Grand","Granite","Grass","Grave","Gray","Green","Grey","Griffon","Gryphon","Guild","Half","Hallow","Hammer","Hard","Hawk","Heart","Hearth","Heath","Hedge","Hem","High","Hills","Hollow","Home","Hope","Horn","Iron","Jade","Jasper","Kent","Key","King","Kings","Kirk","Kraig","Lady","Lake","Larch","Law","Leaf","Ledge","Ley","Lime","Lion","Little","Liver","Loch","Lone","Love","Low","Lower","Maiden","Main","Man","Mans","Maple","Marble","Marsh","Mason","Mass","May","Mead","Meadow","Mid","Middle","Mine","Mist","Mithril","Moon","Mord","Moss","Mourn","Mud","Murk","Myst","Mythril","Nettle","Never","New","Night","North","Oak","Old","Onyx","Opal","Pale","Peace","Pike","Pine","Plum","Point","Pond","Port","Prince","Pyre","Queen","Queens","Quiet","Rain","Rainbow","Ram","Raven","Red","Redwood","Rex","Rich","Ridge","Ring","River","Rock","Rose","Ruby","Rune","Sage","Sand","Sapphire","Sea","Sedge","Shade","Sharp","Sharpe","Shatter","Shaw","Shell","Shield","Shire","Shore","Silver","Skull","Sky","Slade","Snow","Sound","South","Spine","Spring","Stan","Star","Still","Stock","Stone","Stony","Storm","Stout","Strath","Strom","Summer","Sun","Sunny","Sword","Tangle","Teak","Temple","Timber","Topaz","Torch","Tower","Tree","True","Tumble","Twin","Tyr","Umber","Umbur","Under","Upper","Wake","Wall","War","Water","Way","Wedge","West","Wet","Whet","Whit","White","Wild","Will","Willow","Win","Wind","Winter","Wolf","Wood","Wren","Wyn","Yew"],t.townNameSuffixes=["Back","Bank","Bard","Baron","Barron","Basin","Bay","Beach","Beck","Bell","Ben","Berg","Black","Bluff","Blum","Bog","Border","Borough","Bourg","Bourne","Brad","Brake","Breach","Breeze","Bridge","Brook","Burg","Burn","Bury","By","Call","Camp","Castle","Chester","City","Corner","Cott","Court","Cove","Crag","Creek","Crest","Cross","Crossroad","Crown","Dag","Dale","Dane","Dark","Deep","Del","Dell","Dike","Dorf","Drake","Dune","Edge","Encampment","End","Fair","Faire","Fal","Fall","Falls","Fast","Fax","Fel","Feldt","Fell","Felt","Field","Fire","Flint","Font","Ford","Forge","Forks","Forth","Full","Gard","Garde","Garden","Gardr","Gate","Gem","Gill","Glen","Glow","Grad","Grade","Grass","Grave","Grove","Guard","Guild","Hall","Hallow","Ham","Hamlet","Hand","Harbour","Haven","Head","Heart","Heed","Heim","Helm","Hill","Hold","Hollow","Holm","Holme","Holt","Home","Hood","Hope","Horse","Ington","Inlet","Island","Isle","Joy","Junction","Keep","Kraig","Lagoon","Lain","Lake","Land","Landing","Lands","Law","Leaf","Leap","Ledge","Letter","Light","Line","Lock","Lodge","Loft","Maiden","Mane","March","Marsh","Mass","Mead","Mere","Mesa","Mile","Mill","Mine","Mond","Mont","Moor","Mora","More","Morra","Mount","Mouth","Murk","Nook","Pad","Park","Pass","Path","Peak","Perch","Pier","Pike","Pine","Pines","Point","Pond","Pool","Poole","Port","Quarry","Quil","Quill","Quin","Quinn","Rain","Rapids","Ray","Reach","Reign","Rest","Ridge","Right","Ring","River","Rock","Roost","Rose","Roth","Rott","Row","Rowe","Run","Rune","Ruun","Sand","Settlement","Shadow","Sharp","Sharpe","Shaw","Shield","Shine","Ship","Shire","Shore","Side","Sierra","Sigil","Snow","Sol","Son","Sor","Sound","Spear","Spot","Square","Stad","Stain","Stane","Star","Station","Stead","Steppe","Stock","Ston","Stone","Stow","Strand","Strike","Summit","Sword","Sworth","Tarn","Tear","Thorn","Thorne","Thorpe","Throw","Ton","Tower","Town","Township","Trail","Tucket","Vale","Valley","Valt","Vanguard","Vault","Veldt","View","Village","Ville","Wake","Wall","Ward","Wash","Watch","Water","Way","Weald","Well","Wharf","Wheel","Wich","Wick","Wild","Wile","Will","Wind","Wing","Wolf","Wolfe","Wood","Worth","Wright","Wyn"],new Map([["Animals",["Badger","Bat","Boar","Buck","Bull","Calf","Canary","Cat","Cattle","Chick","Chicken","Clam","Cob","Cock","Cockatiel","Cockatoo","Cockerel","Cockle","Colt","Cow","Crab","Crow","Cub","Deer","Doe","Dog","Donkey","Dove","Drake","Dray","Duck","Duckling","Ewe","Eyas","Fawn","Ferret","Foal","Fox","Frog","Gander","Gerbil","Goat","Goose","Gosling","Hamster","Hare","Hawk","Hedgehog","Hen","Heron","Horse","Jack","Jenny","Jill","Kid","Kingfisher","Kit","Kitten","Lamb","Leveret","Lobster","Mare","Mole","Mouse","Mussel","Nanny","Newt","Otter","Owl","Owlet","Oyster","Peachick","Peacock","Peafowl","Peahen","Pheasant","Pig","Pigeon","Piglet","Pike","Prickle","Pup","Puppy","Rabbit","Ram","Rat","Robin","Rook","Salmon","Sheep","Signet","Snail","Snake","Sneak","Sow","Sparrow","Spider","Squab","Squirrel","Stag","Stallion","Starling","Stoat","Swan","Tiercel","Toad","Trout","Vixen","Weasel"]],["Geography",["Basin","Bay","Bluffs","Bush","Canal","Canyon","Cave","Cliff","Crag","Crater","Creek","Dale","Down","Falls","Fern","Flats","Forest","Fork","Glacier","Grotto","Heights","Hill","Hollow","Island","Knoll","Lagoon","Lake","Marsh","Mountain","Narrows","Overlook","Pass","Peak","Plain","Pond","Ravine","Reef","Ridge","River","Sound","Tree","Vale","Valley","Woods"]],["Geology",["Agate","Aluminum","Amber","Amethyst","Basalt","Brass","Bronze","Chalk","Chrome","Clay","Coal","Copper","Coral","Diamond","Emerald","Feldspar","Flint","Gold","Granite","Gypsum","Iron","Jade","Jasper","Lead","Limestone","Marble","Mercury","Mica","Pewter","Platinum","Pyrite","Quartz","Ruby","Sandstone","Shale","Silt","Silver","Slate","Steel","Tin","Topaz"]]])},12678:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssertionError=t.assert=void 0;const s=i(54444);function n(e,t=`expected ${e} to be truthy`){if(!e)throw new a(e,t)}t.assert=n,n.defined=(e,t=`expected ${e} to be defined`)=>{if(!(0,s.isDefined)(e))throw new a(e,t)},n.undefined=(e,t=`expected ${e} to be undefined`)=>{if((0,s.isDefined)(e))throw new a(e,t)},n.naturalNumber=(e,t=`expected ${e} to be a natural number`)=>{n("number"==typeof e&&e>0&&Math.floor(e)===e,t)};class a extends Error{constructor(e,t){t||(t="failed for value %s"),super(t.replace("%s",e?.toString()))}}t.AssertionError=a},54444:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getGlyphForRegionId=t.formatNumber=t.cleanse=t.singleton=t.isWholeNumber=t.dec2bin=t.numberToDots=t.prettyPrintObject=t.OBJECT_TO_STRING_WHITELIST=t.withSign=t.preventFreeze=t.sleep=t.withTimeout=t.TIMEOUT=t.deepFreeze=t.isDefined=t.decompressStr=t.compressStr=t.shallowStr=t.replaceClassObjects=t.describeSize=t.sizeOf=t.str=void 0;const n=s(i(95775)),a=s(i(4037)),o=i(85656),r=i(96486),c=i(88865),l=i(41707);function d(e){return"object"!=typeof e||null==e?e:Array.isArray(e)?e.map(d):"Object"!==e.constructor.name?`[${e.constructor.name}]`:(0,o.mapDictionary)(e,(e=>d(e)))}function h(e){return new Promise((t=>setTimeout(t,e)))}function u(e){return e>=1e3?e.toFixed():parseFloat(e.toPrecision(3))}t.str=function(e,t){if(void 0===e)return"";e=d(e);const i=(0,n.default)(e);return t&&i.length>t?i.slice(0,t)+"(...)":i},t.sizeOf=function e(t){return t?Array.isArray(t)?new Blob(t).size:"object"==typeof t?new Blob(Object.values(t)).size:e([t]):0},t.describeSize=function(e){return e<1e3?`${e} bytes`:e<1e6?`${(e/1e3).toFixed(1)} KB`:`${(e/1e6).toFixed(1)} MB`},t.replaceClassObjects=d,t.shallowStr=function(e){return(0,n.default)(e,((e,t)=>e&&t&&"number"!=typeof t?Array.isArray(t)?"[object Array]":""+t:t))},t.compressStr=function(e){return a.default.compress(e,{outputEncoding:"StorageBinaryString"})},t.decompressStr=function(e){return a.default.decompress(e,{inputEncoding:"StorageBinaryString"})},t.isDefined=function(e){return null!=e},t.deepFreeze=function e(t){const i=Object.getOwnPropertyNames(t);for(const s of i){const i=t[s];i&&"object"==typeof i&&e(i)}return Object.freeze(t)},t.TIMEOUT=Symbol("TIMEOUT"),t.withTimeout=function(e,i,s){return Promise.race([i,new Promise((i=>{e.time.addEvent({delay:s,callback:()=>i(t.TIMEOUT)})}))])},t.sleep=h,t.preventFreeze=(0,r.throttle)(h.bind(void 0,0),10,{trailing:!0}),t.withSign=function(e,t=0){return e>=0?"+"+e.toFixed(t):e.toFixed(t)},t.OBJECT_TO_STRING_WHITELIST=new Set(["UnitsByMight"]),t.prettyPrintObject=function e(i,s=0){if(null==i)return String(i);const n=Array(s+1).join(" ");return Object.entries(i).map((([i,a])=>null==a?`${n}${i}: ⊘`:Array.isArray(a)?0===a.length?`${n}${i}: ⊘`:"object"!=typeof a[0]?`${n}${i}: ${a.join(",")}`:`${n}${i}:\n${a.map((t=>e(t,s+2))).join(`\n${n}  —————\n`)}`:"object"==typeof a&&null!==a?a.constructor===Object?`${n}${i}:\n${e(a,s+2)}`:t.OBJECT_TO_STRING_WHITELIST.has(a.constructor.name)?`${n}${i}: ${a.toString()}`:`${n}${i}: [${a.constructor.name}]`:"number"==typeof a?`${n}${i}: ${u(a)}`:`${n}${i}: ${a}`)).join("\n")},t.numberToDots=function(e){return e>8?"⣿":" ⠁⠃⠇⠏⠟⠿⡿⣿"[e]},t.dec2bin=function(e){return(e>>>0).toString(2)},t.isWholeNumber=function(e){return Math.floor(e)===e},t.singleton=function(e){let t;return{get:i=>(void 0===t&&(t=e(...i)),t)}},t.cleanse=function e(t){if(null==t)return t;if(Array.isArray(t))return t.map(e);if("object"==typeof t){const i={};for(let[s,n]of Object.entries(t))null!=n&&(i[s]=e(n));return i}return t},t.formatNumber=u,t.getGlyphForRegionId=function(e){const t=c.inject.gameStateModel.factions.byRegion(c.inject.gameStateModel.regions.byId(e));return t?.isAlive()?l.GLYPH.factions[t.themeIndex+1]:l.GLYPH.whiteFlag}},55958:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CallToActionForm=void 0;const s=i(70319),n=i(24917),a=i(5715),o=i(96465),r=i(4126),c=i(99694),l=i(58592);var d=Phaser.GameObjects.BitmapText;class h extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.title=new d(this.scene,0,0,n.BitmapFont.Main,"").setTint(a.Colors.glassUi.primaryText),this.content=new d(this.scene,0,0,n.BitmapFont.Small,"").setTint(a.Colors.glassUi.primaryText),this.submitButtonText=new d(this.scene,0,0,n.BitmapFont.Small,"OK").setTint(a.Colors.glassUi.primaryText),this.submitButton=new o.BoxButton(this.scene,0,0,{baseTexture:r.BoxTextures.DialogButton,downTexture:r.BoxTextures.DialogButtonDown,content:this.submitButtonText,width:200,height:36}),this.add([this.title,this.content,this.submitButton]),this.submitButton.onClicked((()=>{this.onSubmit?.()}))}applyProps(e){return this.title.setText(e.title),this.content.setText(e.content),this.submitButtonText.setText(e.action),this.onSubmit=e.onSubmit,this.preUpdate.makeDirty(),this}updateLayout(){this.title.setMaxWidth(this.width),this.content.setMaxWidth(this.width),c.Arrange.fromTopToBottomOld([this.title,this.content,this.submitButton],{x:0,y:0,originX:0,originY:0,spacing:10});const e=l.app.scene.globalUI.notifications.layout;this.submitButton.x=this.width/2-this.submitButton.width/2-(e.padding+e.spaceForIcon)/2,this.updateSize()}calculateHeight(){return this.submitButton.y+this.submitButton.height}}t.CallToActionForm=h},52104:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FeedbackForm=t.FeedbackFormMode=void 0;const s=i(70319),n=i(24917),a=i(5715),o=i(73190),r=i(99694),c=i(97569),l=i(78295),d=i(68930),h=i(68660),u=i(1909),p=i(91025),g=i(50668),m=i(88865),y=i(58592);var f,w=Phaser.GameObjects.BitmapText;!function(e){e.Minimal="minimal",e.SingleLine="single-line",e.Full="full",e.Thanks="thanks"}(f=t.FeedbackFormMode||(t.FeedbackFormMode={}));class v extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.title=new w(this.scene,0,0,n.BitmapFont.Main,"").setTint(a.Colors.glassUi.primaryText),this.subtitle=new w(this.scene,0,0,n.BitmapFont.Small,"").setTint(a.Colors.glassUi.primaryText),this.emotionPicker=new o.MiniButtonsRow(this.scene,[10,11,12,13,14].map((e=>`attitude-emoji/${e}`))),this.chosenEmotion=void 0,this.emailFieldLabel=new w(this.scene,0,0,n.BitmapFont.Mini,"").setTint(a.Colors.glassUi.primaryText),this.messageField=new l.TextArea(this.scene,{rows:1,placeholder:"You can also add a comment, if you wish!",onChange:()=>{this.mode===f.SingleLine&&this.setMode(f.Full)}}),this.emailField=new d.TextInput(this.scene,{width:160,placeholder:"email@example.com"}),this.socials=function(e,t=1){const i=u.UiBuilder.for(e);return i.hLayout({layoutPolicy:g.LayoutChildrenPolicy.None,originX:t,content:[i.text("You can also",n.BitmapFont.Mini,a.Colors.glassUi.primaryText),i.button(u.ButtonTemplate.MiniStealthButton,{text:"Tweet at me",icon:i.image("ui/icons/twitter",a.Colors.glassUi.primaryText).setScale(.5,.5),onClicked:()=>m.inject.events.trigger(p.UserActions.SendTweet())}),i.text("or",n.BitmapFont.Mini,a.Colors.glassUi.primaryText),i.button(u.ButtonTemplate.MiniStealthButton,{text:"Join the Discord server",icon:i.image("ui/icons/discord",a.Colors.glassUi.primaryText).setScale(.5,.5),onClicked:()=>m.inject.events.trigger(p.UserActions.JoinDiscord())})],originY:.5,spacing:6})}(this.scene),this.ui=u.UiBuilder.for(this.scene),this.submitButton=this.ui.button(u.ButtonTemplate.SmallRibbonButton,{text:"Send",onClicked:()=>{this.setMode(f.Thanks),this.props.onSubmit({email:this.emailField.text.trim()||void 0,comment:this.messageField.text.trim()||void 0,mood:this.chosenEmotion})}}),this.add([this.title,this.subtitle,this.emotionPicker,this.messageField,this.emailField,this.emailFieldLabel,this.socials,this.submitButton]),this.emailField.node.type="email",this.messageField.setVisible(!1),this.submitButton.setVisible(!1),this.socials.setVisible(!1),this.emotionPickerCtl=c.ButtonControllers.options({1:this.emotionPicker.buttons[0],2:this.emotionPicker.buttons[1],3:this.emotionPicker.buttons[2],4:this.emotionPicker.buttons[3],5:this.emotionPicker.buttons[4]}),this.emotionPickerCtl.onButtonClicked((({key:e,pointer:t})=>{this.emotionPickerCtl.selectButton(e),this.chosenEmotion=Number(e),this.messageField.visible||(this.messageField.setVisible(!0),this.preUpdate.makeDirty(),this.mode===f.Minimal&&this.setMode(f.SingleLine))}))}setMode(e){this.mode=e,this.preUpdate.force()}applyProps(e){this.props=e,e.chosenEmotion&&this.emotionPickerCtl.selectButton(e.chosenEmotion.toString()),this.mode=e.mode,this.chosenEmotion=e.chosenEmotion,this.titleText=e.title,this.subtitleText=e.subtitle,this.emailField.setValue(e.email??""),this.messageField.setValue(e.message??""),this.preUpdate.makeDirty(),e.autoFocus&&this.messageField.node.focus()}updateLayout(){switch(this.title.setMaxWidth(this.width),this.subtitle.setMaxWidth(this.width),this.mode===f.Thanks?(this.title.setText("Thank you so much!"),this.subtitle.setVisible(!1),this.emotionPicker.setVisible(!1)):(this.title.setText(this.titleText),this.subtitle.setVisible(!0),this.subtitle.setText(this.subtitleText),this.emotionPicker.setVisible(!0)),this.emailFieldLabel.setText((y.app.device.uiVariant()===h.UiVariant.Large?"<- ":"")+"Add email if you'd like to hear back from me!"),this.mode){case f.Thanks:case f.Minimal:this.messageField.setVisible(!1),this.socials.setVisible(!1),this.submitButton.setVisible(!1),this.emailField.setVisible(!1),this.emailFieldLabel.setVisible(!1);break;case f.SingleLine:this.messageField.setVisible(!0),this.socials.setVisible(y.app.device.uiVariant()===h.UiVariant.Large),this.submitButton.setVisible(!0),this.emailField.setVisible(!1),this.emailFieldLabel.setVisible(!1),this.messageField.resizeToRows(1),this.messageField.node.placeholder="You can also add a comment, if you wish!";break;case f.Full:this.messageField.setVisible(!0),this.messageField.node.placeholder="Write your message here",this.socials.setVisible(y.app.device.uiVariant()===h.UiVariant.Large),this.submitButton.setVisible(!0),this.emailField.setVisible(!0),this.emailFieldLabel.setVisible(!0),this.messageField.resizeToRows(3),this.messageField.displayHeight=this.messageField.height}this.messageField.width=this.width,r.Arrange.fromTopToBottomOld([this.title,this.subtitle,this.emotionPicker,this.messageField,...y.app.device.uiVariant()===h.UiVariant.Compact?[this.emailFieldLabel]:[],this.emailField,this.submitButton],{x:0,y:0,originX:0,originY:0,spacing:10}),this.socials.setPosition(this.width,this.submitButton.y+this.submitButton.height-this.socials.height),y.app.device.uiVariant()===h.UiVariant.Large&&this.emailFieldLabel.setPosition(this.emailField.x+this.emailField.displayWidth+8,this.emailField.y+this.emailField.displayHeight/2-this.emailFieldLabel.height/2),this.updateSize()}calculateHeight(){let e;switch(this.mode){case f.Thanks:e=this.title;break;case f.Minimal:e=this.emotionPicker;break;case f.SingleLine:case f.Full:e=this.submitButton}return e.y+e.height}}t.FeedbackForm=v},50211:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SurrenderForm=void 0;const s=i(70319),n=i(24917),a=i(5715),o=i(96465),r=i(4126),c=i(99694),l=i(58592),d=i(88865),h=i(91025),u=i(3691),p=i(68660),g=i(60807);var m=Phaser.GameObjects.BitmapText;class y extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.title=new m(this.scene,0,0,n.BitmapFont.Main,"Congratulations!").setTint(a.Colors.glassUi.primaryText),this.content=new m(this.scene,0,0,n.BitmapFont.Small,"Your rivals have lost all hope! Accept their surrender?").setTint(a.Colors.glassUi.primaryText),this.submitButtonText=new m(this.scene,0,0,n.BitmapFont.Small,"CLAIM VICTORY!").setTint(a.Colors.glassUi.primaryText),this.submitButton=new o.BoxButton(this.scene,0,0,{baseTexture:r.BoxTextures.DialogButton,downTexture:r.BoxTextures.DialogButtonDown,content:this.submitButtonText,width:200,height:36}),this.cancelButtonText=new m(this.scene,0,0,n.BitmapFont.Small,"I'M NOT DONE YET!").setTint(a.Colors.glassUi.primaryText),this.cancelButton=new o.BoxButton(this.scene,0,0,{baseTexture:r.BoxTextures.DialogButton,downTexture:r.BoxTextures.DialogButtonDown,content:this.cancelButtonText,width:200,height:36}),this.add([this.title,this.content,this.submitButton,this.cancelButton]),this.submitButton.onClicked((()=>{d.inject.events.trigger(h.UserActions.AcceptSurrender())})),this.cancelButton.onClicked((()=>{d.inject.ui.session.onDismissedSurrender(),g.track.interaction("dismiss_surrender"),l.app.scene.globalUI.notifications.clearToasts(u.NotificationScope.Level)}))}updateLayout(){this.title.setMaxWidth(this.width),this.content.setMaxWidth(this.width),c.Arrange.fromTopToBottomOld([this.title,this.content,this.submitButton,this.cancelButton],{x:0,y:0,originX:0,originY:0,spacing:16});const e=l.app.scene.globalUI.notifications.layout;l.app.device.uiVariant()===p.UiVariant.Compact?c.Arrange.alignX([this.submitButton,this.cancelButton],{x:this.width/2-e.padding,origin:.5}):(c.Arrange.leftToRight({content:[this.submitButton,this.cancelButton],spacing:10,x:this.width/2-e.padding,origin:.5}),c.Arrange.alignY([this.submitButton,this.cancelButton],{y:this.submitButton.y,origin:0})),this.updateSize()}calculateHeight(){return this.cancelButton.y+this.submitButton.height}}t.SurrenderForm=y},93632:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NotificationsManager=t.DETAILED_NOTIFICATIONS_WHITELIST=void 0;const s=i(43950),n=i(3691),a=i(8952),o=i(71234),r=i(1909),c=i(60807),l=i(88865),d=i(58592),h=i(50211);t.DETAILED_NOTIFICATIONS_WHITELIST=["intro1","l-intro-castles-v2","l-fracture"],t.NotificationsManager=class{constructor(){this.displayedFeedbackToast=void 0}get ui(){return this._builder||(this._builder=r.UiBuilder.for(d.app.scene.globalUI)),this._builder}get scene(){return d.app.scene.globalUI}add(e){return d.app.scene.globalUI.notifications.addToast(e)}close(e){d.app.scene.globalUI.notifications.closeToast(e)}toggleFeedback(){this.displayedFeedbackToast&&this.displayedFeedbackToast.visible?this.close(this.displayedFeedbackToast):(this.displayedFeedbackToast=(0,a.showFeedbackForm)(),c.track.interaction("open_feedback_form"))}askForLevelFeedback(e){this.displayedFeedbackToast&&this.displayedFeedbackToast.visible||setTimeout((()=>{this.displayedFeedbackToast=(0,a.askForLevelFeedback)(e)}),500)}uncaughtError(e){(0,s.showErrorNotification)(this.scene,e)}isTutorialLevel(){return t.DETAILED_NOTIFICATIONS_WHITELIST.includes(l.inject.ui.session.levelId)}movePreventedByPawn(e,t){if(0===t.length)return;if(!this.isTutorialLevel())return;const i=t.reduce(((e,t)=>t.might>e?.might?t:e));if(i.might>3)return;let s=i.faction===l.inject.gameStateModel.currentPhase.faction?`Cannot place ${e} on a tile that already has ${i.type}`:`This tile is protected by an enemy ${i.type}. We needed a stronger unit to capture it!`;this.add({category:n.NotificationCategory.InvalidUserActionHint,style:n.NotificationStyle.Default,scope:n.NotificationScope.Screen,timeout:2500,clickable:!0,icon:this.ui.image((0,o.getFrameForPawnType)(i.type)),cancelTimeoutOnHover:!1,content:this.ui.caption(s)})}regionDisaster(e,t,i){const s=this.add({style:n.NotificationStyle.Default,scope:n.NotificationScope.Screen,timeout:5e3,clickable:!0,icon:this.ui.image("ui/icons/alert"),cancelTimeoutOnHover:!0,content:this.ui.vLayout({spacing:10,content:[this.ui.caption(e),this.ui.paragraph(t)]}),onClicked:()=>{this.close(s);const e=i&&l.inject.gameStateModel.regions.byId(i);e&&e?.exists&&e.isAlive()&&d.app.screen.play.selectRegion(i,{clickEffect:!1,panCamera:!0})}});return s}warning(e,t){return this.add({style:n.NotificationStyle.Alert,scope:n.NotificationScope.Global,timeout:5e3,clickable:!0,icon:this.ui.image("ui/icons/alert"),cancelTimeoutOnHover:!0,content:this.ui.vLayout({spacing:10,content:[this.ui.caption(e),this.ui.paragraph(t)]})})}success(e,t,i="ui/icons/mail"){return this.add({style:n.NotificationStyle.Success,scope:n.NotificationScope.Global,timeout:5e3,clickable:!0,icon:this.ui.image(i),cancelTimeoutOnHover:!0,content:this.ui.vLayout({spacing:10,content:[this.ui.caption(e),this.ui.paragraph(t)]})})}claimVictory(){return this.add({style:n.NotificationStyle.Default,scope:n.NotificationScope.Level,category:n.NotificationCategory.SurrenderOffer,clickable:!1,icon:this.ui.image("ui/icons/campaign"),cancelTimeoutOnHover:!0,content:new h.SurrenderForm(d.app.scene.globalUI),onDismissed:()=>{l.inject.ui.session.onDismissedSurrender()}})}}},8952:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showFeedbackForm=t.askForLevelFeedback=void 0;const s=i(3691),n=i(52104),a=i(40009),o=i(60807),r=i(68660),c=i(88865),l=i(58592);function d(e,t,i){e.clickable=!0,e.icon.setFrame("ui/icons/heart"),e.preUpdate.makeDirty(),c.inject.userData.rememberChoice("feedbackEmail",i.email),c.inject.userData.saveFeedback({levelId:t,mood:i.mood,comment:i.comment,screen:l.app.navigator.currentScreen?.name??"",timestamp:Date.now()}),c.inject.events.trigger(a.ReportingEvents.SubmitFeedbackForm({levelId:t,email:i.email,mood:i.mood,comment:i.comment})),setTimeout((()=>l.app.scene.globalUI.notifications.closeToast(e)),1e3)}t.askForLevelFeedback=function(e){const t=new n.FeedbackForm(l.app.scene.globalUI);t.applyProps({mode:n.FeedbackFormMode.Minimal,title:"Thanks for playing! How did you like this level?",subtitle:"Your feedback matters!",email:c.inject.userData.recallChoice("feedbackEmail")??"",message:"",onSubmit:t=>d(i,e,t)});const i=l.app.scene.globalUI.notifications.addToast({category:s.NotificationCategory.FeedbackForm,style:s.NotificationStyle.Default,icon:new Phaser.GameObjects.Image(l.app.scene.globalUI,0,0,"atlas","ui/icons/please"),content:t,scope:s.NotificationScope.Level,onDismissed:()=>{c.inject.userData.rememberChoice("dismissedFeedbackForm",Date.now())}});return i},t.showFeedbackForm=function(){const e=c.inject.ui.selectedLevelId();if(!window.navigator.onLine)return l.app.notifications.warning("Feedback not available while offline.","Sorry, please try again when you are connected to the internet.\nSending feedback via messenger pigeons is not supported yet.");const t=new n.FeedbackForm(l.app.scene.globalUI);t.applyProps({mode:n.FeedbackFormMode.Full,email:c.inject.userData.recallChoice("feedbackEmail")??"",autoFocus:l.app.device.uiVariant()===r.UiVariant.Large,message:"",title:"Hi there!",subtitle:"\nI'm Mike, the developer behind this game, and I'd love to hear from you!\nBug reports, improvement ideas, or just a simple thank you, all feedback is much appreciated.\n",onSubmit:t=>d(i,e,t)});const i=l.app.scene.globalUI.notifications.addToast({style:s.NotificationStyle.Default,icon:new Phaser.GameObjects.Image(l.app.scene.globalUI,0,0,"atlas","ui/icons/please"),content:t,scope:s.NotificationScope.Global,cancelTimeoutOnHover:!0,onDismissed:()=>{o.track.ui.dismissFeedbackForm()}});return i}},43950:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showErrorNotification=void 0;var s=Phaser.GameObjects.Image;const n=i(3691),a=i(55958),o=i(58592),r=i(88865);function c(e){return window.navigator.onLine?`The game just encountered an unexpected error, sorry about that!\nAn error report was already sent and I will be looking into it!\n\nSince the game is now most likely stuck in a broken state, you should reload the page.\nDon't worry, you won't lose any progress!\n\n(error_id="${e}")`:`The game just encountered an unexpected error, sorry about that!\n\nSince the game is now most likely stuck in a broken state, you should reload the page.\nDon't worry, you won't lose any progress!\n\n(error_id="${e}")`}t.showErrorNotification=function(e,t){e.notifications.addToast({style:n.NotificationStyle.Alert,category:n.NotificationCategory.Error,icon:new s(o.app.scene.globalUI,0,0,"atlas","ui/icons/dead"),content:new a.CallToActionForm(o.app.scene.globalUI).applyProps({title:"Well... This was not supposed to happen.",content:c(t),action:"RELOAD",async onSubmit(){r.inject.ui.session.end({origin:"error/reload"}),await o.app.reporting.sendTelemetryEvents(),window.location.reload()}}),scope:n.NotificationScope.Global})}},58592:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setAppContext=t.app=void 0,t.setAppContext=function(e){if(t.app)throw new Error("phaser context already initialized");t.app=new Proxy(e,{get(e,t,i){if(e.hasOwnProperty(t))return Reflect.get(e,t,i);throw new Error(`attempted to access unitialized property "${String(t)}"`)}})}},24917:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DebugTextBox=t.BitmapFont=t.UNICODE_MAP=t.Fonts=void 0;const n=s(i(82260)),a=i(41707),o=i(58592);var r,c=n.default.GameObjects.Layer,l=n.default.GameObjects.BitmapText,d=n.default.GameObjects.Rectangle;t.Fonts=class{load(e){e.load.bitmapFont(r.Debug,"assets/fonts/debug.png","assets/fonts/debug.xml"),e.load.bitmapFont(r.Main,"assets/fonts/main.png","assets/fonts/main.xml"),e.load.bitmapFont(r.Mini,"assets/fonts/mini.png","assets/fonts/mini.xml"),e.load.bitmapFont(r.MiniBold,"assets/fonts/mini-bold.png","assets/fonts/mini-bold.xml"),e.load.bitmapFont(r.Small,"assets/fonts/small.png","assets/fonts/small.xml")}},t.UNICODE_MAP={"⬡":a.GLYPH.hex,"⚐":a.GLYPH.whiteFlag,"🚩":a.GLYPH.redFlag,"⚑":a.GLYPH.blackFlag,"👤":a.GLYPH.pawn,"♖":a.GLYPH.kingdom,"✓":a.GLYPH.checkMark,"❌":a.GLYPH.crossMark,"💂‍":a.GLYPH.pawns.milita,"⛔":a.GLYPH.error},function(e){e.Debug="Debug",e.Main="Main",e.Small="Small",e.Mini="Mini",e.MiniBold="MiniBold"}(r=t.BitmapFont||(t.BitmapFont={}));const h={origin:[0,0],backgroundOpacity:.2,padding:2,textAlign:l.ALIGN_LEFT,dropShadow:!0};t.DebugTextBox=class extends c{constructor(e,t,i,s,n){super(e),this.opts={...h,...n},e.add.existing(this),this.text=new l(e,t,i,o.app.device.isMobile()?r.Small:r.Debug,s,void 0,this.opts.textAlign).setOrigin(...this.opts.origin),this.background=new d(e,t,i,0,0,0,.25).setOrigin(0,0),this.opts.dropShadow&&this.text.setDropShadow(1,1,0,1),this.opts.backgroundOpacity>0&&this.add(this.background),this.add(this.text),this.updateBackgroundSize()}setPosition(e,t){return this.text.setPosition(e,t),this.background.setPosition(this.text.x-this.text.width*this.text.originX-this.opts.padding,this.text.y-this.text.height*this.text.originY-this.opts.padding),this}setText(e){return this.text.setText(e.replace(/./g,(e=>t.UNICODE_MAP[e]||e))),this.updateBackgroundSize(),this}updateBackgroundSize(){this.background.setPosition(this.text.x-this.text.width*this.text.originX-this.opts.padding,this.text.y-this.text.height*this.text.originY-this.opts.padding),this.background.setSize(this.text.width+2*this.opts.padding,this.text.height+2*this.opts.padding)}}},79432:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelScript=void 0;const s=i(38952),n=i(88865),a=i(58592),o=i(91025);t.LevelScript=class{constructor(e){this.module=e,this.subscriptions=[],this.tooltips=[],this.watchers=[]}onEvent(e,t){const i=n.inject.events.on(e,t);return this.subscriptions.push(i),i}watch(e,t){this.watchers.push(e.watchFuture(t))}addTooltip(e){const t=a.app.tooltips.show({...e,type:s.TooltipType.Permanent});return this.tooltips.push(t),t}goTo(e){void 0===e?n.inject.scriptRunner.setScript(void 0):n.inject.scriptRunner.setScript(this.module.name+"."+e)}setScript(e){void 0===e?n.inject.scriptRunner.setScript(void 0):n.inject.scriptRunner.setScript(e)}activate(){this.watch(n.inject.ui.sidebarMode,(e=>{e&&a.app.scene.globalUI.clearTooltips()})),this.onEvent(o.UserActions.OpenRollbackMenu,(()=>{a.app.scene.globalUI.clearTooltips()}))}deactivate(){this.subscriptions.forEach((e=>e.unsubscribe())),this.subscriptions=[],this.tooltips.forEach((e=>a.app.tooltips.removeTooltip(e))),this.tooltips=[],this.watchers.forEach((e=>e.unsubscribe())),this.watchers=[]}}},26037:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScriptModulesRegistry=void 0;const s=i(38437);t.ScriptModulesRegistry=class{constructor(){this.moduleCache={}}getScript(e){const t=e.split("."),i=this.getModule(t[0]);if(1===t.length)return i.main;{const e=i[t[1]];if(!e)throw Error(`script "${t[1]}" not found in module ${i.name}`);return e}}getModule(e){if(!this.moduleCache[e]){const t=s.ScriptModules[e];if(!t)throw Error(`level scripts module "${e}" not found`);this.moduleCache[e]=t(),this.moduleCache[e].name=e}return this.moduleCache[e]}}},38437:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScriptModules=void 0;const s=i(88793),n=i(67032),a=i(70017),o=i(69330),r=i(2563);t.ScriptModules={tutorial1:()=>new s.Tutorial1,tutorial2:()=>new n.Tutorial2,tutorial3:()=>new o.Tutorial3,tutorial4:()=>new r.Tutorial4,global:()=>new a.GlobalModule}},70017:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GlobalModule=void 0;const s=i(79432),n=i(91025),a=i(28367),o=i(92516),r=i(24794),c=i(88865),l=i(58592);t.GlobalModule=class{constructor(){this.main=new d(this),this.teachRewind_step1=new h(this),this.teachRewind_step2=new u(this),this.teachRetreat=new p(this)}};class d extends s.LevelScript{activate(){this.onEvent(n.GameStateEvents.FactionTurnStarted,(e=>{var t;!c.inject.userData.hasCompletedTutorial("rewind")&&1===e.factionId&&l.app.scene.playUI.activeUI.rewindButton&&c.inject.ui.session.remainingLives>0&&(t=l.app.worldNews.news,Object.values(t).some((e=>e.type===o.NewsEvents.TownRazed)))&&this.goTo("teachRewind_step1")}))}}class h extends s.LevelScript{activate(){this.addTooltip({placement:a.TooltipPlacement.overUiObject(l.app.scene.playUI.activeUI.undoButton),delayMs:1e3,icon:"ui/mini-icons/lightbulb",title:"Not happy with the outcome?\nClick here to rewind to last turn!"}),this.onEvent(n.WorldMapEvents.StartInteraction,(()=>{this.goTo("main")})),this.onEvent(n.UserActions.EndTurn,(()=>{this.goTo("main")})),this.onEvent(n.UserActions.OpenRollbackMenu,(()=>{this.goTo("teachRewind_step2")}))}}class u extends s.LevelScript{activate(){this.addTooltip({placement:a.TooltipPlacement.overUiObject(l.app.scene.playUI.activeUI.rewindButton),delayMs:300,enforceDelay:!0,icon:"ui/mini-icons/lightbulb",title:"You can do this 3 times per level!",displayBelow:!0}),this.onEvent(n.UserActions.StartRewind,(()=>{c.inject.userData.completeTutorial("rewind"),this.goTo("main")})),this.onEvent(n.UiEvents.RollbackMenuClosed,(()=>{this.goTo("teachRewind_step1")}))}}class p extends s.LevelScript{activate(){this.addTooltip({placement:a.TooltipPlacement.atWorldMapHex((0,r.getHex)(this.module.hexId)),delayMs:500,enforceDelay:!0,icon:"ui/mini-icons/lightbulb",title:"Units protected by walls will retreat instead of dying."}),c.inject.userData.completeTutorial("walls"),this.onEvent(n.WorldMapEvents.StartInteraction,(()=>{this.goTo("main")})),this.onEvent(n.UserActions.EndTurn,(()=>{this.goTo("main")}))}}s.LevelScript},88793:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TutorialStep=t.Tutorial1=void 0;const s=i(30420),n=i(12678),a=i(28367),o=i(24794),r=i(79432),c=i(91025),l=i(88865),d=i(58592),h=i(24275);t.Tutorial1=class{constructor(){this.step1_selectVillager=new m(this),this.step2_captureHex=new y(this),this.step3_buyAnotherVillager=new f(this),this.step4_mergeVillagers=new w(this),this.step5_undoMerge=new v(this),this.step6_buyAgain=new b(this),this.step7_captureAnotherHex=new S(this),this.step8_endTurn=new x(this),this.reselectRegion=new g(this),this.displayObjectives=new T(this),this.main=new u(this)}};class u extends r.LevelScript{activate(){l.inject.ai.maxAllowedUnitMight=2,l.inject.ai.allowSurrender=!1,1===l.inject.gameStateModel.currentPhase.turnNumber&&1===l.inject.gameStateModel.currentPhase.getMovablePawns().length?(d.app.scene.playUI.updateState({layout:{name:"hidden"}}),this.goTo("step1_selectVillager")):this.goTo("displayObjectives")}}class p extends r.LevelScript{activate(){super.activate(),this.onEvent(c.UserActions.EndTurn,(()=>{this.goTo("displayObjectives")})),this.onEvent(c.UiEvents.RegionSelected,(e=>{e||(this.module.storedStep=l.inject.scriptRunner.currentScriptName,this.goTo("reselectRegion"))}))}deactivate(){super.deactivate()}abortTutorial(){this.goTo("displayObjectives")}}t.TutorialStep=p;class g extends p{activate(){super.activate(),this.addTooltip({title:"Select your province",placement:a.TooltipPlacement.atWorldMapHex((0,o.getHex)(602)),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(c.UiEvents.RegionSelected,(e=>{e&&(this.module.storedStep?this.setScript(this.module.storedStep):this.goTo("displayObjectives"))}))}}class m extends p{activate(){super.activate();const e=l.inject.gameStateModel,t=e.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[s.PawnType.Villager]});if(!t)return this.goTo("displayObjectives");const i=t.hex.id;setTimeout((()=>{d.app.scene.worldMap.cameraController.scrollController.panTo(t.hex.display.centerX,t.hex.display.centerY)})),this.addTooltip({title:"Select villager",placement:a.TooltipPlacement.atWorldMapHex(t.hex),delayMs:500,icon:"ui/icons/hand"}),this.onEvent(c.WorldMapEvents.StartInteraction,(({hexId:e,flags:t})=>{e===i&&this.goTo("step2_captureHex")})),this.onEvent(c.GameStateEvents.HexCaptured,(()=>{this.goTo("step3_buyAnotherVillager")})),this.onEvent(c.UserActions.BuyablePawnPointerUp,(()=>{this.goTo("step4_mergeVillagers")}))}}class y extends p{activate(){super.activate(),d.app.scene.playUI.updateFromGameState(l.inject.currentGameState,"play");const e=l.inject.gameStateModel;if(!e.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[s.PawnType.Villager]}))return this.goTo("displayObjectives");this.addTooltip({title:"Expand your province!",placement:a.TooltipPlacement.atWorldMapHex((0,o.getHex)(504)),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(c.GameStateEvents.HexCaptured,(()=>{this.goTo("step3_buyAnotherVillager")})),this.onEvent(c.GameStateEvents.PawnMoved,(()=>{this.goTo("step1_selectVillager")})),this.onEvent(c.UserActions.ReturnHeldPawn,(()=>{this.goTo("step1_selectVillager")}))}}class f extends p{activate(){super.activate(),d.app.scene.playUI.updateFromGameState(l.inject.currentGameState,"play"),this.addTooltip({title:"Recruit another villager",placement:a.TooltipPlacement.overUiObject(d.app.scene.playUI.activeUI.shoppingTray.pawnSprites[s.PawnType.Villager]),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(c.UserActions.BuyablePawnPointerDown,(e=>{e===s.PawnType.Villager&&this.goTo("step4_mergeVillagers")})),this.onEvent(c.UserActions.Undo,(()=>{this.goTo("step1_selectVillager")}))}}class w extends p{activate(){super.activate();const e=l.inject.gameStateModel,t=e.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[s.PawnType.Villager]});if(!t)return this.goTo("displayObjectives");const i=t.hex.id;this.addTooltip({title:"Get a stronger unit by merging two villagers together!",placement:a.TooltipPlacement.atWorldMapHex(t.hex),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(c.UiEvents.PawnReturnedToShop,(()=>{this.goTo("step3_buyAnotherVillager")})),this.onEvent(c.GameStateEvents.PawnBought,(e=>{e.destinationHexId===i?this.goTo("step5_undoMerge"):this.goTo("step8_endTurn")})),this.onEvent(c.GameStateEvents.HexCaptured,(e=>{this.goTo("step8_endTurn")})),this.onEvent(c.UserActions.Undo,(()=>{this.goTo("step1_selectVillager")}))}}class v extends p{activate(){super.activate();const e=l.inject.gameStateModel,t=l.inject.gameStateModel.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[s.PawnType.Pikeman]});if(!t)return this.abortTutorial();setTimeout((()=>d.app.scene.playUI.updatePlayLayout({primaryButton:"endTurn"})),0),this.addTooltip({title:"Nice! But beware that stronger units also cost\n more coins each turn to maintain!",placement:a.TooltipPlacement.atWorldMapHex(t.hex),delayMs:0}),this.addTooltip({title:"Let's reconsider! Click here to undo the last action.",placement:a.TooltipPlacement.overUiObject(d.app.scene.playUI.activeUI.undoButton),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(c.UserActions.Undo,(()=>{this.goTo("step6_buyAgain")})),this.onEvent(c.UserActions.EndTurn,(()=>{this.goTo("displayObjectives")}))}}class b extends p{activate(){super.activate(),this.addTooltip({title:"Recruit the villager again",placement:a.TooltipPlacement.overUiObject(d.app.scene.playUI.activeUI.shoppingTray.pawnSprites[s.PawnType.Villager]),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(c.UserActions.BuyablePawnPointerDown,(e=>{e===s.PawnType.Villager&&this.goTo("step7_captureAnotherHex")})),this.onEvent(c.UserActions.Undo,(()=>{this.goTo("displayObjectives")}))}}class S extends p{activate(){super.activate();const e=l.inject.gameStateModel,t=e.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[s.PawnType.Villager]}),i=e.factions.byId(1)?.getRegions()[0];if(!i)return this.abortTutorial();n.assert.defined(i);const o=e.warfare.getConquerableHexes(i,s.PawnType.Villager).first();if(!t||!o)return this.abortTutorial();this.addTooltip({title:"Capture another tile!",placement:a.TooltipPlacement.atWorldMapHex(o),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(c.GameStateEvents.HexCaptured,(()=>{this.goTo("step8_endTurn")})),this.onEvent(c.UserActions.ReturnHeldPawn,(()=>{this.goTo("step6_buyAgain")})),this.onEvent(c.UserActions.Undo,(()=>{this.goTo("displayObjectives")}))}}class x extends p{activate(){super.activate(),this.addTooltip({title:"End turn",placement:a.TooltipPlacement.overUiObject(d.app.scene.playUI.activeUI.endTurnButton),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(c.UserActions.EndTurn,(()=>{this.goTo("displayObjectives")})),this.onEvent(c.UserActions.Undo,(()=>{this.goTo("displayObjectives")}))}}class T extends r.LevelScript{activate(){super.activate(),this.addTooltip({title:"Get the bastard!",placement:a.TooltipPlacement.atWorldMapHex((0,o.getHex)(707)),delayMs:0,displayBelow:!0,icon:"ui/icons/star"});const e=this.addTooltip({title:"Expand here to boost your income",placement:a.TooltipPlacement.atWorldMapHex((0,o.getHex)(203)),icon:"ui/icons/star",delayMs:0}),t=d.app.scene.globalUI.sidebarButtons.buttons.find((e=>e.key===h.SideBarButtonKeys.Help));t&&t.visible&&!l.inject.ui.sidebarMode()&&this.addTooltip({title:"Click here for more hints",placement:a.TooltipPlacement.overUiObject(t),displayBelow:!0}),this.onEvent(c.UserActions.OpenRollbackMenu,(()=>{d.app.scene.globalUI.clearTooltips()}));const i=this.onEvent(c.GameStateEvents.HexCaptured,(()=>{s()}));function s(){const t=l.inject.gameStateModel.regions.byHex((0,o.getHex)(305))?.isAlive();t&&(d.app.tooltips.removeTooltip(e),i.unsubscribe())}s()}}},67032:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TutorialStep=t.Tutorial2=void 0;const s=i(30420),n=i(28367),a=i(24794),o=i(79432),r=i(91025),c=i(88865),l=i(58592);t.Tutorial2=class{constructor(){this.step1_buyCastle=new p(this),this.step2_placeCastle=new g(this),this.reselectRegion=new u(this),this.displayObjectives=new m(this),this.main=new d(this)}};class d extends o.LevelScript{activate(){c.inject.ai.maxAllowedUnitMight=2,1===c.inject.gameStateModel.currentPhase.turnNumber&&c.inject.gameStateModel.regions.byId(28)?.treasury?this.goTo("step1_buyCastle"):this.goTo("displayObjectives")}}class h extends o.LevelScript{activate(){super.activate(),this.onEvent(r.UserActions.EndTurn,(()=>{this.goTo("displayObjectives")})),this.watch(c.inject.ui.sidebarMode,(e=>{e&&l.app.scene.globalUI.clearTooltips()})),this.onEvent(r.UserActions.OpenRollbackMenu,(()=>{l.app.scene.globalUI.clearTooltips()})),this.onEvent(r.UiEvents.RegionSelected,(e=>{14!==e&&(this.module.storedStep=c.inject.scriptRunner.currentScriptName,this.goTo("reselectRegion"))}))}deactivate(){super.deactivate()}abortTutorial(){this.goTo("displayObjectives")}}t.TutorialStep=h;class u extends o.LevelScript{activate(){super.activate(),this.addTooltip({title:"Select province",placement:n.TooltipPlacement.atWorldMapHex((0,a.getHex)(807)),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(r.UserActions.EndTurn,(()=>{this.goTo("displayObjectives")})),this.onEvent(r.UiEvents.RegionSelected,(e=>{e&&(this.module.storedStep?this.setScript(this.module.storedStep):this.goTo("displayObjectives"))}))}}class p extends h{activate(){super.activate(),this.addTooltip({title:"Castles are a good way to protect key tiles,\n they cost less to maintain than soldiers.",placement:n.TooltipPlacement.overUiObject(l.app.scene.playUI.activeUI.shoppingTray.pawnSprites[s.PawnType.Castle]),delayMs:1e3,icon:"ui/icons/hand"}),this.onEvent(r.UserActions.BuyablePawnPointerDown,(e=>{e===s.PawnType.Castle?this.goTo("step2_placeCastle"):this.goTo("displayObjectives")}))}}class g extends h{activate(){super.activate(),c.inject.gameStateModel,this.addTooltip({title:"Place it here to keep the enemies at bay!",placement:n.TooltipPlacement.atWorldMapHex((0,a.getHex)(707)),delayMs:0,icon:"ui/mini-icons/lightbulb",displayBelow:!0}),this.onEvent(r.UserActions.ReturnHeldPawn,(()=>{this.goTo("step1_buyCastle")})),this.onEvent(r.GameStateEvents.PawnBought,(()=>{this.goTo("displayObjectives")}))}}class m extends o.LevelScript{activate(){super.activate()}}},69330:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tutorial3=void 0;const s=i(30420),n=i(28367),a=i(24794),o=i(79432),r=i(91025),c=i(88865);t.Tutorial3=class{constructor(){this.step1_waitForPikemanPickup=new d(this),this.step2_exploitWeakpoint=new h(this),this.step3_commentary=new u(this),this.main=new l(this)}};class l extends o.LevelScript{activate(){1===c.inject.gameStateModel.currentPhase.turnNumber&&c.inject.gameStateModel.currentPhase.getMovablePawns().length&&this.goTo("step1_waitForPikemanPickup")}}class d extends o.LevelScript{activate(){super.activate(),this.onEvent(r.UiEvents.PawnPickedUp,(({pawnType:e})=>{e===s.PawnType.Pikeman?this.goTo("step2_exploitWeakpoint"):this.goTo("main")})),this.onEvent(r.GameStateEvents.HexCaptured,(e=>{708===e.capturedHexId?this.goTo("step3_commentary"):this.goTo("main")}))}}class h extends o.LevelScript{activate(){super.activate(),c.inject.gameStateModel,this.addTooltip({title:"Enemy weakpoint",placement:n.TooltipPlacement.atWorldMapHex((0,a.getHex)(809)),delayMs:0,icon:"ui/mini-icons/lightbulb",displayBelow:!0}),this.onEvent(r.UserActions.ReturnHeldPawn,(()=>{this.goTo("step1_waitForPikemanPickup")})),this.onEvent(r.GameStateEvents.HexCaptured,(e=>{809===e.capturedHexId?this.goTo("step3_commentary"):this.goTo("main")}))}}class u extends o.LevelScript{activate(){super.activate(),c.inject.gameStateModel,this.addTooltip({title:"They loved your move!",placement:n.TooltipPlacement.atWorldMapHex((0,a.getHex)(407)),delayMs:1500,enforceDelay:!0,icon:"ui/mini-icons/lightbulb",displayBelow:!0}),this.addTooltip({title:"We've cut off the enemy pikeman!",placement:n.TooltipPlacement.atWorldMapHex((0,a.getHex)(1008)),delayMs:200,enforceDelay:!0,icon:"ui/mini-icons/lightbulb",displayBelow:!0}),this.onEvent(r.UserActions.EndTurn,(()=>{this.goTo("main")}))}}},2563:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tutorial4=void 0;const s=i(28367),n=i(24794),a=i(79432),o=i(91025),r=i(88865);t.Tutorial4=class{constructor(){this.step1_informAboutKnight=new l(this),this.main=new c(this),this.done=new d(this)}};class c extends a.LevelScript{activate(){1===r.inject.gameStateModel.currentPhase.turnNumber&&r.inject.gameStateModel.currentPhase.isLocalPlayerTurn()&&this.goTo("step1_informAboutKnight")}}class l extends a.LevelScript{activate(){super.activate(),this.addTooltip({title:"You won't beat knights head on,\nbut you can often starve them out!",placement:s.TooltipPlacement.atWorldMapHex((0,n.getHex)(610)),delayMs:1e3,icon:"ui/mini-icons/lightbulb"}),this.onEvent(o.UiEvents.RegionSelected,(e=>{e&&this.goTo("done")})),this.onEvent(o.UserActions.EndTurn,(()=>{this.goTo("done")}))}}class d extends a.LevelScript{}},4126:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Box=t.BoxTextures=void 0;var i=Phaser.GameObjects.NineSlice;function s(e,t){return{frame:e,bottomHeight:t/3,leftWidth:t/3,rightWidth:t/3,topHeight:t/3}}t.BoxTextures={Plate:s("ui/box/plate",48),RoundedPlate:s("ui/box/rounded-plate",48),InnerPlate:s("ui/box/inner-plate",30),WindowFrame:s("ui/box/window",48),Tooltip:s("ui/box/tooltip",12),DialogButton:s("ui/box/dialog-button",48),DialogButtonDown:s("ui/box/dialog-button-down",48)},t.Box=class extends i{constructor(e,t,i=0,s=0,n=0,a=0){super(e,0,0,"atlas",t.frame,n,a,t.leftWidth,t.rightWidth,t.topHeight,t.bottomHeight),this.setOrigin(0,0)}setFrameFrom(e){return this.setFrame(e.frame),this}}},97569:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ButtonControllers=t.ButtonState=void 0;const s=i(12162),n=i(33971),a=i(98278),o=i(88865);var r;(r=t.ButtonState||(t.ButtonState={})).Rest="rest",r.Hover="hover",r.Down="down",r.Disabled="disabled",t.ButtonControllers={triggerEvent:e=>{const t=new s.SimpleButtonStateController({});return t.onClicked((()=>o.inject.events.trigger(e()))),t},simple:()=>new s.SimpleButtonStateController({}),passive:()=>new n.PassiveButtonStateController,options:(e,t)=>new a.OptionsGroupButtonController(e,t)}},98278:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OptionsGroupButtonController=void 0;const s=i(33971),n=i(52937),a=i(85656);t.OptionsGroupButtonController=class{constructor(e,t){this.buttons=e,this.onButtonClicked=(0,n.signal)(),this.buttonControllers=(0,a.mapDictionary)(e,((e,t)=>{const i=new s.PassiveButtonStateController;return e.setController(i),i.onClicked((e=>this.onButtonClicked.fire({key:t,pointer:e}))),i}))}selectButton(e){for(let[t,i]of Object.entries(this.buttonControllers))i.setSelected(t===e)}}},33971:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PassiveButtonStateController=void 0;const s=i(52937),n=i(81363),a=i(97569),o=i(58592);t.PassiveButtonStateController=class{constructor(){this.enabled=!0,this.state=a.ButtonState.Rest,this.onClicked=(0,s.signal)(),this.selected=!1}getState(){return this.state}bindTo(e,t){this.applyState=t,e.removeAllListeners(),e.setInteractive({useHandCursor:!0}).on("pointerdown",(e=>{this.enabled?(this.onClicked.fire(e),o.app.audio.playEffect(n.SoundEffects.ButtonDown)):o.app.audio.playEffect(n.SoundEffects.Deny)}))}setSelected(e){this.selected=e,this.state!==a.ButtonState.Hover&&this.enabled&&this.setState(e?a.ButtonState.Down:a.ButtonState.Rest)}setEnabled(e){this.enabled=e,this.setState(e?this.getIdleState():a.ButtonState.Disabled)}setState(e){e!==this.state&&(this.state=e,this.applyState(e))}getIdleState(){return this.selected?a.ButtonState.Down:a.ButtonState.Rest}}},12162:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleButtonStateController=void 0;const s=i(52937),n=i(81363),a=i(97569),o=i(58592);t.SimpleButtonStateController=class{constructor(e){this.options=e,this.enabled=!0,this.state=a.ButtonState.Rest,this.onClicked=(0,s.signal)()}getState(){return this.state}bindTo(e,t){this.applyState=t,e.removeAllListeners(),e.on("pointerover",(()=>{this.state===a.ButtonState.Rest&&this.setState(a.ButtonState.Hover)})).on("pointerout",(()=>{this.enabled?this.setState(a.ButtonState.Rest):this.setState(a.ButtonState.Disabled)})).on("pointerdown",(()=>{this.enabled?(this.setState(a.ButtonState.Down),this.playSoundEffect(n.SoundEffects.ButtonDown)):this.playSoundEffect(n.SoundEffects.Deny)})).on("pointerup",(e=>{this.enabled&&this.state===a.ButtonState.Down&&(this.setState(a.ButtonState.Hover),this.playSoundEffect(n.SoundEffects.ButtonUp),this.onClicked.fire(e))}))}playSoundEffect(e){!1!==this.options.audio&&o.app.audio.playEffect(e)}setState(e){e!==this.state&&(this.state=e,this.applyState(e))}setEnabled(e){this.enabled=e,this.setState(e?a.ButtonState.Rest:a.ButtonState.Disabled)}}},3682:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColorBar=void 0;const s=i(56996),n=i(46453);class a extends s.Ribbon{constructor(e,t){super(e,s.RibbonTextures.ColorBar,t.x,t.y,t.width),this.props=t,this.adjustX=n.Control.propOf(this,"x",{duration:500}),this.adjustY=n.Control.propOf(this,"y",{duration:500}),this.adjustSize=new n.TransitionController(this.scene,{duration:500,applyValue:e=>{this.active&&(this.width=e)},initialValue:this.width}),void 0!==t.color&&this.setTint(t.color)}}t.ColorBar=a},35863:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CursorAttachment=void 0,t.CursorAttachment=class{constructor(e){this.scene=e}setImage(e){if(this.image){if(this.image===e)return;this.image.destroy()}this.image=e,e&&(this.scene.add.existing(e),e.setOrigin(0,0))}update(){this.image&&this.image.setPosition(this.scene.input.activePointer.x+8,this.scene.input.activePointer.y+8)}clear(){this.setImage(void 0)}}},91633:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugRectangle=void 0;const s=i(24917);var n=Phaser.GameObjects.BitmapText;t.DebugRectangle=class{constructor(e,t=255){this.target=e,this.rect=new Phaser.GameObjects.Rectangle(this.target.scene,0,0,0,0).setStrokeStyle(1,t,1).setOrigin(0,0).setDepth(1e4),this.label=new n(this.target.scene,0,0,s.BitmapFont.Debug).setTint(t).setOrigin(0,0).setDepth(1e4),this.target.parentContainer?this.target.parentContainer.add([this.rect,this.label]):(this.target.scene.add.existing(this.rect),this.target.scene.add.existing(this.label)),this.update()}update(){this.rect.setPosition(this.target.x,this.target.y),this.rect.setSize(this.target.width,this.target.height),this.label.setPosition(this.target.x,this.target.y-12),this.label.setText(`${this.target.constructor.name}: ${this.target.width}x${this.target.height}`)}setVisible(e){this.rect.setVisible(e),this.label.setVisible(e)}}},73190:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TextBlock=t.MiniButtonsRow=void 0;var s=Phaser.GameObjects.Container,n=Phaser.GameObjects.Image;const a=i(11771);var o=Phaser.GameObjects.BitmapText;const r=i(24917),c=i(70319);t.MiniButtonsRow=class extends s{constructor(e,t){super(e),this.frames=t,this.buttons=[],this.components=[],this.createButtons()}createButtons(){if(this.frames.length<2)throw new Error("MiniButtonsRow must have at least 2 buttons");this.addButton("left",this.frames[0]),this.frames.slice(1,this.frames.length-1).forEach((e=>{"display"===e?(this.textBlock=new l(this.scene),this.textBlock.width=80,this.textBlock.height=24,this.textBlock.updateLayout(),this.components.push(this.textBlock)):this.addButton("mid",e)})),this.addButton("right",this.frames[this.frames.length-1]),this.add(this.components),this.updateLayout()}addButton(e,t){const i=new a.ImageButtonWithContent(this.scene,0,0,{down:!0,frame:`ui/mini-buttons/${e}`,content:new n(this.scene,0,0,"atlas",t)});this.buttons.push(i),this.components.push(i)}setText(e){this.textBlock&&this.textBlock.setText(e)}updateLayout(){let e=0;for(let t of this.components)t===this.textBlock&&e++,t.x=e,e+=t.width-1;this.width=e+1,this.height=this.buttons[0]?.height??0}};class l extends c.BaseResponsiveContainer{constructor(e){super(e),this.label=new o(this.scene,0,0,r.BitmapFont.Mini,"turn 1/10").setTint(3355443).setOrigin(.5,.5),this.ribbon=new n(this.scene,0,0,"atlas","ui/mini-buttons/ribbon"),this.add([this.ribbon,this.label])}updateLayout(){this.label.setPosition(this.width/2,this.height/2),this.ribbon.setDisplaySize(this.width,this.ribbon.height)}setText(e){this.label.setText(e)}}t.TextBlock=l},56996:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Ribbon=t.RibbonTextures=void 0;var i=Phaser.GameObjects.NineSlice;t.RibbonTextures={WindowHeader:{frame:"ui/ribbon/window-header",borderWidth:4},ButtonGroup:{frame:"ui/ribbon/button-group",borderWidth:16},Slider:{frame:"ui/ribbon/slider",borderWidth:8},ColorBar:{frame:"ui/ribbon/color-bar",borderWidth:4,height:12},SmallButton:{frame:"ui/ribbon/small-button",borderWidth:8},SmallButtonDown:{frame:"ui/ribbon/small-button-down",borderWidth:8},MainButton:{frame:"ui/ribbon/main-button",borderWidth:8},MainButtonDown:{frame:"ui/ribbon/main-button-down",borderWidth:8},MainButtonDisabled:{frame:"ui/ribbon/main-button-disabled",borderWidth:8},MediumButton:{frame:"ui/ribbon/medium-button",borderWidth:8},MediumButtonDown:{frame:"ui/ribbon/medium-button-down",borderWidth:8},UnitTray:{frame:"ui/ribbon/unit-tray",borderWidth:8},Cloth:{borderWidth:8,frame:"ui/ribbon/cloth"},Pergamen:{frame:"ui/ribbon/pergamen",borderWidth:64},SmallPergamen:{frame:"ui/ribbon/small-pergamen",borderWidth:24},SmallPergamenShadow:{frame:"ui/ribbon/small-pergamen-shadow",borderWidth:12}},t.Ribbon=class extends i{constructor(e,t,i=0,s=0,n=0){super(e,i,s,"atlas",t.frame,n,void 0,t.borderWidth,t.borderWidth),this.setOrigin(0,0)}setFrameFrom(e){this.setFrame(e.frame)}}},98691:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RichText=void 0;const s=i(44850);class n extends s.BBCodeText{setWordWrapWidth(e){return this.setStyle({wrap:{mode:this.style.wrapMode,width:e}}),this}setTint(e){return this.setStyle({...this.style,color:e,delimiters:","}),this}setColor(e){return this.setTint(e),this}}t.RichText=n},86183:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SmallPergamen=void 0;const s=i(46453),n=i(70319),a=i(56996),o=i(23441),r=i(1909);var c=Phaser.GameObjects.Image;class l extends n.ResponsiveContainer{constructor(e){super(e),this.pergamen=new a.Ribbon(this.scene,a.RibbonTextures.SmallPergamen),this.shadow=r.UiBuilder.for(this.scene).rectangle(0,1),this.pawn=new c(this.scene,0,0,"atlas","pawns/villager").setScale(.5).setOrigin(.5,.5),this.visibilityController=new s.TransitionController(this.scene,{initialValue:0,applyValue:e=>{const t=24+(this.targetDimensions.width-24)*e,i=(0,o.pickLarger)(0,2*e-1);this.content?.setScale(1,1),this.content?.setAlpha(i),this.width=t,this.setPosition(this.targetDimensions.x-t/2,this.targetDimensions.y-this.height/2),this.pergamen.width=2*t,this.pergamen.setAlpha(e),this.shadow.width=(0,o.pickLarger)(0,t-8),this.shadow.setAlpha(e/5),this.pawn.setPosition(t-12+2,8*(1-e)),this.pawn.setAlpha(i)}}),this.targetDimensions={x:0,y:0,width:0},this.shadow.setSize(10,5),this.shadow.setPosition(4,0),this.pergamen.setScale(.5),this.add([this.pawn,this.pergamen])}setContent(e){if(this.content){if(this.content===e)return;this.remove(this.content)}this.content=e,this.add(e),this.content.setPosition(12,6),this.targetDimensions.width=this.content.width+24,this.updateTargetSize()}showAt(e,t,i,s){this.visibilityController.setTo(0),this.targetDimensions.x=e,this.targetDimensions.y=t,s?(this.pawn.setFrame(s).setOrigin(1,.5),this.pawn.setVisible(!0)):this.pawn.setVisible(!1),this.visibilityController.transitionTo(1,{duration:300,ease:"Sine.easeOut"}),this.updateTargetSize()}updateTargetSize(){this.targetDimensions.width=this.content.width+24,this.visibilityController.currentValue>0&&this.visibilityController.setTo(1)}hide(){this.visibilityController.transitionTo(0,{duration:300,ease:"Sine.easeOut"})}}t.SmallPergamen=l},96465:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoxButton=void 0;const s=i(97569),n=i(4126),a=i(78374),o=i(70319);class r extends o.ResponsiveContainer{set buttonState(e){this._state=e,this.preUpdate.makeDirty()}get buttonState(){return this._state}constructor(e,t,i,o){super(e),this.props=o,this._state=s.ButtonState.Rest,this.box=new n.Box(this.scene,o.baseTexture,0,0,o.width,o.height),this.setSize(o.width,o.height),o.content.setOrigin(.5,.5),o.buttonTint&&this.box.setTint(o.buttonTint),this.add([this.box,this.props.content]),this.setPosition(t,i),this.setInteractiveAuto(),this.setController((0,a.setupController)(o))}setEnabled(e){this.controller.setEnabled(e)}get onClicked(){return this.controller.onClicked}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.buttonState=e)))}setTextTint(e){return this.props.content.setTint(e),this}setTint(e){return this.box.setTint(e),this}updateLayout(){super.updateLayout(),console.log("UPDATE BOX BUTTON LAYOUT");let e=Math.round(this.width/2+(this.props.contentOffset?.x??0)),t=Math.round(this.height/2+(this.props.contentOffset?.y??0));this.buttonState===s.ButtonState.Down&&(e+=2,t+=2),this.box.setFrameFrom(this.props.downTexture&&this.buttonState===s.ButtonState.Down?this.props.downTexture:this.props.baseTexture),this.props.content.setPosition(e,t)}}t.BoxButton=r},78374:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupController=void 0;const s=i(12162);t.setupController=function(e){return void 0===e.controller?new s.SimpleButtonStateController({audio:e.audio}):null!==e.controller?e.controller:void 0}},39953:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CircleButton=void 0;var s=Phaser.GameObjects.Arc,n=Phaser.Geom.Circle;const a=i(70319),o=i(97569),r=i(78374);class c extends a.BaseResponsiveContainer{constructor(e,t){super(e),this.props=t,this.background=new s(this.scene,0,0,t.size/2),this.width=t.size,this.height=t.size,this.add([this.background,this.props.content]),this.setInteractive({hitArea:this.getHitArea(),hitAreaCallback:n.Contains,cursor:"pointer"}),this.setController((0,r.setupController)({audio:t.audio})),this.onNewButtonState(o.ButtonState.Rest)}getHitArea(){return new n(this.props.size,this.props.size,this.props.size/2)}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.onNewButtonState(e))))}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}getButtonStyleForState(e){switch(e){case o.ButtonState.Disabled:case o.ButtonState.Rest:return this.props.style[e]??this.props.style[o.ButtonState.Rest];case o.ButtonState.Down:case o.ButtonState.Hover:return this.props.style[e]??this.props.style[o.ButtonState.Down]}}onNewButtonState(e){const t=this.getButtonStyleForState(e);this.background.setFillStyle(t.backgroundColor,t.backgroundAlpha),t.tint?this.props.content.setTint(t.tint):this.props.content.clearTint(),this.preUpdate.makeDirty()}updateLayout(){const e=this.props.size/2;this.input?.hitArea.setTo(this.props.size,this.props.size,this.props.size/2),this.background.radius=e,this.background.setPosition(e,e),this.props.content.setPosition(e,e).setOrigin(.5,.5)}}t.CircleButton=c},79730:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createLevelLinkButton=void 0;const s=i(1909),n=i(88865),a=i(11041),o=i(97520),r=i(81700),c=i(60807),l=i(58592),d=i(38952);function h(){return a.LevelModel.for(n.inject.gameStateModel.map.levelId)}t.createLevelLinkButton=function(e,t=h){const i=e.button(s.ButtonTemplate.SmallCircleButton,{icon:"ui/button-icons/link",onClicked:()=>{const e=t().createUrlHash(),s=(0,o.createUrl)(e);(0,r.copyTextToClipboard)(s),c.track.interaction("copy_level_link"),l.app.tooltips.showOver(i,{title:"Link to the level copied to clipboard!",type:d.TooltipType.Hover,icon:"ui/icons/ok",delayMs:0,expireAfterMs:1500})},tooltip:"Copy link to this island."});return i}},57902:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageButton=void 0;const s=i(97569);var n=Phaser.GameObjects.Image;t.ImageButton=class extends n{constructor(e,t,i,n){super(e,t,i,"atlas",n.frame),this.config=n,this.setInteractive({cursor:"pointer"}),void 0===n.controller?this.setController(s.ButtonControllers.simple()):null!==n.controller&&this.setController(n.controller)}setController(e){this.controller=e,e.bindTo(this,(e=>this.setButtonState(e)))}setBaseFrame(e){this.config.frame=e,this.setButtonState(this.controller.getState())}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}setButtonState(e){switch(e){case s.ButtonState.Rest:this.setFrame(this.config.frame);break;case s.ButtonState.Disabled:this.setFrame(this.config.frame+(this.config.disabled?"-disabled":""));break;case s.ButtonState.Hover:this.setFrame(this.config.frame+(this.config.hover?"-hover":""));break;case s.ButtonState.Down:this.setFrame(this.config.frame+(this.config.down?"-down":""))}}}},11771:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageButtonWithContent=void 0;const s=i(97569),n=i(78374);var a=Phaser.GameObjects.Container,o=Phaser.GameObjects.Sprite;t.ImageButtonWithContent=class extends a{constructor(e,t,i,s){super(e,t,i),this.config=s,this.buttonSprite=new o(this.scene,0,0,"atlas",s.frame),this.buttonSprite.setInteractive({cursor:"pointer"}),this.setController((0,n.setupController)(s)),this.config.content.setOrigin(.5,.5).setPosition(this.buttonSprite.width/2,this.buttonSprite.height/2-1),this.add([this.buttonSprite,this.config.content]),this.width=this.buttonSprite.width,this.height=this.buttonSprite.height}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}setController(e){e&&(this.controller=e,e.bindTo(this.buttonSprite,(e=>this.setButtonState(e))))}setButtonState(e){const t=this.buttonSprite.width/2,i=this.buttonSprite.height/2-1;switch(e){case s.ButtonState.Rest:this.buttonSprite.setFrame(this.config.frame),this.config.content.setPosition(t,i);break;case s.ButtonState.Disabled:this.buttonSprite.setFrame(this.config.frame+(this.config.disabled?"-disabled":"")),this.config.content.setPosition(t,i);break;case s.ButtonState.Hover:this.buttonSprite.setFrame(this.config.frame+(this.config.hover?"-hover":"")),this.config.content.setPosition(t,i);break;case s.ButtonState.Down:this.buttonSprite.setFrame(this.config.frame+(this.config.down?"-down":"")),this.config.content.setPosition(t+1,i+1)}}}},98534:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MiniCloseButton=void 0;const s=i(57902);class n extends s.ImageButton{constructor(e,t,i){super(e,t,i,{frame:"ui/mini-close-button",hover:!0})}}t.MiniCloseButton=n},17120:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RibbonButton=t.RibbonButtonStyle=void 0;const s=i(56996),n=i(12162),a=i(97569),o=i(70319),r=i(78374);var c=Phaser.GameObjects.Image;t.RibbonButtonStyle={Small:{base:s.RibbonTextures.SmallButton,down:s.RibbonTextures.SmallButtonDown},Medium:{base:s.RibbonTextures.MediumButton,down:s.RibbonTextures.MediumButtonDown},Primary:{base:s.RibbonTextures.MainButton,down:s.RibbonTextures.MainButtonDown,disabled:s.RibbonTextures.MainButtonDisabled}};class l extends o.BaseResponsiveContainer{set buttonState(e){this._state=e,this.preUpdate.makeDirty()}get buttonState(){return this._state}constructor(e,t,i,o){super(e),this.props=o,this._state=a.ButtonState.Rest,this.button=new s.Ribbon(this.scene,o.type.base,0,0,o.width),this.setSize(this.props.width,this.button.height),this.setInteractiveAuto(),o.content.setOrigin(.5,.5),o.buttonTint&&this.button.setTint(o.buttonTint),this.add([this.button,this.props.content]),o.icon&&this.add(o.icon),this.setPosition(t,i),this.setController((0,r.setupController)(o)),void 0===o.controller?this.setController(new n.SimpleButtonStateController({audio:this.props.audio})):null!==o.controller&&this.setController(o.controller)}setEnabled(e){this.controller.setEnabled(e)}get onClicked(){return this.controller.onClicked}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.buttonState=e)))}setTint(e,t){return this.button.setTint(t),this.props.content.setTint(e),this}updateLayout(){this.button.width=this.width;let e=this.button.width/2+(this.props.icon?this.props.icon.width/2:0),t=this.button.height/2;this.buttonState===a.ButtonState.Down&&(e+=2,t+=2),this.buttonState===a.ButtonState.Disabled&&this.props.content instanceof c?this.props.content.setAlpha(.25):this.props.content.setAlpha(1),this.props.icon?.setPosition(this.props.icon?.width/2+14,t),this.button.setFrameFrom(this.getCurrentTexture()),this.props.content.setPosition(e+(this.props.contentOffset?.x??0),t+(this.props.contentOffset?.y??0))}getCurrentTexture(){switch(this.buttonState){case a.ButtonState.Disabled:return this.props.type.disabled??this.props.type.base;case a.ButtonState.Down:return this.props.type.down;default:return this.props.type.base}}}t.RibbonButton=l},55254:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoundedRectButton=void 0;var s=Phaser.Geom.Rectangle;const n=i(70319),a=i(5715),o=i(84892),r=i(97569),c=i(78374);class l extends n.BaseResponsiveContainer{constructor(e,t){super(e),this._rounded=1,this._raised=0,this._contentOriginX=0,this.background=new o.RoundedRect(this.scene,{x:0,y:0,fillStyle:{color:a.Colors.glassUi.shape,alpha:1},radius:0}),t.raised&&(this._raised=t.raised,this.shadow=new o.RoundedRect(this.scene,{x:0,y:0,fillStyle:{color:a.Colors.glassUi.shapeShadow,alpha:1},radius:0}),this.add(this.shadow)),this.content=t.content,this._contentOriginX=t.contentOriginX??0,this.add([this.background,this.content]),this.setInteractive({hitArea:this.getHitArea(),hitAreaCallback:s.Contains,cursor:"pointer"}),this.setController((0,c.setupController)({audio:t.audio}))}getHitArea(){return this._raised?new s(this.width/2-4,this.height/2-4,this.width+4,this.height+4):new s(this.width/2,this.height/2,this.width,this.height)}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.onNewButtonState(e))))}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}set rounded(e){this._rounded=e}get rounded(){return this._rounded}onNewButtonState(e){switch(e){case r.ButtonState.Disabled:this.background.setFillStyle(a.Colors.glassUi.shape),this.background.setAlpha(.5),this.preUpdate.makeDirty();break;case r.ButtonState.Hover:case r.ButtonState.Down:this.background.setAlpha(1),this.background.setFillStyle(a.Colors.glassUi.shapeLightAccent),this.preUpdate.makeDirty();break;default:this.background.setAlpha(1),this.background.setFillStyle(a.Colors.glassUi.shape),this.preUpdate.makeDirty()}}updateLayout(){const e=this._raised?this.controller.getState()===r.ButtonState.Down||this.controller.getState()===r.ButtonState.Disabled?-1:-this._raised:0;this.input.hitArea.setTo(this.width/2,this.height/2,this.width,this.height),this.background.radius=this.height/2*this._rounded,this.background.setSize(this.width,this.height),this.content.setSize(this.width,this.height),this.background.setPosition(e,e),this.content.setPosition(e+this._contentOriginX*this.width-this.content.width*this._contentOriginX,e),this._raised&&this.shadow&&(this.shadow.setPosition(0,0),this.shadow.radius=this.background.radius,this.shadow.setSize(this.width,this.height))}}t.RoundedRectButton=l},29301:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StealthButton=void 0;var s=Phaser.Geom.Rectangle;const n=i(70319),a=i(5715),o=i(84892),r=i(97569),c=i(78374);class l extends n.BaseResponsiveContainer{constructor(e,t){super(e),this._radius=10,this._radius=t.radius??this._radius,this._background=new o.RoundedRect(this.scene,{x:0,y:0,fillStyle:{color:a.Colors.glassUi.shapeLightAccent,alpha:.5},radius:this._radius}).setAlpha(0),this.content=t.content,this.add([this._background,t.content]),this.setInteractive({hitArea:new s(this.width/2,this.height/2,this.width,this.height),hitAreaCallback:s.Contains,cursor:"pointer"}),this.setController((0,c.setupController)(t))}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.onNewButtonState(e))))}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}onNewButtonState(e){switch(e){case r.ButtonState.Hover:case r.ButtonState.Down:this._background.setAlpha(1);break;default:this._background.setAlpha(0)}}updateLayout(){this.input.hitArea.setTo(this.width/2,this.height/2,this.width,this.height),this._background.radius=this._radius,this._background.setSize(this.width,this.height),this.content.setPosition(this.width/2-this.content.width/2,this.height/2-this.content.height/2)}}t.StealthButton=l},22884:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFrame=t.SEAMLESS_IFRAME_CSS=void 0;const s=i(78382);t.SEAMLESS_IFRAME_CSS="\n    resize: none;\n    border: none;\n    scroll: auto;\n";class n extends s.ResizableDOMElement{constructor(e,i){super(e,0,0,document.createElement("iframe"),t.SEAMLESS_IFRAME_CSS+i.customCss??""),this.props=i,this.hasFocus=!1;const s=this.node;this.setElement(s),this.setOrigin(0,0),i.url&&this.setUrl(i.url)}setUrl(e){this.node.src=e}}t.IFrame=n},78382:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResizableDOMElement=void 0;var s=Phaser.GameObjects.DOMElement;const n=i(23441);t.ResizableDOMElement=class extends s{constructor(e,t,i,s,a,o){super(e,t,i,s,a,o),this.node.style.transform="translate(-10000px, -10000px)",this.node.style.left="0px",Object.defineProperties(this,{width:{set:e=>{this.node.style.width=`${e}px`},get:()=>this.node.offsetWidth},height:{set:e=>{this.node.style.height=`${e}px`},get:()=>(0,n.pickLarger)(this.node.offsetHeight,this.displayHeight)}})}preUpdate(){this.scene.scene.isVisible()||(this.node.style.display="none"),this.parentContainer?.willRender(this.scene.cameras.main)||(this.node.style.display="none")}}},31103:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveDOMContent=void 0;var s=Phaser.GameObjects.DOMElement;const n=i(23441);t.ResponsiveDOMContent=class extends s{constructor(e,t){super(e,0,0),this.cacheItem=t,this.createFromCache(t),this.setOrigin(0,0),this.rootDiv=this.node,this.node.style.transform="translate(-10000px, -10000px)",this.node.style.left="0px",Object.defineProperties(this,{width:{set:e=>{this.node.style.width=`${e}px`},get:()=>this.node.offsetWidth},height:{set:e=>{this.node.style.height=`${e}px`},get:()=>(0,n.pickLarger)(this.node.offsetHeight,this.displayHeight)}})}preUpdate(){this.scene.scene.isVisible()||(this.rootDiv.style.display="none"),this.parentContainer?.willRender(this.scene.cameras.main)||(this.rootDiv.style.display="none")}}},78295:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setKeyboardCaptureEnabled=t.TextArea=void 0;const s=i(68930),n=i(78382),a=i(58592);class o extends n.ResizableDOMElement{constructor(e,t){super(e,0,0,document.createElement("textarea"),s.TEXT_INPUT_BASE_CSS+t.customCss??""),this.props=t,this.hasFocus=!1;const i=this.node;i.readOnly=this.props.readOnly??!1,i.placeholder=this.props.placeholder??"",this.props.autoSelectAll&&(i.onclick=function(){this.focus(),this.select()}),this.props.onChange&&(i.oninput=()=>{t.onChange(i.value)}),i.onfocus=()=>{this.hasFocus=!0,r(!1)},i.onblur=()=>{this.hasFocus=!1,r(!0)},i.innerText=this.props.text??"",t.rows&&this.resizeToRows(t.rows),t.width&&(this.width=t.width),t.height&&(this.height=t.height),this.setElement(i),this.setOrigin(0,0)}resizeToRows(e){this.node.rows=e,this.node.style.height="auto"}get text(){return this.node.value}destroy(){this.node.remove(),super.destroy(),this.hasFocus&&r(!0)}setValue(e){this.node.textContent=e}setSize(e,t){this.width=e,this.height=t}setText(e){return this.node.value=e,this}}function r(e){a.app.game.input.keyboard.enabled=e}t.TextArea=o,t.setKeyboardCaptureEnabled=r},68930:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setKeyboardCaptureEnabled=t.TextInput=t.TEXT_INPUT_BASE_CSS=void 0;const s=i(5715),n=i(78382),a=i(58592);t.TEXT_INPUT_BASE_CSS=`\n    box-sizing: border-box;\n    resize:none;\n    background-color: #${s.Colors.woodenUi.pergamen.toString(16)};\n    pointer-events: auto;\n    padding: 8px;\n    border-radius: 8px;\n    border: 2px solid #${s.Colors.glassUi.primaryText.toString(16)};\n    font-size: 10pt;\n    font-family: sans-serif;\n`;class o extends n.ResizableDOMElement{constructor(e,i){super(e,0,0,document.createElement("input"),t.TEXT_INPUT_BASE_CSS+i.customCss??""),this.props=i,this.hasFocus=!1;const s=this.node;s.readOnly=this.props.readOnly??!1,s.placeholder=this.props.placeholder??"",this.props.autoSelectAll&&(s.onclick=function(){this.focus(),this.select()}),this.props.onChange&&(s.oninput=()=>{i.onChange(s.value)}),s.onfocus=()=>{this.hasFocus=!0,r(!1)},s.onblur=()=>{this.hasFocus=!1,r(!0)},s.innerText=this.props.text??"",this.setElement(s),this.setOrigin(0,0),i.height?this.height=i.height:s.style.height="auto",i.width&&(this.width=i.width)}get text(){return this.node.value}destroy(){super.destroy(),this.hasFocus&&r(!0)}setValue(e){this.node.value=e}focus(){this.node.focus()}selectAll(){this.node.select()}}function r(e){a.app.game.input.keyboard.enabled=e}t.TextInput=o,t.setKeyboardCaptureEnabled=r},29528:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Card=t.CardPointerInputMode=void 0;const s=i(70319),n=i(84892),a=i(5715),o=i(12162),r=i(97569);var c,l=Phaser.Geom.Rectangle,d=Phaser.GameObjects.Image;!function(e){e.Whole="whole",e.WithoutFooter="without-footer",e.NotClickable="not-clickable"}(c=t.CardPointerInputMode||(t.CardPointerInputMode={}));class h extends s.BaseResponsiveContainer{get clickable(){return this._clickable}set footerSize(e){this._footerSize=e,this.preUpdate.makeDirty()}get footerSize(){return this._footerSize}set radius(e){this.background.radius=e,this.preUpdate.makeDirty()}get radius(){return this.background.radius}set content(e){this._content!==e&&(this._content&&this.remove(this._content),this._content=e,this.add([this._content]),this.preUpdate.makeDirty())}get content(){return this._content}constructor(e,t={}){if(super(e),this._footerSize=0,this._clickable=c.NotClickable,this._buttonState=r.ButtonState.Rest,this.background=new n.RoundedRect(e,{x:0,y:0,fillStyle:{color:a.Colors.glassUi.shape,alpha:1},radius:0}),this.shadow=new n.RoundedRect(e,{x:h.Layout.shadowDepth,y:h.Layout.shadowDepth,fillStyle:{color:a.Colors.glassUi.shapeShadow,alpha:1},radius:0}),this.footerBackground=new n.RoundedRect(e,{x:h.Layout.shadowDepth,y:h.Layout.shadowDepth,fillStyle:{color:a.Colors.glassUi.shapeDarkAccent,alpha:1},radius:0}),t.radius&&(this.radius=t.radius),t.onClick){this._onClick=t.onClick,this._clickable=t.clickable??c.Whole;const e=new o.SimpleButtonStateController({audio:!1});e.bindTo(this,(e=>{this._buttonState=e,this.preUpdate.makeDirty()})),e.onClicked(t.onClick)}else this._clickable=t.clickable??c.NotClickable;this.add([this.shadow,this.background,this.footerBackground]),t.content&&(this._content=t.content,this.add([this._content])),t.footerSize&&(this._footerSize=t.footerSize),t.sticker&&(this.sticker=new d(this.scene,0,0,"atlas",t.sticker),this.add(this.sticker))}getHitAreaHeight(){return this.height-(this._clickable===c.Whole?0:this._footerSize)}setClickable(e){this._clickable=e,this.preUpdate.makeDirty()}updateLayout(){const e=this._buttonState===r.ButtonState.Down&&this._clickable===c.Whole?2:0;this._clickable!==c.NotClickable?(this.input?.hitArea?this.input.hitArea.setTo(this.width/2,this.height/2,this.width,this.getHitAreaHeight()):this.setInteractive({hitArea:new l(this.width/2,this.height/2,this.width,this.getHitAreaHeight()),hitAreaCallback:l.Contains,cursor:"pointer"}),this.input.enabled=!0):this.input&&(this.input.enabled=!1),this.shadow.setSize(this.width,this.height),this.shadow.radius=this.radius,this.background.setPosition(e,e),this.background.setSize(this.width,this.height),this._content?.setPosition(e,e),this._content?.setSize(this.width,this.height),this._buttonState===r.ButtonState.Down||this._buttonState==r.ButtonState.Hover?(this.background.setFillStyle(a.Colors.glassUi.shapeLightAccent),this._clickable===c.Whole&&this.footerBackground.setFillStyle(a.Colors.glassUi.shape)):(this.background.setFillStyle(a.Colors.glassUi.shape),this.footerBackground.setFillStyle(a.Colors.glassUi.shapeDarkAccent)),this.footerBackground.radius={tl:0,tr:0,bl:"object"==typeof this.radius?this.radius.bl:this.radius,br:"object"==typeof this.radius?this.radius.br:this.radius},this.footerBackground.setVisible(this.footerSize>0),this.footerBackground.setPosition(0+e,this.height-this.footerSize+e),this.footerBackground.setSize(this.width,this.footerSize),this.sticker&&this.sticker.setPosition(this.width+e,e).setOrigin(1,0)}}t.Card=h,h.Layout={shadowDepth:4,defaultRadius:20}},84892:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoundedRect=void 0;var s=Phaser.GameObjects.Graphics;const n=i(97866),a=i(50059);t.RoundedRect=class extends s{constructor(e,t){super(e,{x:t.x??0,y:t.y??0,fillStyle:t.fillStyle,lineStyle:t.lineStyle}),this.preUpdate=(0,n.whenDirty)((()=>{this.clear(),this.fillStyle(this._fillStyle.color??0,this._fillStyle.alpha),this.fillRoundedRect(0,0,this.width,this.height,this.radius)})),this.radius=t.radius,this._fillStyle=t.fillStyle||{color:4095,alpha:1},a.ResponsiveSizeComponent.overrideSizeComponent(this)}setFillStyle(e,t=1){this._fillStyle={color:e,alpha:t},this.preUpdate.makeDirty()}set radius(e){this._radius=e,this.preUpdate.makeDirty()}get radius(){return this._radius}}},83820:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ArrowButton=t.SelectBoxWithArrows=void 0;const s=i(70319),n=i(84892),a=i(1909),o=i(24917),r=i(5715),c=i(97569),l=i(52937);var d=Phaser.GameObjects.Container,h=Phaser.Geom.Rectangle;class u extends s.BaseResponsiveContainer{constructor(e,t){super(e),this.ui=a.UiBuilder.for(this.scene),this.leftButton=new p(this.scene,{direction:"left"}),this.rightButton=new p(this.scene,{direction:"right"}),this.background=new n.RoundedRect(this.scene,{radius:12,fillStyle:{color:r.Colors.glassUi.shape,alpha:.3}}),this.titleText=this.ui.text("Title",o.BitmapFont.Mini,r.Colors.glassUi.secondaryText),this.selectedText=this.ui.text("Selected",o.BitmapFont.Main,r.Colors.glassUi.primaryText),this.components=[this.background,this.leftButton,this.rightButton,this.titleText,this.selectedText],this.items=[],this.selectedItemIndex=-1,this.onSelect=(0,l.signal)(),this.add(this.components),this.height=this.leftButton.height+10,this.setProps(t),this.leftButton.onClicked((()=>{if(0===this.selectedItemIndex){if(!this.infinite)return;this.onSelect.fire({value:this.items[this.items.length-1].value,direction:"left"})}else this.onSelect.fire({value:this.items[this.selectedItemIndex-1].value,direction:"left"})})),this.rightButton.onClicked((()=>{(this.infinite||this.selectedItemIndex!==this.items.length-1)&&this.onSelect.fire({value:this.items[(this.selectedItemIndex+1)%this.items.length].value,direction:"right"})}))}setProps(e){this.titleText.setText(e.title),this.items=e.options,this.infinite=e.infinite??!1,this.setSelection(e.selectedOption)}setSelection(e){let t=this.items.findIndex((t=>t.value===e));-1===t&&(t=0),this.selectedItemIndex=t,this.selectedItem=this.items[t],this.selectedItem?(this.selectedText.setText(this.selectedItem.title),this.leftButton.setEnabled(this.infinite||0!==t),this.rightButton.setEnabled(this.infinite||t!==this.items.length-1)):(this.selectedText.setText(""),this.leftButton.setEnabled(!1),this.rightButton.setEnabled(!1))}updateLayout(){const e=10+this.leftButton.height/2,t=this.width/2;this.leftButton.setPosition(0,e-this.leftButton.height/2),this.rightButton.setPosition(this.width-this.rightButton.width,e-this.leftButton.height/2),this.background.setSize(this.width-89,this.rightButton.height-10),this.background.setPosition(44,15),this.selectedText.setOrigin(.5,.5).setPosition(t,e),this.titleText.setOrigin(.5,.5).setPosition(t,5)}}t.SelectBoxWithArrows=u;class p extends d{constructor(e,t){super(e),this.ui=a.UiBuilder.for(this.scene),this.mainImage=this.ui.image("glass-ui/arrow-button"),this.shadow=this.ui.image("glass-ui/arrow-button-shadow").setTint(r.Colors.glassUi.shapeShadow),this.height=this.mainImage.height,this.width=this.mainImage.width,this.mainImage.setFlipX("left"===t.direction).setOrigin("left"===t.direction?1:0,0).setInteractive({cursor:"pointer",hitArea:new h("left"===t.direction?this.mainImage.width:0,0,this.mainImage.width,this.mainImage.height),hitAreaCallback:h.Contains}),this.shadow.setPosition(0,0).setOrigin("left"===t.direction?1:0,0).setFlipX("left"===t.direction),this.add([this.shadow,this.mainImage]),this.updateLayout(c.ButtonState.Rest),void 0===t.controller?this.setController(c.ButtonControllers.simple()):null!==t.controller&&this.setController(t.controller)}get onClicked(){return this.controller.onClicked}setController(e){this.controller=e,e.bindTo(this.mainImage,(e=>this.setButtonState(e)))}setEnabled(e){this.controller.setEnabled(e)}updateLayout(e=c.ButtonState.Rest){switch(e===c.ButtonState.Disabled?(this.mainImage.setAlpha(.3),this.shadow.setVisible(!1)):(this.mainImage.setAlpha(1),this.shadow.setVisible(!0)),e){case c.ButtonState.Down:case c.ButtonState.Disabled:this.mainImage.setPosition(0,0);break;default:this.mainImage.setPosition(-2,-2)}}setButtonState(e){this.updateLayout(e)}}t.ArrowButton=p},99694:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Arrange=t.horizontalAlign=void 0;const s=i(23441);function n(e){return"number"==typeof e?{size:e}:function(e){return"number"!=typeof e&&e.hasOwnProperty("type")}(e)?{object:e}:e}function a(e){const t=e.content.map(n).filter((e=>!e.object||e.object.visible)),i=e.spacing??0,a=e.origin??0;let o=t.map(l).reduce(s.sum,0)+i*(t.length-1),r=0;if(e.maxSize&&o>e.maxSize){let i=o-e.maxSize;const n=t.map((e=>e.minSize?l(e)-e.minSize:0)).reduce(s.sum,0);r=(0,s.pickSmaller)(1,i/n),o=e.maxSize}let c=e.offset-o*a;for(let s of t){const t=l(s,r);s.object&&(s.object[e.layoutAxis]=c,s.object[e.secondarySizeProp]!==t&&(s.object[e.secondarySizeProp]=t)),c+=t+i}function l(t,i=0){const s=(t.size||t.object?.[e.primarySizeProp]||t.object?.[e.secondarySizeProp])??0;if(i&&t.minSize){const e=s-t.minSize;return t.minSize+e*(1-i)}return s}}function o(e){return e.displayHeight||e.height}function r(e){return e.displayWidth||e.width}var c;(c=t.horizontalAlign||(t.horizontalAlign={}))[c.Left=0]="Left",c[c.Middle=.5]="Middle",c[c.Right=1]="Right",t.Arrange={fromTopToBottomOld(e,t){const i=(e=e.filter((e=>e.visible))).map((e=>e.height)).reduce(s.sum,0)+t.spacing*(e.length-1)+2*(t.padding??0);e.map(r).reduce(s.pickLarger,0);let n=t.y-i*(t.originY??0);for(let i of e)i.setPosition(t.x-r(i)*(t.originX??0),n),n=n+i.height+t.spacing},fromLeftToRightOld(e,t){const i=(e=e.filter((e=>e.visible))).map(o).reduce(s.pickLarger,0),n=Math.min(t.maxWidth??Number.MAX_SAFE_INTEGER,e.map(r).reduce(s.sum,0))+t.spacing*(e.length-1)+2*(t.padding??0),a=t.x-n*(t.originX??0)+(t.padding??0);let c=t.y+(t.padding??0),l=a;for(let s of e){const e=r(s),n=o(s);t.maxWidth&&l-a+e>t.maxWidth&&(l=a,c=c+i+t.spacing),s.setPosition(l,c-n*(t.originY??0)),l=l+e+t.spacing}return{width:n,height:i}},alignX(e,t){const i=t.origin??.5;for(let n of e){const e=t.width??(0,s.pickLarger)(n.displayWidth??0,n.width);n.x=t.x-e*i,t.width&&n.width!==t.width&&(n.width=t.width)}},alignY(e,t){const i=t.origin??.5;for(let n of e){const e=t.height??(0,s.pickLarger)(n.displayHeight??0,n.height);n.y=t.y-e*i,t.height&&n.height!==t.height&&(n.height=t.height)}},vertically:e=>a({...e,offset:e.y,layoutAxis:"y",primarySizeProp:"displayHeight",secondarySizeProp:"height"}),leftToRight:e=>a({...e,offset:e.x,layoutAxis:"x",primarySizeProp:"displayWidth",secondarySizeProp:"width"})}},29306:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AutoHeightComponent=void 0;const s=i(73773);class n{constructor(e){this.parent=e,this._width=0,this._height=0,this.initialHeightSet=!1}get height(){return this._height}set width(e){this._width!==e&&(this._width=e,this.parent.preUpdate.force())}get width(){return this._width}updateSize(){const e=this.parent.calculateHeight();e!==this._height&&(this._height=e,this.initialHeightSet?this.parent.parentContainer?(0,s.handlesAutoSizeChildren)(this.parent.parentContainer)&&this.parent.parentContainer.handleChildResize(this.parent):(0,s.handlesAutoSizeChildren)(this.parent.scene)&&this.parent.scene.handleChildResize(this.parent):this.initialHeightSet=!0)}static overrideSizeComponent(e){const t=new n(e);Object.defineProperties(e,{width:{set:e=>{t.width=e},get:()=>t.width},height:{get:()=>t.height},updateSize:{value:t.updateSize.bind(t)}})}}t.AutoHeightComponent=n},24986:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AutoWidthComponent=void 0;const s=i(73773);class n{constructor(e){this.parent=e,this._width=0,this._height=0,this.initialWidthSet=!1}get height(){return this._height}set height(e){this._height!==e&&(this._height=e,this.parent.preUpdate.force())}get width(){return this._width}updateSize(){const e=this.parent.calculateWidth();e!==this._width&&(this._width=e,this.initialWidthSet?this.parent.parentContainer?(0,s.handlesAutoSizeChildren)(this.parent.parentContainer)&&this.parent.parentContainer.handleChildResize(this.parent):(0,s.handlesAutoSizeChildren)(this.parent.scene)&&this.parent.scene.handleChildResize(this.parent):this.initialWidthSet=!0)}static overrideSizeComponent(e){const t=new n(e);Object.defineProperties(e,{width:{get:()=>t.width},height:{set:e=>{t.height=e},get:()=>t.height},updateSize:{value:t.updateSize.bind(t)}})}}t.AutoWidthComponent=n},70319:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveContainer=t.AutoWidthResponsiveContainer=t.AutoHeightResponsiveContainer=t.BaseResponsiveContainer=void 0;const s=i(97866),n=i(50059),a=i(29306),o=i(24986),r=i(91633),c=i(12678);var l=Phaser.GameObjects.Container,d=Phaser.Geom.Rectangle;class h extends l{constructor(e){super(e),this.updateList=[],this.autoInteractive=!1,this.renderedLastFrame=!1,this.preUpdate=(0,s.whenDirty)((()=>{this.updateLayout(),this.autoInteractive&&this.input?.hitArea&&(this.input.hitArea=new d(this.width/2,this.height/2,this.width,this.height))}),(()=>{this.debugRect?.update(),this.willRender()?(this.preUpdateChildren(),this.renderedLastFrame=!0):this.renderedLastFrame&&(this.preUpdateChildren(),this.renderedLastFrame=!1)}))}add(e){c.assert.defined(e),super.add(e);let t=Array.isArray(e)?e:[e];for(let e of t)(0,s.hasPreUpdate)(e)&&this.updateList.push(e);return this}preUpdateChildren(){for(let e of this.updateList)e.preUpdate()}setSizeToFrame(e){throw new Error("not implemented")}setInteractiveAuto(e="pointer"){this.autoInteractive=!0,this.setInteractive({cursor:e,hitArea:new d(this.width/2,this.height/2,this.width,this.height),hitAreaCallback:d.Contains})}willRender(e){return super.willRender(e)&&(!this.parentContainer||this.parentContainer.willRender(e))}showDebugOutline(){this.debugRect||(this.debugRect=new r.DebugRectangle(this))}}class u extends h{handleChildResize(e){this.preUpdate.makeDirty()}constructor(e){super(e),n.ResponsiveSizeComponent.overrideSizeComponent(this)}}t.BaseResponsiveContainer=u,t.AutoHeightResponsiveContainer=class extends h{constructor(e){super(e),a.AutoHeightComponent.overrideSizeComponent(this)}get height(){return super.height}handleChildResize(e){this.preUpdate.makeDirty()}},t.AutoWidthResponsiveContainer=class extends h{constructor(e){super(e),o.AutoWidthComponent.overrideSizeComponent(this)}get width(){return super.width}handleChildResize(e){this.preUpdate.makeDirty()}},t.ResponsiveContainer=class extends u{updateLayout(){}}},73773:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handlesAutoSizeChildren=void 0,t.handlesAutoSizeChildren=function(e){return"function"==typeof e.handleChildResize}},97866:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasPreUpdate=t.whenDirty=void 0;const s=i(52937);t.whenDirty=function(e,t){let i=!0,n=!1;const a=(0,s.signal)(),o=()=>{i&&(i=!1,e()),t&&t()};return o.enableEagerUpdates=()=>{n=!0},o.isDirty=()=>i,o.makeDirty=()=>{i||a.fire(),i=!0,n&&o()},o.force=()=>{i=!0,o()},o.onBecameDirty=a,o},t.hasPreUpdate=function(e){return e.preUpdate}},14034:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveLayer=void 0;const s=i(97866);var n=Phaser.GameObjects.Layer;t.ResponsiveLayer=class extends n{constructor(e,t){super(e,t),this.updateList=[];for(let e of t)(0,s.hasPreUpdate)(e)&&this.updateList.push(e)}add(e,t){return(0,s.hasPreUpdate)(e)&&this.updateList.push(e),super.add(e,t)}remove(e,t){const i=this.updateList.indexOf(e);return-1!==i&&this.updateList.splice(i,1),super.remove(e,t)}preUpdate(){for(let e of this.updateList)e.preUpdate()}destroy(){super.destroy(),this.updateList.length=0}}},50059:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveSizeComponent=void 0;class i{constructor(e){this.parent=e,this._width=0,this._height=0}set height(e){this._height!==e&&(this._height=e,this.parent.preUpdate.makeDirty())}get height(){return this._height}set width(e){this._width!==e&&(this._width=e,this.parent.preUpdate.makeDirty())}get width(){return this._width}set(e,t){return this.width=e,this.height=t,this.parent}static overrideSizeComponent(e){const t=new i(e);Object.defineProperties(e,{width:{set:e=>{t.width=e},get:()=>t.width},height:{set:e=>{t.height=e},get:()=>t.height}}),e.setSize=t.set.bind(t)}}t.ResponsiveSizeComponent=i},97720:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveTextContainer=void 0;const s=i(70319);class n extends s.BaseResponsiveContainer{constructor(e,t){super(e),this.text=t,this.text.setOrigin(.5,.5),this.add(t)}updateLayout(){this.text.setPosition(this.width/2,this.height/2)}}t.ResponsiveTextContainer=n},69414:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VFXSpawner=void 0;const s=i(5893),n=i(24917),a=i(82556);t.VFXSpawner=class{constructor(e){this.scene=e,this.pool=new s.Pool((()=>this.scene.add.bitmapText(0,0,n.BitmapFont.Small).setDropShadow(1,1,16777215).setDepth(a.WorldLayers.UIOverlay).setVisible(!1).setOrigin(.5,.5)))}popupText(e,t,i){const s=this.pool.take();s.setText(t),s.setPosition(e.display.centerX,e.display.centerY-25),s.setTint(i),s.setVisible(!0),s.setDepth(a.WorldLayers.UIOverlay+s.y),this.scene.tweens.add({targets:[s],y:{from:e.display.centerY-36,to:e.display.centerY-50},alpha:{from:0,to:1},duration:500,ease:"Sine.easeOut"}),this.scene.tweens.add({targets:[s],alpha:0,duration:300,delay:800,ease:"Sine.easeIn",onComplete:()=>{s.setVisible(!1),this.pool.free(s)}})}}},82556:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.WorldLayers=void 0,(i=t.WorldLayers||(t.WorldLayers={}))[i.Landmass=0]="Landmass",i[i.Tiles=1e4]="Tiles",i[i.TileHighlight=2e4]="TileHighlight",i[i.TileBorders=3e4]="TileBorders",i[i.TileDecals=4e4]="TileDecals",i[i.TileObjects=5e4]="TileObjects",i[i.FlyingObject=6e4]="FlyingObject",i[i.UIOverlay=7e4]="UIOverlay",i[i.DebugOverlay=8e4]="DebugOverlay"},52596:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionBordersRenderer=t.WorldMapDebugOverlay=void 0;const s=i(48500),n=i(34198),a=i(82556),o=i(24917),r=i(24794),c=i(36454),l=i(50264),d=i(42233),h=i(88865);s.logger.for("WorldMapDebugOverlay"),t.WorldMapDebugOverlay=class{constructor(e,t){this.scene=e,this.renderer=t,this.signalSubs=[],this.hexDebugLabels={},this.active=!1,this.arrowsGroup=this.scene.add.group({defaultKey:"atlas",defaultFrame:"debug-arrow"}).setDepth(a.WorldLayers.DebugOverlay),this.chunkRectangles=this.scene.add.group({classType:Phaser.GameObjects.Rectangle,createCallback:e=>{const t=e;t.setStrokeStyle(1,65280,.5),t.setDepth(a.WorldLayers.DebugOverlay)}}),this.regionBorders=new u(this.renderer)}showDebugLayer(e){this.clearDebugLayer(),this.activeDebugLayer=e;const t=this.scene;if(this.regionBorders.clear(),e){h.inject.gameStateModel.map;const i=e.getMap();i.getHexIds().forEach((e=>{const s=(0,r.getHex)(e),n=i.get(s.id);null!=n&&(this.hexDebugLabels[e]?this.hexDebugLabels[e].setVisible(!0).setText(n.toString()):this.hexDebugLabels[e]=function(e,i){return new o.DebugTextBox(t,e.display.centerX,e.display.centerY,i,{origin:[.5,.5],backgroundOpacity:1}).setDepth(a.WorldLayers.DebugOverlay)}(s,n.toString()))})),(e.getArrows&&e.getArrows())?.forEach((e=>{const[t,i]=(0,r.getHexes)(e).members,s=t.getAngleTowards(i);if(void 0===s)return;const n=(t.display.centerX+i.display.centerX)/2,o=(t.display.centerY+i.display.centerY)/2;this.arrowsGroup.get(n,o).setActive(!0).setVisible(!0).setDepth(a.WorldLayers.DebugOverlay).setRotation(s)})),e.getGroups&&this.regionBorders.setGroups(e.getGroups())}}clearDebugLayer(e){this.activeDebugLayer&&(this.activeDebugLayer=void 0,this.debugLayerSub?.unsubscribe(),e?(Object.values(this.hexDebugLabels).forEach((e=>e.destroy())),this.hexDebugLabels={}):Object.values(this.hexDebugLabels).forEach((e=>e.setVisible(!1))),this.arrowsGroup.getChildren().forEach((e=>this.arrowsGroup.killAndHide(e))))}create(){this.active=!0,this.hexUnderCursor=this.scene.add.polygon(0,0,n.HEX_POLYGON).setStrokeStyle(2,255).setVisible(!1).setDepth(a.WorldLayers.DebugOverlay).setOrigin(0,0),this.registerSignals()}registerSignals(){this.unRegisterSignals(),this.signalSubs.push(h.inject.ui.hexUnderCursor.watch((e=>{e?(this.hexUnderCursor.setPosition(e.x*n.HEX_WIDTH,e.y*n.HEX_INNER_HEIGHT),this.hexUnderCursor.setVisible(!0)):this.hexUnderCursor.setVisible(!1)}))),h.inject.config.watchFuture(this.applyConfig.bind(this))}applyConfig(e){this.worldBoundsRectangle?.setVisible(!!e.debug.overlay)}unRegisterSignals(){this.signalSubs.forEach((e=>e.unsubscribe())),this.signalSubs=[]}redrawWorldBoundsRectangle(e){this.worldBoundsRectangle&&this.worldBoundsRectangle.destroy(),h.inject.config.debug.overlay&&(this.worldBoundsRectangle=this.scene.add.rectangle(e.x,e.y,e.width,e.height).setStrokeStyle(1,255,1).setDepth(a.WorldLayers.DebugOverlay).setOrigin(0,0))}showDebugRectangle(e){this.debugRectangle&&this.debugRectangle.destroy(),h.inject.config.debug.overlay&&(this.debugRectangle=this.scene.add.rectangle(e.x,e.y,e.width,e.height).setStrokeStyle(1,255,1).setDepth(a.WorldLayers.DebugOverlay).setOrigin(0,0))}showDebugPoint(e,t){this.debugPoint&&this.debugPoint.destroy(),h.inject.config.debug.overlay&&(this.debugPoint=this.scene.add.arc(e,t,4).setStrokeStyle(1,255,1).setDepth(a.WorldLayers.DebugOverlay).setOrigin(.5,.5))}redrawChunkRectangles(e){this.chunkRectangles.getChildren().forEach((e=>this.chunkRectangles.killAndHide(e))),h.inject.config.debug.chunkBorders&&e.map((e=>e.boundingBox)).forEach((e=>{const t=this.chunkRectangles.get(e.x,e.y);t.setSize(e.width,e.height),t.setVisible(!0),this.scene.add.existing(t).setDepth(a.WorldLayers.DebugOverlay)}))}destroy(e){this.unRegisterSignals(),this.clearDebugLayer(!0),this.active=!1,[this.worldBoundsRectangle,this.hexUnderCursor].forEach((e=>e?.destroy()))}setVisible(e){this.active!==e&&(e?this.create():this.destroy())}};class u{constructor(e){this.renderer=e,this.groups=[]}syncWithState(e=h.inject.currentGameState){this.clear();const t=l.Regions.model(e).all().map((e=>e.hexes));this.setGroups(t)}setGroups(e){e.filter((e=>e.length>0)).forEach((e=>{const t=new c.IsoTileGroup(this.renderer,d.IsoTileRecipes.Highlight,(e=>{}));t.setHexes(e),this.groups.push(t)}))}clear(){this.groups.forEach((e=>e.clear())),this.groups=[]}}t.RegionBordersRenderer=u},21361:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapEditorOverlay=void 0;const s=i(48500),n=i(34198),a=i(82556),o=i(78153),r=i(88865);s.logger.for("WorldMapEditorOverlay"),t.WorldMapEditorOverlay=class{constructor(e){this.scene=e,this.signalSubs=[],this.active=!1}create(){this.active=!0,this.worldBoundsRectangle=this.scene.add.rectangle(0,0,0,0).setStrokeStyle(1,16777215,.5).setDepth(a.WorldLayers.UIOverlay).setOrigin(0,0),this.hexUnderCursor=this.scene.add.polygon(0,0,n.HEX_POLYGON).setStrokeStyle(1,16777215,.5).setFillStyle(16777215,.2).setVisible(!1).setDepth(a.WorldLayers.UIOverlay).setOrigin(0,0),this.scene.add.existing(this.worldBoundsRectangle),this.scene.add.existing(this.hexUnderCursor),this.registerSignals()}setVisible(e){this.worldBoundsRectangle||this.create(),this.worldBoundsRectangle.setVisible(e),this.hexUnderCursor.setVisible(e),this.active=e,e?this.registerSignals():this.unRegisterSignals()}registerSignals(){this.unRegisterSignals(),this.signalSubs.push(r.inject.ui.hexUnderCursor.watch((e=>{e&&!e.isAtGridBorder(r.inject.gameStateModel.map)?(this.hexUnderCursor.setPosition(e.x*n.HEX_WIDTH,e.y*n.HEX_INNER_HEIGHT),this.hexUnderCursor.setVisible(!0)):this.hexUnderCursor.setVisible(!1)})))}unRegisterSignals(){this.signalSubs.forEach((e=>e.unsubscribe())),this.signalSubs=[]}update(){if(this.active){const e=(0,o.getWorldBounds)(r.inject.gameStateModel.map.innerWidth,r.inject.gameStateModel.map.innerHeight);this.worldBoundsRectangle.setPosition(n.HEX_WIDTH/2,n.HEX_INNER_HEIGHT),this.worldBoundsRectangle.setSize(e.width,e.height-o.EXTRA_SPACE_FOR_CONTROL_PANEL)}}}},57942:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AttitudeEmojiManager=void 0;const s=i(48500),n=i(5436),a=i(78179),o=i(41959);s.logger.for("AttitudeEmoji"),t.AttitudeEmojiManager=class{constructor(e,t,i){this.scene=e,this.pool=t,this.tiles=i,this.emojis=new Map,this.originFaction=void 0,this.alpha=1,this.focusedHex=void 0}clear(){Array.from(this.emojis.keys()).forEach((e=>this.remove(e))),this.originFaction=void 0}syncWithModel(e,t,i=1){const s=t??e.currentPhase.faction;this.clear(),this.originFaction=s,this.alpha=i,s&&this.updateAll(e.factions)}setFocusedHex(e){const t=(0,o.getCurrentGameStateModel)().regions;this.focusedHex=e;const i=e?t.byHex(e):void 0;for(let[s,n]of this.emojis.entries())void 0!==i&&t.byHex(s)===i?n.lookAtHex(e):n.resetLook()}updateAll(e){if(this.originFaction)for(let t of e.all())t.id===this.originFaction.id||t.isLocalPlayer()||this.update(t,this.originFaction)}update(e,t,i=0){const s=a.HexGroup.union(e.getRegions().map((e=>e.getTownHexes())));for(let n of s){const s=e.approvalOf(t)+i,a=e.fearOf(t);this.setHex(n,a,s),i&&this.emojis.get(n).reactTo({approvalDelta:i,newApproval:s,fear:a})}}setHex(e,t,i){const s=this.emojis.get(e);if(s&&!s.isDestroyed)s.setAttitude(t,i),s.setAlpha(this.alpha);else{const s=new n.EmojiObject(this.pool);s.attachToTile(this.tiles.getByHex(e.id)),this.emojis.set(e,s),s.setAttitude(t,i),s.setAlpha(this.alpha),this.focusedHex&&this.focusedRegion?.id===(0,o.getCurrentGameStateModel)().regions.byHex(this.focusedHex)?.id?s.lookAtHex(this.focusedHex):s.resetLook()}}get focusedRegion(){if(this.focusedHex)return(0,o.getCurrentGameStateModel)().regions.byHex(this.focusedHex)}remove(e){const t=this.emojis.get(e);t&&(t.destroy(),this.emojis.delete(e))}getAll(){return Array.from(this.emojis.values())}}},5436:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EmojiObject=t.Cooldown=void 0;const s=i(71234),n=i(12678),a=i(82556),o=i(48500),r=i(58592),c=i(54444),l=i(88865),d=i(97119),h=i(17947),u=i(54812),p=i(52937);o.logger.for("AttitudeEmoji");class g{constructor(e){this.delay=e,this.onFinished=(0,p.signal)(),this.currentTimer=void 0}start(){this.currentTimer&&clearTimeout(this.currentTimer),this.currentTimer=setTimeout((()=>this.onFinished.fire()),this.delay)}isRunning(){return!!this.currentTimer}cancel(){this.currentTimer&&clearTimeout(this.currentTimer),this.currentTimer=void 0}}t.Cooldown=g,t.EmojiObject=class{constructor(e){this.pools=e,this.isDestroyed=!1,this.tile=void 0,this.tween=void 0,this.tweener=new d.Tweener(this.pools.scene),this.emotionCooldown=new g(750),this.restingFaceIndex=12,this.face=this.pools.getEmojiFace(12),this.faceBg=this.pools.getEmojiFaceBg(),this.crown=this.pools.getEmojiCrown(),this.emotionCooldown.onFinished((()=>{this.showRestingFace()}))}attachToTile(e){(0,n.assert)(!this.isDestroyed),this.tile=e,e.addObject(this.faceBg,0,-28),e.addObject(this.crown,0,-32),e.addObject(this.face,0,-26),this.faceBg.setDepth(a.WorldLayers.UIOverlay),this.face.setDepth(a.WorldLayers.UIOverlay+1),this.crown.setDepth(a.WorldLayers.UIOverlay+2)}setAttitude(e,t){const i=this.face.originX,s=this.face.originY;this.setRestingFace((0,h.getAttitudeIndex)(e,t)),this.face.setOrigin(i,s),this.faceBg.setTint((0,h.getApprovalColor)(e,t))}setRestingFace(e){this.restingFaceIndex=e,this.emotionCooldown.isRunning()||this.showRestingFace()}showRestingFace(){this.face.setFrame((0,s.getFrameForEmojiFace)(this.restingFaceIndex))}showEmotion(e){this.face.setFrame("attitude-emoji/"+e),this.emotionCooldown.start()}setAlpha(e){this.faceBg.setAlpha(e),this.face.setAlpha(e),this.crown.setAlpha(e)}detachFromTile(){this.tile&&(this.tile.removeObject(this.face),this.tile.removeObject(this.crown),this.tile.removeObject(this.faceBg))}reactTo(e){const t=Math.round(e.approvalDelta);this.tile&&0!==t&&(l.inject.config.flags.seeEnemyAttitudes&&r.app.scene.worldMap.vfx.popupText(this.tile.hex,(0,c.withSign)(e.approvalDelta),t>0?65280:16711680),t<-5&&!this.tweener.hasTweens()&&this.reactWithShock(e),t>5&&this.spawnWithHearts(e))}lookAtHex(e){if(!this.tile)return;const t=.1,i=(0,u.cropNumber)(this.tile.hex.x-e.x,-t,t),s=(0,u.cropNumber)(this.tile.hex.y-e.y,-t,t);this.face.setOrigin(.5+i,.5+s)}resetLook(){this.face.setOrigin(.5,.5)}reactWithShock(e){if(e.newApproval>100)return;this.showEmotion(this.pickEmotion(e));const t=Math.sqrt(Math.abs(e.approvalDelta)),i=100+4*t,s=t>=5?1.5*t:t,n=l.inject.random.numberBetween(0,100);this.tweener.add({targets:[this.face,this.faceBg],y:"-="+t,ease:"Sine.easeOut",delay:n,yoyo:!0,duration:i}),this.tweener.add({targets:[this.crown],y:"-="+s,ease:"Sine.easeOut",delay:n,yoyo:!0,duration:i})}pickEmotion(e){const t=e.newApproval-e.approvalDelta;return e.approvalDelta<-100?"shock-2":t>-h.APPROVAL_MINOR_THRESHOLD&&e.fear<-h.FEAR_THRESHOLD?"shock-0":t<-h.APPROVAL_MINOR_THRESHOLD&&e.fear<h.FEAR_THRESHOLD?"0":e.approvalDelta<-100?"shock-2":"shock-1"}destroy(){(0,n.assert)(!this.isDestroyed),this.detachFromTile(),this.pools.free(this.face),this.pools.free(this.faceBg),this.pools.free(this.crown),this.isDestroyed=!0}spawnWithHearts(e){if(e.newApproval-e.approvalDelta<-h.APPROVAL_MINOR_THRESHOLD)return;const t=Math.ceil(e.approvalDelta/10),i=Array(t).fill(null).map(((e,t)=>this.pools.getHeart().setDepth(a.WorldLayers.UIOverlay+t))),s=(e,t,i,s)=>200*s;i.forEach((e=>{e.setAlpha(0)})),this.pools.scene.tweens.add({targets:i,x:{from:this.tile.hex.display.centerX,to:()=>this.tile.hex.display.centerX+l.inject.random.numberBetween(-10,10)},y:{from:this.tile.hex.display.centerY-36,to:this.tile.hex.display.centerY-60+l.inject.random.numberBetween(0,10)},delay:s,ease:"Sine.easeOut",duration:800,alpha:{from:0,to:1}}),this.pools.scene.tweens.add({targets:i,delay:(e,t,i,n)=>800+s(0,0,0,n),duration:200,alpha:{from:1,to:0},onComplete:()=>{i.forEach((e=>this.pools.free(e)))}})}}},94220:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CameraScrollController=void 0;const s=i(48500),n=i(42526),a=i(65337),o=i(58592);s.logger.for("ui:camera"),t.CameraScrollController=class{constructor(e){this.camera=e,this.dragging=!1,this.dragMomentumX=0,this.dragMomentumY=0,this.drag=3e3,this.dragStartPosition={x:0,y:0},this.scene=this.camera.scene;const t=this;this.cameraX=new a.KineticValue(e.scrollX,{scene:this.scene,drag:this.drag,apply:e=>this.camera.scrollX=e,stops:{getNextFrom:e=>e<t.bounds.left?t.bounds.left:void 0,getPreviousFrom:e=>e>t.bounds.right-t.camera.width?t.bounds.right-t.camera.width:void 0}}),this.cameraY=new a.KineticValue(0,{drag:this.drag,scene:this.scene,apply:e=>{this.camera.scrollY=e},stops:{getNextFrom:e=>e<t.bounds.top?t.bounds.top:void 0,getPreviousFrom:e=>e>t.bounds.bottom-t.camera.height?t.bounds.bottom-t.camera.height:void 0}}),this.pointer=this.scene.input.activePointer,this.scene.input.on("pointermove",this.pointerDragHandler,this),this.scene.events.on("update",this.update,this)}detach(){this.scene.input.removeListener("pointermove",this.pointerDragHandler),this.scene.input.removeListener("update",this.update)}update(e,t){this.dragMomentumX*=.8,this.dragMomentumY*=.8,this.cameraX.update(e,t),this.cameraY.update(e,t)}startDrag(){this.dragging=!0,this.dragStartPosition={x:this.cameraX.value,y:this.cameraY.value},this.dragCursorIconOn(),this.cameraX.freeze(),this.cameraY.freeze(),o.app.tooltips.close()}async panTo(e,t,i=0,s=this.camera.zoom){this.camera.width,this.camera.height;const n=e-this.camera.midPoint.x,a=t-this.camera.midPoint.y,o=[];if(Math.abs(n)>=1){const e=this.cameraX.value+n;0===i?this.cameraX.setTo(e):o.push(this.cameraX.tweenTo(e,i,"Sine.easeInOut"))}if(Math.abs(a)>=1){const e=this.cameraY.value+a;0===i?this.cameraY.setTo(e):o.push(this.cameraY.tweenTo(e,i,"Sine.easeInOut"))}o.length>0&&await Promise.all(o)}dragCursorIconOn(){this.scene.game.canvas.style.cursor="grabbing"}dragCursorIconOff(){this.scene.game.canvas.style.cursor="default"}pointerDragHandler(e){if(this.dragging){if(!e.isDown)return this.cameraX.unfreeze(),this.cameraY.unfreeze(),void this.stopDragging();const t=e.position.x-e.prevPosition.x,i=e.position.y-e.prevPosition.y;this.dragMomentumX-=10*t,this.dragMomentumY-=10*i,this.cameraX.setTo(this.cameraX.value-t/this.camera.zoom),this.cameraY.setTo(this.cameraY.value-i/this.camera.zoom)}}stopDragging(){if(this.dragging){this.dragging=!1;const e=(0,n.euclidDistance)(this.dragStartPosition,{x:this.cameraX.value,y:this.cameraY.value});return this.cameraX.unfreeze(),this.cameraY.unfreeze(),this.cameraX.accelerate(this.dragMomentumX),this.cameraY.accelerate(this.dragMomentumY),this.dragCursorIconOff(),e}return 0}setBounds(e){this.bounds=e,this.cameraX.unfreeze(),this.cameraY.unfreeze()}}},75413:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CameraZoomController=void 0;const s=i(48500),n=i(65337),a=i(58592);s.logger.for("ui:camera"),t.CameraZoomController=class{constructor(e){this.pinchStartPointerDistance=0,this.pinchStartCameraDistance=0,this.camera=e.camera,this.scene=e.camera.scene,this.cameraDistance=new n.KineticValue(1/this.camera.zoom,{scene:this.scene,drag:20,min:.2,continueToNextStopThreshold:.1,stops:[.25,.5,.75,1,1.5,2,3],apply:e=>this.camera.setZoom(1/e)})}applyScroll(e){0!==e&&this.cameraDistance.accelerate(.02*e)}startPinchZoom(){this.pinchStartPointerDistance=a.app.scene.worldMap.pointersTracker.distanceBetweenPointers,this.cameraDistance.freeze(),this.pinchStartCameraDistance=this.cameraDistance.value}stopPinchZoom(){this.cameraDistance.unfreeze(),this.pinchStartCameraDistance=0,this.pinchStartPointerDistance=0}get isPinchZooming(){return 0!==this.pinchStartCameraDistance}update(e,t){if(this.isPinchZooming){const e=a.app.scene.worldMap.pointersTracker.distanceBetweenPointers,t=this.pinchStartPointerDistance/e;this.cameraDistance.setTo(this.pinchStartCameraDistance*t)}else this.cameraDistance.update(e,t)}}},67945:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapCameraController=t.inverseDirection=void 0;const s=i(94220),n=i(75413),a=i(78153),o=i(42526),r=i(88865),c=i(58592),l=i(23441);var d=Phaser.Geom.Rectangle;t.inverseDirection=function(e){if(!e)return e;switch(e){case"up":return"down";case"down":return"up";case"left":return"right";case"right":return"left"}},t.WorldMapCameraController=class{constructor(e){this.scene=e,this.viewPortMargins={left:0,right:0,top:0,bottom:0},this.camera=this.scene.cameras.main,this.camera.roundPixels=!0,this.zoomController=new n.CameraZoomController({camera:this.camera}),this.scrollController=new s.CameraScrollController(this.camera),this.zoomController.cameraDistance.setTo(1/r.inject.ui.scale())}setViewportMargins(e){const{x:t,y:i}=this.camera,s={left:0,right:0,bottom:0,top:0,...e},n=(s.left-t)/this.camera.zoom,a=(s.top-i)/this.camera.zoom;this.viewPortMargins=s,this.updateViewPort(),this.updateBounds(),this.scrollController.cameraX.setTo(this.scrollController.cameraX.value+n),this.scrollController.cameraY.setTo(this.scrollController.cameraY.value+a)}updateBounds(e){const t=r.inject.gameStateModel;this.worldBounds=(0,a.getWorldBounds)(t.map.width,t.map.height),r.inject.debugData.set("worldBounds",`${this.worldBounds.x},${this.worldBounds.y},${this.worldBounds.width},${this.worldBounds.height}`),this.updateCameraBounds()}updateCameraBounds(){if(!this.worldBounds)return;const e=this.camera.width/2,t=this.camera.height/2,i=new d(this.worldBounds.x-e,this.worldBounds.y-t,this.worldBounds.width+2*e,this.worldBounds.height+2*t);return this.scrollController.setBounds(i),r.inject.debugData.set("camBounds",`${i.x},${i.y} -> ${i.width},${i.height}`),i}async centerAboveControlPanel(e=0){this.updateBounds(),this.camera.preRender(),await this.scrollController.panTo(this.worldBounds.centerX,this.worldBounds.height-this.camera.displayHeight/2+a.EXTRA_SPACE_FOR_CONTROL_PANEL/2,e)}async center(e=0,t){this.updateBounds(t),this.camera.preRender(),t&&this.zoomController.cameraDistance.tweenTo(t,e,"Sine.easeInOut"),await this.scrollController.panTo(this.worldBounds.centerX,this.worldBounds.centerY,e,t)}savePreset(){return{x:this.camera.midPoint.x,y:this.camera.midPoint.y,distance:this.zoomController.cameraDistance.value}}async panTo(e,t=0){const i=1/e.distance;await Promise.all([this.scrollController.panTo(e.x,e.y,t,i),this.zoomController.cameraDistance.tweenTo(e.distance,t,"Sine.easeInOut")])}async panAway(e,t=1e3){this.updateBounds();const[i,s]=[this.camera.midPoint.x,this.camera.midPoint.y],n={up:[i,s+this.camera.worldView.centerY+this.worldBounds.height+100],down:[i,s-this.camera.worldView.centerY-this.worldBounds.height-100],left:[i+this.worldBounds.centerX+this.worldBounds.width+100,s],right:[i-this.worldBounds.centerX-this.worldBounds.width-100,s]};let[a,o]=n[e];await this.scrollController.panTo(a,o,t)}async panIntoCenter(e,t=1e3){this.updateBounds();const[i,s]=[this.camera.midPoint.x,this.camera.midPoint.y],n={down:[i,this.worldBounds.height+c.app.device.screenHeight],up:[i,-this.camera.displayHeight],left:[-this.camera.displayWidth,s],right:[this.camera.displayWidth,s]};let[a,o]=n[e];await this.scrollController.panTo(a,o),await this.center(t)}async ensureRectVisible(e,t={}){const i=t.padding??40,s=t.allowZoom??!0;let n=d.Clone(this.camera.worldView),a=this.zoomController.cameraDistance.value;if(n.bottom-=c.app.scene.playUI.getBottomPanelHeight()+5,0!==n.width){if(c.app.scene.worldMap.debugOverlay.showDebugRectangle(e),!d.ContainsRect(n,e)){for(e=d.Inflate(e,i,i);(e.width>n.width||e.height>n.height)&&s;)a*=2,d.Inflate(n,n.width/2,n.height/2);let t=n.centerX,r=n.centerY;const h=n.x-e.x,u=e.right-n.right,p=n.y-e.y,g=e.bottom-n.bottom;e.width>n.width?t=e.left+e.width/2:h>0?t-=h:u>0&&(t+=u),e.height>n.height?r=e.top+e.height/2:p>0?r-=p:g>0&&(r+=g);const m=Math.abs(this.zoomController.cameraDistance.value-a),y=(0,l.pickLarger)((0,o.manhattanDistance)({x:n.centerX,y:n.centerY},{x:t,y:r}),100*m);c.app.scene.worldMap.debugOverlay.showDebugPoint(t,r),await this.panTo({x:t,y:r,distance:a},y)}}else console.warn("viewRect is 0 width")}startDragScroll(){this.scrollController.startDrag()}stopDragScroll(){this.scrollController.stopDragging()}updateViewPort(){const e=this.viewPortMargins,t=this.scene.bounds.width-e.right-e.left,i=this.scene.bounds.height-e.top-e.bottom;this.camera.setSize(t,i)}update(e,t){this.zoomController.update(e,t),this.scrollController.update(e,t)}}},78153:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getWorldBounds=t.EXTRA_SPACE_FOR_CONTROL_PANEL=void 0;var s=Phaser.Geom.Rectangle;const n=i(34198);t.EXTRA_SPACE_FOR_CONTROL_PANEL=100,t.getWorldBounds=function(e,i){let a=e*n.HEX_WIDTH,o=(i-1)*n.HEX_INNER_HEIGHT+n.HEX_HEIGHT+t.EXTRA_SPACE_FOR_CONTROL_PANEL;return new s(-n.HEX_WIDTH/2,0,a+n.HEX_WIDTH/2,o)}},68040:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Chest=void 0;const s=i(59228),n=i(48500),a=i(82556),o=i(88865);var r=Phaser.GameObjects.Image;const c=n.logger.for("coins");t.Chest=class extends r{constructor(e){super(e.scene,0,0,"atlas","chest"),this.pools=e,this.scene=this.pools.scene,this.currentAmount=0}addToTile(e,t,i){e.addObject(this,t,i)}addCoins(e){this.currentAmount+=e,this.updateVisibility()}consumeCoins(e){this.currentAmount+=e.length,this.updateVisibility(),o.inject.ui.skipTransitions()?e.forEach((e=>this.pools.free(e))):e.forEach(((e,t)=>{e.setDepth(a.WorldLayers.FlyingObject+10*this.y),(0,s.consumeCoin)(this.pools,e,this.x,this.y)}))}deleteCoins(e,t){this.currentAmount<e?(c.warning(`Attempted to delete ${e} coins from a virtual stack that already has only ${this.currentAmount} coins. Extra coins not deleted.`),this.currentAmount=0):this.currentAmount-=e,this.updateVisibility()}updateVisibility(){this.setVisible(this.currentAmount>0)}remainingCapacity(){return Number.POSITIVE_INFINITY}removeFromTile(e){e.removeObject(this)}spawnCoin(){return this.y,this.currentAmount-=1,this.updateVisibility(),this.pools.getCoin(this.x,this.y)}}},86244:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinPile=t.StackType=void 0;const s=i(48500),n=i(59228),a=i(34198),o=i(23441),r=i(20914),c=i(68040),l=i(88865);var d;!function(e){e[e.Regular=0]="Regular",e[e.Virtual=1]="Virtual",e[e.Chest=2]="Chest"}(d=t.StackType||(t.StackType={}));const h=[{x:-8,y:10,maxSize:5,type:d.Regular},{x:-12,y:6,maxSize:10,type:d.Regular},{x:-8,y:-2,maxSize:15,type:d.Regular},{x:6,y:-2,maxSize:12,type:d.Regular},{x:0,y:-6,maxSize:20,type:d.Regular},{x:13,y:8,maxSize:Number.POSITIVE_INFINITY,type:d.Chest}],u=s.logger.for("coins");t.CoinPile=class{constructor(e,t,i){this.pools=e,this.tiles=t,this.hex=i,this.stacks=[],this.overflowStack=new c.Chest(this.pools)}getCurrentAmount(){return this.stacks.map((e=>e.currentAmount)).reduce(o.sum,0)}addCoins(e){let t=e;for(;t>0;){const e=this.getOrCreateStackWithFreeCapacity();if(!e)return;e.remainingCapacity()>t?(e.addCoins(t),t=0):(t-=e.remainingCapacity(),e.addCoins(e.remainingCapacity()))}}setAmount(e){const t=e-this.getCurrentAmount();t>0?this.addCoins(t):t<0&&this.deleteCoins(-t)}deleteCoins(e){let t=e;for(;t>0;){const i=this.getLatestStack();if(!i)return void u.warning(`unable to delete ${e} coins from ${this.hex}, hex is already empty of coins`);i.currentAmount>t?(i.deleteCoins(t),t=0):(t-=i.currentAmount,i.deleteCoins(i.currentAmount,(()=>{this.destroyStack(i)})),this.stacks.pop())}}getLatestStack(){return this.stacks[this.stacks.length-1]}storeCoins(e){let t=[...e];for(;t.length>0;){const e=this.getOrCreateStackWithFreeCapacity();if(!e)return void this.stacks[this.stacks.length-1].consumeCoins(t);{const i=t.splice(0,e.remainingCapacity());e.consumeCoins(i)}}}spawnCoin(){const e=this.getLatestStack();if(e&&0!==e.currentAmount){const t=e.spawnCoin();return 0===e.currentAmount&&(this.destroyStack(e),this.stacks.pop()),t}return u.warning(`Spawning coin from pile at ${this.hex}, but the pile is empty => new coin created from nothing`),this.pools.getCoin((this.hex.x+.5)*a.HEX_WIDTH,this.hex.y*a.HEX_INNER_HEIGHT+a.HEX_HEIGHT/2+l.inject.random.integerBetween(-2,2))}destroy(){this.stacks.forEach((e=>{this.destroyStack(e)})),this.stacks=[]}getOrCreateStackWithFreeCapacity(){const e=this.stacks.find((e=>e.remainingCapacity()>0))||this.addStack();return e||u.warning(`Max displayable coin pile size exceeded at hex ${this.hex}. You have too much money!`),e}destroyStack(e){e.removeFromTile(this.tiles.getByHex(this.hex.id)),e.destroy()}addStack(){const e=h[this.stacks.length];if(!e)return;const t=this.createStackByType(e.type,e.maxSize);return this.stacks.push(t),t.addToTile(this.tiles.getByHex(this.hex.id),e.x,e.y),t}createStackByType(e,t){switch(e){case d.Regular:return new n.CoinStack(this.pools,t);case d.Chest:return new c.Chest(this.pools);case d.Virtual:return new r.VirtualStack(this.pools)}}}},59228:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.consumeCoin=t.CoinStack=t.COIN_SPRITE_SCALE=t.COIN_THICKNESS=t.COIN_FACE_SIZE=void 0;const s=i(48500),n=i(82556),a=i(64849),o=i(96486),r=i(12678),c=i(88865);var l=Phaser.GameObjects.Container;const d=s.logger.for("coins");async function h(e,t,i,s){if(!c.inject.ui.skipTransitions())return new Promise((n=>{e.scene.tweens.add({targets:t,x:i,y:s,ease:"Sine.easeOut",duration:600,onComplete:()=>{n(),setTimeout((()=>e.free(t)),10)}})}));e.free(t)}t.COIN_FACE_SIZE=5,t.COIN_THICKNESS=2,t.COIN_SPRITE_SCALE=.5,t.CoinStack=class extends l{constructor(e,t){super(e.scene,0,0),this.pools=e,this.capacity=t,this.currentAmount=0,(0,a.assignObjId)(this)}addToTile(e,t,i){e.addObject(this,t,i)}removeFromTile(e){e.removeObject(this)}remainingCapacity(){return this.capacity-this.currentAmount}acquireSprites(){this.column=this.pools.getCoinStack(0,0),this.topCoin=this.pools.getCoin(0,-t.COIN_THICKNESS),this.cropRect=new Phaser.Geom.Rectangle(0,this.column.height-t.COIN_THICKNESS,this.column.width,t.COIN_THICKNESS),this.column.setCrop(this.cropRect),this.add([this.column,this.topCoin])}acquireSpritesIfNeeded(){this.column||this.acquireSprites()}updateSize(){if(this.stopAllTransitions(),0!==this.currentAmount){const e=this.getTargetSize();this.acquireSpritesIfNeeded(),r.assert.defined(this.topCoin),r.assert.defined(this.column),this.topCoin.y=this.column.y-e,this.topCoin.setAlpha(this.currentAmount>0?1:0),this.cropRect=new Phaser.Geom.Rectangle(0,this.column.height-e/t.COIN_SPRITE_SCALE,this.column.width,e/t.COIN_SPRITE_SCALE),this.column.setCrop(this.cropRect)}else this.freeSpritesIfEmpty()}getTargetSize(){return this.getSizeForAmount(this.currentAmount)}getSizeForAmount(e){return 0===e?t.COIN_THICKNESS:e*t.COIN_THICKNESS+1}freeSpritesIfEmpty(){0===this.currentAmount&&(this.column&&(this.remove(this.column),this.pools.free(this.column),this.column=void 0),this.topCoin&&(this.remove(this.topCoin),this.pools.free(this.topCoin),this.topCoin=void 0))}stopAllTransitions(){this.currentTransition&&(this.currentTransition.forEach((e=>e.stop())),this.currentTransition=void 0)}transitionSize(){return new Promise((e=>{let i=this.getTargetSize();const s=Math.abs(i-(this.cropRect?.height||0));if(0===s)return void e();const n=10*s;this.stopAllTransitions(),this.acquireSpritesIfNeeded(),r.assert.defined(this.column),this.currentTransition=[this.scene.tweens.add({targets:this.cropRect,height:i/t.COIN_SPRITE_SCALE,y:this.column.height-i/t.COIN_SPRITE_SCALE,duration:n,onUpdate:()=>this.column.setCrop(this.cropRect)}).on(Phaser.Tweens.Events.TWEEN_COMPLETE,(()=>{this.freeSpritesIfEmpty(),e()})),this.scene.tweens.add({targets:this.topCoin,props:{y:{duration:n,value:this.column.y-i},alpha:{value:1,duration:0}}})]}))}addCoins(e,t=o.noop){e>this.remainingCapacity()?this.currentAmount=this.capacity:this.currentAmount+=e,c.inject.ui.skipTransitions()?(this.updateSize(),t()):this.transitionSize().then(t)}consumeCoins(e){this.currentAmount<this.capacity&&(this.currentAmount+=e.length),c.inject.ui.skipTransitions()?(e.forEach((e=>this.pools.free(e))),this.updateSize()):e.forEach(((e,t)=>{const i=this.y-this.getSizeForAmount(this.currentAmount-t);e.setDepth(n.WorldLayers.TileObjects+this.y-.01*i),h(this.pools,e,this.x,i).then((()=>this.updateSize()))}))}spawnCoin(){this.acquireSpritesIfNeeded();const e=this.y-this.getTargetSize();this.currentAmount-=1;const t=this.pools.getCoin(this.x,e);return this.updateSize(),t}destroy(){this.stopAllTransitions(),this.currentAmount=0,this.freeSpritesIfEmpty(),super.destroy()}deleteCoins(e,t=o.noop){this.currentAmount<e?(d.warning(`Attempted to delete ${e} coins to a stack that already has only ${this.currentAmount}/${this.capacity} coins. Extra coins not deleted.`),this.currentAmount=0):this.currentAmount-=e,c.inject.ui.skipTransitions()?(this.updateSize(),t()):this.transitionSize().then(t)}},t.consumeCoin=h},10839:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinTransactionCinematic=void 0;const s=i(20327),n=i(24794),a=i(34198),o=i(82556),r=i(90617),c=i(12678),l=i(48500),d=i(88865);l.logger.for("CoinTransactionCinematic");class h extends s.BaseCinematic{constructor(e,t){super(e.scene),this.coins=e,this.transactions=t}execute(e){const t=this.scene,i={},s={};let r=0;const l=this.transactions,h=this.coins;for(let e in l){const t=(0,n.getHex)(Number(e));c.assert.defined(t);const h=l[e],u=[];for(let e=0;e<h.spawn;++e){const e=this.coins.pools.getCoin((t.x+.5)*a.HEX_WIDTH,t.y*a.HEX_INNER_HEIGHT+a.HEX_HEIGHT/2+d.inject.random.integerBetween(-2,2));e.setDepth(o.WorldLayers.FlyingObject+e.y),u.push(e),this.scene.add.existing(e),e.setAlpha(0)}d.inject.ui.skipTransitions()||this.animateCoinSpawn(u),r+=u.length,i[e]=u,s[e]=h.consume||0}if(d.inject.ui.skipTransitions())u(),p(),e&&e();else{const e=r>0?1e3:0;this.scene.time.addEvent({delay:e,callback:u})}function u(){let s=!1;for(let e in l){const t=(0,n.getHex)(Number(e));c.assert.defined(t);const a=l[e],r=Object.values(a.send).reduce(((e,t)=>e+t),0);for(let s=a.spawn;s<r;++s){const s=h.getOrCreatePile(t).spawnCoin();s.setDepth(o.WorldLayers.FlyingObject-s.y),i[e].push(s),h.scene.add.existing(s)}for(let t in a.send){const o=(0,n.getHex)(Number(t)),r=a.send[t];c.assert.defined(o);const l=i[e];r>0&&(s=!0,h.getOrCreatePile(o).storeCoins(l.slice(0,r))),i[e]=i[e].slice(r)}i[e].length>0&&h.getOrCreatePile(t).storeCoins(i[e])}if(!d.inject.ui.skipTransitions()){const i=s?600:0;t.time.addEvent({delay:i+100,callback:p}),t.time.addEvent({delay:i+600,callback:e})}}function p(){for(let e in l){const t=(0,n.getHex)(Number(e));c.assert.defined(t);const i=l[e].consume;0!==i&&h.getOrCreatePile(t).deleteCoins(i)}}}animateCoinSpawn(e){const t=e.map((()=>d.inject.random.integerBetween(-100,100)));e.forEach(((e,i)=>{this.scene.time.addEvent({delay:t[i],callback:()=>{e.play("spin-coin")}})})),this.scene.tweens.add({targets:e,duration:500,y:"-=1",ease:r.jump,easeParams:[80],delay:(e,i,s,n)=>t[n],onComplete:()=>e.forEach((e=>{e.anims.stop(),e.setFrame(0)}))}),this.scene.tweens.add({targets:e,duration:500,x:e=>e.x+d.inject.random.integerBetween(-4,4),alpha:{from:0,to:1},delay:(e,i,s,n)=>t[n]})}}t.CoinTransactionCinematic=h},59889:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinsManager=void 0;const s=i(48500),n=i(85656),a=i(86244),o=i(24794),r=i(10839),c=i(23441),l=i(30420),d=i(91539);s.logger.for("coins"),t.CoinsManager=class{constructor(e,t,i){this.scene=e,this.pools=t,this.tiles=i,this.piles={},this.coinTransactionsQueue=new d.AsyncJobQueue((async e=>{await new r.CoinTransactionCinematic(this,e).play()}))}async play(e){0!==Object.keys(e).length&&(this.coinTransactionsQueue.addJob(e),await this.coinTransactionsQueue.jobsComplete())}spawnOnHex(e,t){this.getOrCreatePile(e).addCoins(t)}setAmount(e,t){0===t?this.destroyPileAt(e.id):this.getOrCreatePile(e).setAmount(t)}syncWithModel(e){const t=e.pawns.select({type:[l.PawnType.Coins]}),i=new Set;for(const e of t)this.setAmount(e.hex,e.count),e.count>0&&i.add(e.hex.id);for(const e in this.piles)i.has(Number(e))||this.destroyPileAt(Number(e))}applyTransactions(e){const t={};for(let i of Object.keys(e).map((e=>Number(e)))){const s=e[i];Object.entries(s.send).forEach((([e,i])=>{const s=Number(e);t[s]?t[s]+=i:t[s]=i}))}const i=(0,n.stripDuplicatesFrom)(Object.keys(e).concat(Object.keys(t)).map((e=>Number(e))));for(let s of i){const i=e[s]||{spawn:0,send:[],consume:0},n=Object.values(i.send).reduce(c.sum,0),a=i?.spawn+(t[s]??0)-n-i.consume;a>0?this.spawnOnHex((0,o.getHex)(s),a):a<0&&this.removeFromHex((0,o.getHex)(s),-a)}}removeFromHex(e,t){this.getOrCreatePile(e).deleteCoins(t)}getOrCreatePile(e){return(0,n.getOrCreate)(this.piles,e.id,(()=>new a.CoinPile(this.pools,this.tiles,e)))}getAllPiles(){return Object.values(this.piles)}destroyPileAt(e){const t=this.piles[e];t&&(t.destroy(),delete this.piles[e])}destroyCoins(){Object.values(this.piles).forEach((e=>{e.destroy()})),this.piles={}}}},20914:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VirtualStack=void 0;const s=i(59228),n=i(48500),a=i(82556),o=i(88865),r=n.logger.for("coins");t.VirtualStack=class{constructor(e){this.pools=e,this.scene=this.pools.scene,this.currentAmount=0,this.x=0,this.y=0}setPosition(e,t){this.x=e,this.y=t}addCoins(e){this.currentAmount+=e}consumeCoins(e){this.currentAmount+=e.length,o.inject.ui.skipTransitions()?e.forEach((e=>this.pools.free(e))):e.forEach(((e,t)=>{e.setDepth(a.WorldLayers.FlyingObject+10*this.y),(0,s.consumeCoin)(this.pools,e,this.x,this.y)}))}deleteCoins(e,t){this.currentAmount<e?(r.warning(`Attempted to delete ${e} coins from a virtual stack that already has only ${this.currentAmount} coins. Extra coins not deleted.`),this.currentAmount=0):this.currentAmount-=e}destroy(){}remainingCapacity(){return Number.POSITIVE_INFINITY}addToTile(e,t,i){}removeFromTile(e){}spawnCoin(){return this.y,this.currentAmount-=1,this.pools.getCoin(this.x,this.y)}}},6914:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnObject=t.Highlight=t.PawnObjectModes=t.PAWN_SHADOW_SCALE_AT_MAX_JUMP=t.PAWN_JUMPING_HEIGHT=t.SYMBOL_VERTICAL_OFFSET=void 0;const s=i(82556),n=i(48500),a=i(80347),o=i(71234),r=i(90617),c=i(12678),l=i(97119),d=i(5715);var h,u;n.logger.for("PawnsManager"),t.SYMBOL_VERTICAL_OFFSET=-25,t.PAWN_JUMPING_HEIGHT=8,t.PAWN_SHADOW_SCALE_AT_MAX_JUMP=.2,function(e){e.Detached="detached",e.AttachedToTile="attached",e.Tweening="tweening",e.Destroyed="destroyed"}(h=t.PawnObjectModes||(t.PawnObjectModes={})),function(e){e.Hang="hang",e.SelectedForMove="selected-for-move"}(u=t.Highlight||(t.Highlight={})),t.PawnObject=class{constructor(e,t,i,s){this.manager=e,this.id=t,this.type=i,this.variant=s,this.visible=!1,this.baseX=0,this.baseY=0,this.tile=void 0,this.jumping=!1,this.jumpingDeSync=0,this.highlight=null,this.mode=h.Detached,this.shadow=e.pools.getPawnShadow(i,s),this.image=e.pools.getPawnImage(i,s),this.tweener=new l.Tweener(this.manager.scene)}attachToTile(e){if(this.mode===h.AttachedToTile){if(this.tile===e)return;this.detachFromTile()}this.setMode(h.AttachedToTile),this.assertNotDestroyed(),this.tile=e,e.addObject(this.image,0,3),e.addObject(this.shadow,0,3),this.attachSymbol(),this.baseX=this.tile.centerX,this.baseY=this.tile.centerY+3,this.baseDepth=this.image.depth,this.image.setDepth(this.baseDepth),this.shadow.setDepth(this.image.depth-1),this.highlight===u.Hang&&this.startHangingTween()}setMode(e){if(this.mode!==e){switch(this.tweener.stop(!1),this.mode){case h.AttachedToTile:this.detachFromTile();break;case h.Destroyed:throw this.illegalModeTransitionError(e);case h.Tweening:this.image.setRotation(0),this.image.setAlpha(1),this.shadow.setAlpha(1)}this.mode=e,this.symbol?.setVisible(this.shouldShowSymbol())}}get hanging(){return this.highlight===u.Hang}setHighlight(e){if(this.highlight!==e)if(e)switch(this.highlight=e,e){case u.Hang:this.symbol?.setVisible(!1),this.mode===h.AttachedToTile&&this.startHangingTween();break;case u.SelectedForMove:this.symbol?.setVisible(!1),this.shadow.setFrame("pawn-move-pedestal").setTint(d.Colors.highlight.ownedRegion),this.startPedestalTween(),this.shadow.setScale(1);break;case null:this.clearHighlight()}else this.clearHighlight()}clearHighlight(){null!==this.highlight&&(this.tweener.stop(),this.symbol?.setVisible(this.shouldShowSymbol()),this.highlight===u.SelectedForMove&&this.shadow.setFrame((0,o.getShadowFrameForPawnType)(this.type,this.variant)).clearTint(),this.jumping?(this.setJumpPhase(.5),this.jumpingDeSync=this.manager._getCurrentJumpingDeSyncForPawn(this,.5)):this.setJumpPhase(0),this.highlight=null)}shouldShowSymbol(){return this.mode===h.AttachedToTile&&this.visible}shouldShowImage(){return this.mode!==h.Destroyed&&this.visible}shouldShowShadow(){return this.mode===h.AttachedToTile&&this.visible}setSymbol(e){this.assertNotDestroyed(),this.symbol?this.symbol.setFrame((0,o.getFrameForPawnSymbol)(e)):(this.symbol=this.manager.pools.getTileSymbol(e),this.attachSymbol())}attachSymbol(){this.tile&&this.symbol&&(this.tile.addObject(this.symbol,0,t.SYMBOL_VERTICAL_OFFSET),this.symbol.setDepth(s.WorldLayers.UIOverlay),this.symbol.setVisible(this.shouldShowSymbol()))}setJumpPhase(e){const i=-(0,r.jump2)(e)*t.PAWN_JUMPING_HEIGHT;this.image.setX(this.baseX),this.image.setY(this.baseY+i),this.symbol?.setY(this.baseY+i+t.SYMBOL_VERTICAL_OFFSET-3),this.shadow.setScale(.5-(0,r.jump2)(e)*t.PAWN_SHADOW_SCALE_AT_MAX_JUMP)}illegalModeTransitionError(e){return new Error(`Illegal mode transition ${this.mode} => ${e}\`)`)}assertMode(e,t="operation"){if(this.mode!==e)return new Error(`${t} unavialable in ${this.mode} (expected ${e})`)}removeSymbol(){this.symbol&&(this.tile&&this.tile.removeObject(this.symbol),this.manager.pools.free(this.symbol),this.symbol=void 0)}detachFromTile(){this.tile&&(this.tile.removeObject(this.image),this.tile.removeObject(this.shadow),this.symbol&&this.tile.removeObject(this.symbol))}destroy(){this.assertNotDestroyed(),this.detachFromTile(),this.removeSymbol(),this.mode=h.Destroyed,this.tweener.stop(!1),this.manager._remove(this),this.manager.pools.free(this.image),this.manager.pools.free(this.shadow)}setVisible(e){e?this.show():this.hide()}hide(){this.assertNotDestroyed(),this.visible=!1,this.image.setVisible(!1),this.shadow.setVisible(!1),this.symbol?.setVisible(!1)}show(){this.assertNotDestroyed(),this.visible=!0,this.image.setVisible(!0),this.shadow.setVisible(!0),this.symbol?.setVisible(!0)}isDestroyed(){return this.mode===h.Destroyed}assertNotDestroyed(){(0,c.assert)(!this.isDestroyed(),`Attempting to modify ${this.type} at ${this.tile?.hex.id??"(no hex)"}, which is already destroyed`)}setType(e,t){this.assertNotDestroyed(),this.type===e&&this.variant===t||(this.type=e,this.variant=t,this.image.setFrame((0,o.getFrameForPawnType)(this.type,t)),this.shadow.setFrame((0,o.getShadowFrameForPawnType)(this.type,t)),this.image.setScale((0,o.getScaleForPawnType)(this.type)),this.image.setAlpha(1))}stopJumping(){this.jumping=!1,this.setJumpPhase(0)}startJumping(){this.jumping||(this.jumpingDeSync=this.manager._getCurrentJumpingDeSyncForPawn(this),this.jumping=!0)}setJumping(e){e?this.startJumping():this.stopJumping()}setTweens(e){this.setMode(h.Tweening),this.image.setDepth(s.WorldLayers.FlyingObject+this.image.y);for(let t of e)this.tweener.add(t)}startHangingTween(){const e=this.tile.centerY-a.HOVERING_HEIGHT;this.tweener.add({targets:[this.image],duration:200,ease:"Sine.easeOut",y:e}),this.tweener.add({targets:this.shadow,duration:100,ease:"Sine.easeOut",scale:.5-t.PAWN_SHADOW_SCALE_AT_MAX_JUMP})}startPedestalTween(){const e=this.baseY-3;this.tweener.add({targets:[this.image],duration:200,ease:"Sine.easeOut",y:e}),this.tweener.add({targets:this.shadow,duration:100,ease:"Sine.easeOut",scale:{from:.1,to:1}})}}},80347:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsManager=t.HOVERING_HEIGHT=t.PawnEffects=void 0;const s=i(48500),n=i(6914),a=i(82187),o=i(30420),r=i(12678),c=i(20666),l=i(85656),d=i(2484),h=i(88865),u=i(77821);var p;(p=t.PawnEffects||(t.PawnEffects={})).Jump="jump",p.SpawnFromAbove="spawn-from-above";t.HOVERING_HEIGHT=10;const g=s.logger.for("PawnsManager");function m(e,t){return t.type==o.PawnType.Town?e.regions.byHex(t.hex)?.getLevel()??1:void 0}t.PawnsManager=class{constructor(e,t,i){this.scene=e,this.pools=t,this.tiles=i,this.transitions=new d.PawnTransitions(this,this.tiles),this.pawnsById={},this.jumpClock=this.scene.tweens.addCounter({from:0,to:1,ease:"Linear",repeat:-1,duration:u.TIMING.pawnJumpDuration})}update(){Object.values(this.pawnsById).filter((e=>e.mode===n.PawnObjectModes.AttachedToTile&&e.jumping&&!e.highlight)).forEach((e=>{const t=(this.getJumpPhaseForPawn(e)+e.jumpingDeSync)%1;e.setJumpPhase(t),e.jumpingDeSync>0&&e.jumpingDeSync<=.5?e.jumpingDeSync-=.002:e.jumpingDeSync>=.998?e.jumpingDeSync=0:e.jumpingDeSync>.5&&(e.jumpingDeSync+=.002)}))}getJumpPhaseForPawn(e,t=0){const i=e.baseY%u.TIMING.pawnJumpDuration/u.TIMING.pawnJumpDuration;return(this.jumpClock.getValue()+t/u.TIMING.pawnJumpDuration+i)%1}createOrUpdatePawnObject(e,t){const i=e.id,s=e.hexId,a=e.type,o=this.pawnsById[i],c=this.tiles.getByHex(s);if((0,r.assert)(c,`unable to get or create pawn on hex #${s} - no tile available for this hex!`),o)return o.setType(a,t),void 0!==e.visible&&o.setVisible(e.visible),o.attachToTile(this.tiles.getByHex(s)),o.setJumping(e.jumping),o;{const o=new n.PawnObject(this,i,a,t);return this.pawnsById[i]=o,o.attachToTile(this.tiles.getByHex(s)),o.setJumping(e.jumping),void 0!==e.visible&&o.setVisible(e.visible),o}}syncWithModel(e,t){const i=e.pawns.all().filter(t),s=(0,l.dictionaryOf)(i,"id");this.clearAllJumping(),Object.entries(this.pawnsById).map((([e,t])=>{s[e]||(t.destroy(),delete this.pawnsById[e])}));for(const t of i)this.createOrUpdatePawnObject({id:t.id,hexId:t.hex.id,jumping:t.isMovable()&&!!t.faction?.isLocalPlayer(),type:t.type,visible:!0},m(e,t))}_remove(e){e.isDestroyed()?(delete this.pawnsById[e.id],this.hangingPawn===e&&this.clearHangingPawn()):e.destroy()}show(e){const t=this.pawnsById[e];t?(t.setVisible(!0),t.jumpingDeSync=this._getCurrentJumpingDeSyncForPawn(t)):g.warning(`Ignoring request to show pawn ${e}, no such pawn exists`)}hide(e){const t=this.pawnsById[e];t?t.setVisible(!1):g.warning(`Ignoring request to hide pawn ${e}, no such pawn exists`)}_getCurrentJumpingDeSyncForPawn(e,t=1){return(1+t-this.getJumpPhaseForPawn(e))%1}getPawnObjectPositionOnScreen(e,t){const i=this.getByHex(t);if(i)return{...(0,a.convertWorldXYToCameraXY)(e,i.image.x,i.image.y),scale:e.zoom*i.image.scale};{const i=this.tiles.getByHex(t);return r.assert.defined(i,`hex ${t} not found`),{...(0,a.convertWorldXYToCameraXY)(e,i.centerX,i.centerY+3),scale:.5*e.zoom}}}setHangingPawn(e){const t=this.pawnsById[e];t!==this.hangingPawn&&(this.hangingPawn&&this.clearHangingPawn(),this.hangingPawn=t),this.hangingPawn&&this.hangingPawn.setHighlight(n.Highlight.Hang)}clearHangingPawn(){this.hangingPawn&&(this.hangingPawn.isDestroyed()||this.hangingPawn.clearHighlight(),this.hangingPawn=void 0)}clearAllJumping(){Object.values(this.pawnsById).map((e=>e.stopJumping()))}resetJumpingState(e){e.setJumpPhase(0)}async replace(e,t,i){let s=this.pawnsById[e];s?s.setType(t,i):g.warning(`Request to replace pawn ${e} with ${t} but there is no existing pawn with this id => ignoring`)}jumpOnce(e){let t=this.pawnsById[e];if(t){if(t.jumping)return void g.warning(`Request to play jump animation on ${e} ignored as pawn is already jumping`);this.scene.tweens.add({targets:t.image,y:{from:t.baseY,to:t.baseY-n.PAWN_JUMPING_HEIGHT},ease:"Sine.easeOut",duration:200,yoyo:!0}),this.scene.tweens.add({targets:t.shadow,scale:{from:.5,to:.2},ease:"Sine.easeOut",duration:200,yoyo:!0})}else g.warning(`Request to play jump animation on ${e} ignored as there is no pawn there`)}getByHex(e){return Object.values(this.pawnsById).find((t=>t.tile?.hex.id===e&&t.mode===n.PawnObjectModes.AttachedToTile))}getById(e){return this.pawnsById[e]}syncPawnVariant(e,t){const i=e.pawns.select({hexes:t,traits:[c.PawnTraits.OccupiesTile]});for(let t of i)this.replace(t.id,t.type,m(e,t))}integrityCheck(){if(h.inject.config.debug.integrityChecks?.pawns)for(let e in this.pawnsById){const t=this.pawnsById[e];(0,r.assert)(!t.isDestroyed(),`found destroyed ${t.type} at hex ${e} (v${t.variant??"-"}) still in pawnsByHex collection`)}}}},2484:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnTransitions=void 0;const s=i(48500),n=i(20666),a=i(6914),o=i(78179),r=i(34198),c=i(88865),l=i(77821),d=s.logger.for("PawnsManager");t.PawnTransitions=class{constructor(e,t){this.pawns=e,this.tiles=t,this.scene=this.pawns.scene}async defendTile(e,t){const i=o.HexGroup.from(t.map((e=>e.hex)));if(i.contains(e))return this.defendWithPawn(e.id,e.id);await Promise.all(i.map((t=>this.defendWithPawn(e.id,t.id))))}defendWithPawn(e,t){let i=this.pawns.getByHex(t);return new Promise((s=>{if(i)if(t==e)this.pawns.jumpOnce(t);else if(c.inject.gameStateModel.rules.pawns(i.type).hasTrait(n.PawnTraits.Building))this.pawns.jumpOnce(t);else{const n=this.tiles.getByHex(t).centerX,a=this.tiles.getByHex(e).centerX,o=i.baseY,r=(a-n)/2,c=(this.tiles.getByHex(e).centerY+3-o)/2;this.scene.tweens.add({targets:[i.image,i.shadow],y:{from:o,to:o+c},x:{from:n,to:n+r},ease:"Sine.easeInOut",duration:200,yoyo:!0,onComplete:s})}else d.warning(`Request to play jump animation from ${t} ignored as there is no pawn there`)}))}pawnArrival(e,t,i){return new Promise((s=>{const n=this.tiles.getByHex(t).centerX,a=this.tiles.getByHex(t).centerY+3,o=this.tiles.getByHex(i).centerX,r=this.tiles.getByHex(i).centerY+3;this.scene.tweens.add({targets:[e.image,e.shadow],x:{from:n,to:o},y:{from:a,to:r},alpha:{from:0,to:1},duration:l.TransitionsSpeed.Normal,ease:"Sine.easeIn",onComplete:s})}))}pawnMove(e,t){return new Promise((i=>{const s=c.inject.ui.transitionsSpeed(),n=t.srcHex||e.tile.hex.id,o=(this.tiles.getByHex(n).centerX,this.tiles.getByHex(n).centerY,t.destHex),r=this.tiles.getByHex(o).centerX,l=this.tiles.getByHex(o).centerY+3,d=[{targets:[e.image,e.shadow],x:{from:e.image.x,to:r},y:{from:e.image.y,to:l},duration:s,alpha:{from:t.fadeIn?0:1,to:1},ease:"Sine.easeOut",onComplete:()=>{e.isDestroyed()||e.attachToTile(this.tiles.getByHex(t.destHex)),i()}}];if(e.symbol){const t=l-3+a.SYMBOL_VERTICAL_OFFSET;d.push({targets:e.symbol,x:r,y:t,duration:s,ease:"Sine.easeOut"})}e.setTweens(d)}))}async destroyPawn(e,t){return new Promise((i=>{const s=2*c.inject.ui.transitionsSpeed();let n=r.HEX_WIDTH,a=r.HEX_HEIGHT/2;t&&(n=(e.tile.hex.display.centerX-t.display.centerX)/2,a=(e.tile.hex.display.centerY-t.display.centerY)/2),e.setTweens([{targets:[e.image],rotation:{from:0,to:Math.PI/2*(n>0?1:-1)},x:e.image.x+n,y:e.image.y+a,alpha:{from:1,to:0},ease:"Sine.easeOut",duration:s,onComplete:()=>{e.isDestroyed()||e.destroy(),i()}},{targets:[e.shadow],x:e.shadow.x+n,y:e.shadow.y+a,alpha:{from:1,to:0},duration:s,ease:"Sine.easeOut"}])}))}async pawnCreated(e,t){return new Promise((i=>{const s=c.inject.ui.transitionsSpeed(),n=this.tiles.getByHex(t).centerX,o=this.tiles.getByHex(t).centerY+3,r=[{targets:[e.image,e.shadow],y:{from:o+10,to:o},duration:s,alpha:{from:0,to:1},ease:"Sine.easeIn",onComplete:()=>{e.isDestroyed()||e.attachToTile(this.tiles.getByHex(t)),i()}}];if(e.symbol){const t=o-3+a.SYMBOL_VERTICAL_OFFSET;r.push({targets:e.symbol,x:n,y:t,duration:s,alpha:{from:0,to:1},ease:"Sine.easeIn"})}e.setTweens(r)}))}}},74868:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionBasedIsoRenderer=void 0;const s=i(36454),n=i(14344);t.FactionBasedIsoRenderer=class{constructor(e,t,i){this.scene=e,this.renderer=t,this.recipe=i,this.groupByFaction={},this.groupByHex={},this.debug=!1}shouldRun(e){return!0}postProcess(e,t){}redrawFaction(e){if(!this.shouldRun(e.state))return;const t=this.groupByFaction[e.id];t&&(t.clear(),delete this.groupByFaction[e.id]);const i=e.hexes.filter((t=>this.shouldIncludeHex(e,t)));if(i.length>0){const t=this.getFactionGroup(e);i.forEach((e=>this.groupByHex[e.id]=t)),t.addHexes(i),t.update()}}clear(){Object.values(this.groupByFaction).forEach((e=>e.clear())),this.groupByFaction={},this.groupByHex={}}redrawHexes(e,t){if(!this.shouldRun(e))return;const i=new Set;for(let s of t){const t=this.groupByHex[s.id],a=n.Factions.model(e).byHex(s),o=a&&this.getFactionGroup(a);t&&t!==o&&t.removeHexes(s),o?(this.groupByHex[s.id]=o,this.shouldIncludeHex(a,s)?o.addHexes(s):o.removeHexes(s)):delete this.groupByHex[s.id],o&&i.add(o),t&&i.add(t)}i.forEach((e=>e.update()))}getFactionGroup(e){return void 0===this.groupByFaction[e.id]&&(this.groupByFaction[e.id]=new s.IsoTileGroup(this.renderer,this.recipe,this.postProcess.bind(this,e))),this.groupByFaction[e.id]}syncWithModel(e){this.clear(),e.factions.all().forEach((e=>this.redrawFaction(e)))}}},86703:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionsRenderer=void 0;const s=i(50264),n=i(20947),a=i(33125),o=i(18676),r=i(33625);t.RegionsRenderer=class{constructor(e){this.renderer=e,this.greenRenderer=new o.GreenRenderer(this.renderer),this.palisadeRenderer=new n.PalisadeRenderer(this.renderer),this.forestRenderer=new r.ForestRenderer(this.renderer),this.subRenderers=[new a.GroundRenderer(this.renderer),this.palisadeRenderer,this.greenRenderer,this.forestRenderer]}syncWithModel(e){this.subRenderers.forEach((t=>t.syncWithModel(e)))}redrawRegions(e,t){for(let i of t){const t=s.Regions.model(e).byId(i);t&&this.redrawRegion(t)}}redrawRegion(e){this.subRenderers.forEach((t=>t.redrawFaction(e.faction)))}refreshHexes(e,t){this.subRenderers.forEach((i=>i.redrawHexes(e,t)))}}},42233:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IsoTileRecipes=void 0;const s=i(82556),n={A111:{frame:"full"},V111:{frame:"full"},V001:{frame:"inner",crop:{x:24,y:0,width:26,height:38}},A010:{frame:"inner",crop:{x:48,y:0,width:26,height:38}},V100:{frame:"inner",crop:{x:48,y:36,width:26,height:38}},A100:{frame:"inner",crop:{x:24,y:36,width:26,height:38}},V010:{frame:"inner",crop:{x:0,y:36,width:26,height:38}},A001:{frame:"inner",crop:{x:0,y:0,width:26,height:38}},V110:{frame:"outer",crop:{x:24,y:0,width:26,height:38}},A101:{frame:"outer",crop:{x:48,y:0,width:26,height:38}},V011:{frame:"outer",crop:{x:48,y:36,width:26,height:38}},A011:{frame:"outer",crop:{x:24,y:36,width:26,height:38}},V101:{frame:"outer",crop:{x:0,y:36,width:26,height:38}},A110:{frame:"outer",crop:{x:0,y:0,width:26,height:38}}};t.IsoTileRecipes={Palisade:{baseDepth:s.WorldLayers.TileObjects,offsetA:24,offsetV:24,frames:{V001:{frame:"V001"},A010:{frame:"A010"},V100:{frame:"V100"},A100:{frame:"A100"},V010:{frame:"V010"},A001:{frame:"A001"},V110:{frame:"V110"},A101:{frame:"A101"},V011:{frame:"V011"},A011:{frame:"A011"},V101:{frame:"V101"},A110:{frame:"A110"}},frameIdBase:"iso-tiles/palisade"},Ground:{baseDepth:s.WorldLayers.Tiles,frameIdBase:"iso-tiles/ground",offsetV:13,offsetA:25,frames:n},Forest:{baseDepth:s.WorldLayers.TileObjects,frameIdBase:"iso-tiles/forest",offsetV:13,offsetA:25,frames:n},GloomyForest:{baseDepth:s.WorldLayers.TileObjects,frameIdBase:"iso-tiles/forest-gloomy",offsetV:13,offsetA:25,frames:n},Green:{baseDepth:s.WorldLayers.Tiles+100,frameIdBase:"iso-tiles/green",offsetV:13,offsetA:25,frames:{...n,A101:{frame:"outer-v"},V110:{frame:"outer-h"},V011:{frame:"outer-v",flipY:!0},A011:{frame:"outer-h",flipY:!0},V101:{frame:"outer-v",flipX:!0,flipY:!0},A110:{frame:"outer-v",flipX:!0}}},Landmass:{baseDepth:s.WorldLayers.Landmass,frameIdBase:"iso-tiles/landmass",offsetV:13,offsetA:25,frames:n},Highlight:{baseDepth:s.WorldLayers.TileHighlight,frameIdBase:"iso-tiles/highlight",offsetV:13,offsetA:25,frames:{...n,A111:void 0,V111:void 0}},Simple2D:{frames:{A111:{frame:"A111"},V111:{frame:"A111",flipY:!0},V001:{frame:"V001"},A010:{frame:"A010"},V100:{frame:"A010",flipY:!0},A100:{frame:"V001",flipY:!0},V010:{frame:"A010",flipX:!0,flipY:!0},A001:{frame:"A010",flipX:!0},V110:{frame:"V110"},A101:{frame:"A101"},V011:{frame:"A101",flipY:!0},A011:{frame:"V110",flipY:!0},V101:{frame:"A101",flipX:!0,flipY:!0},A110:{frame:"A101",flipX:!0}}}}},33625:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ForestRenderer=void 0;const s=i(74868),n=i(42233),a=i(21999),o=i(30420),r=i(62977);class c extends s.FactionBasedIsoRenderer{constructor(e){super(e.scene,e,n.IsoTileRecipes.Forest)}redrawFaction(e){e?.id===a.SpecialFaction.neutral&&super.redrawFaction(e)}shouldIncludeHex(e,t){return e.id===a.SpecialFaction.neutral&&!!r.Pawns.model(e.state).findOne({hexes:t,type:[o.PawnType.Forest]})}}t.ForestRenderer=c},18676:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GreenRenderer=void 0;const s=i(74868),n=i(42233),a=i(50264),o=i(78179),r=i(40108);class c extends s.FactionBasedIsoRenderer{constructor(e){super(e.scene,e,n.IsoTileRecipes.Green)}shouldIncludeHex(e,t){return!!a.Regions.model(e.state).byHex(t)?.isAlive()&&0!==r.AI.getHexAge(e.state,t.id)}postProcess(e,t){const i=e?.landColorLight||0;t.setTint(i)}redrawRegions(e){if(0===e.length)return;const t=o.HexGroup.union(e.map((e=>e.hexes)));this.redrawHexes(e[0].state,t)}}t.GreenRenderer=c},33125:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GroundRenderer=void 0;const s=i(74868),n=i(42233);class a extends s.FactionBasedIsoRenderer{constructor(e){super(e.scene,e,n.IsoTileRecipes.Ground),this.debug=!0}redrawFaction(e){e.id>0&&super.redrawFaction(e)}shouldIncludeHex(e,t){return!e.isNeutral()}postProcess(e,t){t.setTint(e?.landColor)}}t.GroundRenderer=a},20947:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PalisadeRenderer=void 0;const s=i(74868),n=i(42297),a=i(42233),o=i(98030),r=i(47610);class c extends s.FactionBasedIsoRenderer{constructor(e){super(e.scene,e,a.IsoTileRecipes.Palisade)}shouldRun(e){return!!(0,o.getParentEngine)(e).isDataSetActive(r.GameState.warfare.hexStaticDefense)}shouldIncludeHex(e,t){return n.Warfare.getHexStaticDefense(e.state,t.id)>0}redrawHexes(e,t){const i=t.with(t.neighbours());super.redrawHexes(e,i)}}t.PalisadeRenderer=c},21711:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConquerableHexesHighlight=t.DEFAULT_TINT=void 0;const s=i(48500),n=i(82556),a=i(30420),o=i(71234),r=i(5715),c=i(97119),l=i(88865),d=i(77821),h=s.logger.for("ConquerableHexesHighlight");t.DEFAULT_TINT=r.Colors.highlight.ownedRegion,t.ConquerableHexesHighlight=class{constructor(e,t){this.scene=e,this.objectPool=t,this.indicatorsByHex={},this.tweener=new c.Tweener(this.scene),this.tint=r.Colors.highlight.ownedRegion,this.alpha=1,this.indicators=this.scene.add.group({defaultKey:"atlas",defaultFrame:"hex-move-indicator",createCallback:e=>{e.setName("indicator"+this.indicators.getLength())}}).setDepth(n.WorldLayers.TileHighlight),this.pawnGhost=this.objectPool.getPawnImage(a.PawnType.Villager).setDepth(n.WorldLayers.FlyingObject).setAlpha(.7).setVisible(!1),this.scene.add.existing(this.pawnGhost)}clear(){this.removeIndicators(Object.keys(this.indicatorsByHex).map((e=>Number(e))))}set(e,i=t.DEFAULT_TINT,s=1){const n=Object.entries(this.indicatorsByHex).filter((([t,i])=>!e.hasId(Number(t)))).map((([e,t])=>Number(e)));this.removeIndicators(n),this.tint==i&&this.alpha===s||(this.tint=i,this.alpha=s,this._updateTintAndAlpha()),this.add(e,i,s)}_updateTintAndAlpha(){for(let e of Object.values(this.indicatorsByHex))e.setTint(this.tint).setAlpha(this.alpha)}add(e,i=t.DEFAULT_TINT,s=1){const a=[];this.tint=i,this.alpha=s,e.map((e=>{const t=this.indicatorsByHex[e.id]||this.indicators.get(e.display.centerX,e.display.centerY,void 0,void 0,!1).setVisible(!0).setActive(!0).setDepth(n.WorldLayers.TileHighlight);return t.setTint(this.tint).setAlpha(this.alpha),this.indicatorsByHex[e.id]||(this.indicatorsByHex[e.id]=t,a.push(t)),t})),this.tweener.add({targets:a,scale:{from:.5,to:1},alpha:{from:0,to:s},duration:d.TIMING.pawnPickupTransition,ease:"Sine.easeOut",onComplete:()=>{a.forEach((e=>e.setAlpha(this.alpha)))}})}remove(e){this.removeIndicators(e.toIdsArray())}setHighlightedHex(e,t){const i=this.indicatorsByHex[e.id];i?this.highlightedIndicator!==i&&(this.clearHighlightedHex(),this.highlightedIndicator=i,this.highlightedIndicator?.setFrame("hex-move-indicator-hover"),this.highlightedIndicator?.setScale(.75),this.highlightedIndicatorTween=this.tweener.add({targets:i,scale:1,duration:200,ease:"Sine.easeInOut"}),t?this.pawnGhost.setPosition(e.display.centerX,e.display.centerY-10).setFrame((0,o.getFrameForPawnType)(t)).setVisible(!0):this.pawnGhost.setVisible(!1)):h.warning(`ignoring attempt to highlight conquest indicator on hex ${e.id}, which does not currently display conquest indicator`)}clearHighlightedHex(){if(this.highlightedIndicator){const e=this.highlightedIndicator;this.tweener.add({targets:e,scale:.75,duration:100,onComplete:()=>{e.setFrame("hex-move-indicator"),e.setScale(1)},onStop:()=>{e.setFrame("hex-move-indicator")}}),this.highlightedIndicatorTween?.stop(),this.highlightedIndicator=void 0,this.pawnGhost.setVisible(!1)}}show(){this.indicators.children.each((e=>!!e.setVisible(e.active)))}hide(){this.indicators.setVisible(!1)}removeIndicators(e){if(0===e.length)return;const t=e.map((e=>this.indicatorsByHex[e])).filter((e=>e));this.highlightedIndicator&&t.includes(this.highlightedIndicator)&&this.clearHighlightedHex(),l.inject.ui.skipTransitions()?t.forEach((e=>{this.indicators.killAndHide(e)})):this.tweener.add({targets:t,scale:{from:1,to:.5},alpha:{from:this.alpha,to:0},duration:d.TIMING.pawnPickupTransition,ease:"Sine.easeIn",onComplete:()=>{t.forEach((e=>{this.indicators.killAndHide(e)}))}}),e.forEach((e=>delete this.indicatorsByHex[e]))}has(e){return void 0!==this.indicatorsByHex[e]}}},43255:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deriveDefenseMarkerDataFromModel=t.HexDefenseMarkers=void 0;const s=i(78179),n=i(48500),a=i(82556),o=i(20666),r=i(16972),c=i(12678),l=i(24794),d=i(77821),h=i(85656),u=i(41959);n.logger.for("HexDefenseMarkers"),t.HexDefenseMarkers=class{constructor(e){this.scene=e,this.shapesByHex={},this.hovered={hex:void 0,defenseAuraStrength:0,defenseAuraHexes:s.HexGroup.empty},this.shapes=this.scene.add.group({defaultKey:"atlas",defaultFrame:"hex-markers/defense-1"}).setDepth(a.WorldLayers.TileHighlight)}clear(){this.clearHoveredHex(),this.removeShapes(Object.keys(this.shapesByHex).map((e=>Number(e))))}set(e){(0,h.mapDictionary)(e.exportDictionary(),(e=>`${e.defense} from #${e.origin.id}`)),this.config=e;const t=Object.keys(this.shapesByHex).filter((t=>0===e.get(Number(t)).defense&&!this.hovered.defenseAuraHexes.has((0,l.getHex)(Number(t))))).map((e=>Number(e)));(0,l.getHexes)(e.getHexIds()).without(this.hovered.hex||s.HexGroup.empty).without(this.hovered.defenseAuraHexes).map((e=>{c.assert.defined(e);const t=this.config.get(e.id),i=this.setShapeOnHex(e,"defense-"+t.defense);return this.shapesByHex[e.id]||(this.shapesByHex[e.id]=i,this.scene.tweens.add({targets:i,x:{from:t.origin.display.centerX,to:e.display.centerX},y:{from:t.origin.display.centerY,to:e.display.centerY},scale:{from:.5,to:1},alpha:{from:0,to:1},duration:d.TIMING.defenseMarkersShowDuration,ease:"Sine.easeOut"})),i})).filter((e=>!!e)),this.removeShapes(t)}setShapeOnHex(e,t){const i=this.shapesByHex[e.id]||this.shapes.get(e.display.centerX,e.display.centerY,void 0,void 0,!1).setVisible(!0).setActive(!0).setDepth(a.WorldLayers.TileHighlight);return i.setFrame("hex-markers/"+t).setAlpha(1).setScale(1),i}setHoveredHex(e,t,i){this.clearHoveredHex(),this.hovered.hex=e,this.hovered.defenseAuraHexes=i,this.hovered.defenseAuraStrength=t,this.shapesByHex[e.id]=this.setShapeOnHex(e,"circle"),this.hovered.defenseAuraHexes.forEach((e=>{const i=this.config.get(e.id).defense;t>i&&(this.shapesByHex[e.id]=this.setShapeOnHex(e,"defense-"+t))}))}clearHoveredHex(){this.hovered.hex&&(s.HexGroup.union([this.hovered.hex,this.hovered.defenseAuraHexes]).forEach((e=>{const t=this.config.get(e.id).defense;t>0?this.shapesByHex[e.id]=this.setShapeOnHex(e,"defense-"+t):(this.scene.tweens.killTweensOf(this.shapesByHex[e.id]),this.shapes.killAndHide(this.shapesByHex[e.id]),delete this.shapesByHex[e.id])})),this.hovered.hex=void 0,this.hovered.defenseAuraStrength=0,this.hovered.defenseAuraHexes=s.HexGroup.empty)}removeShapes(e){const t=e.map((e=>this.shapesByHex[e]));this.scene.tweens.add({targets:t,scale:{from:1,to:.5},alpha:{from:1,to:0},duration:d.TIMING.defenseMarkersHideDuration,ease:"Sine.easeIn",onComplete:()=>{t.forEach((e=>{this.shapes.killAndHide(e)}))}}),e.forEach((e=>delete this.shapesByHex[e]))}},t.deriveDefenseMarkerDataFromModel=function(e,t){const i=(0,u.getCurrentGameStateModel)(),s=e.hexes,n=new r.CustomHexGroupValuation({defense:0});return i.pawns.select({hexes:s,traits:[o.PawnTraits.GuardsAdjacentTiles]}).filter((e=>e.id!==t)).forEach((e=>{s.neighboursOf(e.hex).filter((e=>!i.warfare.isOccupied(e)||e.id===t)).forEach((t=>{const i=n.get(t.id);e.might>i.defense&&n.set(t.id,{defense:e.might,origin:e.hex})}))})),n}},68480:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LandmassRenderer=void 0;const s=i(36454),n=i(78179),a=i(42233);t.LandmassRenderer=class{constructor(e){this.renderer=e,this.landmass=new s.IsoTileGroup(this.renderer,a.IsoTileRecipes.Landmass,this.postProcess)}syncWithModel(e,t){this.clear();const i=n.HexGroup.union(e.regions.all().map((e=>e.hexes)));this.landmass.addHexes(i),this.landmass.update()}postProcess(e){}clear(){this.landmass.clear()}}},79773:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnBacklight=void 0;const s=i(82556),n=i(48500);var a=Phaser.GameObjects.Sprite;n.logger.for("PawnBacklight"),t.PawnBacklight=class extends a{constructor(e,t){super(e,0,0,"atlas","pawn-backlight"),this.baseWidth=t,this.setOrigin(.5,1),this.setTint(65280),this.setDepth(s.WorldLayers.UIOverlay),this.setDisplaySize(t,128),this.baseScaleX=this.scaleX,this.baseScaleY=this.scaleY,this.pulseTween=this.scene.add.tween({targets:this,scaleY:{from:.9*this.baseScaleY,to:this.baseScaleY},alpha:{from:.7,to:1},duration:1e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut",paused:!0}),this.animateIn()}setBaseWidth(e){this.baseWidth=e,this.setDisplaySize(this.baseWidth,128)}animateIn(){this.scene.tweens.add({targets:this,scaleX:{from:0,to:this.baseScaleX},scaleY:{from:.5,to:this.baseScaleY},alpha:{from:0,to:.7},ease:"Sine.easeOut",duration:300,onComplete:()=>this.pulseTween.play()})}destroy(){this.scene.tweens.add({targets:this,width:0,height:this.height/2,alpha:0,duration:300,onComplete:()=>{this.pulseTween.stop(),super.destroy()}})}}},21204:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnBacklightManager=void 0;const s=i(84446),n=i(79773),a=i(48500).logger.for("PawnBacklightManager");class o extends s.TileAttachmentsManager{constructor(e,t,i){super("PawnBacklightManager",e,t,a),this.pawns=i}createObject(e,t){const i=this.pawns.getByHex(e.id),s=t.width??i?.image.displayWidth??18;return new n.PawnBacklight(this.scene,s).setTint(t.color)}updateObject(e,t,i){const s=this.pawns.getByHex(t.id);e.setBaseWidth(i.width??s.image.displayWidth??18),e.setTint(i.color)}attachObject(e,t){t.addObject(e,0,0)}removeObject(e,t){t.removeObject(e),e.destroy()}}t.PawnBacklightManager=o},6810:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PawnSymbolsManager=t.PawnSymbolType=void 0;const n=i(48500),a=s(i(54485)),o=i(85656),r=i(88865);var c;(c=t.PawnSymbolType||(t.PawnSymbolType={})).Arrow="0-arrow",c.Plus="1-plus",c.CrossedCoin="2-crossed-coin",c.Alert="3-alert",c.Warning="4-warning";const l=n.logger.for("PawnSymbols"),d=(e,t)=>e.type.localeCompare(t.type);t.PawnSymbolsManager=class{constructor(e){this.pawns=e,this.symbolsByPawn=new Map}clearAll(){const e=this.symbolsByPawn.keys();for(const t of e){const e=this.pawns.getById(t);!e||e.isDestroyed()?l.warning(`Ignoring stale pawnSymbol reference to destroyed pawn #${t}`):e.removeSymbol()}this.symbolsByPawn.clear()}clear(e){const t=[];for(let[i,s]of this.symbolsByPawn.entries()){const s=this.pawns.getById(i);!s||s.isDestroyed()?t.push(i):this.remove(i,e)}for(let e of t)this.symbolsByPawn.delete(e)}add(e,t,i){let s=this.symbolsByPawn.get(e),n=s?.find((e=>e.type===t));s?n?n.message=i:(s.push({type:t,message:i}),s.sort(d)):(new a.default(d),this.symbolsByPawn.set(e,[{type:t,message:i}])),n||this.updateSymbolImage(e)}remove(e,t){const i=this.symbolsByPawn.get(e),s=i?.find((e=>e.type===t));i&&s&&((0,o.removeFromArrayInPlace)(i,s),this.updateSymbolImage(e))}getCurrentSymbol(e){return this.symbolsByPawn.get(e)?.[0]}updateSymbolImage(e){const t=this.getCurrentSymbol(e),i=this.pawns.getById(e);t?i?i.setSymbol(t.type):l.warning(`Failed to update symbol image to ${t.type} for pawn ${e}: no pawn sprite located`):i?.removeSymbol()}has(e,t){return!!this.symbolsByPawn.get(e)?.find((e=>e.type===t))}byHex(e){const t=r.inject.gameStateModel.pawns.byHex(e).map((e=>e.id));return(0,o.stripDuplicatesFrom)((0,o.mergeArrays)(...t.map((e=>this.symbolsByPawn.get(e)??[]))))}}},62515:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SelectedRegionHighlight=t.HighlightStyle=void 0;const s=i(48500),n=i(42233),a=i(36454),o=i(5715);var r;s.logger.for("SelectedRegionHighlight"),function(e){e.Gold="gold",e.Muted="muted"}(r=t.HighlightStyle||(t.HighlightStyle={})),r.Gold,r.Muted,t.SelectedRegionHighlight=class{constructor(e){this.renderer=e,this.tileGroup=new a.IsoTileGroup(this.renderer,n.IsoTileRecipes.Highlight,(e=>{e.setTint(this.color)})),this.color=o.Colors.highlight.ownedRegion}getHexes(e){return e.hexes}clear(){this.tileGroup.clear(),this.selectedRegion=void 0}setColor(e){e!==this.color&&(this.clear(),this.color=e)}set(e,t){t&&this.setColor(t),this.selectedRegion=e,this.tileGroup.setHexes(this.selectedRegion.hexes)}setHexes(e,t){t&&this.setColor(t),this.selectedRegion=void 0,this.tileGroup.setHexes(e)}refresh(){this.selectedRegion?this.tileGroup.setHexes(this.selectedRegion.hexes):this.tileGroup.clear()}includesHex(e){return this.tileGroup.hexes.has(e)}add(e){this.tileGroup.addHexes(e),this.tileGroup.update()}}},86130:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tile=void 0;var s=Phaser.GameObjects.Container;const n=i(34198),a=i(82556),o=i(64849);function r(e){let t="(unknown)";return t=e instanceof s?e.constructor.name:e.frame.name,`\n- ${t}(#${(0,o.getObjId)(e)} V:${e.visible?1:0} A:${e.alpha.toFixed(1)})`}i(48500).logger.for("Tile"),t.Tile=class{constructor(e,t,i=0){this.renderer=e,this.hex=t,this.frame=i,this.attachedObjects=new Set,this.decals=new Set,this.active=!0}get baseDepth(){return a.WorldLayers.Tiles+this.bottom}get bottom(){return this.hex.y*n.HEX_INNER_HEIGHT+n.HEX_HEIGHT}get centerX(){return(this.hex.x+.5)*n.HEX_WIDTH}get centerY(){return this.hex.y*n.HEX_INNER_HEIGHT+.5*n.HEX_HEIGHT}addObject(e,t,i){this.attachedObjects.add(e),this.renderer.add(this.hex,e),e.setPosition(this.centerX+t,this.centerY+i).setDepth(a.WorldLayers.TileObjects+this.bottom-n.HEX_HEIGHT/2+i)}addDecal(e,t,i){e.setOrigin(.5,.5),this.decals.add(e),this.renderer.add(this.hex,e).setDepth(a.WorldLayers.TileDecals),e.setPosition(this.centerX+t,this.centerY+i)}removeObject(e){this.attachedObjects.delete(e),this.renderer.remove(this.hex,e)}activate(e){this.active||[...this.decals,...this.attachedObjects].forEach((e=>this.renderer.add(this.hex,e))),this.active=!0,e.isNeutral()?this.decals.forEach((e=>e.setVisible(!1))):this.decals.forEach((t=>{t.setVisible(!0),t.setTint(e.landColor)}))}deactivate(){this.active=!1,[...this.decals,...this.attachedObjects].forEach((e=>{this.renderer.remove(this.hex,e),e.setVisible(!1)}))}toString(){return`[Tile #${this.hex.id}]`}getDebugData(){return`[Tile #${this.hex.id}]\nactive: ${this.active}\nattachedObjects:${Array.from(this.attachedObjects).map(r).join("")}\ndecals:${Array.from(this.decals).map(r)}\n`}}},84446:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TileAttachmentsManager=void 0;const s=i(24794),n=i(78179),a=i(96486);t.TileAttachmentsManager=class{constructor(e,t,i,s){this.name=e,this.renderer=t,this.tiles=i,this.log=s,this.objectsByHex={},this.scene=this.renderer.scene}alreadyHas(e,t){const i=this.objectsByHex[e.id];if(i)return(0,a.isEqual)(i.options,t)}add(e,t){if(!this.alreadyHas(e,t)){if(this.objectsByHex[e.id])return this.objectsByHex[e.id].options=t,void this.updateObject(this.objectsByHex[e.id].attachedObject,e,t);{const i=this.tiles.getByHex(e.id);if(!i)return void this.log.warning(`cannot attach object to hex ${e} - no such tile found`);const s=this.createObject(e,t);this.objectsByHex[e.id]={attachedObject:s,options:t},this.attachObject(s,i)}}}set(e,t){for(let[t]of Object.entries(this.objectsByHex)){const i=(0,s.getHex)(Number(t));e.has(i)||this.remove(i)}for(let i of e)this.add(i,t)}setDiverse(e){const t=n.HexGroup.union(e.map((e=>e.hexes)));for(let[e]of Object.entries(this.objectsByHex)){const i=(0,s.getHex)(Number(e));t.has(i)||this.remove(i)}for(let{hexes:t,options:i}of e)for(let e of t)this.add(e,i)}update(e){const t=[];e(((e,i)=>t.push({hexes:e,options:i}))),this.setDiverse(t)}remove(e){this.objectsByHex[e.id]&&this.doRemoveObject(e,this.objectsByHex[e.id].attachedObject)}clear(){Object.entries(this.objectsByHex).forEach((([e,t])=>{this.doRemoveObject((0,s.getHex)(Number(e)),t.attachedObject)})),this.objectsByHex={}}doRemoveObject(e,t){const i=this.tiles.getByHex(e.id);this.removeObject(t,i),delete this.objectsByHex[e.id]}}},50735:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bgrSwap=t.TilesManager=void 0;const s=i(48500),n=i(86130),a=i(88865);var o=Phaser.GameObjects.Image;const r=s.logger.for("TilesManager");t.TilesManager=class{constructor(e,t){this.scene=e,this.renderer=t,this.cinematics={},this.tilesByHexId={}}setTile(e,t){this.createOrUpdateTile(e,t)}syncWithModel(e,t,i=!1){i&&Object.entries(this.tilesByHexId).filter((([e,i])=>i.active&&!t.hasId(Number(e)))).forEach((([e,t])=>t.deactivate()));for(const i of t){const t=e.factions.byHex(i);t&&this.setTile(i,t)}}getByHex(e){return this.tilesByHexId[e]}addObjectToTile(e,t,i=0,s=0){const n=this.tilesByHexId[e];n?n.addObject(t,i,s):r.error(`Unable to place ${t} on hex ${e}, hex not present in the current rendering. Ignoring.`)}getAll(){return Object.values(this.tilesByHexId).filter((e=>e.active))}clear(){Object.values(this.tilesByHexId).forEach((e=>e.deactivate()))}createOrUpdateTile(e,t){let i=this.tilesByHexId[e.id];if(i)i.activate(t);else{if(i=new n.Tile(this.renderer,e),a.inject.random.boolean(.75)){const e=a.inject.random.point(6);t.isNeutral()||i.addDecal(new o(this.renderer.scene,0,0,"atlas","hex-decals/grass").setTint(t.landColor).setFlipX(a.inject.random.boolean()),e.x,e.y)}this.tilesByHexId[e.id]=i}return i}},t.bgrSwap=e=>{const[t,i,s]=e.toString(16).padStart(6,"0").match(/[\w]{2}/g);return parseInt([s,i,t].join(""),16)}},30489:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TownStatusFlagsManager=t.FlagObject=void 0;const s=i(48500),n=i(84446),a=s.logger.for("TownStatusFlags");class o{constructor(e,t){this.renderer=e,this.objectPool=t}acquireSprites(){this.flagFace||(this.flagFace=this.objectPool.getFlag(0,0),this.flagPole=this.objectPool.getFlagPole(0,0))}attachToTile(e){this.acquireSprites(),this.tile=e,e.addObject(this.flagFace,10,-8),e.addObject(this.flagPole,10,10),this.flagPole.setDepth(this.flagPole.depth+2),this.flagFace.setDepth(this.flagPole.depth+3).play("wave-flag")}setTint(e){return this.acquireSprites(),this.flagFace.setTint(e),this}destroy(){this.tile&&(this.tile.removeObject(this.flagFace),this.tile.removeObject(this.flagPole),this.objectPool.free(this.flagPole),this.objectPool.free(this.flagFace))}}t.FlagObject=o;class r extends n.TileAttachmentsManager{constructor(e,t,i){super("TownStatusFlags",e,i,a),this.imagePool=t}attachObject(e,t){e.attachToTile(t)}createObject(e,t){return new o(this.renderer,this.imagePool).setTint(t)}removeObject(e,t){e.destroy()}updateObject(e,t,i){e.setTint(i)}}t.TownStatusFlagsManager=r},7656:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Padding=void 0;const s=i(68660),n=i(58592),a={[s.UiVariant.Compact]:{large:14,medium:10},[s.UiVariant.Large]:{large:30,medium:20}};t.Padding={get large(){return a[n.app.device.uiVariant()].large},get medium(){return a[n.app.device.uiVariant()].medium}}},46919:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseScene=void 0;const s=i(48500),n=i(88865),a=i(51209),o=i(58592),r=i(82260),c=i(87262);class l extends Phaser.Scene{constructor(e){super(e),this.observe=new c.Observer((()=>this.scene.isActive())),this.bounds=e.bounds??a.BOUNDS.Main,this.log=s.logger.for((e.key??"")+"Scene")}updateBounds(){const e=this.cameras.main.width,t=this.cameras.main.height;this.cameras.main.setPosition(this.bounds.x,this.bounds.y),this.cameras.main.setSize(this.bounds.width,this.bounds.height),this.resize({oldWidth:e,oldHeight:t,newWidth:this.cameras.main.width,newHeight:this.cameras.main.height})}create(){n.inject.config.watchFuture((e=>this.applyConfig(e))),this.keys={shift:this.input.keyboard.addKey(r.Input.Keyboard.KeyCodes.SHIFT),alt:this.input.keyboard.addKey(r.Input.Keyboard.KeyCodes.ALT),ctrl:this.input.keyboard.addKey(r.Input.Keyboard.KeyCodes.CTRL)},this.observe.watch(n.inject.ui.sidebarMode,(e=>{this.updateBounds()})),this.scale.on("resize",(()=>{o.app.device.updateScreenSize(),this.updateBounds()})),this.events.on(Phaser.Scenes.Events.WAKE,(()=>{this.observe.wakeUp()})),this.events.on(Phaser.Scenes.Events.SLEEP,(()=>{})),this.events.on(Phaser.Scenes.Events.SHUTDOWN,(()=>{})),this.events.on(Phaser.Scenes.Events.DESTROY,(()=>{})),this.events.on(Phaser.Scenes.Events.PRE_UPDATE,(()=>{this.preUpdate()}))}resize(e){}destroy(){this.observe.destroy()}applyConfig(e){this.tweens.timeScale=e.debug.tweenSpeedFactor||1,this.time.timeScale=e.debug.tweenSpeedFactor||1,this.anims.globalTimeScale=e.debug.tweenSpeedFactor||1}addAll(e){for(let t of e)this.add.existing(t)}addImage(e,t="atlas"){return this.add.image(0,0,t,e)}preUpdate(){}bindKey(e,t){this.input.keyboard.addKey(e).on("down",(async()=>{const e=await Promise.resolve(t());e&&n.inject.events.trigger(e)}))}}t.BaseScene=l},68736:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseUIScene=void 0;const s=i(48500),n=i(46919),a=i(38952),o=i(91025),r=i(88865),c=i(58592);class l extends n.BaseScene{constructor(e){super(e),this.log=s.logger.for("scene:"+e.key??"BaseScene")}create(){super.create(),this.cameras.main.setZoom(r.inject.ui.scale()).setOrigin(0,0).setRoundPixels(!0),this.observe.watch(r.inject.ui.scale,(e=>{e!==this.cameras.main.zoom&&(this.cameras.main.setZoom(e).setOrigin(0,0).setRoundPixels(!0),this.preUpdate.makeDirty())})),this.observe.watch(r.inject.ui.sidebarMode,(e=>{this.preUpdate.makeDirty()})),this.scale.on("resize",(()=>{c.app.device.updateScreenSize(),this.preUpdate.makeDirty()})),this.input.on("pointerdown",((e,t)=>{this.closeCurrentTooltip()})),this.input.on("pointerover",((e,t)=>{t.length&&(e.wasTouch||t[0]!==this.currentTooltipTarget&&this.showTooltipFor(t[0],!1))})),this.input.on("pointerout",((e,t)=>{e.wasTouch||this.closeCurrentTooltip()})),this.events.on(Phaser.Scenes.Events.WAKE,(()=>{this.preUpdate.makeDirty()})),this.observe.event(o.UserActions.ToggleTooltip,(({object:e})=>{this.toggleTooltipFor(e)}))}closeCurrentTooltip(){this.currentTooltip===c.app.tooltips.currentTooltip&&(c.app.tooltips.close(),this.currentTooltip=void 0,this.currentTooltipTarget=void 0)}showTooltipFor(e,t=!0){const i=this.getTooltipFor(e);i?(this.currentTooltip=c.app.tooltips.showOver(e,i&&{...i,delayMs:t?0:void 0,type:a.TooltipType.Hover}),this.currentTooltipTarget=e):c.app.tooltips.close()}toggleTooltipFor(e){this.currentTooltipTarget===e&&this.currentTooltip?.visible?this.closeCurrentTooltip():this.showTooltipFor(e,!0)}getTooltipFor(e){const t=e.getData("tooltip");return"string"==typeof t?{title:t}:void 0}}t.BaseUIScene=l},44906:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugHistoryScene=void 0;const s=i(82260),n=i(11930),a=i(24917),o=i(88865),r=i(58592),c=i(84370),l=i(30093);class d extends s.Scene{constructor(){super({key:n.Scenes.DebugHistory,pixelArt:!1}),this.currentIndex=0}create(){this.controller=o.inject.gameStateController,this.historyLabel=new a.DebugTextBox(this,10,40,"Frames:",{dropShadow:!1,origin:[0,1]});const e=this.input.keyboard.addKey(s.Input.Keyboard.KeyCodes.ESC),t=this.input.keyboard.createCursorKeys();e.on("down",(e=>{r.app.navigator.goTo(r.app.screen.play,c.NewGameStateContext.ResumingGame)})),t.down.on("down",(e=>{this.goToNextFrame()})),t.up.on("down",(()=>{this.goToPreviousFrame()}))}goToNextFrame(){this.currentIndex!==o.inject.history.length()&&(this.currentIndex++,this.currentIndex===o.inject.history.length()?this.loadState(this.suspendedCurrentState):this.loadState(o.inject.history.get(this.currentIndex).state))}goToPreviousFrame(){0!==this.currentIndex&&(this.currentIndex===o.inject.history.length()&&(this.suspendedCurrentState=o.inject.gameStateModel.state),this.currentIndex--,this.loadState(o.inject.history.get(this.currentIndex).state))}loadState(e){o.inject.gameStateModel.restore(e),r.app.scene.worldMap.syncState(e,l.OverlayModes.disabled)}resetCursor(){this.currentIndex=o.inject.history.length()}update(){const e=[...o.inject.history.getAll(),{label:"(CURRENT STATE)",state:o.inject.gameStateModel.state}];this.currentIndex>e.length&&(this.currentIndex=e.length-1);const t=e.map(((e,t)=>(this.currentIndex===t?"->":"  ")+e.label)).join("\n");this.historyLabel.setText(t),this.historyLabel.setPosition(10,this.cameras.main.displayHeight-10)}}t.DebugHistoryScene=d},47038:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugScene=void 0;const s=i(11930),n=i(54444),a=i(98030),o=i(47610),r=i(24917),c=i(30420),l=i(69905),d=i(68736),h=i(97866),u=i(41707),p=i(88865),g=i(58592),m=i(41959);class y extends d.BaseUIScene{constructor(){super({key:s.Scenes.Debug,pixelArt:!1}),this.suppressBreakPoints=!1,this.preUpdate=(0,h.whenDirty)((()=>{}))}create(){super.create(),this.cameras.main.setOrigin(0,0),this.debugData=p.inject.debugData,this.controller=p.inject.gameStateController,this.cursorPosLabel=new r.DebugTextBox(this,100,100,"(left, top)",{padding:10}),this.topLeftLabel=new r.DebugTextBox(this,10,30,"[left, top] - [left,top]",{dropShadow:!1,padding:10}),this.cursorPosLabel.setVisible(!1),this.pointer=this.input.activePointer,this.horizontalGuideLine=this.add.line(0,0,1,1).setOrigin(0,0).setStrokeStyle(1,255,.25),this.verticalGuideLine=this.add.line(0,0,1,1).setOrigin(0,0).setStrokeStyle(1,255,.25),this.breakpointLabel=this.add.text(0,0,"",{fontFamily:'"Monospace"',color:"#0000ff",fontSize:"24px"}).setVisible(!1).setOrigin(.5);const e=this.input.keyboard.addKey("N"),t=this.input.keyboard.addKey("C");e.on("down",(e=>{this.resumeFromBreakpoint()})),t.on("down",(e=>{this.suppressBreakPoints=!0,this.resumeFromBreakpoint(),setTimeout((()=>this.suppressBreakPoints=!1),3e3)})),p.inject.ui.hexUnderCursor.watch((e=>{if(e){const t=this.scene.get(s.Scenes.WorldMap).chunkedRenderer.getByHex(e);p.inject.config.debug.overlay&&this.debugData.set("hexInfo",function(e,t){try{const i=(0,m.getCurrentGameStateModel)(),r=g.app.game.scene.getScene(s.Scenes.WorldMap),l=i.regions.byHex(e),d=i.factions.byHex(e),h=i.currentPhase.faction,y=l?`\n${u.GLYPH.factions[d?.id??0]} R#${l.id} F#${d?.id??0} ${function(e){const t=(0,m.getCurrentGameStateModel)();if(!(0,a.isDataSetActive)(t.state,o.GameState.economy.budgetByRegion))return"";const i=t.economy.budgetOf(e);return`(${e.hexes.length}${u.GLYPH.hex} ${t.economy.treasuryOf(e)}${(0,n.withSign)(i.balance)}=${t.economy.treasuryOf(e)+t.economy.budgetOf(e).balance}${u.GLYPH.coin})`}(l)} "${l.name||"region"}"`:"",w=i.pawns.byHex(e).map(f).join("\n♖ "),v=w.length?"\n♖ "+w:"";let b=p.inject.config.debug.gameObjects&&r.tiles.getByHex(e.id)?.getDebugData()||"";b&&(b="\n"+b);let S="";return p.inject.debugLayers.activeLayerName&&(S=`\n${p.inject.debugLayers.activeLayerName}:\n  ${p.inject.debugLayers.activeLayer.getDetail(e)?.replace(/\n/g,"\n  ")}`),i.pawns.presentAtHex(e,c.PawnType.Town)&&d&&h&&(S+=`\nFaction ${d.id}:\n  Attitude: ${d.attitudeTowards(h)} (F: ${d.fearOf(h)} A: ${d.approvalOf(h)})`),`${e}[c:${e.c},r:${e.r}][chunk #${t}]${y}${v}${S}${b}`}catch(e){return`⛔ ${e.toString()}`}}(e,t.id))}else this.debugData.clear("hexInfo")}))}resumeFromBreakpoint(){console.log("RESUME FROM BREAKPOINT"),this.resumeFromBreakpointCallback&&(console.log("TRIGGERING CALLBACK"),this.resumeFromBreakpointCallback(),this.resumeFromBreakpointCallback=void 0,this.breakpointLabel.setVisible(!1))}update(){const e=this.scene.get(s.Scenes.WorldMap);e&&this.pointer.updateWorldPoint(e.cameras.main),this.cursorPosLabel.setText(`C(${Math.round(this.pointer.x)},${Math.round(this.pointer.y)}) W(${Math.round(this.pointer.worldX)},${Math.round(this.pointer.worldY)})\n${this.debugData.get("hexInfo")||""}`);const t=this.cameras.main;this.topLeftLabel.setText(`v2.10.0-build-5143612584 ${t.width}x${t.height} DPR=${g.app.device.dpr} (real=${window.devicePixelRatio||1}), variant=${g.app.device.uiVariant()} ${Math.floor(this.game.loop.actualFps)} FPS\n${function(e){if(p.inject.config.debug.dataFilter&&!"scenes".includes(p.inject.config.debug.dataFilter))return"";return["scenes:          state    DL  UL  TW A V",...e.map((e=>(0,l.padRight)("-"+e.scene.key,16)+" "+(0,l.padRight)(w[e.sys.settings.status],8)+(0,l.padLeft)(e.sys.displayList.length.toString(),3)+" "+(0,l.padLeft)(e.sys.updateList.length.toString(),3)+" "+(0,l.padLeft)(e.tweens.getTweens().length.toString(),3)+" "+(e.sys.isActive()?"* ":"  ")+(e.sys.isVisible()?"* ":"  ")))].join("\n")}(this.game.scene.getScenes(!0))}\n${function(){if(p.inject.config.debug.dataFilter&&!"level".includes(p.inject.config.debug.dataFilter))return"";if(!p.inject.currentGameState)return"level: N/A";const e=p.inject.gameStateModel.map,t=p.inject.gameStateModel.currentPhase;return`level: ${e.levelId} ${e.width}x${e.height} turn ${t.turnNumber} (${t.type} ${t.faction?.id??""})`}()}\n${p.inject.debugData.getText()}`),0===this.pointer.x&&0===this.pointer.y||(this.cursorPosLabel.setPosition((this.pointer.x+20)/p.inject.ui.scale(),(this.pointer.y+20)/p.inject.ui.scale()),this.cursorPosLabel.setVisible(!0)),this.horizontalGuideLine.setTo(0,this.pointer.y,this.cameras.main.width,this.pointer.y),this.verticalGuideLine.setTo(this.pointer.x,0,this.pointer.x,this.cameras.main.height)}async handleBreakpoint(e,t){const i=g.app.scene.worldMap;if(!this.suppressBreakPoints)return new Promise((s=>{t.region&&i.overlays.selectedRegionHighlight.set(t.region),t.hexes?setTimeout((()=>{i.overlays.conquerableHexesHighlight.set(t.hexes)}),100):i.overlays.conquerableHexesHighlight.clear();let n=p.inject.debugLayers.activeLayerName;t.debugLayer&&("string"==typeof t.debugLayer?p.inject.debugLayers.activate(t.debugLayer):p.inject.debugLayers.registerAndActivate("breakpointDebugLayer",t.debugLayer)),this.resumeFromBreakpointCallback=()=>{i.overlays.selectedRegionHighlight.clear(),i.overlays.conquerableHexesHighlight.clear(),t.debugLayer&&p.inject.debugLayers.activate(n),s()},this.breakpointLabel.setVisible(!0),this.breakpointLabel.setText("⏸️ "+e+"\n [N] step [C] continue"),this.breakpointLabel.setPosition(this.cameras.main.centerX,this.cameras.main.height-100)}))}}function f(e){const t=g.app.scene.worldMap.pawns.getById(e.id);return`${e.type}${1!==e.count?` x${e.count}`:""} #${e.id} ${e.isMovable()?"(M)":""} (${t?.mode??"-"}${t?.hanging?":h":""}${t?.jumping?":j":""})`}t.DebugScene=y;const w={0:"pending",1:"init",2:"start",3:"loading",4:"creating",5:"running",6:"paused",7:"sleeping",8:"shutdown",9:"destroyed"}},10298:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MenuHeaderUIScene=void 0;const s=i(11930),n=i(5715),a=i(97866),o=i(24917),r=i(91025),c=i(68660),l=i(68736),d=i(40056),h=i(17120),u=i(99694),p=i(88865),g=i(58592);var m=Phaser.GameObjects.Rectangle,y=Phaser.GameObjects.BitmapText,f=Phaser.GameObjects.Image;const w={[c.UiVariant.Compact]:{panelHeight:64,backButtonWidth:100},[c.UiVariant.Large]:{panelHeight:128,backButtonWidth:180,titleLineOffset:-14}};class v extends l.BaseUIScene{static get Layout(){return w[g.app.device.uiVariant()]}constructor(){super({key:s.Scenes.MenuHeaderUI}),this.state=(0,d.StateContainer)(this,{title:"",icon:null}),this.preUpdate=(0,a.whenDirty)((()=>{this.cameras.main.y=0;const e=this.bounds.width,t=(this.bounds.height,v.Layout);if(this.background.setPosition(0,0),this.background.setSize(e,t.panelHeight),this.backButton.width=t.backButtonWidth,this.icon.setVisible(!!this.state().icon),g.app.device.uiVariant()===c.UiVariant.Large)this.backButtonText.setText(this.state().backButtonTitle??"BACK"),u.Arrange.leftToRight({content:[{object:this.icon},{object:this.titleText}],x:this.bounds.contentLeft+c.DEFAULT_CONTENT_PADDING,spacing:6,origin:0}),u.Arrange.alignY([this.icon,this.titleText],{y:this.background.height/2-14,origin:.5}),this.backButton.setPosition(this.bounds.contentLeft+c.DEFAULT_CONTENT_PADDING,t.panelHeight/2+14);else{this.backButtonText.setText("BACK"),u.Arrange.leftToRight({content:[{object:this.icon},{object:this.titleText}],x:this.bounds.centerX,spacing:6,origin:.5}),u.Arrange.alignY([this.backButton,this.icon,this.titleText],{y:this.background.height/2,origin:.5}),this.backButton.x=this.bounds.contentLeft+14;const e=this.backButton.x+this.backButton.width+6;e>this.icon.x&&(this.icon.x=e,this.titleText.x=this.icon.x+this.icon.width+6)}}))}create(){super.create(),this.scale.on("resize",(()=>this.preUpdate.makeDirty())),this.background=new m(this,0,0,0,0,n.Colors.glassUi.shape).setOrigin(0,0),this.backButtonText=new y(this,0,0,o.BitmapFont.Small,"BACK").setTint(n.Colors.woodenUi.primaryText),this.backButton=new h.RibbonButton(this,0,0,{icon:new f(this,0,0,"atlas","ui/mini-icons/back").setTint(n.Colors.woodenUi.primaryText),type:h.RibbonButtonStyle.Small,width:180,content:this.backButtonText}),this.icon=new f(this,0,0,"atlas").setOrigin(0,0),this.titleText=new y(this,0,0,o.BitmapFont.Main,"?").setOrigin(0,0).setTint(n.Colors.glassUi.primaryText),this.backButton.onClicked((()=>p.inject.events.trigger(r.UserActions.GoBack()))),this.addAll([this.background,this.icon,this.titleText,this.backButton])}applyState(e,t,i){e.title&&this.titleText.setText(e.title),e.backButtonTitle&&g.app.device.uiVariant()===c.UiVariant.Large&&this.backButtonText.setText(e.backButtonTitle),void 0!==e.icon&&(e.icon&&this.icon.setFrame(e.icon),this.preUpdate.makeDirty())}slideOut(){this.tweens.add({targets:this.cameras.main,props:{y:-this.background.height*p.inject.ui.scale()},duration:p.inject.config.screenTransitionDuration,ease:"Sine.easeOut"})}slideIn(){this.tweens.add({targets:this.cameras.main,props:{y:0},duration:p.inject.config.screenTransitionDuration,ease:"Sine.easeOut"})}getTooltipFor(e){return e===this.backButton?{title:"Go back to the previous screen"}:super.getTooltipFor(e)}}t.MenuHeaderUIScene=v},65953:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalWindowScene=void 0;const s=i(11930),n=i(40169),a=i(56952),o=i(68736),r=i(97866),c=i(31856),l=i(88865),d=i(58592),h=i(51209),u=i(91025);var p=Phaser.GameObjects.Rectangle;class g extends o.BaseUIScene{constructor(){super({key:s.Scenes.ModalWindow,bounds:h.BOUNDS.FullScreen}),this.debugLayer=new n.UiDebugLayer(this),this.modalsStack=[],this.preUpdate=(0,r.whenDirty)((()=>{this.window.setPosition(this.cameras.main.width/2,this.cameras.main.height/2),this.backgroundOverlay.setSize(this.bounds.width,this.bounds.height),this.debugLayer.clear(),l.inject.config.debug.uiLayout&&(this.debugLayer.addHorizontalLine(this.cameras.main.height/2),this.debugLayer.addVerticalLine(this.cameras.main.width/2))})),this.observe.event(u.UserActions.SubmitForm,(()=>{this.submitCurrentModal()})),this.observe.event(u.UserActions.Cancel,(()=>{this.cancelCurrentModal()}))}pushModal(e,t){const i={uiProvider:e,props:t};d.app.navigator.currentScreen?.pause(),this.modalsStack.push(i),this.doShowModal(i),this.updateDebugData()}updateDebugData(){this.modalsStack.length?l.inject.debugData.set("modalWindow",this.modalsStack.map((e=>e.uiProvider.constructor.name)).join(" > ")):l.inject.debugData.clear("modalWindow")}submitCurrentModal(){this.modalsStack.length&&(this.modalsStack[this.modalsStack.length-1].uiProvider.handleSubmit(),this.closeModal())}cancelCurrentModal(){this.modalsStack.length&&(this.modalsStack[this.modalsStack.length-1].uiProvider.handleCancel(),this.closeModal())}doShowModal({uiProvider:e,props:t}){const i=this.window.onCancel((()=>{this.closeModal(),i.unsubscribe(),t.onClose(a.DialogButtons.Cancel)})),s=e.getContent(this,{...t,onClose:e=>{i.unsubscribe(),this.closeModal(),t.onClose(e)}},{width:this.bounds.width,height:this.bounds.height});this.window.setProps({title:e.getTitle(t),content:s}),this.preUpdate(),e.onShown?.(),this.fadeIn()}fadeIn(){this.window.animateIn(),this.add.tween({targets:this.backgroundOverlay,alpha:1,ease:"Sine.easeOut",duration:400})}fadeOut(e){this.window.animateOut(),this.add.tween({targets:this.backgroundOverlay,alpha:{from:1,to:0},ease:"Sine.easeOut",duration:400,onComplete:e})}closeModal(){this.modalsStack.pop();const e=this.modalsStack[this.modalsStack.length-1];e?this.doShowModal(e):(d.app.navigator.currentScreen?.resume(),this.fadeOut((()=>{0===this.modalsStack.length&&this.scene.sleep()}))),this.updateDebugData()}create(){if(super.create(),this.cameras.main.roundPixels=!0,this.window)throw new Error("Attempt to create ModalWindowScene for a second time");this.window=new c.ModalWindow(this,{title:""}),this.backgroundOverlay=new p(this,0,0,0,0,0,.5).setOrigin(0,0),this.addAll([this.backgroundOverlay,this.window])}isModalActive(){return this.modalsStack.length>0}}t.ModalWindowScene=g},60925:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PreloadScene=void 0;const s=i(11930),n=i(91025),a=i(82260),o=i(75071),r=i(39835),c=i(88865),l=i(58592);class d extends a.Scene{constructor(){super({key:s.Scenes.Preload})}preload(){}update(){}create(){if(this.load.spritesheet("coin","assets/img/coin-animated.png",{frameWidth:20,frameHeight:18}),this.load.spritesheet("coin-hd","assets/img/coin-animated-hd.png",{frameWidth:20,frameHeight:18}),this.load.spritesheet("flag","assets/img/flag-animated.png",{frameWidth:12,frameHeight:11}),this.load.multiatlas("atlas","assets/atlas.json","assets"),this.load.bitmapFont("debug","assets/fonts/debug.png","assets/fonts/debug.xml"),this.load.html("login-buttons","assets/html/login-buttons.html"),l.app.audio.load(this),l.app.fonts.load(this),this.dataFetchPromise=Promise.all([c.inject.userData.initialize().catch((e=>this.handleFatalLoadingError(e))),c.inject.mapRegistry.initialize().catch((e=>this.handleFatalLoadingError(e)))]),this.game.renderer.type===Phaser.CANVAS)return o.ErrorTracking.captureException(new Error("Canvas renderer detected")),void setLoadingStatus("Your browser/device does not seem to support WebGL, which is required to run this game. Sorry!");this.load.once(Phaser.Loader.Events.COMPLETE,(async()=>{await this.dataFetchPromise,this.sanityCheck()?(o.ErrorTracking.gameRunning=!0,setLoadingStatus(""),document.getElementById("loader")?.remove(),r.NewsBox.show(),c.inject.events.trigger(n.SystemEvents.EngineInitialized()),this.scene.stop()):this.game.destroy(!0)})),window.document.getElementById("phaser-game")?.classList?.remove("hidden"),this.load.start()}handleFatalLoadingError(e){o.ErrorTracking.captureException(e),this.failedToLoadLevelData=!0}sanityCheck(){return this.verifyTexturesLoaded()?l.app.appController.initialized?!this.failedToLoadLevelData||(o.ErrorTracking.captureException(new Error("Failed to load level data")),!1):(o.ErrorTracking.captureException(new Error("AppController did not start")),!1):(o.ErrorTracking.captureException(new Error("Failed to load textures")),!1)}verifyTexturesLoaded(){return void 0!==this.textures.getFrame("atlas","logos/game-title")}}t.PreloadScene=d},11930:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.Scenes=void 0,(i=t.Scenes||(t.Scenes={})).Play="Play",i.Debug="Debug",i.DebugHistory="DebugHistory",i.WorldMap="WorldMap",i.Preload="Preload",i.MapEditor="MapEditor",i.PlayUI="PlayUI",i.ModalWindow="ModalWindow",i.TitleScreenUI="TitleScreenUI",i.LevelSelectUI="LevelSelectUI",i.MenuHeaderUI="MenuHeaderUI",i.LevelDetailUI="LevelDetailUI",i.Victory="Victory",i.Defeat="Defeat",i.GlobalUI="GlobalUI",i.RandomMapSelectUI="RandomMapSelectUI",i.SidePanel="SidePanel"},51209:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BOUNDS=t.SidebarPanelBounds=t.MainBoundsProvider=t.FullScreenBoundsProvider=t.BaseBoundsProvider=void 0;const s=i(58592),n=i(68660),a=i(23441),o=i(88865),r=i(28418);class c{get x(){return 0}get y(){return 0}get contentLeft(){return this.width<=n.MAX_CONTENT_WIDTH?0:Math.trunc((this.width-n.MAX_CONTENT_WIDTH)/2)}get contentWidth(){return(0,a.pickSmaller)(this.width,n.MAX_CONTENT_WIDTH)}get contentRight(){return this.width<=n.MAX_CONTENT_WIDTH?this.width:this.contentLeft+n.MAX_CONTENT_WIDTH}get centerX(){return this.width/2}get centerY(){return this.height/2}}t.BaseBoundsProvider=c;class l extends c{get width(){return s.app.device.screenWidth}get height(){return s.app.device.screenHeight}}t.FullScreenBoundsProvider=l;class d extends c{get width(){return s.app.device.uiVariant()!==n.UiVariant.Compact&&o.inject.ui.sidebarMode()?s.app.device.screenWidth-r.SIDEBAR_LAYOUT.totalWidth:s.app.device.screenWidth}get height(){return s.app.device.screenHeight}}t.MainBoundsProvider=d;class h extends c{get x(){return s.app.device.uiVariant()===n.UiVariant.Compact?0:s.app.device.screenWidth-r.SIDEBAR_LAYOUT.totalWidth}get width(){return s.app.device.uiVariant()===n.UiVariant.Compact?s.app.device.screenWidth-r.SIDEBAR_LAYOUT.buttons.outerWidth:r.SIDEBAR_LAYOUT.contentWidth+r.SIDEBAR_LAYOUT.separatorWidth}get height(){return s.app.device.screenHeight}}t.SidebarPanelBounds=h,t.BOUNDS={Main:new d,FullScreen:new l,SidePanel:new h}},53270:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GlobalUIScene=void 0;const s=i(11930),n=i(68736),a=i(97866),o=i(82260),r=i(46453),c=i(91025),l=i(50807),d=i(3691),h=i(81363),u=i(28367),p=i(38952),g=i(5893),m=i(48500),y=i(12312),f=i(88865),w=i(24275),v=i(51209),b=i(58592),S=i(27557),x=m.logger.for("GlobalUIScene");class T extends n.BaseUIScene{constructor(){super({key:s.Scenes.GlobalUI,bounds:v.BOUNDS.FullScreen}),this.permanentTooltips=[],this.tooltipsPool=new g.Pool((()=>new u.Tooltip(this))),this.preUpdate=(0,a.whenDirty)((()=>{this.updateLayout()}))}addTooltip(e){switch(e.type){case p.TooltipType.Hover:return this.tooltip.showDelayed(e),this.tooltip.setDepth(1e3),this.tooltip;case p.TooltipType.Permanent:const t=this.tooltipsPool.take();return this.add.existing(t),t.depth=-1,t.setVisible(!1),this.permanentTooltips.push(t),t.showDelayed(e),t}}create(){super.create(),this.tooltip=new u.Tooltip(this),this.notifications=new l.Notifications(this),this.tooltip.setVisible(!1),this.sidebarButtons=new w.SidebarButtonsUI(this),this.sidebarButtons.addToScene(),this.toggleButtons=new y.ToggleButtonsUI(this),this.toggleButtons.addToScene(),this.addAll([this.tooltip,this.notifications]),this.promptButtons=new S.PromptButtonsUI(this),this.promptButtons.addToScene(),this.observe.event(c.SystemEvents.ScreenActivated,(e=>{this.toggleButtons.adjustLayoutBasedOnScreen(e.screen),this.notifications.clearToasts(d.NotificationScope.Screen),this.notifications.preUpdate.makeDirty(),this.promptButtons.updateLayout()})),this.observe.watch(f.inject.ui.selectedLevelId,(e=>{this.notifications.clearToasts(d.NotificationScope.Level)})),this.observe.watch(f.inject.ui.sidebarMode,(e=>{b.app.scene.globalUI?.tooltip.hide()})),this.bindKey(o.Input.Keyboard.KeyCodes.ESC,c.UserActions.Escape),this.bindKey(o.Input.Keyboard.KeyCodes.F8,c.UserActions.OpenLoadGameDialog),this.ambientGlitterSound=this.sound.add(h.SoundEffects.Glitter,{loop:!0,volume:0}),this.ambientGlitterVolume=new r.TransitionController(this,{duration:1e3,ease:"Sine.easeInOut",initialValue:0,applyValue:e=>{0===e?this.ambientGlitterSound.stop():(this.ambientGlitterSound.isPlaying||this.ambientGlitterSound.play(),this.ambientGlitterSound.setVolume(e))}}),this.load.multiatlas("gameOverAtlas","assets/gameOverAtlas.json","assets"),this.load.start()}getTooltipFor(e){return this.toggleButtons.getTooltipFor(e)||this.sidebarButtons.getTooltipFor(e)}updateLayout(){this.toggleButtons.updateLayout(),this.sidebarButtons.updateLayout(),this.notifications.preUpdate.makeDirty(),this.promptButtons.updateLayout()}update(e,t){super.update(e,t),this.permanentTooltips.forEach((e=>e.updatePosition())),f.inject.debugData.set("MOD_KEYS",(this.keys.ctrl.isDown?"CTRL":" ")+(this.keys.shift.isDown?"SHIFT":" ")+(this.keys.alt.isDown?"ALT":""))}removeTooltip(e){const t=this.permanentTooltips.indexOf(e);-1!==t?(this.permanentTooltips.splice(t,1),e.hide().then((()=>this.tooltipsPool.free(e)))):x.warning(`Invalid attempt to remove tooltip "${e}", no such tooltip present among permanent tooltips`)}clearTooltips(){this.permanentTooltips.forEach((e=>{e.hide().then((()=>this.tooltipsPool.free(e)))})),this.permanentTooltips=[]}}t.GlobalUIScene=T},3691:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NotificationToast=t.NotificationCategory=t.NotificationScope=t.NotificationStyle=t.NotificationType=void 0;var s=Phaser.GameObjects.BitmapText;const n=i(5715),a=i(70319),o=i(84892),r=i(98534),c=i(46453),l=i(68660),d=i(23441),h=i(58592);var u,p,g;(g=t.NotificationType||(t.NotificationType={})).Info="info",g.Success="success",g.Alert="alert",t.NotificationStyle={Default:{palette:{shape:n.Colors.glassUi.shape,shadow:n.Colors.glassUi.shapeShadow,timeoutBar:n.Colors.darker(n.Colors.glassUi.shapeShadow),highlight:n.Colors.glassUi.shapeLightAccent}},Alert:{palette:{shape:n.Colors.glassUi.alert.main,shadow:n.Colors.glassUi.alert.shadow,timeoutBar:n.Colors.darker(n.Colors.glassUi.alert.shadow),highlight:n.Colors.glassUi.alert.lightAccent}},Success:{palette:{shape:n.Colors.glassUi.success.main,shadow:n.Colors.glassUi.success.shadow,timeoutBar:n.Colors.darker(n.Colors.glassUi.success.shadow),highlight:n.Colors.glassUi.success.lightAccent}}},(p=t.NotificationScope||(t.NotificationScope={})).Global="global",p.Screen="screen",p.Level="level",(u=t.NotificationCategory||(t.NotificationCategory={})).FeedbackForm="feedback-form",u.InvalidUserActionHint="invalid-user-action-hint",u.SurrenderOffer="surrender-offer",u.UpdatePrompt="update-prompt",u.Error="error";class m extends a.AutoHeightResponsiveContainer{constructor(e){super(e.scene),this.parent=e,this.shadowRect=new o.RoundedRect(this.scene,{x:0,y:0,radius:this.parent.layout.radius}),this.backgroundRect=new o.RoundedRect(this.scene,{x:1,y:1,radius:this.parent.layout.radius}),this.timerBar=new o.RoundedRect(this.scene,{x:0,y:0,radius:0}),this.cancelTimeoutOnHover=!1,this.clickable=!1,this.closeButton=new r.MiniCloseButton(this.scene,0,0),this.offset=c.Control.propOf(this,"y",{duration:this.parent.layout.tweenDuration,ease:"Sine.easeInOut"}),this.add([this.shadowRect,this.backgroundRect,this.timerBar]),this.closeButton.onClicked((async()=>{this.onBeforeDismissed&&!await this.onBeforeDismissed()||(e.closeToast(this),this.onDismissed?.())})),this.setInteractiveAuto(),this.on("pointerdown",(async()=>{this.clickable&&(this.onBeforeDismissed&&!await this.onBeforeDismissed()||(this.onClicked?this.onClicked():e.closeToast(this)))})),this.on("pointerover",(()=>{this.clickable&&this.backgroundRect.setFillStyle(this.style.palette.highlight,.7),this.cancelTimeoutOnHover&&this.timeoutTween&&(this.timeoutTween.stop(),this.timerBar.setVisible(!1)),this.timeoutTween?.pause()})),this.on("pointerout",(()=>{this.backgroundRect.setFillStyle(this.style.palette.shape,.7),this.timeoutTween?.resume()}))}handleChildResize(e){const t=this.height;this.preUpdate.makeDirty(),this.updateSize();const i=this.height;this.parent.handleToastResized(this,i-t)}setProps(e){this.clearContent(),this.icon=e.icon,this.content=e.content,this.scope=e.scope,this.category=e.category,this.style=e.style,e.timeout&&(this.timeoutTween=this.scene.tweens.add({targets:this.timerBar,scaleX:{from:1,to:0},duration:e.timeout,onComplete:()=>{this.parent.closeToast(this)}})),this.clickable=e.clickable??!1,this.cancelTimeoutOnHover=e.cancelTimeoutOnHover??!1,this.onBeforeDismissed=e.onBeforeDismissed,this.onDismissed=e.onDismissed,this.onClicked=e.onClicked,this.timerBar.setFillStyle(e.style.palette.timeoutBar,1),this.backgroundRect.setFillStyle(e.style.palette.shape,.7),this.shadowRect.setFillStyle(e.style.palette.shadow,.7),this.closeButton.setTint(e.style.palette.shadow),this.add([this.icon,this.content,this.closeButton])}clearContent(){this.icon&&(this.icon.destroy(),this.remove(this.icon)),this.content&&(this.remove(this.content),this.content.destroy(),this.content=void 0),this.timeoutTween&&(this.timeoutTween.stop(),this.timeoutTween=void 0)}updateLayout(){const e=this.parent.layout;if(this.content){const t=this.width-3*e.padding-e.spaceForIcon-this.closeButton.width;this.content instanceof s?this.content.setMaxWidth(t):this.content.width=t}this.preUpdateChildren(),h.app.device.uiVariant()===l.UiVariant.Compact?(this.backgroundRect.radius=0,this.shadowRect.radius=0,this.backgroundRect.setPosition(0,1),this.backgroundRect.setSize(this.width,this.height-7),this.shadowRect.setSize(this.width,this.height),this.timerBar.radius=0):(this.backgroundRect.radius=e.radius,this.shadowRect.radius=e.radius,this.backgroundRect.setPosition(1,1),this.backgroundRect.setSize(this.width-2,this.height-7),this.shadowRect.setSize(this.width,this.height),this.timerBar.radius={tl:0,tr:0,bl:6,br:6}),this.timerBar.setPosition(0,this.height-6),this.timerBar.setSize(this.width,6),this.icon.setOrigin(.5,.5).setPosition(e.padding+e.spaceForIcon/2,(0,d.pickSmaller)(this.height/2,e.padding+this.icon.height/2)),this.content?.setPosition(e.padding+e.spaceForIcon+e.padding,e.padding),this.closeButton.setPosition(this.width-e.padding/2-this.closeButton.width,(0,d.pickSmaller)(this.height/2-this.closeButton.height/2,e.padding/2)),this.updateSize()}calculateHeight(){return 2*this.parent.layout.padding+(this.content?.height??0)}destroy(){this.clearContent(),super.destroy()}}t.NotificationToast=m},50807:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Notifications=void 0;const s=i(97866),n=i(14034),a=i(5893),o=i(99694),r=i(68660),c=i(23441),l=i(97119),d=i(48500),h=i(3691),u=i(39835),p=i(58592),g={padding:20,spaceForIcon:50,tweenDuration:300,maxWidth:900},m={[r.UiVariant.Compact]:{...g,spacing:0,radius:0,playModeOffsetFromBottom:82,baseOffsetFromBottom:0},[r.UiVariant.Large]:{...g,spacing:10,radius:6,playModeOffsetFromBottom:200,baseOffsetFromBottom:20}},y=d.logger.for("Notifications");class f extends n.ResponsiveLayer{constructor(e){super(e,[]),this.pool=new a.Pool((()=>new h.NotificationToast(this))),this.displayedToasts=[],this.tweener=new l.Tweener(this.scene,{duration:this.layout.tweenDuration}),this.preUpdate=(0,s.whenDirty)((()=>{this.tweener.stop(),this.displayedToasts.forEach((e=>e.offset.stopTransition()));let e=(0,c.pickSmaller)(this.layout.maxWidth,this.scene.bounds.contentWidth-20);p.app.device.uiVariant()===r.UiVariant.Compact&&(e=this.scene.bounds.width),this.displayedToasts.forEach((t=>{t.width=e,t.alpha=1,t.preUpdate()}));const{x:t,y:i}=this.getToastAreaBottomCenter();o.Arrange.fromTopToBottomOld(this.displayedToasts,{x:t,y:i,originY:1,originX:.5,spacing:this.layout.spacing})}),(()=>super.preUpdate()))}get layout(){return m[p.app.device.uiVariant()]}addToast(e){u.NewsBox.hide();const t=this.pool.take();t.setProps(e),t.width=this.getToastWidth(),t.updateLayout(),this.add(t),this.displayedToasts.forEach((e=>{e.offset.transitionTo(e.offset.targetValue-(this.layout.spacing+t.height))}));const{x:i,y:s}=this.getToastAreaBottomCenter();if(t.setPosition(i-t.width/2,s),t.offset.transitionTo(s-t.height),this.tweener.add({targets:t,alpha:{from:0,to:1},ease:"Sine.easeIn"}),e.category){const t=this.displayedToasts.filter((t=>t.category===e.category));for(let e of t)this.closeToast(e)}return this.displayedToasts.push(t),t}handleToastResized(e,t){const i=this.displayedToasts.indexOf(e);-1!==i?this.displayedToasts.slice(0,i+1).forEach((e=>{e.offset.transitionTo(e.offset.targetValue-t)})):y.warning("invalid call to handleToastResized - object not found among displayed toasts",e)}closeToast(e){return new Promise((t=>{const i=this.displayedToasts.indexOf(e);if(-1===i)return t();this.displayedToasts.splice(i,1),this.displayedToasts.slice(0,i).forEach((t=>{t.offset.transitionTo(t.offset.targetValue+(this.layout.spacing+e.height))})),this.tweener.add({targets:e,alpha:0,onComplete:()=>{e.destroy(),t()},ease:"Sine.easeOut"})}))}clearToasts(e){const t=this.displayedToasts.filter((t=>e===h.NotificationScope.Global||e===h.NotificationScope.Screen&&t.scope!==h.NotificationScope.Global||t.scope===e));for(let e of t)this.closeToast(e)}clearToastsByCategory(e){const t=this.displayedToasts.filter((t=>t.category===e));for(let e of t)this.closeToast(e)}getToastAreaBottomCenter(){return{x:this.scene.bounds.width/2,y:this.scene.bounds.height-this.getOffsetFromBottom()}}getOffsetFromBottom(){return p.app.navigator.currentScreen===p.app.screen.play||p.app.navigator.currentScreen===p.app.screen.levelDetail?this.layout.playModeOffsetFromBottom:this.layout.baseOffsetFromBottom}getToastWidth(){return p.app.device.uiVariant()===r.UiVariant.Compact?this.scene.bounds.width:(0,c.pickSmaller)(this.layout.maxWidth,this.scene.bounds.contentWidth-20)}}t.Notifications=f},27557:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PromptButtonsUI=void 0;const s=i(55254),n=i(1909),a=i(24917),o=i(5715),r=i(50668),c=i(46453),l=i(58592),d=i(68660),h=i(60807),u=i(88865);t.PromptButtonsUI=class{constructor(e){this.scene=e;const t=n.UiBuilder.for(e),i=t.hLayout({content:[t.image("ui/button-icons/fullscreen-enter",o.Colors.glassUi.primaryText),t.text("Enter fullscreen",a.BitmapFont.Main,o.Colors.glassUi.primaryText)],horizontalPadding:24,originY:.5,originX:0,layoutPolicy:r.LayoutChildrenPolicy.None,spacing:18});this.fullScreenButton=new s.RoundedRectButton(e,{content:i,raised:2,audio:!0}),this.fullScreenButton.y=-70,this.fullScreenButton.width=260,this.fullScreenButton.height=50,this.fullScreenButton.onClicked((()=>{h.track.interaction("enter_fullscreen"),this.scene.scale.startFullscreen()})),this.fullScreenButtonOffset=c.Control.propOf(this.fullScreenButton,"y",{ease:"Sine.easeInOut"})}addToScene(){this.scene.addAll([this.fullScreenButton])}updateLayout(){this.fullScreenButton.x=this.scene.bounds.centerX-this.fullScreenButton.width/2,this.shouldShowFullScreenPrompt()?this.fullScreenButtonOffset.transitionTo(20):this.fullScreenButtonOffset.transitionTo(0-this.fullScreenButton.height-20)}shouldShowFullScreenPrompt(){return l.app.device.uiVariant()===d.UiVariant.Compact&&l.app.device.isMobile()&&l.app.navigator.currentScreen===l.app.screen.play&&!u.inject.ui.sidebarMode()&&!this.scene.scale.isFullscreen&&l.app.device.isFullScreenAvailable()}}},21922:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SideBarWidget=void 0;const s=i(70319),n=i(1909),a=i(5715),o=i(28418);var r=Phaser.GameObjects.BitmapText;class c extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e);const i=n.UiBuilder.for(e);this.padding=t.padding??o.SIDEBAR_LAYOUT.widgets.padding,this.background=i.roundedRect(o.SIDEBAR_LAYOUT.widgets.radius,t.backgroundColor??10473960,.5),this.add([this.background]),t.title&&(this.title=i.richText(`[b]${t.title}[/b]`,a.Colors.glassUi.backgroundText),this.add(this.title))}setContent(e){this.content&&(this.content.setVisible(!1),this.remove(this.content)),this.content=e,e&&(this.add(e),e.setVisible(!0)),this.preUpdate.makeDirty()}setBackground(e,t=.5){this.background.setFillStyle(e,t)}calculateHeight(){return this.content?this.content.y+this.content.height+this.padding:2*this.padding}updateLayout(){let e=this.padding;this.title&&(this.title.setWordWrapWidth(this.width-2*this.padding),this.title.setPosition(this.padding,this.padding),e+=this.title.y+this.title.height),this.content&&(this.content.setPosition(this.padding,e),this.content instanceof r?this.content.maxWidth=this.width-2*this.padding:this.content.width=this.width-2*this.padding),this.updateSize(),this.background.setSize(this.width,this.height)}}t.SideBarWidget=c},59978:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SidebarButton=t.SideBarButtonState=void 0;const s=i(70319),n=i(28418),a=i(1909),o=i(5715);var r;!function(e){e[e.Rest=0]="Rest",e[e.Hover=1]="Hover",e[e.Selected=2]="Selected"}(r=t.SideBarButtonState||(t.SideBarButtonState={}));class c extends s.ResponsiveContainer{setState(e){return this.state=e,this.updateLayout(),this}constructor(e,t,i,s){super(e),this.key=t,this.role=i,this.tooltip=s,this.state=r.Rest,this._radius=n.SIDEBAR_LAYOUT.buttons.radius;const c=a.UiBuilder.for(e);this.background=c.roundedRect(this._radius,o.Colors.glassUi.background).setAlpha(0),this.icon=c.image("ui/button-icons/"+t).setTint(o.Colors.glassUi.backgroundText),this.stripe=c.rectangle(o.Colors.glassUi.backgroundText),this.setInteractiveAuto(),this.setData("tooltip",this.tooltip),this.add([this.background,this.icon,this.stripe])}updateLayout(){const e=(this.width-n.SIDEBAR_LAYOUT.buttons.stripeWidth)/2;switch(this.icon.setPosition(e-this.icon.width/2,this.height/2-this.icon.height/2),this.state){case r.Rest:this.background.setAlpha(0),this.stripe.setVisible(!1);break;case r.Hover:this.background.radius=this._radius,this.background.setSize(n.SIDEBAR_LAYOUT.buttons.innerWidth,n.SIDEBAR_LAYOUT.buttons.innerHeight),this.background.setPosition(e-this.background.width/2,this.height/2-this.background.height/2),this.background.setAlpha(1),this.stripe.setVisible(!1);break;case r.Selected:this.background.radius=0,this.background.setSize(this.width,this.height),this.background.setPosition(0,0),this.background.setAlpha(1),this.stripe.setVisible(!0),this.stripe.setSize(n.SIDEBAR_LAYOUT.buttons.stripeWidth,this.height),this.stripe.setPosition(this.width-this.stripe.width,0)}}}t.SidebarButton=c},96848:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SidebarButtonsController=void 0;const s=i(58592),n=i(81363),a=i(24275),o=i(59978),r=i(52937),c=i(88865);t.SidebarButtonsController=class{get selectedTab(){return c.inject.ui.sidebarMode()}constructor(e){this.tabButtons=e,this.onButtonClicked=(0,r.signal)(),e.forEach((e=>this.bindTo(e))),c.inject.ui.sidebarMode.watch((e=>{for(let t of this.tabButtons)t.setState(t.key===e?o.SideBarButtonState.Selected:o.SideBarButtonState.Rest)}))}bindTo(e){e.on("pointerover",(()=>{e.state===o.SideBarButtonState.Rest&&e.setState(o.SideBarButtonState.Hover)})).on("pointerout",(()=>{e.state===o.SideBarButtonState.Hover&&e.setState(o.SideBarButtonState.Rest)})).on("pointerdown",(()=>{s.app.audio.playEffect(n.SoundEffects.ButtonDown),e.state===o.SideBarButtonState.Selected?this.selectTab(void 0):e.role===a.Role.Clickable?(this.onButtonClicked.fire(e.key),this.selectTab(void 0)):this.selectTab(e.key)}))}selectTab(e){c.inject.ui.sidebarMode.set(e)}}},24275:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SidebarButtonsUI=t.Attachments=t.Role=t.SideBarButtonKeys=void 0;const s=i(58592),n=i(99694),a=i(28418),o=i(59978),r=i(96848),c=i(88865),l=i(91025),d=i(60807),h=i(69965),u=i(38952),p=i(1909),g=i(68660);var m,y;!function(e){e.Close="exit",e.Menu="menu",e.Settings="settings",e.BugReport="bug-report",e.Help="help"}(m=t.SideBarButtonKeys||(t.SideBarButtonKeys={})),function(e){e.Clickable="Clickable",e.Selectable="Selectable"}(y=t.Role||(t.Role={})),(t.Attachments||(t.Attachments={})).Warning="warning",t.SidebarButtonsUI=class{constructor(e){this.scene=e,this.buttons=[new o.SidebarButton(this.scene,m.Close,y.Clickable,"Close sidebar menu"),new o.SidebarButton(this.scene,m.Menu,y.Selectable,"Open level menu"),new o.SidebarButton(this.scene,m.Settings,y.Selectable,"Settings"),new o.SidebarButton(this.scene,m.BugReport,y.Selectable,"Open feedback form"),new o.SidebarButton(this.scene,m.Help,y.Selectable,"How to play")],this.barBackground=p.UiBuilder.for(this.scene).rectangle(10473960),this.controller=new r.SidebarButtonsController(this.buttons),c.inject.ui.sidebarMode.watchFuture((()=>this.updateLayout())),c.inject.events.on(l.SystemEvents.ScreenActivated,(e=>{this.updateLayout()})),this.controller.onButtonClicked((e=>{switch(e){case m.Close:break;case m.BugReport:s.app.notifications.toggleFeedback();break;case m.Help:this.handleHelpButtonClick()}}))}handleHelpButtonClick(){switch(d.track.interaction("help"),s.app.navigator.currentScreen){case s.app.screen.play:c.inject.events.trigger(l.UserActions.ShowHowToPlay());break;case s.app.screen.title:window.open(h.HtmlDocs.about.url,"_blank");break;default:s.app.tooltips.showOver(this.buttons.find((e=>e.key===m.Help)),{title:"Sorry! No help is available for this screen yet.\nTry hovering the other buttons on screen to find more information.",type:u.TooltipType.Hover,delayMs:0,icon:"attitude-emoji/1"})}}setButtonAttachment(e,t){}clearButtonAttachment(e){}get selectedTab(){return this.controller.selectedTab}getAvailableButtons(){if(!this.selectedTab&&s.app.device.uiVariant()===g.UiVariant.Compact)return s.app.navigator.currentScreen===s.app.screen.play?new Set([m.Menu]):s.app.navigator.currentScreen===s.app.screen.defeat||s.app.navigator.currentScreen===s.app.screen.victory?new Set:new Set([m.Settings]);const e=new Set([m.Settings,m.BugReport,m.Help]);return s.app.navigator.currentScreen===s.app.screen.play&&s.app.device.uiVariant()===g.UiVariant.Compact&&e.add(m.Menu),this.selectedTab&&e.add(m.Close),e}updateLayout(){s.app.device.updateScreenSize();const e=this.getAvailableButtons();for(let t of this.buttons)t.width=a.SIDEBAR_LAYOUT.buttons.outerWidth,t.height=this.selectedTab?a.SIDEBAR_LAYOUT.buttons.outerHeight:a.SIDEBAR_LAYOUT.buttons.innerHeight,t.setVisible(e.has(t.key));this.barBackground.setVisible(!!this.selectedTab),this.barBackground.setPosition(this.scene.bounds.width-a.SIDEBAR_LAYOUT.buttons.outerWidth,0),this.barBackground.setSize(a.SIDEBAR_LAYOUT.buttons.outerWidth,this.scene.bounds.height),n.Arrange.vertically({content:this.buttons,origin:0,y:a.SIDEBAR_LAYOUT.verticalOffset,spacing:0}),n.Arrange.alignX(this.buttons,{x:this.scene.bounds.width,origin:1})}addToScene(){this.scene.addAll([this.barBackground,...Object.values(this.buttons)])}hide(){for(let e of this.buttons)e.setVisible(!1)}getTooltipFor(e){}}},12312:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shouldShowFullScreenButton=t.ToggleButtonsUI=void 0;const s=i(29301),n=i(5715),a=i(60807),o=i(46453),r=i(68660),c=i(99694),l=i(84892),d=i(88865),h=i(58592),u=i(28418);t.ToggleButtonsUI=class{constructor(e){this.scene=e,this.offset=(u.SIDEBAR_LAYOUT.buttons.outerWidth-u.SIDEBAR_LAYOUT.buttons.innerWidth)/2,this.topOffsetController=new o.TransitionController(this.scene,{duration:200,ease:"Sine.easeInOut",initialValue:this.offset,applyValue:e=>{this.offset=e,this.updateLayout()}}),this.background=new l.RoundedRect(this.scene,{x:0,y:0,fillStyle:{color:n.Colors.ocean,alpha:u.SIDEBAR_LAYOUT.background.alpha},radius:u.SIDEBAR_LAYOUT.buttons.radius}),this.buttons={toggleSoundButton:new m(this.scene),toggleFullScreenButton:new g(this.scene)}}addToScene(){this.scene.addAll([this.background,...Object.values(this.buttons)])}updateLayout(){h.app.device.updateScreenSize(),Object.values(this.buttons).forEach((e=>e.setVisible(!1)));const e=this.getButtonsToShow();e.forEach((e=>e.setVisible(!0))),c.Arrange.vertically({content:e,origin:1,y:this.scene.bounds.height-this.offset-(d.inject.config.flags.avoidBottomRightCorner?48:0),spacing:2}),c.Arrange.alignX(e,{x:this.scene.bounds.width-this.offset,origin:1});const t=e[0],i=e[e.length-1];t?(this.background.setPosition(t.x-2,t.y-2),this.background.setSize(i.x+i.width-t.x+4,i.y+i.height-t.y+4),this.background.setVisible(this.shouldShowBackground())):this.background.setVisible(!1)}getButtonsToShow(){const{toggleSoundButton:e,toggleFullScreenButton:t}=this.buttons,i=[];return this.shouldShowToggleSoundButton()&&i.push(e),f()&&i.push(t),i}getTooltipFor(e){switch(e){case this.buttons.toggleFullScreenButton:return this.scene.scale.isFullscreen?{title:"Return to windowed mode"}:{title:"Go to fullscreen mode"};case this.buttons.toggleSoundButton:return h.app.audio.mute?{title:"Unmute sounds"}:{title:"Mute sounds"}}}adjustLayoutBasedOnScreen(e){this.updateLayout()}shouldShowToggleSoundButton(){return!(h.app.device.uiVariant()===r.UiVariant.Compact&&!d.inject.ui.sidebarMode()||h.app.device.isMobile())}shouldShowBackground(){return!d.inject.ui.sidebarMode()}hide(){this.topOffsetController.transitionTo(-34)}};class p extends s.StealthButton{constructor(e,t){super(e,{content:y(e,t).setTint(n.Colors.glassUi.backgroundText),audio:!0,radius:u.SIDEBAR_LAYOUT.buttons.radius}),this.setSize(u.SIDEBAR_LAYOUT.buttons.innerWidth,u.SIDEBAR_LAYOUT.buttons.innerHeight),this.onClicked((()=>this.handleClick()))}}class g extends p{constructor(e){super(e,g.ENTER),this.scene.scale.on(Phaser.Scale.Events.ENTER_FULLSCREEN,(()=>{this.content.setFrame(g.LEAVE)})),this.scene.scale.on(Phaser.Scale.Events.LEAVE_FULLSCREEN,(()=>{this.content.setFrame(g.ENTER)}))}handleClick(){this.scene.scale.isFullscreen?(a.track.interaction("exit_fullscreen"),this.scene.scale.stopFullscreen()):(a.track.interaction("enter_fullscreen"),this.scene.scale.startFullscreen())}}g.ENTER="ui/button-icons/fullscreen-enter",g.LEAVE="ui/button-icons/fullscreen-exit";class m extends p{constructor(e){super(e,m.ON)}handleClick(){h.app.audio.mute=!h.app.audio.mute,this.content.setFrame(h.app.audio.mute?m.ON:m.OFF),a.track.interaction(h.app.audio.mute?"mute":"unmute")}}function y(e,t,i="atlas"){return new Phaser.GameObjects.Image(e,0,0,i,t)}function f(){return!(h.app.device.uiVariant()===r.UiVariant.Compact&&!d.inject.ui.sidebarMode())&&h.app.device.isFullScreenAvailable()}m.ON="ui/button-icons/sound-on",m.OFF="ui/button-icons/sound-off",t.shouldShowFullScreenButton=f},28418:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SIDEBAR_LAYOUT=void 0,t.SIDEBAR_LAYOUT={buttons:{radius:6,spacing:2,innerWidth:32,innerHeight:32,outerWidth:54,outerHeight:40,stripeWidth:4},verticalOffset:10,background:{alpha:.9},contentWidth:360,contentPadding:16,separatorWidth:3,totalWidth:417,widgets:{radius:16,padding:16}}},38427:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createSocialsFootnote=t.SubmitButton=t.FeedbackWidgetContent=t.FeedbackWidget=t.FeedbackPanel=void 0;const s=i(1909),n=i(5715),a=i(28418),o=i(78295),r=i(68930),c=i(24917),l=i(99694),d=i(55254),h=i(21922),u=i(94433),p=i(70319),g=i(50668),m=i(88865),y=i(91025),f=i(58592),w=i(40009),v=i(3691);var b=Phaser.GameObjects.BitmapText;class S extends u.SidebarPanelBase{constructor(e){super(e),this.setWidgets([new x(e),M(e,0)])}}t.FeedbackPanel=S;class x extends h.SideBarWidget{constructor(e){super(e,{title:"Have feedback?"}),this.setContent(new T(e))}}t.FeedbackWidget=x;class T extends p.AutoHeightResponsiveContainer{constructor(e){super(e),this.messageField=new o.TextArea(this.scene,{rows:7,placeholder:"Write your message here",onChange:e=>{this.submitButton.setEnabled(!!e.trim())}}),this.emailField=new r.TextInput(this.scene,{width:200,placeholder:"email@example.com"}),this.emailFieldLabel=new b(this.scene,0,0,c.BitmapFont.Mini,"Add email if you'd like to hear back from me").setTint(n.Colors.glassUi.backgroundText),this.submitButton=new P(s.UiBuilder.for(this.scene)),this.message=s.UiBuilder.for(e).richText("Hi, I'm Mike, the developer behind this game, and I'd love to hear from you!\n\nWhether it's a [b]bug report[/b], an [b]idea for improvement[/b], or just a simple thank you, [b]all feedback is much appreciated![/b]",n.Colors.glassUi.backgroundText),this.submitButton.onClicked((()=>{var e,t,i;e=s.UiBuilder.for(this.scene),t=m.inject.ui.session.levelId,i={comment:this.messageField.text.trim()||void 0,email:this.emailField.text.trim()||void 0},m.inject.userData.rememberChoice("feedbackEmail",i.email),m.inject.events.trigger(w.ReportingEvents.SubmitFeedbackForm({levelId:t,email:i.email,mood:i.mood,comment:i.comment})),m.inject.ui.sidebarMode.set(void 0),f.app.notifications.add({style:v.NotificationStyle.Success,scope:v.NotificationScope.Global,timeout:3e3,clickable:!0,icon:e.image("ui/icons/heart"),cancelTimeoutOnHover:!1,content:e.vLayout({spacing:10,content:[e.caption("Thank you so much!"),e.paragraph("Feedback sent.")]})}),this.messageField.setText(""),this.submitButton.setEnabled(!1)})),this.submitButton.setEnabled(!1),this.emailField.setValue(m.inject.userData.recallChoice("feedbackEmail")??""),this.add([this.message,this.messageField,this.emailFieldLabel,this.emailField,this.submitButton])}calculateHeight(){return this.submitButton.y+this.submitButton.height}updateLayout(){const e=a.SIDEBAR_LAYOUT.contentPadding,t=this.width;this.message.setWordWrapWidth(t),this.message.setPosition(e,e).setOrigin(0,0),this.messageField.width=t,this.emailField.width=t,this.submitButton.width=t;const i=[this.message,20,this.messageField,10,this.emailFieldLabel,5,this.emailField,20,this.submitButton];l.Arrange.vertically({content:i,y:0,origin:0,spacing:0}),l.Arrange.alignX([this.message,this.messageField,this.emailFieldLabel,this.emailField,this.submitButton],{x:0,origin:0}),this.updateSize()}}t.FeedbackWidgetContent=T;class P extends d.RoundedRectButton{constructor(e){const t=e.text("Send!",c.BitmapFont.Main,n.Colors.glassUi.primaryText),i=e.hLayout({originX:.5,originY:.5,content:[t],spacing:10});super(e.scene,{raised:2,contentOriginX:.5,content:i}),this.label=t,this.layout=i,this.height=40}}function M(e,t=1){const i=s.UiBuilder.for(e);return i.vLayout({layoutPolicy:g.LayoutChildrenPolicy.None,originY:0,content:[i.hLayout({layoutPolicy:g.LayoutChildrenPolicy.None,originX:t,content:[i.text("You can also",c.BitmapFont.Mini,n.Colors.glassUi.backgroundText),i.button(s.ButtonTemplate.MiniStealthButton,{text:"Tweet at me",icon:i.image("ui/icons/twitter",n.Colors.glassUi.backgroundText).setScale(.5,.5),onClicked:()=>m.inject.events.trigger(y.UserActions.SendTweet())})],originY:.5,spacing:2,horizontalPadding:a.SIDEBAR_LAYOUT.contentPadding}),i.hLayout({layoutPolicy:g.LayoutChildrenPolicy.None,originX:t,content:[i.text("or",c.BitmapFont.Mini,n.Colors.glassUi.backgroundText),i.button(s.ButtonTemplate.MiniStealthButton,{text:"Join the Discord server",icon:i.image("ui/icons/discord",n.Colors.glassUi.backgroundText).setScale(.5,.5),onClicked:()=>m.inject.events.trigger(y.UserActions.JoinDiscord())})],originY:.5,spacing:2,horizontalPadding:a.SIDEBAR_LAYOUT.contentPadding})],spacing:6})}t.SubmitButton=P,t.createSocialsFootnote=M},19703:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HelpPanel=void 0;const s=i(70319),n=i(22884);class a extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.frame=new n.IFrame(this.scene,{url:"./assets/html/help/how-to-play.html"}),this.add(this.frame)}updateLayout(){this.frame.width=this.width,this.frame.height=this.scene.bounds.height,this.updateSize()}calculateHeight(){return this.frame.height}}t.HelpPanel=a},30220:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SmallRoundedRectButton=t.LevelMenuPanel=void 0;const s=i(70319),n=i(1909),a=i(5715),o=i(55254),r=i(24917),c=i(91025),l=i(81363),d=i(99694),h=i(23441),u=i(11041),p=i(99813),g=i(88865),m=i(58592),y=i(68660);class f extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.props=t,this.ui=n.UiBuilder.for(this.scene),this.headingPanel=new w(this.scene),this.buttons=new v(this),this.resumeButton=new x(this.scene,(()=>this.handleActionTaken())),this.add([this.headingPanel,this.buttons,this.resumeButton])}updateLayout(){this.headingPanel.width=this.width,this.headingPanel.updateLayout();const e=(0,h.pickSmaller)(200,this.width-60);this.buttons.width=e,this.resumeButton.width=e,this.resumeButton.setVisible(m.app.device.uiVariant()===y.UiVariant.Compact),d.Arrange.vertically({content:[{object:this.headingPanel},{object:this.buttons},{object:this.resumeButton}],y:40,origin:0,spacing:40}),d.Arrange.alignX([this.headingPanel,this.buttons,this.resumeButton],{x:this.width/2,origin:.5}),this.updateSize()}calculateHeight(){return this.resumeButton.y+this.resumeButton.height}setVisible(e){return e&&(this.headingPanel.updateContent(),this.buttons.rewindButton.livesCounter.setCount(g.inject.ui.session.remainingLives)),super.setVisible(e)}show(){this.headingPanel.updateContent(),this.buttons.rewindButton.livesCounter.setCount(g.inject.ui.session.remainingLives),this.setVisible(!0)}handleActionTaken(){this.props.onAction()}setRewindEnabled(e){this.buttons.rewindButton.setEnabled(e)}}t.LevelMenuPanel=f;class w extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.campaignTitle=this.ui.text("",r.BitmapFont.Small,a.Colors.glassUi.primaryText),this.levelName=this.ui.text("",r.BitmapFont.Main,a.Colors.glassUi.primaryText),this.turnNumber=this.ui.text("",r.BitmapFont.Mini,a.Colors.glassUi.secondaryText),this.add([this.campaignTitle,this.levelName,this.turnNumber])}updateContent(){const e=u.LevelModel.for(g.inject.ui.session.levelId);this.campaignTitle.setText(e.campaignContext?.campaign.name??"Conquest"),this.levelName.setText(e.getTitle(u.LevelTitleStyle.Full)),this.turnNumber.setText(`turn ${g.inject.gameStateModel.currentPhase.turnNumber}`),this.preUpdate.makeDirty()}updateLayout(){d.Arrange.vertically({content:[{object:this.campaignTitle},{object:this.levelName},{object:this.turnNumber}],y:0,spacing:6}),d.Arrange.alignX([this.campaignTitle,this.levelName,this.turnNumber],{x:this.width/2}),this.updateSize()}calculateHeight(){return this.turnNumber.y+this.turnNumber.height}}class v extends s.AutoHeightResponsiveContainer{constructor(e){super(e.scene),this.parent=e,this.rewindButton=new S(this.scene,{title:"Rewind",icon:"ui/button-icons/rollback",onClick:()=>{this.parent.handleActionTaken(),g.inject.events.trigger(c.UserActions.StartRewind()),m.app.audio.playEffect(l.SoundEffects.Rewind)}}),this.restartButton=new b(this.scene,{title:"Restart",icon:"ui/button-icons/restart",onClick:()=>{this.parent.handleActionTaken(),g.inject.events.trigger(c.UserActions.RestartLevel({levelId:g.inject.ui.session.levelId}))}}),this.replayButton=new b(this.scene,{title:"View Replay",icon:"ui/button-icons/eye",onClick:()=>{this.parent.handleActionTaken(),g.inject.ui.sidebarMode.set(void 0),g.inject.events.trigger(c.UserActions.ViewReplay())}}),this.leaveButton=new b(this.scene,{title:"Leave",icon:"ui/mini-close-button",onClick:()=>{this.parent.handleActionTaken(),g.inject.ui.sidebarMode.set(void 0),g.inject.events.trigger(c.UserActions.GoBack())}}),this.buttons=[this.rewindButton,this.restartButton,this.replayButton,this.leaveButton],this.add(this.buttons)}updateLayout(){for(let e of this.buttons)e.width=this.width;d.Arrange.vertically({content:this.buttons.map((e=>({object:e}))),y:0,origin:0,spacing:20}),this.updateSize()}calculateHeight(){return this.leaveButton.y+this.leaveButton.height}}class b extends o.RoundedRectButton{constructor(e,{title:t,icon:i,onClick:s,extraContent:o}){const c=n.UiBuilder.for(e),l=c.image(i).setTint(a.Colors.glassUi.primaryText),d=c.text(t,r.BitmapFont.Small,a.Colors.glassUi.primaryText);super(e,{raised:2,content:c.hLayout({content:[l,d,...o??[]],spacing:20,originY:.5,originX:0,horizontalPadding:20})}),this.image=l,this.text=d,this.height=40,this.onClicked(s)}setEnabled(e){super.setEnabled(e);const t=e?a.Colors.glassUi.primaryText:a.Colors.glassUi.disabledText;this.image.setTint(t),this.text.setTint(t)}}t.SmallRoundedRectButton=b;class S extends b{constructor(e,t){const i=new p.LivesCounter(e).setMode(p.LivesCounterMode.FullColor);super(e,{...t,extraContent:[i]}),this.livesCounter=i}setEnabled(e){super.setEnabled(e),this.livesCounter.setMode(e?p.LivesCounterMode.FullColor:p.LivesCounterMode.Muted)}updateLayout(){super.updateLayout(),this.livesCounter.x=162}}class x extends o.RoundedRectButton{constructor(e,t){const i=n.UiBuilder.for(e);super(e,{raised:2,content:i.hLayout({content:[i.image("ui/level-icons/in-progress"),i.text("Resume",r.BitmapFont.Main,a.Colors.glassUi.primaryText)],spacing:20,originY:.5,originX:0,horizontalPadding:30})}),this.height=48,this.onClicked(t)}}},68338:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SidePanelScene=t.ClickTrap=void 0;const s=i(97866),n=i(68736),a=i(11930),o=i(51209),r=i(88865),c=i(5715),l=i(24275),d=i(30220),h=i(58592),u=i(68660),p=i(73036),g=i(70319),m=i(38427),y=i(19703),f=i(28418);var w=Phaser.GameObjects.Rectangle;class v extends g.ResponsiveContainer{constructor(e){super(e),this.setInteractiveAuto("default")}}t.ClickTrap=v;class b extends n.BaseUIScene{constructor(){super({key:a.Scenes.SidePanel,bounds:o.BOUNDS.SidePanel}),this.preUpdate=(0,s.whenDirty)((()=>{this.scene.setVisible(!!r.inject.ui.sidebarMode());const e=r.inject.ui.sidebarMode()?this.panels[r.inject.ui.sidebarMode()]:void 0;e&&(e.width=this.bounds.width-f.SIDEBAR_LAYOUT.separatorWidth,e.x=f.SIDEBAR_LAYOUT.separatorWidth),this.separator.height=this.bounds.height,this.clickTrap.width=this.bounds.width,this.clickTrap.height=this.bounds.height,r.inject.ui.sidebarMode()||this.scene.pause()}))}create(){super.create(),this.panels={[l.SideBarButtonKeys.Settings]:new p.SettingsPanel(this),[l.SideBarButtonKeys.Menu]:new d.LevelMenuPanel(this,{onAction:()=>{h.app.device.uiVariant()===u.UiVariant.Compact&&r.inject.ui.sidebarMode.set(void 0)}}),[l.SideBarButtonKeys.BugReport]:new m.FeedbackPanel(this),[l.SideBarButtonKeys.Help]:new y.HelpPanel(this)},this.separator=new w(this,0,0,3,this.bounds.height,c.Colors.ocean).setOrigin(0,0),this.cameras.main.setBackgroundColor(c.Colors.glassUi.background),this.clickTrap=new v(this),this.addAll([this.clickTrap,...Object.values(this.panels),this.separator]),r.inject.ui.sidebarMode.watch((e=>{e&&this.scene.resume();for(let[t,i]of Object.entries(this.panels))i.setVisible(t===e);this.preUpdate.makeDirty()}))}update(e,t){super.update(e,t)}}t.SidePanelScene=b},97716:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogoutButton=t.LoggedInUi=t.LoggingInUI=t.NotLoggedInUi=t.LoginWidget=void 0;const s=i(48500),n=i(70319),a=i(1909),o=i(5715),r=i(55254),c=i(88865),l=i(91025),d=i(99694),h=i(21922),u=i(58592),p=i(70766),g=i(31103),m=i(81363),y=i(51453),f=i(7141),w=i(29301),v=i(24275),b={userEmail:"",loggedInState:p.LoginState.Disabled,cloudSyncState:y.CloudSyncState.Disabled};class S extends h.SideBarWidget{constructor(e){super(e,{padding:20}),this.currentState=b,this.notLoggedInContent=new T(this.scene),this.loggedInContent=new M(this.scene),this.loggingInContent=new P(this.scene),c.inject.login.state.watch((e=>{c.inject.ui.sidebarMode()===v.SideBarButtonKeys.Settings&&this.updateStateFromCurrentLoginStatus()})),c.inject.ui.sidebarMode.watch((e=>{e===v.SideBarButtonKeys.Settings&&this.updateStateFromCurrentLoginStatus()})),u.app.cloudSync.status.watch((e=>{this.updateState({cloudSyncState:e})}))}updateStateFromCurrentLoginStatus(){this.updateState({userEmail:c.inject.login.getUserEmail(),authProvider:c.inject.login.describeCurrentAuthProvider(),loggedInState:c.inject.login.state(),signupEmail:c.inject.storage.getItem("emailForSignIn")??void 0})}updateState(e){switch(this.currentState,this.currentState={...this.currentState,...e},this.currentState.loggedInState){case p.LoginState.SignedIn:this.loggedInContent.setProps(this.currentState),this.setContent(this.loggedInContent),this.setBackground(10473960);break;case p.LoginState.LoginFailed:case p.LoginState.Disabled:case p.LoginState.SignedOut:case p.LoginState.Offline:this.setContent(this.notLoggedInContent),this.notLoggedInContent.setProps({state:this.currentState.loggedInState,error:c.inject.login.signInErrorMessage}),this.setBackground(16771498,1);break;case p.LoginState.SigningIn:case p.LoginState.SignInEmailSent:this.setContent(this.loggingInContent),this.loggingInContent.setProps(this.currentState),this.setBackground(10473960)}}}t.LoginWidget=S;const x="[b]Sign in[/b] to [b]backup your progress[/b] and share it between devices!";class T extends n.AutoHeightResponsiveContainer{constructor(e){super(e);const t=a.UiBuilder.for(this.scene);this.warningPrompt=t.richText(x,o.Colors.glassUi.primaryText),this.warningPrompt.setStyle({halign:"center"}),this.buttons=new g.ResponsiveDOMContent(this.scene,"login-buttons"),this.buttons.addListener("click"),this.buttons.on("click",(e=>{const t=e.target?.id||e.target?.parentElement?.id;switch(u.app.audio.playEffect(m.SoundEffects.ButtonUp),t){case"login-google":c.inject.events.trigger(l.UserActions.SignInWithGoogle());break;case"login-facebook":c.inject.events.trigger(l.UserActions.SignInWithFacebook());break;case"login-email":c.inject.events.trigger(l.UserActions.SignInWithEmail())}})),this.add([this.warningPrompt,this.buttons])}calculateHeight(){return this.buttons.visible?this.buttons.y+this.buttons.height:this.warningPrompt.y+this.warningPrompt.height}setProps(e){switch(e.state){case p.LoginState.LoginFailed:this.warningPrompt.setText(c.inject.login.signInErrorMessage??"Oops! Something went wrong during the sign in process.\n\n[b]Please try again![/b]").setTint(o.Colors.glassUi.errorText),this.buttons.setVisible(!0);break;case p.LoginState.Offline:this.warningPrompt.setText("[b]You are offline![/b]\n\nReconnect to the internet in order to sign in.").setTint(o.Colors.glassUi.errorText),this.buttons.setVisible(!1);break;case p.LoginState.Disabled:default:this.warningPrompt.setText(x).setTint(o.Colors.glassUi.primaryText),this.buttons.setVisible(!0)}this.preUpdate.makeDirty()}updateLayout(){const e=T.extraPadding,t=this.width-2*e;this.warningPrompt.setStyle({...this.warningPrompt.style,wrap:{mode:1,width:t}}),d.Arrange.vertically({content:[this.warningPrompt,this.buttons],y:e,origin:0,spacing:20}),d.Arrange.alignX([this.warningPrompt,this.buttons],{x:e+t/2,origin:.5}),this.updateSize()}}t.NotLoggedInUi=T,T.extraPadding=0;class P extends n.AutoHeightResponsiveContainer{constructor(e){super(e);const t=a.UiBuilder.for(this.scene);this.label=t.richText("[i]Signing in...[/i]",o.Colors.glassUi.primaryText),this.label.setStyle({halign:"center"}),this.cancelButton=new w.StealthButton(e,{content:t.image("ui/mini-close-button").setTint(o.Colors.glassUi.backgroundText)}),this.cancelButton.setSize(24,24),this.cancelButton.onClicked((()=>{c.inject.login.cancelSignIn()})),this.add([this.label,this.cancelButton])}calculateHeight(){return this.label.height+40}updateLayout(){this.label.setWordWrapWidth(this.width),this.label.setPosition(this.width/2-this.label.width/2,20),this.cancelButton.setPosition(this.width-this.cancelButton.width+6,-6),this.updateSize()}setProps(e){e.loggedInState===p.LoginState.SignInEmailSent?this.label.setText(`Sign-in link sent to \n\n[b]${e.signupEmail??"the provided address"}[/b]\n\nVisit your inbox to complete the sign-in!`):this.label.setText("[i]Signing in...[/i]"),this.preUpdate.makeDirty()}}t.LoggingInUI=P;class M extends n.AutoHeightResponsiveContainer{constructor(e){super(e);const t=a.UiBuilder.for(this.scene);this.avatar=t.image("ui/avatar"),this.usernameLabel=t.richText("",o.Colors.glassUi.backgroundText),this.authProviderLabel=new f.StatusLabel(e),this.logoutButton=new I(t),this.logoutButton.onClicked((()=>{c.inject.events.trigger(l.UserActions.SignOut())})),this.statusLabel=new f.CloudSyncStatusLabel(this.scene),this.add([this.avatar,this.usernameLabel,this.authProviderLabel,this.logoutButton,this.statusLabel])}calculateHeight(){return this.statusLabel.y+this.statusLabel.height}setProps(e){this.usernameLabel.setText("[b]"+e.userEmail+"[/b]"),this.statusLabel.setSyncState(e.cloudSyncState),this.authProviderLabel.setProps({text:`Signed in with ${e.authProvider}.`,icon:"ui/icons/ok"})}updateLayout(){this.logoutButton.width=32,this.logoutButton.height=32,d.Arrange.vertically({content:[this.avatar,this.authProviderLabel,this.statusLabel],y:0,origin:0,spacing:14}),d.Arrange.alignX([this.authProviderLabel,this.statusLabel],{x:(this.avatar.width-this.statusLabel.icon.width)/2,origin:0}),this.usernameLabel.setPosition(54,this.avatar.y+this.avatar.height/2-this.usernameLabel.height/2),this.logoutButton.setPosition(this.width-this.logoutButton.width,this.avatar.y+this.avatar.height/2-this.logoutButton.height/2),this.statusLabel.setSize(this.width,this.logoutButton.height),this.updateSize()}}t.LoggedInUi=M;class I extends r.RoundedRectButton{constructor(e){const t=e.image("ui/button-icons/logout").setTint(o.Colors.glassUi.secondaryText),i=e.hLayout({spacing:10,originY:.5,originX:.5,content:[t]});super(e.scene,{raised:2,audio:!0,contentOriginX:.5,content:i}),this.setData("tooltip","Sign Out"),this.icon=t,this.layout=i}}t.LogoutButton=I,s.logger.for("LoginWidget")},73036:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SettingsPanel=void 0;const s=i(1909),n=i(48500),a=i(97716),o=i(98437),r=i(94433),c=i(88865);n.logger.for("SettingsPanel");class l extends r.SidebarPanelBase{constructor(e){super(e),this.ui=s.UiBuilder.for(this.scene),this.loginWidget=new a.LoginWidget(this.scene),this.settingsWidget=new o.SettingsWidget(this.scene),c.inject.config.flags.cloudSync?this.setWidgets([this.loginWidget,this.settingsWidget]):this.setWidgets([this.settingsWidget])}}t.SettingsPanel=l},98437:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CameraFollowButton=t.SurrenderButton=t.SpeedButton=t.ThemeButton=t.SelectOptionButton=t.SettingsWidget=void 0;const s=i(21922),n=i(70319),a=i(1909),o=i(5715),r=i(55254),c=i(24917),l=i(88865),d=i(70448),h=i(60807),u=i(91025),p=i(22378);class g extends s.SideBarWidget{constructor(e){super(e,{padding:20,title:"Preferences"}),this.setContent(new m(e))}}t.SettingsWidget=g;class m extends n.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=a.UiBuilder.for(this.scene),this.themeLabel=this.ui.richText("Color scheme",o.Colors.glassUi.secondaryText),this.themeButton=new f(this.ui),this.speedLabel=this.ui.richText("Enemy turn speed",o.Colors.glassUi.secondaryText),this.speedButton=new w(this.ui),this.surrenderLabel=this.ui.richText("Rivals surrender",o.Colors.glassUi.secondaryText),this.surrenderButton=new v(this.ui),this.cameraLabel=this.ui.richText("Camera autofocus",o.Colors.glassUi.secondaryText),this.cameraButton=new b(this.ui),this.add([this.themeLabel,this.themeButton,this.speedLabel,this.speedButton,this.surrenderLabel,this.surrenderButton,this.cameraLabel,this.cameraButton])}calculateHeight(){return this.cameraButton.y+this.cameraButton.height}updateLayout(){this.themeButton.setPosition(this.width-this.themeButton.width,0),this.themeLabel.setPosition(0,this.themeButton.height/2-this.themeLabel.height/2),this.speedButton.setPosition(this.themeButton.x,this.themeButton.y+this.themeButton.height+16),this.speedLabel.setPosition(this.themeLabel.x,this.speedButton.y+this.speedButton.height/2-this.speedLabel.height/2),this.surrenderButton.setPosition(this.speedButton.x,this.speedButton.y+this.speedButton.height+16),this.surrenderLabel.setPosition(this.themeLabel.x,this.surrenderButton.y+this.surrenderButton.height/2-this.surrenderLabel.height/2),this.cameraButton.setPosition(this.surrenderButton.x,this.surrenderButton.y+this.surrenderButton.height+16),this.cameraLabel.setPosition(this.themeLabel.x,this.cameraButton.y+this.cameraButton.height/2-this.cameraLabel.height/2),this.updateSize()}}class y extends r.RoundedRectButton{constructor(e,t,i){const s=e.text("",c.BitmapFont.Small,o.Colors.glassUi.secondaryText),n=e.hLayout({spacing:10,originY:.5,originX:.5,content:[s]});super(e.scene,{raised:2,audio:!0,contentOriginX:.5,content:n}),this.options=t,this.selected=i,this.label=s,this.layout=n,this.width=150,this.height=30,this.onClicked((()=>this.handleClick())),this.select(this.options.includes(i)?this.selected:this.options[0])}select(e){this.selected=e,this.label.setText(this.getOptionLabel(e)),this.layout.updateSize(),this.layout.updateLayout()}handleClick(){let e=this.options.indexOf(this.selected);-1===e&&(e=0);const t=this.options[(e+1)%this.options.length];this.select(t),this.onSelected(this.selected)}}t.SelectOptionButton=y;class f extends y{constructor(e){super(e,["muted","default","grounded","highContrast"],l.inject.userData.recallChoice("preferredTheme")??"default")}onSelected(e){l.inject.userData.rememberChoice("preferredTheme",e),l.inject.events.trigger(u.UserActions.SyncWithModel()),h.track.interaction("change_color_theme")}getOptionLabel(e){return d.THEMES[e]?.name??"Default"}}t.ThemeButton=f;class w extends y{constructor(e){super(e,[1,2,3],l.inject.userData.recallChoice("spectatingSpeed")||1)}onSelected(e){l.inject.events.trigger(u.UserActions.SetSpectatingPlayBackSpeed(e))}getOptionLabel(e){return l.SPECTATING_SPEED_LABELS[e]}}t.SpeedButton=w;class v extends y{constructor(e){super(e,[!0,!1],l.inject.userData.recallChoice("rivalsSurrender")??!0)}onSelected(e){l.inject.userData.rememberChoice("rivalsSurrender",e)}getOptionLabel(e){return e?"Enabled":"Disabled"}}t.SurrenderButton=v;class b extends y{constructor(e){super(e,[p.CameraFollowPreset.On,p.CameraFollowPreset.NoZoom,p.CameraFollowPreset.Off],l.inject.userData.recallChoice("cameraFollow")??p.CameraFollowPreset.On)}onSelected(e){l.inject.userData.rememberChoice("cameraFollow",e)}getOptionLabel(e){switch(e){case p.CameraFollowPreset.On:return"On";case p.CameraFollowPreset.NoZoom:return"No zoom-out";case p.CameraFollowPreset.Off:return"Disabled"}}}t.CameraFollowButton=b},94433:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SidebarPanelBase=void 0;const s=i(70319),n=i(28418),a=i(48500),o=i(99694);a.logger.for("SidebarPanelbase");class r extends s.AutoHeightResponsiveContainer{constructor(e){super(e)}setWidgets(e){this.widgets=e,this.add(e)}updateLayout(){for(let e of this.widgets)e.width=this.width-2*n.SIDEBAR_LAYOUT.contentPadding;o.Arrange.vertically({content:this.widgets,y:n.SIDEBAR_LAYOUT.contentPadding,spacing:n.SIDEBAR_LAYOUT.contentPadding}),o.Arrange.alignX(this.widgets,{x:this.width/2,origin:.5}),this.updateSize()}calculateHeight(){const e=this.widgets[this.widgets.length-1];return e.y+e.height}}t.SidebarPanelBase=r},7141:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CloudSyncStatusLabel=t.StatusLabel=void 0;const s=i(51453),n=i(70319),a=i(1909),o=i(5715),r=i(23441),c={[s.CloudSyncState.Synchronized]:{icon:"ui/icons/cloud-ok",text:"Progress saved."},[s.CloudSyncState.Synchronizing]:{icon:"ui/icons/cloud-syncing",text:"Saving progress..."},[s.CloudSyncState.NotAvailable]:{icon:"ui/icons/cloud-failed",text:"Disconnected."},[s.CloudSyncState.Disabled]:{icon:"ui/icons/cloud-failed",text:"Disconnected."}};class l extends n.AutoHeightResponsiveContainer{constructor(e){super(e);const t=a.UiBuilder.for(this.scene);this.label=t.richText("",o.Colors.glassUi.secondaryText).setOrigin(0,.5),this.icon=t.image(c[s.CloudSyncState.Synchronizing].icon),this.add([this.label,this.icon])}updateLayout(){this.icon.setPosition(0,0),this.label.setPosition(30,this.icon.height/2),this.updateSize()}setProps({text:e,icon:t}){this.label.setText(e),this.icon.setFrame(t).setOrigin(0,0),this.updateLayout()}calculateHeight(){return(0,r.pickLarger)(this.label.height,this.icon.height)}}t.StatusLabel=l,t.CloudSyncStatusLabel=class extends l{setSyncState(e){this.setProps(c[e])}}},48216:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createWorldMapLODManager=void 0;const s=i(22827),n=i(46453),a=i(58592);t.createWorldMapLODManager=function(e){const t=new n.TransitionController(e.scene,{applyValue:t=>{e.coins.setAlpha(t),e.coinStacks.setAlpha(t),a.app.scene.worldMap.overlays.regionSummaryPopup.setAlpha(t)},ease:"ease.sineInOut",duration:100,initialValue:1});return new s.LODManager(e.scene.cameras.main,[{when:e=>e<.9,activate:e=>{t.transitionTo(0)}},{when:e=>e>=.9,activate:e=>{t.transitionTo(1)}},{when:e=>e>=1.5,activate:()=>{e.coinStacks.defaultFrame="coinstack-hd",e.coins.defaultKey="coin-hd";for(let t of e.coinStacks.getChildren())t.setFrame("coinstack-hd");for(let t of e.coins.getChildren())t.setTexture("coin-hd")}},{when:e=>e<1.5,activate:()=>{e.coinStacks.defaultFrame="coinstack",e.coins.defaultKey="coin";for(let t of e.coinStacks.getChildren())t.setFrame("coinstack");for(let t of e.coins.getChildren())t.setTexture("coin")}}])}},39363:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapPointersTracker=void 0;const s=i(5773),n=i(86848),a=i(24794),o=i(88865),r=i(58592),c=i(91025);i(48500).logger.for("TwoPointersTracker");class l extends s.TwoPointersTracker{constructor(e){super(e),this.dragOriginHexId=void 0}hasInteraction(e){const t=this.buildPointerEventContext(e);return this.scene.mode.isHexInteractive(void 0===t.hexId?void 0:(0,a.getHex)(t.hexId))}onStartInteraction(e){const t=this.buildPointerEventContext(e);this.dragOriginHexId=t.hexId,o.inject.events.trigger(c.WorldMapEvents.StartInteraction(this.buildPointerEventContext(e)))}onCompleteInteraction(e){o.inject.events.trigger(c.WorldMapEvents.CompleteInteraction(this.buildPointerEventContext(e)))}onAbortInteraction(e){o.inject.events.trigger(c.WorldMapEvents.AbortInteraction(this.buildPointerEventContext(e)))}onStartDrag(e){const t=this.buildPointerEventContext(e);this.dragOriginHexId&&(t.hexId=this.dragOriginHexId,this.dragOriginHexId=void 0),o.inject.events.trigger(c.WorldMapEvents.StartDrag(t))}onEndDrag(e){o.inject.events.trigger(c.WorldMapEvents.EndDrag(this.buildPointerEventContext(e)))}onStartPinch(e){r.app.scene.worldMap.cameraController.stopDragScroll(),r.app.scene.worldMap.cameraController.zoomController.startPinchZoom(),o.inject.events.trigger(c.WorldMapEvents.StartPinch(this.buildPointerEventContext(e)))}onEndPinch(e){r.app.scene.worldMap.cameraController.zoomController.stopPinchZoom(),o.inject.events.trigger(c.WorldMapEvents.EndPinch(this.buildPointerEventContext(e)))}buildPointerEventContext(e){const t=(0,n.getHexUnderCursor)(this.scene,o.inject.gameStateModel);let i=0;return(e.middleButtonDown()||e.middleButtonReleased())&&(i|=c.PointerEventFlags.MiddleButton),(e.rightButtonDown()||e.rightButtonReleased())&&(i|=c.PointerEventFlags.RightButton),this.scene.keys.shift.isDown&&(i|=c.PointerEventFlags.Shift),this.scene.keys.alt.isDown&&(i|=c.PointerEventFlags.Alt),this.scene.keys.ctrl.isDown&&(i|=c.PointerEventFlags.Ctrl),e.wasTouch&&(i|=c.PointerEventFlags.Touch),{hexId:t?.id,flags:i}}}t.WorldMapPointersTracker=l},57492:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapScene=void 0;const s=i(48500),n=i(11930),a=i(47613),o=i(52596),r=i(67945),c=i(50735),l=i(59889),d=i(80347),h=i(78179),u=i(46919),p=i(30420),g=i(74965),m=i(71234),y=i(82260),f=i(21361),w=i(86703),v=i(68480),b=i(89806),S=i(48216),x=i(39363),T=i(88865),P=i(58592),M=i(51209),I=i(69414),A=i(70448),C=i(23479),B=s.logger.for("WorldMapScene");class E extends u.BaseScene{constructor(){super({key:n.Scenes.WorldMap,bounds:M.BOUNDS.Main}),this.currentSessionId=0}session(){const e=this.currentSessionId,t=this;return{isActive:()=>t.currentSessionId===e}}endSession(){this.currentSessionId++}create(){super.create(),this.mode=new b.BaseWorldMapMode,this.input.keyboard.addKey(y.Input.Keyboard.KeyCodes.SHIFT),P.app.device.supports.touch&&this.input.addPointer(1),this.input.on("wheel",((e,t,i,s,n)=>{this.mode.zoomWithScrollWheel&&this.cameraController.zoomController.applyScroll(s)}),this),this.chunkedRenderer=new g.ChunkedRenderer(this,5),this.chunksRenderingController=new g.ChunksRenderingController(this,this.chunkedRenderer),this.cameraController=new r.WorldMapCameraController(this),this.debugOverlay=new o.WorldMapDebugOverlay(this,this.chunkedRenderer),this.editorOverlay=new f.WorldMapEditorOverlay(this),this.objectPools=new m.WorldObjectsPool(this),this.debugOverlay.create(),this.tiles=new c.TilesManager(this,this.chunkedRenderer),this.regions=new w.RegionsRenderer(this.chunkedRenderer),this.landmass=new v.LandmassRenderer(this.chunkedRenderer),this.coins=new l.CoinsManager(this,this.objectPools,this.tiles),this.pawns=new d.PawnsManager(this,this.objectPools,this.tiles),this.overlays=new C.WorldMapOverlaysManager(this),this.vfx=new I.VFXSpawner(this),this.pointersTracker=new x.WorldMapPointersTracker(this),this.input.on("pointerup",this.onPointerUp,this),this.input.on("pointermove",this.onPointerMove,this),this.scale.on("resize",this.handleResize,this),T.inject.config.watch(this.applyConfig.bind(this)),this.lodManager=(0,S.createWorldMapLODManager)(this.objectPools),this.observe.signal(T.inject.debugLayers.onActiveLayerUpdated,(e=>{if(T.inject.config.debug.overlay)try{this.debugOverlay.showDebugLayer(e)}catch(t){B.warning(`Failed to render debug layer ${e}`,t,t?.stack)}})),this.anims.create({key:"spin-coin",frames:this.anims.generateFrameNumbers("coin",{frames:[0,1,2,3,4,5,0]}),frameRate:30,repeat:-1}),this.applyTheme(T.inject.userData.recallChoice("preferredTheme")??"default")}setMode(e){B.info(`⚙ entering ${e.name} (from ${this.mode.name})`),this.mode.deactivate(),this.mode=e,T.inject.debugData.set("worldMap.mode",this.mode.name),e.activate()}applyConfig(e){super.applyConfig(e),this.debugOverlay.setVisible(!!e.debug.overlay)}onPointerMove(){this.mode.handlesPointerEvents&&T.inject.ui.hexUnderCursor.update(this)}update(e,t){this.pawns.update(),this.mode.rendersEverything?this.chunksRenderingController.renderEverything():this.chunksRenderingController.update();const i=this.cameras.main;this.cameraController.update(e,t),this.lodManager.update(),T.inject.config.debug.overlay&&(T.inject.debugData.set("CAM.dimensions",`${i.x},${i.y} -> ${i.width},${i.height}`),T.inject.debugData.set("CAM.worldView",`${i.worldView.x},${i.worldView.y} -> ${Math.round(i.worldView.right)},${Math.round(i.worldView.bottom)}`),T.inject.debugData.set("CAM.scroll",`${Math.round(i.scrollX)}, ${Math.round(i.scrollY)} ph(${this.cameraController.scrollController.cameraX.phase}) z(${i.zoom.toFixed(1)}) d(${(1/i.zoom).toFixed(1)})`),T.inject.debugData.set("CAM.scrollSpeed",`${Math.round(this.cameraController.scrollController.cameraX.speed)}`),T.inject.debugData.set("worldTweens",`${this.tweens.getTweens().length}`),T.inject.debugData.set("CAM.points",this.pointersTracker.pointers.map((e=>`${e.id}: ${!!this.pointersTracker.pointerMoved[e.id]}`)).join(",")),this.objectPools.updateDebugData())}loadNewGameState(e){T.inject.ui.withoutTransitions((()=>{this.cameraController.updateBounds(),this.debugOverlay.redrawWorldBoundsRectangle(this.cameraController.worldBounds),this.editorOverlay?.update(),this.syncState(e)}))}syncState(e=T.inject.currentGameState,t){const i=new a.StaticGameStateModel(e);this.currentSessionId++,this.applyTheme(i.map.themeKey);const{regions:s}=i,n=h.HexGroup.union(s.all().map((e=>e.hexes))),o=[p.PawnType.Coins,p.PawnType.Forest];this.tiles.syncWithModel(i,n,!0),this.pawns.syncWithModel(i,(e=>!o.includes(e.type))),this.coins.syncWithModel(i),this.regions.syncWithModel(i),this.landmass.syncWithModel(i),t?this.overlays.set(e,t):this.overlays.update(e),this.debugOverlay.redrawChunkRectangles(this.chunkedRenderer.getAllChunks()),this.mode.onSyncState(i),P.app.scene.worldMap.runIntegrityChecks()}async play(e){await this.mode.applyWorldUpdates(e)}destroy(e){}resize(e){const t=e.oldWidth-e.newWidth,i=e.oldHeight-e.newHeight,s=this.cameraController.scrollController;s.cameraX.setTo(s.cameraX.value+t/2),s.cameraY.setTo(s.cameraY.value+i/2)}getPawnObjectPositionOnScreen(e){return this.pawns.getPawnObjectPositionOnScreen(this.cameras.main,e)}handleResize(){this.cameraController.updateBounds(),this.mode.onResize()}runIntegrityChecks(){this.pawns.integrityCheck()}onPointerUp(e){e.wasTouch&&T.inject.ui.hexUnderCursor.clear()}applyTheme(e){const t=A.THEMES[e]??A.THEMES.default;this.regions.forestRenderer.recipe.frameIdBase=t.forestsTexture??"iso-tiles/forest"}}t.WorldMapScene=E},89806:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseWorldMapMode=void 0;const s=i(48500),n=i(58592);s.logger.for("BaseWorldMapMode"),t.BaseWorldMapMode=class{constructor(){this.name=this.constructor.name,this.rendersEverything=!1,this.handlesPointerEvents=!1,this.zoomWithScrollWheel=!1,this.scene=n.app.scene.worldMap}activate(){}deactivate(){}onSyncState(e){}onResize(){}applyWorldUpdates(e){}isHexInteractive(e){return!0}}},47102:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EditorMode=void 0;const s=i(89806),n=i(21361),a=i(58592);class o extends s.BaseWorldMapMode{constructor(){super(...arguments),this.handlesPointerEvents=!0}activate(){super.activate(),a.app.device.disableContextMenu(),this.scene.editorOverlay||(this.scene.editorOverlay=new n.WorldMapEditorOverlay(this.scene),this.scene.editorOverlay.create()),this.scene.editorOverlay.setVisible(!0),this.scene.editorOverlay?.update()}deactivate(){this.scene.editorOverlay?.setVisible(!1),a.app.device.enableContextMenu()}onSyncState(e){this.scene.editorOverlay?.update()}isHexInteractive(e){return!1}}t.EditorMode=o},23625:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InteractiveMode=void 0;const s=i(89806),n=i(33174),a=i(54444),o=i(48500),r=i(2975),c=i(85350),l=i(75071),d=i(30458),h=i(73205),u=i(58592),p=i(85282),g=o.logger.for("WorldMapScene");class m extends s.BaseWorldMapMode{constructor(){super(...arguments),this.handlesPointerEvents=!0,this.zoomWithScrollWheel=!0}activate(){super.activate(),u.app.scene.worldMap.cameraController.setViewportMargins({}),u.app.device.disableContextMenu()}deactivate(){super.deactivate(),u.app.device.enableContextMenu()}isHexInteractive(e){return u.app.scene.play.mode.isHexInteractive(e)}applyWorldUpdates(e){super.applyWorldUpdates(e);const t=e.updates,i=this.scene.session();if(0===t.length)return Promise.resolve();g.group(`Apply world updates: \n${t.map((e=>" - "+e.type)).join("\n")}`);const s=u.app.scene.worldMap,o=t.map((t=>(0,a.withTimeout)(this.scene,async function(e,t,i){switch(t.type){case n.UpdateType.PawnsMoved:return(0,r.playPawnMove)(e,t,i);case n.UpdateType.HexTakeover:return(0,d.playHexCaptured)(e,t,i);case n.UpdateType.PawnsDestroyed:return(0,c.playPawnDestroy)(e,t);case n.UpdateType.PawnReplaced:return(0,h.playPawnReplaced)(e,t,i);case n.UpdateType.CoinTransaction:return(0,p.playCoinTransaction)(e,t,i);default:throw new Error(`Unable to interpret ${t.type} => aborting smooth update and launching full map sync`)}}(s,t,e.stateAfter),2500).then((e=>{e===a.TIMEOUT&&i.isActive()&&g.error(`TIMED OUT while playing [${t.type}]: \n%s`,(0,a.prettyPrintObject)(t))}))));return Promise.all(o).then((()=>{console.groupEnd()})).catch((t=>{g.error(t.stack),l.ErrorTracking.captureException(t),g.warning("One or more smooth world map updates failed, resorting to full sync."),s.syncState(e.stateAfter),console.groupEnd()}))}}t.InteractiveMode=m},35037:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PreviewMode=void 0;const s=i(89806),n=i(88865);class a extends s.BaseWorldMapMode{constructor(){super(...arguments),this.handlesPointerEvents=!!n.inject.config.debug.overlay,this.rendersEverything=!0}onSyncState(e){super.onSyncState(e),this.scene.cameraController.center()}onResize(){this.scene.cameraController.center()}}t.PreviewMode=a},73674:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DisabledOverlayMode=void 0,t.DisabledOverlayMode=class{constructor(){this.type="disabled"}update(e,t){e.selectedRegionHighlight.clear(),e.pawnBacklight.clear(),e.conquerableHexesHighlight.clear(),e.townStatusFlags.clear(),e.pawnSymbols.clearAll(),e.hexMarkers.clear(),e.attitudeEmojis.clear(),e.regionSummaryPopup.hide()}toString(){return"[DisabledOverlay]"}}},85927:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayingOverlayMode=void 0;const s=i(78179),n=i(50264),a=i(5715),o=i(30420),r=i(14344),c=i(62977),l=i(42297),d=i(6810),h=i(52048),u=i(10863),p=i(43255),g=i(20666),m=i(58592),y=i(54444);t.PlayingOverlayMode=class{constructor(e){this.options=e,this.type="playing"}update(e,t){this.gameState=t,this.updateRegionHighlight(e),this.updatePawnBacklight(e),this.updateConquerableHexes(e),this.updateTownStatusFlags(e),this.updatePlusSymbols(e),(0,u.updateBankrupcySymbols)(t,e.pawnSymbols),(0,u.updateAttitudeEmojis)(this.gameState,e.attitudeEmojis),e.pawnSymbols.clear(d.PawnSymbolType.Arrow),this.updateRegionSummary(e),this.updateDefenseMarkers(e)}updateRegionSummary(e){const t=this.getSelectedRegion();!t||t.faction?.isLocalPlayer()?e.regionSummaryPopup.hide():e.regionSummaryPopup.showOverRegion(t.id)}updateRegionHighlight(e){const{selectedRegionId:t}=this.options;if(!t)return void e.selectedRegionHighlight.clear();const i=n.Regions.model(this.gameState).byId(t),o=i?.faction?.isLocalPlayer()?a.Colors.highlight.ownedRegion:a.Colors.brighter(i?.faction?.landColorLight??0,20);e.selectedRegionHighlight.setHexes(s.HexGroup.fromIds(n.Regions.getRegionHexes(this.gameState,t).toArray()),o)}updatePawnBacklight(e){const{selectedPawnId:t,selectedRegionId:i}=this.options;if(t){const i=c.Pawns.model(this.gameState).byId(t);if(i&&m.app.device.isUsingTouch())return void e.pawnBacklight.set(i.hex,{color:a.Colors.highlight.ownedRegion,width:20})}const n=r.Factions.model(this.gameState).localPlayer?.getRegions().filter((e=>e.id!==i)).filter((e=>e.treasury>=10||e.getMovableUnitsByMight().count()>0))??[],o=s.HexGroup.union(n.map((e=>e.getTownHexes())));e.pawnBacklight.set(o,{color:a.Colors.highlight.friendlyRegion})}updateConquerableHexes(e){e.conquerableHexesHighlight.clearHighlightedHex(),e.conquerableHexesHighlight.set(this.getConquerableHexes(),a.Colors.highlight.ownedRegion,this.options.holdingPawnType?1:.5)}getConquerableHexes(){const{holdingPawnType:e,selectedRegionId:t}=this.options,i=l.Warfare.model(this.gameState);if(!t)return s.HexGroup.empty;const a=n.Regions.model(this.gameState).byId(t);return a?e?e===o.PawnType.Present?i.getConquerableHexes(m.app.screen.play.selectedRegion,4).filter((e=>!i.isOccupied(e))):h.Rules.model(this.gameState).pawns(e).hasTrait(g.PawnTraits.Unit)?i.getConquerableHexes(a,e):s.HexGroup.empty:i.getConquerableHexes(a,a.getMovableUnitsByMight().getStrongest()):s.HexGroup.empty}updateTownStatusFlags(e){const t=r.Factions.model(this.gameState).localPlayer?.getRegions()??[];e.townStatusFlags.update((e=>{for(let i of t){const t=this.getFlagColor(i);void 0!==t&&e(i.getTownHexes(),t)}}))}getFlagColor(e){return e.budget.balance<0?e.treasury+e.budget.balance<0?3158064:16711680:e.treasury>=10?65280:void 0}updatePlusSymbols(e){const{holdingPawnType:t,selectedRegionId:i,selectedPawnId:s}=this.options;if(!t||!i)return void e.pawnSymbols.clear(d.PawnSymbolType.Plus);const a=n.Regions.model(this.gameState).byId(i);if(!a?.exists)return void e.pawnSymbols.clear(d.PawnSymbolType.Plus);const o=h.Rules.getPawnRules(this.gameState,t).merge;o&&a.getPawns().filter((e=>e.type===t&&e.id!==s)).forEach((t=>{e.pawnSymbols.add(t.id,d.PawnSymbolType.Plus,`Drop here to upgrade to ${o}.`)}))}getSelectedRegion(){if(this.options.selectedRegionId)return n.Regions.model(this.gameState).byId(this.options.selectedRegionId)}updateDefenseMarkers(e){const{selectedPawnId:t}=this.options,i=this.getSelectedRegion();if(!i)return void e.hexMarkers.clear();const s=(0,p.deriveDefenseMarkerDataFromModel)(i,t);e.hexMarkers.set(s)}toString(){return`[PlayingOverlay (${(0,y.str)(this.options)})]`}}},12749:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SpectatingOverlayMode=void 0;const s=i(78179),n=i(50264),a=i(5032),o=i(5715),r=i(10863);t.SpectatingOverlayMode=class{constructor(e){this.type="spectating",this.highlightRegions=e.highlightRegions??[],this.highlightHexes=e.highlightHexes??s.HexGroup.empty}update(e,t){this.gameState=t;const i=this.getHighlightColor();this.updateRegionHighlight(e,i),this.updateTownBacklight(e,i),e.conquerableHexesHighlight.set(this.highlightHexes,i),e.townStatusFlags.clear(),e.pawnSymbols.clearAll(),(0,r.updateBankrupcySymbols)(this.gameState,e.pawnSymbols),(0,r.updateAttitudeEmojis)(this.gameState,e.attitudeEmojis),e.hexMarkers.clear(),e.hexMarkers.clearHoveredHex(),e.regionSummaryPopup.hide()}updateRegionHighlight(e,t){const i=s.HexGroup.fromIds(this.highlightRegions.flatMap((e=>n.Regions.getRegionHexes(this.gameState,e).toArray())));e.selectedRegionHighlight.setHexes(i,t)}updateTownBacklight(e,t){const i=s.HexGroup.fromIds(this.highlightRegions.flatMap((e=>a.Economy.getTownHexesByRegion(this.gameState,e).toArray())));e.pawnBacklight.set(i,{color:t})}getHighlightColor(){if(!this.highlightRegions.length)return o.Colors.highlight.ownedRegion;const e=n.Regions.model(this.gameState).byId(this.highlightRegions[0]);return e&&e.exists?e.faction?.isLocalPlayer()?o.Colors.highlight.friendlyRegion:o.Colors.highlight.hostileRegion:o.Colors.highlight.ownedRegion}toString(){return`[SpectatingOverlay (regions=[${this.highlightRegions.join(",")}], hexes=[${this.highlightHexes.toString()}]`}}},23479:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapOverlaysManager=void 0;const s=i(62515),n=i(21711),a=i(6810),o=i(57942),r=i(43255),c=i(30489),l=i(21204),d=i(48500),h=i(73674),u=i(74422);d.logger.for("WorldMapOverlaysManager"),t.WorldMapOverlaysManager=class{constructor(e){this.scene=e,this.mode=new h.DisabledOverlayMode,this.selectedRegionHighlight=new s.SelectedRegionHighlight(this.scene.chunkedRenderer),this.conquerableHexesHighlight=new n.ConquerableHexesHighlight(this.scene,this.scene.objectPools),this.pawnSymbols=new a.PawnSymbolsManager(this.scene.pawns),this.attitudeEmojis=new o.AttitudeEmojiManager(this.scene,this.scene.objectPools,this.scene.tiles),this.hexMarkers=new r.HexDefenseMarkers(this.scene),this.townStatusFlags=new c.TownStatusFlagsManager(this.scene.chunkedRenderer,this.scene.objectPools,this.scene.tiles),this.pawnBacklight=new l.PawnBacklightManager(this.scene.chunkedRenderer,this.scene.tiles,this.scene.pawns),this.regionSummaryPopup=new u.RegionSummaryPopup(this.scene),this.scene.add.existing(this.regionSummaryPopup)}set(e,t){this.mode=t,this.mode.update(this,e)}update(e){this.mode.update(this,e)}}},10863:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateAttitudeEmojis=t.updateBankrupcySymbols=void 0;const s=i(50264),n=i(6810),a=i(20666),o=i(47613);t.updateBankrupcySymbols=function(e,t){const i=s.Regions.model(e).all().filter((e=>!e.faction?.isNeutral()&&(!e.isAlive()||e.isBankrupt())));t.clear(n.PawnSymbolType.CrossedCoin);for(let e of i)for(let i of e.getPawns().filter((e=>e.upkeep>0&&e.hasTrait(a.PawnTraits.Unit))))t.add(i.id,n.PawnSymbolType.CrossedCoin,"Unit can't get paid! It will turn into bandit next turn!")},t.updateAttitudeEmojis=function(e,t){const i=new o.StaticGameStateModel(e);t.syncWithModel(i,i.factions.localPlayer)}},30093:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverlayModes=void 0;const s=i(73674),n=i(12749),a=i(85927);t.OverlayModes={disabled:new s.DisabledOverlayMode,spectating:(e={})=>new n.SpectatingOverlayMode(e),playing:e=>new a.PlayingOverlayMode(e)}},8457:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.redrawPalisadeIfReplacedByBuilding=void 0;const s=i(52048),n=i(20666),a=i(24794),o=i(58592);t.redrawPalisadeIfReplacedByBuilding=function(e,t,i,r){const c=s.Rules.model(e);(c.pawns(r).hasTrait(n.PawnTraits.Building)||c.pawns(i).hasTrait(n.PawnTraits.Building))&&o.app.scene.worldMap.regions.palisadeRenderer.redrawHexes(e,(0,a.getHex)(t))}},85282:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playCoinTransaction=void 0;const s=i(58592),n=i(99896),a=i(92578),o=i(5427);t.playCoinTransaction=async function(e,t,i){!n.CurrentPhase.model(i).isLocalPlayerTurn()||s.app.scene.play.mode instanceof a.SpectatorMode&&(s.app.scene.play.mode.context===o.SpectatingContext.LiveReplay||s.app.scene.play.mode.context===o.SpectatingContext.ReplayOnly)?s.app.scene.worldMap.coins.applyTransactions(t.coinTransaction):s.app.scene.worldMap.coins.play(t.coinTransaction)}},30458:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playHexCaptured=void 0;const s=i(50264),n=i(24794),a=i(14344);t.playHexCaptured=async function(e,t,i){const o=i,r=s.Regions.model(o);e.regions.refreshHexes(o,(0,n.getHex)(t.conqueredHex));const c=t.affectedRegions.map((e=>r.byId(e))).filter((e=>e));e.regions.greenRenderer.redrawRegions(c),e.tiles.setTile((0,n.getHex)(t.conqueredHex),a.Factions.model(o).byId(t.newFactionId));const l=r.byId(t.newRegionId)?.hexes.find((e=>e.id!==t.conqueredHex)),d=e.overlays.selectedRegionHighlight;d.selectedRegion&&t.affectedRegions.includes(d.selectedRegion.id)?d.refresh():l&&d.includesHex(l)&&d.add((0,n.getHex)(t.conqueredHex))}},85350:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playPawnDestroy=void 0;const s=i(12678);t.playPawnDestroy=async function(e,t){const i=e.pawns.getById(t.pawnId);s.assert.defined(i),await e.pawns.transitions.destroyPawn(i)}},2975:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playPawnMove=void 0;const s=i(48500),n=i(30458),a=i(62977),o=i(12678),r=i(6914),c=i(52048),l=i(20666),d=i(99896),h=i(24794),u=i(88865),p=i(58592),g=i(50264),m=i(75071),y=i(5715),f=i(92578),w=i(8457),v=i(30093),b=s.logger.for("PawnsManager");t.playPawnMove=async function(e,t,i){const s=d.CurrentPhase.model(i).isLocalPlayerTurn()&&!(p.app.scene.play.mode instanceof f.SpectatorMode),S=[];if(t.hexCaptured){const e=g.Regions.model(i),s=t.hexCaptured.affectedRegions.map((t=>e.byId(t)));p.app.scene.play.refreshTownVariantInRegions(s.filter((e=>e)))}s&&t.hexCaptured&&(0,n.playHexCaptured)(e,t.hexCaptured,i),s&&e.overlays.set(i,v.OverlayModes.playing({selectedRegionId:p.app.screen.play.selectedRegion?.id})),!s&&t.hexCaptured&&e.overlays.conquerableHexesHighlight.add((0,h.getHex)(t.destHex),d.CurrentPhase.model(i).isLocalPlayerTurn()?y.Colors.highlight.friendlyRegion:y.Colors.highlight.hostileRegion);let x=[],T=[];const P=e.session();if(!u.inject.ui.skipTransitions()){for(let n of t.pawns){let a;if(n.created){const o=c.Rules.model(i).pawns(n.created.pawnType);a=e.pawns.createOrUpdatePawnObject({id:n.pawnId,type:n.created.pawnType,hexId:s||o.hasTrait(l.PawnTraits.Building)?t.destHex:n.created.hex??t.destHex,jumping:!1,visible:!0}),o.hasTrait(l.PawnTraits.Building)&&e.regions.palisadeRenderer.redrawHexes(i,(0,h.getHex)(t.destHex))}else a=e.pawns.getById(n.pawnId);if(!a)return void b.error(`Unable to play pawn move - pawn with id ${n.pawnId} not found`);S.push(a),a.visible&&!u.inject.ui.skipTransitions()&&(a.tile?.hex.id!==t.destHex?(x.push(e.pawns.transitions.pawnMove(a,{srcHex:n.created?.hex,destHex:t.destHex,fadeIn:!!n.created})),T.push(a)):n.created&&!s&&(x.push(e.pawns.transitions.pawnCreated(a,t.destHex)),T.push(a)))}for(let e of T)e.setJumping(!1),e.setHighlight(null);if(await Promise.all(x),!P.isActive())return;for(let i of T)i.setJumping(!1),i.setHighlight(null),i.setVisible(!0),i.isDestroyed()||i.attachToTile(e.tiles.getByHex(t.destHex))}if(!P.isActive())return;let M,I;if(!s&&t.hexCaptured&&((0,n.playHexCaptured)(e,t.hexCaptured,i),e.overlays.conquerableHexesHighlight.remove((0,h.getHex)(t.destHex))),t.merged){let s;if(t.merged.mergedWith&&(s=e.pawns.getById(t.merged.mergedWith)),M=a.Pawns.model(i).byId(t.merged.newPawnId),!M)return void m.ErrorTracking.captureNonFatalError(new Error("unable to play merge animation, output pawn object not found"),"playPawnMove");o.assert.defined(M),I=e.pawns.createOrUpdatePawnObject({id:M.id,hexId:M.hex.id,type:M.type,jumping:!1,visible:!0}),S.forEach((e=>e.destroy())),s&&!s.isDestroyed()&&s.destroy()}else if(t.replaced){I=e.pawns.createOrUpdatePawnObject({id:t.replaced.newPawnId,type:t.replaced.newType,hexId:t.destHex,jumping:!1,visible:!0});const s=e.pawns.getById(t.pawns[0].pawnId);S.forEach((e=>e.destroy())),s&&!s.isDestroyed()&&s.destroy(),M=a.Pawns.model(i).byId(t.replaced.newPawnId),(0,w.redrawPalisadeIfReplacedByBuilding)(i,t.destHex,t.replaced.oldType,t.replaced.newType)}else(0,o.assert)(1===t.pawns.length,`unexpected number of pawns involved in non-merge move - expected: 1; actual: ${t.pawns.length}`),M=a.Pawns.model(i).byId(t.pawns[0].pawnId),o.assert.defined(M,`pawn not found for id ${t.pawns[0].pawnId}`),I=T[0]??e.pawns.createOrUpdatePawnObject({id:M.id,hexId:M.hex.id,type:M.type,jumping:!1,visible:!0});if(I.setJumping(s&&M.isMovable()),I.hanging&&I.setHighlight(I.jumping?r.Highlight.Hang:null),t.defeatedUnit){const i=e.pawns.getById(t.defeatedUnit.pawnId);i?t.defeatedUnit.retreatHex?await async function(e,t){e&&await t}(!s,e.pawns.transitions.pawnMove(i,{destHex:t.defeatedUnit.retreatHex})):e.pawns.transitions.destroyPawn(i,T.length>0?(0,h.getHex)(t.pawns[0].srcHex):void 0):b.warning(`invalid defeated unit ${t.defeatedUnit.pawnId}`)}}},73205:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playPawnReplaced=void 0;const s=i(48500),n=i(8457),a=s.logger.for("PawnsManager");t.playPawnReplaced=async function(e,t,i){let s=e.pawns.getById(t.oldPawnId);s||a.error(`Unexpected state while in playPawnReplaced: old pawn #${t.oldPawnId} does not exist on the board`),e.pawns.createOrUpdatePawnObject({id:t.newPawnId,type:t.newType,jumping:s?.jumping??!1,hexId:t.hexId,visible:!0}),(0,n.redrawPalisadeIfReplacedByBuilding)(i,t.hexId,t.oldType,t.newType),s?.destroy()}},54949:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseScreen=void 0;const s=i(48500),n=i(58592),a=i(87262);s.logger.for("Navigator"),t.BaseScreen=class{constructor(e,t){this.lockOrientation=!1,this.observe=new a.Observer((()=>this.isActive())),this.scenes=t,this.name=e}getScenes(){return this.scenes}async activate(e,t){}async transitionIn(e){}async transitionOut(e){}deactivate(){}isActive(){return n.app.navigator.activeScreen===this&&!n.app.modals.isModalActive()}pause(){this.scenes.forEach((e=>n.app.game.scene.pause(e)))}resume(){this.scenes.forEach((e=>n.app.game.scene.resume(e)))}}},78089:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BreakPointScreen=void 0;const s=i(11930),n=i(54949);class a extends n.BaseScreen{constructor(){super("BreakPoint",[s.Scenes.WorldMap])}async activate(){}deactivate(){}}t.BreakPointScreen=a},50988:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugHistoryScreen=void 0;const s=i(11930),n=i(54949),a=i(88865),o=i(58592);class r extends n.BaseScreen{constructor(){super("DebugHistory",[s.Scenes.DebugHistory,s.Scenes.WorldMap])}async activate(){o.app.scene.debugHistory.resetCursor(),a.inject.history.suspendRecording(),this.prevIntegrityChecksSetting=a.inject.config.debug.integrityChecks,a.inject.config.debug.integrityChecks=void 0}deactivate(){a.inject.config.debug.integrityChecks=this.prevIntegrityChecksSetting,a.inject.history.resumeRecording()}}t.DebugHistoryScreen=r},436:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Navigator=void 0;const s=i(48500),n=i(91025),a=i(88865),o=i(58592),r=i(39835),c=s.logger.for("Navigator");t.Navigator=class{constructor(e){this.game=e,this.transitionInProgress=!1,this.lockedOrientation=!1}async goTo(e,t){if(this.transitionInProgress)return void c.warning(`Ignoring transition attempt to ${e.name} while another screen transition is already in progress`);this.transitionInProgress=!0;const i=this.activeScreen;o.app.tooltips.close(),r.NewsBox.hide(),this.updateScreenOrientationLock(e),this.currentScreen=e;let s=[];this.activeScreen&&(this.activeScreen.deactivate(),s=this.activeScreen.getScenes(),this.activeScreen=void 0);const l=e.getScenes();l.forEach((e=>{const t=this.game.scene.getScene(e);if(!t)throw new Error(`Scene not found: ${e}`);t.sys.isActive()||this.game.scene.run(e)})),await e.activate(t,i),a.inject.events.trigger(n.SystemEvents.ScreenActivated({screen:e,previousScreen:i})),a.inject.debugData.set("screen",`${i?.name??"-"} => ${e.name}`),await Promise.all([i?.transitionOut(e).then((()=>{})),e.transitionIn(i).then((()=>{}))]),this.activeScreen=e,s.filter((e=>-1===l.indexOf(e))).forEach((e=>{this.game.scene.sleep(e)})),this.transitionInProgress=!1,a.inject.debugData.set("screen",e.name)}async updateScreenOrientationLock(e){if(o.app.device.isMobile())try{e.lockOrientation?(await(window.screen?.orientation?.lock?.("portrait")),this.lockedOrientation=!0):(this.lockedOrientation&&window.screen?.orientation?.unlock?.(),this.lockedOrientation=!1)}catch(e){c.warning("Unable to lock/unlock display orientation",e)}}}},54173:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.returnToMenuFromGame=void 0;const s=i(11041),n=i(88865),a=i(58592),o=i(30093);t.returnToMenuFromGame=async function(){const e=n.inject.gameStateModel.map.levelId;n.inject.ui.selectedLevelId.set(e),s.LevelModel.for(e).campaignContext?(a.app.scene.worldMap.overlays.set(n.inject.currentGameState,o.OverlayModes.disabled),a.app.scene.levelDetailUI.refreshLevelCard(e),await a.app.navigator.goTo(a.app.screen.levelDetail)):await a.app.navigator.goTo(a.app.screen.title)}},54427:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefeatScene=void 0;const s=i(97866),n=i(68736),a=i(11930),o=i(56996),r=i(24917),c=i(5715),l=i(91025),d=i(1909),h=i(99694),u=i(68660),p=i(88865),g=i(58592);var m=Phaser.GameObjects.Image,y=Phaser.GameObjects.BitmapText,f=Phaser.GameObjects.Graphics;class w extends n.BaseUIScene{constructor(){super({key:a.Scenes.Defeat}),this.preUpdate=(0,s.whenDirty)((()=>{let e;p.inject.ui.session.remainingLives>0?(e=this.rewindButton,this.replayButton.setVisible(!1)):(e=this.replayButton,this.rewindButton.setVisible(!1)),e.setVisible(!0),this.ribbon.width=400,g.app.device.uiVariant()===u.UiVariant.Compact?(h.Arrange.vertically({content:[{object:this.ribbon},{object:e},{object:this.restartButton},{object:this.menuButton}],spacing:10,y:this.bounds.height-20,origin:1}),h.Arrange.alignX([e,this.restartButton,this.menuButton],{x:this.bounds.centerX,origin:.5}),this.ribbon.x=this.bounds.centerX-this.ribbon.width/2):(this.ribbon.setPosition(this.bounds.centerX-this.ribbon.width/2,this.bounds.height-150),h.Arrange.fromLeftToRightOld([e,this.restartButton,this.menuButton],{x:this.bounds.centerX,originX:.5,y:this.bounds.height-60,originY:.5,spacing:10})),this.ribbonText.setPosition(this.bounds.centerX,this.ribbon.y+6),this.gravestone.setPosition(this.bounds.centerX,this.ribbon.y-20),this.background.clear(),this.background.fillGradientStyle(0,0,0,0,0,0,.5,.5),this.background.fillRect(0,this.bounds.height-200,this.bounds.width,200)}))}create(){super.create();const e=d.UiBuilder.for(this);this.restartButton=e.button(d.ButtonTemplate.MainActionButton,{text:"RESTART",onClicked:()=>{p.inject.events.trigger(l.UserActions.RestartLevel({levelId:p.inject.ui.session.levelId}))}}),this.rewindButton=e.button(d.ButtonTemplate.AlternativeActionButton,{text:"REWIND",icon:"ui/button-icons/rollback",onClicked:()=>{p.inject.events.trigger(l.UserActions.StartRewind())}}),this.replayButton=e.button(d.ButtonTemplate.AlternativeActionButton,{text:"VIEW REPLAY",onClicked:()=>{p.inject.events.trigger(l.UserActions.ViewReplay())}}),this.menuButton=e.button(d.ButtonTemplate.AlternativeActionButton,{text:"MENU",onClicked:()=>{this.continue()}}),this.ribbon=new o.Ribbon(this,o.RibbonTextures.Pergamen,0,0,400),this.ribbonText=new y(this,0,0,r.BitmapFont.Main,"Oh no! We have been defeated!").setTint(c.Colors.woodenUi.primaryText).setOrigin(.5,0),this.gravestone=this.createImage("gravestone"),this.background=new f(this),this.addAll([this.background,this.gravestone,this.menuButton,this.restartButton,this.rewindButton,this.replayButton,this.ribbon,this.ribbonText])}continue(){this.scene.isActive()&&p.inject.events.trigger(l.UserActions.GoToLevelDetail({levelId:p.inject.ui.session.levelId}))}createImage(e){return new m(this,0,0,"gameOverAtlas",e)}}t.DefeatScene=w},99431:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefeatScreen=void 0;const s=i(11930),n=i(54949),a=i(91025),o=i(35037),r=i(54173),c=i(85501),l=i(81363),d=i(88865),h=i(58592),u=i(84370),p=i(14917),g=i(60807);class m extends n.BaseScreen{constructor(){super("Defeat",[s.Scenes.WorldMap,s.Scenes.Defeat]),this.observe.event(a.UserActions.GoToLevelDetail,(({levelId:e})=>{d.inject.ui.session.end({origin:"defeat/return-to-menu"}),(0,r.returnToMenuFromGame)()})),this.observe.event(a.UserActions.Escape,(async()=>{d.inject.ui.session.end({origin:"defeat/return-to-menu"}),(0,r.returnToMenuFromGame)()})),this.observe.event(a.UserActions.RestartLevel,(({levelId:e})=>{d.inject.userData.clearLevelProgress(e),d.inject.events.trigger(a.UserActions.PlayLevel({levelId:e,origin:"defeat/restart"})),h.app.audio.playEffect(l.SoundEffects.Rewind)})),this.observe.event(a.UserActions.StartRewind,(()=>{h.app.navigator.goTo(h.app.screen.play,u.NewGameStateContext.Rewind),h.app.scene.play.setMode(new p.RewindMode(h.app.scene.play))})),this.observe.event(a.UserActions.ViewReplay,(()=>{g.track.interaction("view_replay"),h.app.navigator.goTo(h.app.screen.play,u.NewGameStateContext.ViewReplayAfterGameOver)}))}async activate(){h.app.scene.worldMap.setMode(new o.PreviewMode),h.app.scene.worldMap.cameraController.center(1e3)}async transitionOut(e){e===h.app.screen.levelDetail&&await(0,c.defeatToLevelDetailTransition)()}}t.DefeatScreen=m},85501:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defeatToLevelDetailTransition=void 0;const s=i(98723),n=i(88865),a=i(58592);t.defeatToLevelDetailTransition=async function(){a.app.scene.levelDetailUI;const e=n.inject.config.screenTransitionDuration,t=a.app.scene.defeat;return(0,s.playSceneToLevelDetailTransition)(),new Promise((i=>{t.tweens.add({targets:[t.menuButton,t.restartButton,t.rewindButton,t.replayButton],y:{to:"+=160"},alpha:{from:1,to:0},duration:e,onComplete:i}),t.tweens.add({targets:[t.background,t.ribbonText],alpha:{from:1,to:0},duration:e,ease:"Sine.easeInOut"}),t.tweens.add({targets:t.ribbon,x:{from:t.ribbon.x,to:t.ribbon.x+150},width:{from:400,to:100},alpha:{from:1,to:0},duration:e,ease:"Sine.easeInOut"}),t.tweens.add({targets:t.gravestone,y:{from:t.gravestone.y,to:t.gravestone.y+40},duration:e,scale:{from:1,to:.1},alpha:{from:1,to:0},ease:"Sine.easeInOut"})}))}},54737:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defeatTransition=void 0;const s=i(81363),n=i(88865),a=i(58592);t.defeatTransition=async function(){const e=a.app.scene.defeat;a.app.scene.playUI.activeUI.transitionOut(),a.app.audio.playEffect(s.SoundEffects.Defeat);const t=n.inject.config.screenTransitionDuration;await new Promise((i=>{e.preUpdate.force(),e.tweens.add({targets:[e.menuButton,e.restartButton,e.rewindButton,e.replayButton],y:{from:"+=160",to:"-=160"},alpha:{from:0,to:1},onComplete:i,duration:t,ease:"Sine.easeInOut"}),e.tweens.add({targets:[e.background,e.ribbonText],alpha:{from:0,to:1},duration:t,ease:"Sine.easeInOut"}),e.tweens.add({targets:e.ribbon,x:{from:e.ribbon.x+150,to:e.ribbon.x},width:{from:100,to:400},alpha:{from:.5,to:1},duration:t,ease:"Sine.easeInOut"}),e.tweens.add({targets:e.gravestone,y:{from:e.gravestone.y+40,to:e.gravestone.y},duration:t,scale:{from:.1,to:1},alpha:{from:0,to:1},ease:"Sine.easeInOut"})}))}},14219:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SideButton=t.SideButtonOrientation=t.LargeLevelCardContent=t.LargeLevelCard=void 0;const s=i(29528),n=i(70319),a=i(96465),o=i(24917),r=i(5715),c=i(4126),l=i(82369),d=i(40056),h=i(46453),u=i(48500),p=i(17120),g=i(68660),m=i(58592),y=i(1909),f=i(81363);var w=Phaser.GameObjects.BitmapText,v=Phaser.GameObjects.Image,b=Phaser.Geom.Rectangle;u.logger.for("LargeLevelCard");const S={icon:l.LevelIcons.NotStarted,title:"",author:null,subTitle:"",leftButton:null,rightButton:null};class x extends s.Card{constructor(e,t){super(e,{...t,content:void 0}),this.content=new T(e,this)}}t.LargeLevelCard=x;class T extends n.ResponsiveContainer{constructor(e,t,i){super(e),this.card=t,this._rightButtonHandler=null,this._leftButtonHandler=null,this.mapPreviewLoaded=!1,this.props=(0,d.StateContainer)(this,S),this._leftButton=new M(e,P.Left,this.card.radius,(()=>this._leftButtonHandler?.())),this._rightButton=new M(e,P.Right,this.card.radius,(()=>this._rightButtonHandler?.())),this._icon=new v(e,0,0,"atlas",l.LevelIcons.NotStarted).setOrigin(.5,.5),this._title=new w(e,0,0,o.BitmapFont.Main,"").setOrigin(0,0).setTint(r.Colors.glassUi.primaryText),this._subTitle=new w(e,0,0,o.BitmapFont.Mini,"").setOrigin(0,0).setTint(r.Colors.glassUi.primaryText),this._mainButtonText=new w(e,0,0,o.BitmapFont.Main,"?").setTint(r.Colors.woodenUi.primaryText).setLetterSpacing(1),this._mainButton=new a.BoxButton(e,0,0,{baseTexture:c.BoxTextures.DialogButton,downTexture:c.BoxTextures.DialogButtonDown,height:60,width:T.Layout.buttonsWidth,content:this._mainButtonText}),this._secondaryButtonText=new w(e,0,0,o.BitmapFont.Small,"?").setTint(r.Colors.woodenUi.primaryText),this._secondaryButton=new p.RibbonButton(e,0,0,{type:p.RibbonButtonStyle.Small,width:T.Layout.buttonsWidth,content:this._secondaryButtonText}),this._tapToPlayHint=new w(e,0,0,o.BitmapFont.Mini,"tap to play").setTint(r.Colors.glassUi.secondaryText).setOrigin(.5,0),this._author=new w(e,0,0,o.BitmapFont.Mini,"").setTint(r.Colors.glassUi.secondaryText).setAlpha(.5).setOrigin(1,1),this.add([this._leftButton,this._rightButton,this._icon,this._title,this._subTitle,this._mainButton,this._secondaryButton,this._tapToPlayHint,this._author]),this._mainButtonVisible=h.Control.visibilityOf(this._mainButton,{duration:300}).setTo(0),this._secondaryButtonVisible=h.Control.visibilityOf(this._secondaryButton,{duration:300}).setTo(0),i&&this.props.update(i)}applyState(e,t,i){if(void 0!==e.title&&e.title!==i.title&&this.setTitle(e.title),void 0!==e.icon&&e.icon!==i.icon&&this.setIcon(e.icon),void 0!==e.subTitle&&e.subTitle!==i.subTitle&&this.setSubtitle(e.subTitle),void 0!==e.primaryButton&&e.primaryButton!==i.primaryButton)if(e.primaryButton){const t=e.primaryButton;this.setMainButton(t.title,t.tooltip,t.onClick,t.visible)}else this.hideMainButton();if(void 0!==e.rightButton&&(this._rightButton.visible=!!e.rightButton,this._rightButtonHandler=e.rightButton),void 0!==e.leftButton&&(this._leftButton.visible=!!e.leftButton,this._leftButtonHandler=e.leftButton),void 0!==e.author&&(e.author?(this._author.setText("level by "+e.author),this._author.setVisible(!0)):this._author.setVisible(!1)),void 0!==e.secondaryButton&&e.secondaryButton!==i.secondaryButton)if(e.secondaryButton){const t=e.secondaryButton;this.setSecondaryButton(t.title,t.tooltip,t.onClick,t.visible)}else this.hideSecondaryButton()}setIcon(e){this._icon.setFrame(e).setOrigin(.5,.5),this.preUpdate.makeDirty()}setTitle(e){this._title.setText(e)}setSubtitle(e){this._subTitle.setText(e)}setMainButton(e,t,i,s){this._mainButtonText.setText(e),this._mainButton.onClicked.unsubscribeAll(),this._mainButton.onClicked(i),this._mainButtonVisible.transitionTo(s?1:0),this._mainButton.setData("tooltip",t),this.preUpdate.makeDirty()}setSecondaryButton(e,t,i,s){this._secondaryButtonText.setText(e),this._secondaryButton.onClicked.unsubscribeAll(),this._secondaryButton.onClicked(i),this._secondaryButton.setData("tooltip",t),this._secondaryButtonVisible.transitionTo(s?1:0),this.preUpdate.makeDirty()}hideMainButton(){this._mainButtonVisible.transitionTo(0),this.preUpdate.makeDirty()}hideSecondaryButton(){this._secondaryButtonVisible.transitionTo(0),this.preUpdate.makeDirty()}loadMapPreviewFromWorldMap(){this.mapPreview||(this.mapPreview=m.app.scene.levelDetailUI.mapPreviewPool.take(),this.add(this.mapPreview)),this.mapPreview.updateFromWorldMap(),this.mapPreviewLoaded=!0,this.preUpdate.makeDirty()}clearMapPreview(){this.mapPreviewLoaded=!1,this.mapPreview?.setVisible(!1)}updateLayout(){super.updateLayout();const e=m.app.device.uiVariant()===g.UiVariant.Compact,t=T.Layout,i=this.props().secondaryButton&&e?-16:0;e?(this._leftButton.setVisible(!1),this._rightButton.setVisible(!1)):(this._leftButton.setPosition(0,0),this._leftButton.setSize(t.sideButtonWidth,this.height-this.card.footerSize),this._rightButton.setPosition(this.width-this._rightButton.width,0),this._rightButton.setSize(t.sideButtonWidth,this.height-this.card.footerSize));const n=t.padding,a=this.height-this.card.footerSize+t.padding,o=this._title.height+(this._subTitle.text?this._subTitle.height+t.textSpacing:0),r=(this.props().primaryButton?this._mainButton.height:0)+(this.props().secondaryButton?this._secondaryButton.height:0)+(this.props().primaryButton&&this.props().secondaryButton?t.buttonSpacing:0);this._icon.setPosition(n+t.iconOffsetFromLeft,this.height-this.card.footerSize/2+i),this._title.setPosition(n+t.titleOffsetFromLeft,a+i+(this.card.footerSize-o-2*t.padding)/2),this._subTitle.setPosition(this._title.x,this._title.y+this._title.height+t.textSpacing);let c=a+(this.card.footerSize-r-2*t.padding)/2;if(this._mainButton.setPosition(this.width-this._mainButton.width-t.padding-t.buttonsOffsetFromRight,c),this._mainButton.setVisible(m.app.device.uiVariant()===g.UiVariant.Large),this._tapToPlayHint.setPosition(this.width/2,this.height-this.card.footerSize-30),this._author.setPosition(this.card.width-t.padding,this.height-this.card.footerSize-t.padding),e){this._secondaryButton.setPosition(this.width/2-this._secondaryButton.width/2,this.height-14-this._secondaryButton.height),this._tapToPlayHint.setVisible(this.card.clickable!==s.CardPointerInputMode.NotClickable);const e=m.app.device.isUsingTouch()?"tap":"click";this._tapToPlayHint.setText(e+" to "+(this.props().primaryButton?.title.toLowerCase()??"play"))}else this._tapToPlayHint.setVisible(!1),this.props().primaryButton?.visible?this._secondaryButton.setPosition(this._mainButton.x,this._mainButton.y+this._mainButton.height+t.buttonSpacing):this._secondaryButton.setPosition(this.width-this._secondaryButton.width-t.padding-t.buttonsOffsetFromRight,c);const l=new b(0,0,this.card.width,this.card.height-this.card.footerSize);if(this.mapPreviewLoaded&&this.mapPreview){const e=b.FromXY(l.x,l.y,l.x+this.mapPreview.width,l.y+this.mapPreview.height);b.FitInside(e,l),this.mapPreview.visible?(this.mapPreview.setVisible(!0),this.mapPreview.setAlpha(1)):(this.mapPreview.setVisible(!0),this.mapPreview.setAlpha(0),this.scene.tweens.add({targets:this.mapPreview,props:{alpha:{start:0,to:1}},duration:300}));let t=e.width/this.mapPreview.width;t>1?(this.mapPreview.setScale(1),this.mapPreview.setPosition(l.centerX-this.mapPreview.width/2,l.centerY-this.mapPreview.height/2)):(this.mapPreview.setScale(t),this.mapPreview.setPosition(e.x,e.y))}}}var P;t.LargeLevelCardContent=T,T.Layout={padding:10,buttonsOffsetFromRight:20,buttonsWidth:200,titleOffsetFromLeft:80,iconOffsetFromLeft:40,buttonSpacing:4,textSpacing:8,sideButtonWidth:80},function(e){e[e.Left=0]="Left",e[e.Right=1]="Right"}(P=t.SideButtonOrientation||(t.SideButtonOrientation={}));class M extends n.ResponsiveContainer{constructor(e,t,i,s){super(e),this.orientation=t,this.radius=i,this.onClick=s,this.ui=y.UiBuilder.for(this.scene),this.background=this.ui.roundedRect(0,r.Colors.glassUi.shapeLightAccent),this.icon=this.ui.image("ui/big-glass-arrow"),t===P.Left&&this.icon.setFlipX(!0),this.background.setVisible(!1),this.add([this.background,this.icon]),this.setInteractiveAuto(),this.on("pointermove",(()=>{this.background.setVisible(!0)})),this.on("pointerout",(()=>{this.background.setVisible(!1)})),this.on("pointerdown",(()=>{m.app.audio.playEffect(f.SoundEffects.ButtonUp)})),this.on("pointerup",(()=>{this.onClick()}))}updateLayout(){switch(this.background.setSize(this.width,this.height),this.background.setPosition(0,0),this.orientation){case P.Right:this.background.radius={tl:0,tr:this.radius,br:0,bl:0};break;case P.Left:this.background.radius={tl:this.radius,tr:0,br:0,bl:0}}this.icon.setPosition(this.width/2,this.height/2)}}t.SideButton=M},16310:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelDetailScreen=t.DEFAULT_LIVES_PER_LEVEL=void 0;const s=i(54949),n=i(11930),a=i(91025),o=i(63103),r=i(35037),c=i(11041),l=i(56952),d=i(88865),h=i(58592),u=i(39835);t.DEFAULT_LIVES_PER_LEVEL=3;class p extends s.BaseScreen{constructor(){super("LevelDetail",[n.Scenes.WorldMap,n.Scenes.LevelDetailUI,n.Scenes.MenuHeaderUI]),this.lockOrientation=!0,this.observe.event(a.UserActions.GoBack,(()=>{h.app.navigator.goTo(h.app.screen.levelSelect)})),this.observe.event(a.UserActions.Escape,(async()=>{d.inject.events.trigger(a.UserActions.GoBack())})),this.observe.event(a.UserActions.PreviewLevel,(({levelId:e})=>{h.app.scene.levelDetailUI.scrollToLevel(e)})),this.observe.event(a.SystemEvents.UserDataLoaded,(()=>{h.app.scene.levelDetailUI.clearCards()})),this.observe.event(a.UserActions.AbandonLevelProgress,(async({levelId:e})=>{!function(e){switch(e){case c.LevelStatus.InProgress:return"Are you sure? Your progress in this level will be lost!";case c.LevelStatus.Replaying:;}}(c.LevelModel.for(e).getLevelStatus()),await h.app.modals.confirmAbandonLevel()===l.DialogButtons.GiveUp&&(d.inject.userData.clearLevelProgress(e,"campaign/abandon"),await this.loadLevel(e),h.app.scene.levelDetailUI.refreshLevelCard(e))})),this.observe.event(a.UserActions.RestartLevel,(async({levelId:e})=>{await h.app.modals.confirmRestart()===l.DialogButtons.Restart&&(d.inject.userData.clearLevelProgress(e,"campaign/restart"),d.inject.events.trigger(a.UserActions.PlayLevel({levelId:e,origin:"campaign/restart"})))}))}async activate(e,t){u.NewsBox.hide(),d.inject.ui.withoutTransitions((()=>{h.app.scene.worldMap.setMode(new r.PreviewMode)})),h.app.scene.worldMap.scene.setVisible(!1),await this.loadLevel(d.inject.ui.selectedLevelId())}deactivate(){h.app.scene.worldMap.scene.setVisible(!0)}async transitionOut(e){if(e===h.app.screen.play)return(0,o.levelDetailToPlaySceneTransition)()}async loadLevel(e){const t=c.LevelModel.for(e);h.app.scene.menuHeaderUI.state.update({title:t.parentCampaign?.name??"Custom map",backButtonTitle:"OVERVIEW"}),h.app.scene.levelDetailUI.state.update({campaignId:t.parentCampaign?.id,levels:t.parentCampaign?.levels.map((e=>e.id))}),h.app.scene.levelDetailUI.goToLevelIndex(t.campaignContext?.indexInCampaign??0)}}t.LevelDetailScreen=p},300:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getLevelCardProps=t.LevelDetailUIScene=void 0;const s=i(11930),n=i(97866),a=i(91025),o=i(68736),r=i(82369),c=i(48500),l=i(40056),d=i(9859),h=i(54812),u=i(11041),p=i(14219),g=i(91539),m=i(12678),y=i(54941),f=i(96737),w=i(5893),v=i(65337),b=i(35037),S=i(84370),x=i(29528),T=i(82260),P=i(81363),M=i(10298),I=i(88865),A=i(58592),C=i(51209);var B=Phaser.Geom.Rectangle;const E=i(30093),R=c.logger.for("LevelDetailUIScene"),O={campaignId:"",levels:[]};class _ extends o.BaseUIScene{constructor(){super({key:s.Scenes.LevelDetailUI,bounds:C.BOUNDS.Main}),this.cards=[],this.mapPreviewLoader=new g.AsyncJobQueue(this._loadMapPreview.bind(this)),this.state=(0,l.StateContainer)(this,O),this.currentLevelIndex=-1,this.mapPreviewPool=new w.Pool((()=>new f.MapPreview(this,this.layout.tileWidth,this.layout.tileHeight))),this.preUpdate=(0,n.whenDirty)((()=>{this.calculateLayout();const{tileWidth:e,tileHeight:t,tileLeft:i,cardWidth:s,cardHeight:n,cardTop:a,cardLeft:o}=this.layout;this.updateCardsInView();for(let e=0;e<this.state().levels.length;++e)this.cards[e]&&(this.cards[e].setPosition(o(e),a),this.cards[e].setSize(s,n),this.cards[e].setAlpha(1));this.scrollController.cameraX.setTo(this.getCameraXByCardIndex(this.currentLevelIndex))}))}create(){super.create();const e=this;this.mapPreviewLoader.pause(),this.scrollController=new d.ScrollableViewController(this.cameras.main,{horizontal:!0,vertical:!1,continueToNextStopThreshold:1e3,maxSpeed:3e3,horizontalStops:{getNextFrom(t){let i=e.getCardIndexByCameraX(t);return t>e.getCameraXByCardIndex(i)&&i<e.state().levels.length-1&&(i+=1),e.getCameraXByCardIndex(i)},getPreviousFrom(t){let i=e.getCardIndexByCameraX(t);return t<e.getCameraXByCardIndex(i)&&i>0&&(i-=1),e.getCameraXByCardIndex(i)}}}),this.calculateLayout(),this.observe.watch(I.inject.ui.scale,(()=>this.calculateLayout())),this.bindKey(T.Input.Keyboard.KeyCodes.ESC,a.UserActions.GoBack)}clearCards(){for(let e of this.cards)e?.destroy();this.cards.length=0,this.preUpdate.makeDirty()}calculateLayout(){const e={cardSpacing:30,tiles:{padding:40,offsetFromTop:M.MenuHeaderUIScene.Layout.panelHeight,offsetFromBottom:20},cards:{radius:40,minVisibleSizeTODO:40,footerSize:120}},t={...e,tileTop:e.tiles.offsetFromTop,tileWidth:this.bounds.contentWidth,tileHeight:this.bounds.height-e.tiles.offsetFromBottom-e.tiles.offsetFromTop},i={...t,tileLeft:e=>e*t.tileWidth,cardWidth:t.tileWidth-2*t.tiles.padding,cardHeight:t.tileHeight-2*t.tiles.padding,cardTop:t.tiles.offsetFromTop+t.tiles.padding,cardLeft:e=>e*t.tileWidth+t.tiles.padding};this.layout={...i,mapPreview:{top:i.cardTop,left:e=>i.cardLeft(e),width:i.cardWidth,height:i.cardHeight-i.cards.footerSize}}}refreshLevelCard(e){const t=this.state().levels.indexOf(e);if(-1===t)return void R.warning(`level ${e} does not exist in the current state, ignoring request to refresh map preview`);const i=this.cards[t];i&&(i.content.clearMapPreview(),this.mapPreviewLoader.addJob(e))}goToLevelIndex(e){this._setCurrentLevelIndex(e),this.scrollController.cameraX.setTo(this.getCameraXByCardIndex(this.currentLevelIndex)),I.inject.ui.withoutTransitions((()=>{this.updateCardsInView()})),this.preUpdate.makeDirty()}_setCurrentLevelIndex(e){this.currentLevelIndex=e;const t=this.state().levels[e];I.inject.ui.selectedLevelId.set(t)}get centralCard(){return this.cards[this.currentLevelIndex]}get leftCard(){const e=this.currentLevelIndex-1;if(-1!==e)return this.cards[e]}get rightCard(){const e=this.currentLevelIndex+1;if(!(e>=this.state().levels.length))return this.cards[e]}getCardIndexByCameraX(e,t=0){const i=Math.floor((e+this.bounds.contentLeft)/this.layout.tileWidth+t+.5),s=this.state().levels.length-1;return(0,h.cropNumber)(i,0,s)}getCameraXByCardIndex(e){return e*this.layout.tileWidth-this.bounds.contentLeft}getCardRectForIndex(e){const{tileWidth:t,tileHeight:i,cardWidth:s,cardHeight:n}=this.layout,a=this.layout,o=e*t+a.tiles.padding,r=a.tiles.offsetFromTop+a.tiles.padding;return B.FromXY(o,r,o+s,r+n)}applyState(e,t,i){e.campaignId&&e.campaignId!==i.campaignId&&(this.cards.forEach((e=>e.destroy())),this.cards=[],this.mapPreviewPool.freeAll(),this.mapPreviewLoader.clear()),e.levels&&this.updateCardsInView()}updateCardsInView(){this.createOrUpdateCard(this.currentLevelIndex-1),this.createOrUpdateCard(this.currentLevelIndex),this.createOrUpdateCard(this.currentLevelIndex+1)}createOrUpdateCard(e){if(e<0||e>=this.state().levels.length)return;const t=this.state().levels[e];if(!this.cards[e]){const i=new p.LargeLevelCard(this,{radius:this.layout.cards.radius,footerSize:this.layout.cards.footerSize,clickable:x.CardPointerInputMode.WithoutFooter,onClick:()=>{if(!this.scrollController.dragging)if(this.currentLevelIndex===e){A.app.audio.playEffect(P.SoundEffects.ButtonUp);const e=u.LevelModel.for(t);I.inject.events.trigger(a.UserActions.PlayLevel({levelId:t,origin:e.getLevelStatus()===u.LevelStatus.InProgress?"campaign/continue":"campaign/play"}))}else{const i=this.getCameraXByCardIndex(e);this.scrollController.cameraX.targetStop!==i&&(A.app.audio.playEffect(P.SoundEffects.ButtonUp),this.scrollToLevel(t))}}});this.cards[e]=i,i.setPosition(this.layout.cardLeft(e),this.layout.cardTop),i.setSize(this.layout.cardWidth,this.layout.cardHeight),this.add.existing(i),this.mapPreviewLoader.addJob(t)}const i=u.LevelModel.for(t),s=this.currentLevelIndex===e,n=s&&0!==e?()=>this.scrollToLevelIndex(e-1):null,o=s&&e!==this.state().levels.length-1?()=>this.scrollToLevelIndex(e+1):null,r=H(this,{title:`${i.getTitle(u.LevelTitleStyle.Full)}`,levelId:t,buttonsVisible:s,goRight:o,goLeft:n});this.cards[e].content?.props.update(r),this.cards[e].setClickable(this.getCardInputMode(i.getLevelStatus(),e))}update(){const e=this.getCardIndexByCameraX(this.scrollController.cameraX.value);e!==this.currentLevelIndex&&this.scrollController.cameraX.phase!==v.KineticValuePhase.Stable&&(this._setCurrentLevelIndex(e),this.updateCardsInView()),this.scrollController.cameraX.phase!==v.KineticValuePhase.Stable||A.app.scene.worldMap.scene.isVisible()?this.mapPreviewLoader.pause():this.mapPreviewLoader.resume()}async _loadMapPreview(e){const t=y.timing.start(`loadMapPreview ${e}`),i=u.LevelModel.for(e);if(i.parentCampaign?.id!==this.state().campaignId)return;const s=i.campaignContext?.indexInCampaign;m.assert.defined(s);const n=this.cards[s];if(n.content.mapPreviewLoaded)return;const a=await i.getCurrentState();m.assert.defined(a,`Failed to load level ${i.id}`),m.assert.defined(n),I.inject.ui.withoutTransitions((()=>{I.inject.gameStateController.loadState(a,S.NewGameStateContext.Preview),A.app.scene.worldMap.setMode(new b.PreviewMode),A.app.scene.worldMap.syncState(I.inject.currentGameState,E.OverlayModes.disabled),A.app.scene.worldMap.chunksRenderingController.renderEverything(),n.content.loadMapPreviewFromWorldMap()})),t.complete()}scrollToLevel(e){const t=this.state().levels.indexOf(e);if(-1===t)throw new Error(`Unable to scroll to level "${e}" - no such level found in the current state`);this.scrollToLevelIndex(t)}scrollToLevelIndex(e){const t=this.getCameraXByCardIndex(e);this.scrollController.cameraX.pushTo(t)}getCardInputMode(e,t){return t!==this.currentLevelIndex||e===u.LevelStatus.InProgress||e===u.LevelStatus.NotStarted||e===u.LevelStatus.Replaying||e===u.LevelStatus.Defeated?x.CardPointerInputMode.WithoutFooter:x.CardPointerInputMode.NotClickable}}function H(e,{title:t,levelId:i,buttonsVisible:s,goLeft:n,goRight:o}){const c=u.LevelModel.for(i);function l(t,i,n){return{title:t,tooltip:i,onClick:()=>{e.scrollController.dragging||I.inject.events.trigger(n)},visible:s}}const d={title:t,leftButton:n,rightButton:o,author:c.getAuthor()};switch(c.getLevelStatus()){case u.LevelStatus.InProgress:return{...d,icon:r.LevelIcons.Fighting,primaryButton:l("CONTINUE","Continue the game where you left off.",a.UserActions.PlayLevel({levelId:i,origin:"campaign/continue"})),secondaryButton:l("RESTART","Abandon the current attempt and start from scratch.",a.UserActions.RestartLevel({levelId:i})),subTitle:`Turn ${c?.userData?.inProgress?.turnNumber??"?"}`};case u.LevelStatus.Completed:const e=c.getNextLevelToPlay();return{...d,icon:r.LevelIcons.Gold,primaryButton:e?l("NEXT","Go to the next unconquered island",a.UserActions.PreviewLevel({levelId:e})):null,secondaryButton:l("PLAY AGAIN","Play this island again (don't worry, this won't erase your victory)",a.UserActions.PlayLevel({levelId:i,origin:"campaign/play-again"})),subTitle:`You won in ${c?.userData?.won?.turns??"unknown number of"} turns!`};case u.LevelStatus.Defeated:return{...d,icon:r.LevelIcons.Defeated,primaryButton:l("TRY AGAIN","Restart this island.",a.UserActions.PlayLevel({levelId:i,origin:"campaign/try-again"})),secondaryButton:null,subTitle:"They will pay for this!"};case u.LevelStatus.NotStarted:return{...d,icon:r.LevelIcons.NotStarted,primaryButton:l("PLAY","Play this island.",a.UserActions.PlayLevel({levelId:i,origin:"campaign/play"})),secondaryButton:null,subTitle:""};case u.LevelStatus.Replaying:return{...d,icon:r.LevelIcons.Gold,primaryButton:l("CONTINUE","Continue the game where you left off.",a.UserActions.PlayLevel({levelId:i,origin:"campaign/continue"})),secondaryButton:l("GIVE UP","Abandon the current attempt and restore\n the island to the previous victory state.",a.UserActions.AbandonLevelProgress({levelId:i})),subTitle:`Turn ${c.userData?.inProgress?.turnNumber}. (Won in ${c.userData?.won?.turns} turns before)`};default:throw new Error(`requested level card props for locked level ${i} which has status ${c.getLevelStatus()} - this is not supported!`)}}t.LevelDetailUIScene=_,t.getLevelCardProps=H},96737:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapPreview=void 0;const s=i(48500),n=i(88865),a=i(58592);var o=Phaser.GameObjects.RenderTexture;s.logger.for("MapPreview"),t.MapPreview=class extends o{constructor(e,t=200,i=200){super(e,0,0,t,i),this.setOrigin(0,0)}updateFromWorldMap(){const e=a.app.scene.worldMap.cameraController.worldBounds,t=e.width,i=e.height;a.app.scene.worldMap.children.depthSort(),this.resize(t,i),this.clear(),this.camera.setScroll(e.x,e.y);const s=a.app.scene.worldMap.children;n.inject.ui.withoutTransitions((()=>{a.app.scene.worldMap.lodManager.apply(.5,!0)})),this.draw(s),n.inject.config.debug.overlay}}},9859:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScrollableViewController=void 0;const s=i(42526),n=i(48500),a=i(65337),o=i(88865);n.logger.for("ScrollableViewController"),t.ScrollableViewController=class{constructor(e,t={}){this.camera=e,this.dragging=!1,this.deadzone=20,this.dragMomentumX=0,this.dragMomentumY=0,this.drag=3e3,this.dragStartPosition=void 0,this.enableX=!0,this.enableY=!0,this.scene=this.camera.scene,this.cameraY=new a.KineticValue(e.scrollX,{drag:this.drag,scene:this.scene,maxSpeed:t.maxSpeed,apply:e=>this.camera.scrollY=e,continueToNextStopThreshold:t.continueToNextStopThreshold,stops:t.verticalStops}),this.cameraX=new a.KineticValue(0,{drag:this.drag,scene:this.scene,maxSpeed:t.maxSpeed,apply:e=>{this.camera.scrollX=e},continueToNextStopThreshold:t.continueToNextStopThreshold,stops:t.horizontalStops}),t.drag&&(this.drag=t.drag),!1===t.vertical&&(this.enableY=!1),!1===t.horizontal&&(this.enableX=!1),void 0!==t.deadzone&&(this.deadzone=t.deadzone),this.pointer=this.scene.input.activePointer,this.scene.input.on("pointerdown",this.handlePointerDown,this),this.scene.input.on("pointermove",this.handlePointerMove,this),this.scene.input.on("pointerup",this.handlePointerUp,this),this.scene.input.on("wheel",((e,t,i,s,n)=>{let a=5*s;this.enableY?(this.cameraY.accelerate(a),Math.abs(this.cameraY.speed)<this.cameraY.continueToNextStopThreshold&&(this.cameraY.speed>0?this.cameraY.pushToNextStop():this.cameraY.pushToPrevStop())):(this.cameraX.accelerate(a),Math.abs(this.cameraX.speed)<this.cameraX.continueToNextStopThreshold&&(this.cameraX.speed>0?this.cameraX.pushToNextStop():this.cameraX.pushToPrevStop()))}),this),this.scene.events.on("update",this.update,this)}detach(){this.scene.input.removeListener("pointermove",this.handlePointerMove),this.scene.input.removeListener("update",this.update)}update(e,t){this.dragMomentumX*=.8,this.dragMomentumY*=.8,this.enableX&&this.cameraX.update(e,t),this.enableY&&this.cameraY.update(e,t),o.inject.debugData.set("SCROLL",`${this.cameraX.value.toFixed(0)} ${this.cameraY.value.toFixed(0)}`)}startDrag(){this.dragging=!0,this.dragCursorIconOn(),this.cameraX.freeze(),this.cameraY.freeze()}stopDrag(){if(!this.dragging)return 0;this.dragging=!1,this.cameraX.unfreeze(),this.cameraY.unfreeze(),this.cameraX.accelerate(this.dragMomentumX),this.cameraY.accelerate(this.dragMomentumY),this.dragCursorIconOff()}async panTo(e,t,i=0){const s=e-this.camera.width/2,n=t-this.camera.height/2;0===i?(this.enableX&&this.cameraX.setTo(s),this.enableY&&this.cameraY.setTo(n)):await Promise.all([this.enableX&&this.cameraX.tweenTo(s,i,"Sine.easeInOut"),this.enableY&&this.cameraY.tweenTo(n,i,"Sine.easeInOut")])}dragCursorIconOn(){this.scene.game.canvas.style.cursor="grabbing"}dragCursorIconOff(){this.scene.game.canvas.style.cursor="default"}handlePointerMove(e){if(this.dragging){if(!e.isDown)return this.cameraX.unfreeze(),this.cameraY.unfreeze(),void this.stopDrag();const t=e.position.x-e.prevPosition.x,i=e.position.y-e.prevPosition.y;this.dragMomentumX-=10*t,this.dragMomentumY-=10*i,this.enableX&&this.cameraX.setTo(this.cameraX.value-t/this.camera.zoom),this.enableY&&this.cameraY.setTo(this.cameraY.value-i/this.camera.zoom)}else this.dragStartPosition&&e.isDown&&(0,s.euclidDistance)(this.dragStartPosition,{x:this.pointer.x,y:this.pointer.y})>this.deadzone&&this.startDrag()}handlePointerDown(e){this.dragStartPosition={...e.position}}handlePointerUp(){this.dragStartPosition=void 0,this.stopDrag()}setBounds(e){this.camera.width,this.camera.height}}},63103:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.levelDetailToPlaySceneTransition=void 0;const s=i(88865),n=i(58592);t.levelDetailToPlaySceneTransition=async function(){const e=n.app.scene.levelDetailUI,t=n.app.scene.menuHeaderUI,i=s.inject.config.screenTransitionDuration,a=n.app.scene.worldMap,o=e.centralCard.content.mapPreview;return o?.setVisible(!1),a.cameraController.zoomController.cameraDistance.setTo(1/(o?.scale??1)/e.cameras.main.zoom),a.cameraController.center(1e3,1),new Promise((s=>{e.tweens.add({targets:[e.centralCard],props:{alpha:0},duration:i,onComplete:s}),e.cameras.main.preRender(),e.leftCard&&e.tweens.add({targets:e.leftCard,props:{x:e.cameras.main.scrollX-e.layout.cardWidth-10},duration:i,ease:"Sine.easeOut"}),e.rightCard&&e.tweens.add({targets:e.rightCard,props:{x:e.cameras.main.scrollX+e.cameras.main.worldView.width+10},duration:i,ease:"Sine.easeOut"}),t.slideOut()})).then((()=>{o?.setVisible(!0)}))}},98723:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playSceneToLevelDetailTransition=t.precalculateMapPreviewScale=void 0;const s=i(88865),n=i(58592);var a=Phaser.Geom.Rectangle;function o(){const e=n.app.scene.levelDetailUI.layout.mapPreview,t=n.app.scene.worldMap.cameraController.worldBounds,i=new a(0,0,e.width,e.height),o=new a(0,0,t.width,t.height);return a.FitInside(o,i),Math.min(1,o.width/t.width*s.inject.ui.scale())}t.precalculateMapPreviewScale=o,t.playSceneToLevelDetailTransition=function(){n.app.scene.playUI.activeUI.transitionOut();const e=n.app.scene.levelDetailUI,t=n.app.scene.menuHeaderUI,i=s.inject.config.screenTransitionDuration,a=n.app.scene.worldMap;return a.scene.setVisible(!0),e.mapPreviewLoader.pause(),e.updateCardsInView(),e.centralCard.content.mapPreview?.setVisible(!1),new Promise((s=>{e.preUpdate.makeDirty(),e.preUpdate();const n=o();a.cameraController.center(i,1/n),e.tweens.add({targets:[e.centralCard],props:{alpha:{from:0,to:1}},duration:i,onComplete:s}),e.leftCard&&e.tweens.add({targets:e.leftCard,props:{x:{from:e.scrollController.cameraX.value-e.layout.cardWidth-10,to:e.leftCard.x}},duration:i,ease:"Sine.easeOut"}),e.rightCard&&e.tweens.add({targets:e.rightCard,props:{x:{from:e.scrollController.cameraX.value+e.bounds.width+10,to:e.rightCard.x}},duration:i,ease:"Sine.easeOut"}),t.slideIn()})).then((()=>{a.chunksRenderingController.renderEverything(),e.centralCard.content.loadMapPreviewFromWorldMap(),a.scene.setVisible(!1),e.centralCard.content.mapPreview?.setVisible(!0)}))}},60234:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelSelectScreen=void 0;const s=i(54949),n=i(11930),a=i(91025),o=i(21672),r=i(60231),c=i(88865),l=i(58592),d=i(11041);class h extends s.BaseScreen{constructor(){super("LevelSelect",[n.Scenes.LevelSelectUI,n.Scenes.MenuHeaderUI]),this.lockOrientation=!0,this.observe.event(a.UserActions.GoBack,(()=>{l.app.navigator.goTo(l.app.screen.title)})),this.observe.event(a.UserActions.GoToLevelDetail,(async({levelId:e})=>{c.inject.ui.selectedLevelId.set(e),l.app.navigator.goTo(l.app.screen.levelDetail)})),this.observe.event(a.SystemEvents.UserDataLoaded,(()=>{this.activate()})),this.observe.event(a.UserActions.Escape,(async()=>{c.inject.events.trigger(a.UserActions.GoBack())}))}async transitionOut(e){switch(e){case l.app.screen.title:return(0,o.levelSelectOutTransition)();case l.app.screen.levelDetail:const e=d.LevelModel.for(c.inject.ui.selectedLevelId()).campaignContext?.indexInCampaign??0;return(0,r.transitionToLevelDetail)(e)}}async activate(e,t){await super.activate(e,t),c.inject.ui.selectedCampaign()||c.inject.ui.selectedCampaign.set(d.LevelModel.for(c.inject.ui.selectedLevelId()).campaignContext?.campaign);const i=c.inject.ui.selectedCampaign();i&&(l.app.scene.menuHeaderUI.state.update({icon:"ui/icons/campaign",title:i.name,backButtonTitle:"MAIN MENU"}),l.app.scene.levelSelectUI.loadCampaign(i))}}t.LevelSelectScreen=h},19132:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SmallLevelCardContent=t.SmallLevelCard=t.LevelSelectUIScene=void 0;const s=i(11930),n=i(97866),a=i(99694),o=i(91025),r=i(5715),c=i(82260),l=i(24917),d=i(68736),h=i(70319),u=i(82369),p=i(9859),g=i(10298),m=i(7656),y=i(23441),f=i(81363),w=i(88865),v=i(58592);var b=Phaser.GameObjects.BitmapText,S=Phaser.GameObjects.Image;const x=i(1909),T=i(97569),P=i(12162);var M=Phaser.Geom.Rectangle;const I=100;class A extends d.BaseUIScene{get maxScrollY(){const e=this.levelCards[this.levelCards.length-1];return e?(0,y.pickLarger)(0,e.y+e.height+m.Padding.large-this.bounds.height):0}constructor(){super({key:s.Scenes.LevelSelectUI}),this.levelCards=[],this.preUpdate=(0,n.whenDirty)((()=>{const e=m.Padding.large,t=m.Padding.large,i=Math.floor((this.bounds.contentWidth-e)/(I+t)),s=Math.ceil(this.levelCards.length/i);for(let n=0;n<s;++n){const s=this.levelCards.slice(n*i,(n+1)*i);a.Arrange.leftToRight({content:s.map((e=>({object:e}))),spacing:t,x:this.bounds.centerX,origin:.5}),a.Arrange.alignY(s,{y:g.MenuHeaderUIScene.Layout.panelHeight+e+n*(I+t),origin:0})}}))}create(){super.create(),this.scrollController=new p.ScrollableViewController(this.cameras.main,{horizontal:!1,vertical:!0,deadzone:50,maxSpeed:1e3,continueToNextStopThreshold:1e3,verticalStops:{getNextFrom:e=>e<0?0:void 0,getPreviousFrom:e=>e>this.maxScrollY?this.maxScrollY:void 0}}),this.bindKey(c.Input.Keyboard.KeyCodes.ESC,o.UserActions.GoBack)}loadCampaign(e){for(let e of this.levelCards)e.destroy();this.levelCards.forEach((e=>e.destroy(!0))),this.levelCards=e.levels.map(((e,t)=>new C(this,{icon:(0,u.getLevelIcon)(e.id),title:(t+1).toString(),isNew:e.isNew,onClick:async()=>{this.scrollController.dragging||(v.app.audio.playEffect(f.SoundEffects.ButtonUp),w.inject.events.trigger(o.UserActions.GoToLevelDetail({levelId:e.id})))}}))),this.addAll(this.levelCards),this.preUpdate.makeDirty()}}t.LevelSelectUIScene=A,A.Layout={cardSpacing:30};class C extends h.BaseResponsiveContainer{constructor(e,t){super(e),this._buttonState=T.ButtonState.Rest;const i=x.UiBuilder.for(e);this.face=i.image("ui/level-buttons/face"),this.background=i.image("ui/level-buttons/shadow"),this.content=new B(e,t.icon,t.title),this.content.setSize(I,I),this.face.setPosition(0,0),this.background.setPosition(6,6),a.Arrange.alignY([this.content],{y:0}),a.Arrange.alignX([this.content],{x:0}),this.setSize(I,I),this.add([this.background,this.face,this.content]),this._onClick=t.onClick;const s=new P.SimpleButtonStateController({audio:!1});s.bindTo(this,(e=>{this._buttonState=e,this.preUpdate.makeDirty()})),s.onClicked(t.onClick),this.add([this.background,this.face,this.content]),t.isNew&&(this.sticker=i.image("ui/new-level-sticker"),this.add(this.sticker))}updateLayout(){const e=this._buttonState===T.ButtonState.Down?2:0;this.input?.hitArea?this.input.hitArea.setTo(this.width/2,this.height/2,this.width,this.height):this.setInteractive({hitArea:new M(this.width/2,this.height/2,this.width,this.height),hitAreaCallback:M.Contains,cursor:"pointer"}),this.input.enabled=!0,this.face.setPosition(e,e),this.content.setPosition(e,e),this.content.setSize(this.width,this.height),this._buttonState===T.ButtonState.Down||this._buttonState==T.ButtonState.Hover?this.face.setFrame("ui/level-buttons/face-hover"):this.face.setFrame("ui/level-buttons/face"),this.sticker&&this.sticker.setPosition(this.width+e,e).setOrigin(1,0)}}t.SmallLevelCard=C,C.Layout={shadowDepth:4};class B extends h.ResponsiveContainer{constructor(e,t,i){super(e),this._icon=new S(e,0,0,"atlas",t).setOrigin(.5,.5),this._text=new b(e,0,0,l.BitmapFont.Main,i).setOrigin(.5,0).setTint(r.Colors.glassUi.primaryText),this.add([this._icon,this._text])}setIcon(e){this._icon.setFrame(e),this.preUpdate.makeDirty()}setText(e){this._text.setText(e),this.preUpdate.makeDirty()}updateLayout(){super.updateLayout(),this._icon.setPosition(this.width/2,(this.height-32)/2),this._text.setPosition(this.width/2,this.height-this._text.height-4)}}t.SmallLevelCardContent=B},21672:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.levelSelectOutTransition=void 0;const s=i(88865),n=i(58592);t.levelSelectOutTransition=async function(){const e=n.app.scene.levelSelectUI,t=s.inject.config.screenTransitionDuration;await new Promise((i=>{e.tweens.add({targets:e.levelCards,y:"+="+n.app.device.screenHeight,delay:(i,s,n,a)=>(e.levelCards.length-a)*(t/100),duration:t,ease:"Sine.easeIn",onComplete:i})}))}},60231:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.transitionToLevelDetail=void 0;const s=i(12678),n=i(88865),a=i(58592);t.transitionToLevelDetail=function(e=0){e<0&&(console.warn(`invalid cardIndex ${e}, replacing with 0`),e=0);const t=a.app.scene.levelSelectUI,i=a.app.scene.levelDetailUI,o=a.app.scene.worldMap,r=n.inject.config.screenTransitionDuration;return o.scene.setVisible(!1),i.preUpdate.force(),new Promise((n=>{const o=t.levelCards[e];(0,s.assert)(o,`targetCard not found for index ${e}`);let c=[],l=[],d=[],h=[];for(let i=0;i<t.levelCards.length;++i){const s=t.levelCards[i];s.y<o.y?c.push(s):s.y>o.y?l.push(s):i<e?d.push(s):i>e&&h.push(s)}i.centralCard?.setVisible(!1),i.leftCard?.setVisible(!1),i.rightCard?.setVisible(!1),t.tweens.add({targets:[...c,...d],y:"-="+o.y,duration:r,ease:"Sine.easeOut",onComplete:n}),t.tweens.add({targets:[...l,...h],y:"+="+(a.app.device.screenHeight-o.y),duration:r,ease:"Sine.easeOut"})})).then((()=>{i.leftCard?.setVisible(!0),i.centralCard?.setVisible(!0),i.rightCard?.setVisible(!0),i.preUpdate.force()}))}},40667:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EDITOR_TOOL=void 0;const s=i(23280),n=i(84304),a=i(44084),o=i(91564),r=i(92476),c=i(59650),l=i(82450),d=i(68950);t.EDITOR_TOOL={deleteTile:new s.DeleteTileTool,paintRegion:[1,2,3,4,5,6].map((e=>new n.PaintRegionTool(e))),paintSoldier:new a.PaintSoldierTool,paintTown:new o.PaintTownTool,paintForest:new l.PaintForestTool,paintCastle:new c.PaintCastleTool,addCoins:new r.CoinsTool,addChest:new d.AddChestTool}},2008:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorPalette=void 0;const s=i(82260),n=i(32466),a=i(40667),o=i(23979),r=i(88865);class c extends n.Palette{constructor(e,t){const i=new Map,n=(t,s,n)=>(i.set(n||s,t),{image:t.createIcon(e),hotkey:s,value:t});super(e,{spacing:4,items:[[...a.EDITOR_TOOL.paintRegion.map(((e,t)=>n(e,(t+1).toString(),s.Input.Keyboard.KeyCodes.ONE+t)))],[n(a.EDITOR_TOOL.deleteTile,"Q"),n(a.EDITOR_TOOL.paintSoldier,"W"),n(a.EDITOR_TOOL.paintTown,"E"),n(a.EDITOR_TOOL.paintForest,"R"),n(a.EDITOR_TOOL.addCoins,"T"),n(a.EDITOR_TOOL.paintCastle,"Z")],[n(a.EDITOR_TOOL.addChest,"A")]],onItemSelected:e=>r.inject.events.trigger(o.MapEditorActions.SetTool(e))});for(const[t,s]of i.entries())e.input.keyboard.addKey(t).on("down",(()=>{this.select(s),r.inject.events.trigger(o.MapEditorActions.SetTool(s))}));this.select(t)}}t.MapEditorPalette=c},865:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorPointerEventsController=t.EditorPointerState=void 0;const s=i(48500),n=i(88865),a=i(58592);var o;!function(e){e.Idle="idle",e.CameraHoldDrag="camera-drag",e.Paint="paint"}(o=t.EditorPointerState||(t.EditorPointerState={})),s.logger.for("ui:MapEditorPointerEventsController"),t.MapEditorPointerEventsController=class{constructor(e){this.actionImpls=e,this.pointerState=o.Idle}startPaint(){this.setState(o.Paint)}startCameraDrag(){a.app.scene.worldMap.cameraController.startDragScroll(),this.setState(o.CameraHoldDrag)}stop(){this.pointerState===o.CameraHoldDrag&&a.app.scene.worldMap.cameraController.stopDragScroll(),this.pointerState=o.Idle}setState(e){e!==this.pointerState&&(this.pointerState=e,e!==o.Idle?n.inject.debugData.set("editorScene.pointerState",e):n.inject.debugData.clear("editorScene.pointerState"))}}},23979:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorScene=t.MapEditorActions=t.editorAction=void 0;const s=i(11930),n=i(48500),a=i(34758),o=i(24794),r=i(91025),c=i(4126),l=i(2008),d=i(35863),h=i(40667),u=i(865),p=i(30237),g=i(82260),m=i(85912),y=i(96465),f=i(24917),w=i(5715),v=i(68736),b=i(97866),S=i(99694),x=i(88865);var T=Phaser.GameObjects.BitmapText;const P=20,M=360;function I(){return(0,a.createEventFactory)(a.EventCategory.MapEditor)}t.editorAction=I,t.MapEditorActions={SetTool:I()("SET_TOOL"),FinalizeMap:I()("FINALIZE_MAP"),ExpandMap:I()("EXPAND_MAP"),ResetStartingCoins:I()("RESET_STARTING_COINS")},n.logger.for(s.Scenes.MapEditor);class A extends v.BaseUIScene{constructor(){super({key:s.Scenes.MapEditor}),this.preUpdate=(0,b.whenDirty)((()=>{})),this.currentTool=h.EDITOR_TOOL.paintRegion[0],this.cursorAttachment=new d.CursorAttachment(this),this.pointerController=new u.MapEditorPointerEventsController({tryStartCameraDrag:()=>!0,endCameraDrag:()=>{this.worldMapScene.cameraController.stopDragScroll()},tryStartPaint:()=>!0,endPaint:()=>{}})}createButton(e,t){const i=new y.BoxButton(this,0,P,{content:new T(this,0,0,f.BitmapFont.Small,e).setTint(w.Colors.woodenUi.primaryText),baseTexture:c.BoxTextures.DialogButton,downTexture:c.BoxTextures.DialogButtonDown,width:102,height:36});return i.onClicked(t),i}create(){super.create(),this.worldMapScene=this.scene.get(s.Scenes.WorldMap),this.resumeButton=this.createButton("PLAY",(()=>{x.inject.events.trigger(r.UserActions.ResumeGame())})),this.newGameButton=this.createButton("CLEAR",(()=>{x.inject.events.trigger(r.UserActions.CreateBlankMap())})).setTextTint(4461331).setTint(16750968),this.exportButton=this.createButton("EXPORT",(()=>{x.inject.events.trigger(r.UserActions.OpenExportMapDialog())})).setTextTint(2376723).setTint(10026855),this.importButton=this.createButton("IMPORT",(()=>{x.inject.events.trigger(r.UserActions.OpenLoadGameDialog())})).setTextTint(4461331).setTint(16750968),this.jsonEditButton=this.createButton("EDIT JSON",(()=>{x.inject.events.trigger(r.UserActions.EditMapJSON())})),this.finalizeButton=this.createButton("FINALIZE",(()=>{x.inject.events.trigger(t.MapEditorActions.FinalizeMap())})),this.expandButton=this.createButton("EXPAND",(()=>{x.inject.events.trigger(t.MapEditorActions.ExpandMap(5))})),this.standardizeGoldButton=this.createButton("STD.COINS",(()=>{x.inject.events.trigger(t.MapEditorActions.ResetStartingCoins({base:7,income:2}))})),this.backgroundPlate=new c.Box(this,c.BoxTextures.Plate),this.backgroundPlate.setInteractive(),this.palette=new l.MapEditorPalette(this,this.currentTool),this.currentToolDescription=new p.Label(this,""),this.handleToolSelected(this.currentTool),this.add.existing(this.backgroundPlate);const e=[this.palette,this.currentToolDescription];this.addAll([...e,this.jsonEditButton,this.resumeButton,this.importButton,this.newGameButton,this.exportButton,this.finalizeButton,this.expandButton,this.standardizeGoldButton]),this.scale.on("resize",(()=>this.reflow())),this.reflow(),this.input.keyboard.addKey(g.Input.Keyboard.KeyCodes.BACKTICK).on("down",(()=>{x.inject.gameStateController.undo()})),this.bindKey(g.Input.Keyboard.KeyCodes.SPACE,(()=>r.UserActions.ResumeGame())),x.inject.gameStateController.onEvent((e=>{this.scene.isActive()&&(0,a.isEvent)(e,r.GameStateEvents.NewGameState)&&this.worldMapScene.loadNewGameState(e.payload.state)})),this.observe.event(r.WorldMapEvents.StartDrag,(({hexId:e,flags:t})=>{if(this.scene.isActive())if(t&r.PointerEventFlags.RightButton)this.pointerController.startCameraDrag();else{if(!e)return;const t=(0,o.getHex)(e);this.pointerController.startPaint(),t&&this.applyCurrentTool(t)}})),this.observe.event(r.WorldMapEvents.EndDrag,(e=>{this.pointerController.stop()})),this.observe.watch(x.inject.ui.hexUnderCursor,(e=>{e&&this.pointerController.pointerState===u.EditorPointerState.Paint&&this.applyCurrentTool(e)})),this.observe.event(r.GameStateEvents.NewGameState,(({state:e})=>{this.worldMapScene.loadNewGameState(e)})),x.inject.events.on(t.MapEditorActions.SetTool,(e=>{this.handleToolSelected(e)}))}update(){this.cursorAttachment.update()}updateToolDescription(){this.currentToolDescription.setText(`${this.currentTool?.description||""}\n~ = undo\nhold right mouse button to drag view`)}handleToolSelected(e){this.currentTool=e,this.cursorAttachment.setImage(this.createCursorAttachmentImage(e)),this.updateToolDescription()}createCursorAttachmentImage(e){const t=e.createIcon(this);return t.setScale(.5*t.scaleX,.5*t.scaleY),t}applyCurrentTool(e){if(!this.currentTool)return;if(e.isAtGridBorder(x.inject.gameStateModel.map))return;const t=x.inject.gameStateModel.state,{shift:i,ctrl:s,alt:n}=this.worldMapScene.keys;this.currentTool.useOn(e,{shift:i.isDown,ctrlOrAlt:s.isDown||n.isDown});const a=x.inject.gameStateModel.state;t!==a&&x.inject.gameStateController.executePlay(r.Plays.EditMap({stateAfter:a}))}updateWorld(){x.inject.ui.withoutTransitions((()=>{this.worldMapScene.loadNewGameState(x.inject.gameStateModel.state)}))}reflow(){const e=this.cameras.main.displayWidth,t=this.cameras.main.displayHeight;this.resumeButton.setPosition(e-this.resumeButton.width-P,P),this.jsonEditButton.setPosition(this.resumeButton.x-8-this.jsonEditButton.width,this.resumeButton.y),this.backgroundPlate.setPosition(e-M,0),this.backgroundPlate.setSize(M,t),this.palette.setPosition(e-M+P,100),this.palette.preUpdate.force(),this.currentToolDescription.setPosition(e-M+P,this.palette.y+this.palette.height+20),(0,m.layoutFromLeftToRight)(e-M+P,t-P-this.newGameButton.height,8,[this.newGameButton,this.importButton,this.exportButton]),S.Arrange.vertically({content:[this.standardizeGoldButton,this.finalizeButton,this.expandButton],y:this.exportButton.y-this.exportButton.height-40,spacing:16,origin:1}),S.Arrange.alignX([this.standardizeGoldButton,this.finalizeButton,this.expandButton],{x:this.exportButton.x,origin:0})}}t.MapEditorScene=A},5845:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorScreen=void 0;const s=i(11930),n=i(54949),a=i(91025),o=i(47102),r=i(84370),c=i(23979),l=i(80682),d=i(38764),h=i(88865),u=i(58592),p=i(30420),g=i(30093);class m extends n.BaseScreen{constructor(){super("MapEditor",[s.Scenes.WorldMap,s.Scenes.MapEditor]),this.observe.event(a.UserActions.ResumeGame,(()=>{h.inject.gameStateController.history.reset(h.inject.currentGameState),h.inject.userData.saveLevelProgress(),u.app.navigator.goTo(u.app.screen.play,r.NewGameStateContext.ResumingGame)})),this.observe.event(a.UserActions.Escape,(async()=>{h.inject.events.trigger(a.UserActions.ResumeGame())})),this.observe.event(c.MapEditorActions.FinalizeMap,(async()=>{const e=(0,d.lintLevel)(h.inject.gameStateModel.exportState(),{fix:!0});h.inject.gameStateModel.restore(e.fixedState),u.app.scene.worldMap.syncState()})),this.observe.event(c.MapEditorActions.ExpandMap,(async e=>{!function(e){const t=h.inject.gameStateModel;l.WorldMap.update(t.state,{levelId:h.inject.ui.session.levelId,width:t.map.width+2*e,height:t.map.height+2*e}),t.restore((0,d.shiftMap)(t.exportState(),e,e))}(e),u.app.scene.worldMap.syncState()})),this.observe.event(c.MapEditorActions.ResetStartingCoins,(async({base:e,income:t})=>{const i=h.inject.gameStateModel,s=i.pawns.select({type:[p.PawnType.Town]});for(let n of s)1===n.faction?.id?i.pawns.setCount(n.hex,p.PawnType.Coins,e):i.pawns.setCount(n.hex,p.PawnType.Coins,e-t);u.app.scene.worldMap.syncState()}))}async activate(){u.app.scene.worldMap.setMode(new o.EditorMode),u.app.scene.worldMap.overlays.set(h.inject.currentGameState,g.OverlayModes.spectating()),u.app.scene.worldMap.cameraController.setViewportMargins({right:300})}deactivate(){}}t.MapEditorScreen=m},68950:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AddChestTool=void 0;const s=i(88865),n=i(30420),a=i(20666);var o=Phaser.GameObjects.Image;t.AddChestTool=class{constructor(){this.description="click = add chest\nalt-click = remove chest"}createIcon(e){return new o(e,0,0,"atlas","pawns/chest").setScale(.5,.5)}useOn(e,t){const i=s.inject.gameStateModel;if(!i.regions.byHex(e))return;const o=n.PawnType.Chest,r=i.pawns.byHex(e).find((e=>e.hasTrait(a.PawnTraits.OccupiesTile)));t.ctrlOrAlt?(r&&r.destroy(),i.pawns.byHex(e,n.PawnType.Coins)?.destroy()):r?(r.type!==o&&r.replaceWith(o),i.pawns.create({hex:e,type:n.PawnType.Coins,count:10})):(i.pawns.create({hex:e,type:o}),i.pawns.create({hex:e,type:n.PawnType.Coins,count:10}))}}},92476:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinsTool=void 0;const s=i(30420),n=i(88865),a=i(58592),o=i(5715);var r=Phaser.GameObjects.Image;t.CoinsTool=class{constructor(){this.description="click = add coin\nalt-click = remove coin\nshift-click = add 5 coins"}createIcon(e){return new r(e,0,0,"atlas","ui/budget-icons/neutral")}useOn(e,t){const i=new Set([s.PawnType.Town,s.PawnType.Camp,s.PawnType.HauntedTown,s.PawnType.Chest]),r=n.inject.gameStateModel,c=r.regions.byHex(e);if(!c)return;const l=r.pawns.findClosest(e,c.hexes,(e=>i.has(e.type)));if(!l)return;const d=function(e,t){const i=t.shift?5:1,s=t.ctrlOrAlt?-1:1;return Math.max(0,e+i*s)}(r.pawns.getCount(l.hex,s.PawnType.Coins),t);r.pawns.setCount(l.hex,s.PawnType.Coins,d),a.app.scene.worldMap.vfx.popupText(l.hex,d.toFixed(0),o.Colors.highlight.ownedRegion)}}},23280:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deleteTile=t.DeleteTileTool=void 0;const s=i(88865);var n=Phaser.GameObjects.Image;function a(e){const t=s.inject.gameStateModel,i=t.regions.byHex(e),n=t.factions.byHex(e);i&&n&&(t.pawns.destroy(...t.pawns.byHex(e)),t.regions.byHex(e).removeHexes(e),n.splitRegionIfDisconnected(i))}t.DeleteTileTool=class{constructor(){this.description="click = delete tile\nshift-click = delete objects"}createIcon(e){return new n(e,0,0,"atlas","editor/delete-tile-icon")}useOn(e,t){t.shift?function(e){const t=s.inject.gameStateModel;t.pawns.destroy(...t.pawns.byHex(e))}(e):a(e)}},t.deleteTile=a},59650:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintCastleTool=void 0;const s=i(30420),n=i(20666),a=i(88865);var o=Phaser.GameObjects.Image;t.PaintCastleTool=class{constructor(){this.description="click = add castle\nalt-click = remove castle"}createIcon(e){return new o(e,0,0,"atlas","pawns/castle").setScale(.5,.5)}useOn(e,t){const i=a.inject.gameStateModel,o=i.pawns.byHex(e).find((e=>e.hasTrait(n.PawnTraits.OccupiesTile)));i.regions.byHex(e)&&(t.ctrlOrAlt?o&&o.destroy():o?o.type!==s.PawnType.Castle&&o.replaceWith(s.PawnType.Castle):i.pawns.create({hex:e,type:s.PawnType.Castle}))}}},82450:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintForestTool=void 0;const s=i(23280),n=i(21999),a=i(20666),o=i(30420),r=i(88865);var c=Phaser.GameObjects.Image;t.PaintForestTool=class{constructor(){this.description="click = add forest tile\nalt-click = delete tile"}createIcon(e){return new c(e,0,0,"atlas","editor/tree")}useOn(e,t){(0,s.deleteTile)(e);const i=r.inject.gameStateModel,c=i.pawns.byHex(e).find((e=>e.hasTrait(a.PawnTraits.OccupiesTile)));t.ctrlOrAlt?(c&&c.destroy(),i.pawns.findOne({hexes:e,type:[o.PawnType.Coins]})?.destroy()):c?(i.factions.byId(n.SpecialFaction.neutral).takeOverHex(e),c.type!==o.PawnType.Forest&&c.replaceWith(o.PawnType.Forest)):(i.factions.byId(n.SpecialFaction.neutral).takeOverHex(e),i.pawns.create({hex:e,type:o.PawnType.Forest}))}}},84304:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintRegionTool=void 0;const s=i(21999),n=i(70448),a=i(88865),o=i(20666);var r=Phaser.GameObjects.Image;t.PaintRegionTool=class{constructor(e){this.factionId=e,this.description=`click = assign faction ${this.factionId}\nalt-click = delete`}createIcon(e){return new r(e,0,0,"atlas","editor/tile-icon").setTint(n.THEMES.default.colors[this.factionId-1])}useOn(e,t){for(;!a.inject.gameStateModel.factions.byId(this.factionId);)a.inject.gameStateModel.factions.create((0,s.getDefaultFactionConfig)(a.inject.gameStateModel.factions.all().length));const i=a.inject.gameStateModel.factions.byId(this.factionId),n=a.inject.gameStateModel.factions.byHex(e)?.id;if(t.ctrlOrAlt){if(n===s.SpecialFaction.neutral)return;a.inject.gameStateModel.factions.byId(s.SpecialFaction.neutral).takeOverHex(e),a.inject.gameStateModel.pawns.byHex(e).forEach((e=>e.destroy()))}else{if(n===this.factionId)return;i.takeOverHex(e),n===s.SpecialFaction.neutral&&a.inject.gameStateModel.pawns.byHex(e).filter((e=>!e.hasTrait(o.PawnTraits.Treasure))).forEach((e=>e.destroy()))}}}},44084:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintSoldierTool=void 0;const s=i(30420),n=i(20666),a=i(88865);var o=Phaser.GameObjects.Image;t.PaintSoldierTool=class{constructor(){this.description="click = add/upgrade unit\nalt-click = downgrade/remove unit"}createIcon(e){return new o(e,0,0,"atlas","pawns/villager").setScale(.5,.5)}useOn(e,t){const i=a.inject.gameStateModel,s=i.pawns.byHex(e).find((e=>e.hasTrait(n.PawnTraits.OccupiesTile))),o=t.ctrlOrAlt?this.getDownGradedUnitType(s?.type):this.getUpgradedUnitType(s?.type);i.regions.byHex(e)&&(o?s?s.type!==o&&s.replaceWith(o):i.pawns.create({hex:e,type:o}):s&&s.destroy())}getUpgradedUnitType(e){switch(e){case s.PawnType.Villager:return s.PawnType.Pikeman;case s.PawnType.Pikeman:return s.PawnType.Knight;case s.PawnType.Knight:case s.PawnType.Hero:return s.PawnType.Hero;default:return s.PawnType.Villager}}getDownGradedUnitType(e){switch(e){case s.PawnType.Bandit:case s.PawnType.Zombie:return;case s.PawnType.Pikeman:return s.PawnType.Villager;case s.PawnType.Knight:return s.PawnType.Pikeman;case s.PawnType.Hero:return s.PawnType.Knight;case s.PawnType.Villager:default:return a.inject.gameStateModel.plugins.zombies?s.PawnType.Zombie:s.PawnType.Bandit}}}},91564:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintTownTool=void 0;const s=i(30420),n=i(20666),a=i(21999),o=i(88865);var r=Phaser.GameObjects.Image;t.PaintTownTool=class{constructor(){this.description="click = add town\nalt-click = remove town"}createIcon(e){return new r(e,0,0,"atlas","pawns/town-1").setScale(.5,.5)}useOn(e,t){const i=o.inject.gameStateModel;if(!i.regions.byHex(e))return;const r=i.factions.byHex(e)?.id===a.SpecialFaction.neutral?o.inject.gameStateModel.plugins.zombies?s.PawnType.HauntedTown:s.PawnType.Camp:s.PawnType.Town,c=i.pawns.byHex(e).find((e=>e.hasTrait(n.PawnTraits.OccupiesTile)));t.ctrlOrAlt?(c&&c.destroy(),i.pawns.findOne({hexes:e,type:[s.PawnType.Coins]})?.destroy()):c?c.type!==r&&c.replaceWith(r):i.pawns.create({hex:e,type:r})}}},25575:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapGenerationScreen=void 0;const s=i(11930),n=i(54949),a=i(91025),o=i(84370),r=i(35037),c=i(88865),l=i(58592);class d extends n.BaseScreen{constructor(){super("MapGeneration",[s.Scenes.WorldMap]),this.observe.event(a.UserActions.ResumeGame,(()=>{c.inject.userData.saveLevelProgress(),l.app.navigator.goTo(l.app.screen.play,o.NewGameStateContext.ResumingGame)})),this.observe.event(a.UserActions.Escape,(async()=>{c.inject.events.trigger(a.UserActions.ResumeGame())}))}async activate(){l.app.scene.worldMap.setMode(new r.PreviewMode)}deactivate(){}}t.MapGenerationScreen=d},1215:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayScene=void 0;const s=i(11930),n=i(48500),a=i(46919),o=i(84370),r=i(47613),c=i(53094),l=i(88865),d=i(58592),h=i(56175),u=i(6914),p=i(24794),g=i(55415);n.logger.for("ui:PlayScene");class m extends a.BaseScene{constructor(){super({key:s.Scenes.Play}),this.inputEventsBuffer=new h.AsyncBuffer,this.mode=new c.PassiveMode(this)}setMode(e){this.mode.deactivate(),this.mode=e,l.inject.debugData.set("playScene.mode",this.mode.name),e.activate(),e.handleNewHexUnderCursor(l.inject.ui.hexUnderCursor())}create(){super.create(),this.gameEventQueue=l.inject.gameStateController.getEventQueue(),this.events.on("destroy",(()=>{this.gameEventQueue.unsubscribe()})),this.worldMapScene=this.scene.get(s.Scenes.WorldMap),this.debugScene=this.scene.get(s.Scenes.Debug),this.uiScene=this.scene.get(s.Scenes.PlayUI),this.resetCursor()}async afterEventsProcessed(e){return this.gameEventQueue.hasNext()?await this.inputEventsBuffer.schedule("input",e):e()}resetCursor(){this.cursor=l.inject.gameStateController.history.getCursor()}skipToCurrentState(e=o.NewGameStateContext.ResumingGame){this.gameEventQueue.clear();const t=l.inject.gameStateModel.state;(0,g.handleNewGameState)(d.app.scene.play,t,e),this.resetCursor()}update(e,t){const i=[];for(;this.gameEventQueue.hasNext()&&this.mode.isReadyForMoreGameEvents();){const e=this.gameEventQueue.next();i.push(e),l.inject.events.trigger(e)}i.length&&(this.mode.handleNewGameEventsAvailable().then((()=>{this.gameEventQueue.hasNext()||this.inputEventsBuffer.flush()})),d.app.scene.worldMap.runIntegrityChecks()),l.inject.debugData.set("playScene.mode",`${this.mode.name} (${this.mode.isReadyForMoreGameEvents()?"ready":"processing event"})`)}async dropHeldPawnAtHex({hexId:e,willBeMovable:t}){const i=this.worldMapScene.getPawnObjectPositionOnScreen(e);return t&&(i.y-=u.PAWN_JUMPING_HEIGHT),new Promise((t=>{this.uiScene.pawnHolder.dropPawn(i.x,i.y,i.scale,(()=>{const i=d.app.scene.worldMap.pawns.getByHex(e);i&&(i.setVisible(!0),i.clearHighlight(),d.app.scene.worldMap.overlays.pawnBacklight.remove((0,p.getHex)(e))),t()}))}))}refreshTownVariantInRegions(e){for(let t of e){const e=t.getTownHexes();d.app.scene.worldMap.pawns.syncPawnVariant(new r.StaticGameStateModel(t.state),e)}}}t.PlayScene=m},39961:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Cheats=t.PlayScreen=void 0;const s=i(11930),n=i(54949),a=i(91025),o=i(23625),r=i(53094),c=i(84370),l=i(54173),d=i(98723),h=i(68825),u=i(56952),p=i(11041),g=i(48500),m=i(81363),y=i(42526),f=i(46345),w=i(60807),v=i(54737),b=i(92578),S=i(24794),x=i(68660),T=i(88865),P=i(58592),M=i(22378),I=i(3691),A=i(12678),C=i(24592),B=i(30258),E=i(14917),R=i(5427),O=i(76909),_=i(98778),H=i(99896),D=i(30093);g.logger.for("PlayScreen");class k extends n.BaseScreen{get currentMode(){return P.app.scene.play.mode}get selectedRegion(){const e=T.inject.ui.session.selectedRegionId;if(void 0!==e)return T.inject.gameStateModel.regions.byId(e)}constructor(){function e(){return!P.app.scene.play.mode.canSwitchRegion()&&(P.app.audio.playEffect(m.SoundEffects.Deny),!0)}super("Play",[s.Scenes.Play,s.Scenes.PlayUI,s.Scenes.WorldMap]),this.isReplay=!1,this.observe.event(a.UserActions.GoBack,(async()=>{P.app.scene.play.skipToCurrentState(c.NewGameStateContext.Preview),P.app.scene.play.mode instanceof b.SpectatorMode&&P.app.scene.play.mode.context===R.SpectatingContext.ReplayOnly?P.app.navigator.goTo(P.app.screen.title):(T.inject.gameStateModel.currentPhase.isLocalPlayerTurn()&&T.inject.userData.saveLevelProgress(),T.inject.ui.session.active&&T.inject.ui.session.end({origin:"play/leave"}),await(0,l.returnToMenuFromGame)())})),this.observe.event(a.UserActions.Escape,(async()=>{this.currentMode.handleAbort()})),this.observe.event(a.UserActions.Cancel,(async()=>{P.app.scene.playUI.activeUI.closeRollbackPanel()})),this.observe.event(a.UserActions.Undo,(()=>{T.inject.gameStateController.undo()})),this.observe.event(a.UserActions.StartRewind,(()=>{T.inject.ui.session.remainingLives>0||T.inject.config.debug.cheats?P.app.scene.play.setMode(new E.RewindMode(P.app.scene.play)):P.app.audio.playEffect(m.SoundEffects.Deny)})),this.observe.event(a.UserActions.ConfirmRewind,(()=>{const e=P.app.scene.play.cursor.currentState,t=T.inject.currentGameState,i=(0,_.getLivesAdjustmentAfterRewind)(t,e),s=(0,_.getTurnDelta)(t,e),n=H.CurrentPhase.getTurnNumber(e);switch(T.inject.gameStateController.rewindTo(P.app.scene.play.cursor),P.app.scene.play.setMode(new O.PlayMode(P.app.scene.play)),i){case"refill":T.inject.ui.session.startNew({levelId:T.inject.ui.session.levelId,origin:"play/rewind-to-start",turnNumber:n}),P.app.scene.playUI.activeUI.updateState({livesLeft:T.inject.ui.session.remainingLives});break;case"burn-one":setTimeout((()=>{T.inject.ui.session.burnLife(),P.app.scene.playUI.activeUI.burnLife(),T.inject.events.trigger(a.UiEvents.RewindConfirmed({turns:s,targetTurn:n}))}),200)}T.inject.userData.saveLevelProgress(),P.app.scene.globalUI.notifications.clearToastsByCategory(I.NotificationCategory.SurrenderOffer)})),this.observe.event(a.UserActions.ViewReplay,(()=>{w.track.interaction("view_replay");const e=P.app.scene.play.cursor,t=T.inject.gameStateModel.factions.all().find((e=>e.isLocalPlayer()));A.assert.defined(t),P.app.scene.play.setMode(new b.SpectatorMode(P.app.scene.play,R.SpectatingContext.LiveReplay)),e.seekBackTag("turnStart",t.id),e.stepBack(),e.seekBackTag("turnStart",t.id),e.stepForward(),e.seekForwardTag("turnStart"),P.app.scene.worldMap.syncState(e.currentState,D.OverlayModes.spectating()),P.app.scene.play.mode.processEvents(e)})),this.observe.event(a.UserActions.RestartLevel,(async()=>{if(await P.app.modals.confirmRestart()===u.DialogButtons.Restart){const e=T.inject.gameStateModel.map.levelId;T.inject.userData.clearLevelProgress(e),T.inject.events.trigger(a.UserActions.PlayLevel({levelId:e,origin:"play/restart"})),P.app.audio.playEffect(m.SoundEffects.Rewind)}})),this.observe.event(a.UserActions.AcceptSurrender,(async()=>{w.track.interaction("accept_surrender"),T.inject.gameStateController.executePlay(a.Plays.AcceptSurrender())})),this.observe.event(a.SystemEvents.ShowGameOverScreen,(async e=>{T.inject.userData.saveLevelOutcome(e),e===M.LevelOutcome.Victory?P.app.navigator.goTo(P.app.screen.victory):P.app.navigator.goTo(P.app.screen.defeat)})),this.observe.event(a.UserActions.DeselectRegion,(()=>{this.selectRegion(void 0,{panCamera:!1,clickEffect:!1})})),this.observe.event(a.UserActions.SelectNextRegion,(()=>{if(e())return;const t=T.inject.ui.regionsLedger.getNext(T.inject.ui.session.selectedRegionId);this.selectRegion(t,{panCamera:!0,clickEffect:!0})})),this.observe.event(a.UserActions.SelectPreviousRegion,(()=>{if(e())return;const t=T.inject.ui.regionsLedger.getPrevious(T.inject.ui.session.selectedRegionId);this.selectRegion(t,{panCamera:!0,clickEffect:!0})})),this.observe.event(a.UserActions.SelectNextPendingRegion,(()=>{if(e())return;const t=T.inject.ui.regionsLedger.getNextPendingRegionId();this.selectRegion(t,{clickEffect:!1,panCamera:!0})})),this.observe.event(a.UserActions.SetSpectatingPlayBackSpeed,(e=>{this.currentMode instanceof b.SpectatorMode&&(0,b.updateTransitionSpeedForSpectatorMode)(e)})),this.observe.event(a.WorldMapEvents.StartInteraction,(e=>{const i=e.hexId&&(0,S.getHex)(e.hexId);i&&T.inject.config.debug.cheats&&e.flags&a.PointerEventFlags.MiddleButton?t.Cheats.toggleTapped(i):(P.app.device.uiVariant()!==x.UiVariant.Compact&&P.app.scene.playUI.activeUI.closeRollbackPanel(),e.flags&a.PointerEventFlags.RightButton&&this.currentMode.canReturnPawn()?this.currentMode.handleReturnPawn():this.currentMode.handleStartInteraction((0,S.getHex)(e.hexId),e.flags))})),this.observe.event(a.WorldMapEvents.CompleteInteraction,(e=>{e.flags&a.PointerEventFlags.RightButton||this.currentMode.handleCompleteInteraction((0,S.getHex)(e.hexId),e.flags)})),this.observe.event(a.WorldMapEvents.StartDrag,(e=>{e.hexId?this.currentMode.handleStartDrag((0,S.getHex)(e.hexId)):P.app.scene.worldMap.cameraController.startDragScroll()})),this.observe.event(a.WorldMapEvents.EndDrag,(e=>{this.currentMode.handleEndDrag((0,S.getHex)(e.hexId))})),this.observe.event(a.UserActions.BuyablePawnPointerDown,(e=>{P.app.scene.playUI.canBuyPawn(e)?this.currentMode.handlePawnInShopPointerDown(e):P.app.audio.playEffect(m.SoundEffects.Deny)})),this.observe.event(a.UserActions.BuyablePawnPointerUp,(e=>{P.app.scene.playUI.canBuyPawn(e)&&this.currentMode.handlePawnInShopPointerUp(e)})),this.observe.event(a.UserActions.ShopAreaPointerUp,(e=>{this.currentMode.handleShopAreaPointerUp()})),this.observe.event(a.UserActions.ReturnHeldPawn,(()=>{this.currentMode.handleReturnPawn()})),this.observe.event(a.GameStateEvents.NewGameState,(({context:e})=>{e!==c.NewGameStateContext.LoadReplay&&e!==c.NewGameStateContext.Rewind&&P.app.scene.play.skipToCurrentState(e)})),this.observe.event(a.UserActions.EndTurn,(async({force:e})=>{if(!this.currentMode.canEndTurn())return void T.inject.events.trigger(a.UserActions.Escape());T.inject.config.autoSaveOnTurnEnd&&T.inject.userData.saveLevelProgress();const t=T.inject.gameStateModel.currentPhase.faction?.getRegions().filter((e=>e.isActionable()));!e&&T.inject.gameStateController.isOnTurnStart()&&t?.length?await P.app.modals.confirmEndTurn()===u.DialogButtons.EndTurn&&this.currentMode.handleEndTurn():this.currentMode.handleEndTurn()})),this.observe.watch(T.inject.ui.hexUnderCursor,(e=>{this.currentMode.handleNewHexUnderCursor(e)})),this.observe.event(a.UserActions.SkipSpectating,(()=>{this.currentMode.handleSkipSpectating(),P.app.scene.playUI.updateSpectatingLayout({enableSkipSpectating:!1})})),this.observe.event(a.UserActions.ExitSpectatingMode,(({returnTo:e})=>{switch(e){case"defeatScreen":P.app.navigator.goTo(P.app.screen.defeat);break;case"victoryScreen":P.app.navigator.goTo(P.app.screen.victory);break;case"menu":P.app.navigator.goTo(P.app.screen.title)}})),this.observe.event(a.UserActions.SaveReplay,(()=>{const e=T.inject.gameStateController.history.export({snapshotPolicy:["initial","p1-start","final"],includeRewinds:!1,sizeLimit:1e5}),t=(0,C.encodeReplay)(e),i=p.LevelModel.for(T.inject.gameStateModel.map.levelId),s=new Date;(0,B.downloadAsTextFile)(`replay-${s.getFullYear()}-${s.getMonth()}-${s.getDate()}-${i.getTitle(p.LevelTitleStyle.Full).toLowerCase().replaceAll(" ","_")}.konkr`,t),P.app.notifications.success("Replay downloaded!","To view the replay later, simply drag and drop the file into the game window.","ui/icons/ok")})),this.observe.event(a.GameStateEvents.FactionApprovalChanged,(e=>{P.app.scene.play.mode.handleApprovalChange(e)}))}async activate(e){const t=P.app.scene.play,i=T.inject.gameStateModel.map.levelId;T.inject.ui.selectedLevelId.set(i),T.inject.ui.regionsLedger.reset(T.inject.gameStateModel.state);const s=p.LevelModel.for(i);if(this.isReplay=e===c.NewGameStateContext.LoadReplay,P.app.scene.playUI.updateState({levelName:s.getTitle(p.LevelTitleStyle.IncludingModePrefix)+(this.isReplay?" (replay)":"")}),e===c.NewGameStateContext.ViewReplayAfterGameOver){const e=P.app.scene.play.cursor;return e.goTo(0),P.app.scene.worldMap.setMode(new o.InteractiveMode),P.app.scene.worldMap.syncState(e.currentState,D.OverlayModes.spectating()),P.app.scene.play.setMode(new b.SpectatorMode(P.app.scene.play,R.SpectatingContext.LiveReplay)),void P.app.scene.play.mode.processEvents(e)}if(e===c.NewGameStateContext.LoadReplay){const e=P.app.scene.play.cursor;return e.goTo(0),P.app.scene.worldMap.setMode(new o.InteractiveMode),P.app.scene.worldMap.syncState(e.currentState,D.OverlayModes.spectating()),P.app.scene.play.setMode(new b.SpectatorMode(P.app.scene.play,R.SpectatingContext.ReplayOnly)),void P.app.scene.play.mode.processEvents(e)}P.app.scene.worldMap.setMode(new o.InteractiveMode),t.skipToCurrentState(e),T.inject.scriptRunner.setScript(s.campaignContext?.levelData.script??"global")}deactivate(){P.app.scene.play.setMode(new r.PassiveMode(P.app.scene.play)),P.app.scene.worldMap.endSession(),T.inject.scriptRunner.setScript(void 0)}async transitionIn(e){e===P.app.screen.levelDetail?P.app.scene.playUI.activeUI.transitionIn():(P.app.scene.playUI.activeUI.transitionIn(),P.app.scene.worldMap.cameraController.center(T.inject.config.screenTransitionDuration,1))}async transitionOut(e){switch(e){case P.app.screen.levelDetail:return(0,d.playSceneToLevelDetailTransition)();case P.app.screen.victory:return await(0,h.victoryTransition)();case P.app.screen.defeat:return await(0,v.defeatTransition)();default:return P.app.scene.playUI.activeUI.transitionOut()}}selectRegion(e,t={panCamera:!1,clickEffect:!0}){const i=T.inject.ui.session.selectedRegionId;T.inject.ui.session.setSelectedRegionId(e),void 0!==e&&T.inject.ui.regionsLedger.regionVisited(e);const s=void 0!==e&&T.inject.gameStateModel.regions.byId(e),n=e?T.inject.gameStateModel.regions.byId(e):void 0,o=i?T.inject.gameStateModel.regions.byId(i):void 0;if(n!==o&&this.currentMode.canReturnPawn()&&this.currentMode.handleReturnPawn(),n!==o&&P.app.scene.worldMap.overlays.set(T.inject.currentGameState,D.OverlayModes.playing({selectedRegionId:n?.id})),P.app.scene.playUI.updateFromGameState(),n&&n.faction&&n.faction===T.inject.gameStateModel.currentPhase.faction&&f.WorldMapUpdater.setPawnsJumpingInRegion(n,!0),t.clickEffect&&s&&P.app.audio.playEffect(m.SoundEffects.ShutterClick),t.panCamera&&s){const e=(0,y.rectToPhaser)(s.hexes.getDisplayBoundingBox());P.app.scene.worldMap.cameraController.ensureRectVisible(e,{allowZoom:!1})}T.inject.events.trigger(a.UiEvents.RegionSelected(e))}}t.PlayScreen=k,t.Cheats={toggleTapped(e){const t=T.inject.gameStateModel;let i=t.warfare.getOccupyingUnit(e);i&&(t.currentPhase.isTapped(i)?(t.currentPhase.unTapPawn(i),P.app.scene.worldMap.pawns.getById(i.id)?.startJumping()):(t.currentPhase.tapPawn(i),P.app.scene.worldMap.pawns.getById(i.id)?.stopJumping()))}}},46345:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapUpdater=void 0;const s=i(4278);t.WorldMapUpdater={setPawnsJumpingInRegion:s.setPawnsJumpingInRegion,setPawnJumpingInRegions:s.setPawnJumpingInRegions}},4278:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setPawnsJumpingInRegion=t.setPawnJumpingInRegions=void 0;const s=i(88865),n=i(58592);function a(e,t){const i=s.inject.gameStateModel.currentPhase.getMovablePawns().filter((t=>t.region.id===e.id)).map((e=>n.app.scene.worldMap.pawns.getById(e.id)));t?i.forEach((e=>e?.startJumping())):i.forEach((e=>e?.stopJumping()))}t.setPawnJumpingInRegions=function(e){e.forEach((e=>a(e,!0)))},t.setPawnsJumpingInRegion=a},34394:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleFactionTurnStarted=void 0;const s=i(76909),n=i(91025),a=i(92578),o=i(30420),r=i(12678),c=i(30997),l=i(21999),d=i(46345),h=i(88865),u=i(58592),p=i(37289),g=i(99896),m=i(51833),y=i(41959);t.handleFactionTurnStarted=function({state:e,factionId:t}){const i=h.inject.gameStateModel.factions.byId(t);r.assert.defined(i);const f=u.app.scene.play;if((0,y.getCurrentGameStateModel)().factions.all().filter((e=>e.isAlive()&&e.controller===o.FactionController.LocalUser)).length){switch(i.controller){case o.FactionController.LocalUser:h.inject.config.autoSaveOnTurnStart&&h.inject.userData.saveLevelProgress(),f.setMode(new s.PlayMode(f)),h.inject.ui.regionsLedger.reset(e),d.WorldMapUpdater.setPawnJumpingInRegions(i.getRegions()),u.app.screen.play.selectRegion(h.inject.ui.regionsLedger.getNextPendingRegionId(),{clickEffect:!1,panCamera:!1}),f.uiScene.updateFromGameState(h.inject.currentGameState,"play"),setTimeout((()=>u.app.worldNews.display()),1e3),0===g.CurrentPhase.model(e).tappedUnits().length&&!1!==h.inject.userData.recallChoice("rivalsSurrender")&&h.inject.ai.allowSurrender&&!h.inject.ui.session.dismissedSurrender&&(0,p.shouldOfferSurrender)(e)&&setTimeout((()=>u.app.notifications.claimVictory()),1);break;case o.FactionController.Ai:h.inject.config.autoSaveOnTurnStart&&h.inject.userData.saveLevelProgress(),f.mode instanceof a.SpectatorMode||f.setMode(new a.SpectatorMode(f)),h.inject.ai.play(i).then((async()=>{h.inject.gameStateController.executePlay(n.Plays.EndTurn())}));break;case o.FactionController.None:i.id===l.SpecialFaction.neutral&&(f.mode instanceof a.SpectatorMode||f.setMode(new a.SpectatorMode(f)),h.inject.gameStateController.executePlay(n.Plays.BanditsAct())),h.inject.gameStateController.executePlay(n.Plays.EndTurn());break;default:throw new Error(`Faction ${i} uses unsupported controller ${i.controller}`)}f.uiScene.updatePowerBalanceFromGameState(h.inject.currentGameState),u.app.scene.worldMap.regions.greenRenderer.redrawFaction(i),h.inject.config.debug.checkWorldMapIntegrity&&(0,c.verifyWorldMapInSync)(f.worldMapScene,e)}else(0,m.handleGameOver)({winningFactionId:void 0,state:h.inject.currentGameState})}},55415:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleNewGameState=void 0;const s=i(30420),n=i(76909),a=i(92578),o=i(99896),r=i(58592),c=i(88865),l=i(34394);t.handleNewGameState=function(e,t,i){const d=o.CurrentPhase.model(t),h=o.CurrentPhase.model(t).faction;if(e.worldMapScene.loadNewGameState(t),r.app.worldNews.clear(),c.inject.ui.regionsLedger.refreshAvailableRegions(t),i.resetCamera&&e.worldMapScene.cameraController.centerAboveControlPanel(),e.uiScene.updateFromGameState(t),e.uiScene.updatePowerBalanceFromGameState(t),i.startFactionTurn)(0,l.handleFactionTurnStarted)({state:t,factionId:o.CurrentPhase.getFaction(t)});else switch(h?.controller){case s.FactionController.LocalUser:e.time.addEvent({callback:()=>{d.getMovablePawns().map((t=>e.worldMapScene.pawns.getById(t.id))).forEach((e=>{e?.startJumping()}))},delay:100}),e.setMode(new n.PlayMode(e));break;case s.FactionController.Ai:case s.FactionController.None:case void 0:e.setMode(new a.SpectatorMode(e));break;default:throw new Error(`Faction ${h} uses unsupported controller ${h?.controller}`)}}},55531:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseMode=void 0;const s=i(48500),n=i(81363),a=i(91025),o=i(87284),r=i(28091),c=i(78336),l=i(7841),d=i(54444),h=i(88865),u=i(58592),p=i(14344),g=i(12678),m=i(35895),y=i(87262),f=i(41959),w=s.logger.for("BaseMode");t.BaseMode=class{isActive(){return this.scene.scene.isActive()&&this._active}constructor(e){this.scene=e,this.observe=new y.Observer((()=>this.isActive())),this._active=!1}isReadyForMoreGameEvents(){return!this.isProcessingEvents}canPickupPawn(e){return!1}canDropPawn(e){return!1}canEndTurn(){return!1}canSwitchRegion(){return!0}isHexInteractive(e){return!1}canReturnPawn(){return!1}handleReturnPawn(){w.warning(`returnPawn not available in ${this.name}`)}handleStartInteraction(e,t){}handleCompleteInteraction(e,t){}handleStartDrag(e){}handleEndDrag(e){}handleSkipSpectating(){w.warning(`skipSpectating not available in ${this.name}`)}handleShopAreaPointerUp(){u.app.audio.playEffect(n.SoundEffects.Deny)}handlePawnInShopPointerUp(e){}handlePawnInShopPointerDown(e){}activate(){this._active=!0}deactivate(){this._active=!1}handleNewHexUnderCursor(e){}handleEndTurn(){}async handleNewGameEventsAvailable(){if(this.isProcessingEvents)return!1;this.isProcessingEvents=!0,await this.processEvents(this.scene.cursor),this.isProcessingEvents=!1}async processEvents(e){for(;e.hasNext();){const t=e.consumeNextPlay();if(!t)return;for(let e of t)await this.playEvent(e)}}async playEvent(e){await(0,d.withTimeout)(this.scene,this.doHandleEvent(e),3e3)===d.TIMEOUT&&this.isProcessingEvents&&this.handleSkipSpectating()}async handlePawnBought(e){await(0,o.handlePawnBought)(this.scene,e)}async handleFactionEconomyUpdated(e){await(0,r.handleFactionEconomyUpdated)(this.scene,e)}async handleHexCaptured(e){await(0,c.handleHexCaptured)(this.scene,e)}async handlePawnMoved(e){await(0,l.handlePawnMoved)(this.scene,e)}async handleCutOffUnitsTurnedBandits(e){await u.app.scene.worldMap.play(e.worldUpdates)}handleAbort(){h.inject.events.trigger(a.UserActions.GoBack())}handleApprovalChange(e){const t=(0,f.getCurrentGameStateModel)().factions;if(!t.byId(e.towardsFactionId)?.isLocalPlayer())return;let i=e.delta;e.reason===m.ApprovalShiftReason.Attacking&&(i=0);const s=t.byId(e.fromFactionId),n=t.byId(e.towardsFactionId);g.assert.defined(s),g.assert.defined(n),u.app.scene.worldMap.overlays.attitudeEmojis.update(s,n,i)}handleFactionTurnOver(e){const t=p.Factions.model(e.state).byId(e.factionId);g.assert.defined(t),u.app.scene.play.refreshTownVariantInRegions(t.getRegions())}}},28914:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BuyingPawnMode=void 0;const s=i(91025),n=i(76909),a=i(55531),o=i(48500),r=i(42297),c=i(93195),l=i(81363),d=i(30420),h=i(12678),u=i(88865),p=i(58592),g=i(78336),m=i(41855),y=i(30093),f=o.logger.for("BuyingPawnMode");class w extends a.BaseMode{constructor(e,t){super(e),this.buyingPawn=t,this.bought=!1,this.name="BuyingPawn",this.isDraggingPawn=!0,this.justInitiated=!0,this.buyAnother=!1,setTimeout((()=>this.justInitiated=!1),200)}activate(){p.app.scene.worldMap.cameraController.stopDragScroll(),p.app.scene.worldMap.overlays.set(u.inject.currentGameState,y.OverlayModes.playing({holdingPawnType:this.buyingPawn,selectedRegionId:p.app.screen.play.selectedRegion.id})),p.app.tooltips.close()}deactivate(){!this.bought&&this.scene.uiScene.pawnHolder.heldPawnImage&&this.scene.uiScene.returnPawnToShop(this.buyingPawn)}isHexInteractive(e){return!0}canDropPawn(e){return!0}canReturnPawnAtHex(e){const t=p.app.screen.play.selectedRegion;return u.inject.gameStateModel.regions.byHex(e)?.id===t?.id&&!!u.inject.gameStateModel.pawns.byHex(e,d.PawnType.Town)}handleCompleteInteraction(e,t){this.isDraggingPawn&&this.justInitiated?this.isDraggingPawn=!1:(this.buyAnother=!!(t&s.PointerEventFlags.Shift&&this.canAffordAnother()),this.tryDropPawn(e)||(p.app.scene.worldMap.cameraController.stopDragScroll(),this.isDraggingPawn&&u.inject.events.trigger(s.UserActions.ReturnHeldPawn())))}handleStartInteraction(e){this.isDraggingPawn||p.app.scene.worldMap.cameraController.startDragScroll()}handleEndDrag(e){this.isDraggingPawn?this.tryDropPawn(e)||u.inject.events.trigger(s.UserActions.ReturnHeldPawn()):p.app.scene.worldMap.cameraController.stopDragScroll()}handlePawnInShopPointerDown(e){e!==this.buyingPawn?p.app.screen.play.selectedRegion.treasury>=u.inject.gameStateModel.rules.pawns(e).cost&&this.scene.uiScene.returnPawnToShop(this.buyingPawn,(()=>{this.scene.uiScene.grabNewPawnFromShop(e),this.buyingPawn=e,p.app.scene.worldMap.overlays.set(u.inject.currentGameState,y.OverlayModes.playing({holdingPawnType:this.buyingPawn,selectedRegionId:p.app.screen.play.selectedRegion.id})),this.fixPawnHolderPositionOnTouchDevice()})):(this.scene.uiScene.returnPawnToShop(this.buyingPawn),this.goToNextMode())}handlePawnInShopPointerUp(e){if(h.assert.defined(this.buyingPawn),e===this.buyingPawn&&this.justInitiated)return this.isDraggingPawn=!1,void this.fixPawnHolderPositionOnTouchDevice()}fixPawnHolderPositionOnTouchDevice(){if(p.app.device.isUsingTouch()){const{x:e,y:t}=p.app.scene.playUI.getPawnXY(this.buyingPawn);p.app.scene.playUI.pawnHolder.setFixedPosition(e,t-10)}}tryDropPawn(e){if(!e)return!1;const t=this.buyingPawn,i=p.app.screen.play.selectedRegion;if(h.assert.defined(t),h.assert.defined(i),this.canReturnPawnAtHex(e))return this.scene.uiScene.restockPawnInShop(this.buyingPawn,!0),this.scene.dropHeldPawnAtHex({hexId:e.id,willBeMovable:!0}),this.bought=!1,this.goToNextMode(),!1;const n=i=>{this.scene.uiScene.restockPawnInShop(this.buyingPawn),this.scene.dropHeldPawnAtHex({hexId:e.id,willBeMovable:i}),u.inject.gameStateController.executePlay(s.Plays.BuyPawn({pawnType:t,destinationHexId:e.id,buyerRegionId:u.inject.ui.session.selectedRegionId,tapUnit:!1})),p.app.audio.playEffect(l.SoundEffects.Drop)},a=u.inject.gameStateModel.warfare.getDropPawnResult(e,this.buyingPawn,i);switch(a.type){case r.DropPawnResultType.Reposition:case r.DropPawnResultType.EradicatePest:case r.DropPawnResultType.Combine:return n(a.type===r.DropPawnResultType.Reposition),this.bought=!0,this.goToNextMode(),!0;case r.DropPawnResultType.Conquest:return this.bought=!0,this.scene.uiScene.restockPawnInShop(this.buyingPawn,!0),u.inject.gameStateController.executePlay(s.Plays.BuyPawn({pawnType:t,destinationHexId:e.id,buyerRegionId:u.inject.ui.session.selectedRegionId,tapUnit:!1})),!0;case r.DropPawnResultType.Invalid:return p.app.audio.playEffect(l.SoundEffects.Deny),a.reason===r.InvalidDropPawnReason.PreventedByPawn&&(p.app.scene.worldMap.pawns.transitions.defendTile(e,a.blockers),p.app.notifications.movePreventedByPawn(this.buyingPawn,a.blockers),p.app.tooltips.showDefenderTaunt(e,this.buyingPawn,a.blockers[0])),!1}}handleShopAreaPointerUp(){u.inject.events.trigger(s.UserActions.ReturnHeldPawn())}handleReturnPawn(){h.assert.defined(this.buyingPawn),p.app.scene.worldMap.cameraController.stopDragScroll(),this.scene.uiScene.returnPawnToShop(this.buyingPawn,(()=>{this.goToNextMode()}))}async handleHexCaptured(e){e.originatingHexId?f.warning(`ignoring hexCaptured as the capture originated from pawn at hex ${e.originatingHexId}, rather than freshly bought pawn`):(p.app.audio.playEffect(l.SoundEffects.Drop),this.scene.dropHeldPawnAtHex({hexId:e.capturedHexId,willBeMovable:!1}),await(0,g.handleHexCaptured)(this.scene,e,!1),this.goToNextMode())}goToNextMode(){this.buyAnother?(this.scene.uiScene.grabNewPawnFromShop(this.buyingPawn),this.scene.setMode(new w(this.scene,this.buyingPawn))):this.scene.setMode(new n.PlayMode(this.scene))}canAffordAnother(){return u.inject.gameStateModel.economy.treasuryOf(p.app.screen.play.selectedRegion)>=2*u.inject.gameStateModel.rules.pawns(this.buyingPawn).cost}handleNewHexUnderCursor(e){(0,c.updateHighlightWhileMovingPawn)(this.scene,e,this.buyingPawn,p.app.screen.play.selectedRegion)}handleAbort(){u.inject.events.trigger(s.UserActions.ReturnHeldPawn())}canReturnPawn(){return!0}doHandleEvent(e){return(0,m.doHandleEvent)(this,e)}}t.BuyingPawnMode=w},93195:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateHighlightWhileMovingPawn=t.MovingPawnMode=void 0;const s=i(58257),n=i(91025),a=i(76909),o=i(55531),r=i(48500),c=i(42297),l=i(20666),d=i(78179),h=i(81363),u=i(12678),p=i(78336),g=i(6914),m=i(5715),y=i(88865),f=i(58592),w=i(41855),v=i(30093),b=r.logger.for("MovingPawnMode");class S extends o.BaseMode{constructor(e,t,i){super(e),this.movingPawn=t,this.wasTouch=i,this.name="MovingPawn",this.isDraggingPawn=!0,this.isTouchMode=!1}activate(){f.app.scene.worldMap.cameraController.stopDragScroll(),this.originHex=this.movingPawn.hex,this.wasTouch||this.initPawnHolder(),f.app.scene.worldMap.overlays.set(y.inject.currentGameState,v.OverlayModes.playing({holdingPawnType:this.movingPawn.type,selectedPawnId:this.movingPawn.id,selectedRegionId:this.movingPawn.region.id})),x(this.scene,this.movingPawn.hex,this.movingPawn,this.movingPawn.region),f.app.tooltips.close()}deactivate(){super.deactivate(),f.app.scene.playUI.updateHeldPawnData(null),f.app.scene.worldMap.pawns.getById(this.movingPawn.id)?.clearHighlight(),this.scene.uiScene.pawnHolder.clear()}canDropPawn(e){return!0}handleReturnPawn(){const e=this.movingPawn;u.assert.defined(e),this.dropPawnAt(e.hex.id,!0).then((()=>{this.scene.mode!==this&&this.scene.mode instanceof S&&this.scene.mode.movingPawn.id===e.id||(f.app.scene.worldMap.pawns.show(e.id),f.app.scene.worldMap.pawns.clearHangingPawn())})),this.scene.setMode(new a.PlayMode(this.scene))}isHexInteractive(e){return!0}handleStartInteraction(e){this.isDraggingPawn||f.app.scene.worldMap.cameraController.startDragScroll()}handleCompleteInteraction(e,t){this.isDraggingPawn?t&n.PointerEventFlags.Touch&&(this.isTouchMode=!0,this.highlightMovingPawn()):(f.app.scene.worldMap.cameraController.stopDragScroll(),this.tryMovePawnTo(e)),this.isDraggingPawn=!1}highlightMovingPawn(){f.app.scene.worldMap.pawns.show(this.movingPawn.id),f.app.scene.worldMap.overlays.pawnBacklight.set(this.movingPawn.hex,{color:m.Colors.highlight.ownedRegion,width:20}),f.app.scene.playUI.pawnHolder.heldPawnImage?.setVisible(!1),f.app.scene.worldMap.pawns.getById(this.movingPawn.id)?.setHighlight(g.Highlight.SelectedForMove)}handleEndDrag(e){this.isDraggingPawn?this.tryMovePawnTo(e)||y.inject.events.trigger(n.UserActions.ReturnHeldPawn()):f.app.scene.worldMap.cameraController.stopDragScroll()}handleStartDrag(e){this.isDraggingPawn?this.wasTouch&&this.initPawnHolder():f.app.scene.worldMap.cameraController.startDragScroll()}initPawnHolder(){if(f.app.scene.playUI.activeUI.pawnHolder.heldPawn)return;const e=f.app.scene.worldMap.getPawnObjectPositionOnScreen(this.originHex.id);f.app.scene.playUI.activeUI.pawnHolder.pickUpPawn(this.movingPawn.type,e.x,e.y,e.scale),f.app.scene.worldMap.pawns.hide(this.movingPawn.id)}tryMovePawnTo(e){const t=this.movingPawn,i=this.movingPawn.region;if(u.assert.defined(t),u.assert.defined(i),!e)return!1;if(t.hex===e)return y.inject.events.trigger(n.UserActions.ReturnHeldPawn()),!0;{const s=y.inject.gameStateModel.warfare.getDropPawnResult(e,this.movingPawn.type,i);switch(s.type){case c.DropPawnResultType.Reposition:case c.DropPawnResultType.EradicatePest:case c.DropPawnResultType.Combine:case c.DropPawnResultType.Conquest:return this.dropPawnAt(e.id,s.type===c.DropPawnResultType.Reposition),y.inject.gameStateController.executePlay(n.Plays.MovePawn({pawnId:t.id,destinationHexId:e.id,tapUnit:!1})),this.scene.setMode(new a.PlayMode(this.scene)),f.app.audio.playEffect(h.SoundEffects.Drop),!0;case c.DropPawnResultType.Invalid:return f.app.audio.playEffect(h.SoundEffects.Deny),s.reason===c.InvalidDropPawnReason.PreventedByPawn&&(f.app.scene.worldMap.pawns.transitions.defendTile(e,s.blockers),f.app.notifications.movePreventedByPawn(this.movingPawn.type,s.blockers),f.app.tooltips.showDefenderTaunt(e,this.movingPawn.type,s.blockers[0])),!1}}}async dropPawnAt(e,t){await this.scene.dropHeldPawnAtHex({hexId:e,willBeMovable:t})}async handleHexCaptured(e){this.movingPawn.id===e.capturingPawnId?(this.dropPawnAt(e.capturedHexId,!1),u.assert.defined(e.originatingHexId),(0,p.handleHexCaptured)(this.scene,e),this.scene.setMode(new a.PlayMode(this.scene))):b.warning(`ignoring hexCaptured as the capturing pawn ${e.capturingPawnId} doesn't match the currently held pawn ${this.movingPawn}`)}handlePawnInShopPointerUp(e){const t=y.inject.gameStateModel,i=t.rules.pawns(this.movingPawn.type).mergeRules[e],s=this.movingPawn.hex;f.app.scene.worldMap.pointersTracker.clear(),i?(this.scene.uiScene.pawnHolder.setPawnType(i),this.isDraggingPawn=!1,f.app.scene.worldMap.overlays.set(y.inject.currentGameState,v.OverlayModes.playing({holdingPawnType:i,selectedRegionId:f.app.screen.play.selectedRegion.id})),f.app.audio.playEffect(h.SoundEffects.Drop),y.inject.gameStateController.executePlay(n.Plays.BuyPawn({pawnType:e,buyerRegionId:this.movingPawn.region.id,destinationHexId:this.movingPawn.hex.id,tapUnit:!1})),this.movingPawn=t.warfare.getOccupyingUnit(s)):(f.app.audio.playEffect(h.SoundEffects.Deny),this.isDraggingPawn&&y.inject.events.trigger(n.UserActions.ReturnHeldPawn()))}async handlePawnBought(e){f.app.scene.worldMap.pawns.getById(this.movingPawn.id)?.visible,y.inject.ui.withoutTransitions((async()=>{await super.handlePawnBought(e)})),f.app.device.isUsingTouch()?this.highlightMovingPawn():f.app.scene.worldMap.pawns.hide(this.movingPawn.id),f.app.scene.playUI.updateHeldPawnData({context:"moving",cost:0,upkeep:0,name:this.movingPawn.type})}handleNewHexUnderCursor(e){x(this.scene,e,this.movingPawn,this.movingPawn.region),this.wasTouch&&this.isDraggingPawn&&e&&e!==this.originHex&&this.initPawnHolder()}handleAbort(){y.inject.events.trigger(n.UserActions.ReturnHeldPawn())}canReturnPawn(){return!0}doHandleEvent(e){return(0,w.doHandleEvent)(this,e)}}function x(e,t,i,n){if(!t)return void e.worldMapScene.overlays.hexMarkers.clearHoveredHex();let a,o;t&&f.app.scene.worldMap.overlays.conquerableHexesHighlight.has(t.id)?(e.worldMapScene.overlays.conquerableHexesHighlight.setHighlightedHex(t),e.worldMapScene.overlays.attitudeEmojis.setFocusedHex(t)):(e.worldMapScene.overlays.conquerableHexesHighlight.clearHighlightedHex(),e.worldMapScene.overlays.attitudeEmojis.setFocusedHex(void 0)),i instanceof s.PawnModel?(a=i,o=a.type):o=i;const r=y.inject.gameStateModel;u.assert.defined(n);const h=r.warfare.getDropPawnResult(t,o,n),p=r.rules.pawns(o).hasTrait(l.PawnTraits.GuardsAdjacentTiles);let g=d.HexGroup.empty;p&&(g=n.hexes.neighboursOf(t).filter((e=>!r.warfare.isOccupied(e)||e===a?.hex))),t==a?.hex||h.type===c.DropPawnResultType.Reposition||h.type===c.DropPawnResultType.Conquest?e.worldMapScene.overlays.hexMarkers.setHoveredHex(t,r.rules.pawns(o).might,g):e.worldMapScene.overlays.hexMarkers.clearHoveredHex()}t.MovingPawnMode=S,t.updateHighlightWhileMovingPawn=x},53094:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PassiveMode=void 0;const s=i(55531),n=i(41855);class a extends s.BaseMode{constructor(e){super(e),this.name="Passive"}isReadyForMoreGameEvents(){return!1}doHandleEvent(e){return(0,n.doHandleEvent)(this,e)}}t.PassiveMode=a},76909:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayMode=void 0;const s=i(93195),n=i(55531),a=i(28914),o=i(81363),r=i(91025),c=i(30420),l=i(12678),d=i(48500),h=i(20666),u=i(92578),p=i(6810),g=i(78336),m=i(83081),y=i(88865),f=i(58592),w=i(77821),v=i(47610),b=i(41855),S=i(30093),x=d.logger.for("PlayMode");class T extends n.BaseMode{constructor(){super(...arguments),this.name="Play",this.autoAttackUnit=void 0}activate(){y.inject.ui.transitionsSpeed.set(w.TransitionsSpeed.Fast),f.app.scene.worldMap.overlays.set(y.inject.currentGameState,S.OverlayModes.playing({selectedRegionId:f.app.screen.play.selectedRegion?.id})),f.app.scene.playUI.updateFromGameState(y.inject.currentGameState,"play"),y.inject.config.debug.overlay||y.inject.gameStateModel.stateEngine.suspend(...v.EXPENSIVE_AI_PROJECTIONS)}canPickupPawn(e){return!!this.getMovablePawnAtHex(e)||!!this.getRichTownAtHex(e)}canEndTurn(){return!0}getRichTownAtHex(e){const t=y.inject.gameStateModel.regions.byHex(e);if(t&&t===f.app.screen.play.selectedRegion&&t.faction===y.inject.gameStateModel.currentPhase.faction&&!((t.treasury||0)<m.CHEAPEST_UNIT_COST))return!!y.inject.gameStateModel.pawns.byHex(e,c.PawnType.Town)}handleStartInteraction(e,t){if(!e)return void f.app.scene.worldMap.cameraController.startDragScroll();const i=this.getMovablePawnAtHex(e),n=this.getRichTownAtHex(e);i?(f.app.audio.playEffect(o.SoundEffects.Grab),this.selectRegionByHex(e),f.app.scene.playUI.updateHeldPawnData({name:i.type.toString(),cost:i.cost,upkeep:i.upkeep,context:"moving"}),this.scene.setMode(new s.MovingPawnMode(this.scene,i,!!(t&r.PointerEventFlags.Touch))),y.inject.events.trigger(r.UiEvents.PawnPickedUp({hexId:e.id,pawnType:i.type}))):n?(f.app.audio.playEffect(o.SoundEffects.Grab),this.scene.uiScene.grabNewPawnFromTown(c.PawnType.Villager,e),this.selectRegionByHex(e),this.scene.setMode(new a.BuyingPawnMode(this.scene,c.PawnType.Villager))):f.app.scene.worldMap.cameraController.startDragScroll()}isHexInteractive(e){return!0}selectRegionByHex(e){const t=y.inject.gameStateModel,i=t.regions.byHex(e),s=f.app.screen.play.selectedRegion,n=e&&f.app.scene.worldMap.overlays.conquerableHexesHighlight.has(e.id);let a=!1;return s&&n?(this.findAutoAttacker(e),this.autoAttackUnit?(f.app.audio.playEffect(o.SoundEffects.Drop),t.regions.byHex(e)===this.autoAttackUnit.region?(y.inject.gameStateController.executePlay(r.Plays.MovePawn({pawnId:this.autoAttackUnit.id,destinationHexId:e.id,tapUnit:!1})),this.clearAutoAttacker()):y.inject.gameStateController.executePlay(r.Plays.MovePawn({pawnId:this.autoAttackUnit.id,destinationHexId:e.id,tapUnit:!1})),a=!0):x.warning(`hex ${e} highlighted as conquerable but could not find any suitable attacker unit`)):i?.isControllable()?i!==s&&(f.app.screen.play.selectRegion(i?.id),a=!0):i?.isAlive()?f.app.screen.play.selectedRegion!==i&&(f.app.screen.play.selectRegion(i?.id),a=!0):f.app.screen.play.selectedRegion&&f.app.screen.play.selectRegion(void 0),a}handleCompleteInteraction(e){e&&(f.app.scene.worldMap.cameraController.stopDragScroll(),this.selectRegionByHex(e)?f.app.tooltips.close():f.app.tooltips.toggleHexTooltip(e))}handleStartDrag(e){f.app.scene.worldMap.cameraController.startDragScroll()}handleEndDrag(e){f.app.scene.worldMap.cameraController.stopDragScroll()}async handleHexCaptured(e){e.originatingHexId&&this.clearAutoAttacker(),await(0,g.handleHexCaptured)(this.scene,e),this.clearAutoAttacker()}handlePawnInShopPointerDown(e){this.scene.uiScene.grabNewPawnFromShop(e),this.scene.setMode(new a.BuyingPawnMode(this.scene,e))}getMovablePawnAtHex(e){return y.inject.gameStateModel.pawns.byHex(e).find((e=>y.inject.gameStateModel.currentPhase.isMovable(e)))}handleNewHexUnderCursor(e){const t=f.app.screen.play.selectedRegion,i=e&&f.app.scene.worldMap.overlays.conquerableHexesHighlight.has(e.id);if(f.app.tooltips.close(),e&&!f.app.game.device.input.touch&&f.app.tooltips.showHexTooltip(e),f.app.game.device.input.touch)this.clearAutoAttacker();else if(e&&this.getMovablePawnAtHex(e)){const t=this.getMovablePawnAtHex(e);this.scene.worldMapScene.pawns.setHangingPawn(t.id),this.scene.input.setDefaultCursor("pointer"),this.clearAutoAttacker()}else if(t&&i)this.scene.input.setDefaultCursor("pointer"),this.scene.worldMapScene.pawns.clearHangingPawn(),this.findAutoAttacker(e);else{this.scene.worldMapScene.pawns.clearHangingPawn();const i=e&&y.inject.gameStateModel.regions.byHex(e);i&&i!==t&&i.isAlive()||e&&f.app.scene.worldMap.overlays.pawnSymbols.byHex(e).find((e=>e.type===p.PawnSymbolType.Warning||e.type===p.PawnSymbolType.Alert))?this.scene.input.setDefaultCursor("pointer"):this.scene.input.setDefaultCursor("default"),this.clearAutoAttacker()}}findAutoAttacker(e){const t=f.app.screen.play.selectedRegion,i=y.inject.gameStateModel,s=i.factions.byHex(e)===i.currentPhase.faction?0:i.warfare.getHexDefense(e)+1;l.assert.defined(t);const n=t.getMovableUnitsByMight().getOneWithMightAtLeast(s);if(!n)return x.warning(`incorrectly thought I could conquer hex ${e} - is among conquerable hexes but i cannot gather ${s}  might from ${t}`),this.clearAutoAttacker();const a=i.pawns.findClosest(e,t.hexes,(e=>e.hasTrait(h.PawnTraits.Unit)&&e.isMovable()&&e.might===n));return a?(this.scene.worldMapScene.overlays.conquerableHexesHighlight.setHighlightedHex(e,a.type),this.scene.worldMapScene.overlays.pawnSymbols.clear(p.PawnSymbolType.Arrow),this.scene.worldMapScene.overlays.pawnSymbols.add(a.id,p.PawnSymbolType.Arrow,""),this.setAutoAttacker(a,e)):(x.warning(`failed to locate unit with might ${n} in the region => RegionMight projection appears to contain invalid data! `),this.clearAutoAttacker())}setAutoAttacker(e,t){this.autoAttackUnit=e,this.scene.worldMapScene.overlays.attitudeEmojis.setFocusedHex(t)}clearAutoAttacker(){this.scene.worldMapScene.overlays.conquerableHexesHighlight.clearHighlightedHex(),this.scene.worldMapScene.overlays.pawnSymbols.clear(p.PawnSymbolType.Arrow),this.scene.worldMapScene.overlays.attitudeEmojis.setFocusedHex(void 0)}async handlePawnMoved(e){await super.handlePawnMoved(e),e.mergedWith&&f.app.scene.worldMap.overlays.update(e.worldUpdates.stateAfter)}handleEndTurn(e=!1){this.scene.worldMapScene.overlays.pawnSymbols.clear(p.PawnSymbolType.Alert),this.scene.worldMapScene.overlays.pawnSymbols.clear(p.PawnSymbolType.Warning),f.app.worldNews.clear(),f.app.tooltips.close(),this.scene.setMode(new u.SpectatorMode(this.scene)),setTimeout((()=>y.inject.gameStateController.executePlay(r.Plays.EndTurn())),y.inject.config.screenTransitionDuration)}doHandleEvent(e){return(0,b.doHandleEvent)(this,e)}}t.PlayMode=T},14917:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RewindMode=void 0;const s=i(55531),n=i(34758),a=i(88865),o=i(58592),r=i(91025),c=i(48500),l=i(96486),d=i(99896),h=i(62977),u=i(98778),p=i(16310),g=i(41959),m=i(30093),y=c.logger.for("RewindMode");class f extends s.BaseMode{constructor(e){super(e),this.name="Rewind",this.observe.event(r.UserActions.RewindForward,(()=>{this.isOnTurnEnd()?this.moveCursor((e=>{e.stepForward()&&(e.seekForwardTag("turnStart",1)||e.stepBack())})):this.moveCursor((e=>{e.seekForward((e=>1!==e.activeFaction))?e.stepBack():e.goToLastStep()}))})),this.observe.event(r.UserActions.RewindBack,(()=>{y.warning("RewindBack",this.isOnTurnStart()),this.isOnTurnStart()?this.moveCursor((e=>{0!==e.currentIndex&&(e.stepBack(),e.seekBackTag("turnStart",1),e.seekForward((e=>1!==e.activeFaction)),e.stepBack())})):this.moveCursor((e=>{0!==e.currentIndex&&e.seekBackTag("turnStart",1)}))})),this.observe.event(r.UserActions.RewindStepForward,(()=>{this.moveCursor((e=>{e.stepForward(),e.seekForwardFaction(1)||e.stepBack()}))})),this.observe.event(r.UserActions.RewindStepBack,(()=>{this.moveCursor((e=>{e.stepBack(),e.seekBackFaction(1)||e.stepForward()}))}))}isOnTurnStart(){return this.scene.cursor.currentStep.tags.has("turnStart")&&1===this.scene.cursor.currentStep.activeFaction}isOnTurnEnd(){const e=this.scene.cursor.nextStep;return!e||(0,n.isEvent)(e.play,r.Plays.EndTurn)}moveCursor(e){e(this.scene.cursor),o.app.scene.worldMap.syncState(this.scene.cursor.currentState,m.OverlayModes.spectating()),this.refreshPlayUI()}activate(){super.activate(),this.scene.worldMapScene.pawns.clearAllJumping(),o.app.scene.worldMap.overlays.set(this.scene.cursor.currentState,m.OverlayModes.spectating()),this.scene.uiScene.updateState({layout:{name:"rewind",label:"?",guidelineLabel:"?",canGoForward:!1,canGoBack:!1,lives:0,burningLife:!1}}),this.moveCursor((e=>{1!==d.CurrentPhase.getFaction(e.currentState)||(e.seekBackTag("turnStart",1),e.stepBack()),e.seekBackFaction(1)})),this.refreshPlayUI()}deactivate(){super.deactivate()}refreshPlayUI(){const e=(0,u.getLivesAdjustmentAfterRewind)(a.inject.currentGameState,this.scene.cursor.currentState);let t="refill"===e?p.DEFAULT_LIVES_PER_LEVEL:a.inject.ui.session.remainingLives;o.app.scene.playUI.updateRewindLayout({label:this.getLabel(),canGoBack:this.canGoBack(),canGoForward:this.canGoForward(),lives:t,guidelineLabel:this.getGuidelineLabel(),burningLife:"burn-one"===e}),o.app.scene.playUI.updatePowerBalanceFromGameState(this.scene.cursor.currentState)}canGoBack(){const e=this.scene.cursor.clone();return e.stepBack()&&e.seekBackFaction(1)}canGoForward(){const e=this.scene.cursor.clone();return e.stepForward()&&e.seekForwardFaction(1)}getLabel(){const e=this.scene.cursor.currentState,t=d.CurrentPhase.getTurnNumber(e),i=a.inject.gameStateModel.currentPhase.turnNumber;if(!this.scene.cursor.nextStep)return"Present";const s=i===t?"this turn":`turn ${t}`;return this.isOnTurnStart()?`Start of ${s}`:this.isOnTurnEnd()?`End of ${s}`:(0,l.capitalize)(s)}isHexInteractive(e){return!0}handleStartDrag(e){o.app.scene.worldMap.cameraController.startDragScroll()}handleEndDrag(e){o.app.scene.worldMap.cameraController.stopDragScroll()}canEndTurn(){return!0}handleStartInteraction(e,t){const i=(0,g.getCurrentGameStateModel)().regions;e&&i.byHex(e)?.faction?.isLocalPlayer()?(a.inject.events.trigger(r.UserActions.ConfirmRewind()),this.scene.mode.handleStartInteraction(e,t)):o.app.scene.worldMap.cameraController.startDragScroll()}handleNewHexUnderCursor(e){const t=e&&this.getMovablePawnAtHex(e);t?(this.scene.worldMapScene.pawns.setHangingPawn(t.id),this.scene.input.setDefaultCursor("pointer")):this.scene.worldMapScene.pawns.clearHangingPawn()}getMovablePawnAtHex(e){const t=this.scene.cursor.currentState;return h.Pawns.model(t).byHex(e).find((e=>d.CurrentPhase.isMovable(t,e.id)))}async doHandleEvent(e){y.warning(`Ignoring event ${e.name} in RewindMode`)}getGuidelineLabel(){return this.scene.cursor.hasNext()?"select your province to confirm rewind":"select your province to cancel rewind"}}t.RewindMode=f},92578:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateTransitionSpeedForSpectatorMode=t.SpectatorMode=void 0;const s=i(55531),n=i(5427),a=i(42526),o=i(78179),r=i(34758),c=i(88865),l=i(58592),d=i(60807),h=i(91025),u=i(93311),p=i(41855),g=i(48500),m=i(34394),y=i(54444),f=i(76909),w=i(96486),v=i(99896),b=i(22378),S=i(81363),x=i(41959),T=i(30093);var P;!function(e){e.Playback="playback",e.Idle="idle",e.Skipping="skipping"}(P||(P={}));const M=g.logger.for("SpectatorMode");class I extends s.BaseMode{constructor(e,t=n.SpectatingContext.Live){super(e),this.context=t,this.name="Spectator",this.state=P.Idle,this.requestedPlays=!0,this.focusedRegions=[],this.observe.event(h.UserActions.GoToPreviousTurn,(()=>this.moveCursor((e=>{e.stepBack(),e.seekBackTag("turnStart",1)})))),this.observe.event(h.UserActions.GoToNextTurn,(()=>this.moveCursor((e=>{e.stepForward(),e.seekForwardTag("turnStart",1)})))),this.observe.event(h.UserActions.GoToStart,(()=>this.moveCursor((e=>{e.goTo(0)})))),this.observe.event(h.UserActions.GoToEnd,(()=>this.moveCursor((e=>{e.goToLastStep()}))))}get paused(){return c.inject.ui.spectatingSpeed()===c.SpectatingPlaybackSpeed.Paused}moveCursor(e){this.canceled()||(c.inject.events.trigger(h.UserActions.SetSpectatingPlayBackSpeed(c.SpectatingPlaybackSpeed.Paused)),e(this.scene.cursor),l.app.scene.worldMap.syncState(this.scene.cursor.currentState,T.OverlayModes.spectating()),this.refreshPlayUI())}activate(){super.activate(),A(c.inject.ui.spectatingSpeed()),this.scene.worldMapScene.pawns.clearAllJumping(),this.scene.uiScene.updateState({layout:{name:"spectate",spectatingContext:this.context,enableSkipSpectating:this.context!==n.SpectatingContext.ReplayOnly,enableDownloadReplay:this.context===n.SpectatingContext.LiveReplay,spectatingSpeed:c.inject.ui.spectatingSpeed(),spectatingTurnNumber:(0,x.getCurrentGameStateModel)().currentPhase.turnNumber}}),l.app.scene.worldMap.overlays.set((0,x.getCurrentGameStateModel)().state,T.OverlayModes.spectating()),this.cameraPreset=l.app.scene.worldMap.cameraController.savePreset(),this.selectedRegionIdPreset=c.inject.ui.session.selectedRegionId,this.spectatingSpeedPreset=c.inject.ui.spectatingSpeed(),this.context===n.SpectatingContext.LiveReplay?c.inject.events.trigger(h.UserActions.SetSpectatingPlayBackSpeed(c.SpectatingPlaybackSpeed.Normal)):this.context===n.SpectatingContext.ReplayOnly?c.inject.events.trigger(h.UserActions.SetSpectatingPlayBackSpeed(c.SpectatingPlaybackSpeed.Paused)):c.inject.events.trigger(h.UserActions.SetSpectatingPlayBackSpeed(c.inject.userData.recallChoice("spectatingSpeed")||c.SpectatingPlaybackSpeed.Normal)),this.refreshPlayUI(),this.eventListener=c.inject.ui.spectatingSpeed.watch(((e,t)=>{t===c.SpectatingPlaybackSpeed.Paused&&e!==c.SpectatingPlaybackSpeed.Paused&&this.state===P.Idle&&this.playNext()}))}deactivate(){super.deactivate(),this.eventListener?.unsubscribe(),d.track.spectatingOver({spectating_speed:this.state===P.Skipping?0:c.inject.ui.spectatingSpeed()}),this.state===P.Skipping&&(l.app.scene.worldMap.syncState(c.inject.currentGameState,T.OverlayModes.spectating()),l.app.scene.playUI.updateFromGameState()),l.app.scene.worldMap.cameraController.panTo(this.cameraPreset,300),this.context===n.SpectatingContext.ReplayOnly&&c.inject.events.trigger(h.UserActions.SetSpectatingPlayBackSpeed(this.spectatingSpeedPreset)),this.context===n.SpectatingContext.LiveReplay&&(c.inject.events.trigger(h.UserActions.SetSpectatingPlayBackSpeed(this.spectatingSpeedPreset)),this.selectedRegionIdPreset&&l.app.screen.play.selectRegion(this.selectedRegionIdPreset,{clickEffect:!1,panCamera:!0}))}isLive(){return this.context===n.SpectatingContext.Live}async processEvents(e){[P.Idle,P.Skipping].includes(this.state)&&await this.playNext()}async playNext(){const e=this.scene.cursor;if(!this.paused&&this.isActive()){if(this.state===P.Skipping&&(e.hasNext()&&(this.requestedPlays=!1),this.processAllEvents(e)),!e.hasNext()){if(this.requestedPlays)return;const t=e.latestEvent;return this.isLive()&&(0,r.isEvent)(t,h.GameStateEvents.FactionTurnStarted)&&(this.requestedPlays=!0,(0,m.handleFactionTurnStarted)({state:e.currentState,factionId:t.payload.factionId})),(0,r.isEvent)(t,h.GameStateEvents.GameOver)&&this.context!==n.SpectatingContext.ReplayOnly&&(this.context===n.SpectatingContext.Live?c.inject.events.trigger(h.SystemEvents.ShowGameOverScreen(1===t.payload.winningFactionId?b.LevelOutcome.Victory:b.LevelOutcome.Defeat)):c.inject.events.trigger(h.UserActions.ExitSpectatingMode({returnTo:1===t.payload.winningFactionId?"victoryScreen":"defeatScreen"}))),void(this.context===n.SpectatingContext.LiveReplay?this.scene.setMode(new f.PlayMode(this.scene)):this.context===n.SpectatingContext.ReplayOnly&&(c.inject.ui.spectatingSpeed.set(c.SpectatingPlaybackSpeed.Paused),this.setFocus(e.currentState,[],[])))}for(this.requestedPlays=!1,this.setState(P.Playback);e.hasNext()&&this.state===P.Playback&&!this.paused;){const t=C(e);if(this.refreshPlayUI(),t){await this.executeScreenPlay(t);break}}this.setState(P.Idle),await this.processEvents(e)}}refreshPlayUI(){const e=this.scene.cursor.currentState,t=c.inject.gameStateController.history.latestState;l.app.scene.playUI.updateState({turnNumber:v.CurrentPhase.getTurnNumber(t)}),l.app.scene.playUI.updateSpectatingLayout({spectatingTurnNumber:v.CurrentPhase.getTurnNumber(e)}),l.app.scene.playUI.updatePowerBalanceFromGameState(e)}setState(e){this.state!==P.Skipping&&(this.state=e)}async executeScreenPlay(e){if(e.forceFullSync)return l.app.scene.worldMap.syncState(e.forceFullSync,T.OverlayModes.spectating()),l.app.audio.playEffect(S.SoundEffects.Rewind),void await this.setFocus(e.forceFullSync,e.focusRegions,e.highlightHexes);for(let t of e.worldUpdates)if(await this.setFocus(t.stateBefore,e.focusRegions,e.highlightHexes),await(0,y.withTimeout)(this.scene,l.app.scene.worldMap.play(t),3e3)===y.TIMEOUT&&this.isProcessingEvents)return M.warning("ScreenPlay execution timeout!"),this.handleSkipSpectating(),void this.playNext();if(this.isLive())for(let t of e.gameEvents)l.app.worldNews.handle(t)}canceled(){return!this.isActive()||this.state===P.Skipping}async setFocus(e,t,i){const s=t.length&&!(0,w.isEqual)(t,this.focusedRegions);this.focusedRegions=t;const n=l.app.scene.worldMap,r=o.HexGroup.fromIds(i),d=c.inject.userData.recallChoice("cameraFollow")!==b.CameraFollowPreset.Off;n.overlays.set(e,T.OverlayModes.spectating({highlightHexes:r,highlightRegions:t})),d&&r.length>0&&await n.cameraController.ensureRectVisible((0,a.rectToPhaser)(r.getDisplayBoundingBox()),{allowZoom:c.inject.userData.recallChoice("cameraFollow")===b.CameraFollowPreset.On}),s&&await(0,y.sleep)(function(e){switch(e){case c.SpectatingPlaybackSpeed.Paused:case c.SpectatingPlaybackSpeed.UltraFast:return 0;case c.SpectatingPlaybackSpeed.Fast:return 250;case c.SpectatingPlaybackSpeed.Normal:return 500}}(c.inject.ui.spectatingSpeed()))}handleSkipSpectating(){this.setState(P.Skipping),this.paused&&c.inject.events.trigger(h.UserActions.SetSpectatingPlayBackSpeed(c.SpectatingPlaybackSpeed.Normal)),this.isProcessingEvents=!1,this.processEvents(this.scene.cursor)}isReadyForMoreGameEvents(){return c.inject.ui.spectatingSpeed()!==c.SpectatingPlaybackSpeed.Paused&&super.isReadyForMoreGameEvents()}isHexInteractive(e){return!1}handleStartDrag(e){l.app.scene.worldMap.cameraController.startDragScroll()}handleEndDrag(e){l.app.scene.worldMap.cameraController.stopDragScroll()}handleEndTurn(){c.inject.events.trigger(h.UserActions.SkipSpectating())}canEndTurn(){return!0}doHandleEvent(e){return(0,p.doHandleEvent)(this,e)}processAllEvents(e){if(this.isLive())for(;e.hasNext();){const t=e.consumeNextPlay();for(let e of t)l.app.worldNews.handle(e)}else e.goToLastStep()}}function A(e){c.inject.ui.transitionsSpeed.set(function(e){switch(e){case c.SpectatingPlaybackSpeed.Paused:return 0;case c.SpectatingPlaybackSpeed.UltraFast:return 300;case c.SpectatingPlaybackSpeed.Fast:return 450;case c.SpectatingPlaybackSpeed.Normal:return 600}}(e))}function C(e){if(c.inject.ui.spectatingSpeed()!==c.SpectatingPlaybackSpeed.Paused){if((0,r.isEvent)(e.peekNextEvent(),h.GameStateEvents.NewGameState)){e.stepForward();const t=e.currentStepEvents[0];return{gameEvents:[t],highlightHexes:[],focusRegions:[],affectedRegions:[],worldUpdates:[],forceFullSync:t.payload.state}}switch(c.inject.ui.spectatingSpeed()){case c.SpectatingPlaybackSpeed.UltraFast:return(0,u.groupByFactionsScreenWriter)(e);case c.SpectatingPlaybackSpeed.Fast:return(0,u.groupByRegionsScreenWriter)(e);case c.SpectatingPlaybackSpeed.Normal:return(0,u.playByPlayScreenwriter)(e)}}}t.SpectatorMode=I,t.updateTransitionSpeedForSpectatorMode=A},41855:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.doHandleEvent=void 0;const s=i(91025),n=i(58592),a=i(51833),o=i(48500),r=i(55415);o.logger.for("BaseMode"),t.doHandleEvent=async function(e,t){switch(t.name){case s.GameStateEvents.NewGameState.eventName:return(0,r.handleNewGameState)(n.app.scene.play,t.payload.state,t.payload.context);case s.GameStateEvents.GameOver.eventName:return(0,a.handleGameOver)(t.payload);case s.GameStateEvents.PawnBought.eventName:return e.handlePawnBought(t.payload);case s.GameStateEvents.FactionEconomyUpdated.eventName:return e.handleFactionEconomyUpdated(t.payload);case s.GameStateEvents.HexCaptured.eventName:return e.handleHexCaptured(t.payload);case s.GameStateEvents.PawnMoved.eventName:return e.handlePawnMoved(t.payload);case s.GameStateEvents.FactionTurnOver.eventName:return e.handleFactionTurnOver(t.payload);case s.GameStateEvents.CutOffUnitsTurnedBandits.eventName:return e.handleCutOffUnitsTurnedBandits(t.payload)}}},28091:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleFactionEconomyUpdated=void 0;const s=i(30420),n=i(47613),a=i(58592),o=i(39710),r=i(88865);t.handleFactionEconomyUpdated=async function(e,t){if(r.inject.gameStateModel.factions.byId(t.factionId)?.controller===s.FactionController.LocalUser&&t.regionReports.length>0){const e=t.regionReports.map((e=>e.coinTransfers)).reduce(o.mergeTransactions);a.app.scene.worldMap.coins.play(e),t.regionReports.forEach((e=>{a.app.scene.worldMap.play(e.worldUpdates)}))}else t.regionReports.forEach((e=>{a.app.scene.worldMap.coins.applyTransactions(e.coinTransfers),a.app.scene.worldMap.play(e.worldUpdates)}));const i=new n.StaticGameStateModel(t.stateAfter),c=t.regionReports.map((e=>i.regions.byId(e.regionId)));e.refreshTownVariantInRegions(c),e.worldMapScene.overlays.update(t.stateAfter),e.uiScene.updateFromGameState(t.stateAfter)}},51833:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleGameOver=void 0;const s=i(22378),n=i(88865),a=i(91025);t.handleGameOver=function(e){const t=1===e.winningFactionId?s.LevelOutcome.Victory:s.LevelOutcome.Defeat;n.inject.events.trigger(a.SystemEvents.ShowGameOverScreen(t))}},78336:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleHexCaptured=void 0;const s=i(88865),n=i(58592);t.handleHexCaptured=async function(e,t,i=!0){s.inject.ui.regionsLedger.refreshAvailableRegions(t.worldUpdates.stateAfter),e.uiScene.updateFromGameState(t.worldUpdates.stateAfter),e.uiScene.updatePowerBalanceFromGameState(t.worldUpdates.stateAfter);const a=n.app.scene.worldMap.play(t.worldUpdates);i&&await a}},87284:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handlePawnBought=void 0,t.handlePawnBought=async function(e,t){e.uiScene.updateFromGameState(t.worldUpdates.stateAfter),e.uiScene.updatePowerBalanceFromGameState(t.worldUpdates.stateAfter),await e.worldMapScene.play(t.worldUpdates)}},7841:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handlePawnMoved=void 0,t.handlePawnMoved=async function(e,t){await e.worldMapScene.play(t.worldUpdates),(t.eradicatedPest||t.mergedInto)&&(e.uiScene.updateFromGameState(t.worldUpdates.stateAfter),e.uiScene.updatePowerBalanceFromGameState(t.worldUpdates.stateAfter))}},90797:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBuyablePawnsConfig=t.BUYABLE_BUILDINGS=t.BUYABLE_UNITS=t.PlayUIScene=void 0;const s=i(11930),n=i(48500),a=i(30420),o=i(91025),r=i(12678),c=i(81363),l=i(5032),d=i(52048),h=i(48466),u=i(5427),p=i(68660),g=i(92109),m=i(14344),y=i(99896),f=i(68736),w=i(97866),v=i(82260),b=i(56872),S=i(50264),x=i(88865),T=i(58592),P=i(9603),M=i(82966),I=n.logger.for("PlayUIScene"),A=v.Input.Keyboard.KeyCodes;class C extends f.BaseUIScene{constructor(){super({key:s.Scenes.PlayUI}),this.currentState=u.DEFAULT_PLAY_UI_STATE,this.preUpdate=(0,w.whenDirty)((()=>{this.activeUI?.updateLayout()}))}get pawnHolder(){return this.activeUI.pawnHolder}create(){super.create(),this.observe.watch(x.inject.gameStateController.undoAvailable,(e=>{this.updatePlayLayout({undoAvailable:e})})),this.observe.watch(x.inject.ui.spectatingSpeed,(e=>{this.updateSpectatingLayout({spectatingSpeed:e})})),this.observe.watch(T.app.device.uiVariant,this.setControlsBasedOnScreenSize.bind(this)),this.observe.event(o.UserActions.OpenRollbackMenu,(()=>this.activeUI.openRollbackPanel())),this.setControlsBasedOnScreenSize(T.app.device.uiVariant()),this.bindKey(A.TAB,(()=>T.app.scene.play.afterEventsProcessed((()=>o.UserActions.SelectNextRegion())))),this.bindKey(A.ONE,(()=>T.app.scene.play.afterEventsProcessed((()=>o.UserActions.BuyablePawnPointerDown(a.PawnType.Villager))))),this.bindKey(A.TWO,(()=>T.app.scene.play.afterEventsProcessed((()=>o.UserActions.BuyablePawnPointerDown(a.PawnType.Pikeman))))),this.bindKey(A.THREE,(()=>T.app.scene.play.afterEventsProcessed((()=>o.UserActions.BuyablePawnPointerDown(a.PawnType.Knight))))),this.bindKey(A.FOUR,(()=>T.app.scene.play.afterEventsProcessed((()=>o.UserActions.BuyablePawnPointerDown(a.PawnType.Hero))))),this.bindKey(A.BACKSPACE,(()=>T.app.scene.play.afterEventsProcessed((()=>this.handleUndoHotkey())))),this.bindKey(A.BACKTICK,(()=>T.app.scene.play.afterEventsProcessed((()=>this.handleUndoHotkey())))),this.bindKey(A.E,(()=>o.UserActions.EndTurn({force:!0}))),this.arrowKeys=this.input.keyboard.addKeys({up:A.UP,down:A.DOWN,left:A.LEFT,right:A.RIGHT}),this.arrowKeys2=this.input.keyboard.addKeys({up:A.W,down:A.S,left:A.A,right:A.D}),x.inject.config.debug.overlay&&(this.bindKey(A.G,(()=>{x.inject.config.debug.ai=x.inject.ui.session.selectedRegionId??!1,x.inject.events.trigger(o.UserActions.EndTurn({force:!0}))})),this.bindKey(A.Y,(()=>{M.commands.debug.history()})),this.bindKey(A.SPACE,(()=>T.app.navigator.currentScreen===T.app.screen.mapEditor?o.UserActions.ResumeGame():o.UserActions.EditMap())))}handleUndoHotkey(){return x.inject.gameStateController.undoAvailable()===P.UndoAvailability.Available?(T.app.audio.playEffect(c.SoundEffects.ButtonUp),o.UserActions.Undo()):"play"===this.currentState.layout.name&&this.currentState.layout.showLevelSummary?(T.app.audio.playEffect(c.SoundEffects.ButtonUp),o.UserActions.OpenRollbackMenu()):void 0}updateState(e){this.currentState={...this.currentState,...e},this.activeUI.updateState(e)}updatePlayLayout(e){"play"===this.currentState.layout.name&&this.updateState({layout:{...this.currentState.layout,...e}})}updateSpectatingLayout(e){"spectate"===this.currentState.layout.name&&this.updateState({layout:{...this.currentState.layout,...e}})}updateRewindLayout(e){"rewind"===this.currentState.layout.name&&this.updateState({layout:{...this.currentState.layout,...e}})}setControlsBasedOnScreenSize(e){if(this.latestScreenSize!==e)switch(this.latestScreenSize=e,I.warning(`Updating controls to fit screen size "${e}"`),this.activeUI?.destroy(),e){case p.UiVariant.Compact:this.activeUI=new g.CompactPlayUI(this,this.currentState);break;case p.UiVariant.Large:this.activeUI=new h.LargePlayUI(this,this.currentState)}}update(e,t){super.update(e,t),this.activeUI?.update(),this.applyKeyboardScrolling(t)}applyKeyboardScrolling(e){const t=10*e,i=T.app.scene.worldMap.cameraController.scrollController;(this.arrowKeys.up.isDown||this.arrowKeys2.up.isDown)&&(T.app.tooltips.close(),i.cameraY.accelerate(-t)),(this.arrowKeys.down.isDown||this.arrowKeys2.down.isDown)&&(T.app.tooltips.close(),i.cameraY.accelerate(t)),(this.arrowKeys.left.isDown||this.arrowKeys2.left.isDown)&&(T.app.tooltips.close(),i.cameraX.accelerate(-t)),(this.arrowKeys.right.isDown||this.arrowKeys2.right.isDown)&&(T.app.tooltips.close(),i.cameraX.accelerate(t))}updateFromGameState(e=x.inject.currentGameState,t=this.currentState.layout.name){const i=l.Economy.model(e),s=(d.Rules.model(e),T.app.screen.play.selectedRegion),n=y.CurrentPhase.model(e),a=n.faction,o=x.inject.ui.regionsLedger.hasPendingRegions(),r=x.inject.ui.regionsLedger.availableRegions.some((t=>S.Regions.model(e).byId(t)?.isActionable())),c=n.turnNumber,h={turnNumber:c,livesLeft:x.inject.ui.session.remainingLives};if("play"===t){const t={name:"play",heldPawnData:null,regionData:null,undoAvailable:x.inject.gameStateController.undoAvailable(),showLevelSummary:c>1,activeFactionColor:a?.landColor||0,primaryButton:r?o?"nextRegion":"endTurn":"highlightEndTurn",enableNextRegion:x.inject.ui.regionsLedger.availableRegions.length>1,enableRollback:x.inject.gameStateController.rollbackAvailable&&x.inject.ui.session.remainingLives>0||x.inject.config.debug.cheats,enableReplay:x.inject.gameStateController.history.length>1};if(s?.exists){const n=i.treasuryOf(s);t.regionData={id:s.id,controllable:s.isControllable(),name:s.name,income:s.budget?.balance||0,treasury:n,buyablePawns:s.isControllable()?B(e,n):[],townLevel:s.getLevel()}}this.updateState({...h,layout:t})}else this.updateState({...h})}grabNewPawnFromShop(e){const t=this.getPawnXY(e);return r.assert.defined(t),this.grabNewPawnFrom(e,t.x,t.y),!0}getPawnXY(e){const t=this.activeUI.shoppingTray.getPawnXY(e);if(t)return{x:t.x+this.activeUI.shoppingTray.x,y:t.y+this.activeUI.shoppingTray.y}}grabNewPawnFromTown(e,t){const{x:i,y:s}=T.app.scene.worldMap.getPawnObjectPositionOnScreen(t.id);this.grabNewPawnFrom(e,i,s)}grabNewPawnFrom(e,t,i){if("play"!==this.currentState.layout.name)return void I.warning(`ignoring PlayUIScene.grabNewPawnFrom in ${this.currentState.layout.name} layout`);this.pawnHolder.pickUpPawn(e,t,i,1);const s=x.inject.gameStateModel.rules.pawns(e);this.updateHeldPawnData({name:e.toString(),cost:s.cost,upkeep:s.upkeep,context:"buying"}),this.activeUI.shoppingTray.setPawnTaken(e,b.TakenMode.Taken),T.app.audio.playEffect(c.SoundEffects.Grab)}updateHeldPawnData(e){"play"===this.currentState.layout.name?this.updateState({layout:{...this.currentState.layout,heldPawnData:e}}):I.warning(`ignoring PlayUIScene.updateHeldPawnData in ${this.currentState.layout.name} layout`)}returnPawnToShop(e,t){const i=this.activeUI.shoppingTray.getPawnXY(e);r.assert.defined(i),this.activeUI.shoppingTray.setPawnTaken(e,b.TakenMode.Returning),this.pawnHolder.dropPawn(this.activeUI.shoppingTray.x+i.x,this.activeUI.shoppingTray.y+i.y,1,(()=>{this.activeUI.shoppingTray.doneReturningPawn(e)})),t?.(),this.updateHeldPawnData(null),x.inject.events.trigger(o.UiEvents.PawnReturnedToShop())}restockPawnInShop(e,t=!1){t?this.activeUI.shoppingTray.setPawnTaken(e,b.TakenMode.NotTaken):this.activeUI.shoppingTray.restockPawn(e),this.updateHeldPawnData(null)}updatePowerBalanceFromGameState(e){const t=m.Factions.model(e).all().filter((e=>e.isAlive())).map((t=>({id:t.id,size:t.size,color:t.landColor,highlight:y.CurrentPhase.getFaction(e)===t.id})));this.updateState({powerBalance:t})}canBuyPawn(e){return"play"===this.currentState.layout.name&&this.currentState.layout.regionData?.buyablePawns.find((t=>t.pawnType===e))?.mode===b.BuyablePawnMode.Available}getTooltipFor(e){return this.activeUI.getTooltipFor(e)}getBottomPanelHeight(){return this.activeUI.getBottomPanelHeight()}}function B(e,i){const s=d.Rules.model(e);let n=[];for(let e of t.BUYABLE_UNITS.map((e=>s.pawns(e))).filter((e=>e.cost>0))){if(!(e.cost<=i)){n.push({pawnType:e.type,mode:b.BuyablePawnMode.Unaffordable,priceTag:e.cost});break}n.push({pawnType:e.type,mode:b.BuyablePawnMode.Available,priceTag:e.cost})}for(let e of t.BUYABLE_BUILDINGS.map((e=>s.pawns(e))).filter((e=>e.cost>0))){if(!(e.cost<=i)){n.push({pawnType:e.type,mode:b.BuyablePawnMode.Unaffordable,priceTag:e.cost});break}n.push({pawnType:e.type,mode:b.BuyablePawnMode.Available,priceTag:e.cost})}return n}t.PlayUIScene=C,t.BUYABLE_UNITS=[a.PawnType.Villager,a.PawnType.Pikeman,a.PawnType.Knight,a.PawnType.Hero],t.BUYABLE_BUILDINGS=[a.PawnType.Castle],t.getBuyablePawnsConfig=B},8141:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PowerBalanceRibbon=void 0;const s=i(3682),n=i(23441),a=i(48500),o=i(56996),r=i(70319),c=i(88865);a.logger.for("ui:PowerBalanceRibbon");class l extends r.ResponsiveContainer{constructor(e,t){super(e),this.props=t,this.currentState=[],this.colorBars=[],this.setPosition(t.x,t.y),this.height=o.RibbonTextures.ColorBar.height,this.backgroundBar=new s.ColorBar(this.scene,{x:0,y:0,width:t.width,color:9474192}),this.setSize(t.width,this.backgroundBar.height),this.add([this.backgroundBar])}setDimensions(e,t,i){return this.setPosition(e,t),this.backgroundBar.width=i,this.width=i,c.inject.ui.withoutTransitions((()=>{this.updateState(this.currentState)})),this}updateState(e){this.currentState=e;const t=function(e,t,i){if(0===e.length)return e;const s=t/e.reduce(((e,t)=>e+t.size),0);let a=e.map((e=>({...e,size:Math.floor(e.size*s)})));const o=a.filter((e=>e.size<i)),r=a.filter((e=>e.size>i));if(o.length&&r.length){const e=o.map((e=>i-e.size)).reduce(n.sum,0)/r.length;o.forEach((e=>e.size=i)),r.forEach((t=>t.size=Math.ceil(t.size-e)))}let c=t-a.reduce(((e,t)=>e+t.size),0);for(let e=0;c>0&&r.length>0;c--,e++)r[e%r.length].size+=1;return a}(e,this.width,this.props.minSize);let i=0;for(let e=0;e<t.length;++e){const n=t[e].size+(e===t.length-1?0:2);this.colorBars[e]?(this.colorBars[e].adjustSize.transitionTo(n),this.colorBars[e].adjustX.transitionTo(i),this.colorBars[e].adjustY.transitionTo(t[e].highlight?-2:0)):(this.colorBars[e]=new s.ColorBar(this.scene,{x:i,y:0,width:n}),this.colorBars[e].adjustY.setTo(t[e].highlight?-2:0),this.colorBars[e].adjustX.setTo(i),this.colorBars[e].adjustSize.setTo(n),this.add(this.colorBars[e]),this.colorBars[e].setVisible(!0)),this.colorBars[e].setTint(t[e].color),i+=t[e].size}this.colorBars.slice(t.length).map((e=>{e.destroy()})),this.colorBars.splice(t.length),this.preUpdate.makeDirty()}}t.PowerBalanceRibbon=l},74422:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionSummaryPopup=void 0;const s=i(86183),n=i(24917),a=i(5715),o=i(85912),r=i(70319),c=i(88865);var l=Phaser.GameObjects.BitmapText,d=Phaser.GameObjects.Image;const h=i(54444),u=i(82556);class p extends s.SmallPergamen{constructor(e){super(e),this.summary=new g(this.scene),this.setContent(this.summary),this.setDepth(u.WorldLayers.FlyingObject)}showOverRegion(e){const t=c.inject.gameStateModel.regions.byId(e);if(!t)return void this.hide();const i=c.inject.gameStateModel.economy.townHexesOf(t).members[0];if(!i)return;this.worldCoords={x:i.display.centerX,y:i.display.centerY},this.summary.updateFromRegion(t);const s=t.getEnemyAssets().getMaxAvailableMight(),n=c.inject.gameStateModel.rules.unitByMight(s);this.showAt(this.worldCoords.x,this.worldCoords.y+6,a.Colors.brighter(t.faction?.landColor??0,40),n&&`pawns/${n.type}`)}}t.RegionSummaryPopup=p;class g extends r.ResponsiveContainer{constructor(e){super(e),this.currentGoldText=new l(this.scene,0,0,n.BitmapFont.Mini,"0").setTint(a.Colors.glassUi.primaryText),this.balanceText=new l(this.scene,0,0,n.BitmapFont.Mini,"0").setTint(a.Colors.glassUi.primaryText),this.rightArrow=new d(this.scene,0,0,"atlas","ui/mini-icons/arrow-right").setTint(a.Colors.glassUi.primaryText),this.predictedGoldText=new l(this.scene,0,0,n.BitmapFont.MiniBold,"0").setTint(a.Colors.glassUi.primaryText),this.goldIcon=new d(this.scene,0,0,"atlas","ui/mini-icons/coins").setOrigin(0,0),this.add([this.currentGoldText,this.balanceText,this.rightArrow,this.predictedGoldText]),this.updateLayout()}updateFromRegion(e){const t=e.treasury,{balance:i,upkeep:s}=e.budget,n=i>=0?a.Colors.glassUi.primaryText:a.Colors.woodenUi.redText;this.currentGoldText.setText(t.toFixed(0)),this.balanceText.setText((0,h.withSign)(i));const o=t+i;this.rightArrow.setTint(n),this.predictedGoldText.setText(o.toFixed(0)).setTint(n),this.updateLayout()}updateLayout(){(0,o.layoutFromLeftToRight)(0,0,2,[this.currentGoldText,this.balanceText,this.rightArrow,this.predictedGoldText]),this.width=this.predictedGoldText.x+this.predictedGoldText.width,this.height=this.currentGoldText.height,(0,o.centerVertically)(this.rightArrow,0,0,this.height),(0,o.centerVertically)(this.goldIcon,0,0,this.height)}}},56872:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BuyablePawnGameObject=t.TakenMode=t.BuyablePawnMode=t.ShoppingTray=void 0;const s=i(48500),n=i(56996),a=i(5427),o=i(91025),r=i(46453),c=i(63637),l=i(70319),d=i(98534),h=i(5715),u=i(71234),p=i(1909),g=i(24917),m=i(50162),y=i(81363),f=i(99694),w=i(97119),v=i(38952),b=i(79773),S=i(88865),x=i(58592);var T=Phaser.GameObjects.Container,P=Phaser.Geom.Rectangle;const M=s.logger.for("ShoppingDesk");class I extends l.ResponsiveContainer{constructor(e,t){super(e),this.config=t,this.pawnSprites={},this.shadows=[],this.displayedPawns=[],this._openRef=(0,m.ref)(!1),this.activePawnBacklight=new b.PawnBacklight(this.scene,48).setTint(h.Colors.highlight.ownedRegion).setVisible(!1),this.yController=r.Control.propOf(this,"y",{duration:c.LARGE_PLAY_UI_LAYOUT.shoppingTray.panelTransitionsDuration}),this.cloth=new Phaser.GameObjects.Rectangle(e,0,0,this.config.width,56).setStrokeStyle(2,0,1).setOrigin(.5,0),this.setSize(this.config.width,this.cloth.height),this.cloth.setInteractive(),this.cloth.on("pointerdown",(()=>S.inject.events.trigger(o.UserActions.ShopAreaPointerDown()))),this.cloth.on("pointerup",(()=>S.inject.events.trigger(o.UserActions.ShopAreaPointerUp()))),this.config.style===a.ShoppingTrayStyle.Elaborate&&(this.tray=new n.Ribbon(e,n.RibbonTextures.UnitTray,-this.config.width/2,0,this.config.width),this.tray.setInteractive(),this.tray.on("pointerdown",(()=>S.inject.events.trigger(o.UserActions.ShopAreaPointerDown()))),this.tray.on("pointerup",(()=>S.inject.events.trigger(o.UserActions.ShopAreaPointerUp()))),this.closeButton=new d.MiniCloseButton(e,this.config.width/2-21,6).setTint(h.Colors.woodenUi.primaryText),this.closeButton.onClicked((()=>S.inject.events.trigger(o.UserActions.DeselectRegion())))),this.add([this.tray,this.cloth,this.closeButton,this.activePawnBacklight].filter((e=>e)))}setColor(e){this.cloth.setFillStyle(e,1)}setOpen(e){e!==this._openRef.current&&this._openRef.set(e);const t=this.scene.bounds.height-(e?this.config.openOffsetFromBottom:this.config.closedOffsetFromBottom);this.yController.transitionTo(t)}get isOpen(){return this._openRef.current}updateLayout(){const e=this.scene.bounds.height,t=this.scene.bounds.width;this.cloth.setOrigin(.5,0),this.cloth.setPosition(0,this.config.clothOffsetTop),this.cloth.setSize(this.width-2*this.config.clothHorizontalPadding,this.cloth.height),this.isOpen?this.setPosition(Math.round(t/2),e-this.config.openOffsetFromBottom):this.setPosition(Math.round(t/2),e-this.config.closedOffsetFromBottom),this.yController.setTo(this.y)}setBuyablePawns(e){this.displayedPawns=e,Object.values(this.pawnSprites).forEach((e=>e.setVisible(!1))),e.forEach(((e,t)=>{const i=this.getOrCreatePawnObject(e);i.setVisible(!0),i.updateLayout()})),this.activePawnBacklight.setVisible(!1),this.updatePawnSprites()}updatePawnSprites(){const e=this.config.pawnsSpacing,t=Math.round(-e*(this.displayedPawns.length-1)/2);Object.values(this.pawnSprites).forEach((e=>e.setVisible(!1))),this.displayedPawns.forEach(((i,s)=>{this.getOrCreatePawnObject(i).setVisible(!0).setPosition(t+s*e,this.config.pawnsVerticalOffset)}))}destroy(){super.destroy(),Object.values(this.pawnSprites).forEach((e=>e.destroy())),this.pawnSprites={}}getOrCreatePawnObject(e){const{pawnType:t,priceTag:i}=e;if(this.pawnSprites[t])this.pawnSprites[t].setConfig(e);else{const i=new B(this.scene,e,this._openRef);this.add(i),this.pawnSprites[t]=i}return this.pawnSprites[t]}setPawnTaken(e,t){const i=this.pawnSprites[e];i?(i.setTaken(t),t===C.Taken?(this.activePawnBacklight.setPosition(i.x,this.height),this.activePawnBacklight.setVisible(!0),this.activePawnBacklight.animateIn()):Object.values(this.pawnSprites).find((e=>e.taken===C.Taken))||this.activePawnBacklight.setVisible(!1)):M.warning(`pawnType ${e} not found in shopping tray`)}getPawnXY(e){const t=this.pawnSprites[e];if(!t)return;const{x:i,y:s}=t;return{x:i,y:s}}restockPawn(e){this.pawnSprites[e]?.restock()}doneReturningPawn(e){const t=this.pawnSprites[e];t&&t.taken===C.Returning&&t.setTaken(C.NotTaken)}getTooltipFor(e){const t=Object.entries(this.pawnSprites).find((([t,i])=>i===e));if(t){const[e]=t;switch(this.displayedPawns.find((t=>t.pawnType===e)).mode){case A.Available:return(0,v.getPawnTypeTooltip)(e,"buyable");case A.Unaffordable:return(0,v.getPawnTypeTooltip)(e,"unaffordable")}}}}var A,C;t.ShoppingTray=I,function(e){e.Available="available",e.Unaffordable="unaffordable"}(A=t.BuyablePawnMode||(t.BuyablePawnMode={})),function(e){e[e.NotTaken=0]="NotTaken",e[e.Taken=1]="Taken",e[e.Returning=2]="Returning"}(C=t.TakenMode||(t.TakenMode={}));class B extends T{constructor(e,t,i){super(e),this.inputEnabled=i,this.ui=p.UiBuilder.for(this.scene),this.shadow=this.ui.image("pawn-shadow"),this.priceTag=this.ui.text("0",g.BitmapFont.Mini,1052688).setOrigin(0,0),this.priceIcon=this.ui.image("ui/budget-icons/neutral").setAlpha(.7).setOrigin(0,0),this.taken=C.NotTaken,this.tweener=new w.Tweener(this.scene),this.image=this.ui.image((0,u.getFrameForPawnType)(t.pawnType)),this.width=this.image.displayWidth,this.height=this.image.displayHeight,this.setInteractive({cursor:"pointer",hitArea:new P(this.width-this.image.displayWidth/2,1.5*this.height-this.image.displayHeight,this.width,this.height),hitAreaCallback:P.Contains}),this.on("pointerdown",(()=>{this.mode===A.Unaffordable?(x.app.audio.playEffect(y.SoundEffects.Deny),S.inject.events.trigger(o.UserActions.ToggleTooltip({object:this}))):S.inject.events.trigger(o.UserActions.BuyablePawnPointerDown(t.pawnType))})),this.on("pointerup",(()=>{this.inputEnabled.current&&S.inject.events.trigger(o.UserActions.BuyablePawnPointerUp(t.pawnType))})),this.add([this.shadow,this.image,this.priceTag,this.priceIcon]),this.setConfig(t)}getWorldTransformMatrix(e,t){return super.getWorldTransformMatrix(e,t).translate(-this.width/2,-this.height)}setConfig(e){this.mode===e.mode&&this.priceTag.text===e.priceTag.toFixed()||(this.mode=e.mode,this.priceTag.setText(e.priceTag.toFixed()),this.taken=C.NotTaken,this.updateLayout())}setTaken(e){this.taken=e,this.updateLayout()}restock(){this.taken!==C.NotTaken&&(this.image.clearTint(),this.shadow.setVisible(!0),this.setTaken(C.NotTaken))}updateLayout(){if(this.tweener.stop(),this.taken===C.Taken)this.priceTag.setVisible(!0),this.priceIcon.setVisible(!0),this.priceIcon.setAlpha(1),this.image.setTint(0),this.image.setAlpha(.3,.3,0,0),this.shadow.setVisible(!1);else if(this.taken===C.Returning)this.priceTag.setVisible(!1),this.priceIcon.setVisible(!1),this.shadow.setVisible(!0),this.image.setTint(0),this.image.setAlpha(.3,.3,0,0);else switch(this.mode){case A.Available:this.priceTag.setVisible(!1),this.priceIcon.setVisible(!1),this.shadow.setVisible(!0),this.image.clearTint(),this.image.setAlpha(1);break;case A.Unaffordable:this.priceTag.setVisible(!0),this.priceIcon.setVisible(!0),this.priceIcon.setAlpha(.7),this.shadow.setVisible(!1),this.image.setTint(0),this.image.setAlpha(.3,.3,0,0)}f.Arrange.leftToRight({content:[{object:this.priceTag},{object:this.priceIcon}],x:0,origin:.5,spacing:3}),f.Arrange.alignY([this.priceTag,this.priceIcon],{y:0,origin:.5})}}t.BuyablePawnGameObject=B},92109:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompactPlayUI=void 0;const s=i(94787),n=i(56872),a=i(57902),o=i(48500),r=i(50273),c=i(46891),l=i(91025),d=i(8141),h=i(14034),u=i(30220),p=i(35037),g=i(23625),m=i(84370),y=i(36140),f=i(88865),w=i(58592),v=i(9603),b=i(32714);o.logger.for("ui:PlayUI"),t.CompactPlayUI=class{constructor(e,t){this.scene=e,this.state=t,this.pawnHolder=new s.PawnHolder(this.scene),this.statusHeader=new y.StatusHeaderUI(this.scene),this.regionPanel=new r.CompactRegionPanel(this.scene),this.shoppingTray=new n.ShoppingTray(this.scene,{...c.COMPACT_PLAY_UI_LAYOUT.shoppingTray,width:this.scene.bounds.width}),this.powerBalanceRibbon=new d.PowerBalanceRibbon(this.scene,{x:0,y:0,width:100,minSize:24}),this.endTurnButton=new S(this.scene),this.undoButton=new x(this.scene),this.nextPendingRegionButton=new T(this.scene),this.skipSpectatingButton=new P(this.scene),this.rollbackPanel=new u.LevelMenuPanel(this.scene,{onAction:()=>this.closeRollbackPanel()}),this.rewindControls=new b.RewindModeControls(this.scene,c.COMPACT_PLAY_UI_LAYOUT.rewindControls),this.bottomAnchoredComponents=[this.shoppingTray,this.regionPanel,this.endTurnButton,this.skipSpectatingButton,this.nextPendingRegionButton,this.undoButton,this.rewindControls.getGameObjects()],this.endTurnButton.onClicked((e=>{e.rightButtonDown()||e.rightButtonReleased()?f.inject.events.trigger(l.UserActions.Escape()):f.inject.events.trigger(l.UserActions.EndTurn({force:this.scene.keys.ctrl.isDown}))})),this.undoButton.onClicked((()=>f.inject.events.trigger(l.UserActions.Undo()))),this.nextPendingRegionButton.onClicked((()=>f.inject.events.trigger(l.UserActions.SelectNextPendingRegion()))),this.skipSpectatingButton.onClicked((()=>f.inject.events.trigger(l.UserActions.SkipSpectating()))),this.layer=new h.ResponsiveLayer(this.scene,[...this.rewindControls.getGameObjects(),this.powerBalanceRibbon,this.shoppingTray,this.regionPanel,this.endTurnButton,this.skipSpectatingButton,this.nextPendingRegionButton,this.undoButton,this.rollbackPanel,this.statusHeader]),this.scene.add.existing(this.layer),this.rollbackPanel.setVisible(!1),this.updateLayout(),f.inject.ui.withoutTransitions((()=>{this.updateState(this.state)}))}openRollbackPanel(){this.scene.children.bringToTop(this.rollbackPanel),this.rollbackPanel.show(),w.app.scene.worldMap.setMode(new p.PreviewMode),w.app.scene.globalUI.updateLayout()}closeRollbackPanel(){this.rollbackPanel.setVisible(!1),w.app.scene.worldMap.setMode(new g.InteractiveMode),w.app.scene.play.skipToCurrentState(m.NewGameStateContext.ResumingGame),w.app.scene.globalUI.updateLayout()}isRollbackPanelOpen(){return this.rollbackPanel.visible}transitionIn(e=f.inject.config.screenTransitionDuration){this.updateLayout(),this.scene.tweens.add({targets:this.bottomAnchoredComponents,props:{y:{getStart:e=>e.y+160,getEnd:e=>e.y}},duration:e,ease:"Sine.easeOut"})}transitionOut(e=f.inject.config.screenTransitionDuration){this.updateLayout(),this.scene.tweens.add({targets:this.bottomAnchoredComponents,y:"+=160",duration:e,ease:"Sine.easeIn"})}burnLife(){}destroy(){this.layer.destroy()}update(){this.pawnHolder.update()}updateLayout(){const e=this.scene.bounds.width,t=this.scene.bounds.height;this.regionPanel.reflow(),this.shoppingTray.x=0,this.shoppingTray.width=e,this.shoppingTray.updateLayout(),this.statusHeader.updateLayout(),this.rewindControls.updateLayout(),this.undoButton.setPosition(0,t-this.undoButton.height),this.endTurnButton.setPosition(e-this.endTurnButton.width,t-this.endTurnButton.height),this.nextPendingRegionButton.copyPosition(this.endTurnButton),this.skipSpectatingButton.copyPosition(this.endTurnButton),this.powerBalanceRibbon.setDimensions(c.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides,t-this.powerBalanceRibbon.height,e-2*c.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides),this.rollbackPanel.setSize(e,t)}updateState(e){if(this.state,this.state={...this.state,...e},this.regionPanel.updateState(e),this.rewindControls.updateState(e),void 0!==e.layout)switch(this.hideIrrelevantLayoutControls(e.layout.name),e.layout.name){case"hidden":break;case"spectate":this.skipSpectatingButton.setVisible(e.layout.enableSkipSpectating);break;case"rewind":this.powerBalanceRibbon.setVisible(!1);break;case"play":this.endTurnButton.setVisible("endTurn"===e.layout.primaryButton||"highlightEndTurn"===e.layout.primaryButton),this.endTurnButton.setHighlight("highlightEndTurn"===e.layout.primaryButton),this.nextPendingRegionButton.setVisible("nextRegion"===e.layout.primaryButton),this.undoButton.setVisible(!0),this.undoButton.setEnabled(e.layout.undoAvailable===v.UndoAvailability.Available),this.rollbackPanel.setRewindEnabled(e.layout.enableRollback);const t=e.layout.regionData;t&&t.controllable?(this.shoppingTray.setOpen(!0),this.shoppingTray.setColor(e.layout.activeFactionColor),this.shoppingTray.setBuyablePawns(t.buyablePawns)):this.shoppingTray.setOpen(!1),w.app.device.isUsingTouch()&&this.statusHeader.updateState(e.layout.heldPawnData)}void 0!==e.powerBalance&&this.powerBalanceRibbon.updateState(e.powerBalance)}hideIrrelevantLayoutControls(e){"play"!==e&&(this.endTurnButton.setVisible(!1),this.nextPendingRegionButton.setVisible(!1),this.undoButton.setVisible(!1),this.shoppingTray.setOpen(!1)),"rewind"!==e&&this.powerBalanceRibbon.setVisible(!0),"spectate"!==e&&this.skipSpectatingButton.setVisible(!1)}setVisible(e){this.layer.setVisible(e)}getTooltipFor(e){return this.shoppingTray.getTooltipFor(e)}getBottomPanelHeight(){if(w.app.navigator.currentScreen!==w.app.screen.play)return 0;switch(this.state.layout.name){case"play":return 85;case"spectate":return 15;case"rewind":return 110;case"hidden":return 0}}};class S extends a.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-turn",down:!0})}setHighlight(e){e?this.setBaseFrame("ui/compact/btn-turn-glow"):this.setBaseFrame("ui/compact/btn-turn")}}class x extends a.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-undo",down:!0,disabled:!0})}}class T extends a.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-next",down:!0})}}class P extends a.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-skip",down:!0})}}},93974:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompactRegionLabel=void 0;const s=i(36119),n=i(46453),a=i(54444),o=i(46891);var r=Phaser.GameObjects.Image;class c extends Phaser.GameObjects.Container{constructor(e,t,i){super(e),this.width=t,this.height=i,this.treasuryTextController=new n.TransitionController(this.scene,{duration:400,initialValue:0,applyValue:e=>{this.treasuryText.setText(e.toFixed(0))}}),this.incomeTextController=new n.TransitionController(this.scene,{duration:400,initialValue:0,applyValue:e=>{this.incomeText.setText((0,a.withSign)(Math.trunc(e))),this.updateTrendIcon(e),this.updateNumbersLayout()}}),this.visibilityController=n.Control.visibilityOf(this,{duration:o.COMPACT_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.regionInfo={controllable:!1,buyablePawns:[],name:"",treasury:0,income:0,id:-1,townLevel:1};const c=this.width;this.treasuryText=new s.RegionLabelText(e,c-16-64,24,"0").setOrigin(1,.5),this.goldIcon=new r(e,c-16-60,24,"atlas","ui/budget-icons/treasury").setOrigin(0,.5),this.incomeText=new s.RegionLabelText(e,c-16-16,24,"+8").setOrigin(1,.5),this.trendIcon=new r(e,c-16-6,24,"atlas","ui/budget-icons/surplus"),this.add([this.treasuryText,this.goldIcon,this.incomeText,this.trendIcon])}setBuyingPawnInfo(e){if("buying"===e?.context){const{cost:t,upkeep:i}=e;this.treasuryTextController.transitionTo(this.regionInfo.treasury-t),this.incomeTextController.transitionTo(this.regionInfo.income-i)}else this.treasuryTextController.transitionTo(this.regionInfo.treasury),this.incomeTextController.transitionTo(this.regionInfo.income)}updateTrendIcon(e){this.trendIcon.setFrame((0,s.getBudgetIcon)(e))}show(){this.visibilityController.transitionTo(1)}hide(){this.visibilityController.transitionTo(0)}setRegionInfo(e){const t=this.regionInfo.id===e.id;this.regionInfo=e,t?(this.treasuryTextController.transitionTo(e.treasury),this.incomeTextController.transitionTo(e.income)):(this.treasuryTextController.setTo(e.treasury),this.incomeTextController.setTo(e.income)),this.updateNumbersLayout()}updateNumbersLayout(){const e=this.width/2;(0,s.layoutFromCenter)(e,6,[this.goldIcon,this.treasuryText,this.incomeText,this.trendIcon])}}t.CompactRegionLabel=c},50273:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompactRegionPanel=t.ExpandedState=void 0;const s=i(4126),n=i(46891),a=i(93974),o=i(46453),r=i(70319);var c;!function(e){e.Hidden="hidden",e.Collapsed="collapsed",e.Expanded="expanded"}(c=t.ExpandedState||(t.ExpandedState={}));const l={[c.Expanded]:n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height,[c.Collapsed]:0,[c.Hidden]:0};class d extends r.ResponsiveContainer{constructor(e){super(e),this.expandedState=c.Collapsed,this.regionLabel=new a.CompactRegionLabel(this.scene,0,n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height),this.yController=o.Control.propOf(this,"y",{duration:n.COMPACT_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.box=new s.Box(e,s.BoxTextures.Plate,0,0,0,n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height),this.add([this.box,this.regionLabel])}updateState(e){if(void 0!==e.layout)if("play"===e.layout.name&&e.layout.regionData?.controllable){const t=e.layout.regionData;this.setExpandedState(c.Expanded),this.regionLabel.setRegionInfo(t),this.regionLabel.setBuyingPawnInfo(e.layout.heldPawnData)}else this.setExpandedState(c.Hidden)}setExpandedState(e){const t=this.scene.bounds.height-l[e];this.yController.transitionTo(t),this.expandedState=e}reflow(){const e=this.scene.bounds.height,t=this.scene.bounds.width;this.box.setSize(t,e);const i=t-2*n.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides;let s=0;switch(this.expandedState){case c.Hidden:case c.Collapsed:s=e;break;case c.Expanded:s=e-n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height}this.setPosition(n.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides,s),this.setSize(i,n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height),this.yController.setTo(s),this.regionLabel.width=i,this.regionLabel.updateNumbersLayout()}}t.CompactRegionPanel=d},36140:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HeaderButton=t.StatusHeaderUI=void 0;const s=i(70319),n=i(1909),a=i(24917),o=i(5715),r=i(99694),c=i(91025),l=i(29301),d=i(46453),h=i(88865),u=i(58592);var p=Phaser.GameObjects.Image;class g extends s.BaseResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.icon=this.ui.image("ui/icons/hand"),this.background=this.ui.rectangle(o.Colors.tooltip.background),this.description=this.ui.text("description",a.BitmapFont.Small,o.Colors.tooltip.text),this.exitButton=new m(this.scene,"ui/button-icons/exit",(()=>{h.inject.events.trigger(c.UserActions.ReturnHeldPawn())})),this.visibility=new d.TransitionController(this.scene,{initialValue:-32,applyValue:e=>{this.y=-32*(1-e)},duration:300,ease:"Sine.easeInOut"}),this.add([this.background,this.icon,this.description,this.exitButton]),this.visibility.setTo(0)}updateLayout(){this.width=this.scene.bounds.width,this.height=32,this.background.setSize(this.width,this.height),r.Arrange.leftToRight({content:[{object:this.icon},{object:this.description}],spacing:10,x:10}),r.Arrange.leftToRight({content:[{object:this.exitButton}],spacing:6,x:this.width-1,origin:1}),r.Arrange.alignY([this.icon,this.description,this.exitButton],{y:16,origin:.5})}updateState(e){e?(u.app.scene.globalUI.sidebarButtons.hide(),this.visibility.transitionTo(1),this.description.setText(`${e.context} ${e.name}`)):(this.visibility.transitionTo(0),u.app.scene.globalUI.sidebarButtons.updateLayout())}}t.StatusHeaderUI=g;class m extends l.StealthButton{constructor(e,t,i){super(e,{content:new p(e,0,0,"atlas",t),radius:4}),this.height=30,this.width=34,this.onClicked(i)}}t.HeaderButton=m},46891:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.COMPACT_PLAY_UI_LAYOUT=void 0;const s=i(5427),n=i(68660);t.COMPACT_PLAY_UI_LAYOUT={regionPanel:{offsetFromSides:70,height:50},shoppingTray:{openOffsetFromBottom:106,pawnsVerticalOffset:44,pawnsSpacing:50,width:n.MIN_WIDTH_FOR_LARGE_UI,height:35,style:s.ShoppingTrayStyle.Simple,closedOffsetFromBottom:-20,panelTransitionsDuration:500,clothHorizontalPadding:-2,clothOffsetTop:24},rewindControls:{buttonsOffsetFromEdge:4,buttonsSpacing:4,guidePromptOffsetFromBottom:48,labelWidth:140},panelTransitionsDuration:500}},48466:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LargePlayUI=t.LevelSummaryVisibility=void 0;const s=i(91025),n=i(57902),a=i(11822),o=i(94787),r=i(54444),c=i(48500),l=i(56872),d=i(63637),h=i(88031),u=i(55438),p=i(14034),g=i(47781),m=i(46453),y=i(55556),f=i(99813),w=i(88865),v=i(9603);var b=Phaser.GameObjects.Image;const S=i(32714),x=i(58592),T=c.logger.for("PlayUI");var P;!function(e){e[e.Hidden=0]="Hidden",e[e.Shown=1]="Shown",e[e.ShownWithRollbackPanel=2]="ShownWithRollbackPanel"}(P=t.LevelSummaryVisibility||(t.LevelSummaryVisibility={})),t.LargePlayUI=class{constructor(e,t){this.scene=e,this.state=t,this.pawnHolder=new o.PawnHolder(this.scene),this.headerPanel=new u.MenuPanel(this.scene),this.shoppingTray=new l.ShoppingTray(this.scene,d.LARGE_PLAY_UI_LAYOUT.shoppingTray),this.regionPanel=new a.LargeRegionPanel(this.scene),this.spectatorPanel=new h.LargeSpectatorPanel(this.scene),this.levelSummary=new y.LevelSummaryPanel(this.scene),this.livesCounter=new f.LivesCounter(this.scene),this.rewindControls=new S.RewindModeControls(this.scene,d.LARGE_PLAY_UI_LAYOUT.rewindControls),this.rollbackPanel=new g.RollbackPanel(this.scene,{onActionTaken:()=>{this.closeRollbackPanel()}}),this.rewindButton=this.rollbackPanel.rollbackButton,this.rollbackPanelVisibility=new m.TransitionController(this.scene,{duration:d.LARGE_PLAY_UI_LAYOUT.rollbackPanel.transitionDuration,ease:"Sine.easeInOut",initialValue:0,applyValue:e=>{this.rollbackPanel.y=this.scene.bounds.height-this.rollbackPanel.height*e,this.rollbackPanel.setAlpha(e)}}),this.levelSummaryVisibility=new m.TransitionController(this.scene,{initialValue:P.Hidden,ease:"Sine.easeInOut",applyValue:e=>{if(e>=1){const t=e-1,i=this._getLivesCounterY(-8*t);this.levelSummary.y=i,this.livesCounter.y=i,this.levelSummary.setAlpha(1-t),this.livesCounter.setAlpha(1),e===P.ShownWithRollbackPanel&&w.inject.gameStateController.rollbackAvailable?this.livesCounter.setMode(f.LivesCounterMode.FullColor):this.livesCounter.setMode(f.LivesCounterMode.Muted)}else{const t=this._getLivesCounterY(20*(1-e));this.levelSummary.setAlpha(e),this.livesCounter.setAlpha(e),this.levelSummary.y=t,this.livesCounter.y=t}},delay:d.LARGE_PLAY_UI_LAYOUT.rollbackPanel.transitionDuration/2,duration:d.LARGE_PLAY_UI_LAYOUT.rollbackPanel.transitionDuration/2}),this.endTurnButton=new M(this.scene),this.undoButton=new A(this.scene),this.buttonGlow=new I(this.scene),this.skipSpectatingButton=new B(this.scene),this.nextPendingRegionButton=new C(this.scene),this.bottomAnchoredComponents=[this.shoppingTray,this.regionPanel,this.spectatorPanel,this.endTurnButton,this.skipSpectatingButton,this.nextPendingRegionButton,this.undoButton,this.buttonGlow.overlayGlow,this.buttonGlow.staticGlow,this.rollbackPanel,this.levelSummary,this.livesCounter,...this.rewindControls.getGameObjects()],this.endTurnButton.onClicked((e=>{e.rightButtonDown()||e.rightButtonReleased()?w.inject.events.trigger(s.UserActions.Escape()):w.inject.events.trigger(s.UserActions.EndTurn({force:this.scene.keys.ctrl.isDown}))})),this.undoButton.on("pointerdown",(()=>{"play"===this.state.layout.name?this.state.layout.undoAvailable===v.UndoAvailability.RollbackOnly&&w.inject.events.trigger(s.UserActions.OpenRollbackMenu()):T.warning(`ignoring undoButton pointerdown in ${this.state.layout.name} layout`)})),this.undoButton.onClicked((()=>{"play"===this.state.layout.name?this.state.layout.undoAvailable===v.UndoAvailability.Available&&w.inject.events.trigger(s.UserActions.Undo()):T.warning(`ignoring undoButton click in ${this.state.layout.name} layout`)})),this.nextPendingRegionButton.onClicked((()=>w.inject.events.trigger(s.UserActions.SelectNextPendingRegion()))),this.skipSpectatingButton.onClicked((()=>w.inject.events.trigger(s.UserActions.SkipSpectating()))),this.layer=new p.ResponsiveLayer(this.scene,[...this.rewindControls.getGameObjects(),this.levelSummary,this.rollbackPanel,this.regionPanel,this.spectatorPanel,this.buttonGlow.staticGlow,this.endTurnButton,this.buttonGlow.overlayGlow,this.skipSpectatingButton,this.nextPendingRegionButton,this.undoButton,this.shoppingTray,this.headerPanel,this.livesCounter]),this.scene.add.existing(this.layer),this.updateLayout(),w.inject.ui.withoutTransitions((()=>{this.updateState(this.state)})),this.rollbackPanel.hovering.watch((e=>{e?this.cancelRollbackPanelAutoHide():this.scheduleRollbackPanelAutoHide()})),this.rollbackPanelVisibility.applyValue(0)}getBottomPanelHeight(){if(x.app.navigator.currentScreen!==x.app.screen.play)return 0;switch(this.state.layout.name){case"play":return 155;case"spectate":return 70;case"rewind":return 110;case"hidden":return 0}}burnLife(){switch(this.state.layout.name){case"rewind":this.rewindControls.livesCounter.burnLife();break;case"play":this.livesCounter.burnLife()}}openRollbackPanel(){this.cancelRollbackPanelAutoHide(),this.rollbackPanelVisibility.transitionTo(1),this.levelSummaryVisibility.transitionTo(P.ShownWithRollbackPanel)}closeRollbackPanel(){this.rollbackPanelVisibility.currentTarget>0&&(w.inject.events.trigger(s.UiEvents.RollbackMenuClosed()),this.rollbackPanelVisibility.transitionTo(0),this.levelSummaryVisibility.transitionTo("play"===this.state.layout.name&&this.state.layout.showLevelSummary?P.Shown:P.Hidden))}isRollbackPanelOpen(){return this.rollbackPanelVisibility.currentTarget>0}cancelRollbackPanelAutoHide(){this.rollbackPanelHideTimeout&&(clearTimeout(this.rollbackPanelHideTimeout),this.rollbackPanelHideTimeout=void 0)}scheduleRollbackPanelAutoHide(){this.rollbackPanelHideTimeout||(this.rollbackPanelHideTimeout=setTimeout((()=>this.closeRollbackPanel()),500))}setVisible(e){this.layer.setVisible(e)}updateLayout(){const e=this.scene.bounds.width,t=this.scene.bounds.height;this.regionPanel.updateLayout(),this.shoppingTray.updateLayout(),this.spectatorPanel.updateLayout(),this.rewindControls.updateLayout(),this.endTurnButton.setPosition(e/2+d.LARGE_PLAY_UI_LAYOUT.spectatorPanel.width/2+d.LARGE_PLAY_UI_LAYOUT.primaryButtons.offsetFromMainPanel,t-d.LARGE_PLAY_UI_LAYOUT.primaryButtons.playModeOffsetFromBottom-this.endTurnButton.height),this.nextPendingRegionButton.copyPosition(this.endTurnButton),this.skipSpectatingButton.copyPosition(this.endTurnButton),this.undoButton.setPosition(e/2-d.LARGE_PLAY_UI_LAYOUT.spectatorPanel.width/2-d.LARGE_PLAY_UI_LAYOUT.primaryButtons.offsetFromMainPanel-this.undoButton.width,t-d.LARGE_PLAY_UI_LAYOUT.primaryButtons.playModeOffsetFromBottom-this.undoButton.height),this.buttonGlow.setPosition(this.endTurnButton.x+this.endTurnButton.width/2,this.endTurnButton.y+this.endTurnButton.height/2),this.headerPanel.setPosition(e/2,0),this.levelSummaryVisibility.setTo(this.levelSummaryVisibility.currentTarget),this.levelSummary.x=this.undoButton.x,this.levelSummary.setSize(this.undoButton.width,20),this.livesCounter.setSize(this.undoButton.width-6,20),this.livesCounter.x=this.undoButton.x,this.rollbackPanel.x=this.undoButton.x-6,this.rollbackPanel.width=this.undoButton.width+12}_getLivesCounterY(e){return this.undoButton.y-4-this.levelSummary.height+e}hidePlayLayoutControls(){this.endTurnButton.setVisible(!1),this.buttonGlow.setVisible(!1),this.nextPendingRegionButton.setVisible(!1),this.undoButton.setVisible(!1),this.shoppingTray.setOpen(!1),this.levelSummaryVisibility.transitionTo(P.Hidden)}updateState(e,t=!1){if(this.state,this.state={...this.state,...e},this.spectatorPanel.updateState(e),this.regionPanel.updateState(e),this.rewindControls.updateState(e),void 0!==e.layout)switch(this.hideIrrelevantLayoutControls(e.layout.name),e.layout.name){case"hidden":case"rewind":break;case"spectate":this.skipSpectatingButton.setVisible(e.layout.enableSkipSpectating);break;case"play":this.endTurnButton.setVisible("endTurn"===e.layout.primaryButton||"highlightEndTurn"===e.layout.primaryButton),this.endTurnButton.setHighlighted("highlightEndTurn"===e.layout.primaryButton),this.buttonGlow.setVisible("highlightEndTurn"===e.layout.primaryButton),this.nextPendingRegionButton.setVisible("nextRegion"===e.layout.primaryButton),this.undoButton.setVisible(!0),this.undoButton.setEnabled(e.layout.undoAvailable!==v.UndoAvailability.Unavailable),this.rollbackPanel.setRollbackEnabled(e.layout.enableRollback),this.rollbackPanel.setReplayEnabled(e.layout.enableReplay),this.levelSummaryVisibility.transitionTo(e.layout.showLevelSummary?P.Shown:P.Hidden);const t=e.layout.regionData;t?t.controllable?(this.shoppingTray.setOpen(!0),this.shoppingTray.setColor(e.layout.activeFactionColor),this.shoppingTray.setBuyablePawns(t.buyablePawns)):t.controllable||this.shoppingTray.setOpen(!1):this.shoppingTray.setOpen(!1)}void 0!==e.turnNumber&&this.levelSummary.setTurnNumber(e.turnNumber),void 0!==e.livesLeft&&this.livesCounter.setCount(e.livesLeft),void 0!==e.levelName&&this.headerPanel.setTitle(e.levelName)}hideIrrelevantLayoutControls(e){"play"!==e&&this.hidePlayLayoutControls(),"spectate"!==e&&this.skipSpectatingButton.setVisible(!1)}update(){this.pawnHolder.update()}destroy(){this.layer.destroy()}transitionIn(e=w.inject.config.screenTransitionDuration){this.updateLayout(),this.scene.tweens.add({targets:this.bottomAnchoredComponents,props:{y:{getStart:e=>e.y+160,getEnd:e=>e.y}},duration:e,ease:"Sine.easeOut",onComplete:()=>this.updateLayout()})}transitionOut(e=w.inject.config.screenTransitionDuration){this.updateLayout(),this.scene.tweens.add({targets:this.bottomAnchoredComponents,y:"+=160",duration:e,ease:"Sine.easeIn"})}getTooltipFor(e){switch(e){case this.undoButton:return"play"===this.state.layout.name&&this.state.layout.undoAvailable===v.UndoAvailability.Unavailable?{title:"No more moves to undo!"}:{title:"Undo last action"};case this.endTurnButton:return{title:"End your turn now"};case this.rollbackPanel.restartButton:return{title:"Restart this island"};case this.rollbackPanel.rollbackButton:return{title:"Rewind back to previous turn",description:"This will cost you one life!"};case this.regionPanel.nextRegionButton:return{title:"Select next province"};case this.regionPanel.prevRegionButton:return{title:"Select previous province"};case this.headerPanel.menuButton:return{title:"Return to menu",description:"Don't worry, your progress is saved automatically"};case this.nextPendingRegionButton:return{title:"Select next idle province"};case this.regionPanel.box:const t="play"===this.state.layout.name?this.state.layout.regionData:void 0;if(!t)return;return function(e,t){const i=w.inject.gameStateModel,s=i.regions.byId(e);if(!s)return;const{incomeFromHexes:n,upkeep:a,balance:o}=i.economy.budgetOf(s),c={};s.getPawns().forEach((e=>{c[e.type]?++c[e.type]:c[e.type]=1}));const l=Object.entries(c).map((([e,t])=>{const s=i.rules.pawns(e)?.upkeep??0;if(s)return` - ${s*t} coins for ${t} x ${e}`})).filter((e=>e));return{icon:"chest",title:`Income:\n + ${n} coins from ${s.size} tiles\nExpenses:\n`+l.join("\n")+"\nBalance:\n"+` ${(0,r.withSign)(o)} coins per turn`}}(t.id,t.townLevel);default:return this.shoppingTray.getTooltipFor(e)??this.spectatorPanel.getTooltipFor(e)}}};class M extends n.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/end-turn",down:!0})}setHighlighted(e){this.setBaseFrame(e?"ui/primary-buttons/end-turn-glow":"ui/primary-buttons/end-turn")}}class I{setVisible(e){this.staticGlow.setVisible(e),this.overlayGlow.setVisible(e)}constructor(e){this.scene=e,this.staticGlow=new b(this.scene,0,0,"atlas","ui/primary-buttons/static-glow").setTint(16777088),this.overlayGlow=new b(this.scene,0,0,"atlas","ui/primary-buttons/overlay-glow").setTint(16777088),this.scene.tweens.add({targets:this.staticGlow,scaleX:{from:.95,to:1.05},scaleY:{from:.9,to:1.1},yoyo:!0,repeat:-1,duration:350,ease:"Sine.easeInOut"}),this.scene.tweens.add({targets:this.overlayGlow,alpha:{from:0,to:1},duration:350,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}setPosition(e,t){this.staticGlow.setPosition(e,t),this.overlayGlow.setPosition(e,t)}}class A extends n.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/undo",down:!0,disabled:!0})}}class C extends n.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/next",down:!0})}}class B extends n.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/skip",down:!0})}}},36119:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBudgetIcon=t.layoutFromCenter=t.layoutFromRight=t.RegionLabelText=t.LargeRegionLabel=void 0;var s=Phaser.GameObjects.Image,n=Phaser.GameObjects.BitmapText;const a=i(23441),o=i(24917),r=i(54444),c=i(46453),l=i(71234),d=i(30420),h=i(54812),u=i(99694),p=30;class g extends Phaser.GameObjects.Container{constructor(e,t,i){super(e),this.width=t,this.height=i,this.regionInfo={buyablePawns:[],controllable:!1,name:"",treasury:0,income:0,id:-1,townLevel:1},this.treasuryTextController=new c.TransitionController(this.scene,{duration:400,initialValue:0,applyValue:e=>{this.treasuryText.setText(e.toFixed(0)),this.updateNumbersLayout()}}),this.incomeTextController=new c.TransitionController(this.scene,{duration:400,initialValue:0,applyValue:e=>{this.incomeText.setText((0,r.withSign)(Math.trunc(e))),this.updateTrendIcon(e),this.updateNumbersLayout()}}),this.line1center=38,this.line2center=this.line1center-24;const n=this.width,a=this.line1center,l=this.line2center;this.regionIcon=new s(e,40,a,"atlas","pawns/town-1").setScale(.5,.5).setOrigin(.5,.5),this.regionNameText=new m(e,66,a,"Kingdom"),this.treasuryText=new m(e,n-p-54,a,"0").setOrigin(0,0),this.treasuryIcon=new s(e,this.treasuryText.x-34-16,a,"atlas","ui/budget-icons/treasury").setOrigin(0,0),this.incomeText=new m(e,n-p-16,a,"+8").setOrigin(0,0),this.trendIcon=new s(e,n-p-20,a,"atlas","ui/budget-icons/surplus"),this.selectedPawnArrow=new s(e,78,l+5,"atlas","ui/arrow-icon"),this.selectedPawnArrow.flipY=!0,this.selectedPawnText=new m(e,90,l,"",o.BitmapFont.Mini),this.selectedPawnCostText=new m(e,this.treasuryText.x,l,"",o.BitmapFont.Mini).setOrigin(1,.5),this.selectedPawnUpkeepText=new m(e,this.incomeText.x,l,"",o.BitmapFont.Mini).setOrigin(1,.5),this.add([this.regionIcon,this.regionNameText,this.treasuryText,this.treasuryIcon,this.incomeText,this.trendIcon,this.selectedPawnText,this.selectedPawnCostText,this.selectedPawnArrow,this.selectedPawnUpkeepText])}setRegionInfo(e){this.regionNameText.setText(e.name),this.regionInfo.id===e.id?(this.treasuryTextController.transitionTo(e.treasury),this.incomeTextController.transitionTo(e.income)):(this.treasuryTextController.setTo(e.treasury),this.incomeTextController.setTo(e.income)),this.regionInfo=e,this.regionIcon.setFrame((0,l.getFrameForPawnType)(d.PawnType.Town,(0,h.cropNumber)(e.townLevel,1,4))).setOrigin(.5,.5)}updateNumbersLayout(){u.Arrange.fromLeftToRightOld([this.treasuryIcon,this.treasuryText,this.incomeText],{x:this.width-p-34,y:this.line1center,originY:.5,originX:1,spacing:8}),this.selectedPawnCostText.x=this.treasuryText.x+this.treasuryText.width,this.selectedPawnUpkeepText.x=this.incomeText.x+this.incomeText.width}updateTrendIcon(e){this.trendIcon.setFrame(y(e))}setBuyingPawnInfo(e){if("buying"===e?.context){const{name:t,cost:i,upkeep:s}=e;this.selectedPawnText.setText(t),this.selectedPawnCostText.setText("-"+i.toString()),this.selectedPawnUpkeepText.setText("-"+s.toString()),[this.selectedPawnArrow,this.selectedPawnText,this.selectedPawnCostText].forEach((e=>e.setVisible(!0))),this.selectedPawnUpkeepText.setVisible(!!s),this.treasuryTextController.transitionTo(this.regionInfo.treasury-i),this.incomeTextController.transitionTo(this.regionInfo.income-s),this.goToVerticalOffset(8)}else this.clearSelectedPawnData(),this.treasuryTextController.transitionTo(this.regionInfo.treasury),this.incomeTextController.transitionTo(this.regionInfo.income),this.goToVerticalOffset(0)}clearSelectedPawnData(){[this.selectedPawnArrow,this.selectedPawnText,this.selectedPawnCostText,this.selectedPawnUpkeepText].forEach((e=>e.setVisible(!1)))}goToVerticalOffset(e){this.scene.tweens.add({targets:this,y:e,scale:1,ease:"Sine.easeOut",duration:200})}}t.LargeRegionLabel=g;class m extends n{constructor(e,t,i,s,n=o.BitmapFont.Main){super(e,t,i,n,s),this.setTint(5583648),this.setOrigin(0,.5)}}function y(e){return 0===e?"ui/budget-icons/neutral":e>0?"ui/budget-icons/surplus":"ui/budget-icons/deficit"}t.RegionLabelText=m,t.layoutFromRight=function(e,t,i){let s=e;for(let e of i.reverse())e.x=s-(1-e.originX)*e.width,s=s-e.width-t},t.layoutFromCenter=function(e,t,i){let s=e-(i.map((e=>e.width)).reduce(a.sum,0)+t*(i.length-1))/2;for(let e of i)e.x=s+e.originX*e.width,s=s+e.width+t},t.getBudgetIcon=y},11822:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LargeRegionPanel=t.ExpandedState=void 0;const s=i(4126),n=i(36119),a=i(63637),o=i(5427),r=i(17120),c=i(91025),l=i(46453),d=i(70319),h=i(88865);var u,p=Phaser.GameObjects.Image;!function(e){e.Hidden="hidden",e.Collapsed="collapsed",e.Expanded="expanded"}(u=t.ExpandedState||(t.ExpandedState={}));const g={[u.Expanded]:a.LARGE_PLAY_UI_LAYOUT.regionPanel.expandedOffsetFromBottom,[u.Collapsed]:a.LARGE_PLAY_UI_LAYOUT.regionPanel.collapsedOffsetFromBottom,[u.Hidden]:0};class m extends d.BaseResponsiveContainer{constructor(e){super(e),this.expandedState=u.Collapsed,this.browseRegionButtonsEnabled=!1,this.mode=o.PlayUIMode.Standby,this.regionLabel=new n.LargeRegionLabel(this.scene,a.LARGE_PLAY_UI_LAYOUT.regionPanel.width,a.LARGE_PLAY_UI_LAYOUT.regionPanel.height),this.nextRegionButton=new y(this.scene,!1),this.prevRegionButton=new y(this.scene,!0),this.sizeController=l.Control.propOf(this,"y",{duration:a.LARGE_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.box=new s.Box(e,s.BoxTextures.RoundedPlate,0,0,a.LARGE_PLAY_UI_LAYOUT.regionPanel.width,a.LARGE_PLAY_UI_LAYOUT.regionPanel.height),this.setDepth(o.PlayUILayers.MainPanel),this.add([this.nextRegionButton,this.prevRegionButton,this.box,this.regionLabel]),this.box.setInteractive(),this.box.input.cursor="default",this.box.on("pointerdown",(()=>{h.inject.events.trigger(c.UserActions.ToggleTooltip({object:this.box}))})),this.nextRegionButton.onClicked((()=>h.inject.events.trigger(c.UserActions.SelectNextRegion()))),this.prevRegionButton.onClicked((()=>h.inject.events.trigger(c.UserActions.SelectPreviousRegion())))}updateState(e){if(e.layout)if("play"===e.layout.name&&e.layout.regionData?.controllable){const t=e.layout.regionData;this.setExpandedState(u.Expanded),this.regionLabel.setRegionInfo(t),this.setBrowseRegionsButtonsEnabled(e.layout.enableNextRegion),this.regionLabel.setBuyingPawnInfo(e.layout.heldPawnData)}else this.setExpandedState(u.Hidden),this.setBrowseRegionsButtonsEnabled(!1)}setExpandedState(e){const t=this.scene.bounds.height-g[e];this.sizeController.transitionTo(t),this.expandedState=e}setBrowseRegionsButtonsEnabled(e){this.browseRegionButtonsEnabled=e;const t=this.prevRegionButton.props.width,i=e?4-t:0,s=e?a.LARGE_PLAY_UI_LAYOUT.regionPanel.width-4:a.LARGE_PLAY_UI_LAYOUT.regionPanel.width-t;if(h.inject.ui.skipTransitions())return this.nextRegionButton.x=s,void(this.prevRegionButton.x=i);this.scene.tweens.add({targets:this.prevRegionButton,x:i,scale:1,ease:"Sine.easeOut",duration:a.LARGE_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.scene.tweens.add({targets:this.nextRegionButton,x:s,scale:1,ease:"Sine.easeOut",duration:a.LARGE_PLAY_UI_LAYOUT.panelTransitionsDuration})}updateLayout(){const e=this.scene.bounds.height;let t=0;switch(this.expandedState){case u.Hidden:t=e;break;case u.Collapsed:t=e-a.LARGE_PLAY_UI_LAYOUT.regionPanel.collapsedOffsetFromBottom;break;case u.Expanded:t=e-a.LARGE_PLAY_UI_LAYOUT.regionPanel.expandedOffsetFromBottom}h.inject.ui.withoutTransitions((()=>{this.setBrowseRegionsButtonsEnabled(this.browseRegionButtonsEnabled)})),this.setPosition(this.scene.bounds.width/2-a.LARGE_PLAY_UI_LAYOUT.regionPanel.width/2,t),this.sizeController.setTo(t)}}t.LargeRegionPanel=m;class y extends r.RibbonButton{constructor(e,t){super(e,0,a.LARGE_PLAY_UI_LAYOUT.regionPanel.nextRegionButtonOffsetFromTop,{audio:!1,type:r.RibbonButtonStyle.Medium,width:36,content:f(e,t),contentOffset:{y:-3}})}}function f(e,t){const i=new p(e,0,0,"atlas","ui/button-icons/play");return i.flipX=t,i}},88031:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TurnNavigationPanel=t.LargeSpectatorPanel=t.ExpandedState=void 0;const s=i(4126),n=i(63637),a=i(5427),o=i(8141),r=i(73190),c=i(46453),l=i(11771),d=i(91025),h=i(97569),u=i(24917),p=i(70319),g=i(88865);var m=Phaser.GameObjects.Image,y=Phaser.GameObjects.BitmapText,f=Phaser.GameObjects.Container;const w=n.LARGE_PLAY_UI_LAYOUT;var v;!function(e){e.Hidden="hidden",e.Collapsed="collapsed",e.Expanded="expanded"}(v=t.ExpandedState||(t.ExpandedState={}));const b={[v.Expanded]:w.spectatorPanel.expandedOffsetFromBottom,[v.Collapsed]:w.spectatorPanel.collapsedOffsetFromBottom,[v.Hidden]:0};class S extends p.ResponsiveContainer{constructor(e){super(e),this.expandedState=v.Collapsed,this.mode=a.PlayUIMode.Standby,this.smallTurnNavigator=new x(this.scene),this.statusIcon=new m(this.scene,0,0,"atlas","ui/hourglass"),this.sizeController=c.Control.propOf(this,"y",{duration:w.panelTransitionsDuration}),this.spectatingMessage="Enemy turn...",this.powerBalanceRibbon=new o.PowerBalanceRibbon(this.scene,{x:w.spectatorPanel.padding,y:w.spectatorPanel.padding,width:w.spectatorPanel.width-2*w.spectatorPanel.padding,minSize:36}),this.box=new s.Box(e,s.BoxTextures.RoundedPlate,0,0,w.spectatorPanel.width,w.spectatorPanel.height),this.statusMessage=new y(this.scene,0,0,u.BitmapFont.Main,"").setTint(5583648),this.playSpeedButtons=new r.MiniButtonsRow(this.scene,["ui/mini-icons/pause","ui/mini-icons/play","ui/mini-icons/fast-forward","ui/mini-icons/super-fast-forward"]),this.downloadButton=new l.ImageButtonWithContent(this.scene,0,0,{frame:"ui/mini-buttons/standalone",content:new m(this.scene,0,0,"atlas","ui/mini-icons/download"),down:!0}),this.playSpeedButtonsGroupController=h.ButtonControllers.options({[g.SpectatingPlaybackSpeed.Paused]:this.playSpeedButtons.buttons[0],[g.SpectatingPlaybackSpeed.Normal]:this.playSpeedButtons.buttons[1],[g.SpectatingPlaybackSpeed.Fast]:this.playSpeedButtons.buttons[2],[g.SpectatingPlaybackSpeed.UltraFast]:this.playSpeedButtons.buttons[3]}),this.playSpeedButtonsGroupController.onButtonClicked((({key:e})=>{const t=Number(e);t!==g.inject.ui.spectatingSpeed()?g.inject.events.trigger(d.UserActions.SetSpectatingPlayBackSpeed(t)):t===g.SpectatingPlaybackSpeed.Paused&&g.inject.events.trigger(d.UserActions.SetSpectatingPlayBackSpeed(g.SpectatingPlaybackSpeed.Normal))})),this.updateButtonsPosition(),this.statusMessage.setPosition(w.spectatorPanel.padding+36,w.spectatorPanel.centerLineOffsetFromTop-2),this.statusIcon.setPosition(w.spectatorPanel.padding+10,w.spectatorPanel.centerLineOffsetFromTop),this.smallTurnNavigator.setPosition(w.spectatorPanel.padding,w.spectatorPanel.centerLineOffsetFromTop),this.downloadButton.onClicked((()=>g.inject.events.trigger(d.UserActions.SaveReplay()))),this.setDepth(a.PlayUILayers.MainPanel),this.add([this.box,this.powerBalanceRibbon,this.playSpeedButtons,this.downloadButton,this.statusMessage,this.statusIcon,this.smallTurnNavigator])}updateButtonsPosition(){this.downloadButton.visible?(this.downloadButton.setPosition(this.box.width-w.spectatorPanel.padding-this.downloadButton.width,w.spectatorPanel.centerLineOffsetFromTop),this.playSpeedButtons.setPosition(this.downloadButton.x-8-this.playSpeedButtons.width,w.spectatorPanel.centerLineOffsetFromTop)):this.playSpeedButtons.setPosition(this.box.width-w.spectatorPanel.padding-this.playSpeedButtons.width,w.spectatorPanel.centerLineOffsetFromTop)}updateState(e){if(e.layout)if("spectate"===e.layout.name){this.setExpandedState(v.Expanded),this.playSpeedButtons.setVisible(!0),this.playSpeedButtonsGroupController.selectButton(e.layout.spectatingSpeed.toString()),this.statusMessage.setText(e.layout.spectatingSpeed===g.SpectatingPlaybackSpeed.Paused?"< PAUSED >":this.spectatingMessage),this.smallTurnNavigator.setTurnNumber(e.layout.spectatingTurnNumber),this.downloadButton.setVisible(e.layout.enableDownloadReplay),this.updateButtonsPosition();const t=e.layout.spectatingContext===a.SpectatingContext.ReplayOnly||e.layout.spectatingContext===a.SpectatingContext.LiveReplay;this.statusMessage.setVisible(!t),this.statusIcon.setVisible(!t),this.smallTurnNavigator.setVisible(t),t||this.downloadButton.setVisible(!1),this.updateButtonsPosition()}else"rewind"===e.layout.name?this.setExpandedState(v.Hidden):this.setExpandedState(v.Collapsed);e.turnNumber&&this.smallTurnNavigator.setTotalTurns(e.turnNumber),e.powerBalance&&this.powerBalanceRibbon.updateState(e.powerBalance)}setExpandedState(e){this.expandedState=e;const t=this.scene.bounds.height-b[e];this.sizeController.transitionTo(t)}updateLayout(){const e=this.scene.bounds.width,t=this.scene.bounds.height;let i=0;switch(this.expandedState){case v.Hidden:i=t;break;case v.Collapsed:i=t-w.spectatorPanel.collapsedOffsetFromBottom;break;case v.Expanded:i=t-w.spectatorPanel.expandedOffsetFromBottom}this.setPosition(e/2-w.spectatorPanel.width/2,i),this.sizeController.setTo(i)}getTooltipFor(e){if(e===this.downloadButton.buttonSprite)return{title:"Download the replay.",description:"Once you download a replay, you can restore it by simply dragging and dropping the replay file into the game."}}}t.LargeSpectatorPanel=S;class x extends f{constructor(e){super(e),this._turnNumber=0,this._totalTurns=0,this.playSpeedButtons=new r.MiniButtonsRow(this.scene,["ui/mini-icons/skip-to-start","ui/mini-icons/prev-turn","display","ui/mini-icons/next-turn","ui/mini-icons/skip-to-end"]),this.add([this.playSpeedButtons]),this.playSpeedButtons.buttons[0].setController(h.ButtonControllers.triggerEvent((()=>d.UserActions.GoToStart()))),this.playSpeedButtons.buttons[1].setController(h.ButtonControllers.triggerEvent((()=>d.UserActions.GoToPreviousTurn()))),this.playSpeedButtons.buttons[2].setController(h.ButtonControllers.triggerEvent((()=>d.UserActions.GoToNextTurn()))),this.playSpeedButtons.buttons[3].setController(h.ButtonControllers.triggerEvent((()=>d.UserActions.GoToEnd())))}setTurnNumber(e){this._turnNumber=e,this.refreshLabel()}setTotalTurns(e){this._totalTurns=e,this.refreshLabel()}refreshLabel(){this.playSpeedButtons.setText(`turn ${this._turnNumber}/${this._totalTurns}`)}}t.TurnNavigationPanel=x},55556:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelSummaryPanel=void 0;const s=i(1909),n=i(24917),a=i(5715),o=i(70319),r=i(84892),c=i(91025),l=i(81363),d=i(88865),h=i(58592);class u extends o.BaseResponsiveContainer{constructor(e){super(e),this.ui=s.UiBuilder.for(this.scene),this.background=new r.RoundedRect(this.scene,{fillStyle:{color:a.Colors.glassUi.shape,alpha:1},radius:8}).setVisible(!1),this.turnNumberText=this.ui.text("Turn 2",n.BitmapFont.MiniBold,a.Colors.darker(a.Colors.glassUi.shapeShadow)),this.add([this.background,this.turnNumberText]),this.setInteractiveAuto(),this.on("pointerover",(()=>{this.background.setVisible(!0)})),this.on("pointerdown",(()=>{h.app.audio.playEffect(l.SoundEffects.ButtonUp),d.inject.events.trigger(c.UserActions.OpenRollbackMenu())})),this.on("pointerout",(()=>{this.background.setVisible(!1)}))}updateLayout(){this.turnNumberText.setOrigin(0,.5).setPosition(8,this.height/2),this.background.setSize(this.width,this.height)}setTurnNumber(e){this.turnNumberText.setText(`Turn ${e}`)}}t.LevelSummaryPanel=u},99813:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LivesCounter=t.LivesCounterMode=void 0;const s=i(1909),n=i(5715),a=i(70319),o=i(99694),r=i(5893),c=i(12678),l=i(48500).logger.for("LivesCounter");var d;!function(e){e.Muted="muted",e.FullColor="full-color",e.Cracked="cracked"}(d=t.LivesCounterMode||(t.LivesCounterMode={}));class h extends a.BaseResponsiveContainer{constructor(e,t=1){super(e),this.origin=t,this.ui=s.UiBuilder.for(this.scene),this.displayMode=d.Muted,this.pool=new r.Pool((()=>this.ui.image("ui/mini-icons/heart").setOrigin(0,0))).preload(3),this.lives=[]}setMode(e){return this.displayMode===e||(this.displayMode=e,this.lives.forEach(((t,i)=>u(t,e,i===this.lives.length-1)))),this}setCount(e){(0,c.assert)(e>=0),this.displayMode===d.Cracked&&(e>this.lives.length&&this.lives.length>0?u(this.lives[this.lives.length-1],this.displayMode,!1):e<this.lives.length&&u(this.lives[e-1],this.displayMode,!0));for(let t=this.lives.length;t<e;++t){const i=u(this.pool.take(),this.displayMode,t===e-1);i.setVisible(!0),this.lives.push(i),this.add(i)}for(;this.lives.length>e;){const e=this.lives.pop();this.pool.free(e),e.setVisible(!1),this.remove(e)}this.preUpdate.makeDirty()}updateLayout(){o.Arrange.leftToRight({content:this.lives,x:this.origin*this.width,origin:this.origin,spacing:4}),o.Arrange.alignY(this.lives,{y:this.height/2,origin:.5})}burnLife(){const e=this.lives.shift();e?(this.remove(e),this.scene.add.existing(e),e.setPosition(this.x+e.x,this.y+e.y),this.scene.tweens.add({targets:[e],props:{y:"-=20",alpha:0},duration:1e3,ease:"Sine.easeOut",onComplete:()=>this.pool.free(e)}),this.preUpdate.makeDirty()):l.warning("Requested to burn one life, but there are no lives left.")}}function u(e,t,i){const s=i||t!==d.Cracked?t:d.FullColor;switch(e.setAlpha(1),s){case d.FullColor:return e.setFrame("ui/mini-icons/heart-colored"),e.clearTint(),e;case d.Muted:return e.setFrame("ui/mini-icons/heart"),e.setTint(n.Colors.glassUi.disabledText),e;case d.Cracked:return e.setFrame("ui/mini-icons/heart-broken"),e.clearTint(),e}}t.LivesCounter=h},55438:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MenuPanel=void 0;var s=Phaser.GameObjects.Image,n=Phaser.GameObjects.BitmapText;const a=i(91025),o=i(70319),r=i(24917),c=i(5715),l=i(17120),d=i(88865),h=i(84892),u=i(1909),p=i(50162),g=i(99694),m=i(79730),y=100,f=30,w=16;class v extends o.AutoWidthResponsiveContainer{constructor(e){super(e),this.ui=u.UiBuilder.for(this.scene),this.background=new h.RoundedRect(this.scene,{radius:{tl:0,tr:0,bl:16,br:16},fillStyle:{color:c.Colors.glassUi.shapeLightAccent,alpha:.9}}),this.menuButton=new l.RibbonButton(this.scene,0,0,{type:l.RibbonButtonStyle.Small,icon:new s(this.scene,0,0,"atlas","ui/mini-icons/up").setTint(c.Colors.woodenUi.primaryText),content:new n(this.scene,0,0,r.BitmapFont.Small,"MENU").setTint(c.Colors.woodenUi.primaryText),width:y}),this.levelNameRef=(0,p.ref)("Unknown Island"),this.levelNameLabel=this.ui.text(this.levelNameRef,r.BitmapFont.Small,c.Colors.glassUi.primaryText),this.copyLinkButton=(0,m.createLevelLinkButton)(this.ui),this.height=f+8,this.menuButton.onClicked((()=>{d.inject.events.trigger(a.UserActions.GoBack())})),this.add([this.background,this.menuButton,this.levelNameLabel,this.copyLinkButton])}setTitle(e){this.levelNameRef.set(e),this.preUpdate.makeDirty()}calculateWidth(){return this.background.width}updateLayout(){g.Arrange.leftToRight({content:[this.menuButton,this.levelNameLabel,this.copyLinkButton],x:0,origin:.5,spacing:w}),g.Arrange.alignY([this.menuButton,this.levelNameLabel,this.copyLinkButton],{y:4+this.menuButton.height/2,origin:.5});const e=this.copyLinkButton.x+this.copyLinkButton.width+4;this.background.setPosition(this.menuButton.x-4,0),this.background.setSize(e-this.background.x,this.menuButton.height+8),this.updateSize()}}t.MenuPanel=v},94787:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnHolder=void 0;var s=Phaser.GameObjects.Image;const n=i(12678),a=i(77821);t.PawnHolder=class{constructor(e){this.scene=e}pickUpPawn(e,t,i,o=1){n.assert.undefined(this.heldPawn),this.heldPawn=e,this.heldPawnImage=new s(this.scene,t,i,"atlas","pawns/"+e),this.followCursor=!0,this.scene.add.existing(this.heldPawnImage),this.pickupTween=this.scene.tweens.add({targets:this.heldPawnImage,x:this.scene.input.activePointer.x,y:this.scene.input.activePointer.y,scale:{from:o,to:1},duration:a.TIMING.pawnPickupTransition,ease:"Sine.easeInOut",onComplete:()=>{this.pickupTween=void 0}})}update(){this.followCursor&&(this.heldPawnImage&&!this.pickupTween?this.heldPawnImage.setPosition(this.scene.input.activePointer.x,this.scene.input.activePointer.y):this.pickupTween&&(this.pickupTween.updateTo("x",this.scene.input.activePointer.x,!0),this.pickupTween.updateTo("y",this.scene.input.activePointer.y,!0)))}setFixedPosition(e,t){this.pickupTween&&this.pickupTween.stop(),this.followCursor=!1,this.pickupTween=this.scene.tweens.add({targets:this.heldPawnImage,x:e,y:t,scale:1,duration:a.TIMING.pawnPickupTransition,ease:"Sine.easeInOut",onComplete:()=>{this.pickupTween=void 0}})}dropPawn(e,t,i,s){const n=this.heldPawnImage;this.heldPawnImage=void 0,this.heldPawn=void 0,n?(this.pickupTween?.stop(),this.scene.tweens.add({targets:n,x:e,y:t,scale:i,duration:a.TIMING.pawnDropTransition,ease:"Sine.easeInOut",onComplete:()=>{n.destroy(),s?.()}})):s?.()}clear(){this.heldPawnImage?.destroy(),this.heldPawnImage=void 0,this.heldPawn=void 0,this.pickupTween?.stop(),this.pickupTween=void 0}setPawnType(e){this.heldPawnImage?.setFrame("pawns/"+e)}}},32714:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RewindModeControls=void 0;const s=i(17120),n=i(1909),a=i(88865),o=i(91025),r=i(24917),c=i(99694),l=i(50162),d=i(58592),h=i(68660),u=i(99813);var p=Phaser.GameObjects.Graphics;function g(e,t){return new s.RibbonButton(e.scene,0,0,{width:48,content:e.image(`ui/primary-button-icons/${t}`),type:s.RibbonButtonStyle.Primary})}t.RewindModeControls=class{constructor(e,t){this.scene=e,this.layout=t,this.ui=n.UiBuilder.for(this.scene),this.nextStopButton=g(this.ui,"next-stop"),this.prevStopButton=g(this.ui,"prev-stop"),this.stepForwardButton=g(this.ui,"step-forward"),this.stepBackButton=g(this.ui,"step-back"),this.labelText=(0,l.ref)("unknown"),this.mainLabel=this.ui.textContainer(this.labelText,r.BitmapFont.Main,0),this.guideline=this.ui.image("ui/guideline-up"),this.guidelineText=this.ui.text("select your province to confirm",r.BitmapFont.Mini,0),this.livesCounter=new u.LivesCounter(this.scene,.5),this.background=new p(this.scene),this.gameObjects=[this.background,this.livesCounter,this.prevStopButton,this.nextStopButton,this.stepForwardButton,this.stepBackButton,this.mainLabel,this.guidelineText,this.guideline],this.setVisible(!1),this.nextStopButton.onClicked((()=>a.inject.events.trigger(o.UserActions.RewindForward()))),this.prevStopButton.onClicked((()=>a.inject.events.trigger(o.UserActions.RewindBack()))),this.stepForwardButton.onClicked((()=>a.inject.events.trigger(o.UserActions.RewindStepForward()))),this.stepBackButton.onClicked((()=>a.inject.events.trigger(o.UserActions.RewindStepBack())))}getGameObjects(){return this.gameObjects}setVisible(e){for(let t of this.gameObjects)t.setVisible(e);e&&this.updateLayout()}updateState(e){e.layout&&("rewind"===e.layout.name?(this.setVisible(!0),this.labelText.set(e.layout.label),this.prevStopButton.setEnabled(e.layout.canGoBack),this.stepBackButton.setEnabled(e.layout.canGoBack),this.nextStopButton.setEnabled(e.layout.canGoForward),this.stepForwardButton.setEnabled(e.layout.canGoForward),this.guidelineText.setText(e.layout.guidelineLabel),this.livesCounter.setMode(e.layout.burningLife?u.LivesCounterMode.Cracked:u.LivesCounterMode.FullColor),this.livesCounter.setCount(e.layout.lives)):this.setVisible(!1))}updateLayout(){const e=this.scene.bounds.width,t=this.scene.bounds.height,i=this.layout;this.mainLabel.setSize(i.labelWidth,this.prevStopButton.height),c.Arrange.alignY([this.prevStopButton,this.stepBackButton,this.mainLabel,this.stepForwardButton,this.nextStopButton],{y:t-i.buttonsOffsetFromEdge-this.prevStopButton.height/2,origin:.5}),d.app.device.uiVariant()===h.UiVariant.Large?c.Arrange.leftToRight({content:[this.prevStopButton,this.stepBackButton,this.mainLabel,this.stepForwardButton,this.nextStopButton],origin:.5,x:e/2,spacing:i.buttonsSpacing}):(c.Arrange.leftToRight({content:[this.prevStopButton,this.stepBackButton],x:i.buttonsOffsetFromEdge,origin:0,spacing:i.buttonsSpacing}),c.Arrange.leftToRight({content:[this.stepForwardButton,this.nextStopButton],x:e-i.buttonsOffsetFromEdge,origin:1,spacing:i.buttonsSpacing}),c.Arrange.leftToRight({content:[this.mainLabel],x:e/2,origin:.5})),this.livesCounter.setSize(160,20),this.livesCounter.setMode(u.LivesCounterMode.Cracked),c.Arrange.vertically({content:[this.guideline,this.guidelineText,this.livesCounter],y:t-i.guidePromptOffsetFromBottom,spacing:4,origin:1}),c.Arrange.alignX([this.guidelineText,this.guideline,this.livesCounter],{origin:.5,x:e/2}),this.background.setPosition(0,0),this.background.clear();const s=16777215;this.background.fillGradientStyle(s,s,s,s,0,0,.8,.8),this.background.fillRect(0,t-200,e,200)}}},47781:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RollbackPanel=void 0;const s=i(70319),n=i(1909),a=i(24917),o=i(5715),r=i(99694),c=i(84892),l=i(91025),d=i(21103),h=i(81363),u=i(88865),p=i(58592);class g extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.hovering=(0,d.watchable)(!1),this.background=new c.RoundedRect(e,{radius:{tl:8,tr:8,bl:0,br:0},fillStyle:{color:o.Colors.glassUi.shape,alpha:1}}),this.restartButton=new m(this.scene,{icon:"ui/button-icons/restart",text:"Restart Level",onClick:()=>{u.inject.events.trigger(l.UserActions.RestartLevel({levelId:u.inject.ui.session.levelId})),p.app.audio.playEffect(h.SoundEffects.ButtonUp),t.onActionTaken()},onHover:this.handleButtonHover.bind(this)}),this.replayButton=new m(this.scene,{icon:"ui/button-icons/eye",text:"View Replay",onClick:()=>{u.inject.events.trigger(l.UserActions.ViewReplay()),p.app.audio.playEffect(h.SoundEffects.Rewind),t.onActionTaken()},onHover:this.handleButtonHover.bind(this)}),this.rollbackButton=new m(this.scene,{icon:"ui/button-icons/rollback",text:"Rewind",onClick:()=>{u.inject.events.trigger(l.UserActions.StartRewind()),p.app.audio.playEffect(h.SoundEffects.Rewind),t.onActionTaken()},onHover:this.handleButtonHover.bind(this)}),this.setInteractiveAuto(),this.input.cursor="default",this.on("pointerover",(()=>{this.hovering.set(!0)})),this.on("pointerout",(()=>{this.hovering.set(!1)})),this.menuItems=[this.restartButton,this.replayButton,this.rollbackButton],this.add([this.background,...this.menuItems])}setRollbackEnabled(e){this.rollbackButton.setEnabled(e)}setReplayEnabled(e){this.replayButton.setEnabled(e)}handleButtonHover(e){this.hovering.set(e)}updateLayout(){for(let e of this.menuItems)e.setSize(this.width,30);r.Arrange.fromTopToBottomOld(this.menuItems,{x:0,y:6,spacing:0}),this.updateSize(),this.background.setSize(this.width,this.height)}calculateHeight(){return 6+30*this.menuItems.length+60}}t.RollbackPanel=g;class m extends s.BaseResponsiveContainer{constructor(e,t){super(e);const i=n.UiBuilder.for(e);this._text=i.text(t.text,a.BitmapFont.Small,o.Colors.glassUi.primaryText).setOrigin(0,.5),this._icon=i.image(t.icon,o.Colors.glassUi.primaryText).setOrigin(.5,.5),this._background=i.rectangle(o.Colors.glassUi.shapeLightAccent).setVisible(!1),this.setInteractiveAuto(),this.on("pointerdown",(()=>{t.onClick()})),this.on("pointerover",((e,i,s,n)=>{t.onHover(!0),this._background.setVisible(!0)})),this.on("pointerout",((e,i,s,n)=>{t.onHover(!1),this._background.setVisible(!0)})),this.on("pointerout",((e,t)=>{t.stopPropagation(),this._background.setVisible(!1)})),this.add([this._background,this._icon,this._text])}setEnabled(e){const t=e?o.Colors.glassUi.primaryText:o.Colors.glassUi.disabledText;this._text.setTint(t),this._icon.setTint(t),this.input&&(this.input.enabled=e)}updateLayout(){this._icon.setPosition(22,15),this._background.setSize(this.width,this.height),this._text.setPosition(38,15)}}},63637:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LARGE_PLAY_UI_LAYOUT=void 0;const s=i(5427);t.LARGE_PLAY_UI_LAYOUT={regionPanel:{width:354,height:300,collapsedOffsetFromBottom:52,expandedOffsetFromBottom:96,nextRegionButtonOffsetFromTop:42},spectatorPanel:{width:418,height:300,collapsedOffsetFromBottom:26,expandedOffsetFromBottom:70,padding:10,centerLineOffsetFromTop:34},shoppingTray:{pawnsVerticalOffset:46,pawnsSpacing:60,width:354,height:45,style:s.ShoppingTrayStyle.Elaborate,openOffsetFromBottom:154,closedOffsetFromBottom:-20,panelTransitionsDuration:500,clothHorizontalPadding:5,clothOffsetTop:25},primaryButtons:{offsetFromMainPanel:12,playModeOffsetFromBottom:6},rollbackPanel:{transitionDuration:200},rewindControls:{buttonsOffsetFromEdge:6,buttonsSpacing:6,guidePromptOffsetFromBottom:50,labelWidth:180},panelTransitionsDuration:500}},5427:(e,t)=>{"use strict";var i,s,n,a,o;Object.defineProperty(t,"__esModule",{value:!0}),t.PlayUILayers=t.ShoppingTrayStyle=t.DEFAULT_PLAY_UI_STATE=t.SpectatingContext=t.PrimaryButton=t.PlayUIMode=void 0,(o=t.PlayUIMode||(t.PlayUIMode={})).Standby="standby",o.OwnedRegionSelected="owned-region-selected",o.HostileRegionSelected="hostile-region-selected",o.Spectating="spectating",o.Hidden="hidden",o.Rewind="rewind",(a=t.PrimaryButton||(t.PrimaryButton={})).None="none",a.EndTurn="end-turn",a.NextRegion="next-region",(n=t.SpectatingContext||(t.SpectatingContext={})).Live="live",n.LiveReplay="live-replay",n.ReplayOnly="replay",n.Rewind="rewind",t.DEFAULT_PLAY_UI_STATE={layout:{name:"hidden"},levelName:"Unknown Island",powerBalance:[],turnNumber:1,livesLeft:0},(s=t.ShoppingTrayStyle||(t.ShoppingTrayStyle={})).Simple="simple",s.Elaborate="elaborate",(i=t.PlayUILayers||(t.PlayUILayers={}))[i.Background=0]="Background",i[i.MainPanel=1]="MainPanel",i[i.Pawns=2]="Pawns"},28843:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegenerateLevelButton=t.LevelNamePanel=void 0;const s=i(70319),n=i(1909),a=i(24917),o=i(5715),r=i(55254),c=i(91025),l=i(88865),d=i(79730),h=i(58592),u=i(56952),p=i(27526),g=i(50162),m=i(96486);class y extends s.BaseResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.bgImage=this.ui.image("logos/ship"),this.headerText=this.ui.text("Setting sail for",a.BitmapFont.Small,o.Colors.glassUi.primaryText),this.levelNameText=this.ui.text("Unknown Island",a.BitmapFont.Main,o.Colors.glassUi.primaryText),this.regenerateLevelButton=new f(this.ui),this.copyLinkButton=(0,d.createLevelLinkButton)(this.ui),this.editNameResult=(0,g.ref)(""),this.editNameButton=this.ui.button(n.ButtonTemplate.SmallCircleButton,{icon:"ui/button-icons/edit",tooltip:"Discover new island by name.",onClicked:this.editLevelName.bind(this)}),this.regenerateLevelButton.onClicked((()=>l.inject.events.trigger(c.UserActions.GenerateNewIsland()))),this.add([this.bgImage,this.headerText,this.levelNameText,this.regenerateLevelButton,this.editNameButton,this.copyLinkButton])}updateLayout(){this.bgImage.setPosition(this.width/2-this.bgImage.width/2,20),this.headerText.setOrigin(.5,.5).setPosition(this.width/2,this.height-y.Layout.spaceForButton-60),this.levelNameText.setOrigin(.5,.5).setPosition(this.width/2,this.height-y.Layout.spaceForButton-30),this.regenerateLevelButton.setSize(150,30),this.regenerateLevelButton.setPosition(this.width/2-this.regenerateLevelButton.width/2,this.height-this.regenerateLevelButton.height/2-y.Layout.spaceForButton/2),this.editNameButton.setPosition(this.levelNameText.x+this.levelNameText.width/2+20,this.levelNameText.y-this.levelNameText.height/2),this.copyLinkButton.setPosition(this.editNameButton.x+this.editNameButton.width+10,this.editNameButton.y)}async editLevelName(){if(this.editNameResult.set(this.levelNameText.text),await h.app.modals.textInput({buttons:[{text:u.DialogButtons.Cancel,role:p.DialogButtonRole.Regular},{text:u.DialogButtons.OK,role:p.DialogButtonRole.PrimaryGreen}],title:"Discover new island",message:"The Shattered Ocean is vast and full of opportunity. Enter the name of a new island you'd like to discover!",value:this.editNameResult,maxLength:16})===u.DialogButtons.OK){const e=(0,m.startCase)(this.editNameResult.current.trim()).replace("_"," ");e&&l.inject.events.trigger(c.UserActions.GenerateNewIsland({name:e}))}}}t.LevelNamePanel=y,y.Layout={spaceForButton:56};class f extends r.RoundedRectButton{constructor(e){const t=e.image("ui/button-icons/restart").setTint(o.Colors.glassUi.secondaryText),i=e.text("Next Island",a.BitmapFont.Small,o.Colors.glassUi.secondaryText),s=e.hLayout({spacing:10,originY:.5,originX:.5,content:[t,i]});super(e.scene,{raised:2,audio:!0,contentOriginX:.5,content:s}),this.icon=t,this.label=i,this.layout=s}setEnabled(e){this.icon.setFrame(e?"ui/button-icons/restart":"ui/button-icons/search"),this.label.setText(e?"Next Island":"Searching..."),super.setEnabled(e)}}t.RegenerateLevelButton=f},52545:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapSettingsPanel=void 0;const s=i(70319),n=i(1909),a=i(83820),o=i(98047),r=i(99694),c=i(52937);class l extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.compressLayout=!1,this.ui=n.UiBuilder.for(this.scene),this.onSettingChanged=(0,c.signal)(),this.sizeSelector=new a.SelectBoxWithArrows(this.scene,{title:"Size",options:[o.MapSize.Small,o.MapSize.Medium,o.MapSize.Large].map((e=>({value:e,title:e}))),selectedOption:o.MapSize.Medium}),this.shapeSelector=new a.SelectBoxWithArrows(this.scene,{title:"Island Type",options:[o.MapShape.Temperate,o.MapShape.Marshlands,o.MapShape.Flat].map((e=>({value:e,title:e}))),selectedOption:o.MapShape.Temperate,infinite:!0}),this.modeSelector=new a.SelectBoxWithArrows(this.scene,{title:"Mode",options:[o.MapMode.Classic,o.MapMode.Colonization,o.MapMode.Crowded].map((e=>({value:e,title:e}))),selectedOption:o.MapMode.Classic,infinite:!0}),this.difficultySelector=new a.SelectBoxWithArrows(this.scene,{title:"Difficulty",options:[o.MapDifficulty.Casual,o.MapDifficulty.Challenging,o.MapDifficulty.Unfair].map((e=>({value:e,title:e}))),selectedOption:o.MapDifficulty.Challenging}),this.sizeSelector.onSelect((({value:e,direction:t})=>{this.onSettingChanged.fire({update:{size:e},direction:"left"===t?"right":"left"})})),this.shapeSelector.onSelect((({value:e,direction:t})=>{this.onSettingChanged.fire({update:{shape:e},direction:"left"===t?"right":"left"})})),this.modeSelector.onSelect((({value:e,direction:t})=>{this.onSettingChanged.fire({update:{mode:e}})})),this.difficultySelector.onSelect((({value:e,direction:t})=>{this.onSettingChanged.fire({update:{difficulty:e}})})),this.add([this.sizeSelector,this.shapeSelector,this.modeSelector,this.difficultySelector])}applyState(e,t,i){e.mode&&this.modeSelector.setSelection(e.mode),e.size&&this.sizeSelector.setSelection(e.size),e.shape&&this.shapeSelector.setSelection(e.shape),e.difficulty&&this.difficultySelector.setSelection(e.difficulty)}updateLayout(){[this.sizeSelector,this.shapeSelector,this.modeSelector,this.difficultySelector].forEach((e=>e.width=this.width)),r.Arrange.fromTopToBottomOld([this.sizeSelector,this.shapeSelector,this.modeSelector,this.difficultySelector],{x:0,y:0,spacing:this.compressLayout?4:14}),this.updateSize()}calculateHeight(){return this.difficultySelector.y+this.difficultySelector.height}}t.MapSettingsPanel=l,l.Layout={}},61770:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.migrateMapPresetInput=t.RandomMapHash=t.isMapPresetHash=t.deserializeMapPresetInput=t.serializeMapSettings=t.serializeMapPresetInput=void 0;const s=i(98047),n=i(12678),a=i(88865),o=i(96486),r=i(85656),c={[s.MapSize.Small]:"S",[s.MapSize.Medium]:"M",[s.MapSize.Large]:"L"},l={[s.MapShape.Temperate]:"T",[s.MapShape.Marshlands]:"M",[s.MapShape.Flat]:"F"},d={[s.MapMode.Classic]:"1",[s.MapMode.Crowded]:"2",[s.MapMode.Colonization]:"3"},h={[s.MapDifficulty.Casual]:"1",[s.MapDifficulty.Challenging]:"2",[s.MapDifficulty.Unfair]:"3"};function u(e){return`gl${e.version}-${p(e)}-${e.name.replaceAll(" ","_")}`}function p(e){return c[e.size]+l[e.shape]+d[e.mode]+h[e.difficulty]}function g(e){const t=e.match(/^gl(\d+)-([a-zA-Z])([a-zA-Z])(\d)(\d)-(\w+)$/);n.assert.defined(t),(0,n.assert)(7===t.length,`failed to interpret "${e} as a conquest map config"`);const i=t[1];(0,n.assert)(i===s.MAP_GENERATOR_VERSION.toString(),`expected generator version ${s.MAP_GENERATOR_VERSION}, found ${i}`);const a=(0,r.inverseLookup)(c,t[2]),u=(0,r.inverseLookup)(l,t[3]),p=(0,r.inverseLookup)(d,t[4]),g=(0,r.inverseLookup)(h,t[5]);return(0,n.assert)(a&&u&&p&&g,"failed to decode map settings"),{version:s.MAP_GENERATOR_VERSION,name:(0,o.startCase)(t[6].replaceAll("_"," ")),size:a,shape:u,mode:p,difficulty:g}}function m(e){return e.startsWith("gl")}t.serializeMapPresetInput=u,t.serializeMapSettings=p,t.deserializeMapPresetInput=g,t.isMapPresetHash=m,t.RandomMapHash={generate:u,parse:g,isValid:m},t.migrateMapPresetInput=function(e){return 2!==e.version?{version:s.MAP_GENERATOR_VERSION,name:a.inject.random.townName(),size:e.size,mode:e.mode,shape:e.shape,difficulty:e.difficulty}:e}},70942:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BeginButton=t.RandomMapSelectScene=t.DEFAULT_STATE=void 0;const s=i(11930),n=i(97866),a=i(68736),o=i(40056),r=i(1909),c=i(24917),l=i(56179),d=i(5715),h=i(55254),u=i(99694),p=i(91025),g=i(17120),m=i(98047),y=i(28843),f=i(52545),w=i(75326),v=i(80568),b=i(81363),S=i(60807),x=i(88865),T=i(58592),P=i(61770),M=i(80682);var I=Phaser.GameObjects.Image;const A=i(30093);t.DEFAULT_STATE={preset:{version:m.MAP_GENERATOR_VERSION,name:"",size:m.MapSize.Medium,shape:m.MapShape.Temperate,difficulty:m.MapDifficulty.Challenging,mode:m.MapMode.Classic}};class C extends a.BaseUIScene{constructor(){super({key:s.Scenes.RandomMapSelectUI}),this.state=(0,o.StateContainer)(this,t.DEFAULT_STATE),this.mapGenerator=new v.AsyncJobExclusiveRunner(((e,t)=>this._generateMap(e,t))),this.preUpdate=(0,n.whenDirty)((()=>{const e=this.bounds.height,t=e<555;this.mainPanelUI.updateLayout(),this.settingsPanel.compressLayout=t,this.settingsPanel.updateLayout(),this.backButton.setPosition(this.mainPanelUI.mainPanel.x+30,20),u.Arrange.vertically({content:[{object:this.levelNamePanel,size:250,minSize:130},{object:this.settingsPanel},{object:this.beginButton,size:50}],y:e/2,origin:.5,spacing:t?15:30,maxSize:e-60}),u.Arrange.alignX([this.levelNamePanel,this.settingsPanel,this.beginButton],{x:this.mainPanelUI.mainPanel.x+this.mainPanelUI.mainPanel.width/2,origin:.5,width:this.mainPanelUI.mainPanel.width-60})}))}applyState(e,t,i){e.preset&&this.settingsPanel.applyState(e.preset,t.preset,i.preset)}create(){super.create();const e=r.UiBuilder.for(this);this.mainPanelUI=new l.VerticalStripePanelUI(this),this.mainPanelUI.addToScene(),this.levelNamePanel=new y.LevelNamePanel(this),this.settingsPanel=new f.MapSettingsPanel(this),this.beginButton=new B(e),this.backButton=new g.RibbonButton(this,0,0,{icon:new I(this,0,0,"atlas","ui/mini-icons/back").setTint(d.Colors.woodenUi.primaryText),type:g.RibbonButtonStyle.Small,width:120,content:e.text("MENU",c.BitmapFont.Small,d.Colors.woodenUi.primaryText)}),this.backButton.onClicked((()=>{x.inject.events.trigger(p.UserActions.GoBack())})),this.beginButton.onClicked((()=>{if(this.mapGenerator.isRunning())return void T.app.audio.playEffect(b.SoundEffects.Deny);const e=this.state().preset;x.inject.userData.rememberChoice("randomMapOptions",{...e,name:x.inject.random.townName()});const t=x.inject.gameStateModel.map.levelId;S.track.randomMapSelected({level_id:t,map_name:e.name,map_size:e.size,map_shape:e.shape,map_mode:e.mode,map_difficulty:e.difficulty}),x.inject.userData.clearLevelProgress(t),x.inject.events.trigger(p.UserActions.PlayLevel({levelId:t,origin:"conquest/begin"}))})),this.settingsPanel.onSettingChanged((e=>{this.state.update({preset:{...this.state().preset,...e.update}}),x.inject.userData.rememberChoice("randomMapOptions",this.state().preset),this.startGenerating(e.direction)})),this.observe.event(p.UserActions.GenerateNewIsland,(async e=>{x.inject.random.reset();const t=this.state().preset;this.state.update({preset:{...t,name:e?.name??x.inject.random.townName()}}),x.inject.userData.rememberChoice("randomMapOptions",this.state().preset),S.track.randomMapRerolled({map_mode:t.mode,map_difficulty:t.difficulty,map_size:t.size,map_shape:t.shape,map_name:t.name}),this.startGenerating("down")})),this.mapGenerator.onJobStarted((()=>{this.levelNamePanel.regenerateLevelButton.setEnabled(!1)})),this.mapGenerator.onJobFinished((()=>{this.levelNamePanel.regenerateLevelButton.setEnabled(!0)})),this.components=[this.backButton,this.levelNamePanel,this.settingsPanel,this.beginButton],this.addAll(this.components)}startGenerating(e){this.mapGenerator.run({preset:this.state().preset,panDirection:e})}async _generateMap(e,t){const i=(0,m.buildGeneratorConfig)(e.preset);await Promise.all([(0,w.generateMap)(i,t),this._maybePanAway(e.panDirection)]),M.WorldMap.update(x.inject.currentGameState,{levelId:P.RandomMapHash.generate(e.preset)}),this.levelNamePanel.levelNameText.setText(e.preset.name),T.app.scene.worldMap.syncState(x.inject.currentGameState,A.OverlayModes.disabled),this._maybePanBack(e.panDirection)}async _maybePanAway(e){e&&await T.app.scene.worldMap.cameraController.panAway(e,x.inject.config.screenTransitionDuration)}async _maybePanBack(e){e&&await T.app.scene.worldMap.cameraController.panIntoCenter(e,x.inject.config.screenTransitionDuration)}getTooltipFor(e){switch(e){case this.levelNamePanel.regenerateLevelButton:return{title:"Click to find a different island."};case this.backButton:return{title:"Return to main menu."}}return super.getTooltipFor(e)}}t.RandomMapSelectScene=C,C.Layout={};class B extends h.RoundedRectButton{constructor(e){const t=e.text("Begin!",c.BitmapFont.Main,d.Colors.glassUi.primaryText),i=e.image("ui/level-icons/in-progress"),s=e.hLayout({originX:.5,originY:.5,content:[i,t],spacing:10});super(e.scene,{raised:4,contentOriginX:.5,content:s}),this.label=t,this.layout=s,this.icon=i}}t.BeginButton=B},86320:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RandomMapSelectScreen=void 0;const s=i(11930),n=i(54949),a=i(91025),o=i(35037),r=i(91471),c=i(60419),l=i(38714),d=i(88865),h=i(58592),u=i(61770),p=i(39835);class g extends n.BaseScreen{constructor(){super("RandomMapSelect",[s.Scenes.WorldMap,s.Scenes.RandomMapSelectUI]),this.observe.event(a.UserActions.Escape,(async()=>{h.app.navigator.goTo(h.app.screen.title)})),this.observe.event(a.UserActions.GoBack,(async()=>{h.app.navigator.goTo(h.app.screen.title)}))}async activate(e,t){p.NewsBox.hide(),h.app.scene.randomMapSelect.state.update({preset:(0,u.migrateMapPresetInput)(d.inject.userData.recallChoice("randomMapOptions"))}),h.app.scene.worldMap.setMode(new o.PreviewMode)}async transitionIn(e){e===h.app.screen.title?await(0,r.titleToRandomMapSelectTransition)():await(0,l.randomMapInTransition)()}async transitionOut(e){e===h.app.screen.play&&await(0,c.randomMapOutTransition)({keepWorldMap:!0})}deactivate(){h.app.scene.randomMapSelect.mapGenerator.clear()}}t.RandomMapSelectScreen=g},56179:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VerticalStripePanelUI=void 0;const s=i(1909),n=i(5715),a={width:400,padding:10,stripeWidth:6};t.VerticalStripePanelUI=class{constructor(e,t={}){this.scene=e;const i=s.UiBuilder.for(this.scene);this.props={...a,...t},this.mainPanel=i.rectangle(n.Colors.glassUi.background,.85),this.decorativeStripe=i.rectangle(n.Colors.glassUi.background,.77),this.decorativeStripeRight=i.rectangle(n.Colors.glassUi.background,.77),this.components=[this.decorativeStripeRight,this.decorativeStripe,this.mainPanel]}addToScene(){this.scene.addAll(this.components)}updateLayout(){const e=this.props,t=(this.scene.bounds.width,this.scene.bounds.height);this.scene.bounds.contentWidth<1.5*e.width?(this.mainPanel.setPosition(0,0),this.mainPanel.setSize(this.scene.bounds.contentWidth,t)):(this.mainPanel.setPosition(this.scene.bounds.contentRight-e.width,0),this.mainPanel.setSize(e.width,t)),this.decorativeStripe.setPosition(this.mainPanel.x-2*e.stripeWidth,0),this.decorativeStripe.setSize(e.stripeWidth,t),this.decorativeStripeRight.setPosition(this.mainPanel.x+this.mainPanel.width+e.stripeWidth,0),this.decorativeStripeRight.setSize(e.stripeWidth,t)}async transitionIn(e){await new Promise((t=>{this.scene.tweens.add({targets:this.components,props:{alpha:{from:0,to:1}},duration:e,ease:"Sine.easeIn",onComplete:t})}))}async transitionOut(e){await new Promise((t=>{this.scene.tweens.add({targets:this.components,props:{alpha:{from:1,to:0}},duration:e,ease:"Sine.easeIn",onComplete:t})}))}setVisible(e){this.components.forEach((t=>{t.setVisible(e),e&&t.setAlpha(1)}))}}},38714:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomMapInTransition=void 0;const s=i(88865),n=i(58592);t.randomMapInTransition=async function(e={}){n.app.scene.titleScreenUI;const t=n.app.scene.randomMapSelect,i=e.duration??s.inject.config.screenTransitionDuration;return new Promise((s=>{t.scene.setVisible(!0),t.preUpdate.force(),e.keepBackgroundPanel?t.mainPanelUI.setVisible(!0):t.mainPanelUI.transitionIn(i),t.startGenerating("up"),t.tweens.add({targets:t.components.filter((e=>e!==t.backButton&&e!==t.levelNamePanel)),props:{x:{getStart:e=>e.x+400,getEnd:e=>e.x},alpha:{from:0,to:1}},duration:i/2,onComplete:s,ease:"Sine.easeOut"}),t.tweens.add({targets:[t.backButton,t.levelNamePanel],props:{alpha:{from:0,to:1}},duration:i/2,ease:"Sine.easeOut"})}))}},60419:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomMapOutTransition=void 0;const s=i(88865),n=i(58592);t.randomMapOutTransition=async function(e){const t=n.app.scene.randomMapSelect,i=e.duration??s.inject.config.screenTransitionDuration;return new Promise((s=>{t.preUpdate.force(),e.keepWorldMap||n.app.scene.worldMap.cameraController.panAway("down",i),e.keepBackground||t.mainPanelUI.transitionOut(i),t.tweens.add({targets:t.components.filter((e=>e!==t.backButton&&e!==t.levelNamePanel)),props:{x:{getStart:e=>e.x,getEnd:e=>e.x+400},alpha:{from:1,to:0}},duration:i,onComplete:s,ease:"Sine.easeOut"}),t.tweens.add({targets:[t.backButton,t.levelNamePanel],props:{alpha:{from:1,to:0}},duration:i,ease:"Sine.easeOut"})}))}},61468:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomMapSelectToTileTransition=void 0;const s=i(23939),n=i(88865),a=i(58592);t.randomMapSelectToTileTransition=async function(){const e=a.app.scene.titleScreenUI,t=n.inject.config.screenTransitionDuration;e.scene.setVisible(!1),await(0,s.titleInTransition)({keepBackgroundPanel:!0,duration:t/2})}},91471:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.titleToRandomMapSelectTransition=void 0;const s=i(33946),n=i(38714),a=i(88865),o=i(58592);t.titleToRandomMapSelectTransition=async function(){const e=o.app.scene.titleScreenUI;return o.app.scene.randomMapSelect.scene.setVisible(!1),new Promise((t=>{const i=a.inject.config.screenTransitionDuration;e.tweens.add({targets:e.buttonsPanel.buttons[1],props:{alpha:{from:1,to:0}},duration:i,ease:"Sine.easeOut"}),(0,s.titleOutTransition)({excludeButton:1,keepBackgroundPanel:!0,duration:i/2}).then((async()=>{e.scene.setVisible(!1),await(0,n.randomMapInTransition)({duration:i/2,keepBackgroundPanel:!0}),t()}))})).then((()=>{e.buttonsPanel.buttons[1].setAlpha(1),e.scene.setVisible(!0)}))}},66967:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createScreens=void 0;const s=i(39961),n=i(5845),a=i(78089),o=i(50988),r=i(17719),c=i(60234),l=i(16310),d=i(95487),h=i(99431),u=i(25575),p=i(86320);t.createScreens=function(){return{play:new s.PlayScreen,mapEditor:new n.MapEditorScreen,breakpoint:new a.BreakPointScreen,debugHistory:new o.DebugHistoryScreen,title:new r.TitleScreen,levelSelect:new c.LevelSelectScreen,levelDetail:new l.LevelDetailScreen,victory:new d.VictoryScreen,defeat:new h.DefeatScreen,mapGeneration:new u.MapGenerationScreen,randomMapSelect:new p.RandomMapSelectScreen}}},17719:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TitleScreen=void 0;const s=i(54949),n=i(11930),a=i(91025),o=i(31129),r=i(24592),c=i(21898),l=i(12678),d=i(35037),h=i(84370),u=i(20666),p=i(33946),g=i(23939),m=i(11041),y=i(61468),f=i(39835),w=i(68660),v=i(88865),b=i(58592),S=i(22378),x=i(30093);class T extends s.BaseScreen{constructor(){super("Title",[n.Scenes.WorldMap,n.Scenes.TitleScreenUI]),this.autoSavedState=void 0,this.lockOrientation=!0,this.observe.event(a.UserActions.GoToLevelSelect,(async({campaignId:e})=>{const t=await v.inject.mapRegistry.getCampaignById(e);l.assert.defined(t),v.inject.ui.selectedCampaign.set(t),b.app.navigator.goTo(b.app.screen.levelSelect)})),this.observe.event(a.UserActions.ResumeGame,(()=>{this.autoSavedState&&v.inject.events.trigger(a.UserActions.PlayLevel({levelId:this.autoSavedState.map.levelId,origin:"title/continue"}))}))}async activate(e,t){await super.activate(e,t),f.NewsBox.show(),await this.loadAutosaveMetadata()}deactivate(){f.NewsBox.hide()}async transitionOut(e){e===b.app.screen.play?await(0,p.titleOutTransition)({keepWorldMap:!0}):e===b.app.screen.levelSelect&&await(0,c.transitionToLevelSelect)(0)}async transitionIn(e){let t=e===b.app.screen.play;b.app.scene.worldMap.scene.setVisible(t),t&&b.app.scene.worldMap.setMode(new d.PreviewMode),e===b.app.screen.randomMapSelect?await(0,y.randomMapSelectToTileTransition)():await(0,g.titleInTransition)(),t||this.loadLevel()}async loadAutosaveMetadata(){const e=v.inject.userData.current.latestLevelId;if(e)try{this.autoSavedState=await v.inject.userData.loadGameState(e,S.SaveGameTags.Autosave);const t=m.LevelModel.for(e);return void b.app.scene.titleScreenUI.state.update({resumeButton:{enable:!0,levelName:t.getTitle(m.LevelTitleStyle.IncludingModePrefix),turnNumber:this.autoSavedState.currentPhase.turnNumber}})}catch(t){console.error("failed to load level "+e,t)}try{const e=function(){const e=v.inject.mapRegistry.getCampaignById("intro")?.levels[0];l.assert.defined(e,"failed to find first campaign level");const t=m.LevelModel.for(e.id);if(t.getLevelStatus()!==m.LevelStatus.Completed&&t.getLevelStatus()!==m.LevelStatus.Replaying)return t;const i=t.getNextLevelToPlay();return i?m.LevelModel.for(i):void 0}();return void(e&&(this.autoSavedState=await v.inject.mapRegistry.loadLevelById(e.id),b.app.scene.titleScreenUI.state.update({resumeButton:{enable:!0,levelName:e.getTitle(m.LevelTitleStyle.IncludingModePrefix)}})))}catch(e){console.error("failed to find next playable campaign",e)}b.app.scene.titleScreenUI.state.update({resumeButton:{enable:!1}})}async loadLevel(){let e=this.autoSavedState??(0,r.decodeGameState)(o.BUILT_IN_MAPS.titleScreenLevel);v.inject.gameStateController.loadState(e,h.NewGameStateContext.Preview),b.app.scene.worldMap.cameraController.zoomController.cameraDistance.setTo(1),b.app.scene.worldMap.setMode(new d.PreviewMode),b.app.scene.worldMap.syncState(v.inject.currentGameState,x.OverlayModes.disabled),b.app.device.uiVariant()===w.UiVariant.Large&&b.app.scene.worldMap.cameraController.panIntoCenter("up"),b.app.scene.worldMap.scene.setVisible(!0),v.inject.gameStateModel.pawns.select({traits:[u.PawnTraits.Unit]}).map((e=>b.app.scene.worldMap.pawns.getById(e.id))).forEach((e=>e?.startJumping()))}}t.TitleScreen=T,T.Layout={buttons:{height:63,spacing:14,maxWidth:400}}},90571:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SocialsPanel=t.CampaignButton=t.DiscordButton=t.ButtonsPanel=t.TitleScreenUIScene=void 0;const s=i(11930),n=i(17719),a=i(55254),o=i(97866),r=i(99694),c=i(91025),l=i(68736),d=i(40056),h=i(1909),u=i(5715),p=i(24917),g=i(50668),m=i(70319),y=i(60807),f=i(56179),w=i(23441),v=i(88865),b=i(39835);class S extends l.BaseUIScene{constructor(){super({key:s.Scenes.TitleScreenUI}),this.state=(0,d.StateContainer)(this,{resumeButton:{enable:!1}}),this.preUpdate=(0,o.whenDirty)((()=>{const e=n.TitleScreen.Layout,t=this.bounds.width,i=this.bounds.height;if(this.background.updateLayout(),this.buttonsPanel.width=(0,w.pickSmaller)(this.background.mainPanel.width-60,n.TitleScreen.Layout.buttons.maxWidth),this.buttonsPanel.updateLayout(),i<900?this.gameLogo.setFrame("logos/game-title-compact"):this.gameLogo.setFrame("logos/game-title"),this.state().resumeButton.enable?(this.background.mainPanel.width===this.bounds.contentWidth?(this.resumeButton.x=this.background.mainPanel.x+30,this.resumeButton.setSize(this.background.mainPanel.width-60,e.buttons.height+10)):(this.resumeButton.x=this.background.mainPanel.x-80,this.resumeButton.setSize(this.background.mainPanel.width+160,e.buttons.height+10)),this.resumeButton.setVisible(!0),this.resumeSubtitle.setText(this.state().resumeButton.levelName??"Custom game")):this.resumeButton.setVisible(!1),r.Arrange.vertically({content:[{object:this.gameLogo},{object:this.buttonsPanel},{object:this.resumeButton}],y:i/2,origin:.5,spacing:30,maxSize:i-60}),r.Arrange.alignX([this.gameLogo,this.buttonsPanel],{x:this.background.mainPanel.x+this.background.mainPanel.width/2,origin:.5}),t>=970?b.NewsBox.show():b.NewsBox.hide(),i<640)this.socialsPanel.setVisible(!1);else{this.socialsPanel.setVisible(!0);let e=i<750?20:40;this.socialsPanel.setSize(this.background.mainPanel.width-80,32),this.socialsPanel.setPosition(this.background.mainPanel.x+40,this.bounds.height-e-this.socialsPanel.height)}}))}applyState(e,t,i){this.preUpdate.makeDirty()}create(){super.create();const e=h.UiBuilder.for(this);this.gameLogo=e.image("logos/game-title"),this.background=new f.VerticalStripePanelUI(this),this.background.addToScene(),this.buttonsPanel=new x(this),this.resumeSubtitle=e.text("?",p.BitmapFont.Mini,u.Colors.glassUi.primaryText),this.resumeButton=new a.RoundedRectButton(this,{raised:4,content:e.hLayout({spacing:20,layoutPolicy:g.LayoutChildrenPolicy.None,horizontalPadding:24,originY:.5,content:[e.image("ui/level-icons/in-progress"),e.vLayout({spacing:4,layoutPolicy:g.LayoutChildrenPolicy.None,content:[e.text("Continue",p.BitmapFont.Main,u.Colors.glassUi.primaryText),this.resumeSubtitle]})]})}),this.resumeButton.onClicked((()=>v.inject.events.trigger(c.UserActions.ResumeGame()))),this.socialsPanel=new M(e),this.addAll([this.gameLogo,this.buttonsPanel,this.resumeButton,this.socialsPanel])}getTooltipFor(e){switch(e){case this.socialsPanel.twitterButton:return{title:"Tweet at me!"};case this.socialsPanel.discordButton:return{title:"Join konkr.io discord server!"};case this.socialsPanel.feedbackButton:return{title:"Send me an email!"}}}}t.TitleScreenUIScene=S;class x extends m.AutoHeightResponsiveContainer{constructor(e){super(e);const t=h.UiBuilder.for(e),i=(i,s,n)=>{const o=t.hLayout({content:[t.image(i),t.text(s,p.BitmapFont.Main,u.Colors.glassUi.primaryText)],horizontalPadding:24,originY:.5,originX:0,layoutPolicy:g.LayoutChildrenPolicy.None,spacing:18}),r=new a.RoundedRectButton(e,{content:o,raised:2,audio:!0});return r.onClicked(n),r};this.buttons=[new P(t),i("ui/icons/conquest","Conquest",(()=>{y.track.interaction("open_conquest"),v.inject.events.trigger(c.UserActions.GoToRandomMapSelect())})),i("ui/icons/book","How to play",(()=>{v.inject.events.trigger(c.UserActions.ShowHowToPlay())})),new T(t)],this.add(this.buttons)}calculateHeight(){return this.buttons[this.buttons.length-1].y+n.TitleScreen.Layout.buttons.height}updateLayout(){this.buttons.forEach((e=>{e.setSize(this.width,n.TitleScreen.Layout.buttons.height),e.rounded=1,e.x=0})),r.Arrange.vertically({content:this.buttons.map((e=>({object:e}))),spacing:n.TitleScreen.Layout.buttons.spacing,origin:0,y:0}),this.updateSize()}}t.ButtonsPanel=x;class T extends a.RoundedRectButton{constructor(e){const t=e.image("ui/icons/new-window").setTint(u.Colors.glassUi.disabledText),i=e.hLayout({content:[e.image("ui/icons/discord-large"),e.vLayout({spacing:2,layoutPolicy:g.LayoutChildrenPolicy.None,content:[e.text("Community",p.BitmapFont.Main,u.Colors.glassUi.primaryText),e.text("Join the konkr.io Discord server",p.BitmapFont.Mini,u.Colors.glassUi.primaryText)]}),t],horizontalPadding:24,originY:.5,originX:0,layoutPolicy:g.LayoutChildrenPolicy.None,spacing:18});super(e.scene,{content:i,raised:2,audio:!0}),this.newWindowIcon=t,this.onClicked((()=>{y.track.interaction("join_discord"),v.inject.events.trigger(c.UserActions.JoinDiscord())}))}updateLayout(){super.updateLayout(),this.newWindowIcon.x=this.width-26-this.newWindowIcon.width}}t.DiscordButton=T;class P extends a.RoundedRectButton{constructor(e){const t=e.hLayout({content:[e.image("ui/icons/campaign"),e.vLayout({spacing:2,layoutPolicy:g.LayoutChildrenPolicy.None,content:[e.text("Campaign",p.BitmapFont.Main,u.Colors.glassUi.primaryText),e.text("New levels every monday!",p.BitmapFont.Mini,u.Colors.glassUi.primaryText)]})],horizontalPadding:24,originY:.5,originX:0,layoutPolicy:g.LayoutChildrenPolicy.None,spacing:18});super(e.scene,{content:t,raised:2,audio:!0}),this.onClicked((()=>{y.track.interaction("open_campaigns"),v.inject.events.trigger(c.UserActions.GoToLevelSelect({campaignId:"intro"}))}))}}t.CampaignButton=P;class M extends m.BaseResponsiveContainer{constructor(e){super(e.scene),this.ui=e,this.callToActionText=this.ui.text("Give me feedback!",p.BitmapFont.Small,u.Colors.glassUi.primaryText),this.twitterButton=new a.RoundedRectButton(this.ui.scene,{raised:0,content:this.ui.centered(this.ui.image("ui/icons/twitter",u.Colors.glassUi.primaryText))}),this.discordButton=new a.RoundedRectButton(this.ui.scene,{raised:0,content:this.ui.centered(this.ui.image("ui/icons/discord",u.Colors.glassUi.primaryText).setOrigin(.5,.5))}),this.feedbackButton=new a.RoundedRectButton(this.ui.scene,{raised:0,content:this.ui.centered(this.ui.image("ui/icons/mail",u.Colors.glassUi.primaryText))}),this.twitterButton.setSize(40,40),this.discordButton.setSize(40,40),this.feedbackButton.setSize(40,40),this.twitterButton.onClicked((()=>{v.inject.events.trigger(c.UserActions.SendTweet())})),this.discordButton.onClicked((()=>{v.inject.events.trigger(c.UserActions.JoinDiscord())})),this.feedbackButton.onClicked((()=>{v.inject.events.trigger(c.UserActions.SendEmail())})),this.add([this.callToActionText,this.twitterButton,this.discordButton,this.feedbackButton])}updateLayout(){r.Arrange.fromLeftToRightOld([this.callToActionText,this.feedbackButton,this.twitterButton,this.discordButton],{x:0,y:this.height/2,originY:.5,originX:0,spacing:12})}}t.SocialsPanel=M},23939:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.titleInTransition=void 0;const s=i(96486),n=i(88865),a=i(58592);t.titleInTransition=async function(e={}){const t=a.app.scene.titleScreenUI,i=e.duration??n.inject.config.screenTransitionDuration;return t.preUpdate.force(),t.scene.setVisible(!0),new Promise((n=>{let a=t.buttonsPanel.buttons;if(void 0!==e.excludeButton){const n=t.buttonsPanel.buttons[e.excludeButton];a=(0,s.without)(t.buttonsPanel.buttons,n);const o={x:n.x,y:n.y,width:n.width,height:n.height,rounded:1,alpha:1};n.x=0,n.y=0,n.setSize(t.bounds.width,200),n.rounded=0,t.tweens.add({targets:n,props:o,duration:i,onComplete:()=>{t.preUpdate.makeDirty()}})}t.tweens.add({targets:[...a,t.resumeButton],props:{x:{getStart:e=>e.x+400,getEnd:e=>e.x},alpha:{from:0,to:1}},duration:i,onComplete:()=>{t.preUpdate.force(),n()},ease:"Sine.easeOut"}),e.keepBackgroundPanel||t.background.transitionIn(i),t.tweens.add({targets:[t.socialsPanel,t.gameLogo],props:{alpha:{from:0,to:1}},duration:i,ease:"Sine.easeOut"})}))}},33946:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.titleOutTransition=void 0;const s=i(88865),n=i(58592);t.titleOutTransition=async function(e={}){const t=n.app.scene.titleScreenUI;await new Promise((i=>{const a=e.duration??s.inject.config.screenTransitionDuration,o=t.buttonsPanel.buttons.filter(((t,i)=>i!==e.excludeButton));e.keepWorldMap||n.app.scene.worldMap.cameraController.panAway("up",a),t.tweens.add({targets:[...o,t.resumeButton],props:{x:"+="+(n.app.device.screenWidth-t.background.decorativeStripe.x),alpha:{from:1,to:0}},duration:a,ease:"Sine.easeIn",onComplete:i}),t.tweens.add({targets:[t.socialsPanel,t.gameLogo],props:{alpha:0},duration:a,ease:"Sine.easeOut"}),e.keepBackgroundPanel||t.background.transitionOut(a)}))}},21898:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.transitionToLevelSelect=void 0;const s=i(10298),n=i(33946),a=i(88865),o=i(58592);t.transitionToLevelSelect=async function(e){const t=o.app.scene.titleScreenUI,i=o.app.scene.levelSelectUI,r=o.app.scene.menuHeaderUI;return(0,n.titleOutTransition)({excludeButton:e}),new Promise((n=>{const c=a.inject.config.screenTransitionDuration;t.tweens.add({targets:t.buttonsPanel.buttons[e],props:{x:0-t.buttonsPanel.x,y:0-t.buttonsPanel.y,width:o.app.device.screenWidth,height:s.MenuHeaderUIScene.Layout.panelHeight,rounded:0},duration:c,onComplete:()=>{t.preUpdate.makeDirty(),n()}}),t.tweens.add({targets:[o.app.scene.worldMap.cameras.main],scrollY:1e3,duration:c,ease:"Sine.easeIn"}),i.preUpdate.force(),r.preUpdate(),r.scene.setVisible(!1),i.levelCards.forEach((e=>e.setVisible(!1))),i.tweens.add({targets:i.levelCards,y:{getStart:(e,t,s,n)=>e.y+i.bounds.height,getEnd:(e,t,i,s)=>e.y},delay:(e,t,i,s)=>s*(c/100),duration:c,ease:"Sine.easeOut"}),setTimeout((()=>i.levelCards.forEach((e=>e.setVisible(!0)))),100)})).then((()=>{r.scene.setVisible(!0)}))}},93440:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelInfoPanel=t.VictoryScene=void 0;const s=i(97866),n=i(68736),a=i(11930),o=i(56996),r=i(24917),c=i(5715),l=i(91025),d=i(1909),h=i(96465),u=i(4126),p=i(99694),g=i(17120),m=i(88865),y=i(11041),f=i(70319),w=i(23441),v=i(79730);var b=Phaser.GameObjects.Image,S=Phaser.GameObjects.BitmapText,x=Phaser.GameObjects.Rectangle;class T extends n.BaseUIScene{constructor(){super({key:a.Scenes.Victory}),this.availableActions=[],this.preUpdate=(0,s.whenDirty)((()=>{this.shield.setPosition(this.bounds.centerX,this.bounds.centerY+20),this.shieldOutline.setPosition(this.bounds.centerX,this.bounds.centerY+26),this.victoryHalo.setPosition(this.bounds.centerX,this.bounds.centerY),this.victoryRays.setPosition(this.bounds.centerX,this.bounds.centerY),this.ribbon.width=400,this.ribbon.setPosition(this.bounds.centerX-this.ribbon.width/2,this.bounds.centerY+60),this.ribbonText.setPosition(this.bounds.centerX,this.bounds.centerY+66),this.ribbonText.setText("You are victorious!"),this.trophy.setPosition(this.bounds.centerX,this.bounds.centerY),this.backgroundOverlay.setSize(this.bounds.width,this.bounds.height),this.primaryButton.setVisible(this.availableActions.length>0),this.secondaryButton.setVisible(this.availableActions.length>1),this.ternaryButton.setVisible(this.availableActions.length>2),this.replayButton.setVisible(this.availableActions.length>3),this.levelInfoPanel.updateLayout();let e=this.bounds.centerY-300;(e<0||e<200&&this.bounds.width<600)&&(e=0),this.levelInfoPanel.setPosition(this.bounds.centerX,e);const t=(0,w.pickSmaller)(this.bounds.centerY+200,this.bounds.height-190);p.Arrange.fromTopToBottomOld([this.replayButton,this.primaryButton,this.secondaryButton,this.ternaryButton],{x:this.bounds.centerX,originX:.5,y:t,originY:0,spacing:10})}))}create(){super.create(),this.ui=d.UiBuilder.for(this),this.shield=this.createImage("shield"),this.shieldOutline=this.createImage("shieldOutline"),this.victoryHalo=this.createImage("victoryHalo"),this.victoryRays=this.createImage("victoryRays"),this.ribbon=new o.Ribbon(this,o.RibbonTextures.Pergamen,0,0,200),this.ribbonText=new S(this,0,0,r.BitmapFont.Main).setTint(c.Colors.woodenUi.primaryText).setOrigin(.5,0),this.levelInfoPanel=new P(this),this.trophy=this.createImage("trophy"),this.backgroundOverlay=new x(this,0,0,0,0,16777215,.5).setOrigin(0,0),this.primaryButtonText=this.ui.caption("?"),this.replayButtonText=this.ui.caption("VIEW REPLAY"),this.replayButton=new g.RibbonButton(this,0,0,{type:g.RibbonButtonStyle.Small,width:180,content:this.replayButtonText}),this.primaryButton=new h.BoxButton(this,0,0,{content:this.primaryButtonText,width:200,height:46,baseTexture:u.BoxTextures.DialogButton,downTexture:u.BoxTextures.DialogButtonDown}),this.secondaryButtonText=this.ui.caption("?"),this.secondaryButton=new g.RibbonButton(this,0,0,{type:g.RibbonButtonStyle.Small,width:180,content:this.secondaryButtonText}),this.ternaryButtonText=this.ui.caption("?"),this.ternaryButton=new g.RibbonButton(this,0,0,{type:g.RibbonButtonStyle.Small,width:180,content:this.ternaryButtonText}),this.addAll([this.backgroundOverlay,this.shieldOutline,this.victoryHalo,this.victoryRays,this.shield,this.trophy,this.ribbon,this.ribbonText,this.levelInfoPanel,this.secondaryButton,this.ternaryButton,this.replayButton,this.primaryButton]),this.tweens.add({targets:this.victoryRays,props:{angle:{from:0,to:360}},repeat:-1,duration:1e4}),this.primaryButton.onClicked((()=>{this.availableActions[0]?.executor?.()})),this.secondaryButton.onClicked((()=>{this.availableActions[1]?.executor?.()})),this.ternaryButton.onClicked((()=>{this.availableActions[2]?.executor?.()})),this.replayButton.onClicked((()=>{this.availableActions[3]?.executor?.()}))}setAvailableActions(e){this.availableActions=e,e[0]&&this.primaryButtonText.setText(e[0].title),e[1]&&this.secondaryButtonText.setText(e[1].title),e[2]&&this.ternaryButtonText.setText(e[2].title),e[3]&&this.replayButtonText.setText(e[3].title),this.preUpdate.makeDirty()}continueAutomaticallyAfter(e=5e3){setTimeout((()=>this.continue()),e)}continue(){this.scene.isActive()&&m.inject.events.trigger(l.UserActions.GoToLevelDetail({levelId:m.inject.ui.session.levelId}))}createImage(e){return new b(this,0,0,"gameOverAtlas",e)}updateContent(){this.levelInfoPanel.updateContent()}}t.VictoryScene=T;class P extends f.BaseResponsiveContainer{constructor(e){super(e),this.ui=d.UiBuilder.for(this.scene),this.background=new b(this.scene,0,0,"gameOverAtlas","levelPanel"),this.levelLabel=new S(this.scene,0,0,r.BitmapFont.Main).setTint(c.Colors.glassUi.secondaryText).setOrigin(0,0).setAlpha(.8).setDropShadow(1,1,16777215,.5),this.turnCountLabel=this.ui.text("won in ? turns",r.BitmapFont.Mini,c.Colors.glassUi.secondaryText).setOrigin(0,0).setAlpha(.8),this.copyLinkButton=(0,v.createLevelLinkButton)(this.ui),this.add([this.background,this.levelLabel,this.turnCountLabel,this.copyLinkButton])}updateContent(){const e=m.inject.ui.session.levelId,t=e?y.LevelModel.for(e):void 0;this.levelLabel.setText(t?.getTitle()??""),this.turnCountLabel.setText(`Won in ${m.inject.gameStateModel.currentPhase.turnNumber} turns`)}updateLayout(){this.background.setPosition(0,0).setOrigin(.5,0);const e=(0,w.pickSmaller)(this.scene.bounds.width/2,this.background.width/2);this.levelLabel.setPosition(0,24).setOrigin(.5,0),this.turnCountLabel.setPosition(0,24+this.levelLabel.height+6).setOrigin(.5,0),this.copyLinkButton.setPosition(e-24-this.copyLinkButton.width,24)}}t.LevelInfoPanel=P},95487:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VictoryScreen=void 0;const s=i(11930),n=i(54949),a=i(91025),o=i(35037),r=i(54173),c=i(93205),l=i(11041),d=i(88865),h=i(58592),u=i(60807),p=i(84370);class g extends n.BaseScreen{constructor(){super("Victory",[s.Scenes.WorldMap,s.Scenes.Victory]),this.observe.event(a.UserActions.GoToLevelDetail,(({levelId:e})=>{(0,r.returnToMenuFromGame)()})),this.observe.event(a.UserActions.Escape,(async()=>{h.app.scene.victory.continue()})),this.observe.event(a.UserActions.ViewReplay,(async()=>{u.track.interaction("view_replay"),h.app.navigator.goTo(h.app.screen.play,p.NewGameStateContext.ViewReplayAfterGameOver)}))}async activate(){h.app.scene.play;const e=l.LevelModel.for(d.inject.ui.session.levelId),t=e.getNextLevelToPlay(),i=[{title:"NEXT ISLAND",executor:()=>{t?d.inject.events.trigger(a.UserActions.PlayLevel({levelId:t,origin:"victory/play-next"})):(d.inject.ui.session.end({origin:"victory/play-next"}),d.inject.events.trigger(a.UserActions.GoToRandomMapSelect()))}},{title:"MENU",executor:()=>{d.inject.ui.session.end({origin:"victory/return-to-menu"}),d.inject.events.trigger(a.UserActions.GoToLevelDetail({levelId:d.inject.ui.session.levelId}))}},{title:"PLAY AGAIN",executor:()=>{d.inject.events.trigger(a.UserActions.PlayLevel({levelId:d.inject.ui.session.levelId,origin:"victory/play-again"}))}},{title:"VIEW REPLAY",executor:()=>{d.inject.events.trigger(a.UserActions.ViewReplay())}}];!t&&e.parentCampaign&&i.splice(0,1),h.app.scene.victory.setAvailableActions(i),h.app.scene.victory.updateContent(),h.app.scene.worldMap.setMode(new o.PreviewMode),h.app.scene.worldMap.cameraController.center(1e3)}async transitionOut(e){return e===h.app.screen.levelDetail?(0,c.victoryToLevelDetailTransition)():(0,c.victoryBaseTransitionOut)()}deactivate(){h.app.scene.globalUI.ambientGlitterVolume.transitionTo(0)}}t.VictoryScreen=g},93205:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.victoryBaseTransitionOut=t.victoryToLevelDetailTransition=void 0;const s=i(98723),n=i(14219),a=i(88865),o=i(58592);async function r(){const e=a.inject.config.screenTransitionDuration,t=o.app.scene.victory;await new Promise((i=>{t.preUpdate(),t.tweens.add({targets:t.backgroundOverlay,alpha:{start:1,to:0},duration:e}),t.tweens.add({targets:t.ribbonText,alpha:{from:1,to:0},duration:e/2}),t.tweens.add({targets:t.ribbon,x:{from:t.ribbon.x,to:t.ribbon.x+150},width:{from:400,to:100},alpha:{from:1,to:0},duration:e,ease:Phaser.Math.Easing.Expo.Out,onComplete:i}),t.tweens.add({delay:2*e/3,targets:t.trophy,alpha:{start:1,to:0},duration:e/3}),t.tweens.add({delay:e/2,targets:[t.shield],scale:{from:1,to:0},alpha:{start:1,to:0},duration:e/2}),t.tweens.add({targets:[t.shieldOutline,t.victoryHalo,t.victoryRays],alpha:{start:1,to:0},scale:{start:1,to:.2},duration:2*e/3,ease:Phaser.Math.Easing.Sine.In}),t.tweens.add({targets:[t.primaryButton,t.secondaryButton,t.ternaryButton,t.replayButton,t.levelInfoPanel].filter((e=>e.visible)),alpha:{start:1,to:0},duration:e/3})}))}t.victoryToLevelDetailTransition=async function(){const e=a.inject.config.screenTransitionDuration,t=o.app.scene.victory,i=o.app.scene.levelDetailUI;(0,s.playSceneToLevelDetailTransition)(),t.tweens.add({targets:t.trophy,delay:0,props:{x:i.layout.cardLeft(0)+i.bounds.contentLeft+n.LargeLevelCardContent.Layout.iconOffsetFromLeft+20,y:i.layout.cardTop+i.layout.cardHeight-i.layout.cards.footerSize/2,scale:{from:1,to:.5}},duration:e,ease:Phaser.Math.Easing.Sine.InOut}),await r()},t.victoryBaseTransitionOut=r},68825:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.victoryTransition=void 0;const s=i(81363),n=i(58592);t.victoryTransition=async function(e=1e3){const t=n.app.scene.victory;n.app.scene.playUI.activeUI.transitionOut(),n.app.audio.playEffect(s.SoundEffects.Victory),n.app.scene.globalUI.ambientGlitterVolume.transitionTo(1),await new Promise((i=>{t.preUpdate.makeDirty(),t.preUpdate(),t.ribbon.setAlpha(1),t.tweens.add({targets:t.backgroundOverlay,alpha:{start:0,to:1},duration:e/2}),t.tweens.add({targets:t.ribbonText,alpha:{from:0,to:1},duration:e,onComplete:i}),t.tweens.add({targets:t.ribbon,x:{from:t.ribbon.x+150,to:t.ribbon.x},width:{from:100,to:400},duration:e,ease:Phaser.Math.Easing.Expo.Out}),t.tweens.add({targets:t.trophy,delay:0,scale:{from:10,to:1},duration:e,ease:Phaser.Math.Easing.Bounce.Out}),t.tweens.add({delay:e/3,targets:t.trophy,alpha:{start:0,to:1},duration:e/2}),t.tweens.add({targets:[t.shield],scale:{from:.2,to:1},alpha:{start:0,to:1},duration:e/2,ease:Phaser.Math.Easing.Expo.Out}),t.tweens.add({delay:e/3,targets:[t.shieldOutline,t.victoryHalo,t.victoryRays],alpha:{start:0,to:1},scale:{start:.2,to:1},duration:2*e/3,ease:Phaser.Math.Easing.Back.Out}),t.tweens.add({delay:.5*e,targets:[t.primaryButton].filter((e=>e.visible)),alpha:{start:0,to:1},duration:e/3}),t.tweens.add({delay:e,targets:[t.levelInfoPanel],alpha:{start:0,to:1},duration:e/3});const s=[t.secondaryButton,t.ternaryButton,t.replayButton].map((e=>e.y));t.tweens.add({delay:e,targets:[t.secondaryButton,t.ternaryButton,t.replayButton].filter((e=>e.visible)),y:{getStart:(e,i,s,n)=>t.primaryButton.y+.5*t.primaryButton.height,getEnd:(e,t,i,n)=>s[n]},alpha:{start:0,to:1},duration:e/3,ease:Phaser.Math.Easing.Sine.Out}),t.tweens.add({delay:2*e/3,targets:[t.levelInfoPanel],y:{from:t.levelInfoPanel.y+150,to:t.levelInfoPanel.y},duration:e/3,ease:Phaser.Math.Easing.Back.Out})}))}},28367:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tooltip=t.TooltipPlacement=t.LAYOUT=t.TOOLTIP_STYLE=void 0;const s=i(5715),n=i(97119),a=i(48500),o=i(89422),r=i(82187),c=i(34198),l=i(96486),d=i(58592);a.logger.for("Tooltips"),t.TOOLTIP_STYLE={default:{textColor:s.Colors.tooltip.text,backgroundColor:s.Colors.tooltip.background,padding:8},speechBubble:{textColor:s.Colors.speechBubble.text,backgroundColor:s.Colors.speechBubble.background,padding:6}},t.LAYOUT={triangleSize:10,spacing:8,maxWidth:240,expandTransitionDuration:200,showHideTransitionDuration:100,screenMargin:10},t.TooltipPlacement={overUiObject:e=>()=>(0,r.getObjectCameraRect)(e),atGlobalXY:(e,t,i)=>()=>({x:e,y:t-i,width:0,height:2*i}),atWorldMapHex:e=>()=>{const{x:t,y:i}=(0,r.convertWorldXYToCameraXY)(d.app.scene.worldMap.cameras.main,e.display.centerX,e.display.centerY);return{x:t,y:i-c.HEX_HEIGHT/2,width:0,height:c.HEX_HEIGHT}}};class h extends o.Container{constructor(e){super(e),this.tweener=new n.Tweener(this.scene),this.preferBelow=!1,this.mode=o.TooltipMode.Hidden,this.recentlyShown=!1,this.content=new o.TooltipContent(e);const i=t.LAYOUT.triangleSize;this.backgroundTriangle=new o.Triangle(e,0,0,.69*-i,-i,.69*i,-i,0,0,s.Colors.tooltip.background).setOrigin(0,0).setPosition(0,0),this.add([this.backgroundTriangle,this.content])}showDelayed(e){const t=this.recentlyShown&&!e.enforceDelay?0:e.delayMs??1e3;this.mode=o.TooltipMode.ScheduledToShow,this._queueAction((()=>this.show(e)),t)}_queueAction(e,t){this._clearQueuedAction(),this.queuedAction=setTimeout(e,t)}_clearQueuedAction(){this.queuedAction&&clearTimeout(this.queuedAction)}updatePosition(){if(this.mode===o.TooltipMode.Hidden||this.mode==o.TooltipMode.ScheduledToShow)return;const e=this.placement(this);if(this.previousPlacement&&(0,l.isEqual)(e,this.previousPlacement))return;this.previousPlacement=e;const i=this.scene.cameras.main,{x:s,y:n}=i.getWorldPoint(10,10),{x:a,y:r}=i.getWorldPoint(i.displayWidth-10,i.displayHeight-10);this.setPosition(e.x+e.width/2,e.y);const c=this.y-this.content.fullSize.height-t.LAYOUT.triangleSize,d=this.y+e.height+this.content.fullSize.height+t.LAYOUT.triangleSize;c<n||this.preferBelow&&d<r?(this.backgroundTriangle.setRotation(Math.PI),this.content.setPosition(-this.content.width/2,t.LAYOUT.triangleSize),this.setPosition(e.x+e.width/2,e.y+e.height)):(this.backgroundTriangle.setRotation(0),this.content.setPosition(-this.content.width/2,-this.content.height-t.LAYOUT.triangleSize)),this.content.x=this.adjustContentXToFitScreen(this.content.x)}show(e){const i=e.style??t.TOOLTIP_STYLE.default;this.tweener.stop(),this.mode=o.TooltipMode.Shown,this.recentlyShown=!0,this._clearQueuedAction(),this.setVisible(!0),this.content.setProps(e),this.placement=e.placement,this.preferBelow=e.displayBelow||!1,this.backgroundTriangle.fillColor=i.backgroundColor,this.content.backgroundBox.setFillStyle(i.backgroundColor,1),this.content.title.setTint(i.textColor),this.content.description.setTint(i.textColor),this.updatePosition(),this.tweener.add({targets:this,scale:{from:0,to:1},alpha:{from:0,to:1},duration:t.LAYOUT.showHideTransitionDuration}),e.expireAfterMs?this._queueAction((()=>this.hide()),e.expireAfterMs):this.content.description&&this._queueAction((()=>{this.mode=o.TooltipMode.Expanded,this.content.expand(),this.backgroundTriangle.rotation?this.content.tweener.add({targets:this.content,x:this.adjustContentXToFitScreen(-this.content.width/2)}):this.content.tweener.add({targets:this.content,x:this.adjustContentXToFitScreen(-this.content.width/2),y:-this.content.height-t.LAYOUT.triangleSize})}),1500)}get shown(){return this.mode===o.TooltipMode.Shown||this.mode===o.TooltipMode.Expanded}async hide(){if(this.mode===o.TooltipMode.ScheduledToShow&&this._clearQueuedAction(),this.shown)return this.mode=o.TooltipMode.Hidden,this.previousPlacement=void 0,this._queueAction((()=>{this.recentlyShown=!1}),500),new Promise((e=>{this.tweener.add({targets:this,scale:0,alpha:0,duration:t.LAYOUT.showHideTransitionDuration,onComplete:()=>{this.setVisible(!1),e()}})}))}adjustContentXToFitScreen(e){const i=this.scene.cameras.main,{x:s,y:n}=i.getWorldPoint(t.LAYOUT.screenMargin,t.LAYOUT.screenMargin),{x:a,y:o}=i.getWorldPoint(i.displayWidth-t.LAYOUT.screenMargin,i.displayHeight-t.LAYOUT.screenMargin),r=this.x-this.content.width/2,c=this.x+this.content.width/2;return r<s?e+(s-r):c>a?e-(c-a):e}toString(){return`[Tooltip "${this.content.title}" (${this.mode})]`}}t.Tooltip=h},89422:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TooltipMode=t.TooltipContent=t.Container=t.Triangle=void 0,t.Triangle=Phaser.GameObjects.Triangle,t.Container=Phaser.GameObjects.Container;const s=i(84892),n=i(5893),a=i(97119),o=i(1909),r=i(24917),c=i(5715),l=i(99694),d=i(28367);class h extends t.Container{constructor(e){super(e),this.counters=[],this.padding=0,this.tweener=new a.Tweener(this.scene,{duration:d.LAYOUT.expandTransitionDuration,ease:"Sine.easeInOut"}),this.fullSize={width:0,height:0};const t=o.UiBuilder.for(e);this.countersPool=new n.Pool((()=>({icon:t.image("").setOrigin(0,.5),text:t.text("",r.BitmapFont.Mini,c.Colors.glassUi.primaryText).setOrigin(0,.5)}))).preload(1),this.icon=t.image(""),this.title=t.text("title",r.BitmapFont.Mini,c.Colors.tooltip.text),this.description=t.text("tooltip description",r.BitmapFont.Mini,c.Colors.tooltip.text).setMaxWidth(d.LAYOUT.maxWidth),this.backgroundBox=new s.RoundedRect(e,{radius:6,fillStyle:{color:c.Colors.tooltip.background,alpha:1}}),this.backgroundBox.preUpdate.enableEagerUpdates(),this.add([this.backgroundBox,this.title,this.icon,this.description])}setProps(e){const t=e.style??d.TOOLTIP_STYLE.default;this.padding=t.padding,e.icon?(this.icon.setFrame(e.icon),this.icon.setVisible(!0)):this.icon.setVisible(!1),this.title.setText(e.title),this.description.setText(e.description??""),this.description.setVisible(!1),this.counters.forEach((e=>{this.remove([e.icon,e.text]),e.icon.setVisible(!1),e.text.setVisible(!1),this.countersPool.free(e)})),this.counters=[],e.counters?.forEach((e=>{const t=this.countersPool.take();t.icon.setFrame(e.icon).setOrigin(0,.5).setTint(e.color).setVisible(!0),t.text.setText(e.value.toString()).setTint(e.color).setVisible(!0),this.add([t.icon,t.text]),this.counters.push(t)})),this.updateLayout()}updateLayout(){const e=!!this.description.text.length;this.icon.setOrigin(0,0),l.Arrange.fromLeftToRightOld([this.icon,this.title],{x:this.padding,y:this.padding+this.title.height/2,originY:.5,spacing:d.LAYOUT.spacing});let t=this.title.x+this.title.width;this.counters.length&&(t+=d.LAYOUT.spacing);const i=this.padding+this.title.height/2;for(const e of this.counters)t+=d.LAYOUT.spacing,e.icon.setPosition(t,i),t+=e.icon.width+4,e.text.setPosition(t,i),t+=e.text.width;this.description.setPosition(this.padding,this.title.y+this.title.height+d.LAYOUT.spacing),this.width=t+this.padding,this.height=this.title.y+this.title.height+this.padding,this.fullSize.width=Math.max(this.width,this.description.x+this.description.width+this.padding),this.fullSize.height=e?this.description.y+this.description.height+this.padding:this.height,this.backgroundBox.setPosition(0,0),this.backgroundBox.setSize(this.width,this.height)}expand(){if(!this.description.text.length)return;this.description.setVisible(!0),this.height=this.fullSize.height,this.width=this.fullSize.width;const e=this.description.maxWidth;this.tweener.add({targets:this.description,alpha:{from:0,to:1},maxWidth:{from:0,to:e},scale:{from:0,to:1}}),this.tweener.add({targets:this.backgroundBox,width:this.width,height:this.height})}}var u;t.TooltipContent=h,(u=t.TooltipMode||(t.TooltipMode={})).Hidden="hidden",u.Shown="shown",u.Expanded="expanded",u.ScheduledToShow="about-to-show"},38952:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnDescriptions=t.pawnTypeToStr=t.getPawnDescription=t.getPawnTypeTooltip=t.TooltipCounters=t.TooltipsManager=t.TooltipType=void 0;const s=i(1909),n=i(28367),a=i(20666),o=i(5715),r=i(30420),c=i(96486),l=i(71234),d=i(89422),h=i(88865),u=i(58592),p=i(6810);var g;function m(e,t){const i=u.app.scene.worldMap.overlays.pawnSymbols.getCurrentSymbol(e.id);if(i&&i.type!==p.PawnSymbolType.Arrow)return{title:i.message,icon:(0,l.getFrameForPawnSymbol)(i.type),enforceDelay:!1,type:g.Hover};{const i=y(e.type,e.faction?.isLocalPlayer()?"own":"hostile");return{...i,counters:[...i.counters??[],...t],enforceDelay:!0,type:g.Hover}}}function y(e,i="own"){const s=[],n=h.inject.gameStateModel.rules.pawns(e);return n.might>0&&!n.isInvincible()&&s.push(t.TooltipCounters.might(n.might)),"buyable"!==i&&"unaffordable"!==i||s.push(t.TooltipCounters.coins(n.cost)),n.upkeep>0&&"hostile"!==i&&s.push(t.TooltipCounters.upkeep(n.upkeep)),{title:b(e),description:f(n,i),counters:s}}function f(e,t){return[w(e,t),v(e,t)].filter((e=>e)).join("\n")}function w(e,t){return"own"===t&&e.upkeep?`Costs you ${e.upkeep} coins each turn.`:"buyable"===t?`Costs ${e.cost} coins now and ${e.upkeep} coins each turn.`:void 0}function v(e,i){if("unaffordable"==i)return"Not enough coins in treasury to buy this unit!";const s=t.PawnDescriptions[e.type];return s?s["hostile"===i?i:"default"]??s.default:void 0}function b(e){return(0,c.capitalize)(e).replaceAll("-"," ")}!function(e){e.Hover="hover",e.Permanent="permanent"}(g=t.TooltipType||(t.TooltipType={})),t.TooltipsManager=class{get currentTooltip(){return this.scene?.tooltip}get activeTooltip(){const e=this.scene?.tooltip;if(e?.mode!==d.TooltipMode.ScheduledToShow&&e?.mode!==d.TooltipMode.Hidden)return e}get ui(){return this._builder||(this._builder=s.UiBuilder.for(u.app.scene.globalUI)),this._builder}get scene(){return u.app.scene.globalUI}close(){u.app.scene.globalUI?.tooltip.hide()}show(e){return u.app.scene.globalUI.addTooltip(e)}showOver(e,t){return this.show({...t,placement:n.TooltipPlacement.overUiObject(e)})}showAt(e,t,i,s){return this.show({...s,placement:n.TooltipPlacement.atGlobalXY(e,t,i)})}showAtHex(e,t){return this.show({...t,placement:n.TooltipPlacement.atWorldMapHex(e)})}showDefenderTaunt(e,t,i){if(i.hasTrait(a.PawnTraits.Impenetrable)||i.faction===h.inject.gameStateModel.currentPhase.faction)return;const s=i.hex===e?h.inject.random.oneOf(["Nice try!","Nope!","You wish!","@#!"]):"Not on my watch!",o=i.hex===e?0:300;return this.show({placement:n.TooltipPlacement.atWorldMapHex(i.hex),title:s,type:g.Hover,style:n.TOOLTIP_STYLE.speechBubble,delayMs:o,expireAfterMs:900,enforceDelay:!0})}showHexTooltip(e,t=!1){const i=h.inject.gameStateModel,s=i.pawns.findOne({hexes:e,traits:[a.PawnTraits.OccupiesTile]}),n=i.pawns.findOne({hexes:e,type:[r.PawnType.Coins]});let c=[];if(s){n&&n.count>0&&c.push({value:n.count,icon:"ui/mini-icons/coins-flat",color:o.Colors.tooltip.coinsCounter});const i=this.showAtHex(e,{...m(s,c),delayMs:t?0:void 0});return this.latestHexTooltip={hex:e,tooltip:i},i}u.app.tooltips.close()}toggleHexTooltip(e){this.latestHexTooltip?.hex===e&&this.latestHexTooltip.tooltip.visible?this.close():this.showHexTooltip(e,!0)}removeTooltip(e){u.app.scene.globalUI.removeTooltip(e)}},t.TooltipCounters={coins:e=>({value:e,color:o.Colors.tooltip.coinsCounter,icon:"ui/mini-icons/coins-flat"}),might:e=>({value:e,color:o.Colors.tooltip.mightCounter,icon:"ui/mini-icons/might"}),upkeep:e=>({value:e,color:o.Colors.tooltip.coinsCounter,icon:"ui/mini-icons/upkeep"})},t.getPawnTypeTooltip=y,t.getPawnDescription=f,t.pawnTypeToStr=b,t.PawnDescriptions={[r.PawnType.Town]:{hostile:"The province treasury is stored here. Would be real shame if something happened to it!\nTowns also protect adjacent tiles from enemy villagers.",default:"The province treasury is stored here. Don't let your enemies raze it!\nTowns also protect adjacent tiles from enemy villagers."},[r.PawnType.Villager]:{default:"Great for capturing undefended territory and dealing with bandits. Protects surrounding tiles from enemy villagers."},[r.PawnType.Pikeman]:{default:"Stronger than towns and villagers, but can't deal with castles."},[r.PawnType.Knight]:{default:"Borderline unstopabble, only other knights or heroes can stand in his way.\b Requires a lot of coins to maintain though!"},[r.PawnType.Hero]:{default:"Unstopabble tool of destruction, only other heroes can hope to challenge him.\b Demands insane amount of coins each turn though!"},[r.PawnType.Castle]:{default:"Protects adjacent tiles from enemy villagers and pikemen."},[r.PawnType.Forest]:{default:"Impassable terrain."},[r.PawnType.Bandit]:{default:"Loyal to no one but himself, a bandit moves randomly around the map and plunders tiles for coins. It can be defeated by any unit, even a villager."},[r.PawnType.Camp]:{default:"Bandits store any coins they plunder in the nearest camp.\nWhen the camp has enough coins stored, it will produce a new bandit!"},[r.PawnType.Zombie]:{default:"Zombies infect adjacent units and towns. Keep them at bay with walls and castles!"},[r.PawnType.HauntedTown]:{default:"This forsaken town spawns a zombie every turn!"},[r.PawnType.Present]:{default:"How sweet!"},[r.PawnType.Chest]:{default:"Sweet loot awaits for the first one to claim it!"}}},48179:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CenterLayout=t.LayoutChildrenPolicy=void 0;const s=i(70319);var n;(n=t.LayoutChildrenPolicy||(t.LayoutChildrenPolicy={})).None="none",n.Stretch="stretch";class a extends s.BaseResponsiveContainer{constructor(e,t){super(e),this.content=t,this.add(t)}updateLayout(){this.content.setPosition(this.width/2,this.height/2)}}t.CenterLayout=a},43733:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HLayout=void 0;const s=i(70319),n=i(99694),a=i(50668);var o=Phaser.GameObjects.BitmapText;class r extends s.AutoWidthResponsiveContainer{constructor(e,t){super(e),this.props={layoutPolicy:a.LayoutChildrenPolicy.Stretch,originX:0,originY:0,horizontalPadding:0,verticalPadding:0,...t},this.add(t.content),t.height?this.height=t.height:this.height=Math.max(...t.content.map((e=>e.height)))}handleChildResize(e){this.preUpdate.makeDirty(),this.updateSize()}updateLayout(){const e=this.props.content;if(this.props.layoutPolicy===a.LayoutChildrenPolicy.Stretch)for(let t of e)t instanceof o||(t.height=this.height);n.Arrange.fromLeftToRightOld(e,{x:this.props.horizontalPadding+this.width*this.props.originX,y:(this.height-2*this.props.verticalPadding)*this.props.originY,originX:this.props.originX??0,originY:this.props.originY??0,spacing:this.props.spacing}),this.updateSize()}calculateWidth(){const e=this.props.content[0],t=this.props.content[this.props.content.length-1];return e&&t?t.x+t.width-e.x:0}}t.HLayout=r},27526:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalDialogContentLayout=t.DialogButtonRole=void 0;const s=i(4126),n=i(62622),a=i(70319),o=i(23441),r=i(30237);var c;(c=t.DialogButtonRole||(t.DialogButtonRole={}))[c.Regular=0]="Regular",c[c.PrimaryGreen=1]="PrimaryGreen",c[c.PrimaryDanger=2]="PrimaryDanger";const l=16;class d extends a.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.contentBox=new s.Box(e,s.BoxTextures.InnerPlate),this.content=t.content,this.buttonGroup=new n.DialogButtonGroup(e,{buttons:t.buttons,onClicked:t.onClicked}),this.add([this.contentBox,this.content,this.buttonGroup])}updateLayout(){this.content.width+32>this.width&&(this.content.width=this.width-32),this.content.setPosition(l,l),this.contentBox.setSize(this.width,this.content.height+32+this.buttonGroup.height/2),this.buttonGroup.updateLayout(),this.buttonGroup.setPosition(this.width/2-this.buttonGroup.width/2,this.contentBox.y+this.contentBox.height-this.buttonGroup.height/2),this.updateSize()}calculateHeight(){return this.contentBox.height+this.buttonGroup.height/2}setMaxWidth(e){this.width=(0,o.pickSmaller)(e,this.content.width+32),this.content instanceof r.Label&&this.content.setMaxWidth(e)}setContent(e){this.content!==e&&(this.content&&(this.remove(this.content),this.content.destroy()),this.content=e,this.add(this.content),this.preUpdate.makeDirty())}}t.ModalDialogContentLayout=d},50162:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ref=t.Ref=void 0;const s=i(52937);t.Ref=class{constructor(e){this.current=e,this.onChanged=(0,s.signal)()}set(e){this.current!==e&&(this.current=e,this.onChanged.fire(e))}},t.ref=function(e){const t=(0,s.signal)(),i={current:e,set:e=>{e!==i.current&&(i.current=e,t.fire(e))},onChanged:t};return i}},1909:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ButtonTemplate=t.UiBuilder=void 0;const s=i(24917),n=i(5715),a=i(50668),o=i(43733),r=i(48179),c=i(17120),l=i(29301),d=i(96465),h=i(4126),u=i(84892),p=i(98691),g=i(39953),m=i(97569),y=i(12678),f=i(97720);var w=Phaser.GameObjects.BitmapText;class v{static for(e){let t=this._instances.get(e.scene.key);return t||(t=new v(e),this._instances.set(e.scene.key,t)),t}constructor(e){this.scene=e}caption(e){return this.text(e,s.BitmapFont.Main,n.Colors.glassUi.primaryText)}paragraph(e){return this.text(e,s.BitmapFont.Small,n.Colors.glassUi.primaryText)}rectangle(e,t=1){return new Phaser.GameObjects.Rectangle(this.scene,0,0,0,0,e,t).setOrigin(0,0)}roundedRect(e,t,i=1){return new u.RoundedRect(this.scene,{radius:e,fillStyle:{color:t,alpha:i}})}image(e,t){const i=new Phaser.GameObjects.Image(this.scene,0,0,"atlas",e);return void 0!==t&&i.setTint(t),i}centered(e){return new r.CenterLayout(this.scene,e)}vLayout(e){return new a.VLayout(this.scene,e)}hLayout(e){return new o.HLayout(this.scene,e)}text(e,t,i){const{ref:s,value:n}=b(e),a=new w(this.scene,0,0,t,n).setTint(i);return s&&s.onChanged((e=>a.setText(e))),a}textContainer(e,t,i){return new f.ResponsiveTextContainer(this.scene,this.text(e,t,i))}richText(e,t){const{ref:i,value:s}=b(e),n=new p.RichText(this.scene,0,0,s,{fontFamily:"Roboto, Verdana, Arial",fontSize:"14px",wrap:{mode:1,width:0}}).setTint(t).setLineSpacing(3);return i&&i.onChanged((e=>n.setText(e))),n}button(e,t){const i=e(this.scene,t);return t.tooltip&&i.setData("tooltip",t.tooltip),i}}function b(e){return"object"==typeof e?{ref:e,value:e.current}:{ref:void 0,value:e}}function S(e,t){const i=v.for(e);return"string"==typeof t?i.image(t).setOrigin(0,0):t.setOrigin(0,0)}t.UiBuilder=v,v._instances=new Map,t.ButtonTemplate={SmallCircleButton:(e,t)=>{y.assert.defined(t.icon);const i=new g.CircleButton(e,{content:S(e,t.icon),audio:!0,size:30,style:{[m.ButtonState.Rest]:{tint:n.Colors.glassUi.secondaryText,backgroundColor:n.Colors.glassUi.shape},[m.ButtonState.Down]:{tint:n.Colors.glassUi.secondaryText,backgroundColor:n.Colors.glassUi.shapeLightAccent}}});return i.onClicked(t.onClicked),i},SmallRibbonButton:(e,t)=>{const i=new c.RibbonButton(e,0,0,{type:c.RibbonButtonStyle.Small,content:new w(e,0,0,s.BitmapFont.Small,t.text).setTint(n.Colors.glassUi.primaryText),width:120});return i.onClicked(t.onClicked),i},MiniStealthButton(e,t){const i=function(e,t,i){const a=v.for(e),o=i?a.text(i,s.BitmapFont.Mini,n.Colors.glassUi.primaryText).setOrigin(0,0):void 0,r=t?S(e,t):void 0;return o&&r?a.hLayout({content:[r,o],spacing:4,originY:.5,originX:0}):o||r}(e,t.icon,t.text),a=new l.StealthButton(e,{content:i});return a.width=i.width+14,a.height=20,a.onClicked(t.onClicked),a},MainActionButton(e,t){const i=v.for(e),s=new d.BoxButton(e,0,0,{content:i.caption(t.text??""),width:200,height:46,baseTexture:h.BoxTextures.DialogButton,downTexture:h.BoxTextures.DialogButtonDown});return s.onClicked(t.onClicked),s},AlternativeActionButton(e,t){const i=v.for(e),s=new c.RibbonButton(e,0,0,{type:c.RibbonButtonStyle.Small,width:180,content:i.caption(t.text??"")});return s.onClicked(t.onClicked),s}}},40169:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UiDebugLayer=t.getDebugRect=t.DebugColors=void 0;var i,s=Phaser.GameObjects.Line,n=Phaser.GameObjects.Rectangle;function a(e,t,i,s,a,o=255){const r=new n(e,t,i,s,a).setStrokeStyle(1,o,1);return r.setOrigin(0,0),r.setPosition(t,i),r}!function(e){e[e.blue=255]="blue",e[e.green=65280]="green",e[e.red=16711680]="red"}(i=t.DebugColors||(t.DebugColors={})),t.getDebugRect=a,t.UiDebugLayer=class{constructor(e,t){this.scene=e,this.objects=[],this.target=t||{add:e=>this.scene.add.existing(e)}}clear(){return this.objects.forEach((e=>e.destroy())),this}addRect(e,t,s,n,o=i.blue){const r=a(this.scene,e,t,s,n,o);return this.target.add(r),this.objects.push(r),this}addRectAround(e,t=i.blue){return this.addRect(e.x,e.y,e.width,e.height,t),this}addHorizontalLine(e,t=i.blue){const n=this.scene.cameras.main,a=new s(this.scene,0,0,n.x,e,n.x+n.width,e,t).setStrokeStyle(1,t).setOrigin(0,0);return this.target.add(a),this}addVerticalLine(e,t=i.blue){const n=this.scene.cameras.main,a=new s(this.scene,0,0,e,n.y,e,n.y+n.height,t).setStrokeStyle(1,t).setOrigin(0,0);return this.target.add(a),this}}},50668:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VLayout=t.LayoutChildrenPolicy=void 0;const s=i(70319),n=i(99694);var a,o=Phaser.GameObjects.BitmapText;!function(e){e.None="none",e.Stretch="stretch"}(a=t.LayoutChildrenPolicy||(t.LayoutChildrenPolicy={}));class r extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.props={layoutPolicy:a.Stretch,originX:0,originY:0,horizontalPadding:0,verticalPadding:0,width:0,...t},this.width=this.props.width,this.add(t.content)}handleChildResize(e){this.preUpdate.makeDirty(),this.updateSize()}updateLayout(){const e=this.props.content;if(this.props.layoutPolicy===a.Stretch)for(let t of e)t instanceof o?t.setMaxWidth(this.width):t.width=this.width;n.Arrange.fromTopToBottomOld(e,{x:this.width*this.props.originX,y:this.height*this.props.originY,originX:this.props.originX,originY:this.props.originY,spacing:this.props.spacing}),this.updateSize()}calculateHeight(){const e=this.props.content[this.props.content.length-1];return e?e.y+e.height:0}}t.VLayout=r},62622:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DialogButtonGroup=void 0;const s=i(56996),n=i(27526),a=i(85912),o=i(96465),r=i(4126),c=i(24917),l=i(5715),d=i(70319);var h=Phaser.GameObjects.BitmapText;const u=16,p=4;class g extends d.AutoWidthResponsiveContainer{constructor(e,t){super(e),this.props=t,this.buttonRibbon=new s.Ribbon(this.scene,s.RibbonTextures.ButtonGroup),this.buttons=[],this.buttons=this.props.buttons.map((e=>this.createButton(e))),this.height=this.buttonRibbon.height,this.add([this.buttonRibbon,...this.buttons])}getButtonWidth(){return this.buttons[0].width||0}updateLayout(){const e=this.calculateWidth();this.buttonRibbon.width=e,(0,a.layoutFromLeftToRight)(u,p,4,this.buttons),this.updateSize()}calculateWidth(){return 2*u+this.getButtonWidth()*this.buttons.length+4*(this.buttons.length-1)}doCreateButton(e,t,i=l.Colors.woodenUi.primaryText,s){const n=new o.BoxButton(this.scene,0,0,{baseTexture:r.BoxTextures.DialogButton,downTexture:r.BoxTextures.DialogButtonDown,content:new h(this.scene,0,0,c.BitmapFont.Small,e).setTint(i),buttonTint:s,width:142,height:46});return n.onClicked(t),n}createButton(e){switch(e.role){case n.DialogButtonRole.Regular:return this.doCreateButton(e.text,(()=>this.props.onClicked(e.text)));case n.DialogButtonRole.PrimaryGreen:return this.doCreateButton(e.text,(()=>this.props.onClicked(e.text)),2376723,10026855);case n.DialogButtonRole.PrimaryDanger:return this.doCreateButton(e.text,(()=>this.props.onClicked(e.text)),4461331,16750968)}}}t.DialogButtonGroup=g},30237:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Label=void 0;var s=Phaser.GameObjects.BitmapText;const n=i(24917);t.Label=class extends s{constructor(e,t,i={}){super(e,0,0,n.BitmapFont.Main,t),this.props=i,this.setTint(i.color??5583648).setOrigin(0,0),i.width&&this.setMaxWidth(i.width),i.shadow&&this.setDropShadow(2,2,0,1)}set width(e){this.setMaxWidth(e)}get width(){return super.getTextBounds().global.width}}},31856:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalWindow=void 0;const s=i(4126),n=i(56996),a=i(30237),o=i(97119),r=i(70319),c=i(1909),l=i(29301),d=i(5715),h=i(52937),u=10,p=55,g=10,m=6,y=4,f=6,w=30;class v extends r.BaseResponsiveContainer{constructor(e,t){super(e),this.scene=e,this.ui=c.UiBuilder.for(this.scene),this.chrome=new s.Box(this.scene,s.BoxTextures.WindowFrame),this.headerRibbon=new n.Ribbon(this.scene,n.RibbonTextures.WindowHeader),this.headerLeftStrap=this.ui.image("ui/window-header-strap").setFlipX(!0).setOrigin(1,0),this.headerRightStrap=this.ui.image("ui/window-header-strap"),this.headerText=new a.Label(this.scene,"",{color:16777215,align:"center",shadow:!0}),this.closeButton=new l.StealthButton(this.scene,{content:this.ui.image("ui/button-icons/exit").setTint(d.Colors.glassUi.primaryText)}),this.tweener=new o.BasicTweener,this.onCancel=(0,h.signal)(),this.props={title:""},this.closeButton.onClicked((()=>{this.onCancel.fire()})),this.add([this.headerLeftStrap,this.headerRightStrap,this.chrome,this.headerRibbon,this.headerText,this.closeButton]),this.setProps(t)}animateIn(){this.addToDisplayList(),this.preUpdate.force();const e=[];e.push(this.scene.tweens.add({targets:this,scale:{from:.1,to:1},alpha:{from:.1,to:1},duration:400,ease:"Back.easeOut"}));const t=this.headerLeftStrap.x;this.headerLeftStrap.x=t+24,e.push(this.scene.tweens.add({targets:this.headerLeftStrap,x:t,duration:400,ease:"Sine.easeIn"}));const i=this.headerRightStrap.x;this.headerRightStrap.x=i-24,e.push(this.scene.tweens.add({targets:this.headerRightStrap,x:i,duration:400,ease:"Sine.easeIn"})),this.tweener.setTweens(e)}animateOut(){this.tweener.setTweens([this.scene.tweens.add({targets:this,scale:{from:1,to:.1},alpha:{from:1,to:0},duration:200,ease:"Sine.easeOut"})],(()=>this.removeFromDisplayList()))}setProps(e){this.props=e,this.headerText.setText(e.title),e.content&&this.setContent(e.content),this.preUpdate.makeDirty()}setContent(e){this.content!==e&&(this.content&&(this.remove(this.content),this.scene.children.remove(this.content)),this.content=e,this.add(e),this.preUpdate.makeDirty())}updateLayout(){if(!this.content)return;let e=this.content.width+2*u,t=this.content.height+p+g;e>this.scene.bounds.width&&(this.content.width=this.scene.bounds.width-2*u,e=this.scene.bounds.width);const i={x:-e/2,y:-t/2};this.headerText.setPosition(-this.headerText.width/2,i.y+y+9),this.closeButton.setSize(26,26),this.closeButton.setPosition(i.x+e-36,i.y+15),this.chrome.setPosition(i.x,i.y),this.chrome.setSize(e,t),this.headerRibbon.setPosition(i.x-m,i.y+y),this.headerRibbon.width=e+2*m,this.headerLeftStrap.setPosition(i.x-m-w,i.y+y+f),this.headerRightStrap.setPosition(i.x+e+m-this.headerRightStrap.width+w,i.y+y+f),this.content.setPosition(i.x+u,i.y+p)}}t.ModalWindow=v},32466:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaletteSlot=t.Palette=void 0;var s=Phaser.GameObjects.Image,n=Phaser.GameObjects.BitmapText;const a=i(85912),o=i(81363),r=i(24917),c=i(70319),l=i(58592);class d extends c.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.props=t,this.slots=[],this.slotByValue=new Map,this.currentSelection=void 0,this.setProps(this.props)}setProps(e){this.destroySlots(),this.slotByValue.clear();for(let t of e.items){const e=t.map((e=>{const t=new u(this.scene,{icon:e.image,hotkey:e.hotkey,onClick:()=>this.handleValueClicked(e.value)});return this.slotByValue.set(e.value,t),t}));this.slots.push(e),this.add(e)}this.preUpdate.makeDirty()}handleValueClicked(e){l.app.audio.playEffect(o.SoundEffects.ButtonDown),this.select(e),this.props.onItemSelected(e)}select(e){if(this.currentSelection){const e=this.slotByValue.get(this.currentSelection);e&&e.setSelected(!1)}if(this.currentSelection=e,e){const t=this.slotByValue.get(e);t&&t.setSelected(!0)}}forEachSlot(e){for(let t of this.slots)for(let i of t)e(i)}destroySlots(){for(let e of this.slots)for(let t of e)t.destroy();this.slots=[]}updateLayout(){let e=0,t=0;for(let i of this.slots)if((0,a.layoutFromLeftToRight)(0,t,this.props.spacing,i),i.length>0){const s=i[i.length-1].x+i[i.length-1].width;s>e&&(e=s),t+=i[0].height+this.props.spacing}this.updateSize()}calculateHeight(){const e=this.slots[this.slots.length-1][0];return e?e.y+e.height:0}}t.Palette=d;const h="ui/palette-slot";class u extends c.ResponsiveContainer{constructor(e,{icon:t,hotkey:i,onClick:a}){super(e),this.background=new s(e,0,0,"atlas",h),this.icon=t,this.background.setInteractive({useHandCursor:!0}),this.background.on("pointerdown",(()=>a())),this.hotkey=new n(e,0,0,r.BitmapFont.Debug,i).setTint(986895),this.hotkey.setPosition(this.background.width-this.hotkey.width-2,2),this.add([this.background,this.icon,this.hotkey]),this.width=this.background.width,this.height=this.background.height}setSelected(e){this.background.setFrame(e?"ui/palette-slot-selected":h)}updateLayout(){this.icon.setOrigin(.5,.5).setPosition(this.background.width/2,this.background.height/2)}}t.PaletteSlot=u},56952:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.DialogButtons=void 0,(i=t.DialogButtons||(t.DialogButtons={})).OK="OK",i.Save="SAVE",i.Cancel="CANCEL",i.NewGame="START",i.Launch="LAUNCH",i.GiveUp="GIVE UP",i.Restart="RESTART",i.Load="LOAD",i.TurnStart="FIRST MOVE",i.TurnEnd="LAST MOVE",i.EndTurn="END TURN",i.Import="IMPORT",i.DontImport="DONT IMPORT"},85912:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.centerVertically=t.center=t.centerHorizontally=t.layoutFromLeftToRight=void 0,t.layoutFromLeftToRight=function(e,t,i,s){let n=e;for(let e of s)e.setPosition(n,t),n=n+e.width+i},t.centerHorizontally=function(e,t,i,s){e.setPosition(t+s/2-e.width/2,i)},t.center=function(e,t,i,s,n){e.setPosition(t+s/2-e.width/2,i+n/2-e.height/2)},t.centerVertically=function(e,t,i,s){e.y=i+s/2-e.height/2}},56320:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EditMapJSONDialog=void 0;const s=i(56952),n=i(30237),a=i(27526),o=i(82169),r=i(81363),c=i(78295),l=i(50668),d=i(96486),h=i(88865),u=i(58592);t.EditMapJSONDialog=class{getTitle(){return"Edit map JSON data"}getContent(e,t,i){this.textArea||(this.textArea=new c.TextArea(e,{onChange:(0,d.debounce)((e=>this.validate(e)),300,{trailing:!0})}),this.statusLabel=new n.Label(e,"Sanity check OK!"),this.layout=new l.VLayout(e,{content:[this.textArea,this.statusLabel],spacing:16,width:i.width})),this.gameState=t.gameState,this.textArea.setSize(i.width,i.height-this.statusLabel.height-16),this.layout.updateLayout();const s=JSON.stringify(this.gameState,null,2);return this.textArea.setText(s),this.validate(s),this.layout}getButtons(){return[{text:s.DialogButtons.Cancel,role:a.DialogButtonRole.Regular},{text:s.DialogButtons.Save,role:a.DialogButtonRole.PrimaryGreen}]}onBeforeClose(e){if(e===s.DialogButtons.Save){if(!this.validate(this.textArea.text))return u.app.audio.playEffect(r.SoundEffects.Deny),!1;h.inject.gameStateModel.restore(this.gameState),u.app.scene.worldMap.scene.isActive()&&u.app.scene.worldMap?.syncState(h.inject.currentGameState)}return!0}validate(e){let t;try{t=JSON.parse(e)}catch(e){return this.statusLabel.setText(`Invalid JSON: ${e.message.replaceAll("\n","\\n")}`),!1}try{(0,o.decompressGameState)(t)}catch(e){return this.statusLabel.setText(`Invalid GameState: ${e.message.replaceAll("\n","\\n")}`),!1}return this.statusLabel.setText("Sanity check OK!"),this.gameState=t,!0}}},87990:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExportMapDialog=void 0;const s=i(56952),n=i(27526),a=i(30237),o=i(50668),r=i(78295),c=i(23441);t.ExportMapDialog=class{getTitle(){return"Export Map"}getContent(e,t,i){const s=(0,c.pickSmaller)(400,i.width),n=(0,c.pickSmaller)(200,i.height);return this.textArea||(this.textArea=new r.TextArea(e,{autoSelectAll:!0,readOnly:!0}),this.layout=new o.VLayout(e,{content:[new a.Label(e,"This is your map. Keep it somewhere safe!"),this.textArea],spacing:16,width:s})),this.textArea.setText(t.saveData),this.textArea.setSize(s,n),this.layout.preUpdate.force(),this.layout}getButtons(){return[{text:s.DialogButtons.OK,role:n.DialogButtonRole.Regular}]}}},52589:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HtmlDialog=void 0;const s=i(56952),n=i(27526),a=i(22884);t.HtmlDialog=class{getTitle(){return this.title}getContent(e,t,i){return this.iframe||(this.iframe=new a.IFrame(e,{url:"",customCss:"width: 800px; height: 430px"})),this.title=t.title,this.iframe.node.src=t.url,this.iframe}getButtons(){return[{text:s.DialogButtons.OK,role:n.DialogButtonRole.Regular}]}onBeforeClose(e){return this.iframe?.destroy(),this.iframe=void 0,!0}}},63055:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImportMapDialog=void 0;const s=i(56952),n=i(27526),a=i(30237),o=i(96486),r=i(50668),c=i(78295),l=i(23441);t.ImportMapDialog=class{constructor(){this.onLoad=o.noop}getTitle(){return"Load Game"}getContent(e,t,i){const s=(0,l.pickSmaller)(400,i.width),n=(0,l.pickSmaller)(200,i.height);return t.onLoad&&(this.onLoad=t.onLoad),this.textArea||(this.textArea=new c.TextArea(e,{autoSelectAll:!0}),this.layout=new r.VLayout(e,{content:[new a.Label(e,"Paste your map data in the text area below:"),this.textArea],spacing:16,width:s})),this.textArea.setText(""),this.textArea.setSize(s,n),this.layout.preUpdate.force(),this.layout}getButtons(){return[{text:s.DialogButtons.Cancel,role:n.DialogButtonRole.Regular},{text:s.DialogButtons.Load,role:n.DialogButtonRole.PrimaryDanger}]}onBeforeClose(e){return e===s.DialogButtons.Load&&this.onLoad(this.textArea.text.trim()),!0}}},31024:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalDialogUIProvider=void 0;const s=i(56952),n=i(96486),a=i(27526),o=i(23441),r=i(82260),c=i(88865),l=i(91025),d=26,h=70,u=80;t.ModalDialogUIProvider=class{constructor(e){this.contentProvider=e,this.onClose=n.noop}getContent(e,t,i){this.props=t,t.onClose&&(this.onClose=t.onClose),this.plate&&(this.plate.remove(this.plate.content),this.plate.destroy(),this.plate=void 0);const s=this.contentProvider.getContent(e,t,this.toContentMaxSize(i)),n=this.contentProvider.getButtons(t);if(this.plate||(this.plate=new a.ModalDialogContentLayout(e,{content:s,buttons:n,onClicked:e=>this.handleClose(e)})),this.plate.setMaxWidth(i.width),this.primaryButton=n.find((e=>e.role===a.DialogButtonRole.PrimaryDanger||e.role===a.DialogButtonRole.PrimaryGreen))?.text,!this.keys){const t=e.input.keyboard.addKey(r.Input.Keyboard.KeyCodes.ENTER).on("up",(()=>c.inject.events.trigger(l.UserActions.SubmitForm()))),i=e.input.keyboard.addKey(r.Input.Keyboard.KeyCodes.SPACE).on("up",(()=>c.inject.events.trigger(l.UserActions.SubmitForm()))),s=e.input.keyboard.addKey(r.Input.Keyboard.KeyCodes.ESC).on("up",(()=>c.inject.events.trigger(l.UserActions.Cancel())));this.keys=[t,i,s]}return this.plate}handleSubmit(){this.primaryButton&&this.handleClose(this.primaryButton)}toContentMaxSize(e){return{width:(0,o.pickLarger)(100,e.width-2*d),height:(0,o.pickLarger)(100,e.height-h-u)}}handleCancel(){this.props.canCancel&&this.handleClose(s.DialogButtons.Cancel)}handleClose(e){this.keys.forEach((e=>e.enabled=!1)),this.contentProvider.onBeforeClose&&!this.contentProvider.onBeforeClose(e)||this.onClose(e)}getTitle(e){return this.contentProvider.getTitle(e)}onShown(){this.contentProvider.onShown?.()}}},35242:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleDialog=void 0;const s=i(30237);t.SimpleDialog=class{getTitle(e){return e.title}getContent(e,t,i){return this.label||(this.label=new s.Label(e,"")),this.label.setText(t.message),this.label.setMaxWidth(i.width),this.label}getButtons(e){return e.buttons}}},78728:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TextInputDialog=void 0,i(27526);const s=i(30237),n=i(96486),a=i(50668),o=i(23441),r=i(68930),c=i(88865),l=i(91025);t.TextInputDialog=class{constructor(){this.onSubmit=n.noop}getTitle(e){return e.title}getContent(e,t,i){const n=(0,o.pickSmaller)(350,i.width);return this.value=t.value,this.textInput||(this.textInput=new r.TextInput(e,{placeholder:t.inputPlaceholder,text:t.value.current}),this.layout=new a.VLayout(e,{content:[new s.Label(e,t.message),this.textInput],spacing:16,width:n}),this.textInput.node.onkeyup=e=>{13===e.keyCode||"Enter"===e.code?c.inject.events.trigger(l.UserActions.SubmitForm()):27!==e.keyCode&&"Escape"!==e.code||c.inject.events.trigger(l.UserActions.Cancel())}),this.textInput.setValue(this.value.current),this.textInput.selectAll(),this.textInput.node.maxLength=t.maxLength??1e3,this.textInput.width=n,this.layout.preUpdate.force(),this.layout}getButtons(e){return e.buttons}onBeforeClose(e){return this.value.set(this.textInput.text),!0}onShown(){this.textInput.focus()}}},81363:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AudioManager=t.SoundEffects=void 0;const s=i(48500);var n;!function(e){e.Grab="grab.wav",e.Drop="drop.wav",e.Deny="deny.wav",e.ButtonDown="button-down.wav",e.ButtonUp="button-up.wav",e.ShutterClick="shutter-click.wav",e.Victory="victory.mp3",e.Glitter="glitter.mp3",e.Rewind="rewind.mp3",e.Defeat="defeat.mp3",e.TwinkleChimes="twinkle-chimes.mp3"}(n=t.SoundEffects||(t.SoundEffects={})),s.logger.for("audio"),t.AudioManager=class{constructor(e){this.game=e,this.loaded=!1}load(e){for(let t of Object.values(n))e.load.audio(t,`assets/audio/${t}`);e.load.once(Phaser.Loader.Events.COMPLETE,(()=>{this.loaded=!0}))}playEffect(e){this.loaded&&this.game.sound.play(e)}stopEffect(e){this.game.sound.stopByKey(e)}get mute(){return this.game.sound.mute}set mute(e){this.game.sound.mute=e}}},97119:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tweener=t.BasicTweener=t.Tween=void 0,t.Tween=Phaser.Tweens.Tween;const s=i(96486),n=i(48500),a=i(85656),o=n.logger.for("Tweener");t.BasicTweener=class{constructor(){this.currentTweens=new Set,this.currentCallback=s.noop}setTweens(e,t){this.currentTweens.forEach((e=>e.stop())),this.currentTweens=new Set(e),this.currentCallback=t||s.noop,e.forEach((e=>e.on("complete",(e=>this.handleCompleted(e)))))}handleCompleted(e){0!==this.currentTweens.size&&(this.currentTweens.delete(e),0===this.currentTweens.size&&(this.currentCallback(),this.currentCallback=s.noop))}},t.Tweener=class{constructor(e,t={}){this.scene=e,this.defaultTweenConfig=t,this.tweensByTarget=new Map}add(e){const t=e.onComplete,i=Array.isArray(e.targets)?e.targets:[e.targets];if(0===i.length)return void o.trace("ignoring request to add tween with no targets");e.onComplete=(...e)=>{for(let e of i)this.tweensByTarget.delete(e);t?.(...e)};const s=this.scene.tweens.add({...e,...this.defaultTweenConfig});if(e.targets)for(let e of i){const t=this.tweensByTarget.get(e);t&&(1===t.targets.length&&t.targets[0]===e?t.stop():(0,a.removeFromArrayInPlace)(t.targets,e)),this.tweensByTarget.set(e,s)}return s}stop(e=!0){(0,a.stripDuplicatesFrom)(Array.from(this.tweensByTarget.values())).forEach((t=>{t.stop(),e&&t.complete()})),this.tweensByTarget.clear()}hasTweens(){return!!this.tweensByTarget.size}}},74965:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Chunk=t.ChunkedRenderer=t.ChunksRenderingController=void 0;const s=i(85656),n=i(41295),a=i(42526),o=i(34198),r=i(48500),c=i(88865),l=i(64849);r.logger.for("ChunkedRenderer"),t.ChunksRenderingController=class{constructor(e,t,i=o.HEX_WIDTH){this.scene=e,this.renderer=t,this.margin=i,this.camera=this.scene.cameras.main}update(){const e=Phaser.Geom.Rectangle.Inflate(this.camera.worldView,this.margin,this.margin);for(const t of this.renderer.getVisibleChunks())Phaser.Geom.Intersects.RectangleToRectangle(e,t.boundingBox)||t.setVisible(!1);for(const t of this.renderer.getChunksInRect(e))t.setVisible(!0);c.inject.debugData.set("visibleChunks",this.renderer.getVisibleChunks().size.toString()),c.inject.config.debug.integrityChecks?.pawns&&this.integrityCheck()}integrityCheck(){const e=new Map;for(const t of this.renderer.getAllChunks())for(let i of t.group.getChildren()){if(e.has(i))throw new Error(`Object #${(0,l.getObjId)(i)} is owned by two different chunks! #${e.get(i)?.id} and #${t.id}`);e.set(i,t)}}renderEverything(){this.renderer.getAllChunks().forEach((e=>e.setVisible(!0)))}},t.ChunkedRenderer=class{constructor(e,t=5){this.scene=e,this.chunkSize=t,this.chunks={},this.visibleChunks=new Set,this.sectorMap=new n.HexGridSectors(t)}getVisibleChunks(){return this.visibleChunks}getAllChunks(){return Object.values(this.chunks)}getByHex(e){return this.getById(this.sectorMap.getSectorOf(e))}getById(e){return(0,s.getOrCreate)(this.chunks,e,(()=>new d(this,e)))}add(e,t){const i=this.sectorMap.getSectorOf(e);return this.getById(i).add(t),t}remove(e,t){const i=this.sectorMap.getSectorOf(e);return this.getById(i).remove(t),t}getChunksInRect(e){return this.getAllChunks().filter((t=>Phaser.Geom.Intersects.RectangleToRectangle(e,t.boundingBox)))}};class d{constructor(e,t){this.parent=e,this.visible=!1,this.id=t,this.group=new Phaser.GameObjects.Group(e.scene),this.visible=!1,this.boundingBox=(0,a.rectToPhaser)((0,a.multiplyRect)(e.sectorMap.getSectorRect(t),o.HEX_WIDTH,o.HEX_INNER_HEIGHT))}add(e){return this.parent.scene.add.existing(e),this.group.add(e),this.visible?e.addToDisplayList():e.removeFromDisplayList(),e}remove(e){return this.group.remove(e,!0),e.addToDisplayList(),e}setVisible(e){if(e===this.visible)return;const t=this.group.getChildren();e?(this.visible=!0,this.parent.visibleChunks.add(this),t.forEach((e=>e.addToDisplayList()))):(this.visible=!1,this.parent.visibleChunks.delete(this),t.forEach((e=>e.removeFromDisplayList())))}}t.Chunk=d},20327:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ParallelCinematic=t.BaseCinematic=t.BlankCinematic=void 0,t.BlankCinematic={async play(){},playAfter:e=>new Promise((t=>setTimeout(t,e)))};class i{constructor(e){this.scene=e}play(){return new Promise((e=>{this.execute(e)}))}playAfter(e,t){return new Promise((t=>{this.scene.time.addEvent({delay:e,callback:()=>this.execute(t)})}))}}t.BaseCinematic=i,t.ParallelCinematic=class extends i{constructor(e){super(e),this.subCinematics=[]}add(e){this.subCinematics.push(e)}execute(e){Promise.all(this.subCinematics.map((e=>e.play()))).then(e)}}},28489:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.debugBreakPointProvider=void 0;const s=i(88865),n=i(58592);t.debugBreakPointProvider=async function(e,t){if(!s.inject.config.debug.overlay||!s.inject.config.debug.breakpoints)return;const i=s.inject.config.debug.breakpoints;if(Array.isArray(i)&&!i.find((t=>e.startsWith(t))))return;const a=n.app.scene.debug,o=n.app.scene.worldMap,r=n.app.navigator.currentScreen,c=t?t():{};o.syncState(c.state??s.inject.gameStateModel.state),console.warn("HANDLING BREAKPOINT ON",r),await a.handleBreakpoint(e,t?t():{}),console.info("BREAKPOINT HANDLED, WILL RETURN TO",r?.constructor?.name)}},36454:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IsoTileGroup=t.Image=void 0,t.Image=Phaser.GameObjects.Image;const s=i(78179);i(48500).logger.for("IsoTileGroup"),t.IsoTileGroup=class{constructor(e,t,i){this.renderer=e,this.recipe=t,this.postProcessor=i,this.triangles={},this.hexes=s.HexGroup.empty,this.dirtyCorners=[]}addHexes(e){const t=e.filter((e=>!this.hexes.has(e)));this.hexes=this.hexes.with(t);const i=t.getCorners();this.dirtyCorners.push(...i)}setHexes(e){const t=this.hexes.without(e),i=e.without(this.hexes);this.addHexes(i),this.removeHexes(t),this.update()}removeHexes(e){this.hexes=this.hexes.without(e);const t=e.getCorners();this.dirtyCorners.push(...t)}update(){this.dirtyCorners.forEach((e=>this.updateCorner(e))),this.dirtyCorners=[]}updateCorner(e){if(this.triangles[e.id]?.destroy(),this.hexes.hasCorner(e)){const t=this.renderTriangle(e.display,e.sortedHexes);t&&(this.triangles[e.id]=t)}else delete this.triangles[e.id]}renderTriangle(e,i){const s=i.sort(((e,t)=>e.id-t.id)),n=s[0].y===s[1].y,a=(n?"V":"A")+s.map((e=>this.hexes.has(e)?"1":"0")).join(""),o=this.recipe.frames[a];if(!o)return;const r=new t.Image(this.renderer.scene,e.x,e.y,"atlas",`${this.recipe.frameIdBase}/${o.frame}`);if(r.setDepth(this.recipe.baseDepth+r.y),r.setOrigin(.5,0),o.flipY&&(r.flipY=!0,r.y+=r.height),o.flipX&&(r.flipX=!0),o.crop){const{x:e,y:t,width:i,height:s}=o.crop;r.setOrigin(0,0),r.setCrop(e,t,i,s),r.x=r.x-e-i/2,r.y=r.y-t}return r.y-=(n?this.recipe.offsetV:this.recipe.offsetA)||0,this.postProcessor(r),this.renderer.add(s[0],r),r}clear(){Object.values(this.triangles).forEach((e=>e.destroy())),this.triangles={},this.hexes=s.HexGroup.empty}}},65337:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KineticValue=t.KineticValuePhase=void 0;const s=i(48500),n=i(23441);var a;s.logger.for("KineticValue"),function(e){e.Frozen="frozen",e.Sliding="sliding",e.Tweening="tweening",e.Stable="stable"}(a=t.KineticValuePhase||(t.KineticValuePhase={})),t.KineticValue=class{constructor(e,t){this.value=e,this.speed=0,this.phase=a.Stable,this.continueToNextStopThreshold=100,this.min=-99999,this.max=99999,this.maxSpeed=99999,this.drag=t.drag,void 0!==t.min&&(this.min=t.min),void 0!==t.max&&(this.max=t.max),void 0!==t.maxSpeed&&(this.maxSpeed=t.maxSpeed),t.continueToNextStopThreshold&&(this.continueToNextStopThreshold=t.continueToNextStopThreshold),this.stops=Array.isArray(t.stops)?new o(t.stops):t.stops,this.apply=t.apply,this.scene=t.scene,this.apply(this.value)}accelerate(e){this.phase!==a.Frozen&&(this.cancelSnap(),this.phase=a.Sliding,this.speed+=e)}cancelSnap(){this.tween&&(this.tween.stop(),this.tween=void 0),this.targetStop=void 0,this.phase===a.Tweening&&(this.phase=a.Sliding)}freeze(){this.phase=a.Frozen,this.targetStop=void 0}unfreeze(){this.phase===a.Frozen&&(this.phase=a.Sliding,this.speed=0)}pushToNextStop(){if(this.cancelSnap(),this.unfreeze(),this.targetStop=this.stops?.getNextFrom(this.value+.001),void 0!==this.targetStop){const e=c(this.value,this.targetStop,this.drag);this.accelerate(e)}}pushToPrevStop(){if(this.cancelSnap(),this.unfreeze(),this.targetStop=this.stops?.getPreviousFrom(this.value-.001),void 0!==this.targetStop){const e=c(this.value,this.targetStop,this.drag);this.accelerate(e)}}pushTo(e){this.cancelSnap(),this.unfreeze();const t=c(this.value,e,this.drag);this.accelerate(t)}update(e,t){const i=t/1e3,s=this.drag*i;switch(this.phase){case a.Tweening:return this.value=this.tween.getValue(),void this.apply(this.value);case a.Stable:case a.Frozen:return;case a.Sliding:if(this.stops&&(void 0===this.targetStop&&(this.targetStop=function(e,t,i,s,n){const a=n.getPreviousFrom(e-.001),o=n.getNextFrom(e+.001);let c=l(n,e);const d=function(e,t,i,s){const n=t>0?1:-1,a=Math.abs(t)-0,o=e+a*a/(2*i)*n;return o!==r&&(r=o),o}(e,t,s);if(Math.abs(t)>i){const e=l(n,d);c=t>0?e===c&&o||e:e===c&&a||e}return c}(this.value,this.speed,this.continueToNextStopThreshold,this.drag,this.stops),this.targetStop),void 0!==this.targetStop)){const e=c(this.value,this.targetStop,this.drag);if(this.speed||this.targetStop!==this.value)if(this.speed<e){const t=e-this.speed;this.speed+=(0,n.pickSmaller)(t,this.drag*i*2)}else if(this.speed>e){const t=this.speed-e;this.speed-=(0,n.pickSmaller)(t,this.drag*i*2)}}this.speed>0?this.speed-=(0,n.pickSmaller)(this.speed,s):this.speed<0&&(this.speed+=(0,n.pickSmaller)(-this.speed,s)),Math.abs(this.speed)<.001&&(void 0===this.targetStop||Math.abs(this.value-this.targetStop)<1)?(this.phase=a.Stable,this.speed=0,this.targetStop&&(this.value=this.targetStop)):this.value+=this.speed*i,this.applyHardLimits(),this.apply(this.value)}}async tweenTo(e,t,i){return this.cancelSnap(),this.phase=a.Tweening,new Promise((s=>{this.tween=this.scene.tweens.addCounter({from:this.value,to:e,duration:t,ease:i,onComplete:()=>{this.apply(e),this.phase=a.Stable,this.tween=void 0,s()},onStop:()=>{s()}})}))}applyHardLimits(){this.value<this.min&&(this.value=this.min),this.value>this.max&&(this.value=this.max),this.speed>this.maxSpeed?this.speed=this.maxSpeed:this.speed<-this.maxSpeed&&(this.speed=-this.maxSpeed)}setTo(e){this.cancelSnap(),this.speed=0,this.value=e,this.applyHardLimits(),this.apply(e)}};class o{constructor(e){this.stops=e}getNextFrom(e){if(0!==this.stops.length)return this.stops.find((t=>t>=e))}getPreviousFrom(e){if(0!==this.stops.length)return this.stops.slice().reverse().find((t=>t<=e))}}let r=0;function c(e,t,i){const s=Math.abs(e-t),n=e>t?-1:1;return Math.sqrt(2*s*i)*n}function l(e,t){const i=e.getPreviousFrom(t),s=e.getNextFrom(t);return void 0===i?s:void 0===s?i:Math.abs(t-i)>Math.abs(t-s)?s:i}},22827:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LODManager=void 0,t.LODManager=class{constructor(e,t=[]){this.camera=e,this.latestZoom=void 0,this.handlers=t}registerLODlevel(e){this.handlers.push(e)}update(){this.apply(this.camera.zoom)}apply(e,t){if(e!==this.latestZoom||t){for(let i of this.handlers)!i.when(e)||void 0!==this.latestZoom&&!t&&i.when(this.latestZoom)||i.activate(e);this.latestZoom=e}}}},71234:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getShadowFrameForPawnType=t.getFrameForEmojiFace=t.getFrameForPawnSymbol=t.getScaleForPawnType=t.getFrameForPawnType=t.WorldObjectsPool=void 0;var s=Phaser.GameObjects.Group,n=Phaser.GameObjects.Image,a=Phaser.GameObjects.Sprite;const o=i(30420),r=i(48500),c=i(64849),l=i(88865);function d(e,t=1){return e===o.PawnType.Town?"pawns/town-"+t:"pawns/"+e}function h(e){return"tile-symbols/"+e.slice(2)}function u(e){return"attitude-emoji/"+e}function p(e,t=1){return e===o.PawnType.Town?`pawns/town-${t}-shadow`:e===o.PawnType.HauntedTown?"pawns/town-2-shadow":e===o.PawnType.Chest?"pawns/chest-shadow":e===o.PawnType.Present?"pawns/present-shadow":"pawn-shadow"}r.logger.for("WorldObjectPools"),t.WorldObjectsPool=class{constructor(e){this.scene=e,this.coins=new s(this.scene,{defaultKey:"coin",classType:a}),this.coinStacks=new s(this.scene,{defaultKey:"atlas",defaultFrame:"coinstack",classType:n}),this.pawnImages=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"pawns/villager",classType:a}),this.pawnShadows=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"pawn-shadow",classType:n}),this.flags=new s(this.scene,void 0,{defaultKey:"flag",classType:a}),this.flagPoles=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"flag-pole",classType:n}),this.tileSymbols=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"tile-symbols/alert",classType:n}),this.emojiFaces=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"attitude-emoji/12",classType:n}),this.emojiFaceBg=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"attitude-emoji/face-bg",classType:n}),this.emojiCrowns=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"attitude-emoji/crown",classType:n}),this.hearts=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"ui/mini-icons/heart-colored",classType:n}),this.scene.anims.create({key:"wave-flag",frames:this.scene.anims.generateFrameNumbers("flag",{frames:[0,1,2,3,4,5,6,7]}),frameRate:20,repeat:-1})}updateDebugData(){l.inject.config.debug.objectPools?l.inject.debugData.set("worldObjects",`\n  coins: ${this.printGroupStats(this.coins)}\n  coinStacks: ${this.printGroupStats(this.coinStacks)}\n  pawnImages: ${this.printGroupStats(this.pawnImages)}\n  pawnShadows: ${this.printGroupStats(this.pawnShadows)}`):l.inject.debugData.clear("worldObjects")}printGroupStats(e){return`${e.getTotalUsed()}/${e.getChildren().length}`}getPawnImage(e,t){return this.getAndActivate(this.pawnImages).setFrame(d(e,t)).setScale(.5).setRotation(0)}getPawnShadow(e,t){return this.getAndActivate(this.pawnShadows).setFrame(p(e,t)).setScale(.5)}getCoin(e,t){return this.getAndActivate(this.coins).setOrigin(.5,.57143).setPosition(e,t).setFrame(0).setScale(.5)}getCoinStack(e,t){return this.getAndActivate(this.coinStacks).setOrigin(.5,1).setScale(.5).setPosition(e,t)}getFlag(e,t){return this.getAndActivate(this.flags,e,t).setOrigin(0,0)}getFlagPole(e,t){return this.getAndActivate(this.flagPoles,e,t)}getTileSymbol(e){return this.getAndActivate(this.tileSymbols).setFrame(h(e))}getEmojiFace(e){return this.getAndActivate(this.emojiFaces).setFrame(u(e))}getEmojiFaceBg(){return this.getAndActivate(this.emojiFaceBg)}getEmojiCrown(){return this.getAndActivate(this.emojiCrowns)}getHeart(){return this.getAndActivate(this.hearts)}free(e){l.inject.config.debug.objectPools&&e.setActive(!1),e.setVisible(!1)}getAndActivate(e,t,i){e.defaultFrame||e.defaultKey;const s=e.get(t,i).setVisible(!0).setActive(!0).setAlpha(1);return l.inject.config.debug.objectPools&&("?"!==(0,c.getObjId)(s)||(0,c.assignObjId)(s)),s}},t.getFrameForPawnType=d,t.getScaleForPawnType=function(e){return.5},t.getFrameForPawnSymbol=h,t.getFrameForEmojiFace=u,t.getShadowFrameForPawnType=p},81191:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PropTransitionController=void 0;const s=i(88865);t.PropTransitionController=class{constructor(e,t,i,s){this.scene=e,this.target=t,this.propName=i,this._targetValue=0,this.defaultTweenOptions={duration:s.duration??500,ease:s.ease??"Sine.easeOut"}}applyValue(e){this.target[this.propName]=e}get currentValue(){return this.target[this.propName]}get targetValue(){return this.tween?this._targetValue:this.currentValue}setTo(e){this.stopTransition(),this.applyValue(e)}transitionTo(e,t){if(s.inject.ui.skipTransitions())return void this.setTo(e);this.tween&&this.tween.stop(),this._targetValue=e;const i=t?{...this.defaultTweenOptions,...t}:this.defaultTweenOptions;this.tween=this.scene.tweens.add({targets:this.target,props:{[this.propName]:{from:this.target[this.propName],to:e}},duration:i.duration,ease:i.ease,onComplete:()=>{this.setTo(e)}})}stopTransition(){this.tween&&(this.tween.stop(),this.tween=void 0)}}},46453:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Control=t.TransitionController=void 0;const s=i(81191),n=i(88865);class a{constructor(e,t){this.scene=e,this.currentValue=0,this.currentTarget=0,this.currentValue=t.initialValue||0,this.defaultTweenOptions={duration:500,ease:"Sine.easeOut",...t},this.applyValue=t.applyValue}setTo(e){return this.tween&&(this.tween.stop(),this.tween=void 0),this.currentValue=e,this.currentTarget=e,this.applyValue(e),this}transitionTo(e,t){if(n.inject.ui.skipTransitions())return void this.setTo(e);if(this.currentTarget===e)return;this.currentTarget=e,this.tween&&this.tween.stop();const i=t?{...this.defaultTweenOptions,...t}:this.defaultTweenOptions;this.tween=this.scene.tweens.addCounter({from:this.currentValue,to:e,...i,onComplete:()=>{this.setTo(e)}}),this.tween.on("update",(()=>this.onTweenUpdated()))}onTweenUpdated(){this.currentValue=this.tween.getValue(),this.applyValue(this.currentValue)}}t.TransitionController=a,t.Control={visibilityOf:(e,t)=>new a(e.scene,{...t,initialValue:e.alpha,applyValue:t=>e.setAlpha(t)}),propOf:(e,t,i)=>new s.PropTransitionController(e.scene,e,t,{...i})}},5773:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TwoPointersTracker=void 0;const s=i(48500),n=i(85656),a=i(42526);var o;s.logger.for("TwoPointersTracker"),function(e){e.Idle="idle",e.InteractionStarted="interaction-started",e.Drag="drag",e.Pinch="pinch"}(o||(o={})),t.TwoPointersTracker=class{constructor(e){this.scene=e,this.pointers=[],this.pointerMoved={},this.state=o.Idle,this.scene.input.on("pointerdown",this.onPointerDown,this),this.scene.input.on("pointerup",this.onPointerUp,this),this.scene.input.on("gameout",this.dragCancel,this),this.scene.input.on("pointermove",this.onPointerMove,this)}onPointerDown(e){if(2!==this.pointers.length&&-1===this.pointers.indexOf(e))switch(this.pointerMoved[e.id]=!1,this.pointers.push(e),this.state){case o.Idle:this.hasInteraction(e)?(this.onStartInteraction(e),setTimeout((()=>this.transitionToDrag(e)),200),this.state=o.InteractionStarted):(this.onStartDrag(e),this.state=o.Drag);break;case o.InteractionStarted:this.state=o.Pinch,this.onAbortInteraction(e),this.onStartPinch(e);break;case o.Drag:this.state=o.Pinch,this.onEndDrag(e),this.onStartPinch(e)}}onPointerUp(e){if(-1!==this.pointers.indexOf(e))switch((0,n.removeFromArrayInPlace)(this.pointers,e),this.state){case o.InteractionStarted:this.state=o.Idle,this.onCompleteInteraction(e);break;case o.Drag:this.state=o.Idle,this.onEndDrag(e);break;case o.Pinch:this.state=o.Drag,this.onEndPinch(e),this.onStartDrag(e)}else this.onCompleteInteraction(e)}onPointerMove(e){if(e.isDown&&(this.pointerMoved[e.id]||(this.pointerMoved[e.id]=e.x!==e.downX||e.y!==e.downY),this.pointerMoved[e.id]))switch(this.state){case o.Drag:this.onDrag(e);break;case o.Pinch:this.onPinch(e)}}transitionToDrag(e){this.state===o.InteractionStarted&&(this.onStartDrag(e),this.state=o.Drag)}dragCancel(){return this.state===o.Pinch&&this.onEndPinch(this.scene.input.activePointer),this.state===o.Drag&&this.onEndDrag(this.scene.input.activePointer),this.clear(),this}hasInteraction(e){return!1}clear(){this.pointers.length=0,this.pointerMoved={},this.state=o.Idle}get distanceBetweenPointers(){if(this.state!==o.Pinch)return 0;const e=this.pointers[0],t=this.pointers[1];return(0,a.euclidDistance)(e,t)}onStartDrag(e){}onStartInteraction(e){}onAbortInteraction(e){}onCompleteInteraction(e){}onEndDrag(e){}onStartPinch(e){}onEndPinch(e){}onDrag(e){}onPinch(e){}}},86848:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getHexUnderCursor=t.watchableHexUnderCursor=void 0;const s=i(34198),n=i(21103),a=i(24794),o=i(88865);function r(e,t){let i,n,r=(e.input.activePointer.worldX+s.HEX_WIDTH/2)/s.HEX_WIDTH,c=e.input.activePointer.worldY/s.HEX_INNER_HEIGHT,l=r%1,d=c%1;o.inject.debugData,Math.floor(c)%2?l<.5?d<(1-2*l)/3?(i=Math.floor(r),n=Math.floor(c)-1/3):(i=Math.floor(r)+.5,n=Math.floor(c)+2/3):d<1/3-2*(1-l)/3?(i=Math.floor(r)+1,n=Math.floor(c)-1/3):(i=Math.floor(r)+.5,n=Math.floor(c)+2/3):l<.5?d<2*l/3?(i=Math.floor(r)+.5,n=Math.floor(c)-1/3):(i=Math.floor(r),n=Math.floor(c)+2/3):d<2/3-2*l/3?(i=Math.floor(r)+.5,n=Math.floor(c)-1/3):(i=Math.floor(r)+1,n=Math.floor(c)+2/3),i-=1,n-=2/3;let h=Math.round(n),u=Math.round(i+h%2/2);if(t.map.isWithinBounds({r:h,c:u}))return(0,a.getHex)({r:h,c:u})}t.watchableHexUnderCursor=function(){const e=(0,n.watchable)(void 0);return e.update=t=>{const i=o.inject.gameStateModel;t.input.activePointer.updateWorldPoint(t.cameras.main);const s=r(t,i);e.set(s)},e.clear=()=>{e.set(void 0)},e},t.getHexUnderCursor=r},82187:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getObjectCameraRect=t.convertWorldXYToCameraXY=void 0,t.convertWorldXYToCameraXY=function(e,t,i){const s=e.getWorldPoint(0,0);return{x:(t-s.x)*e.zoom,y:(i-s.y)*e.zoom}},t.getObjectCameraRect=function(e){const t={x:0,y:0},i={x:0,y:0},s=e.getWorldTransformMatrix();s.transformPoint(0,0,t),s.transformPoint(e.displayWidth??e.width,e.displayHeight??e.height,i);const n=e.scene.cameras.main;return t.x+=n.x,i.x+=n.x,t.y+=n.y,i.y+=n.y,{x:t.x,y:t.y,width:i.x-t.x,height:i.y-t.y}}},64849:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MEMORY_MARKER=t.debugMethodCalls=t.assignObjId=t.getObjId=void 0;const s=i(12678);let n=1;t.getObjId=function(e){return e.getData("id")||"?"},t.assignObjId=function(e){return e.setData("id",n++),n-1},t.debugMethodCalls=function(e,t,i){(0,s.assert)("function"==typeof e[t]);const n=e[t].bind(e);e[t]=(...s)=>(i?i(...s):console.warn(`${e.constructor.name}.${String(t)} called with`,...s),n(...s))},t.MEMORY_MARKER=class{constructor(){this.stuff=Array(200).fill(0).map((()=>Math.random()))}}},90617:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jump2=t.jump=void 0,t.jump=function(e,t){return e-Math.sin(e*Math.PI)*-t},t.jump2=function(e){return Math.sin(e*Math.PI)}},83742:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupFileDropZone=void 0;const s=i(12678),n=i(58592),a=i(27526),o=i(56952),r=i(58586);t.setupFileDropZone=function(e){const t=document.getElementById(e),i=document.getElementById("file-drop-zone"),c=document.getElementById("phaser-game");async function l(e){e.stopPropagation(),e.preventDefault(),i.classList.add("hidden");const t=e.dataTransfer?.files[0];await async function(e){try{s.assert.defined(e,"You dropped something that is not a file.\nYou have to drag and drop a file from your system.\nDropping a link to a file directly from discord etc.\n won't work unfortunately!"),await async function(e){const t=await e.text();if(!t||"string"!=typeof t)throw new Error("File appears to be empty!");(0,r.parseKonkrData)(t)}(e)}catch(e){n.app.modals.simpleDialog({title:"Data import failed",message:`Oops, that didn't work :(\n${e.message}`,buttons:[{text:o.DialogButtons.OK,role:a.DialogButtonRole.Regular}]})}}(t)}s.assert.defined(t,`cannot create file drop zone: no element found for id '${e}'`),t.ondrop=l,i.ondrop=l,c.ondrop=l,t.ondragover=e=>{e.stopPropagation(),e.preventDefault(),i.classList.remove("hidden")},i.ondragover=e=>{e.stopPropagation(),e.preventDefault()},i.ondragleave=e=>{e.stopPropagation(),e.preventDefault(),i.classList.add("hidden")}}},82369:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getLevelIcon=t.LevelIcons=void 0;const s=i(11041);var n;!function(e){e.Gold="ui/level-icons/gold",e.Silver="ui/level-icons/silver",e.Bronze="ui/level-icons/bronze",e.Fighting="ui/level-icons/in-progress",e.NotStarted="ui/level-icons/no-trophy",e.Defeated="ui/level-icons/rip"}(n=t.LevelIcons||(t.LevelIcons={})),t.getLevelIcon=function(e){switch(s.LevelModel.for(e).getLevelStatus()){case s.LevelStatus.Completed:case s.LevelStatus.Replaying:return n.Gold;case s.LevelStatus.InProgress:return n.Fighting;case s.LevelStatus.Defeated:return n.Defeated;case s.LevelStatus.NotStarted:return n.NotStarted;case s.LevelStatus.Locked:throw new Error("Locked levels not supported yet")}}},30997:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.verifyWorldMapInSync=void 0;const s=i(47613),n=i(30420),a=i(48500).logger.for("integrity");t.verifyWorldMapInSync=function(e,t){const i=new s.StaticGameStateModel(t),o=i.map.getAllHexes();for(const e of o)r(e);function r(t){const s=i.pawns.getCount(t,n.PawnType.Coins);var o,r,c;o=t,(r=e.coins.getOrCreatePile(t).getCurrentAmount())!==(c=s)&&a.error(`Integrity check failed on ${o}! Expected coinsx${r}, found ${c}`)}a.info("WorldMapScene integrity check completed.")}},30781:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugData=void 0;const s=i(88865);t.DebugData=class{constructor(){this.items={}}set(e,t){this.items[e]=t}get(e){return this.items[e]}clear(e){delete this.items[e]}getText(){const e=s.inject.config.debug.dataFilter;return Object.entries(this.items).filter((([t])=>!e||t.includes(e))).map((([e,t])=>`${e}: ${t}`)).join("\n")}}},69072:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameStateHistory=void 0;const s=i(35908),n=i(48500),a=i(98030),o=i(88865),r=i(58089);n.logger.for("StateRecorder"),t.GameStateHistory=class{constructor(){this.capacity=40,this.data=new s.FixedCapacityArray(40),this.currentFrame=0,this.paused=!1}add(e,t=o.inject.gameStateModel.state){this.paused||this.data.push({state:t,label:e})}debugMutationBuilder(e,t,i){const s=new r.Mutator((0,a.getParentEngine)(t),[i.createMutation(e)]).apply();this.add(e,s)}suspendRecording(){this.paused=!0}resumeRecording(){this.paused=!1}getAll(){return this.data.getItems()}get(e){return this.data.get(e)}length(){return this.data.length}}},24762:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelScriptRunner=void 0;const s=i(48500),n=i(75071),a=s.logger.for("LevelScriptRunner");t.LevelScriptRunner=class{constructor(e){this.registry=e,this.currentScript=void 0}setScript(e){const t=this.getNewScriptByName(e);if(this.currentScript!==t){if(this.currentScript)try{this.currentScript.deactivate()}catch(e){n.ErrorTracking.captureNonFatalError(e,`deactivating script ${this.currentScriptName}`)}if(this.currentScript=t,this.currentScriptName=e,t){a.info(`Activating level script ${e}`);try{t.activate()}catch(t){n.ErrorTracking.captureNonFatalError(t,`activating script ${e}`)}}}}getNewScriptByName(e){if(e)try{return e?this.registry.getScript(e):void 0}catch(e){n.ErrorTracking.captureNonFatalError(e,"invalid level script"),this.setScript(void 0)}}}},39835:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NewsBox=void 0;const i=document.getElementById("news-box");let s=!1;t.NewsBox={show(){i&&(i.style.left="40px",i.style.bottom="40px",s=!1)},hide(){i&&!s&&(i.style.bottom=-i.offsetHeight-10+"px",s=!0)}}},97701:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionsLedger=void 0;const s=i(99896),n=i(12678),a=i(48500),o=i(88865);a.logger.for("RegionsLedger"),t.RegionsLedger=class{constructor(){this.ledger=[],this.visited=new Set}get availableRegions(){return this.ledger}refreshAvailableRegions(e){const t=s.CurrentPhase.model(e).faction;n.assert.defined(t);const i=t.getRegions().filter((e=>e.exists&&e.isAlive())).sort(((e,t)=>t.size-e.size));this.ledger=i.map((e=>e.id)),i.filter((e=>!e.isActionable())).forEach((e=>this.visited.add(e.id))),this.updateDebugData()}regionVisited(e){this.visited.add(e),this.updateDebugData()}reset(e){this.visited.clear(),this.refreshAvailableRegions(e)}updateDebugData(){o.inject.debugData.set("regionsLedger",o.inject.ui.regionsLedger.toDebugString())}getNextPendingRegionId(){return this.getPendingRegions()[0]}getPendingRegions(){return this.ledger.filter((e=>!this.visited.has(e)))}getNext(e){if(void 0===e)return this.ledger[0];const t=this.ledger.indexOf(e);return this.ledger[(t+1)%this.ledger.length]}getPrevious(e){if(!e)return this.ledger[this.ledger.length-1];const t=this.ledger.indexOf(e);return 0===t?this.ledger[this.ledger.length-1]:this.ledger[t-1]}isVisited(e){return this.visited.has(e)}isPending(e){return!this.visited.has(e)}hasPendingRegions(){return this.getPendingRegions().length>0}toDebugString(){return Array.from(this.ledger).map((e=>e+(this.visited.has(e)?"":"*"))).join(",")}}},45662:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FirebaseRemoteConfig=void 0;const s=i(51010),n=i(120),a=i(88865);t.FirebaseRemoteConfig=class{get levelTelemetrySampleRate(){return this.number("levelTelemetrySampleRate")}get replaysSampleRate(){return this.number("replaysSampleRate")}number(e){const t=a.inject.config.remoteConfigDefaults[e];return n.Firebase.remoteConfig?(0,s.getValue)(n.Firebase.remoteConfig,e).asNumber()??t:t}}},29635:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameplayStatsCollector=t.BLANK_GAMEPLAY_STATS=void 0;const s=i(48500),n=i(91025),a=i(44188),o=i(88865),r=i(58592),c=s.logger.for("StatsCollector");t.BLANK_GAMEPLAY_STATS=Object.freeze({playTimeSeconds:0,undoCount:0,clicks:0,turns:0,startTime:0,endTime:0,rewindCount:0}),t.GameplayStatsCollector=class{constructor(){this.stats={...t.BLANK_GAMEPLAY_STATS},this.playTimeMeasurementPaused=!0,this.currentLevelId=void 0;const e=o.inject.events;document.addEventListener("visibilitychange",(()=>{document.hidden?this.pausePlayTimeMeasurement():this.resumePlayTimeMeasurement()})),e.on(n.SystemEvents.ScreenActivated,(({screen:e})=>{e===r.app.screen.play?(this.reset(),this.resumePlayTimeMeasurement()):this.pausePlayTimeMeasurement()})),e.on(n.SystemEvents.UserBecameInactive,(()=>{c.info("Tab is inactive"),this.pausePlayTimeMeasurement()})),e.on(n.SystemEvents.UserBecameActive,(()=>{r.app.navigator.currentScreen===r.app.screen.play&&(c.info("Tab is active again"),this.resumePlayTimeMeasurement())})),e.on(n.UserActions.Undo,(()=>{++this.stats.undoCount})),e.on(n.UserActions.ConfirmRewind,(()=>{this.stats.rewindCount||(this.stats.rewindCount=0),++this.stats.rewindCount})),e.on(n.UserActions.EndTurn,(()=>{++this.stats.turns})),e.on(n.WorldMapEvents.StartInteraction,(()=>{++this.stats.clicks})),e.on(n.SystemEvents.LevelSessionStarted,(({levelId:e})=>{this.currentLevelId=e,this.reset()}))}getStats(e){return this.updatePlayTime(),e?{playTimeSeconds:(e.playTimeSeconds??0)+this.stats.playTimeSeconds,undoCount:(e.undoCount??0)+this.stats.undoCount,clicks:(e.clicks??0)+this.stats.clicks,turns:(e.turns??0)+this.stats.turns,startTime:this.stats.startTime,endTime:this.stats.endTime,rewindCount:(e.rewindCount??0)+(this.stats.rewindCount??0)}:{...this.stats}}getSessionStats(e){return!e||(0,a.differenceInMinutes)(Date.now(),e.endTime)>=1?this.getStats():this.getStats(e)}pausePlayTimeMeasurement(){this.updatePlayTime(),this.stats.endTime=Date.now(),this.playTimeMeasurementPaused=!0}resumePlayTimeMeasurement(){this.playTimeMeasurementPaused=!1,this.stats.endTime=Date.now()}updatePlayTime(){if(this.stats.endTime&&!this.playTimeMeasurementPaused){const e=Math.round((Date.now()-this.stats.endTime)/1e3);e>0&&(this.stats.playTimeSeconds+=e)}this.stats.endTime=Date.now()}getDebugString(){const e=this.playTimeMeasurementPaused?0:(Date.now()-this.stats.endTime)/1e3;return`${this.playTimeMeasurementPaused?"[PAUSED]":`t=${(this.stats.playTimeSeconds+e).toFixed()}s`} undos=${this.stats.undoCount} clicks=${this.stats.clicks} turns=${this.stats.turns}`}reset(){this.stats={...t.BLANK_GAMEPLAY_STATS,startTime:Date.now(),endTime:Date.now()}}}},81590:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ActivityWatcher=void 0;const s=i(91025),n=i(88865),a=i(58592),o=function(){let e,t=0,i=!0;function o(){t++,t>10&&r(),n.inject.config.debug.overlay&&n.inject.debugData.set("GameplayStats",a.app.gameplayStats.getDebugString())}function r(){i&&(i=!1,n.inject?.events.trigger(s.SystemEvents.UserBecameInactive()))}function c(){i||n.inject?.events.trigger(s.SystemEvents.UserBecameActive()),i=!0,t=0}return["mousedown","mousemove","keydown","scroll","touchstart"].forEach((e=>{document.addEventListener(e,c,!0)})),document.addEventListener("visibilitychange",(()=>{document.hidden?r():c()})),{start:()=>{e||(e=setInterval(o,1e3))},stop:()=>{e&&(clearInterval(e),e=void 0)}}}();t.ActivityWatcher={start:o.start,stop:o.stop}},51453:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CloudSyncService=t.Collections=t.CloudSyncState=void 0;const s=i(88865),n=i(58592),a=i(70766),o=i(81591),r=i(120),c=i(48500),l=i(21103),d=i(54444),h=i(91539),u=i(91025),p=i(85656),g=i(56952),m=i(27526),y=c.logger.for("CloudSync");var f,w;function v(e){const t=(0,p.filterDictionary)(e,(e=>"campaign"===e.type));return(0,d.cleanse)((0,p.mapDictionary)(t,b))}function b(e){const t={...e};return delete t.snapshots,delete t.inProgress,t}!function(e){e.Disabled="disabled",e.NotAvailable="not-available",e.Synchronizing="syncing",e.Synchronized="synced"}(f=t.CloudSyncState||(t.CloudSyncState={})),function(e){e.userdata="userdata",e.telemetryEvents="telemetry_events_v2"}(w=t.Collections||(t.Collections={})),t.CloudSyncService=class{constructor(){this.status=(0,l.watchable)(f.Synchronizing),this.uploadQueue=new h.AsyncJobQueue((e=>e())),this.uploadQueue.status.watch((e=>{switch(e){case h.QueueStatus.Idle:this.status()===f.Synchronizing&&this.status.set(f.Synchronized);break;case h.QueueStatus.Processing:this.status.set(f.Synchronizing)}}))}initialize(){s.inject.login.state.watch((e=>{if(e===a.LoginState.SignedIn)if(this.currentUserId=s.inject.login.getUserId(),s.inject.login.state()===a.LoginState.SignedIn){const e=this.currentUserId;this.status.set(f.Synchronized),this.remoteListenerUnsub?.(),this.remoteListenerUnsub=(0,o.onSnapshot)((0,o.doc)(r.Firebase.db,w.userdata,e),(t=>{(function(e){return e.metadata.fromCache||e.metadata.hasPendingWrites})(t)||this.handleNewDoc(t.data(),e)}))}else this.status.set(f.Disabled)})),s.inject.events.on(u.SystemEvents.LevelRecordUpdated,(e=>{s.inject.login.state()===a.LoginState.SignedIn&&"campaign"===e.newRecord.type&&this.uploadLevelRecords({[e.levelId]:e.newRecord})}))}uploadLevelRecords(e){this.currentUserId;const t=v(e);0!==Object.keys(t).length&&this.uploadUserData({levels:t})}async handleNewDoc(e,t){if(t!==this.currentUserId)y.warning(`ignoring incoming data for user ${t} - user no longer active`);else if(e){const i=s.inject.userData.current.metadata;i.cloudSyncUserId&&i.cloudSyncUserId!==t&&await n.app.modals.simpleDialog({title:"Import progress?",message:`Do you want to import your current progress into account ${s.inject.login.getUserEmail()}?`,buttons:[{text:g.DialogButtons.DontImport,role:m.DialogButtonRole.PrimaryDanger},{text:g.DialogButtons.Import,role:m.DialogButtonRole.PrimaryGreen}]})===g.DialogButtons.DontImport&&s.inject.userData.clearLevelRecords(),s.inject.userData.setMetadata({cloudSyncUserId:t});const a=s.inject.userData.syncLevelRecords(e.levels);if(y.info(`User data arrived for ${t}`),a.length){const e={};for(let t of a)e[t]=s.inject.userData.getLevelRecordById(t);this.uploadLevelRecords(e)}else this.status.set(f.Synchronized);"intro1"===s.inject.ui.session.levelId&&n.app.navigator.currentScreen===n.app.screen.play&&1===s.inject.gameStateModel.currentPhase.turnNumber&&(s.inject.ui.session.end({origin:"abort-tutorial-after-signin"}),n.app.navigator.goTo(n.app.screen.title),n.app.screen.title.loadLevel())}else y.warning(`no remote data found for user ${t}, uploading local data`),s.inject.userData.setMetadata({cloudSyncUserId:t}),await this.uploadLocalData()}uploadUserData(e){const t=this.currentUserId,i=(0,d.cleanse)(e);this.uploadQueue.addJob((()=>(0,o.setDoc)((0,o.doc)(r.Firebase.db,w.userdata,t),i,{merge:!0}).catch((e=>{y.error("error uploading user data",e)}))))}async uploadLocalData(){const e=v(s.inject.userData.current.levels);this.uploadUserData({levels:e})}}},22766:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getSizeByKey=t.LocalStorage=t.InMemoryStorage=t.STORAGE_KEYS=t.USER_DATA_VERSION=void 0;const s=i(54444);t.USER_DATA_VERSION=2,t.STORAGE_KEYS={CURRENT_USER:"konkr.userId",DEFAULT_USER:"konkr.defaultUserId",SIGN_IN_EMAIL:"konkr.signInEmail",USER_DATA_PREFIX:`konkr.userData.v${t.USER_DATA_VERSION}.`},t.InMemoryStorage=class{constructor(){this.data={}}getItem(e){return this.data[e]??null}setItem(e,t){this.data[e]=t}removeItem(e){delete this.data[e]}entries(){return Object.entries(this.data)}clear(){this.data={}}getSizeInBytes(){return new Blob(Object.values(this.data)).size}},t.LocalStorage=class{getItem(e){return window.localStorage.getItem(e)}setItem(e,t){window.localStorage.setItem(e,t)}removeItem(e){window.localStorage.removeItem(e)}entries(){return Object.entries(window.localStorage)}getSizeInBytes(){return(0,s.sizeOf)(Object.values(window.localStorage))}},t.getSizeByKey=function(e){return e.entries().map((([e,t])=>[e,(0,s.sizeOf)(t)])).sort((([e,t],[i,s])=>s-t))}},68310:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getLevelIdFromSaveGameKey=t.UserDataService=void 0;const s=i(16310),n=i(54444),a=i(11041),o=i(59674),r=i(48500),c=i(91025),l=i(62960),d=i(88865),h=i(58592),u=i(22378),p=i(22766),g=i(24592),m=i(29635),y=i(23441),f=i(85656),w=i(54230),v=i(96486),b=i(91172),S=i(12678),x=i(75071),T=i(22847),P=r.logger.for("UserData");function M(e){return e.slice(o.SAVE_GAME_LOCAL_STORAGE_PREFIX.length,e.lastIndexOf("."))}function I(e,t){const i={...e,inProgress:t.inProgress,snapshots:t.snapshots};return(0,v.isEqual)((0,n.cleanse)(i),(0,n.cleanse)(t))}t.UserDataService=class{constructor(e){this.storage=e}reload(){this.readUserData()}async initialize(){this.readUserData(),d.inject.events.on(c.SystemEvents.UserSignedIn,(({userId:e,previousUserId:t})=>{this.handleNewUserSignedIn(e,t)})),await this.cleanup()}handleNewUserSignedIn(e,t){t&&e!==t&&((0,S.assert)(e===d.inject.login.getUserId()),this.storage.getItem(this.storageKey(e))?this.reload():this.writeUserData())}async cleanup(){await d.inject.mapRegistry.initialize(),this.deleteOrphanedLevelsFromLocalStorage(),this.deleteOrphanedConquestRecords(),this.writeUserData()}deleteOrphanedLevelsFromLocalStorage(){const e=[],t=o.SAVE_GAME_LOCAL_STORAGE_PREFIX;for(const[i,s]of this.storage.entries())if(i.startsWith(t)){const t=M(i);t&&!d.inject.mapRegistry.getLevelInfoById(t)&&this.current.latestLevelId!==t&&e.push(i)}for(let t of e)P.info(`deleting orphaned save data ${t}`),this.storage.removeItem(t)}deleteOrphanedConquestRecords(){this.current.levels=(0,f.filterDictionary)(this.current.levels,((e,t)=>"conquest"!==e.type||t===this.current.latestLevelId))}getLevelRecordById(e){return this.current.levels[e]}async loadGameState(e,t){const i=`${e}/${t}`,s=this.current.levels[e]?.snapshots[t];if(!s)throw new Error(`no data found for save "${i}"`);let n;try{n=(0,g.decodeGameState)(s)}catch(e){throw new Error(`save data corrupted for ${i}`)}if(n.version!==l.CORE_GAMESTATE_SCHEMA_VERSION)throw new Error(`save data not compatible with current version of the game in ${i}`);if(n.map.levelId!==e)throw new Error(`Level id mismatch - expected "${e}", found ${n.map.levelId}"`);return n}rememberChoice(e,t){this.current.rememberedChoices[e]=t,this.writeUserData()}recallChoice(e){return this.current.rememberedChoices[e]}clearLevelProgress(e,t){const i=this.current.levels[e];i&&(i.inProgress&&t&&i.inProgress.levelSessionId&&this.endLevelSession(e,i.inProgress,t),delete i.inProgress,delete i.snapshots[u.SaveGameTags.Autosave],this.current.latestLevelId===e&&(this.current.latestLevelId=void 0),this.writeUserData())}endLevelSession(e,t,i){t.levelSessionId&&(d.inject.ui.session.id===t.levelSessionId?d.inject.ui.session.end({origin:i}):d.inject.events.trigger(c.SystemEvents.LevelSessionOver({levelId:e,origin:i,timestamp:Date.now(),victoryDistance:t.victoryDistance??.5,avgFps:0,minFps:0,playLog:[],sessionId:t.levelSessionId})))}writeUserData(){const e=this.storageKey();try{this.storage.setItem(e,JSON.stringify(this.current))}catch(e){P.warning(`Failed to store user data (${e?.message}), trying to free up some space`),this.dropOldestAutoSave()&&this.writeUserData()}}dropOldestAutoSave(){let e,t=Number.POSITIVE_INFINITY;if(Object.entries(this.current.levels).forEach((([i,s])=>{s.snapshots.auto&&s.stats.endTime<t&&(t=s.stats.endTime,e=i)})),e){P.warning(`Removing old autosave for level ${e} to free up storage space`);const t=this.current.levels[e];return delete t.snapshots.auto,delete t.inProgress,!0}return!1}storageKey(e=d.inject.login.getUserId()){return p.STORAGE_KEYS.USER_DATA_PREFIX+e}readUserData(){const e=this.storage.getItem(this.storageKey())??"{}";this._parseUserData(e),P.info(`User data initialized from local storage (key ${this.storageKey()})`),d.inject.events.trigger(c.SystemEvents.UserDataLoaded(this.current)),this.checkStorageUsage(),this.writeUserData()}checkStorageUsage(){const e=this.storage.getSizeInBytes();e>2e6&&x.ErrorTracking.captureNonFatalError({message:"Dangerously high local storage usage!",totalBytes:e,usageByKey:(0,p.getSizeByKey)(this.storage)},"userData.checkLocalStorage")}_parseUserData(e){let t,i;try{i=JSON.parse(e)}catch(e){P.error("Failed parsing metadata:",e),i={}}function s(){return t||(t=(0,w.defaultUserData)()),t}"object"==typeof i&&i||(P.error("Ignoring invalid metadata"),i={});const n={...s(),metadata:i.metadata??s().metadata,levels:i.levels??s().levels,latestLevelId:i.latestLevelId,rememberedChoices:{...s().rememberedChoices,...i.rememberedChoices},stats:i.stats??s().stats,tutorialsCompleted:i.tutorialsCompleted??s().tutorialsCompleted};this.current=n,t&&this.writeUserData()}saveConquestLevelStartingState(){this.getOrCreateLevelRecord(d.inject.gameStateModel.map.levelId),this.writeUserData()}saveLevelProgress(){const e=d.inject.gameStateModel,t=a.LevelModel.for(e.map.levelId),i=this.getOrCreateLevelRecord(t.id);if(h.app.gameplayStats.getStats().playTimeSeconds>0&&this._updateLevelStats(e.map.levelId),t.parentCampaign&&1===e.currentPhase.turnNumber&&1===e.currentPhase.faction?.id&&0===e.currentPhase.tappedUnits().length)return;i.inProgress={lives:d.inject.ui.session.remainingLives,turnNumber:e.currentPhase.turnNumber,levelSessionId:d.inject.ui.session.id,victoryDistance:(0,T.getCurrentVictoryDistance)()};const s=d.inject.gameStateController.exportStateWithHistory({title:"autosave",snapshotPolicy:["initial","p1-rewind-checkpoints","final"],includeRewinds:!0,sizeLimit:1e3});i.snapshots[u.SaveGameTags.Autosave]=(0,g.encodeGameState)(s),this.current.latestLevelId=e.map.levelId,this.writeUserData()}_updateLevelStats(e){const t=this.current.levels[e].stats;this.current.levels[e].stats=h.app.gameplayStats.getStats(t),this.current.stats.total=h.app.gameplayStats.getStats(this.current.stats.total),this.current.stats.latestSession=h.app.gameplayStats.getSessionStats(this.current.stats.latestSession),h.app.gameplayStats.reset()}getOrCreateLevelRecord(e){if(!this.current.levels[e]){P.info(`Creating new level record for ${e}`);const t=(0,g.encodeGameState)(d.inject.gameStateModel.exportState()),i={type:a.LevelModel.for(e).parentCampaign?"campaign":"conquest",snapshots:{[u.SaveGameTags.Autosave]:t},stats:m.BLANK_GAMEPLAY_STATS,inProgress:{lives:s.DEFAULT_LIVES_PER_LEVEL,turnNumber:d.inject.gameStateModel.currentPhase.turnNumber,levelSessionId:d.inject.ui.session.id,victoryDistance:.5}};"conquest"===i.type&&(i.snapshots[u.SaveGameTags.Start]=t),this.current.levels[e]=i}return this.current.levels[e]}saveLevelOutcome(e){const t=d.inject.gameStateModel,i=a.LevelModel.for(t.map.levelId),s=this.getOrCreateLevelRecord(i.id),n=t.currentPhase.turnNumber;if(i.parentCampaign)if(this._updateLevelStats(i.id),e===u.LevelOutcome.Victory){const e=s.won,t=(0,y.pickSmaller)(n,e?.turns??1/0);s.won={turns:t}}else s.lost={turns:n};this.clearLevelProgress(i.id),this.writeUserData(),d.inject.events.trigger(c.SystemEvents.LevelRecordUpdated({levelId:i.id,newRecord:s}))}getStats(){return this.current.stats}saveFeedback(e){if(!e.levelId)return;const t=this.getLevelRecordById(e.levelId);t&&(t.feedback={mood:e.mood,timestamp:e.timestamp,comment:e.comment},this.writeUserData())}completeTutorial(e){this.current.tutorialsCompleted[e]=!0,this.writeUserData()}hasCompletedTutorial(e){return this.current.tutorialsCompleted[e]??!1}syncLevelRecords(e){const t=new Set;let i=!1;for(let[t,s]of Object.entries(e)){const e=this.current.levels[t];e?I(s,e)||(this.current.levels[t]=(0,b.mergeLevelRecords)(s,e),i=!0):(this.current.levels[t]={...s,snapshots:{}},i=!0)}for(let[i,s]of Object.entries(this.current.levels))e[i]&&I(e[i],s)||t.add(i);return i&&(d.inject.events.trigger(c.SystemEvents.UserDataLoaded(this.current)),this.writeUserData()),Array.from(t)}clearLevelRecords(){this.current.levels={},this.writeUserData()}setMetadata(e){const t={...this.current.metadata,...e};(0,v.isEqual)(t,this.current.metadata)||(this.current.metadata=t,this.writeUserData())}},t.getLevelIdFromSaveGameKey=M},54230:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultUserData=void 0;const s=i(88865),n=i(98047),a=i(58592),o=i(68660),r=i(29635),c=i(22378);t.defaultUserData=()=>({metadata:{cloudSyncUserId:void 0},rememberedChoices:{randomMapOptions:{version:n.MAP_GENERATOR_VERSION,name:s.inject.random.townName(),shape:n.MapShape.Temperate,mode:n.MapMode.Classic,difficulty:n.MapDifficulty.Challenging,size:a.app.device.uiVariant()===o.UiVariant.Compact?n.MapSize.Small:n.MapSize.Medium},feedbackEmail:void 0,spectatingSpeed:s.SpectatingPlaybackSpeed.Normal,cameraFollow:c.CameraFollowPreset.On},levels:{},latestLevelId:void 0,tutorialsCompleted:{},stats:{latestSession:r.BLANK_GAMEPLAY_STATS,total:r.BLANK_GAMEPLAY_STATS}})},91172:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mergeLevelRecords=void 0;const s=i(23441),n=i(29635);function a(e,t){return e||(e={...n.BLANK_GAMEPLAY_STATS,startTime:Date.now()}),t={...n.BLANK_GAMEPLAY_STATS,...t},{clicks:(0,s.pickLarger)(e.clicks,t.clicks),playTimeSeconds:(0,s.pickLarger)(e.playTimeSeconds,t.playTimeSeconds),turns:(0,s.pickLarger)(e.turns,t.turns),endTime:(0,s.pickLarger)(e.endTime,t.endTime),undoCount:(0,s.pickLarger)(e.undoCount,t.undoCount),startTime:(0,s.pickSmaller)(e.startTime,t.startTime),rewindCount:(0,s.pickLarger)(e.rewindCount??0,t.rewindCount??0)}}function o(e,t){return e?t?{turns:(0,s.pickSmaller)(e.turns,t.turns)}:e:t}function r(e,t){return e?t?e.timestamp>t.timestamp?e:t:e:t}t.mergeLevelRecords=function(e,t){return{type:e.type,snapshots:t.snapshots,inProgress:t.inProgress,stats:a(e.stats,t.stats),won:o(e.won,t.won),lost:o(e.lost,t.lost),feedback:r(e.feedback,t.feedback)}}},70697:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.loadOldLevelData=t.migrateUserData=void 0;const s=i(22766),n=i(48500),a=i(24592),o=i(59674),r=i(62960),c=i(16310),l=i(88865),d=i(22378),h=n.logger.for("migrate");function u(e,t,i){const s=e.getItem(o.SAVE_GAME_LOCAL_STORAGE_PREFIX+t+"."+i);if(!s)return;let n;try{n=JSON.parse(s)}catch(e){throw new Error("save data corrupted")}if(n.version!==r.CORE_GAMESTATE_SCHEMA_VERSION)throw new Error("save data not compatible with current version of the game");return n}t.migrateUserData=async function(){try{l.inject.storage.getItem("konkr.userData")&&(h.warning("Found user data in V1 format, migrating..."),await async function(){const e=l.inject.storage;if(e.getItem("konkr.userData")){const t=JSON.parse(e.getItem("konkr.userData"));e.setItem(s.STORAGE_KEYS.DEFAULT_USER,t.userId),e.setItem(s.STORAGE_KEYS.CURRENT_USER,t.userId);const i=await async function(e){const t={};await l.inject.mapRegistry.initialize();for(let s of Object.values(e.savedGamesById)){const n={type:l.inject.mapRegistry.getLevelInfoById(s.levelId)?"campaign":"conquest",snapshots:{},stats:e.stats.perLevel[s.levelId]?.total,feedback:i(s)};if(s.bestResult?.outcome===d.LevelOutcome.Victory?n.won={turns:s.bestResult.turnNumber}:s.bestResult?.outcome===d.LevelOutcome.Defeat&&(n.lost={turns:s.bestResult.turnNumber}),s.levelId&&s.inProgress)try{const e=u(l.inject.storage,s.levelId,d.SaveGameTags.Autosave),t=u(l.inject.storage,s.levelId,d.SaveGameTags.Start);e&&(n.snapshots[d.SaveGameTags.Autosave]=(0,a.encodeGameState)(e)),t&&"conquest"===n.type&&(n.snapshots[d.SaveGameTags.Start]=(0,a.encodeGameState)(t)),n.inProgress={turnNumber:s.inProgress.turnNumber,lives:s.inProgress.lives??c.DEFAULT_LIVES_PER_LEVEL}}catch(e){h.error(`Failed to load save data for ${s.levelId}, skipping`,e)}t[s.levelId]=n}function i(t){const i=e.feedbacks.find((e=>e.levelId===t.levelId));if(i)return{mood:i.mood,comment:i.comment,timestamp:i.timestamp}}const s={...e.rememberedChoices,cameraFollow:d.CameraFollowPreset.On};return delete s.latestLevelId,delete s.newGameOptions,{metadata:{cloudSyncUserId:void 0},levels:t,latestLevelId:e.rememberedChoices.latestLevelId,rememberedChoices:s,tutorialsCompleted:e.tutorialsCompleted,stats:{total:e.stats.total,latestSession:e.stats.latestSession}}}(t);i&&(e.setItem(s.STORAGE_KEYS.USER_DATA_PREFIX+t.userId,JSON.stringify(i)),e.setItem("konkr.userData.v1.backup",JSON.stringify(t)),e.removeItem("konkr.userData"))}}(),l.inject.userData.reload())}catch(e){h.error("User data migration failed",e)}},t.loadOldLevelData=u},22378:(e,t)=>{"use strict";var i,s,n;Object.defineProperty(t,"__esModule",{value:!0}),t.SaveGameTags=t.LevelOutcome=t.CameraFollowPreset=void 0,(n=t.CameraFollowPreset||(t.CameraFollowPreset={})).Off="off",n.NoZoom="no-zoom",n.On="on",(s=t.LevelOutcome||(t.LevelOutcome={})).Victory="Victory",s.Defeat="Defeat",(i=t.SaveGameTags||(t.SaveGameTags={})).Start="start",i.Autosave="auto",i.BestResult="best"},63488:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ViewsManager=void 0;const s=i(82251),n=i(91989),a=i(17947),o=i(4643),r=i(95877),c=i(2336),l=i(28271),d=i(41690),h=i(5957),u=i(64673),p=i(21980),g=i(35602),m=i(72960),y=i(75828),f=i(26579);t.ViewsManager=class{constructor(){this.attitude=new a.AttitudeView,this.fear=new s.FearView,this.hostility=new u.HostilityView,this.conquerableHexes=new f.ConquerableHexesView,this.factionInfluenceByRegion=new n.FactionInfluenceByRegionView,this.behaviorSummary=new p.BehaviorSummaryView,this.factionNeighboursView=new g.FactionNeighboursView,this.powerBalance=new h.PowerBalanceView,this.attritionByFaction=new o.AttritionByFactionView,this.hexProximityToRegion=new r.HexProximityToRegionView,this.situationScoreByRegion=new c.SituationScoreByRegionView,this.expansionOptions=new l.ExpansionOptionsView,this.regionPoliticsView=new d.RegionPoliticsView,this.regionForecast=new m.RegionForecastView,this.factionDiplomacyScore=new y.FactionDiplomacyScoreView}}},96525:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AnalyticsReporter=void 0;const s=i(91025),n=i(54465),a=i(120);t.AnalyticsReporter=class{constructor(e){e.on(s.SystemEvents.UserSignedIn,(({userId:e})=>{a.Firebase.analytics&&(0,n.setUserId)(a.Firebase.analytics,e)}))}setUserProperties(e){a.Firebase.analytics&&(0,n.setUserProperties)(a.Firebase.analytics,e)}setDefaultEventParams(e){(0,n.setDefaultEventParameters)(e)}}},60807:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.track=void 0;const s=i(48500),n=i(11041),a=i(88865),o=i(58592),r=i(54465),c=i(120),l=s.logger.for("analytics");function d(e,t){try{if(!c.Firebase.analytics)return void l.warning(`failed to log ${e} to firebase, analytics not initialized`);(0,r.logEvent)(c.Firebase.analytics,e,u(t))}catch(t){l.warning(`failed to log ${e} to firebase`)}}function h(e){return t=>{d(e,u(t))}}function u(e){const t=o.app.navigator.currentScreen;return e||(e={}),{user_id:a.inject.login.getUserId(),screen:t?.name,frameParent:o.app.device.frameParent,...p(t),...e}}function p(e){switch(e){case o.app.screen.play:case o.app.screen.victory:const e=n.LevelModel.for(a.inject.ui.session.levelId);return{level_id:e.id,level_name:e.getTitle(n.LevelTitleStyle.IncludingModePrefix),campaign_id:e.parentCampaign?.id,map_color_theme:a.inject.gameStateModel.map.themeKey};case o.app.screen.levelDetail:const t=n.LevelModel.for(a.inject.ui.selectedLevelId());return{level_id:t.id,level_name:t.getTitle(n.LevelTitleStyle.IncludingModePrefix),campaign_id:a.inject.ui.selectedCampaign()?.id};default:return{}}}t.track={bootComplete:h("boot_complete"),exception:h("exception"),pageView:h("page_view"),interaction:e=>{d(e,{})},ui:{dismissFeedbackForm:h("dismiss_feedback_form")},playerFeedback:h("player_feedback"),randomMapSelected:h("random_map_started"),randomMapRerolled:h("random_map_rerolled"),spectatingOver:h("spectating_over"),loginStart:h("login_start"),loginSuccess:h("login_success"),loginFailed:h("login_failed")}},97520:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createUrl=t.buildUrlHash=t.parseUrlHash=t.instrumentBrowserHistory=t.clearUrlHash=t.updateUrlHash=void 0;const s=i(48500),n=i(91025),a=i(81363),o=i(88865),r=i(58592),c=i(61770),l=i(11041),d=i(12678);s.logger.for("browserHistory");let h=!1;async function u(){const e=window.location.hash?.slice(1),t=e.split("/");switch(t[0]){case"conquest":const e=t[1];try{if(o.inject.ui.session.active&&o.inject.ui.session.end({origin:"deep-link"}),!c.RandomMapHash.isValid(e))throw new Error("invalid hash");const t=c.RandomMapHash.parse(e);return await r.app.navigator.goTo(r.app.screen.randomMapSelect),r.app.scene.randomMapSelect.state.update({preset:t}),o.inject.userData.rememberChoice("randomMapOptions",t),r.app.scene.randomMapSelect.startGenerating("down"),!0}catch(e){return console.error(e),r.app.notifications.warning("Failed to load conquest map","The map link provided in the URL is incorrect or not valid for this version of the game, sorry!"),!1}case"campaign":const i=t[1],s=l.LevelModel.for(i);try{if(o.inject.ui.session.active&&o.inject.ui.session.end({origin:"deep-link"}),"campaign"!==s.category)throw new Error("not a campaign level");const e=s.campaignContext;return d.assert.defined(e),o.inject.ui.selectedLevelId.set(s.id),await r.app.navigator.goTo(r.app.screen.levelDetail),!0}catch{return r.app.notifications.warning("Failed to load campaign map","The campaign map link provided in the URL is outdated or invalid, sorry!"),!1}case"quickload":return!!o.inject.config.debug.cheats&&(o.inject.events.trigger(n.UserActions.InternalLoadGame("1")),!0)}return!1}t.updateUrlHash=function(e){window.location.hash!==e&&(h=!0,window.location.hash=e)},t.clearUrlHash=function(){history.pushState(null,""," ")},t.instrumentBrowserHistory=function(){if(window.addEventListener("hashchange",(()=>{window.location.hash&&!h?u():h=!1})),r.app.device.isMobile()){function e(){history.pushState(null,"",window.location.href)}e(),window.addEventListener("popstate",(function(t){if(console.warn("POPPED",t),!r.app.navigator.transitionInProgress)if(r.app.navigator.currentScreen===r.app.screen.title)confirm("Exit the game?")?history.back():e();else{e();try{r.app.audio.playEffect(a.SoundEffects.ButtonDown)}catch{}o.inject.events.trigger(n.UserActions.Escape())}}),!1)}},t.parseUrlHash=u,t.buildUrlHash={campaign:e=>"campaign/"+e,conquest:e=>"conquest/"+e},t.createUrl=function(e){return"https://"+window.location.host+window.location.pathname+"#"+e}},5604:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createAIControls=void 0;const s=i(51019),n=i(30420),a=i(96486),o=i(88865),r=i(58592),c=i(40108),l=i(8527),d=i(91025),h=i(78179),u=i(34758),p={1:0,2:0,3:0,4:0,5:0,6:0};t.createAIControls=function(e){const t=[],i={faction:"all",controlledBy:n.FactionController.Ai,preset:"competitive",personality:{...s.DEFAULT_AI_PERSONALITY},approval:p,"What's this?":()=>window.open("https://www.konkr.io/update/2022/12/12/ai-beta-test-guide.html","_blank")?.focus()},g=e.add(i,"faction",["all",1,2,3,4,5,6]).onChange((function(e){let t="all"===e?void 0:o.inject.gameStateModel.factions.byId(e);const s=t?t.liveHexes:h.HexGroup.union(o.inject.gameStateModel.regions.all().filter((e=>e.isAlive())).map((e=>e.hexes)));r.app.scene.worldMap.overlays.selectedRegionHighlight.clear(),r.app.scene.worldMap.overlays.selectedRegionHighlight.setHexes(s,16777215),r.app.scene.worldMap.overlays.conquerableHexesHighlight.clear(),function(e){i.faction=e,P()}(e)})),m=e.add(i,"controlledBy",Object.values(n.FactionController)).onChange((function(){T((e=>{e.setController(i.controlledBy)}))})),y=e.addFolder("playstyle");y.open();const f=y.add(i,"preset",Object.keys(s.AI_PERSONALITY_PRESETS)).onChange((function(){const e=s.AI_PERSONALITY_PRESETS[i.preset];e&&(Object.assign(i.personality,e),x(),P())})),w=e.addFolder("approval"),v=(0,a.debounce)((()=>{x(),P()}),300,{trailing:!0}),b=["daring","combative","ambitious","honorable","attackSkill","defenseSkill"];for(let e of b)y.add(i.personality,e,0,1,.05).onChange(v);function S(){const e=i.faction;let t="all"===e?void 0:o.inject.gameStateModel.factions.byId(e);if(t?.isAlive())return t}function x(){T((e=>{e.controller===n.FactionController.Ai&&e.setAiPersonality({...i.personality})}))}function T(e){const t=S();if(t)e(t);else{const t=o.inject.gameStateModel.factions.all().filter((e=>!e.isNeutral()&&1!==e.id));for(let i of t)e(i)}}function P(){t.forEach((e=>e.remove())),t.length=0;let d=S();if(d){w.show();const e=o.inject.gameStateModel.factions.all().filter((e=>e.isAlive()&&!e.isNeutral()));(0,l.updateDropdownOptions)(g,["all",...e.map((e=>e.id.toString()))]),i.faction=d.id,Object.assign(i.personality,d.aiPersonality),Object.assign(i.approval,{...p,...c.AI.getFactionApproval(o.inject.currentGameState,d.id)}),i.controlledBy=d.controller??n.FactionController.None;for(const s of e)t.push(w.add(i.approval,s.id.toString(),-300,300,1).onChange((e=>{c.AI.changeFactionApproval(o.inject.currentGameState,d.id,s.id,(()=>e)),r.app.scene.worldMap.overlays.attitudeEmojis.syncWithModel(o.inject.gameStateModel)})))}else i.faction="all",w.hide(),d=o.inject.gameStateModel.factions.all().find((e=>e.controller===n.FactionController.Ai)),i.controlledBy=d?.controller??n.FactionController.None,Object.assign(i.personality,d?.aiPersonality??s.DEFAULT_AI_PERSONALITY);if(d){const e=Object.entries(s.AI_PERSONALITY_PRESETS).find((([e,t])=>(0,a.isEqual)(t,d.aiPersonality)))?.[0]??"(custom)";i.preset=e,(0,l.setDropdownSelection)(f,e)}(0,l.setDropdownSelection)(g,i.faction.toString()),(0,l.setDropdownSelection)(m,i.controlledBy),e.updateDisplay()}o.inject.gameStateController.onEvent((e=>{(0,u.isEvent)(e,d.GameStateEvents.NewGameState)&&P()})),o.inject.events.on(d.GameStateEvents.HexCaptured,P),P()}},8527:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setDropdownSelection=t.updateDropdownOptions=void 0,t.updateDropdownOptions=function(e,t){const i=e.domElement.children[0].value;let s="";for(let e=0;e<t.length;e++)s+="<option value='"+t[e]+"'>"+t[e]+"</option>";""!=s&&(e.domElement.children[0].innerHTML=s),e.domElement.children[0].value=i},t.setDropdownSelection=function(e,t){e.domElement.children[0].value=t??"---"}},53994:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.generationPresets=t.setDatGUIVisible=void 0;const o=a(i(84376)),r=i(91025),c=i(75326),l=i(96486),d=i(30420),h=i(85656),u=i(81363),p=i(54444),g=i(88865),m=i(58592),y=i(82966),f=i(5604),w=i(8527),v=i(41065);let b;t.setDatGUIVisible=function(e){e?(b||function(e){const i={mapGen:{preset:t.generationPresets[1].key,players:6,playerAdvantage:1,randomize:async function(){A.seed=g.inject.random.integerBetween(0,1e4),localStorage.setItem("seed",A.seed.toString()),n.updateDisplay(),await E()},breakpoints:!!g.inject.config.debug.breakpoints},debugLayer:""};b=new o.GUI({width:300});const s=b.addFolder("DEBUG"),n=b.addFolder("MAP GENERATION"),a=b.addFolder("LEVEL"),S=b.addFolder("FACTIONS");s.add(g.inject.config.debug,"overlay");const x=s.add(i,"debugLayer",["----------------"]).onChange((function(e){g.inject.debugLayers.layers[e]?g.inject.debugLayers.activate(e):y.commands.debug.dataSet(e)}));B(),g.inject.debugLayers.onActiveLayerUpdated(B),s.add(g.inject.config.debug,"gameObjects"),s.add(g.inject.config.debug,"ai"),s.add(g.inject.config.debug,"objectPools"),s.add(g.inject.config.debug,"chunkBorders"),s.add(g.inject.config.debug,"tweenSpeedFactor",.1,2),s.add(g.inject.config,"screenTransitionDuration",0,3e3),(0,f.createAIControls)(S);const T=(0,l.throttle)(E,100,{trailing:!0}),P=(0,l.debounce)(E,300,{trailing:!0}),M=async()=>{A.generateRegions?await P():await T()};let I=!1;const A={seed:Number(localStorage.getItem("seed"))||g.inject.random.integerBetween(0,1e4),...(0,l.cloneDeep)(t.generationPresets.find((e=>e.key===i.mapGen.preset)))};function C(e,t){switch(t){case"off":return void e.hide();case"expanded":e.open()}}function B(){const e=g.inject.gameStateModel.stateEngine.getAllDataSets().toArray().map((e=>e.key)),t=Object.keys(g.inject.debugLayers.layers);(0,w.updateDropdownOptions)(x,(0,l.sortedUniq)([...e,...t].sort())),(0,w.setDropdownSelection)(x,g.inject.debugLayers.activeLayerName)}async function E(){try{if(I)return void m.app.audio.playEffect(u.SoundEffects.Deny);I=!0,g.inject.events.trigger(r.UserActions.GoToMapGeneration()),await(0,c.generateMap)(A,(async()=>{await(0,p.sleep)(1)})),m.app.scene.worldMap.syncState(),I=!1,g.inject.events.trigger(r.UserActions.EditMap())}catch(e){console.error(e)}}function R(){A.regions.factions=[{controller:d.FactionController.LocalUser,startingTilesMultiplier:i.mapGen.playerAdvantage},...(0,h.range)(2,i.mapGen.players).map((e=>({controller:d.FactionController.Ai})))],M()}n.add(i.mapGen,"preset",t.generationPresets.map((e=>e.key))).onChange((function(){const e=t.generationPresets.find((e=>e.key===i.mapGen.preset));Object.assign(A.land,(0,l.cloneDeep)(e.land)),Object.assign(A.regions,(0,l.cloneDeep)(e.regions)),n.updateDisplay(),E()})),n.add(A,"seed").onChange(M),n.add(i.mapGen,"randomize"),n.add(A.land,"width",8,40,1).onChange(M),n.add(A.land,"height",8,40,1).onChange(M),n.add(A.land,"smoothness",1,10,.1).onChange(M),n.add(A.land,"water",0,1).onChange(M),n.add(A.land,"inlandForests",0,1).onChange(M),n.add(A.land,"coastalForests",0,1).onChange(M),n.add(A.land,"coastalForestsCohesion",0,1).onChange(M),n.add(A,"generateRegions").onChange(M),n.add(i.mapGen,"players",2,6,1).onChange(R),n.add(i.mapGen,"playerAdvantage",0,3,.1).onChange(R),n.add(A.regions,"minCellSize",1,15,1).onChange(M),n.add(A.regions,"maxCellSize",1,15,1).onChange(M),n.add(A.regions,"cellSeparation",0,5,1).onChange(M),n.add(A.regions,"coloration",0,1).onChange(M),n.add(A.regions,"clustering",0,1,.1).onChange(M),n.add(A,"spawnTowns").onChange(M),n.add(A.regions,"startingTiles",1,20,1).onChange(M),n.add(A.regions,"startingCoins",1,20,1).onChange(M),n.add(i.mapGen,"breakpoints").onChange((e=>{g.inject.config.debug.breakpoints=e?["mapgen"]:[]})),(0,v.createLevelSelectMenu)(a),C(s,e.sections.debug),C(S,e.sections.factions),C(a,e.sections.level),C(n,e.sections.mapgen)}(e),b.show(),e.expand?b.open():b.close()):b?.hide()};const S={minCellSize:3,maxCellSize:6,cellSeparation:2,factions:[{controller:d.FactionController.LocalUser},{controller:d.FactionController.Ai},{controller:d.FactionController.Ai},{controller:d.FactionController.Ai},{controller:d.FactionController.Ai},{controller:d.FactionController.Ai}],cellCohesion:.5,coloration:1,startingTiles:5,startingCoins:10,clustering:0};t.generationPresets=[{key:"small",land:{width:10,height:14,smoothness:4.5,water:.25,inlandForests:.4,coastalForests:.2,coastalForestsCohesion:.6},generateRegions:!0,spawnTowns:!0,regions:{...S,minCellSize:4}},{key:"medium",land:{width:18,height:18,smoothness:7,water:.25,inlandForests:.4,coastalForests:.2,coastalForestsCohesion:.6},generateRegions:!1,spawnTowns:!0,regions:S},{key:"large",land:{width:24,height:24,smoothness:7,water:.25,inlandForests:.5,coastalForests:.2,coastalForestsCohesion:.6},generateRegions:!0,spawnTowns:!0,regions:S}]},41065:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createLevelSelectMenu=void 0;const s=i(88865),n=i(91025),a=i(58592),o=i(82966);t.createLevelSelectMenu=function(e){const t={campaign:"",level:"","quick save":()=>{o.commands.game.save("1")},"quick load":()=>{o.commands.game.load("1")},import:()=>{s.inject.events.trigger(n.UserActions.OpenLoadGameDialog())},export:()=>{s.inject.events.trigger(n.UserActions.OpenExportMapDialog())},"edit current map":()=>{a.app.navigator.currentScreen===a.app.screen.mapEditor?s.inject.events.trigger(n.UserActions.ResumeGame()):s.inject.events.trigger(n.UserActions.EditMap())}};let i;function r(o){const r=s.inject.mapRegistry.getCampaignById(o);i&&i.remove();const c=r.levels.map((e=>e.id));i=e.add(t,"level",c).onChange((async e=>{s.inject.events.trigger(n.UserActions.PlayLevel({levelId:e,origin:"debug-tool"})),a.app.scene.worldMap.syncState()}))}e.add(t,"quick save"),e.add(t,"edit current map"),e.add(t,"quick load"),e.add(t,"import"),e.add(t,"export"),s.inject.mapRegistry.initialize().then((()=>{const i=s.inject.mapRegistry.getCampaigns().map((e=>e.id));t.campaign=i[0],e.add(t,"campaign",i).onChange(r),r(i[0])}))}},120:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Firebase=t.FirebaseFacade=void 0;const s=i(15503),n=i(82417),a=i(81591),o=i(51010),r=i(54465),c=i(44188),l=i(48500),d=i(75071),h=l.logger.for("Firebase");class u{initialize(e){this.app=(0,s.initializeApp)({apiKey:"AIzaSyBmeS83yP2kyjZ3RZ6hHniLsCQ3V4H6Nq4",authDomain:"konkr-io.firebaseapp.com",projectId:"konkr-io",storageBucket:"konkr-io.appspot.com",messagingSenderId:"892701750301",appId:"1:892701750301:web:87bc46832d0fa3902a42f4",measurementId:"G-4JS2TP1WG6"}),this.auth=(0,n.getAuth)(this.app),this.db=(0,a.initializeFirestore)(this.app,{ignoreUndefinedProperties:!0}),(0,r.isSupported)().then((e=>{try{if(!e)return void h.warning("Analytics not supported");this.analytics=(0,r.initializeAnalytics)(this.app,{config:{allow_ad_personalization_signals:!1,send_page_view:!1}})}catch(e){d.ErrorTracking.captureNonFatalError(e,"Firebase.initializeAnalytics")}})),(0,o.isSupported)().then((t=>{if(!t)return void h.warning("RemoteConfig not supported");this.remoteConfig=(0,o.getRemoteConfig)(this.app),this.remoteConfig.defaultConfig=e.remoteConfigDefaults;const i=(0,c.minutesToMilliseconds)(15);this.remoteConfig.settings.minimumFetchIntervalMillis=i/2,this.refreshRemoteConfig(),setInterval((()=>this.refreshRemoteConfig()),i)}))}refreshRemoteConfig(){(0,o.fetchAndActivate)(this.remoteConfig).then((()=>{})).catch((e=>{d.ErrorTracking.captureNonFatalError(e,"refreshRemoteConfig.fetchAndActivate")}))}}t.FirebaseFacade=u,t.Firebase=new u},41959:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getCurrentGameStateModel=void 0;const s=i(58592),n=i(47613),a=i(88865);t.getCurrentGameStateModel=function(){return s.app.navigator.currentScreen===s.app.screen.play&&s.app.scene.play.cursor.isValid()&&s.app.scene.play.cursor.currentState!==a.inject.currentGameState?new n.StaticGameStateModel(s.app.scene.play.cursor.currentState):a.inject.gameStateModel}},22847:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getCurrentVictoryDistance=t.LevelSession=void 0;const s=i(12678),n=i(88865),a=i(14711),o=i(16310),r=i(91025),c=i(16963),l=i(22436),d=i(75071),h=i(43427),u=i(54812),p=i(96486),g=i(58592),m=i(72019),y="konkr.levelSessionEndEvent.v1";function f(){if(g.app.navigator.currentScreen===g.app.screen.defeat)return 0;if(g.app.navigator.currentScreen===g.app.screen.victory)return 1;const e=n.inject.views.powerBalance.get(n.inject.currentGameState),t=e.dominantFaction?.isLocalPlayer(),i=n.inject.gameStateModel.factions.byId(1).scaledPower,s=e.factionsByPower[0]?.scaledPower;return t?(0,u.cropNumber)(.5+e.dominance/200,.5,.99):(0,u.cropNumber)(i/s*.5,.01,.5)}t.LevelSession=class{get id(){return this.data?.id??""}get active(){return!!this.data}constructor(){this.fpsTracker=new l.FpsTracker,this.storedSession=new h.PersistentEntry(y)}initialize(){this.logBuilder=new c.PlayLogAutoBuilder;try{const e=this.storedSession.take();e&&n.inject.events.trigger(r.SystemEvents.LevelSessionOver(e))}catch(e){d.ErrorTracking.captureNonFatalError(e,`reading stored level session from "${y}"`)}n.inject.events.on(r.SystemEvents.UserBecameInactive,(()=>{this.persist()}))}get selectedRegionId(){return this.data?.selectedRegionId??void 0}get levelId(){return this.data?.levelId??""}get remainingLives(){return this.data?.remainingLives??0}get dismissedSurrender(){return this.data?.dismissedSurrender??!1}onDismissedSurrender(){s.assert.defined(this.data,"onDismissedSurrender called with no active session"),this.data.dismissedSurrender=!0}setSelectedRegionId(e){s.assert.defined(this.data,"attempted to set selected region while no session is active"),this.data.selectedRegionId=e}startNew(e){this.active&&this.end({origin:e.origin}),this.fpsTracker.reset(),this.data={id:e.sessionId??n.inject.random.id(a.ID_TYPE.Session),levelId:e.levelId,remainingLives:e.remainingLives??o.DEFAULT_LIVES_PER_LEVEL,selectedRegionId:void 0,dismissedSurrender:!1},n.inject.ai.maxAllowedUnitMight=void 0,n.inject.ai.allowSurrender=!0,n.inject.events.trigger(r.SystemEvents.LevelSessionStarted({levelId:this.data.levelId,sessionId:this.data.id,origin:e.origin,turnNumber:e.turnNumber}))}end(e){this.data?(this.logBuilder.commitEntry(),this.shouldSaveReplay()&&(this.data.replay=(0,m.tryToEncodeCurrentReplay)()),n.inject.events.trigger(r.SystemEvents.LevelSessionOver(this.buildEndEventData(e))),this.storedSession.discard(),this.data=void 0):d.ErrorTracking.captureNonFatalError("attempted to end level session while no session is active","levelSession.end")}shouldSaveReplay(){const e=n.inject.random.numberBetween(0,1);return g.app.remoteConfig.replaysSampleRate>e||!!this.logBuilder.hasErrors}buildEndEventData(e){return s.assert.defined(this.data),{levelId:this.levelId,sessionId:this.data.id,origin:e.origin,playLog:this.logBuilder.getPlayLog(),avgFps:(0,p.round)(this.fpsTracker.avgFps),minFps:(0,p.round)(this.fpsTracker.minFps),victoryDistance:(0,p.round)(f(),2),replay:this.data.replay}}persist(){this.data&&this.storedSession.put({...this.buildEndEventData({origin:"exit-game"}),timestamp:Date.now()})}burnLife(){s.assert.defined(this.data,"attempted to burn life while there is no active session"),this.data.remainingLives>0&&this.data.remainingLives--}getTotalSeconds(){return this.logBuilder.getTotalSeconds()}},t.getCurrentVictoryDistance=f},97197:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelSessionEndWatcher=t.isLevelSessionEndError=t.LevelSessionEndError=void 0;const s=i(88865);class n extends Error{constructor(){super("Level Session Ended"),this.isLevelSessionEndedError=!0}}t.LevelSessionEndError=n,t.isLevelSessionEndError=function(e){return"object"==typeof e&&e.isLevelSessionEndedError},t.LevelSessionEndWatcher=class{constructor(){this.levelSessionId=s.inject.ui.session.id}throwIfAborted(){if(this.levelSessionId!==s.inject.ui.session.id)throw new n}isAborted(){return this.levelSessionId!==s.inject.ui.session.id}}},38508:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BLANK_PLAY_LOG_ITEM=void 0,t.BLANK_PLAY_LOG_ITEM=Object.freeze({playSeconds:0,aiSeconds:0,balance:[],moves:0,undos:0,seconds:0,turn:0})},16963:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayLogAutoBuilder=void 0;const s=i(48500),n=i(91025),a=i(88865),o=i(58592),r=i(76470),c=i(38508),l=i(36307),d=i(30420),h=i(23441),u=i(96486);s.logger.for("PlayLog"),t.PlayLogAutoBuilder=class{update(e){document.hidden||e!==o.app.screen.play?(this.stopwatch.pause(),this.isPlayerTurn=!1):(this.stopwatch.start(),this.updateCurrentItemFromGameState())}constructor(){this.stopwatch=new r.Stopwatch,this.aiTimeStopwatch=new r.Stopwatch,this.currentItem={...c.BLANK_PLAY_LOG_ITEM},this.log=[],this.isPlayerTurn=!1,this.hasErrors=!1;const e=a.inject.events;e.on(n.SystemEvents.LevelSessionStarted,(({sessionId:e})=>{this.reset()})),e.on(n.SystemEvents.ScreenActivated,(({screen:e})=>{this.update(e)})),e.on(n.SystemEvents.UserBecameInactive,(()=>{this.stopwatch.pause()})),e.on(n.SystemEvents.UserBecameActive,(()=>{this.update(o.app.navigator.currentScreen)})),e.on(n.UserActions.Undo,(()=>{++this.currentItem.undos})),e.on(n.UiEvents.RewindConfirmed,(({targetTurn:e})=>{this.currentItem.rewindTo=e,this.commitEntry()})),e.on(n.GameStateEvents.FactionTurnOver,(e=>{1===e.factionId&&(this.logElapsedTime(),this.updateCurrentItemFromGameState(),this.aiTimeStopwatch.pause(),this.aiTimeStopwatch.reset(),this.isPlayerTurn=!1)})),e.on(n.GameStateEvents.FactionTurnStarted,(e=>{1===e.factionId&&(this.currentItem.aiSeconds=this.aiTimeStopwatch.getElapsedSeconds(),this.commitEntry(),this.updateCurrentItemFromGameState())})),e.on(n.SystemEvents.FactionAiBegin,(()=>{this.aiTimeStopwatch.start()})),e.on(n.SystemEvents.FactionAiEnd,(()=>{this.aiTimeStopwatch.pause()})),e.on(n.SystemEvents.FatalError,(e=>{this.currentItem.errors||(this.currentItem.errors=[]),this.currentItem.errors.push({id:e.correlationId,message:e.message}),this.hasErrors=!0}));const t=()=>{a.inject.gameStateModel.currentPhase.isLocalPlayerTurn()&&++this.currentItem.moves};e.on(n.GameStateEvents.PawnBought,t),e.on(n.GameStateEvents.PawnMoved,t),e.on(n.GameStateEvents.HexCaptured,t)}commitEntry(){this.logElapsedTime(),this.log.push({...this.currentItem,aiSeconds:(0,u.round)(this.currentItem.aiSeconds,1),seconds:(0,u.round)(this.currentItem.seconds,1)}),this.startNewEntry()}startNewEntry(){this.stopwatch.reset(),this.aiTimeStopwatch.pause(),this.aiTimeStopwatch.reset(),this.currentItem={...c.BLANK_PLAY_LOG_ITEM}}reset(){this.log=[],this.startNewEntry()}getPlayLog(){return this.log}updateCurrentItemFromGameState(){this.currentItem.balance=function(){const e=[],t=a.inject.gameStateModel.factions;for(let i=1;i<=l.MAX_FACTIONS_COUNT;i++){const s=t.byId(i)?.size;s&&(e[i]=s)}const i=a.inject.gameStateModel.pawns.select({type:[d.PawnType.Forest]}).length,s=a.inject.gameStateModel.regions.all().filter((e=>!e.isAlive())).map((e=>e.size)).reduce(h.sum,0);return e[0]=s-i,e}(),this.currentItem.turn=a.inject.gameStateModel.currentPhase.turnNumber,this.isPlayerTurn=a.inject.gameStateModel.currentPhase.isLocalPlayerTurn(),this.isPlayerTurn&&this.logElapsedTime()}logElapsedTime(){this.currentItem.seconds+=this.stopwatch.getElapsedSeconds(),this.isPlayerTurn&&(this.currentItem.playSeconds+=this.stopwatch.getElapsedSeconds()),this.stopwatch.reset()}getTotalSeconds(){return this.logElapsedTime(),this.log.reduce(((e,t)=>e+t.seconds),0)+this.currentItem.seconds}}},77705:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.loadGame=void 0;const s=i(59674),n=i(62960),a=i(88865),o=i(24592);t.loadGame=function(e){const t=a.inject.storage.getItem(s.SAVE_GAME_LOCAL_STORAGE_PREFIX+e);if(!t)throw new Error(`no data found for save "${e}"`);let i;try{i=(0,o.decodeGameState)(t)}catch(e){throw new Error("save data corrupted")}if(i.version!==n.CORE_GAMESTATE_SCHEMA_VERSION)throw new Error("save data not compatible with current version of the game");return i}},70766:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoginService=t.LoginAction=t.LoginState=void 0;const s=i(120),n=i(82417),a=i(21103),o=i(60807),r=i(88865),c=i(91025),l=i(58592),d=i(75071),h=i(22766),u=i(14711),p=i(56952),g=i(27526),m=i(50162);var y,f;i(48500).logger.for("LoginService"),function(e){e.Disabled="Disabled",e.SigningIn="SigningIn",e.SignInEmailSent="SigningInEmailSent",e.SignedIn="SignedIn",e.SignedOut="SignedOut",e.LoginFailed="LoginFailed",e.Offline="Offline"}(y=t.LoginState||(t.LoginState={})),function(e){e.None="none",e.SignIn="sign-in",e.SignOut="sign-out"}(f=t.LoginAction||(t.LoginAction={})),t.LoginService=class{getDefaultUserId(){let e=this.localStorage.getItem(h.STORAGE_KEYS.DEFAULT_USER);if(!e){const t=this.localStorage.getItem("konkr.userData");t&&(e=JSON.parse(t).userId)}return e||(e=r.inject.random.id(u.ID_TYPE.User),this.localStorage.setItem(h.STORAGE_KEYS.DEFAULT_USER,e)),e}getUserId(){return this.localStorage.getItem(h.STORAGE_KEYS.CURRENT_USER)??this.getDefaultUserId()}getUserEmail(){return s.Firebase.auth?.currentUser?.email??void 0}constructor(e){this.localStorage=e,this.state=(0,a.watchable)(y.Disabled),this.googleAuthProvider=new n.GoogleAuthProvider,this.facebookAuthProvider=new n.FacebookAuthProvider,this.latestAction=f.None,this.supportedProviders=[this.googleAuthProvider,this.facebookAuthProvider],this.googleAuthProvider.setCustomParameters({prompt:"select_account"})}initialize(){s.Firebase.auth?.onAuthStateChanged((e=>{const t=this.getUserId();!e||e?.isAnonymous?this.state.set(function(e){switch(e){case f.None:return y.Disabled;case f.SignIn:return y.LoginFailed;case f.SignOut:return y.SignedOut}}(this.latestAction)):(this.localStorage.setItem(h.STORAGE_KEYS.CURRENT_USER,e.uid),this.state.set(y.SignedIn),r.inject.events.trigger(c.SystemEvents.UserSignedIn({userId:e.uid,previousUserId:t})))})),r.inject.events.trigger(c.SystemEvents.UserSignedIn({userId:this.getDefaultUserId()})),r.inject.events.on(c.UserActions.SignInWithGoogle,(()=>{this.state.set(y.SigningIn),this.signInWithGoogle()})),r.inject.events.on(c.UserActions.SignInWithFacebook,(()=>{this.state.set(y.SigningIn),this.signInWithFacebook()})),window.addEventListener("online",(()=>{this.state()===y.Offline&&this.state.set(s.Firebase.auth?.currentUser&&!s.Firebase.auth?.currentUser.isAnonymous?y.SignedIn:y.Disabled)})),window.addEventListener("offline",(()=>{this.state.set(y.Offline)})),r.inject.events.on(c.UserActions.SignInWithEmail,(async()=>{this.state.set(y.SigningIn);const e=(0,m.ref)(r.inject.userData.recallChoice("feedbackEmail")??""),t=await l.app.modals.textInput({title:"Sign-in with email",inputPlaceholder:"email@example.com",message:"A sign-in link will be sent to the following email address:",value:e,buttons:[{text:p.DialogButtons.Cancel,role:g.DialogButtonRole.Regular},{text:p.DialogButtons.OK,role:g.DialogButtonRole.PrimaryGreen}]}),i=e.current;t===p.DialogButtons.OK&&i?(r.inject.storage.setItem("emailForSignIn",i),await this.signInWithEmail(i.trim())):this.state.set(y.Disabled)})),r.inject.events.on(c.UserActions.SignOut,(()=>{this.signOut()})),r.inject.events.on(c.SystemEvents.EngineInitialized,(async()=>{await this.parseUrlParams()}))}async parseUrlParams(){if((0,n.isSignInWithEmailLink)(s.Firebase.auth,window.location.href)){let e=r.inject.storage.getItem("emailForSignIn");if(!e){const t=(0,m.ref)("");await l.app.modals.textInput({title:"Sign-in with email",message:"Please enter your email for confirmation",inputPlaceholder:"email@example.com",value:t,buttons:[{text:p.DialogButtons.Cancel,role:g.DialogButtonRole.Regular},{text:p.DialogButtons.OK,role:g.DialogButtonRole.PrimaryGreen}]}),e=t.current}(0,n.signInWithEmailLink)(s.Firebase.auth,e,window.location.href).then((t=>{l.app.notifications.success("Sign-in completed!",`Your can now access your progress on any device by signing in as ${e}.`),o.track.loginSuccess({provider:"email"})})).catch((e=>{o.track.loginFailed({provider:"email"}),l.app.notifications.warning("Email sign up failed.","Looks like the sign-in link in the email is expired or invalid, please try again!")})).finally((()=>{r.inject.storage.removeItem("emailForSignIn"),setTimeout((()=>window.history.pushState({},"",window.location.pathname)),1e3)}))}}async signInWithGoogle(){this.latestAction=f.SignIn;const e={provider:"google"};try{o.track.loginStart(e),await(0,n.signInWithPopup)(s.Firebase.auth,this.googleAuthProvider),o.track.loginSuccess(e)}catch(e){await this.handleSignInError(e,"facebook")}}async signInWithFacebook(){this.latestAction=f.SignIn;const e={provider:"facebook"};try{o.track.loginStart(e),await(0,n.signInWithPopup)(s.Firebase.auth,this.facebookAuthProvider),o.track.loginSuccess(e)}catch(e){await this.handleSignInError(e,"facebook")}}async handleSignInError(e,t){switch(e.code){case"auth/popup-closed-by-user":this.state.set(y.Disabled);break;case"auth/account-exists-with-different-credential":this.signInErrorMessage=`Email [b]${e.customData?.email??""}[/b] is already used with another sign-in method.\n\nPlease try signing in with a [b]different method[/b] or a [b]different email[/b].`,this.state.set(y.LoginFailed),o.track.loginFailed({provider:t});break;default:this.signInErrorMessage="'Oops! Something went wrong during the sign in process.\n\n'[b]Please try again![/b]'",d.ErrorTracking.captureNonFatalError(e,`signIn/${t}`),this.state()===y.SigningIn&&this.state.set(y.LoginFailed),o.track.loginFailed({provider:t})}}getProviderById(e){for(let t of this.supportedProviders)if(t.providerId===e)return t}async signInWithEmail(e){this.latestAction=f.SignIn;const t={provider:"email"};try{o.track.loginStart(t),await(0,n.sendSignInLinkToEmail)(s.Firebase.auth,e,{url:window.location.href,handleCodeInApp:!0}),o.track.loginSuccess(t),this.state.set(y.SignInEmailSent)}catch(e){await this.handleSignInError(e,"email")}}cancelSignIn(){this.state()!==y.SigningIn&&this.state()!==y.SignInEmailSent||(this.latestAction=f.SignOut,this.state.set(y.Disabled))}getAuth(){return s.Firebase.auth}async signOut(){this.latestAction=f.SignOut,await s.Firebase.auth.signOut()}describeCurrentAuthProvider(){const e=s.Firebase.auth?.currentUser?.providerData?.[0]?.providerId;switch(e){case this.facebookAuthProvider.providerId:return"Facebook";case this.googleAuthProvider.providerId:return"Google";default:return"email"}}}},11041:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelModel=t.LevelTitleStyle=t.getUnlockedLevels=t.LevelStatus=void 0;const s=i(85656),n=i(88865),a=i(22378),o=i(61770),r=i(97520);var c,l;function d(e){let t=0,i=!0;return e.levels.filter((e=>{const s=function(e){switch(e.unlockCondition?.type){case void 0:return!0;case"completed-previous":return i;case"max-incomplete":return t<=e.unlockCondition.maxIncomplete}}(e);return s?(t++,i=!0):i=!1,s})).map((e=>e.id))}!function(e){e.Locked="Locked",e.NotStarted="NotStarted",e.InProgress="InProgress",e.Replaying="Replaying",e.Completed="Completed",e.Defeated="Defeated"}(c=t.LevelStatus||(t.LevelStatus={})),t.getUnlockedLevels=d,function(e){e.Full="full",e.IncludingModePrefix="with-mode-prefix"}(l=t.LevelTitleStyle||(t.LevelTitleStyle={}));class h{constructor(e){this.id=e}get userData(){return n.inject.userData.getLevelRecordById(this.id)}getAuthor(){return n.inject.mapRegistry.getLevelInfoById(this.id)?.author??null}getTitle(e=l.Full){const t=n.inject.mapRegistry.getLevelInfoById(this.id);switch(this.category){case"campaign":const i=e===l.IncludingModePrefix?this.campaignContext?.campaign.name+" > ":"",s=this.campaignContext.indexInCampaign;return t?.name?`${i}Island ${s+1}: ${t.name}`:`${i}Island ${s+1}`;case"conquest":let n="Unknown Island";try{n=o.RandomMapHash.parse(this.id).name}catch(e){}return(e===l.IncludingModePrefix?"Conquest > ":"")+n}}get category(){return this.campaignContext?"campaign":"conquest"}get campaignContext(){return n.inject.mapRegistry.getLevelLocationInCampaign(this.id)}get parentCampaign(){return this.campaignContext?.campaign}getNextLevelToPlay(){if(this.parentCampaign)return[...this.parentCampaign.levels.slice(this.campaignContext.indexInCampaign+1),...this.parentCampaign.levels.slice(0,this.campaignContext.indexInCampaign)].find((e=>{const t=h.for(e.id).getLevelStatus();return t===c.NotStarted||t===c.InProgress||t===c.Defeated}))?.id}async getStartingState(){switch(this.category){case"conquest":return n.inject.userData.loadGameState(this.id,a.SaveGameTags.Start);case"campaign":return n.inject.mapRegistry.loadLevelById(this.id)}}async getCurrentState(){if(!this.userData?.inProgress)return this.getStartingState();try{return await n.inject.userData.loadGameState(this.id,a.SaveGameTags.Autosave)}catch(e){return console.error(`Failed to load level "${this.id}" state from user data, falling back to start`,e),n.inject.userData.clearLevelProgress(this.id,"error/failed-to-load-level"),this.getCurrentState()}}getLevelStatus(){return this.isUnlocked()?this.userData?.won&&this.userData?.inProgress?c.Replaying:this.userData?.inProgress?c.InProgress:this.userData?.won?c.Completed:this.userData?.lost?c.Defeated:c.NotStarted:c.Locked}isUnlocked(){const e=this.campaignContext,t=e?.levelData.unlockCondition;return!t||!e||d(e.campaign).includes(this.id)}createUrlHash(){switch(this.category){case"campaign":return r.buildUrlHash.campaign(this.id);case"conquest":return r.buildUrlHash.conquest(this.id)}}static for(e){return(0,s.getOrCreate)(this._instances,e,(()=>new h(e)))}}t.LevelModel=h,h._instances={}},8265:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleMapRegistry=void 0;const s=i(85656),n=i(24592),a=i(48500),o=i(54941),r=a.logger.for("MapRegistry");t.SimpleMapRegistry=class{constructor(e){this.dataSource=e,this.initialized=!1,this.campaigns=[],this.levelsById={},this.loadTime=0}initialize(){const e=o.timing.start("MapRegistry.initialize");return this.initialized?Promise.resolve():(this.initializedPromise||(this.initializedPromise=this.dataSource.fetchCampaignsAndLevels().then((t=>{r.info(`${t.campaigns.length} campaigns and ${t.levels.length} maps loaded`),this.campaigns=t.campaigns,this.levelsById=(0,s.dictionaryOf)(t.levels,"id"),this.initialized=!0,this.initializedPromise=void 0,this.loadTime=e.complete()})).catch((e=>{throw e.message="Failed to load maps from registry: "+e.message,e}))),this.initializedPromise)}async reload(){return this.initialized=!1,this.initialize()}async loadLevelById(e){const t=this.levelsById[e]?.data;if(t)return(0,n.decodeGameState)(t)}_assertInitialized(){if(!this.initialized)throw new Error("Using mapRegistry synchronous api before initialization complete")}getCampaignById(e){return this._assertInitialized(),this.campaigns.find((t=>t.id===e))}getLevelInfoById(e){return this._assertInitialized(),this.levelsById[e]}getLevelLocationInCampaign(e){this._assertInitialized();for(let t of this.campaigns){const i=t.levels.findIndex((t=>t.id===e));if(-1!==i)return{campaign:t,indexInCampaign:i,levelData:t.levels[i]}}}getCampaigns(){return this.campaigns}}},15045:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MockMapRegistryDataSource=void 0;const s=i(88865);t.MockMapRegistryDataSource=class{constructor(e={campaigns:[],levels:[]}){this.mockData=e}async setData(e){this.mockData=e,await s.inject.mapRegistry.reload()}async fetchCampaignsAndLevels(){return this.mockData}}},63313:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RestMapRegistryDataSource=void 0,t.RestMapRegistryDataSource=class{constructor(e){this.urls=e}async fetchCampaignsAndLevels(){const e=await Promise.all(this.urls.map((e=>fetch(e).then((e=>e.json())))));return{campaigns:e.map((e=>e.campaigns)).flat(),levels:e.map((e=>e.levels)).flat()}}}},49497:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.blank=t.plains=t.avoidEdges=t.generateLandmass=void 0;const s=i(13225),n=i(48500),a=i(47613),o=i(12678),r=i(30420),c=i(78179),l=i(88865),d=n.logger.for("generateLandmass");function h(e,t){return Math.pow(1-2*((.5-e)*(.5-e)+(.5-t)*(.5-t)),2)}t.generateLandmass=async function e(t,i){const n=i.minSize??t.map.innerWidth*t.map.innerHeight*(1-i.water)*.33,u=i.smoothness,p=i.water,g=p+(1-p)*(1-i.inlandForests),m=l.inject.random,y=(e,i)=>(w.simplex2(e.x/u,e.y/u)+1)/2*h((e.x-.5)/t.map.innerWidth,(e.y-.5)/t.map.innerHeight)>=i;let f,w;d.info("Generating new random map"),f=i.seed??m.integerBetween(0,Number.MAX_SAFE_INTEGER),w=new s.Noise(f),l.inject.random.reset(f),t.useProjections(a.ProjectionPresets.coreEntities);const v=t.map.getInnerHexes().filter((e=>y(e,p))).components().getLargestGroup()??c.HexGroup.empty;if(d.info(`Base landmass generated (${v?.length} hexes, target is at least ${n})`),v.length<n)return d.warning("Not enough land, decreasing water level and trying again"),await e(t,{...i,minSize:n,water:.75*i.water});t.factions.neutral.addNewRegion("land",v);const b=v.border(),S=v.without(b).filter((e=>y(e,g)));S.forEach((e=>{t.pawns.create({hex:e,type:r.PawnType.Forest})}));let x=v.without(S),T=Math.floor(x.length*i.coastalForests);console.log(`adding ${T} coastal forest tiles`);let P=l.inject.random.shuffle(b.filter(M).toArray());for(;T>0&&P.length;){let e=P.shift();if(o.assert.defined(e),M(e)&&(t.pawns.create({hex:e,type:r.PawnType.Forest}),x=x.without(e),T--,T>0&&l.inject.random.boolean(i.coastalForestsCohesion))){const t=e.neighbours(M);if(t.length){const e=l.inject.random.hex(t);P.unshift(e)}}}function M(e){return b.has(e)&&x.has(e)&&1===x.disjointedNeighbourGroupsOf(e).getGroups().length}},t.avoidEdges=h,t.plains=function(e){e.regions.clear(),e.factions.byId(0)?.addNewRegion("land",e.map.getInnerHexes())},t.blank=function(e){e.regions.clear()}},75326:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createBlankMap=t.generateMap=void 0;const s=i(49497),n=i(41997),a=i(47613),o=i(21999),r=i(54444),c=i(88865);function l(e,t){const i=(0,o.createBlankGameState)({width:e,height:t}),s=c.inject.gameStateModel;s.restore(i),s.useProjections(a.ProjectionPresets.coreEntities)}t.generateMap=async function(e,t=(async()=>{await(0,r.sleep)(1)})){await l(e.land.width,e.land.height),await(0,s.generateLandmass)(c.inject.gameStateModel,{...e.land,seed:e.seed}),e.generateRegions?await(0,n.generateRegions)(c.inject.gameStateModel,{seed:e.seed,...e.regions,startingTiles:e.spawnTowns?e.regions.startingTiles:0},t):c.inject.gameStateModel.activateAllProjections()},t.createBlankMap=l},41997:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateRegions=void 0;const s=i(12678),n=i(48500),a=i(43911),o=i(14654),r=i(21999),c=i(44846),l=i(88865);n.logger.for("mapgen"),t.generateRegions=async function(e,t,i){l.inject.random.reset(t.seed);const n=e.regions.all()[0];s.assert.defined(n,"map generator expects the first region in regions.all() to represent available landmass, but no regions were found"),n.size;let d=await(0,a.partitionLand)(e,n,t,i);await(0,o.colorizeRegions)(e,d,t,i),t.startingTiles>0&&await(0,c.spawnTowns)(e,d.filter((e=>e.faction?.id!==r.SpecialFaction.neutral)),t,i),e.regions.destroy(...e.regions.all().filter((e=>0===e.size))),e.factions.neutral.mergeAdjacentRegions()}},98047:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildGeneratorConfig=t.MAP_GENERATOR_VERSION=t.MapDifficulty=t.MapMode=t.MapShape=t.MapSize=void 0;const s=i(68752),n=i(26279),a=i(69905);var o,r,c,l;(l=t.MapSize||(t.MapSize={})).Small="Small",l.Medium="Medium",l.Large="Large",(c=t.MapShape||(t.MapShape={})).Temperate="Temperate",c.Marshlands="Marshlands",c.Flat="Flat",(r=t.MapMode||(t.MapMode={})).Classic="Classic",r.Colonization="Colonization",r.Crowded="Crowded",(o=t.MapDifficulty||(t.MapDifficulty={})).Casual="Casual",o.Challenging="Challenging",o.Unfair="Unfair",t.MAP_GENERATOR_VERSION=3,t.buildGeneratorConfig=function(e){const t=(0,a.stringToHash)(e.name);return{seed:t,land:(0,n.buildLandGenerationConfig)({...e,seed:t}),regions:(0,s.buildRegionsGenerationConfig)({...e,seed:t}),generateRegions:!0,spawnTowns:!0}}},26279:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.flat=t.marshland=t.temperate=t.buildLandGenerationConfig=void 0;const s=i(98047),n=i(88865);function a(e){const t=n.inject.random,i={seed:e.seed,water:t.numberBetween(.2,.3),inlandForests:t.numberBetween(.2,.4),coastalForests:t.numberBetween(.01,.3),coastalForestsCohesion:t.numberBetween(.1,.3)};switch(e.size){case s.MapSize.Small:default:return{...i,width:10,height:t.integerBetween(16,18),smoothness:t.numberBetween(4,6)};case s.MapSize.Medium:return{...i,width:18,height:18,smoothness:t.numberBetween(5,7)};case s.MapSize.Large:return{...i,width:24,height:24,inlandForests:t.numberBetween(.3,.4),coastalForests:t.numberBetween(.1,.3),smoothness:t.numberBetween(6,8)}}}function o(e){const t=n.inject.random,i={seed:e.seed,water:.25,inlandForests:0,smoothness:1,coastalForests:t.numberBetween(.2,.4),coastalForestsCohesion:t.numberBetween(.1,.3)};switch(e.size){case s.MapSize.Small:default:return{...i,smoothness:.5,coastalForests:.2,width:10,height:t.integerBetween(16,18)};case s.MapSize.Medium:return{...i,width:18,height:18};case s.MapSize.Large:return{...i,width:24,height:24}}}function r(e){n.inject.random;const t={seed:e.seed,water:.1,inlandForests:0,smoothness:10,coastalForests:.2,coastalForestsCohesion:0};switch(e.size){case s.MapSize.Small:default:return{...t,width:9,height:15};case s.MapSize.Medium:return{...t,width:16,height:16};case s.MapSize.Large:return{...t,width:22,height:22}}}t.buildLandGenerationConfig=function(e){switch(n.inject.random.reset(e.seed),e.shape){case s.MapShape.Temperate:return a(e);case s.MapShape.Marshlands:return o(e);case s.MapShape.Flat:return r(e)}},t.temperate=a,t.marshland=o,t.flat=r},68752:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildRegionsGenerationConfig=void 0;const s=i(30420),n=i(98047),a=i(85656),o=i(88865);function r(e,t){return[{controller:s.FactionController.LocalUser,startingTilesMultiplier:t.playerAdvantage},...(0,a.range)(2,e).map((e=>({controller:s.FactionController.Ai,startingTilesMultiplier:t.aiAdvantage})))]}t.buildRegionsGenerationConfig=function(e){let t=1,i=1;switch(e.difficulty){case n.MapDifficulty.Casual:t=2;break;case n.MapDifficulty.Unfair:i=2}const s={...e,aiAdvantage:i,playerAdvantage:t};switch(e.mode){case n.MapMode.Classic:return function(e){const t={startingCoins:10,seed:e.seed,coloration:1,clustering:o.inject.random.numberBetween(0,.3),cellSeparation:2};let i;switch(e.size){case n.MapSize.Small:return i=o.inject.random.integerBetween(2,3),{...t,minCellSize:i,maxCellSize:4,startingTiles:i*o.inject.random.integerBetween(1,2),factions:r(o.inject.random.integerBetween(3,5),e),cellCohesion:o.inject.random.numberBetween(.5,1)};case n.MapSize.Medium:return i=o.inject.random.integerBetween(2,3),{...t,minCellSize:i,maxCellSize:o.inject.random.integerBetween(i+1,7),startingTiles:i*o.inject.random.integerBetween(2,3),factions:r(o.inject.random.integerBetween(4,6),e),cellCohesion:o.inject.random.numberBetween(.5,1)};case n.MapSize.Large:return i=o.inject.random.integerBetween(3,4),{...t,minCellSize:i,maxCellSize:o.inject.random.integerBetween(i+1,7),startingTiles:i*o.inject.random.integerBetween(3,4),factions:r(6,e),cellCohesion:o.inject.random.numberBetween(.5,1)}}}(s);case n.MapMode.Colonization:return function(e){const t={startingCoins:10,seed:e.seed,coloration:0,clustering:o.inject.random.numberBetween(0,.5),cellSeparation:2};let i;switch(e.size){case n.MapSize.Small:return i=o.inject.random.integerBetween(2,3),{...t,minCellSize:i,maxCellSize:4,startingTiles:i,factions:r(o.inject.random.integerBetween(3,5),e),cellCohesion:o.inject.random.numberBetween(.5,1)};case n.MapSize.Medium:return i=o.inject.random.integerBetween(2,3),{...t,minCellSize:i,maxCellSize:o.inject.random.integerBetween(i+1,7),startingTiles:i,factions:r(o.inject.random.integerBetween(4,6),e),cellCohesion:o.inject.random.numberBetween(.5,1)};case n.MapSize.Large:return i=o.inject.random.integerBetween(3,4),{...t,minCellSize:i,maxCellSize:o.inject.random.integerBetween(i+1,7),startingTiles:i,factions:r(6,e),cellCohesion:o.inject.random.numberBetween(.5,1)}}}(s);case n.MapMode.Crowded:return function(e){const t={startingCoins:10,seed:e.seed,coloration:1,clustering:0,cellSeparation:2};let i;switch(e.size){case n.MapSize.Small:return i=o.inject.random.integerBetween(5,6),{...t,minCellSize:2,maxCellSize:4,startingTiles:o.inject.random.integerBetween(30,50)/i,factions:r(i,e),cellCohesion:o.inject.random.numberBetween(.5,1)};case n.MapSize.Medium:return i=o.inject.random.integerBetween(5,6),{...t,minCellSize:o.inject.random.integerBetween(2,3),maxCellSize:5,startingTiles:o.inject.random.integerBetween(50,80)/i,factions:r(i,e),cellCohesion:o.inject.random.numberBetween(.5,1)};case n.MapSize.Large:return i=6,{...t,minCellSize:o.inject.random.integerBetween(2,3),maxCellSize:6,startingTiles:o.inject.random.integerBetween(80,120)/i,factions:r(6,e),cellCohesion:o.inject.random.numberBetween(.5,1)}}}(s)}}},14654:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.colorizeRegions=void 0;const s=i(85656),n=i(78179),a=i(91989),o=i(52937),r=i(24794),c=i(54444),l=i(23441),d=i(77359),h=i(48500),u=i(88865),p=h.logger.for("colorizeRegions");t.colorizeRegions=async function(e,t,i,h){let g={},m=new Set(u.inject.random.shuffle(t));const y=Math.ceil(n.HexGroup.union(t.map((e=>e.hexes))).length*i.coloration),f=Math.ceil(y/i.factions.length),w={},v={},b={},S=(0,d.getFactionsFromConfig)(e,i.factions);for(let e of S){const t=Math.round(i.factions[e.id-1].startingTilesMultiplier??1);w[e.id]=f*t,v[e.id]=0,b[e.id]=(0,l.pickLarger)(1,Math.round(t))}for(let e of t)g[e.id]=new Set(S);for(;m.size;){await h();const e=x(m);if(!e){p.warning(`Failed to assign any faction to the ${m.size} remaining region(s)`);break}const t=T(e);t&&(await M(`Region ${e.id} will belong to faction ${t.id}`,e.hexes),t.captureRegions(e),w[t.id]-=e.size,v[t.id]+=e.size,P()),m.delete(e)}function x(e){if(i.coloration>.7)return(0,s.findMin)(Array.from(e),(e=>g[e.id]?.size??1/0));{const t=e=>e.getNeighbours().filter((e=>!e.faction?.isNeutral())).length;return u.inject.random.boolean(i.clustering)?(0,s.findMax)(Array.from(e),t):(0,s.findMin)(Array.from(e),t)}}function T(e){const t=g[e.id];if(t?.size)return(0,s.findMax)(Array.from(t),(e=>w[e.id]))}function P(){for(let t of m){const s=S.filter((s=>!(s.getRegions().length>=b[s.id]&&w[s.id]<t.size/2)&&0===u.inject.views.factionInfluenceByRegion.get(e.state,{influencingFaction:s.id,targetRegion:t.id,maxDistance:i.cellSeparation,powerMeasurement:a.PowerMeasurement.RegionSize}).total));0===s.length?delete g[t.id]:g[t.id]=new Set(s)}}async function M(t,i){await u.inject.debugBreakpoint(`[mapgen:assignFactions] ${t}`,(()=>({hexes:i,debugLayer:{onChange:(0,o.signal)(),getGroups:()=>Array.from(m).map((e=>e.hexes)),getMap:()=>({getHexIds:()=>n.HexGroup.union(e.regions.all().map((e=>e.hexes))).toIdsArray(),get:t=>{const i=e.regions.byHex((0,r.getHex)(t));return Array.from(g[i.id]??[]).map((e=>e.id)).toString()}}),getDetail:e=>""}})))}0===v[1]&&e.factions.byId(1).captureRegions(u.inject.random.oneOf(e.regions.all())),p.debug(`Final stats:\n\nassigned hexes per faction:\b\n${(0,c.prettyPrintObject)(v,2)}\n`)}},77359:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getFactionsFromConfig=void 0,t.getFactionsFromConfig=function(e,t){return t.map(((t,i)=>e.factions.byId(i+1)))}},43911:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.partitionLand=void 0;const n=i(78179),a=s(i(20504)),o=i(12678),r=i(85656),c=i(52937),l=i(24794),d=i(47613),h=i(21999),u=i(88865);t.partitionLand=async function(e,t,i,s){let p=t.hexes.filter((t=>!e.warfare.isImpassable(t)));(0,o.assert)(p.length),p.length;const g=await async function(e,t,i){const s=new a.default;let d;for(e.forEach((e=>s.addToGroup(e.id,e))),await g("starting state");d=h(s.keys());){await i();const e=p(d);e||await g("about to fail - no valid neighbour",n.HexGroup.from(d.hexes)),o.assert.defined(e),await g("merging groups",n.HexGroup.union([n.HexGroup.from(e.hexes),n.HexGroup.from(d.hexes)])),s.addToGroup(e.key,...d.hexes)}return s;function h(e){let i,n=1/0;for(let a of e){const e=s.byKey(a);if(e.hexes.size>=t.minCellSize)continue;const o=s.getGroupsAdjacentTo(a),r=o.filter((i=>i.hexes.size+e.hexes.size<t.maxCellSize));if(0!==o.length){if(r.length<=1)return e;r.length>0&&r.length<n&&(i=e,n=r.length)}}return i}function p(e){let i=s.getGroupsAdjacentTo(e.key);return(0,r.findMax)(i,(i=>{let s=0;return e.hexes.size+i.hexes.size>t.maxCellSize&&(s=-100),i.hexes.size<t.minCellSize&&(s=1),i.borderSize+s}))}async function g(e,t){await u.inject.debugBreakpoint(`mapgen: ${e}`,(()=>({hexes:t,debugLayer:{onChange:(0,c.signal)(),getGroups:()=>s.getGroups(),getMap:()=>({getHexIds:()=>n.HexGroup.union(s.getGroups()).toIdsArray(),get:e=>s.getOwnerOf((0,l.getHex)(e))}),getDetail:e=>""}})))}}(p,i,s),m=[];e.useProjections(d.ProjectionPresets.coreEntities);const y=e.factions.byId(h.SpecialFaction.neutral);for(let e of g.getGroups())(0,o.assert)(e.length>0),await s(),m.push(y.addNewRegion(u.inject.random.townName(),e));return e.activateAllProjections(),m}},44846:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PickRegionsMemory=t.spawnTowns=void 0;const s=i(77359),n=i(96486),a=i(85656),o=i(23441),r=i(30420),c=i(12678),l=i(48500),d=i(78179),h=i(40909),u=i(88865),p=l.logger.for("spawnTowns");t.spawnTowns=async function(e,t,i,l){const h=(0,s.getFactionsFromConfig)(e,i.factions);for(let e of h){const t=i.factions[e.id-1].startingTilesMultiplier??1,s=await y(e,t);await u.inject.debugBreakpoint(`mapgen.spawnTowns: picked regions for ${e}`,(()=>({hexes:d.HexGroup.union(s.map((e=>e.hexes)))})));for(let t of u.inject.random.shuffle(s))await l(),m(t,1!==e.id)}function m(t,s){const n=(0,a.findMax)(t.hexes.members,(i=>function(t,i){return i.neighbours().map((i=>{let s=0;return e.warfare.isImpassable(i)&&s++,e.regions.byHex(i)===t&&s++,e.pawns.byHex(i,r.PawnType.Town)&&(s-=5),s-=e.warfare.getHexDefense(i),s})).reduce(o.sum,0)+u.inject.random.number()}(t,i)));c.assert.defined(n),e.pawns.create({hex:n,type:r.PawnType.Town});const l=s?(0,o.pickLarger)(0,i.startingCoins-t.budget.incomeFromHexes):i.startingCoins;e.pawns.create({hex:n,type:r.PawnType.Coins,count:l})}async function y(s,n=1){const a=new g;return await f({model:e,faction:s,tilesLeft:Math.floor(i.startingTiles*n),penalty:0,solutionSoFar:[],remainingRegions:u.inject.random.shuffle(t.filter((e=>e.faction===s))),memory:a,minRegionCount:(0,o.pickLarger)(1,Math.round(n))}),a.bestSolution.regions}async function f(e){const{model:t,faction:s,tilesLeft:a,solutionSoFar:r,remainingRegions:c,penalty:d,memory:h}=e;await l(),h.steps++;let u={regions:r,penalty:d+a*a+100*(0,o.pickLarger)(0,e.minRegionCount-r.length)};if(function(e,t){t.memory.cache.store(e.regions,e),e.penalty<t.memory.bestSolution.penalty&&(t.memory.bestSolution=e)}(u,e),!(a<=0||u.penalty>e.memory.bestSolution.penalty))for(let t of c){const s=a-t.size,o=[...r,t];h.cache.find(o)||(p.group(`given a pick of region ${t.id}`),await f({...e,tilesLeft:s,solutionSoFar:[...r,t],remainingRegions:(0,n.without)(c,t),penalty:d+(g=t,g.getNeighbours().filter((e=>e.isAlive())).length*(.5-i.clustering)*3)}),p.groupEnd())}var g}};class g{constructor(){this.cache=new h.ObjectCache((e=>e.map((e=>e.id)).sort().join(","))),this.steps=0,this.bestSolution={regions:[],penalty:1/0}}}t.PickRegionsMemory=g},58586:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseKonkrData=void 0;const s=i(24592),n=i(88865),a=i(84370),o=i(58592),r=i(13010);t.parseKonkrData=function(e){if((0,s.isEncodedGameState)(e)){const t=(0,s.decodeGameState)(e);n.inject.ui.session.startNew({origin:"file-import",levelId:t.map.levelId,turnNumber:t.currentPhase.turnNumber}),n.inject.gameStateController.loadState(t,a.NewGameStateContext.LoadingGame),o.app.navigator.goTo(o.app.screen.play,a.NewGameStateContext.LoadingGame),o.app.scene.worldMap.syncState()}else{if(!(0,s.isEncodedReplay)(e))throw new Error("File content is not compatible with this version of the game.");(0,r.loadReplay)(e)}}},51262:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameHistoryCursor=t.GameHistory=void 0;const s=i(98030),n=i(99896),a=i(88865),o=i(12678),r=i(48500),c=i(14344),l=i(82169),d=i(11041),h=i(47613),u=i(59006),p=i(91025),g=i(10337),m=i(96348),y=i(84370),f=r.logger.for("GameHistory");t.GameHistory=class{get length(){return this.data.length}constructor(){this.data=[],this.tempModel=new h.GameStateModel}addPlay(e,t,i){let s=new Set,a=n.CurrentPhase.getFaction(i)??0;this.data.length?this.data[this.data.length-1].activeFaction!==a&&s.add("turnStart"):(s.add("gameStart"),s.add("turnStart")),this.data.push({play:e,gameState:i,compressedState:null,activeFaction:a,tags:s,events:t}),this.updateDebugData()}reset(e){this.data=[{tags:new Set(["gameStart","turnStart"]),activeFaction:n.CurrentPhase.getFaction(e)??0,play:void 0,events:[],gameState:e,compressedState:null}],this.updateDebugData()}rewindTo(e,t){(0,o.assert)(e.history===this,"cursor is not valid for this GameHistory instance");const i=this.data.splice(e.currentIndex+1);t.storeAsRewind&&(e.currentStep.rewinds||(e.currentStep.rewinds=[]),e.currentStep.rewinds.push(i)),this.updateDebugData()}getCursor(){return new w(this)}latestMoveIndex(){return this.data.length-1}get latestState(){return this.getStateAt(this.data.length-1)}updateDebugData(){a.inject.config.debug.gameHistory&&a.inject.debugData.set("history",this.debugDump(3))}getStateAt(e){const t=this.data[e];if(!t)throw new Error(`index ${e} out of range (0..${this.data.length-1})`);if(t.gameState)return t.gameState;if(t.compressedState)return this.tempModel.restore(t.compressedState),this.tempModel.stateEngine.activateAllProjections(),t.gameState=(0,s.setParentEngine)(this.tempModel.state,a.inject.gameStateModel.stateEngine),t.gameState;if(0===e)throw new Error("Cannot restore state - no state snapshot available at initial state");return this.reconstructStateAndEventsAt(e),t.gameState}reconstructStateAndEventsAt(e){const t=this.getStateAt(e-1),i=this.data[e];if(v(i)){const t=e-i.rewindSteps;return i.gameState=this.getStateAt(t),void(i.events=[p.GameStateEvents.NewGameState({state:i.gameState,context:y.NewGameStateContext.Rewind})])}if(!i.play)return i.gameState=t,void(i.events=[]);this.tempModel.restore(t),this.tempModel.stateEngine.activateAllProjections();const n=(0,u.gameStateReducer)(this.tempModel,i.play);i.gameState=(0,s.setParentEngine)(this.tempModel.state,a.inject.gameStateModel.stateEngine),i.events=n}getCompressedStateAt(e){const t=this.data[e];if(!t)throw new Error(`index ${e} out of range (0..${this.data.length-1})`);if(t.compressedState)return t.compressedState;const i=this.getStateAt(e);return t.compressedState=(0,l.compressGameState)(i),t.compressedState}getEventsAt(e){const t=this.data[e];if(!t)throw new Error(`index ${e} out of range (0..${this.data.length-1})`);var i;return(i=t).play||i.rewindSteps||(t.events=[]),t.events||this.reconstructStateAndEventsAt(e),t.events}import(e,t){this.data=(0,m.importReplay)(e,t)}export(e){return(0,g.exportReplay)(this.data,{...e,gameStateSerializer:e=>this.getCompressedStateAt(e),title:d.LevelModel.for(a.inject.gameStateModel.map.levelId).getTitle()})}debugDump(e=20){return this.data.map(((e,t)=>`#${t} ${function(e){if(v(e))return`[REWIND] ${e.rewindSteps} steps`;let t=`[${e.activeFaction}:${e.compressedState?"C":"."}${e.gameState?"S":"."}${e.events?"E":"."}] after ${e.play?.name??"initialization"} ${Array.from(e.tags).join(",")}`;return e.rewinds&&(t+=`\n${e.rewinds.map((e=>` └ rewind ${e.length} steps`)).join("\n")}`),t}(e)}`)).slice(-e).join("\n")}};class w{constructor(e){this.history=e,this.currentIndex=0,this.currentIndex=e.latestMoveIndex()}isValid(){return this.currentIndex<this.history.length}canUndo(){const e=this.previousStep?.activeFaction;return this.currentStep&&e===this.currentStep.activeFaction}stepBack(){return 0!==this.currentIndex&&(this.currentIndex-=1,!0)}stepForward(){return!(this.currentIndex>=this.history.data.length-1||(this.currentIndex+=1,0))}consumeNextPlay(){return this.stepForward()?this.history.getEventsAt(this.currentIndex):[]}get currentStep(){return this.history.data[this.currentIndex]}get currentStepEvents(){return this.history.getEventsAt(this.currentIndex)}get currentState(){return this.currentIndex>=this.history.length&&(f.warning(`cursor is out of range (${this.currentIndex}>${this.history.length-1}), resetting to latest state`),this.currentIndex=this.history.length-1),this.history.getStateAt(this.currentIndex)}get latestEvent(){const e=this.history.getEventsAt(this.currentIndex);return e[e.length-1]}get previousStep(){return this.history.data[this.currentIndex-1]}peekNextEvent(){if(!this.hasNext())return;let e=this.currentIndex+1;for(;e<this.history.data.length&&0===this.history.getEventsAt(e).length;)++e;return this.history.getEventsAt(e)[0]}get nextStep(){return this.history.data[this.currentIndex+1]}goTo(e){return(0,o.assert)(e>=0&&e<this.history.data.length,`goTo index ${e} is out of valid range (0..${this.history.data.length-1})`),this.currentIndex=e,this}goToLastStep(){return this.currentIndex=this.history.data.length-1,this}seekBack(e){for(let t=this.currentIndex;t>=0;--t)if(e(this.history.data[t]))return this.goTo(t),!0;return!1}seekForward(e){for(let t=this.currentIndex;t<this.history.data.length;++t)if(e(this.history.data[t]))return this.goTo(t),!0;return!1}seekBackTag(e,t){return this.seekBack((i=>i.tags.has(e)&&(void 0===t||i.activeFaction===t)))}seekForwardTag(e,t){return this.seekForward((i=>i.tags.has(e)&&(void 0===t||i.activeFaction===t)))}seekBackFaction(e){return this.seekBack((t=>t.activeFaction===e))}seekForwardFaction(e){return this.seekForward((t=>t.activeFaction===e))}clone(){return new w(this.history).goTo(this.currentIndex)}canRollback(){if(!this.currentStep)return!1;const e=this.clone(),t=c.Factions.model(this.history.latestState).all().find((e=>e.isLocalPlayer()))?.id;if(!t)return!1;if(n.CurrentPhase.model(this.history.latestState).faction?.id===t){if(!e.seekBackTag("turnStart",t))return!1;if(!e.stepBack())return!1}return e.seekBackTag("turnStart",t)}hasNext(){return this.currentIndex<this.history.data.length-1}}function v(e){return!!e.rewindSteps}t.GameHistoryCursor=w},93311:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameEventModel=t.ScreenWriter=t.groupByFactionsScreenWriter=t.groupByRegionsScreenWriter=t.playByPlayScreenwriter=void 0;const s=i(34758),n=i(91025),a=i(50264),o=i(14344),r=i(48500),c=i(33174),l=i(12678);r.logger.for("ScreenWriters"),t.playByPlayScreenwriter=function(e){if(!e.stepForward())return;const t=e.currentStepEvents;let i=new Set,s=[];for(let e of t)if(g(e)){s.push(e.payload.worldUpdates);for(let t of e.payload.worldUpdates.affectedRegions)i.add(t)}return{gameEvents:t,worldUpdates:s,affectedRegions:Array.from(i),focusRegions:h(t),highlightHexes:u(t)}},t.groupByRegionsScreenWriter=function(e){if(!e.hasNext())return;const t=new d((e=>h([e])[0]));for(t.addEvents(e.consumeNextPlay());t.fitsIntoCurrentBeat(e.peekNextEvent());)t.addEvents(e.consumeNextPlay());return t.getScreenPlay()},t.groupByFactionsScreenWriter=function(e){if(!e.hasNext())return;const t=new d((e=>function(e){const t=h([e])[0];return t&&g(e)?o.Factions.getByRegion(e.payload.worldUpdates.stateBefore,t):void 0}(e)));for(t.addEvents(e.consumeNextPlay());t.fitsIntoCurrentBeat(e.peekNextEvent());)t.addEvents(e.consumeNextPlay());return t.getScreenPlay()};class d{constructor(e){this.grouper=e,this.beatState=void 0,this.screenPlay={gameEvents:[],highlightHexes:new Set,focusRegions:new Set,affectedRegions:new Set,worldUpdates:[]}}getEventKey(e){return this.grouper(e)}fitsIntoCurrentBeat(e){return!!e&&this.beatState&&this.beatState.updateListKey===this.getEventKey(e)}startNewBeat(e){this.beatState&&this.endCurrentBeat();const t=this.getEventKey(e);this.beatState={updateListKey:t,affectedRegions:new Set,moveByTargetHex:{},initialState:void 0,finalState:void 0,updateList:[],retreatDestinations:{}}}endCurrentBeat(){const e=this.beatState;e&&(e.updateList.push(...Object.values(e.moveByTargetHex)),e.updateList.length&&this.screenPlay.worldUpdates.push({updates:e.updateList,affectedRegions:Array.from(e.affectedRegions),stateBefore:e.initialState,stateAfter:e.finalState}),this.beatState=void 0)}processEvent(e){if(l.assert.defined(this.beatState,"processEvent called outside of beat"),g(e)){for(let t of e.payload.worldUpdates.affectedRegions)this.beatState.affectedRegions.add(t);e.payload.worldUpdates.affectedRegions.forEach((e=>this.screenPlay.affectedRegions.add(e)));for(let t of e.payload.worldUpdates.updates)switch(t.type){case c.UpdateType.PawnsMoved:this.addPawnMoveUpdate(t);break;case c.UpdateType.PawnReplaced:this.addPawnReplacedUpdate(t);break;default:this.beatState.updateList.push(t)}this.beatState.initialState||(this.beatState.initialState=e.payload.worldUpdates.stateBefore),this.beatState.finalState=e.payload.worldUpdates.stateAfter}}addEvents(e){this.screenPlay.gameEvents.push(...e),u(e).forEach((e=>this.screenPlay.highlightHexes.add(e))),h(e).forEach((e=>this.screenPlay.focusRegions.add(e)));for(let t of e)this.fitsIntoCurrentBeat(t)||this.startNewBeat(t),this.processEvent(t)}addPawnReplacedUpdate(e){const t=e.hexId,i=this.beatState;l.assert.defined(i);const s=i.moveByTargetHex[t];s?i.moveByTargetHex[t]={...s,replaced:{newPawnId:e.newPawnId,oldType:e.oldType,newType:e.newType}}:i.updateList.push(e)}addPawnMoveUpdate(e){const t=e.pawns[0]?.srcHex,i=e.pawns[0]?.pawnId,s=this.beatState;if(l.assert.defined(t),l.assert.defined(s),(e={...e}).defeatedUnit?.retreatHex){const t=e.defeatedUnit?.retreatHex;l.assert.undefined(s.retreatDestinations[t],"invalid retreat to hex which already has a retreating unit"),s.retreatDestinations[t]=e}const n=s.retreatDestinations[e.destHex],a=s.moveByTargetHex[t],o=s.moveByTargetHex[e.destHex];if(n){const t={...n,defeatedUnit:e.defeatedUnit};s.moveByTargetHex[n.destHex]=t,delete s.retreatDestinations[e.destHex],e.defeatedUnit?.retreatHex&&(s.retreatDestinations[e.defeatedUnit?.retreatHex]=t),delete e.defeatedUnit}if(o||a){l.assert.undefined(a?.defeatedUnit,`attempt to follow-up a move which defeated a unit (capture ${a?.destHex} => move to ${e.destHex})`),l.assert.undefined(a?.hexCaptured,`attempt to follow-up a move after hexCaptured move (capture ${a?.destHex} => move ${t}->${e.destHex})`);let n=e.merged&&{...e.merged};!n&&a.merged&&(n={newPawnId:a.merged.newPawnId,outputType:a.merged.outputType});const r=[];if(a?(delete s.moveByTargetHex[t],i===a?.merged?.newPawnId?(r.push(...a.pawns),a.merged?.mergedWith&&r.push({pawnId:a.merged.mergedWith,srcHex:a.destHex})):r.push(...e.pawns)):r.push(...e.pawns),o){const t=e.merged&&e.merged?.mergedWith===o?.merged?.newPawnId;o.merged&&(t?(r.push(...o.pawns),o.merged.mergedWith&&r.push({pawnId:o.merged.mergedWith,srcHex:o.destHex}),n&&delete n.mergedWith):r.push({pawnId:o.merged.newPawnId,srcHex:o.destHex}))}s.moveByTargetHex[e.destHex]={type:c.UpdateType.PawnsMoved,pawns:r,destHex:e.destHex,defeatedUnit:e.defeatedUnit,hexCaptured:o?.hexCaptured??e.hexCaptured,merged:n}}else s.moveByTargetHex[e.destHex]=e}getScreenPlay(){return this.endCurrentBeat(),{gameEvents:this.screenPlay.gameEvents,worldUpdates:this.screenPlay.worldUpdates,affectedRegions:Array.from(this.screenPlay.affectedRegions),focusRegions:Array.from(this.screenPlay.focusRegions),highlightHexes:Array.from(this.screenPlay.highlightHexes)}}}function h(e){const t=new Set;for(let i of e)p.of(i).getFocusRegionIds().forEach((e=>t.add(e)));return Array.from(t)}function u(e){const t=new Set;for(let i of e)(0,s.isEvent)(i,n.GameStateEvents.HexCaptured)&&t.add(i.payload.capturedHexId);return Array.from(t)}t.ScreenWriter=d;class p{constructor(e){this.event=e}static of(e){return new p(e)}getSourceHexId(){const e=this.event;return(0,s.isEvent)(e,n.GameStateEvents.HexCaptured)?e.payload.originatingHexId:(0,s.isEvent)(e,n.GameStateEvents.PawnMoved)?e.payload.sourceHexId:void 0}getDestinationHexId(){const e=this.event;return(0,s.isEvent)(e,n.GameStateEvents.HexCaptured)?e.payload.capturedHexId:(0,s.isEvent)(e,n.GameStateEvents.PawnMoved)||(0,s.isEvent)(e,n.GameStateEvents.PawnBought)?e.payload.destinationHexId:void 0}getFocusRegionIds(){const e=this.event;return(0,s.isEvent)(e,n.GameStateEvents.HexCaptured)?[e.payload.capturingRegionId]:(0,s.isEvent)(e,n.GameStateEvents.PawnMoved)?[a.Regions.getByHex(e.payload.worldUpdates.stateBefore,e.payload.sourceHexId)]:(0,s.isEvent)(e,n.GameStateEvents.PawnBought)?[e.payload.buyerRegionId]:(0,s.isEvent)(e,n.GameStateEvents.FactionTurnStarted)?o.Factions.model(e.payload.state).byId(e.payload.factionId)?.getLiveRegions().map((e=>e.id))??[]:[]}}function g(e){return e.payload.hasOwnProperty("worldUpdates")}t.GameEventModel=p},10337:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.exportReplay=void 0;const s=i(91025),n=i(19098),a=[s.Plays.EndTurn,s.Plays.AcceptSurrender,s.Plays.BanditsAct,s.Plays.MovePawn,s.Plays.BuyPawn],o=new Set(a.map((e=>e.eventName)));function r(e,t,i){if(e.rewindSteps)throw new Error("Attempt to serialize replay with unpacked rewinds!");return[{play:c(e.play),snapshot:i,tags:e.tags.size?Array.from(e.tags):void 0,faction:e.activeFaction,rewinds:d(e,t)}]}function c(e){if(e){if(!o.has(e.name))throw new Error(`Unable to serialize ${(0,n.describeEventVerbose)(e)}`);return{name:e.name,payload:e.payload}}}function l(e,t,i,s){if(function(e,t,i,s){if(s.snapshotPolicy.includes("initial")&&0===i)return!0;if(s.snapshotPolicy.includes("final")&&t===e.length-1)return!0;const n=e[t],a=e[t+1];return!(!s.snapshotPolicy.includes("p1-start")&&!s.snapshotPolicy.includes("p1-rewind-checkpoints")||1!==n.activeFaction||!n.tags.has("turnStart"))||!(!s.snapshotPolicy.includes("p1-rewind-checkpoints")||1!==n.activeFaction||!a?.tags.has("turnStart"))}(e,t,i,s))return s.gameStateSerializer(t)}function d(e,t){if(!e.rewinds||!t.includeRewinds)return;let i=[];for(let s of e.rewinds)i.push(s.flatMap((e=>r(e,t,void 0))));return i}t.exportReplay=function(e,t){let i=0;e.length>t.sizeLimit&&(i=e.length-t.sizeLimit);let s=[];for(let n=i;n<e.length;++n)s.push(...r(e[n],t,l(e,n,n-i,t)));return{meta:{title:t.title,timestamp:Date.now()},steps:s}}},96348:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.importReplay=void 0;const s=i(12678),n=i(34758);function a(e,t,i=0){const s=[];for(let r of e)if(void 0!==r.faction&&(i=r.faction),s.push({events:null,gameState:null,compressedState:r.snapshot??null,play:r.play&&{...r.play,isTypedEvent:!0,category:n.EventCategory.Play},activeFaction:i,tags:new Set(r.tags),rewinds:r.rewinds&&!t.unpackRewinds?r.rewinds.map((e=>a(e,t,i))):void 0}),t.unpackRewinds&&r.rewinds){const e=o(r.rewinds,i);s.push(...e,{gameState:null,compressedState:null,events:null,tags:new Set,activeFaction:i,rewindSteps:e.length+1})}return s}function o(e,t){let i=[];for(let s of e)i.push(...a(s,{unpackRewinds:!0},t));return i}t.importReplay=function(e,t){const i=e.steps[0];return s.assert.defined(i?.snapshot,"invalid replay: missing snapshot in initial step"),s.assert.defined(i?.faction,"invalid replay: missing faction in initial step"),a(e.steps,t)}},13010:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.loadReplay=void 0;const s=i(24592),n=i(12678),a=i(88865),o=i(84370),r=i(58592);t.loadReplay=function(e){const t=(0,s.decodeReplay)(e),i=t.steps[0].snapshot;n.assert.defined(i,"Replay data is corrupted."),a.inject.gameStateController.loadState({...i,replay:t},o.NewGameStateContext.LoadReplay),r.app.navigator.goTo(r.app.screen.play,o.NewGameStateContext.LoadReplay)}},72019:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tryToEncodeCurrentReplay=void 0;const s=i(88865),n=i(24592);t.tryToEncodeCurrentReplay=function(){try{const e=s.inject.gameStateController.history.export({snapshotPolicy:["initial","final"],includeRewinds:!0,sizeLimit:2e3});return(0,n.encodeReplay)(e)}catch(e){return`[failed to export] ${e.message}`}}},76515:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AutoPrompts=void 0;const s=i(91025),n=i(48500),a=i(44188),o=i(11041),r=i(88865),c=i(58592),l=["intro1"];n.logger.for("AutoPrompts"),t.AutoPrompts=class{constructor(e){this.events=e,e.on(s.SystemEvents.ScreenActivated,(async e=>{const t=[c.app.screen.play],i=r.inject.ui.selectedLevelId();if(i&&(e.screen===c.app.screen.levelDetail||e.screen===c.app.screen.victory)&&e.previousScreen&&t.includes(e.previousScreen)){if(!window.navigator.onLine)return;if(c.app.screen.play.isReplay)return;const e=r.inject.userData.recallChoice("dismissedFeedbackForm")??0;if((0,a.differenceInDays)(Date.now(),e)<1)return;const t=r.inject.userData.getLevelRecordById(i);if(r.inject.ui.session.getTotalSeconds()<=60)return;if(t?.feedback)return;if(l.includes(i))return;if(!o.LevelModel.for(i).campaignContext)return;c.app.notifications.askForLevelFeedback(i)}}))}}},75071:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ErrorTracking=void 0;const o=a(i(47906)),r=i(91025),c=i(48500),l=i(14711),d=i(60807),h=i(88865),u=i(58592),p=i(120),g=i(54465),m=i(72019),y=i(15503),f=c.logger.for("Telemetry"),w=["Failed to start the audio device","Illegal invocation","The database connection is closing"],v=[y.FirebaseError],b=new Set([r.SystemEvents.ScreenActivated].map((e=>e.eventName)));function S(e){return e.extra={...e.extra,replay:(0,m.tryToEncodeCurrentReplay)()},e}function x(e){return e instanceof Error?{error:e,extras:{}}:"string"==typeof e?{error:new Error(e),extras:{}}:"object"==typeof e?{error:new Error(e.message??"Error without message"),extras:e}:{error:e,extras:{}}}t.ErrorTracking={gameRunning:!1,hadErrors:!1,tamperingDetected:!1,setup(e){window.onunhandledrejection=e=>{console.warn("window.onunhandledrejection",e),t.ErrorTracking.captureException(e.reason),t.ErrorTracking.hadErrors=!0},window.onerror=function(e,i,s,n,a){i&&(t.ErrorTracking.captureException(a),t.ErrorTracking.hadErrors=!0)},o.init({enabled:e.reporting.sentry.enabled,dsn:e.reporting.sentry.dsn,environment:"production",release:"2.10.0-build-5143612584",beforeSend:S})},logEvent(e){b.has(e.name)||o.addBreadcrumb({type:"default",level:"debug",category:e.category,message:(0,r.describeEvent)(e)})},captureException(e){const{error:i,extras:s}=x(e),n=h.inject.random.id(l.ID_TYPE.Error);t.ErrorTracking.gameRunning&&(h.inject.events.trigger(r.SystemEvents.FatalError({correlationId:n,message:i.toString()})),function(e){for(const t of v)if(e instanceof t)return!1;for(const t of w)if(e.message.includes(t))return!1;return!0}(i)?u.app.notifications.uncaughtError(n):f.info(`Error popup for ${i} was supressed`)),window.navigator.onLine?this.tamperingDetected?f.warning("Not reporting exception after unsupported operations were performed",i):t.ErrorTracking.gameRunning?(o.captureException(i,{extra:{...s},tags:{correlationId:n}}),d.track.exception({description:i.toString(),fatal:!0,correlation_id:n})):function(e){let t=Math.floor(1e6*Math.random()).toString();console.error(e),setLoadingStatus(`Oh no! Something went really wrong and the game failed to load :(\n             \nerror-id: ${t}`,!1),p.Firebase.analytics&&(0,g.logEvent)(p.Firebase.analytics,"exception",{description:`Failed to boot: ${e}`,correlation_id:t,fatal:!0,during_boot:!0}),o.captureException(e,{tags:{correlationId:t}})}(i):f.warning("Not reporting exception in offline mode",i)},captureNonFatalError(e,t){const{error:i,extras:s}=x(e);window.navigator.onLine?(console.warn(`[silent error: ${t}]`,i),o.captureException(i,{extra:{...s},tags:{backgroundErrorContext:t}}),d.track.exception({description:i.toString(),fatal:!1})):f.warning("Ignoring exception in offline mode",i)},initializeContext(){h.inject.events.on(r.SystemEvents.UserSignedIn,(({userId:e})=>{o.setUser({id:e})})),h.inject.events.on(r.UserActions.EditMap,(()=>{this.tamperingDetected=!0})),h.inject.events.on(r.UserActions.InternalLoadGame,(()=>{this.tamperingDetected=!0})),h.inject.events.on(r.UserActions.OpenLoadGameDialog,(()=>{this.tamperingDetected=!0})),o.setTags({scale:h.inject.ui.scale().toString(),logicalDpr:u.app.device.dpr,realDpr:window.devicePixelRatio??1,frameParent:u.app.device.frameParent,uiVariant:u.app.device.uiVariant().toString()}),h.inject.events.on(r.SystemEvents.ScreenActivated,(({screen:e,previousScreen:t})=>{o.addBreadcrumb({type:"navigation",data:{from:t?.name,to:e?.name}})})),h.inject.ui.selectedLevelId.watch((e=>{o.setTag("levelId",e)}))}}},40009:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Reporter=t.ReportingEvents=t.reportingEvent=void 0;const s=i(34758),n=i(35521),a=i(3910),o=i(76515),r=i(60807),c=i(48500),l=i(99313);function d(){return(0,s.createEventFactory)(s.EventCategory.ReportingEvent)}t.reportingEvent=d,t.ReportingEvents={SubmitFeedbackForm:d()("SUBMIT_FEEDBACK_FORM")},c.logger.for("Reporter"),t.Reporter=class{constructor(e,i){this.slackClient=new n.SlackClient(i.reporting.slack.feedbackHook),this.autoPrompts=new o.AutoPrompts(e),this.telemetry=new l.Telemetry,e.on(t.ReportingEvents.SubmitFeedbackForm,(e=>{if(e.comment&&i.reporting.slack.enabled){const t=(0,a.reportFeedback)(e);this.slackClient.sendMessage(t)}r.track.playerFeedback({mood:e.mood,level_id:e.levelId})}))}setupTelemetryReporting(){this.telemetry.initialize()}async sendTelemetryEvents(){await this.telemetry.flushPendingEvents()}}},99313:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Telemetry=void 0;const n=i(88865),a=i(91025),o=i(58592),r=i(81591),c=i(120),l=i(51453),d=i(48500),h=i(75071),u=i(87262),p=i(43427),g=i(96486),m=s(i(95775)),y=i(40009);d.logger.for("Telemetry"),t.Telemetry=class{constructor(){this.sampleThreshold=0,this.observe=new u.Observer((()=>o.app.remoteConfig.levelTelemetrySampleRate>this.sampleThreshold)),this.storedPendingEvents=new p.PersistentEntry("konkr.telemetryEvents.v1"),this.pendingEvents=[],this.scheduleTelemetryRequest=(0,g.debounce)(this.flushPendingEvents.bind(this),200,{trailing:!0})}initialize(){this.sampleThreshold=n.inject.random.numberBetween(0,1);const e=this.storedPendingEvents.take();if(e)for(let t of e)this.sendEvent(t);this.observe.event(a.SystemEvents.LevelSessionStarted,(e=>{this.sendEvent({type:"LEVEL_ENTER",origin:e.origin,device:{build:"2.10.0-build-5143612584",env:"production",realDpr:window.devicePixelRatio,logicalDpr:o.app.device.dpr,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,userAgent:window.navigator.userAgent,vw:window.innerWidth,vh:window.innerHeight,os:o.app.device.os(),touch:o.app.game.device.input.touch,uiVariant:o.app.device.uiVariant()},userId:n.inject.login.getUserId(),parentFrame:o.app.device.frameParent,levelId:e.levelId,levelSessionId:e.sessionId})})),this.observe.event(a.SystemEvents.LevelSessionOver,(e=>{this.sendEvent({type:"LEVEL_LEAVE",origin:e.origin,victoryDistance:e.victoryDistance,levelSessionId:e.sessionId,timestamp:e.timestamp,playLog:e.playLog,avgFps:e.avgFps,minFps:e.minFps,replay:e.replay,tampering:h.ErrorTracking.tamperingDetected})})),this.observe.event(y.ReportingEvents.SubmitFeedbackForm,(e=>{e.levelId&&this.sendEvent({type:"LEVEL_FEEDBACK",levelId:e.levelId,userId:n.inject.login.getUserId(),mood:e.mood,comment:e.comment})}))}sendEvent(e){this.pendingEvents.push(e),this.scheduleTelemetryRequest()}async flushPendingEvents(){const e=this.pendingEvents;if(0!==e.length){this.pendingEvents=[];try{if(!n.inject.config.flags.telemetry)return;await(0,r.addDoc)((0,r.collection)(c.Firebase.db,l.Collections.telemetryEvents),{events:(0,m.default)(e),timestamp:(0,r.serverTimestamp)()})}catch(e){h.ErrorTracking.captureNonFatalError(e,"Telemetry.sendEvent")}}}}},3910:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.reportFeedback=void 0;const s=i(11041),n=i(33817),a=i(69905),o=i(44188),r=i(88865),c=i(58592),l=i(54444);function d(e){return(0,a.prefixEachLineWith)("> ",`${t=e.mood,void 0===t?"":p[t]??`<${t}>`} ${e.comment}\n-- ${e.email||"user <"+r.inject.login.getUserId()+">"}`);var t}function h(e){return(e.campaignContext?`*${e.campaignContext.campaign.name} progress:* ${t=e.campaignContext,t.campaign.levels.map(((e,t)=>{const i=s.LevelModel.for(e.id);return`[${t+1}${m[i.getLevelStatus()]}]`})).join(" ")}\n`:"")+`*${function(e){const t=e.campaignContext;return t?`Level ${t.indexInCampaign+1}`:`Custom level \`${e.id}\`*`}(e)} progress:* ${m[e.getLevelStatus()]} ${function(e){const t=e.userData;switch(e.getLevelStatus()){case s.LevelStatus.Replaying:return`replaying (turn ${t?.inProgress?.turnNumber??"?"}), previous victory in ${t?.won?.turns??"?"} turns`;case s.LevelStatus.NotStarted:return"not started";case s.LevelStatus.InProgress:return`turn ${t?.inProgress?.turnNumber??"?"}`;case s.LevelStatus.Completed:return`won in ${t?.won?.turns??"?"} turns`;case s.LevelStatus.Locked:return"locked";case s.LevelStatus.Defeated:return`defeated in ${t?.lost?.turns??"?"} turns`}}(e)}`;var t}function u(e){const t=e.campaignContext;return t?`*${e.getTitle(s.LevelTitleStyle.Full)}* in *${t.campaign.name}*`:`*custom level \`${e.id}\`*`}t.reportFeedback=function(e){if(e.levelId){const t=s.LevelModel.for(e.levelId);return{blocks:[n.SlackMessage.section.text(`:incoming_envelope: Feedback on ${u(t)}:`),n.SlackMessage.section.text(d(e),h(t)),n.SlackMessage.section.text(n.SlackMessage.codeBlock(y(),g(t)))]}}return{blocks:[n.SlackMessage.section.text(`:incoming_envelope: Feedback from *${c.app.navigator.currentScreen?.name??"<unknown screen>"}*:`),n.SlackMessage.section.text(d(e)),n.SlackMessage.section.text(n.SlackMessage.codeBlock(y()))]}};const p=[void 0,":rage:",":angry:",":neutral_face:",":slightly_smiling_face:",":smile:"];function g(e){const t=r.inject.userData.getLevelRecordById(e.id)?.stats;return`level:\n  id: ${e.id} (campaign_id: ${e.campaignContext?.campaign.id})\n  status: ${e.getLevelStatus()}\n  stats: ${t?function(e){return`${e.playTimeSeconds}s, ${e.turns} turns, ${e.clicks} clicks, ${e.undoCount} undos`}(t):"N/A"}\n  turn: ${e.userData?.inProgress?.turnNumber??e.userData?.won?.turns}\n`}const m={[s.LevelStatus.Completed]:":trophy:",[s.LevelStatus.Replaying]:":trophy::crossed_swords:",[s.LevelStatus.InProgress]:":crossed_swords:",[s.LevelStatus.Defeated]:":headstone:",[s.LevelStatus.Locked]:":lock:",[s.LevelStatus.NotStarted]:":white_square:"};function y(){const e=r.inject.userData.getStats();return`game:\n  build: 2.10.0-build-5143612584 (environment=production)\n  url: ${window.location.toString()}\n  screen: ${c.app.navigator.currentScreen?.name??"?"}\nuser:\n  id: ${r.inject.login.getUserId()}\n  email: ${r.inject.login.getUserEmail()}\n  auth_provider: ${r.inject.login.describeCurrentAuthProvider()}\n  timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}\n  total_playtime: ${(0,o.secondsToHours)(e.total.playTimeSeconds).toFixed(0)}h\n  latest_session_playtime: ${(0,o.secondsToMinutes)(e.latestSession.playTimeSeconds).toFixed(0)}m\n  local_storage_usage: ${(0,l.describeSize)(r.inject.storage.getSizeInBytes())}\ndevice:\n  user_agent: ${window.navigator.userAgent}\n  current_fps: ${c.app.game.loop.actualFps.toFixed()}\n  raw viewport: ${window.innerWidth}x${window.innerHeight} dpr=${window.devicePixelRatio||1}\n  scaled viewport: ${c.app.device.screenWidth}x${c.app.device.screenHeight} (dpr=${c.app.device.dpr} uiVariant=${c.app.device.uiVariant()})\n  os: ${c.app.device.os()})\n  touch: ${c.app.game.device.input.touch}`}},59674:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.saveGame=t.SAVE_GAME_LOCAL_STORAGE_PREFIX=void 0;const s=i(48500),n=i(82169),a=i(62960),o=i(88865),r=i(24592);t.SAVE_GAME_LOCAL_STORAGE_PREFIX=`konkr.savedGame.v${a.CORE_GAMESTATE_SCHEMA_VERSION}.`,t.saveGame=function(e,i){const a=(0,n.compressGameState)(i??o.inject.currentGameState);i||(a.replay=o.inject.gameStateController.history.export({snapshotPolicy:["p1-rewind-checkpoints"],sizeLimit:1e3,includeRewinds:!0})),o.inject.storage.setItem(t.SAVE_GAME_LOCAL_STORAGE_PREFIX+e,(0,r.encodeGameState)(a)),s.logger.for("saveGame").info(`Current games state saved into local storage as "${e}"`)}},35521:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SlackClient=void 0;const s=i(88865);t.SlackClient=class{constructor(e){this.webhookUrl=e}async sendMessage(e){await fetch(s.inject.config.reporting.slack.feedbackHook,{method:"POST",body:JSON.stringify(e)}).then((e=>{if(!e.ok)throw new Error(`Failed to send slack message - hook responded with status ${e.status}`)}))}}},33817:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SlackMessage=void 0,t.SlackMessage={codeBlock:(...e)=>`\`\`\`\n${e.join("\n")}\n\`\`\``,section:{text:(...e)=>({type:"section",text:{type:"mrkdwn",text:e.join("\n")}})}}},70448:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.THEMES=void 0,t.THEMES={default:{name:"Default",colors:[29184,14393427,5939244,14382416,8347466,6052185]},muted:{name:"Muted",colors:[3891771,11639421,6389837,12223857,7430488,5522773],forestsTexture:"iso-tiles/forest-gloomy"},grounded:{name:"Grounded",colors:[29184,5939244,9019436,8421376,7101779,5066061]},highContrast:{name:"High Contrast",colors:[13385760,28876,29184,14532608,12303291,13582480]}}},92065:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameStateDebugLayer=void 0;const s=i(52937),n=i(16972),a=i(88865),o=i(41959);t.GameStateDebugLayer=class{constructor(e){this.adapter=e,this.onChange=(0,s.signal)(),this.listener=(()=>this.onChange.fire()).bind(this)}getGroups(){return this.adapter.getGroups?.((0,o.getCurrentGameStateModel)().state)||[]}activate(){a.inject.gameStateModel.stateEngine.watchAll(this.listener)}deactivate(){a.inject.gameStateModel.stateEngine.stopWatching(this.listener)}getMap(){const e=(0,o.getCurrentGameStateModel)().state,t=new n.CustomHexGroupValuation(void 0);for(const i of this.adapter.getHexes(e))t.set(i.id,this.adapter.getValue(e,i.id));return t}getDetail(e){return this.adapter.getDetail((0,o.getCurrentGameStateModel)().state,e.id)}getArrows(){if(!this.adapter.getParents&&!this.adapter.getChildren)return[];let e=[];const t=(0,o.getCurrentGameStateModel)().state,i=this.adapter.getHexes(t);for(const s of i)this.adapter.getParents&&this.adapter.getParents(t,s.id)?.forEach((t=>{e.push([t,s.id])})),this.adapter.getChildren&&this.adapter.getChildren(t,s.id)?.forEach((t=>{e.push([s.id,t])}));return e}}},79738:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gettersFromDataSet=t.factionDataSetAdapter=t.regionDataSetAdapter=t.dataSetAdapter=void 0;const s=i(98030),n=i(78179),a=i(53191),o=i(7407),r=i(74064);function c(e,t){const i=t.getValue||(t=>e.entryToString(t)),n=t.getDetail||(t=>e.entryToDebugString(t));return{getValue(t,n){const a=(0,s.selectFromState)(t,e,n);return a&&i(a)},getDetail(t,i){const a=(0,s.selectFromState)(t,e,i);return a&&n(a)}}}t.dataSetAdapter=function(e,t={}){const i=t.arrowDataRetriever||((t,i)=>(0,s.selectFromState)(t,e,i));return{getHexes:t=>n.HexGroup.fromIds(e.getEntryIds(t)),getGroups:t.getGroups,...c(e,t),...(0,a.autoArrowsGenerator)(i)}},t.regionDataSetAdapter=function(e,t={}){return(0,o.regionBasedAdapter)(c(e,t))},t.factionDataSetAdapter=function(e,t={}){return(0,r.factionBasedAdapter)(c(e,t))},t.gettersFromDataSet=c},74064:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.factionBasedAdapter=void 0;const s=i(78179),n=i(50264),a=i(5032),o=i(14344);t.factionBasedAdapter=function(e){return{getHexes:e=>s.HexGroup.union(n.Regions.model(e).all().filter((e=>e.isAlive())).map((t=>s.HexGroup.fromIds(a.Economy.getTownHexesByRegion(e,t.id).toArray())))),getValue(t,i){const s=o.Factions.getByHex(t,i);if(void 0!==s)return e.getValue(t,s)},getDetail(t,i){const s=o.Factions.getByHex(t,i);if(void 0!==s)return e.getDetail(t,s)}}}},50921:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hexBasedAdapter=void 0;const s=i(78179),n=i(50264),a=i(53191);t.hexBasedAdapter=function(e){return{getHexes:e=>s.HexGroup.union(n.Regions.model(e).all().map((e=>e.hexes))),getValue:(t,i)=>e.getValue(t,i),getDetail:(t,i)=>e.getDetail(t,i),getGroups:e.getGroups,...(0,a.autoArrowsGenerator)(((t,i)=>e.getDetail(t,i)))}}},7407:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.regionBasedAdapter=void 0;const s=i(78179),n=i(50264),a=i(5032),o=i(55668);t.regionBasedAdapter=function(e){return{getHexes:e=>s.HexGroup.union(n.Regions.model(e).all().map((t=>s.HexGroup.fromIds(a.Economy.getTownHexesByRegion(e,t.id).concat(o.Bandits.getCampsByRegion(e,t.id)).toArray())))),getValue(t,i){const s=n.Regions.getByHex(t,i);if(void 0!==s)return e.getValue(t,s)},getDetail(t,i){const s=n.Regions.getByHex(t,i);if(void 0!==s)return e.getDetail(t,s)}}}},27932:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldDebugLayersManager=void 0;const s=i(96486),n=i(52937),a=i(16972),o=i(48500),r=i(88865);o.logger.for("DebugLayersManager");class c{constructor(){this.layers={blank:c.blankLayer},this.activeLayer=c.blankLayer,this.activeLayerName=void 0,this.onActiveLayerUpdated=(0,n.signal)()}register(e,t){this.layers[e]&&(this.layers[e].deactivate&&this.layers[e].deactivate(),this.layers[e].onChange.unsubscribeAll()),this.layers[e]=t,t.onChange((()=>this._layerChanged(t)))}registerAndActivate(e,t){this.register(e,t),this.activate(e)}_layerChanged(e){e===this.activeLayer&&this.onActiveLayerUpdated.fire(this.activeLayer)}get(e){return this.layers[e]}activate(e,t){if(this.activeLayer&&this.activeLayer.deactivate&&this.activeLayer.deactivate(),e){if(!this.layers[e]){if(!t)throw new Error(`No debug layer found for name ${e}`);this.register(e,t())}this.activeLayerName=e,this.activeLayer=this.layers[e],this.activeLayer.activate&&this.activeLayer.activate(),r.inject.debugData.set("debugLayer",e)}else this.activeLayer=c.blankLayer,this.activeLayerName=void 0,r.inject.debugData.clear("debugLayer");this.onActiveLayerUpdated.fire(this.activeLayer)}}t.WorldDebugLayersManager=c,c.blankLayer={onChange:(0,n.signal)(),activate:s.noop,deactivate:s.noop,getMap:()=>new a.CustomHexGroupValuation(void 0),getDetail:()=>{}}},53191:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.autoArrowsGenerator=void 0;const s=i(24794);function n(e){return"object"==typeof e?e.id:e}t.autoArrowsGenerator=function(e){return{getParents(t,i){const s=e(t,i);if("object"==typeof s)return s.parent?[n(s.parent)]:s.parents?s.parents.map(n):void 0},getChildren(t,i){const a=e(t,i);if("object"==typeof a)return a.child?[n(a.parent)]:a.children?a.children.map(n):a.rootId&&a.distance?(0,s.getHex)(i).neighbours((i=>{const s=e(t,i.id);return s&&s.rootId===a.rootId&&s.distance<a.distance})).toIdsArray():void 0}}}},15802:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createDiplomacyDebugLayer=void 0;const s=i(92065),n=i(40108),a=i(14344),o=i(30420),r=i(88865),c=i(41707),l=i(54444),d=i(23441),h=i(79516),u=i(1591),p=i(69905),g=i(40909),m=i(74064);t.createDiplomacyDebugLayer=function(){const e=new g.ObjectCache;let t;function i(i,s){return i!==t&&(e.flush(),t=i),a.Factions.model(i).all().filter((e=>e.controller!==o.FactionController.None&&e.id!==s&&e.isAlive())).map((t=>{const o=t.id,c=r.inject.views.fear.get(i,{fromFactionId:s,towardsFactionId:o}),l=a.Factions.model(i).byId(o).getLargestLiveRegion(),p=e.find(l.id)??(0,h.createAiContext)(l),g=a.Factions.model(i).byId(s).getLargestLiveRegion(),m=e.find(g.id)??(0,h.createAiContext)(g);return e.store(g.id,m),e.store(l.id,p),{id:o,theirHostilityTowardsMe:r.inject.views.hostility.calculate(i,{attackerContext:p,targetRegion:g}),myHostilityTowardsThem:r.inject.views.hostility.calculate(i,{attackerContext:m,targetRegion:l}),theirApprovalOfMe:n.AI.getFactionApproval(i,o,s),myApprovalOfThem:n.AI.getFactionApproval(i,s,o),theirAttitudeToMe:n.AI.getFactionAttitude(i,o,s),myAttitudeToThem:n.AI.getFactionAttitude(i,s,o),theirFearOfMe:r.inject.views.fear.get(i,{fromFactionId:s,towardsFactionId:o}),myFearOfThem:c,theirTotalAttrition:Object.values(n.AI.getFactionAttrition(i,o)).reduce(d.sum,0),theirAttritionInflictedByMe:n.AI.getFactionAttrition(i,o,s),myAttritionInflictedByThem:n.AI.getFactionAttrition(i,s,o),perceivedThreat:u.AIPolitics.getPerceivedThreat(l,g)}})).sort(((e,t)=>t.myApprovalOfThem-e.myApprovalOfThem))}return new s.GameStateDebugLayer((0,m.factionBasedAdapter)({getValue(e,t){const s=r.inject.views.powerBalance.get(e),n=i(e,t);t===s.dominantFaction?.id&&[].push(`${c.GLYPH.whiteFlag} ${s.dominance}${s.is1v1situation?" (1V1)":""}`);let a="-".repeat(8);for(let e of n){const t=Math.floor(10*e.myHostilityTowardsThem);a=a.slice(0,t)+c.GLYPH.factions[e.id]+a.slice(t)}return c.GLYPH.whiteFlag+a+c.GLYPH.redFlag},getDetail(e,t){const s=i(e,t),n=`${c.GLYPH.factions[0]} Appr Fear Hos Thr   ${c.GLYPH.sword}  ${c.GLYPH.defense}  Val`,a=r.inject.views.factionDiplomacyScore.getComponents(e,t);return n+"\n"+s.map((e=>{const t=(0,p.padLeft)((0,l.withSign)(e.myApprovalOfThem,0),4),i=(0,p.padLeft)((0,l.withSign)(e.myFearOfThem,0),4),s=(0,p.padLeft)((100*e.myHostilityTowardsThem).toFixed(0),3),n=(0,p.padLeft)((100*e.perceivedThreat).toFixed(0),3),o=(0,p.padLeft)(e.theirAttritionInflictedByMe.toFixed(),3),r=(0,p.padLeft)(e.myAttritionInflictedByThem.toFixed(),3),d=(0,p.padLeft)((a.find((t=>t.factionId===e.id))?.score??0).toFixed(),5);return`${c.GLYPH.factions[e.id]} ${t} ${i} ${s} ${n} ${o} ${r} ${d}`})).join("\n")}}))}},92516:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldNews=t.NewsEvents=void 0;const s=i(34758),n=i(91025),a=i(14344),o=i(50264),r=i(62977),c=i(30420),l=i(24794),d=i(6810),h=i(48500),u=i(33174),p=i(12678),g=i(88865),m=i(58592),y=i(20666);var f;!function(e){e.Rebellion="rebellion",e.TownRazed="town-razed",e.StrandedUnitTurnedBandit="stranded-unit-turned-bandit",e.UnpaidUnitTurnedBandit="unpaid-unit-turned-bandit",e.CastleTurnedBanditCamp="unit-turned-bandit-camp",e.UnitKilled="unit-killed",e.BanditCampSpawned="bandit-camp-spawned",e.HexLost="hex-lost",e.UnitInfected="unit-infected",e.OurTownInfected="our-town-infected",e.ForeignTownInfected="foreign-town-infected"}(f=t.NewsEvents||(t.NewsEvents={}));const w={[f.HexLost]:{symbol:d.PawnSymbolType.Warning,message:()=>"They took our land!"},[f.UnitKilled]:{symbol:d.PawnSymbolType.Warning,message:e=>`They killed our ${e??"unit"}!`},[f.TownRazed]:{symbol:d.PawnSymbolType.Alert,message:()=>"They razed our town!"},[f.BanditCampSpawned]:{symbol:d.PawnSymbolType.Warning,message:()=>"Bandits have built a camp here!"},[f.StrandedUnitTurnedBandit]:{symbol:d.PawnSymbolType.Warning,message:e=>`Our stranded ${e??"unit"} became a bandit!`},[f.UnpaidUnitTurnedBandit]:{symbol:d.PawnSymbolType.Warning,message:e=>`Our unpaid ${e??"unit"} became a bandit!`},[f.CastleTurnedBanditCamp]:{symbol:d.PawnSymbolType.Alert,message:()=>"Our abandoned castle turned into a bandit camp!"},[f.Rebellion]:{symbol:d.PawnSymbolType.Alert,message:()=>"Disaster! We did not have enough coins to pay our army!\nOur treacherous soldiers rebelled!"},[f.OurTownInfected]:{symbol:d.PawnSymbolType.Alert,message:()=>"Our town was overran by zombies!"},[f.ForeignTownInfected]:{symbol:d.PawnSymbolType.Warning,message:()=>"Town was overran by zombies!"},[f.UnitInfected]:{symbol:d.PawnSymbolType.Warning,message:e=>`Our ${e??"unit"} turned into a zombie!`}};function v(e,t,i){const s=g.inject.gameStateModel.warfare.getOccupyingUnit(e);s&&m.app.scene.worldMap.overlays.pawnSymbols.add(s.id,t,i)}h.logger.for("WorldNews"),t.WorldNews=class{constructor(){this.feed=(0,s.createTypedEventHandler)(),this.news=[],this.feed.on(n.GameStateEvents.CutOffUnitsTurnedBandits,(e=>{const t=r.Pawns.model(e.stateBefore);for(const i of e.worldUpdates.updates)i.type===u.UpdateType.PawnReplaced&&t.byId(i.oldPawnId)?.faction?.isLocalPlayer()&&(i.newType===c.PawnType.Bandit||i.newType===c.PawnType.Zombie?this.addNewsItem(i.hexId,f.StrandedUnitTurnedBandit,i.oldType):i.newType!==c.PawnType.Camp&&i.newType!==c.PawnType.HauntedTown||(i.oldType===c.PawnType.Castle?this.addNewsItem(i.hexId,f.CastleTurnedBanditCamp,i.oldType):this.addNewsItem(i.hexId,f.StrandedUnitTurnedBandit,i.oldType)))})),this.feed.on(n.GameStateEvents.FactionEconomyUpdated,(e=>{if(!a.Factions.model(e.stateAfter).byId(e.factionId)?.isLocalPlayer())return;const t=o.Regions.model(e.stateAfter);for(let i of e.regionReports){const e=t.byId(i.regionId);if(e&&(i.worldUpdates.updates.forEach((t=>{t.type===u.UpdateType.PawnsMoved&&t.pawns[0]?.created?.pawnType===c.PawnType.Camp?this.addNewsItem(t.destHex,f.BanditCampSpawned):t.type!==u.UpdateType.PawnReplaced||t.newType!==c.PawnType.Camp&&t.newType!==c.PawnType.HauntedTown||t.oldType!==c.PawnType.Castle||this.addNewsItem(t.hexId,f.CastleTurnedBanditCamp,t.oldType),t.type!==u.UpdateType.PawnReplaced||t.newType!==c.PawnType.Bandit&&t.newType!==c.PawnType.Zombie||(e.isAlive()?this.addNewsItem(t.hexId,f.UnpaidUnitTurnedBandit,t.oldType):this.addNewsItem(t.hexId,f.StrandedUnitTurnedBandit,t.oldType))})),i.sufferedRebellion))for(let t of e.getTownHexes().toArray())this.addNewsItem(t.id,f.Rebellion)}})),this.feed.on(n.GameStateEvents.HexCaptured,(e=>{if(!e.victimFactionId||!a.Factions.model(e.worldUpdates.stateAfter).byId(e.victimFactionId)?.isLocalPlayer()||!o.Regions.model(e.worldUpdates.stateBefore).byId(e.victimRegionId)?.isAlive())return;const t=e.worldUpdates.updates.find((e=>e.type===u.UpdateType.PawnsMoved)).hexCaptured;let i;p.assert.defined(t),e.defeatedUnit&&!e.defeatedUnit.retreatHex&&(i=r.Pawns.model(e.worldUpdates.stateBefore).byId(e.defeatedUnit.pawnId)),i?.type===c.PawnType.Town?this.addNewsItem(e.capturedHexId,f.TownRazed):i&&!i?.hasTrait(y.PawnTraits.Pest)?this.addNewsItem(e.capturedHexId,f.UnitKilled,i.type):this.addNewsItem(e.capturedHexId,f.HexLost)})),this.feed.on(n.GameStateEvents.BanditsActed,(e=>{g.inject.gameStateModel.plugins.zombies&&e.worldUpdates.updates.forEach((t=>{if(t.type===u.UpdateType.PawnsMoved){const i=a.Factions.model(e.worldUpdates.stateBefore).byHex((0,l.getHex)(t.destHex));if(t.merged?.outputType===c.PawnType.HauntedTown)i?.isLocalPlayer()?this.addNewsItem(t.destHex,f.OurTownInfected):this.addNewsItem(t.destHex,f.ForeignTownInfected);else if(t.merged?.outputType===c.PawnType.Zombie&&i?.isLocalPlayer()){const i=r.Pawns.model(e.worldUpdates.stateBefore).byId(t.merged.mergedWith);this.addNewsItem(t.destHex,f.UnitInfected,i?.type)}}}))}))}addNewsItem(e,t,i){this.news.push({hexId:e,type:t,context:i})}handle(e){this.feed.handle(e)}display(){for(let e of this.news){const{message:t,symbol:i}=w[e.type];v((0,l.getHex)(e.hexId),i,t(e.context))}}clear(){this.news=[]}}},48780:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SceneInjector=t.setupInjectionContainer=void 0;const s=i(9603),n=i(14711),a=i(69072),o=i(30781),r=i(86848),c=i(18327),l=i(21103),d=i(81363),h=i(27932),u=i(97060),p=i(28489),g=i(12678),m=i(68660),y=i(24917),f=i(97701),w=i(69965),v=i(11930),b=i(436),S=i(63488),x=i(66967),T=i(40009),P=i(29635),M=i(93632),I=i(92516),A=i(38952),C=i(24762),B=i(96525),E=i(68310),R=i(8265),O=i(15045),_=i(63313),H=i(88865),D=i(58592),k=i(26037),j=i(77821),L=i(65375),F=i(22766),U=i(70766),G=i(51453),N=i(45662),V=i(22847);function z(e){const t=H.inject.ui.transitionsSpeed();H.inject.ui.transitionsSpeed.set(j.TransitionsSpeed.Instant),e(),H.inject.ui.transitionsSpeed.set(t)}t.setupInjectionContainer=function(e,t,i,v={},$={}){if(!t)throw new Error('No configuration found for ENVIRONMENT="production", unable to setup injection container!');const Y=i,X=new c.TypedEventBus,q=new s.GameStateController,K=new m.DeviceInfo(e),J=function(e){return e.hasLocalStorage?new F.LocalStorage:new F.InMemoryStorage}(K),Q=function(e){return e.mapRegistryUrls?new R.SimpleMapRegistry(new _.RestMapRegistryDataSource(e.mapRegistryUrls)):new R.SimpleMapRegistry(new O.MockMapRegistryDataSource)}(t),Z={config:(0,L.deepWatchable)(t),ai:new u.AIController,events:X,random:(0,n.createRandomGenerator)(),storage:J,login:new U.LoginService(J),debugBreakpoint:p.debugBreakPointProvider,mapRegistry:Q,userData:new E.UserDataService(J),gameStateController:q,ui:{scale:(0,l.watchable)(1),withoutTransitions:z,spectatingSpeed:(0,l.watchable)(H.SpectatingPlaybackSpeed.Fast),transitionsSpeed:(0,l.watchable)(j.TransitionsSpeed.Fast),skipTransitions:()=>H.inject.ui.transitionsSpeed()===j.TransitionsSpeed.Instant,hexUnderCursor:(0,r.watchableHexUnderCursor)(),regionsLedger:new f.RegionsLedger,selectedCampaign:(0,l.watchable)(void 0),selectedLevelId:(0,l.watchable)(void 0),session:new V.LevelSession,playedLevelId:(0,l.watchable)(void 0),sidebarMode:(0,l.watchable)(void 0)}};(0,H.setCoreContext)(Z);const ee={...Z,ai:new u.AIController,get currentGameState(){return q.model.state},set currentGameState(e){q.currentState!==e&&(g.assert.defined(e,"attempt to set current game state to undefined value"),q.model.restore(e))},gameStateModel:q.model,views:new S.ViewsManager,history:new a.GameStateHistory,mapRegistry:Q,userData:new E.UserDataService(J),debugData:new o.DebugData,debugBreakpoint:p.debugBreakPointProvider,debugLayers:new h.WorldDebugLayersManager,scriptRunner:new C.LevelScriptRunner(new k.ScriptModulesRegistry),...v};(0,H.setCoreContext)(ee);const te={game:e,appController:Y,device:K,audio:new d.AudioManager(e),fonts:new y.Fonts,navigator:new b.Navigator(e),scene:new W(e),screen:(0,x.createScreens)(),modals:new w.ModalsManager(e),notifications:new M.NotificationsManager,tooltips:new A.TooltipsManager,worldNews:new I.WorldNews,gameplayStats:new P.GameplayStatsCollector,cloudSync:new G.CloudSyncService,analytics:new B.AnalyticsReporter(X),reporting:new T.Reporter(X,t),remoteConfig:new N.FirebaseRemoteConfig,...$};(0,D.setAppContext)(te)};class W{constructor(e){this.game=e}get worldMap(){return this.game.scene.getScene(v.Scenes.WorldMap)}get debug(){return this.game.scene.getScene(v.Scenes.Debug)}get debugHistory(){return this.game.scene.getScene(v.Scenes.DebugHistory)}get play(){return this.game.scene.getScene(v.Scenes.Play)}get playUI(){return this.game.scene.getScene(v.Scenes.PlayUI)}get titleScreenUI(){return this.game.scene.getScene(v.Scenes.TitleScreenUI)}get levelDetailUI(){return this.game.scene.getScene(v.Scenes.LevelDetailUI)}get mapEditor(){return this.game.scene.getScene(v.Scenes.MapEditor)}get menuHeaderUI(){return this.game.scene.getScene(v.Scenes.MenuHeaderUI)}get levelSelectUI(){return this.game.scene.getScene(v.Scenes.LevelSelectUI)}get victory(){return this.game.scene.getScene(v.Scenes.Victory)}get defeat(){return this.game.scene.getScene(v.Scenes.Defeat)}get globalUI(){return this.game.scene.getScene(v.Scenes.GlobalUI)}get randomMapSelect(){return this.game.scene.getScene(v.Scenes.RandomMapSelectUI)}}t.SceneInjector=W},68660:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceInfo=t.scaleDown=t.getLogicalDpr=t.DEFAULT_CONTENT_PADDING=t.MAX_CONTENT_WIDTH=t.MIN_HEIGHT_FOR_LARGE_UI=t.MIN_WIDTH_FOR_LARGE_UI=t.UiVariant=void 0;const s=i(21103),n=i(58592),a=i(88865),o=i(116);var r;function c(){let e=l(window.devicePixelRatio||1);for(;e*window.innerWidth>2560&&e*window.innerHeight>1e3;)e/=2;return e}function l(e){return e>=2?1:e}function d(e){return e.preventDefault(),!1}!function(e){e.Large="large",e.Compact="small"}(r=t.UiVariant||(t.UiVariant={})),t.MIN_WIDTH_FOR_LARGE_UI=740,t.MIN_HEIGHT_FOR_LARGE_UI=540,t.MAX_CONTENT_WIDTH=1200,t.DEFAULT_CONTENT_PADDING=30,t.getLogicalDpr=c,t.scaleDown=l,t.DeviceInfo=class{constructor(e){this.game=e,this.uiVariant=(0,s.watchable)(r.Large),this.dpr=c(),this.hasBrowserChrome=window.innerHeight!==window.screen.height,this.frameParent=(0,o.getFrameParent)(),this.supports={touch:e.device.input.touch};try{window.localStorage.getItem("test"),this.hasLocalStorage=!0}catch(e){this.hasLocalStorage=!1}e.scale.on("resize",(()=>setTimeout((()=>this.updateScreenSize()),100)),this)}get screenWidth(){return n.app.game.scale.width}get url(){return window.location!=window.parent.location?document.referrer:document.location.href}get screenHeight(){return n.app.game.scale.height}get contentLeft(){return this.screenWidth<=t.MAX_CONTENT_WIDTH?0:Math.trunc((this.screenWidth-t.MAX_CONTENT_WIDTH)/2)}get contentRight(){return this.screenWidth<=t.MAX_CONTENT_WIDTH?this.screenWidth:this.contentLeft+t.MAX_CONTENT_WIDTH}get contentWidth(){return Math.min(this.screenWidth,t.MAX_CONTENT_WIDTH)}isMobile(){return!this.game.device.os.desktop}isUsingTouch(){return n.app.game.input.activePointer.wasTouch}os(){return`${window.navigator.platform??"?"} (${Object.entries(n.app.game.device.os).filter((([e,t])=>!0===t)).map((([e,t])=>e)).join(", ")})`}updateScreenSize(){this.screenWidth>=t.MIN_WIDTH_FOR_LARGE_UI&&this.screenHeight>=t.MIN_HEIGHT_FOR_LARGE_UI?this.uiVariant.set(r.Large):this.uiVariant.set(r.Compact)}isFullScreenAvailable(){return a.inject.config.flags.fullScreenToggleButton&&n.app.device.hasBrowserChrome&&n.app.game.scale.fullscreen.available}disableContextMenu(){document.body.addEventListener("contextmenu",d)}enableContextMenu(){document.body.removeEventListener("contextmenu",d)}}},69965:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HtmlDocs=t.UI=t.ModalsManager=void 0;const s=i(11930),n=i(56952),a=i(87990),o=i(63055),r=i(52589),c=i(56320),l=i(31024),d=i(39835),h=i(35242),u=i(27526),p=i(78728),g=i(58592);t.ModalsManager=class{constructor(e){this.game=e}getModalWindowScene(){return this.game.scene.getScene(s.Scenes.ModalWindow)}show(e,t,i=(()=>{})){d.NewsBox.hide(),this.ensureSceneRunning(),this.getModalWindowScene().pushModal(e,{...t,onClose:i})}close(){this.getModalWindowScene().closeModal()}message(e){return this.simpleDialog({title:"Message",message:e,buttons:[{text:n.DialogButtons.OK,role:u.DialogButtonRole.PrimaryGreen}]})}textInput(e){return new Promise((i=>{this.show(t.UI.textInputDialog,{...e},i)}))}simpleDialog(e){return new Promise((i=>{this.show(t.UI.simpleDialog,e,i)}))}confirmEndTurn(){return this.defaultIfBypassed(n.DialogButtons.EndTurn)||this.simpleDialog({title:"End turn?",message:"Are you sure you want to end your turn already?",buttons:[{text:n.DialogButtons.Cancel,role:u.DialogButtonRole.Regular},{text:n.DialogButtons.EndTurn,role:u.DialogButtonRole.PrimaryDanger}]})}confirmRestart(){return this.defaultIfBypassed(n.DialogButtons.Restart)||this.simpleDialog({title:"Restart Island",message:"Are you sure? All progress will be lost!",buttons:[{text:n.DialogButtons.Cancel,role:u.DialogButtonRole.Regular},{text:n.DialogButtons.Restart,role:u.DialogButtonRole.PrimaryDanger}]})}confirmAbandonLevel(){return this.defaultIfBypassed(n.DialogButtons.GiveUp)||this.simpleDialog({title:"Revert Island",message:"Are you sure you want to give up your latest game on this island?",buttons:[{text:n.DialogButtons.Cancel,role:u.DialogButtonRole.Regular},{text:n.DialogButtons.GiveUp,role:u.DialogButtonRole.PrimaryDanger}]})}ensureSceneRunning(){this.game.scene.isActive(s.Scenes.ModalWindow)||this.game.scene.run(s.Scenes.ModalWindow)}defaultIfBypassed(e){if(g.app.scene.globalUI.keys.ctrl.isDown)return e}isModalActive(){return this.getModalWindowScene().isModalActive()}},t.UI={exportMap:new l.ModalDialogUIProvider(new a.ExportMapDialog),loadGame:new l.ModalDialogUIProvider(new o.ImportMapDialog),editMapJSONDialog:new l.ModalDialogUIProvider(new c.EditMapJSONDialog),htmlDialog:new l.ModalDialogUIProvider(new r.HtmlDialog),simpleDialog:new l.ModalDialogUIProvider(new h.SimpleDialog),textInputDialog:new l.ModalDialogUIProvider(new p.TextInputDialog)},t.HtmlDocs={howToPlay:{url:"/how-to-play",title:"How to play"},about:{url:"/about",title:"About Konkr.io"}}},52361:()=>{},94616:()=>{}},i={};function s(e){var n=i[e];if(void 0!==n)return n.exports;var a=i[e]={id:e,loaded:!1,exports:{}};return t[e].call(a.exports,a,a.exports,s),a.loaded=!0,a.exports}s.m=t,s.c=i,e=[],s.O=(t,i,n,a)=>{if(!i){var o=1/0;for(d=0;d<e.length;d++){for(var[i,n,a]=e[d],r=!0,c=0;c<i.length;c++)(!1&a||o>=a)&&Object.keys(s.O).every((e=>s.O[e](i[c])))?i.splice(c--,1):(r=!1,a<o&&(o=a));if(r){e.splice(d--,1);var l=n();void 0!==l&&(t=l)}}return t}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[i,n,a]},s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e={179:0};s.O.j=t=>0===e[t];var t=(t,i)=>{var n,a,[o,r,c]=i,l=0;if(o.some((t=>0!==e[t]))){for(n in r)s.o(r,n)&&(s.m[n]=r[n]);if(c)var d=c(s)}for(t&&t(i);l<o.length;l++)a=o[l],s.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return s.O(d)},i=self.webpackChunkkonkr=self.webpackChunkkonkr||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})(),s.O(void 0,[216],(()=>s(s.s=48762)));var n=s.O(void 0,[216],(()=>s(s.s=1041)));n=s.O(n)})();
//# sourceMappingURL=main.9446182491832f529827.bundle.js.map
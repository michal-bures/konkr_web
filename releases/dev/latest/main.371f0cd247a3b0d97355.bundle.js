(()=>{var e,t={78547:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScalingPOC=t.TestScene=void 0;const s=i(79294),n=i(71203),a=i(18995),o=i(36205),r=i(84612),c=i(9724),l=i(48565);class d extends c.BaseUIScene{constructor(){super({key:"testScene"}),this.preUpdate=(0,l.whenDirty)((()=>{this.contentAreaRectangle.setOrigin(0,0).setPosition(this.bounds.contentLeft,0).setSize(this.bounds.contentWidth,this.bounds.height);const e=this.cameras.main;n.inject.debugData.set("inject.device",`\n  screenWidth/Height=${n.inject.device.screenHeight}x${n.inject.device.screenWidth}\nBaseUiScene.bounds:\n  width/height=${this.bounds.width}x${this.bounds.height}\n  center=${this.bounds.centerX},${this.bounds.centerY}\n  contentArea=${this.bounds.contentLeft}-${this.bounds.contentRight} (width ${this.bounds.contentWidth})\nCamera:\n zoom=${e.zoom}\n x,y=${e.x},${e.y}\n size=${e.width}x${e.height}\n worldView=from ${e.worldView.x},${e.worldView.y} size ${e.worldView.width}x${e.worldView.height}\n`)}))}create(){super.create(),this.contentAreaRectangle=this.add.rectangle().setStrokeStyle(4,65280)}}t.TestScene=d,t.ScalingPOC=class{getScenes(){return[s.PreloadScene,d,o.DebugScene]}run(){n.inject.events.on(a.SystemEvents.EngineInitialized,(()=>{n.inject.game.scene.run(r.Scenes.Debug),n.inject.game.scene.run("testScene"),n.inject.debugData.set("---------------","")}))}}},92070:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.selectStrategy=t.AIController=t.MIN_WAR_SUPPORT_THRESHOLD=void 0;const s=i(71203),n=i(62199),a=i(37614),o=i(51392),r=i(43685),c=i(95077),l=i(46299),d=i(73508),h=i(29438),u=i(57153),g=n.logger.for("ai:controller");var p;function m(e){const i=e.parentModel.state,n=e.faction,a=l.Factions.model(i),m=[],y=a.all().filter((e=>e.controller!==d.FactionController.None&&e!==n)).filter((t=>c.AI.getFactionInfluenceByRegion(i,t.id,e.id).proximity<=3)),f=(0,r.getDominantFaction)(i);y.forEach((t=>{const a=c.AI.getRegionAttrition(i,e.id,t.id),o=-c.AI.getFactionApproval(i,n.id,t.id),r=s.inject.views.fear.getComponents(i,{fromFactionId:n.id,towardsFactionId:t.id}),l=f.faction===t?r.fear.fearOfFactionDomination:0;g.debug(`Eval against ${t.id}? \n fightBack ${a}, punish ${o}, stop ${l}\n fear ${r.fear.totalFear}, 1 from gangUpBonus`),a>0&&m.push({factionId:t.id,reason:p.FightBack,strength:Math.floor(1*a),desperation:r.fear.totalFear}),o>0&&m.push({factionId:t.id,reason:p.Punish,strength:Math.floor(1*o),desperation:r.fear.totalFear/2}),l>=20&&m.push({factionId:t.id,reason:p.StopFromWinning,strength:Math.floor(1*l),desperation:r.fear.totalFear/2})})),m.sort(((e,t)=>t.strength-e.strength));const w=Math.max(m.filter((e=>e.strength>=t.MIN_WAR_SUPPORT_THRESHOLD)).map((e=>e.desperation)).reduce(((e,t)=>Math.max(e,t)),0)),b=m[0]?.strength||0,v=new Map;return y.forEach((e=>{const t=Math.min(100,Math.max(0,-c.AI.getFactionApproval(i,n.id,e.id))),s=m.filter((t=>t.factionId===e.id)).reduce(((e,t)=>Math.max(e,t.strength)),t);v.set(e.id,s)})),g.debug(`War goals:\n${m.map((e=>`(${e.strength}) ${e.reason} F${e.factionId} with desperation ${e.desperation}`)).join("\n")}\nWar support:\n${Array.from(v.entries()).map((([e,t])=>`${t} against F${e}`)).join("\n")}\nOverall despair ${w}\n`),b<t.MIN_WAR_SUPPORT_THRESHOLD?o.growthStrategy:w<25?(0,h.warStrategy)({warSupportByFaction:v}):(0,u.assaultStrategy)({warSupportByFaction:v})}t.MIN_WAR_SUPPORT_THRESHOLD=15,t.AIController=class{constructor(){this.dataLayer=new r.DefaultAIDataLayer,this.debug=!1}async play(e){this.gameController=s.inject.gameStateController,this.gameController.beginTransaction(),this.debug=!0===s.inject.config.debug.ai;const t=e.getRegions().filter((e=>e.isAlive())).sort(((e,t)=>e.hexes.length-t.hexes.length));for(let i of t){const t=m(i);if(i.updateFrom(s.inject.gameStateController.currentState),!i.exists)continue;s.inject.debugData.set("AI",`faction ${e.id}, region ${i.id}`);const n=new a.RegionAIContext(i);n.debug=!0===s.inject.config.debug.ai||s.inject.config.debug.ai===i.id,await t(n)}const i=this.gameController.scheduledEvents.length;return this.gameController.commitTransaction(),i}},function(e){e.FightBack="fight back against",e.Punish="punish",e.StopFromWinning="stop"}(p||(p={})),t.selectStrategy=m},43685:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateAttritionImpact=t.getDominantFaction=t.DefaultAIDataLayer=t.DummyAIDataLayer=void 0;const s=i(73508),n=i(52163),a=i(1951),o=i(95077),r=i(71203),c=i(92940),l=i(62199),d=i(85044),h=i(98697),u=i(46299);function g(e){const t=(0,d.selectFromState)(e,h.GameState.ai.powerByFaction).valueSeq().reduce(a.sum,0),i=u.Factions.model(e).all().filter((e=>e.controller!==s.FactionController.None)).reduce(((e,t)=>e.power<t.power?t:e));return{faction:i,dominance:i.power/t}}function p({model:e,destroyedPawns:t,victimRegions:i,regionWasAlive:s}){if(s){const s=i.filter((e=>!e.isAlive())),n=i.filter((e=>e.isAlive())),o=t.map(y).reduce(a.sum,0),r=1+s.map((e=>e.size)).reduce(a.sum,0),c=s.map((t=>e.warfare.getUnitsByRegion(t).map(m).reduce(a.sum,0))).reduce(a.sum,0),l=function(e){e.sort(((e,t)=>e.size-t.size));return e.slice(1).map((e=>e.budget.incomeFromHexes)).reduce(a.sum,0)/10+e.filter((e=>e.budget.balance<0)).map((e=>-1*e.budget.balance)).reduce(a.sum,0)}(n);return Math.floor(10*(r+o+c+l))}return Math.ceil(i.map((e=>e.size)).reduce(a.sum)/5)}function m(e){return y(e.type)}function y(e){const t=r.inject.gameStateModel.rules.pawns(e);return t.hasTrait(c.PawnTraits.Unit)?t.upkeep:t.type===s.PawnType.Town?10:0}function f(e,t){return Math.ceil(e/Math.min(10,Math.max(1,t))*10)}l.logger.for("ai:DataLayer"),t.DummyAIDataLayer=class{onHexConquered(e){}onTurnEnd(e,t){}onTurnStart(e,t){}},t.DefaultAIDataLayer=class{onHexConquered({model:e,attackerFaction:t,destroyedPawns:i,victimRegions:a,regionWasAlive:r}){(0,n.assert)(a.length>0,"victimRegions should never be empty");const c=a[0].faction,l=a.filter((e=>e.isAlive())),d=p({model:e,attackerFaction:t,destroyedPawns:i,victimRegions:a,regionWasAlive:r}),h=f(d,c.power);l.length>0&&o.AI.inflictRegionAttrition(e.stateEngine.currentState,l.map((e=>e.id)),t.id,d),o.AI.changeFactionApproval(e.state,c.id,t.id,(e=>function(e,t,i){let s=t;return t>0&&i>=10&&(s=Math.floor(t/(i/10+1))),s-=i,s}(0,e,h)));const u=o.AI.getFactionApproval(e.state,t.id,c.id);if(u>0){const i=Math.max(0,u-h/2);o.AI.changeFactionApproval(e.state,t.id,c.id,(()=>i))}if(d>=10){const i=e.factions.all().filter((t=>t.controller!==s.FactionController.None&&t!==c&&o.AI.getFactionApproval(e.state,t.id,c.id)>=100)),n=e.factions.all().filter((t=>t.controller!==s.FactionController.None&&o.AI.getFactionApproval(e.state,t.id,c.id)<=-100));for(const s of i){const i=Math.floor(f(d,Math.max(s.power,c.power))/3);o.AI.changeFactionApproval(e.state,s.id,t.id,(e=>e-i))}for(const i of n){const s=Math.floor(f(d,Math.max(i.power,c.power))/3);o.AI.changeFactionApproval(e.state,i.id,t.id,(e=>e+s))}}}onTurnEnd(e,t){t.controller!==s.FactionController.None&&(function(e,t){o.AI.changeFactionAttrition(e.state,e.currentPhase.faction.id,(e=>Math.floor(.5*e)))}(e),function(e,t){const i=g(e.state),n=i.dominance>.25?2*(i.dominance-.25):0;e.factions.all().filter((e=>e.controller!==s.FactionController.None&&e!==t)).forEach((s=>{o.AI.changeFactionApproval(e.state,s.id,t.id,(a=>{let r=a;const c=-o.AI.getFactionFear(e.state,s.id,t.id),l=a>c&&t===i.faction||a<c&&![t,i].includes(i.faction)?n+.1:.1;r+=Math.floor((c-a)*l);for(const i of s.getRegions().filter((e=>e.isAlive()))){const s=o.AI.getFactionInfluenceByRegion(e.state,t.id,i.id);if(s.proximity>1)continue;const n=s.total;if(0===o.AI.getRegionAttrition(e.state,i.id,t.id)&&n>0){const e=Math.floor(Math.sqrt(n)/3);r+=Math.min(e,10)}}return r}))}))}(e,t))}onTurnStart(e,t){}},t.getDominantFaction=g,t.calculateAttritionImpact=p},17172:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createExposedHexesDebugLayer=t.ExposedHexes=void 0;const s=i(89403),n=i(14090),a=i(71203),o=i(98697),r=i(19764),c=i(95077),l=i(1157),d=i(9332),h=i(73508);function u(e,t){let i=(0,n.signal)();const s=a.inject.gameStateModel;return s.stateEngine.watchDataSet(o.GameState.ai.regionInfluenceByHex,(()=>{i.fire()})),s.stateEngine.watchDataSet(o.GameState.ai.hexImportance,(()=>{i.fire()})),{name:"ai.exposedHexes",onChange:i,getMap(){let i=new r.CustomHexGroupValuation("");const n=e.get(t);return e.region.hexes.forEach((a=>{n.has(a)?i.set(a.id,l.GLYPH.redFlag+s.ai.getHexImportance(a)):e.isImportantEnough(a,t)?i.set(a.id,l.GLYPH.defense):i.set(a.id,s.ai.getHexImportance(a).toString())})),i},getDetail(i){const n=e.threatAssessment.get(i.id).strongestUnit,a=s.warfare.getHexDefense(i),o=e.threatAssessment.get(i.id).riskByMight[a]||0;return`importance: ${s.ai.getHexImportance(i)} / ${t} ${e.isImportantEnough(i,t)?l.GLYPH.redFlag:""}\nthreat ${n} / ${s.warfare.getHexDefense(i)} ${e.isThreatened(i)?l.GLYPH.redFlag:""}\ncredibility ${Math.round(100*o)}% for might ${a+1}`}}}t.ExposedHexes=class{constructor(e,t){this.region=e,this.threatAssessment=t}get(e){return this.threatenedHexes||(this.threatenedHexes=this.region.hexes.filter((e=>this.isThreatened(e)))),this.threatenedHexes.filter((t=>this.isImportantEnough(t,e)))}isImportantEnough(e,t){return(c.AI.getHexImportance(this.region.state,e.id)?.value||0)>=t}isThreatened(e){const t=this.threatAssessment.get(e.id),i=s.Warfare.getHexDefense(this.region.parentModel.state,e),n=d.Pawns.model(this.region.parentModel.state).presentAtHex(e,h.PawnType.Town);return t.strongestUnit>i&&(n||t.riskByMight[i]>=.25)}getDebugLayer(e=0){return u(this,e)}invalidateCache(){this.threatenedHexes=void 0}},t.createExposedHexesDebugLayer=u},79530:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getCostPerUnitOfMight=t.Marshal=t.RosterUnitRecipeType=void 0;const s=i(92940),n=i(18995),a=i(62199),o=i(73508),r=i(52163),c=a.logger.for("ai:Marshal");var l;(l=t.RosterUnitRecipeType||(t.RosterUnitRecipeType={})).PickExisting="pick-existing",l.CombineUnits="combine-units",l.Buy="buy",t.Marshal=class{constructor(e){this.ctx=e,this.model=this.ctx.game.model}moveUnit(e,t){const i=[...t.useUnits],s=[...t.buyUnits];if(0===i.length){(0,r.assert)(1===s.length,`Unexpected plan - given there are no existing units to use, expected one unit to buy, instead got [${s}]`);const t=this.model.rules.unitByMight(s[0]).type;return!!this.freeUpHexIfFriendly(e)&&(this.ctx.addPlay(n.Plays.BuyPawn({pawnType:t,buyerRegionId:this.ctx.region.id,destinationHexId:e.id}),e),!0)}const a=i.shift();let o=this.getClosestMovableUnitByMight(e,a);for(r.assert.defined(o,`Marshal was unable to find unit with might ${a}`);i.length>0||s.length>0;){const e=o.hex;if(i[0]===o.might){const t=this.getClosestMovableUnitByMight(o.hex,i.shift(),[o]);r.assert.defined(t,`Failed to find a unit with might ${a} to merge into ${o}`),this.ctx.addPlay(n.Plays.MovePawn({pawnId:t.id,destinationHexId:e.id}))}else{if(s[0]!==o.might)return c.error(`Marshal failed to execute plan, unclear what to do next: current unit ${o}, unitsToUse [${i}], unitsToBuy [${s}]`),!1;{const t=this.model.rules.unitByMight(s.shift()).type;this.ctx.addPlay(n.Plays.BuyPawn({pawnType:t,buyerRegionId:this.ctx.region.id,destinationHexId:e.id}))}}o=this.model.warfare.getOccupyingUnit(e),r.assert.defined(o,`lost track of the current unit after move to ${e}`)}return!(e!==o.hex&&!this.freeUpHexIfFriendly(e)||(this.ctx.addPlay(n.Plays.MovePawn({pawnId:o.id,destinationHexId:e.id}),e),0))}getClosestMovableUnitByMight(e,t,i=[]){return this.model.pawns.findClosest(e,this.ctx.region.hexes,(e=>!i.includes(e)&&this.model.currentPhase.isMovable(e)&&e.might===t))}freeUpHexIfFriendly(e){if(this.model.regions.byHex(e)!==this.ctx.region)return!0;const t=this.model.pawns.findOne({hexes:e,traits:[s.PawnTraits.Unit]});if(t){const i=this.ctx.region.hexes.findClosest(e,(e=>!this.model.warfare.isOccupied(e)));return i?(this.ctx.addPlay(n.Plays.MovePawn({pawnId:t.id,destinationHexId:i.id})),!0):(c.warning(`Unable to free up space for defender on hex ${e} - there's nowhere to move obstructing unit ${t}`),!1)}return!0}buildCastle(e,t){const i=this.model.rules.castleByMight(t).type;return this.ctx.addPlay(n.Plays.BuyPawn({pawnType:i,buyerRegionId:this.ctx.region.id,destinationHexId:e.id})),!0}},t.getCostPerUnitOfMight=function(e){return e.rules.pawns(o.PawnType.Villager).cost}},37614:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RegionAIContext=void 0;const n=i(79530),a=s(i(35369)),o=i(67732),r=i(71203),c=i(62199),l=i(38070),d=i(76339),h=i(98260),u=i(4877);c.logger.for("ai:context"),a.default.Map([[1,1],[2,1],[3,1],[4,1]]),t.RegionAIContext=class{constructor(e){this.region=e,this.game=r.inject.gameStateController,this.currentScore=0,this.debug=!1,this.plays=[],this.marshal=new n.Marshal(this),this.advisors={political:u.NEUTRAL_POLITICAL_ADVISOR,armyComposition:l.UNRESTRICTED_ARMY_COMPOSITION,economic:d.UNRESTRICTED_ECONOMIC_ADVISOR},this.focus={growth:1,defense:1,offense:1}}get faction(){return this.region.faction}get state(){return this.game.currentState}setAdvisors(e){this.advisors=e,this.unitSolver=new o.UnitSolver(e)}async breakpoint(e,t=(()=>({}))){this.debug&&await r.inject.debugBreakpoint(e,(()=>({...t(),region:this.region})))}addPlay(e,t){if(this.plays.push({play:e,gameCheckpoint:this.game.createCheckpoint()}),this.game.executePlay(e),t){const e=this.game.model.warfare.getOccupyingUnit(t);e&&this.game.model.currentPhase.tapPawn(e)}this.updateAfterStateChange()}requestUnit(e){let t,i=0;return e.forEach(((e,s)=>{const n=this.unitSolver.gather({...(0,h.getMyRegionAssets)(this.region),requiredMight:s,allowOverkill:!1});if(!n)return;const a=e*(n.attractiveness+1);a>i&&(i=a,t=n)})),t}updateAfterStateChange(){this.region.updateFrom(this.game.currentState)}}},68517:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createAiViews=t.SituationExplorer=void 0;const s=i(71203),n=i(62199),a=i(73508),o=i(17172),r=i(95077),c=i(1951),l=i(16912),d=i(66798),h=i(89403),u=i(9332);function g(e){const t=new l.ThreatAssessment(e.faction,e.advisors);return{threatAssessment:t,exposedHexes:new o.ExposedHexes(e.region,t),tacticalPotential:null}}n.logger.for("ai:SituationExplorer"),t.SituationExplorer=class{constructor(e){this.context=e,this.situationStack=[];const t=g(e);this.situationStack=[{label:"start",...e.game.createCheckpoint(),score:-1e3,views:t}],this.bestOutcomeSoFar=this.situationStack[0]}async tryBest(e){let t=!1;const i=new d.CompositePlanner({allowedTactics:e}),s=i.generatePlans(this.context,this.currentSituation.views);let n;do{if(n=s.next().value,!n)return!1;await this.context.breakpoint(`ai:next-plan: ${n}`,(()=>({debugLayer:i.getDebugLayer(),hexes:n.hex}))),t=n.execute(this.context)}while(!t);return this.addSituation(n.constructor.name),await this.context.breakpoint(`ai:plan-completed score ${this.currentSituation.score}`,(()=>({debugLayer:this.currentSituation.views.exposedHexes.getDebugLayer(50),hexes:n.hex}))),!0}get currentSituation(){return this.situationStack[this.situationStack.length-1]}backtrack(e=1){const t=this.situationStack[0].score,i=this.situationStack[this.situationStack.length-1].score;if(i<=t)this.goTo(this.situationStack[0]);else{const s=i-(i-t)/e,n=this.situationStack.find((e=>e.score>=s));this.situationStack.splice(this.situationStack.indexOf(n)+1),this.context.game.restoreCheckpoint(n)}}goToBestOutcomeSoFar(){this.goTo(this.bestOutcomeSoFar)}goTo(e){this.context.game.restoreCheckpoint(e),this.updateDebugData();const t=this.situationStack.indexOf(e);-1!==t?this.situationStack=[e]:this.situationStack.splice(t+1)}addSituation(e){const t=g(this.context),i=this.appraiseCurrentSituation(t),s={...this.context.game.createCheckpoint(),score:i,label:e,views:t};this.situationStack.push(s),this.updateDebugData()}considerCurrentSituation(){this.currentSituation.score>this.bestOutcomeSoFar.score&&(this.bestOutcomeSoFar=this.currentSituation)}updateDebugData(){s.inject.debugData.set("SituationExplorer","\n"+this.situationStack.map((e=>` - ${e.label}(${this.getRelativeScore(e.score)})`)).join("\n")+`\nWinner: ${this.bestOutcomeSoFar.label}(${this.getRelativeScore(this.bestOutcomeSoFar.score)})`)}getRelativeScore(e){return e-this.situationStack[0].score}appraiseCurrentSituation(e){const t=this.getEnemyPowerScore(),i=this.getMyPowerScore(),s=this.getSafetyPenalty(e);return Math.floor(i-t-s)}getEnemyPowerScore(){return this.context.game.model.factions.all().filter((e=>e.controller!==a.FactionController.None&&e!==this.context.faction&&this.context.advisors.political.getHostilityTowardsFaction(e)>1)).map((e=>({factionId:e.id,score:e.power}))).map((e=>e.score)).reduce(c.sum,0)}getMyPowerScore(){return 3*this.context.faction.power}getSafetyPenalty(e){return e.exposedHexes.get(50).map((t=>{const i=r.AI.getHexImportance(this.context.game.currentState,t.id)?.value||0,s=h.Warfare.getHexDefense(this.context.state,t);let n=e.threatAssessment.get(t.id).riskByMight[s]||0;return u.Pawns.model(this.context.state).presentAtHex(t,a.PawnType.Town)&&(n*=2),i*n})).reduce(c.max,0)}isSafe(){return 0===this.getSafetyPenalty(this.currentSituation.views)}},t.createAiViews=g},16912:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.estimateStrongestUnitAtRange=t.ThreatAssessmentDebugLayer=t.ThreatAssessment=void 0;const s=i(95077),n=i(46299),a=i(67732),o=i(71203),r=i(23803),c=i(89403),l=i(52754),d=i(38997),h=i(38070),u=i(76339),g=i(16115),p=i(76038),m=i(1951);i(62199).logger.for("ai:ThreatAssessment");class y extends d.CalculatedHexGroupValuationWithCache{constructor(e,t){super(),this.faction=e,this.advisors=t,this.unitSolver=new a.UnitSolver({economic:u.UNRESTRICTED_ECONOMIC_ADVISOR,armyComposition:h.UNRESTRICTED_ARMY_COMPOSITION})}calculate(e){const t=this.getComponents(e),i=[0,0,0,0];for(const e of t)e.riskByMight.forEach(((e,t)=>{i[t]=p.Probability.ofEither(i[t],e)}));return{riskByMight:i,strongestUnit:t.map((e=>e.riskByMight.length)).reduce(m.max,0)}}getComponents(e){return function(e,t,i){const a=e.parentModel.state;return s.AI.getHexInfluence(a,t).filter(((t,i)=>n.Factions.getByRegion(a,i)!==e.id)).map(((e,s)=>{const n=g.Regions.model(a).byId(s);if(!n)return{regionId:s,riskByMight:[]};const o=n.power.totalMight,l=c.Warfare.getHexDefense(a,(0,r.getHex)(t)),d=w({totalMight:o,maxUnitMight:n.power.maxObtainableUnitMight,maxUnitCount:n.power.maxObtainableUnitCount,resistance:e.resistance-l-1,distance:e.distance});return d<=l?{regionId:s,riskByMight:[]}:{regionId:s,riskByMight:[1,2,3,4].filter((e=>e<=d)).map((t=>{const s=t>n.power.maxSustainableUnitMight?.1:1;return i.political.getPerceivedThreat(n)*s/e.resistance})).filter((e=>e>0))}})).valueSeq().toArray().filter((({regionId:e,riskByMight:t})=>t.length>0))}(this.faction,e,this.advisors)}getDebugLayer(){return new f(this)}}t.ThreatAssessment=y;class f extends l.GameStateDebugLayer{constructor(e){super({getValue(t,i){const s=e.get(i);if(s&&0!==s.strongestUnit)return`${s.strongestUnit}\n${Math.round(100*s.riskByMight[s.strongestUnit-1])}%`},getDetail:(t,i)=>o.inject.gameStateModel.factions.byHex((0,r.getHex)(i))!==e.faction?"":e.getComponents(i).map((e=>e.riskByMight.map(((t,i)=>`  ${i+1} (${(100*t).toFixed(0)}%) from ${e.regionId}`)).join("\n"))).join("\n"),getHexes:t=>e.faction.hexes}),this.assessment=e}}function w(e){const t=e.maxUnitCount-(e.distance-1),i=e.totalMight-e.resistance;return t<=0?0:1===t?i:Math.min(i,e.maxUnitMight)}t.ThreatAssessmentDebugLayer=f,t.estimateStrongestUnitAtRange=w},38070:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BalancedGrowthArmyComposition=t.UNRESTRICTED_ARMY_COMPOSITION=void 0;const s=i(71203);i(62199).logger.for("ai:ArmyComposition"),t.UNRESTRICTED_ARMY_COMPOSITION={getWillingnessToDiscardUnit:()=>1,getWillingnessToObtainUnit:()=>1},t.BalancedGrowthArmyComposition=class{constructor(e,t=1){this.region=e,this.strictness=t}getWillingnessToDiscardUnit(e,t){return 1-this.getUnitCountPressure(e.totalUnits,t,-1)*this.strictness}getWillingnessToObtainUnit(e,t){return 1+this.getUnitCountPressure(e.totalUnits,t,1)*this.strictness}getWillingnessToSpend(e,t){return 0}getUnitCountPressure(e,t,i){const n=this.region.size,a=s.inject.gameStateModel.rules.unitByMight(t).upkeep,o=Math.floor(n/(t+2)),r=.75*n-o,c=e.countOf(t);if(1===t&&0===c)return 1;let l=(o-a*(c+i))/r;return l>1?l=1:l<-1&&(l=-1),l}}},76339:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BALANCED_ECONOMIC_STRATEGY=t.BalancedEconomicAdvisor=t.GrowthEconomicAdvisor=t.UNRESTRICTED_ECONOMIC_ADVISOR=void 0,t.UNRESTRICTED_ECONOMIC_ADVISOR={getWillingnessToSpend:(e,t,i)=>e.remainingGold>=t?1-t/1e3:0,getMinimalAcceptableIncome:e=>-1/0},t.GrowthEconomicAdvisor=class{constructor(e){this.region=e}getWillingnessToSpend(e,t,i){const s=e.willSacrifice?i:0,n=e.remainingIncome+1,a=e.remainingIncome-s,o=this.getIncomeTarget();let r=1;return s>0&&a<o&&(r=1/(o-a)),e.remainingGold<t||n-s<0?0:1-t/1e3*r}getMinimalAcceptableIncome(e){return this.region.size<3?-1:Math.ceil(this.getIncomeTarget()/2)}getIncomeTarget(){return this.region.size<3?0:Math.max(1,this.region.size/3)}};class i{getWillingnessToSpend(e,t,i){const s=e.willSacrifice?i:0,n=e.remainingIncome+1;return e.remainingGold<t||n-s<0?0:1-t/1e3}getMinimalAcceptableIncome(e){return-1}}t.BalancedEconomicAdvisor=i,t.BALANCED_ECONOMIC_STRATEGY=new i},4877:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ApprovalBasedPoliticalAdvisor=t.NEUTRAL_POLITICAL_ADVISOR=t.AGRESSIVE_POLITICAL_ADVISOR=void 0;const s=i(46299),n=i(95077),a=i(76038);t.AGRESSIVE_POLITICAL_ADVISOR={getWillingnessToAttack:e=>2,getPerceivedThreat:e=>0,getHostilityTowardsFaction:e=>2},t.NEUTRAL_POLITICAL_ADVISOR={getWillingnessToAttack:e=>1,getPerceivedThreat:e=>1,getHostilityTowardsFaction:e=>1},t.ApprovalBasedPoliticalAdvisor=class{constructor(e){this.faction=e}getWillingnessToAttack(e){const t=e.parentModel.state,i=s.Factions.model(t).byRegion(e);return i?e.isAlive()?1-this.getApprovalModifier(t,this.faction.id,i.id):1:0}getPerceivedThreat(e){const t=e.parentModel.state,i=s.Factions.model(t).byRegion(e);return i&&e.isAlive()?1-this.getApprovalModifier(t,i.id,this.faction.id):0}getHostilityTowardsFaction(e){return 1-this.getApprovalModifier(e.parentModel.state,this.faction.id,e.id)}getApprovalModifier(e,t,i){return(0,a.cropNumber)(n.AI.getFactionApproval(e,t,i)/100,-2,.5)}}},98260:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getEnemyRegionAssets=t.getMyRegionAssets=void 0,t.getMyRegionAssets=function(e){return{remainingIncome:e.budget?.balance||0,remainingGold:e.treasury,remainingUnits:e.getMovableUnitsByMight(),totalUnits:e.getUnitsByMight()}},t.getEnemyRegionAssets=function(e){const t=e.treasury-(e.budget?.upkeep||0);return{remainingIncome:e.budget?.balance||0,remainingGold:Math.max(t,0),remainingUnits:e.getUnitsByMight(),totalUnits:e.getUnitsByMight()}}},54053:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.UnitsByMight=t.MAX_UNIT_MIGHT=void 0;const n=s(i(35369)),a=i(52163),o=i(1951);t.MAX_UNIT_MIGHT=4;const r=n.default.Map();class c{constructor(e=r){this.data=e}getOneWithMightAtLeast(e){for(let i=e;i<=t.MAX_UNIT_MIGHT;++i)if(this.data.get(i))return i}has(e){return!!this.data.get(e)}withoutUnit(e){const t=this.data.get(e,0);return(0,a.assert)(t>0,`cannot take unit with might ${e} from ${this.toString()}`),new c(t-1>0?this.data.update(e,(e=>e-1)):this.data.delete(e))}hasUnitsWeakerThan(e){for(let t=1;t<e;++t)if(this.data.get(t))return!0;return!1}getTotalMight(){return this.data.map(((e,t)=>t*e)).reduce(o.sum,0)}static fromUnitList(e){return new c(n.default.Map().withMutations((t=>{e.forEach((e=>t.set(e,t.get(e,0)+1)))})))}toString(){let e="[";for(let t=1;t<4;++t)e+=t.toString().repeat(this.data.get(t,0));return e+="]",e}add(e,t=1){return new c(this.data.set(e,this.data.get(e,0)+t))}getStrongest(){for(let e=4;e>0;--e)if(this.data.get(e))return e;return 0}getAvailableMightLevels(){return Array.from(this.data.keys())}map(e){return this.data.map(e)}count(){return this.data.valueSeq().reduce(o.sum,0)}countOf(e){return this.data.get(e,0)}without(...e){return new c(this.data.withMutations((t=>{e.forEach((i=>{const s=t.get(i,0);if(s<1)throw new Error(`cannot take units ${e} from ${this.toString()}`);1===s?t.remove(i):t.set(i,s-1)}))})))}with(...e){return new c(this.data.withMutations((t=>{e.forEach((e=>{const i=t.get(e,0);t.set(e,i+1)}))})))}}t.UnitsByMight=c,c.empty=new c},57153:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.assaultStrategy=void 0;const s=i(76339),n=i(38070),a=i(68517),o=i(59402),r=i(29438),c=i(92070),l=i(1951);t.assaultStrategy=({warSupportByFaction:e})=>async t=>{const i=t.game.currentState;t.setAdvisors({political:new r.WartimePoliticalStrategy(i,t.region,e),economic:s.UNRESTRICTED_ECONOMIC_ADVISOR,armyComposition:n.UNRESTRICTED_ARMY_COMPOSITION});const d=Array.from(e.values()).reduce(l.max,2*c.MIN_WAR_SUPPORT_THRESHOLD),h=Array.from(e.entries()).filter((([e,t])=>t>=.75*d)).map((([e,t])=>`${e}(${t})`)).join(", ");await t.breakpoint(`ai:strategy: ASSAULT against ${h}`);const u=[o.Planners.Default],g=new a.SituationExplorer(t);for(t.focus={offense:1,defense:0,growth:.1};await g.tryBest(u););for(t.focus={offense:2,defense:1,growth:.5};await g.tryBest(u););}},51392:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.growthStrategy=void 0;const s=i(62199),n=i(68517),a=i(59402),o=i(38070),r=i(4877),c=i(76339);s.logger.for("ai:strategy"),t.growthStrategy=async e=>{const t=new n.SituationExplorer(e);for(e.setAdvisors({political:new r.ApprovalBasedPoliticalAdvisor(e.faction),armyComposition:new o.BalancedGrowthArmyComposition(e.region),economic:new c.GrowthEconomicAdvisor(e.region)}),await e.breakpoint("ai:strategy: GROWTH"),e.focus={offense:.5,defense:0,growth:1};await t.tryBest([a.Planners.Default]););if(!t.isSafe()){for(t.considerCurrentSituation(),t.backtrack(.5),e.focus={offense:.5,defense:2,growth:1};await t.tryBest([a.Planners.Default]););if(t.isSafe())return t.considerCurrentSituation(),void t.goToBestOutcomeSoFar();for(t.backtrack(1);await t.tryBest([a.Planners.Default]););t.considerCurrentSituation(),t.goToBestOutcomeSoFar()}}},29438:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WartimeEconomicAdvisor=t.AssaultPoliticalStrategy=t.WartimePoliticalStrategy=t.warStrategy=t.Tactic=void 0;const s=i(73508),n=i(95077),a=i(1951),o=i(38070),r=i(68517),c=i(59402),l=i(92070);var d;(d=t.Tactic||(t.Tactic={})).Expedition="expedition",d.Defend="defend",d.Expand="expand",d.HoardGold="hoardGold",t.warStrategy=({warSupportByFaction:e})=>async t=>{const i=t.game.currentState;t.setAdvisors({political:new h(i,t.region,e),economic:new u,armyComposition:new o.BalancedGrowthArmyComposition(t.region,.5)});const s=Array.from(e.values()).reduce(a.max,2*l.MIN_WAR_SUPPORT_THRESHOLD),n=Array.from(e.entries()).filter((([e,t])=>t>=.75*s)).map((([e,t])=>`${e}(${t})`)).join(", ");await t.breakpoint(`ai:strategy: WAR against ${n}`);const d=[c.Planners.Default],g=new r.SituationExplorer(t);for(t.focus={offense:2,defense:0,growth:.5};await g.tryBest(d););for(t.focus={offense:2,defense:1,growth:.5};await g.tryBest(d););if(!g.isSafe()){for(g.considerCurrentSituation(),g.backtrack(.5),t.focus={offense:1,defense:1,growth:.5};await g.tryBest(d););if(g.isSafe())return g.considerCurrentSituation(),void g.goToBestOutcomeSoFar();for(g.backtrack(1),t.focus={offense:.5,defense:2,growth:.5},await g.tryBest(d),t.focus={offense:1,defense:1,growth:.5};await g.tryBest(d););g.considerCurrentSituation(),g.goToBestOutcomeSoFar()}};class h{constructor(e,t,i){this.state=e,this.region=t,this.warSupportByFaction=i}getPerceivedThreat(e){const t=e.faction;if(!e.isAlive()||!t)return 0;const i=(100+(this.warSupportByFaction.get(t.id)||0))/100,s=Math.min(100,n.AI.getRegionAttrition(this.state,this.region.id,t.id)),a=s>0?(120+s)/100:1;return i<=1?i*a*.5:i*a}getWillingnessToAttack(e){const t=e.faction;if(!t||t.controller===s.FactionController.None)return 1;const i=e.isAlive()?1:.1;return this.getHostilityTowardsFaction(t)*((100+Object.values(n.AI.getFactionAttrition(this.state,t.id)).reduce(a.sum,0)*i)/100)}getHostilityTowardsFaction(e){if(!e||e.controller===s.FactionController.None)return 1;const t=this.warSupportByFaction.get(e.id)||0,i=n.AI.getFactionApproval(this.state,this.region.faction.id,e.id);return t>0?(100+t)/100:(100-(i>0?Math.max(i,90):0))/100}}t.WartimePoliticalStrategy=h,t.AssaultPoliticalStrategy=class{constructor(e,t,i){this.state=e,this.region=t,this.warSupportByFaction=i}getPerceivedThreat(e){return 0}getWillingnessToAttack(e){const t=e.faction;return t&&t.controller!==s.FactionController.None?(this.warSupportByFaction.get(t.id)||0)>0?.5:2:1}getHostilityTowardsFaction(e){return 0}};class u{getWillingnessToSpend(e,t,i){const s=e.willSacrifice?i:0,n=e.remainingGold-t,a=e.remainingIncome+1+Math.floor(n/2);return e.remainingGold<t||a-s<0?0:.98-t/1e3}getMinimalAcceptableIncome(e){return Math.min(-Math.floor(e.remainingGold/10),-1)}}t.WartimeEconomicAdvisor=u},66798:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CompositePlanner=void 0;const n=s(i(54485)),a=i(14090),o=i(19764),r=i(55455),c=i(1951);i(62199).logger.for("ai:CompositePlanner"),t.CompositePlanner=class{constructor(e){this.options=e,this.name="CompositePlanner",this.candidatePlans=[],this.candidatePlansHeap=new n.default(((e,t)=>t.utility-e.utility))}*generatePlans(e,t){for(const i of this.options.allowedTactics)for(const s of i.generatePlans(e,t))this.candidatePlans.push(s),this.candidatePlansHeap.push(s);for(;!this.candidatePlansHeap.empty();)yield this.candidatePlansHeap.pop()}getDebugLayer(){return{onChange:(0,a.signal)(),getMap:()=>{const e=new o.CustomHexGroupValuation([]);return this.candidatePlans.forEach((t=>{const i=t.hex;i&&e.set(i.id,[...e.get(i.id),t])})),new r.ProxyHexGroupValuation(e,(e=>e.map((e=>e.utility)).reduce(c.max,-1/0)))},getDetail:e=>this.candidatePlans.filter((t=>t.hex===e)).sort(((e,t)=>t.utility-e.utility)).map((e=>e.toString()+"\n"+e.toDebugString())).join("\n")}}}},62271:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultPlanner=void 0;const s=i(98260),n=i(89403),a=i(95077),o=i(16115),r=i(30634),c=i(1951),l=i(87832),d=i(9332),h=i(73508),u=i(52163),g=i(46299),p=i(8650),m=i(31028);i(62199).logger.for("ai:DefaultPlanner"),t.DefaultPlanner=class{constructor(){this.name=this.constructor.name}*generatePlans(e,t){this.context=e,this.views=t,this.focus=e.focus,this.state=e.state,this.investmentPenaltyByMight={};const i=(0,s.getMyRegionAssets)(e.region),r=e.unitSolver,c=[1,2,3,4].filter((t=>{if(e.region.power.maxObtainableUnitMight<t)return!1;if(i.remainingUnits.has(t))return this.investmentPenaltyByMight[t]=0,!0;const s=r.gather({...i,requiredMight:t,allowOverkill:!1});return!!(s&&s.attractiveness>=.1)&&(this.investmentPenaltyByMight[t]=Math.floor(Math.min(0,100*(s.attractiveness-1))),!0)})),l=this.getObtainableCastles(i),d=c[c.length-1];if(d>0)for(const t of n.Warfare.getConquerableHexes(this.state,e.region.id,d).members)for(let e=n.Warfare.getHexDefense(this.state,t)+1;e<=d;++e){if(!c.includes(e))continue;const i=this.calculateFactorsForAttack(t,e);yield new p.PlaceUnitPlan(t,e,i)}if(this.focus.defense>0){const t=this.views.exposedHexes.get(20/e.focus.defense);if(t.length){const e=t.members.reduce(((e,t)=>a.AI.getHexImportance(this.state,t.id).value>a.AI.getHexImportance(this.state,e.id).value?t:e)),i=[e,...o.Regions.getSameRegionNeighbours(this.state,e).members].filter((e=>!n.Warfare.model(this.state).isOccupied(e)));for(const e of i){for(let t=1;t<=d;++t){if(!c.includes(t))continue;const i=this.calculateFactorsForPlacingDefender(e,t);yield new p.PlaceUnitPlan(e,t,i)}for(const t of l){const i=this.calculateFactorsForBuildingCastle(e,t);yield new m.PlaceCastlePlan(e,t,i)}}}}}getObtainableCastles(e){return[2].filter((t=>this.context.advisors.economic.getWillingnessToSpend(e,r.Rules.model(this.state).castleByMight(t).cost,0)>0))}calculateFactorsForPlacingDefender(e,t){r.Rules.model(this.state);const i=[e,...o.Regions.getSameRegionNeighbours(this.state,e).members].map((e=>this.calculateDefenseBenefit(e,t))).reduce(c.sum,0);return{capturedHexEnemyImportance:0,capturedHexImportanceForMe:0,joinRegionsBonus:0,loot:0,investmentPenalty:this.investmentPenaltyByMight[t],threatReduction:Math.floor(i),baseSafetyRating:0,exposedUnitPenalty:0}}calculateFactorsForBuildingCastle(e,t){const i=r.Rules.model(this.state).castleByMight(t),s=[e,...o.Regions.getSameRegionNeighbours(this.state,e).members],n=s.map((e=>this.calculateDefenseBenefit(e,t))).reduce(c.sum,0),a=s.map((e=>this.calculateStaticDefenseBenefit(e,t))).reduce(c.sum,0);return{capturedHexEnemyImportance:0,capturedHexImportanceForMe:0,joinRegionsBonus:0,loot:0,investmentPenalty:-i.cost*this.focus.growth,threatReduction:Math.floor(n),baseSafetyRating:Math.floor(a),exposedUnitPenalty:0}}calculateFactorsForAttack(e,t){return{capturedHexEnemyImportance:this.calculateEnemyHexImportanceFactor(e),capturedHexImportanceForMe:this.calculateMyHexImportanceFactor(e),joinRegionsBonus:this.calculateJoinRegionBonus(e),loot:10*l.Economy.model(this.state).numberOfCoinsAt(e)*this.focus.growth,...this.calculateSafetyRating(e,t),investmentPenalty:this.investmentPenaltyByMight[t],threatReduction:this.calculateThreatReductionAfterHexCaptured(e,t)}}calculateThreatReductionAfterHexCaptured(e,t){if(0===this.focus.defense)return 0;let i=0;return this.context.region.hexes.neighboursOf(e).forEach((e=>{i+=this.calculateDefenseBenefit(e,t)})),Math.floor(i)}calculateDefenseBenefit(e,t){const i=n.Warfare.getHexDefense(this.state,e);if(i>t)return 0;const s=this.views.threatAssessment.get(e.id),o=Math.min(i,s.strongestUnit),r=Math.min(t,s.strongestUnit),c=a.AI.getHexImportance(this.state,e.id)?.value||0,l=d.Pawns.model(this.state).presentAtHex(e,h.PawnType.Town);let u=0;for(let e=o+1;e<=r;e++)u+=c*(l?1:s.riskByMight[e]||0)*this.focus.defense;return Math.floor(u)}calculateStaticDefenseBenefit(e,t){const i=n.Warfare.getHexStaticDefense(this.state,e);if(i>t)return 0;const s=this.views.threatAssessment.get(e.id),o=Math.min(i,s.strongestUnit),r=Math.min(t,s.strongestUnit),c=a.AI.getHexImportance(this.state,e.id)?.value||0,l=d.Pawns.model(this.state).presentAtHex(e,h.PawnType.Town);let u=0;for(let e=o+1;e<=r;e++)u+=c*(l?1:s.riskByMight[e]||0)*this.focus.defense;return Math.floor(u)}calculateSafetyRating(e,t){const i=this.context.faction;u.assert.defined(i);const s=o.Regions.model(this.context.state).byHex(e);u.assert.defined(s);const a=s.power.maxSustainableUnitMight,r=n.Warfare.getHexDefenseAsIfOwnedBy(this.state,e,this.context.region.id);let c,l=0;if(a){c=50/(Math.max(0,t-(a>r?a:1))+1);const e=Math.max(0,a-Math.max(t,r));l=-1*this.context.focus.defense*e*5}else c=50/t;return{baseSafetyRating:Math.floor(c),exposedUnitPenalty:l}}calculateEnemyHexImportanceFactor(e){if(0===this.focus.offense)return 0;const t=o.Regions.model(this.state).byHex(e);if(!t)return 0;const i=this.context.advisors.political.getWillingnessToAttack(t);if(0===i)return-1e3;const s=i-1,n=t.isAlive()?25:0,r=Math.max(n,a.AI.getHexImportance(this.state,e.id)?.value||0);return s>0?Math.round(r*s*this.focus.offense):Math.round(r*s/this.focus.offense)}calculateMyHexImportanceFactor(e){return Math.max(this.focus.defense,this.focus.growth/2)?e.neighbours((e=>g.Factions.getByHex(this.state,e.id)===this.context.faction.id)).map((e=>a.AI.getHexImportance(this.state,e.id)?.value||0)).reduce(c.sum,0):0}calculateJoinRegionBonus(e){if(!this.focus.growth)return 0;let t=0;return new Set(e.neighbours().map((e=>o.Regions.model(this.state).byHex(e))).filter((e=>e&&e!==this.context.region&&e.faction===this.context.faction))).forEach((e=>{e.isAlive()?t+=5*(e.treasury+Math.abs(e.budget?.balance||0)):t+=50*e.hexes.length})),Math.min(t*this.focus.growth,500)}}},31028:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaceCastlePlan=void 0;const s=i(1951),n=i(71203),a=i(5538),o=i(73735);t.PlaceCastlePlan=class{constructor(e,t,i){this.hex=e,this.might=t,this.utilityFactors=i,this.utility=Object.values(this.utilityFactors).reduce(s.sum,0)}execute(e){return e.marshal.buildCastle(this.hex,this.might),!0}toString(){return`[${this.utility} | Place ${n.inject.gameStateModel.rules.castleByMight(this.might).type} at #${this.hex.id}]`}toDebugString(){return(0,a.prettyPrintObject)((0,o.filterDictionary)(this.utilityFactors,(e=>0!=e)),2)}}},8650:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaceUnitPlan=void 0;const s=i(98260),n=i(1951),a=i(71203),o=i(5538),r=i(73735);t.PlaceUnitPlan=class{constructor(e,t,i){this.hex=e,this.might=t,this.utilityFactors=i,this.utility=Object.values(this.utilityFactors).reduce(n.sum,0)}execute(e){const t=e.unitSolver.gather({...(0,s.getMyRegionAssets)(e.region),requiredMight:this.might,allowOverkill:!0});return!!t&&(e.marshal.moveUnit(this.hex,t),!0)}toString(){return`[${this.utility} | Place ${a.inject.gameStateModel.rules.unitByMight(this.might).type} at #${this.hex.id}]`}toDebugString(){return(0,o.prettyPrintObject)((0,r.filterDictionary)(this.utilityFactors,(e=>0!=e)),2)}}},59402:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Planners=void 0;const s=i(62271);t.Planners={Default:new s.DefaultPlanner}},67732:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BestPlanPicker=t.describePlan=t.UnitSolver=void 0;const s=i(73735),n=i(38070),a=i(62199),o=i(76339),r=i(54053),c=i(71203),l=i(76378);a.logger.for("ai:UnitSolver"),t.UnitSolver=class{constructor(e={}){this.rules=e.rules||c.inject.gameStateModel.rules,this.armyComposition=e.armyComposition||n.UNRESTRICTED_ARMY_COMPOSITION,this.economicStrategy=e.economic||o.UNRESTRICTED_ECONOMIC_ADVISOR}gather(e){if(e.requiredMight>r.MAX_UNIT_MIGHT)return;void 0===e.allowOverkill&&(e.allowOverkill=!0);const t=new d,i=e.remainingUnits.getOneWithMightAtLeast(e.requiredMight);if(i===e.requiredMight)return this._useExisting(e,i);if(t.consider(this._useExisting(e,i)),t.consider(this._buy(e)),e.requiredMight>1){let i=this.gather({...e,requiredMight:e.requiredMight-1,allowOverkill:!1,willSacrifice:!0});if(!i)return;let n=this.gather({...i,requiredMight:e.requiredMight-1,allowOverkill:!1,willSacrifice:!0});if(!n)return;const a=[...i.useUnits,...n.useUnits].sort(s.ascendingSortFn),o=n.remainingIncome+2*this.rules.unitByMight(e.requiredMight-1).upkeep-this.rules.unitByMight(e.requiredMight).upkeep;o>=this.economicStrategy.getMinimalAcceptableIncome(n)&&a.length>0&&t.consider({...n,useUnits:a,buyUnits:[...i.buyUnits,...n.buyUnits].sort(s.ascendingSortFn),might:e.requiredMight,remainingIncome:o,attractiveness:i.attractiveness*n.attractiveness*(e.willSacrifice?1:this.armyComposition.getWillingnessToObtainUnit(e,e.requiredMight))})}const n=t.getBestPlan();return!n||void 0!==e.minAttractiveness&&n.attractiveness<e.minAttractiveness?void 0:n}_useExisting(e,t){if(void 0===t)return;if(!e.allowOverkill&&t!==e.requiredMight)return;const i=e.requiredMight/t*(e.willSacrifice?this.armyComposition.getWillingnessToDiscardUnit(e,t):1);return{useUnits:[t],buyUnits:[],totalUnits:e.willSacrifice?e.totalUnits.withoutUnit(t):e.totalUnits,remainingUnits:e.remainingUnits.withoutUnit(t),remainingGold:e.remainingGold,remainingIncome:e.remainingIncome,might:t,attractiveness:i}}_buy(e){const t=this.rules.unitByMight(e.requiredMight),i=e.remainingGold-t.cost,s=e.remainingIncome-t.upkeep;if(!(i<0||s<this.economicStrategy.getMinimalAcceptableIncome(e)))return{useUnits:[],buyUnits:[e.requiredMight],totalUnits:e.willSacrifice?e.totalUnits:e.totalUnits.add(e.requiredMight),remainingUnits:e.remainingUnits,remainingGold:i,remainingIncome:s,might:e.requiredMight,attractiveness:(e.willSacrifice?1:this.armyComposition.getWillingnessToObtainUnit(e,e.requiredMight))*this.economicStrategy.getWillingnessToSpend(e,t.cost,t.upkeep)}}estimateBuyableMight(e){const t=Math.floor(e.remainingGold/l.CHEAPEST_UNIT_COST),i=Math.floor((e.remainingIncome-this.economicStrategy.getMinimalAcceptableIncome(e))/2);return Math.max(0,Math.min(t,i))}estimateTotalMight(e){return e.remainingUnits.getTotalMight()+this.estimateBuyableMight(e)}estimateTopAvailableMight({remainingIncome:e,remainingGold:t,remainingUnits:i,totalUnits:s}){let n,a=i.getStrongest();if(a===r.MAX_UNIT_MIGHT)return r.MAX_UNIT_MIGHT;do{n=this.gather({remainingIncome:e,remainingGold:t,remainingUnits:i,totalUnits:s,requiredMight:a+1}),n&&++a}while(n&&a<r.MAX_UNIT_MIGHT);return a||0}getObtainableUnits(e,t=.1){return[1,2,3,4].filter((i=>!!e.remainingUnits.has(i)||(this.gather({...e,requiredMight:i,allowOverkill:!1})?.attractiveness??-1/0)>=t))}getObtainableUnitCount(e){return e.remainingUnits.count()+Math.floor(e.remainingGold/l.CHEAPEST_UNIT_COST)}},t.describePlan=function(e){let t="";return e.useUnits.length&&(t+=`use ${e.useUnits.join(",")}${e.buyUnits.length?" and ":""}`),e.buyUnits.length&&(t+=`buy ${e.buyUnits.join(",")}`),t+` to obtain ${e.might} (attr ${e.attractiveness})`};class d{consider(e){e&&(!this.bestPlanSoFar||this.bestPlanSoFar.attractiveness<e.attractiveness)&&(this.bestPlanSoFar=e)}getBestPlan(){return this.bestPlanSoFar}}t.BestPlanPicker=d},78275:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getAppController=void 0;const s=i(44762),n=i(29834),a=i(42413),o=i(78547);t.getAppController=function(e){switch(e){case s.LaunchMode.Standard:return new n.GameAppController;case s.LaunchMode.Storybook:return new a.StorybookAppController;case s.LaunchMode.ScalingPOC:return new o.ScalingPOC}}},29834:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameAppController=void 0;const s=i(71203),n=i(84612),a=i(62199),o=i(18995),r=i(41e3),c=i(68179),l=i(73508),d=i(61852),h=i(46499),u=i(24909),g=i(79294),p=i(27358),m=i(29323),y=i(57557),f=i(8635),w=i(36205),b=i(86201),v=i(50937),S=i(30697),P=i(56118),T=i(52700),x=i(82963),M=i(39999),C=i(28989),I=i(28492),A=i(1956),B=i(51897),j=i(51059),_=i(84809),E=i(52163),R=i(59286),O=i(85059),H=i(38735),D=i(64900),k=i(58609),L=i(82334),U=i(46900),F=i(42574),G=i(94459);a.logger.for("AppController"),t.GameAppController=class{getScenes(){return[g.PreloadScene,P.LevelSelectUIScene,x.LevelDetailUIScene,p.WorldMapScene,m.PlayScene,y.MapEditorScene,f.PlayUIScene,T.MenuHeaderUIScene,S.TitleScreenUIScene,C.VictoryScene,D.DefeatScene,U.RandomMapSelectScene,I.GlobalUIScene,h.ModalWindowScene,w.DebugScene,v.DebugHistoryScene]}run(){const{game:e,events:t,gameStateController:i}=s.inject;s.inject.config.watch((t=>{(0,L.setDatGUIVisible)(t.debug.datgui),t.debug.overlay?(e.scene.isSleeping(n.Scenes.Debug)?e.scene.resume(n.Scenes.Debug):e.scene.run(n.Scenes.Debug),"string"==typeof t.debug.overlay&&d.commands.debug.dataSet(t.debug.overlay)):e.scene.isActive(n.Scenes.Debug)&&e.scene.sleep(n.Scenes.Debug)})),t.setDefaultHandler((e=>{B.ErrorTracking.logEvent(e)})),t.on(o.SystemEvents.EngineInitialized,(async()=>{j.ActivityWatcher.start(),H.track.timingComplete({name:H.TimingEvent.BootGame,value:O.timing.since(window.tStart)}),s.inject.ui.spectatingSpeed.set(s.inject.userData.recallChoice("spectatingSpeed"));const t=await s.inject.mapRegistry.getCampaignById("intro");E.assert.defined(t),s.inject.ui.selectedCampaign.set(t),s.inject.userData.recallChoice("latestLevelId"),e.scene.run(n.Scenes.GlobalUI),s.inject.config.debug.overlay&&e.scene.run(n.Scenes.Debug),0===s.inject.userData.getStats().total.turns?(F.NewsBox.hide(),s.inject.events.trigger(o.UserActions.PlayLevel({levelId:t.levels[0].id}))):await s.inject.navigator.goTo(s.inject.screen.title)})),t.on(o.UserActions.OpenExportMapDialog,(()=>{const e=s.inject.gameStateModel.exportState();e.currentPhase={turnNumber:1,faction:1,type:l.PhaseTypes.FactionTurn,tappedUnits:[]};const t=(0,b.encodeGameState)(e);s.inject.modals.show(u.UI.exportMap,{saveData:t},(()=>{}))})),t.on(o.UserActions.EditMapJSON,(()=>{const e=s.inject.gameStateModel.exportState();(0,A.setKeyboardCaptureEnabled)(!1),s.inject.modals.show(u.UI.editMapJSONDialog,{gameState:e},(e=>{(0,A.setKeyboardCaptureEnabled)(!0)}))})),t.on(o.UserActions.OpenLoadGameDialog,(()=>{s.inject.modals.show(u.UI.loadGame,{onLoad:e=>{try{if(!e)return void s.inject.modals.show(u.UI.oopsMessage,{message:"Looks like you didn't enter any map data. Try again!"});const t=(0,b.decodeGameState)(e);i.loadState(t,M.NewGameStateContext.LoadingGame),(0,c.saveGame)("restart"),s.inject.userData.saveLevelProgress()}catch(e){console.error(e),s.inject.modals.show(u.UI.oopsMessage,{message:"Looks like the save data is corrupted or incompatible\nwith this version of the game. Sorry!"})}}})})),t.on(o.UserActions.EditMap,(()=>{s.inject.userData.saveLevelProgress(),s.inject.navigator.goTo(s.inject.screen.mapEditor)})),t.on(o.UserActions.StartNewGame,(async e=>{i.loadState(s.inject.gameStateModel.state,M.NewGameStateContext.StartingNewGame),s.inject.screen.play.activationContext=M.NewGameStateContext.StartingNewGame,s.inject.navigator.goTo(s.inject.screen.play),s.inject.userData.saveNewLevel(),H.track.levelStart({level_id:s.inject.gameStateModel.map.levelId})})),t.on(o.UserActions.PlayLevel,(async({levelId:e})=>{const t=_.LevelModel.for(e);let i,n;const a=t.getLevelStatus();a===_.LevelStatus.InProgress||a==_.LevelStatus.Replaying?(i=await t.getCurrentState(),s.inject.screen.play.remainingLives=t.userData?.inProgress?.lives??R.DEFAULT_LIVES_PER_LEVEL,n=s.inject.ui.playedLevelId()===e?M.NewGameStateContext.ResumingGame:M.NewGameStateContext.LoadingGame,H.track.levelResume({level_id:t.id})):(n=M.NewGameStateContext.StartingNewGame,i=await t.getStartingState(),H.track.levelStart({level_id:t.id})),E.assert.defined(i),s.inject.gameStateController.loadState(i,n),s.inject.screen.play.activationContext=n,s.inject.navigator.goTo(s.inject.screen.play)})),t.on(o.UserActions.LoadGame,(e=>{const t=(0,r.loadGame)(e);i.loadState(t,M.NewGameStateContext.LoadingGame),s.inject.config.autoSaveOnTurnStart&&"auto"!==e&&s.inject.userData.saveLevelProgress(),s.inject.navigator.goTo(s.inject.screen.play)})),t.on(o.UserActions.SyncWithModel,(e=>{i.loadState(i.currentState,M.NewGameStateContext.LoadingGameStateForDebug)})),t.on(o.UserActions.SaveGame,(e=>{(0,c.saveGame)(e)})),t.on(o.UserActions.DebugGameState,(e=>{i.loadState(e,M.NewGameStateContext.LoadingGameStateForDebug)})),t.on(o.UserActions.SendTweet,(()=>{H.track.interaction("feedback_twitter"),window.open(s.inject.config.socials.twitterUrl,"_blank")})),t.on(o.UserActions.JoinDiscord,(()=>{H.track.interaction("feedback_discord"),window.open(s.inject.config.socials.discordUrl,"_blank")})),t.on(o.UserActions.SendEmail,(()=>{H.track.interaction("feedback_email"),window.open("mailto:"+s.inject.config.socials.email,"_blank")})),t.on(o.UserActions.SetSpectatingPlayBackSpeed,(e=>{s.inject.ui.spectatingSpeed.set(e),e!==k.SpectatingPlaybackSpeed.Paused&&s.inject.userData.rememberChoice("spectatingSpeed",e)})),t.on(o.UserActions.GoToMapGeneration,(()=>{s.inject.navigator.goTo(s.inject.screen.mapGeneration)})),t.on(o.UserActions.GoToRandomMapSelect,(()=>{s.inject.navigator.goTo(s.inject.screen.randomMapSelect)})),t.on(o.UserActions.ShowHowToPlay,(()=>{H.track.interaction("how_to_play"),s.inject.device.uiVariant()===G.UiVariant.Large?s.inject.modals.show(u.UI.htmlDialog,u.HtmlDocs.howToPlay):window.open(u.HtmlDocs.howToPlay.url,"_blank")}))}}},42413:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StorybookAppController=void 0;const s=i(71203),n=i(62199),a=i(18995),o=i(46499),r=i(24909),c=i(79294);n.logger.for("AppController"),t.StorybookAppController=class{getScenes(){return[c.PreloadScene,o.ModalWindowScene]}run(){s.inject.events.on(a.SystemEvents.EngineInitialized,(()=>{s.inject.modals.show(r.UI.exportMap,{saveData:"asjdlfkaj slkdfja lsfhjaksdf lkashdfkjsadfjkshdfash fkahs lfk kjf aksdfh kas hfdlkhasfjlksah flkh lsjdfh"},(e=>console.info("RESULT",e)))}))}}},61852:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CUSTOM_WORLD_DEBUG_LAYERS=t.createHexIdDebugLayer=t.registerConsoleCommands=t.commands=void 0;const n=i(71203),a=i(18995),o=i(98697),r=i(73508),c=i(52163),l=s(i(11227)),d=i(85044),h=i(77296),u=i(93122),g=i(99073),p=i(67732),m=i(95077),y=i(5538),f=i(50666),w=i(46299),b=i(52754),v=i(57775),S=i(94632),P=i(16912),T=i(1522),x=i(20680),M=i(38070),C=i(76339),I=i(4877),A=i(66798),B=i(59402),j=i(68517),_=i(10997),E=i(98260),R=i(17172),O=i(86201),H=i(69893),D=i(51897),k=i(72196),L=i(16115),U=i(88048);function F(){return new b.GameStateDebugLayer((0,T.hexBasedAdapter)({getValue:(e,t)=>t.toString(),getDetail:(e,t)=>t.toString()}))}function G(e){const t=n.inject.gameStateModel.stateEngine;let i=`${(0,d.isProjectionDataSet)(e)?t.isDataSetActive(e)?"●":"○":"■"} ${e.key} (${e.constructor.name})`;return(0,d.isProjectionDataSet)(e)&&(i+=`\nbased on:\n${e.parents.map((e=>`  ${N(e)} ${e.key}`)).join("\n")}`),i+=`\nused by:\n${t.childrenOf(e).map((e=>`  ${N(e)} ${e.key}`)).join("\n")}`,i}function N(e){return(0,d.isProjectionDataSet)(e)?n.inject.gameStateModel.stateEngine.isDataSetActive(e)?"●":"○":"■"}t.commands={game:{save:(e="auto")=>{n.inject.events.trigger(a.UserActions.SaveGame(e))},resume:()=>{n.inject.events.trigger(a.UserActions.ResumeGame())},load:(e="auto")=>{n.inject.events.trigger(a.UserActions.LoadGame(e))},decode(e){const t=(0,O.decodeGameState)(e);console.log(JSON.stringify(t,null,2))},export(){const e=JSON.stringify((0,H.compressGameState)(n.inject.gameStateModel.stateEngine));console.log(e)},import(e){const t=JSON.parse(e);n.inject.gameStateModel.restore(t),n.inject.events.trigger(a.UserActions.DebugGameState(n.inject.currentGameState))},revertTurn:()=>{n.inject.events.trigger(a.UserActions.RollbackTurn())},endTurn:()=>{n.inject.gameStateController.executePlay(a.Plays.EndTurn())},setFaction:(e,t)=>{n.inject.gameStateModel.stateEngine.apply(o.GameState.factions.byId.createMutation({set:{[e]:{...n.inject.gameStateModel.stateEngine.get(o.GameState.factions.byId,e),controller:t}}},"command"))},setTheme(e){h.WorldMap.setTheme(n.inject.gameStateModel.stateEngine.currentState,e),n.inject.events.trigger(a.UserActions.SyncWithModel())},takeOver(e){n.inject.gameStateModel.stateEngine.apply(o.GameState.factions.byId.createMutation({set:{[e]:{...n.inject.gameStateModel.stateEngine.get(o.GameState.factions.byId,e),controller:r.FactionController.LocalUser}}},"command"))},sync:()=>{n.inject.events.trigger(a.UserActions.SyncWithModel())},get state(){return n.inject.gameStateModel.stateEngine.serialize()},get rawState(){return n.inject.gameStateModel.stateEngine.currentState},get stateModel(){return n.inject.gameStateModel}},debug:{off(){const e=n.inject.config.debug;e.tweenSpeedFactor=1,e.overlay=!1,e.recordStateChanges=!1,e.integrityChecks=void 0,e.ai=!1,e.datgui=!1,n.inject.debugLayers.activate(void 0)},on(){n.inject.config.debug.overlay=!0},edit:()=>{n.inject.navigator.goTo(n.inject.screen.mapEditor)},logs(e){l.default.enable(e)},history(){n.inject.navigator.goTo(n.inject.screen.debugHistory)},borders(){n.inject.debugLayers.activate("TileBordersManager")},layer(e){(0,c.assert)(n.inject.debugLayers.get(e),`unknown debug layer ${e}`),n.inject.debugLayers.activate(e)},dataSet(e){const i=n.inject.gameStateModel.stateEngine.getDataSetByKey(e);if(!i)throw new Error(`No dataset found for key "${e}"`);if(!n.inject.debugLayers.get(e)){const s=t.CUSTOM_WORLD_DEBUG_LAYERS[e],a=s?s():new b.GameStateDebugLayer((0,S.dataSetAdapter)(i));n.inject.debugLayers.register(e,a)}n.inject.debugLayers.activate(e),console.log(G(i))},dataSets(){const e=n.inject.gameStateModel.stateEngine;console.log(e.getAllDataSets().toArray().sort((function(e,t){let i=e.key.split(".")[0],s=t.key.split(".")[0],n=i+"."+((0,d.isProjectionDataSet)(e)?"Z":"A")+"."+e.key,a=s+"."+((0,d.isProjectionDataSet)(t)?"Z":"A")+"."+t.key;return(0,u.compareStrings)(n,a)})).map((t=>`${(0,d.isProjectionDataSet)(t)?e.isDataSetActive(t)?"●":"○":"■"} ${t.key} (${t.constructor.name})`)).join("\n"))},factionDataSet(e){const t=n.inject.gameStateModel.stateEngine,i=n.inject.gameStateModel.stateEngine.getDataSetByKey(e);if(!i)throw new Error(`No dataset found for key "${e}"`);console.log(G(i));const s=(0,d.selectFromState)(t.currentState,i).entrySeq(),a=s.map((([e])=>e)).toJS(),o=s.map((([e,t])=>t)).toJS();console.table({faction:a,value:o})},hexImportance(){n.inject.debugLayers.activate("ai.hexImportance")},threatAssessment(e=n.inject.gameStateModel.currentPhase.faction?.id||1){const t=n.inject.gameStateModel.factions.byId(e),i=new P.ThreatAssessment(t,{armyComposition:M.UNRESTRICTED_ARMY_COMPOSITION,economic:C.UNRESTRICTED_ECONOMIC_ADVISOR,political:new I.ApprovalBasedPoliticalAdvisor(t)});n.inject.debugLayers.registerAndActivate("threatAssessment",i.getDebugLayer())},exposedHexes(e){const t=n.inject.gameStateModel.regions.byId(e);c.assert.defined(t,"invalid region id");const i=n.inject.gameStateModel.factions.byRegion(t);c.assert.defined(i,"invalid region id (region not controlled by faction)");const s=new P.ThreatAssessment(i,{armyComposition:M.UNRESTRICTED_ARMY_COMPOSITION,economic:C.UNRESTRICTED_ECONOMIC_ADVISOR,political:new I.ApprovalBasedPoliticalAdvisor(i)}),a=new R.ExposedHexes(t,s);n.inject.debugLayers.registerAndActivate("exposedHexes",a.getDebugLayer(0))},regionInfluence(e){const t=n.inject.gameStateModel.regions.byId(e);c.assert.defined(t),n.inject.debugLayers.registerAndActivate("regionInfluence",(0,g.createHexInfluenceDebugLayer)(e))},factionInfluenceByRegion:function(e,t=U.PowerMeasurement.MilitaryMight,i=1/0){n.inject.debugLayers.registerAndActivate(`factionInfluenceByRegion(${e})`,n.inject.views.factionInfluenceByRegion.getDebugLayer(e,t,i))},fear:function(e){n.inject.debugLayers.registerAndActivate(`fear(faction=${e})`,n.inject.views.fear.getDebugLayer(e))},hexIds(){n.inject.debugLayers.activate("hexIds",t.CUSTOM_WORLD_DEBUG_LAYERS.hexIds)},regionAssets(){n.inject.debugLayers.registerAndActivate("regionAssets",new b.GameStateDebugLayer((0,_.regionBasedAdapter)({getValue:(e,t)=>{const i=n.inject.gameStateModel.regions.byId(t);if(i)return`${(0,E.getMyRegionAssets)(i).totalUnits.getTotalMight()})`},getDetail:(e,t)=>{const i=n.inject.gameStateModel.regions.byId(t);if(i)return`units: ${(0,E.getMyRegionAssets)(i).totalUnits.toString()}`}})))},approval(e=1){const t=n.inject.gameStateModel,i=t.factions.byId(e);c.assert.defined(i);const s=t.factions.all().filter((e=>e.controller!==r.FactionController.None));let a=[["from \\ towards",...s.map((e=>e.id))]],o=1;for(let e of s){a[o]=[e.id];for(let i of s)a[o].push(m.AI.getFactionApproval(t.state,e.id,i.id));++o}console.table(a),n.inject.debugLayers.registerAndActivate("approval",new b.GameStateDebugLayer((0,v.factionBasedAdapter)({getValue:(e,t)=>m.AI.getFactionApproval(e,t,i.id),getDetail:(e,t)=>(0,y.prettyPrintObject)(m.AI.getFactionApproval(e,t))})))},factionAttrition(){n.inject.debugLayers.registerAndActivate("factionAttrition",n.inject.views.attritionByFaction.getDebugLayer())},diplomacy(){n.inject.debugLayers.activate("diplomacy",(()=>(0,x.createDiplomacyDebugLayer)()))},regionAiPlan(e,t){const i=new A.CompositePlanner({allowedTactics:[B.Planners.Default]}),s=n.inject.gameStateModel.regions.byId(e);c.assert.defined(s);const a=n.inject.gameStateModel.factions.byRegion(s);c.assert.defined(a);const o={economic:new C.BalancedEconomicAdvisor,armyComposition:new M.BalancedGrowthArmyComposition(s),political:new I.ApprovalBasedPoliticalAdvisor(a)},r={unitSolver:new p.UnitSolver(o),focus:t,advisors:o,faction:a,region:s,state:n.inject.currentGameState},l=(0,j.createAiViews)(r),d=i.generatePlans(r,l);for(;d.next()?.value;);n.inject.debugLayers.registerAndActivate("aiPlans",i.getDebugLayer())},attitude(e=1){const t=n.inject.gameStateModel,i=t.factions.byId(e);c.assert.defined(i);const s=t.factions.all().filter((e=>e.controller!==r.FactionController.None));let a=[["from \\ towards",...s.map((e=>e.id))]],o=1;for(let e of s){a[o]=[e.id];for(let i of s)a[o].push(m.AI.getFactionAttitude(t.state,e.id,i.id));++o}console.table(a),n.inject.debugLayers.registerAndActivate("approval",new b.GameStateDebugLayer((0,v.factionBasedAdapter)({getValue(e,t){if(t===i.id)return"";const{fear:s,approval:a,attitude:o}=n.inject.views.attitude.getComponents(e,{fromFactionId:t,towardsFactionId:i.id});return`${o}\n(A${a};F${s})`},getDetail:(e,t)=>w.Factions.model(e).all().filter((e=>e.controller!==r.FactionController.None&&e!==i&&e.id!==t)).map((i=>{const s=n.inject.views.attitude.getComponents(e,{fromFactionId:t,towardsFactionId:i.id});return`${s.attitude} towards F${i.id} (A${s.approval};F${s.fear})`})).join("\n")})))},testReporting(){D.ErrorTracking.captureException(new Error("Test Error (triggered by commands.testReporting())")),(0,k.reportFeedback)({comment:"Testing Feedback Message",email:"commands.testReporting()",mood:4})},testError(){myUndefinedFunction2()}},get rec(){return n.inject.history},get config(){return n.inject.config},get ui(){return n.inject.ui},edit:{setFactionColor:(e,t)=>{const i=n.inject.gameStateModel.factions.byId(e);c.assert.defined(i,`Invalid faction id ${e}`),i.setLandColor(t),n.inject.events.trigger(a.UserActions.SyncWithModel())},approval(e,t,i){const s=m.AI.changeFactionApproval(n.inject.currentGameState,e,t,(e=>e+i));console.log(`Approval from ${e} to ${t} now ${m.AI.getFactionApproval(s,e,t)}`)}}},t.registerConsoleCommands=function(){const e=t.commands,i=window;i.commands=e,i.game=e.game,i.debug=e.debug,i.rec=e.rec,i.config=e.config,i.edit=e.edit,i.ui=e.ui,i.inject=n.inject,i.GameState=o.GameState},t.createHexIdDebugLayer=F,t.CUSTOM_WORLD_DEBUG_LAYERS={hexIds:F,[o.GameState.regions.edgeHexes.key]:f.createBorderHexesDebugLayer,[o.GameState.warfare.borderHexes.key]:f.createBorderHexesDebugLayer,[o.GameState.regions.byHex.key]:()=>new b.GameStateDebugLayer((0,S.dataSetAdapter)(o.GameState.regions.byHex,{getGroups:e=>L.Regions.model(e).all().map((e=>e.hexes))}))},[o.GameState.pawns.byRegion,o.GameState.regions.hexes,o.GameState.economy.budgetByRegion,o.GameState.economy.treasuryByRegion,o.GameState.economy.townsByRegion,o.GameState.ai.attritionByRegion,o.GameState.ai.powerByRegion,o.GameState.ai.regionInfluenceByRegion,o.GameState.currentPhase.movableUnits,o.GameState.bandits.campsByRegion].forEach((e=>{t.CUSTOM_WORLD_DEBUG_LAYERS[e.key]=()=>new b.GameStateDebugLayer((0,S.regionDataSetAdapter)(e))})),[o.GameState.ai.approval,o.GameState.ai.powerByFaction,o.GameState.units.byFaction].forEach((e=>{t.CUSTOM_WORLD_DEBUG_LAYERS[e.key]=()=>new b.GameStateDebugLayer((0,S.factionDataSetAdapter)(e))}))},44762:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.configProfiles=t.LaunchMode=void 0,function(e){e[e.Standard=0]="Standard",e[e.Storybook=1]="Storybook",e[e.ScalingPOC=2]="ScalingPOC"}(i=t.LaunchMode||(t.LaunchMode={}));const s={reporting:{slack:{enabled:!0,feedbackHook:atob("aHR0cHM6Ly9ob29rcy5zbGFjay5jb20vc2VydmljZXMvVE0xQk01UzVCL0IwM0dVUkY4M0Q1L25YWGEwdHlraG1CNjBEYXExY3I3UzVHdg==")},sentry:{enabled:!0,dsn:"https://63ec8bedbe5345db9b76689cadb81eea@o364314.ingest.sentry.io/6446750"},googleAnalytics:{enabled:!0}},socials:{twitterUrl:"https://twitter.com/intent/tweet?text="+encodeURIComponent("@konkr_dev"),discordUrl:"https://discord.gg/C9HucB9arH",email:"dev@konkr.io"}};t.configProfiles={dev:{...s,mode:i.Standard,mapRegistryUrl:"assets/maps.json",debug:{datgui:!1,overlay:!1,dataFilter:"",ai:!1,breakpoints:[],cheats:!0,chunkBorders:!1,gameObjects:!1,objectPools:!1,recordStateChanges:!1,uiLayout:!1,integrityChecks:{pawns:!1,gameState:!1},checkWorldMapIntegrity:!1,tweenSpeedFactor:1,tileTextureAtlas:!1},allowEditing:!0,autoSaveOnTurnStart:!0,autoSaveOnTurnEnd:!0,serviceWorker:{enabled:!0,scope:"http://localhost:3000/"},antialiasing:!0,screenTransitionDuration:300,flags:{seeEnemyAttitudes:!1},reporting:{...s.reporting,sentry:{enabled:!1,dsn:""},googleAnalytics:{enabled:!1}}},production:{...s,mode:i.Standard,mapRegistryUrl:"assets/maps.json",debug:{datgui:!1,overlay:!1,dataFilter:void 0,ai:!1,breakpoints:!1,cheats:!1,gameObjects:!1,objectPools:!1,chunkBorders:!1,recordStateChanges:!1,integrityChecks:void 0,checkWorldMapIntegrity:!1,tweenSpeedFactor:1},allowEditing:!0,autoSaveOnTurnStart:!0,autoSaveOnTurnEnd:!0,serviceWorker:{enabled:!0,scope:"https://www.konkr.io/"},antialiasing:!0,screenTransitionDuration:300,flags:{seeEnemyAttitudes:!1}}}},30905:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BUILT_IN_MAPS=void 0,t.BUILT_IN_MAPS={titleScreenLevel:"konkrmap.v7.eyJtYXAiOnsid2lkdGgiOjIwLCJoZWlnaHTGDHRoZW1lIjoiZGVmYXVsdCJ9LCJ2ZXJzaW9uIjo3LCJyZWdpb25zIjpbeyJpZCI6MSwibmHFMWtpbmdkb20ixE94ZcQiNjEwLDYxMSw2MTIsNjEzXX0sxjQy2zQxNTA0LDE1MDXEBTfEBTgsMTbGFDnECjXEBTfEBTgsMTLEDzPGBTYsMTTEKDTEDzTEDzUwynQ03HQzMTIsMTMxMywxNMQKNTEwxAUxxAUyLDEyxA8yxA8yxigxyVY121Y3MDUsNzA2LOQAzDUwNizkAMXkAL82MDbJQDfcQDEyLDcxMyw4MTIsODEzLDnFDDEsODEwLDfrAIQ420Q5MDYsOTA3LDkwOCw55AFAMOQBGDDkAUAw5AFAMeQBLDDEGTHEGTHEGTHGGTnkAV42xAU3yWsx/AG6NTE2LDUxNyw2MeoA4DH8AOE4MDQsOcUE5QCFM8QFNMk7MvwCWjExxC8x5AHvMsYF6wJeM9w5M8Q5M8xo/QIaMeQB9zExMMov/ADSMTfkAUE35AFBOMQKODA4yjn8Aag4MDgsODA5LDnMajndMTUsOOsCSTT8AS43y1Y0/AEeNzE0LDcxNcot/AEc5ADs5ADrNzA5LDjrAiU0/AMVMTAwy1822yo07AO9/AF1OeYCOjLKLvwBajE17AE2/AFjMTTrANU1MNwqMuQDLjPrAWY1/QK9M8RZXSwiZmFjdO0FTcplbmF0dXJlIucFj0luZGV4xR9jb250cm9sbGVyxCVvbsQj6gWT5ASjLDQ0LDQ1LDQ2LDQ3LDQ4LDQ5LDUwLDLqAU3qAJtQbGF5ZXIgMSLPWGxvY2FsLXVzZXLyAIHKbTIsNDMsMeoBI+oEHMdYMtBYYWnPUDHMUDQsNDEsNeoE2OoCqcdQM99Q5QCDylAyNywy6gN/6gLKx040307lAIHKTjUsMjEsMuoEN+oC5cdQNd9Q5QCDylA3LDI5yU3qAwjHTTbfTeUAgMpN6gDnLeoB3v8CQ/cCQ+UCmXBhd+4H43R5cMRTdG93buYCySI65AepyHYy1SI2MDXIITPWQzMxMsgiNNYiMjA3yCI11SI5MTPIITbJIWNhc3Rs5ADYxkU1MMkkN9gkNOoAizjLJG1wyCI2MTDIITHkCSfSIuQGXMkj6gE1Y29pbnPJJOQI3yJjb3VudMRIyS/qAULOLzIwN9Qv6gFQzi/kCMnTL+oBXc0v5AhS0y7qAWnNLuQIvMgu6QEsMeoBdWZvcmVzdMku6gGY5AgF1yTKSOoBddAkMckkOdckNTE2yCTlCsLUJDcwOckk6gGc0CQ4ySTqAZHQJOkCkeQIadUkOMsk6gF7ziTkBwnJJeoBcs4lNOoCUTL4AWnkBvvJJfgBajnLSfgBauQJFskl+AFr5Ac/yCUz+AFs5Ac6ySX4AW3kBzDJJfgBbuQHWskl6gFLcGlrZW1h6gQmNOsEauoBA2tu5QzWyCUx6wCV6gEEdmlsbGFn5QbqxSc46gJwM+oBBdAm5AwPyCc06gEH0Cc36gCY5Amh1yY5MDnkBXVydWxlU2V06w17LCJjdXJyZW50UGhhc2XkDbR0dXJuTnVtYuQFvDHpCEHsBaPHEy3EKuQF/GFwcGVkVW5pdOYF3X0="}},66024:(e,t,i)=>{"use strict";i(82260);const s=i(71203),n=i(62199),a=i(61852),o=i(44762),r=i(78275),c=i(51897),l=i(94459),d=i(95976),h=i(38735),u=i(10445),g=i(68843),p=o.configProfiles.production;function m(e){const t=window.devicePixelRatio||1,{width:i,height:n}=(Math.floor(t),y());e.width===i&&e.height===n||(console.warn(`Window size changed. Adjusting viewport size to ${i}x${n}`),s.inject.game.scale.setGameSize(i,n))}function y(){const e=(0,l.getLogicalDpr)();return{width:window.innerWidth*e,height:window.innerHeight*e}}console.info("⚔ Konkr.io production build 2.0.19-build-2727693328 (master)"),p.reporting.googleAnalytics.enabled||(window.gtag=()=>{}),c.ErrorTracking.setup(p),window.launchGame=()=>{n.logger.addTransport("console",new d.ConsoleLogger),n.logger.for("game").info("starting");const e=(0,r.getAppController)(p.mode),t=(i=e.getScenes(),{type:Phaser.AUTO,backgroundColor:u.Colors.ocean,scale:{parent:"phaser-game",mode:Phaser.Scale.FIT,...y()},dom:{createContainer:!0},scene:i,pixelArt:!p.antialiasing,antialias:p.antialiasing});var i;const o=new Phaser.Game(t);(0,s.setupInjectionContainer)(o,p),c.ErrorTracking.initializeContext(),(0,g.instrumentBrowserHistory)(),(0,a.registerConsoleCommands)(),s.inject.userData.initialize().catch(c.ErrorTracking.captureException),s.inject.mapRegistry.initialize().catch(c.ErrorTracking.captureException),s.inject.analytics.setConfig({build_number:"2.0.19-build-2727693328",real_dpr:window.devicePixelRatio||1,logical_dpr:s.inject.device.dpr,ui_variant:s.inject.device.uiVariant(),os:s.inject.device.os()}),h.track.pageView(),o.scale.on("resize",m),e.run()}},98697:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createAIDataSets=t.createWarfareDataSets=t.createEconomyDataSets=t.createUnitsDataSets=t.createPawnDataSets=t.createFactionDataSets=t.createRegionDataSets=t.GameState=t.CORE_GAMESTATE_SCHEMA_VERSION=void 0;const s=i(41640),n=i(44334),a=i(73508),o=i(73916),r=i(76378),c=i(24534),l=i(47181),d=i(16882),h=i(61340),u=i(66873),g=i(69158),p=i(1482),m=i(47571),y=i(5057),f=i(55576),w=i(62284),b=i(50666),v=i(76491),S=i(74585),P=i(17981),T=i(51443),x=i(99073),M=i(30592),C=i(84820),I=i(19655),A=i(54934),B=i(71169),j=i(22738),_=i(30957);t.CORE_GAMESTATE_SCHEMA_VERSION=7;const E=new c.SingletonDataSet("map",{levelId:"",width:10,height:10,theme:"default"}),R=new c.SingletonDataSet("ruleSet",r.ruleSets.default),O=W(),H=z(),D=V(),k=$(),L=function(){const e={data:new c.SingletonDataSet("currentPhase",{type:a.PhaseTypes.FactionTurn,turnNumber:1,faction:1}),tappedUnits:new g.SetDataSet("currentPhase.tappedUnits")};return{...e,movableUnits:new p.MovableUnitsProjection("currentPhase.movableUnits",{currentPhase:e.data,currentPhaseTappedUnits:e.tappedUnits,unitsByFaction:k.byFaction})}}(),U=Y(),F=X(),G=K(),N=function(){const e=new h.HexesByPawnTypeAndRegionProjection("bandits.campsByRegion",a.PawnType.Camp,{pawnsByRegion:H.byRegion});return{campsByRegion:e,nearestCamp:new j.NearestCampByHexProjection("bandits.nearestCamp",{campsByRegion:e,regionsByHex:O.byHex,regionsHexes:O.hexes})}}();function W(){const e=new l.MapDataSet("regions"),t=new l.MapDataSet("regions.byHex"),i=new s.InvertedMapProjection("regions.hexes",t);return{byId:e,byHex:t,hexes:i,edgeHexes:new b.RegionEdgeHexesProjection("regions.edgeHexes",i),nextId:new n.NextIdProjection("regions.nextId",e)}}function V(){const e={byId:new l.MapDataSet("factions"),byRegion:new l.MapDataSet("factions.byRegion")},t=new s.InvertedMapProjection("factions.regions",e.byRegion);return{...e,regions:t,nextId:new n.NextIdProjection("factions.nextId",e.byId)}}function z(){const e={byId:new l.MapDataSet("pawns"),hex:new l.MapDataSet("pawns.hex"),count:new l.MapDataSet("pawns.count")},t=new s.InvertedMapProjection("pawns.byHex",e.hex);return{...e,byHex:t,nextId:new n.NextIdProjection("pawns.nextId",e.byId),byRegion:new o.PawnsByRegionProjection("pawns.byRegion",{pawnsByHex:t,regionsByHex:O.byHex,pawnsHex:e.hex})}}function $(){return{byFaction:new u.UnitsByFactionProjection("units.byFaction",{factionRegions:D.regions,pawnsByRegion:H.byRegion,rules:R})}}function Y(){const e=new h.HexesByPawnTypeAndRegionProjection("economy.townsByRegion",a.PawnType.Town,{pawnsByRegion:H.byRegion}),t=new _.NearestTownProjection("economy.nearestTown",{townsByRegion:e,regionByHex:O.byHex,regionsHexes:O.hexes}),i=new w.CoinsByHexProjection("economy.coinsByHex",{pawnsByHex:H.byHex,pawns:H.byId,pawnsCount:H.count}),s=new y.BudgetByRegionProjection("economy.budgetByRegion",{regionHexes:O.hexes,townsByRegion:e,pawnsByRegion:H.byRegion,regions:O.byId});return{coinsByHex:i,townsByRegion:e,nearestTown:t,treasuryByRegion:new f.TreasuryByRegionProjection("economy.treasuryByRegion",{coinsByHex:i,townsByRegion:e,regionsByHex:O.byHex}),budgetByRegion:s}}function X(){const e=new m.HexDefenseSourcesProjection("warfare.hexDefenseSources",{rules:R,movableUnits:L.movableUnits,pawns:H.byId,pawnsByHex:H.byHex,regionByHex:O.byHex});return{borderHexes:new v.RegionBorderHexesProjection("warfare.borderHexes",{regionsEdgeHexes:O.edgeHexes,pawnsByHex:H.byHex}),hexDefenseSources:e,hexDefense:new A.HexDefenseProjection("warfare.hexDefense",{hexDefenseSources:e,regionByHex:O.byHex}),hexStaticDefense:new B.HexStaticDefenseProjection("warfare.hexStaticDefense",{hexDefenseSources:e,regionByHex:O.byHex})}}function K(){const e=new M.AttritionByRegionDataSet("ai.attritionByRegion"),t=new l.MapDataSet("ai.approval"),i=new S.HexDepthProjection("ai.hexDepth",{regionHexes:O.hexes,borderHexes:F.borderHexes}),s=new P.PawnsValueByHex("ai.pawnsValueByHex",{pawns:H.byId,pawnsHex:H.hex,movableUnits:L.movableUnits,rules:R}),n=new d.HexImportanceProjection("ai.hexImportance",{regionsByHex:O.byHex,regionsHexes:O.hexes,townsByRegion:U.townsByRegion,coinsByHex:U.coinsByHex,pawnsValueByHex:s}),a=new x.RegionInfluenceByHexProjection("ai.regionInfluenceByHex",{factionsByRegion:D.byRegion,regionsByHex:O.byHex,borderHexes:F.borderHexes,hexDefense:F.hexDefense}),o=new I.PowerByRegionProjection("ai.powerByRegion",{treasuryByRegion:U.treasuryByRegion,budgetByRegion:U.budgetByRegion,pawnsByRegion:H.byRegion});return{attritionByRegion:e,approval:t,hexDepth:i,hexPawnsCost:s,hexImportance:n,regionInfluenceByHex:a,powerByRegion:o,powerByFaction:new T.PowerByFactionProjection("ai.powerByFaction",{factionRegions:D.regions,factions:D.byId,powerByRegion:o}),regionInfluenceByRegion:new C.RegionInfluenceByRegionProjection("ai.regionInfluenceByRegion",{regionInfluenceByHex:a,regionHexes:O.hexes})}}t.GameState={version:new c.SingletonDataSet("version",t.CORE_GAMESTATE_SCHEMA_VERSION),map:E,regions:O,factions:D,pawns:H,ruleSet:R,units:k,currentPhase:L,economy:U,warfare:F,ai:G,bandits:N},t.createRegionDataSets=W,t.createFactionDataSets=V,t.createPawnDataSets=z,t.createUnitsDataSets=$,t.createEconomyDataSets=Y,t.createWarfareDataSets=X,t.createAIDataSets=K},92940:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.PawnTraits=void 0,(i=t.PawnTraits||(t.PawnTraits={})).NegatesTileIncome="negates-tile-income",i.Unit="unit",i.Impenetrable="impenetrable",i.Building="building",i.Pest="pest",i.GuardsAdjacentTiles="protects-adjacent",i.OccupiesTile="occupies-tile"},24011:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createBlankGameState=t.SpecialFaction=void 0;const s=i(98697),n=i(73508),a=i(76378),o=i(71203),r=i(41682),c=i(73735);var l;!function(e){e[e.neutral=0]="neutral"}(l=t.SpecialFaction||(t.SpecialFaction={})),t.createBlankGameState=function(e={width:0,height:0,theme:"default"}){return{version:s.CORE_GAMESTATE_SCHEMA_VERSION,map:{width:e.width,height:e.height,theme:e.theme,levelId:o.inject.random.id(r.ID_TYPE.Level)},regions:[],factions:[{id:l.neutral,name:"nature",themeIndex:0,controller:n.FactionController.None,regions:[]},...(0,c.range)(1,6).map((e=>({id:e,name:`Player ${e}`,themeIndex:e-1,controller:1===e?n.FactionController.LocalUser:n.FactionController.Ai,regions:[]})))],pawns:[],currentPhase:{type:n.PhaseTypes.FactionTurn,turnNumber:1,faction:1},ruleSet:a.ruleSets.default}}},69893:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compressRuleSet=t.addIds=t.decompressGameState=t.compressGameState=void 0;const s=i(73735),n=i(98697),a=i(62199),o=i(76378),r=i(16115);function c(e,t,i){return e.get(t,i)?.toArray()||[]}a.logger.for("decompressGameState"),t.compressGameState=function(e){e.isDataSetActive(n.GameState.regions.hexes)&&r.Regions.destroyAllEmptyRegions(e.currentState);const t=e.serialize();return e.activate(n.GameState.regions.hexes,n.GameState.factions.regions),{map:t.map,version:t.version,regions:Object.values(t.regions).map((t=>({...t,hexes:c(e,n.GameState.regions.hexes,t.id),attrition:e.get(n.GameState.ai.attritionByRegion,t.id)}))),factions:Object.values(t.factions).map((t=>({...t,regions:c(e,n.GameState.factions.regions,t.id),approval:e.get(n.GameState.ai.approval,t.id)}))),pawns:Object.values(t.pawns).map((t=>{return{...t,hex:e.get(n.GameState.pawns.hex,t.id),count:(i=e.get(n.GameState.pawns.count,t.id),1===i?void 0:i)};var i})),ruleSet:e.get(n.GameState.ruleSet)===o.ruleSets.default?"default":e.get(n.GameState.ruleSet),currentPhase:{...t.currentPhase,tappedUnits:e.get(n.GameState.currentPhase.tappedUnits).keySeq().toArray()}}},t.decompressGameState=function(e){let t;const i={},a={},r={};t=(0,s.dictionaryOf)(e.regions.map((e=>(0,s.omit)(e,"hexes","attrition"))),"id"),e.regions.forEach((e=>{e.hexes.forEach((t=>i[t]=e.id)),e.attrition&&(a[e.id]=e.attrition)}));let c={};const l={};c=(0,s.dictionaryOf)(e.factions.map((e=>(0,s.omit)(e,"regions"))),"id"),e.factions.forEach((e=>{e.regions.forEach((t=>l[t]=e.id)),e.approval&&(r[e.id]=e.approval)}));let d={};const h={},u={};d=(0,s.dictionaryOf)(e.pawns.map((e=>(0,s.omit)(e,"hex","count"))),"id"),e.pawns.forEach((e=>{h[e.id]=e.hex,u[e.id]=e.count||1}));const g=(0,s.omit)(e.currentPhase,"tappedUnits");e.pawns.forEach((e=>{h[e.id]=e.hex,u[e.id]=e.count||1}));const p="string"==typeof e.ruleSet?o.ruleSets[e.ruleSet]:e.ruleSet;return{map:e.map,version:n.CORE_GAMESTATE_SCHEMA_VERSION,ruleSet:p,regions:t,"regions.byHex":i,factions:c,"factions.byRegion":l,pawns:d,"pawns.count":u,"pawns.hex":h,currentPhase:g,"currentPhase.tappedUnits":e.currentPhase.tappedUnits||[],"ai.approval":r,"ai.attritionByRegion":a}},t.addIds=function(e){return(0,s.mapDictionary)(e,((e,t)=>({...e,id:Number(t)})))},t.compressRuleSet=function(e){return o.ruleSets[e.id]?e.id:e}},40520:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameStateController=void 0;const s=i(70780),n=i(14090),a=i(98721),o=i(18995),r=i(62199),c=i(5538),l=i(73664),d=i(76321),h=i(61473),u=i(62616),g=i(71203),p=i(28565),m=i(14611),y=i(52163),f=i(85059),w=i(54694),b=i(39999),v=i(58609),S=i(65641),P=r.logger.for("GameStateController");t.GameStateController=class{constructor(){this.actionHandlers={},this.onEvent=(0,n.signal)(),this.thisTurnHistory=new u.FixedCapacityArray(50),this.rollbackHistory=new u.FixedCapacityArray(5),this.eventsPaused=!1,this.scheduledEvents=[],this.undoAvailable=(0,S.watchable)(v.UndoAvailability.RollbackOnly),this.model=new l.GameStateModel,this.on(o.Plays.EndTurn,(e=>{this.model.currentPhase.isLocalPlayerTurn()&&this.turnStartState&&this.rollbackHistory.push(this.turnStartState);const t=(0,m.executeEndTurn)(e);return this.model.currentPhase.isLocalPlayerTurn()&&(this.turnStartState=e.state,this.thisTurnHistory.clear()),this.updateUndoAvailability(),t})).on(o.Plays.MovePawn,d.executeMovePawn).on(o.Plays.BuyPawn,h.executeBuyPawn).on(o.Plays.AttackHex,p.executeAttackHex).on(o.Plays.BanditsAct,w.executeBanditsAct)}get rollbackAvailable(){return this.rollbackHistory.length>0}updateUndoAvailability(){this.thisTurnHistory.length>0?this.setUndoAvailable(v.UndoAvailability.Available):this.rollbackHistory.length>0?this.setUndoAvailable(v.UndoAvailability.RollbackOnly):this.setUndoAvailable(v.UndoAvailability.Unavailable)}setUndoAvailable(e){this.undoAvailable.set(e)}on(e,t){return(0,y.assert)(void 0===this.actionHandlers[e.eventName],`a handler is already assigned to event type ${e.eventName}!`),this.actionHandlers[e.eventName]=t,this}getEventQueue(){const e=new a.EventQueue;return e.addSource(this.onEvent),e}loadState(e,t){this.model.restore(e),this.model.activateAllProjections(),this.fireEvent(o.GameEvents.NewGameState({state:this.model.state,context:t})),this.scheduledEvents=[],t.startFactionTurn&&this.fireEvent(o.GameEvents.FactionTurnStarted({state:this.model.state,factionId:this.model.currentPhase.faction.id})),t.flushHistory&&(this.clearHistory(),this.model.currentPhase.isLocalPlayerTurn()&&(this.turnStartState=this.currentState)),this.updateUndoAvailability()}undo(){0!==this.thisTurnHistory.length?this.loadState(this.thisTurnHistory.pop(),b.NewGameStateContext.Undo):P.error("Unable to undo - history is empty")}rollbackTurn(){0!==this.rollbackHistory.length?(this.thisTurnHistory.clear(),this.loadState(this.rollbackHistory.pop(),b.NewGameStateContext.RollbackTurn)):P.error("Unable to rollback turn - turn history is empty")}clearHistory(){this.thisTurnHistory.clear(),this.rollbackHistory.clear(),this.updateUndoAvailability()}beginTransaction(){this.eventsPaused=!0}commitTransaction(){this.eventsPaused=!1,this.scheduledEvents.forEach((e=>this.fireEvent(e))),this.scheduledEvents=[]}createCheckpoint(){return{state:this.currentState,events:[...this.scheduledEvents]}}restoreCheckpoint(e){this.model.restore(e.state),this.scheduledEvents=[...e.events],g.inject.config.debug.ai&&this.onEvent.fire(o.GameEvents.NewGameState({state:this.currentState,context:b.NewGameStateContext.LoadingGameStateForDebug}))}saveCurrentStateForUndo(){this.currentState&&this.addStateToUndoHistory(this.currentState)}addStateToUndoHistory(e){this.thisTurnHistory.push(e),this.updateUndoAvailability()}get currentState(){return this.model?.stateEngine.currentState}handlePlay(e){const t=f.timing.start(`handleAction(${e.name})`);this.model.currentPhase.isLocalPlayerTurn()&&this.saveCurrentStateForUndo();const i=this.actionHandlers[e.name];i?i(this.model,e.payload).forEach((e=>this.fireEvent(e))):P.warning(`No handler assigned for event ${e.name} - ignoring it.`),t.complete()}fireEvent(e){this.eventsPaused&&!g.inject.config.debug.ai?(P.info(`[SCHEDULED] ${e.name} (${(0,c.str)(e.payload,100)})`),this.scheduledEvents.push(e)):(P.info(`🚀 ${e.name} (${(0,c.str)(e.payload,100)})`),this.onEvent.fire(e))}executePlay(e){if(e.category!=s.EventCategory.Play)throw new Error(`cannot execute ${e.name} - does not appear to be a Play`);P.info(`👤⮕ ${e.name}(${(0,c.str)(e.payload)})`),this.handlePlay(e)}}},37191:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.checkWinConditions=void 0;const s=i(18995);t.checkWinConditions=function(e){const t=e.factions.all().filter((e=>e.isAlive()));return 1===t.length?[s.GameEvents.GameOver({winningFactionId:t[0].id,state:e.state})]:[]}},28565:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.captureHex=t.executeAttackHex=void 0;const s=i(18995),n=i(72373),a=i(92940),o=i(73508),r=i(52163),c=i(23803),l=i(71203),d=i(37191),h=i(33376),u=i(35171);function g(e,t,i){const o=l.inject.gameStateModel,c=new h.WorldUpdateBuilder(o),u=o.state;r.assert.defined(e);const g=o.regions.byHex(e);r.assert.defined(g),r.assert.defined(t);const m=g.faction;let y;const f=i instanceof n.PawnModel?i.hex:void 0,w=(g.isAlive(),o.economy.loot(e,t)),b=function(){const t=o.pawns.findOne({hexes:e,traits:[a.PawnTraits.OccupiesTile]});if(!t)return;if(!(t.hasTrait(a.PawnTraits.Unit)&&o.warfare.getHexStaticDefense(e)>0))return{pawnId:t.id};const i=o.warfare.getRetreatDestination(t,f);return i?{pawnId:t.id,retreatHex:i.id}:{pawnId:t.id}}(),v=b?[o.pawns.byId(b.pawnId).type]:[];let S;if(i instanceof n.PawnModel)S=c.move({pawnId:i.id,destHex:e,defeatedUnit:b,captureHex:!0}).hexCaptured;else{const s=c.create({type:i,hex:e,defeatedUnit:b,sourceHex:p(o,e,t),regionId:t.id,captureHex:!0});y=o.economy.payForNewPawn(e,i),S=s.hexCaptured,i=o.pawns.byId(s.pawnId)}return l.inject.ai.dataLayer.onHexConquered({model:o,attackerFaction:t.faction,destroyedPawns:v,victimRegions:[g,...S.splitOffRegions.map((e=>o.regions.byId(e)))],regionWasAlive:S.victimRegionWasAlive}),[s.GameEvents.HexCaptured({stateBefore:u,stateAfter:o.state,capturedHexId:e.id,capturingPawnId:i.id,capturingPawnType:i.type,capturingFactionId:t.faction.id,lootTransactions:w,boughtPawnTransactions:y,newRegionId:t.id,victimRegionId:g.id,victimFactionId:m?.id,originatingHexId:f?.id,defeatedUnit:b,worldUpdates:c.getUpdates()}),...(0,d.checkWinConditions)(o)]}function p(e,t,i){return e.pawns.findClosest(t,u.HexGroup.union([t,i.hexes]),(e=>e.type===o.PawnType.Town))?.hex}t.executeAttackHex=function(e,t){const i=(0,c.getHex)(t.destinationHexId),s=e.pawns.byId(t.pawnId);r.assert.defined(i),r.assert.defined(s);const n=e.regions.byHex(s.hex);return r.assert.defined(n),g(i,n,s)},t.captureHex=g},54694:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeBanditsAct=void 0;const s=i(3579),n=i(24011),a=i(73508),o=i(18995),r=i(1947),c=i(62199),l=i(52163),d=i(23803),h=i(73735),u=i(43360),g=i(38416),p=i(33376);c.logger.for("bandits"),t.executeBanditsAct=function(e){const t=e.pawns.select({type:[a.PawnType.Bandit]}),i=new Set(t),c=new p.WorldUpdateBuilder(e),m=[],y={baseIncome:new s.CoinTransactionBuilder,buyUnits:new s.CoinTransactionBuilder,pillage:new s.CoinTransactionBuilder};for(let s of t){if(!s.exists)continue;const t=e.regions.byHex(s.hex);l.assert.defined(t);const a=t?.id;if(!t?.isAlive()&&!t?.faction?.isNeutral()){const t=s.hex;c.captureHex(s.hex,e.factions.byId(n.SpecialFaction.neutral)),m.push({hexId:s.hex.id,originalRegionId:a});const o=(0,u.getOrCreateNearestCamp)(e,s.hex,c);o?.hex===t?y.pillage.from(t).spawn(1):void 0!==o&&y.pillage.from(t).spawn(1).send(o.hex),i.delete(s)}}e.restore(y.pillage.apply(e.state)),(0,g.moveBandits)(e,i,c);const f=e.factions.byId(n.SpecialFaction.neutral).getRegions().map((t=>Array.from(r.Bandits.getCampsByRegion(e.state,t.id)))).flat().map(d.getHex);return f.forEach((t=>{if(e.economy.numberOfCoinsAt(t)>=3){const i=(0,g.pickHexToEnter)(e,t);i&&(c.create({hex:i,sourceHex:t,type:a.PawnType.Bandit,captureHex:!1}),y.buyUnits.from(t).consume(3))}})),e.restore(y.buyUnits.apply(e.state)),f.forEach((e=>{y.baseIncome.from(e).spawn(1)})),e.restore(y.baseIncome.apply(e.state)),[o.GameEvents.BanditsActed({stateAfter:e.state,pillagedHexes:m,coinTransactions:(0,h.mapDictionary)(y,(e=>e.getTransactions())),worldUpdates:c.getUpdates()})]}},61473:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeBuyPawn=void 0;const s=i(18995),n=i(28565),a=i(89403),o=i(52163),r=i(23803),c=i(33376);t.executeBuyPawn=function(e,t){const i=(0,r.getHex)(t.destinationHexId),l=e.regions.byId(t.buyerRegionId);o.assert.defined(i),o.assert.defined(l);const d=new c.WorldUpdateBuilder(e),h=e.warfare.getDropPawnResult(i,t.pawnType,l);switch(h.type){case a.DropPawnResultType.Conquest:return(0,n.captureHex)(i,l,t.pawnType);case a.DropPawnResultType.Reposition:case a.DropPawnResultType.EradicatePest:case a.DropPawnResultType.Combine:let o,r;h.type===a.DropPawnResultType.EradicatePest&&(r={pawnId:h.pest.id}),h.type===a.DropPawnResultType.Combine&&(o={outputType:h.combineInto,mergedWith:h.combineWith.id});const c=e.economy.payForNewPawn(i,t.pawnType),u=d.create({type:t.pawnType,hex:i,regionId:l.id,sourceHex:e.economy.nearestTownHexFrom(i),mergeData:o,defeatedUnit:r,captureHex:!1}),g={...t,stateAfter:e.state,payment:c,pawnId:u.merged?.newPawnId??u.pawnId,eradicatedPest:h.type===a.DropPawnResultType.EradicatePest,worldUpdates:d.getUpdates()};return[s.GameEvents.PawnBought(g)];case a.DropPawnResultType.Invalid:default:throw new Error(`Invalid buy attempt (${h.reason})`)}}},14611:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeEndTurn=void 0;const s=i(1547),n=i(18995),a=i(73508),o=i(52163),r=i(71203);t.executeEndTurn=function(e){(0,o.assert)(e.currentPhase.type===a.PhaseTypes.FactionTurn,`Cannot end turn in phase ${e.currentPhase.type}`);const t=[],i=e.currentPhase.faction;return o.assert.defined(i),r.inject.ai.dataLayer.onTurnEnd(e,i),function(e){const t=e.currentPhase.getNextFaction();0===t&&e.currentPhase.incrementTurnNumber(),e.currentPhase.set({type:a.PhaseTypes.FactionTurn,faction:t})}(e),t.push(...(0,s.startPhase)(e),n.GameEvents.FactionTurnStarted({state:e.state,factionId:e.currentPhase.faction.id})),t}},76321:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeMovePawn=void 0;const s=i(18995),n=i(89403),a=i(28565),o=i(52163),r=i(23803),c=i(33376);t.executeMovePawn=function(e,t){const i=e.pawns.byId(t.pawnId),l=new c.WorldUpdateBuilder(e);o.assert.defined(i);const d=i.region,h=i.hex,u=(0,r.getHex)(t.destinationHexId);if(o.assert.defined(d),o.assert.defined(u),h===u)return[];const g=e.warfare.getDropPawnResult(u,i.type,d);switch(g.type){case n.DropPawnResultType.Conquest:return(0,a.captureHex)(u,d,i);case n.DropPawnResultType.Reposition:return l.move({pawnId:i.id,destHex:u,captureHex:!0}),[s.GameEvents.PawnMoved({...t,stateAfter:e.state,sourceHexId:h.id,worldUpdates:l.getUpdates()})];case n.DropPawnResultType.EradicatePest:return l.move({pawnId:i.id,destHex:u,defeatedUnit:{pawnId:g.pest.id},captureHex:!0}),[s.GameEvents.PawnMoved({...t,stateAfter:e.state,sourceHexId:h.id,eradicatedPest:!0,worldUpdates:l.getUpdates()})];case n.DropPawnResultType.Combine:const o=g.combineWith.type;return g.combineWith.isMovable(),l.move({pawnId:i.id,destHex:u,mergeData:{mergedWith:g.combineWith.id,outputType:g.combineInto},captureHex:!0}),[s.GameEvents.PawnMoved({...t,stateAfter:e.state,sourceHexId:h.id,mergedWith:o,mergedInto:g.combineInto,worldUpdates:l.getUpdates()})];case n.DropPawnResultType.Invalid:default:throw new Error(`Invalid move (${g.reason})`)}}},1547:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gatherIncome=t.startPhase=void 0;const s=i(18995),n=i(73508),a=i(52163);t.startPhase=function(e){if(e.currentPhase.type===n.PhaseTypes.FactionTurn){const t=e.currentPhase.faction;return a.assert.defined(t),function(e,t){const i=[];return t.getRegions().forEach((t=>{a.assert.defined(t);const s=e.economy.gatherIncomeAndPayUpkeep(t);(s.worldUpdates.length>0||Object.keys(s.coinTransfers).length>0)&&i.push(s)})),[s.GameEvents.FactionEconomyUpdated({stateAfter:e.state,factionId:t.id,regionReports:i})]}(e,t)}return[]},t.gatherIncome=function(e){if(e.currentPhase.type!==n.PhaseTypes.FactionTurn)return[];const t=e.currentPhase.faction;return a.assert.defined(t),function(e,t){const i=[];return t.getRegions().forEach((t=>{a.assert.defined(t);const s=e.economy.gatherRegionIncome(t);(s.worldUpdates.length>0||Object.keys(s.coinTransfers).length>0)&&i.push(s)})),[s.GameEvents.FactionEconomyUpdated({stateAfter:e.state,factionId:t.id,regionReports:i})]}(e,t)}},39999:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NewGameStateContext=void 0,t.NewGameStateContext={StartingNewGame:{name:"starting new game",startFactionTurn:!0,flushHistory:!0,resetCamera:!1},LoadingGame:{name:"loading game",startFactionTurn:!0,flushHistory:!0,resetCamera:!0},ResumingGame:{name:"resuming game",startFactionTurn:!0,flushHistory:!1,resetCamera:!1},LoadingGameStateForDebug:{name:"loading game state for debug",startFactionTurn:!1,flushHistory:!1,resetCamera:!1},Preview:{name:"loading game state for preview",startFactionTurn:!1,flushHistory:!1,resetCamera:!1},Undo:{name:"undo",startFactionTurn:!1,flushHistory:!1,resetCamera:!1},RollbackTurn:{name:"rollback turn",startFactionTurn:!1,flushHistory:!1,resetCamera:!1}}},18995:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SystemEvents=t.UiEvents=t.UserActions=t.Plays=t.GameEvents=void 0;const s=i(70780);t.GameEvents={NewGameState:(0,s.gameStateEvent)("NEW_GAME_STATE"),FailedToLoadGame:(0,s.gameStateEvent)("FAILED_TO_LOAD_GAME"),PawnMoved:(0,s.gameStateEvent)("PAWN_MOVED"),PawnBought:(0,s.gameStateEvent)("PAWN_BOUGHT"),HexCaptured:(0,s.gameStateEvent)("HEX_CAPTURED"),BanditsActed:(0,s.gameStateEvent)("BANDITS_ACTED"),FactionEconomyUpdated:(0,s.gameStateEvent)("FACTION_ECONOMY_UPDATED"),FactionTurnStarted:(0,s.gameStateEvent)("FACTION_TURN_STARTED"),GameOver:(0,s.gameStateEvent)("GAME_OVER")},t.Plays={EndTurn:(0,s.gameplayAction)("END_TURN"),MovePawn:(0,s.gameplayAction)("REPOSITION_PAWN"),BuyPawn:(0,s.gameplayAction)("BUY_PAWN"),AttackHex:(0,s.gameplayAction)("ATTACK_HEX"),BanditsAct:(0,s.gameplayAction)("BANDITS_ACT")},t.UserActions={OpenNewGameDialog:(0,s.userAction)("OPEN_NEW_GAME_DIALOG"),EditMapJSON:(0,s.userAction)("EDIT_MAP_JSON"),OpenExportMapDialog:(0,s.userAction)("OPEN_SAVE_GAME_DIALOG"),OpenLoadGameDialog:(0,s.userAction)("OPEN_LOAD_GAME_DIALOG"),StartNewGame:(0,s.userAction)("START_NEW_GAME"),SaveGame:(0,s.userAction)("SAVE_GAME"),LoadGame:(0,s.userAction)("LOAD_GAME"),ResumeGame:(0,s.userAction)("RESUME_GAME"),RollbackTurn:(0,s.userAction)("ROLLBACK_TURN"),DeselectRegion:(0,s.userAction)("DESELECT_REGION"),SelectNextRegion:(0,s.userAction)("SELECT_NEXT_REGION"),SelectPreviousRegion:(0,s.userAction)("SELECT_PREVIOUS_REGION"),SelectNextPendingRegion:(0,s.userAction)("SELECT_NEXT_PENDING_REGION"),EndTurn:(0,s.userAction)("END_TURN"),Undo:(0,s.userAction)("UNDO"),OpenRollbackMenu:(0,s.userAction)("OPEN_ROLLBACK_MENU"),BuyablePawnPointerDown:(0,s.userAction)("BUYABLE_PAWN_POINTER_DOWN"),BuyablePawnPointerUp:(0,s.userAction)("BUYABLE_PAWN_POINTER_UP"),ReturnHeldPawn:(0,s.userAction)("RETURN_HELD_PAWN"),ShopAreaPointerDown:(0,s.userAction)("SHOP_AREA_POINTER_DOWN"),ShopAreaPointerUp:(0,s.userAction)("SHOP_AREA_POINTER_UP"),DebugGameState:(0,s.userAction)("DEBUG_GAME_STATE"),EditMap:(0,s.userAction)("EDIT_MAP"),SyncWithModel:(0,s.userAction)("SYNC_WITH_MODEL"),SetSpectatingPlayBackSpeed:(0,s.userAction)("SET_SPECTATING_PLAYBACK_SPEED"),SkipSpectating:(0,s.userAction)("SKIP_SPECTATING"),GoToMapGeneration:(0,s.userAction)("GOTO_MAP_GENERATION"),GoToCampaigns:(0,s.userAction)("GOTO_CAMPAIGNS"),GoToLevelSelect:(0,s.userAction)("GOTO_LEVEL_SELECT"),GoToLevelDetail:(0,s.userAction)("GOTO_LEVEL_DETAIL"),GoToQuickGame:(0,s.userAction)("GOTO_QUICK_GAME"),GoToRandomMapSelect:(0,s.userAction)("GOTO_RANDOM_MAP_SELECT"),PreviewLevel:(0,s.userAction)("FOCUS_LEVEL"),PlayLevel:(0,s.userAction)("PLAY_LEVEL"),RestartLevel:(0,s.userAction)("RESTART_LEVEL"),AbandonLevelProgress:(0,s.userAction)("ABANDON_LEVEL_PROGRESS"),Escape:(0,s.userAction)("ESCAPE"),GoBack:(0,s.userAction)("GO_BACK"),Cancel:(0,s.userAction)("CANCEL"),GenerateNewIsland:(0,s.userAction)("GENERATE_NEW_ISLAND"),GameOver:(0,s.userAction)("GAME_OVER"),SendTweet:(0,s.userAction)("SEND_TWEET"),SendEmail:(0,s.userAction)("SEND_EMAIL"),JoinDiscord:(0,s.userAction)("JOIN_DISCORD"),ToggleTooltip:(0,s.userAction)("TOGGLE_TOOLTIP"),ShowHowToPlay:(0,s.userAction)("SHOW_HOW_TO_PLAY")},t.UiEvents={PawnReturnedToShop:(0,s.uiEvent)("PAWN_RETURNED_TO_SHOP"),RollbackMenuClosed:(0,s.uiEvent)("ROLLBACK_MENU_CLOSED"),PawnPickedUp:(0,s.uiEvent)("PAWN_PICKED_UP")},t.SystemEvents={EngineInitialized:(0,s.systemEvent)("ENGINE_INITIALIZED"),ScreenActivated:(0,s.systemEvent)("SCREEN_ACTIVATED"),RequestLevelFeedback:(0,s.systemEvent)("REQUEST_LEVEL_FEEDBACK"),UserBecameInactive:(0,s.systemEvent)("USER_INACTIVE"),UserBecameActive:(0,s.systemEvent)("USER_ACTIVE"),UserMetaDataLoaded:(0,s.systemEvent)("USER_DATA_LOADED")}},86201:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.assertPrefixValid=t.decodeGameState=t.encodeGameState=void 0;const n=i(98697),a=s(i(4037)),o=`konkrmap.v${n.CORE_GAMESTATE_SCHEMA_VERSION}.`;function r(e){if(!e.startsWith(o))throw new Error(`Invalid save data: "${e.substring(0,50)}..." does not start with ${o}`)}t.encodeGameState=function(e){const t=JSON.stringify(e),i=a.default.compress(t,{inputEncoding:"String",outputEncoding:"Base64"});return`${o}${i}`},t.decodeGameState=function(e){r(e);const t=e.substring(o.length),i=a.default.decompress(t,{inputEncoding:"Base64",outputEncoding:"String"}).toString();return JSON.parse(i)},t.assertPrefixValid=r},58500:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseEntityModel=void 0;const s=i(78311),n=i(52163);class a extends s.BaseModel{constructor(e,t){super(),this.parentModel=e,n.assert.defined(t),this.id=t}updateFrom(e){return this.parentModel.state=e,this}get state(){return this.parentModel.state}set state(e){this.parentModel.state=e}}t.BaseEntityModel=a},78311:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseModel=void 0;const s=i(71203);t.BaseModel=class{constructor(){}get state(){return this._lockedState??s.inject.currentGameState}set state(e){if(this._lockedState)throw new Error("This state model is locked");s.inject.currentGameState=e}lockToState(e){this._lockedState=e}unlock(){this._lockedState=void 0}}},73664:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.readOnlyModelOf=t.describePhase=t.describeState=t.checkForInvalidReferences=t.GameStateModel=t.StaticGameStateModel=t.ProjectionPresets=void 0;const o=a(i(96486)),r=i(62199),c=i(14090),l=i(98697),d=i(71203),h=i(75910),u=i(60263),g=i(89403),p=i(69893),m=i(73735),y=i(30634),f=i(16115),w=i(85044),b=i(2733),v=i(9332),S=i(46299),P=i(87832),T=i(2011),x=i(77296),M=i(1157),C=i(95077);r.logger.for("GameStateModel");let I=!1;t.ProjectionPresets={coreEntities:[...Object.values(l.GameState.regions),...Object.values(l.GameState.factions),...Object.values(l.GameState.pawns)],coreEntitiesAndSystems:[...Object.values(l.GameState.regions),...Object.values(l.GameState.factions),...Object.values(l.GameState.pawns),...Object.values(l.GameState.units),...Object.values(l.GameState.warfare),...Object.values(l.GameState.currentPhase)]};class A{constructor(e){this.state=e}get map(){return x.WorldMap.model(this.state)}get rules(){return y.Rules.model(this.state)}get regions(){return f.Regions.model(this.state)}get factions(){return S.Factions.model(this.state)}get pawns(){return v.Pawns.model(this.state)}get currentPhase(){return T.CurrentPhase.model(this.state)}get warfare(){return g.Warfare.model(this.state)}get economy(){return P.Economy.model(this.state)}get ai(){return C.AI.readOnlyModel(this.state)}}function B(e){return`${e.type}`&&e.faction?`/${e.faction}`:""}t.StaticGameStateModel=A,t.GameStateModel=class{constructor(e){this.onNewState=(0,c.signal)(),this.stateEngine=new u.StateEngine,this.loadDataSets(),e&&((0,w.isImmutableState)(e)?this.stateEngine.setState((0,w.setParentEngine)(e,this.stateEngine)):this.stateEngine.deserialize((0,p.decompressGameState)(e)))}get map(){return x.WorldMap.model(this.state)}get rules(){return y.Rules.model(this.state)}get regions(){return f.Regions.model(this.state)}get factions(){return S.Factions.model(this.state)}get pawns(){return v.Pawns.model(this.state)}get currentPhase(){return T.CurrentPhase.model(this.state)}get warfare(){return g.Warfare.model(this.state)}get economy(){return P.Economy.model(this.state)}get ai(){return C.AI.currentModel()}get state(){return this.stateEngine.currentState}suspendAllProjections(){this.stateEngine.suspendAllProjections()}useProjections(e){return this.stateEngine.activateOnly(...e),this}activateAllProjections(){return this.stateEngine.activateAllProjections(),this}loadDataSets(){this.stateEngine.add(l.GameState.version,l.GameState.map,l.GameState.ruleSet,...Object.values(l.GameState.regions),...Object.values(l.GameState.factions),...Object.values(l.GameState.pawns),...Object.values(l.GameState.units),...Object.values(l.GameState.currentPhase),...Object.values(l.GameState.warfare),...Object.values(l.GameState.economy),...Object.values(l.GameState.ai),...Object.values(l.GameState.bandits)),this.stateEngine.watchAll(((e,t)=>this.stateUpdated(t)))}restore(e){return(0,w.isImmutableState)(e)?this.stateEngine.setState(e):this.stateEngine.deserialize((0,p.decompressGameState)(e)),d.inject.config.debug.recordStateChanges&&!I&&d.inject.history.add("restored state"),this}stateUpdated(e){I||(d.inject.config.debug.integrityChecks?.gameState&&this.protectStateIntegrity(),d.inject.config.debug.recordStateChanges&&d.inject.history.add(function(e){return e&&0!==e.length?e[0].context:"state updated (no mutation)"}(e)),this.onNewState.fire(this.stateEngine.currentState))}protectStateIntegrity(){I=!0;const e=this.state,t=(0,b.getCanonicalStateSnapshot)(this.state);this.stateEngine.deserialize(this.stateEngine.serialize());const i=(0,b.getCanonicalStateSnapshot)(this.state);if(!o.isEqual(t,i)){const s=(0,h.diff)(t,i),n=Object.keys(s);console.warn(`GameState integrity violation! There's a difference in state after serialization and deserialization!\nDIFFERENCE IN ${n.join(",")}:\n${JSON.stringify(s,null,2)}\nBEFORE:\n${JSON.stringify((0,m.filterDictionary)(t,((e,t)=>n.includes(t))),null,2)}\nAFTER:\n${JSON.stringify((0,m.filterDictionary)(i,((e,t)=>n.includes(t))),null,2)}\n`),d.inject.history.add(`${M.GLYPH.redFlag} INCONSISTENT STATE (error in ${n.join(",")})`,e)}this.stateEngine.currentState,I=!1}exportState(){return(0,p.compressGameState)(this.stateEngine)}withTemporaryBranch(e){const t=this.state;e(),this.restore(t)}},t.checkForInvalidReferences=function(e){},t.describeState=function(e){return`[GameState (${e.map.width}x${e.map.height}⬡, ${e.factions.length}👤, ${e.regions.length}♖,${B(e.currentPhase)})]`},t.describePhase=B,t.readOnlyModelOf=function(e){return new A(e)}},33376:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldUpdateBuilder=t.UpdateType=void 0;const s=i(52163),n=i(23803),a=i(71249);var o;!function(e){e.PawnMoved="pawn-moved",e.PawnsMerged="pawns-merged",e.PawnsDestroyed="pawns-destroyed",e.PawnReplaced="pawn-replaced",e.HexCaptured="hex-captured"}(o=t.UpdateType||(t.UpdateType={})),t.WorldUpdateBuilder=class{constructor(e){this.model=e,this.data=[]}create(e){const t=this.model.pawns.create(e);return this.move({pawnId:t.id,created:{pawnType:e.type,hex:e.sourceHex?.id??e.hex.id,regionId:e.regionId??t.region.id},destHex:e.hex,defeatedUnit:e.defeatedUnit,mergeData:e.mergeData,captureHex:e.captureHex})}getUpdates(){return this.data}replace(e,t){const i=e.id,s=e.type,n=this.model.pawns.byId(e.id).replaceWith(t);return this.data.push({type:o.PawnReplaced,hexId:n.hex.id,oldPawnId:i,newPawnId:n.id,newType:t,oldType:s,stateAfter:this.model.state}),n}destroy(...e){e.forEach((e=>{this.data.push({type:o.PawnsDestroyed,pawnId:e.id})})),this.model.pawns.destroy(...e)}captureHex(e,t){const i=this.buildCaptureHexUpdate(e,t);return this.data.push(i),i}buildCaptureHexUpdate(e,t){let i,n;t instanceof a.RegionModel?(i=t.faction,n=t):(i=t,n=void 0);const o=this.model.regions.byHex(e),r=(o.isAlive(),o.id,i.captureHex(e,n));return s.assert.defined(r),this.data.push(r),r}move({pawnId:e,destHex:t,defeatedUnit:i,mergeData:a,created:r,captureHex:c}){let l=this.model.pawns.byId(e);s.assert.defined(l);const d=r?.regionId?this.model.regions.byId(r.regionId):l.region;s.assert.defined(d);let h,u,g=!1;c&&d!==this.model.regions.byHex(t)&&(g=!0,h=this.buildCaptureHexUpdate(t,d));const p=l.hex;if(a){const e=this.model.pawns.byId(a.mergedWith);s.assert.defined(e),s.assert.defined(l),e.hex;const t=!e.isMovable(),i=e.replaceWith(a.outputType);u={...a,newPawnId:i.id},l.destroy(),l=i,t&&(g=!0)}else l.moveTo(t);i&&(g=!0,i.retreatHex?this.model.pawns.byId(i.pawnId).moveTo((0,n.getHex)(i.retreatHex)):this.model.pawns.byId(i.pawnId).destroy()),g&&this.model.currentPhase.tapPawn(l),h&&(h.stateAfter=this.model.state);const m={type:o.PawnMoved,pawnId:e,srcHex:p.id,destHex:t.id,defeatedUnit:i,hexCaptured:h,created:r,merged:u,stateAfter:this.model.state};return this.data.push(m),m}}},95077:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.AIMutations=t.AI=void 0;const o=i(98697),r=i(85044),c=a(i(35369)),l=i(46299),d=i(73735),h=i(19655),u=i(71203),g=i(42830),p=i(88048);class m{static currentModel(){return this._model.unlock(),this._model}static readOnlyModel(e){return this._model.lockToState(e),this._model}static getHexDepth(e,t){return(0,r.selectFromState)(e,o.GameState.ai.hexDepth,t)}static getHexImportance(e,t){return(0,r.selectFromState)(e,o.GameState.ai.hexImportance,t)}static getRegionPower(e,t){return(0,r.selectFromState)(e,o.GameState.ai.powerByRegion,t)||h.NO_REGION_POWER}static getFactionPower(e,t){return(0,r.selectFromState)(e,o.GameState.ai.powerByFaction,t)||0}static getRegionAttrition(e,t,i){const s=(0,r.selectFromState)(e,o.GameState.ai.attritionByRegion,t)||{};return void 0===i?s:s[i]||0}static getHexInfluence(e,t,i){if(void 0===i)return(0,r.selectFromState)(e,o.GameState.ai.regionInfluenceByHex,t)||c.Map();{const s=(0,r.selectFromState)(e,o.GameState.ai.regionInfluenceByHex,t)||c.Map();return void 0===i?s:s.get(i)}}static getAggregateHexInfluence(e,t,i){return this.getHexInfluence(e,t).reduce(((e,t,s)=>e+i(s,t.resistance)),0)}static inflictRegionAttrition(e,t,i,s){return(0,r.applyMutations)(e,y.inflictRegionAttrition(e,t,i,s))}static changeFactionAttrition(e,t,i){const s=y.updateAllRegionAttrition(e,l.Factions.getFactionRegions(e,t),i);return(0,r.applyMutations)(e,s)}static changeFactionApproval(e,t,i,s){return(0,r.applyMutations)(e,y.changeApproval(e,t,i,s))}static getFactionApproval(e,t,i){const s=(0,r.selectFromState)(e,o.GameState.ai.approval,t);return s?void 0===i?s:s[i]||0:0}static getFactionAttrition(e,t,i){const s=u.inject.views.attritionByFaction.get(e,t);return s?void 0===i?s:s[i]||0:0}static getFactionFear(e,t,i){return u.inject.views.fear.get(e,{fromFactionId:t,towardsFactionId:i})}static getRegionInfluence(e,t,i){const s=(0,r.selectFromState)(e,o.GameState.ai.regionInfluenceByRegion,i);return s&&s.get(t)||0}static getFactionInfluenceByRegion(e,t,i,s=p.PowerMeasurement.MilitaryMight,n=1/0){return u.inject.views.factionInfluenceByRegion.get(e,{influencingFaction:t,targetRegion:i,maxDistance:n,powerMeasurement:s})}static getFactionAttitude(e,t,i){return u.inject.views.attitude.get(e,{fromFactionId:t,towardsFactionId:i})}}t.AI=m,m._model=new g.AIModel;class y{static inflictRegionAttrition(e,t,i,s){const n={};return t.forEach((t=>{const a=(0,r.selectFromState)(e,o.GameState.ai.attritionByRegion,t)||{},c={...a,[i]:(a[i]||0)+s};n[t]=c})),o.GameState.ai.attritionByRegion.createMutation({set:n},"inflictRegionAttrition")}static updateAllRegionAttrition(e,t,i){const s={};return t.forEach((t=>{const n=(0,r.selectFromState)(e,o.GameState.ai.attritionByRegion,t)||{},a=(0,d.mapDictionary)(n,i);s[t]=a})),o.GameState.ai.attritionByRegion.createMutation({set:s},"updateRegionAttrition")}static changeApproval(e,t,i,s){const n=(0,r.selectFromState)(e,o.GameState.ai.approval,t)||{},a=s(n[i]||0),c={...n,[i]:a};return o.GameState.ai.approval.createMutation({set:{[t]:c}},"changeApproval")}}t.AIMutations=y},42830:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AIModel=void 0;const s=i(98697),n=i(78311),a=i(85044);class o extends n.BaseModel{getHexDepth(e){return(0,a.selectFromState)(this.state,s.GameState.ai.hexDepth,e.id)||0}getHexImportance(e){return(0,a.selectFromState)(this.state,s.GameState.ai.hexImportance,e.id)?.value||0}}t.AIModel=o},30592:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AttritionByRegionDataSet=void 0;const s=i(47181),n=i(1951);class a extends s.MapDataSet{entryToString(e){return Object.values(e).reduce(n.sum,0).toString()}entryToDebugString(e){return Object.entries(e).filter((([e,t])=>t>0)).map((([e,t])=>`${t} inflicted by faction ${e}`)).join("\n")}}t.AttritionByRegionDataSet=a},1947:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Bandits=void 0;const n=i(85044),a=s(i(35369)),o=i(98697);t.Bandits=class{static getCampsByRegion(e,t){return(0,n.selectFromState)(e,o.GameState.bandits.campsByRegion,t)||a.default.Set()}static getNearestCampHex(e,t){return(0,n.selectFromState)(e,o.GameState.bandits.nearestCamp,t)?.rootId}static getNearestCampDistance(e,t){return(0,n.selectFromState)(e,o.GameState.bandits.nearestCamp,t)?.distance||Number.POSITIVE_INFINITY}}},43360:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOrCreateNearestCamp=void 0;const s=i(16115),n=i(46299),a=i(24011),o=i(92940),r=i(73508),c=i(1947);i(62199).logger.for("bandits"),t.getOrCreateNearestCamp=function(e,t,i){const l=c.Bandits.getNearestCampHex(e.state,t.id);if(c.Bandits.getNearestCampDistance(e.state,t.id)>5){const c=function(e,t){const i=t.floodFillOut(((t,i,c)=>c<5&&function(e,t){const i=s.Regions.getByHex(e.state,t.id);if(!i)return!1;if(n.Factions.getByRegion(e.state,i)===a.SpecialFaction.neutral)return!0;const c=e.pawns.findOne({hexes:t,traits:[o.PawnTraits.OccupiesTile]});return!c||c.type===r.PawnType.Bandit}(e,t))).filter((t=>function(e,t){if(!e.factions.byHex(t)?.isNeutral())return!1;const i=e.warfare.getOccupyingUnit(t);return!i||i.type===r.PawnType.Bandit}(e,t)));let c,l=Number.NEGATIVE_INFINITY;return i.forEach((t=>{const i=function(e,t){const i=t.neighbours().filter((t=>function(e,t){const i=e.regions.byHex(t)?.faction;return void 0!==i&&!i.isNeutral()}(e,t))).length;return 2*t.neighbours().filter((t=>!!e.pawns.findOne({hexes:t,type:[r.PawnType.Forest]}))).length+t.neighbours().filter((t=>!e.regions.byHex(t))).length-2*i+(e.pawns.findOne({hexes:t,type:[r.PawnType.Bandit]})?3:0)}(e,t);i>l&&(c=t,l=i)})),c}(e,t);if(c){const t=e.pawns.findOne({hexes:c,type:[r.PawnType.Bandit]});if(t)return i.replace(t,r.PawnType.Camp);{const t=i.create({hex:c,type:r.PawnType.Camp,captureHex:!1});return e.pawns.byId(t.pawnId)}}return l?e.pawns.byHex(l,r.PawnType.Camp):void 0}return l?e.pawns.byHex(l,r.PawnType.Camp):void 0}},38416:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pickHexToEnter=t.moveBandits=void 0;const s=i(24011),n=i(71203),a=i(16115),o=i(92940);function r(e,t,i=new Set){if(!a.Regions.getByHex(e.state,t.id))return!1;const s=e.pawns.findOne({hexes:t,traits:[o.PawnTraits.OccupiesTile]});return!s||i.has(s)}i(62199).logger.for("bandits"),t.moveBandits=function(e,t,i){for(;t.size;)a(t[Symbol.iterator]().next().value);function a(c){if(t.delete(c),!c.exists)return;const l=c.hex.neighbours().filter((i=>r(e,i,t))),d=l.filter((t=>e.regions.byHex(t)?.faction?.id!==s.SpecialFaction.neutral));if(l.length){const s=d.length?n.inject.random.hex(d):n.inject.random.hex(l),r=function(i){const s=e.pawns.findOne({hexes:i,traits:[o.PawnTraits.OccupiesTile]});return s&&t.has(s)?s:void 0}(s);r?(a(r),a(c)):i.move({pawnId:c.id,destHex:s,captureHex:!1})}}},t.pickHexToEnter=function(e,t,i=new Set){const a=t.neighbours().filter((t=>r(e,t,i))),o=a.filter((t=>e.regions.byHex(t)?.faction?.id!==s.SpecialFaction.neutral));return o.length>0?n.inject.random.hex(o):a.length>0?n.inject.random.hex(a):void 0}},2011:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurrentPhase=void 0;const s=i(98697),n=i(85044),a=i(74995),o=i(71203);class r{static model(e){return e===o.inject.currentGameState?this._model:(this._readOnlyModel.lockToState(e),this._readOnlyModel)}static getFaction(e){return(0,n.selectFromState)(e,s.GameState.currentPhase.data)?.faction}static getType(e){return(0,n.selectFromState)(e,s.GameState.currentPhase.data)?.type}static getTurnNumber(e){return(0,n.selectFromState)(e,s.GameState.currentPhase.data)?.turnNumber}static isMovable(e,t){return(0,n.selectFromState)(e,s.GameState.currentPhase.movableUnits).has(t)}static getMovableUnits(e){return(0,n.selectFromState)(e,s.GameState.currentPhase.movableUnits).toArray()}static isTapped(e,t){return(0,n.selectFromState)(e,s.GameState.currentPhase.tappedUnits).has(t)}static tapPawn(e,t){return(0,n.applyMutations)(e,s.GameState.currentPhase.tappedUnits.createMutation({add:[t]},"currentPhase.tapPawn"))}static unTapPawn(e,t){return(0,n.applyMutations)(e,s.GameState.currentPhase.tappedUnits.createMutation({delete:[t]},"currentPhase.unTapPawn"))}static set(e,t){const i=(0,n.selectFromState)(e,s.GameState.currentPhase.data);return(0,n.applyMutations)(e,s.GameState.currentPhase.data.createMutation({...i,...t},"currentPhase.set"),s.GameState.currentPhase.tappedUnits.createMutation({clear:!0},"currentPhase.set"))}}t.CurrentPhase=r,r._model=new a.CurrentPhaseModel,r._readOnlyModel=new a.CurrentPhaseModel},74995:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurrentPhaseModel=void 0;const s=i(73508),n=i(52163),a=i(2011),o=i(46299),r=i(9332),c=i(78311);class l extends c.BaseModel{get type(){return a.CurrentPhase.getType(this.state)}get turnNumber(){return a.CurrentPhase.getTurnNumber(this.state)}get faction(){const e=a.CurrentPhase.getFaction(this.state);if(void 0!==e)return o.Factions.model(this.state).byId(e)}isTapped(e){return a.CurrentPhase.isTapped(this.state,e.id)}isMovable(e){return a.CurrentPhase.isMovable(this.state,e.id)}isLocalPlayerTurn(){return this.type===s.PhaseTypes.FactionTurn&&this.faction?.controller===s.FactionController.LocalUser}getMovablePawns(){if(this.type!==s.PhaseTypes.FactionTurn)return[];n.assert.defined(this.faction);const e=r.Pawns.model(this.state);return a.CurrentPhase.getMovableUnits(this.state).map((t=>e.byId(t)))}getNextFaction(){const e=a.CurrentPhase.getFaction(this.state),t=o.Factions.getAll(this.state);return void 0===e?t[0]:t[(t.indexOf(e)+1)%t.length]}tapPawn(e){this.state=a.CurrentPhase.tapPawn(this.state,e.id)}unTapPawn(e){this.state=a.CurrentPhase.unTapPawn(this.state,e.id)}set(e){this.state=a.CurrentPhase.set(this.state,e)}is(e){return this.type===e}incrementTurnNumber(){this.set({turnNumber:this.turnNumber+1})}}t.CurrentPhaseModel=l},3579:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.mergeTransactions=t.CoinTransactionBuilder=void 0;const n=i(73735),a=i(73508),o=i(52163),r=i(9332),c=i(23803),l=s(i(96486));function d(){return{consume:0,send:{},spawn:0}}t.CoinTransactionBuilder=class{constructor(){this.data={}}from(e){return this.currentHex=e,this}spawn(e){return o.assert.defined(this.currentHex,"no hex selected"),(0,n.getOrCreate)(this.data,this.currentHex.id,d).spawn+=e,this.currentAmount=e,this}send(e,t=this.currentAmount){o.assert.defined(this.currentHex,"no hex selected"),o.assert.defined(t,"amount not specified");const i=(0,n.getOrCreate)(this.data,this.currentHex.id,d);return i.send[e.id]=(i.send[e.id]||0)+t,this.currentHex=e,this.currentAmount=t,this}consume(e=this.currentAmount){return o.assert.defined(e,"amount not specified"),o.assert.defined(this.currentHex,"no hex selected"),(0,n.getOrCreate)(this.data,this.currentHex.id,d).consume+=e,this}getTransactions(){return this.data}reset(){this.currentHex=void 0,this.currentAmount=void 0,this.data={}}apply(e){return function(e,t){const i={};Object.entries(t).forEach((([e,t])=>{i[e]=i[e]||0,i[e]+=t.spawn,i[e]-=t.consume,Object.entries(t.send).forEach((([t,s])=>{i[e]-=s,i[t]=(i[t]||0)+s}))}));const s=r.Pawns.model(e);return Object.entries(i).forEach((([e,t])=>{const i=(0,c.getHex)(Number(e));o.assert.defined(i),s.adjustCount(i,a.PawnType.Coins,t)})),s.state}(e,this.getTransactions())}},t.mergeTransactions=function(e,t){const i=l.default.cloneDeep(e);for(const e of Object.keys(t)){const s=Number(e),n=t[s];if(i[s]){i[s].consume+=n.consume;for(const e of Object.keys(n.send)){const t=Number(e);i[s].send[t]=(i[s].send[t]||0)+n.send[t]}i[s].spawn+=n.spawn}else i[s]=n}return i}},87832:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Economy=t.EMPTY_BUDGET=void 0;const o=i(98697),r=i(85044),c=i(92940),l=i(3579),d=i(35171),h=i(30634),u=i(9332),g=i(16115),p=i(62199),m=i(19228),y=i(71203),f=a(i(35369)),w=p.logger.for("Economy");t.EMPTY_BUDGET={balance:0,upkeep:0,incomeFromHexes:0};class b{static model(e){return e===y.inject.currentGameState?this._model:(this._readOnlyModel.lockToState(e),this._readOnlyModel)}static getTownHexesByRegion(e,t){return(0,r.selectFromState)(e,o.GameState.economy.townsByRegion,t)||f.Set()}static getBaseIncomePerHex(e){return h.Rules.getEconomyRules(e).baseIncomePerTile}static getIncomeFromHex(e,t){return u.Pawns.model(e).byHex(t).find((e=>e.hasTrait(c.PawnTraits.NegatesTileIncome)))?0:this.getBaseIncomePerHex(e)}static getTreasuryOf(e,t){return(0,r.selectFromState)(e,o.GameState.economy.treasuryByRegion,t)||0}static getNumberOfCoinsAt(e,t){return(0,r.selectFromState)(e,o.GameState.economy.coinsByHex,t)||0}static payForNewPawn(e,t,i){return this.payToHex(e,t,h.Rules.getPawnRules(e,i)?.cost||0)}static payToHex(e,t,i,s=new l.CoinTransactionBuilder){const n=g.Regions.model(e).byHex(t);let a=i;s.from(t).consume(i);let o=new Set;for(;a>0;){const r=n.hexes.findClosest(t,(t=>!o.has(t)&&b.getNumberOfCoinsAt(e,t.id)>0));if(!r)throw new Error(`Unable to find enough gold to pay ${i}g to hex ${t} in region ${n}`);const c=b.getNumberOfCoinsAt(e,r.id),l=Math.min(c,a);a-=l,o.add(r),s.from(r).send(t,l)}return s}static loot(e,t,i,s=new l.CoinTransactionBuilder){const n=new l.CoinTransactionBuilder,a=b.getTownHexesByRegion(e,i.id),o=d.HexGroup.from([...i.hexes.members,t]).findClosest(t,(e=>e!==t&&a.includes(e.id)));return o?n.from(t).send(o,this.getNumberOfCoinsAt(e,t.id)):(w.warning(`did not find any town in ${i} that could receive loot from ${t}, the money will just disappear`),n.from(t).consume(this.getNumberOfCoinsAt(e,t.id))),n}static getRegionBudget(e,i){return(0,r.selectFromState)(e,o.GameState.economy.budgetByRegion,i)||t.EMPTY_BUDGET}}t.Economy=b,b._model=new m.EconomyModel,b._readOnlyModel=new m.EconomyModel},19228:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EconomyModel=void 0;const s=i(85044),n=i(31439),a=i(92940),o=i(30634),r=i(9332),c=i(62199),l=i(87832),d=i(78311),h=i(23803),u=i(98697);c.logger.for("EconomyModel");class g extends d.BaseModel{townHexesOf(e){const t=l.Economy.getTownHexesByRegion(this.state,e.id);return(0,h.getHexes)(t.toArray())}nearestTownHexFrom(e){const t=(0,s.selectFromState)(this.state,u.GameState.economy.nearestTown,e.id)?.rootId;if(t)return(0,h.getHex)(t)}baseIncomePerHex(){return o.Rules.getEconomyRules(this.state).baseIncomePerTile}incomeFromHex(e){return r.Pawns.model(this.state).byHex(e).find((e=>e.hasTrait(a.PawnTraits.NegatesTileIncome)))?0:l.Economy.getBaseIncomePerHex(this.state)}gatherRegionIncome(e){return new n.RegionEconomyCalculator(e).run({gatherIncome:!0,payUpkeep:!1})}payUnitUpkeep(e){return new n.RegionEconomyCalculator(e).run({gatherIncome:!1,payUpkeep:!0})}gatherIncomeAndPayUpkeep(e){return new n.RegionEconomyCalculator(e).run({gatherIncome:!0,payUpkeep:!0})}treasuryOf(e){return l.Economy.getTreasuryOf(this.state,e.id)}numberOfCoinsAt(e){return l.Economy.getNumberOfCoinsAt(this.state,e.id)}payForNewPawn(e,t){const i=l.Economy.payToHex(this.state,e,o.Rules.getPawnRules(this.state,t)?.cost||0);return i.apply(this.state),i.getTransactions()}payToHex(e,t,i){const s=l.Economy.payToHex(this.state,t,i);return s.apply(this.state),s.getTransactions()}loot(e,t){const i=l.Economy.loot(this.state,e,t);return i.apply(this.state),i.getTransactions()}budgetOf(e){return l.Economy.getRegionBudget(this.state,e.id)}}t.EconomyModel=g},31439:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionEconomyCalculator=void 0;const s=i(62199),n=i(3579),a=i(73508),o=i(52163),r=i(87832),c=i(23803),l=i(92940),d=i(24011),h=i(43360),u=i(71203),g=i(33376);s.logger.for("RegionEconomyCalculator"),t.RegionEconomyCalculator=class{constructor(e){this.region=e,this.sinks=[],this.builder=new n.CoinTransactionBuilder,this.model=u.inject.gameStateModel,this.worldUpdateBuilder=new g.WorldUpdateBuilder(this.model)}run({gatherIncome:e,payUpkeep:t}){this.allRegionHexes=this.region.hexes,this.builder.reset();const i=r.Economy.getTownHexesByRegion(this.model.state,this.region.id).toArray();if(this.townHexes=(0,c.getHexes)(i).members,this.goldByHex={},this.spawnGoldInTreasury(),e&&this.spawnIncome(),t)for(this.assembleSinks();this.sinks.length;){const e=this.sinks[0],t=this.allRegionHexes.findClosest(e.pawn.hex,(e=>(this.goldByHex[e.id]||0)>0));if(!t)break;{const i=this.goldByHex[t.id];i>e.demand?this.sendMoneyToSink(t,0,e.demand):this.sendMoneyToSink(t,0,i)}}return Object.entries(this.goldByHex).map((([e,t])=>({hexId:Number(e),remainingIncome:t}))).filter((({hexId:e})=>!i.includes(e))).forEach((({hexId:e,remainingIncome:t})=>{const i=(0,c.getHex)(e),s=this.model.economy.nearestTownHexFrom(i);s&&this.sendMoneyToTown(i,s,t)})),this.sinks.length>0&&(this.model.pawns.select({hexes:this.region.hexes,traits:[l.PawnTraits.Unit]}).forEach((e=>{this.worldUpdateBuilder.replace(e,a.PawnType.Bandit)})),0===this.townHexes.length&&this.model.pawns.select({hexes:this.region.hexes,type:[a.PawnType.Castle]}).forEach((e=>{const t=e.hex;this.worldUpdateBuilder.replace(e,a.PawnType.Camp),this.worldUpdateBuilder.captureHex(t,this.model.factions.byId(d.SpecialFaction.neutral))}))),this.builder.apply(this.model.state),{regionId:this.region.id,coinTransfers:this.builder.getTransactions(),worldUpdates:this.worldUpdateBuilder.getUpdates()}}assembleSinks(){this.model.pawns.select({hexes:this.region.hexes}).filter((e=>e.upkeep&&e.upkeep>0)).forEach((e=>{this.sinks.push({pawn:e,demand:e.upkeep})}))}sendMoneyToSink(e,t,i){const s=this.sinks[t];this.builder.from(e).send(s.pawn.hex,i).consume(),s.demand-=i,this.removeGoldFromHex(e,i),0===s.demand&&this.sinks.splice(t,1)}sendMoneyToTown(e,t,i){this.builder.from(e).send(t,i),this.removeGoldFromHex(e,i),this.addGoldToHex(t,i)}spawnIncome(){0!==this.townHexes.length&&(this.allRegionHexes.forEach((e=>{const t=this.model.economy.incomeFromHex(e.id);t>0&&(this.addGoldToHex(e,t),this.builder.from(e).spawn(t))})),this.evalBanditLooting())}spawnGoldInTreasury(){for(const e of this.townHexes)this.addGoldToHex(e,this.model.economy.numberOfCoinsAt(e)||0)}addGoldToHex(e,t){this.goldByHex[e.id]=(this.goldByHex[e.id]||0)+t}removeGoldFromHex(e,t){(0,o.assert)(this.goldByHex[e.id]>0),this.goldByHex[e.id]=this.goldByHex[e.id]-t,this.goldByHex[e.id]<=0&&delete this.goldByHex[e.id]}evalBanditLooting(){this.model.pawns.select({hexes:this.allRegionHexes,type:[a.PawnType.Bandit]}).map((e=>e.hex)).forEach((e=>{const t=(0,h.getOrCreateNearestCamp)(this.model,e,this.worldUpdateBuilder);t&&this.builder.from(e).spawn(1).send(t.hex)}))}}},84562:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionModel=void 0;const s=i(35171),n=i(58500),a=i(62199),o=i(72373),r=i(73508),c=i(52163),l=i(46299),d=i(16115),h=i(62072),u=i(73735),g=i(77296),p=i(59753),m=i(95077),y=i(24011),f=i(71203),w=i(33376);a.logger.for("FactionsModel");class b extends n.BaseEntityModel{constructor(){super(...arguments),this.getRegions=(0,h.lazyAdapter)({source:()=>l.Factions.getFactionRegions(this.state,this.id),transform:e=>e.map((e=>d.Regions.model(this.state).byId(e)))})}data(){return l.Factions.getData(this.state,this.id)}get exists(){return!!this.data()}get name(){return this.data()?.name||""}get themeIndex(){return this.data()?.themeIndex||0}get landColorLight(){return Phaser.Display.Color.IntegerToColor(this.landColor).lighten(10).color}get landColor(){return(p.THEMES[g.WorldMap.get(this.state).theme]||p.THEMES.default).colors[this.themeIndex]||13421772}get landColorDark(){return Phaser.Display.Color.IntegerToColor(this.landColor).darken(20).color}get controller(){return this.data()?.controller}get power(){return m.AI.getFactionPower(this.state,this.id)}get hexes(){return s.HexGroup.union(this.getRegions().map((e=>e.hexes)))}isAlive(){return this.controller!==r.FactionController.None&&this.getRegions().find((e=>e.isAlive()))}isLocalPlayer(){return this.controller===r.FactionController.LocalUser}isNeutral(){return this.id==y.SpecialFaction.neutral}getPawns(e){const t=(0,u.mergeArrays)(...this.getRegions().map((e=>e.getPawns())));return e?(0,o.filterPawns)(this.state,t,e):t}addNewRegion(e,t){const i=d.Regions.getNextId(this.state);return this.state=l.Factions.addNewRegion(this.state,this.id,e,t.toIdsArray()),d.Regions.model(this.state).byId(i)}disownRegions(...e){return this.state=l.Factions.disownRegions(this.state,...e.map((e=>e.id))),this}captureRegions(...e){return this.state=l.Factions.captureRegions(this.state,this.id,...e.map((e=>e.id))),this}captureHex(e,t){const i=d.Regions.model(this.state),n=this.parentModel,a=i.byHex(e),o=a?.id,r=!!a?.isAlive();if(a?.faction===this)return;let c=e.neighbours().map((e=>({region:i.byHex(e),faction:n.byHex(e)}))).filter((({region:e,faction:t})=>t===this)).map((({region:e,faction:t})=>e));c=(0,u.stripDuplicatesFrom)(c),t?c=c.filter((e=>e.id!==t.id)):(t=c.pop())||(t=this.addNewRegion(f.inject.random.townName(),e)),t.addHexes(e);let l=s.HexGroup.empty;const h=c.map((e=>e.id));c.length>0&&(l=s.HexGroup.union(c.map((e=>e.hexes))),t.absorbRegions(c));let g=[],p=s.HexGroup.empty;a?.faction&&(g=a.faction.splitRegionIfDisconnected(a),p=s.HexGroup.union(g.map((e=>e.hexes))));const m=r?[a,...g].filter((e=>!e?.isAlive())):[];return{type:w.UpdateType.HexCaptured,newFactionId:this.id,newRegionId:t.id,conqueredHex:e.id,connectedHexes:l.toIdsArray(),affectedHexes:s.HexGroup.union([e,l,p]).toIdsArray(),victimRegionId:o,victimRegionWasAlive:r,splitOffRegions:g.map((e=>e.id)),affectedRegions:[t.id,...[a?.id].filter((e=>e)),...h,...g.map((e=>e.id))],killedRegions:m.map((e=>e.id)),stateAfter:this.state}}ownsHex(e){return l.Factions.getByHex(this.state,e.id)===this.id}absorbOwnRegionsAdjacentTo(e){(0,c.assert)(this.ownsHex(e),`${e} is not owned by ${this}!`);const t=d.Regions.model(this.state),i=t.byHex(e);c.assert.defined(i);const s=Array.from(new Set(e.neighbours().map((e=>t.byHex(e))).filter((e=>e&&e!==i&&e.faction===this))));if(0===s.length)return[];const n=s.map((e=>({originalRegionId:e.id,hexes:e.hexes})));return i.absorbRegions(s),n}splitRegionIfDisconnected(e){const t=e.hexes.components(),i=[];if(t.length>1)for(t.popLargestGroup();t.length>0;){let e=t.popLargestGroup();i.push(this.addNewRegion(f.inject.random.townName(),e))}return i}setController(e){this.state=l.Factions.setController(this.state,this.id,e)}toString(){return`[Faction #${this.id} "${this.name}"]`}getLargestRegion(){const e=this.getRegions();if(0!==e.length)return e.reduce(((e,t)=>t.hexes.length>e.hexes.length?t:e))}setLandColor(e){p.THEMES[g.WorldMap.get(this.state).theme].colors[this.themeIndex]=e}fearOf(e){return m.AI.getFactionFear(this.state,this.id,e.id)}approvalOf(e){return m.AI.getFactionApproval(this.state,this.id,e.id)}attitudeTowards(e){return m.AI.getFactionAttitude(this.state,this.id,e.id)}mergeAdjacentRegions(){for(let e of this.getRegions()){let t=e.getNeighbours().filter((e=>e.faction===this));for(;t.length;)e.addHexes(s.HexGroup.union(t.map((e=>e.hexes)))),e.parentModel.destroy(...t),t=e.getNeighbours().filter((e=>e.faction===this))}}}t.FactionModel=b},46299:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionMutations=t.Factions=void 0;const s=i(98697),n=i(16115),a=i(73508),o=i(85044),r=i(6098),c=i(52163),l=i(71203);class d{static model(e){return e===l.inject.currentGameState?this._model:(this._readOnlyModel.lockToState(e),this._readOnlyModel)}static getAll(e){return(0,o.selectFromState)(e,s.GameState.factions.byId).keySeq().toArray()}static getData(e,t){return(0,o.selectFromState)(e,s.GameState.factions.byId,t)}static getByRegion(e,t){return(0,o.selectFromState)(e,s.GameState.factions.byRegion,t)}static getByHex(e,t){const i=n.Regions.getByHex(e,t);if(i)return d.getByRegion(e,i)}static getNextId(e){return(0,o.selectFromState)(e,s.GameState.factions.nextId)}static getFactionRegions(e,t){return(0,o.selectFromState)(e,s.GameState.factions.regions,t)?.toArray()||[]}static setThemeIndex(e,t,i){const n=d.getData(e,t);return c.assert.defined(n),(0,o.applyMutations)(e,s.GameState.factions.byId.createMutation({set:{[t]:{...n,themeIndex:i}}},"faction.setLandColor"))}static setController(e,t,i){const n=d.getData(e,t);return c.assert.defined(n),(0,o.applyMutations)(e,s.GameState.factions.byId.createMutation({set:{[t]:{...n,controller:i}}},"faction.setController"))}static createFaction(e,{name:t,regions:i,landColor:n,controller:r}){const c=this.getNextId(e),l={id:c,name:t,controller:r??a.FactionController.None,themeIndex:n??0};return(0,o.applyMutations)(e,s.GameState.factions.byId.createMutation({set:{[c]:l}},"createFaction"),h.captureRegions(c,i||[]))}static captureRegions(e,t,...i){return 0===i.length?e:(0,o.applyMutations)(e,h.captureRegions(t,i))}static addNewRegion(e,t,i,s){const a=n.Regions.getNextId(e);return(0,o.applyMutations)(e,n.RegionMutations.createRegion(a,i),n.RegionMutations.addHexesToRegion(a,s),h.captureRegions(t,[a]))}static disownRegions(e,...t){const i=t.filter((t=>void 0!==this.getByRegion(e,t)));return(0,o.applyMutations)(e,s.GameState.factions.byRegion.createMutation({delete:i},"faction.disownRegions"))}static getSameFactionNeighbours(e,t,i){const s=i??this.getByHex(e,t.id);return t.neighbours((t=>this.getByHex(e,t.id)===s))}}t.Factions=d,d._model=new r.FactionsDataSetModel,d._readOnlyModel=new r.FactionsDataSetModel;class h{static captureRegions(e,t){const i={};return t.forEach((t=>i[t]=e)),s.GameState.factions.byRegion.createMutation({set:i},"faction.captureRegions")}}t.FactionMutations=h},6098:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionsDataSetModel=void 0;const s=i(84562),n=i(46299),a=i(16115),o=i(78311),r=i(24011);class c extends o.BaseModel{constructor(){super(...arguments),this.factionModels={}}byId(e){let t=this.factionModels[e];if(t||(t=new s.FactionModel(this,e),this.factionModels[t.id]=t),t.exists)return t}get neutral(){return this.byId(r.SpecialFaction.neutral)}byRegion(e){const t=n.Factions.getByRegion(this.state,e.id);if(void 0!==t)return this.byId(t)}byHex(e){const t=a.Regions.getByHex(this.state,e.id);if(!t)return;const i=n.Factions.getByRegion(this.state,t);return void 0!==i?this.byId(i):void 0}nextId(){return n.Factions.getNextId(this.state)}all(){return n.Factions.getAll(this.state).map((e=>this.byId(e)))}create(e){const t=this.nextId();return this.state=n.Factions.createFaction(this.state,{...e,regions:e.regions?.map((e=>e.id))}),this.byId(t)}}t.FactionsDataSetModel=c},62072:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazyAdapter=void 0,t.lazyAdapter=function(e){let t,i;return()=>{const s=e.source();return void 0!==s&&s===i||(t=e.transform(s),i=s),t}}},72373:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.filterPawns=t.PawnModel=void 0;const s=i(58500),n=i(92940),a=i(9332),o=i(30634),r=i(16115),c=i(46299),l=i(2011),d=i(23803);class h extends s.BaseEntityModel{get exists(){return!!a.Pawns.getPawnData(this.state,this.id)}get name(){return a.Pawns.getPawnData(this.state,this.id)?.name||""}get type(){return a.Pawns.getPawnData(this.state,this.id).type}get count(){return a.Pawns.getPawnCount(this.state,this.id)||0}get traits(){return this.rules?.traits}get cost(){return this.rules?.cost}get upkeep(){return this.rules?.upkeep}get might(){return this.rules.might}get defense(){return this.rules.defense}get protection(){return this.hasTrait(n.PawnTraits.GuardsAdjacentTiles)?this.rules.defense:0}get rules(){return o.Rules.model(this.state).pawns(this.type)}get region(){return r.Regions.model(this.state).byHex(this.hex)}get faction(){return c.Factions.model(this.state).byHex(this.hex)}hasTrait(e){return this.traits.includes(e)}get hex(){return(0,d.getHex)(a.Pawns.getPawnHex(this.state,this.id))}replaceWith(e){const t=this.hex;return this.state=a.Pawns.replacePawn(this.state,this.id,e),this.parentModel.byHex(t,e)}isMovable(){return l.CurrentPhase.isMovable(this.state,this.id)}isInvincible(){return this.might>=10}moveTo(e){return this.state=a.Pawns.movePawn(this.state,this.id,e.id),this}setCount(e){return this.state=a.Pawns.setPawnCount(this.state,this.id,e),this}toString(){const e=this.type+(void 0!==this.count&&1!==this.count?`×${this.count}`:"");return`[Pawn #${this.id} (${e} at ${this.hex})]`}destroy(){this.parentModel.destroy(this)}}t.PawnModel=h,t.filterPawns=function(e,t,i){return i.type&&(t=t.filter((e=>i.type.includes(e.type)))),i.traits&&(t=t.filter((e=>i.traits.every((t=>e.hasTrait(t)))))),t}},9332:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnMutations=t.Pawns=void 0;const s=i(85044),n=i(98697),a=i(52163),o=i(73544),r=i(71203),c=i(23803);class l{static model(e){return e===r.inject.currentGameState?this._model:(this._readOnlyModel.lockToState(e),this._readOnlyModel)}static getPawnData(e,t){return(0,s.selectFromState)(e,n.GameState.pawns.byId,t)}static getPawnType(e,t){return this.getPawnData(e,t)?.type}static getPawnCount(e,t){return(0,s.selectFromState)(e,n.GameState.pawns.count,t)||0}static getByHex(e,t,i){return void 0===i?(0,s.selectFromState)(e,n.GameState.pawns.byHex,t)?.toArray()||[]:(0,s.selectFromState)(e,n.GameState.pawns.byHex,t)?.filter((t=>l.getPawnData(e,t)?.type===i)).first()}static getPawnHex(e,t){return(0,s.selectFromState)(e,n.GameState.pawns.hex,t)}static getByRegion(e,t){return(0,s.selectFromState)(e,n.GameState.pawns.byRegion,t)?.toArray()||[]}static getNextId(e){return(0,s.selectFromState)(e,n.GameState.pawns.nextId)}static getAll(e){return(0,s.selectFromState)(e,n.GameState.pawns.byId).keySeq().toArray()}static destroy(e,...t){return 0===t.length?e:(0,s.applyMutations)(e,...d.destroyPawns(t))}static create(e,t){return(0,s.applyMutations)(e,...d.createPawn(e,t))}static setPawnCount(e,t,i){return(0,a.assert)(i>=0,`attempt to set count of pawn #${t} to negative value (${i})`),(0,s.applyMutations)(e,...d.setPawnCount(t,i))}static replacePawn(e,t,i){const n=l.getPawnHex(e,t),o=l.getByHex(e,n,i),r={...l.getPawnData(e,t),type:i};return a.assert.undefined(o,`Cannot replace pawn ${t} with ${i}, pawn ${o} on the same hex already has this type`),(0,s.applyMutations)(e,...d.replacePawn(e,t,{...r,hex:(0,c.getHex)(n)}))}static movePawn(e,t,i){const a=this.getPawnData(e,t).type,o=l.getByHex(e,i,a);return o===t?e:o?(0,s.applyMutations)(e,...d.setPawnCount(t,this.getPawnCount(e,o)+1),...d.destroyPawns([o])):(0,s.applyMutations)(e,n.GameState.pawns.hex.createMutation({set:{[t]:i}},"pawn.moveTo"))}}t.Pawns=l,l._model=new o.PawnsDataSetModel,l._readOnlyModel=new o.PawnsDataSetModel;class d{static setPawnCount(e,t){return(0,a.assert)(t>=0,`attempt to set count of pawn #${e} to negative value (${t})`),0===t?this.destroyPawns([e]):[n.GameState.pawns.count.createMutation({set:{[e]:t}},"setPawnCount")]}static destroyPawns(e){return[n.GameState.pawns.count.createMutation({delete:e},"pawns.destroy"),n.GameState.pawns.hex.createMutation({delete:e},"pawns.destroy"),n.GameState.pawns.byId.createMutation({delete:e},"pawns.destroy")]}static createPawn(e,t){const i=l.getNextId(e),s={id:i,type:t.type,name:t.name};return[n.GameState.pawns.byId.createMutation({set:{[i]:s}},"pawns.create"),n.GameState.pawns.hex.createMutation({set:{[i]:t.hex.id}},"pawns.create"),n.GameState.pawns.count.createMutation({set:{[i]:t.count||1}},"pawns.create")]}static replacePawn(e,t,i){const s=l.getNextId(e),a={id:s,type:i.type,name:i.name};return[n.GameState.pawns.byId.createMutation({set:{[s]:a},delete:[t]},"pawns.replace"),n.GameState.pawns.hex.createMutation({set:{[s]:i.hex.id},delete:[t]},"pawns.replace"),n.GameState.pawns.count.createMutation({set:{[s]:i.count||1},delete:[t]},"pawns.replace")]}}t.PawnMutations=d},73544:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsDataSetModel=void 0;const s=i(73735),n=i(52163),a=i(72373),o=i(9332),r=i(78311),c=i(23803),l=i(77296);class d extends r.BaseModel{constructor(){super(...arguments),this.pawnModels={}}byId(e){let t=this.pawnModels[e];if(t||(t=new a.PawnModel(this,e),this.pawnModels[e]=t),t.exists)return t}byType(e,t){return this.select({hexes:e,type:[t]})}select(e){const t=e.hexes||l.WorldMap.getAllHexes(this.state);let i=(0,s.mergeArrays)(...t.map((e=>o.Pawns.getByHex(this.state,e.id)))).map((e=>this.byId(e)));return e.type&&(i=i.filter((t=>e.type.includes(t.type)))),e.traits&&(i=i.filter((t=>e.traits.every((e=>t.hasTrait(e)))))),void 0!==e.movable&&(i=i.filter((t=>t.isMovable()===e.movable))),i}findOne(e){return this.select(e)[0]}findClosest(e,t,i){let s;return t.bfsFrom(e,(e=>!s&&(s=this.byHex(e).filter(i)[0],!s))),s}byHex(e,t){return"number"==typeof e&&(e=(0,c.getHex)(e)),t?this.select({hexes:e,type:[t]})[0]:this.select({hexes:e})}byRegion(e){return o.Pawns.getByRegion(this.state,e.id).map((e=>this.byId(e)))}adjustCount(e,t,i){if(0===i)return;const s=this.byHex(e,t);s?s.setCount(s.count+i):((0,n.assert)(i>=0,`attempt to reduce ${t} count at ${e} below 0 (0-${-i}=${i})`),this.create({hex:e,type:t,count:i}))}setCount(e,t,i){const s=this.byHex(e,t);if(s)s.setCount(i);else{if(0===i)return;this.create({hex:e,type:t,count:i})}}presentAtHex(e,...t){return this.select({hexes:e,type:t.length>0?t:void 0}).length>0}nextId(){return o.Pawns.getNextId(this.state)}all(){return o.Pawns.getAll(this.state).map((e=>this.byId(e)))}create(e){const t=this.nextId();return this.state=o.Pawns.create(this.state,e),this.byId(t)}destroy(...e){this.state=o.Pawns.destroy(this.state,...e.map((e=>e.id)))}clear(){this.destroy(...this.all())}getCount(e,t){const i=this.byHex(e,t);return i?i.count:0}}t.PawnsDataSetModel=d},71249:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionModel=void 0;const s=i(35171),n=i(62072),a=i(73508),o=i(16115),r=i(46299),c=i(87832),l=i(95077),d=i(58500),h=i(9332),u=i(23803),g=i(89403),p=i(2011),m=i(73735),y=i(54053),f=i(76038);class w extends d.BaseEntityModel{constructor(){super(...arguments),this._hexes=(0,n.lazyAdapter)({source:()=>o.Regions.getRegionHexes(this.state,this.id),transform:e=>(0,u.getHexes)(e.toArray())}),this.getTownHexes=(0,n.lazyAdapter)({source:()=>c.Economy.getTownHexesByRegion(this.state,this.id),transform:e=>(0,u.getHexes)(e.toArray())}),this.getBorderHexes=(0,n.lazyAdapter)({source:()=>o.Regions.getRegionEdgeHexes(this.state,this.id),transform:e=>(0,u.getHexes)(e.toArray())}),this.getHostileBorderHexes=(0,n.lazyAdapter)({source:()=>o.Regions.getRegionBorderHexes(this.state,this.id),transform:e=>(0,u.getHexes)(e.toArray())}),this.getPawns=(0,n.lazyAdapter)({source:()=>h.Pawns.getByRegion(this.state,this.id),transform:e=>e.map((e=>h.Pawns.model(this.state).byId(e)))})}get name(){return o.Regions.getRegionData(this.state,this.id)?.name||""}get exists(){return!!o.Regions.getRegionData(this.state,this.id)}get hexes(){return this._hexes()}getNeighbours(){let e=new Set;for(let t of this.getHostileBorderHexes().neighbours().members){const i=this.parentModel.byHex(t);i&&e.add(i)}return e.delete(this),Array.from(e)}get faction(){const e=r.Factions.getByRegion(this.state,this.id);if(void 0!==e)return r.Factions.model(this.state).byId(e)}get budget(){return c.Economy.getRegionBudget(this.state,this.id)}get treasury(){return c.Economy.getTreasuryOf(this.state,this.id)}get size(){return o.Regions.getRegionHexes(this.state,this.id)?.size||0}getUnitsByMight(e=!1){return this.faction&&this.faction?.controller!==a.FactionController.None&&this.isAlive()?y.UnitsByMight.fromUnitList(g.Warfare.model(this.state).getUnitsByRegion(this).filter((t=>!e||p.CurrentPhase.isMovable(this.state,t.id))).map((e=>e.might)).sort(m.ascendingSortFn)):new y.UnitsByMight}getMovableUnitsByMight(){return this.getUnitsByMight(!0)}get power(){return l.AI.getRegionPower(this.state,this.id)}isAlive(){const e=r.Factions.getByRegion(this.state,this.id);if(!e)return!1;const t=r.Factions.getData(this.state,e);return!(!t.controller||t.controller===a.FactionController.None)&&0!==c.Economy.getTownHexesByRegion(this.state,this.id).size}isActionable(){return this.isAlive()&&(this.treasury>=10||p.CurrentPhase.model(this.state).getMovablePawns().find((e=>e.region===this)))}getLevel(){return(0,f.cropNumber)(this.power.maxObtainableUnitMight??1,1,4)}addHexes(e){return this.state=o.Regions.addHexesToRegion(this.state,this.id,e.toIdsArray()),this}removeHexes(e){return this.state=o.Regions.removeHexesFromRegion(this.state,e.toIdsArray()),this}absorbRegions(e){if(e.includes(this))throw new Error(`Invalid absorbRegion arguments - region ${this} cannot absorb itself`);return this.addHexes(s.HexGroup.union(e.map((e=>e.hexes)))),this.parentModel.destroy(...e),this}splitIntoComponents(){return o.Regions.splitRegionIntoComponents(this.state,this.id),this}toString(){return`[Region #${this.id} (${this.hexes.length}⬡)]`}}t.RegionModel=w},16115:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RegionMutations=t.Regions=void 0;const n=i(98697),a=s(i(35369)),o=i(46299),r=i(85044),c=i(25032),l=i(71203),d=i(52163),h=i(47181);class u{static model(e){return e===l.inject.currentGameState?this._model:(this._readOnlyModel.lockToState(e),this._readOnlyModel)}static getAll(e){return(0,r.selectFromState)(e,n.GameState.regions.byId).keySeq().toArray()}static getByHex(e,t){return(0,r.selectFromState)(e,n.GameState.regions.byHex,t)}static getRegionData(e,t){return(0,r.selectFromState)(e,n.GameState.regions.byId,t)}static getRegionHexes(e,t){return(0,r.selectFromState)(e,n.GameState.regions.hexes,t)||r.EMPTY_SET}static getRegionEdgeHexes(e,t){return(0,r.selectFromState)(e,n.GameState.regions.edgeHexes,t)||r.EMPTY_SET}static getRegionBorderHexes(e,t){return(0,r.selectFromState)(e,n.GameState.warfare.borderHexes,t)||r.EMPTY_SET}static destroyRegions(e,...t){if(0===t.length)return e;const i=a.default.Set.union(t.map((t=>u.getRegionHexes(e,t)))).toArray();return e=o.Factions.disownRegions(e,...t),e=(0,r.applyMutations)(e,n.GameState.regions.byHex.createMutation({delete:i},"destroyRegions"),n.GameState.regions.byId.createMutation({delete:t},"destroyRegions"),n.GameState.ai.attritionByRegion.createMutation({delete:t},"destroyRegions"))}static destroyAllEmptyRegions(e){const t=u.getAll(e).filter((t=>u.getRegionHexes(e,t).isEmpty()));return this.destroyRegions(e,...t)}static getSameRegionNeighbours(e,t){const i=this.getByHex(e,t.id);return t.neighbours((t=>this.getByHex(e,t.id)===i))}static getAdjacentForeignHexes(e,t){return this.model(e).byId(t).getHostileBorderHexes().neighbours().filter((i=>{const s=this.getByHex(e,i.id);return void 0!==s&&s!==t}))}static getNextId(e){return(0,r.selectFromState)(e,n.GameState.regions.nextId)}static createRegion(e,t,i){const s=u.getNextId(e),n=[g.createRegion(s,t)];return i&&n.push(g.addHexesToRegion(s,i)),(0,r.applyMutations)(e,...n)}static addHexesToRegion(e,t,i){const s=[g.addHexesToRegion(t,i)];return(0,r.applyMutations)(e,...s)}static removeHexesFromRegion(e,t){return(0,r.applyMutations)(e,n.GameState.regions.byHex.createMutation({delete:t},"removeHexesFromRegion"))}static splitRegionIntoComponents(e,t){const i=this.model(e).byId(t),s=o.Factions.getByRegion(e,t);d.assert.defined(i,`no region found for id ${t}`);const a=i.hexes.components(),c=a.getLargestGroupKey();if(!c)return;a.removeGroup(c);const g=new h.MapMutationBuilder(n.GameState.regions.byId).init(e),p=new h.MapMutationBuilder(n.GameState.regions.byHex).init(e),m=new h.MapMutationBuilder(n.GameState.factions.byRegion).init(e);let y=u.getNextId(e);return a.forEach((e=>{g.set(y,{id:y,name:l.inject.random.townName()}),p.setAll(Array.from(e).map((e=>e.id)),y),void 0!==s&&m.set(y,s),y++})),(0,r.applyMutations)(e,p.createMutation("regions.splitRegionIntoComponents"),g.createMutation("regions.splitRegionIntoComponents"),m.createMutation("regions.splitRegionIntoComponents"))}}t.Regions=u,u._model=new c.RegionsDataSetModel,u._readOnlyModel=new c.RegionsDataSetModel;class g{static createRegion(e,t){return n.GameState.regions.byId.createMutation({set:{[e]:{id:e,name:t}}},"createRegion")}static addHexesToRegion(e,t){const i={};return t.forEach((t=>{i[t]=e})),n.GameState.regions.byHex.createMutation({set:i},"addHexesToRegion")}}t.RegionMutations=g},25032:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionsDataSetModel=void 0;const s=i(85044),n=i(71249),a=i(98697),o=i(73735),r=i(35171),c=i(16115),l=i(78311);class d extends l.BaseModel{constructor(){super(...arguments),this.regionModels={}}all(){return(0,s.selectFromState)(this.state,a.GameState.regions.byId).keySeq().toArray().map((e=>this.byId(e)))}byHex(e){let t="number"==typeof e?e:e.id;const i=c.Regions.getByHex(this.state,t);return i?this.byId(i):void 0}byId(e){if(c.Regions.getRegionData(this.state,e))return(0,o.getOrCreate)(this.regionModels,e,(()=>new n.RegionModel(this,e)))}nextId(){return(0,s.selectFromState)(this.state,a.GameState.regions.nextId)}create(e,t=r.HexGroup.empty){const i=this.nextId();return this.state=c.Regions.createRegion(this.state,e,t.toIdsArray()),this.byId(i)}destroy(...e){this.state=c.Regions.destroyRegions(this.state,...e.map((e=>e.id)))}clear(){this.destroy(...this.all())}}t.RegionsDataSetModel=d},30634:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rules=void 0;const s=i(98697),n=i(67966),a=i(92940),o=i(11979),r=i(85044),c=i(9332);class l{static get(e){return(0,r.selectFromState)(e,s.GameState.ruleSet)}static model(e){const t=this.get(e);return this.modelFactory.getOrCreateFor(t)}static getEconomyRules(e){return l.get(e).economy}static getPawnRules(e,t){return(0,r.selectFromState)(e,s.GameState.ruleSet).pawns[t]}static getPawnCost(e,t){return this.getPawnRules(e,t).cost||0}static getMergeResult(e,t,i){const s=c.Pawns.model(e).select({hexes:t,traits:[a.PawnTraits.OccupiesTile]})[0];if(!s)return i;const n=this.model(e).pawns(s.type).mergeRules;return n&&n[i]}}t.Rules=l,l.modelFactory=new o.FactoryWithCache((e=>new n.RulesModel(e)))},67966:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RulesModel=t.PawnTypeRulesModel=void 0;const s=i(92940);class n{constructor(e,t){this.pawnRules=e,this.type=t}get state(){return this.pawnRules}get cost(){return this.state?.cost||0}get upkeep(){return this.state?.upkeep||0}get defense(){return this.state?.defense||0}get might(){return this.state?.might||0}get traits(){return this.state?.traits||[]}get mergeRules(){return this.state?.merge||{}}isInvincible(){return this.might>=10}hasTrait(e){return this.traits.includes(e)}toString(){return`[PawnType ${this.type}]`}}t.PawnTypeRulesModel=n,t.RulesModel=class{constructor(e){this.rules=e,this.pawnModels={},this.unitsByMight={},this.castlesByMight={},this.getAllPawnTypes().forEach((e=>{e.hasTrait(s.PawnTraits.Unit)&&e.might&&(this.unitsByMight[e.might]=e),e.hasTrait(s.PawnTraits.Building)&&e.cost&&e.defense&&(this.castlesByMight[e.defense]=e)}))}get economy(){return this.state.economy}get state(){return this.rules}pawns(e){let t=this.pawnModels[e];return t||(t=new n(this.state.pawns[e],e),this.pawnModels[e]=t),t}unitByMight(e){return this.unitsByMight[e]}castleByMight(e){return this.castlesByMight[e]}getAllPawnTypes(){return Object.keys(this.state.pawns).map((e=>this.pawns(e)))}getPawnTypesByTrait(e){this.getAllPawnTypes().filter((t=>t.hasTrait(e)))}}},89403:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Warfare=t.InvalidDropPawnReason=t.DropPawnResultType=void 0;const s=i(92940),n=i(73508),a=i(98697),o=i(1951),r=i(85044),c=i(30634),l=i(16115),d=i(9332),h=i(73735),u=i(71203),g=i(54797),p=i(23803);var m,y;(y=t.DropPawnResultType||(t.DropPawnResultType={})).Invalid="invalid",y.Reposition="reposition",y.Conquest="conquest",y.Combine="combine",y.EradicatePest="eradicate-pest",(m=t.InvalidDropPawnReason||(t.InvalidDropPawnReason={})).PreventedByPawn="prevented-by-pawn",m.OutOfRange="out-of-range",m.InvalidRegion="invalid-region";class f{static model(e){return e===u.inject.currentGameState?this._model:(this._readOnlyModel.lockToState(e),this._readOnlyModel)}static getConquerableHexes(e,t,i){let a;if("number"==typeof i)a=i;else{const t=c.Rules.model(e).pawns(i);a=t.hasTrait(s.PawnTraits.Unit)?t.might:0}const o=d.Pawns.getByRegion(e,t).filter((t=>d.Pawns.getPawnType(e,t)===n.PawnType.Bandit)).map((t=>(0,p.getHex)(d.Pawns.getPawnHex(e,t))));return l.Regions.getAdjacentForeignHexes(e,t).filter((t=>this.getHexDefense(e,t)<a)).with(...o)}static getHexDefense(e,t){return(0,r.selectFromState)(e,a.GameState.warfare.hexDefense,t.id)||0}static getHexStaticDefense(e,t){return(0,r.selectFromState)(e,a.GameState.warfare.hexStaticDefense,t.id)||0}static getHexDefenseAsIfOwnedBy(e,t,i){const s=this.getHexLocalDefense(e,t.id);return t.neighbours((t=>l.Regions.getByHex(e,t.id)===i)).map((t=>this.getHexProjectedDefense(e,t.id))).reduce(o.max,s)}static getHexLocalDefense(e,t){return(0,r.selectFromState)(e,a.GameState.warfare.hexDefenseSources,t)?.totalDefense||0}static getHexLocalStaticDefense(e,t){return(0,r.selectFromState)(e,a.GameState.warfare.hexDefenseSources,t)?.buildingDefense||0}static getHexProjectedDefense(e,t){return(0,r.selectFromState)(e,a.GameState.warfare.hexDefenseSources,t)?.totalProtection||0}static getHexProjectedStaticDefense(e,t){const i=(0,r.selectFromState)(e,a.GameState.warfare.hexDefenseSources,t);return i?i.buildingProtection:0}static getHexDefenders(e,t,i=1){const n=d.Pawns.model(e),a=l.Regions.getSameRegionNeighbours(e,t);return[...n.byHex(t),...n.select({hexes:a,traits:[s.PawnTraits.GuardsAdjacentTiles]})].filter((e=>e.defense>=i))}static canConquerHexWith(e,t,i){const s=c.Rules.model(e).pawns(i).might;return void 0!==l.Regions.getByHex(e,t.id)&&this.getHexDefense(e,t)<s}static getOccupyingUnit(e,t){return d.Pawns.model(e).findOne({hexes:t,traits:[s.PawnTraits.OccupiesTile]})}static getUnitsByRegion(e,...t){return(0,h.mergeArrays)(...t.map((t=>d.Pawns.getByRegion(e,t).filter((t=>f.isUnit(e,t)))||[])))}static isUnit(e,t){return d.Pawns.model(e).byId(t)?.hasTrait(s.PawnTraits.Unit)}}t.Warfare=f,f._model=new g.WarfareModel,f._readOnlyModel=new g.WarfareModel},54797:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WarfareModel=void 0;const s=i(78311),n=i(30634),a=i(92940),o=i(16115),r=i(9332),c=i(89403),l=i(35171);class d extends s.BaseModel{getUnitsByRegion(e){const t=r.Pawns.model(this.state);return c.Warfare.getUnitsByRegion(this.state,e.id).map((e=>t.byId(e)))}getConquerableHexes(e,t){return 0===t?l.HexGroup.empty:c.Warfare.getConquerableHexes(this.state,e.id,t)}getHexLocalDefense(e){return c.Warfare.getHexLocalDefense(this.state,e.id)}getHexDefenders(e,t=1){return c.Warfare.getHexDefenders(this.state,e,t)}getHexDefense(e){return c.Warfare.getHexDefense(this.state,e)}getHexStaticDefense(e){return c.Warfare.getHexStaticDefense(this.state,e)}canConquerHexWith(e,t){return c.Warfare.canConquerHexWith(this.state,e,t)}getMergeResult(e,t){return n.Rules.getMergeResult(this.state,e,t)}isOccupied(e){return!!this.getOccupyingUnit(e)}isImpassable(e){return!o.Regions.getByHex(this.state,e.id)||!!this.getOccupyingUnit(e)?.isInvincible()}getOccupyingUnit(e){return c.Warfare.getOccupyingUnit(this.state,e)}getMightOf(e){return n.Rules.model(this.state).pawns(e).might}getDropPawnResult(e,t,i){const s=o.Regions.model(this.state),r=n.Rules.model(this.state),l=s.byHex(e);if(l?.id===i.id){const i=this.getOccupyingUnit(e);if(!i)return{type:c.DropPawnResultType.Reposition};if(i.hasTrait(a.PawnTraits.Pest))return r.pawns(t).hasTrait(a.PawnTraits.Unit)&&i.defense<this.getMightOf(t)?{type:c.DropPawnResultType.EradicatePest,pest:i}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:[i]};const s=r.pawns(i.type).mergeRules[t];return s?{type:c.DropPawnResultType.Combine,combineWith:i,combineInto:s}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:[i]}}return void 0===l||l.faction===i.faction?{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.InvalidRegion}:r.pawns(t).hasTrait(a.PawnTraits.Unit)?e.neighbours().find((e=>s.byHex(e)===i))?this.canConquerHexWith(e,t)?{type:c.DropPawnResultType.Conquest}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:this.getHexDefenders(e,r.pawns(t).might)}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.OutOfRange}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.InvalidRegion}}getRetreatDestination(e,t){const i=e.region;return i.hexes.neighboursOf(e.hex).filter((e=>!this.isOccupied(e))).findMax((e=>100*this.getHexStaticDefense(e)+i.hexes.neighboursOf(e).length))}}t.WarfareModel=d},77296:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMap=void 0;const s=i(23803),n=i(85044),a=i(98697),o=i(11979),r=i(53187);class c{static get(e){return(0,n.selectFromState)(e,a.GameState.map)}static getAllHexes(e){return s.HexGrid.getAllHexes(this.get(e))}static setTheme(e,t){const i=this.get(e);return(0,n.applyMutations)(e,a.GameState.map.createMutation({...i,theme:t},"setTheme"))}static model(e){const t=this.get(e);return this.modelFactory.getOrCreateFor(t)}}t.WorldMap=c,c.modelFactory=new o.FactoryWithCache((e=>new r.WorldMapModel(e)))},53187:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapModel=void 0;const s=i(23803);t.WorldMapModel=class{constructor(e){this.state=e,this.innerWidth=this.state.width-2,this.innerHeight=this.state.height-2,this.width=this.state.width,this.height=this.state.height}get theme(){return this.state.theme}get levelId(){return this.state.levelId}getAllHexes(){return s.HexGrid.getAllHexes(this.state)}getInnerHexes(){return s.HexGrid.getInnerHexes(this.state)}filter(e){return s.HexGrid.filter(e,this.state)}isWithinBounds(e){return s.HexGrid.isWithinBounds(e,this.state)}}},54934:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexDefenseUpdater=t.HexDefenseProjection=void 0;const n=i(47181),a=s(i(35369)),o=i(23803),r=i(85044),c=i(9332),l=i(1951),d=i(30833),h=i(16115),u=i(89403);class g extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new p(this).update}bootstrap(e){return a.default.Map().withMutations((t=>{(0,o.getHexes)((0,r.selectFromState)(e,this.sources.regionByHex).keySeq().toArray()).map((i=>{const s=this._calculate(e,i);s>0&&t.set(i.id,s)}))}))}_calculate(e,t){const i=u.Warfare.getHexLocalDefense(e,t.id);return h.Regions.getSameRegionNeighbours(e,t).map((t=>u.Warfare.getHexProjectedDefense(e,t.id))).reduce(l.max,i)}}t.HexDefenseProjection=g;class p extends d.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}initialize(){this.pawns=c.Pawns.model(this.newState),this.dirtyHexes=new Set}registerHandlers(e){e(this.dataSet.sources.hexDefenseSources,(e=>this._handleHexDefenseSourcesChanged(e))),e(this.dataSet.sources.regionByHex,(e=>this._handleRegionByHexChange(e)))}_handleHexDefenseSourcesChanged(e){e.updated?.forEach((([e,t])=>{const i=(0,o.getHex)(e);this.dirtyHexes.add(i),h.Regions.getSameRegionNeighbours(this.oldState,i).forEach((e=>this.dirtyHexes.add(e)))}))}_handleRegionByHexChange(e){e.updated?.forEach((([e,t])=>{const i=(0,o.getHex)(e);this.dirtyHexes.add(i),u.Warfare.getHexProjectedDefense(this.oldState,e)>0&&(h.Regions.getSameRegionNeighbours(this.oldState,i).forEach((e=>this.dirtyHexes.add(e))),h.Regions.getSameRegionNeighbours(this.newState,i).forEach((e=>this.dirtyHexes.add(e))))}))}createMutation(){return this.dirtyHexes.forEach((e=>{const t=this.dataSet._calculate(this.newState,e);t>0?this.builder.set(e.id,t):this.builder.delete(e.id)})),super.createMutation()}}t.HexDefenseUpdater=p},47571:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexDefenseSourcesProjection=t.NO_DEFENSE=void 0;const n=i(47181),a=s(i(35369)),o=i(23803),r=i(92940),c=i(85044),l=i(2011),d=i(9332),h=i(1951),u=i(30833),g=i(52163),p=i(1157);t.NO_DEFENSE=Object.freeze({unitDefense:0,buildingDefense:0,unitProtection:0,buildingProtection:0,totalDefense:0,totalProtection:0});class m extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.eager=!1,this.update=new y(this).update}bootstrap(e){return a.default.Map().withMutations((t=>{(0,o.getHexes)((0,c.selectFromState)(e,this.sources.regionByHex).keySeq().toArray()).forEach((i=>{const s=this._calculate(e,i);s.totalDefense>0&&t.set(i.id,s)}))}))}_calculate(e,t){const i=d.Pawns.model(e).byHex(t).filter((t=>!l.CurrentPhase.isMovable(e,t.id))),s=i.find((e=>e.hasTrait(r.PawnTraits.Unit))),n=i.find((e=>e.hasTrait(r.PawnTraits.Building))),a=i.find((e=>e.hasTrait(r.PawnTraits.OccupiesTile))),o=s?.defense||0,c=s?.protection||0,u=n?.defense||0,g=n?.protection||0;return{unitDefense:o,unitProtection:c,buildingDefense:u,buildingProtection:g,totalDefense:Math.max(o,u,a?.defense||0),totalProtection:(0,h.max)(c,g)}}entryToString(e){return`${e.totalDefense}${e.buildingDefense>0?p.GLYPH.whiteFlag:""}`}}t.HexDefenseSourcesProjection=m;class y extends u.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}initialize(){this.pawns=d.Pawns.model(this.newState),this.dirtyHexes=new Set}registerHandlers(e){e(this.dataSet.sources.pawnsByHex,(e=>this._handlePawnsByHexChange(e))),e(this.dataSet.sources.movableUnits,(e=>this._handleMovableUnitsChange(e)))}createMutation(){return this.dirtyHexes.forEach((e=>{const t=this.dataSet._calculate(this.newState,e);t.unitDefense||t.buildingDefense?this.builder.set(e.id,t):this.builder.delete(e.id)})),super.createMutation()}invalidate(e){g.assert.defined(e,"attempted to add undefined into dirtyHexes"),this.dirtyHexes.add(e)}_handlePawnsByHexChange(e){e.updated?.forEach((e=>{e.removed?this.invalidate((0,o.getHex)(e.id)):e.added&&this._addDefenders(e.added)}))}_handleMovableUnitsChange(e){if(e.cleared){const e=l.CurrentPhase.getMovableUnits(this.oldState);this._addDefenders(e)}e.addedEntries?.forEach((e=>{const t=this.pawns.byId(e)?.hex;this.invalidate(t)})),e.deletedEntries&&this._addDefenders(e.deletedEntries)}_addDefenders(e){e.forEach((e=>{const t=this.pawns.byId(e);if(!t||l.CurrentPhase.isMovable(this.newState,e))return;const i=this.pawns.byId(e)?.hex;if(!i)return;const s=this.builder.getCurrent(i.id);let n=s?.unitDefense||0,a=s?.unitProtection||0,o=s?.buildingDefense||0,c=s?.buildingProtection||0;const d=t.hasTrait(r.PawnTraits.OccupiesTile)?t.defense:0;t.hasTrait(r.PawnTraits.Unit)&&(n=t.defense,a=t.protection),t.hasTrait(r.PawnTraits.Building)&&(o=t.defense,c=t.protection),this.builder.set(i.id,{unitDefense:n,unitProtection:a,buildingDefense:o,buildingProtection:c,totalDefense:Math.max(n,o,d),totalProtection:(0,h.max)(a,c)})}))}}},71169:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexStaticDefenseProjection=void 0;const n=i(47181),a=s(i(35369)),o=i(23803),r=i(85044),c=i(1951),l=i(16115),d=i(89403),h=i(54934);class u extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new h.HexDefenseUpdater(this).update}bootstrap(e){return a.default.Map().withMutations((t=>{(0,o.getHexes)((0,r.selectFromState)(e,this.sources.regionByHex).keySeq().toArray()).map((i=>{const s=this._calculate(e,i);s>0&&t.set(i.id,s)}))}))}_calculate(e,t){const i=d.Warfare.getHexLocalStaticDefense(e,t.id);return l.Regions.getSameRegionNeighbours(e,t).map((t=>d.Warfare.getHexProjectedStaticDefense(e,t.id))).reduce(c.max,i)}}t.HexStaticDefenseProjection=u},61340:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexesByPawnTypeAndRegionProjection=void 0;const s=i(16001),n=i(9332);class a extends s.FilteredMultiMapProjection{constructor(e,t,i){super(e,i.pawnsByRegion),this.filteredPawnType=t,this.sources=i}constraint(e,t){return n.Pawns.getPawnType(e,t)===this.filteredPawnType}transform(e,t){return n.Pawns.getPawnHex(e,t)}}t.HexesByPawnTypeAndRegionProjection=a},1482:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MovableUnitsProjection=void 0;const n=s(i(35369)),a=i(73508),o=i(69158),r=i(85044);class c extends o.SetDataSet{constructor(e,t){super(e),this.key=e,this.sources=t,this.parents=Object.values(this.sources),this.builder=new o.SetDataSetMutationBuilder(this)}bootstrap(e){const t=(0,r.selectFromState)(e,this.sources.currentPhase);if(t.type!==a.PhaseTypes.FactionTurn)return n.default.Set();const i=(0,r.selectFromState)(e,this.sources.unitsByFaction,t.faction);return i&&0!==i.size?i.filter((t=>!this._isTapped(e,t))):n.default.Set()}update(e,t,i){this.builder.init(e);const s=t.of(this.sources.currentPhase);return s?(this._handleCurrentPhaseChange(e,s,i),this.builder.createMutation("phase changed")):(this._handleTappedUnitsChange(e,t.of(this.sources.currentPhaseTappedUnits),i),this._handleFactionUnitsChange(e,t.of(this.sources.unitsByFaction),i),this.builder.createMutation("units changed"))}_isTapped(e,t){return(0,r.selectFromState)(e,this.sources.currentPhaseTappedUnits).has(t)}_handleFactionUnitsChange(e,t,i){if(!t)return;const s=(0,r.selectFromState)(e,this.sources.currentPhase).faction;void 0!==s&&t.updated?.forEach((t=>{t.id===s&&(t.added&&this.builder.add(...t.added.filter((t=>!this._isTapped(e,t)))),t.removed&&this.builder.delete(...t.removed.filter((t=>!this._isTapped(e,t)))))}))}_handleTappedUnitsChange(e,t,i){if(t){if(t.cleared){this.builder.clear();const t=(0,r.selectFromState)(e,this.sources.currentPhase).faction;if(t){const i=(0,r.selectFromState)(e,this.sources.unitsByFaction,t);i&&this.builder.add(...i.toArray())}}t.addedEntries?.forEach((e=>this.builder.delete(e))),t.deletedEntries?.forEach((e=>{this.builder.add(e)}))}}_handleCurrentPhaseChange(e,t,i){if(t.type!==a.PhaseTypes.FactionTurn)this.builder.clear();else{this.builder.clear();const i=(0,r.selectFromState)(e,this.sources.unitsByFaction,t.faction);i&&this.builder.add(...i.toArray())}return this.builder.createMutation("currentPhaseChanged")}}t.MovableUnitsProjection=c},73916:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsByRegionUpdater=t.PawnsByRegionProjection=void 0;const n=i(73735),a=s(i(35369)),o=i(17653),r=i(52163),c=i(85044),l=i(30833),d=i(16115);class h extends o.MultiMapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new u(this),this.update=this.updater.update.bind(this)}bootstrap(e){const t=(0,c.selectFromState)(e,this.sources.pawnsByHex),i=[];(0,r.assert)(a.default.Map.isMap(t),`Invalid source ${this.sources.pawnsByHex.key} for ${this.key}`),(0,c.selectFromState)(e,this.sources.pawnsByHex);for(const[s,a]of t){const t=d.Regions.getByHex(e,s);t&&(0,n.pushIntoArrayByKey)(i,t,...a)}return s=i,a.default.Map().withMutations((e=>{for(let[t,i]of Object.entries(s))e.set(Number(t),a.default.Set(i))}));var s}}t.PawnsByRegionProjection=h;class u extends l.BaseUpdater{constructor(){super(...arguments),this.builder=new o.MultiMapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.pawnsHex,this._handlePawnsHexUpdate.bind(this)),e(this.dataSet.sources.regionsByHex,this._handleRegionsByHexUpdate.bind(this))}_handlePawnsHexUpdate(e){e.updated?.forEach((([e,t])=>{const i=(0,c.selectFromState)(this.oldState,this.dataSet.sources.pawnsHex,e),s=void 0!==t&&(0,c.selectFromState)(this.newState,this.dataSet.sources.regionsByHex,t);let n=void 0!==i&&(0,c.selectFromState)(this.oldState,this.dataSet.sources.regionsByHex,i);n!==s&&(n&&this.builder.remove(n,e),s&&this.builder.add(s,e))}))}_handleRegionsByHexUpdate(e){e.updated?.forEach((([e,t])=>{let i=(0,c.selectFromState)(this.oldState,this.dataSet.sources.regionsByHex,e),s=(0,c.selectFromState)(this.newState,this.dataSet.sources.pawnsByHex,e);s&&(i&&this.builder.remove(i,...s.toArray()),t&&this.builder.add(t,...s.toArray()))}))}}t.PawnsByRegionUpdater=u},76491:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionBorderHexesProjection=void 0;const s=i(17653),n=i(16115),a=i(85044),o=i(23803),r=i(35171),c=i(9332),l=i(92940);class d extends s.MultiMapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources)}bootstrap(e){return(0,a.selectFromState)(e,this.sources.regionsEdgeHexes).map(((t,i)=>t.filter((t=>h(e,t,i))))).filter((e=>e.size>0))}update(e,t,i){const a=new s.MultiMapMutationBuilder(this,e);return t.of(this.sources.regionsEdgeHexes)?.updated?.forEach((t=>{const i=t.id;if(t.added){const s=(0,o.getHexes)(t.added);(0,o.getHexes)(a.getCurrent(i).toArray()||[]),a.add(i,...t.added.filter((t=>h(e,t,i)))),s.forEach((t=>{t.neighbours((t=>void 0!==n.Regions.getByHex(e,t.id))).forEach((t=>{const s=n.Regions.getByHex(e,t.id);void 0!==s&&s!==i?a.add(s,t.id):h(e,t.id,i)||a.remove(i,t.id)}))}))}if(t.removed){a.remove(i,...t.removed);const s=(0,o.getHexes)(t.removed),c=r.HexGroup.fromIds(n.Regions.getRegionEdgeHexes(e,i).toArray());s.forEach((t=>{c.neighboursOf(t).forEach((t=>{n.Regions.getByHex(e,t.id)===i&&h(e,t.id,i)&&a.add(i,t.id)}))}))}})),a.createMutation("regionBorderChanged")}entryToString(e){return`[${e.size}]`}}function h(e,t,i){return!!(0,o.getHex)(t).findNeighbour((t=>{const s=n.Regions.getByHex(e,t.id);return void 0!==s&&s!==i&&!c.Pawns.model(e).findOne({hexes:t,traits:[l.PawnTraits.Impenetrable]})}))}t.RegionBorderHexesProjection=d},50666:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createBorderHexesDebugLayer=t.RegionEdgeHexesProjection=void 0;const n=s(i(35369)),a=i(23803),o=i(17653),r=i(16115),c=i(98697),l=i(85044),d=i(1157),h=i(52754),u=i(1522);class g extends o.MultiMapDataSet{constructor(e,t){super(e),this.regionsHexes=t,this.parents=[this.regionsHexes]}bootstrap(e){return n.default.Map().withMutations((t=>{r.Regions.model(e).all().forEach((i=>{const s=i.hexes.filter((t=>p(e,t,i.id))).map((e=>e.id));s.length&&t.set(i.id,n.default.Set(s))}))}))}update(e,t,i){const s=new o.MultiMapMutationBuilder(this,e);return t.require(this.regionsHexes).updated?.forEach((t=>{const i=t.id;t.added&&(0,a.getHexes)(t.added).forEach((t=>{const n=r.Regions.model(e).byId(i);p(e,t,i)&&s.add(i,t.id),n.hexes.neighboursOf(t).forEach((t=>{p(e,t,i)||s.remove(i,t.id)}))})),t.removed&&(s.remove(i,...t.removed),t.removed.forEach((t=>{const n=r.Regions.model(e).byId(i);n?n.hexes.neighboursOf((0,a.getHex)(t)).forEach((e=>{s.add(i,e.id)})):s.removeEntry(i)})))})),s.createMutation("regionsByHexChanged")}entryToString(e){return`[${e.size}]`}}function p(e,t,i){return!!t.findNeighbour((t=>r.Regions.getByHex(e,t.id)!==i))}t.RegionEdgeHexesProjection=g,t.createBorderHexesDebugLayer=function(){return new h.GameStateDebugLayer((0,u.hexBasedAdapter)({getValue(e,t){const i=r.Regions.getByHex(e,t);if(!i)return;const s=(0,l.selectFromState)(e,c.GameState.warfare.borderHexes,i)?.has(t),n=(0,l.selectFromState)(e,c.GameState.regions.edgeHexes,i)?.has(t);return s?d.GLYPH.redFlag:n?d.GLYPH.whiteFlag:""},getDetail(e,t){const i=r.Regions.getByHex(e,t);if(!i)return;const s=(0,l.selectFromState)(e,c.GameState.warfare.borderHexes,i)?.has(t),n=(0,l.selectFromState)(e,c.GameState.regions.edgeHexes,i)?.has(t);return`\nregion: ${i}\nborder: ${n?"YES":"NO"}\nhostile: ${s?"YES":"NO"}`}}))}},66873:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.UnitsByFactionUpdater=t.UnitsByFactionProjection=void 0;const n=s(i(35369)),a=i(17653),o=i(85044),r=i(30833),c=i(46299),l=i(89403);class d extends a.MultiMapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new h(this).update}bootstrap(e){const t=(0,o.selectFromState)(e,this.sources.factionRegions);return n.default.Map().withMutations((i=>{t.entrySeq().forEach((([t,s])=>{let a=n.default.Set(l.Warfare.getUnitsByRegion(e,...s.toArray()));a.isEmpty()||i.set(t,a)}))}))}}t.UnitsByFactionProjection=d;class h extends r.BaseUpdater{constructor(){super(...arguments),this.builder=new a.MultiMapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.factionRegions,this._handleFactionRegionsUpdate),e(this.dataSet.sources.pawnsByRegion,this._handlePawnsByRegionUpdate)}_handleFactionRegionsUpdate(e){e.updated?.forEach((e=>{e.removed&&this.builder.remove(e.id,...l.Warfare.getUnitsByRegion(this.newState,...e.removed)),e.added&&this.builder.add(e.id,...l.Warfare.getUnitsByRegion(this.newState,...e.added))}))}_handlePawnsByRegionUpdate(e){e.updated?.forEach((e=>{let t=c.Factions.getByRegion(this.newState,e.id);t&&e.removed&&this.builder.remove(t,...e.removed.filter((e=>l.Warfare.isUnit(this.oldState,e))))})),e.updated?.forEach((e=>{let t=c.Factions.getByRegion(this.newState,e.id);t&&e.added&&this.builder.add(t,...e.added.filter((e=>l.Warfare.isUnit(this.newState,e))))}))}}t.UnitsByFactionUpdater=h},74585:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexDepthUpdater=t.HexDepthProjection=void 0;const n=i(47181),a=s(i(35369)),o=s(i(54485)),r=i(16115),c=i(85044),l=i(30833),d=i(23803);class h extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new u(this).update.bind(this)}bootstrap(e){return a.default.Map().withMutations((t=>{(0,c.selectFromState)(e,this.sources.regionHexes).forEach(((i,s)=>{const n=r.Regions.model(e).byId(s);n.getHostileBorderHexes().length?n.hexes.bfsFrom(n.getHostileBorderHexes(),((e,i,s)=>(t.set(e.id,s+1),!0))):n.hexes.forEach((e=>t.set(e.id,1/0)))}))}))}}t.HexDepthProjection=h;class u extends l.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.borderHexes,this.handleHostileBorderHexesChanged.bind(this)),e(this.dataSet.sources.regionHexes,this.handleRegionHexesChanged.bind(this))}handleHostileBorderHexesChanged(e){e.updated?.forEach((e=>{const t=e.id,i=r.Regions.model(this.newState).byId(e.id);if(e.removed){const t=(0,d.getHexes)(e.removed),s=t.filter((e=>r.Regions.getByHex(this.newState,e.id)===i.id));this.updateDueToNewlyInternalHexes(i,s);const n=t.without(s);this.updateAfterHexesLost(i,n)}e.added&&r.Regions.getRegionBorderHexes(this.oldState,t).isEmpty()&&i.hexes.bfsFrom(i.getBorderHexes(),((e,t,i)=>(this.builder.set(e.id,i+1),!0)))}))}handleRegionHexesChanged(e){return e.updated?.forEach((e=>{const t=r.Regions.model(this.newState).byId(e.id);e.added,e.removed&&this.updateAfterHexesLost(t,(0,d.getHexes)(e.removed))})),this.builder.createMutation("regionHexes changed")}updateDueToNewlyInternalHexes(e,t){let i=new Set(t.members),s=new o.default(((e,t)=>e.candidateDepth-t.candidateDepth)),n=[...t.members];const a=r.Regions.getRegionBorderHexes(this.newState,e.id);for(;n.length;){let t=n.shift();for(let o of e.hexes.neighboursOf(t).members)if(!i.has(o))if(a.has(o.id))s.push({hex:t,candidateDepth:2});else{const a=this.dataSet.getEntryById(this.newState,o.id);this.hexCanJustifyDepth(this.newState,e,o,a,i)?s.push({hex:t,candidateDepth:a+1}):(n.push(o),i.add(o))}}for(i.forEach((e=>this.builder.delete(e.id)));!s.empty()&&i.size;){let t=s.pop();if(i.has(t.hex)){i.delete(t.hex),this.builder.set(t.hex.id,t.candidateDepth);for(let n of e.hexes.neighboursOf(t.hex).members)i.has(n)&&s.push({hex:n,candidateDepth:t.candidateDepth+1})}}i.forEach((e=>this.builder.set(e.id,1/0)))}updateAfterHexesLost(e,t){e.hexes.bfsFrom(t,((e,t,i)=>!t||(this.dataSet.getEntryById(this.newState,e.id)||1/0)>i&&(this.builder.set(e.id,i),!0)))}isForeignRegion(e,t,i){const s=r.Regions.getByHex(e,t);return void 0!==s&&s!==i}hexCanJustifyDepth(e,t,i,s,n){return 1===s?!!i.findNeighbour((i=>!n.has(i)&&this.isForeignRegion(e,i.id,t.id))):!!t.hexes.neighboursOf(i).find((t=>!n.has(t)&&this.dataSet.getEntryById(e,t.id)===s-1))}}t.HexDepthUpdater=u},16882:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexImportanceUpdater=t.HexImportanceProjection=t.TOWN_HEX_BASE_IMPORTANCE=t.NO_IMPORTANCE=void 0;const n=i(47181),a=s(i(35369)),o=s(i(54485)),r=i(5538),c=i(62199),l=i(1951),d=i(73508),h=i(16115),u=i(2011),g=i(87832),p=i(52163),m=i(9332),y=i(30833),f=i(23803);t.NO_IMPORTANCE=Object.freeze({distanceFromTown:1/0,value:0,factors:{fromConnectedHexes:0,fromTownProximity:0,fromHex:0},parents:[],connectivity:0}),c.logger.for("HexImportanceProjection"),t.TOWN_HEX_BASE_IMPORTANCE=40;class w extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new b(this).update}bootstrap(e){const t=new b(this);return t.initFromState(e),h.Regions.getAll(e).filter((t=>h.Regions.model(e).byId(t).isAlive())).forEach((e=>t.invalidateRegion(e))),t.getMap()}entryToString(e){return e.value.toString()}entryToDebugString(e){return(0,r.prettyPrintObject)(e)}}t.HexImportanceProjection=w;class b extends y.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.invalidatedRegions=new Set,this.roots=new Map,this.regionId=-1,this}registerHandlers(e){e(this.dataSet.sources.townsByRegion,this.handleTownsByRegionChange),e(this.dataSet.sources.regionsHexes,this.handleRegionsHexesChange),e(this.dataSet.sources.pawnsValueByHex,this.handleHexValueChanged),e(this.dataSet.sources.coinsByHex,this.handleHexValueChanged)}handleTownsByRegionChange(e){e.updated?.forEach((e=>{this.invalidateRegion(e.id)}))}handleRegionsHexesChange(e){e.updated?.forEach((e=>{const t=e.id;e.added?.forEach((e=>{const i=(0,f.getHex)(e);this.invalidateAfterCapturedHex(i,t)})),e.removed?.forEach((e=>{const i=(0,f.getHex)(e);this.invalidateAfterCapturedHex(i,t)}))}))}handleHexValueChanged(e){const t=new Set;e.updated?.forEach((([e,i])=>{t.add(e)}));for(let e of t){const t=h.Regions.getByHex(this.newState,e);t&&!this.invalidatedRegions.has(t)&&(this.setRegion(t),this.region.isAlive()&&this.invalidateHexAndParents((0,f.getHex)(e)))}}createMutation(){return this.updateInvalidated(),super.createMutation()}setRegion(e){e!==this.regionId&&(this.regionId=e,this.region=h.Regions.model(this.newState).byId(this.regionId),p.assert.defined(this.region,`no region matched for id ${this.regionId}`))}invalidateAfterCapturedHex(e,t){if(this.setRegion(t),!this.region.isAlive())return;this.invalidateHex(e);let i=this.region.hexes.neighboursOf(e);i.forEach((e=>{this.invalidateHex(e),this.findNewParents(e).parents.forEach((e=>{this.invalidateHexAndParents(e)}))})),i.forEach((e=>{this.invalidatePotentialChildren(e)}))}invalidateHex(e){this.invalidatedHexes.has(e)||(this.invalidatedHexes.add(e),m.Pawns.getByHex(this.newState,e.id,d.PawnType.Town)&&this.addRoot(e))}findNewParents(e){p.assert.defined(this.region,`must first set region before calling findParents (called with ${e})`);let t=1/0,i=[];return this.region.hexes.neighboursOf(e).filter((e=>this.builder.has(e.id)||!this.isInvalidated(e))).forEach((e=>{const s=(this.builder.getCurrent(e.id)?.distanceFromTown??1/0)+(7-(this.builder.getCurrent(e.id)?.connectivity??0));s===t?i.push(e):s<t&&(t=s,i=[e])})),{parents:i,distance:t}}addRoot(e){const t=h.Regions.getByHex(this.newState,e.id),i=this.roots.get(t)||new Set;i.add(e),this.roots.set(t,i)}invalidateParents(e){let t=this.dataSet.getEntryById(this.newState,e.id)?.parents||[];0===t.length&&m.Pawns.getByHex(this.newState,e.id,d.PawnType.Town)&&this.addRoot(e),t.filter((e=>!this.isInvalidated(e))).forEach((e=>{this.invalidateHexAndParents(e)}))}invalidatePotentialParents(e){this.region.hexes.neighboursOf(e).filter((e=>!this.isInvalidated(e))).forEach((e=>{this.invalidateHexAndParents(e)}))}invalidateHexAndParents(e){this.invalidatedHexes.has(e)||(this.invalidateHex(e),this.invalidateParents(e))}invalidatePotentialChildren(e){if(this.invalidatedRegions.has(this.regionId))return;const t=this.dataSet.getEntryById(this.newState,e.id)?.distanceFromTown||0;this.region.hexes.neighboursOf(e).filter((e=>this.dataSet.getEntryById(this.newState,e.id)?.distanceFromTown>t)).forEach((e=>{this.invalidateHex(e),this.invalidatePotentialParents(e),this.invalidatePotentialChildren(e)}))}invalidateRegion(e){const i=h.Regions.model(this.newState).byId(e);if(i&&!this.invalidatedRegions.has(i.id))if(i.isAlive()){const t=g.Economy.getTownHexesByRegion(this.newState,e);this.invalidatedRegions.add(e),t.forEach((e=>this.addRoot((0,f.getHex)(e))))}else i.hexes.forEach((e=>this.builder.set(e.id,t.NO_IMPORTANCE)))}updateInvalidated(){for(let[e,t]of this.roots.entries())this.updateForRegion(e,t);this.invalidatedHexes.forEach((e=>this.builder.delete(e.id)))}updateForRegion(e,i){this.setRegion(e);const s=new Set,n=new Map,a=new Set,r=new o.default(((e,t)=>e.distance-t.distance));for(i.forEach((e=>r.push({hex:e,distance:0})));!r.empty();){const e=r.pop(),i=e.hex;if(a.has(i))continue;const o=this.getHexConnectivity(i);if(a.add(i),s.add(i),this.invalidatedHexes.delete(i),0===e.distance)this.builder.set(i.id,{connectivity:o,parents:[],value:0,distanceFromTown:0,factors:{fromHex:this.getHexBaseImportance(i),fromConnectedHexes:0,fromTownProximity:t.TOWN_HEX_BASE_IMPORTANCE}});else{let{parents:e,distance:a}=this.findNewParents(i);const r={connectivity:o,parents:e,distanceFromTown:a,value:0,factors:{fromHex:this.getHexBaseImportance(i),fromConnectedHexes:0,fromTownProximity:Math.floor(t.TOWN_HEX_BASE_IMPORTANCE/(a+1))}};this.builder.set(i.id,r),e.forEach((e=>{const t=(n.get(e)||0)+1;s.delete(e),n.set(e,t)}))}this.region.hexes.neighboursOf(i).filter((e=>(!this.builder.getCurrent(e.id)||this.isInvalidated(e))&&!a.has(e))).forEach((e=>{const t=this.builder.get(i.id);r.push({hex:e,distance:t.distanceFromTown+(7-t.connectivity)})}))}const c=Array.from(s);for(;c.length;){const e=c.pop(),t=this.builder.getCurrent(e.id),i=t.factors;this.addValueFromUnchangedChildren(e),i.fromConnectedHexes=Math.floor(i.fromConnectedHexes),t.value=i.fromHex+i.fromConnectedHexes+i.fromTownProximity,t.parents.forEach((t=>{const i=n.get(t)??0;0===i&&console.error(`${t} considered parent of ${e.id}, but his children count is ${i}`),i<=1&&c.push(t),n.set(t,(0,l.max)(0,i-1)),this.addValueToParent(e,t)}))}this.invalidatedRegions.delete(this.regionId)}isInvalidated(e){return!!this.invalidatedRegions.has(this.regionId)||this.invalidatedHexes.has(e)}addValueToParent(e,t){const i=this.builder.getCurrent(e.id),s=this.builder.getCurrent(t.id);p.assert.defined(s),p.assert.defined(i);const n=i.parents.length,a=(i.factors.fromHex+i.factors.fromConnectedHexes)/n;s.factors.fromConnectedHexes+=a}getHexConnectivity(e){return 6-e.neighbours((e=>{const t=h.Regions.getByHex(this.newState,e.id);return void 0!==t&&t!==this.regionId})).length}getHexBaseImportance(e){return Math.floor(m.Pawns.model(this.newState).byHex(e).filter((e=>!u.CurrentPhase.isMovable(this.newState,e.id))).map((e=>this.getValueOfPawn(e))).reduce(l.sum,1))}getValueOfPawn(e){return e.type===d.PawnType.Coins?e.count:e.rules.cost}getMap(){return this.updateInvalidated(),a.default.Map(this.builder.getEntries()).mapKeys((e=>Number(e)))}addValueFromUnchangedChildren(e){this.region.hexes.neighboursOf(e).filter((t=>!this.builder.get(t.id)&&!!this.dataSet.getEntryById(this.newState,t.id)?.parents.includes(e))).forEach((t=>this.addValueToParent(t,e)))}}t.HexImportanceUpdater=b},17981:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexPawnsCostUpdater=t.PawnsValueByHex=void 0;const n=i(47181),a=s(i(35369)),o=i(9332),r=i(30833),c=i(2011);class l extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new d(this).update}bootstrap(e){return a.default.Map().withMutations((t=>{o.Pawns.model(e).all().filter((e=>!e.isMovable())).forEach((e=>{t.update(e.hex.id,0,(t=>t+e.cost))}))}))}}t.PawnsValueByHex=l;class d extends r.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.pawnsHex,this.handlePawnsHexChanged),e(this.dataSet.sources.movableUnits,this.handleMovableUnitsChanged)}updateCost(e,t){if(0===t)return;const i=(this.builder.getCurrent(e)||0)+t;0===i?this.builder.delete(e):this.builder.set(e,i)}handlePawnsHexChanged(e){e.updated?.forEach((([e,t])=>{void 0!==o.Pawns.getPawnHex(this.oldState,e)&&this.subtractPawnCost(this.oldState,e),void 0!==t&&this.addPawnCost(this.newState,e)}))}handleMovableUnitsChanged(e){e.cleared&&c.CurrentPhase.getMovableUnits(this.oldState).forEach((e=>this.addPawnCost(this.newState,e))),e.addedEntries?.forEach((e=>{this.subtractPawnCost(this.oldState,e)})),e.deletedEntries?.forEach((e=>{this.addPawnCost(this.newState,e)}))}addPawnCost(e,t){const i=o.Pawns.getPawnHex(e,t),s=o.Pawns.model(e).byId(t);if(!s||s.isMovable())return;const n=s.cost||0;this.updateCost(i,n)}subtractPawnCost(e,t){const i=o.Pawns.getPawnHex(e,t),s=o.Pawns.model(e).byId(t);if(!s||s.isMovable())return;const n=s.cost||0;this.updateCost(i,-n)}}t.HexPawnsCostUpdater=d},51443:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.PowerByFactionUpdater=t.PowerByFactionProjection=void 0;const o=i(47181),r=a(i(35369)),c=i(30833),l=i(46299),d=i(1951),h=i(95077);i(62199).logger.for("PowerByFactionProjection");class u extends o.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new g(this).update}bootstrap(e){return r.Map().withMutations((t=>{l.Factions.model(e).all().forEach((i=>{const s=i.getRegions().map((t=>h.AI.getRegionPower(e,t.id).total)).reduce(d.sum,0);t.set(i.id,s)}))}))}}t.PowerByFactionProjection=u;class g extends c.BaseUpdater{constructor(){super(...arguments),this.builder=new o.MapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.factionRegions,this._handleFactionRegionsChanged),e(this.dataSet.sources.powerByRegion,this._handleRegionPowerChanged)}_handleFactionRegionsChanged(e){e.updated?.forEach((e=>{const t=e.id,i=(e.added?.map((e=>h.AI.getRegionPower(this.newState,e).total)).reduce(d.sum,0)||0)-(e.removed?.map((e=>h.AI.getRegionPower(this.oldState,e).total)).reduce(d.sum,0)||0);i&&this.builder.set(t,(this.builder.getCurrent(t)||0)+i)}))}_handleRegionPowerChanged(e){e.updated?.forEach((([e,t])=>{const i=l.Factions.getByRegion(this.oldState,e),s=h.AI.getRegionPower(this.oldState,e).total,n=t?.total||0,a=n-s;if(!i||!a||n===s)return;const o=this.builder.getCurrent(i)||0;this.builder.set(i,o+a)}))}}t.PowerByFactionUpdater=g},19655:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.PowerByRegionUpdater=t.PowerByRegionProjection=t.NO_REGION_POWER=void 0;const o=i(47181),r=a(i(35369)),c=i(5538),l=i(16115),d=i(67732),h=i(30833),u=i(62199),g=i(52163),p=i(76339),m=i(2011);u.logger.for("MightByRegionProjection"),t.NO_REGION_POWER={total:0,militaryPower:0,economicPower:0,totalMight:0,maxObtainableUnitMight:0,maxObtainableUnitCount:0,maxSustainableUnitMight:0};class y extends o.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new f(this).update}bootstrap(e){const t=new d.UnitSolver,i=l.Regions.model(e);return r.Map().withMutations((e=>{i.all().filter((e=>e.isAlive())).forEach((i=>{const s=this.calculateRegionPower(i,t);s.total>0&&e.set(i.id,s)}))}))}calculateRegionPower(e,i){if(!e?.isAlive())return t.NO_REGION_POWER;const s=e.getUnitsByMight(),n=e.budget,a=m.CurrentPhase.model(e.state).faction!==e.faction;g.assert.defined(n);const o={totalUnits:s,remainingUnits:s,remainingIncome:e.budget?.balance||0,remainingGold:e.treasury+(a&&e.budget?.balance||0)},r=i.estimateTotalMight(o),c=Math.floor(Math.pow(5*i.estimateTotalMight(o),1.1)),l=Math.floor(Math.pow(Math.max(0,n.incomeFromHexes),1.1)),d=c+l;i.economicStrategy=p.BALANCED_ECONOMIC_STRATEGY;const h=i.estimateTopAvailableMight(o);return i.economicStrategy=p.UNRESTRICTED_ECONOMIC_ADVISOR,{total:d,totalMight:r,militaryPower:c,economicPower:l,maxSustainableUnitMight:h,maxObtainableUnitMight:i.estimateTopAvailableMight(o),maxObtainableUnitCount:i.getObtainableUnitCount(o)}}entryToString(e){return`${e.militaryPower}+${e.economicPower}`}entryToDebugString(e){return(0,c.prettyPrintObject)({...e})}}t.PowerByRegionProjection=y;class f extends h.BaseUpdater{constructor(){super(...arguments),this.builder=new o.MapMutationBuilder(this.dataSet)}initialize(){this.invalidated=new Set}registerHandlers(e){e(this.dataSet.sources.budgetByRegion,this.handleRegionBudgetChange.bind(this)),e(this.dataSet.sources.pawnsByRegion,this.handlePawnsByRegionChange.bind(this)),e(this.dataSet.sources.treasuryByRegion,this.handleTreasuryByRegionChange.bind(this))}handleRegionBudgetChange(e){e.updated?.forEach((([e,t])=>{this.invalidated.add(e)}))}handlePawnsByRegionChange(e){e.updated?.forEach((e=>this.invalidated.add(e.id)))}handleTreasuryByRegionChange(e){e.updated?.forEach((([e,t])=>this.invalidated.add(e)))}createMutation(){const e=l.Regions.model(this.newState),t=new d.UnitSolver;return this.invalidated.forEach((i=>{const s=this.dataSet.calculateRegionPower(e.byId(i),t);s.total>0?this.builder.set(i,s):this.builder.delete(i)})),super.createMutation()}}t.PowerByRegionUpdater=f},99073:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createHexInfluenceDebugLayer=t.HexRegionInfluenceUpdater=t.InfluenceSpreadHeap=t.RegionInfluenceByHexProjection=void 0;const n=i(47181),a=s(i(35369)),o=s(i(54485)),r=i(16115),c=i(85044),l=i(30833),d=i(62199),h=i(46299),u=i(23803),g=i(89403),p=i(1157),m=i(98697),y=i(52163),f=i(52754),w=i(94632),b=i(24011),v=d.logger.for("RegionInfluenceByHexProjection");function S(e){switch(e){case 0:case 1:return 0;case 2:return 1;case 3:return 2;case 4:case 5:return 3;case 6:case 7:case 8:case 9:return 5;default:return 5*Math.floor(e/10)}}class P extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new x(this),this.update=this.updater.update}bootstrap(e){return this.updater.initFromState(e),r.Regions.getAll(e).forEach((t=>{r.Regions.getRegionHexes(e,t).size>=1&&this.updater.addSourcesFromRegion(t)})),this.updater.getMap()}entryToString(e){return e.size?`[${e.size}]`:""}entryToDebugString(e){return e.entrySeq().sort(((e,t)=>t[1].resistance-e[1].resistance)).map((([e,t])=>`from ${p.GLYPH.whiteFlag}${e} dist ${t.distance} resist ${t.resistance}`)).join("\n")}}t.RegionInfluenceByHexProjection=P;class T extends o.default{constructor(){super(((e,t)=>e.resistance-t.resistance))}}t.InfluenceSpreadHeap=T;class x extends l.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet),this.invalidation=new Map}createMutation(){return this.updateInvalidated(),super.createMutation()}addSourcesFromRegion(e){const t=r.Regions.getRegionBorderHexes(this.newState,e);for(const i of t)this.addRoot(e,(0,u.getHex)(i))}updateInvalidated(){for(const e of this.invalidation.keys())this.updateInvalidatedForRegion(e)}updateInvalidatedForRegion(e){const{roots:t,dirtyHexes:i}=this.getOrCreateInvalidationData(e),s=S(r.Regions.getRegionHexes(this.newState,e).size);this.updateInfluenceRange(e);const n=h.Factions.getByRegion(this.newState,e);if(void 0===n)return v.warning(`ignoring request to generate influence from region ${e}, it has no faction assigned`),void this.invalidation.delete(e);const a=new Set;for(const i of t.toArray())0===i.resistance&&this.updateInfluence(e,i.hex,null,0,0);for(const t of i)t.neighbours((e=>!i.has(e))).forEach((t=>{const i=this.builder.getCurrent(t.id)?.get(e);void 0!==i?.resistance&&this.addRoot(e,t,i.resistance,i.distance)}));for(;!t.empty();){const{hex:i,resistance:o,distance:c}=t.pop();a.add(i);const l=i.neighbours((t=>{if(a.has(t))return!1;const i=r.Regions.getByHex(this.newState,t.id);return void 0!==i&&i!==e}));for(let r of l.members){const l=o+this.getInfluenceSpreadResistance(n,r),d=this.builder.getCurrent(r.id)?.get(e)?.resistance??1/0;l<=s&&l<d&&(this.updateInfluence(e,r,i,l,c+1),a.add(r),t.push({hex:r,resistance:l,distance:c+1}))}}this.invalidation.delete(e)}getMap(){return this.updateInvalidated(),a.default.Map(this.builder.getEntries()).mapKeys((e=>Number(e)))}registerHandlers(e){e(this.dataSet.sources.borderHexes,this.handleRegionBorderChange),e(this.dataSet.sources.regionsByHex,this.handleHexRegionChanged),e(this.dataSet.sources.hexDefense,this.handleHexDefenseChanged)}handleRegionBorderChange(e){for(let t of e.updated||[]){const e=t.id;for(let i of t.added||[])this.addRoot(e,(0,u.getHex)(i));for(let i of t.removed||[])this.invalidateSource(e,(0,u.getHex)(i))}}invalidateSource(e,t){r.Regions.getByHex(this.newState,t.id)!==e&&this.markDirty(e,t);const i=this.builder.getCurrent(t.id)?.get(e);if(i){this.removeInfluence(t,e);for(const t of i.children)this.invalidateSource(e,t)}}getOrCreateInvalidationData(e){let t=this.invalidation.get(e);return t||(t={dirtyHexes:new Set,roots:new T},this.invalidation.set(e,t)),t}addRoot(e,t,i=0,s=0){this.getOrCreateInvalidationData(e).roots.push({hex:t,resistance:i,distance:s})}markDirty(e,t){this.getOrCreateInvalidationData(e).dirtyHexes.add(t)}getParentOf(e,t){return t.findNeighbour((i=>!!this.builder.getCurrent(i.id)?.get(e)?.children.includes(t)))}clearParent(e,t){const i=this.getParentOf(e,t);if(!i)return;const s=this.builder.getCurrent(i.id),n=s?.get(e)?.children||a.default.Set();this.builder.set(i.id,s.setIn([e,"children"],n.delete(t)))}updateInfluence(e,t,i,s,n){const o=this.builder.getCurrent(t.id)||a.default.Map();if(o.get(e)&&this.clearParent(e,t),this.builder.set(t.id,o.set(e,{children:a.default.Set(),resistance:s,distance:n})),i){const s=this.builder.getCurrent(i.id);y.assert.defined(s);const n=s.get(e)?.children||a.default.Set();this.builder.set(i.id,s.setIn([e,"children"],n.add(t)))}}removeInfluence(e,t){const i=this.builder.getCurrent(e.id);if(!i)return;this.clearParent(t,e);const s=i.delete(t);0===s.size?this.builder.delete(e.id):this.builder.set(e.id,s)}getInfluenceSpreadResistance(e,t){return e!==b.SpecialFaction.neutral&&h.Factions.getByHex(this.newState,t.id)===e?0:1+g.Warfare.getHexDefense(this.newState,t)}handleHexRegionChanged(e){for(let[t,i]of e.updated||[]){const e=(0,u.getHex)(t),s=r.Regions.getByHex(this.oldState,t),n=h.Factions.getByHex(this.oldState,t),o=h.Factions.getByHex(this.newState,t);if(s===i)return;let c;s?(this.getOrCreateInvalidationData(s),this.invalidateSource(s,e),c=this.builder.getCurrent(t)?.keySeq().filter((e=>{const t=h.Factions.getByRegion(this.newState,e);return t===o||t===n||void 0===o})).toArray()):c=e.neighbours().map((e=>this.builder.getCurrent(e.id)?.keySeq().toSet()||a.default.Set())).reduce(((e,t)=>t?.union(e))).toArray(),i&&this.getOrCreateInvalidationData(i),c?.forEach((t=>{this.invalidateSource(t,e)}))}}updateInfluenceRange(e){if(!this.oldState)return;const t=S(r.Regions.getRegionHexes(this.oldState,e).size),i=S(r.Regions.getRegionHexes(this.newState,e).size);i>t?this.addLeafsAsRoots(e):i<t&&this.cullInfluenceRange(e,i)}addLeafsAsRoots(e){let t=r.Regions.getRegionBorderHexes(this.oldState,e).toArray();for(;t.length>0;){const i=t.pop(),s=this.builder.getCurrent(i)?.get(e);s&&(this.addRoot(e,(0,u.getHex)(i),s.resistance,s.distance),s.children.size>0&&t.push(...s.children.toArray().map((e=>e.id))))}}cullInfluenceRange(e,t){let i=r.Regions.getRegionBorderHexes(this.oldState,e).toArray();for(;i.length>0;){const s=i.pop(),n=this.builder.getCurrent(s)?.get(e);n&&(n.resistance>t?this.removeSubTree(e,(0,u.getHex)(s)):i.push(...n.children.toArray().map((e=>e.id))))}}removeSubTree(e,t){const i=this.builder.getCurrent(t.id)?.get(e)?.children.toArray()||[];this.removeInfluence(t,e),i.forEach((t=>this.removeSubTree(e,t)))}handleHexDefenseChanged(e){for(let[t,i]of e.updated||[])this.invalidateForAllRegionsExceptOwner((0,u.getHex)(t))}invalidateForAllRegionsExceptOwner(e){const t=r.Regions.getByHex(this.newState,e.id),i=new Set(this.builder.getCurrent(e.id)?.keySeq().filter((e=>e!==t)));for(const s of e.neighbours().members)this.builder.getCurrent(s.id)?.keySeq().filter((e=>e!==t)).forEach((e=>i.add(e)));i?.forEach((t=>this.invalidateSource(t,e)))}}t.HexRegionInfluenceUpdater=x,t.createHexInfluenceDebugLayer=function(e){return new f.GameStateDebugLayer((0,w.dataSetAdapter)(m.GameState.ai.regionInfluenceByHex,{getValue:t=>t.get(e)?.resistance.toString(),arrowDataRetriever:(t,i)=>(0,c.selectFromState)(t,m.GameState.ai.regionInfluenceByHex,i)?.get(e)}))}},84820:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createFactionInfluenceDebugLayer=t.RegionInfluenceByRegionUpdater=t.RegionInfluenceByRegionProjection=void 0;const n=i(47181),a=s(i(35369)),o=i(16115),r=i(85044),c=i(30833),l=i(62199),d=i(95077),h=(i(23803),i(1157)),u=i(71203),g=i(14090),p=i(98697),m=i(55455),y=i(23169);l.logger.for("RegionInfluenceByRegionProjection");class f extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new b(this),this.update=this.updater.update}bootstrap(e){return this.updater.initFromState(e),a.default.Map().withMutations((t=>{for(const i of o.Regions.getAll(e))w(e,i).size>0&&t.set(i,w(e,i))}))}entryToString(e){return e.size?`[${e.size}]`:""}entryToDebugString(e){return e.entrySeq().sort((([e],[t])=>e-t)).map((([e,t])=>`${h.GLYPH.whiteFlag}${e}: ${t.total} (proximity ${t.proximity})`)).join("\n")}}function w(e,t){const i=o.Regions.getRegionHexes(e,t);return a.default.Map().withMutations((s=>{for(const n of i)for(const[i,a]of d.AI.getHexInfluence(e,n))i!==t&&s.update(i,{proximity:1/0,total:0},(e=>({proximity:Math.min(e.proximity,a.resistance),total:e.total+Math.floor(10/a.resistance)})));s.map((e=>({...e,total:Math.floor(e.total)}))).filter((e=>e.total>0))}))}t.RegionInfluenceByRegionProjection=f;class b extends c.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet),this.dirtyRegions=new Set}registerHandlers(e){e(this.dataSet.sources.regionHexes,this.handleRegionBorderChange),e(this.dataSet.sources.regionInfluenceByHex,this.handleHexRegionInfluenceChange)}initialize(){super.initialize(),this.dirtyRegions.clear()}createMutation(){return this.dirtyRegions.forEach((e=>{const t=w(this.newState,e);t.size>0?this.builder.set(e,t):this.builder.delete(e)})),super.createMutation()}handleRegionBorderChange(e){for(let t of e.updated||[]){const e=t.id;this.dirtyRegions.add(e)}}handleHexRegionInfluenceChange(e){for(let[t,i]of e.updated||[]){const e=o.Regions.getByHex(this.newState,t);e&&this.dirtyRegions.add(e)}}}t.RegionInfluenceByRegionUpdater=b,t.createFactionInfluenceDebugLayer=function(e){const t=u.inject.gameStateModel.stateEngine;let i=(0,g.signal)();return t.watchDataSet(p.GameState.ai.regionInfluenceByHex,(()=>{i.fire()})),{onChange:i,getMap:()=>new m.ProxyHexGroupValuation(new y.HexGroupValuationFromStateEngine(t,p.GameState.ai.regionInfluenceByHex),((t,i)=>{if(!t)return;const s=t.get(e);return s?0===s.resistance?h.GLYPH.whiteFlag:s.resistance:void 0})),getArrows(){let i=[];return t.get(p.GameState.ai.regionInfluenceByHex).forEach(((t,s)=>{const n=t.get(e);n?.children&&n.children.forEach((e=>{i.push([s,e.id])}))})),i},getDetail(i){const s=(0,r.selectFromState)(t.currentState,p.GameState.ai.regionInfluenceByHex,i.id);if(!s)return"";const n=s.get(e);return n?`${n.resistance.toString()} -> ${n.children.map((e=>e.id)).join(",")}`:""}}}},5057:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.RegionBudgetUpdater=t.BudgetByRegionProjection=void 0;const o=i(47181),r=a(i(35369)),c=i(5538),l=i(16115),d=i(87832),h=i(30833);class u extends o.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new g(this).update}bootstrap(e){return r.Map().withMutations((t=>{l.Regions.model(e).all().forEach((e=>{t.set(e.id,this.getRegionBudget(e))}))}))}getRegionBudget(e){const t=e.state,i=e.isAlive()?e.hexes.map((e=>d.Economy.getIncomeFromHex(t,e.id))).reduce(((e,t)=>e+t),0):0,s=e.getPawns().map((e=>e.upkeep)).reduce(((e,t)=>e+t),0);return{incomeFromHexes:i,upkeep:s,balance:i-s}}entryToString(e){return`${(0,c.withSign)(e.balance)}`}entryToDebugString(e){return(0,c.prettyPrintObject)(e)}}t.BudgetByRegionProjection=u;class g extends h.BaseUpdater{constructor(){super(...arguments),this.builder=new o.MapMutationBuilder(this.dataSet)}initialize(){this.invalidated=new Set}registerHandlers(e){e(this.dataSet.sources.regionHexes,this._invalidateAffectedRegions),e(this.dataSet.sources.pawnsByRegion,this._invalidateAffectedRegions),e(this.dataSet.sources.regions,this._handleRegionsUpdated)}createMutation(){const e=l.Regions.model(this.newState);return this.invalidated.forEach((t=>{const i=e.byId(t);i?this.builder.set(t,this.dataSet.getRegionBudget(i)):this.builder.delete(t)})),super.createMutation()}_invalidateAffectedRegions(e){e.updated?.forEach((({id:e})=>this.invalidated.add(e)))}_handleRegionsUpdated(e){e.updated?.forEach((([e,t])=>{t?l.Regions.getRegionData(this.oldState,e)||this.invalidated.add(e):this.builder.delete(e)}))}}t.RegionBudgetUpdater=g},62284:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinsByHexProjection=void 0;const s=i(47181),n=i(73508),a=i(85044),o=i(9332);class r extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.builder=new s.MapMutationBuilder(this)}bootstrap(e){return(0,a.selectFromState)(e,this.sources.pawnsByHex).map((t=>t.find((t=>o.Pawns.getPawnType(e,t)===n.PawnType.Coins)))).filter((t=>t&&0!==o.Pawns.getPawnCount(e,t))).map((t=>o.Pawns.getPawnCount(e,t)||0))}update(e,t,i){return this.builder.init(e),this._handlePawnByHexChange(e,t.of(this.sources.pawnsByHex),i),this._handlePawnsCountChange(e,t.of(this.sources.pawnsCount),i),this.builder.createMutation("parent changed")}_handlePawnByHexChange(e,t,i){t?.updated?.forEach((t=>{const s=t.id;t.added?.forEach((t=>{o.Pawns.getPawnType(e,t)===n.PawnType.Coins&&this.builder.set(s,o.Pawns.getPawnCount(e,t)||1)})),t.removed?.forEach((e=>{o.Pawns.getPawnType(i,e)===n.PawnType.Coins&&this.builder.delete(s)}))}))}_handlePawnsCountChange(e,t,i){t?.updated?.forEach((([t,i])=>{if(o.Pawns.getPawnType(e,t)===n.PawnType.Coins){const s=o.Pawns.getPawnHex(e,t);if(!s)return;i?this.builder.set(s,i):this.builder.delete(s)}}))}}t.CoinsByHexProjection=r},22738:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NearestCampUpdater=t.NearestCampByHexProjection=t.UNREACHABLE=void 0;const r=i(47181),c=a(i(35369)),l=i(62199),d=i(30833),h=i(16115),u=i(23803),g=i(1947),p=o(i(54485)),m=i(1157),y=i(5538),f=i(35171),w=i(52163);l.logger.for("NearestCampByHexProjection"),t.UNREACHABLE=Object.freeze({rootId:0,distance:Number.POSITIVE_INFINITY});class b extends r.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new v(this).update}bootstrap(e){const t=new v(this);return t.initFromState(e),h.Regions.getAll(e).filter((t=>h.Regions.model(e).byId(t)?.faction?.isNeutral())).forEach((e=>{t.addRootsFromRegion(e)})),t.getMap()}entryToString(e){return 0===e.distance?m.GLYPH.whiteFlag:e.rootId}entryToDebugString(e){return(0,y.prettyPrintObject)(e)}}t.NearestCampByHexProjection=b;class v extends d.BaseUpdater{constructor(){super(...arguments),this.builder=new r.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.sources=new Set,this}registerHandlers(e){e(this.dataSet.sources.campsByRegion,this.handleCampsByRegionChange)}handleCampsByRegionChange(e){e.updated?.forEach((e=>{e.added?.forEach((e=>{this.addNewRoot((0,u.getHex)(e))})),e.removed?.forEach((e=>{this.invalidateFrom((0,u.getHex)(e))}))}))}addRootsFromRegion(e){const t=h.Regions.model(this.newState).byId(e);t&&t.faction?.isNeutral()&&g.Bandits.getCampsByRegion(this.newState,e).forEach((e=>this.addNewRoot((0,u.getHex)(e))))}updateInvalidated(){this.addSourcesFromInvalidatedHexes();const e=new p.default(((e,t)=>e.distance-t.distance));for(this.sources.forEach((t=>{const i=this.builder.getCurrent(t.id);w.assert.defined(i),e.push({hex:t,rootHex:(0,u.getHex)(i.rootId),distance:i?.distance})}));!e.empty();){const t=e.pop(),i=t.hex;this.getCurrentDistanceFrom(i)<=t.distance||(this.invalidatedHexes.delete(i),this.builder.set(i.id,{distance:t.distance,rootId:t.rootHex.id}),i.neighbours((e=>void 0!==h.Regions.getByHex(this.newState,e.id)&&this.getCurrentDistanceFrom(e)>=t.distance+1)).forEach((i=>{e.push({hex:i,rootHex:t.rootHex,distance:t.distance+1})})))}this.invalidatedHexes.forEach((e=>this.builder.delete(e.id)))}addSourcesFromInvalidatedHexes(){f.HexGroup.from(Array.from(this.invalidatedHexes)).neighbours().filter((e=>this.getCurrentDistanceFrom(e)<Number.POSITIVE_INFINITY)).forEach((e=>{this.sources.add(e),this.invalidatedHexes.add(e)}))}getMap(){return this.updateInvalidated(),c.Map(this.builder.getEntries()).mapKeys((e=>Number(e)))}createMutation(){return this.updateInvalidated(),super.createMutation()}invalidateFrom(e){if(this.invalidatedHexes.has(e))return;this.invalidatedHexes.add(e);const i=this.builder.getCurrent(e.id);i&&e.neighbours((e=>{const s=this.builder.getCurrent(e.id)??t.UNREACHABLE;return i.rootId==s.rootId&&s.distance===i.distance+1})).forEach((e=>this.invalidateFrom(e)))}getCurrentDistanceFrom(e){return this.invalidatedHexes.has(e)?Number.POSITIVE_INFINITY:this.builder.getCurrent(e.id)?.distance??Number.POSITIVE_INFINITY}addNewRoot(e){this.sources.add(e),this.builder.set(e.id,{rootId:e.id,distance:0}),this.invalidatedHexes.add(e)}}t.NearestCampUpdater=v},30957:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NearestTownUpdater=t.NearestTownProjection=t.UNREACHABLE=void 0;const r=i(47181),c=a(i(35369)),l=i(62199),d=i(30833),h=i(16115),u=i(23803),g=o(i(54485)),p=i(1157),m=i(5538),y=i(35171),f=i(52163),w=i(87832);l.logger.for("NearestTownProjection"),t.UNREACHABLE=Object.freeze({rootId:0,distance:Number.POSITIVE_INFINITY});class b extends r.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new v(this).update}bootstrap(e){const t=new v(this);return t.initFromState(e),h.Regions.getAll(e).forEach((e=>{t.addRootsFromRegion(e)})),t.getMap()}entryToString(e){return 0===e.distance?p.GLYPH.whiteFlag:e.rootId}entryToDebugString(e){return(0,m.prettyPrintObject)(e)}}t.NearestTownProjection=b;class v extends d.BaseUpdater{constructor(){super(...arguments),this.builder=new r.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.sources=new Set,this}registerHandlers(e){e(this.dataSet.sources.townsByRegion,this.handleTownsByRegionChange),e(this.dataSet.sources.regionByHex,this.handleRegionByHexChange)}handleTownsByRegionChange(e){e.updated?.forEach((e=>{e.added?.forEach((e=>{this.addNewRoot((0,u.getHex)(e))})),e.removed?.forEach((e=>{this.invalidateFrom((0,u.getHex)(e))}))}))}handleRegionByHexChange(e){e.updated?.forEach((([e,t])=>{this.invalidateFrom((0,u.getHex)(e))}))}addRootsFromRegion(e){h.Regions.model(this.newState).byId(e)&&w.Economy.getTownHexesByRegion(this.newState,e).forEach((e=>this.addNewRoot((0,u.getHex)(e))))}updateInvalidated(){this.addSourcesFromInvalidatedHexes();const e=new g.default(((e,t)=>e.distance-t.distance));for(this.sources.forEach((t=>{const i=this.builder.getCurrent(t.id);f.assert.defined(i),e.push({hex:t,rootHex:(0,u.getHex)(i.rootId),distance:i?.distance})}));!e.empty();){const t=e.pop(),i=t.hex;this.getCurrentDistanceFrom(i)<=t.distance||(this.invalidatedHexes.delete(i),this.builder.set(i.id,{distance:t.distance,rootId:t.rootHex.id}),i.neighbours((e=>h.Regions.getByHex(this.newState,e.id)===h.Regions.getByHex(this.newState,i.id)&&this.getCurrentDistanceFrom(e)>=t.distance+1)).forEach((i=>{e.push({hex:i,rootHex:t.rootHex,distance:t.distance+1})})))}this.invalidatedHexes.forEach((e=>this.builder.delete(e.id)))}addSourcesFromInvalidatedHexes(){y.HexGroup.from(Array.from(this.invalidatedHexes)).neighbours().filter((e=>this.getCurrentDistanceFrom(e)<Number.POSITIVE_INFINITY)).forEach((e=>{this.sources.add(e),this.invalidatedHexes.add(e)}))}getMap(){return this.updateInvalidated(),c.Map(this.builder.getEntries()).mapKeys((e=>Number(e)))}createMutation(){return this.updateInvalidated(),super.createMutation()}invalidateFrom(e){if(this.invalidatedHexes.has(e))return;this.invalidatedHexes.add(e);const i=this.builder.getCurrent(e.id);i&&e.neighbours((e=>{const s=this.builder.getCurrent(e.id)??t.UNREACHABLE;return i.rootId==s.rootId&&s.distance===i.distance+1})).forEach((e=>this.invalidateFrom(e)))}getCurrentDistanceFrom(e){return this.invalidatedHexes.has(e)?Number.POSITIVE_INFINITY:this.builder.getCurrent(e.id)?.distance??Number.POSITIVE_INFINITY}addNewRoot(e){this.sources.add(e),this.builder.set(e.id,{rootId:e.id,distance:0}),this.invalidatedHexes.add(e)}}t.NearestTownUpdater=v},55576:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.TreasuryByRegionProjection=void 0;const o=i(47181),r=a(i(35369)),c=i(16115),l=i(1951),d=i(85044),h=i(24011),u=i(46299);class g extends o.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.builder=new o.MapMutationBuilder(this)}bootstrap(e){return r.Map().withMutations((t=>{(0,d.selectFromState)(e,this.sources.townsByRegion).forEach(((i,s)=>{const n=i.toArray().map((t=>(0,d.selectFromState)(e,this.sources.coinsByHex,t)||0)).reduce(l.sum,0);n>0&&t.set(s,n)}))}))}update(e,t,i){return this.builder.init(e),this._handleCoinsByHexChange(e,t.of(this.sources.coinsByHex),i),this._handleTownsByRegionChange(e,t.of(this.sources.townsByRegion),i),this.builder.createMutation("parent changed")}_handleCoinsByHexChange(e,t,i){t?.updated?.forEach((([t,s])=>{const n=c.Regions.getByHex(e,t);if(!n||u.Factions.getByRegion(e,n)===h.SpecialFaction.neutral)return;void 0===s&&(s=0);const a=(0,d.selectFromState)(i,this.sources.coinsByHex,t)||0,o=(this.builder.getCurrent(n)||0)+s-a;o?this.builder.set(n,o):this.builder.delete(n)}))}_handleTownsByRegionChange(e,t,i){t?.updated?.forEach((e=>{const t=e.id;let s=this.builder.getCurrent(t)||0;e.added&&(s+=e.added.map((e=>(0,d.selectFromState)(i,this.sources.coinsByHex,e)||0)).reduce(l.sum,0)),e.removed&&(s-=e.removed.map((e=>(0,d.selectFromState)(i,this.sources.coinsByHex,e)||0)).reduce(l.sum,0)),s>0?this.builder.set(t,s):this.builder.delete(t)}))}}t.TreasuryByRegionProjection=g},76378:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ruleSets=t.CHEAPEST_UNIT_COST=void 0;const s=i(92940),n=i(73508);t.CHEAPEST_UNIT_COST=10,t.ruleSets={default:{id:"default",economy:{baseIncomePerTile:1,baseIncomePerRegion:0},pawns:{[n.PawnType.Villager]:{might:1,defense:1,cost:10,upkeep:2,traits:[s.PawnTraits.Unit,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.OccupiesTile],merge:{[n.PawnType.Villager]:n.PawnType.Pikeman}},[n.PawnType.Pikeman]:{might:2,defense:2,cost:20,upkeep:6,traits:[s.PawnTraits.Unit,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.OccupiesTile],merge:{[n.PawnType.Pikeman]:n.PawnType.Knight}},[n.PawnType.Knight]:{might:3,defense:3,cost:40,upkeep:18,traits:[s.PawnTraits.Unit,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.OccupiesTile],merge:{[n.PawnType.Knight]:n.PawnType.Hero}},[n.PawnType.Hero]:{might:4,defense:3,cost:80,upkeep:54,traits:[s.PawnTraits.Unit,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.OccupiesTile],merge:{}},[n.PawnType.Town]:{traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Building,s.PawnTraits.GuardsAdjacentTiles],might:1,defense:1},[n.PawnType.Camp]:{traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Building],might:1,defense:1},[n.PawnType.Castle]:{traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Building,s.PawnTraits.GuardsAdjacentTiles],might:2,defense:2,cost:20,upkeep:2},[n.PawnType.Bandit]:{might:0,defense:0,upkeep:0,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.NegatesTileIncome,s.PawnTraits.Pest]},[n.PawnType.Forest]:{might:99,defense:99,upkeep:0,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Impenetrable,s.PawnTraits.NegatesTileIncome]}}}}},73508:(e,t)=>{"use strict";var i,s,n;Object.defineProperty(t,"__esModule",{value:!0}),t.PawnType=t.FactionController=t.PhaseTypes=void 0,(n=t.PhaseTypes||(t.PhaseTypes={})).FactionTurn="faction-turn",n.GameOver="game-over",(s=t.FactionController||(t.FactionController={})).None="none",s.LocalUser="local-user",s.Ai="ai",s.Remote="remote",(i=t.PawnType||(t.PawnType={})).Town="town",i.Palisade="palisade",i.StoneWall="stonewall",i.Castle="castle",i.Camp="camp",i.Forest="forest",i.Villager="villager",i.Pikeman="pikeman",i.Knight="knight",i.Hero="hero",i.Bandit="bandit",i.Coins="coins"},29429:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AlliesView=void 0;const s=i(73508),n=i(98697),a=i(46299),o=i(44150),r=i(95077);class c extends o.LazyView{constructor(){super([n.GameState.ai.approval]),this.name="ai.allies"}calculate(e,t){return a.Factions.getAll(e).filter((i=>i!==t&&a.Factions.getData(e,i)?.controller!==s.FactionController.None&&r.AI.getFactionApproval(e,i,t)>=100))}getCacheKey(e){return e}}t.AlliesView=c},72005:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateFear=t.AttitudeView=t.getAttitudeStr=t.getAttitudeIndex=t.ATTITUDE_LABELS=void 0;const s=i(98697),n=i(44150),a=i(95077),o=(i(1951),i(62199)),r=i(5538),c=i(71203),l=i(52754),d=i(57775);function h(e,t){let i=0;i=e>=25?0:e>-25?1:2;let s=0;return s=t<=-100?0:t<=-10?1:t<10?2:t<100?3:4,10*i+s}function u(e,i){const s=h(e,i),n=Math.floor(s/10),a=s%10;return t.ATTITUDE_LABELS[n][a]}o.logger.for("FearView"),t.ATTITUDE_LABELS=[["defiant","cornered","nervous","friendly/nervous","subservient"],["furious","angry","reserved","friendly","grateful"],["merciless","annoyed","confident","friendly/confident","benevolent"]],t.getAttitudeIndex=h,t.getAttitudeStr=u;class g extends n.LazyView{constructor(){super([s.GameState.ai.powerByFaction,s.GameState.ai.approval]),this.name="attitude"}calculate(e,t){return this.getComponents(e,t)?.attitude||"-"}getComponents(e,{fromFactionId:t,towardsFactionId:i}){if(t===i)return;const s=c.inject.views.fear.calculate(e,{towardsFactionId:i,fromFactionId:t}),n=a.AI.getFactionApproval(e,t,i);return{fear:s,approval:n,attitude:u(s,n)}}getCacheKey(e){return`${e.fromFactionId}->${e.towardsFactionId}`}getDebugLayer(e){return new l.GameStateDebugLayer((0,d.factionBasedAdapter)({getValue:(t,i)=>{if(i!==e)return this.get(t,{towardsFactionId:e,fromFactionId:i})},getDetail:(t,i)=>{if(i!==e)return(0,r.prettyPrintObject)(this.getComponents(t,{towardsFactionId:e,fromFactionId:i}))}}))}}t.AttitudeView=g,t.calculateFear=function({enemyAlliancePower:e,myAlliancePower:t,myPower:i,totalPower:s,enemyPower:n}){const a=Math.floor(i/s*100),o=Math.floor(n/s*100)-a,r=Math.floor(e/(e+t)*200-100);return{fearOfFactionDomination:o,fearOfGettingCrushed:r,totalFear:Math.max(o,r)}}},45996:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AttritionByFactionView=void 0;const s=i(98697),n=i(44150),a=i(95077),o=i(1951),r=i(62199),c=i(52754),l=i(57775),d=i(46299);r.logger.for("AttritionByFactionView");class h extends n.LazyView{constructor(){super([s.GameState.ai.attritionByRegion]),this.name="attritionByFaction"}calculate(e,t){const i={};return d.Factions.getFactionRegions(e,t).map((t=>{const s=a.AI.getRegionAttrition(e,t);for(const[e,t]of Object.entries(s))i[Number(e)]=(i[Number(e)]||0)+t})),i}getCacheKey(e){return e}getDebugLayer(){return new c.GameStateDebugLayer((0,l.factionBasedAdapter)({getValue:(e,t)=>Object.values(this.get(e,t)).reduce(o.sum,0),getDetail:(e,t)=>Object.entries(this.get(e,t)).map((([e,t])=>`${t} inflicted by faction ${e}`)).join("\n")}))}}t.AttritionByFactionView=h},88048:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionInfluenceByRegionView=t.PowerMeasurement=void 0;const s=i(98697),n=i(85044),a=i(46299),o=i(44150),r=i(95077),c=i(52754),l=i(10997),d=i(16115);var h;!function(e){e.MilitaryMight="might",e.RegionSize="size"}(h=t.PowerMeasurement||(t.PowerMeasurement={}));class u extends o.LazyView{constructor(){super([s.GameState.ai.regionInfluenceByRegion,s.GameState.factions.byRegion,s.GameState.ai.powerByRegion]),this.name="factionInfluenceByRegion"}calculate(e,t){const i=this.getComponents(e,t);return{total:i.reduce(((e,t)=>e+t.influence),0),proximity:i.reduce(((e,t)=>Math.min(e,t.proximity)),1/0)}}getComponents(e,{influencingFaction:t,targetRegion:i,maxDistance:o,powerMeasurement:r}){const c=(0,n.selectFromState)(e,s.GameState.ai.regionInfluenceByRegion,i);return c?c.entrySeq().filter((([i,s])=>a.Factions.getByRegion(e,i)===t&&s.proximity<=o)).map((([t,i])=>({regionId:t,influence:i.total*this.getRegionPower(e,t,r),proximity:i.proximity}))).filter((({influence:e})=>e>0)).toArray():[]}getRegionPower(e,t,i){switch(i){case h.MilitaryMight:return r.AI.getRegionPower(e,t).militaryPower;case h.RegionSize:return d.Regions.getRegionHexes(e,t).size}}getCacheKey({influencingFaction:e,targetRegion:t,maxDistance:i,powerMeasurement:s}){return`${e}.${t}.${i}.${s}`}getDebugLayer(e,t,i=99){return new c.GameStateDebugLayer((0,l.regionBasedAdapter)({getValue:(s,n)=>{const a=this.get(s,{influencingFaction:e,targetRegion:n,maxDistance:i,powerMeasurement:t});return`${a.total}\n(${a.proximity})`},getDetail:(s,n)=>this.getComponents(s,{influencingFaction:e,targetRegion:n,maxDistance:i,powerMeasurement:t}).map((e=>`${e.influence} from region ${e.regionId} (proximity ${e.proximity})`)).join("\n")}))}}t.FactionInfluenceByRegionView=u},35670:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateFear=t.FearView=void 0;const s=i(98697),n=i(85044),a=i(44150),o=i(95077),r=i(1951),c=i(62199),l=i(5538),d=i(52754),h=i(57775);c.logger.for("FearView");class u extends a.LazyView{constructor(){super([s.GameState.ai.powerByFaction,s.GameState.ai.approval]),this.name="fear"}calculate(e,t){return this.getComponents(e,t).fear.totalFear}getComponents(e,{fromFactionId:t,towardsFactionId:i}){const a=(0,n.selectFromState)(e,s.GameState.ai.powerByFaction),c=a.valueSeq().reduce(r.sum,0),l=a.get(t),d=[t],h=g(e,d.filter((e=>e!==i))),u=o.AI.getFactionPower(e,i),m=[i],y=g(e,m);return{totalPower:c,myPower:l,rivalFactionPower:u,rivalAllianceMembers:m,rivalAlliancePower:y,myAlliance:d,myAlliancePower:h,fear:p({myPower:l,enemyPower:u,totalPower:c,myAlliancePower:h,enemyAlliancePower:y})}}getCacheKey(e){return`${e.fromFactionId}->${e.towardsFactionId}`}getDebugLayer(e){return new d.GameStateDebugLayer((0,h.factionBasedAdapter)({getValue:(t,i)=>{if(i!==e)return this.get(t,{towardsFactionId:e,fromFactionId:i})},getDetail:(t,i)=>{if(i!==e)return(0,l.prettyPrintObject)(this.getComponents(t,{towardsFactionId:e,fromFactionId:i}))}}))}}function g(e,t){return t.map((t=>o.AI.getFactionPower(e,t))).reduce(r.sum,0)}function p({enemyAlliancePower:e,myAlliancePower:t,myPower:i,totalPower:s,enemyPower:n}){const a=Math.floor(i/s*100),o=2*(Math.floor(n/s*100)-a),r=Math.floor(e/(e+t)*200-100);return{fearOfFactionDomination:o,fearOfGettingCrushed:r,totalFear:Math.max(o,r)}}t.FearView=u,t.calculateFear=p},88316:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexProximityToRegionView=void 0;const s=i(98697),n=i(85044),a=i(44150),o=i(52754),r=i(1951),c=i(1522);class l extends a.LazyView{constructor(){super([s.GameState.ai.regionInfluenceByHex,s.GameState.regions.byHex,s.GameState.factions.byRegion]),this.name="hexProximityToRegionView"}calculate(e,t){return this.getComponents(e,t).map((e=>e.score)).reduce(r.sum,0)}getComponents(e,t){const i=(0,n.selectFromState)(e,s.GameState.ai.regionInfluenceByHex,t.hexId);return i?i.entrySeq().map((([e,i])=>({regionId:e,distance:i.distance,score:t.scoreCalculator(e,i.distance)}))).toArray():[]}getCacheKey(e){return e.cacheId+"."+e.hexId}getDebugLayer(e){return new o.GameStateDebugLayer((0,c.hexBasedAdapter)({getValue:(t,i)=>this.get(t,{...e,hexId:i}),getDetail:(t,i)=>this.getComponents(t,{...e,hexId:i}).map((({regionId:e,score:t,distance:i})=>`${t} from region ${e} (d=${i})`)).join("\n")}))}}t.HexProximityToRegionView=l},71203:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SceneInjector=t.inject=t.setupInjectionContainer=void 0;const s=i(40520),n=i(41682),a=i(98616),o=i(32036),r=i(41421),c=i(67060),l=i(65641),d=i(9095),h=i(90016),u=i(92070),g=i(42519),p=i(52163),m=i(94459),y=i(1157),f=i(89086),w=i(24909),b=i(78275),v=i(84612),S=i(35832),P=i(78823),T=i(58609),x=i(3255),M=i(91058),C=i(59257),I=i(32498),A=i(11274),B=i(84477),j=i(54051),_=i(21669),E=i(13872),R=i(72591),O=i(93808),H=i(31763),D=i(35702);function k(e){return new Proxy(e,{get(e,t,i){if(e.hasOwnProperty(t))return Reflect.get(e,t,i);throw new Error(`attempted to access unitialized property "${String(t)}"`)}})}function L(e){const i=t.inject.ui.transitionsSpeed();t.inject.ui.transitionsSpeed.set(E.TransitionsSpeed.Instant),e(),t.inject.ui.transitionsSpeed.set(i)}t.setupInjectionContainer=function(e,i,v={}){if(!i)throw new Error('No configuration found for ENVIRONMENT="production", unable to setup injection container!');const F=(0,b.getAppController)(i.mode),G=new c.TypedEventBus,N=new s.GameStateController,W=new m.DeviceInfo(e),V={config:(0,l.deepWatchable)(i),navigator:new S.Navigator(e),scene:new U(e),events:G,game:e,audio:new d.AudioManager(e),fonts:new y.Fonts,random:(0,n.createRandomGenerator)(),gameStateController:N,analytics:new _.AnalyticsReporter(G),ui:{scale:(0,l.watchable)(1),withoutTransitions:L,spectatingSpeed:(0,l.watchable)(T.SpectatingPlaybackSpeed.Fast),transitionsSpeed:(0,l.watchable)(E.TransitionsSpeed.Fast),skipTransitions:()=>t.inject.ui.transitionsSpeed()===E.TransitionsSpeed.Instant,hexUnderCursor:(0,r.watchableHexUnderCursor)(),regionsLedger:new f.RegionsLedger,selectedCampaign:(0,l.watchable)(void 0),selectedLevelId:(0,l.watchable)(void 0),playedLevelId:(0,l.watchable)(void 0)}};t.inject=k(V),t.inject={...V,screen:(0,x.createScreens)(),device:W,ai:new u.AIController,modals:new w.ModalsManager(e),notifications:new I.NotificationsManager,tooltips:new B.TooltipsManager,appController:F,gameStateModel:N.model,views:new P.ViewsManager,history:new a.GameStateHistory,reporting:new M.Reporter(G,i),gameplayStats:new C.GameplayStatsCollector,worldNews:new A.WorldNews,scriptRunner:new j.LevelScriptRunner,debugData:new o.DebugData,debugLayers:new h.WorldDebugLayersManager,debugBreakpoint:g.debugBreakPointProvider,mapRegistry:new O.SimpleMapRegistry(i.mapRegistryUrl?new D.RestMapRegistryDataSource(i.mapRegistryUrl):new H.MockMapRegistryDataSource),userData:new R.LocalStorageUserData,get currentGameState(){return N.model.state},set currentGameState(e){N.currentState!==e&&(p.assert.defined(e,"attempt to set current game state to undefined value"),N.model.restore(e))},...v}},t.inject=k({});class U{constructor(e){this.game=e}get worldMap(){return this.game.scene.getScene(v.Scenes.WorldMap)}get debug(){return this.game.scene.getScene(v.Scenes.Debug)}get debugHistory(){return this.game.scene.getScene(v.Scenes.DebugHistory)}get play(){return this.game.scene.getScene(v.Scenes.Play)}get playUI(){return this.game.scene.getScene(v.Scenes.PlayUI)}get titleScreenUI(){return this.game.scene.getScene(v.Scenes.TitleScreenUI)}get levelDetailUI(){return this.game.scene.getScene(v.Scenes.LevelDetailUI)}get mapEditor(){return this.game.scene.getScene(v.Scenes.MapEditor)}get menuHeaderUI(){return this.game.scene.getScene(v.Scenes.MenuHeaderUI)}get levelSelectUI(){return this.game.scene.getScene(v.Scenes.LevelSelectUI)}get victory(){return this.game.scene.getScene(v.Scenes.Victory)}get defeat(){return this.game.scene.getScene(v.Scenes.Defeat)}get globalUI(){return this.game.scene.getScene(v.Scenes.GlobalUI)}get randomMapSelect(){return this.game.scene.getScene(v.Scenes.RandomMapSelectUI)}}t.SceneInjector=U},11979:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryWithCache=void 0,t.FactoryWithCache=class{constructor(e){this.maker=e,this.instances=new WeakMap}getOrCreateFor(e){let t=this.instances.get(e);return t||(t=this.maker(e),this.instances.set(e,t)),t}}},62616:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FixedCapacityArray=void 0,t.FixedCapacityArray=class{constructor(e){this.cursor=0,this.data=[],this.size=0,Array.isArray(e)?(this.data=e,this.size=this.data.length):this.size=e}get length(){return this.data.length}push(e){this.data[this.cursor]=e,this.cursor=(this.cursor+1)%this.size}getItems(){return this.data.slice(this.cursor,this.size).concat(...this.data.slice(0,this.cursor))}get(e){return this.data[(this.cursor+e)%this.data.length]}pop(){const e=this.getItems(),t=e[e.length-1];return this.data=this.getItems().slice(0,this.data.length-1),this.cursor=this.data.length,t}clear(){this.data=[],this.cursor=0}}},21189:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ObjectCache=void 0;const s=i(35369);t.ObjectCache=class{constructor(e=s.hash){this.hashFunction=e,this.data={}}find(e){return this.data[this.hashFunction(e)]}store(e,t){this.data[this.hashFunction(e)]=t}}},87951:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Pool=void 0;const s=i(62199).logger.for("Pool");t.Pool=class{constructor(e){this.factory=e,this.freeInstances=new Set,this.usedInstances=new Set}preload(e){for(;this.freeInstances.size<e;)this.freeInstances.add(this.factory());return this}take(){let e=this.freeInstances.values().next().value;return e?this.freeInstances.delete(e):e=this.factory(),this.usedInstances.add(e),e}free(e){this.usedInstances.has(e)?(this.usedInstances.delete(e),this.freeInstances.add(e)):s.warning(`redundant attempt to free ${e} - it is not marked as used in the Pool`)}freeAll(){this.usedInstances.forEach((e=>this.freeInstances.add(e))),this.usedInstances.clear()}}},73735:(e,t)=>{"use strict";function i(e,t){for(var i=0,s=e.length;i<s;){var n=i+s>>>1;e[n]<t?i=n+1:s=n}return i}function s(e,t){let i,s=-1/0;for(let n of e){const e=t(n);e>s&&(i=n,s=e)}return i}Object.defineProperty(t,"__esModule",{value:!0}),t.findMin=t.findMax=t.range=t.ascendingSortFn=t.getInsertionIndexInSortedArray=t.insertIntoSortedArray=t.getOrCreate=t.isObject=t.filterDictionaryInPlace=t.filterDictionary=t.mapDictionary=t.pick=t.omit=t.mergeArrays=t.dictionaryOf=t.removeFromArrayInPlace=t.pushIntoArrayByKey=t.cloneArrayWithoutItemAt=t.cloneArrayWithout=t.stripDuplicatesFrom=t.insertBetween=t.replaceArrayItem=void 0,t.replaceArrayItem=function(e,t,i){if(t<0||t>=e.length)throw new Error(`index out of bounds (array length: ${e.length}, index: ${t})`);return[...e.slice(0,t),i,...e.slice(t+1)]},t.insertBetween=function(e,t){return e.reduce(((e,i,s,n)=>(e.push(i),s<n.length-1&&e.push(t),e)),[])},t.stripDuplicatesFrom=function(e){return Array.from(new Set(e))},t.cloneArrayWithout=function(e,...t){return e.filter((e=>!t.includes(e)))},t.cloneArrayWithoutItemAt=function(e,t){return[...e.slice(0,t),...e.slice(t+1)]},t.pushIntoArrayByKey=function(e,t,...i){void 0===e[t]&&(e[t]=[]),e[t].push(...i)},t.removeFromArrayInPlace=function(e,t){return-1===e.indexOf(t)||e.splice(e.indexOf(t),1),e},t.dictionaryOf=function(e,t){const i={};for(const s of e)i[s[t]]=s;return i},t.mergeArrays=function(...e){return[].concat(...e)},t.omit=function(e,...t){return Object.keys(e).reduce(((i,s)=>(t.includes(s)||(i[s]=e[s]),i)),{})},t.pick=function(e,...t){return Object.keys(e).reduce(((i,s)=>(t.includes(s)&&(i[s]=e[s]),i)),{})},t.mapDictionary=function(e,t){return Object.assign({},...Object.keys(e).map((i=>({[i]:t(e[i],i)}))))},t.filterDictionary=function(e,t){const i={};for(const s in e)t(e[s],s)&&(i[s]=e[s]);return i},t.filterDictionaryInPlace=function(e,t){for(const i in e)t(e[i],i)||delete e[i];return e},t.isObject=function(e){return e&&"object"==typeof e&&!Array.isArray(e)},t.getOrCreate=function(e,t,i){if(void 0!==e[t])return e[t];const s=i();return e[t]=s,s},t.insertIntoSortedArray=function(e,t){const s=i(e,t);return e.splice(s,0,t),e},t.getInsertionIndexInSortedArray=i,t.ascendingSortFn=function(e,t){return e-t},t.range=function(e,t){return t<e||isNaN(e)||isNaN(t)?[]:Array(t-e+1).fill(0).map(((t,i)=>e+i))},t.findMax=s,t.findMin=function(e,t){return s(e,(e=>-t(e)))}},30707:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncJobExclusiveRunner=void 0;const s=i(62199),n=i(14090),a=i(5538),o=s.logger.for("AsyncJobExclusiveRunner");t.AsyncJobExclusiveRunner=class{constructor(e){this.jobRunner=e,this.paused=!1,this.currentInput=null,this.currentPromise=null,this.onJobStarted=(0,n.signal)(),this.onJobFinished=(0,n.signal)()}run(e){this.currentInput!==e&&(this.currentInput=e,this.currentPromise?this.currentPromise=null:this._runPendingJob())}_runPendingJob(){if(this.currentInput&&!this.currentPromise){const e=this.currentInput;this.currentPromise=this.jobRunner(e,(async()=>{this.currentInput!==e?(o.warning("Aborting job"),this._runPendingJob(),await new Promise((()=>{}))):await(0,a.preventFreeze)()})),this.onJobStarted.fire(e),this.currentPromise.then((()=>{this.currentInput===e?(this.currentInput=null,this.currentPromise=null,this.onJobFinished.fire(e)):this._runPendingJob()}))}}isRunning(){return!!this.currentPromise}clear(){this.currentInput=null,this.currentPromise=null}}},41625:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncJobQueue=void 0,i(62199).logger.for("AsyncJobQueue"),t.AsyncJobQueue=class{constructor(e){this.jobRunner=e,this.pendingJobs=[],this.paused=!1,this.currentPromise=void 0}addJob(e){this.pendingJobs.push((()=>this.jobRunner(e))),this.startNextJobIfIdle()}startNextJobIfIdle(){if(this.currentPromise||this.paused)return;const e=this.pendingJobs.shift();e&&(this.currentPromise=e().then((()=>{this.currentPromise=void 0,this.startNextJobIfIdle()})))}pause(){this.paused||(this.paused=!0)}resume(){this.paused&&(this.paused=!1,this.startNextJobIfIdle())}clear(){this.pendingJobs=[]}}},98721:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventQueue=void 0,t.EventQueue=class{constructor(){this.sources=[],this.pendingEvents=[]}addSource(e){this.sources.push(e((e=>this.push(e))))}push(e){this.pendingEvents.push(e)}hasNext(){return this.pendingEvents.length>0}next(){return this.pendingEvents.shift()}unsubscribe(){this.sources.forEach((e=>e.unsubscribe()))}clear(){this.pendingEvents=[]}}},14090:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.signal=void 0,t.signal=function(){const e=[],t=function(t){return e.push(t),{unsubscribe(){i(t)}}};return t.fire=t=>e.map((e=>e(t))),t.unsubscribe=i,t.unsubscribeAll=()=>e.length=0,t;function i(t){const i=e.indexOf(t);-1!==i&&e.splice(i,1)}}},67060:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TypedEventBus=void 0;const s=i(73735),n=i(62199).logger.for("events");class a{constructor(e){this.parent=e,this.handlers={}}on(e,t){(0,s.pushIntoArrayByKey)(this.handlers,e.eventName,t);const i=this.on.bind(this),n=this.handlers;return{unsubscribe(){(0,s.removeFromArrayInPlace)(n[e.eventName],t)},on:i}}trigger(e){let t=!1,i=!1;for(let s of this.handlers[e.name]||[])if(i=!0,s(e.payload,(()=>t=!0)),t)return;t=!1,this.defaultHandler&&(this.defaultHandler(e,(()=>t=!0)),i=!0),t||(this.parent?this.parent.trigger(e):i||n.warning(`No handler currently registered for event ${e.name} - ignoring.`))}setDefaultHandler(e){this.defaultHandler=e}createChild(){return new a(this)}}t.TypedEventBus=a},70780:(e,t)=>{"use strict";var i;function s(e,t){const i=e+"."+t,s=function(t){return{name:i,payload:t,category:e,isTypedEvent:!0}};return s.eventName=e+"."+t,s.category=e,s}Object.defineProperty(t,"__esModule",{value:!0}),t.createTypedEventHandler=t.isEvent=t.createEventFactory=t.gameplayAction=t.uiEvent=t.userAction=t.systemEvent=t.gameStateEvent=t.EventCategory=void 0,function(e){e.GameState="GAME_STATE",e.System="SYSTEM",e.UserAction="UserAction",e.UiEvent="UiEvent",e.ReportingEvent="TELEMETRY",e.MapEditor="UI_MAP_EDITOR",e.WorldMap="UI_WORLD_MAP",e.Play="PLAY",e.News="NEWS"}(i=t.EventCategory||(t.EventCategory={})),t.gameStateEvent=function(e){return s(i.GameState,e)},t.systemEvent=function(e){return s(i.System,e)},t.userAction=function(e){return s(i.UserAction,e)},t.uiEvent=function(e){return s(i.UserAction,e)},t.gameplayAction=function(e){return s(i.Play,e)},t.createEventFactory=s,t.isEvent=function(e,t){return!(!e.hasOwnProperty("isTypedEvent")||t&&e.name!==t.eventName)},t.createTypedEventHandler=function(){const e={};return{on(t,i){if(e[t.eventName])throw new Error(`${t.eventName} already has a handler!`);e[t.eventName]=i},handle(t){e[t.name]?.(t.payload)}}}},1951:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDefined=t.min=t.max=t.sum=void 0,t.sum=(e,t)=>e+t,t.max=(e,t)=>e>=t?e:t,t.min=(e,t)=>e>=t?t:e,t.isDefined=function(e){return void 0!==e}},36504:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBoundingBox=t.getRectMidPoint=t.euclidDistance=t.manhattanDistance=t.multiplyRect=t.enlargeRect=t.rectToPhaser=void 0,t.rectToPhaser=function(e){return new Phaser.Geom.Rectangle(e.x,e.y,e.width,e.height)},t.enlargeRect=function(e,t){return e.x-=t,e.y-=t,e.width+=2*t,e.height+=2*t,e},t.multiplyRect=function(e,t,i){return e.x*=t,e.y*=i,e.width*=t,e.height*=i,e},t.manhattanDistance=function(e,t){return Math.abs(Math.abs(e.x)-Math.abs(t.x))+Math.abs(Math.abs(e.y)-Math.abs(t.y))},t.euclidDistance=function(e,t){const i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)},t.getRectMidPoint=function(e){return{x:e.x+e.width/2,y:e.y+e.height/2}},t.getBoundingBox=function(e){if(0===e.length)return{x:0,y:0,height:0,width:0};let t=Number.MAX_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER,s=-Number.MAX_SAFE_INTEGER,n=-Number.MAX_SAFE_INTEGER;for(let a of e)a.x<t&&(t=a.x),a.x>s&&(s=a.x),a.y<i&&(i=a.y),a.y>n&&(n=a.y);return{x:t,y:i,width:s-t,height:n-i}}},28396:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.neighbourBitmapHasDirection=t.HexDisplayDelegate=t.Hex=t.HEX_CORNER_NEIGHBOURS=t.HEX_CORNER_DIRECTIONS=t.HEX_DIRECTIONS=t.HexCornerDirection=t.HexDirection=void 0;const n=i(23803),a=i(58869),o=i(35171),r=s(i(43991)),c=i(26792),l=i(35101);var d,h,u=Phaser.Math.PI2;(h=t.HexDirection||(t.HexDirection={}))[h.UP_LEFT=0]="UP_LEFT",h[h.UP_RIGHT=1]="UP_RIGHT",h[h.RIGHT=2]="RIGHT",h[h.DOWN_RIGHT=3]="DOWN_RIGHT",h[h.DOWN_LEFT=4]="DOWN_LEFT",h[h.LEFT=5]="LEFT",(d=t.HexCornerDirection||(t.HexCornerDirection={}))[d.UP_LEFT=0]="UP_LEFT",d[d.TOP=1]="TOP",d[d.UP_RIGHT=2]="UP_RIGHT",d[d.DOWN_RIGHT=3]="DOWN_RIGHT",d[d.DOWN=4]="DOWN",d[d.DOWN_LEFT=5]="DOWN_LEFT",t.HEX_DIRECTIONS=[0,1,2,3,4,5],t.HEX_CORNER_DIRECTIONS=[0,1,2,3,4,5],t.HEX_CORNER_NEIGHBOURS=[[5,0],[0,1],[1,2],[2,3],[3,4],[4,5]];const g=[-u/3,-u/6,0,u/6,u/3,u/2],p=[[-.5,-1],[.5,-1],[1,0],[.5,1],[-.5,1],[-1,0]],m=[[-.5,-.25],[0,-.5],[.5,-.25],[.5,.25],[0,.5],[-.5,.25]];t.Hex=class{constructor(e){this.id=e}get tabular(){return void 0===this._tabular&&(this._tabular=(0,a.ordinalToTabular)(this.id)),this._tabular}get display(){return this._display||(this._display=new y(this)),this._display}get r(){return this.tabular.r}get c(){return this.tabular.c}get x(){return(0,a.tabularToSpatial)(this.tabular).x}get y(){return this.r}get length(){return 1}get members(){return[this]}first(){return this}isAtGridBorder(e){return n.HexGrid.isHexOnGridBorder(this,e)}neighbours(e=(e=>!0)){return o.HexGroup.from(p.map((e=>n.HexGrid.getHex({x:this.x+e[0],y:this.y+e[1]}))).filter((t=>t&&e(t))))}disjointedNeighbourGroups(e,i){let s=new r.default,n=t.HEX_DIRECTIONS.map((t=>{const s=e.neighbour(t);return s&&i(s)?s:null}));const a=n.indexOf(null);let o=null;if(-1===a)s.addToGroup(n[0].id,...n);else{for(let e=a+1;e<n.length;++e)c(n[e]);for(let e=0;e<a;++e)c(n[e])}function c(e){null===e?o=null:(o||(o=e.id),s.addToGroup(o,e))}return s}neighboursByCornerDirection(e){const[i,s]=t.HEX_CORNER_NEIGHBOURS[e];return[this.neighbour(i),this.neighbour(s)].filter((e=>e))}neighbour(e){const t=p[e];return n.HexGrid.getHex({x:this.x+t[0],y:this.y+t[1]})}getDirectionTowards(e){const t=e.x-this.x,i=e.y-this.y;return p.findIndex((([e,s])=>e===t&&s===i))}getCorner(e){return l.HexCorner.fromHexAndDirection(this,e)}getCorners(){return t.HEX_CORNER_DIRECTIONS.map((e=>this.getCorner(e)))}hasCorner(e){return e.sortedHexes.includes(this)}getAngleTowards(e){return g[this.getDirectionTowards(e)]}bfsFrom(e,t){t(e,void 0,0)}floodFillOut(e=(()=>!0)){return o.HexGroup.from([this]).floodFillOut(e)}findClosest(e,t){return o.HexGroup.from([this]).findClosest(e,t)}neighboursOf(e){return o.HexGroup.from([this]).neighboursOf(e)}toString(){return`[Hex #${this.id} (${this.x},${this.y})]`}asGroup(){return o.HexGroup.from([this])}toIdsArray(){return this.asGroup().toIdsArray()}toArray(){return this.asGroup().toArray()}has(e){return this.asGroup().has(e)}contains(e){return this.id===e?.id}containsId(e){return this.id===e}border(e=!1){return this.asGroup().border(e)}boundingBox(){return{x:this.display.left,y:this.display.top,width:this.display.width,height:this.display.height}}components(e=(()=>!0)){return this.asGroup().components(e)}with(...e){return o.HexGroup.from([this,...e])}without(e){return this.asGroup().without(e)}filter(e){return this.asGroup().filter(e)}forEach(e){return this.asGroup().forEach(e)}map(e){return this.asGroup().map(e)}find(e){return this.asGroup().find(e)}sort(e){return this.asGroup().sort(e)}findInnerMostHex(){return this}findMax(e){return this}floodFillFrom(e,t){return o.HexGroup.from(e.members)}customSearchFrom(e,t,i){return o.HexGroup.from([this]).customSearchFrom(e,t,i)}findNeighbour(e){for(let t of p){const i=n.HexGrid.getHex({x:this.x+t[0],y:this.y+t[1]});if(i&&e(i))return i}}neighboursBitmap(e){let i=0;for(let s of t.HEX_DIRECTIONS){const t=this.neighbour(s);i<<=1,t&&e(t,s)&&++i}return i}disjointedNeighbourGroupsOf(e){return new r.default}};class y{constructor(e){this.hex=e,this.width=c.HEX_WIDTH,this.height=c.HEX_HEIGHT}get left(){return this.hex.x*c.HEX_WIDTH}get right(){return(this.hex.x+1)*c.HEX_WIDTH}get top(){return this.hex.y*c.HEX_INNER_HEIGHT}get bottom(){return this.hex.y*c.HEX_INNER_HEIGHT+c.HEX_HEIGHT}get centerX(){return this.hex.x*c.HEX_WIDTH+c.HALF_HEX_WIDTH}get centerY(){return this.hex.y*c.HEX_INNER_HEIGHT+c.HALF_HEX_HEIGHT}getCornerPoint(e){return{x:this.centerX+m[e][0]*c.HEX_WIDTH,y:this.centerY+m[e][1]*c.HEX_HEIGHT}}}t.HexDisplayDelegate=y,t.neighbourBitmapHasDirection=function(e,t){return!!(e&1<<5-t)}},35101:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexCorner=void 0;const s=i(23803),n=i(52163),a=i(26792);class o{constructor(e){this.sortedHexes=e.sort(((e,t)=>e.id-t.id)),this.id=r(...e),this.variant=this.sortedHexes[0].y===this.sortedHexes[1].y?"V":"A","A"===this.variant?this.display={x:this.sortedHexes[0].display.centerX,y:this.sortedHexes[0].display.centerY+a.HEX_HEIGHT/2}:this.display={x:this.sortedHexes[0].display.centerX+a.HEX_WIDTH/2,y:this.sortedHexes[0].display.centerY+.25*a.HEX_HEIGHT}}static byId(e){if(!this.cache[e]){const t=e.split(".").map((e=>(0,s.getHex)(Number(e))));(0,n.assert)(3===t.length,`invalid cornerId ${e}`),this.cache[e]=new o(t)}return this.cache[e]}static fromHexes(...e){const t=r(...e.sort(((e,t)=>e.id-t.id)));return this.byId(t)}static fromHexAndDirection(e,t){return o.fromHexes(e,...e.neighboursByCornerDirection(t))}}function r(e,t,i){return i?[e,t,i].map((e=>e.id)).sort(((e,t)=>e-t)).join("."):e.id>t.id?`${t.id}.${e.id}`:`${e.id}.${t.id}`}t.HexCorner=o,o.cache={}},23803:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getHexes=t.getHex=t.HexGrid=t.GRID_MAX_DIMENSION=void 0;const s=i(5538),n=i(28396),a=i(58869),o=i(35171);i(62199).logger.for("HexGrid"),t.GRID_MAX_DIMENSION=100;class r{constructor(){}static getHex(e){if(void 0!==e&&this.isWithinBounds(e,{width:t.GRID_MAX_DIMENSION,height:t.GRID_MAX_DIMENSION}))return(0,a.isOrdinal)(e)?(this._hexes[e]||(this._hexes[e]=new n.Hex(e)),this._hexes[e]):this.getHex(this.toOrdinal(e))}static getAllHexes(e){const t=Array(e.width*e.height).fill(void 0);for(let i=0;i<e.height;++i)for(let s=0;s<e.width;++s)t[i*e.width+s]=(0,a.tabularToOrdinal)({r:i,c:s});return o.HexGroup.from(t.map((e=>c(e))))}static getHexes(e){return o.HexGroup.from(e.map((e=>this.getHex(e))))}static filter(e,t){return this.getAllHexes(t).filter(e)}static getInnerHexes(e){return this.getAllHexes(e).filter((t=>!this.isHexOnGridBorder(t,e)))}static isWithinBounds(e,t){if((0,a.isTabular)(e))return!(e.c>=t.width||e.c<0||e.r>=t.height||e.r<0);if((0,a.isOrdinal)(e))return this.isWithinBounds((0,a.ordinalToTabular)(e),t);if((0,a.isSpatial)(e))return this.isWithinBounds((0,a.spatialToTabular)(e),t);throw new Error(`HexGrid.isOutOfBounds called with invalid grid position (${(0,s.str)(e)})`)}static isHexOnGridBorder(e,i){return e.id<t.GRID_MAX_DIMENSION||e.id%t.GRID_MAX_DIMENSION==0||e.id%t.GRID_MAX_DIMENSION==i.width-1||Math.floor(e.id/t.GRID_MAX_DIMENSION)===i.height-1}static toOrdinal(e){if((0,a.isOrdinal)(e))return e;if((0,a.isTabular)(e))return(0,a.tabularToOrdinal)(e);if((0,a.isSpatial)(e))return(0,a.tabularToOrdinal)((0,a.spatialToTabular)(e));throw new Error(`HexGrid.toOrdinal called with invalid grid position (${(0,s.str)(e)})`)}static bfs(e,t=(()=>!0)){let i=[];e.forEach((e=>i.push({hex:e,d:0})));let s=new Set(e.members);const n=({hex:e,d:n,parent:a})=>{s.add(e),t(e,a,n)&&e.neighbours().filter((e=>!s.has(e))).members.forEach((t=>{s.add(t),i.push({hex:t,d:n+1,parent:e})}))};for(;i.length>0;)n(i.shift())}}function c(e){return r.getHex(e)}t.HexGrid=r,r.upperBound=t.GRID_MAX_DIMENSION*t.GRID_MAX_DIMENSION-1,r._hexes=[],t.getHex=c,t.getHexes=function(e){return r.getHexes(e)}},58869:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.spatialToTabular=t.tabularToOrdinal=t.tabularToSpatial=t.ordinalToTabular=t.isOrdinal=t.isTabular=t.isSpatial=void 0;const s=i(23803);t.isSpatial=function(e){return e.hasOwnProperty("x")},t.isTabular=function(e){return e.hasOwnProperty("r")},t.isOrdinal=function(e){return"number"==typeof e},t.ordinalToTabular=function(e){return{r:Math.floor(e/s.GRID_MAX_DIMENSION),c:Math.floor(e%s.GRID_MAX_DIMENSION)}},t.tabularToSpatial=function({r:e,c:t}){return{x:t-e%2/2,y:e}},t.tabularToOrdinal=function({r:e,c:t}){return e*s.GRID_MAX_DIMENSION+t},t.spatialToTabular=function({x:e,y:t}){return{r:t,c:Math.ceil(e)}}},46438:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexGridSectors=void 0;const s=i(23803);t.HexGridSectors=class{constructor(e){this.sectorSize=e,this.sectorsPerRow=Math.ceil(s.GRID_MAX_DIMENSION/this.sectorSize)}getSectorOf(e){const t=Math.floor(e.r/this.sectorSize),i=Math.floor(e.c/this.sectorSize);return t*this.sectorsPerRow+i}getSectorRect(e){return{x:e%this.sectorsPerRow*this.sectorSize-.5,y:Math.floor(e/this.sectorsPerRow)*this.sectorSize,width:this.sectorSize+.5,height:this.sectorSize+.5}}}},35171:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexGroup=void 0;const n=s(i(43991)),a=i(73735),o=s(i(54485)),r=i(23803);var c=Phaser.Math.MIN_SAFE_INTEGER;class l{constructor(e={},t){this.membersByIndex=e,this._membersList=t}get length(){return this.members.length}get members(){return this._membersList||(this._membersList=Object.values(this.membersByIndex),Object.freeze(this._membersList)),this._membersList}first(){return this.members[0]}static from(e){const t={};e instanceof Set&&(e=Array.from(e));const i=e.filter((e=>void 0!==e));for(let e of i)t[e.id]=e;return new l(t,i)}static fromIds(e){return l.from(e.map(r.getHex))}static union(e){const t=(0,a.stripDuplicatesFrom)((0,a.mergeArrays)(...e.map((e=>e.members))));return l.from(t)}boundingBox(){if(0===this.length)return{x:0,y:0,height:0,width:0};let e=Number.MAX_SAFE_INTEGER,t=Number.MAX_SAFE_INTEGER,i=-Number.MAX_SAFE_INTEGER,s=-Number.MAX_SAFE_INTEGER;for(let n of this.members)(n.display.left<e??Number.MAX_SAFE_INTEGER)&&(e=n.display.left),n.display.right>i&&(i=n.display.right),n.display.top<t&&(t=n.display.top),n.display.bottom>s&&(s=n.display.bottom);return{x:e,y:t,width:i-e,height:s-t}}toIdsArray(){return this.members.map((e=>e.id))}toArray(){return[...this.members]}has(e){return!!this.membersByIndex[e.id]}contains(e){return void 0!==e&&this.containsId(e.id)}containsId(e){return!!this.membersByIndex[e]}border(e=!0){return this.filter((t=>{const i=t.neighbours();return!!(e&&i.length<6)||!!i.find((e=>!this.has(e)))}))}borderIncludingShoreline(){return this.border(!0)}neighbours(){return l.union(this.map((e=>e.neighbours().filter((e=>!this.has(e))))))}neighboursOf(e){return e.neighbours((e=>this.has(e)))}components(e=(()=>!0)){let t=new n.default,i=1;const s=(t,i)=>!i||e(t,i);return this.forEach((e=>{t.getOwnerOf(e)||(t.addToGroup(i,e),t.addToGroup(i,...this.floodFillFrom(e,s).members),++i)})),t}with(...e){return l.from([...this.members,...e])}without(e){const t={...this.membersByIndex};return e.forEach((e=>delete t[e.id])),new l(t)}filter(e){return l.from(this.members.filter(e))}forEach(e){return this.members.forEach(e)}map(e){return this.members.map(e)}find(e){return this.members.find(e)}sort(e){return this.members.sort(e)}bfsFrom(e,t=(()=>!0)){let i=[];e.forEach((e=>i.push({hex:e,d:0})));let s=new Set(e.members);const n=({hex:e,d:n,parent:a})=>{s.add(e),t(e,a,n)&&e.neighbours().filter((e=>this.has(e)&&!s.has(e))).members.forEach((t=>{s.add(t),i.push({hex:t,d:n+1,parent:e})}))};for(;i.length>0;)n(i.shift())}floodFillOut(e=(()=>!0)){let t=[];this.forEach((e=>t.push({hex:e,d:0})));let i=new Set(this.members);const s=({hex:s,d:n,parent:a})=>{e(s,a,n)&&(i.add(s),s.neighbours().filter((e=>!i.has(e))).members.forEach((e=>{t.push({hex:e,d:n+1,parent:s})})))};for(;t.length>0;)s(t.shift());return l.from(Array.from(i))}customSearchFrom(e,t,i){let s=new o.default(((e,t)=>t.score-e.score));e.forEach((e=>s.push({hex:e,d:0,score:i(e)})));let n=new Set(e.members);const a=({hex:e,d:a,parent:o})=>{n.add(e),t(e,o,a)&&e.neighbours().filter((e=>this.has(e)&&!n.has(e))).members.forEach((t=>{n.add(t),s.push({hex:t,d:a+1,score:i(t),parent:e})}))};for(;s.size()>0;)a(s.pop())}findClosest(e,t){let i;return this.bfsFrom(e,(e=>!(i||t(e)&&(i=e,1)))),i}toString(){const e=this.members.slice(0,3).map((e=>e.toString())).join(",")+(this.length>3?",...":"");return`[HexGroup (${this.length}⬡): ${e}]`}findInnerMostHex(){let e=this,t=this;for(;t.length>0;)e=t,t=t.without(t.border());return e.findMax((e=>e.neighbours((e=>this.has(e))).length))}findMax(e){return this.members.reduce(((t,i)=>{const s=e(i);return s>t.score?{score:s,hex:i}:t}),{hex:void 0,score:c}).hex}floodFillFrom(e,t){const i=[...e.members];return this.bfsFrom(e,((e,s,n)=>!s||!!t(e,s,n)&&(i.push(e),!0))),l.from(i)}getCorners(){return(0,a.stripDuplicatesFrom)(this.members.map((e=>e.getCorners())).flat())}hasCorner(e){return!!e.sortedHexes.find((e=>this.has(e)))}disjointedNeighbourGroupsOf(e){return e.disjointedNeighbourGroups(e,(e=>this.has(e)))}}t.HexGroup=l,l.empty=new l({})},43991:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(35171),n=i(52163);t.default=class{constructor(){this.groups={},this.membership={},this._length=0}get length(){return this._length}addToGroup(e,...t){this.groups[e]?t.forEach((t=>this.groups[e].add(t))):this.groups[e]=new Set(t),t.forEach((t=>{const i=this.membership[t.id];void 0===i?(this.membership[t.id]=e,++this._length):i!==e&&(this.groups[i].delete(t),this.membership[t.id]=e,0===this.groups[i].size&&this.removeGroup(i))}))}getOwnerOf(e){return this.membership[e.id]}removeGroup(e){n.assert.defined(this.groups[e]),this.groups[e].forEach((e=>delete this.membership[e.id])),this._length-=this.groups[e].size,delete this.groups[e]}forEach(e){for(const t in this.groups)e(this.groups[t],t)}find(e){for(const t in this.groups)if(e(this.groups[t],t))return{key:t,hexes:this.groups[t]}}getGroupsAdjacentTo(e){let t={};const i=this.groups[e];if(!i)return[];const n=s.HexGroup.from(i);for(let e of n.neighbours().members){const i=this.getOwnerOf(e);i&&(t[i]?t[i]++:t[i]=1)}return Object.entries(t).map((([e,t])=>({key:e,hexes:this.groups[e],borderSize:t})))}map(e){let t=[];return this.forEach(((i,s)=>t.push(e(Array.from(i),s)))),t}getLargestGroup(){const e=this.getLargestGroupKey();if(void 0!==e)return s.HexGroup.from(Array.from(this.groups[e]))}getLargestGroupKey(){let e,t,i=0;return this.forEach(((s,n)=>{s.size>i&&(i=s.size,e=s,t=n)})),t}popLargestGroup(){const e=this.getLargestGroupKey();if(e){const t=this.groups[e];return this.removeGroup(e),s.HexGroup.from(Array.from(t))}throw new Error("Attempt to pop() from empty log groups collection")}getGroups(){return Object.values(this.groups).map((e=>s.HexGroup.from(Array.from(e))))}keys(){return Object.keys(this.groups)}byKey(e){return{key:e,hexes:this.groups[e]}}toString(){let e=0,t=Object.keys(this.groups).map((t=>{const i=this.groups[t].size;return e+=i,`${t}(${i})`})).join(", ");return`[HexGroupSet (${e}): ${t}]`}}},38997:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CalculatedHexGroupValuationWithCache=void 0,t.CalculatedHexGroupValuationWithCache=class{constructor(){this.values={}}get(e){return this.values[e]||(this.values[e]=this.calculate(e)),this.values[e]}getHexIds(){return Object.keys(this.values).map((e=>Number(e)))}flush(){this.values={}}}},19764:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CustomHexGroupValuation=void 0;const s=i(73735),n=i(5538);class a{constructor(e){this.defaultValue=e,this.values={}}generateFrom(e,t){e.forEach((e=>{const i=t(e);void 0!==i&&i!==this.defaultValue&&this.set(e.id,t(e))}))}generateFromIds(e,t){e.forEach((e=>{const i=t(e);void 0!==i&&i!==this.defaultValue&&this.set(e,t(e))}))}set(e,t){this.values[e]=t}unset(e){delete this.values[e]}get(e){return this.values.hasOwnProperty(e)?this.values[e]:this.defaultValue}map(e){const t=new a(e(this.defaultValue,-1));return t.importDictionary(this.exportDictionary(e)),t}exportDictionary(e){return e?(0,s.mapDictionary)(this.values,e):this.values}toString(){return`[HexGroupValuation (default=${this.defaultValue})]`}dump(){return`{\n${Object.entries(this.values).map((([e,t])=>`${e}: ${(0,n.str)(t)}`)).join("\n")}\n}`}getHexIds(){return Object.keys(this.values).map((e=>Number(e)))}importDictionary(e){Object.keys(e).forEach((t=>this.values[t]=e[t]))}clear(){this.values={}}static fromDictionary(e,t){const i=new a(t);return i.importDictionary(e),i}static fromGroupsCollection(e,t){const i=new a(t);return e.forEach(((e,t)=>{e.forEach((e=>i.set(e.id,t)))})),i}}t.CustomHexGroupValuation=a},23169:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexGroupValuationFromStateEngine=void 0,t.HexGroupValuationFromStateEngine=class{constructor(e,t){this.state=e,this.dataSet=t}get(e){return this.state.get(this.dataSet,e)}getHexIds(){return this.state.getEntryIds(this.dataSet)}}},55455:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProxyHexGroupValuation=void 0,t.ProxyHexGroupValuation=class{constructor(e,t){this.parent=e,this.proxyFunc=t}get(e){return this.proxyFunc(this.parent.get(e),e)}getHexIds(){return this.parent.getHexIds()}}},95976:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConsoleLogger=void 0;const n=s(i(11227)),a=i(51897),o=i(62199);function r(e){return n.default.enabled("game:"+e)}t.ConsoleLogger=class{log(e,t,i,...s){const c=`[${t}] ${i}`;switch(e){case o.LogLevel.Trace:r(t)&&console.trace(c,...s);break;case o.LogLevel.Debug:(0,n.default)("game:"+t)(i,...s);break;case o.LogLevel.Error:console.error(c,...s),a.ErrorTracking.captureNonFatalError({message:i,data:s},"logger.error");break;case o.LogLevel.Warning:console.warn(c,...s);break;case o.LogLevel.Info:console.info(c,...s)}}group(e,t){r(e)&&console.groupCollapsed(t)}groupEnd(e){r(e)&&console.groupEnd()}}},62199:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.logger=t.NamedLogger=t.RootLogger=t.LogLevel=void 0,function(e){e.Error="error",e.Warning="warning",e.Info="info",e.Debug="debug",e.Trace="trace"}(i=t.LogLevel||(t.LogLevel={}));class s{constructor(){this.transportsByName=new Map,this.loggersByModule=new Map}addTransport(e,t){this.transportsByName.set(e,t)}removeTransport(e){this.transportsByName.delete(e)}for(e){const t=this.loggersByModule.get(e)||new n(e,this);return this.loggersByModule.set(e,t),t}log(e,t,i,...s){for(let n of this.transportsByName.values())n.log(e,t,i,...s)}group(e,t){for(let i of this.transportsByName.values())i.group(e,t)}groupEnd(e){for(let t of this.transportsByName.values())t.groupEnd(e)}}t.RootLogger=s;class n{constructor(e,t){this.name=e,this.parentLogger=t}trace(e,...t){this.parentLogger.log(i.Trace,this.name,e,...t)}debug(e,...t){this.parentLogger.log(i.Debug,this.name,e,...t)}error(e,...t){this.parentLogger.log(i.Error,this.name,e,...t)}info(e,...t){this.parentLogger.log(i.Info,this.name,e,...t)}warning(e,...t){this.parentLogger.log(i.Warning,this.name,e,...t)}group(e){this.parentLogger.group(this.name,e)}groupEnd(){this.parentLogger.groupEnd(this.name)}}t.NamedLogger=n,t.logger=new s},65641:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.deepWatchable=t.watchable=void 0;const n=s(i(22658)),a=i(73735);t.watchable=function(e){let t,i=e,s=[];function n(){return i}return n.set=e=>{i!==e&&(i=e,s.forEach((e=>e(i,t))),t=i)},n.watch=e=>{const t=n.watchFuture(e);return setTimeout((()=>e(i,void 0)),0),t},n.watchFuture=e=>(s.push(e),{unsubscribe:()=>(0,a.removeFromArrayInPlace)(s,e)}),n},t.deepWatchable=function(e){let t=(0,n.default)(e,(function(){s.forEach((e=>e(t,i))),i=t})),i=e,s=[];function a(){return t}return a.watch=function(e){s.push(e),e(t,void 0)},a.watchFuture=function(e){s.push(e)},new Proxy(a,{get:(e,i,s)=>a.hasOwnProperty(i)?a[i]:t[i]})}},41682:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createRandomGenerator=t.ID_TYPE=void 0;const s=i(6571),n=i(71203),a=i(64296);var o=Phaser.Math.PI2;t.ID_TYPE={User:{prefix:"u",size:8},Level:{prefix:"l",size:8},Error:{prefix:"e",size:8}},t.createRandomGenerator=function(e){const t=(0,a.customAlphabet)("01234567890qwertzuiopasdfghjklyxcvbnmQWERTZUIOPASDFGHJKLYXCVBNM");function i(t=Math.floor(1e5*Math.random())){e=t}function r(){var t=1e4*Math.sin(e++);return t-Math.floor(t)}function c(e,t){return Math.floor(r()*(t-e+1))+e}return i(e),{reset:i,number:r,numberBetween:function(e,t){return r()*(t-e)+e},oneOf:function(e){return e[c(0,e.length-1)]},popFrom:function(e){return e.splice(c(0,e.length-1),1)[0]},hex:function(e){return e.members[c(0,e.length-1)]},property:function(e){var t,i=0;for(var s in e)r()<1/++i&&(t=s);return t},integerBetween:c,shuffle:function(e){let t,i,s=[...e],n=s.length;for(;0!==n;)i=Math.floor(r()*n),n-=1,t=s[n],s[n]=s[i],s[i]=t;return s},boolean:function(e=.5){return r()<e},point:function(e){const t=e*Math.sqrt(r()),i=r()*o;return{x:t*Math.cos(i),y:t*Math.sin(i)}},townName:function(){return n.inject.random.oneOf(s.townNamePrefixes)+n.inject.random.oneOf(s.townNameSuffixes).toLowerCase()},id:function(e){return e.prefix+"-"+t(e.size)}}}},61720:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StateContainer=void 0,i(62199).logger.for("StateContainer"),t.StateContainer=function(e,t){let i=t;function s(){return i}return s.update=t=>{const s={...i,...t};e.applyState(t,s,i),i=s},s}},30833:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseUpdater=void 0,i(62199).logger.for("BaseUpdater"),t.BaseUpdater=class{constructor(e){this.dataSet=e,this.handlers=[],this.initFromState=e=>{this.newState=e,this.oldState=void 0,this.builder.init(e),this.initialize()},this.update=(e,t,i)=>(this.newState=e,this.changeSet=t,this.oldState=i,this.builder.init(e),this.initialize(),this.handlers.forEach((({dataSet:e,handler:t})=>{const i=this.changeSet.of(e);i&&t(i)})),this.createMutation()),this.registerHandlers(((e,t)=>this.handlers.push({dataSet:e,handler:t.bind(this)})))}createMutation(){return this.builder.createMutation("parents changed")}initialize(){}}},27413:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChangeSet=void 0;const s=i(52163),n=i(5538);t.ChangeSet=class{constructor(e){this.mutations=new Map,this.title="empty",e?.forEach((e=>this.add(e)))}add(e){s.assert.undefined(this.mutations.get(e.dataSet),`changeSet already contains mutation for "${e.dataSet.key}" (${(0,n.str)(e)})`),this.title=e.dataSet.key,this.mutations.set(e.dataSet,e)}all(){return Array.from(this.mutations.values())}of(e){return this.mutations.get(e)?.changes}require(e){const t=this.of(e);return s.assert.defined(t,`DataSet "${e.key}" not found in ${this}`),t}toString(){return`[ChangeSet<${Array.from(this.mutations.values()).map((e=>e.dataSet.key)).join(",")}>]`}}},85044:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isImmutableState=t.updateActiveDataSets=t.isProjectionDataSet=t.selectFromSuspendedState=t.selectFromState=t.getActiveProjections=t.getActiveDataSets=t.isDataSetActive=t.assertStateHasDataSet=t.getParentEngine=t.setParentEngine=t.applyMutations=t.createImmutableState=t.PARENT_ENGINE_KEY=t.ACTIVE_DATASETS_KEY=t.EMPTY_SET=void 0;const n=s(i(35369)),a=i(52163);function o(e){return e.get(t.PARENT_ENGINE_KEY)}function r(e,i){return e.get(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET).has(i)}function c(e){return e.get(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET)}function l(e){return!!e.bootstrap}t.EMPTY_SET=n.default.Set(),t.ACTIVE_DATASETS_KEY="_activeDataSets",t.PARENT_ENGINE_KEY="_parentEngine",t.createImmutableState=function(e,i){return n.default.Map({[t.ACTIVE_DATASETS_KEY]:n.default.Set(i),[t.PARENT_ENGINE_KEY]:e})},t.applyMutations=function(e,...t){const i=o(e);if(i.currentState!==e)throw new Error("Attempt to apply mutation to state that is no longer active in the parent engine");return i.apply(...t),i.currentState},t.setParentEngine=function(e,i){return e.set(t.PARENT_ENGINE_KEY,i)},t.getParentEngine=o,t.assertStateHasDataSet=function(e,t){if(!r(e,t))throw new Error(`dataSet ${t} not available in the state (available dataSets: ${c(e).map((e=>`"${e.key}"`)).join(",")})`)},t.isDataSetActive=r,t.getActiveDataSets=c,t.getActiveProjections=function(e){return c(e).filter((e=>l(e)))},t.selectFromState=function(e,t,i){return(0,a.assert)(r(e,t),`dataSet ${t} not available in the state`),void 0!==i?t.getEntryById(e,i):e.get(t.key)},t.selectFromSuspendedState=function(e,t,i){return t.getEntryById(e,i)},t.isProjectionDataSet=l,t.updateActiveDataSets=function(e,i){return e.update(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET,i)},t.isImmutableState=function(e){return n.default.Map.isMap(e)}},60263:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Mutator=t.StateEngine=void 0;const n=s(i(35369)),a=i(73735),o=i(62199),r=i(27413),c=i(85059),l=i(96486),d=i(5538),h=i(52163),u=i(85044),g=o.logger.for("StateEngine");t.StateEngine=class{constructor(){this.roots={},this.projections={},this.children=new Map,this.watchers={},this.globalListeners=new Set,this.currentState=(0,u.createImmutableState)(this,[])}_addPrimary(e,t){return(0,h.assert)(!this.roots[t.key],`dataSet ${t.key} already exists in the state engine!`),this.roots[t.key]=t,e.set(t.key,t.defaultValue)}add(...e){let t=[];return e.forEach((e=>{(0,u.isProjectionDataSet)(e)?this._addProjection(e):(t.push(e),this.currentState=this._addPrimary(this.currentState,e))})),this._updateState((e=>(0,u.updateActiveDataSets)(e,(e=>e.union(n.default.Set(t)))))),this.updateSequence=this.getProjectionsBootstrapSequence(),this}suspend(...e){if(!e.length)return;const t=e.filter(u.isProjectionDataSet);this._mutateState((e=>{(0,u.updateActiveDataSets)(e,(e=>e.subtract(t)))}))}activate(...e){if(!e.length)return;const t=this.getProjectionsBootstrapSequence(e.filter((e=>!this.isDataSetActive(e))));this.currentState=this.currentState.deleteAll(t.map((e=>e.key)));const i=this.currentState;t.forEach((e=>{const t=e.bootstrap(this.currentState);this.currentState=this.currentState.set(e.key,t),this.currentState=(0,u.updateActiveDataSets)(this.currentState,(t=>t.add(e)))})),this._notifyWatchersAfterChanges(this.currentState,[],i,t)}activateAllProjections(){this.activate(...Object.values(this.projections))}suspendAllProjections(){this.suspend(...Object.values(this.projections))}activateOnly(...e){const t=new Set,i=[...e].filter(u.isProjectionDataSet);for(;i.length;){const e=i.pop();t.add(e),(0,u.isProjectionDataSet)(e)&&e.parents?.filter(u.isProjectionDataSet).forEach((e=>{e&&i.push(e)}))}const s=this.getActiveProjections().subtract(t);this.suspend(...s.toArray()),this.activate(...Array.from(t))}getActiveDataSets(){return(0,u.getActiveDataSets)(this.currentState)}getActiveProjections(){return this.getActiveDataSets().filter((e=>(0,u.isProjectionDataSet)(e)))}isDataSetActive(e){return this.getActiveDataSets().has(e)}_updateState(e){this.currentState=e(this.currentState)}_mutateState(e){this.currentState=this.currentState.withMutations(e)}_addProjection(e){this.projections[e.key]=e,e.parents.forEach((t=>{const i=this.children.get(t);i?i.push(e):this.children.set(t,[e])}))}apply(...e){e.forEach((e=>{const t=e.dataSet,i=this.roots[t.key];if(i!==t)throw void 0===i?this.projections[t.key]?new Error(`dataSet "${t.key}" is a projection, it cannot be updated manually!`):new Error(`no such dataSet: ${t.key}`):new Error(`dataSet mismatch for key "${t.key}" - registered instance in state engine is different than the instance passed into update()`)})),this._applyMutationsAndNotifyWatchers(...e)}_applyMutationsAndNotifyWatchers(...e){g.group(`New mutations from "${e[0]?.context}"]\n${e.map((e=>` • ${e.dataSet.key}: ${(0,d.str)(e.changes)}`)).join("\n")}`);const t=c.timing.start("StateEngine update"),i=new p(this,e);return this.currentState=i.apply(),this._notifyWatchersAfterChanges(this.currentState,e,i.startingState,i.getChangedDataSets()),t.complete(`updated ${Array.from(i.getChangedDataSets()).map((e=>`"${e.key}"`)).join(", ")}`),g.groupEnd(),this.currentState}_notifyWatchersAfterChanges(e,t,i,s){if(s[Symbol.iterator]().next().value){this.globalListeners.forEach((s=>s(e,t,i)));for(let n of s){const s=this.watchers[n.key];s&&s.forEach((s=>{s(e,t,i)}))}}}get(e,t){return this.assertActive(e),(0,u.selectFromState)(this.currentState,e,t)}setState(e){const t=this.currentState;this.currentState=e,(0,u.setParentEngine)(e,this);const i=this.getAllDataSets().filter((i=>e.get(i.key)!==t.get(i.key)));this._notifyWatchersAfterChanges(e,[],t,i)}getEntryIds(e){return e.getEntryIds(this.currentState)}serialize(){return(0,a.mapDictionary)(this.roots,((e,t)=>e.serialize(this.currentState.get(t))))}clear(){this.currentState=(0,u.createImmutableState)(this,this.getActiveDataSets())}watchAll(e){this.globalListeners.add(e)}watchDataSet(e,t){this.assertHas(e),(0,a.pushIntoArrayByKey)(this.watchers,e.key,t)}stopWatching(e,t){t?(0,a.removeFromArrayInPlace)(this.watchers[t.key]||[],e):this.globalListeners.delete(e)}assertActive(e,t){if(!this.isDataSetActive(e))throw this.assertHas(e,t),new Error(`DataSet ${e} is suspended`+(t?` (${t})`:""))}assertHas(e,t){const i=this.getDataSetByKey(e.key);if(i!==e){throw(e=>new Error(e+(t?` (${t})`:"")))(i?`DataSet with key "${e.key}" already exists, but is not the expected instance`:`DataSet with key "${e.key}" not found in the state engine`)}}getAllDataSets(){return n.default.Set([...Object.values(this.roots),...Object.values(this.projections)])}deserialize(e){const t=c.timing.start("ImmutableState deserialization");this.clear();for(let[t,i]of Object.entries(this.roots))try{this.currentState=this.currentState.set(t,i.deserialize(e[t]))}catch(i){throw i.message=`Failed to deserialize ${t} from ${JSON.stringify(e)} \n\n${i.message}`,i}this.getProjectionsBootstrapSequence().forEach((e=>{this.isDataSetActive(e)&&(this.currentState=this.currentState.set(e.key,e.bootstrap(this.currentState)))})),this._notifyWatchersAfterChanges(this.currentState,[],this.currentState,this.getAllDataSets()),t.complete()}sortProjections(e){const t=new Set(e);return this.getProjectionsBootstrapSequence(e).filter((e=>t.has(e)))}getProjectionsBootstrapSequence(e=Object.values(this.projections)){let t=Object.values(this.roots),i=[...t];return e.forEach((e=>{i.includes(e)||this._resolveDeps(e,"<root>",i)})),i.slice(t.length)}getDependencyMap(){let e={};return Object.values(this.roots).forEach((t=>{e[t.key]=this._getDepTree(t)})),e}getParentsMap(e){if((0,u.isProjectionDataSet)(e)){const t={};return e.parents.forEach((e=>t[e.key]=this.getParentsMap(e))),t}return"<root>"}_getDepTree(e){let t={};return this.assertHas(e),(this.children.get(e)||[]).forEach((e=>{t[e.key]=this._getDepTree(e)})),t}_resolveDeps(e,t,i,s=new Set){s.add(e),this.assertHas(e,`required by ${t}`);for(let n of e.parents)if(!i.includes(n)){if(!(0,u.isProjectionDataSet)(n))throw new Error(`missing primary dataSet ${n} (required by ${t})`);if(s.has(n))throw new Error(`circular reference detected: ${e} -> ${n}`);this._resolveDeps(n,e,i,s)}i.push(e),s.delete(e)}getDataSetByKey(e){return this.roots[e]||this.projections[e]}childrenOf(e){return this.children.get(e)||[]}};class p{constructor(e,t){this.stateEngine=e,this.mutations=t,this.dirty=new Set,this.updated=new Set,this.changeSet=new r.ChangeSet,this.startingState=this.stateEngine.currentState,this.currentState=this.startingState}apply(){this.mutations.forEach((e=>{this.applyMutation(e)}));for(let e of this.stateEngine.updateSequence)this.dirty.has(e)&&this.stateEngine.isDataSetActive(e)&&this.resolve(e);return this.currentState}makeChildrenDirty(e){const t=this.stateEngine.childrenOf(e).filter((e=>this.stateEngine.isDataSetActive(e)));t.length,t.forEach((e=>this.dirty.add(e)))}resolve(e){(0,h.assert)(this.stateEngine.isDataSetActive(e),`Attempt to resolve suspended projection ${e}`);const t=e.update(this.currentState,this.changeSet,this.startingState);!t||void 0===t.changes||"object"==typeof t.changes&&(0,l.isEmpty)(t.changes)||this.applyMutation(t)}applyMutation(e){this.currentState=e.dataSet.apply(this.currentState,e.changes),this.changeSet.add(e),this.updated.add(e.dataSet),this.makeChildrenDirty(e.dataSet)}getChangedDataSets(){return this.updated}}t.Mutator=p},2733:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BLACKLISTED_KEYS=t.getCanonicalStateSnapshot=void 0;const n=i(85044),a=s(i(96486));function o(e,i){for(let s in e)i&&!i.has(s)||t.BLACKLISTED_KEYS.has(s)?delete e[s]:(Array.isArray(e[s])&&(e[s]=e[s].sort()),0===e[s]&&delete e[s],"object"==typeof e[s]&&null!==e[s]&&("Hex"==e[s].constructor.name&&(e[s]=e[s].id),a.default.isEqual(e[s],{})&&delete e[s],o(e[s])))}t.getCanonicalStateSnapshot=function(e){const t=new Set,i=(0,n.getActiveDataSets)(e).map((e=>e.key)).asImmutable().filter((e=>!t.has(e))),s=e.filter(((e,t)=>i.has(t))).map(((e,t)=>e)).toJS();return o(s,i),s},t.BLACKLISTED_KEYS=new Set(["child","children","parent","parents"])},44150:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LazyView=t.ViewCache=void 0,i(62199).logger.for("Selector");class s{constructor(e){this.parentDataSets=e}handleNewState(e){e!==this.lastState&&this.didParentDataSetsChangedInNewState(e)&&this.flush(),this.lastState=e}didParentDataSetsChangedInNewState(e){return this.parentDataSets.find((t=>e.get(t.key)!==this.lastState?.get(t.key)))}flush(){this.data={}}set(e,t){this.data[e]=t}get(e){return this.data[e]}has(e){return this.data.hasOwnProperty(e)}getOrCalculate(e,t){return void 0===e?t():(this.has(e)||this.set(e,t()),this.get(e))}}t.ViewCache=s,t.LazyView=class{constructor(e){this.cache=new s(e)}get(e,t){this.cache.handleNewState(e);const i=this.getCacheKey(t)?.toString();return this.cache.getOrCalculate(i,(()=>this.calculate(e,t)))}}},47181:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MapMutationBuilder=t.MapDataSet=void 0;const n=s(i(35369)),a=i(96486),o=i(85044),r=i(52163);t.MapDataSet=class{constructor(e){this.key=e,this.defaultValue=n.default.Map()}deserialize(e){let t=n.default.Map();return Object.entries(e).forEach((([e,i])=>{t=t.set(Number(e),i)})),t}serialize(e){return e.toJS()}apply(e,t){return e.withMutations((e=>{t.updated?.forEach((([t,i])=>{void 0===i?e.deleteIn([this.key,t]):e.setIn([this.key,t],i)}))}))}createMutation(e,t){let i={};if(e.set&&!(0,a.isEmpty)(e.set)&&(i.updated=Object.entries(e.set).map((([e,t])=>[Number(e),t]))),e.delete&&!(0,a.isEmpty)(e.delete)){const t=e.delete.map((e=>[e,void 0]));i.updated?i.updated.push(...t):i.updated=t}return{dataSet:this,changes:i,context:`${this.key}/${t}`}}getEntryById(e,t){return e.getIn([this.key,t])}entryToString(e){return e.toString()}entryToDebugString(e){return JSON.stringify(e)}getEntryIds(e){return e.get(this.key)?.keySeq().toArray()||[]}toString(){return`[MapDataSet "${this.key}"]`}},t.MapMutationBuilder=class{constructor(e){this.dataSet=e}init(e){return this.state=e,this._entriesToSet={},this._entriesToDelete=new Set,this}set(e,t){return r.assert.defined(this.state,"builder not initialized!"),this._entriesToDelete.delete(e),this._entriesToSet[e]=t,this}setFromBootstrap(){r.assert.defined(this.state,"builder not initialized!"),(0,r.assert)((0,o.isProjectionDataSet)(this.dataSet),`Cannot call setFromBootstrap on ${this.dataSet} - it's not a projection`),this._entriesToSet=this.dataSet.bootstrap(this.state).toObject()}delete(e){r.assert.defined(this.state,"builder not initialized!"),delete this._entriesToSet[e],this._entriesToDelete.add(e)}getCurrent(e){if(r.assert.defined(this.state,"builder not initialized!"),!this._entriesToDelete.has(e))return this._entriesToSet.hasOwnProperty(e)?this._entriesToSet[e]:this.state.getIn([this.dataSet.key,e])}has(e){return!!this.get(e)}get(e){if(r.assert.defined(this.state,"builder not initialized!"),!this._entriesToDelete.has(e))return this._entriesToSet[e]}getEntries(){return r.assert.defined(this.state,"builder not initialized!"),this._entriesToSet}clear(){throw new Error("Not Implemented")}createMutation(e){return r.assert.defined(this.state,"builder not initialized!"),this.dataSet.createMutation({set:this._entriesToSet,delete:Array.from(this._entriesToDelete).filter((e=>void 0!==this.state.getIn([this.dataSet.key,e])))},e)}setAll(e,t){e.forEach((e=>this.set(e,t)))}}},17653:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MultiMapMutationBuilder=t.MultiMapDataSet=void 0;const n=i(96486),a=s(i(35369)),o=i(85044),r=i(52163);t.MultiMapDataSet=class{constructor(e){this.key=e,this.defaultValue=a.default.Map()}deserialize(e){let t=a.default.Map();return Object.entries(e).forEach((([e,i])=>{t=t.set(Number(e),a.default.Set(i))})),t}serialize(e){return e.toJS()}apply(e,t){return e.withMutations((e=>{t.updated?.forEach((t=>{t.removed&&(e.updateIn([this.key,t.id],o.EMPTY_SET,(e=>e.subtract(t.removed))),e.getIn([this.key,t.id]).isEmpty()&&e.deleteIn([this.key,t.id])),t.added&&e.updateIn([this.key,t.id],o.EMPTY_SET,(e=>e.union(t.added)))}))}))}createMutation(e,t){let i={},s=e.remove&&Object.entries(e.remove).filter((([e,t])=>t.size)),a=e.add&&Object.entries(e.add).filter((([e,t])=>t.size));return(a&&!(0,n.isEmpty)(a)||s&&!(0,n.isEmpty)(s))&&(i.updated=[],a?.forEach((([t,s])=>{const n={id:Number(t),added:Array.from(s)};e.remove&&e.remove[t]?.size&&(n.removed=Array.from(e.remove[t])),i.updated.push(n)})),s?.forEach((([t,s])=>{const n=Number(t);e.add&&e.add[Number(n)]?.size||i.updated.push({id:Number(n),removed:Array.from(s)})}))),{dataSet:this,changes:i,context:`${this.key}/${t}`}}getEntryById(e,t){return e.getIn([this.key,t])}getEntryIds(e){return e.get(this.key).keySeq().toArray()}entryToString(e){return e.map((e=>e.toString())).toArray().join(",")}entryToDebugString(e){return e.map((e=>e.toString())).toArray().join(",")}toString(){return`[MultiMapDataSet "${this.key}"]`}},t.MultiMapMutationBuilder=class{constructor(e,t){this.dataSet=e,this._itemsToAdd={},this._itemsToRemove={},t&&this.init(t)}init(e){this.state=e,this._itemsToAdd={},this._itemsToRemove={}}add(e,...t){return this._itemsToAdd[e]||(this._itemsToAdd[e]=new Set),t.forEach((t=>{r.assert.defined(t),this._itemsToRemove[e]?.has(t)?this._itemsToRemove[e].delete(t):this.getCurrent(e).has(t)||this._itemsToAdd[e].add(t)})),this}has(e,t){return!this._itemsToRemove[e]?.has(t)&&!!this._itemsToAdd[e]?.has(t)}getCurrent(e){let t=this.dataSet.getEntryById(this.state,e)||o.EMPTY_SET;return this._itemsToRemove[e]&&(t=t.subtract(this._itemsToRemove[e])),this._itemsToAdd[e]&&(t=t.union(this._itemsToAdd[e])),t}currentHas(e,t){return!this._itemsToRemove[e]?.has(t)&&(!!this._itemsToAdd[e]?.has(t)||this.dataSet.getEntryById(this.state,e)?.has(t))}hasRemoved(e,t){return!!this._itemsToRemove[e]?.has(t)}remove(e,...t){this._itemsToRemove[e]||(this._itemsToRemove[e]=new Set),t.forEach((t=>{r.assert.defined(t),this._itemsToAdd[e]?.has(t)?this._itemsToAdd[e].delete(t):this.dataSet.getEntryById(this.state,e)?.has(t)&&this._itemsToRemove[e].add(t)}))}removeEntry(e){const t=this.dataSet.getEntryById(this.state,e);t&&t.size&&(delete this._itemsToAdd[e],this._itemsToRemove[e]=new Set(t.toArray()))}clear(){throw new Error("Not implemented")}createMutation(e){return this.dataSet.createMutation({add:this._itemsToAdd,remove:this._itemsToRemove},e)}}},69158:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SetDataSetMutationBuilder=t.SetDataSet=void 0;const n=s(i(35369)),a=i(85044),o=i(52163);t.SetDataSet=class{constructor(e){this.key=e,this.defaultValue=n.default.Set()}deserialize(e){return n.default.Set(e)}serialize(e){return e.toArray()}apply(e,t){t.cleared&&(e=e.set(this.key,n.default.Set()));let i=e.get(this.key);return t.addedEntries&&(i=i.union(t.addedEntries)),t.deletedEntries&&(i=i.subtract(t.deletedEntries)),e.set(this.key,i)}getEntryById(e,t){return e.get(this.key).has(t)}getEntryIds(e){return[]}entryToString(e){return e.toString()}entryToDebugString(e){return e.toString()}createMutation(e,t){let i={};return e.clear&&(i.cleared=!0),e.add&&e.add.length&&(i.addedEntries=e.add),e.delete&&e.delete.length&&(i.deletedEntries=e.delete),{dataSet:this,changes:i,context:`${this.key}/${t}`}}toString(){return`[SetDataSet "${this.key}"]`}},t.SetDataSetMutationBuilder=class{constructor(e){this.dataSet=e}init(e){this.state=e,this._itemsToDelete=new Set,this._itemsToAdd=new Set,this._clear=!1}add(...e){o.assert.defined(this.state,"builder not initialized!"),e.forEach((e=>{this._itemsToDelete.has(e)?this._itemsToDelete.delete(e):this._itemsToAdd.add(e)}))}delete(...e){o.assert.defined(this.state,"builder not initialized!"),e.forEach((e=>{this._itemsToAdd.has(e)?this._itemsToAdd.delete(e):this._itemsToDelete.add(e)}))}createMutation(e){const t=(0,a.selectFromState)(this.state,this.dataSet);return this.dataSet.createMutation({clear:this._clear,add:Array.from(this._itemsToAdd).filter((e=>!t.has(e))),delete:Array.from(this._itemsToDelete).filter((e=>t.has(e)))},e)}clear(){this._clear=!0}}},24534:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SingletonDataSet=void 0,t.SingletonDataSet=class{constructor(e,t){this.key=e,this.defaultValue=t}apply(e,t){return e.set(this.key,t)}deserialize(e){return e}serialize(e){return e}createMutation(e,t){return{dataSet:this,changes:e,context:t}}getEntryById(e,t){throw new Error(`Cannot extract entry ${t} from SingletonDataSet ${this.key} (SingletonDataSet has no entries)`)}entryToString(e){return""}entryToDebugString(e){return""}getEntryIds(e){return[]}toString(){return`[SingletonDataSet "${this.key}"]`}}},16001:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FilteredMultiMapProjection=void 0;const s=i(17653),n=i(85044);class a extends s.MultiMapDataSet{constructor(e,t,i=[]){super(e),this.key=e,this.filteredDataSet=t,this.parents=[t,...i]}bootstrap(e){return(0,n.selectFromState)(e,this.filteredDataSet).map((t=>t.filter((t=>this.constraint(e,t))))).filter((e=>!e.isEmpty())).map((t=>t.map((t=>this.transform(e,t)))))}update(e,t,i){const n=t.of(this.filteredDataSet);if(!n)return;const a=new s.MultiMapMutationBuilder(this,e);return n.updated?.forEach((t=>{let s=t.id;if(t.added&&a.add(s,...t.added.filter((t=>this.constraint(e,t))).map((t=>this.transform(e,t)))),t.removed){const n=this.getEntryById(e,s);if(!n)return;a.remove(s,...t.removed.filter((e=>this.constraint(i,e))).map((e=>this.transform(i,e))).filter((e=>n.has(e))))}})),a.createMutation(this.filteredDataSet.key)}}t.FilteredMultiMapProjection=a},41640:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.InvertedMapProjection=void 0;const n=i(73735),a=s(i(35369)),o=i(17653),r=i(85044);class c extends o.MultiMapDataSet{constructor(e,t){super(e),this.key=e,this.source=t,this.parents=[this.source]}bootstrap(e){const t=(0,r.selectFromState)(e,this.source);if(!t)return a.default.Map();const i=[];if(!a.default.Map.isMap(t))throw console.error(t),new Error(`${this.source.key} is invalid source for InvertedMapProjection: ${t} is not an Immutable.Map instance`);return t.forEach(((e,t)=>{(0,n.pushIntoArrayByKey)(i,e,t)})),s=i,a.default.Map().withMutations((e=>{for(let[t,i]of Object.entries(s))e.set(Number(t),a.default.Set(i))}));var s}update(e,t,i){const s=t.require(this.source),n=new o.MultiMapMutationBuilder(this,e);return s.updated?.forEach((([e,t])=>{const s=(0,r.selectFromState)(i,this.source,e);void 0!==s&&n.remove(s,e),void 0!==t&&n.add(t,e)})),n.createMutation(this.source.key+" changed")}entryToString(e){return`[${e.size}]`}}t.InvertedMapProjection=c},44334:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NextIdProjection=void 0;const s=i(1951),n=i(24534),a=i(85044);class o extends n.SingletonDataSet{constructor(e,t){super(e,1),this.source=t,this.parents=[this.source]}bootstrap(e){const t=(0,a.selectFromState)(e,this.source);return t?t.keySeq().reduce(s.max,0)+1:1}update(e,t,i){let s=(0,a.selectFromState)(i,this)||0,n=s;const o=t.require(this.source);let r=!1;if(o.updated?.forEach((e=>{if(Array.isArray(e)){const[t,i]=e;void 0!==i?t>=n&&(n=t+1):r=!0}else{const t=e;t.added&&t.id>=n&&(n=t.id+1),t.removed&&(r=!0)}})),r)for(;n>1&&!(0,a.selectFromState)(e,this.source,n-1);)n-=1;return n!==s?this.createMutation(n,this.source.key):void 0}}t.NextIdProjection=o},93122:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compareStrings=t.prefixEachLineWith=t.padLeft=t.padRight=void 0,t.padRight=function(e,t){return e.length===t?e:e.length>t?e.slice(0,t):e+" ".repeat(t-e.length)},t.padLeft=function(e,t){return e.length===t?e:e.length>t?e.slice(0,t):" ".repeat(t-e.length)+e},t.prefixEachLineWith=function(e,t){return t.split("\n").map((t=>e+t)).join("\n")},t.compareStrings=function(e,t){return e>t?1:e<t?-1:0}},85059:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timing=t.TimingHandle=t.Timing=void 0;const s=i(62199),n=i(38735);s.logger.for("timing");class a{start(e){return new o(e)}since(e){return Math.floor(performance.now()-e)}}t.Timing=a;class o{constructor(e){this.key=e,this.start=performance.now()}complete(e){return Math.ceil(performance.now()-this.start)}reportAs(e){const t=this.complete();n.track.timingComplete({name:e,value:t})}}t.TimingHandle=o,t.timing=new a},6571:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.townNameSuffixes=t.townNamePrefixes=void 0,t.townNamePrefixes=["Agate","Al","Amber","Amethyst","Ametrine","Ander","Apple","Arbor","Ard","Arrow","Ash","Ashen","Auburn","Autumn","Back","Bain","Baldur","Bane","Baron","Barron","Barrow","Basalt","Beach","Bear","Beech","Bell","Belle","Beryl","Big","Birch","Bitter","Black","Blade","Blue","Bog","Bone","Border","Boulder","Brass","Break","Breeze","Briar","Bridge","Brier","Bright","Brim","Burn","Castle","Cedar","Chamber","Chill","Cinder","Clay","Cold","Condor","Corner","Crab","Crag","Craw","Crown","Crystal","Dag","Dark","Day","Dead","Deep","Dire","Dragon","Drake","Draken","Dread","Dusk","Eagle","East","Ebon","Eden","Edge","Edin","Elder","Elm","Ember","Emerald","Ever","Fae","Fair","Faire","Fal","Fall","Fel","Fell","Fey","Fir","Fire","Flint","Fog","Fort","Free","Full","Gay","Gem","Glow","Gold","Grand","Granite","Grass","Grave","Gray","Green","Grey","Griffon","Gryphon","Guild","Half","Hallow","Hammer","Hard","Hawk","Heart","Hearth","Heath","Hedge","Hem","High","Hills","Hollow","Home","Hope","Horn","Iron","Jade","Jasper","Kent","Key","King","Kings","Kirk","Kraig","Lady","Lake","Larch","Law","Leaf","Ledge","Ley","Lime","Lion","Little","Liver","Loch","Lone","Love","Low","Lower","Maiden","Main","Man","Mans","Maple","Marble","Marsh","Mason","Mass","May","Mead","Meadow","Mid","Middle","Mine","Mist","Mithril","Moon","Mord","Moss","Mourn","Mud","Murk","Myst","Mythril","Nettle","Never","New","Night","North","Oak","Old","Onyx","Opal","Pale","Peace","Pike","Pine","Plum","Point","Pond","Port","Prince","Pyre","Queen","Queens","Quiet","Rain","Rainbow","Ram","Raven","Red","Redwood","Rex","Rich","Ridge","Ring","River","Rock","Rose","Ruby","Rune","Sage","Sand","Sapphire","Sea","Sedge","Shade","Sharp","Sharpe","Shatter","Shaw","Shell","Shield","Shire","Shore","Silver","Skull","Sky","Slade","Snow","Sound","South","Spine","Spring","Stan","Star","Still","Stock","Stone","Stony","Storm","Stout","Strath","Strom","Summer","Sun","Sunny","Sword","Tangle","Teak","Temple","Timber","Topaz","Torch","Tower","Tree","True","Tumble","Twin","Tyr","Umber","Umbur","Under","Upper","Wake","Wall","War","Water","Way","Wedge","West","Wet","Whet","Whit","White","Wild","Will","Willow","Win","Wind","Winter","Wolf","Wood","Wren","Wyn","Yew"],t.townNameSuffixes=["Back","Bank","Bard","Baron","Barron","Basin","Bay","Beach","Beck","Bell","Ben","Berg","Black","Bluff","Blum","Bog","Border","Borough","Bourg","Bourne","Brad","Brake","Breach","Breeze","Bridge","Brook","Burg","Burn","Bury","By","Call","Camp","Castle","Chester","City","Corner","Cott","Court","Cove","Crag","Creek","Crest","Cross","Crossroad","Crown","Dag","Dale","Dane","Dark","Deep","Del","Dell","Dike","Dorf","Drake","Dune","Edge","Encampment","End","Fair","Faire","Fal","Fall","Falls","Fast","Fax","Fel","Feldt","Fell","Felt","Field","Fire","Flint","Font","Ford","Forge","Forks","Forth","Full","Gard","Garde","Garden","Gardr","Gate","Gem","Gill","Glen","Glow","Grad","Grade","Grass","Grave","Grove","Guard","Guild","Hall","Hallow","Ham","Hamlet","Hand","Harbour","Haven","Head","Heart","Heed","Heim","Helm","Hill","Hold","Hollow","Holm","Holme","Holt","Home","Hood","Hope","Horse","Ington","Inlet","Island","Isle","Joy","Junction","Keep","Kraig","Lagoon","Lain","Lake","Land","Landing","Lands","Law","Leaf","Leap","Ledge","Letter","Light","Line","Lock","Lodge","Loft","Maiden","Mane","March","Marsh","Mass","Mead","Mere","Mesa","Mile","Mill","Mine","Mond","Mont","Moor","Mora","More","Morra","Mount","Mouth","Murk","Nook","Pad","Park","Pass","Path","Peak","Perch","Pier","Pike","Pine","Pines","Point","Pond","Pool","Poole","Port","Quarry","Quil","Quill","Quin","Quinn","Rain","Rapids","Ray","Reach","Reign","Rest","Ridge","Right","Ring","River","Rock","Roost","Rose","Roth","Rott","Row","Rowe","Run","Rune","Ruun","Sand","Settlement","Shadow","Sharp","Sharpe","Shaw","Shield","Shine","Ship","Shire","Shore","Side","Sierra","Sigil","Snow","Sol","Son","Sor","Sound","Spear","Spot","Square","Stad","Stain","Stane","Star","Station","Stead","Steppe","Stock","Ston","Stone","Stow","Strand","Strike","Summit","Sword","Sworth","Tarn","Tear","Thorn","Thorne","Thorpe","Throw","Ton","Tower","Town","Township","Trail","Tucket","Vale","Valley","Valt","Vanguard","Vault","Veldt","View","Village","Ville","Wake","Wall","Ward","Wash","Watch","Water","Way","Weald","Well","Wharf","Wheel","Wich","Wick","Wild","Wile","Will","Wind","Wing","Wolf","Wolfe","Wood","Worth","Wright","Wyn"],new Map([["Animals",["Badger","Bat","Boar","Buck","Bull","Calf","Canary","Cat","Cattle","Chick","Chicken","Clam","Cob","Cock","Cockatiel","Cockatoo","Cockerel","Cockle","Colt","Cow","Crab","Crow","Cub","Deer","Doe","Dog","Donkey","Dove","Drake","Dray","Duck","Duckling","Ewe","Eyas","Fawn","Ferret","Foal","Fox","Frog","Gander","Gerbil","Goat","Goose","Gosling","Hamster","Hare","Hawk","Hedgehog","Hen","Heron","Horse","Jack","Jenny","Jill","Kid","Kingfisher","Kit","Kitten","Lamb","Leveret","Lobster","Mare","Mole","Mouse","Mussel","Nanny","Newt","Otter","Owl","Owlet","Oyster","Peachick","Peacock","Peafowl","Peahen","Pheasant","Pig","Pigeon","Piglet","Pike","Prickle","Pup","Puppy","Rabbit","Ram","Rat","Robin","Rook","Salmon","Sheep","Signet","Snail","Snake","Sneak","Sow","Sparrow","Spider","Squab","Squirrel","Stag","Stallion","Starling","Stoat","Swan","Tiercel","Toad","Trout","Vixen","Weasel"]],["Geography",["Basin","Bay","Bluffs","Bush","Canal","Canyon","Cave","Cliff","Crag","Crater","Creek","Dale","Down","Falls","Fern","Flats","Forest","Fork","Glacier","Grotto","Heights","Hill","Hollow","Island","Knoll","Lagoon","Lake","Marsh","Mountain","Narrows","Overlook","Pass","Peak","Plain","Pond","Ravine","Reef","Ridge","River","Sound","Tree","Vale","Valley","Woods"]],["Geology",["Agate","Aluminum","Amber","Amethyst","Basalt","Brass","Bronze","Chalk","Chrome","Clay","Coal","Copper","Coral","Diamond","Emerald","Feldspar","Flint","Gold","Granite","Gypsum","Iron","Jade","Jasper","Lead","Limestone","Marble","Mercury","Mica","Pewter","Platinum","Pyrite","Quartz","Ruby","Sandstone","Shale","Silt","Silver","Slate","Steel","Tin","Topaz"]]])},52163:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssertionError=t.assert=void 0;const s=i(5538);function n(e,t=`expected ${e} to be truthy`){if(!e)throw new a(e,t)}t.assert=n,n.defined=(e,t=`expected ${e} to be defined`)=>{if(!(0,s.isDefined)(e))throw new a(e,t)},n.undefined=(e,t=`expected ${e} to be undefined`)=>{if((0,s.isDefined)(e))throw new a(e,t)},n.naturalNumber=(e,t=`expected ${e} to be a natural number`)=>{n("number"==typeof e&&e>0&&Math.floor(e)===e,t)};class a extends Error{constructor(e,t){t||(t="failed for value %s"),super(t.replace("%s",e?.toString()))}}t.AssertionError=a},5538:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isWholeNumber=t.dec2bin=t.numberToDots=t.prettyPrintObject=t.OBJECT_TO_STRING_WHITELIST=t.withSign=t.preventFreeze=t.sleep=t.deepFreeze=t.isDefined=t.decompressStr=t.compressStr=t.shallowStr=t.replaceClassObjects=t.str=void 0;const n=s(i(95775)),a=s(i(4037)),o=i(73735),r=i(96486);function c(e){return"object"!=typeof e||null==e?e:Array.isArray(e)?e.map(c):"Object"!==e.constructor.name?`[${e.constructor.name}]`:(0,o.mapDictionary)(e,(e=>c(e)))}function l(e){return new Promise((t=>setTimeout(t,e)))}t.str=function(e,t){e=c(e);const i=(0,n.default)(e);return t&&i.length>t?i.slice(0,t)+"(...)":i},t.replaceClassObjects=c,t.shallowStr=function(e){return(0,n.default)(e,((e,t)=>e&&t&&"number"!=typeof t?Array.isArray(t)?"[object Array]":""+t:t))},t.compressStr=function(e){return a.default.compress(e,{outputEncoding:"StorageBinaryString"})},t.decompressStr=function(e){return a.default.decompress(e,{inputEncoding:"StorageBinaryString"})},t.isDefined=function(e){return null!=e},t.deepFreeze=function e(t){const i=Object.getOwnPropertyNames(t);for(const s of i){const i=t[s];i&&"object"==typeof i&&e(i)}return Object.freeze(t)},t.sleep=l,t.preventFreeze=(0,r.throttle)(l.bind(void 0,0),10,{trailing:!0}),t.withSign=function(e){return e>=0?"+"+e:e.toString()},t.OBJECT_TO_STRING_WHITELIST=new Set(["UnitsByMight"]),t.prettyPrintObject=function e(i,s=0){const n=Array(s+1).join(" ");return Object.entries(i).map((([i,a])=>null==a?`${n}${i}: ⊘`:Array.isArray(a)?`${n}${i}: ${a.join(",")}`:"object"==typeof a&&null!==a?a.constructor===Object?`${n}${i}:\n${e(a,s+2)}`:t.OBJECT_TO_STRING_WHITELIST.has(a.constructor.name)?`${n}${i}: ${a.toString()}`:`${n}${i}: [${a.constructor.name}]`:`${n}${i}: ${a}`)).join("\n")},t.numberToDots=function(e){return e>8?"⣿":" ⠁⠃⠇⠏⠟⠿⡿⣿"[e]},t.dec2bin=function(e){return(e>>>0).toString(2)},t.isWholeNumber=function(e){return Math.floor(e)===e}},95559:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CallToActionForm=void 0;const s=i(95569),n=i(1157),a=i(10445),o=i(15641),r=i(10780);var c=Phaser.GameObjects.BitmapText;const l=i(44031),d=i(71203);class h extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.title=new c(this.scene,0,0,n.BitmapFont.Main,"").setTint(a.Colors.glassUi.primaryText),this.content=new c(this.scene,0,0,n.BitmapFont.Small,"").setTint(a.Colors.glassUi.primaryText),this.submitButtonText=new c(this.scene,0,0,n.BitmapFont.Small,"OK").setTint(a.Colors.glassUi.primaryText),this.submitButton=new o.BoxButton(this.scene,0,0,{baseTexture:r.BoxTexture.DialogButton,downTexture:r.BoxTexture.DialogButtonDown,content:this.submitButtonText,width:200,height:36}),this.add([this.title,this.content,this.submitButton]),this.submitButton.onClicked((()=>{this.onSubmit?.()}))}applyProps(e){return this.title.setText(e.title),this.content.setText(e.content),this.submitButtonText.setText(e.action),this.onSubmit=e.onSubmit,this.preUpdate.makeDirty(),this}updateLayout(){this.title.setMaxWidth(this.width),this.content.setMaxWidth(this.width),l.Arrange.fromTopToBottomOld([this.title,this.content,this.submitButton],{x:0,y:0,originX:0,originY:0,spacing:10});const e=d.inject.scene.globalUI.comps.notifications.layout;this.submitButton.x=this.width/2-this.submitButton.width/2-(e.padding+e.spaceForIcon)/2,this.updateSize()}calculateHeight(){return this.submitButton.y+this.submitButton.height}}t.CallToActionForm=h},56225:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FeedbackForm=t.FeedbackFormMode=void 0;const s=i(95569),n=i(1157),a=i(10445),o=i(98538),r=i(44031),c=i(56421),l=i(1956),d=i(25578),h=i(71203),u=i(94459),g=i(79578),p=i(18995),m=i(5085);var y,f=Phaser.GameObjects.BitmapText;!function(e){e.Minimal="minimal",e.SingleLine="single-line",e.Full="full",e.Thanks="thanks"}(y=t.FeedbackFormMode||(t.FeedbackFormMode={}));class w extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.title=new f(this.scene,0,0,n.BitmapFont.Main,"").setTint(a.Colors.glassUi.primaryText),this.subtitle=new f(this.scene,0,0,n.BitmapFont.Small,"").setTint(a.Colors.glassUi.primaryText),this.emotionPicker=new o.MiniButtonsRow(this.scene,[10,11,12,13,14].map((e=>`attitude-emoji/${e}`))),this.chosenEmotion=void 0,this.emailFieldLabel=new f(this.scene,0,0,n.BitmapFont.Mini,"").setTint(a.Colors.glassUi.primaryText),this.messageField=new l.TextArea(this.scene,{rows:1,placeholder:"You can also add a comment, if you wish!",onChange:()=>{this.mode===y.SingleLine&&this.setMode(y.Full)}}),this.emailField=new d.TextInput(this.scene,{width:160,placeholder:"email@example.com"}),this.socials=function(e){const t=g.UiBuilder.for(e);return t.hLayout({layoutPolicy:m.LayoutChildrenPolicy.None,originX:1,content:[t.text("You can also",n.BitmapFont.Mini,a.Colors.glassUi.primaryText),t.button(g.ButtonTemplate.MiniStealthButton,{text:"Tweet at me",icon:t.image("ui/icons/twitter",a.Colors.glassUi.primaryText).setScale(.5,.5),onClicked:()=>h.inject.events.trigger(p.UserActions.SendTweet())}),t.text("or",n.BitmapFont.Mini,a.Colors.glassUi.primaryText),t.button(g.ButtonTemplate.MiniStealthButton,{text:"Join the Discord server",icon:t.image("ui/icons/discord",a.Colors.glassUi.primaryText).setScale(.5,.5),onClicked:()=>h.inject.events.trigger(p.UserActions.JoinDiscord())})],originY:.5,spacing:6})}(this.scene),this.ui=g.UiBuilder.for(this.scene),this.submitButton=this.ui.button(g.ButtonTemplate.SmallRibbonButton,{text:"Send",onClicked:()=>{this.setMode(y.Thanks),this.props.onSubmit({email:this.emailField.text.trim()||void 0,comment:this.messageField.text.trim()||void 0,mood:this.chosenEmotion})}}),this.add([this.title,this.subtitle,this.emotionPicker,this.messageField,this.emailField,this.emailFieldLabel,this.socials,this.submitButton]),this.emailField.node.type="email",this.messageField.setVisible(!1),this.submitButton.setVisible(!1),this.socials.setVisible(!1),this.emotionPickerCtl=c.ButtonControllers.options({1:this.emotionPicker.buttons[0],2:this.emotionPicker.buttons[1],3:this.emotionPicker.buttons[2],4:this.emotionPicker.buttons[3],5:this.emotionPicker.buttons[4]}),this.emotionPickerCtl.onButtonClicked((e=>{this.emotionPickerCtl.selectButton(e),this.chosenEmotion=Number(e),this.messageField.visible||(this.messageField.setVisible(!0),this.preUpdate.makeDirty(),this.mode===y.Minimal&&this.setMode(y.SingleLine))}))}setMode(e){this.mode=e,this.preUpdate.force()}applyProps(e){this.props=e,e.chosenEmotion&&this.emotionPickerCtl.selectButton(e.chosenEmotion.toString()),this.mode=e.mode,this.chosenEmotion=e.chosenEmotion,this.titleText=e.title,this.subtitleText=e.subtitle,this.emailField.setValue(e.email??""),this.messageField.setValue(e.message??""),this.preUpdate.makeDirty(),e.autoFocus&&this.messageField.node.focus()}updateLayout(){switch(this.title.setMaxWidth(this.width),this.subtitle.setMaxWidth(this.width),this.mode===y.Thanks?(this.title.setText("Thank you so much!"),this.subtitle.setVisible(!1),this.emotionPicker.setVisible(!1)):(this.title.setText(this.titleText),this.subtitle.setVisible(!0),this.subtitle.setText(this.subtitleText),this.emotionPicker.setVisible(!0)),this.emailFieldLabel.setText((h.inject.device.uiVariant()===u.UiVariant.Large?"<- ":"")+"Add email if you'd like to hear back from me!"),this.mode){case y.Thanks:case y.Minimal:this.messageField.setVisible(!1),this.socials.setVisible(!1),this.submitButton.setVisible(!1),this.emailField.setVisible(!1),this.emailFieldLabel.setVisible(!1);break;case y.SingleLine:this.messageField.setVisible(!0),this.socials.setVisible(h.inject.device.uiVariant()===u.UiVariant.Large),this.submitButton.setVisible(!0),this.emailField.setVisible(!1),this.emailFieldLabel.setVisible(!1),this.messageField.resizeToRows(1),this.messageField.node.placeholder="You can also add a comment, if you wish!";break;case y.Full:this.messageField.setVisible(!0),this.messageField.node.placeholder="Write your message here",this.socials.setVisible(h.inject.device.uiVariant()===u.UiVariant.Large),this.submitButton.setVisible(!0),this.emailField.setVisible(!0),this.emailFieldLabel.setVisible(!0),this.messageField.resizeToRows(3),this.messageField.displayHeight=this.messageField.height}this.messageField.width=this.width,r.Arrange.fromTopToBottomOld([this.title,this.subtitle,this.emotionPicker,this.messageField,...h.inject.device.uiVariant()===u.UiVariant.Compact?[this.emailFieldLabel]:[],this.emailField,this.submitButton],{x:0,y:0,originX:0,originY:0,spacing:10}),this.socials.setPosition(this.width,this.submitButton.y+this.submitButton.height-this.socials.height),h.inject.device.uiVariant()===u.UiVariant.Large&&this.emailFieldLabel.setPosition(this.emailField.x+this.emailField.displayWidth+8,this.emailField.y+this.emailField.displayHeight/2-this.emailFieldLabel.height/2),this.updateSize()}calculateHeight(){let e;switch(this.mode){case y.Thanks:e=this.title;break;case y.Minimal:e=this.emotionPicker;break;case y.SingleLine:case y.Full:e=this.submitButton}return e.y+e.height}}t.FeedbackForm=w},32498:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NotificationsManager=void 0;const s=i(71203),n=i(5200),a=i(39104),o=i(78411),r=i(17225),c=i(79578),l=i(38735);t.NotificationsManager=class{constructor(){this.displayedFeedbackToast=void 0}get ui(){return this._builder||(this._builder=c.UiBuilder.for(s.inject.scene.globalUI)),this._builder}get scene(){return s.inject.scene.globalUI}add(e){return s.inject.scene.globalUI.comps.notifications.addToast(e)}close(e){s.inject.scene.globalUI.comps.notifications.closeToast(e)}toggleFeedback(){this.displayedFeedbackToast&&this.displayedFeedbackToast.visible?this.close(this.displayedFeedbackToast):(this.displayedFeedbackToast=(0,o.showFeedbackForm)(),l.track.interaction("open_feedback_form"))}askForLevelFeedback(e){this.displayedFeedbackToast&&this.displayedFeedbackToast.visible||(this.displayedFeedbackToast=(0,o.askForLevelFeedback)(e))}uncaughtError(e){(0,n.showErrorNotification)(this.scene,e)}movePreventedByPawn(e,t){if(0===t.length)return;const i=t.reduce(((e,t)=>t.defense>e?.defense?t:e));if(i.defense>3)return;let n=i.faction===s.inject.gameStateModel.currentPhase.faction?`Cannot place ${e} on a tile that already has ${i.type}`:`This tile is protected by an enemy ${i.type}. We needed a stronger unit to capture it!`;this.add({category:a.NotificationCategory.InvalidUserActionHint,style:a.NotificationStyle.Default,scope:a.NotificationScope.Screen,timeout:2500,clickable:!0,icon:this.ui.image((0,r.getFrameForPawnType)(i.type)),cancelTimeoutOnHover:!1,content:this.ui.caption(n)})}regionDisaster(e,t,i){const n=this.add({style:a.NotificationStyle.Default,scope:a.NotificationScope.Screen,timeout:5e3,clickable:!0,icon:this.ui.image("ui/icons/alert"),cancelTimeoutOnHover:!0,content:this.ui.vLayout({spacing:10,content:[this.ui.caption(e),this.ui.paragraph(t)]}),onClicked:()=>{this.close(n);const e=i&&s.inject.gameStateModel.regions.byId(i);e&&e?.exists&&e.isAlive()&&s.inject.screen.play.selectRegion(i,{clickEffect:!1,panCamera:!0})}});return n}warning(e,t){return this.add({style:a.NotificationStyle.Alert,scope:a.NotificationScope.Global,timeout:5e3,clickable:!0,icon:this.ui.image("ui/icons/alert"),cancelTimeoutOnHover:!0,content:this.ui.vLayout({spacing:10,content:[this.ui.caption(e),this.ui.paragraph(t)]})})}}},78411:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showFeedbackForm=t.askForLevelFeedback=void 0;const s=i(39104),n=i(56225),a=i(71203),o=i(91058),r=i(38735);function c(e,t,i){e.clickable=!0,e.icon.setFrame("ui/icons/heart"),e.preUpdate.makeDirty(),a.inject.userData.rememberChoice("feedbackEmail",i.email),a.inject.userData.saveFeedback({levelId:t,mood:i.mood,comment:i.comment,screen:a.inject.navigator.currentScreen?.name??"",timestamp:Date.now()}),a.inject.events.trigger(o.ReportingEvents.SubmitFeedbackForm({levelId:t,email:i.email,mood:i.mood,comment:i.comment})),setTimeout((()=>a.inject.scene.globalUI.comps.notifications.closeToast(e)),1e3)}t.askForLevelFeedback=function(e){const t=new n.FeedbackForm(a.inject.scene.globalUI);t.applyProps({mode:n.FeedbackFormMode.Minimal,title:"Thanks for playing! How did you like this level?",subtitle:"Your feedback matters!",email:a.inject.userData.recallChoice("feedbackEmail")??"",message:"",onSubmit:t=>c(i,e,t)});const i=a.inject.scene.globalUI.comps.notifications.addToast({style:s.NotificationStyle.Default,icon:new Phaser.GameObjects.Image(a.inject.scene.globalUI,0,0,"atlas","ui/icons/please"),content:t,scope:s.NotificationScope.Level,onDismissed:()=>{a.inject.userData.rememberChoice("dismissedFeedbackForm",Date.now())}});return i},t.showFeedbackForm=function(){const e=a.inject.ui.selectedLevelId(),t=new n.FeedbackForm(a.inject.scene.globalUI);t.applyProps({mode:n.FeedbackFormMode.Full,email:a.inject.userData.recallChoice("feedbackEmail")??"",autoFocus:!0,message:"",title:"Hi there!",subtitle:"\nI'm Mike, the developer behind this game, and I'd love to hear from you!\nBug reports, improvement ideas, or just a simple thank you, all feedback is much appreciated.\n",onSubmit:t=>c(i,e,t)});const i=a.inject.scene.globalUI.comps.notifications.addToast({style:s.NotificationStyle.Default,icon:new Phaser.GameObjects.Image(a.inject.scene.globalUI,0,0,"atlas","ui/icons/please"),content:t,scope:s.NotificationScope.Global,cancelTimeoutOnHover:!0,onDismissed:()=>{r.track.ui.dismissFeedbackForm()}});return i}},5200:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showErrorNotification=void 0;var s=Phaser.GameObjects.Image;const n=i(71203),a=i(39104),o=i(95559);function r(e){return window.navigator.onLine?`The game just encountered an unexpected error, sorry about that!\nAn error report was already sent and I will be looking into it!\n\nSince the game is now most likely stuck in a broken state, you should reload the page.\nDon't worry, you won't lose any progress!\n\n(error_id="${e}")`:`The game just encountered an unexpected error, sorry about that!\n\nSince the game is now most likely stuck in a broken state, you should reload the page.\nDon't worry, you won't lose any progress!\n\n(error_id="${e}")`}t.showErrorNotification=function(e,t){e.comps.notifications.addToast({style:a.NotificationStyle.Alert,category:a.NotificationCategory.Error,icon:new s(n.inject.scene.globalUI,0,0,"atlas","ui/icons/dead"),content:new o.CallToActionForm(n.inject.scene.globalUI).applyProps({title:"Well... This was not supposed to happen.",content:r(t),action:"RELOAD",onSubmit(){window.location.reload()}}),scope:a.NotificationScope.Global})}},10445:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Colors=void 0,t.Colors={woodenUi:{primaryText:5781794,redText:8388608,pergamen:16379880},glassUi:{background:11656690,primaryText:3355442,secondaryText:2710903,disabledText:7972541,backgroundText:5460817,shape:12969202,shapeDarkAccent:11590124,shapeShadow:9027030,shapeLightAccent:14412786,alert:{shadow:13118720,main:16749944,lightAccent:16773357},success:{shadow:4496950,main:8376178,lightAccent:12445366}},tooltip:{text:14540253,background:2697512,mightCounter:3648456,coinsCounter:16763904},highlight:{ownedRegion:16577024,hostileRegion:16721920},ocean:10213106,oceanLight:11591925,darker:(e,t=10)=>Phaser.Display.Color.IntegerToColor(e).darken(t).color,lighter:(e,t=10)=>Phaser.Display.Color.IntegerToColor(e).lighten(t).color}},1157:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugTextBox=t.BitmapFont=t.UNICODE_MAP=t.GLYPH=t.Fonts=void 0;const s=i(71203);var n,a=Phaser.GameObjects.Layer,o=Phaser.GameObjects.BitmapText,r=Phaser.GameObjects.Rectangle;t.Fonts=class{load(e){e.load.bitmapFont(n.Debug,"assets/fonts/debug.png","assets/fonts/debug.xml"),e.load.bitmapFont(n.Main,"assets/fonts/main.png","assets/fonts/main.xml"),e.load.bitmapFont(n.Mini,"assets/fonts/mini.png","assets/fonts/mini.xml"),e.load.bitmapFont(n.MiniBold,"assets/fonts/mini-bold.png","assets/fonts/mini-bold.xml"),e.load.bitmapFont(n.Small,"assets/fonts/small.png","assets/fonts/small.xml")}},t.GLYPH={defense:String.fromCodePoint(57344),might:String.fromCodePoint(57345),pawn:String.fromCodePoint(57346),kingdom:String.fromCodePoint(57347),coin:String.fromCodePoint(57348),hex:String.fromCodePoint(57349),checkMark:String.fromCodePoint(57350),crossMark:String.fromCodePoint(57351),pawns:{milita:"",pikeman:"",knight:"",hero:""},whiteFlag:"",redFlag:"",blueFlag:"",blackFlag:"",greenFlag:"",source:"",movable:"",error:""},t.UNICODE_MAP={"⬡":t.GLYPH.hex,"⚐":t.GLYPH.whiteFlag,"🚩":t.GLYPH.redFlag,"⚑":t.GLYPH.blackFlag,"👤":t.GLYPH.pawn,"♖":t.GLYPH.kingdom,"✓":t.GLYPH.checkMark,"❌":t.GLYPH.crossMark,"💂‍":t.GLYPH.pawns.milita,"⛔":t.GLYPH.error},function(e){e.Debug="Debug",e.Main="Main",e.Small="Small",e.Mini="Mini",e.MiniBold="MiniBold"}(n=t.BitmapFont||(t.BitmapFont={}));const c={origin:[0,0],backgroundOpacity:.2,padding:2,textAlign:o.ALIGN_LEFT,dropShadow:!0};t.DebugTextBox=class extends a{constructor(e,t,i,a,l){super(e),this.opts={...c,...l},e.add.existing(this),this.text=new o(e,t,i,s.inject.device.isMobile()?n.Small:n.Debug,a,void 0,this.opts.textAlign).setOrigin(...this.opts.origin),this.background=new r(e,t,i,0,0,0,.25),this.opts.dropShadow&&this.text.setDropShadow(1,1,0,1),this.opts.backgroundOpacity>0&&this.add(this.background),this.add(this.text),this.updateBackgroundSize()}setPosition(e,t){return this.text.setPosition(e,t),this.background.setPosition(this.text.x-this.text.width*this.text.originX-this.opts.padding,this.text.y-this.text.height*this.text.originY-this.opts.padding),this}setText(e){return this.text.setText(e.replace(/./g,(e=>t.UNICODE_MAP[e]||e))),this.updateBackgroundSize(),this}updateBackgroundSize(){this.background.setPosition(this.text.x-this.text.width*this.text.originX-this.opts.padding,this.text.y-this.text.height*this.text.originY-this.opts.padding),this.background.setSize(this.text.width+2*this.opts.padding,this.text.height+2*this.opts.padding)}}},53717:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelScript=void 0;const s=i(71203),n=i(84477);t.LevelScript=class{constructor(e){this.module=e,this.subscriptions=[],this.tooltips=[],this.watchers=[]}onEvent(e,t){const i=s.inject.events.on(e,t);return this.subscriptions.push(i),i}watch(e,t){this.watchers.push(e.watchFuture(t))}addTooltip(e){const t=s.inject.tooltips.show({...e,type:n.TooltipType.Permanent});return this.tooltips.push(t),t}goTo(e){void 0===e?s.inject.scriptRunner.setScript(void 0):s.inject.scriptRunner.setScript(this.module.name+"."+e)}setScript(e){void 0===e?s.inject.scriptRunner.setScript(void 0):s.inject.scriptRunner.setScript(e)}activate(){}deactivate(){this.subscriptions.forEach((e=>e.unsubscribe())),this.subscriptions=[],this.tooltips.forEach((e=>s.inject.tooltips.removeTooltip(e))),this.tooltips=[],this.watchers.forEach((e=>e.unsubscribe())),this.watchers=[]}}},54051:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelScriptRunner=void 0;const s=i(62199),n=i(46670),a=i(51897),o=s.logger.for("LevelScriptRunner");t.LevelScriptRunner=class{constructor(){this.registry=new n.ScriptModulesRegistry,this.currentScript=void 0}setScript(e){const t=this.getNewScriptByName(e);this.currentScript!==t&&(this.currentScript&&this.currentScript.deactivate(),this.currentScript=t,this.currentScriptName=e,t&&(o.info(`Activating level script ${e}`),t.activate()))}getNewScriptByName(e){if(e)try{return e?this.registry.getScript(e):void 0}catch(e){a.ErrorTracking.captureNonFatalError(e,"invalid level script"),this.setScript(void 0)}}}},46670:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScriptModulesRegistry=void 0;const s=i(53257);t.ScriptModulesRegistry=class{constructor(){this.moduleCache={}}getScript(e){const t=e.split("."),i=this.getModule(t[0]);if(1===t.length)return i.main;{const e=i[t[1]];if(!e)throw Error(`script "${t[1]}" not found in module ${i.name}`);return e}}getModule(e){if(!this.moduleCache[e]){const t=s.ScriptModules[e];if(!t)throw Error(`level scripts module "${e}" not found`);this.moduleCache[e]=t(),this.moduleCache[e].name=e}return this.moduleCache[e]}}},53257:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScriptModules=void 0;const s=i(82521),n=i(92224),a=i(12145),o=i(87776),r=i(35520);t.ScriptModules={tutorial1:()=>new s.Tutorial1,tutorial2:()=>new a.Tutorial2,tutorial3:()=>new r.Tutorial3,deathmatch:()=>new n.Deathmatch,global:()=>new o.GlobalModule}},92224:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Deathmatch=void 0;const s=i(53717),n=i(71203),a=i(73508),o=i(85421),r=i(18995);t.Deathmatch=class{constructor(){this.main=new c(this)}};class c extends s.LevelScript{activate(){super.activate();const e={};n.inject.gameStateModel.pawns.all().filter((e=>e.type===a.PawnType.Town&&1!==e.faction?.id)).forEach((t=>{e[t.hex.id]=this.addTooltip({title:"Destroy",icon:"ui/icons/star",placement:o.TooltipPlacement.atWorldMapHex(t.hex),delayMs:0,displayBelow:!0})})),this.onEvent(r.GameEvents.HexCaptured,(t=>{const i=t.capturedHexId;e[i]&&(n.inject.tooltips.removeTooltip(e[i]),delete e[i])}))}}},87776:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GlobalModule=void 0;const s=i(53717),n=i(71203),a=i(18995),o=i(85421),r=i(27358),c=i(23803);t.GlobalModule=class{constructor(){this.main=new l(this),this.teachRewind_step1=new d(this),this.teachRewind_step2=new h(this),this.teachRetreat=new u(this)}};class l extends s.LevelScript{activate(){this.onEvent(a.GameEvents.FactionTurnStarted,(e=>{var t;!n.inject.userData.hasCompletedTutorial("rewind")&&1===e.factionId&&n.inject.scene.playUI.activeUI.rewindButton&&n.inject.screen.play.remainingLives>0&&(t=n.inject.worldNews.newsByRegion,Object.values(t).some((e=>e.died||e.townsLost.length)))&&this.goTo("teachRewind_step1")})),this.onEvent(a.GameEvents.HexCaptured,(e=>{!n.inject.userData.hasCompletedTutorial("walls")&&e.defeatedUnit?.retreatHex&&(this.module.hexId=e.defeatedUnit.retreatHex,this.goTo("teachRetreat"))}))}}class d extends s.LevelScript{activate(){this.addTooltip({placement:o.TooltipPlacement.overUiObject(n.inject.scene.playUI.activeUI.undoButton),delayMs:1e3,icon:"ui/mini-icons/lightbulb",title:"Not happy with the outcome?\nClick here to rewind to last turn!"}),this.onEvent(r.WorldMapEvents.StartInteraction,(()=>{this.goTo("main")})),this.onEvent(a.UserActions.EndTurn,(()=>{this.goTo("main")})),this.onEvent(a.UserActions.OpenRollbackMenu,(()=>{this.goTo("teachRewind_step2")}))}}class h extends s.LevelScript{activate(){this.addTooltip({placement:o.TooltipPlacement.overUiObject(n.inject.scene.playUI.activeUI.rewindButton),delayMs:300,enforceDelay:!0,icon:"ui/mini-icons/lightbulb",title:"You can do this 3 times per level!",displayBelow:!0}),this.onEvent(a.UserActions.RollbackTurn,(()=>{n.inject.userData.completeTutorial("rewind"),this.goTo("main")})),this.onEvent(a.UiEvents.RollbackMenuClosed,(()=>{this.goTo("teachRewind_step1")}))}}class u extends s.LevelScript{activate(){this.addTooltip({placement:o.TooltipPlacement.atWorldMapHex((0,c.getHex)(this.module.hexId)),delayMs:500,enforceDelay:!0,icon:"ui/mini-icons/lightbulb",title:"Units protected by walls will retreat instead of dying."}),n.inject.userData.completeTutorial("walls"),this.onEvent(r.WorldMapEvents.StartInteraction,(()=>{this.goTo("main")})),this.onEvent(a.UserActions.EndTurn,(()=>{this.goTo("main")}))}}},82521:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TutorialStep=t.Tutorial1=void 0;const s=i(71203),n=i(27358),a=i(73508),o=i(52163),r=i(85421),c=i(23803),l=i(53717),d=i(18995),h=i(58609);t.Tutorial1=class{constructor(){this.step1_selectVillager=new m(this),this.step2_captureHex=new y(this),this.step3_buyAnotherVillager=new f(this),this.step4_mergeVillagers=new w(this),this.step5_undoMerge=new b(this),this.step6_buyAgain=new v(this),this.step7_captureAnotherHex=new S(this),this.step8_endTurn=new P(this),this.reselectRegion=new p(this),this.displayObjectives=new T(this),this.main=new u(this)}};class u extends l.LevelScript{activate(){1===s.inject.gameStateModel.currentPhase.turnNumber&&1===s.inject.gameStateModel.currentPhase.getMovablePawns().length?(s.inject.scene.playUI.updateState({mode:h.PlayUIMode.Hidden}),this.goTo("step1_selectVillager")):this.goTo("displayObjectives")}}class g extends l.LevelScript{activate(){super.activate(),this.onEvent(d.UserActions.EndTurn,(()=>{this.goTo("displayObjectives")})),this.onEvent(d.UserActions.OpenRollbackMenu,(()=>{s.inject.scene.globalUI.clearTooltips()})),this.watch(s.inject.screen.play.selectedRegionId,(e=>{e||(this.module.storedStep=s.inject.scriptRunner.currentScriptName,this.goTo("reselectRegion"))}))}deactivate(){super.deactivate()}abortTutorial(){this.goTo("displayObjectives")}}t.TutorialStep=g;class p extends g{activate(){super.activate(),this.addTooltip({title:"Select your province",placement:r.TooltipPlacement.atWorldMapHex((0,c.getHex)(803)),delayMs:0,icon:"ui/icons/hand"}),this.watch(s.inject.screen.play.selectedRegionId,(e=>{e&&(this.module.storedStep?this.setScript(this.module.storedStep):this.goTo("displayObjectives"))}))}}class m extends g{activate(){super.activate();const e=s.inject.gameStateModel,t=e.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[a.PawnType.Villager]});o.assert.defined(t);const i=t.hex.id;this.addTooltip({title:"Select villager",placement:r.TooltipPlacement.atWorldMapHex(t.hex),delayMs:500,icon:"ui/icons/hand"}),this.onEvent(n.WorldMapEvents.StartInteraction,(({hexId:e,flags:t})=>{e===i&&this.goTo("step2_captureHex")})),this.onEvent(d.GameEvents.HexCaptured,(()=>{this.goTo("step3_buyAnotherVillager")})),this.onEvent(d.UserActions.BuyablePawnPointerUp,(()=>{this.goTo("step4_mergeVillagers")}))}}class y extends g{activate(){super.activate(),s.inject.scene.playUI.updateState({mode:h.PlayUIMode.OwnedRegionSelected});const e=s.inject.gameStateModel,t=e.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[a.PawnType.Villager]});o.assert.defined(t),this.addTooltip({title:"Expand your province!",placement:r.TooltipPlacement.atWorldMapHex((0,c.getHex)(705)),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(d.GameEvents.HexCaptured,(()=>{this.goTo("step3_buyAnotherVillager")})),this.onEvent(d.GameEvents.PawnMoved,(()=>{this.goTo("step1_selectVillager")})),this.onEvent(d.UserActions.ReturnHeldPawn,(()=>{this.goTo("step1_selectVillager")}))}}class f extends g{activate(){super.activate(),s.inject.scene.playUI.updateState({mode:h.PlayUIMode.OwnedRegionSelected}),this.addTooltip({title:"Recruit another villager",placement:r.TooltipPlacement.overUiObject(s.inject.scene.playUI.activeUI.shoppingTray.pawnSprites[a.PawnType.Villager]),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(d.UserActions.BuyablePawnPointerDown,(e=>{e===a.PawnType.Villager&&this.goTo("step4_mergeVillagers")})),this.onEvent(d.UserActions.Undo,(()=>{this.goTo("step1_selectVillager")}))}}class w extends g{activate(){super.activate();const e=s.inject.gameStateModel,t=e.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[a.PawnType.Villager]});o.assert.defined(t);const i=t.hex.id;this.addTooltip({title:"Get a stronger unit by merging two villagers together!",placement:r.TooltipPlacement.atWorldMapHex(t.hex),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(d.UiEvents.PawnReturnedToShop,(()=>{this.goTo("step3_buyAnotherVillager")})),this.onEvent(d.GameEvents.PawnBought,(e=>{e.destinationHexId===i?this.goTo("step5_undoMerge"):this.goTo("step8_endTurn")})),this.onEvent(d.GameEvents.HexCaptured,(e=>{this.goTo("step8_endTurn")})),this.onEvent(d.UserActions.Undo,(()=>{this.goTo("step1_selectVillager")}))}}class b extends g{activate(){super.activate();const e=s.inject.gameStateModel,t=s.inject.gameStateModel.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[a.PawnType.Pikeman]});if(!t)return this.abortTutorial();s.inject.scene.playUI.updateState({highlightEndTurn:!1}),this.addTooltip({title:"Nice! But beware that stronger units also cost\n more coins each turn to maintain!",placement:r.TooltipPlacement.atWorldMapHex(t.hex),delayMs:0}),this.addTooltip({title:"Let's reconsider! Click here to undo the last action.",placement:r.TooltipPlacement.overUiObject(s.inject.scene.playUI.activeUI.undoButton),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(d.UserActions.Undo,(()=>{this.goTo("step6_buyAgain")})),this.onEvent(d.UserActions.EndTurn,(()=>{this.goTo("displayObjectives")}))}}class v extends g{activate(){super.activate(),this.addTooltip({title:"Recruit the villager again",placement:r.TooltipPlacement.overUiObject(s.inject.scene.playUI.activeUI.shoppingTray.pawnSprites[a.PawnType.Villager]),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(d.UserActions.BuyablePawnPointerDown,(e=>{e===a.PawnType.Villager&&this.goTo("step7_captureAnotherHex")})),this.onEvent(d.UserActions.Undo,(()=>{this.goTo("displayObjectives")}))}}class S extends g{activate(){super.activate();const e=s.inject.gameStateModel,t=e.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[a.PawnType.Villager]}),i=e.factions.byId(1)?.getRegions()[0];if(!i)return this.abortTutorial();o.assert.defined(i);const n=e.warfare.getConquerableHexes(i,a.PawnType.Villager).first();if(!t||!n)return this.abortTutorial();this.addTooltip({title:"Capture another tile!",placement:r.TooltipPlacement.atWorldMapHex(n),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(d.GameEvents.HexCaptured,(()=>{this.goTo("step8_endTurn")})),this.onEvent(d.UserActions.ReturnHeldPawn,(()=>{this.goTo("step6_buyAgain")})),this.onEvent(d.UserActions.Undo,(()=>{this.goTo("displayObjectives")}))}}class P extends g{activate(){super.activate(),this.addTooltip({title:"End turn",placement:r.TooltipPlacement.overUiObject(s.inject.scene.playUI.activeUI.endTurnButton),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(d.UserActions.EndTurn,(()=>{this.goTo("displayObjectives")})),this.onEvent(d.UserActions.Undo,(()=>{this.goTo("displayObjectives")}))}}class T extends l.LevelScript{activate(){super.activate(),this.addTooltip({title:"Get the bastard!",placement:r.TooltipPlacement.atWorldMapHex((0,c.getHex)(908)),delayMs:0,displayBelow:!0,icon:"ui/icons/star"});const e=this.addTooltip({title:"Expand here to boost your income",placement:r.TooltipPlacement.atWorldMapHex((0,c.getHex)(404)),icon:"ui/icons/star",delayMs:0});this.addTooltip({title:"Click here for more hints",placement:r.TooltipPlacement.overUiObject(s.inject.scene.globalUI.headerButtons.buttons.helpButton)}),this.onEvent(d.UserActions.OpenRollbackMenu,(()=>{s.inject.scene.globalUI.clearTooltips()}));const t=this.onEvent(d.GameEvents.HexCaptured,(()=>{i()}));function i(){const i=s.inject.gameStateModel.regions.byHex((0,c.getHex)(404))?.isAlive();i&&(s.inject.tooltips.removeTooltip(e),t.unsubscribe())}i()}}},12145:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TutorialStep=t.Tutorial2=void 0;const s=i(71203),n=i(73508),a=i(85421),o=i(23803),r=i(53717),c=i(18995),l=i(58609);t.Tutorial2=class{constructor(){this.step1_buyCastle=new g(this),this.step2_placeCastle=new p(this),this.reselectRegion=new u(this),this.displayObjectives=new m(this),this.main=new d(this)}};class d extends r.LevelScript{activate(){1===s.inject.gameStateModel.currentPhase.turnNumber&&s.inject.gameStateModel.regions.byId(14)?.treasury?this.goTo("step1_buyCastle"):this.goTo("displayObjectives")}}class h extends r.LevelScript{activate(){super.activate(),this.onEvent(c.UserActions.EndTurn,(()=>{this.goTo("displayObjectives")})),this.watch(s.inject.screen.play.selectedRegionId,(e=>{14!==e&&(this.module.storedStep=s.inject.scriptRunner.currentScriptName,this.goTo("reselectRegion"))}))}deactivate(){super.deactivate()}abortTutorial(){this.goTo("displayObjectives")}}t.TutorialStep=h;class u extends h{activate(){super.activate(),this.addTooltip({title:"Select province",placement:a.TooltipPlacement.atWorldMapHex((0,o.getHex)(905)),delayMs:0,icon:"ui/icons/hand"}),this.watch(s.inject.screen.play.selectedRegionId,(e=>{e&&(this.module.storedStep?this.setScript(this.module.storedStep):this.goTo("displayObjectives"))}))}}class g extends h{activate(){super.activate(),this.addTooltip({title:"Castles are a cost-effective way to protect key tiles",placement:a.TooltipPlacement.overUiObject(s.inject.scene.playUI.activeUI.shoppingTray.pawnSprites[n.PawnType.Castle]),delayMs:1e3,icon:"ui/icons/hand"}),this.onEvent(c.UserActions.BuyablePawnPointerDown,(e=>{e===n.PawnType.Castle?this.goTo("step2_placeCastle"):this.goTo("displayObjectives")}))}}class p extends h{activate(){super.activate(),s.inject.scene.playUI.updateState({mode:l.PlayUIMode.OwnedRegionSelected}),s.inject.gameStateModel,this.addTooltip({title:"Place it here to protect your town.",placement:a.TooltipPlacement.atWorldMapHex((0,o.getHex)(905)),delayMs:0,icon:"ui/icons/hand"}),this.onEvent(c.UserActions.ReturnHeldPawn,(()=>{this.goTo("step1_buyCastle")})),this.onEvent(c.GameEvents.PawnBought,(()=>{this.goTo("displayObjectives")}))}}class m extends r.LevelScript{activate(){super.activate()}}},35520:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tutorial3=void 0;const s=i(71203),n=i(73508),a=i(85421),o=i(23803),r=i(53717),c=i(18995),l=i(58609);t.Tutorial3=class{constructor(){this.step1_waitForPikemanPickup=new h(this),this.step2_exploitWeakpoint=new u(this),this.step3_commentary=new g(this),this.main=new d(this)}};class d extends r.LevelScript{activate(){1===s.inject.gameStateModel.currentPhase.turnNumber&&s.inject.gameStateModel.currentPhase.getMovablePawns().length&&this.goTo("step1_waitForPikemanPickup")}}class h extends r.LevelScript{activate(){super.activate(),this.onEvent(c.UiEvents.PawnPickedUp,(({pawnType:e})=>{e===n.PawnType.Pikeman?this.goTo("step2_exploitWeakpoint"):this.goTo("main")})),this.onEvent(c.GameEvents.HexCaptured,(e=>{1208===e.capturedHexId?this.goTo("step3_commentary"):this.goTo("main")}))}}class u extends r.LevelScript{activate(){super.activate(),s.inject.gameStateModel,this.addTooltip({title:"Enemy weakpoint",placement:a.TooltipPlacement.atWorldMapHex((0,o.getHex)(1208)),delayMs:0,icon:"ui/mini-icons/lightbulb",displayBelow:!0}),this.onEvent(c.UserActions.ReturnHeldPawn,(()=>{this.goTo("step1_waitForPikemanPickup")})),this.onEvent(c.GameEvents.HexCaptured,(e=>{1208===e.capturedHexId?this.goTo("step3_commentary"):this.goTo("main")}))}}class g extends r.LevelScript{activate(){super.activate(),s.inject.scene.playUI.updateState({mode:l.PlayUIMode.OwnedRegionSelected}),s.inject.gameStateModel,this.addTooltip({title:"They loved your move!",placement:a.TooltipPlacement.atWorldMapHex((0,o.getHex)(806)),delayMs:1500,enforceDelay:!0,icon:"ui/mini-icons/lightbulb",displayBelow:!0}),this.addTooltip({title:"We've cut off the enemy pikeman!",placement:a.TooltipPlacement.atWorldMapHex((0,o.getHex)(1407)),delayMs:200,enforceDelay:!0,icon:"ui/mini-icons/lightbulb",displayBelow:!0}),this.onEvent(c.UserActions.EndTurn,(()=>{this.goTo("main")}))}}},10780:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getTileFrameKey=t.createTileSprite=t.createCornerImage=t.Box=t.BoxTexture=void 0;var s=Phaser.GameObjects.Image,n=Phaser.Geom.Rectangle;const a=i(95569);var o;(o=t.BoxTexture||(t.BoxTexture={})).Plate="ui/box/plate",o.RoundedPlate="ui/box/rounded-plate",o.InnerPlate="ui/box/inner-plate",o.WindowFrame="ui/box/window",o.Tooltip="ui/box/tooltip",o.DialogButton="ui/box/dialog-button",o.DialogButtonDown="ui/box/dialog-button-down";class r extends a.BaseResponsiveContainer{constructor(e,t,i=0,s=0,n=0,a=0){super(e),this.setPosition(i,s),this.setSize(n,a),this.topLeftCorner=c(e,t,0),this.topEdge=l(e,t,1),this.topRightCorner=c(e,t,2),this.leftEdge=l(e,t,3),this.middle=l(e,t,4),this.rightEdge=l(e,t,5),this.bottomLeftCorner=c(e,t,6),this.bottomEdge=l(e,t,7),this.bottomRightCorner=c(e,t,8),this.add(this.getSprites())}setInteractive(){return super.setInteractive({cursor:"pointer",hitArea:new n(this.width/2,this.height/2,this.width,this.height),hitAreaCallback:n.Contains}),this}updateHitArea(){this.input?.hitArea&&(this.input.hitArea=new n(this.width/2,this.height/2,this.width,this.height))}updateLayout(){const e=this.height-this.topLeftCorner.height-this.bottomLeftCorner.height,t=this.width-this.topLeftCorner.width-this.topRightCorner.width;this.topRightCorner.setPosition(this.width-this.topRightCorner.width,0),this.bottomLeftCorner.setPosition(0,this.height-this.bottomLeftCorner.height),this.bottomRightCorner.setPosition(this.width-this.bottomRightCorner.width,this.height-this.bottomRightCorner.height),this.topEdge.setPosition(this.topLeftCorner.width,0),this.topEdge.setDisplaySize(t,this.topRightCorner.height),this.bottomEdge.setPosition(this.bottomLeftCorner.width,this.height-this.bottomLeftCorner.height),this.bottomEdge.setDisplaySize(t,this.bottomLeftCorner.height),this.leftEdge.setPosition(0,this.topRightCorner.height),this.leftEdge.setDisplaySize(this.topRightCorner.width,e),this.rightEdge.setPosition(this.width-this.topRightCorner.width,this.topLeftCorner.height),this.rightEdge.setDisplaySize(this.topRightCorner.width,e),this.middle.setPosition(this.topRightCorner.width-1,this.topRightCorner.height-1),this.middle.setDisplaySize(t+2,e+2),this.updateHitArea()}setTint(e){return this.getSprites().forEach((t=>t.setTint(e))),this}setTexture(e){this.getSprites().forEach(((t,i)=>t.setFrame(d(e,i))))}getSprites(){return[this.topLeftCorner,this.topEdge,this.topRightCorner,this.leftEdge,this.middle,this.rightEdge,this.bottomLeftCorner,this.bottomEdge,this.bottomRightCorner]}}function c(e,t,i){return new s(e,0,0,"atlas",d(t,i))}function l(e,t,i){const n=new s(e,0,0,"atlas",d(t,i));return n.setOrigin(0,0),n}function d(e,t){return`${e}/tile-${t}`}t.Box=r,t.createCornerImage=c,t.createTileSprite=l,t.getTileFrameKey=d},56421:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ButtonControllers=t.ButtonState=void 0;const s=i(32287),n=i(95972),a=i(67621);var o;(o=t.ButtonState||(t.ButtonState={})).Rest="rest",o.Hover="hover",o.Down="down",o.Disabled="disabled",t.ButtonControllers={simple:()=>new s.SimpleButtonStateController({}),passive:()=>new n.PassiveButtonStateController,options:(e,t)=>new a.OptionsGroupButtonController(e,t)}},67621:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OptionsGroupButtonController=void 0;const s=i(95972),n=i(14090),a=i(73735);t.OptionsGroupButtonController=class{constructor(e,t){this.buttons=e,this.onButtonClicked=(0,n.signal)(),this.buttonControllers=(0,a.mapDictionary)(e,((e,t)=>{const i=new s.PassiveButtonStateController;return e.setController(i),i.onClicked((()=>this.onButtonClicked.fire(t))),i}))}selectButton(e){for(let[t,i]of Object.entries(this.buttonControllers))i.setSelected(t===e)}}},95972:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PassiveButtonStateController=void 0;const s=i(14090),n=i(71203),a=i(9095),o=i(56421);t.PassiveButtonStateController=class{constructor(){this.enabled=!0,this.state=o.ButtonState.Rest,this.onClicked=(0,s.signal)(),this.selected=!1}getState(){return this.state}bindTo(e,t){this.applyState=t,e.removeAllListeners(),e.setInteractive({useHandCursor:!0}).on("pointerdown",(()=>{this.enabled?(this.onClicked.fire(),n.inject.audio.playEffect(a.SoundEffects.ButtonDown)):n.inject.audio.playEffect(a.SoundEffects.Deny)}))}setSelected(e){this.selected=e,this.state!==o.ButtonState.Hover&&this.enabled&&this.setState(e?o.ButtonState.Down:o.ButtonState.Rest)}setEnabled(e){this.enabled=e,this.setState(e?this.getIdleState():o.ButtonState.Disabled)}setState(e){e!==this.state&&(this.state=e,this.applyState(e))}getIdleState(){return this.selected?o.ButtonState.Down:o.ButtonState.Rest}}},32287:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleButtonStateController=void 0;const s=i(14090),n=i(71203),a=i(9095),o=i(56421);t.SimpleButtonStateController=class{constructor(e){this.options=e,this.enabled=!0,this.state=o.ButtonState.Rest,this.onClicked=(0,s.signal)()}getState(){return this.state}bindTo(e,t){this.applyState=t,e.removeAllListeners(),e.on("pointerover",(()=>{this.state===o.ButtonState.Rest&&this.setState(o.ButtonState.Hover)})).on("pointerout",(()=>{this.enabled?this.setState(o.ButtonState.Rest):this.setState(o.ButtonState.Disabled)})).on("pointerdown",(()=>{this.enabled?(this.setState(o.ButtonState.Down),this.playSoundEffect(a.SoundEffects.ButtonDown)):this.playSoundEffect(a.SoundEffects.Deny)})).on("pointerup",(()=>{this.enabled&&(this.setState(o.ButtonState.Hover),this.playSoundEffect(a.SoundEffects.ButtonUp),this.onClicked.fire())}))}playSoundEffect(e){!1!==this.options.audio&&n.inject.audio.playEffect(e)}setState(e){e!==this.state&&(this.state=e,this.applyState(e))}setEnabled(e){this.enabled=e,this.setState(e?o.ButtonState.Rest:o.ButtonState.Disabled)}}},59824:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColorBar=void 0;const s=i(73432),n=i(63286);class a extends s.Ribbon{constructor(e,t){super(e,s.RibbonTexture.ColorBar,t.x,t.y,t.width),this.props=t,this.adjustX=n.Control.propOf(this,"x",{duration:500}),this.adjustY=n.Control.propOf(this,"y",{duration:500}),this.adjustSize=new n.TransitionController(this.scene,{duration:500,applyValue:e=>this.width=e,initialValue:this.width}),void 0!==t.color&&this.setTint(t.color)}}t.ColorBar=a},84080:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CursorAttachment=void 0,t.CursorAttachment=class{constructor(e){this.scene=e}setImage(e){if(this.image){if(this.image===e)return;this.image.destroy()}this.image=e,e&&(this.scene.add.existing(e),e.setOrigin(0,0))}update(){this.image&&this.image.setPosition(this.scene.input.activePointer.x+8,this.scene.input.activePointer.y+8)}clear(){this.setImage(void 0)}}},96141:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugRectangle=void 0;const s=i(1157);var n=Phaser.GameObjects.BitmapText;t.DebugRectangle=class{constructor(e,t=255){this.target=e,this.rect=new Phaser.GameObjects.Rectangle(this.target.scene,0,0,0,0).setStrokeStyle(1,t,1).setOrigin(0,0).setDepth(1e4),this.label=new n(this.target.scene,0,0,s.BitmapFont.Debug).setTint(t).setOrigin(0,0).setDepth(1e4),this.target.parentContainer?this.target.parentContainer.add([this.rect,this.label]):(this.target.scene.add.existing(this.rect),this.target.scene.add.existing(this.label)),this.update()}update(){this.rect.setPosition(this.target.x,this.target.y),this.rect.setSize(this.target.width,this.target.height),this.label.setPosition(this.target.x,this.target.y-12),this.label.setText(`${this.target.constructor.name}: ${this.target.width}x${this.target.height}`)}setVisible(e){this.rect.setVisible(e),this.label.setVisible(e)}}},98538:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MiniButtonsRow=void 0;var s=Phaser.GameObjects.Container,n=Phaser.GameObjects.Image;const a=i(91895);t.MiniButtonsRow=class extends s{constructor(e,t){super(e),this.frames=t,this.buttons=[],this.createButtons()}createButtons(){if(this.frames.length<2)throw new Error("MiniButtonsRow must have at least 2 buttons");this.createButton("left",this.frames[0]),this.frames.slice(1,this.frames.length-1).forEach((e=>{this.createButton("mid",e)})),this.createButton("right",this.frames[this.frames.length-1]),this.add(this.buttons),this.updateLayout()}createButton(e,t){this.buttons.push(new a.ImageButtonWithContent(this.scene,0,0,{down:!0,frame:`ui/mini-buttons/${e}`,content:new n(this.scene,0,0,"atlas",t)}))}updateLayout(){let e=0;for(let t of this.buttons)t.x=e,e+=t.width-1;this.width=e+1,this.height=this.buttons[0]?.height??0}}},73432:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Ribbon=t.RibbonTexture=void 0;const s=i(10780);var n=Phaser.Geom.Rectangle;const a=i(95569);t.RibbonTexture={WindowHeader:{texture:"ui/ribbon/window-header",height:64},ButtonGroup:{texture:"ui/ribbon/button-group",height:54},Slider:{texture:"ui/ribbon/slider",height:7},ColorBar:{texture:"ui/ribbon/color-bar",height:12},DialogButton:{texture:"ui/ribbon/dialog-button",height:46},DialogButtonDown:{texture:"ui/ribbon/dialog-button-down",height:46},SmallButton:{texture:"ui/ribbon/small-button",height:30},SmallButtonDown:{texture:"ui/ribbon/small-button-down",height:30},MediumButton:{texture:"ui/ribbon/medium-button",height:36},MediumButtonDown:{texture:"ui/ribbon/medium-button-down",height:36},UnitTray:{texture:"ui/ribbon/unit-tray",height:64},Cloth:{texture:"ui/ribbon/cloth",height:64},Pergamen:{texture:"ui/ribbon/pergamen",height:48}};class o extends a.BaseResponsiveContainer{constructor(e,t,i=0,n=0,a=0){super(e),this.setPosition(i,n),this.setSize(a,t.height),this.leftEdge=(0,s.createCornerImage)(e,t.texture,0),this.middle=(0,s.createTileSprite)(e,t.texture,1),this.rightEdge=(0,s.createCornerImage)(e,t.texture,2),this.add([this.leftEdge,this.rightEdge,this.middle]),this.preUpdate()}setInteractive(){return super.setInteractive({hitArea:new n(this.width/2,this.height/2,this.width,this.height),hitAreaCallback:n.Contains,useHandCursor:!0}),this}updateHitArea(){this.input?.hitArea&&(this.input.hitArea=new n(this.width/2,this.height/2,this.width,this.height))}updateLayout(){const e=this.leftEdge.height,t=this.width-this.leftEdge.width-this.rightEdge.width;this.leftEdge.setPosition(0,0),this.rightEdge.setPosition(this.width-this.rightEdge.width,0),t>0?(this.middle.setVisible(!0),this.middle.setPosition(this.leftEdge.width-1,0),this.middle.setDisplaySize(t+2,e)):this.middle.setVisible(!1),this.updateHitArea()}getSprites(){return[this.leftEdge,this.middle,this.rightEdge]}setTint(e){this.getSprites().forEach((t=>t.setTint(e)))}setTexture(e){this.getSprites().forEach(((t,i)=>t.setFrame((0,s.getTileFrameKey)(e.texture,i))))}}t.Ribbon=o},2592:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ToolTipBox=void 0;const s=i(10780),n=i(63286);class a extends s.Box{constructor(e,t={padding:6}){super(e,s.BoxTexture.Tooltip),this.config=t,this.visibilityController=new n.TransitionController(this.scene,{initialValue:0,applyValue:e=>{const t=this.targetDimensions.width*e,i=this.targetDimensions.height;this.content?.setScale(e),this.content.y=this.config.padding+(1-e)*this.content.height/2,this.setPosition(this.targetDimensions.x-t/2,this.targetDimensions.y-i/2),this.setSize(t,i),this.setAlpha(e)}}),this.targetDimensions={x:0,y:0,width:0,height:0}}setContent(e){if(this.content){if(this.content===e)return;this.remove(this.content)}this.content=e,this.add(e),this.content.setPosition(this.config.padding,this.config.padding),this.targetDimensions.width=this.content.width+2*this.config.padding,this.targetDimensions.height=this.content.height+2*this.config.padding,this.updateTargetSize()}showAt(e,t){this.visibilityController.setTo(0),this.targetDimensions.x=e,this.targetDimensions.y=t,this.visibilityController.transitionTo(1,{duration:300,ease:"Sine.easeOut"}),this.updateTargetSize()}repositionTo(e,t){this.targetDimensions.x=e,this.targetDimensions.y=t,this.visibilityController.applyValue(this.visibilityController.currentValue)}updateTargetSize(){this.targetDimensions.width=this.content.width+2*this.config.padding,this.targetDimensions.height=this.content.height+2*this.config.padding,this.visibilityController.currentValue>0&&this.visibilityController.setTo(1)}hide(){this.visibilityController.transitionTo(0,{duration:300,ease:"Sine.easeOut"})}}t.ToolTipBox=a},15641:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoxButton=void 0;const s=i(56421),n=i(10780),a=i(35990);class o extends n.Box{constructor(e,t,i,n){super(e,n.baseTexture,0,0,n.width,n.height),this.props=n,this._state=s.ButtonState.Rest,this.setSize(n.width,n.height),n.content.setOrigin(.5,.5),n.buttonTint&&this.setTint(n.buttonTint),this.add([this.props.content]),this.setPosition(t,i),this.setInteractiveAuto(),this.setController((0,a.setupController)(n))}set buttonState(e){this._state=e,this.preUpdate.makeDirty()}get buttonState(){return this._state}setEnabled(e){this.controller.setEnabled(e)}get onClicked(){return this.controller.onClicked}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.buttonState=e)))}setTextTint(e){return this.props.content.setTint(e),this}updateLayout(){super.updateLayout();let e=Math.round(this.width/2+(this.props.contentOffset?.x??0)),t=Math.round(this.height/2+(this.props.contentOffset?.y??0));this.buttonState===s.ButtonState.Down&&(e+=2,t+=2),this.setTexture(this.props.downTexture&&this.buttonState===s.ButtonState.Down?this.props.downTexture:this.props.baseTexture),this.props.content.setPosition(e,t)}}t.BoxButton=o},35990:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupController=void 0;const s=i(32287);t.setupController=function(e){return void 0===e.controller?new s.SimpleButtonStateController({audio:e.audio}):null!==e.controller?e.controller:void 0}},15363:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageButton=void 0;const s=i(56421);var n=Phaser.GameObjects.Image;t.ImageButton=class extends n{constructor(e,t,i,n){super(e,t,i,"atlas",n.frame),this.config=n,this.setInteractive({cursor:"pointer"}),void 0===n.controller?this.setController(s.ButtonControllers.simple()):null!==n.controller&&this.setController(n.controller)}setController(e){this.controller=e,e.bindTo(this,(e=>this.setButtonState(e)))}setBaseFrame(e){this.config.frame=e,this.setButtonState(this.controller.getState())}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}setButtonState(e){switch(e){case s.ButtonState.Rest:this.setFrame(this.config.frame);break;case s.ButtonState.Disabled:this.setFrame(this.config.frame+(this.config.disabled?"-disabled":""));break;case s.ButtonState.Hover:this.setFrame(this.config.frame+(this.config.hover?"-hover":""));break;case s.ButtonState.Down:this.setFrame(this.config.frame+(this.config.down?"-down":""))}}}},91895:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageButtonWithContent=void 0;const s=i(56421);var n=Phaser.GameObjects.Container,a=Phaser.GameObjects.Sprite;const o=i(35990);t.ImageButtonWithContent=class extends n{constructor(e,t,i,s){super(e,t,i),this.config=s,this.buttonSprite=new a(this.scene,0,0,"atlas",s.frame),this.buttonSprite.setInteractive({cursor:"pointer"}),this.setController((0,o.setupController)(s)),this.config.content.setOrigin(.5,.5).setPosition(this.buttonSprite.width/2,this.buttonSprite.height/2-1),this.add([this.buttonSprite,this.config.content]),this.width=this.buttonSprite.width,this.height=this.buttonSprite.height}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}setController(e){e&&(this.controller=e,e.bindTo(this.buttonSprite,(e=>this.setButtonState(e))))}setButtonState(e){const t=this.buttonSprite.width/2,i=this.buttonSprite.height/2-1;switch(e){case s.ButtonState.Rest:this.buttonSprite.setFrame(this.config.frame),this.config.content.setPosition(t,i);break;case s.ButtonState.Disabled:this.buttonSprite.setFrame(this.config.frame+(this.config.disabled?"-disabled":"")),this.config.content.setPosition(t,i);break;case s.ButtonState.Hover:this.buttonSprite.setFrame(this.config.frame+(this.config.hover?"-hover":"")),this.config.content.setPosition(t,i);break;case s.ButtonState.Down:this.buttonSprite.setFrame(this.config.frame+(this.config.down?"-down":"")),this.config.content.setPosition(t+1,i+1)}}}},14067:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MiniCloseButton=void 0;const s=i(15363);class n extends s.ImageButton{constructor(e,t,i){super(e,t,i,{frame:"ui/mini-close-button",hover:!0})}}t.MiniCloseButton=n},77949:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RibbonButton=t.RibbonButtonStyle=void 0;const s=i(73432),n=i(32287),a=i(56421),o=i(95569),r=i(35990);t.RibbonButtonStyle={Small:{base:s.RibbonTexture.SmallButton,down:s.RibbonTexture.SmallButtonDown},Medium:{base:s.RibbonTexture.MediumButton,down:s.RibbonTexture.MediumButtonDown}};class c extends o.BaseResponsiveContainer{constructor(e,t,i,o){super(e),this.props=o,this._state=a.ButtonState.Rest,this.button=new s.Ribbon(this.scene,o.type.base,0,0,o.width),this.setSize(this.props.width,o.type.base.height),this.setInteractiveAuto(),o.content.setOrigin(.5,.5),o.buttonTint&&this.button.setTint(o.buttonTint),this.add([this.button,this.props.content]),o.icon&&this.add(o.icon),this.setPosition(t,i),this.setController((0,r.setupController)(o)),void 0===o.controller?this.setController(new n.SimpleButtonStateController({audio:this.props.audio})):null!==o.controller&&this.setController(o.controller)}set buttonState(e){this._state=e,this.preUpdate.makeDirty()}get buttonState(){return this._state}setEnabled(e){this.controller.setEnabled(e)}get onClicked(){return this.controller.onClicked}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.buttonState=e)))}setTint(e,t){return this.button.setTint(t),this.props.content.setTint(e),this}updateLayout(){this.button.width=this.width,this.button.height=this.height;let e=this.button.width/2+(this.props.icon?this.props.icon.width/2:0),t=this.button.height/2;this.buttonState===a.ButtonState.Down&&(e+=2,t+=2),this.props.icon?.setPosition(this.props.icon?.width/2+14,t),this.button.setTexture(this.props.type.down&&this.buttonState===a.ButtonState.Down?this.props.type.down:this.props.type.base),this.props.content.setPosition(e+(this.props.contentOffset?.x??0),t+(this.props.contentOffset?.y??0))}}t.RibbonButton=c},2214:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoundedRectButton=void 0;var s=Phaser.Geom.Rectangle;const n=i(95569),a=i(10445),o=i(7721),r=i(56421),c=i(35990);class l extends n.BaseResponsiveContainer{constructor(e,t){super(e),this._rounded=1,this._raised=0,this._contentOriginX=0,this.background=new o.RoundedRect(this.scene,{x:0,y:0,fillStyle:{color:12969202,alpha:1},radius:0}),t.raised&&(this._raised=t.raised,this.shadow=new o.RoundedRect(this.scene,{x:0,y:0,fillStyle:{color:a.Colors.glassUi.shapeShadow,alpha:1},radius:0}),this.add(this.shadow)),this.content=t.content,this._contentOriginX=t.contentOriginX??0,this.add([this.background,this.content]),this.setInteractive({hitArea:this.getHitArea(),hitAreaCallback:s.Contains,cursor:"pointer"}),this.setController((0,c.setupController)({audio:t.audio}))}getHitArea(){return this._raised?new s(this.width/2-4,this.height/2-4,this.width+4,this.height+4):new s(this.width/2,this.height/2,this.width,this.height)}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.onNewButtonState(e))))}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}set rounded(e){this._rounded=e}get rounded(){return this._rounded}onNewButtonState(e){switch(e){case r.ButtonState.Disabled:this.background.setFillStyle(a.Colors.glassUi.shape),this.background.setAlpha(.5),this.preUpdate.makeDirty();break;case r.ButtonState.Hover:case r.ButtonState.Down:this.background.setAlpha(1),this.background.setFillStyle(a.Colors.glassUi.shapeLightAccent),this.preUpdate.makeDirty();break;default:this.background.setAlpha(1),this.background.setFillStyle(a.Colors.glassUi.shape),this.preUpdate.makeDirty()}}updateLayout(){const e=this._raised?this.controller.getState()===r.ButtonState.Down||this.controller.getState()===r.ButtonState.Disabled?-1:-this._raised:0;this.input.hitArea.setTo(this.width/2,this.height/2,this.width,this.height),this.background.radius=this.height/2*this._rounded,this.background.setSize(this.width,this.height),this.content.setSize(this.width,this.height),this.background.setPosition(e,e),this.content.setPosition(e+this._contentOriginX*this.width-this.content.width*this._contentOriginX,e),this._raised&&this.shadow&&(this.shadow.setPosition(0,0),this.shadow.radius=this.background.radius,this.shadow.setSize(this.width,this.height))}}t.RoundedRectButton=l},63520:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StealthButton=void 0;var s=Phaser.Geom.Rectangle;const n=i(95569),a=i(10445),o=i(7721),r=i(56421),c=i(35990);class l extends n.BaseResponsiveContainer{constructor(e,t){super(e),this._radius=10,this._radius=t.radius??this._radius,this._background=new o.RoundedRect(this.scene,{x:0,y:0,fillStyle:{color:a.Colors.glassUi.shapeLightAccent,alpha:.5},radius:this._radius}).setAlpha(0),this.content=t.content,this.add([this._background,t.content]),this.setInteractive({hitArea:new s(this.width/2,this.height/2,this.width,this.height),hitAreaCallback:s.Contains,cursor:"pointer"}),this.setController((0,c.setupController)(t))}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.onNewButtonState(e))))}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}onNewButtonState(e){switch(e){case r.ButtonState.Hover:case r.ButtonState.Down:this._background.setAlpha(1);break;default:this._background.setAlpha(0)}}updateLayout(){this.input.hitArea.setTo(this.width/2,this.height/2,this.width,this.height),this._background.radius=this._radius,this._background.setSize(this.width,this.height),this.content.setPosition(this.width/2-this.content.width/2,this.height/2-this.content.height/2)}}t.StealthButton=l},92924:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFrame=t.SEAMLESS_IFRAME_CSS=void 0;const s=i(7231);t.SEAMLESS_IFRAME_CSS="\n    resize: none;\n    border: none;\n    scroll: auto;\n";class n extends s.ResizableDOMElement{constructor(e,i){super(e,0,0,document.createElement("iframe"),t.SEAMLESS_IFRAME_CSS+i.customCss??""),this.props=i,this.hasFocus=!1;const s=this.node;this.setElement(s),this.setOrigin(0,0)}}t.IFrame=n},7231:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResizableDOMElement=void 0;var i=Phaser.GameObjects.DOMElement;t.ResizableDOMElement=class extends i{constructor(e,t,i,s,n,a){super(e,t,i,s,n,a),this.node.style.transform="translate(-10000px, -10000px)",Object.defineProperties(this,{width:{set:e=>{this.node.style.width=`${e}px`},get:()=>this.node.offsetWidth},height:{set:e=>{this.node.style.height=`${e}px`},get:()=>this.node.offsetHeight}})}}},1956:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setKeyboardCaptureEnabled=t.TextArea=void 0;const s=i(71203),n=i(25578),a=i(7231);class o extends a.ResizableDOMElement{constructor(e,t){super(e,0,0,document.createElement("textarea"),n.TEXT_INPUT_BASE_CSS+t.customCss??""),this.props=t,this.hasFocus=!1;const i=this.node;i.readOnly=this.props.readOnly??!1,i.placeholder=this.props.placeholder??"",this.props.autoSelectAll&&(i.onclick=function(){this.focus(),this.select()}),this.props.onChange&&(i.oninput=()=>{t.onChange(i.value)}),i.onfocus=()=>{this.hasFocus=!0,r(!1)},i.onblur=()=>{this.hasFocus=!1,r(!0)},i.innerText=this.props.text??"",t.rows&&this.resizeToRows(t.rows),t.width&&(this.width=t.width),t.height&&(this.height=t.height),this.setElement(i),this.setOrigin(0,0)}resizeToRows(e){this.node.rows=e,this.node.style.height="auto"}get text(){return this.node.value}destroy(){console.log("DESTROYING TEXT AREA"),super.destroy(),this.hasFocus&&r(!0)}setValue(e){this.node.textContent=e}}function r(e){s.inject.game.input.keyboard.enabled=e}t.TextArea=o,t.setKeyboardCaptureEnabled=r},25578:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setKeyboardCaptureEnabled=t.TextInput=t.TEXT_INPUT_BASE_CSS=void 0;const s=i(71203),n=i(10445),a=i(7231);t.TEXT_INPUT_BASE_CSS=`\n    resize:none;\n    background-color: #${n.Colors.woodenUi.pergamen.toString(16)};\n    pointer-events: auto;\n    padding: 8px;\n    border-radius: 8px;\n    border: 2px solid #${n.Colors.glassUi.primaryText.toString(16)};\n    font-size: 10pt;\n    font-family: sans-serif;\n`;class o extends a.ResizableDOMElement{constructor(e,i){super(e,0,0,document.createElement("input"),t.TEXT_INPUT_BASE_CSS+i.customCss??""),this.props=i,this.hasFocus=!1;const s=this.node;s.readOnly=this.props.readOnly??!1,s.placeholder=this.props.placeholder??"",this.props.autoSelectAll&&(s.onclick=function(){this.focus(),this.select()}),this.props.onChange&&(s.oninput=()=>{i.onChange(s.value)}),s.onfocus=()=>{this.hasFocus=!0,r(!1)},s.onblur=()=>{this.hasFocus=!1,r(!0)},s.innerText=this.props.text??"",this.setElement(s),this.setOrigin(0,0),i.height?this.height=i.height:s.style.height="auto",i.width&&(this.width=i.width)}get text(){return this.node.value}destroy(){super.destroy(),this.hasFocus&&r(!0)}setValue(e){this.node.value=e}}function r(e){s.inject.game.input.keyboard.enabled=e}t.TextInput=o,t.setKeyboardCaptureEnabled=r},1532:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Card=t.CardPointerInputMode=void 0;const s=i(95569),n=i(7721),a=i(10445),o=i(32287),r=i(56421);var c,l=Phaser.Geom.Rectangle;!function(e){e.Whole="whole",e.WithoutFooter="without-footer",e.NotClickable="not-clickable"}(c=t.CardPointerInputMode||(t.CardPointerInputMode={}));class d extends s.BaseResponsiveContainer{constructor(e,t={}){if(super(e),this._footerSize=0,this._clickable=c.NotClickable,this._buttonState=r.ButtonState.Rest,this.background=new n.RoundedRect(e,{x:0,y:0,fillStyle:{color:a.Colors.glassUi.shape,alpha:1},radius:0}),this.shadow=new n.RoundedRect(e,{x:d.Layout.shadowDepth,y:d.Layout.shadowDepth,fillStyle:{color:a.Colors.glassUi.shapeShadow,alpha:1},radius:0}),this.footerBackground=new n.RoundedRect(e,{x:d.Layout.shadowDepth,y:d.Layout.shadowDepth,fillStyle:{color:a.Colors.glassUi.shapeDarkAccent,alpha:1},radius:0}),t.radius&&(this.radius=t.radius),t.onClick){this._onClick=t.onClick,this._clickable=t.clickable??c.Whole;const e=new o.SimpleButtonStateController({audio:!1});e.bindTo(this,(e=>{this._buttonState=e,this.preUpdate.makeDirty()})),e.onClicked(t.onClick)}else this._clickable=t.clickable??c.NotClickable;this.add([this.shadow,this.background,this.footerBackground]),t.content&&(this._content=t.content,this.add([this._content])),t.footerSize&&(this._footerSize=t.footerSize)}get clickable(){return this._clickable}set footerSize(e){this._footerSize=e,this.preUpdate.makeDirty()}get footerSize(){return this._footerSize}set radius(e){this.background.radius=e,this.preUpdate.makeDirty()}get radius(){return this.background.radius}set content(e){this._content!==e&&(this._content&&this.remove(this._content),this._content=e,this.add([this._content]),this.preUpdate.makeDirty())}get content(){return this._content}getHitAreaHeight(){return this.height-(this._clickable===c.Whole?0:this._footerSize)}setClickable(e){this._clickable=e,this.preUpdate.makeDirty()}updateLayout(){const e=this._buttonState===r.ButtonState.Down&&this._clickable===c.Whole?2:0;this._clickable!==c.NotClickable?(this.input?.hitArea?this.input.hitArea.setTo(this.width/2,this.height/2,this.width,this.getHitAreaHeight()):this.setInteractive({hitArea:new l(this.width/2,this.height/2,this.width,this.getHitAreaHeight()),hitAreaCallback:l.Contains,cursor:"pointer"}),this.input.enabled=!0):this.input&&(this.input.enabled=!1),this.shadow.setSize(this.width,this.height),this.shadow.radius=this.radius,this.background.setPosition(e,e),this.background.setSize(this.width,this.height),this._content?.setPosition(e,e),this._content?.setSize(this.width,this.height),this._buttonState===r.ButtonState.Down||this._buttonState==r.ButtonState.Hover?(this.background.setFillStyle(a.Colors.glassUi.shapeLightAccent),this._clickable===c.Whole&&this.footerBackground.setFillStyle(a.Colors.glassUi.shape)):(this.background.setFillStyle(a.Colors.glassUi.shape),this.footerBackground.setFillStyle(a.Colors.glassUi.shapeDarkAccent)),this.footerBackground.radius={tl:0,tr:0,bl:"object"==typeof this.radius?this.radius.bl:this.radius,br:"object"==typeof this.radius?this.radius.br:this.radius},this.footerBackground.setVisible(this.footerSize>0),this.footerBackground.setPosition(0+e,this.height-this.footerSize+e),this.footerBackground.setSize(this.width,this.footerSize)}}t.Card=d,d.Layout={shadowDepth:4,defaultRadius:20}},7721:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoundedRect=void 0;var s=Phaser.GameObjects.Graphics;const n=i(48565),a=i(82433);t.RoundedRect=class extends s{constructor(e,t){super(e,{x:t.x??0,y:t.y??0,fillStyle:t.fillStyle,lineStyle:t.lineStyle}),this.preUpdate=(0,n.whenDirty)((()=>{this.clear(),this.fillStyle(this._fillStyle.color??0,this._fillStyle.alpha),this.fillRoundedRect(0,0,this.width,this.height,this.radius)})),this.radius=t.radius,this._fillStyle=t.fillStyle||{color:4095,alpha:1},a.ResponsiveSizeComponent.overrideSizeComponent(this)}setFillStyle(e,t=1){this._fillStyle={color:e,alpha:t},this.preUpdate.makeDirty()}set radius(e){this._radius=e,this.preUpdate.makeDirty()}get radius(){return this._radius}}},36139:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ArrowButton=t.SelectBoxWithArrows=void 0;const s=i(95569),n=i(7721),a=i(79578),o=i(1157),r=i(10445),c=i(56421);var l=Phaser.GameObjects.Container,d=Phaser.Geom.Rectangle;const h=i(14090);class u extends s.BaseResponsiveContainer{constructor(e,t){super(e),this.ui=a.UiBuilder.for(this.scene),this.leftButton=new g(this.scene,{direction:"left"}),this.rightButton=new g(this.scene,{direction:"right"}),this.background=new n.RoundedRect(this.scene,{radius:12,fillStyle:{color:r.Colors.glassUi.shape,alpha:.3}}),this.titleText=this.ui.text("Title",o.BitmapFont.Mini,r.Colors.glassUi.secondaryText),this.selectedText=this.ui.text("Selected",o.BitmapFont.Main,r.Colors.glassUi.primaryText),this.components=[this.background,this.leftButton,this.rightButton,this.titleText,this.selectedText],this.items=[],this.selectedItemIndex=-1,this.onSelect=(0,h.signal)(),this.add(this.components),this.height=this.leftButton.height+10,this.setProps(t),this.leftButton.onClicked((()=>{if(0===this.selectedItemIndex){if(!this.infinite)return;this.onSelect.fire({value:this.items[this.items.length-1].value,direction:"left"})}else this.onSelect.fire({value:this.items[this.selectedItemIndex-1].value,direction:"left"})})),this.rightButton.onClicked((()=>{(this.infinite||this.selectedItemIndex!==this.items.length-1)&&this.onSelect.fire({value:this.items[(this.selectedItemIndex+1)%this.items.length].value,direction:"right"})}))}setProps(e){this.titleText.setText(e.title),this.items=e.options,this.infinite=e.infinite??!1,this.setSelection(e.selectedOption)}setSelection(e){let t=this.items.findIndex((t=>t.value===e));-1===t&&(t=0),this.selectedItemIndex=t,this.selectedItem=this.items[t],this.selectedItem?(this.selectedText.setText(this.selectedItem.title),this.leftButton.setEnabled(this.infinite||0!==t),this.rightButton.setEnabled(this.infinite||t!==this.items.length-1)):(this.selectedText.setText(""),this.leftButton.setEnabled(!1),this.rightButton.setEnabled(!1))}updateLayout(){const e=10+this.leftButton.height/2,t=this.width/2;this.leftButton.setPosition(0,e-this.leftButton.height/2),this.rightButton.setPosition(this.width-this.rightButton.width,e-this.leftButton.height/2),this.background.setSize(this.width-89,this.rightButton.height-10),this.background.setPosition(44,15),this.selectedText.setOrigin(.5,.5).setPosition(t,e),this.titleText.setOrigin(.5,.5).setPosition(t,5)}}t.SelectBoxWithArrows=u;class g extends l{constructor(e,t){super(e),this.ui=a.UiBuilder.for(this.scene),this.mainImage=this.ui.image("glass-ui/arrow-button"),this.shadow=this.ui.image("glass-ui/arrow-button-shadow").setTint(r.Colors.glassUi.shapeShadow),this.height=this.mainImage.height,this.width=this.mainImage.width,this.mainImage.setFlipX("left"===t.direction).setOrigin("left"===t.direction?1:0,0).setInteractive({cursor:"pointer",hitArea:new d("left"===t.direction?this.mainImage.width:0,0,this.mainImage.width,this.mainImage.height),hitAreaCallback:d.Contains}),this.shadow.setPosition(0,0).setOrigin("left"===t.direction?1:0,0).setFlipX("left"===t.direction),this.add([this.shadow,this.mainImage]),this.updateLayout(c.ButtonState.Rest),void 0===t.controller?this.setController(c.ButtonControllers.simple()):null!==t.controller&&this.setController(t.controller)}get onClicked(){return this.controller.onClicked}setController(e){this.controller=e,e.bindTo(this.mainImage,(e=>this.setButtonState(e)))}setEnabled(e){this.controller.setEnabled(e)}updateLayout(e=c.ButtonState.Rest){switch(e===c.ButtonState.Disabled?(this.mainImage.setAlpha(.3),this.shadow.setVisible(!1)):(this.mainImage.setAlpha(1),this.shadow.setVisible(!0)),e){case c.ButtonState.Down:case c.ButtonState.Disabled:this.mainImage.setPosition(0,0);break;default:this.mainImage.setPosition(-2,-2)}}setButtonState(e){this.updateLayout(e)}}t.ArrowButton=g},44031:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Arrange=t.horizontalAlign=void 0;const s=i(1951);function n(e){const t=e.content.filter((e=>e.object.visible)),i=e.spacing??0,n=e.origin??0;let a=t.map(c).reduce(s.sum,0)+i*(t.length-1),o=0;if(e.maxSize&&a>e.maxSize){let i=a-e.maxSize;const n=t.map((e=>e.minSize?c(e)-e.minSize:0)).reduce(s.sum,0);o=(0,s.min)(1,i/n),a=e.maxSize}let r=e.offset-a*n;for(let s of t){const t=c(s,o);s.object[e.layoutAxis]=r,s.object[e.secondarySizeProp]!==t&&(s.object[e.secondarySizeProp]=t),r+=t+i}function c(t,i=0){const s=t.size||t.object[e.primarySizeProp]||t.object[e.secondarySizeProp];if(i&&t.minSize){const e=s-t.minSize;return t.minSize+e*(1-i)}return s}}function a(e){return e.displayHeight||e.height}function o(e){return e.displayWidth||e.width}var r;(r=t.horizontalAlign||(t.horizontalAlign={}))[r.Left=0]="Left",r[r.Middle=.5]="Middle",r[r.Right=1]="Right",t.Arrange={fromTopToBottomOld(e,t){const i=(e=e.filter((e=>e.visible))).map(a).reduce(s.sum,0)+t.spacing*(e.length-1)+2*(t.padding??0);e.map(o).reduce(s.max,0);let n=t.y-i*(t.originY??0);for(let i of e)i.setPosition(t.x-o(i)*(t.originX??0),n),n=n+a(i)+t.spacing},fromLeftToRightOld(e,t){const i=(e=e.filter((e=>e.visible))).map(a).reduce(s.max,0),n=Math.min(t.maxWidth??Number.MAX_SAFE_INTEGER,e.map(o).reduce(s.sum,0))+t.spacing*(e.length-1)+2*(t.padding??0),r=t.x-n*(t.originX??0)+(t.padding??0);let c=t.y+(t.padding??0),l=r;for(let s of e){const e=o(s),n=a(s);t.maxWidth&&l-r+e>t.maxWidth&&(l=r,c=c+i+t.spacing),s.setPosition(l,c-n*(t.originY??0)),l=l+e+t.spacing}return{width:n,height:i}},alignVertically(e,t){const i=t.origin??.5;for(let s of e){const e=t.width??s.displayWidth??s.width;s.x=t.x-e*i,t.width&&s.width!==t.width&&(s.width=t.width)}},alignHorizontally(e,t){const i=t.origin??.5;for(let s of e){const e=t.height??s.displayHeight??s.height;s.y=t.y-e*i,t.height&&s.height!==t.height&&(s.height=t.height)}},vertically:e=>n({...e,offset:e.y,layoutAxis:"y",primarySizeProp:"displayHeight",secondarySizeProp:"height"}),horizontally:e=>n({...e,offset:e.x,layoutAxis:"x",primarySizeProp:"displayWidth",secondarySizeProp:"width"})}},49608:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AutoHeightComponent=void 0;const s=i(823);class n{constructor(e){this.parent=e,this._width=0,this._height=0,this.initialHeightSet=!1}get height(){return this._height}set width(e){this._width!==e&&(this._width=e,this.parent.preUpdate.force())}get width(){return this._width}updateSize(){const e=this.parent.calculateHeight();e!==this._height&&(this._height=e,this.initialHeightSet?this.parent.parentContainer?(0,s.handlesAutoSizeChildren)(this.parent.parentContainer)&&this.parent.parentContainer.handleChildResize(this.parent):(0,s.handlesAutoSizeChildren)(this.parent.scene)&&this.parent.scene.handleChildResize(this.parent):this.initialHeightSet=!0)}static overrideSizeComponent(e){const t=new n(e);Object.defineProperties(e,{width:{set:e=>{t.width=e},get:()=>t.width},height:{get:()=>t.height},updateSize:{value:t.updateSize.bind(t)}})}}t.AutoHeightComponent=n},70193:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AutoWidthComponent=void 0;const s=i(823);class n{constructor(e){this.parent=e,this._width=0,this._height=0,this.initialWidthSet=!1}get height(){return this._height}set height(e){this._height!==e&&(this._height=e,this.parent.preUpdate.force())}get width(){return this._width}updateSize(){const e=this.parent.calculateWidth();e!==this._width&&(this._width=e,this.initialWidthSet?this.parent.parentContainer?(0,s.handlesAutoSizeChildren)(this.parent.parentContainer)&&this.parent.parentContainer.handleChildResize(this.parent):(0,s.handlesAutoSizeChildren)(this.parent.scene)&&this.parent.scene.handleChildResize(this.parent):this.initialWidthSet=!0)}static overrideSizeComponent(e){const t=new n(e);Object.defineProperties(e,{width:{get:()=>t.width},height:{set:e=>{t.height=e},get:()=>t.height},updateSize:{value:t.updateSize.bind(t)}})}}t.AutoWidthComponent=n},95569:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveContainer=t.AutoWidthResponsiveContainer=t.AutoHeightResponsiveContainer=t.BaseResponsiveContainer=void 0;const s=i(48565),n=i(82433),a=i(49608),o=i(70193),r=i(96141),c=i(52163);var l=Phaser.GameObjects.Container,d=Phaser.Geom.Rectangle;class h extends l{constructor(e){super(e),this.updateList=[],this.autoInteractive=!1,this.preUpdate=(0,s.whenDirty)((()=>{this.updateLayout(),this.autoInteractive&&this.input?.hitArea&&(this.input.hitArea=new d(this.width/2,this.height/2,this.width,this.height))}),(()=>{this.debugRect?.update(),this.preUpdateChildren()}))}add(e){c.assert.defined(e),super.add(e);let t=Array.isArray(e)?e:[e];for(let e of t)(0,s.isResponsive)(e)&&this.updateList.push(e);return this}preUpdateChildren(){for(let e of this.updateList)e.preUpdate()}setSizeToFrame(e){throw new Error("not implemented")}setInteractiveAuto(){this.autoInteractive=!0,this.setInteractive({cursor:"pointer",hitArea:new d(this.width/2,this.height/2,this.width,this.height),hitAreaCallback:d.Contains})}showDebugOutline(){this.debugRect||(this.debugRect=new r.DebugRectangle(this))}}class u extends h{handleChildResize(e){this.preUpdate.makeDirty()}constructor(e){super(e),n.ResponsiveSizeComponent.overrideSizeComponent(this)}}t.BaseResponsiveContainer=u,t.AutoHeightResponsiveContainer=class extends h{constructor(e){super(e),a.AutoHeightComponent.overrideSizeComponent(this)}get height(){return super.height}},t.AutoWidthResponsiveContainer=class extends h{constructor(e){super(e),o.AutoWidthComponent.overrideSizeComponent(this)}get width(){return super.width}},t.ResponsiveContainer=class extends u{updateLayout(){}}},823:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handlesAutoSizeChildren=void 0,t.handlesAutoSizeChildren=function(e){return"function"==typeof e.handleChildResize}},48565:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isResponsive=t.whenDirty=void 0;const s=i(14090);t.whenDirty=function(e,t){let i=!0,n=!1;const a=(0,s.signal)(),o=()=>{i&&(i=!1,e()),t&&t()};return o.enableEagerUpdates=()=>{n=!0},o.isDirty=()=>i,o.makeDirty=()=>{i||a.fire(),i=!0,n&&o()},o.force=()=>{i=!0,o()},o.onBecameDirty=a,o},t.isResponsive=function(e){return e.preUpdate?.makeDirty}},46252:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveLayer=void 0;const s=i(48565);var n=Phaser.GameObjects.Layer;t.ResponsiveLayer=class extends n{constructor(e,t){super(e,t),this.updateList=[];for(let e of t)(0,s.isResponsive)(e)&&this.updateList.push(e)}add(e,t){return(0,s.isResponsive)(e)&&this.updateList.push(e),super.add(e,t)}remove(e,t){const i=this.updateList.indexOf(e);return-1!==i&&this.updateList.splice(i,1),super.remove(e,t)}preUpdate(){for(let e of this.updateList)e.preUpdate()}}},82433:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveSizeComponent=void 0;class i{constructor(e){this.parent=e,this._width=0,this._height=0}set height(e){this._height!==e&&(this._height=e,this.parent.preUpdate.makeDirty())}get height(){return this._height}set width(e){this._width!==e&&(this._width=e,this.parent.preUpdate.makeDirty())}get width(){return this._width}set(e,t){return this.width=e,this.height=t,this.parent}static overrideSizeComponent(e){const t=new i(e);Object.defineProperties(e,{width:{set:e=>{t.width=e},get:()=>t.width},height:{set:e=>{t.height=e},get:()=>t.height}}),e.setSize=t.set.bind(t)}}t.ResponsiveSizeComponent=i},64912:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TownStatusFlagsManager=t.FlagObject=t.FlagType=void 0;const s=i(23803),n=i(62199).logger.for("TownStatusFlags");(t.FlagType||(t.FlagType={})).Ready="ready";class a{constructor(e,t){this.renderer=e,this.objectPool=t}acquireSprites(){this.flagFace||(this.flagFace=this.objectPool.getFlag(0,0),this.flagPole=this.objectPool.getFlagPole(0,0))}attachToTile(e,t){this.acquireSprites(),this.tile=e,e.addObject(this.flagFace,10,-8),e.addObject(this.flagPole,10,10),this.flagPole.setDepth(this.flagPole.depth+2),this.flagFace.setDepth(this.flagPole.depth+3).setTint(t).play("wave-flag")}setTint(e){this.acquireSprites(),this.flagFace.setTint(e)}destroy(){this.tile&&(this.tile.removeObject(this.flagFace),this.tile.removeObject(this.flagPole),this.objectPool.free(this.flagPole),this.objectPool.free(this.flagFace))}}t.FlagObject=a,t.TownStatusFlagsManager=class{constructor(e,t,i){this.renderer=e,this.imagePool=t,this.tiles=i,this.flagsByHex={},this.backlightByHex={}}setFlag(e,t){if(this.flagsByHex[e.id])this.flagsByHex[e.id].setTint(t);else{if(!this.tiles.getByHex(e.id))return void n.warning(`cannot attach flag to hex ${e} - no such tile found`);const i=new a(this.renderer,this.imagePool);this.flagsByHex[e.id]=i,i.attachToTile(this.tiles.getByHex(e.id),t)}}removeFlag(e){this.flagsByHex[e.id]&&this.doRemoveFlag(e,this.flagsByHex[e.id])}clear(){Object.entries(this.flagsByHex).forEach((([e,t])=>{this.doRemoveFlag((0,s.getHex)(Number(e)),t)})),this.flagsByHex={}}doRemoveFlag(e,t){t.destroy(),delete this.flagsByHex[e.id]}}},99044:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.WorldLayers=void 0,(i=t.WorldLayers||(t.WorldLayers={}))[i.Landmass=0]="Landmass",i[i.Tiles=1e4]="Tiles",i[i.TileHighlight=2e4]="TileHighlight",i[i.TileBorders=3e4]="TileBorders",i[i.TileDecals=4e4]="TileDecals",i[i.TileObjects=5e4]="TileObjects",i[i.FlyingObject=6e4]="FlyingObject",i[i.UIOverlay=7e4]="UIOverlay",i[i.DebugOverlay=8e4]="DebugOverlay"},12455:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionBordersRenderer=t.WorldMapDebugOverlay=void 0;const s=i(62199),n=i(71203),a=i(26792),o=i(99044),r=i(1157),c=i(23803),l=i(95794),d=i(16115),h=i(89242);s.logger.for("WorldMapDebugOverlay"),t.WorldMapDebugOverlay=class{constructor(e,t){this.scene=e,this.renderer=t,this.signalSubs=[],this.hexDebugLabels={},this.active=!1,this.arrowsGroup=this.scene.add.group({defaultKey:"atlas",defaultFrame:"debug-arrow"}).setDepth(o.WorldLayers.DebugOverlay),this.chunkRectangles=this.scene.add.group({classType:Phaser.GameObjects.Rectangle,createCallback:e=>{const t=e;t.setStrokeStyle(1,65280,.5),t.setDepth(o.WorldLayers.DebugOverlay)}}),this.regionBorders=new u(this.renderer)}showDebugLayer(e){this.clearDebugLayer(),this.activeDebugLayer=e;const t=this.scene;if(this.regionBorders.clear(),e){n.inject.gameStateModel.map;const i=e.getMap();i.getHexIds().forEach((e=>{const s=(0,c.getHex)(e),n=i.get(s.id);null!=n&&(this.hexDebugLabels[e]?this.hexDebugLabels[e].setVisible(!0).setText(n.toString()):this.hexDebugLabels[e]=function(e,i){return new r.DebugTextBox(t,e.display.centerX,e.display.centerY,i,{origin:[.5,.5],backgroundOpacity:1}).setDepth(o.WorldLayers.DebugOverlay)}(s,n.toString()))})),(e.getArrows&&e.getArrows())?.forEach((e=>{const[t,i]=(0,c.getHexes)(e).members,s=t.getAngleTowards(i);if(void 0===s)return;const n=(t.display.centerX+i.display.centerX)/2,a=(t.display.centerY+i.display.centerY)/2;this.arrowsGroup.get(n,a).setActive(!0).setVisible(!0).setDepth(o.WorldLayers.DebugOverlay).setRotation(s)})),e.getGroups&&this.regionBorders.setGroups(e.getGroups())}}clearDebugLayer(e){this.activeDebugLayer&&(this.activeDebugLayer=void 0,this.debugLayerSub?.unsubscribe(),e?(Object.values(this.hexDebugLabels).forEach((e=>e.destroy())),this.hexDebugLabels={}):Object.values(this.hexDebugLabels).forEach((e=>e.setVisible(!1))),this.arrowsGroup.getChildren().forEach((e=>this.arrowsGroup.killAndHide(e))))}create(){this.active=!0,this.hexUnderCursor=this.scene.add.polygon(0,0,a.HEX_POLYGON).setStrokeStyle(2,255).setVisible(!1).setDepth(o.WorldLayers.DebugOverlay).setOrigin(0,0),this.registerSignals()}registerSignals(){this.unRegisterSignals(),this.signalSubs.push(n.inject.ui.hexUnderCursor.watch((e=>{e?(this.hexUnderCursor.setPosition(e.x*a.HEX_WIDTH,e.y*a.HEX_INNER_HEIGHT),this.hexUnderCursor.setVisible(!0)):this.hexUnderCursor.setVisible(!1)}))),n.inject.config.watchFuture(this.applyConfig.bind(this))}applyConfig(e){this.worldBoundsRectangle?.setVisible(!!e.debug.overlay)}unRegisterSignals(){this.signalSubs.forEach((e=>e.unsubscribe())),this.signalSubs=[]}redrawWorldBoundsRectangle(e){this.worldBoundsRectangle&&this.worldBoundsRectangle.destroy(),n.inject.config.debug.overlay&&(this.worldBoundsRectangle=this.scene.add.rectangle(e.x,e.y,e.width,e.height).setStrokeStyle(1,255,1).setDepth(o.WorldLayers.DebugOverlay).setOrigin(0,0))}redrawChunkRectangles(e){this.chunkRectangles.getChildren().forEach((e=>this.chunkRectangles.killAndHide(e))),n.inject.config.debug.chunkBorders&&e.map((e=>e.boundingBox)).forEach((e=>{const t=this.chunkRectangles.get(e.x,e.y);t.setSize(e.width,e.height),this.scene.add.existing(t)}))}destroy(e){this.unRegisterSignals(),this.clearDebugLayer(!0),this.active=!1,[this.worldBoundsRectangle,this.hexUnderCursor].forEach((e=>e?.destroy()))}setVisible(e){this.active!==e&&(e?this.create():this.destroy())}};class u{constructor(e){this.renderer=e,this.groups=[]}syncWithState(e=n.inject.currentGameState){this.clear();const t=d.Regions.model(e).all().map((e=>e.hexes));this.setGroups(t)}setGroups(e){e.filter((e=>e.length>0)).forEach((e=>{const t=new l.IsoTileGroup(this.renderer,h.IsoTileRecipes.Highlight,(e=>{}));t.setHexes(e),this.groups.push(t)}))}clear(){this.groups.forEach((e=>e.clear())),this.groups=[]}}t.RegionBordersRenderer=u},5926:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapEditorOverlay=void 0;const s=i(62199),n=i(71203),a=i(26792),o=i(99044),r=i(56541);s.logger.for("WorldMapEditorOverlay"),t.WorldMapEditorOverlay=class{constructor(e){this.scene=e,this.signalSubs=[],this.active=!1}create(){this.active=!0,this.worldBoundsRectangle=this.scene.add.rectangle(0,0,0,0).setStrokeStyle(1,16777215,.5).setDepth(o.WorldLayers.UIOverlay).setOrigin(0,0),this.hexUnderCursor=this.scene.add.polygon(0,0,a.HEX_POLYGON).setStrokeStyle(1,16777215,.5).setFillStyle(16777215,.2).setVisible(!1).setDepth(o.WorldLayers.UIOverlay).setOrigin(0,0),this.scene.add.existing(this.worldBoundsRectangle),this.scene.add.existing(this.hexUnderCursor),this.registerSignals()}setVisible(e){this.worldBoundsRectangle||this.create(),this.worldBoundsRectangle.setVisible(e),this.hexUnderCursor.setVisible(e),this.active=e,e?this.registerSignals():this.unRegisterSignals()}registerSignals(){this.unRegisterSignals(),this.signalSubs.push(n.inject.ui.hexUnderCursor.watch((e=>{e&&!e.isAtGridBorder(n.inject.gameStateModel.map)?(this.hexUnderCursor.setPosition(e.x*a.HEX_WIDTH,e.y*a.HEX_INNER_HEIGHT),this.hexUnderCursor.setVisible(!0)):this.hexUnderCursor.setVisible(!1)})))}unRegisterSignals(){this.signalSubs.forEach((e=>e.unsubscribe())),this.signalSubs=[]}update(){if(this.active){const e=(0,r.getWorldBounds)(n.inject.gameStateModel.map.innerWidth,n.inject.gameStateModel.map.innerHeight);this.worldBoundsRectangle.setPosition(a.HEX_WIDTH/2,a.HEX_INNER_HEIGHT),this.worldBoundsRectangle.setSize(e.width,e.height-r.EXTRA_SPACE_FOR_CONTROL_PANEL)}}}},97045:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AttitudeEmojiManager=t.EmojiObject=void 0;const s=i(62199),n=i(52163),a=i(17225),o=i(99044),r=i(21055);s.logger.for("ui:AttitudeEmoji");class c{constructor(e){this.pools=e,this.isDestroyed=!1,this.tile=void 0,this.tween=void 0,this.face=this.pools.getEmojiFace(12),this.crown=this.pools.getEmojiCrown()}attachToTile(e){(0,n.assert)(!this.isDestroyed),this.tile=e,e.addObject(this.face,0,-28),e.addObject(this.crown,0,-32),this.face.setDepth(o.WorldLayers.UIOverlay),this.crown.setDepth(o.WorldLayers.UIOverlay+1)}setAttitude(e){this.face.setFrame((0,a.getFrameForEmojiFace)(e))}setAlpha(e){this.face.setAlpha(e),this.crown.setAlpha(e)}detachFromTile(){this.tile&&(this.tile.removeObject(this.face),this.tile.removeObject(this.crown))}destroy(){(0,n.assert)(!this.isDestroyed),this.detachFromTile(),this.pools.free(this.face),this.pools.free(this.crown),this.isDestroyed=!0}}t.EmojiObject=c,t.AttitudeEmojiManager=class{constructor(e,t,i){this.scene=e,this.pool=t,this.tiles=i,this.emojis=new Map,this.animating=!1,this.cinematics={appear:new r.EmojisAppearCinematic(this,{delay:0,delayNoise:100,maxDelay:1e3,duration:200}),hide:new r.EmojisHideCinematic(this,{delay:0,delayNoise:50,maxDelay:100,duration:200})}}clear(){Array.from(this.emojis.keys()).forEach((e=>this.remove(e)))}set(e,t,i=1){const s=this.emojis.get(e);if(s&&!s.isDestroyed)s.setAttitude(t),this.animating||s.setAlpha(i);else{const s=new c(this.pool);s.attachToTile(this.tiles.getByHex(e.id)),this.emojis.set(e,s),s.setAttitude(t),this.animating||s.setAlpha(i)}}remove(e){const t=this.emojis.get(e);t&&(t.destroy(),this.emojis.delete(e))}getAll(){return Array.from(this.emojis.values())}}},21055:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EmojisHideCinematic=t.EmojisAppearCinematic=void 0;const s=i(32304),n=i(26244);class a extends n.BaseCinematic{constructor(e,t){super(e.scene),this.emojiManager=e,this.config={duration:500,delay:0,delayNoise:0,maxDelay:0,...t}}execute(e){this.emojiManager.animating=!0;const t=this.emojiManager.getAll();this.emojis=t;const i=(0,s.createStaggeredDelay2Dfn)(t.map((e=>e.face)),this.config.delay,this.config.maxDelay,this.config.delayNoise),n=new Map;t.forEach((e=>{const t=e.face.y;e.face.setY(t+10),e.face.setAlpha(0),e.crown.setAlpha(0),e.crown.setY(e.crown.y+10);const s=i(e.face);n.set(e.face,s),n.set(e.crown,s)})),this.mainTween=this.scene.tweens.add({duration:this.config.duration,targets:[...t.map((e=>e.face)),...t.map((e=>e.crown))],y:"-=10",ease:"Sine.easeIn",alpha:1,delay:e=>n.get(e)}),this.mainTween.once(Phaser.Tweens.Events.TWEEN_COMPLETE,(()=>{this.emojiManager.animating=!1,e&&e()}))}playAfter(e,t){return this.emojiManager.animating=!0,this.emojiManager.getAll().forEach((e=>{e.face.setAlpha(0),e.crown.setAlpha(0)})),super.playAfter(e,t)}stop(){this.mainTween&&this.mainTween.stop(1)}toString(){return`[Effect: EmojiAppearCinematic (${this.mainTween?"playing":"stopped"})]`}}t.EmojisAppearCinematic=a;class o extends n.BaseCinematic{constructor(e,t){super(e.scene),this.emojiManager=e,this.config={duration:500,delay:0,delayNoise:0,maxDelay:0,...t}}execute(e){const t=this.emojiManager.getAll();this.emojis=t;const i=(0,s.createStaggeredDelay2Dfn)(t.map((e=>e.face)),this.config.delay,this.config.maxDelay,this.config.delayNoise),n=new Map;t.forEach((e=>{const t=i(e.face);n.set(e.face,t),n.set(e.crown,t)})),this.faceTween=this.scene.tweens.add({duration:this.config.duration,targets:[...t.map((e=>e.face)),...t.map((e=>e.crown))],y:"+=10",ease:"Sine.easeIn",alpha:0,delay:e=>n.get(e)}),e&&this.faceTween.once(Phaser.Tweens.Events.TWEEN_COMPLETE,(()=>{e()}))}stop(){this.faceTween&&this.faceTween.stop(1)}toString(){return`[Effect: EmojiAppearCinematic (${this.faceTween?"playing":"stopped"})]`}}t.EmojisHideCinematic=o},88970:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CameraScrollController=void 0;const s=i(62199),n=i(71203),a=i(36504),o=i(1245);s.logger.for("ui:camera"),t.CameraScrollController=class{constructor(e){this.camera=e,this.dragging=!1,this.dragMomentumX=0,this.dragMomentumY=0,this.drag=3e3,this.dragStartPosition={x:0,y:0},this.scene=this.camera.scene;const t=this;this.cameraX=new o.KineticValue(e.scrollX,{scene:this.scene,drag:this.drag,apply:e=>this.camera.scrollX=e,stops:{getNextFrom:e=>e<t.bounds.left?t.bounds.left:void 0,getPreviousFrom:e=>e>t.bounds.right-t.camera.width?t.bounds.right-t.camera.width:void 0}}),this.cameraY=new o.KineticValue(0,{drag:this.drag,scene:this.scene,apply:e=>{this.camera.scrollY=e},stops:{getNextFrom:e=>e<t.bounds.top?t.bounds.top:void 0,getPreviousFrom:e=>e>t.bounds.bottom-t.camera.height?t.bounds.bottom-t.camera.height:void 0}}),this.pointer=this.scene.input.activePointer,this.scene.input.on("pointermove",this.pointerDragHandler,this),this.scene.events.on("update",this.update,this)}detach(){this.scene.input.removeListener("pointermove",this.pointerDragHandler),this.scene.input.removeListener("update",this.update)}update(e,t){this.dragMomentumX*=.8,this.dragMomentumY*=.8,this.cameraX.update(e,t),this.cameraY.update(e,t)}startDrag(){this.dragging=!0,this.dragStartPosition={x:this.cameraX.value,y:this.cameraY.value},this.dragCursorIconOn(),this.cameraX.freeze(),this.cameraY.freeze(),n.inject.tooltips.close()}async panTo(e,t,i=0,s=this.camera.zoom){const n=e/s-this.camera.width/s/2,a=t/s-this.camera.height/s/2;0===i?(this.cameraX.setTo(n),this.cameraY.setTo(a)):await Promise.all([this.cameraX.tweenTo(n,i,"Sine.easeInOut"),this.cameraY.tweenTo(a,i,"Sine.easeInOut")])}dragCursorIconOn(){this.scene.game.canvas.style.cursor="grabbing"}dragCursorIconOff(){this.scene.game.canvas.style.cursor="default"}pointerDragHandler(e){if(this.dragging){if(!e.isDown)return this.cameraX.unfreeze(),void this.cameraY.unfreeze();const t=e.position.x-e.prevPosition.x,i=e.position.y-e.prevPosition.y;this.dragMomentumX-=10*t,this.dragMomentumY-=10*i,this.cameraX.setTo(this.cameraX.value-t/this.camera.zoom),this.cameraY.setTo(this.cameraY.value-i/this.camera.zoom)}}stopDragging(){if(this.dragging){this.dragging=!1;const e=(0,a.euclidDistance)(this.dragStartPosition,{x:this.cameraX.value,y:this.cameraY.value});return this.cameraX.unfreeze(),this.cameraY.unfreeze(),this.cameraX.accelerate(this.dragMomentumX),this.cameraY.accelerate(this.dragMomentumY),this.dragCursorIconOff(),e}return 0}setBounds(e){this.bounds=e,this.cameraX.unfreeze(),this.cameraY.unfreeze()}}},34797:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CameraZoomController=void 0;const s=i(62199),n=i(1245),a=i(71203);s.logger.for("ui:camera"),t.CameraZoomController=class{constructor(e){this.pinchStartPointerDistance=0,this.pinchStartCameraDistance=0,this.camera=e.camera,this.scene=e.camera.scene,this.cameraDistance=new n.KineticValue(1/this.camera.zoom,{scene:this.scene,drag:20,min:.2,continueToNextStopThreshold:.1,stops:[.25,.5,1,1.5,2,3],apply:e=>this.camera.setZoom(1/e)})}applyScroll(e){0!==e&&this.cameraDistance.accelerate(.02*e)}startPinchZoom(){this.pinchStartPointerDistance=a.inject.scene.worldMap.pointersTracker.distanceBetweenPointers,this.cameraDistance.freeze(),this.pinchStartCameraDistance=this.cameraDistance.value}stopPinchZoom(){this.cameraDistance.unfreeze(),this.pinchStartCameraDistance=0,this.pinchStartPointerDistance=0}get isPinchZooming(){return 0!==this.pinchStartCameraDistance}update(e,t){if(this.isPinchZooming){const e=a.inject.scene.worldMap.pointersTracker.distanceBetweenPointers,t=this.pinchStartPointerDistance/e;this.cameraDistance.setTo(this.pinchStartCameraDistance*t)}else this.cameraDistance.update(e,t)}}},54001:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapCameraController=void 0;const s=i(88970),n=i(34797),a=i(56541),o=i(71203),r=i(36504);var c=Phaser.Geom.Rectangle;t.WorldMapCameraController=class{constructor(e){this.camera=e,this.scrollController=new s.CameraScrollController(this.camera),this.zoomController=new n.CameraZoomController({camera:this.camera}),this.viewPortMargins={left:0,right:0,top:0,bottom:0},this.camera.roundPixels=!0,this.zoomController.cameraDistance.setTo(1/o.inject.ui.scale())}setViewportMargins(e){const{x:t,y:i}=this.camera,s={left:0,right:0,bottom:0,top:0,...e},n=(s.left-t)/this.camera.zoom,a=(s.top-i)/this.camera.zoom;this.viewPortMargins=s,this.updateViewPort(),this.updateBounds(),this.scrollController.cameraX.setTo(this.scrollController.cameraX.value+n),this.scrollController.cameraY.setTo(this.scrollController.cameraY.value+a)}updateBounds(e){const t=o.inject.gameStateModel;this.worldBounds=(0,a.getWorldBounds)(t.map.width,t.map.height),o.inject.debugData.set("worldBounds",`${this.worldBounds.x},${this.worldBounds.y},${this.worldBounds.width},${this.worldBounds.height}`),this.updateCameraBounds()}updateCameraBounds(){if(!this.worldBounds)return;const e=this.camera.width/2,t=this.camera.height/2,i=new c(this.worldBounds.x-e,this.worldBounds.y-t,this.worldBounds.width+2*e,this.worldBounds.height+2*t);return this.scrollController.setBounds(i),o.inject.debugData.set("camBounds",`${i.x},${i.y} -> ${i.width},${i.height}`),i}async centerAboveControlPanel(e=0){this.updateBounds(),this.camera.preRender(),await this.scrollController.panTo(this.worldBounds.centerX,this.worldBounds.height-this.camera.displayHeight/2+a.EXTRA_SPACE_FOR_CONTROL_PANEL/2,e)}async center(e=0,t){this.updateBounds(t),t&&this.zoomController.cameraDistance.tweenTo(t,e,"Sine.easeInOut"),await this.scrollController.panTo(this.worldBounds.centerX,this.worldBounds.centerY,e,t)}async panAway(e,t=1e3){this.updateBounds();const[i,s]=[this.scrollController.cameraX.value,this.scrollController.cameraY.value],n={up:[i,this.worldBounds.height+o.inject.device.screenHeight],down:[i,-this.camera.displayHeight],right:[-this.camera.displayWidth,s],left:[this.camera.displayWidth,s]};let[a,r]=n[e];a+=this.camera.displayWidth/2,r+=this.camera.displayHeight/2,await this.scrollController.panTo(a,r,t)}async panIntoCenter(e,t=1e3){this.updateBounds();const[i,s]=[this.scrollController.cameraX.value,this.scrollController.cameraY.value],n={down:[i,this.worldBounds.height+o.inject.device.screenHeight],up:[i,-this.camera.displayHeight],left:[-this.camera.displayWidth,s],right:[this.camera.displayWidth,s]};let[a,r]=n[e];a+=this.camera.displayWidth/2,r+=this.camera.displayHeight/2,await this.scrollController.panTo(a,r),await this.center(t)}async ensureRectVisible(e,t=40){let i=c.Clone(this.camera.worldView);const s=this.camera.zoom;if(i.bottom-=a.EXTRA_SPACE_FOR_CONTROL_PANEL/s,i=c.Inflate(i,-t,-t),!c.ContainsRect(i,e)){e=c.Inflate(e,t,t);const s=i.x-e.x,n=e.right-i.right,a=i.y-e.y,o=e.bottom-i.bottom;let l=i.centerX,d=i.centerY;e.width>i.width?l=e.left+e.width/2-i.width/2:s>0?l-=s:n>0&&(l+=n),e.height>i.height?d=e.top+e.height/2-i.height/2:a>0?d-=a:o>0&&(d+=o);const h=(0,r.manhattanDistance)({x:i.centerX,y:i.centerY},{x:l,y:d});await this.scrollController.panTo(l,d,h)}}startDragScroll(){this.scrollController.startDrag()}stopDragScroll(){this.scrollController.stopDragging()}updateViewPort(){const e=this.viewPortMargins,t=o.inject.device.screenWidth-e.right-e.left,i=o.inject.device.screenHeight-e.top-e.bottom;this.camera.setViewport(e.left,e.top,t,i)}update(e,t){this.zoomController.update(e,t),this.scrollController.update(e,t)}}},56541:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getWorldBounds=t.EXTRA_SPACE_FOR_CONTROL_PANEL=void 0;var s=Phaser.Geom.Rectangle;const n=i(26792);t.EXTRA_SPACE_FOR_CONTROL_PANEL=100,t.getWorldBounds=function(e,i){let a=e*n.HEX_WIDTH,o=(i-1)*n.HEX_INNER_HEIGHT+n.HEX_HEIGHT+t.EXTRA_SPACE_FOR_CONTROL_PANEL;return new s(-n.HEX_WIDTH/2,0,a+n.HEX_WIDTH/2,o)}},57748:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Chest=void 0;const s=i(71203),n=i(82566);var a=Phaser.GameObjects.Image;const o=i(62199),r=i(99044),c=o.logger.for("coins");t.Chest=class extends a{constructor(e){super(e.scene,0,0,"atlas","chest"),this.pools=e,this.scene=this.pools.scene,this.currentAmount=0}addToTile(e,t,i){e.addObject(this,t,i)}addCoins(e){this.currentAmount+=e,this.updateVisibility()}consumeCoins(e){this.currentAmount+=e.length,this.updateVisibility(),s.inject.ui.skipTransitions()?e.forEach((e=>this.pools.free(e))):e.forEach(((e,t)=>{e.setDepth(r.WorldLayers.FlyingObject+10*this.y),(0,n.consumeCoin)(this.pools,e,this.x,this.y)}))}deleteCoins(e,t){this.currentAmount<e?(c.warning(`Attempted to delete ${e} coins from a virtual stack that already has only ${this.currentAmount} coins. Extra coins not deleted.`),this.currentAmount=0):this.currentAmount-=e,this.updateVisibility()}updateVisibility(){this.setVisible(this.currentAmount>0)}remainingCapacity(){return Number.POSITIVE_INFINITY}removeFromTile(e){e.removeObject(this)}spawnCoin(){return this.y,this.currentAmount-=1,this.updateVisibility(),this.pools.getCoin(this.x,this.y)}}},9036:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinPile=t.StackType=void 0;const s=i(62199),n=i(82566),a=i(26792),o=i(71203),r=i(1951),c=i(7844),l=i(57748);var d;!function(e){e[e.Regular=0]="Regular",e[e.Virtual=1]="Virtual",e[e.Chest=2]="Chest"}(d=t.StackType||(t.StackType={}));const h=[{x:-8,y:10,maxSize:5,type:d.Regular},{x:-12,y:6,maxSize:10,type:d.Regular},{x:-8,y:-2,maxSize:15,type:d.Regular},{x:6,y:-2,maxSize:12,type:d.Regular},{x:0,y:-6,maxSize:20,type:d.Regular},{x:13,y:8,maxSize:Number.POSITIVE_INFINITY,type:d.Chest}],u=s.logger.for("coins");t.CoinPile=class{constructor(e,t,i){this.pools=e,this.tiles=t,this.hex=i,this.stacks=[],this.overflowStack=new l.Chest(this.pools)}getCurrentAmount(){return this.stacks.map((e=>e.currentAmount)).reduce(r.sum,0)}addCoins(e){let t=e;for(;t>0;){const e=this.getOrCreateStackWithFreeCapacity();if(!e)return;e.remainingCapacity()>t?(e.addCoins(t),t=0):(t-=e.remainingCapacity(),e.addCoins(e.remainingCapacity()))}}setAmount(e){const t=e-this.getCurrentAmount();t>0?this.addCoins(t):t<0&&this.deleteCoins(-t)}deleteCoins(e){let t=e;for(;t>0;){const i=this.getLatestStack();if(!i)return void u.warning(`unable to delete ${e} coins from ${this.hex}, hex is already empty of coins`);i.currentAmount>t?(i.deleteCoins(t),t=0):(t-=i.currentAmount,i.deleteCoins(i.currentAmount,(()=>{this.destroyStack(i)})),this.stacks.pop())}}getLatestStack(){return this.stacks[this.stacks.length-1]}storeCoins(e){let t=[...e];for(;t.length>0;){const e=this.getOrCreateStackWithFreeCapacity();if(!e)return void this.stacks[this.stacks.length-1].consumeCoins(t);{const i=t.splice(0,e.remainingCapacity());e.consumeCoins(i)}}}spawnCoin(){const e=this.getLatestStack();if(e&&0!==e.currentAmount){const t=e.spawnCoin();return 0===e.currentAmount&&(this.destroyStack(e),this.stacks.pop()),t}return u.warning(`Spawning coin from pile at ${this.hex}, but the pile is empty => new coin created from nothing`),this.pools.getCoin((this.hex.x+.5)*a.HEX_WIDTH,this.hex.y*a.HEX_INNER_HEIGHT+a.HEX_HEIGHT/2+o.inject.random.integerBetween(-2,2))}destroy(){this.stacks.forEach((e=>{this.destroyStack(e)})),this.stacks=[]}getOrCreateStackWithFreeCapacity(){const e=this.stacks.find((e=>e.remainingCapacity()>0))||this.addStack();return e||u.warning(`Max displayable coin pile size exceeded at hex ${this.hex}. You have too much money!`),e}destroyStack(e){e.removeFromTile(this.tiles.getByHex(this.hex.id)),e.destroy()}addStack(){const e=h[this.stacks.length];if(!e)return;const t=this.createStackByType(e.type,e.maxSize);return this.stacks.push(t),t.addToTile(this.tiles.getByHex(this.hex.id),e.x,e.y),t}createStackByType(e,t){switch(e){case d.Regular:return new n.CoinStack(this.pools,t);case d.Chest:return new l.Chest(this.pools);case d.Virtual:return new c.VirtualStack(this.pools)}}}},82566:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.consumeCoin=t.CoinStack=t.COIN_SPRITE_SCALE=t.COIN_THICKNESS=t.COIN_FACE_SIZE=void 0;const s=i(71203),n=i(62199),a=i(99044),o=i(105),r=i(96486),c=i(52163);var l=Phaser.GameObjects.Container;const d=n.logger.for("coins");async function h(e,t,i,n){if(!s.inject.ui.skipTransitions())return new Promise((s=>{e.scene.tweens.add({targets:t,x:i,y:n,ease:"Sine.easeOut",duration:400,onComplete:()=>{s(),setTimeout((()=>e.free(t)),10)}})}));e.free(t)}t.COIN_FACE_SIZE=5,t.COIN_THICKNESS=2,t.COIN_SPRITE_SCALE=.5,t.CoinStack=class extends l{constructor(e,t){super(e.scene,0,0),this.pools=e,this.capacity=t,this.currentAmount=0,(0,o.assignObjId)(this)}addToTile(e,t,i){e.addObject(this,t,i)}removeFromTile(e){e.removeObject(this)}remainingCapacity(){return this.capacity-this.currentAmount}acquireSprites(){this.column=this.pools.getCoinStack(0,0),this.topCoin=this.pools.getCoin(0,-t.COIN_THICKNESS),this.cropRect=new Phaser.Geom.Rectangle(0,this.column.height-t.COIN_THICKNESS,this.column.width,t.COIN_THICKNESS),this.column.setCrop(this.cropRect),this.add([this.column,this.topCoin])}acquireSpritesIfNeeded(){this.column||this.acquireSprites()}updateSize(){if(this.stopAllTransitions(),0!==this.currentAmount){const e=this.getTargetSize();this.acquireSpritesIfNeeded(),c.assert.defined(this.topCoin),c.assert.defined(this.column),this.topCoin.y=this.column.y-e,this.topCoin.setAlpha(this.currentAmount>0?1:0),this.cropRect=new Phaser.Geom.Rectangle(0,this.column.height-e/t.COIN_SPRITE_SCALE,this.column.width,e/t.COIN_SPRITE_SCALE),this.column.setCrop(this.cropRect)}else this.freeSpritesIfEmpty()}getTargetSize(){return this.getSizeForAmount(this.currentAmount)}getSizeForAmount(e){return 0===e?t.COIN_THICKNESS:e*t.COIN_THICKNESS+1}freeSpritesIfEmpty(){0===this.currentAmount&&(this.column&&(this.remove(this.column),this.pools.free(this.column),this.column=void 0),this.topCoin&&(this.remove(this.topCoin),this.pools.free(this.topCoin),this.topCoin=void 0))}stopAllTransitions(){this.currentTransition&&(this.currentTransition.forEach((e=>e.stop())),this.currentTransition=void 0)}transitionSize(){return new Promise((e=>{let i=this.getTargetSize();const s=Math.abs(i-(this.cropRect?.height||0));if(0===s)return void e();const n=10*s;this.stopAllTransitions(),this.acquireSpritesIfNeeded(),c.assert.defined(this.column),this.currentTransition=[this.scene.tweens.add({targets:this.cropRect,height:i/t.COIN_SPRITE_SCALE,y:this.column.height-i/t.COIN_SPRITE_SCALE,duration:n,onUpdate:()=>this.column.setCrop(this.cropRect)}).on(Phaser.Tweens.Events.TWEEN_COMPLETE,(()=>{this.freeSpritesIfEmpty(),e()})),this.scene.tweens.add({targets:this.topCoin,props:{y:{duration:n,value:this.column.y-i},alpha:{value:1,duration:0}}})]}))}addCoins(e,t=r.noop){e>this.remainingCapacity()?(d.warning(`Attempted to add ${e} coins to a stack that already has ${this.currentAmount}/${this.capacity} coins. Extra coins not displayed.`),this.currentAmount=this.capacity):this.currentAmount+=e,s.inject.ui.skipTransitions()?(this.updateSize(),t()):this.transitionSize().then(t)}consumeCoins(e){this.currentAmount<this.capacity&&(this.currentAmount+=e.length),s.inject.ui.skipTransitions()?(e.forEach((e=>this.pools.free(e))),this.updateSize()):e.forEach(((e,t)=>{const i=this.y-this.getSizeForAmount(this.currentAmount-t);e.setDepth(a.WorldLayers.TileObjects+this.y-.01*i),h(this.pools,e,this.x,i).then((()=>this.updateSize()))}))}spawnCoin(){this.acquireSpritesIfNeeded();const e=this.y-this.getTargetSize();this.currentAmount-=1;const t=this.pools.getCoin(this.x,e);return this.updateSize(),t}destroy(){this.stopAllTransitions(),this.currentAmount=0,this.freeSpritesIfEmpty(),super.destroy()}deleteCoins(e,t=r.noop){this.currentAmount<e?(d.warning(`Attempted to delete ${e} coins to a stack that already has only ${this.currentAmount}/${this.capacity} coins. Extra coins not deleted.`),this.currentAmount=0):this.currentAmount-=e,s.inject.ui.skipTransitions()?(this.updateSize(),t()):this.transitionSize().then(t)}},t.consumeCoin=h},35860:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinTransactionCinematic=void 0;const s=i(26244),n=i(23803),a=i(26792),o=i(71203),r=i(99044),c=i(50737),l=i(52163);i(62199).logger.for("CoinTransactionCinematic");class d extends s.BaseCinematic{constructor(e,t){super(e.scene),this.coins=e,this.transactions=t}execute(e){const t=this.scene,i={},s={};let c=0;const d=this.transactions,h=this.coins;for(let e in d){const t=(0,n.getHex)(Number(e));l.assert.defined(t);const h=d[e],u=[];for(let e=0;e<h.spawn;++e){const e=this.coins.pools.getCoin((t.x+.5)*a.HEX_WIDTH,t.y*a.HEX_INNER_HEIGHT+a.HEX_HEIGHT/2+o.inject.random.integerBetween(-2,2));e.setDepth(r.WorldLayers.FlyingObject+e.y),u.push(e),this.scene.add.existing(e),e.setAlpha(0)}o.inject.ui.skipTransitions()||this.animateCoinSpawn(u),c+=u.length,i[e]=u,s[e]=h.consume||0}if(o.inject.ui.skipTransitions())u(),g(),e&&e();else{const e=c>0?1e3:0;this.scene.time.addEvent({delay:e,callback:u})}function u(){let s=!1;for(let e in d){const t=(0,n.getHex)(Number(e));l.assert.defined(t);const a=d[e],o=Object.values(a.send).reduce(((e,t)=>e+t),0);for(let s=a.spawn;s<o;++s){const s=h.getOrCreatePile(t).spawnCoin();s.setDepth(r.WorldLayers.FlyingObject-s.y),i[e].push(s),h.scene.add.existing(s)}for(let t in a.send){const o=(0,n.getHex)(Number(t)),r=a.send[t];l.assert.defined(o);const c=i[e];r>0&&(s=!0,h.getOrCreatePile(o).storeCoins(c.slice(0,r))),i[e]=i[e].slice(r)}i[e].length>0&&h.getOrCreatePile(t).storeCoins(i[e])}if(!o.inject.ui.skipTransitions()){const i=s?600:0;t.time.addEvent({delay:i,callback:g}),t.time.addEvent({delay:i+600,callback:e})}}function g(){for(let e in d){const t=(0,n.getHex)(Number(e));l.assert.defined(t);const i=d[e].consume;0!==i&&h.getOrCreatePile(t).deleteCoins(i)}}}animateCoinSpawn(e){const t=e.map((()=>o.inject.random.integerBetween(-100,100)));e.forEach(((e,i)=>{this.scene.time.addEvent({delay:t[i],callback:()=>{e.play("spin-coin")}})})),this.scene.tweens.add({targets:e,duration:500,y:"-=1",ease:c.jump,easeParams:[80],delay:(e,i,s,n)=>t[n],onComplete:()=>e.forEach((e=>{e.anims.stop(),e.setFrame(0)}))}),this.scene.tweens.add({targets:e,duration:500,x:e=>e.x+o.inject.random.integerBetween(-4,4),alpha:{from:0,to:1},delay:(e,i,s,n)=>t[n]})}}t.CoinTransactionCinematic=d},68568:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinsManager=void 0;const s=i(62199),n=i(73735),a=i(9036),o=i(23803),r=i(35860),c=i(1951),l=i(73508),d=i(29689);s.logger.for("coins"),t.CoinsManager=class{constructor(e,t,i){this.scene=e,this.pools=t,this.tiles=i,this.cinematics={transactions:e=>new r.CoinTransactionCinematic(this,e),growStacks:e=>new d.GrowCoinStacksCinematic(this,e)},this.piles={}}spawnOnHex(e,t){this.getOrCreatePile(e).addCoins(t)}setAmount(e,t){0===t?this.destroyPileAt(e.id):this.getOrCreatePile(e).setAmount(t)}syncWithModel(e){const t=e.pawns.select({type:[l.PawnType.Coins]}),i=new Set;for(const e of t)this.setAmount(e.hex,e.count),i.add(e.hex.id);for(const e in this.piles)i.has(Number(e))||this.destroyPileAt(Number(e))}applyTransactions(e){const t={};for(let i of Object.keys(e).map((e=>Number(e)))){const s=e[i];Object.entries(s.send).forEach((([e,i])=>{const s=Number(e);t[s]?t[s]+=i:t[s]=i}))}const i=(0,n.stripDuplicatesFrom)(Object.keys(e).concat(Object.keys(t)).map((e=>Number(e))));for(let s of i){const i=e[s]||{spawn:0,send:[],consume:0},n=Object.values(i.send).reduce(c.sum,0),a=i?.spawn+(t[s]??0)-n-i.consume;a>0?this.spawnOnHex((0,o.getHex)(s),a):a<0&&this.removeFromHex((0,o.getHex)(s),-a)}}removeFromHex(e,t){this.getOrCreatePile(e).deleteCoins(t)}getOrCreatePile(e){return(0,n.getOrCreate)(this.piles,e.id,(()=>new a.CoinPile(this.pools,this.tiles,e)))}getAllPiles(){return Object.values(this.piles)}destroyPileAt(e){const t=this.piles[e];t&&(t.destroy(),delete this.piles[e])}destroyCoins(){Object.values(this.piles).forEach((e=>{e.destroy()})),this.piles={}}}},29689:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GrowCoinStacksCinematic=void 0;const s=i(26244),n=i(71203),a=i(32304),o=i(23803);class r extends s.BaseCinematic{constructor(e,t){super(e.scene),this.coins=e,this.map=t,this.coinsByHex={},this.pilesHidden=!1}playAfter(e,t){return this.hidePiles(),super.playAfter(e,t)}execute(e=(()=>{})){this.hidePiles(),this.growPiles(e)}hidePiles(){this.pilesHidden||(this.pilesHidden=!0,n.inject.ui.withoutTransitions((()=>{for(let e of this.coins.getAllPiles()){const t=e.getCurrentAmount();this.coinsByHex[e.hex.id]=t,e.setAmount(0)}})))}growPiles(e){this.pilesHidden=!1;const t=1/n.inject.config.debug.tweenSpeedFactor,i=1e3*t,s=(0,a.createStaggeredDelay2Dfn)([{x:0,y:0},{x:this.map.width,y:this.map.height}],0,1e3*t,100*t);for(let e in this.coinsByHex){const t=(0,o.getHex)(Number(e)),i=this.coins.getOrCreatePile(t);setTimeout((()=>i.setAmount(this.coinsByHex[e])),s(t))}setTimeout(e,i)}}t.GrowCoinStacksCinematic=r},7844:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VirtualStack=void 0;const s=i(71203),n=i(82566),a=i(62199),o=i(99044),r=a.logger.for("coins");t.VirtualStack=class{constructor(e){this.pools=e,this.scene=this.pools.scene,this.currentAmount=0,this.x=0,this.y=0}setPosition(e,t){this.x=e,this.y=t}addCoins(e){this.currentAmount+=e}consumeCoins(e){this.currentAmount+=e.length,s.inject.ui.skipTransitions()?e.forEach((e=>this.pools.free(e))):e.forEach(((e,t)=>{e.setDepth(o.WorldLayers.FlyingObject+10*this.y),(0,n.consumeCoin)(this.pools,e,this.x,this.y)}))}deleteCoins(e,t){this.currentAmount<e?(r.warning(`Attempted to delete ${e} coins from a virtual stack that already has only ${this.currentAmount} coins. Extra coins not deleted.`),this.currentAmount=0):this.currentAmount-=e}destroy(){}remainingCapacity(){return Number.POSITIVE_INFINITY}addToTile(e,t,i){}removeFromTile(e){}spawnCoin(){return this.y,this.currentAmount-=1,this.pools.getCoin(this.x,this.y)}}},33580:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnObject=t.Highlight=t.PawnObjectModes=t.PAWN_SHADOW_SCALE_AT_MAX_JUMP=t.PAWN_JUMPING_HEIGHT=t.SYMBOL_VERTICAL_OFFSET=void 0;const s=i(99044),n=i(62199),a=i(13626),o=i(17225),r=i(50737),c=i(52163),l=i(92536),d=i(10445),h=n.logger.for("PawnsManager");var u,g;t.SYMBOL_VERTICAL_OFFSET=-25,t.PAWN_JUMPING_HEIGHT=8,t.PAWN_SHADOW_SCALE_AT_MAX_JUMP=.2,function(e){e.Detached="detached",e.AttachedToTile="attached",e.Tweening="tweening",e.Destroyed="destroyed"}(u=t.PawnObjectModes||(t.PawnObjectModes={})),function(e){e.Hang="hang",e.SelectedForMove="selected-for-move"}(g=t.Highlight||(t.Highlight={})),t.PawnObject=class{constructor(e,t,i,s){this.manager=e,this.id=t,this.type=i,this.variant=s,this.visible=!0,this.baseX=0,this.baseY=0,this.tile=void 0,this.jumping=!1,this.jumpingDeSync=0,this.highlight=null,this.mode=u.Detached,this.shadow=e.pools.getPawnShadow(i,s),this.image=e.pools.getPawnImage(i,s),this.tweener=new l.Tweener(this.manager.scene)}attachToTile(e){this.mode===u.AttachedToTile&&this.tile===e||(this.setMode(u.AttachedToTile),this.assertNotDestroyed(),this.tile=e,e.addObject(this.image,0,3),e.addObject(this.shadow,0,3),this.attachSymbol(),this.baseX=this.tile.centerX,this.baseY=this.tile.centerY+3,this.baseDepth=this.image.depth,this.image.setDepth(this.baseDepth),this.shadow.setDepth(this.image.depth-1),this.highlight===g.Hang&&this.startHangingTween())}setMode(e){if(this.mode!==e){switch(this.tweener.stop(!1),this.mode){case u.Destroyed:throw this.illegalModeTransitionError(e);case u.Tweening:this.image.setRotation(0),this.image.setAlpha(1),this.shadow.setAlpha(1)}this.mode=e,this.symbol?.setVisible(this.shouldShowSymbol())}}get hanging(){return this.highlight===g.Hang}setHighlight(e){if(this.highlight!==e)if(e)switch(this.highlight=e,e){case g.Hang:this.symbol?.setVisible(!1),this.mode===u.AttachedToTile&&this.startHangingTween();break;case g.SelectedForMove:this.symbol?.setVisible(!1),this.shadow.setFrame("pawn-move-pedestal").setTint(d.Colors.highlight.ownedRegion),this.startPedestalTween(),this.shadow.setScale(1);break;case null:this.clearHighlight()}else this.clearHighlight()}clearHighlight(){null!==this.highlight&&(this.tweener.stop(),this.symbol?.setVisible(this.shouldShowSymbol()),this.highlight===g.SelectedForMove&&this.shadow.setFrame((0,o.getShadowFrameForPawnType)(this.type,this.variant)).clearTint(),this.jumping?(this.setJumpPhase(.5),this.jumpingDeSync=this.manager._getCurrentJumpingDeSyncForPawn(this,.5)):this.setJumpPhase(0),this.highlight=null)}shouldShowSymbol(){return this.mode===u.AttachedToTile&&this.visible}shouldShowImage(){return this.mode!==u.Destroyed&&this.visible}shouldShowShadow(){return this.mode===u.AttachedToTile&&this.visible}setSymbol(e){this.assertNotDestroyed(),this.symbol?this.symbol.setFrame((0,o.getFrameForPawnSymbol)(e)):(this.symbol=this.manager.pools.getTileSymbol(e),this.attachSymbol())}attachSymbol(){this.tile&&this.symbol&&(this.tile.addObject(this.symbol,0,t.SYMBOL_VERTICAL_OFFSET),this.symbol.setDepth(s.WorldLayers.UIOverlay),this.symbol.setVisible(this.shouldShowSymbol()))}setJumpPhase(e){const i=-(0,r.jump2)(e)*t.PAWN_JUMPING_HEIGHT;this.image.setX(this.baseX),this.image.setY(this.baseY+i),this.symbol?.setY(this.baseY+i+t.SYMBOL_VERTICAL_OFFSET-3),this.shadow.setScale(.5-(0,r.jump2)(e)*t.PAWN_SHADOW_SCALE_AT_MAX_JUMP)}illegalModeTransitionError(e){return new Error(`Illegal mode transition ${this.mode} => ${e}\`)`)}assertMode(e,t="operation"){if(this.mode!==e)return new Error(`${t} unavialable in ${this.mode} (expected ${e})`)}removeSymbol(){this.symbol&&(this.tile&&this.tile.removeObject(this.symbol),this.manager.pools.free(this.symbol),this.symbol=void 0)}detachFromTile(){this.tile&&(this.tile.removeObject(this.image),this.tile.removeObject(this.shadow),this.symbol&&this.tile.removeObject(this.symbol),this.setMode(u.Detached))}destroy(){this.assertNotDestroyed(),this.detachFromTile(),this.removeSymbol(),this.mode=u.Destroyed,this.tweener.stop(!1),this.manager._remove(this),this.manager.pools.free(this.image),this.manager.pools.free(this.shadow)}hide(){this.assertNotDestroyed(),this.visible=!1,this.image.setVisible(!1),this.shadow.setVisible(!1),this.symbol?.setVisible(!1)}show(){this.assertNotDestroyed(),this.visible=!0,this.image.setVisible(!0),this.shadow.setVisible(!0),this.symbol?.setVisible(!0)}isDestroyed(){return this.mode===u.Destroyed}assertNotDestroyed(){(0,c.assert)(!this.isDestroyed(),`Attempting to modify ${this.type} at ${this.tile?.hex.id??"(no hex)"}, which is already destroyed`)}setType(e,t){this.assertNotDestroyed(),this.type===e&&this.variant===t||(this.type=e,this.variant=t,this.image.setFrame((0,o.getFrameForPawnType)(this.type,t)),this.shadow.setFrame((0,o.getShadowFrameForPawnType)(this.type,t)),this.image.setScale((0,o.getScaleForPawnType)(this.type)),this.image.setAlpha(1))}stopJumping(){this.jumping=!1,this.setJumpPhase(0)}startJumping(){this.jumping||(this.jumpingDeSync=this.manager._getCurrentJumpingDeSyncForPawn(this),this.jumping=!0)}setJumping(e){e?this.startJumping():this.stopJumping()}setTweens(e){this.setMode(u.Tweening),this.image.setDepth(s.WorldLayers.FlyingObject+this.image.y);for(let t of e)this.tweener.add(t)}startHangingTween(){h.warning(`[pawnObject ${this.id}] start hanging tween`);const e=this.tile.centerY-a.HOVERING_HEIGHT;this.tweener.add({targets:[this.image],duration:200,ease:"Sine.easeOut",y:e}),this.tweener.add({targets:this.shadow,duration:100,ease:"Sine.easeOut",scale:.5-t.PAWN_SHADOW_SCALE_AT_MAX_JUMP})}startPedestalTween(){const e=this.baseY-3;this.tweener.add({targets:[this.image],duration:200,ease:"Sine.easeOut",y:e}),this.tweener.add({targets:this.shadow,duration:100,ease:"Sine.easeOut",scale:{from:.1,to:1}})}}},13626:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsManager=t.HOVERING_HEIGHT=t.PawnEffects=void 0;const s=i(62199),n=i(33580),a=i(98439),o=i(13872),r=i(71203),c=i(73508),l=i(52163),d=i(92940),h=i(73735),u=i(55987);var g;(g=t.PawnEffects||(t.PawnEffects={})).Jump="jump",g.SpawnFromAbove="spawn-from-above";t.HOVERING_HEIGHT=10;const p=s.logger.for("PawnsManager");function m(e,t){return t.type==c.PawnType.Town?e.regions.byHex(t.hex)?.getLevel()??1:void 0}t.PawnsManager=class{constructor(e,t,i){this.scene=e,this.pools=t,this.tiles=i,this.transitions=new u.PawnTransitions(this,this.tiles),this.pawnsById={},this.jumpClock=this.scene.tweens.addCounter({from:0,to:1,ease:"Linear",repeat:-1,duration:o.TIMING.pawnJumpDuration})}update(){Object.values(this.pawnsById).filter((e=>e.mode===n.PawnObjectModes.AttachedToTile&&e.jumping&&!e.highlight)).forEach((e=>{const t=(this.getJumpPhaseForPawn(e)+e.jumpingDeSync)%1;e.setJumpPhase(t),e.jumpingDeSync>0&&e.jumpingDeSync<=.5?e.jumpingDeSync-=.002:e.jumpingDeSync>=.998?e.jumpingDeSync=0:e.jumpingDeSync>.5&&(e.jumpingDeSync+=.002)}))}getJumpPhaseForPawn(e,t=0){const i=e.baseY%o.TIMING.pawnJumpDuration/o.TIMING.pawnJumpDuration;return(this.jumpClock.getValue()+t/o.TIMING.pawnJumpDuration+i)%1}createOrUpdatePawnObject(e,t){const i=e.id,s=e.hexId,a=e.type,o=this.pawnsById[i],r=this.tiles.getByHex(s);if((0,l.assert)(r,`unable to get or create pawn on hex #${s} - no tile available for this hex!`),o)return o.setType(a,t),o.attachToTile(this.tiles.getByHex(s)),o.show(),o.setJumping(e.jumping),o;{const o=new n.PawnObject(this,i,a,t);return this.pawnsById[i]=o,o.attachToTile(this.tiles.getByHex(s)),o.setJumping(e.jumping),o}}syncWithModel(e,t){const i=e.pawns.all().filter(t),s=(0,h.dictionaryOf)(i,"id");this.clearAllJumping(),Object.entries(this.pawnsById).map((([e,t])=>{s[e]||(t.destroy(),delete this.pawnsById[e])}));for(const t of i)this.createOrUpdatePawnObject({id:t.id,hexId:t.hex.id,jumping:t.isMovable()&&!!t.faction?.isLocalPlayer(),type:t.type},m(e,t))}_remove(e){e.isDestroyed()?(delete this.pawnsById[e.id],this.hangingPawn===e&&this.clearHangingPawn()):e.destroy()}show(e){const t=this.pawnsById[e];t?(t.show(),t.jumpingDeSync=this._getCurrentJumpingDeSyncForPawn(t)):p.warning(`Ignoring request to show pawn ${e}, no such pawn exists`)}hide(e){const t=this.pawnsById[e];t?t.hide():p.warning(`Ignoring request to hide pawn ${e}, no such pawn exists`)}_getCurrentJumpingDeSyncForPawn(e,t=1){return(1+t-this.getJumpPhaseForPawn(e))%1}getPawnObjectPositionOnScreen(e,t){const i=this.pawnsById[t];if(i)return{...(0,a.convertWorldXYToCameraXY)(e,i.image.x,i.image.y),scale:e.zoom*i.image.scale};{const i=this.tiles.getByHex(t);return l.assert.defined(i,`hex ${t} not found`),{...(0,a.convertWorldXYToCameraXY)(e,i.centerX,i.centerY+3),scale:.5*e.zoom}}}setHangingPawn(e){const t=this.pawnsById[e];t!==this.hangingPawn&&(this.hangingPawn&&this.clearHangingPawn(),this.hangingPawn=t),this.hangingPawn&&this.hangingPawn.setHighlight(n.Highlight.Hang)}clearHangingPawn(){this.hangingPawn&&(this.hangingPawn.isDestroyed()||this.hangingPawn.clearHighlight(),this.hangingPawn=void 0)}clearAllJumping(){Object.values(this.pawnsById).map((e=>e.stopJumping()))}resetJumpingState(e){e.setJumpPhase(0)}async replace(e,t,i){let s=this.pawnsById[e];s||(0,l.assert)(s,`Request to replace pawn ${e} with ${t} but there is no existing pawn with this id => ignoring`),s.setType(t,i)}jumpOnce(e){let t=this.pawnsById[e];if(t){if(t.jumping)return void p.warning(`Request to play jump animation on ${e} ignored as pawn is already jumping`);this.scene.tweens.add({targets:t.image,y:{from:t.baseY,to:t.baseY-n.PAWN_JUMPING_HEIGHT},ease:"Sine.easeOut",duration:200,yoyo:!0}),this.scene.tweens.add({targets:t.shadow,scale:{from:.5,to:.2},ease:"Sine.easeOut",duration:200,yoyo:!0})}else p.warning(`Request to play jump animation on ${e} ignored as there is no pawn there`)}getByHex(e){return Object.values(this.pawnsById).find((t=>t.tile?.hex.id===e&&t.mode===n.PawnObjectModes.AttachedToTile))}getById(e){return this.pawnsById[e]}syncPawnVariant(e,t){const i=e.pawns.select({hexes:t,traits:[d.PawnTraits.OccupiesTile]});for(let t of i)this.replace(t.id,t.type,m(e,t))}integrityCheck(){if(r.inject.config.debug.integrityChecks?.pawns)for(let e in this.pawnsById){const t=this.pawnsById[e];(0,l.assert)(!t.isDestroyed(),`found destroyed ${t.type} at hex ${e} (v${t.variant??"-"}) still in pawnsByHex collection`)}}}},55987:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnTransitions=void 0;const s=i(62199),n=i(71203),a=i(92940),o=i(33580),r=i(13872),c=i(35171),l=i(26792),d=s.logger.for("PawnsManager");t.PawnTransitions=class{constructor(e,t){this.pawns=e,this.tiles=t,this.scene=this.pawns.scene}async defendTile(e,t){const i=c.HexGroup.from(t.map((e=>e.hex)));if(i.contains(e))return this.defendWithPawn(e.id,e.id);await Promise.all(i.map((t=>this.defendWithPawn(e.id,t.id))))}defendWithPawn(e,t){let i=this.pawns.getByHex(t);return new Promise((s=>{if(i)if(t==e)this.pawns.jumpOnce(t);else if(n.inject.gameStateModel.rules.pawns(i.type).hasTrait(a.PawnTraits.Building))this.pawns.jumpOnce(t);else{const n=this.tiles.getByHex(t).centerX,a=this.tiles.getByHex(e).centerX,o=i.baseY,r=(a-n)/2,c=(this.tiles.getByHex(e).centerY+3-o)/2;this.scene.tweens.add({targets:[i.image,i.shadow],y:{from:o,to:o+c},x:{from:n,to:n+r},ease:"Sine.easeInOut",duration:200,yoyo:!0,onComplete:s})}else d.warning(`Request to play jump animation from ${t} ignored as there is no pawn there`)}))}pawnArrival(e,t,i){return new Promise((s=>{const n=this.tiles.getByHex(t).centerX,a=this.tiles.getByHex(t).centerY+3,o=this.tiles.getByHex(i).centerX,c=this.tiles.getByHex(i).centerY+3;this.scene.tweens.add({targets:[e.image,e.shadow],x:{from:n,to:o},y:{from:a,to:c},alpha:{from:0,to:1},duration:r.TransitionsSpeed.Normal,ease:"Sine.easeIn",onComplete:s})}))}pawnMove(e,t){return new Promise((i=>{const s=n.inject.ui.transitionsSpeed(),a=t.srcHex||e.tile.hex.id,r=(this.tiles.getByHex(a).centerX,this.tiles.getByHex(a).centerY,t.destHex),c=this.tiles.getByHex(r).centerX,l=this.tiles.getByHex(r).centerY+3,d=[{targets:[e.image,e.shadow],x:{from:e.image.x,to:c},y:{from:e.image.y,to:l},duration:s,alpha:{from:t.fadeIn?0:1,to:1},ease:"Sine.easeOut",onComplete:()=>{e.isDestroyed()||e.attachToTile(this.tiles.getByHex(t.destHex)),i()}}];if(e.symbol){const t=l-3+o.SYMBOL_VERTICAL_OFFSET;d.push({targets:e.symbol,x:c,y:t,duration:s,ease:"Sine.easeOut"})}e.setTweens(d)}))}async destroyPawn(e,t){return new Promise((i=>{const s=2*n.inject.ui.transitionsSpeed();let a=l.HEX_WIDTH,o=l.HEX_HEIGHT/2;t&&(a=(e.tile.hex.display.centerX-t.display.centerX)/2,o=(e.tile.hex.display.centerY-t.display.centerY)/2),e.setTweens([{targets:[e.image],rotation:{from:0,to:Math.PI/2*(a>0?1:-1)},x:e.image.x+a,y:e.image.y+o,alpha:{from:1,to:0},ease:"Sine.easeOut",duration:s,onComplete:()=>{e.isDestroyed()||e.destroy(),i()}},{targets:[e.shadow],x:e.shadow.x+a,y:e.shadow.y+o,alpha:{from:1,to:0},duration:s,ease:"Sine.easeOut"}])}))}async pawnCreated(e,t){return new Promise((i=>{const s=n.inject.ui.transitionsSpeed(),a=this.tiles.getByHex(t).centerX,r=this.tiles.getByHex(t).centerY+3,c=[{targets:[e.image,e.shadow],y:{from:r+10,to:r},duration:s,alpha:{from:0,to:1},ease:"Sine.easeIn",onComplete:()=>{e.isDestroyed()||e.attachToTile(this.tiles.getByHex(t)),i()}}];if(e.symbol){const t=r-3+o.SYMBOL_VERTICAL_OFFSET;c.push({targets:e.symbol,x:a,y:t,duration:s,alpha:{from:0,to:1},ease:"Sine.easeIn"})}e.setTweens(c)}))}}},32801:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionBasedIsoRenderer=void 0;const s=i(95794),n=i(46299);t.FactionBasedIsoRenderer=class{constructor(e,t,i){this.scene=e,this.renderer=t,this.recipe=i,this.groupByFaction={},this.groupByHex={}}shouldRun(e){return!0}postProcess(e,t){}redrawFaction(e){if(!this.shouldRun(e.state))return;const t=this.groupByFaction[e.id];t&&(t.clear(),delete this.groupByFaction[e.id]);const i=e.hexes.filter((t=>this.shouldIncludeHex(e,t)));if(i.length>0){const t=this.getFactionGroup(e);i.forEach((e=>this.groupByHex[e.id]=t)),t.addHexes(i),t.update()}}clear(){Object.values(this.groupByFaction).forEach((e=>e.clear())),this.groupByFaction={},this.groupByHex={}}redrawHexes(e,t){if(!this.shouldRun(e))return;const i=new Set;t.forEach((t=>{const s=this.groupByHex[t.id],a=n.Factions.model(e).byHex(t),o=a&&this.getFactionGroup(a);s&&s!==o&&s.removeHexes(t),o?(this.groupByHex[t.id]=o,this.shouldIncludeHex(a,t)?o.addHexes(t):o.removeHexes(t)):delete this.groupByHex[t.id],o&&i.add(o),s&&i.add(s)})),i.forEach((e=>e.update()))}getFactionGroup(e){return void 0===this.groupByFaction[e.id]&&(this.groupByFaction[e.id]=new s.IsoTileGroup(this.renderer,this.recipe,this.postProcess.bind(this,e))),this.groupByFaction[e.id]}syncWithModel(e){this.clear(),e.factions.all().forEach((e=>this.redrawFaction(e)))}}},12543:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionsRenderer=void 0;const s=i(16115),n=i(80437),a=i(69938),o=i(43317),r=i(68678);t.RegionsRenderer=class{constructor(e){this.renderer=e,this.greenRenderer=new o.GreenRenderer(this.renderer),this.palisadeRenderer=new n.PalisadeRenderer(this.renderer),this.subRenderers=[new a.GroundRenderer(this.renderer),this.palisadeRenderer,this.greenRenderer,new r.ForestRenderer(this.renderer)]}syncWithModel(e){this.subRenderers.forEach((t=>t.syncWithModel(e)))}redrawRegions(e,t){for(let i of t){const t=s.Regions.model(e).byId(i);t&&this.redrawRegion(t)}}redrawRegion(e){this.subRenderers.forEach((t=>t.redrawFaction(e.faction)))}refreshHexes(e,t){this.subRenderers.forEach((i=>i.redrawHexes(e,t)))}}},89242:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IsoTileRecipes=void 0;const s=i(99044),n={A111:{frame:"full"},V111:{frame:"full"},V001:{frame:"inner",crop:{x:24,y:0,width:26,height:38}},A010:{frame:"inner",crop:{x:48,y:0,width:26,height:38}},V100:{frame:"inner",crop:{x:48,y:36,width:26,height:38}},A100:{frame:"inner",crop:{x:24,y:36,width:26,height:38}},V010:{frame:"inner",crop:{x:0,y:36,width:26,height:38}},A001:{frame:"inner",crop:{x:0,y:0,width:26,height:38}},V110:{frame:"outer",crop:{x:24,y:0,width:26,height:38}},A101:{frame:"outer",crop:{x:48,y:0,width:26,height:38}},V011:{frame:"outer",crop:{x:48,y:36,width:26,height:38}},A011:{frame:"outer",crop:{x:24,y:36,width:26,height:38}},V101:{frame:"outer",crop:{x:0,y:36,width:26,height:38}},A110:{frame:"outer",crop:{x:0,y:0,width:26,height:38}}};t.IsoTileRecipes={Palisade:{baseDepth:s.WorldLayers.TileObjects,offsetA:24,offsetV:24,frames:{V001:{frame:"V001"},A010:{frame:"A010"},V100:{frame:"V100"},A100:{frame:"A100"},V010:{frame:"V010"},A001:{frame:"A001"},V110:{frame:"V110"},A101:{frame:"A101"},V011:{frame:"V011"},A011:{frame:"A011"},V101:{frame:"V101"},A110:{frame:"A110"}},frameIdBase:"iso-tiles/palisade"},Ground:{baseDepth:s.WorldLayers.Tiles,frameIdBase:"iso-tiles/ground",offsetV:13,offsetA:25,frames:n},Forest:{baseDepth:s.WorldLayers.TileObjects,frameIdBase:"iso-tiles/forest",offsetV:13,offsetA:25,frames:n},Green:{baseDepth:s.WorldLayers.Tiles+100,frameIdBase:"iso-tiles/green",offsetV:13,offsetA:25,frames:{...n,A101:{frame:"outer-v"},V110:{frame:"outer-h"},V011:{frame:"outer-v",flipY:!0},A011:{frame:"outer-h",flipY:!0},V101:{frame:"outer-v",flipX:!0,flipY:!0},A110:{frame:"outer-v",flipX:!0}}},Landmass:{baseDepth:s.WorldLayers.Landmass,frameIdBase:"iso-tiles/landmass",offsetV:13,offsetA:25,frames:n},Highlight:{baseDepth:s.WorldLayers.TileHighlight,frameIdBase:"iso-tiles/highlight",offsetV:13,offsetA:25,frames:{...n,A111:void 0,V111:void 0}},Simple2D:{frames:{A111:{frame:"A111"},V111:{frame:"A111",flipY:!0},V001:{frame:"V001"},A010:{frame:"A010"},V100:{frame:"A010",flipY:!0},A100:{frame:"V001",flipY:!0},V010:{frame:"A010",flipX:!0,flipY:!0},A001:{frame:"A010",flipX:!0},V110:{frame:"V110"},A101:{frame:"A101"},V011:{frame:"A101",flipY:!0},A011:{frame:"V110",flipY:!0},V101:{frame:"A101",flipX:!0,flipY:!0},A110:{frame:"A101",flipX:!0}}}}},68678:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ForestRenderer=void 0;const s=i(32801),n=i(89242),a=i(24011),o=i(73508),r=i(9332);class c extends s.FactionBasedIsoRenderer{constructor(e){super(e.scene,e,n.IsoTileRecipes.Forest)}redrawFaction(e){e?.id===a.SpecialFaction.neutral&&super.redrawFaction(e)}shouldIncludeHex(e,t){return e.id===a.SpecialFaction.neutral&&!!r.Pawns.model(e.state).findOne({hexes:t,type:[o.PawnType.Forest]})}}t.ForestRenderer=c},43317:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GreenRenderer=void 0;const s=i(32801),n=i(89242),a=i(16115),o=i(35171);class r extends s.FactionBasedIsoRenderer{constructor(e){super(e.scene,e,n.IsoTileRecipes.Green)}shouldIncludeHex(e,t){return!!a.Regions.model(e.state).byHex(t)?.isAlive()}postProcess(e,t){const i=e?.landColorLight||0;t.setTint(i)}redrawRegions(e){if(0===e.length)return;const t=o.HexGroup.union(e.map((e=>e.hexes)));this.redrawHexes(e[0].state,t)}}t.GreenRenderer=r},69938:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GroundRenderer=void 0;const s=i(32801),n=i(89242);class a extends s.FactionBasedIsoRenderer{constructor(e){super(e.scene,e,n.IsoTileRecipes.Ground)}redrawFaction(e){e.id>0&&super.redrawFaction(e)}shouldIncludeHex(e,t){return!e.isNeutral()}postProcess(e,t){t.setTint(e?.landColor)}}t.GroundRenderer=a},80437:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PalisadeRenderer=void 0;const s=i(32801),n=i(89403),a=i(89242),o=i(85044),r=i(98697);class c extends s.FactionBasedIsoRenderer{constructor(e){super(e.scene,e,a.IsoTileRecipes.Palisade)}shouldRun(e){return!!(0,o.getParentEngine)(e).isDataSetActive(r.GameState.warfare.hexStaticDefense)}shouldIncludeHex(e,t){return n.Warfare.getHexStaticDefense(e.state,t)>0}redrawHexes(e,t){const i=t.with(...t.neighbours().members);super.redrawHexes(e,i)}}t.PalisadeRenderer=c},88755:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConquerableHexesHighlight=t.DEFAULT_TINT=void 0;const s=i(35171),n=i(62199),a=i(13872),o=i(99044),r=i(73508),c=i(17225),l=i(10445),d=i(71203),h=i(92536),u=n.logger.for("ConquerableHexesHighlight");t.DEFAULT_TINT=l.Colors.highlight.ownedRegion,t.ConquerableHexesHighlight=class{constructor(e,t){this.scene=e,this.objectPool=t,this.indicatorsByHex={},this.tweener=new h.Tweener(this.scene),this.activeHexes=s.HexGroup.empty,this.tint=l.Colors.highlight.ownedRegion,this.alpha=1,this.indicators=this.scene.add.group({defaultKey:"atlas",defaultFrame:"hex-move-indicator",createCallback:e=>{e.setName("indicator"+this.indicators.getLength())}}).setDepth(o.WorldLayers.TileHighlight),this.pawnGhost=this.objectPool.getPawnImage(r.PawnType.Villager).setDepth(o.WorldLayers.FlyingObject).setAlpha(.7).setVisible(!1),this.scene.add.existing(this.pawnGhost)}clear(){this.removeIndicators(Object.keys(this.indicatorsByHex).map((e=>Number(e)))),this.activeHexes=s.HexGroup.empty}set(e,i=t.DEFAULT_TINT,s=1){const n=Object.entries(this.indicatorsByHex).filter((([t,i])=>!e.containsId(Number(t)))).map((([e,t])=>Number(e)));this.removeIndicators(n),this.tint==i&&this.alpha===s||(this.tint=i,this.alpha=s,this._updateTintAndAlpha()),this.add(e,i,s)}_updateTintAndAlpha(){for(let e of Object.values(this.indicatorsByHex))e.setTint(this.tint).setAlpha(this.alpha)}add(e,i=t.DEFAULT_TINT,s=1){const n=[];this.tint=i,this.alpha=s,e.map((e=>{const t=this.indicatorsByHex[e.id]||this.indicators.get(e.display.centerX,e.display.centerY,void 0,void 0,!1).setVisible(!0).setActive(!0).setDepth(o.WorldLayers.TileHighlight);return t.setTint(this.tint).setAlpha(this.alpha),this.indicatorsByHex[e.id]||(this.indicatorsByHex[e.id]=t,n.push(t)),t})),this.tweener.add({targets:n,scale:{from:.5,to:1},alpha:{from:0,to:s},duration:a.TIMING.pawnPickupTransition,ease:"Sine.easeOut"})}setHighlightedHex(e,t){const i=this.indicatorsByHex[e.id];i?this.highlightedIndicator!==i&&(this.clearHighlightedHex(),this.highlightedIndicator=i,this.highlightedIndicator?.setFrame("hex-move-indicator-hover"),this.highlightedIndicator?.setScale(.75),this.highlightedIndicatorTween=this.tweener.add({targets:i,scale:1,duration:200,ease:"Sine.easeInOut"}),t?this.pawnGhost.setPosition(e.display.centerX,e.display.centerY-10).setFrame((0,c.getFrameForPawnType)(t)).setVisible(!0):this.pawnGhost.setVisible(!1)):u.warning(`ignoring attempt to highlight conquest indicator on hex ${e.id}, which does not currently display conquest indicator`)}clearHighlightedHex(){if(this.highlightedIndicator){const e=this.highlightedIndicator;this.tweener.add({targets:e,scale:.75,duration:100,onComplete:()=>{e.setFrame("hex-move-indicator"),e.setScale(1)},onStop:()=>{e.setFrame("hex-move-indicator")}}),this.highlightedIndicatorTween?.stop(),this.highlightedIndicator=void 0,this.pawnGhost.setVisible(!1)}}show(){this.indicators.children.each((e=>e.setVisible(e.active)))}hide(){this.indicators.setVisible(!1)}removeIndicators(e){if(0===e.length)return;const t=e.map((e=>this.indicatorsByHex[e]));this.highlightedIndicator&&t.includes(this.highlightedIndicator)&&this.clearHighlightedHex(),this.tweener.add({targets:t,scale:{from:1,to:.5},alpha:{from:this.alpha,to:0},duration:d.inject.ui.skipTransitions()?0:a.TIMING.pawnPickupTransition,ease:"Sine.easeIn",onComplete:()=>{t.forEach((e=>{this.indicators.killAndHide(e)}))}}),e.forEach((e=>delete this.indicatorsByHex[e]))}}},7937:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deriveDefenseMarkerDataFromModel=t.HexDefenseMarkers=t.HexMarker=void 0;const s=i(35171),n=i(62199),a=i(13872),o=i(99044),r=i(71203),c=i(92940),l=i(19764),d=i(52163),h=i(23803);var u;n.logger.for("HexDefenseHighlight"),(u=t.HexMarker||(t.HexMarker={})).Circle="circle",u.Defense1="defense-1",u.Defense2="defense-2",u.Defense3="defense-3",u.Defense4="defense-4",t.HexDefenseMarkers=class{constructor(e){this.scene=e,this.shapesByHex={},this.hovered={hex:void 0,defenseAuraStrength:0,defenseAuraHexes:s.HexGroup.empty},this.shapes=this.scene.add.group({defaultKey:"atlas",defaultFrame:"hex-markers/defense-1"}).setDepth(o.WorldLayers.TileHighlight)}clear(){this.removeShapes(Object.keys(this.shapesByHex).map((e=>Number(e))))}set(e){this.config=e;const t=Object.entries(this.shapesByHex).filter((([t,i])=>0===e.get(Number(t)).defense)).map((([e,t])=>Number(e)));(0,h.getHexes)(e.getHexIds()).without(this.hovered.hex||s.HexGroup.empty).without(this.hovered.defenseAuraHexes).map((e=>{d.assert.defined(e);const t=this.config.get(e.id),i=this.setShapeOnHex(e,"defense-"+t.defense);return this.shapesByHex[e.id]||(this.shapesByHex[e.id]=i,this.scene.tweens.add({targets:i,x:{from:t.origin.display.centerX,to:e.display.centerX},y:{from:t.origin.display.centerY,to:e.display.centerY},scale:{from:.5,to:1},alpha:{from:0,to:1},duration:a.TIMING.pawnPickupTransition,ease:"Sine.easeOut"})),i})).filter((e=>!!e)),this.removeShapes(t)}setShapeOnHex(e,t){const i=this.shapesByHex[e.id]||this.shapes.get(e.display.centerX,e.display.centerY,void 0,void 0,!1).setVisible(!0).setActive(!0).setDepth(o.WorldLayers.TileHighlight);return i.setFrame("hex-markers/"+t).setAlpha(1).setScale(1),i}setHoveredHex(e,t,i){this.clearHoveredHex(),this.hovered.hex=e,this.hovered.defenseAuraHexes=i,this.hovered.defenseAuraStrength=t,this.shapesByHex[e.id]=this.setShapeOnHex(e,"circle"),this.hovered.defenseAuraHexes.forEach((e=>{const i=this.config.get(e.id).defense;t>i&&(this.shapesByHex[e.id]=this.setShapeOnHex(e,"defense-"+t))}))}clearHoveredHex(){this.hovered.hex&&(s.HexGroup.union([this.hovered.hex,this.hovered.defenseAuraHexes]).forEach((e=>{const t=this.config.get(e.id).defense;t>0?this.shapesByHex[e.id]=this.setShapeOnHex(e,"defense-"+t):(this.shapes.killAndHide(this.shapesByHex[e.id]),delete this.shapesByHex[e.id])})),this.hovered.hex=void 0,this.hovered.defenseAuraStrength=0,this.hovered.defenseAuraHexes=s.HexGroup.empty)}removeShapes(e){const t=e.map((e=>this.shapesByHex[e]));this.scene.tweens.add({targets:t,scale:{from:1,to:.5},alpha:{from:1,to:0},duration:a.TIMING.pawnPickupTransition,ease:"Sine.easeIn",onComplete:()=>{t.forEach((e=>{this.shapes.killAndHide(e)}))}}),e.forEach((e=>delete this.shapesByHex[e]))}},t.deriveDefenseMarkerDataFromModel=function(e,t){const i=r.inject.gameStateModel,s=e.hexes,n=new l.CustomHexGroupValuation({defense:0});return i.pawns.select({hexes:s,traits:[c.PawnTraits.GuardsAdjacentTiles]}).filter((e=>e!==t)).forEach((e=>{s.neighboursOf(e.hex).filter((e=>!i.warfare.isOccupied(e))).forEach((t=>{const i=n.get(t.id);e.defense>i.defense&&n.set(t.id,{defense:e.defense,origin:e.hex})}))})),n}},81281:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LandmassRenderer=void 0;const s=i(95794),n=i(35171),a=i(89242);t.LandmassRenderer=class{constructor(e){this.renderer=e,this.landmass=new s.IsoTileGroup(this.renderer,a.IsoTileRecipes.Landmass,this.postProcess)}syncWithModel(e,t){this.clear();const i=n.HexGroup.union(e.regions.all().map((e=>e.hexes)));this.landmass.addHexes(i),this.landmass.update()}postProcess(e){}clear(){this.landmass.clear()}}},52584:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnBacklight=void 0;const s=i(99044),n=i(62199);var a=Phaser.GameObjects.Sprite;n.logger.for("PawnBacklight"),t.PawnBacklight=class extends a{constructor(e,t){super(e,0,0,"atlas","pawn-backlight"),this.baseWidth=t,this.setOrigin(.5,1),this.setTint(65280),this.setDepth(s.WorldLayers.UIOverlay),this.setDisplaySize(t,128),this.baseScaleX=this.scaleX,this.baseScaleY=this.scaleY,this.pulseTween=this.scene.add.tween({targets:this,scaleY:{from:.9*this.baseScaleY,to:this.baseScaleY},alpha:{from:.7,to:1},duration:1e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut",paused:!0}),this.animateIn()}setBaseWidth(e){this.baseWidth=e,this.setDisplaySize(this.baseWidth,128)}animateIn(){this.scene.tweens.add({targets:this,scaleX:{from:0,to:this.baseScaleX},scaleY:{from:.5,to:this.baseScaleY},alpha:{from:0,to:.7},ease:"Sine.easeOut",duration:300,onComplete:()=>this.pulseTween.play()})}destroy(){this.scene.tweens.add({targets:this,width:0,height:this.height/2,alpha:0,duration:300,onComplete:()=>{this.pulseTween.stop(),super.destroy()}})}}},7703:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnBacklightManager=void 0;const s=i(93080),n=i(52584);class a extends s.TileAttachmentsManager{constructor(e,t,i){super("PawnBacklightManager",e,t),this.pawns=i}createObject(e,t){const i=this.pawns.getByHex(e.id),s=t.width??i.image.displayWidth??18;return new n.PawnBacklight(this.scene,s).setTint(t.color)}updateObject(e,t,i){const s=this.pawns.getByHex(t.id);e.setBaseWidth(i.width??s.image.displayWidth??18),e.setTint(i.color)}}t.PawnBacklightManager=a},34594:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PawnSymbolsManager=t.PawnSymbolType=void 0;const n=i(62199),a=s(i(54485)),o=i(73735);var r;(r=t.PawnSymbolType||(t.PawnSymbolType={})).Arrow="0-arrow",r.Plus="1-plus",r.Alert="2-alert",r.CrossedCoin="3-crossed-coin";const c=n.logger.for("TileSymbols"),l=(e,t)=>e.type.localeCompare(t.type);t.PawnSymbolsManager=class{constructor(e){this.pawns=e,this.symbolsByPawn=new Map}clear(e){const t=[];for(let[i,s]of this.symbolsByPawn.entries()){const s=this.pawns.getById(i);!s||s.isDestroyed()?t.push(i):this.remove(i,e)}for(let e of t)this.symbolsByPawn.delete(e)}add(e,t,i){let s=this.symbolsByPawn.get(e),n=s?.find((e=>e.type===t));s?n?n.message=i:(s.push({type:t,message:i}),s.sort(l)):(new a.default(l),this.symbolsByPawn.set(e,[{type:t,message:i}])),n||this.updateSymbolImage(e)}remove(e,t){const i=this.symbolsByPawn.get(e),s=i?.find((e=>e.type===t));i&&s&&((0,o.removeFromArrayInPlace)(i,s),this.updateSymbolImage(e))}getCurrentSymbol(e){return this.symbolsByPawn.get(e)?.[0]}updateSymbolImage(e){const t=this.getCurrentSymbol(e),i=this.pawns.getById(e);t?i?i.setSymbol(t.type):c.warning(`Failed to update symbol image to ${t} for pawn ${e}: no pawn sprite located`):i?.removeSymbol()}has(e,t){return!!this.symbolsByPawn.get(e)?.find((e=>e.type===t))}}},62461:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SelectedRegionHighlight=t.HighlightStyle=void 0;const s=i(62199),n=i(89242),a=i(95794),o=i(10445);var r;s.logger.for("SelectedRegionHighlight"),function(e){e.Gold="gold",e.Muted="muted"}(r=t.HighlightStyle||(t.HighlightStyle={})),r.Gold,r.Muted,t.SelectedRegionHighlight=class{constructor(e){this.renderer=e,this.tileGroup=new a.IsoTileGroup(this.renderer,n.IsoTileRecipes.Highlight,(e=>{e.setTint(this.color)})),this.color=o.Colors.highlight.ownedRegion}getHexes(e){return e.hexes}clear(){this.tileGroup.clear(),this.selectedRegion=void 0}setColor(e){e!==this.color&&(this.clear(),this.color=e)}set(e,t){t&&this.setColor(t),this.selectedRegion=e,this.tileGroup.setHexes(this.selectedRegion.hexes)}setHexes(e,t){t&&this.setColor(t),this.selectedRegion=void 0,this.tileGroup.setHexes(e)}refresh(){this.selectedRegion?this.tileGroup.setHexes(this.selectedRegion.hexes):this.tileGroup.clear()}}},56058:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tile=void 0;var s=Phaser.GameObjects.Container;const n=i(26792),a=i(99044),o=i(105);function r(e){let t="(unknown)";return t=e instanceof s?e.constructor.name:e.frame.name,`\n- ${t}(#${(0,o.getObjId)(e)} V:${e.visible?1:0} A:${e.alpha.toFixed(1)})`}t.Tile=class{constructor(e,t,i=0){this.renderer=e,this.hex=t,this.frame=i,this.attachedObjects=new Set,this.decals=new Set,this.active=!0}get baseDepth(){return a.WorldLayers.Tiles+this.bottom}get bottom(){return this.hex.y*n.HEX_INNER_HEIGHT+n.HEX_HEIGHT}get centerX(){return(this.hex.x+.5)*n.HEX_WIDTH}get centerY(){return this.hex.y*n.HEX_INNER_HEIGHT+.5*n.HEX_HEIGHT}addObject(e,t,i){this.attachedObjects.add(e),this.renderer.add(this.hex,e),e.setPosition(this.centerX+t,this.centerY+i).setDepth(a.WorldLayers.TileObjects+this.bottom-n.HEX_HEIGHT/2+i)}addDecal(e,t,i){e.setOrigin(.5,.5),this.decals.add(e),this.renderer.add(this.hex,e).setDepth(a.WorldLayers.TileDecals),e.setPosition(this.centerX+t,this.centerY+i)}removeObject(e){this.attachedObjects.delete(e),this.renderer.remove(this.hex,e)}activate(e){this.active||[...this.decals,...this.attachedObjects].forEach((e=>this.renderer.add(this.hex,e))),this.active=!0,e.isNeutral()?this.decals.forEach((e=>e.setVisible(!1))):this.decals.forEach((t=>{t.setVisible(!0),t.setTint(e.landColor)}))}deactivate(){this.active=!1,this.attachedObjects.forEach((e=>e.setVisible(!1))),[...this.decals,...this.attachedObjects].forEach((e=>this.renderer.remove(this.hex,e)))}toString(){return`[Tile #${this.hex.id}]`}getDebugData(){return`[Tile #${this.hex.id}]\nactive: ${this.active}\nattachedObjects:${Array.from(this.attachedObjects).map(r).join("")}\ndecals:${Array.from(this.decals).map(r)}\n`}}},93080:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TileAttachmentsManager=void 0;const s=i(23803),n=i(62199).logger.for("TileAttachmentsManager");t.TileAttachmentsManager=class{constructor(e,t,i){this.name=e,this.renderer=t,this.tiles=i,this.objectsByHex={},this.scene=this.renderer.scene}add(e,t){if(this.objectsByHex[e.id])this.updateObject(this.objectsByHex[e.id],e,t);else{const i=this.tiles.getByHex(e.id);if(!i)return void n.warning(`[${this.name}] cannot attach flag to hex ${e} - no such tile found`);const s=this.createObject(e,t);this.objectsByHex[e.id]=s,this.attachToTile(s,i)}}set(e,t){this.clear();for(let i of e.members)this.add(i,t)}attachToTile(e,t){t.addObject(e,0,0)}remove(e){this.objectsByHex[e.id]&&this.doRemoveObject(e,this.objectsByHex[e.id])}clear(){Object.entries(this.objectsByHex).forEach((([e,t])=>{this.doRemoveObject((0,s.getHex)(Number(e)),t)})),this.objectsByHex={}}destroyObject(e,t){t.destroy()}doRemoveObject(e,t){this.tiles.getByHex(e.id).removeObject(t),delete this.objectsByHex[e.id],this.destroyObject(e,t)}}},26792:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HEX_POLYGON=t.HEX_COLLAR_HEIGHT=t.HEX_ANGLED_HEIGHT=t.HEX_INNER_HEIGHT=t.HALF_HEX_HEIGHT=t.HEX_HEIGHT=t.HALF_HEX_WIDTH=t.HEX_WIDTH=void 0,t.HEX_WIDTH=48,t.HALF_HEX_WIDTH=t.HEX_WIDTH/2,t.HEX_HEIGHT=48,t.HALF_HEX_HEIGHT=t.HEX_HEIGHT/2,t.HEX_INNER_HEIGHT=36,t.HEX_ANGLED_HEIGHT=t.HEX_HEIGHT-t.HEX_INNER_HEIGHT,t.HEX_COLLAR_HEIGHT=30,t.HEX_POLYGON=[[-.5,-.25],[0,-.5],[.5,-.25],[.5,.25],[0,.5],[-.5,.25]].map((([e,t])=>[e+.5,t+.5])).map((([e,i])=>({x:e*t.HEX_WIDTH,y:i*t.HEX_HEIGHT})))},11406:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bgrSwap=t.TilesManager=void 0;const s=i(62199),n=i(56058),a=i(71203);var o=Phaser.GameObjects.Image;const r=s.logger.for("TilesManager");t.TilesManager=class{constructor(e,t){this.scene=e,this.renderer=t,this.cinematics={},this.tilesByHexId={}}setTile(e,t){this.createOrUpdateTile(e,t)}syncWithModel(e,t,i=!1){i&&Object.entries(this.tilesByHexId).filter((([e,i])=>i.active&&!t.containsId(Number(e)))).forEach((([e,t])=>t.deactivate()));for(const i of t.members){const t=e.factions.byHex(i);t&&this.setTile(i,t)}}getByHex(e){return this.tilesByHexId[e]}addObjectToTile(e,t,i=0,s=0){const n=this.tilesByHexId[e];n?n.addObject(t,i,s):r.error(`Unable to place ${t} on hex ${e}, hex not present in the current rendering. Ignoring.`)}getAll(){return Object.values(this.tilesByHexId).filter((e=>e.active))}clear(){Object.values(this.tilesByHexId).forEach((e=>e.deactivate()))}createOrUpdateTile(e,t){let i=this.tilesByHexId[e.id];if(i)i.activate(t);else{if(i=new n.Tile(this.renderer,e),a.inject.random.boolean(.75)){const e=a.inject.random.point(6);t.isNeutral()||i.addDecal(new o(this.renderer.scene,0,0,"atlas","hex-decals/grass").setTint(t.landColor).setFlipX(a.inject.random.boolean()),e.x,e.y)}this.tilesByHexId[e.id]=i}return i}},t.bgrSwap=e=>{const[t,i,s]=e.toString(16).padStart(6,"0").match(/[\w]{2}/g);return parseInt([s,i,t].join(""),16)}},86273:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Padding=void 0;const s=i(94459),n=i(71203),a={[s.UiVariant.Compact]:{large:14,medium:10},[s.UiVariant.Large]:{large:30,medium:20}};t.Padding={get large(){return a[n.inject.device.uiVariant()].large},get medium(){return a[n.inject.device.uiVariant()].medium}}},44976:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseScene=void 0;const s=i(71203),n=i(62199);class a extends Phaser.Scene{constructor(e){super(e),this._deferredHandlers=new Map,this._subs=[],this.log=n.logger.for(e.key||"BaseScene"),s.inject.config.watchFuture((e=>this.applyConfig(e)))}create(){this.events.on(Phaser.Scenes.Events.WAKE,(()=>{this.triggerDeferredHandlers()})),this.events.on(Phaser.Scenes.Events.SLEEP,(()=>{})),this.events.on(Phaser.Scenes.Events.SHUTDOWN,(()=>{})),this.events.on(Phaser.Scenes.Events.DESTROY,(()=>{})),this.events.on(Phaser.Scenes.Events.PRE_UPDATE,(()=>{this.preUpdate()}))}destroy(){this._subs.forEach((e=>e.unsubscribe()))}applyConfig(e){this.tweens.timeScale=e.debug.tweenSpeedFactor||1,this.time.timeScale=e.debug.tweenSpeedFactor||1,this.anims.globalTimeScale=e.debug.tweenSpeedFactor||1}addAll(e){for(let t of e)this.add.existing(t)}addImage(e,t="atlas"){return this.add.image(0,0,t,e)}preUpdate(){}triggerDeferredHandlers(){this._deferredHandlers.forEach((e=>e())),this._deferredHandlers.clear()}handleEventWhileActive(e,t){this._subs.push(s.inject.events.on(e,((e,i)=>{this.scene.isActive()&&t.apply(this,[e,i])})))}handleSignalWhileActive(e,t){this._subs.push(e(((...e)=>{this.scene.isActive()&&t.apply(this,e)})))}watchWhileActive(e,t){this._subs.push(e.watch(((i,s)=>{this.scene.isActive()?t.apply(this,[i,s]):this._deferredHandlers.set(e,(()=>t.apply(this,[i,s])))})))}bindKey(e,t){this.input.keyboard.addKey(e).on("down",(()=>{const e=t();e&&s.inject.events.trigger(e)}))}}t.BaseScene=a},9724:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseUIScene=void 0;const s=i(71203),n=i(62199),a=i(44976),o=i(84477),r=i(18995);class c extends a.BaseScene{constructor(e){super(e),this.log=n.logger.for(e.key||"BaseScene"),s.inject.config.watchFuture((e=>this.applyConfig(e)))}create(){super.create();const e=this.cameras.main;e.setZoom(s.inject.ui.scale()).setOrigin(0,0).setRoundPixels(!0),this.watchWhileActive(s.inject.ui.scale,(e=>{e!==this.cameras.main.zoom&&(this.cameras.main.setZoom(e).setOrigin(0,0).setRoundPixels(!0),this.preUpdate.makeDirty())})),this.bounds={get width(){return s.inject.device.screenWidth/e.zoom},get height(){return s.inject.device.screenHeight/e.zoom},get contentLeft(){return s.inject.device.contentLeft/e.zoom},get contentWidth(){return s.inject.device.contentWidth/e.zoom},get contentRight(){return s.inject.device.contentRight/e.zoom},get centerX(){return s.inject.device.screenWidth/e.zoom/2},get centerY(){return s.inject.device.screenHeight/e.zoom/2}},this.scale.on("resize",(()=>{this.preUpdate.makeDirty()})),this.input.on("pointerdown",((e,t)=>{this.closeCurrentTooltip()})),this.input.on("pointerover",((e,t)=>{t.length&&(e.wasTouch||t[0]!==this.currentTooltipTarget&&this.showTooltipFor(t[0],!1))})),this.input.on("pointerout",((e,t)=>{e.wasTouch||this.closeCurrentTooltip()})),this.handleEventWhileActive(r.UserActions.ToggleTooltip,(({object:e})=>{console.log("TOGGLE_TOOLTPI",e),this.toggleTooltipFor(e)}))}closeCurrentTooltip(){this.currentTooltip===s.inject.tooltips.activeTooltip&&(s.inject.tooltips.close(),this.currentTooltip=void 0,this.currentTooltipTarget=void 0)}showTooltipFor(e,t=!0){const i=this.getTooltipFor(e);i?(this.currentTooltip=s.inject.tooltips.showOver(e,i&&{...i,delayMs:t?0:void 0,type:o.TooltipType.Hover}),this.currentTooltipTarget=e):s.inject.tooltips.close()}toggleTooltipFor(e){this.currentTooltipTarget===e&&this.currentTooltip?.visible?this.closeCurrentTooltip():this.showTooltipFor(e,!0)}getTooltipFor(e){const t=e.getData("tooltip");return"string"==typeof t?{title:t}:void 0}}t.BaseUIScene=c},50937:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugHistoryScene=void 0;const s=i(82260),n=i(84612),a=i(71203),o=i(1157);class r extends s.Scene{constructor(){super({key:n.Scenes.DebugHistory,pixelArt:!1}),this.currentIndex=0}create(){this.controller=a.inject.gameStateController,this.historyLabel=new o.DebugTextBox(this,10,40,"Frames:",{dropShadow:!1,origin:[0,1]});const e=this.input.keyboard.addKey(s.Input.Keyboard.KeyCodes.ESC),t=this.input.keyboard.createCursorKeys();e.on("down",(e=>{a.inject.navigator.goTo(a.inject.screen.play)})),t.down.on("down",(e=>{this.goToNextFrame()})),t.up.on("down",(()=>{this.goToPreviousFrame()}))}goToNextFrame(){this.currentIndex!==a.inject.history.length()&&(this.currentIndex++,this.currentIndex===a.inject.history.length()?this.loadState(this.suspendedCurrentState):this.loadState(a.inject.history.get(this.currentIndex).state))}goToPreviousFrame(){0!==this.currentIndex&&(this.currentIndex===a.inject.history.length()&&(this.suspendedCurrentState=a.inject.gameStateModel.state),this.currentIndex--,this.loadState(a.inject.history.get(this.currentIndex).state))}loadState(e){a.inject.gameStateModel.restore(e),a.inject.scene.worldMap.setSelectedRegion(void 0),a.inject.scene.worldMap.conquerableHexesHighlight.clear(),a.inject.scene.worldMap.syncState(e)}resetCursor(){this.currentIndex=a.inject.history.length()}update(){const e=[...a.inject.history.getAll(),{label:"(CURRENT STATE)",state:a.inject.gameStateModel.state}];this.currentIndex>e.length&&(this.currentIndex=e.length-1);const t=e.map(((e,t)=>(this.currentIndex===t?"->":"  ")+e.label)).join("\n");this.historyLabel.setText(t),this.historyLabel.setPosition(10,this.cameras.main.displayHeight-10)}}t.DebugHistoryScene=r},36205:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugScene=void 0;const s=i(84612),n=i(71203),a=i(5538),o=i(85044),r=i(98697),c=i(1157),l=i(73508),d=i(93122),h=i(9724),u=i(48565);class g extends h.BaseUIScene{constructor(){super({key:s.Scenes.Debug,pixelArt:!1}),this.suppressBreakPoints=!1,this.preUpdate=(0,u.whenDirty)((()=>{}))}create(){super.create(),console.warn("DEBUG SCENE CREATE"),this.cameras.main.setOrigin(0,0),this.debugData=n.inject.debugData,this.controller=n.inject.gameStateController,this.cursorPosLabel=new c.DebugTextBox(this,100,100,"(left, top)",{padding:10}),this.topLeftLabel=new c.DebugTextBox(this,10,30,"[left, top] - [left,top]",{dropShadow:!1,padding:10}),this.cursorPosLabel.setVisible(!1),this.pointer=this.input.activePointer,this.horizontalGuideLine=this.add.line(0,0,1,1).setOrigin(0,0).setStrokeStyle(1,255,.25),this.verticalGuideLine=this.add.line(0,0,1,1).setOrigin(0,0).setStrokeStyle(1,255,.25),this.breakpointLabel=this.add.text(0,0,"",{fontFamily:'"Monospace"',color:"#0000ff",fontSize:"24px"}).setVisible(!1).setOrigin(.5);const e=this.input.keyboard.addKey("N"),t=this.input.keyboard.addKey("C");e.on("down",(e=>{this.resumeFromBreakpoint()})),t.on("down",(e=>{this.suppressBreakPoints=!0,this.resumeFromBreakpoint(),setTimeout((()=>this.suppressBreakPoints=!1),3e3)})),n.inject.ui.hexUnderCursor.watch((e=>{if(e){const t=this.scene.get(s.Scenes.WorldMap).chunkedRenderer.getByHex(e);this.debugData.set("hexInfo",function(e,t){try{const i=n.inject.gameStateModel,d=n.inject.game.scene.getScene(s.Scenes.WorldMap),h=i.regions.byHex(e),u=i.factions.byHex(e),g=i.currentPhase.faction,m=h?`\n⚐ ${h.name||"region"} #${h.id} ${function(e){const t=n.inject.gameStateModel;if(!(0,o.isDataSetActive)(t.state,r.GameState.economy.budgetByRegion))return"";const i=t.economy.budgetOf(e);return`(${e.hexes.length}${c.GLYPH.hex} ${t.economy.treasuryOf(e)}${(0,a.withSign)(i.balance)}=${t.economy.treasuryOf(e)+t.economy.budgetOf(e).balance}${c.GLYPH.coin})`}(h)}`:"",y=u?`\n owned by ${u}`:"",f=i.pawns.byHex(e).map(p).join("\n♖ "),w=f.length?"\n♖ "+f:"";let b=n.inject.config.debug.gameObjects&&d.tiles.getByHex(e.id)?.getDebugData()||"";b&&(b="\n"+b);let v="";return n.inject.debugLayers.activeLayerName&&(v=`\n${n.inject.debugLayers.activeLayerName}:\n  ${n.inject.debugLayers.activeLayer.getDetail(e)?.replace(/\n/g,"\n  ")}`),i.pawns.presentAtHex(e,l.PawnType.Town)&&u&&g&&(v+=`\nFaction ${u.id}:\n  Attitude: ${u.attitudeTowards(g)} (F: ${u.fearOf(g)} A: ${u.approvalOf(g)})`),`${e}[chunk #${t}]${m}${y}${w}${v}${b}`}catch(e){return`⛔ ${e.toString()}`}}(e,t.id))}else this.debugData.clear("hexInfo")}))}resumeFromBreakpoint(){this.resumeFromBreakpointCallback&&(this.resumeFromBreakpointCallback(),this.resumeFromBreakpointCallback=void 0,this.breakpointLabel.setVisible(!1))}update(){const e=this.scene.get(s.Scenes.WorldMap);e&&this.pointer.updateWorldPoint(e.cameras.main),this.cursorPosLabel.setText(`C(${Math.round(this.pointer.x)},${Math.round(this.pointer.y)}) W(${Math.round(this.pointer.worldX)},${Math.round(this.pointer.worldY)})\n${this.debugData.get("hexInfo")||""}`);const t=this.cameras.main;this.topLeftLabel.setText(`v2.0.19-build-2727693328 ${t.width}x${t.height} DPR=${n.inject.device.dpr} (real=${window.devicePixelRatio||1}), variant=${n.inject.device.uiVariant()} ${Math.floor(this.game.loop.actualFps)} FPS\n${function(e){if(n.inject.config.debug.dataFilter&&!"scenes".includes(n.inject.config.debug.dataFilter))return"";return["scenes:          state    DL  UL  TW A V",...e.map((e=>(0,d.padRight)("-"+e.scene.key,16)+" "+(0,d.padRight)(m[e.sys.settings.status],8)+(0,d.padLeft)(e.sys.displayList.length.toString(),3)+" "+(0,d.padLeft)(e.sys.updateList.length.toString(),3)+" "+(0,d.padLeft)(e.tweens.getAllTweens().length.toString(),3)+" "+(e.sys.isActive()?"* ":"  ")+(e.sys.isVisible()?"* ":"  ")))].join("\n")}(this.game.scene.getScenes(!0))}\n${function(){if(n.inject.config.debug.dataFilter&&!"level".includes(n.inject.config.debug.dataFilter))return"";if(!n.inject.currentGameState)return"level: N/A";const e=n.inject.gameStateModel.map,t=n.inject.gameStateModel.currentPhase;return`level: ${e.levelId} ${e.width}x${e.height} turn ${t.turnNumber} (${t.type} ${t.faction?.id??""})`}()}\n${n.inject.debugData.getText()}`),0===this.pointer.x&&0===this.pointer.y||(this.cursorPosLabel.setPosition((this.pointer.x+20)/n.inject.ui.scale(),(this.pointer.y+20)/n.inject.ui.scale()),this.cursorPosLabel.setVisible(!0)),this.horizontalGuideLine.setTo(0,this.pointer.y,this.cameras.main.width,this.pointer.y),this.verticalGuideLine.setTo(this.pointer.x,0,this.pointer.x,this.cameras.main.height)}async handleBreakpoint(e,t){const i=n.inject.scene.worldMap;if(!this.suppressBreakPoints)return new Promise((s=>{i.setSelectedRegion(t.region),t.hexes?i.conquerableHexesHighlight.set(t.hexes):i.conquerableHexesHighlight.clear();let a=n.inject.debugLayers.activeLayerName;t.debugLayer&&("string"==typeof t.debugLayer?n.inject.debugLayers.activate(t.debugLayer):n.inject.debugLayers.registerAndActivate("breakpointDebugLayer",t.debugLayer)),this.resumeFromBreakpointCallback=()=>{i.setSelectedRegion(void 0),i.conquerableHexesHighlight.clear(),t.debugLayer&&n.inject.debugLayers.activate(a),s()},this.breakpointLabel.setVisible(!0),this.breakpointLabel.setText("⏸️ "+e+"\n [N] step [C] continue"),this.breakpointLabel.setPosition(this.cameras.main.centerX,this.cameras.main.height-100)}))}}function p(e){const t=n.inject.scene.worldMap.pawns.getById(e.id);return`${e.type}${1!==e.count?` x${e.count}`:""} #${e.id} ${e.isMovable()?"(M)":""} (${t?.mode??"-"}${t?.hanging?":h":""}${t?.jumping?":j":""})`}t.DebugScene=g;const m={0:"pending",1:"init",2:"start",3:"loading",4:"creating",5:"running",6:"paused",7:"sleeping",8:"shutdown",9:"destroyed"}},52700:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MenuHeaderUIScene=void 0;const s=i(84612),n=i(10445),a=i(48565),o=i(71203),r=i(1157),c=i(18995),l=i(94459),d=i(9724),h=i(61720),u=i(77949),g=i(44031);var p=Phaser.GameObjects.Rectangle,m=Phaser.GameObjects.BitmapText,y=Phaser.GameObjects.Image;const f={[l.UiVariant.Compact]:{panelHeight:64,backButtonWidth:100},[l.UiVariant.Large]:{panelHeight:128,backButtonWidth:180,titleLineOffset:-14}};class w extends d.BaseUIScene{constructor(){super({key:s.Scenes.MenuHeaderUI}),this.state=(0,h.StateContainer)(this,{title:"",icon:null}),this.preUpdate=(0,a.whenDirty)((()=>{this.cameras.main.y=0;const e=this.bounds.width,t=(this.bounds.height,w.Layout);if(this.cameras.main.setSize(o.inject.device.screenWidth,o.inject.device.screenHeight),this.background.setPosition(0,0),this.background.setSize(e,t.panelHeight),this.backButton.width=t.backButtonWidth,this.icon.setVisible(!!this.state().icon),o.inject.device.uiVariant()===l.UiVariant.Large)this.backButtonText.setText(this.state().backButtonTitle??"BACK"),g.Arrange.horizontally({content:[{object:this.icon},{object:this.titleText}],x:this.bounds.contentLeft+l.DEFAULT_CONTENT_PADDING,spacing:6,origin:0}),g.Arrange.alignHorizontally([this.icon,this.titleText],{y:this.background.height/2-14,origin:.5}),this.backButton.setPosition(this.bounds.contentLeft+l.DEFAULT_CONTENT_PADDING,t.panelHeight/2+14);else{this.backButtonText.setText("BACK"),g.Arrange.horizontally({content:[{object:this.icon},{object:this.titleText}],x:this.bounds.centerX,spacing:6,origin:.5}),g.Arrange.alignHorizontally([this.backButton,this.icon,this.titleText],{y:this.background.height/2,origin:.5}),this.backButton.x=this.bounds.contentLeft+14;const e=this.backButton.x+this.backButton.width+6;e>this.icon.x&&(this.icon.x=e,this.titleText.x=this.icon.x+this.icon.width+6)}}))}static get Layout(){return f[o.inject.device.uiVariant()]}create(){super.create(),this.scale.on("resize",(()=>this.preUpdate.makeDirty())),this.background=new p(this,0,0,0,0,n.Colors.glassUi.shape),this.backButtonText=new m(this,0,0,r.BitmapFont.Small,"BACK").setTint(n.Colors.woodenUi.primaryText),this.backButton=new u.RibbonButton(this,0,0,{icon:new y(this,0,0,"atlas","ui/mini-icons/back").setTint(n.Colors.woodenUi.primaryText),type:u.RibbonButtonStyle.Small,width:180,content:this.backButtonText}),this.icon=new y(this,0,0,"atlas").setOrigin(0,0),this.titleText=new m(this,0,0,r.BitmapFont.Main,"?").setOrigin(0,0).setTint(n.Colors.glassUi.primaryText),this.backButton.onClicked((()=>o.inject.events.trigger(c.UserActions.GoBack()))),this.addAll([this.background,this.icon,this.titleText,this.backButton])}applyState(e,t,i){e.title&&this.titleText.setText(e.title),e.backButtonTitle&&o.inject.device.uiVariant()===l.UiVariant.Large&&this.backButtonText.setText(e.backButtonTitle),void 0!==e.icon&&(e.icon&&this.icon.setFrame(e.icon),this.preUpdate.makeDirty())}slideOut(){this.tweens.add({targets:this.cameras.main,props:{y:-this.background.height*o.inject.ui.scale()},duration:o.inject.config.screenTransitionDuration,ease:"Sine.easeOut"})}slideIn(){this.tweens.add({targets:this.cameras.main,props:{y:0},duration:o.inject.config.screenTransitionDuration,ease:"Sine.easeOut"})}getTooltipFor(e){return e===this.backButton?{title:"Go back to the previous screen"}:super.getTooltipFor(e)}}t.MenuHeaderUIScene=w},46499:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalWindowScene=void 0;const s=i(84612),n=i(71203),a=i(88698),o=i(9724),r=i(48565),c=i(16705);var l=Phaser.GameObjects.Rectangle;class d extends o.BaseUIScene{constructor(){super({key:s.Scenes.ModalWindow}),this.debugLayer=new a.UiDebugLayer(this),this.modalsStack=[],this.preUpdate=(0,r.whenDirty)((()=>{this.window.setPosition(this.cameras.main.width/2,this.cameras.main.height/2),console.log("THIS.BOUNDS",this.bounds),this.backgroundOverlay.setSize(this.bounds.width,this.bounds.height),this.debugLayer.clear(),n.inject.config.debug.uiLayout&&(this.debugLayer.addHorizontalLine(this.cameras.main.height/2),this.debugLayer.addVerticalLine(this.cameras.main.width/2))}))}pushModal(e,t){const i={uiProvider:e,props:t};n.inject.navigator.currentScreen?.pause(),this.modalsStack.push(i),this.doShowModal(i),this.updateDebugData()}updateDebugData(){this.modalsStack.length?n.inject.debugData.set("modalWindow",this.modalsStack.map((e=>e.uiProvider.constructor.name)).join(" > ")):n.inject.debugData.clear("modalWindow")}doShowModal({uiProvider:e,props:t}){const i=e.getContent(this,{...t,onClose:e=>{this.closeModal(),t.onClose(e)}});this.window.setProps({title:e.getTitle(t),content:i}),this.preUpdate(),this.fadeIn()}fadeIn(){this.window.animateIn(),this.add.tween({targets:this.backgroundOverlay,alpha:1,ease:"Sine.easeOut",duration:400})}fadeOut(e){this.window.animateOut(),this.add.tween({targets:this.backgroundOverlay,alpha:{from:1,to:0},ease:"Sine.easeOut",duration:400,onComplete:e})}closeModal(){this.modalsStack.pop();const e=this.modalsStack[this.modalsStack.length-1];e?this.doShowModal(e):(n.inject.navigator.currentScreen?.resume(),this.fadeOut((()=>{0===this.modalsStack.length&&this.scene.sleep()}))),this.updateDebugData()}create(){if(super.create(),this.cameras.main.roundPixels=!0,this.window)throw new Error("Attempt to create ModalWindowScene for a second time");this.window=new c.ModalWindow(this,{title:""}),this.backgroundOverlay=new l(this,0,0,0,0,0,.5),this.addAll([this.backgroundOverlay,this.window])}}t.ModalWindowScene=d},79294:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PreloadScene=void 0;const s=i(84612),n=i(71203),a=i(18995),o=i(82260),r=i(51897),c=i(42574);class l extends o.Scene{constructor(){super({key:s.Scenes.Preload})}preload(){}update(){}create(){this.load.spritesheet("coin","assets/img/coin-animated.png",{frameWidth:20,frameHeight:18}),this.load.spritesheet("coin-hd","assets/img/coin-animated-hd.png",{frameWidth:20,frameHeight:18}),this.load.spritesheet("flag","assets/img/flag-animated.png",{frameWidth:12,frameHeight:11}),this.load.multiatlas("atlas","assets/atlas.json","assets"),this.load.bitmapFont("debug","assets/fonts/debug.png","assets/fonts/debug.xml"),n.inject.audio.load(this),n.inject.fonts.load(this),this.game.renderer.type!==Phaser.CANVAS?(this.load.once(Phaser.Loader.Events.COMPLETE,(()=>{r.ErrorTracking.gameRunning=!0,setLoadingStatus(""),document.getElementById("loader")?.remove(),c.NewsBox.show(),n.inject.events.trigger(a.SystemEvents.EngineInitialized()),this.scene.stop()})),window.document.getElementById("phaser-game")?.classList?.remove("hidden"),this.load.start()):setLoadingStatus("Your browser/device does not seem to support WebGL, which is required to run this game. Sorry!")}}t.PreloadScene=l},84612:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.Scenes=void 0,(i=t.Scenes||(t.Scenes={})).Play="Play",i.Debug="Debug",i.DebugHistory="DebugHistory",i.WorldMap="WorldMap",i.Preload="Preload",i.MapEditor="MapEditor",i.PlayUI="PlayUI",i.ModalWindow="ModalWindow",i.TitleScreenUI="TitleScreenUI",i.LevelSelectUI="LevelSelectUI",i.MenuHeaderUI="MenuHeaderUI",i.LevelDetailUI="LevelDetailUI",i.Victory="Victory",i.Defeat="Defeat",i.GlobalUI="GlobalUI",i.RandomMapSelectUI="RandomMapSelectUI"},28492:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GlobalUIScene=void 0;const s=i(84612),n=i(71203),a=i(9724),o=i(48565),r=i(82260),c=i(63286),l=i(18995),d=i(57926),h=i(39104),u=i(9095),g=i(85421),p=i(84477),m=i(87951),y=i(62199),f=i(31496),w=y.logger.for("GlobalUIScene");class b extends a.BaseUIScene{constructor(){super({key:s.Scenes.GlobalUI}),this.permanentTooltips=[],this.tooltipsPool=new m.Pool((()=>new g.Tooltip(this))),this.preUpdate=(0,o.whenDirty)((()=>{this.updateLayout()}))}createComponents(){return{notifications:new d.Notifications(this),tooltip:new g.Tooltip(this)}}addTooltip(e){switch(e.type){case p.TooltipType.Hover:return this.comps.tooltip.showDelayed(e),this.comps.tooltip.setDepth(1e3),this.comps.tooltip;case p.TooltipType.Permanent:const t=this.tooltipsPool.take();return this.add.existing(t),t.depth=-1,t.setVisible(!1),this.permanentTooltips.push(t),t.showDelayed(e),t}}create(){super.create(),this.comps=this.createComponents(),this.comps.tooltip.setVisible(!1),this.addAll(Object.values(this.comps)),this.headerButtons=new f.HeaderButtonsUI(this),this.headerButtons.addToScene(),this.handleEventWhileActive(l.SystemEvents.ScreenActivated,(e=>{this.headerButtons.adjustLayoutBasedOnScreen(e.screen),this.comps.notifications.clearToasts(h.NotificationScope.Screen),this.comps.notifications.preUpdate.makeDirty()})),this.watchWhileActive(n.inject.ui.selectedLevelId,(e=>{this.comps.notifications.clearToasts(h.NotificationScope.Level)})),this.bindKey(r.Input.Keyboard.KeyCodes.ESC,l.UserActions.Escape),this.ambientGlitterSound=this.sound.add(u.SoundEffects.Glitter,{loop:!0,volume:0}),this.ambientGlitterVolume=new c.TransitionController(this,{duration:1e3,ease:"Sine.easeInOut",initialValue:0,applyValue:e=>{0===e?this.ambientGlitterSound.stop():(this.ambientGlitterSound.isPlaying||this.ambientGlitterSound.play(),this.ambientGlitterSound.setVolume(e))}})}getTooltipFor(e){return this.headerButtons.getTooltipFor(e)}updateLayout(){this.headerButtons.updateLayout(),this.comps.notifications.preUpdate.makeDirty()}update(e,t){super.update(e,t),this.permanentTooltips.forEach((e=>e.updatePosition()))}removeTooltip(e){const t=this.permanentTooltips.indexOf(e);-1!==t?(this.permanentTooltips.splice(t,1),e.hide().then((()=>this.tooltipsPool.free(e)))):w.warning(`Invalid attempt to remove tooltip "${e}", no such tooltip present among permanent tooltips`)}clearTooltips(){this.permanentTooltips.forEach((e=>{e.hide().then((()=>this.tooltipsPool.free(e)))})),this.permanentTooltips=[]}}t.GlobalUIScene=b},31496:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HeaderButtonsUI=void 0;const s=i(63520),n=i(10445),a=i(38735),o=i(71203),r=i(24909),c=i(84477),l=i(59753),d=i(61852),h=i(18995),u=i(63286),g=i(94459),p=i(44031),m=i(7721),y=i(1951);t.HeaderButtonsUI=class{constructor(e){this.scene=e,this.topOffset=20,this.topOffsetController=new u.TransitionController(this.scene,{duration:200,ease:"Sine.easeInOut",initialValue:this.topOffset,applyValue:e=>{this.topOffset=e,this.updateLayout()}}),this.background=new m.RoundedRect(this.scene,{x:0,y:0,fillStyle:{color:n.Colors.ocean,alpha:.8},radius:8}),this.buttons={toggleSoundButton:new v(this.scene),toggleFullScreenButton:new w(this.scene),helpButton:new b(this.scene),feedbackButton:new S(this.scene),menuButton:new T(this.scene),themeButton:new P(this.scene),cancelButton:new x(this.scene)}}addToScene(){this.scene.addAll([this.background,...Object.values(this.buttons)])}updateLayout(){o.inject.device.updateScreenSize(),Object.values(this.buttons).forEach((e=>e.setVisible(!1)));const e=this.getButtonsToShow();e.forEach((e=>e.setVisible(!0))),p.Arrange.fromLeftToRightOld(e,{x:this.scene.bounds.contentLeft+this.scene.bounds.contentWidth-(0,y.max)(this.topOffset,4),originX:1,y:this.topOffset,padding:0,spacing:2});const t=e[0],i=e[e.length-1];t?(this.background.setPosition(t.x-2,t.y-2),this.background.setSize(i.x+i.width-t.x+4,t.height+4),this.background.setVisible(this.shouldShowBackground())):this.background.setVisible(!1)}getButtonsToShow(){const{toggleFullScreenButton:e,toggleSoundButton:t,helpButton:i,feedbackButton:s,themeButton:n,menuButton:a,cancelButton:r}=this.buttons,c=[];return this.shouldShowFeedbackButton()&&c.push(s),this.shouldShowFullScreenButton()&&c.push(e),this.shouldShowToggleSoundButton()&&c.push(t),o.inject.navigator.currentScreen===o.inject.screen.play?o.inject.device.uiVariant()===g.UiVariant.Compact?o.inject.scene.playUI.activeUI.isRollbackPanelOpen()?[s,...c,n,i,r]:[...c,i,a]:[s,...c,n,i]:[...c,i]}getTooltipFor(e){switch(e){case this.buttons.themeButton:return{title:"Change map color scheme"};case this.buttons.feedbackButton:return{title:"Send feedback to the developer"};case this.buttons.helpButton:return{title:"Display help"};case this.buttons.toggleFullScreenButton:return this.scene.scale.isFullscreen?{title:"Return to windowed mode"}:{title:"Go to fullscreen mode"};case this.buttons.toggleSoundButton:return o.inject.audio.mute?{title:"Unmute sounds"}:{title:"Mute sounds"}}}adjustLayoutBasedOnScreen(e){switch(this.updateLayout(),e){case o.inject.screen.play:this.topOffsetController.transitionTo(4);break;case o.inject.screen.mapEditor:case o.inject.screen.mapGeneration:this.topOffsetController.transitionTo(-34);break;case o.inject.screen.title:default:this.topOffsetController.transitionTo(o.inject.device.uiVariant()===g.UiVariant.Large?20:14)}}shouldShowToggleSoundButton(){return!o.inject.device.isMobile()}shouldShowFullScreenButton(){return o.inject.device.hasBrowserChrome&&this.scene.scale.fullscreen.available}shouldShowBackground(){return o.inject.navigator.currentScreen===o.inject.screen.play&&!o.inject.scene.playUI.activeUI.isRollbackPanelOpen()}shouldShowFeedbackButton(){return o.inject.device.uiVariant()===g.UiVariant.Large&&o.inject.navigator.currentScreen!==o.inject.screen.title}hide(){this.topOffsetController.transitionTo(-34)}};class f extends s.StealthButton{constructor(e,t){super(e,{content:M(e,t).setTint(n.Colors.glassUi.backgroundText),audio:!0,radius:6}),this.setSize(36,32),this.onClicked((()=>this.handleClick()))}}class w extends f{constructor(e){super(e,w.ENTER),this.scene.scale.on(Phaser.Scale.Events.ENTER_FULLSCREEN,(()=>{this.content.setFrame(w.LEAVE)})),this.scene.scale.on(Phaser.Scale.Events.LEAVE_FULLSCREEN,(()=>{this.content.setFrame(w.ENTER)}))}handleClick(){this.scene.scale.isFullscreen?(a.track.interaction("exit_fullscreen"),this.scene.scale.stopFullscreen()):(a.track.interaction("enter_fullscreen"),this.scene.scale.startFullscreen())}}w.ENTER="ui/button-icons/fullscreen-enter",w.LEAVE="ui/button-icons/fullscreen-exit";class b extends f{constructor(e){super(e,"ui/button-icons/help")}handleClick(){switch(a.track.interaction("help"),o.inject.navigator.currentScreen){case o.inject.screen.play:o.inject.events.trigger(h.UserActions.ShowHowToPlay());break;case o.inject.screen.title:window.open(r.HtmlDocs.about.url,"_blank");break;default:o.inject.tooltips.showOver(this,{title:"Sorry! No help is available for this screen yet.\nTry hovering the other buttons on screen to find more information.",type:c.TooltipType.Hover,delayMs:0,icon:"attitude-emoji/1"})}}}class v extends f{constructor(e){super(e,v.ON)}handleClick(){o.inject.audio.mute=!o.inject.audio.mute,this.content.setFrame(o.inject.audio.mute?v.ON:v.OFF),a.track.interaction(o.inject.audio.mute?"mute":"unmute")}}v.ON="ui/button-icons/sound-on",v.OFF="ui/button-icons/sound-off";class S extends s.StealthButton{constructor(e){super(e,{content:M(e,"ui/button-icons/feedback"),audio:!0,radius:6}),this.setSize(this.content.width+8,32),this.onClicked((()=>this.handleClick()))}handleClick(){o.inject.notifications.toggleFeedback()}}class P extends f{constructor(e){super(e,"ui/button-icons/palette")}handleClick(){const e=o.inject.gameStateModel.map.theme,t=Object.keys(l.THEMES);let i=t.indexOf(e);-1===i&&(i=0);const s=t[(i+1)%t.length];d.commands.game.setTheme(s),a.track.interaction("change_color_theme")}}class T extends f{constructor(e){super(e,"ui/button-icons/menu")}handleClick(){o.inject.events.trigger(h.UserActions.OpenRollbackMenu())}}class x extends f{constructor(e){super(e,"ui/button-icons/exit")}handleClick(){o.inject.events.trigger(h.UserActions.Cancel())}}function M(e,t,i="atlas"){return new Phaser.GameObjects.Image(e,0,0,i,t)}},39104:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NotificationToast=t.NotificationCategory=t.NotificationScope=t.NotificationStyle=t.NotificationType=void 0;var s=Phaser.GameObjects.BitmapText;const n=i(10445),a=i(95569),o=i(7721),r=i(14067),c=i(63286),l=i(71203),d=i(94459),h=i(1951);var u,g,p;(p=t.NotificationType||(t.NotificationType={})).Info="info",p.Success="success",p.Alert="alert",t.NotificationStyle={Default:{palette:{shape:n.Colors.glassUi.shape,shadow:n.Colors.glassUi.shapeShadow,timeoutBar:n.Colors.darker(n.Colors.glassUi.shapeShadow),highlight:n.Colors.glassUi.shapeLightAccent}},Alert:{palette:{shape:n.Colors.glassUi.alert.main,shadow:n.Colors.glassUi.alert.shadow,timeoutBar:n.Colors.darker(n.Colors.glassUi.alert.shadow),highlight:n.Colors.glassUi.alert.lightAccent}},Success:{palette:{shape:n.Colors.glassUi.success.main,shadow:n.Colors.glassUi.success.shadow,timeoutBar:n.Colors.darker(n.Colors.glassUi.success.shadow),highlight:n.Colors.glassUi.success.lightAccent}}},(g=t.NotificationScope||(t.NotificationScope={})).Global="global",g.Screen="screen",g.Level="level",(u=t.NotificationCategory||(t.NotificationCategory={})).FeedbackForm="feedback-form",u.InvalidUserActionHint="invalid-user-action-hint",u.UpdatePrompt="update-prompt",u.Error="error";class m extends a.AutoHeightResponsiveContainer{constructor(e){super(e.scene),this.parent=e,this.shadowRect=new o.RoundedRect(this.scene,{x:0,y:0,radius:this.parent.layout.radius}),this.backgroundRect=new o.RoundedRect(this.scene,{x:1,y:1,radius:this.parent.layout.radius}),this.timerBar=new o.RoundedRect(this.scene,{x:0,y:0,radius:0}),this.cancelTimeoutOnHover=!1,this.clickable=!1,this.closeButton=new r.MiniCloseButton(this.scene,0,0),this.offset=c.Control.propOf(this,"y",{duration:this.parent.layout.tweenDuration,ease:"Sine.easeInOut"}),this.add([this.shadowRect,this.backgroundRect,this.timerBar]),this.closeButton.onClicked((async()=>{this.onBeforeDismissed&&!await this.onBeforeDismissed()||(e.closeToast(this),this.onDismissed?.())})),this.setInteractiveAuto(),this.on("pointerdown",(async()=>{this.clickable&&(this.onBeforeDismissed&&!await this.onBeforeDismissed()||(this.onClicked?this.onClicked():e.closeToast(this)))})),this.on("pointerover",(()=>{this.clickable&&this.backgroundRect.setFillStyle(this.style.palette.highlight,.7),this.cancelTimeoutOnHover&&this.timeoutTween&&(this.timeoutTween.stop(),this.timerBar.setVisible(!1)),this.timeoutTween?.pause()})),this.on("pointerout",(()=>{this.backgroundRect.setFillStyle(this.style.palette.shape,.7),this.timeoutTween?.resume()}))}handleChildResize(e){const t=this.height;this.preUpdate.makeDirty(),this.updateSize();const i=this.height;this.parent.handleToastResized(this,i-t)}setProps(e){this.clearContent(),this.icon=e.icon,this.content=e.content,this.scope=e.scope,this.category=e.category,this.style=e.style,e.timeout&&(this.timeoutTween=this.scene.tweens.add({targets:this.timerBar,scaleX:{from:1,to:0},duration:e.timeout,onComplete:()=>{this.parent.closeToast(this)}})),this.clickable=e.clickable??!1,this.cancelTimeoutOnHover=e.cancelTimeoutOnHover??!1,this.onBeforeDismissed=e.onBeforeDismissed,this.onDismissed=e.onDismissed,this.onClicked=e.onClicked,this.timerBar.setFillStyle(e.style.palette.timeoutBar,1),this.backgroundRect.setFillStyle(e.style.palette.shape,.7),this.shadowRect.setFillStyle(e.style.palette.shadow,.7),this.closeButton.setTint(e.style.palette.shadow),this.add([this.icon,this.content,this.closeButton])}clearContent(){this.icon&&(this.icon.destroy(),this.remove(this.icon)),this.content&&(this.remove(this.content),this.content.destroy(),this.content=void 0),this.timeoutTween&&(this.timeoutTween.stop(),this.timeoutTween=void 0)}updateLayout(){const e=this.parent.layout;if(this.content){const t=this.width-3*e.padding-e.spaceForIcon-this.closeButton.width;this.content instanceof s?this.content.setMaxWidth(t):this.content.width=t}this.preUpdateChildren(),l.inject.device.uiVariant()===d.UiVariant.Compact?(this.backgroundRect.radius=0,this.shadowRect.radius=0,this.backgroundRect.setPosition(0,1),this.backgroundRect.setSize(this.width,this.height-7),this.shadowRect.setSize(this.width,this.height),this.timerBar.radius=0):(this.backgroundRect.radius=e.radius,this.shadowRect.radius=e.radius,this.backgroundRect.setPosition(1,1),this.backgroundRect.setSize(this.width-2,this.height-7),this.shadowRect.setSize(this.width,this.height),this.timerBar.radius={tl:0,tr:0,bl:6,br:6}),this.timerBar.setPosition(0,this.height-6),this.timerBar.setSize(this.width,6),this.icon.setOrigin(.5,.5).setPosition(e.padding+e.spaceForIcon/2,(0,h.min)(this.height/2,e.padding+this.icon.height/2)),this.content?.setPosition(e.padding+e.spaceForIcon+e.padding,e.padding),this.closeButton.setPosition(this.width-e.padding/2-this.closeButton.width,(0,h.min)(this.height/2-this.closeButton.height/2,e.padding/2)),this.updateSize()}calculateHeight(){return 2*this.parent.layout.padding+(this.content?.height??0)}destroy(){this.clearContent(),super.destroy()}}t.NotificationToast=m},57926:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Notifications=void 0;const s=i(48565),n=i(46252),a=i(87951),o=i(44031),r=i(94459),c=i(71203),l=i(1951),d=i(92536),h=i(62199),u=i(39104),g=i(42574),p={padding:20,spaceForIcon:50,tweenDuration:300,maxWidth:900},m={[r.UiVariant.Compact]:{...p,spacing:0,radius:0,playModeOffsetFromBottom:82,baseOffsetFromBottom:0},[r.UiVariant.Large]:{...p,spacing:10,radius:6,playModeOffsetFromBottom:200,baseOffsetFromBottom:20}},y=h.logger.for("Notifications");class f extends n.ResponsiveLayer{constructor(e){super(e,[]),this.pool=new a.Pool((()=>new u.NotificationToast(this))),this.displayedToasts=[],this.tweener=new d.Tweener(this.scene,{duration:this.layout.tweenDuration}),this.preUpdate=(0,s.whenDirty)((()=>{this.tweener.stop(),this.displayedToasts.forEach((e=>e.offset.stopTransition()));let e=(0,l.min)(this.layout.maxWidth,this.scene.bounds.contentWidth-20);c.inject.device.uiVariant()===r.UiVariant.Compact&&(e=this.scene.bounds.width),this.displayedToasts.forEach((t=>{t.width=e,t.alpha=1,t.preUpdate()}));const{x:t,y:i}=this.getToastAreaBottomCenter();o.Arrange.fromTopToBottomOld(this.displayedToasts,{x:t,y:i,originY:1,originX:.5,spacing:this.layout.spacing})}),(()=>super.preUpdate()))}get layout(){return m[c.inject.device.uiVariant()]}addToast(e){g.NewsBox.hide();const t=this.pool.take();t.setProps(e),t.width=this.getToastWidth(),t.updateLayout(),this.add(t),this.displayedToasts.forEach((e=>{e.offset.transitionTo(e.offset.targetValue-(this.layout.spacing+t.height))}));const{x:i,y:s}=this.getToastAreaBottomCenter();if(t.setPosition(i-t.width/2,s),t.offset.transitionTo(s-t.height),this.tweener.add({targets:t,alpha:{from:0,to:1},ease:"Sine.easeIn"}),e.category){const t=this.displayedToasts.filter((t=>t.category===e.category));for(let e of t)this.closeToast(e)}return this.displayedToasts.push(t),t}handleToastResized(e,t){const i=this.displayedToasts.indexOf(e);-1!==i?this.displayedToasts.slice(0,i+1).forEach((e=>{e.offset.transitionTo(e.offset.targetValue-t)})):y.warning("invalid call to handleToastResized - object not found among displayed toasts",e)}closeToast(e){return new Promise((t=>{const i=this.displayedToasts.indexOf(e);if(-1===i)return t();this.displayedToasts.splice(i,1),this.displayedToasts.slice(0,i).forEach((t=>{t.offset.transitionTo(t.offset.targetValue+(this.layout.spacing+e.height))})),this.tweener.add({targets:e,alpha:0,onComplete:()=>{e.destroy(),t()},ease:"Sine.easeOut"})}))}clearToasts(e){const t=this.displayedToasts.filter((t=>e===u.NotificationScope.Global||e===u.NotificationScope.Screen&&t.scope!==u.NotificationScope.Global||t.scope===e));for(let e of t)this.closeToast(e)}getToastAreaBottomCenter(){return{x:this.scene.bounds.width/2,y:this.scene.bounds.height-this.getOffsetFromBottom()}}getOffsetFromBottom(){return c.inject.navigator.currentScreen===c.inject.screen.play||c.inject.navigator.currentScreen===c.inject.screen.levelDetail?this.layout.playModeOffsetFromBottom:this.layout.baseOffsetFromBottom}getToastWidth(){return c.inject.device.uiVariant()===r.UiVariant.Compact?this.scene.bounds.width:(0,l.min)(this.layout.maxWidth,this.scene.bounds.contentWidth-20)}}t.Notifications=f},56890:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createWorldMapLODManager=void 0;const s=i(694),n=i(63286);t.createWorldMapLODManager=function(e){const t=new n.TransitionController(e.scene,{applyValue:t=>{e.coins.setAlpha(t),e.coinStacks.setAlpha(t)},ease:"ease.sineInOut",duration:100,initialValue:1});return new s.LODManager(e.scene.cameras.main,[{when:e=>e<.9,activate:e=>{t.transitionTo(0)}},{when:e=>e>=.9,activate:e=>{t.transitionTo(1)}},{when:e=>e>=1.5,activate:()=>{e.coinStacks.defaultFrame="coinstack-hd",e.coins.defaultKey="coin-hd";for(let t of e.coinStacks.getChildren())t.setFrame("coinstack-hd");for(let t of e.coins.getChildren())t.setTexture("coin-hd")}},{when:e=>e<1.5,activate:()=>{e.coinStacks.defaultFrame="coinstack",e.coins.defaultKey="coin";for(let t of e.coinStacks.getChildren())t.setFrame("coinstack");for(let t of e.coins.getChildren())t.setTexture("coin")}}])}},42190:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapPointersTracker=void 0;const s=i(62199),n=i(3724),a=i(41421),o=i(71203),r=i(27358),c=i(23803);s.logger.for("TwoPointersTracker");class l extends n.TwoPointersTracker{constructor(e){super(e)}hasInteraction(e){const t=this.buildPointerEventContext(e);return!!t.hexId&&this.scene.mode.isHexInteractive((0,c.getHex)(t.hexId))}onStartInteraction(e){o.inject.events.trigger(r.WorldMapEvents.StartInteraction(this.buildPointerEventContext(e)))}onCompleteInteraction(e){o.inject.events.trigger(r.WorldMapEvents.CompleteInteraction(this.buildPointerEventContext(e)))}onAbortInteraction(e){o.inject.events.trigger(r.WorldMapEvents.AbortInteraction(this.buildPointerEventContext(e)))}onStartDrag(e){o.inject.events.trigger(r.WorldMapEvents.StartDrag(this.buildPointerEventContext(e)))}onEndDrag(e){o.inject.events.trigger(r.WorldMapEvents.EndDrag(this.buildPointerEventContext(e)))}onStartPinch(e){o.inject.scene.worldMap.cameraController.stopDragScroll(),o.inject.scene.worldMap.cameraController.zoomController.startPinchZoom(),o.inject.events.trigger(r.WorldMapEvents.StartPinch(this.buildPointerEventContext(e)))}onEndPinch(e){o.inject.scene.worldMap.cameraController.zoomController.stopPinchZoom(),o.inject.events.trigger(r.WorldMapEvents.EndPinch(this.buildPointerEventContext(e)))}buildPointerEventContext(e){const t=(0,a.getHexUnderCursor)(this.scene,o.inject.gameStateModel);let i=0;return(e.middleButtonDown()||e.middleButtonReleased())&&(i|=r.PointerEventFlags.MiddleButton),(e.rightButtonDown()||e.rightButtonReleased())&&(i|=r.PointerEventFlags.RightButton),this.scene.keys.shift.isDown&&(i|=r.PointerEventFlags.Shift),this.scene.keys.alt.isDown&&(i|=r.PointerEventFlags.Alt),this.scene.keys.ctrl.isDown&&(i|=r.PointerEventFlags.Ctrl),e.wasTouch&&(i|=r.PointerEventFlags.Touch),{hexId:t?.id,flags:i}}}t.WorldMapPointersTracker=l},27358:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapScene=t.WorldMapEvents=t.PointerEventFlags=t.worldMapAction=void 0;const s=i(62199),n=i(84612),a=i(73664),o=i(71203),r=i(12455),c=i(54001),l=i(11406),d=i(68568),h=i(13626),u=i(35171),g=i(70780),p=i(62461),m=i(44976),y=i(88755),f=i(7937),w=i(73508),b=i(47287),v=i(17225),S=i(64912),P=i(34594),T=i(82260),x=i(5926),M=i(97045),C=i(12543),I=i(81281),A=i(10445),B=i(7703),j=i(62743),_=i(56890),E=i(42190),R=s.logger.for("WorldMapScene");function O(e){return(0,g.createEventFactory)(g.EventCategory.WorldMap,e)}var H;t.worldMapAction=O,(H=t.PointerEventFlags||(t.PointerEventFlags={}))[H.MiddleButton=1]="MiddleButton",H[H.RightButton=2]="RightButton",H[H.Shift=4]="Shift",H[H.Alt=8]="Alt",H[H.Ctrl=16]="Ctrl",H[H.Touch=32]="Touch",t.WorldMapEvents={StartInteraction:O("START_INTERACTION"),AbortInteraction:O("ABORT_INTERACTION"),CompleteInteraction:O("COMPLETE_INTERACTION"),StartDrag:O("START_DRAG"),EndDrag:O("END_DRAG"),StartPinch:O("START_PINCH"),EndPinch:O("END_PINCH")};class D extends m.BaseScene{constructor(){super({key:n.Scenes.WorldMap}),this.mode=new j.BaseWorldMapMode,this.cinematics={coinTransaction:e=>this.coins.cinematics.transactions(e)}}create(){super.create(),this.keys={shift:this.input.keyboard.addKey(T.Input.Keyboard.KeyCodes.SHIFT),alt:this.input.keyboard.addKey(T.Input.Keyboard.KeyCodes.ALT),ctrl:this.input.keyboard.addKey(T.Input.Keyboard.KeyCodes.CTRL)},this.input.keyboard.addKey(T.Input.Keyboard.KeyCodes.SHIFT),o.inject.device.supports.touch&&this.input.addPointer(1),this.input.mouse.disableContextMenu(),this.input.on("wheel",((e,t,i,s,n)=>{this.mode.zoomWithScrollWheel&&this.cameraController.zoomController.applyScroll(s)}),this),this.chunkedRenderer=new b.ChunkedRenderer(this,5),this.chunksRenderingController=new b.ChunksRenderingController(this,this.chunkedRenderer),this.cameraController=new c.WorldMapCameraController(this.cameras.main),this.debugOverlay=new r.WorldMapDebugOverlay(this,this.chunkedRenderer),this.editorOverlay=new x.WorldMapEditorOverlay(this),this.objectPools=new v.WorldObjectsPool(this),this.debugOverlay.create(),this.tiles=new l.TilesManager(this,this.chunkedRenderer),this.regions=new C.RegionsRenderer(this.chunkedRenderer),this.landmass=new I.LandmassRenderer(this.chunkedRenderer),this.coins=new d.CoinsManager(this,this.objectPools,this.tiles),this.pawns=new h.PawnsManager(this,this.objectPools,this.tiles),this.townStatusFlags=new S.TownStatusFlagsManager(this.chunkedRenderer,this.objectPools,this.tiles),this.pawnBacklight=new B.PawnBacklightManager(this.chunkedRenderer,this.tiles,this.pawns),this.pawnSymbols=new P.PawnSymbolsManager(this.pawns),this.attitudeEmojis=new M.AttitudeEmojiManager(this,this.objectPools,this.tiles),this.selectedRegionHighlight=new p.SelectedRegionHighlight(this.chunkedRenderer),this.conquerableHexesHighlight=new y.ConquerableHexesHighlight(this,this.objectPools),this.hexMarkers=new f.HexDefenseMarkers(this),this.pointersTracker=new E.WorldMapPointersTracker(this),this.input.on("pointerup",this.onPointerUp,this),this.input.on("pointermove",this.onPointerMove,this),this.scale.on("resize",this.handleResize,this),o.inject.config.watch(this.applyConfig.bind(this)),this.lodManager=(0,_.createWorldMapLODManager)(this.objectPools),this.handleSignalWhileActive(o.inject.debugLayers.onActiveLayerUpdated,(e=>{if(o.inject.config.debug.overlay)try{this.debugOverlay.showDebugLayer(e)}catch(t){R.warning(`Failed to render debug layer ${e}`,t,t?.stack)}})),this.anims.create({key:"spin-coin",frames:this.anims.generateFrameNumbers("coin",{frames:[0,1,2,3,4,5,0]}),frameRate:30,repeat:-1})}setMode(e){R.info(`⚙ entering ${e.name} (from ${this.mode.name})`),this.mode.deactivate(),this.mode=e,o.inject.debugData.set("worldMap.mode",this.mode.name),e.activate()}applyConfig(e){super.applyConfig(e),this.debugOverlay.setVisible(!!e.debug.overlay)}onPointerMove(){this.mode.handlesPointerEvents&&o.inject.ui.hexUnderCursor.update(this)}update(e,t){this.pawns.update(),this.mode.rendersEverything?this.chunksRenderingController.renderEverything():this.chunksRenderingController.update();const i=this.cameras.main;this.cameraController.update(e,t),this.lodManager.update(),o.inject.config.debug.overlay&&(o.inject.debugData.set("CAM.dimensions",`${i.x},${i.y} -> ${i.width},${i.height}`),o.inject.debugData.set("CAM.worldView",`${i.worldView.x},${i.worldView.y} -> ${Math.round(i.worldView.right)},${Math.round(i.worldView.bottom)}`),o.inject.debugData.set("CAM.scroll",`${Math.round(i.scrollX)}, ${Math.round(i.scrollY)} ph(${this.cameraController.scrollController.cameraX.phase}) z(${i.zoom.toFixed(1)}) d(${(1/i.zoom).toFixed(1)})`),o.inject.debugData.set("worldTweens",`${this.tweens.getAllTweens().length}`),o.inject.debugData.set("CAM.points",this.pointersTracker.pointers.map((e=>`${e.id}: ${!!this.pointersTracker.pointerMoved[e.id]}`)).join(",")),this.objectPools.updateDebugData())}setSelectedRegion(e,t=A.Colors.highlight.ownedRegion){this.selectedRegionHighlight&&(e?this.selectedRegionHighlight.set(e,t):this.selectedRegionHighlight.clear())}loadNewGameState(e){o.inject.ui.withoutTransitions((()=>{this.cameraController.updateBounds(),this.debugOverlay.redrawWorldBoundsRectangle(this.cameraController.worldBounds),this.editorOverlay?.update(),this.syncState(e)}))}syncState(e=o.inject.currentGameState){const t=new a.StaticGameStateModel(e),{pawns:i,regions:s,factions:n}=t,r=u.HexGroup.union(s.all().map((e=>e.hexes))),c=[w.PawnType.Palisade,w.PawnType.StoneWall,w.PawnType.Coins,w.PawnType.Forest];i.select({hexes:r}).filter((e=>!c.includes(e.type))),this.townStatusFlags.clear(),this.pawnBacklight.clear(),this.attitudeEmojis.clear(),this.pawnSymbols.clear(P.PawnSymbolType.Alert),this.pawnSymbols.clear(P.PawnSymbolType.Arrow),this.pawnSymbols.clear(P.PawnSymbolType.Plus),this.pawnSymbols.clear(P.PawnSymbolType.CrossedCoin),this.tiles.syncWithModel(t,r,!0),this.pawns.syncWithModel(t,(e=>!c.includes(e.type))),this.coins.syncWithModel(t),this.regions.syncWithModel(t),this.landmass.syncWithModel(t),this.debugOverlay.redrawChunkRectangles(this.chunkedRenderer.getAllChunks()),this.mode.onSyncState(t),o.inject.scene.worldMap.runIntegrityChecks()}async play(e,t){await this.mode.applyWorldUpdates(e,t)}destroy(e){}getPawnObjectPositionOnScreen(e){return this.pawns.getPawnObjectPositionOnScreen(this.cameras.main,e)}handleResize(){this.cameraController.updateViewPort(),this.cameraController.updateBounds(),this.mode.onResize()}showHexDefenseMarkers(e){const t=o.inject.screen.play.selectedRegion;if(t){const i=(0,f.deriveDefenseMarkerDataFromModel)(t,e);this.hexMarkers.set(i)}}runIntegrityChecks(){this.pawns.integrityCheck()}onPointerUp(e){e.wasTouch&&o.inject.ui.hexUnderCursor.clear()}}t.WorldMapScene=D},62743:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseWorldMapMode=void 0;const s=i(62199),n=i(71203);s.logger.for("BaseWorldMapMode"),t.BaseWorldMapMode=class{constructor(){this.name=this.constructor.name,this.rendersEverything=!1,this.handlesPointerEvents=!1,this.zoomWithScrollWheel=!1,this.scene=n.inject.scene.worldMap}activate(){}deactivate(){}onSyncState(e){}onResize(){}applyWorldUpdates(e,t){}isHexInteractive(e){return!0}}},83367:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EditorMode=void 0;const s=i(62743),n=i(5926);class a extends s.BaseWorldMapMode{constructor(){super(...arguments),this.handlesPointerEvents=!0}activate(){super.activate(),this.scene.editorOverlay||(this.scene.editorOverlay=new n.WorldMapEditorOverlay(this.scene),this.scene.editorOverlay.create()),this.scene.editorOverlay.setVisible(!0),this.scene.editorOverlay?.update()}deactivate(){this.scene.editorOverlay?.setVisible(!1)}onSyncState(e){this.scene.editorOverlay?.update()}isHexInteractive(e){return!1}}t.EditorMode=a},76344:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InteractiveMode=void 0;const s=i(62743),n=i(71203),a=i(22919),o=i(33376),r=i(62199),c=i(68807),l=i(92123),d=i(51897),h=i(70427),u=i(4951),g=r.logger.for("WorldMapScene");class p extends s.BaseWorldMapMode{constructor(){super(...arguments),this.handlesPointerEvents=!0,this.zoomWithScrollWheel=!0}activate(){super.activate(),n.inject.scene.worldMap.cameraController.setViewportMargins({})}deactivate(){super.deactivate(),this.scene.selectedRegionHighlight.clear(),this.scene.conquerableHexesHighlight.clear(),this.scene.townStatusFlags.clear(),this.scene.attitudeEmojis.clear(),this.scene.pawnBacklight.clear(),this.scene.pawns.clearAllJumping(),this.scene.pawns.clearHangingPawn()}onSyncState(e){super.onSyncState(e),(0,a.showWorldMapOverlaysBasedOnSelectedRegion)(),this.scene.selectedRegionHighlight.refresh()}isHexInteractive(e){return n.inject.scene.play.mode.isHexInteractive(e)}applyWorldUpdates(e,t){super.applyWorldUpdates(e,t),g.group(`Apply world updates: \n${e.map((e=>" - "+e.type)).join("\n")}`);const i=n.inject.scene.worldMap,s=e.map((e=>async function(e,t){switch(t.type){case o.UpdateType.PawnMoved:return(0,c.playPawnMove)(e,t);case o.UpdateType.HexCaptured:return(0,h.playHexCaptured)(e,t);case o.UpdateType.PawnsDestroyed:return(0,l.playPawnDestroy)(e,t);case o.UpdateType.PawnReplaced:return(0,u.playPawnReplaced)(e,t);default:throw new Error(`Unable to interpret ${t.type} => aborting smooth update and launching full map sync`)}}(i,e)));return Promise.all(s).then((()=>{console.groupEnd()})).catch((e=>{g.error(e.stack),d.ErrorTracking.captureException(e),g.warning("One or more smooth world map updates failed, resorting to full sync."),i.syncState(t),console.groupEnd()}))}}t.InteractiveMode=p},99809:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PreviewMode=void 0;const s=i(62743),n=i(71203);class a extends s.BaseWorldMapMode{constructor(){super(...arguments),this.handlesPointerEvents=!!n.inject.config.debug.overlay,this.rendersEverything=!0}onSyncState(e){super.onSyncState(e),this.scene.conquerableHexesHighlight.clear(),this.scene.cameraController.center()}onResize(){this.scene.cameraController.center()}}t.PreviewMode=a},70427:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playHexCaptured=void 0;const s=i(16115),n=i(23803),a=i(46299);t.playHexCaptured=async function(e,t){const i=s.Regions.model(t.stateAfter);e.regions.refreshHexes(t.stateAfter,(0,n.getHex)(t.conqueredHex)),e.regions.greenRenderer.redrawRegions(t.affectedRegions.map((e=>i.byId(e))).filter((e=>e))),e.tiles.setTile((0,n.getHex)(t.conqueredHex),a.Factions.model(t.stateAfter).byId(t.newFactionId)),e.selectedRegionHighlight.selectedRegion&&t.affectedRegions.includes(e.selectedRegionHighlight.selectedRegion.id)&&e.selectedRegionHighlight.refresh()}},92123:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playPawnDestroy=void 0;const s=i(52163);t.playPawnDestroy=async function(e,t){const i=e.pawns.getById(t.pawnId);s.assert.defined(i),await e.pawns.transitions.destroyPawn(i)}},68807:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playPawnMove=void 0;const s=i(71203),n=i(62199),a=i(70427),o=i(9332),r=i(52163),c=i(33580),l=i(30634),d=i(92940),h=i(2011),u=i(23803),g=n.logger.for("PawnsManager");async function p(e,t){e&&await t}t.playPawnMove=async function(e,t){let i;const n=h.CurrentPhase.model(t.stateAfter).isLocalPlayerTurn();if(t.created){const s=l.Rules.model(t.stateAfter).pawns(t.created.pawnType);i=e.pawns.createOrUpdatePawnObject({id:t.pawnId,type:t.created.pawnType,hexId:n||s.hasTrait(d.PawnTraits.Building)?t.destHex:t.created.hex??t.destHex,jumping:!1}),s.hasTrait(d.PawnTraits.Building)&&e.regions.palisadeRenderer.redrawHexes(t.stateAfter,(0,u.getHex)(t.destHex))}else i=e.pawns.getById(t.pawnId);r.assert.defined(i),n&&t.hexCaptured&&(0,a.playHexCaptured)(e,t.hexCaptured),n&&s.inject.screen.play.setConquerableHexesBasedOnSelectedRegion();let m,y=!1;if(i.visible&&!s.inject.ui.skipTransitions()&&(i.tile?.hex.id!==t.destHex?(await e.pawns.transitions.pawnMove(i,{srcHex:t.created?.hex,destHex:t.destHex,fadeIn:!!t.created}),y=!0):t.created&&!n&&await e.pawns.transitions.pawnCreated(i,t.destHex)),i.visible||i.show(),i.isDestroyed()||i.attachToTile(e.tiles.getByHex(t.destHex)),!n&&t.hexCaptured&&(0,a.playHexCaptured)(e,t.hexCaptured),t.merged){const s=e.pawns.getById(t.merged.mergedWith);m=o.Pawns.model(t.stateAfter).byId(t.merged.newPawnId),r.assert.defined(m),r.assert.defined(s);const n=e.pawns.createOrUpdatePawnObject({id:m.id,hexId:m.hex.id,type:m.type,jumping:!1});i.destroy(),s.destroy(),i=n}else m=o.Pawns.model(t.stateAfter).byId(t.pawnId),r.assert.defined(m);if(i.setJumping(n&&m.isMovable()),i.hanging&&i.setHighlight(i.jumping?c.Highlight.Hang:null),t.defeatedUnit){const i=e.pawns.getById(t.defeatedUnit.pawnId);i?t.defeatedUnit.retreatHex?await p(!n,e.pawns.transitions.pawnMove(i,{destHex:t.defeatedUnit.retreatHex})):await p(!n,e.pawns.transitions.destroyPawn(i,y?(0,u.getHex)(t.srcHex):void 0)):g.warning(`invalid defeated unit ${t.defeatedUnit.pawnId}`)}}},4951:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playPawnReplaced=void 0;const s=i(62199),n=i(52163),a=i(30634),o=i(92940),r=i(23803);s.logger.for("PawnsManager"),t.playPawnReplaced=async function(e,t){let i=e.pawns.getById(t.oldPawnId);n.assert.defined(i),e.pawns.createOrUpdatePawnObject({id:t.newPawnId,type:t.newType,jumping:i.jumping,hexId:i.tile.hex.id});const s=a.Rules.model(t.stateAfter);a.Rules.model(t.stateAfter).pawns(t.newType),(s.pawns(t.newType).hasTrait(o.PawnTraits.Building)||s.pawns(t.oldType).hasTrait(o.PawnTraits.Building))&&e.regions.palisadeRenderer.redrawHexes(t.stateAfter,(0,r.getHex)(t.hexId)),i.destroy()}},83928:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseScreen=void 0;const s=i(71203);i(62199).logger.for("Navigator"),t.BaseScreen=class{constructor(e,t){this._subs=[],this._deferredHandlers=new Map,this.lockOrientation=!1,this.scenes=t,this.name=e}getScenes(){return this.scenes}async activate(e){}async transitionIn(e){}async transitionOut(e){}deactivate(){}isActive(){return s.inject.navigator.currentScreen===this}pause(){this.scenes.forEach((e=>s.inject.game.scene.pause(e)))}resume(){this.scenes.forEach((e=>s.inject.game.scene.resume(e)))}handleEventWhileActive(e,t){this._subs.push(s.inject.events.on(e,((e,i)=>{this.isActive()&&t.apply(this,[e,i])})))}handleSignalWhileActive(e,t){this._subs.push(e(((...e)=>{this.isActive()&&t.apply(this,e)})))}watchWhileActive(e,t){this._subs.push(e.watch(((i,s)=>{this.isActive()?t.apply(this,[i,s]):this._deferredHandlers.set(e,(()=>t.apply(this,[i,s])))})))}}},79668:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BreakPointScreen=void 0;const s=i(84612),n=i(83928),a=i(71203),o=i(39999);class r extends n.BaseScreen{constructor(){super("BreakPoint",[s.Scenes.WorldMap])}async activate(){}deactivate(){a.inject.screen.play.activationContext=o.NewGameStateContext.ResumingGame}}t.BreakPointScreen=r},55994:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugHistoryScreen=void 0;const s=i(84612),n=i(83928),a=i(71203),o=i(39999);class r extends n.BaseScreen{constructor(){super("DebugHistory",[s.Scenes.DebugHistory,s.Scenes.WorldMap])}async activate(){a.inject.scene.debugHistory.resetCursor(),a.inject.history.suspendRecording(),this.prevIntegrityChecksSetting=a.inject.config.debug.integrityChecks,a.inject.config.debug.integrityChecks=void 0}deactivate(){a.inject.config.debug.integrityChecks=this.prevIntegrityChecksSetting,a.inject.history.resumeRecording(),a.inject.screen.play.activationContext=o.NewGameStateContext.ResumingGame}}t.DebugHistoryScreen=r},35832:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Navigator=void 0;const s=i(71203),n=i(62199),a=i(18995),o=n.logger.for("Navigator");t.Navigator=class{constructor(e){this.game=e}async goTo(e,t){const i=this.currentScreen;s.inject.tooltips.close(),this.updateScreenOrientationLock(e);let n=[];this.currentScreen&&(this.currentScreen.deactivate(),n=this.currentScreen.getScenes(),this.currentScreen=void 0);const o=e.getScenes();o.forEach((e=>{const t=this.game.scene.getScene(e);if(!t)throw new Error(`Scene not found: ${e}`);t.sys.isActive()||this.game.scene.run(e)})),await e.activate(i),this.currentScreen=e,s.inject.events.trigger(a.SystemEvents.ScreenActivated({screen:e,previousScreen:i})),s.inject.debugData.set("screen",`${i?.name??"-"} => ${e.name}`),t?await t():await Promise.all([i?.transitionOut(e),e.transitionIn(i)]),n.filter((e=>-1===o.indexOf(e))).forEach((e=>{this.game.scene.sleep(e)})),s.inject.debugData.set("screen",e.name)}updateScreenOrientationLock(e){if(s.inject.device.isMobile())if(e.lockOrientation)try{window.screen?.orientation?.lock?.("portrait").catch((e=>{o.warning("Unable to lock orientation",e)}))}catch(e){o.warning("Unable to lock orientation",e)}else window.screen?.orientation?.unlock()}}},13933:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.returnToMenuFromGame=void 0;const s=i(71203),n=i(84809);t.returnToMenuFromGame=async function(){const e=s.inject.gameStateModel.map.levelId;s.inject.ui.selectedLevelId.set(e),n.LevelModel.for(e).campaignContext?(s.inject.scene.levelDetailUI.refreshLevelCard(s.inject.ui.playedLevelId()),await s.inject.navigator.goTo(s.inject.screen.levelDetail)):await s.inject.navigator.goTo(s.inject.screen.title)}},64900:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefeatScene=void 0;const s=i(48565),n=i(9724),a=i(84612),o=i(73432),r=i(1157),c=i(10445),l=i(71203),d=i(18995),h=i(79578),u=i(44031),g=i(94459);var p=Phaser.GameObjects.Image,m=Phaser.GameObjects.BitmapText,y=Phaser.GameObjects.Graphics;class f extends n.BaseUIScene{constructor(){super({key:a.Scenes.Defeat}),this.preUpdate=(0,s.whenDirty)((()=>{this.rewindButton.setVisible(l.inject.screen.play.remainingLives>0),this.ribbon.width=400,l.inject.device.uiVariant()===g.UiVariant.Compact?(u.Arrange.vertically({content:[{object:this.ribbon},{object:this.rewindButton},{object:this.restartButton},{object:this.menuButton}],spacing:10,y:this.bounds.height-20,origin:1}),u.Arrange.alignVertically([this.rewindButton,this.restartButton,this.menuButton],{x:this.bounds.centerX,origin:.5}),this.ribbon.x=this.bounds.centerX-this.ribbon.width/2):(this.ribbon.setPosition(this.bounds.centerX-this.ribbon.width/2,this.bounds.height-150),u.Arrange.fromLeftToRightOld([this.rewindButton,this.restartButton,this.menuButton],{x:this.bounds.centerX,originX:.5,y:this.bounds.height-60,originY:.5,spacing:10})),this.ribbonText.setPosition(this.bounds.centerX,this.ribbon.y+6),this.gravestone.setPosition(this.bounds.centerX,this.ribbon.y-20),this.background.clear(),this.background.fillGradientStyle(0,0,0,0,0,0,.5,.5),this.background.fillRect(0,this.bounds.height-200,this.bounds.width,200)}))}create(){super.create();const e=h.UiBuilder.for(this);this.restartButton=e.button(h.ButtonTemplate.MainActionButton,{text:"RESTART",onClicked:()=>{l.inject.events.trigger(d.UserActions.RestartLevel({levelId:l.inject.ui.playedLevelId()}))}}),this.rewindButton=e.button(h.ButtonTemplate.AlternativeActionButton,{text:"REWIND",icon:"ui/button-icons/rollback",onClicked:()=>{l.inject.events.trigger(d.UserActions.RollbackTurn())}}),this.menuButton=e.button(h.ButtonTemplate.AlternativeActionButton,{text:"MENU",onClicked:()=>{this.continue()}}),this.ribbon=new o.Ribbon(this,o.RibbonTexture.Pergamen,0,0,400),this.ribbonText=new m(this,0,0,r.BitmapFont.Main,"Oh no! We have been defeated!").setTint(c.Colors.woodenUi.primaryText).setOrigin(.5,0),this.gravestone=this.createImage("gravestone"),this.background=new y(this),this.addAll([this.background,this.gravestone,this.menuButton,this.restartButton,this.rewindButton,this.ribbon,this.ribbonText])}continue(){this.scene.isActive()&&l.inject.events.trigger(d.UserActions.GoToLevelDetail({levelId:l.inject.ui.playedLevelId()}))}createImage(e){return new p(this,0,0,"gameOverAtlas",e)}}t.DefeatScene=f},26602:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefeatScreen=void 0;const s=i(84612),n=i(83928),a=i(71203),o=i(18995),r=i(99809),c=i(80266),l=i(13933),d=i(3031),h=i(9095);class u extends n.BaseScreen{constructor(){super("Defeat",[s.Scenes.WorldMap,s.Scenes.Defeat]),this.handleEventWhileActive(o.UserActions.GoToLevelDetail,(({levelId:e})=>{(0,l.returnToMenuFromGame)()})),this.handleEventWhileActive(o.UserActions.RestartLevel,(({levelId:e})=>{a.inject.userData.deleteSavedGame(e,c.SaveGameTags.Autosave),a.inject.events.trigger(o.UserActions.PlayLevel({levelId:e})),a.inject.audio.playEffect(h.SoundEffects.Rewind)})),this.handleEventWhileActive(o.UserActions.RollbackTurn,(()=>{a.inject.screen.play.rewindTurn(),a.inject.navigator.goTo(a.inject.screen.play)})),this.handleEventWhileActive(o.UserActions.Escape,(async()=>{a.inject.scene.defeat.continue()}))}async activate(){a.inject.scene.worldMap.setMode(new r.PreviewMode),a.inject.scene.worldMap.cameraController.center(1e3)}async transitionOut(e){if(e===a.inject.screen.levelDetail)return(0,d.defeatToLevelDetailTransition)()}}t.DefeatScreen=u},3031:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defeatToLevelDetailTransition=void 0;const s=i(71203),n=i(20069);t.defeatToLevelDetailTransition=async function(){s.inject.scene.levelDetailUI;const e=s.inject.config.screenTransitionDuration,t=s.inject.scene.defeat;return(0,n.playSceneToLevelDetailTransition)(),new Promise((i=>{t.tweens.add({targets:[t.menuButton,t.restartButton,t.rewindButton],y:{to:"+=160"},alpha:{from:1,to:0},duration:e,onComplete:i}),t.tweens.add({targets:[t.background,t.ribbonText],alpha:{from:1,to:0},duration:e,ease:"Sine.easeInOut"}),t.tweens.add({targets:t.ribbon,x:{from:t.ribbon.x,to:t.ribbon.x+150},width:{from:400,to:100},alpha:{from:1,to:0},duration:e,ease:"Sine.easeInOut"}),t.tweens.add({targets:t.gravestone,y:{from:t.gravestone.y,to:t.gravestone.y+40},duration:e,scale:{from:1,to:.1},alpha:{from:1,to:0},ease:"Sine.easeInOut"})}))}},81183:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defeatTransition=void 0;const s=i(71203),n=i(9095);t.defeatTransition=async function(){const e=s.inject.scene.defeat;s.inject.scene.playUI.activeUI.transitionOut(),s.inject.audio.playEffect(n.SoundEffects.Defeat);const t=s.inject.config.screenTransitionDuration;return new Promise((i=>{e.preUpdate.force(),e.tweens.add({targets:[e.menuButton,e.restartButton,e.rewindButton],y:{from:"+=160",to:"-=160"},alpha:{from:0,to:1},onComplete:i,duration:t,ease:"Sine.easeInOut"}),e.tweens.add({targets:[e.background,e.ribbonText],alpha:{from:0,to:1},duration:t,ease:"Sine.easeInOut"}),e.tweens.add({targets:e.ribbon,x:{from:e.ribbon.x+150,to:e.ribbon.x},width:{from:100,to:400},alpha:{from:.5,to:1},duration:t,ease:"Sine.easeInOut"}),e.tweens.add({targets:e.gravestone,y:{from:e.gravestone.y+40,to:e.gravestone.y},duration:t,scale:{from:.1,to:1},alpha:{from:0,to:1},ease:"Sine.easeInOut"})}))}},74760:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LargeLevelCardContent=t.LargeLevelCard=void 0;const s=i(1532),n=i(95569),a=i(15641),o=i(1157),r=i(10445),c=i(10780),l=i(96532),d=i(61720),h=i(63286),u=i(62199),g=i(71203),p=i(77949),m=i(94459);var y=Phaser.GameObjects.BitmapText,f=Phaser.GameObjects.Image,w=Phaser.Geom.Rectangle;u.logger.for("LargeLevelCard");const b={icon:l.LevelIcons.NotStarted,title:"",subTitle:""};class v extends s.Card{constructor(e,t){super(e,{...t,content:void 0}),this.content=new S(e,this)}}t.LargeLevelCard=v;class S extends n.ResponsiveContainer{constructor(e,t,i){super(e),this.card=t,this.mapPreviewLoaded=!1,this.props=(0,d.StateContainer)(this,b),this._icon=new f(e,0,0,"atlas",l.LevelIcons.NotStarted).setOrigin(.5,.5),this._title=new y(e,0,0,o.BitmapFont.Main,"").setOrigin(0,0).setTint(r.Colors.glassUi.primaryText),this._subTitle=new y(e,0,0,o.BitmapFont.Mini,"").setOrigin(0,0).setTint(r.Colors.glassUi.primaryText),this._mainButtonText=new y(e,0,0,o.BitmapFont.Main,"?").setTint(r.Colors.woodenUi.primaryText).setLetterSpacing(1),this._mainButton=new a.BoxButton(e,0,0,{baseTexture:c.BoxTexture.DialogButton,downTexture:c.BoxTexture.DialogButtonDown,height:60,width:S.Layout.buttonsWidth,content:this._mainButtonText}),this._secondaryButtonText=new y(e,0,0,o.BitmapFont.Small,"?").setTint(r.Colors.woodenUi.primaryText),this._secondaryButton=new p.RibbonButton(e,0,0,{type:p.RibbonButtonStyle.Small,width:S.Layout.buttonsWidth,content:this._secondaryButtonText}),this._tapToPlayHint=new y(e,0,0,o.BitmapFont.Mini,"tap to play").setTint(r.Colors.glassUi.secondaryText).setOrigin(.5,0),this.add([this._icon,this._title,this._subTitle,this._mainButton,this._secondaryButton,this._tapToPlayHint]),this._mainButtonVisible=h.Control.visibilityOf(this._mainButton,{duration:300}).setTo(0),this._secondaryButtonVisible=h.Control.visibilityOf(this._secondaryButton,{duration:300}).setTo(0),i&&this.props.update(i)}applyState(e,t,i){if(void 0!==e.title&&e.title!==i.title&&this.setTitle(e.title),void 0!==e.icon&&e.icon!==i.icon&&this.setIcon(e.icon),void 0!==e.subTitle&&e.subTitle!==i.subTitle&&this.setSubtitle(e.subTitle),void 0!==e.primaryButton&&e.primaryButton!==i.primaryButton)if(e.primaryButton){const t=e.primaryButton;this.setMainButton(t.title,t.tooltip,t.onClick,t.visible)}else this.hideMainButton();if(void 0!==e.secondaryButton&&e.secondaryButton!==i.secondaryButton)if(e.secondaryButton){const t=e.secondaryButton;this.setSecondaryButton(t.title,t.tooltip,t.onClick,t.visible)}else this.hideSecondaryButton()}setIcon(e){this._icon.setFrame(e).setOrigin(.5,.5),this.preUpdate.makeDirty()}setTitle(e){this._title.setText(e)}setSubtitle(e){this._subTitle.setText(e)}setMainButton(e,t,i,s){this._mainButtonText.setText(e),this._mainButton.onClicked.unsubscribeAll(),this._mainButton.onClicked(i),this._mainButtonVisible.transitionTo(s?1:0),this._mainButton.setData("tooltip",t),this.preUpdate.makeDirty()}setSecondaryButton(e,t,i,s){this._secondaryButtonText.setText(e),this._secondaryButton.onClicked.unsubscribeAll(),this._secondaryButton.onClicked(i),this._secondaryButton.setData("tooltip",t),this._secondaryButtonVisible.transitionTo(s?1:0),this.preUpdate.makeDirty()}hideMainButton(){this._mainButtonVisible.transitionTo(0),this.preUpdate.makeDirty()}hideSecondaryButton(){this._secondaryButtonVisible.transitionTo(0),this.preUpdate.makeDirty()}loadMapPreviewFromWorldMap(){this.mapPreview||(this.mapPreview=g.inject.scene.levelDetailUI.mapPreviewPool.take(),this.add(this.mapPreview)),this.mapPreview.updateFromWorldMap(),this.mapPreviewLoaded=!0,this.preUpdate.makeDirty()}clearMapPreview(){this.mapPreviewLoaded=!1,this.mapPreview?.setVisible(!1)}updateLayout(){super.updateLayout();const e=g.inject.device.uiVariant()===m.UiVariant.Compact,t=S.Layout,i=this.props().secondaryButton&&e?-16:0,n=t.padding,a=this.height-this.card.footerSize+t.padding,o=this._title.height+(this._subTitle.text?this._subTitle.height+t.textSpacing:0),r=(this.props().primaryButton?this._mainButton.height:0)+(this.props().secondaryButton?this._secondaryButton.height:0)+(this.props().primaryButton&&this.props().secondaryButton?t.buttonSpacing:0);this._icon.setPosition(n+t.iconOffsetFromLeft,this.height-this.card.footerSize/2+i),this._title.setPosition(n+t.titleOffsetFromLeft,a+i+(this.card.footerSize-o-2*t.padding)/2),this._subTitle.setPosition(this._title.x,this._title.y+this._title.height+t.textSpacing);let c=a+(this.card.footerSize-r-2*t.padding)/2;if(this._mainButton.setPosition(this.width-this._mainButton.width-t.padding-t.buttonsOffsetFromRight,c),this._mainButton.setVisible(g.inject.device.uiVariant()===m.UiVariant.Large),this._tapToPlayHint.setPosition(this.width/2,this.height-this.card.footerSize-30),e){this._secondaryButton.setPosition(this.width/2-this._secondaryButton.width/2,this.height-14-this._secondaryButton.height),this._tapToPlayHint.setVisible(this.card.clickable!==s.CardPointerInputMode.NotClickable);const e=g.inject.device.isUsingTouch()?"tap":"click";this._tapToPlayHint.setText(e+" to "+(this.props().primaryButton?.title.toLowerCase()??"play"))}else this._tapToPlayHint.setVisible(!1),this.props().primaryButton?.visible?this._secondaryButton.setPosition(this._mainButton.x,this._mainButton.y+this._mainButton.height+t.buttonSpacing):this._secondaryButton.setPosition(this.width-this._secondaryButton.width-t.padding-t.buttonsOffsetFromRight,c);const l=new w(0,0,this.card.width,this.card.height-this.card.footerSize);if(this.mapPreviewLoaded&&this.mapPreview){const e=w.FromXY(l.x,l.y,l.x+this.mapPreview.width,l.y+this.mapPreview.height);w.FitInside(e,l),this.mapPreview.visible?(this.mapPreview.setVisible(!0),this.mapPreview.setAlpha(1)):(this.mapPreview.setVisible(!0),this.mapPreview.setAlpha(0),this.scene.tweens.add({targets:this.mapPreview,props:{alpha:{start:0,to:1}},duration:300}));let t=e.width/this.mapPreview.width;t>1?(this.mapPreview.setScale(1),this.mapPreview.setPosition(l.centerX-this.mapPreview.width/2,l.centerY-this.mapPreview.height/2)):(this.mapPreview.setScale(t),this.mapPreview.setPosition(e.x,e.y))}}}t.LargeLevelCardContent=S,S.Layout={padding:10,buttonsOffsetFromRight:20,buttonsWidth:200,titleOffsetFromLeft:80,iconOffsetFromLeft:40,buttonSpacing:4,textSpacing:8}},59286:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelDetailScreen=t.DEFAULT_LIVES_PER_LEVEL=void 0;const s=i(83928),n=i(84612),a=i(71203),o=i(18995),r=i(36530),c=i(99809),l=i(84809),d=i(24909),h=i(56849),u=i(80266);t.DEFAULT_LIVES_PER_LEVEL=3;class g extends s.BaseScreen{constructor(){super("LevelDetail",[n.Scenes.WorldMap,n.Scenes.LevelDetailUI,n.Scenes.MenuHeaderUI]),this.handleEventWhileActive(o.UserActions.GoBack,(()=>{a.inject.navigator.goTo(a.inject.screen.levelSelect)})),this.handleEventWhileActive(o.UserActions.Escape,(async()=>{a.inject.events.trigger(o.UserActions.GoBack())})),this.handleEventWhileActive(o.UserActions.PreviewLevel,(({levelId:e})=>{a.inject.scene.levelDetailUI.scrollToLevel(e)})),this.handleEventWhileActive(o.UserActions.AbandonLevelProgress,(({levelId:e})=>{const t=function(e){switch(e){case l.LevelStatus.InProgress:return"Are you sure? Your progress in this level will be lost!";case l.LevelStatus.Replaying:return"Are you sure? Your progress since the most recent victory will be lost.";default:return}}(l.LevelModel.for(e).getLevelStatus());a.inject.modals.show(d.UI.abandonLevelDialog,{message:t},(async t=>{t===h.DialogButtons.GiveUp&&(a.inject.userData.deleteSavedGame(e,u.SaveGameTags.Autosave),this.loadLevel(e),a.inject.scene.levelDetailUI.refreshLevelCard(e),a.inject.ui.playedLevelId.set(void 0))}))}))}async activate(e){a.inject.ui.withoutTransitions((()=>{a.inject.scene.worldMap.setMode(new c.PreviewMode)})),a.inject.scene.worldMap.scene.setVisible(!1),await this.loadLevel(a.inject.ui.selectedLevelId())}deactivate(){a.inject.scene.worldMap.scene.setVisible(!0)}async transitionOut(e){if(e===a.inject.screen.play)return(0,r.levelDetailToPlaySceneTransition)()}async loadLevel(e){const t=l.LevelModel.for(e);a.inject.scene.menuHeaderUI.state.update({title:t.parentCampaign?.name??"Custom map",backButtonTitle:"OVERVIEW"}),a.inject.scene.levelDetailUI.state.update({campaignId:t.parentCampaign?.id,levels:t.parentCampaign?.levels.map((e=>e.id))}),a.inject.scene.levelDetailUI.goToLevelIndex(t.campaignContext?.indexInCampaign??0)}}t.LevelDetailScreen=g},82963:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getLevelCardProps=t.LevelDetailUIScene=void 0;const s=i(84612),n=i(71203),a=i(48565),o=i(18995),r=i(9724),c=i(96532),l=i(62199),d=i(61720),h=i(1663),u=i(76038),g=i(84809),p=i(74760),m=i(41625),y=i(52163),f=i(85059),w=i(26801),b=i(87951),v=i(1245),S=i(99809),P=i(39999),T=i(1532),x=i(82260),M=i(9095),C=i(52700);var I=Phaser.Geom.Rectangle;const A=l.logger.for("LevelDetailUIScene"),B={campaignId:"",levels:[]};class j extends r.BaseUIScene{constructor(){super({key:s.Scenes.LevelDetailUI}),this.cards=[],this.mapPreviewLoader=new m.AsyncJobQueue(this._loadMapPreview.bind(this)),this.state=(0,d.StateContainer)(this,B),this.currentLevelIndex=-1,this.mapPreviewPool=new b.Pool((()=>new w.MapPreview(this,this.layout.tileWidth,this.layout.tileHeight))),this.preUpdate=(0,a.whenDirty)((()=>{const{tileWidth:e,tileHeight:t,tileLeft:i,cardWidth:s,cardHeight:n,cardTop:a,cardLeft:o}=this.layout;this.updateCardsInView();for(let e=0;e<this.state().levels.length;++e)this.cards[e]&&(this.cards[e].setPosition(o(e),a),this.cards[e].setSize(s,n),this.cards[e].setAlpha(1));this.scrollController.cameraX.setTo(this.getCameraXByCardIndex(this.currentLevelIndex))}))}create(){super.create();const e=this;this.scrollController=new h.ScrollableViewController(this.cameras.main,{horizontal:!0,vertical:!1,continueToNextStopThreshold:1e3,horizontalStops:{getNextFrom(t){let i=e.getCardIndexByCameraX(t);return t>e.getCameraXByCardIndex(i)&&i<e.state().levels.length-1&&(i+=1),e.getCameraXByCardIndex(i)},getPreviousFrom(t){let i=e.getCardIndexByCameraX(t);return t<e.getCameraXByCardIndex(i)&&i>0&&(i-=1),e.getCameraXByCardIndex(i)}}}),this.calculateLayout(),this.scale.on("resize",(()=>this.calculateLayout())),this.watchWhileActive(n.inject.ui.scale,(()=>this.calculateLayout())),this.bindKey(x.Input.Keyboard.KeyCodes.ESC,o.UserActions.GoBack)}calculateLayout(){const e={cardSpacing:30,tiles:{padding:40,offsetFromTop:C.MenuHeaderUIScene.Layout.panelHeight,offsetFromBottom:20},cards:{radius:40,minVisibleSizeTODO:40,footerSize:120}},t={...e,tileTop:e.tiles.offsetFromTop,tileWidth:this.bounds.contentWidth,tileHeight:this.bounds.height-e.tiles.offsetFromBottom-e.tiles.offsetFromTop},i={...t,tileLeft:e=>e*t.tileWidth,cardWidth:t.tileWidth-2*t.tiles.padding,cardHeight:t.tileHeight-2*t.tiles.padding,cardTop:t.tiles.offsetFromTop+t.tiles.padding,cardLeft:e=>e*t.tileWidth+t.tiles.padding};this.layout={...i,mapPreview:{top:i.cardTop,left:e=>i.cardLeft(e),width:i.cardWidth,height:i.cardHeight-i.cards.footerSize}}}refreshLevelCard(e){const t=this.state().levels.indexOf(e);if(-1===t)return void A.warning(`level ${e} does not exist in the current state, ignoring request to refresh map preview`);const i=this.cards[t];i&&(i.content.clearMapPreview(),this.mapPreviewLoader.addJob(e))}goToLevelIndex(e){this._setCurrentLevelIndex(e),this.scrollController.cameraX.setTo(this.getCameraXByCardIndex(this.currentLevelIndex)),this.preUpdate.makeDirty()}_setCurrentLevelIndex(e){this.currentLevelIndex=e;const t=this.state().levels[e];n.inject.ui.selectedLevelId.set(t)}get centralCard(){return this.cards[this.currentLevelIndex]}get leftCard(){const e=this.currentLevelIndex-1;if(-1!==e)return this.cards[e]}get rightCard(){const e=this.currentLevelIndex+1;if(!(e>=this.state().levels.length))return this.cards[e]}getCardIndexByCameraX(e,t=0){const i=Math.floor((e+this.bounds.contentLeft)/this.layout.tileWidth+t+.5),s=this.state().levels.length-1;return(0,u.cropNumber)(i,0,s)}getCameraXByCardIndex(e){return e*this.layout.tileWidth-this.bounds.contentLeft}getCardRectForIndex(e){const{tileWidth:t,tileHeight:i,cardWidth:s,cardHeight:n}=this.layout,a=this.layout,o=e*t+a.tiles.padding,r=a.tiles.offsetFromTop+a.tiles.padding;return I.FromXY(o,r,o+s,r+n)}applyState(e,t,i){e.campaignId&&e.campaignId!==i.campaignId&&(this.cards.forEach((e=>e.destroy())),this.cards=[],this.mapPreviewPool.freeAll(),this.mapPreviewLoader.clear()),e.levels&&this.updateCardsInView()}updateCardsInView(){this.createOrUpdateCard(this.currentLevelIndex-1),this.createOrUpdateCard(this.currentLevelIndex),this.createOrUpdateCard(this.currentLevelIndex+1)}createOrUpdateCard(e){if(e<0||e>=this.state().levels.length)return;const t=this.state().levels[e];if(!this.cards[e]){const i=new p.LargeLevelCard(this,{radius:this.layout.cards.radius,footerSize:this.layout.cards.footerSize,clickable:T.CardPointerInputMode.WithoutFooter,onClick:()=>{this.scrollController.dragging||(n.inject.audio.playEffect(M.SoundEffects.ButtonUp),this.currentLevelIndex===e?n.inject.events.trigger(o.UserActions.PlayLevel({levelId:t})):this.scrollToLevel(t))}});this.cards[e]=i,i.setPosition(this.layout.cardLeft(e),this.layout.cardTop),i.setSize(this.layout.cardWidth,this.layout.cardHeight),this.add.existing(i),this.mapPreviewLoader.addJob(t)}const i=g.LevelModel.for(t),s=this.currentLevelIndex===e,a=_(this,`${i.getTitle(g.LevelTitleStyle.Full)}`,t,s);console.log("NEW PROPS",a),this.cards[e].content?.props.update(a),this.cards[e].setClickable(this.getCardInputMode(i.getLevelStatus(),e))}update(){const e=this.getCardIndexByCameraX(this.scrollController.cameraX.value);n.inject.debugData.set("HOVERING INDEX",e.toString()),e!==this.currentLevelIndex&&this.scrollController.cameraX.phase!==v.KineticValuePhase.Stable&&(this._setCurrentLevelIndex(e),this.updateCardsInView()),this.scrollController.cameraX.phase!==v.KineticValuePhase.Stable||n.inject.scene.worldMap.scene.isVisible()?this.mapPreviewLoader.pause():this.mapPreviewLoader.resume()}async _loadMapPreview(e){const t=f.timing.start(`loadMapPreview ${e}`),i=g.LevelModel.for(e);if(i.parentCampaign?.id!==this.state().campaignId)return;const s=i.campaignContext?.indexInCampaign;y.assert.defined(s);const a=this.cards[s];if(a.content.mapPreviewLoaded)return;const o=await i.getCurrentState();y.assert.defined(o,`Failed to load level ${i.id}`),y.assert.defined(a),n.inject.ui.withoutTransitions((()=>{n.inject.gameStateController.loadState(o,P.NewGameStateContext.Preview),n.inject.scene.worldMap.setMode(new S.PreviewMode),n.inject.scene.worldMap.syncState(n.inject.currentGameState),n.inject.scene.worldMap.chunksRenderingController.renderEverything(),a.content.loadMapPreviewFromWorldMap()})),t.complete()}scrollToLevel(e){const t=this.state().levels.indexOf(e);if(-1===t)throw new Error(`Unable to scroll to level "${e}" - no such level found in the current state`);const i=this.getCameraXByCardIndex(t);this.scrollController.cameraX.pushTo(i)}getCardInputMode(e,t){return t!==this.currentLevelIndex||e===g.LevelStatus.InProgress||e===g.LevelStatus.NotStarted||e===g.LevelStatus.Replaying||e===g.LevelStatus.Defeated?T.CardPointerInputMode.WithoutFooter:T.CardPointerInputMode.NotClickable}}function _(e,t,i,s){const a=g.LevelModel.for(i);function r(t,i,a){return{title:t,tooltip:i,onClick:()=>{e.scrollController.dragging||n.inject.events.trigger(a)},visible:s}}const l={title:t};switch(a.getLevelStatus()){case g.LevelStatus.InProgress:return{...l,icon:c.LevelIcons.Fighting,primaryButton:r("CONTINUE","Continue the game where you left off.",o.UserActions.PlayLevel({levelId:i})),secondaryButton:r("GIVE UP","Abandon the current attempt and start from scratch.",o.UserActions.AbandonLevelProgress({levelId:i})),subTitle:`Turn ${a?.userData?.inProgress?.turnNumber??"?"}`};case g.LevelStatus.Completed:const e=a.getNextUnfinishedLevelId();return{...l,icon:c.LevelIcons.Gold,primaryButton:e?r("NEXT","Go to the next unconquered island",o.UserActions.PreviewLevel({levelId:e})):null,secondaryButton:r("PLAY AGAIN","Play this island again (don't worry, this won't erase your victory)",o.UserActions.PlayLevel({levelId:i})),subTitle:`You won in ${a?.userData?.bestResult?.turnNumber??"unknown number of"} turns!`};case g.LevelStatus.Defeated:return{...l,icon:c.LevelIcons.Defeated,primaryButton:r("TRY AGAIN","Restart this island.",o.UserActions.PlayLevel({levelId:i})),secondaryButton:null,subTitle:"They will pay for this!"};case g.LevelStatus.NotStarted:return{...l,icon:c.LevelIcons.NotStarted,primaryButton:r("PLAY","Play this island.",o.UserActions.PlayLevel({levelId:i})),secondaryButton:null,subTitle:""};case g.LevelStatus.Replaying:return{...l,icon:c.LevelIcons.Gold,primaryButton:r("CONTINUE","Continue the game where you left off.",o.UserActions.PlayLevel({levelId:i})),secondaryButton:r("ABANDON","Abandon the current attempt and restore\n the island to the previous victory state",o.UserActions.AbandonLevelProgress({levelId:i})),subTitle:`Turn ${a.userData?.inProgress?.turnNumber}. (Won in ${a.userData?.bestResult?.turnNumber} turns before)`};default:throw new Error(`requested level card props for locked level ${i} which has status ${a.getLevelStatus()} - this is not supported!`)}}t.LevelDetailUIScene=j,t.getLevelCardProps=_},26801:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapPreview=void 0;const s=i(71203);var n=Phaser.GameObjects.RenderTexture;i(62199).logger.for("MapPreview"),t.MapPreview=class extends n{constructor(e,t=200,i=200){super(e,0,0,t,i)}updateFromWorldMap(){const e=s.inject.scene.worldMap.cameraController.worldBounds,t=e.width,i=e.height;s.inject.scene.worldMap.children.depthSort(),this.resize(t,i),this.clear(),this.camera.setScroll(e.x,e.y);const n=s.inject.scene.worldMap.children;s.inject.ui.withoutTransitions((()=>{s.inject.scene.worldMap.lodManager.apply(.5,!0)})),this.draw(n),s.inject.config.debug.overlay}}},1663:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScrollableViewController=void 0;const s=i(36504),n=i(71203),a=i(62199),o=i(1245);a.logger.for("ScrollableViewController"),t.ScrollableViewController=class{constructor(e,t={}){this.camera=e,this.dragging=!1,this.deadzone=20,this.dragMomentumX=0,this.dragMomentumY=0,this.drag=3e3,this.dragStartPosition=void 0,this.enableX=!0,this.enableY=!0,this.scene=this.camera.scene,this.cameraY=new o.KineticValue(e.scrollX,{drag:this.drag,scene:this.scene,apply:e=>this.camera.scrollY=e,continueToNextStopThreshold:t.continueToNextStopThreshold,stops:t.verticalStops}),this.cameraX=new o.KineticValue(0,{drag:this.drag,scene:this.scene,apply:e=>{this.camera.scrollX=e},continueToNextStopThreshold:t.continueToNextStopThreshold,stops:t.horizontalStops}),t.drag&&(this.drag=t.drag),!1===t.vertical&&(this.enableY=!1),!1===t.horizontal&&(this.enableX=!1),void 0!==t.deadzone&&(this.deadzone=t.deadzone),this.pointer=this.scene.input.activePointer,this.scene.input.on("pointerdown",this.handlePointerDown,this),this.scene.input.on("pointermove",this.handlePointerMove,this),this.scene.input.on("pointerup",this.handlePointerUp,this),this.scene.input.on("wheel",((e,t,i,s,n)=>{let a=10*s;this.enableY?(this.cameraY.accelerate(a),a>0&&this.cameraY.speed<this.cameraY.continueToNextStopThreshold&&this.cameraY.pushToNextStop()):(this.cameraX.accelerate(a),a>0&&this.cameraX.speed<this.cameraX.continueToNextStopThreshold&&this.cameraX.pushToNextStop())}),this),this.scene.events.on("update",this.update,this)}detach(){this.scene.input.removeListener("pointermove",this.handlePointerMove),this.scene.input.removeListener("update",this.update)}update(e,t){this.dragMomentumX*=.8,this.dragMomentumY*=.8,this.enableX&&this.cameraX.update(e,t),this.enableY&&this.cameraY.update(e,t),n.inject.debugData.set("SCROLL",`${this.cameraX.value.toFixed(0)} ${this.cameraY.value.toFixed(0)}`)}startDrag(){this.dragging=!0,this.dragCursorIconOn(),this.cameraX.freeze(),this.cameraY.freeze()}stopDrag(){if(!this.dragging)return 0;this.dragging=!1,this.cameraX.unfreeze(),this.cameraY.unfreeze(),this.cameraX.accelerate(this.dragMomentumX),this.cameraY.accelerate(this.dragMomentumY),this.dragCursorIconOff()}async panTo(e,t,i=0){const s=e-this.camera.width/2,n=t-this.camera.height/2;0===i?(this.enableX&&this.cameraX.setTo(s),this.enableY&&this.cameraY.setTo(n)):await Promise.all([this.enableX&&this.cameraX.tweenTo(s,i,"Sine.easeInOut"),this.enableY&&this.cameraY.tweenTo(n,i,"Sine.easeInOut")])}dragCursorIconOn(){this.scene.game.canvas.style.cursor="grabbing"}dragCursorIconOff(){this.scene.game.canvas.style.cursor="default"}handlePointerMove(e){if(this.dragging){if(!e.isDown)return this.cameraX.unfreeze(),void this.cameraY.unfreeze();const t=e.position.x-e.prevPosition.x,i=e.position.y-e.prevPosition.y;this.dragMomentumX-=10*t,this.dragMomentumY-=10*i,this.enableX&&this.cameraX.setTo(this.cameraX.value-t/this.camera.zoom),this.enableY&&this.cameraY.setTo(this.cameraY.value-i/this.camera.zoom)}else this.dragStartPosition&&e.isDown&&(0,s.euclidDistance)(this.dragStartPosition,{x:this.pointer.x,y:this.pointer.y})>this.deadzone&&this.startDrag()}handlePointerDown(e){this.dragStartPosition={...e.position}}handlePointerUp(){this.dragStartPosition=void 0,this.stopDrag()}setBounds(e){this.camera.width,this.camera.height}}},36530:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.levelDetailToPlaySceneTransition=void 0;const s=i(71203);t.levelDetailToPlaySceneTransition=async function(){const e=s.inject.scene.levelDetailUI,t=s.inject.scene.menuHeaderUI,i=s.inject.config.screenTransitionDuration,n=s.inject.scene.worldMap,a=e.centralCard.content.mapPreview;return a?.setVisible(!1),n.cameraController.zoomController.cameraDistance.setTo(1/(a?.scale??1)/e.cameras.main.zoom),n.cameraController.center(1e3,1),new Promise((s=>{e.tweens.add({targets:[e.centralCard],props:{alpha:0},duration:i,onComplete:s}),e.cameras.main.preRender(),e.leftCard&&e.tweens.add({targets:e.leftCard,props:{x:e.cameras.main.scrollX-e.layout.cardWidth-10},duration:i,ease:"Sine.easeOut"}),e.rightCard&&e.tweens.add({targets:e.rightCard,props:{x:e.cameras.main.scrollX+e.cameras.main.worldView.width+10},duration:i,ease:"Sine.easeOut"}),t.slideOut()})).then((()=>{a?.setVisible(!0)}))}},20069:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playSceneToLevelDetailTransition=t.precalculateMapPreviewScale=void 0;const s=i(71203);var n=Phaser.Geom.Rectangle;function a(){const e=s.inject.scene.levelDetailUI.layout.mapPreview,t=s.inject.scene.worldMap.cameraController.worldBounds,i=new n(0,0,e.width,e.height),a=new n(0,0,t.width,t.height);return n.FitInside(a,i),Math.min(1,a.width/t.width*s.inject.ui.scale())}t.precalculateMapPreviewScale=a,t.playSceneToLevelDetailTransition=function(){s.inject.scene.playUI.activeUI.transitionOut();const e=s.inject.scene.levelDetailUI,t=s.inject.scene.menuHeaderUI,i=s.inject.config.screenTransitionDuration,n=s.inject.scene.worldMap;return n.scene.setVisible(!0),e.mapPreviewLoader.pause(),e.updateCardsInView(),e.centralCard.content.mapPreview?.setVisible(!1),new Promise((s=>{e.preUpdate.makeDirty(),e.preUpdate();const o=a();n.cameraController.center(i,1/o),e.tweens.add({targets:[e.centralCard],props:{alpha:{from:0,to:1}},duration:i,onComplete:s}),e.leftCard&&e.tweens.add({targets:e.leftCard,props:{x:{from:e.scrollController.cameraX.value-e.layout.cardWidth-10,to:e.leftCard.x}},duration:i,ease:"Sine.easeOut"}),e.rightCard&&e.tweens.add({targets:e.rightCard,props:{x:{from:e.scrollController.cameraX.value+e.bounds.width+10,to:e.rightCard.x}},duration:i,ease:"Sine.easeOut"}),t.slideIn()})).then((()=>{n.chunksRenderingController.renderEverything(),e.centralCard.content.loadMapPreviewFromWorldMap(),n.scene.setVisible(!1),e.centralCard.content.mapPreview?.setVisible(!0)}))}},96873:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelSelectScreen=void 0;const s=i(83928),n=i(84612),a=i(71203),o=i(18995),r=i(33135),c=i(56524);class l extends s.BaseScreen{constructor(){super("LevelSelect",[n.Scenes.LevelSelectUI,n.Scenes.MenuHeaderUI]),this.handleEventWhileActive(o.UserActions.GoBack,(()=>{a.inject.navigator.goTo(a.inject.screen.title)})),this.handleEventWhileActive(o.UserActions.GoToLevelDetail,(async({levelId:e})=>{const t=a.inject.ui.selectedCampaign()?.levels.findIndex((t=>t.id===e));a.inject.ui.selectedLevelId.set(e),a.inject.navigator.goTo(a.inject.screen.levelDetail,(()=>(0,c.transitionToLevelDetail)(t)))})),this.handleEventWhileActive(o.UserActions.Escape,(async()=>{a.inject.events.trigger(o.UserActions.GoBack())}))}async transitionOut(e){if(e===a.inject.screen.title)return(0,r.levelSelectOutTransition)()}async activate(e){await super.activate(e);const t=a.inject.ui.selectedCampaign();t&&(a.inject.scene.menuHeaderUI.state.update({icon:"ui/icons/campaign",title:t.name,backButtonTitle:"MAIN MENU"}),a.inject.scene.levelSelectUI.loadCampaign(t))}}t.LevelSelectScreen=l},56118:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SmallLevelCardContent=t.SmallLevelCard=t.LevelSelectUIScene=void 0;const s=i(84612),n=i(71203),a=i(48565),o=i(44031),r=i(18995),c=i(10445),l=i(1532),d=i(82260),h=i(1157),u=i(9724),g=i(95569),p=i(96532),m=i(1663),y=i(52700),f=i(86273),w=i(1951),b=i(9095);var v=Phaser.GameObjects.BitmapText,S=Phaser.GameObjects.Image;const P=100;class T extends u.BaseUIScene{constructor(){super({key:s.Scenes.LevelSelectUI}),this.levelCards=[],this.preUpdate=(0,a.whenDirty)((()=>{n.inject.device.screenWidth,n.inject.device.screenHeight;const e=f.Padding.large,t=f.Padding.large,i=Math.floor((this.bounds.contentWidth-e)/(P+t)),s=Math.ceil(this.levelCards.length/i);for(let n=0;n<s;++n){const s=this.levelCards.slice(n*i,(n+1)*i);o.Arrange.horizontally({content:s.map((e=>({object:e}))),spacing:t,x:this.bounds.centerX,origin:.5}),o.Arrange.alignHorizontally(s,{y:y.MenuHeaderUIScene.Layout.panelHeight+e+n*(P+t),origin:0})}}))}get maxScrollY(){const e=this.levelCards[this.levelCards.length-1];return e?(0,w.max)(0,e.y+e.height+f.Padding.large-this.bounds.height):0}create(){super.create(),this.scrollController=new m.ScrollableViewController(this.cameras.main,{horizontal:!1,vertical:!0,deadzone:50,continueToNextStopThreshold:1e3,verticalStops:{getNextFrom:e=>e<0?0:void 0,getPreviousFrom:e=>e>this.maxScrollY?this.maxScrollY:void 0}}),this.bindKey(d.Input.Keyboard.KeyCodes.ESC,r.UserActions.GoBack)}loadCampaign(e){for(let e of this.levelCards)e.destroy();this.levelCards.forEach((e=>e.destroy(!0))),this.levelCards=e.levels.map(((e,t)=>new x(this,(0,p.getLevelIcon)(e.id),(t+1).toString(),(async()=>{this.scrollController.dragging||(n.inject.audio.playEffect(b.SoundEffects.ButtonUp),n.inject.events.trigger(r.UserActions.GoToLevelDetail({levelId:e.id})))})))),this.addAll(this.levelCards),this.preUpdate.makeDirty()}}t.LevelSelectUIScene=T,T.Layout={cardSpacing:30};class x extends l.Card{constructor(e,t,i,s){super(e,{onClick:s,radius:20,clickable:l.CardPointerInputMode.Whole}),this.content=new M(e,this,t,i),this.setSize(P,P),this.footerSize=32}}t.SmallLevelCard=x;class M extends g.ResponsiveContainer{constructor(e,t,i,s){super(e),this.card=t,this._icon=new S(e,0,0,"atlas",i).setOrigin(.5,.5),this._text=new v(e,0,0,h.BitmapFont.Main,s).setOrigin(.5,0).setTint(c.Colors.glassUi.primaryText),this.add([this._icon,this._text])}setIcon(e){this._icon.setFrame(e),this.preUpdate.makeDirty()}setText(e){this._text.setText(e),this.preUpdate.makeDirty()}updateLayout(){super.updateLayout(),this._icon.setPosition(this.width/2,(this.height-this.card.footerSize)/2),this._text.setPosition(this.width/2,this.height-this._text.height-4)}}t.SmallLevelCardContent=M},33135:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.levelSelectOutTransition=void 0;const s=i(71203);t.levelSelectOutTransition=function(){const e=s.inject.scene.levelSelectUI,t=s.inject.config.screenTransitionDuration;return new Promise((i=>{e.tweens.add({targets:e.levelCards,y:"+="+s.inject.device.screenHeight,delay:(i,s,n,a)=>(e.levelCards.length-a)*(t/100),duration:t,ease:"Sine.easeIn",onComplete:i})}))}},56524:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.transitionToLevelDetail=void 0;const s=i(71203),n=i(52163);t.transitionToLevelDetail=function(e=0){e<0&&(console.warn(`invalid cardIndex ${e}, replacing with 0`),e=0);const t=s.inject.scene.levelSelectUI,i=s.inject.scene.levelDetailUI,a=s.inject.scene.worldMap,o=s.inject.config.screenTransitionDuration;return a.scene.setVisible(!1),i.preUpdate(),new Promise((a=>{const r=t.levelCards[e];(0,n.assert)(r,`targetCard not found for index ${e}`);let c=[],l=[],d=[],h=[];for(let i=0;i<t.levelCards.length;++i){const s=t.levelCards[i];s.y<r.y?c.push(s):s.y>r.y?l.push(s):i<e?d.push(s):i>e&&h.push(s)}t.tweens.add({targets:[...d,r,...h],props:{x:(e,t,s,n)=>i.layout.cardLeft(c.length+n)-i.scrollController.cameraX.value,y:i.layout.cardTop,width:i.layout.cardWidth,height:i.layout.cardHeight,footerSize:i.layout.cards.footerSize,radius:i.layout.cards.radius},duration:o,ease:"Sine.easeOut",onComplete:a});const u=t.levelCards[e];i.tweens.add({targets:i.centralCard,props:{x:{from:u.x+i.scrollController.cameraX.value,to:i.layout.cardLeft(e)},y:{from:u.y,to:i.layout.cardTop},width:{from:u.width,to:i.layout.cardWidth},height:{from:u.height,to:i.layout.cardHeight},footerSize:{from:u.footerSize,to:i.layout.cards.footerSize},radius:{from:u.radius,to:i.layout.cards.radius},alpha:{from:0,to:1}},duration:o,ease:"Sine.easeOut"}),i.leftCard?.setVisible(!1),i.rightCard?.setVisible(!1),t.tweens.add({targets:c,y:"-="+r.y,duration:o,ease:"Sine.easeOut"}),t.tweens.add({targets:l,y:"+="+(s.inject.device.screenHeight-r.y),duration:o,ease:"Sine.easeOut"})})).then((()=>{i.leftCard?.setVisible(!0),i.rightCard?.setVisible(!0)}))}},95306:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EDITOR_TOOL=void 0;const s=i(23939),n=i(83967),a=i(51995),o=i(71671),r=i(53854),c=i(32009),l=i(10433);t.EDITOR_TOOL={deleteTile:new s.DeleteTileTool,paintRegion:[1,2,3,4,5,6].map((e=>new n.PaintRegionTool(e))),paintSoldier:new a.PaintSoldierTool,paintTown:new o.PaintTownTool,paintForest:new l.PaintForestTool,paintCastle:new c.PaintCastleTool,addCoins:new r.CoinsTool}},2309:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorPalette=void 0;const s=i(82260),n=i(75255),a=i(95306),o=i(57557),r=i(71203);class c extends n.Palette{constructor(e,t){const i={},n=(t,s,n)=>(i[n||s]=t,{image:t.createIcon(e),hotkey:s,value:t});super(e,{spacing:4,items:[[...a.EDITOR_TOOL.paintRegion.map(((e,t)=>n(e,(t+1).toString(),s.Input.Keyboard.KeyCodes.ONE+t)))],[n(a.EDITOR_TOOL.deleteTile,"Q"),n(a.EDITOR_TOOL.paintSoldier,"W"),n(a.EDITOR_TOOL.paintTown,"E"),n(a.EDITOR_TOOL.paintForest,"R"),n(a.EDITOR_TOOL.addCoins,"T"),n(a.EDITOR_TOOL.paintCastle,"A")]],onItemSelected:e=>r.inject.events.trigger(o.MapEditorActions.SetTool(e))}),Object.entries(i).forEach((([t,i])=>{e.input.keyboard.addKey(t).on("down",(()=>{this.select(i),r.inject.events.trigger(o.MapEditorActions.SetTool(i))}))})),this.select(t)}}t.MapEditorPalette=c},64492:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorPointerEventsController=t.EditorPointerState=void 0;const s=i(62199),n=i(71203);var a;!function(e){e.Idle="idle",e.CameraHoldDrag="camera-drag",e.Paint="paint"}(a=t.EditorPointerState||(t.EditorPointerState={})),s.logger.for("ui:MapEditorPointerEventsController"),t.MapEditorPointerEventsController=class{constructor(e){this.actionImpls=e,this.pointerState=a.Idle}startPaint(){this.setState(a.Paint)}startCameraDrag(){n.inject.scene.worldMap.cameraController.startDragScroll(),this.setState(a.CameraHoldDrag)}stop(){this.pointerState===a.CameraHoldDrag&&n.inject.scene.worldMap.cameraController.stopDragScroll(),this.pointerState=a.Idle}setState(e){e!==this.pointerState&&(this.pointerState=e,e!==a.Idle?n.inject.debugData.set("editorScene.pointerState",e):n.inject.debugData.clear("editorScene.pointerState"))}}},57557:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorScene=t.MapEditorInputMode=t.MapEditorActions=t.editorAction=void 0;const s=i(27358),n=i(84612),a=i(71203),o=i(62199),r=i(70780),c=i(23803),l=i(18995),d=i(10780),h=i(2309),u=i(84080),g=i(95306),p=i(64492),m=i(76733),y=i(82260),f=i(97306),w=i(15641),b=i(1157),v=i(10445),S=i(9724),P=i(48565);var T=Phaser.GameObjects.BitmapText;const x=20,M=360;function C(e){return(0,r.createEventFactory)(r.EventCategory.MapEditor,e)}var I;t.editorAction=C,t.MapEditorActions={SetTool:C("SET_TOOL")},(I=t.MapEditorInputMode||(t.MapEditorInputMode={})).PaintFaction="pain-faction",I.PaintPawns="paint-pawns",I.DeletePawns="delete-objects",I.DeleteTiles="delete-tiles",I.AddCoins="add-coins",I.RemoveCoins="remove-coins",o.logger.for(n.Scenes.MapEditor);class A extends S.BaseUIScene{constructor(){super({key:n.Scenes.MapEditor}),this.preUpdate=(0,P.whenDirty)((()=>{})),this.currentTool=g.EDITOR_TOOL.paintRegion[0],this.cursorAttachment=new u.CursorAttachment(this),this.pointerController=new p.MapEditorPointerEventsController({tryStartCameraDrag:()=>!0,endCameraDrag:()=>{this.worldMapScene.cameraController.stopDragScroll()},tryStartPaint:()=>!0,endPaint:()=>{}}),this.handleEventWhileActive(s.WorldMapEvents.StartDrag,(({hexId:e,flags:t})=>{if(!this.scene.isActive()||!e)return;const i=(0,c.getHex)(e);t&s.PointerEventFlags.RightButton?this.pointerController.startCameraDrag():(this.pointerController.startPaint(),i&&this.applyCurrentTool(i))})),this.handleEventWhileActive(s.WorldMapEvents.EndDrag,(e=>{this.pointerController.stop()})),this.watchWhileActive(a.inject.ui.hexUnderCursor,(e=>{e&&this.pointerController.pointerState===p.EditorPointerState.Paint&&this.applyCurrentTool(e)})),this.handleEventWhileActive(l.GameEvents.NewGameState,(({state:e})=>{this.worldMapScene.loadNewGameState(e)})),a.inject.events.on(t.MapEditorActions.SetTool,(e=>{this.handleToolSelected(e)}))}createButton(e,t){const i=new w.BoxButton(this,0,x,{content:new T(this,0,0,b.BitmapFont.Small,e).setTint(v.Colors.woodenUi.primaryText),baseTexture:d.BoxTexture.DialogButton,downTexture:d.BoxTexture.DialogButtonDown,width:102,height:36});return i.onClicked(t),i}create(){super.create(),this.worldMapScene=this.scene.get(n.Scenes.WorldMap),this.resumeButton=this.createButton("PLAY",(()=>{a.inject.events.trigger(l.UserActions.ResumeGame())})),this.newGameButton=this.createButton("NEW",(()=>{a.inject.events.trigger(l.UserActions.OpenNewGameDialog())})).setTextTint(4461331).setTint(16750968),this.exportButton=this.createButton("EXPORT",(()=>{a.inject.events.trigger(l.UserActions.OpenExportMapDialog())})).setTextTint(2376723).setTint(10026855),this.importButton=this.createButton("IMPORT",(()=>{a.inject.events.trigger(l.UserActions.OpenLoadGameDialog())})).setTextTint(4461331).setTint(16750968),this.jsonEditButton=this.createButton("EDIT JSON",(()=>{a.inject.events.trigger(l.UserActions.EditMapJSON())})),this.backgroundPlate=new d.Box(this,d.BoxTexture.Plate),this.backgroundPlate.setInteractive(),this.palette=new h.MapEditorPalette(this,this.currentTool),this.currentToolDescription=new m.Label(this,""),this.handleToolSelected(this.currentTool),this.add.existing(this.backgroundPlate);const e=[this.palette,this.currentToolDescription];this.addAll([...e,this.jsonEditButton,this.resumeButton,this.importButton,this.newGameButton,this.exportButton]),this.scale.on("resize",(()=>this.reflow())),this.reflow(),this.input.keyboard.addKey(y.Input.Keyboard.KeyCodes.BACKTICK).on("down",(()=>{a.inject.gameStateController.undo()})),a.inject.gameStateController.onEvent((e=>{this.scene.isActive()&&(0,r.isEvent)(e,l.GameEvents.NewGameState)&&this.worldMapScene.loadNewGameState(e.payload.state)}))}update(){this.cursorAttachment.update()}updateToolDescription(){this.currentToolDescription.setText(`${this.currentTool?.description||""}\n~ = undo\nhold right mouse button to drag view`)}handleToolSelected(e){this.currentTool=e,this.cursorAttachment.setImage(this.createCursorAttachmentImage(e)),this.updateToolDescription()}createCursorAttachmentImage(e){const t=e.createIcon(this);return t.setScale(.5*t.scaleX,.5*t.scaleY),t}applyCurrentTool(e){if(!this.currentTool)return;if(e.isAtGridBorder(a.inject.gameStateModel.map))return;const t=a.inject.gameStateModel.state,{shift:i,ctrl:s}=this.worldMapScene.keys;this.currentTool.useOn(e,{shift:i.isDown,ctrl:s.isDown}),t!==a.inject.gameStateModel.state&&(a.inject.gameStateController.addStateToUndoHistory(t),this.updateWorld())}updateWorld(){a.inject.ui.withoutTransitions((()=>{this.worldMapScene.loadNewGameState(a.inject.gameStateModel.state)}))}reflow(){const e=this.cameras.main.displayWidth,t=this.cameras.main.displayHeight;this.resumeButton.setPosition(e-this.resumeButton.width-x,x),this.jsonEditButton.setPosition(this.resumeButton.x-8-this.jsonEditButton.width,this.resumeButton.y),this.backgroundPlate.setPosition(e-M,0),this.backgroundPlate.setSize(M,t),this.palette.setPosition(e-M+x,100),this.palette.preUpdate.force(),console.log("USING PALETTE HEIGHT",this.palette.height),this.currentToolDescription.setPosition(e-M+x,this.palette.y+this.palette.height+20),(0,f.layoutFromLeftToRight)(e-M+x,t-x-this.newGameButton.height,8,[this.newGameButton,this.importButton,this.exportButton])}}t.MapEditorScene=A},79036:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorScreen=void 0;const s=i(84612),n=i(83928),a=i(71203),o=i(18995),r=i(83367),c=i(39999);class l extends n.BaseScreen{constructor(){super("MapEditor",[s.Scenes.WorldMap,s.Scenes.MapEditor]),this.handleEventWhileActive(o.UserActions.ResumeGame,(()=>{a.inject.userData.saveNewLevel(),a.inject.screen.play.activationContext=c.NewGameStateContext.ResumingGame,a.inject.navigator.goTo(a.inject.screen.play)})),this.handleEventWhileActive(o.UserActions.Escape,(async()=>{a.inject.events.trigger(o.UserActions.ResumeGame())}))}async activate(){a.inject.scene.worldMap.setMode(new r.EditorMode),a.inject.scene.worldMap.cameraController.setViewportMargins({right:300})}deactivate(){}}t.MapEditorScreen=l},53854:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinsTool=void 0;const s=i(71203),n=i(73508);var a=Phaser.GameObjects.Image;t.CoinsTool=class{constructor(){this.description="click = add coin\nctrl-click = remove coin\nshift-click = add 5 coins"}createIcon(e){return new a(e,0,0,"atlas","ui/budget-icons/neutral")}useOn(e,t){const i=s.inject.gameStateModel,a=i.regions.byHex(e);if(!a)return;const o=i.pawns.findClosest(e,a.hexes,(e=>e.type===n.PawnType.Town||e.type===n.PawnType.Camp));if(!o)return;const r=function(e,t){const i=t.shift?5:1,s=t.ctrl?-1:1;return Math.max(0,e+i*s)}(i.pawns.getCount(o.hex,n.PawnType.Coins),t);i.pawns.setCount(o.hex,n.PawnType.Coins,r)}}},23939:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deleteTile=t.DeleteTileTool=void 0;const s=i(71203);var n=Phaser.GameObjects.Image;function a(e){const t=s.inject.gameStateModel,i=t.regions.byHex(e),n=t.factions.byHex(e);i&&n&&(t.pawns.destroy(...t.pawns.byHex(e)),t.regions.byHex(e).removeHexes(e),n.splitRegionIfDisconnected(i))}t.DeleteTileTool=class{constructor(){this.description="click = delete tile\nshift-click = delete objects"}createIcon(e){return new n(e,0,0,"atlas","editor/delete-tile-icon")}useOn(e,t){t.shift?function(e){const t=s.inject.gameStateModel;t.pawns.destroy(...t.pawns.byHex(e))}(e):a(e)}},t.deleteTile=a},32009:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintCastleTool=void 0;const s=i(71203),n=i(73508),a=i(92940);var o=Phaser.GameObjects.Image;t.PaintCastleTool=class{constructor(){this.description="click = add castle\nctrl-click = remove castle"}createIcon(e){return new o(e,0,0,"atlas","pawns/castle").setScale(.5,.5)}useOn(e,t){const i=s.inject.gameStateModel,o=i.pawns.byHex(e).find((e=>e.hasTrait(a.PawnTraits.OccupiesTile)));i.regions.byHex(e)&&(t.ctrl?o&&o.destroy():o?o.type!==n.PawnType.Castle&&o.replaceWith(n.PawnType.Castle):i.pawns.create({hex:e,type:n.PawnType.Castle}))}}},10433:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintForestTool=void 0;const s=i(23939),n=i(24011),a=i(92940),o=i(73508),r=i(71203);var c=Phaser.GameObjects.Image;t.PaintForestTool=class{constructor(){this.description="click = add forest tile\nctrl-click = delete tile"}createIcon(e){return new c(e,0,0,"atlas","editor/tree")}useOn(e,t){(0,s.deleteTile)(e);const i=r.inject.gameStateModel,c=i.pawns.byHex(e).find((e=>e.hasTrait(a.PawnTraits.OccupiesTile)));t.ctrl?(c&&c.destroy(),i.pawns.findOne({hexes:e,type:[o.PawnType.Coins]})?.destroy()):c?(i.factions.byId(n.SpecialFaction.neutral).captureHex(e),c.type!==o.PawnType.Forest&&c.replaceWith(o.PawnType.Forest)):(i.factions.byId(n.SpecialFaction.neutral).captureHex(e),i.pawns.create({hex:e,type:o.PawnType.Forest}))}}},83967:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintRegionTool=void 0;const s=i(71203),n=i(24011);var a=Phaser.GameObjects.Image;t.PaintRegionTool=class{constructor(e){this.factionId=e,this.description=`click = assign faction ${this.factionId}\nctrl-click = delete`}createIcon(e){return new a(e,0,0,"atlas","editor/tile-icon").setTint(s.inject.gameStateModel.factions.byId(this.factionId)?.landColor??16777215)}useOn(e,t){const i=s.inject.gameStateModel.factions.byHex(e)?.id;if(t.ctrl){if(i===n.SpecialFaction.neutral)return;s.inject.gameStateModel.factions.byId(n.SpecialFaction.neutral).captureHex(e),s.inject.gameStateModel.pawns.byHex(e).forEach((e=>e.destroy()))}else{if(i===this.factionId)return;s.inject.gameStateModel.factions.byId(this.factionId)?.captureHex(e),i===n.SpecialFaction.neutral&&s.inject.gameStateModel.pawns.byHex(e).forEach((e=>e.destroy()))}}}},51995:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintSoldierTool=void 0;const s=i(71203),n=i(73508),a=i(92940);var o=Phaser.GameObjects.Image;t.PaintSoldierTool=class{constructor(){this.description="click = add/upgrade unit\nctrl-click = downgrade/remove unit"}createIcon(e){return new o(e,0,0,"atlas","pawns/villager").setScale(.5,.5)}useOn(e,t){const i=s.inject.gameStateModel,n=i.pawns.byHex(e).find((e=>e.hasTrait(a.PawnTraits.OccupiesTile))),o=t.ctrl?this.getDownGradedUnitType(n?.type):this.getUpgradedUnitType(n?.type);i.regions.byHex(e)&&(o?n?n.type!==o&&n.replaceWith(o):i.pawns.create({hex:e,type:o}):n&&n.destroy())}getUpgradedUnitType(e){switch(e){case n.PawnType.Villager:return n.PawnType.Pikeman;case n.PawnType.Pikeman:return n.PawnType.Knight;case n.PawnType.Knight:case n.PawnType.Hero:return n.PawnType.Hero;default:return n.PawnType.Villager}}getDownGradedUnitType(e){switch(e){case n.PawnType.Bandit:return;case n.PawnType.Villager:return n.PawnType.Bandit;case n.PawnType.Pikeman:return n.PawnType.Villager;case n.PawnType.Knight:return n.PawnType.Pikeman;case n.PawnType.Hero:return n.PawnType.Knight;default:return n.PawnType.Bandit}}}},71671:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintTownTool=void 0;const s=i(71203),n=i(73508),a=i(92940),o=i(24011);var r=Phaser.GameObjects.Image;t.PaintTownTool=class{constructor(){this.description="click = add town\nctrl-click = remove town"}createIcon(e){return new r(e,0,0,"atlas","pawns/town-1").setScale(.5,.5)}useOn(e,t){const i=s.inject.gameStateModel;if(!i.regions.byHex(e))return;const r=i.factions.byHex(e)?.id===o.SpecialFaction.neutral?n.PawnType.Camp:n.PawnType.Town,c=i.pawns.byHex(e).find((e=>e.hasTrait(a.PawnTraits.OccupiesTile)));t.ctrl?(c&&c.destroy(),i.pawns.findOne({hexes:e,type:[n.PawnType.Coins]})?.destroy()):c?c.type!==n.PawnType.Town&&c.replaceWith(r):i.pawns.create({hex:e,type:r})}}},10068:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapGenerationScreen=void 0;const s=i(84612),n=i(83928),a=i(71203),o=i(18995),r=i(39999),c=i(99809);class l extends n.BaseScreen{constructor(){super("MapEditor",[s.Scenes.WorldMap]),this.handleEventWhileActive(o.UserActions.ResumeGame,(()=>{a.inject.userData.saveNewLevel(),a.inject.screen.play.activationContext=r.NewGameStateContext.ResumingGame,a.inject.navigator.goTo(a.inject.screen.play)})),this.handleEventWhileActive(o.UserActions.Escape,(async()=>{a.inject.events.trigger(o.UserActions.ResumeGame())}))}async activate(){a.inject.scene.worldMap.setMode(new c.PreviewMode)}deactivate(){}}t.MapGenerationScreen=l},29323:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isRegionControllable=t.PlayScene=void 0;const s=i(71203),n=i(84612),a=i(18995),o=i(62199),r=i(44976),c=i(67060),l=i(85170),d=i(6961),h=i(2011),u=i(70780),g=i(39999),p=i(80266),m=i(73664),y=i(68714),f=o.logger.for("ui:PlayScene");class w extends r.BaseScene{constructor(){super({key:n.Scenes.Play}),this.gameEventsBus=new c.TypedEventBus,this.mode=new y.PassiveMode(this)}setMode(e){f.info(`⚙ entering ${e.name} (from ${this.mode.name})`),this.mode.deactivate(),this.mode=e,s.inject.debugData.set("playScene.mode",this.mode.name),e.activate(),e.handleNewHexUnderCursor(s.inject.ui.hexUnderCursor())}create(){super.create(),this.load.multiatlas("gameOverAtlas","assets/gameOverAtlas.json","assets"),this.load.start(),this.gameEventQueue=s.inject.gameStateController.getEventQueue(),this.events.on("destroy",(()=>{this.gameEventQueue.unsubscribe()})),this.worldMapScene=this.scene.get(n.Scenes.WorldMap),this.debugScene=this.scene.get(n.Scenes.Debug),this.uiScene=this.scene.get(n.Scenes.PlayUI),this.gameEventsBus.setDefaultHandler((async(e,t)=>(0,u.isEvent)(e,a.GameEvents.NewGameState)?(0,l.handleNewGameState)(this,e.payload):(0,u.isEvent)(e,a.GameEvents.FactionTurnStarted)?(0,d.handleFactionTurnStarted)(this,e.payload):(0,u.isEvent)(e,a.GameEvents.GameOver)?this.handleGameOver(e.payload):void await this.mode.handleGameEvent(e)))}skipToCurrentState(e=g.NewGameStateContext.ResumingGame){this.gameEventQueue.clear();const t=s.inject.gameStateModel.state;(0,l.handleNewGameState)(this,{state:t,context:e}),(0,d.handleFactionTurnStarted)(this,{state:t,factionId:h.CurrentPhase.getFaction(t)})}update(){for(;this.gameEventQueue.hasNext()&&this.mode.isReadyForMoreGameEvents();){const e=this.gameEventQueue.next();this.gameEventsBus.trigger(e),s.inject.events.trigger(e),s.inject.scene.worldMap.runIntegrityChecks()}s.inject.debugData.set("playScene.mode",`${this.mode.name} (${this.mode.isReadyForMoreGameEvents()?"ready":"processing event"})`)}dropHeldPawnAtHex(e){return new Promise((t=>{const i=this.worldMapScene.getPawnObjectPositionOnScreen(e);this.uiScene.pawnHolder.dropPawn(i.x,i.y,i.scale,t)}))}refreshTownVariantInRegions(e){for(let t of e){const e=t.getTownHexes();s.inject.scene.worldMap.pawns.syncPawnVariant(new m.StaticGameStateModel(t.state),e)}}handleGameOver(e){const t=1===e.winningFactionId?p.LevelOutcome.Victory:p.LevelOutcome.Defeat;s.inject.events.trigger(a.UserActions.GameOver(t))}}t.PlayScene=w,t.isRegionControllable=function(e){if(!e)return!1;const t=s.inject.gameStateModel;return t.factions.byRegion(e)===t.currentPhase.faction&&t.economy.townHexesOf(e).length>0}},19121:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Cheats=t.PlayScreen=void 0;const s=i(84612),n=i(83928),a=i(71203),o=i(18995),r=i(76344),c=i(68714),l=i(39999),d=i(13933),h=i(20069),u=i(80266),g=i(91763),p=i(24909),m=i(56849),y=i(84809),f=i(65641),w=i(10445),b=i(29323),v=i(62199),S=i(9095),P=i(36504),T=i(88755),x=i(35171),M=i(62136),C=i(38735),I=i(81183),A=i(90862),B=i(34594),j=i(59286),_=i(27358),E=i(23803),R=i(94459);v.logger.for("PlayScreen");class O extends n.BaseScreen{constructor(){super("Play",[s.Scenes.Play,s.Scenes.PlayUI,s.Scenes.WorldMap]),this.selectedRegionId=(0,f.watchable)(void 0),this.activationContext=l.NewGameStateContext.ResumingGame,this.handleEventWhileActive(o.UserActions.GoBack,(async()=>{a.inject.userData.saveLevelProgress();const e=y.LevelModel.for(a.inject.ui.playedLevelId());C.track.levelLeave({level_id:e.id}),await(0,d.returnToMenuFromGame)()})),this.handleEventWhileActive(o.UserActions.Escape,(async()=>{this.currentMode.handleAbort()})),this.handleEventWhileActive(o.UserActions.Cancel,(async()=>{a.inject.scene.playUI.activeUI.closeRollbackPanel()})),this.handleEventWhileActive(o.UserActions.EndTurn,(()=>{a.inject.config.autoSaveOnTurnEnd&&a.inject.userData.saveLevelProgress()})),this.handleEventWhileActive(o.UserActions.Undo,(()=>{a.inject.gameStateController.undo()})),this.handleEventWhileActive(o.UserActions.RollbackTurn,(()=>{this.rewindTurn()})),this.handleEventWhileActive(o.UserActions.RestartLevel,(()=>{a.inject.modals.show(p.UI.restartGameDialog,{message:"Are you sure you want to restart? You will loose all previous progress on this island!"},(e=>{if(e===m.DialogButtons.Restart){const e=a.inject.gameStateModel.map.levelId;a.inject.userData.deleteSavedGame(e,u.SaveGameTags.Autosave),a.inject.events.trigger(o.UserActions.PlayLevel({levelId:e})),a.inject.audio.playEffect(S.SoundEffects.Rewind)}}))})),this.handleEventWhileActive(o.UserActions.GameOver,(async e=>{a.inject.userData.saveLevelOutcome(e),e===u.LevelOutcome.Victory?a.inject.navigator.goTo(a.inject.screen.victory,g.victoryTransition):a.inject.navigator.goTo(a.inject.screen.defeat,I.defeatTransition)})),this.handleEventWhileActive(o.UserActions.DeselectRegion,(()=>{this.selectRegion(void 0,{panCamera:!1,clickEffect:!1})})),this.handleEventWhileActive(o.UserActions.SelectNextRegion,(()=>{const e=a.inject.ui.regionsLedger.getNext(a.inject.screen.play.selectedRegionId());this.selectRegion(e,{panCamera:!0,clickEffect:!0})})),this.handleEventWhileActive(o.UserActions.SelectPreviousRegion,(()=>{const e=a.inject.ui.regionsLedger.getPrevious(a.inject.screen.play.selectedRegionId());this.selectRegion(e,{panCamera:!0,clickEffect:!0})})),this.handleEventWhileActive(o.UserActions.SelectNextPendingRegion,(()=>{const e=a.inject.ui.regionsLedger.getNextPendingRegionId();this.selectRegion(e,{clickEffect:!1,panCamera:!0})})),this.handleEventWhileActive(o.UserActions.SetSpectatingPlayBackSpeed,(e=>{this.currentMode instanceof A.SpectatorMode&&(0,A.updateTransitionSpeedForSpectatorMode)(e)})),this.handleEventWhileActive(_.WorldMapEvents.StartInteraction,(e=>{const i=e.hexId&&(0,E.getHex)(e.hexId);i&&a.inject.config.debug.cheats&&e.flags&_.PointerEventFlags.MiddleButton?t.Cheats.toggleTapped(i):(a.inject.device.uiVariant()!==R.UiVariant.Compact&&a.inject.scene.playUI.activeUI.closeRollbackPanel(),e.flags&_.PointerEventFlags.RightButton&&this.currentMode.canReturnPawn()?this.currentMode.handleReturnPawn():this.currentMode.handleStartInteraction((0,E.getHex)(e.hexId),e.flags))})),this.handleEventWhileActive(_.WorldMapEvents.CompleteInteraction,(e=>{e.flags&_.PointerEventFlags.RightButton||this.currentMode.handleCompleteInteraction((0,E.getHex)(e.hexId),e.flags)})),this.handleEventWhileActive(_.WorldMapEvents.StartDrag,(e=>{e.hexId?this.currentMode.handleStartDrag((0,E.getHex)(e.hexId)):a.inject.scene.worldMap.cameraController.startDragScroll()})),this.handleEventWhileActive(_.WorldMapEvents.EndDrag,(e=>{this.currentMode.handleEndDrag((0,E.getHex)(e.hexId))})),this.handleEventWhileActive(o.UserActions.BuyablePawnPointerDown,(e=>{this.currentMode.handlePawnInShopPointerDown(e)})),this.handleEventWhileActive(o.UserActions.BuyablePawnPointerUp,(e=>{this.currentMode.handlePawnInShopPointerUp(e)})),this.handleEventWhileActive(o.UserActions.ShopAreaPointerUp,(e=>{this.currentMode.handleShopAreaPointerUp()})),this.handleEventWhileActive(o.UserActions.ReturnHeldPawn,(()=>{this.currentMode.handleReturnPawn()})),this.handleEventWhileActive(o.UserActions.EndTurn,(()=>{this.currentMode.handleEndTurn()})),this.watchWhileActive(a.inject.ui.hexUnderCursor,(e=>{this.currentMode.handleNewHexUnderCursor(e)})),this.handleEventWhileActive(o.UserActions.SkipSpectating,(()=>{this.currentMode.handleSkipSpectating(),a.inject.scene.playUI.updateState({enableSkipSpectating:!1})}))}get currentMode(){return a.inject.scene.play.mode}get selectedRegion(){const e=this.selectedRegionId();if(void 0!==e)return a.inject.gameStateModel.regions.byId(e)}async activate(){const e=a.inject.scene.play;this.activationContext===l.NewGameStateContext.StartingNewGame&&(this.remainingLives=j.DEFAULT_LIVES_PER_LEVEL),a.inject.scene.worldMap.setMode(new r.InteractiveMode),e.skipToCurrentState(this.activationContext);const t=a.inject.gameStateModel.map.levelId;a.inject.ui.playedLevelId.set(t),a.inject.ui.selectedLevelId.set(t),a.inject.ui.regionsLedger.reset(a.inject.gameStateModel.state);const i=y.LevelModel.for(t);a.inject.scriptRunner.setScript(i.campaignContext?.levelData.script??"global"),this.selectRegion(a.inject.ui.regionsLedger.getNextPendingRegionId(),{clickEffect:!1,panCamera:!1})}deactivate(){a.inject.scene.play.setMode(new c.PassiveMode(a.inject.scene.play)),a.inject.scriptRunner.setScript(void 0)}async transitionIn(e){e===a.inject.screen.levelDetail?a.inject.scene.playUI.activeUI.transitionIn():(a.inject.scene.playUI.activeUI.transitionIn(),a.inject.scene.worldMap.cameraController.center(a.inject.config.screenTransitionDuration,1))}async transitionOut(e){return e===a.inject.screen.levelDetail?(0,h.playSceneToLevelDetailTransition)():a.inject.scene.playUI.activeUI.transitionOut()}selectRegion(e,t={panCamera:!1,clickEffect:!0}){const i=this.selectedRegionId();this.selectedRegionId.set(e),void 0!==e&&a.inject.ui.regionsLedger.regionVisited(e);const s=void 0!==e&&a.inject.gameStateModel.regions.byId(e),n=e?a.inject.gameStateModel.regions.byId(e):void 0,o=i?a.inject.gameStateModel.regions.byId(i):void 0,r=(0,b.isRegionControllable)(n);if(o&&M.WorldMapUpdater.refreshTownFlagsAndBacklightInRegion(o),n&&n.faction&&n.faction===a.inject.gameStateModel.currentPhase.faction&&(M.WorldMapUpdater.refreshTownFlagsAndBacklightInRegion(n),M.WorldMapUpdater.setPawnsJumpingInRegion(n,!0)),M.WorldMapUpdater.showWorldMapOverlaysBasedOnSelectedRegion(),a.inject.scene.worldMap.setSelectedRegion(n,r?w.Colors.highlight.ownedRegion:w.Colors.highlight.hostileRegion),a.inject.scene.playUI.updateFromGameState(),t.clickEffect&&s&&a.inject.audio.playEffect(S.SoundEffects.ShutterClick),t.panCamera&&s){const e=(0,P.rectToPhaser)(s.hexes.boundingBox());a.inject.scene.worldMap.cameraController.ensureRectVisible(e)}}setConquerableHexesBasedOnSelectedRegion(){const e=a.inject.screen.play.selectedRegion;if(!e)return this.clearConquerableHexes();const t=e.getMovableUnitsByMight().getStrongest();this.conquerableHexes=a.inject.gameStateModel.warfare.getConquerableHexes(e,t),a.inject.scene.worldMap.conquerableHexesHighlight.set(this.conquerableHexes,T.DEFAULT_TINT,.5),M.WorldMapUpdater.showAttitudeEmojis(a.inject.gameStateModel.currentPhase.faction)}clearConquerableHexes(){this.conquerableHexes=x.HexGroup.empty,a.inject.scene.worldMap.conquerableHexesHighlight.set(this.conquerableHexes)}showConquerableHexesBasedOn(e){const t=a.inject.screen.play.selectedRegion;t?(this.conquerableHexes=a.inject.gameStateModel.warfare.getConquerableHexes(t,e),a.inject.scene.worldMap.conquerableHexesHighlight.set(this.conquerableHexes)):a.inject.scene.worldMap.conquerableHexesHighlight.clear()}rewindTurn(){(this.remainingLives>0||a.inject.config.debug.cheats)&&(this.remainingLives>0&&(this.remainingLives--,a.inject.scene.playUI.activeUI.burnLife()),a.inject.gameStateController.rollbackTurn(),a.inject.userData.saveLevelProgress())}showUpgradeSymbolsFor(e,t){const i=a.inject.gameStateModel.rules.pawns(e).mergeRules[e];i&&a.inject.screen.play.selectedRegion.getPawns().filter((i=>i.type===e&&i!==t)).forEach((e=>{a.inject.scene.worldMap.pawnSymbols.add(e.id,B.PawnSymbolType.Plus,`Drop here to upgrade to ${i}.`)}))}}t.PlayScreen=O,t.Cheats={toggleTapped(e){const t=a.inject.gameStateModel;let i=t.warfare.getOccupyingUnit(e);i&&(t.currentPhase.isTapped(i)?(t.currentPhase.unTapPawn(i),a.inject.scene.worldMap.pawns.getById(i.id)?.startJumping()):(t.currentPhase.tapPawn(i),a.inject.scene.worldMap.pawns.getById(i.id)?.stopJumping()))}}},89086:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionsLedger=void 0;const s=i(2011),n=i(52163),a=i(71203);i(62199).logger.for("RegionsLedger"),t.RegionsLedger=class{constructor(){this.ledger=[],this.visited=new Set}get availableRegions(){return this.ledger}refreshAvailableRegions(e){const t=s.CurrentPhase.model(e).faction;n.assert.defined(t);const i=t.getRegions().filter((e=>e.exists&&e.isAlive())).sort(((e,t)=>t.size-e.size));this.ledger=i.map((e=>e.id)),i.filter((e=>!e.isActionable())).forEach((e=>this.visited.add(e.id))),this.updateDebugData()}regionVisited(e){this.visited.add(e),this.updateDebugData()}reset(e){this.visited.clear(),this.refreshAvailableRegions(e)}updateDebugData(){a.inject.debugData.set("regionsLedger",a.inject.ui.regionsLedger.toDebugString())}getNextPendingRegionId(){return this.getPendingRegions()[0]}getPendingRegions(){return this.ledger.filter((e=>!this.visited.has(e)))}getNext(e){if(void 0===e)return this.ledger[0];const t=this.ledger.indexOf(e);return this.ledger[(t+1)%this.ledger.length]}getPrevious(e){if(!e)return this.ledger[this.ledger.length-1];const t=this.ledger.indexOf(e);return 0===t?this.ledger[this.ledger.length-1]:this.ledger[t-1]}isVisited(e){return this.visited.has(e)}isPending(e){return!this.visited.has(e)}hasPendingRegions(){return this.getPendingRegions().length>0}toDebugString(){return Array.from(this.ledger).map((e=>e+(this.visited.has(e)?"":"*"))).join(",")}}},62136:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapUpdater=void 0;const s=i(47692),n=i(22919),a=i(48993);t.WorldMapUpdater={refreshTownFlagsAndBacklightInRegion:s.refreshTownFlagsAndBacklightInRegion,refreshAllTownFlagsAndBacklight:s.refreshAllTownFlagsAndBacklight,showWorldMapOverlaysBasedOnSelectedRegion:n.showWorldMapOverlaysBasedOnSelectedRegion,showAttitudeEmojis:n.showAttitudeEmojis,hideAttitudeAttitudeEmojis:n.hideAttitudeAttitudeEmojis,setPawnsJumpingInRegion:a.setPawnsJumpingInRegion,setPawnJumpingInRegions:a.setPawnJumpingInRegions}},47692:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.refreshAllTownFlagsAndBacklight=t.refreshTownFlagsAndBacklightInRegion=void 0;const s=i(71203),n=i(2011),a=i(87832),o=i(73508),r=i(9332),c=i(92940);function l(e){const t=s.inject.scene.worldMap,i=a.Economy.model(e.state).townHexesOf(e),l=e.faction?.controller===o.FactionController.LocalUser&&e.faction.id===n.CurrentPhase.getFaction(e.state),d=e.treasury>=10,h=r.Pawns.model(e.state).findOne({hexes:e.hexes,traits:[c.PawnTraits.Unit],movable:!0});n.CurrentPhase.model(e.state).getMovablePawns().find((t=>e.hexes.has(t.hex)));const u=(e.budget?.balance||0)<0;if(t.pawnBacklight.clear(),l&&(d||h||u)){const n=u?16711680:65280;for(let a of i.members)d||u?t.townStatusFlags.setFlag(a,n):t.townStatusFlags.removeFlag(a),s.inject.screen.play.selectedRegion!==e?t.pawnBacklight.add(a,{color:n}):t.pawnBacklight.remove(a)}else i.forEach((e=>{t.townStatusFlags.removeFlag(e),t.pawnBacklight.remove(e)}))}i(62199).logger.for("PlayScreen:updaters"),t.refreshTownFlagsAndBacklightInRegion=l,t.refreshAllTownFlagsAndBacklight=function(e){s.inject.scene.worldMap.townStatusFlags.clear(),s.inject.scene.worldMap.pawnBacklight.clear(),n.CurrentPhase.model(e).faction?.getRegions().forEach((e=>l(e)))}},48993:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setPawnsJumpingInRegion=t.setPawnJumpingInRegions=void 0;const s=i(71203);function n(e,t){const i=s.inject.gameStateModel.currentPhase.getMovablePawns().filter((t=>t.region.id===e.id)).map((e=>s.inject.scene.worldMap.pawns.getById(e.id)));t?i.forEach((e=>e?.startJumping())):i.forEach((e=>e?.stopJumping()))}t.setPawnJumpingInRegions=function(e){e.forEach((e=>n(e,!0)))},t.setPawnsJumpingInRegion=n},22919:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hideAttitudeAttitudeEmojis=t.showAttitudeEmojis=t.showWorldMapOverlaysBasedOnSelectedRegion=void 0;const s=i(71203),n=i(29323),a=i(52163),o=i(73508),r=i(72005);function c(e){const t=s.inject.gameStateModel;a.assert.defined(e);for(const i of t.regions.all())if(i.isAlive()&&i.faction?.controller!==o.FactionController.LocalUser&&i.faction!==e){const n=(0,r.getAttitudeIndex)(i.faction.fearOf(e),i.faction.approvalOf(e)),a=e===t.currentPhase.faction?1:.75;t.economy.townHexesOf(i).forEach((e=>s.inject.scene.worldMap.attitudeEmojis.set(e,n,a)))}else t.economy.townHexesOf(i).forEach((e=>s.inject.scene.worldMap.attitudeEmojis.remove(e)))}function l(){s.inject.scene.worldMap.attitudeEmojis.clear()}i(62199).logger.for("PlayScreen:updaters"),t.showWorldMapOverlaysBasedOnSelectedRegion=function(){const e=s.inject.screen.play.selectedRegion;e&&(0,n.isRegionControllable)(e)?s.inject.screen.play.setConquerableHexesBasedOnSelectedRegion():(s.inject.screen.play.clearConquerableHexes(),e?.faction&&s.inject.config.flags.seeEnemyAttitudes?c(e.faction):e&&s.inject.config.flags.seeEnemyAttitudes?l():s.inject.gameStateModel.currentPhase.isLocalPlayerTurn()?c(s.inject.gameStateModel.currentPhase.faction):l())},t.showAttitudeEmojis=c,t.hideAttitudeAttitudeEmojis=l},6961:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleFactionTurnStarted=void 0;const s=i(71203),n=i(94058),a=i(18995),o=i(90862),r=i(73508),c=i(52163),l=i(5694),d=i(24011),h=i(58609),u=i(62136);t.handleFactionTurnStarted=function(e,{state:t,factionId:i}){const g=s.inject.gameStateModel.factions.byId(i);switch(c.assert.defined(g),g.controller){case r.FactionController.LocalUser:s.inject.config.autoSaveOnTurnStart&&s.inject.userData.saveLevelProgress(),g.isAlive()||s.inject.gameStateModel.factions.all().filter((e=>e.isAlive()&&e.controller===r.FactionController.LocalUser)).length||e.handleGameOver({winningFactionId:void 0,state:s.inject.currentGameState}),e.setMode(new n.PlayMode(e)),s.inject.ui.regionsLedger.reset(t),u.WorldMapUpdater.setPawnJumpingInRegions(g.getRegions()),s.inject.screen.play.selectRegion(s.inject.ui.regionsLedger.getNextPendingRegionId(),{clickEffect:!1,panCamera:!1}),u.WorldMapUpdater.refreshAllTownFlagsAndBacklight(t),e.uiScene.updateState({mode:h.PlayUIMode.Standby}),e.uiScene.updateFromGameState(s.inject.currentGameState),s.inject.worldNews.display();break;case r.FactionController.Ai:e.mode instanceof o.SpectatorMode||e.setMode(new o.SpectatorMode(e)),s.inject.ai.play(g).then((async()=>{s.inject.gameStateController.executePlay(a.Plays.EndTurn())}));break;case r.FactionController.None:g.id===d.SpecialFaction.neutral&&(e.mode instanceof o.SpectatorMode||e.setMode(new o.SpectatorMode(e)),s.inject.gameStateController.executePlay(a.Plays.BanditsAct())),s.inject.gameStateController.executePlay(a.Plays.EndTurn());break;default:throw new Error(`Faction ${g} uses unsupported controller ${g.controller}`)}e.uiScene.updatePowerBalanceFromGameState(s.inject.currentGameState),s.inject.config.debug.checkWorldMapIntegrity&&(0,l.verifyWorldMapInSync)(e.worldMapScene,t)}},85170:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleNewGameState=void 0;const s=i(71203),n=i(35910);t.handleNewGameState=function(e,t){s.inject.ui.withoutTransitions((()=>{(0,n.syncPlayUiWithNewState)(e,t.state,{resetCamera:t.context.resetCamera})}))}},35910:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.syncPlayUiWithNewState=void 0;const s=i(73508),n=i(94058),a=i(90862),o=i(71203),r=i(2011),c=i(47692),l=i(55912),d=i(16115);t.syncPlayUiWithNewState=function(e,t,i={resetCamera:!1}){const h=r.CurrentPhase.model(t),u=r.CurrentPhase.model(t).faction;switch(e.worldMapScene.loadNewGameState(t),i.resetCamera&&e.worldMapScene.cameraController.centerAboveControlPanel(),e.uiScene.updateFromGameState(t),e.uiScene.updatePowerBalanceFromGameState(t),e.worldMapScene.setSelectedRegion(o.inject.screen.play.selectedRegion),(0,c.refreshAllTownFlagsAndBacklight)(t),(0,l.updateCutOffSymbols)(d.Regions.model(t).all()),u?.controller){case s.FactionController.LocalUser:e.uiScene.setFactionColor(u.landColor||16777215),e.time.addEvent({callback:()=>{h.getMovablePawns().map((t=>e.worldMapScene.pawns.getById(t.id))).forEach((e=>{e?.startJumping()}))},delay:100}),e.setMode(new n.PlayMode(e));break;case s.FactionController.Ai:case s.FactionController.None:case void 0:e.setMode(new a.SpectatorMode(e));break;default:throw new Error(`Faction ${u} uses unsupported controller ${u?.controller}`)}}},96355:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseMode=void 0;const s=i(62199),n=i(9095),a=i(71203),o=i(18995),r=i(75981),c=i(55241),l=i(58060),d=i(55912),h=i(59002),u=i(70780),g=i(5538),p=i(51897),m=s.logger.for("BaseMode");t.BaseMode=class{constructor(e){this.scene=e}isReadyForMoreGameEvents(){return!this.isHandlingEvent}canPickupPawn(e){return!1}canDropPawn(e){return!1}isHexInteractive(e){return!1}canReturnPawn(){return!1}handleReturnPawn(){m.warning(`returnPawn not available in ${this.name}`)}handleStartInteraction(e,t){}handleCompleteInteraction(e,t){}handleStartDrag(e){}handleEndDrag(e){}handleSkipSpectating(){m.warning(`skipSpectating not available in ${this.name}`)}handleShopAreaPointerUp(){a.inject.audio.playEffect(n.SoundEffects.Deny)}handlePawnInShopPointerUp(e){}handlePawnInShopPointerDown(e){}activate(){}deactivate(){}handleNewHexUnderCursor(e){}handleEndTurn(){}async handleGameEvent(e){this.isHandlingEvent=!0,"TIMEOUT"===await Promise.race([this.doHandleEvent(e),(0,g.sleep)(3e3).then((()=>"TIMEOUT"))])&&this.isHandlingEvent&&(p.ErrorTracking.captureNonFatalError(new Error(`event handling timeout while processing ${e.name}`),"handleGameEvent timeout"),this.handleSkipSpectating()),this.isHandlingEvent=!1}async doHandleEvent(e){return(0,u.isEvent)(e,o.GameEvents.PawnBought)?this.handlePawnBought(e.payload):(0,u.isEvent)(e,o.GameEvents.BanditsActed)?this.handleBanditsActed(e.payload):(0,u.isEvent)(e,o.GameEvents.FactionEconomyUpdated)?this.handleFactionEconomyUpdated(e.payload):(0,u.isEvent)(e,o.GameEvents.HexCaptured)?this.handleHexCaptured(e.payload):(0,u.isEvent)(e,o.GameEvents.PawnMoved)?this.handlePawnMoved(e.payload):void 0}async handlePawnBought(e){await(0,r.handlePawnBought)(this.scene,e)}async handleBanditsActed(e){await(0,c.handleBanditsActed)(this.scene,e)}async handleFactionEconomyUpdated(e){await(0,l.handleFactionEconomyUpdated)(this.scene,e)}async handleHexCaptured(e){await(0,d.handleHexCaptured)(this.scene,e)}async handlePawnMoved(e){await(0,h.handlePawnMoved)(this.scene,e)}handleAbort(){a.inject.events.trigger(o.UserActions.GoBack())}}},50476:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BuyingPawnMode=void 0;const s=i(71203),n=i(18995),a=i(94058),o=i(96355),r=i(62199),c=i(89403),l=i(88028),d=i(9095),h=i(73508),u=i(52163),g=i(34594),p=i(92940),m=i(3579),y=r.logger.for("BuyingPawnMode");class f extends o.BaseMode{constructor(e,t){super(e),this.buyingPawn=t,this.bought=!1,this.name="BuyingPawn",this.isDraggingPawn=!0,this.justInitiated=!0,setTimeout((()=>this.justInitiated=!1),200)}activate(){s.inject.scene.worldMap.cameraController.stopDragScroll(),s.inject.scene.worldMap.showHexDefenseMarkers(),s.inject.scene.worldMap.pawnSymbols.clear(g.PawnSymbolType.Arrow),s.inject.gameStateModel.rules.pawns(this.buyingPawn).hasTrait(p.PawnTraits.Unit)?(s.inject.screen.play.showConquerableHexesBasedOn(this.buyingPawn),s.inject.screen.play.showUpgradeSymbolsFor(this.buyingPawn)):s.inject.screen.play.clearConquerableHexes(),s.inject.tooltips.close()}deactivate(){this.bought||this.scene.uiScene.returnPawnToShop(this.buyingPawn,(()=>{})),s.inject.scene.worldMap.pawnSymbols.clear(g.PawnSymbolType.Plus),s.inject.scene.worldMap.hexMarkers.clear()}isHexInteractive(e){return!0}canDropPawn(e){return!0}canReturnPawnAtHex(e){const t=s.inject.screen.play.selectedRegion;return s.inject.gameStateModel.regions.byHex(e)?.id===t?.id&&!!s.inject.gameStateModel.pawns.byHex(e,h.PawnType.Town)}handleCompleteInteraction(e){this.isDraggingPawn&&this.justInitiated?this.isDraggingPawn=!1:this.tryDropPawn(e)||(s.inject.scene.worldMap.cameraController.stopDragScroll(),this.isDraggingPawn&&s.inject.events.trigger(n.UserActions.ReturnHeldPawn()))}handleStartInteraction(e){this.isDraggingPawn||s.inject.scene.worldMap.cameraController.startDragScroll()}handleEndDrag(e){this.isDraggingPawn?this.tryDropPawn(e)||s.inject.events.trigger(n.UserActions.ReturnHeldPawn()):s.inject.scene.worldMap.cameraController.stopDragScroll()}handlePawnInShopPointerUp(e){if(u.assert.defined(this.buyingPawn),e===this.buyingPawn&&this.justInitiated)return this.isDraggingPawn=!1,void this.fixPawnHolderPositionOnTouchDevice();e===this.buyingPawn||this.isDraggingPawn?(this.scene.uiScene.returnPawnToShop(this.buyingPawn),this.scene.setMode(new a.PlayMode(this.scene))):s.inject.screen.play.selectedRegion.treasury>=s.inject.gameStateModel.rules.pawns(e).cost&&this.scene.uiScene.returnPawnToShop(this.buyingPawn,(()=>{this.scene.uiScene.grabNewPawnFromShop(e),this.buyingPawn=e,s.inject.screen.play.showConquerableHexesBasedOn(this.buyingPawn),this.fixPawnHolderPositionOnTouchDevice()}))}fixPawnHolderPositionOnTouchDevice(){if(s.inject.device.isUsingTouch()){const{x:e,y:t}=s.inject.scene.playUI.getPawnXY(this.buyingPawn);s.inject.scene.playUI.pawnHolder.setFixedPosition(e,t-10)}}tryDropPawn(e){if(!e)return!1;const t=this.buyingPawn,i=s.inject.screen.play.selectedRegion;if(u.assert.defined(t),u.assert.defined(i),this.canReturnPawnAtHex(e))return this.scene.uiScene.restockPawnInShop(this.buyingPawn),this.scene.dropHeldPawnAtHex(e.id),this.bought=!1,this.scene.setMode(new a.PlayMode(this.scene)),!1;const o=()=>{this.scene.uiScene.restockPawnInShop(this.buyingPawn),this.scene.dropHeldPawnAtHex(e.id),s.inject.gameStateController.executePlay(n.Plays.BuyPawn({pawnType:t,destinationHexId:e.id,buyerRegionId:s.inject.screen.play.selectedRegionId()})),s.inject.audio.playEffect(d.SoundEffects.Drop)},r=s.inject.gameStateModel.warfare.getDropPawnResult(e,this.buyingPawn,i);switch(r.type){case c.DropPawnResultType.Reposition:case c.DropPawnResultType.EradicatePest:case c.DropPawnResultType.Combine:return o(),this.bought=!0,this.scene.setMode(new a.PlayMode(this.scene)),!0;case c.DropPawnResultType.Conquest:return this.bought=!0,this.scene.uiScene.restockPawnInShop(this.buyingPawn,!0),s.inject.gameStateController.executePlay(n.Plays.BuyPawn({pawnType:t,destinationHexId:e.id,buyerRegionId:s.inject.screen.play.selectedRegionId()})),!0;case c.DropPawnResultType.Invalid:return s.inject.audio.playEffect(d.SoundEffects.Deny),r.reason===c.InvalidDropPawnReason.PreventedByPawn&&(s.inject.scene.worldMap.pawns.transitions.defendTile(e,r.blockers),s.inject.notifications.movePreventedByPawn(this.buyingPawn,r.blockers)),!1}}handleShopAreaPointerUp(){s.inject.events.trigger(n.UserActions.ReturnHeldPawn())}handleReturnPawn(){u.assert.defined(this.buyingPawn),s.inject.scene.worldMap.cameraController.stopDragScroll(),this.scene.uiScene.returnPawnToShop(this.buyingPawn,(()=>{this.scene.setMode(new a.PlayMode(this.scene))}))}async handleHexCaptured(e){e.originatingHexId?y.warning(`ignoring hexCaptured as the capture originated from pawn at hex ${e.originatingHexId}, rather than freshly bought pawn`):(s.inject.audio.playEffect(d.SoundEffects.Drop),this.scene.dropHeldPawnAtHex(e.capturedHexId).then((async()=>{const t=(0,m.mergeTransactions)(e.lootTransactions||{},e.boughtPawnTransactions||{});t&&s.inject.scene.worldMap.cinematics.coinTransaction(t).play(),await super.handleHexCaptured(e)})),this.scene.setMode(new a.PlayMode(this.scene)))}handleNewHexUnderCursor(e){(0,l.updateHighlightWhileMovingPawn)(this.scene,e,this.buyingPawn,s.inject.screen.play.selectedRegion)}handleAbort(){s.inject.events.trigger(n.UserActions.ReturnHeldPawn())}canReturnPawn(){return!0}}t.BuyingPawnMode=f},88028:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateHighlightWhileMovingPawn=t.MovingPawnMode=void 0;const s=i(72373),n=i(71203),a=i(18995),o=i(94058),r=i(96355),c=i(62199),l=i(89403),d=i(92940),h=i(35171),u=i(9095),g=i(52163),p=i(34594),m=i(3579),y=i(55912),f=i(27358),w=i(47692),b=i(33580),v=i(10445),S=c.logger.for("MovingPawnMode");class P extends r.BaseMode{constructor(e,t,i){super(e),this.movingPawn=t,this.wasTouch=i,this.name="MovingPawn",this.isDraggingPawn=!0,this.isTouchMode=!1}activate(){n.inject.scene.worldMap.cameraController.stopDragScroll(),this.originHex=this.movingPawn.hex,this.wasTouch||this.initPawnHolder(),n.inject.scene.worldMap.showHexDefenseMarkers(this.movingPawn);const e=n.inject.screen.play.selectedRegion;g.assert.defined(e),n.inject.screen.play.showConquerableHexesBasedOn(this.movingPawn.type),n.inject.screen.play.showUpgradeSymbolsFor(this.movingPawn.type,this.movingPawn),n.inject.tooltips.close()}deactivate(){super.deactivate(),n.inject.scene.playUI.updateState({heldPawnData:null}),n.inject.scene.worldMap.pawnSymbols.clear(p.PawnSymbolType.Plus),n.inject.scene.worldMap.hexMarkers.clear(),n.inject.scene.worldMap.pawns.getById(this.movingPawn.id)?.clearHighlight(),(0,w.refreshAllTownFlagsAndBacklight)(n.inject.currentGameState),this.scene.uiScene.pawnHolder.clear()}canDropPawn(e){return!0}handleReturnPawn(){console.log("RETURNING");const e=this.movingPawn;g.assert.defined(e),this.dropPawnAt(e.hex.id).then((()=>{n.inject.scene.worldMap.pawns.show(e.id),n.inject.scene.worldMap.pawns.clearHangingPawn()})),this.scene.setMode(new o.PlayMode(this.scene))}isHexInteractive(e){return!0}handleStartInteraction(e){this.isDraggingPawn||n.inject.scene.worldMap.cameraController.startDragScroll()}handleCompleteInteraction(e,t){console.log("IS DRAGGIN?",this.isDraggingPawn),this.isDraggingPawn?t&f.PointerEventFlags.Touch&&(this.isTouchMode=!0,this.highlightMovingPawn()):(n.inject.scene.worldMap.cameraController.stopDragScroll(),this.tryMovePawnTo(e)),this.isDraggingPawn=!1}highlightMovingPawn(){n.inject.scene.worldMap.pawns.show(this.movingPawn.id),n.inject.scene.worldMap.pawnBacklight.set(this.movingPawn.hex,{color:v.Colors.highlight.ownedRegion,width:20}),n.inject.scene.playUI.pawnHolder.heldPawnImage?.setVisible(!1),n.inject.scene.worldMap.pawns.getById(this.movingPawn.id)?.setHighlight(b.Highlight.SelectedForMove)}handleEndDrag(e){this.isDraggingPawn?this.tryMovePawnTo(e)||n.inject.events.trigger(a.UserActions.ReturnHeldPawn()):n.inject.scene.worldMap.cameraController.stopDragScroll()}handleStartDrag(e){this.isDraggingPawn?this.wasTouch&&this.initPawnHolder():n.inject.scene.worldMap.cameraController.startDragScroll()}initPawnHolder(){if(n.inject.scene.playUI.activeUI.pawnHolder.heldPawn)return;const e=n.inject.scene.worldMap.getPawnObjectPositionOnScreen(this.originHex.id);n.inject.scene.playUI.activeUI.pawnHolder.pickUpPawn(this.movingPawn.type,e.x,e.y,e.scale),n.inject.scene.worldMap.pawns.hide(this.movingPawn.id)}tryMovePawnTo(e){const t=this.movingPawn,i=this.movingPawn.region;if(g.assert.defined(t),g.assert.defined(i),!e)return!1;if(t.hex===e)return n.inject.events.trigger(a.UserActions.ReturnHeldPawn()),!0;{const s=n.inject.gameStateModel.warfare.getDropPawnResult(e,this.movingPawn.type,i);switch(s.type){case l.DropPawnResultType.Reposition:case l.DropPawnResultType.EradicatePest:case l.DropPawnResultType.Combine:return this.dropPawnAt(e.id),n.inject.gameStateController.executePlay(a.Plays.MovePawn({pawnId:t.id,destinationHexId:e.id})),this.scene.setMode(new o.PlayMode(this.scene)),n.inject.audio.playEffect(u.SoundEffects.Drop),!0;case l.DropPawnResultType.Conquest:return n.inject.audio.playEffect(u.SoundEffects.Drop),n.inject.gameStateController.executePlay(a.Plays.AttackHex({pawnId:t.id,destinationHexId:e.id})),!0;case l.DropPawnResultType.Invalid:return n.inject.audio.playEffect(u.SoundEffects.Deny),s.reason===l.InvalidDropPawnReason.PreventedByPawn&&(n.inject.scene.worldMap.pawns.transitions.defendTile(e,s.blockers),n.inject.notifications.movePreventedByPawn(this.movingPawn.type,s.blockers)),!1}}}async dropPawnAt(e){n.inject.scene.worldMap.pawns.getById(this.movingPawn.id)?.clearHighlight(),n.inject.scene.worldMap.pawnBacklight.remove(this.originHex),await this.scene.dropHeldPawnAtHex(e)}async handleHexCaptured(e){if(this.movingPawn.id!==e.capturingPawnId)return void S.warning(`ignoring hexCaptured as the capturing pawn ${e.capturingPawnId} doesn't match the currently held pawn ${this.movingPawn}`);this.dropPawnAt(e.capturedHexId),g.assert.defined(e.originatingHexId);const t=(0,m.mergeTransactions)(e.lootTransactions||{},e.boughtPawnTransactions||{});t&&n.inject.scene.worldMap.cinematics.coinTransaction(t).play(),(0,y.handleHexCaptured)(this.scene,e),this.scene.setMode(new o.PlayMode(this.scene))}handlePawnInShopPointerUp(e){const t=n.inject.gameStateModel,i=t.rules.pawns(this.movingPawn.type).mergeRules[e],s=this.movingPawn.hex;n.inject.scene.worldMap.pointersTracker.clear(),i?(this.scene.uiScene.pawnHolder.setPawnType(i),this.isDraggingPawn=!1,n.inject.screen.play.showConquerableHexesBasedOn(i),n.inject.audio.playEffect(u.SoundEffects.Drop),n.inject.gameStateController.executePlay(a.Plays.BuyPawn({pawnType:e,buyerRegionId:this.movingPawn.region.id,destinationHexId:this.movingPawn.hex.id})),this.movingPawn=t.warfare.getOccupyingUnit(s)):(n.inject.audio.playEffect(u.SoundEffects.Deny),this.isDraggingPawn&&n.inject.events.trigger(a.UserActions.ReturnHeldPawn()))}async handlePawnBought(e){const t=n.inject.scene.worldMap.pawns.getById(this.movingPawn.id)?.visible;console.log("WAS_VISIBLE?",t),n.inject.ui.withoutTransitions((async()=>{await super.handlePawnBought(e)})),n.inject.device.isUsingTouch()?this.highlightMovingPawn():n.inject.scene.worldMap.pawns.hide(this.movingPawn.id),n.inject.scene.playUI.updateState({heldPawnData:{context:"moving",cost:0,upkeep:0,name:this.movingPawn.type}})}handleNewHexUnderCursor(e){T(this.scene,e,this.movingPawn,this.movingPawn.region),this.wasTouch&&this.isDraggingPawn&&e&&e!==this.originHex&&this.initPawnHolder()}handleAbort(){n.inject.events.trigger(a.UserActions.ReturnHeldPawn())}canReturnPawn(){return!0}}function T(e,t,i,a){if(t&&n.inject.screen.play.conquerableHexes?.contains(t)?e.worldMapScene.conquerableHexesHighlight.setHighlightedHex(t):e.worldMapScene.conquerableHexesHighlight.clearHighlightedHex(),t){let o,r;i instanceof s.PawnModel?(o=i,r=o.type):r=i;const c=n.inject.gameStateModel;g.assert.defined(a);const u=c.warfare.getDropPawnResult(t,r,a),p=c.rules.pawns(r).hasTrait(d.PawnTraits.GuardsAdjacentTiles);let m=h.HexGroup.empty;p&&(m=a.hexes.neighboursOf(t).filter((e=>!c.warfare.isOccupied(e)||e===o?.hex))),t==o?.hex||u.type===l.DropPawnResultType.Reposition||u.type===l.DropPawnResultType.Conquest?e.worldMapScene.hexMarkers.setHoveredHex(t,c.rules.pawns(r).defense,m):e.worldMapScene.hexMarkers.clearHoveredHex()}else e.worldMapScene.hexMarkers.clearHoveredHex()}t.MovingPawnMode=P,t.updateHighlightWhileMovingPawn=T},68714:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PassiveMode=void 0;const s=i(96355);class n extends s.BaseMode{constructor(e){super(e),this.name="Passive"}isReadyForMoreGameEvents(){return!1}}t.PassiveMode=n},94058:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayMode=void 0;const s=i(71203),n=i(88028),a=i(96355),o=i(50476),r=i(9095),c=i(18995),l=i(73508),d=i(52163),h=i(62199),u=i(92940),g=i(90862),p=i(34594),m=i(29323),y=i(3579),f=i(13872),w=i(55912),b=i(76378),v=i(22919),S=i(27358),P=h.logger.for("ui:PlayMode");class T extends a.BaseMode{constructor(){super(...arguments),this.name="Play",this.autoAttackUnit=void 0}activate(){(0,v.showWorldMapOverlaysBasedOnSelectedRegion)(),s.inject.ui.transitionsSpeed.set(f.TransitionsSpeed.Fast)}canPickupPawn(e){return!!this.getMovablePawnAtHex(e)||!!this.getRichTownAtHex(e)}getRichTownAtHex(e){const t=s.inject.gameStateModel.regions.byHex(e);if(t&&t===s.inject.screen.play.selectedRegion&&t.faction===s.inject.gameStateModel.currentPhase.faction&&!((t.treasury||0)<b.CHEAPEST_UNIT_COST))return!!s.inject.gameStateModel.pawns.byHex(e,l.PawnType.Town)}handleStartInteraction(e,t){if(!e)return void s.inject.scene.worldMap.cameraController.startDragScroll();const i=this.getMovablePawnAtHex(e),a=this.getRichTownAtHex(e);i?(s.inject.audio.playEffect(r.SoundEffects.Grab),this.selectRegionByHex(e),s.inject.scene.playUI.updateState({heldPawnData:{name:i.type.toString(),cost:i.cost,upkeep:i.upkeep,context:"moving"}}),this.scene.setMode(new n.MovingPawnMode(this.scene,i,!!(t&S.PointerEventFlags.Touch))),s.inject.events.trigger(c.UiEvents.PawnPickedUp({hexId:e.id,pawnType:i.type}))):a?(s.inject.audio.playEffect(r.SoundEffects.Grab),this.scene.uiScene.grabNewPawnFromTown(l.PawnType.Villager,e),this.selectRegionByHex(e),this.scene.setMode(new o.BuyingPawnMode(this.scene,l.PawnType.Villager))):s.inject.scene.worldMap.cameraController.startDragScroll()}isHexInteractive(e){return!0}selectRegionByHex(e){const t=s.inject.gameStateModel,i=t.regions.byHex(e),n=s.inject.screen.play.selectedRegion;let a=!1;return n&&s.inject.screen.play.conquerableHexes?.contains(e)?(this.findAutoAttacker(e),this.autoAttackUnit?(s.inject.audio.playEffect(r.SoundEffects.Drop),t.regions.byHex(e)===this.autoAttackUnit.region?(s.inject.gameStateController.executePlay(c.Plays.MovePawn({pawnId:this.autoAttackUnit.id,destinationHexId:e.id})),this.clearAutoAttacker()):s.inject.gameStateController.executePlay(c.Plays.AttackHex({pawnId:this.autoAttackUnit.id,destinationHexId:e.id})),a=!0):P.warning(`hex ${e} highlighted as conquerable but could not find any suitable attacker unit`)):(0,m.isRegionControllable)(i)?i!==n&&(s.inject.screen.play.selectRegion(i?.id),a=!0):i?.isAlive()?s.inject.screen.play.selectedRegion!==i&&(s.inject.screen.play.selectRegion(i?.id),a=!0):s.inject.screen.play.selectedRegion&&s.inject.screen.play.selectRegion(void 0),a}handleCompleteInteraction(e){e&&(s.inject.scene.worldMap.cameraController.stopDragScroll(),this.selectRegionByHex(e)?s.inject.tooltips.close():s.inject.tooltips.toggleHexTooltip(e))}handleStartDrag(e){s.inject.scene.worldMap.cameraController.startDragScroll()}handleEndDrag(e){s.inject.scene.worldMap.cameraController.stopDragScroll()}async handleHexCaptured(e){if(e.capturingPawnId!==this.autoAttackUnit?.id)return void P.warning(`Ignoring unexpected hexCaptured event during PlayMode (expected capturingPawnId to be ${this.autoAttackUnit?.id}, but was ${e.capturingPawnId}`);e.originatingHexId&&this.clearAutoAttacker();const t=(0,y.mergeTransactions)(e.lootTransactions||{},e.boughtPawnTransactions||{});t&&this.scene.worldMapScene.coins.cinematics.transactions(t).play(),(0,w.handleHexCaptured)(this.scene,e),this.clearAutoAttacker()}handlePawnInShopPointerDown(e){this.scene.uiScene.grabNewPawnFromShop(e),this.scene.setMode(new o.BuyingPawnMode(this.scene,e))}getMovablePawnAtHex(e){return s.inject.gameStateModel.pawns.byHex(e).find((e=>s.inject.gameStateModel.currentPhase.isMovable(e)))}handleNewHexUnderCursor(e){const t=s.inject.screen.play.selectedRegion;if(console.log("NEW HEX UNDER CURSOR",e),s.inject.tooltips.close(),e&&!s.inject.game.device.input.touch&&s.inject.tooltips.showHexTooltip(e),s.inject.game.device.input.touch)this.clearAutoAttacker();else if(e&&this.getMovablePawnAtHex(e)){const t=this.getMovablePawnAtHex(e);this.scene.worldMapScene.pawns.setHangingPawn(t.id),this.scene.input.setDefaultCursor("pointer"),this.clearAutoAttacker()}else if(t&&e&&s.inject.screen.play.conquerableHexes?.contains(e))this.scene.input.setDefaultCursor("pointer"),this.scene.worldMapScene.pawns.clearHangingPawn(),this.findAutoAttacker(e);else{this.scene.worldMapScene.pawns.clearHangingPawn();const i=e&&s.inject.gameStateModel.regions.byHex(e);i&&i!==t&&i.isAlive()?this.scene.input.setDefaultCursor("pointer"):this.scene.input.setDefaultCursor("default"),this.clearAutoAttacker()}}findAutoAttacker(e){const t=s.inject.screen.play.selectedRegion,i=s.inject.gameStateModel,n=i.factions.byHex(e)===i.currentPhase.faction?0:i.warfare.getHexDefense(e)+1;d.assert.defined(t);const a=t.getMovableUnitsByMight().getOneWithMightAtLeast(n);if(!a)return P.warning(`incorrectly thought I could conquer hex ${e} - is among conquerable hexes but i cannot gather ${n}  might from ${t}`),this.clearAutoAttacker();const o=i.pawns.findClosest(e,t.hexes,(e=>e.hasTrait(u.PawnTraits.Unit)&&e.isMovable()&&e.might===a));return o?(this.scene.worldMapScene.conquerableHexesHighlight.setHighlightedHex(e,o.type),this.scene.worldMapScene.pawnSymbols.clear(p.PawnSymbolType.Arrow),this.scene.worldMapScene.pawnSymbols.add(o.id,p.PawnSymbolType.Arrow,""),this.setAutoAttacker(o,e)):(P.warning(`failed to locate unit with might ${a} in the region => RegionMight projection appears to contain invalid data! `),this.clearAutoAttacker())}setAutoAttacker(e,t){this.autoAttackUnit=e}clearAutoAttacker(){console.log("CLEAR AUTO ATTACKER"),this.scene.worldMapScene.conquerableHexesHighlight.clearHighlightedHex(),this.scene.worldMapScene.pawnSymbols.clear(p.PawnSymbolType.Arrow)}async handlePawnMoved(e){await super.handlePawnMoved(e),e.mergedWith&&s.inject.screen.play.setConquerableHexesBasedOnSelectedRegion()}handleEndTurn(){this.scene.worldMapScene.pawnSymbols.clear(p.PawnSymbolType.Alert),s.inject.worldNews.clear(),s.inject.gameStateController.executePlay(c.Plays.EndTurn()),this.scene.setMode(new g.SpectatorMode(this.scene))}}t.PlayMode=T},90862:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateTransitionSpeedForSpectatorMode=t.SpectatorMode=void 0;const s=i(96355),n=i(71203),a=i(23803),o=i(3579),r=i(16115),c=i(55912),l=i(58609),d=i(36504),h=i(5538),u=i(35171),g=i(52163),p=i(96486),m=i(10445),y=i(73508),f=i(22919),w=i(13872);class b extends s.BaseMode{constructor(e){super(e),this.name="Spectator",this.pendingEvents=[],this.ongoingMoves=[],this.skipping=!1,this.active=!0,this.scheduleSelectedRegionUpdate=(0,p.debounce)((()=>{this.active&&this.scene.worldMapScene.setSelectedRegion(this.focusedRegion,m.Colors.highlight.hostileRegion)}),500)}activate(){v(n.inject.ui.spectatingSpeed()),this.scene.worldMapScene.pawns.clearAllJumping(),this.scene.uiScene.updateState({mode:l.PlayUIMode.Spectating,spectatingState:l.SpectatingState.EnemyTurn,enableSkipSpectating:!0,enableNextRegion:!1,regionData:void 0,showLevelSummary:!1}),this.scene.worldMapScene.townStatusFlags.clear(),this.scene.worldMapScene.pawnBacklight.clear(),(0,f.hideAttitudeAttitudeEmojis)()}deactivate(){super.deactivate(),n.inject.scene.worldMap.selectedRegionHighlight.clear(),n.inject.scene.worldMap.pawnBacklight.clear(),n.inject.scene.worldMap.conquerableHexesHighlight.clearHighlightedHex(),this.active=!1,this.skipping&&this.scene.worldMapScene.syncState(n.inject.currentGameState)}async handleGameEvent(e){n.inject.worldNews.handle(e),await super.handleGameEvent(e)}async handleFactionEconomyUpdated(e){this.skipping||(this.scene.worldMapScene.conquerableHexesHighlight.clear(),n.inject.gameStateModel.factions.byId(e.factionId)?.controller===y.FactionController.LocalUser?n.inject.scene.playUI.updateState({spectatingState:l.SpectatingState.GatherIncome}):await this.waitForAllTweensToFinish(),this.scene.worldMapScene.conquerableHexesHighlight.clear(),await super.handleFactionEconomyUpdated(e))}async waitForAllTweensToFinish(){await Promise.all(this.ongoingMoves),this.ongoingMoves=[]}async ensureRegionFocused(e,t){if(e!==this.focusedRegion)if(n.inject.ui.spectatingSpeed()!==l.SpectatingPlaybackSpeed.UltraFast)await this.waitForAllTweensToFinish(),this.scene.worldMapScene.conquerableHexesHighlight.clear(),await this.focusRegion(e,t),await(0,h.sleep)(500);else if(e.faction!==this.focusedRegion?.faction){const t=e.faction.getRegions().filter((e=>e.isAlive())),i=u.HexGroup.union(t.map((e=>e.hexes))),s=u.HexGroup.union(t.map((e=>e.getTownHexes())));this.scene.worldMapScene.selectedRegionHighlight.setHexes(i,m.Colors.highlight.hostileRegion),this.scene.worldMapScene.pawnBacklight.set(s,{color:m.Colors.highlight.hostileRegion})}}async handleHexCaptured(e){if(this.skipping)return;const t=r.Regions.model(e.stateAfter).byId(e.newRegionId);g.assert.defined(t),await this.ensureRegionFocused(t,e.capturedHexId),this.scene.worldMapScene.conquerableHexesHighlight.add((0,a.getHex)(e.capturedHexId),m.Colors.highlight.hostileRegion),this.scheduleSelectedRegionUpdate();const i=(0,c.handleHexCaptured)(this.scene,e);[l.SpectatingPlaybackSpeed.Normal,l.SpectatingPlaybackSpeed.Paused].includes(n.inject.ui.spectatingSpeed())?(await i,this.scene.worldMapScene.conquerableHexesHighlight.clear()):this.ongoingMoves.push(i);const s=(0,o.mergeTransactions)(e.boughtPawnTransactions||{},e.lootTransactions||{});s&&this.scene.worldMapScene.coins.applyTransactions(s)}async handlePawnMoved(e){if(this.skipping)return;const t=r.Regions.model(e.stateAfter).byHex(e.destinationHexId);g.assert.defined(t),await this.ensureRegionFocused(t),n.inject.ui.spectatingSpeed()===l.SpectatingPlaybackSpeed.Normal?await super.handlePawnMoved(e):n.inject.ui.withoutTransitions((()=>{super.handlePawnMoved(e)}))}async handlePawnBought(e){this.skipping||(n.inject.ui.spectatingSpeed()===l.SpectatingPlaybackSpeed.Normal?await super.handlePawnBought(e):n.inject.ui.withoutTransitions((()=>{super.handlePawnBought(e)})))}async handleBanditsActed(e){this.skipping||(n.inject.scene.playUI.updateState({spectatingState:l.SpectatingState.BanditsAct}),this.scene.worldMapScene.selectedRegionHighlight.clear(),this.scene.worldMapScene.pawnBacklight.clear(),await super.handleBanditsActed(e))}async focusRegion(e,t){this.focusedRegion=e;const i=void 0!==t?u.HexGroup.fromIds([t]):u.HexGroup.empty,s=(0,d.rectToPhaser)(e.hexes.boundingBox());this.scene.worldMapScene.selectedRegionHighlight.setHexes(e.hexes.without(i),m.Colors.highlight.hostileRegion),e.getTownHexes().forEach((e=>{this.scene.worldMapScene.pawnBacklight.set(e,{color:m.Colors.highlight.hostileRegion})})),await this.scene.worldMapScene.cameraController.ensureRectVisible(s)}handleSkipSpectating(){this.skipping=!0,this.isHandlingEvent=!1,this.ongoingMoves=[]}isReadyForMoreGameEvents(){return n.inject.ui.spectatingSpeed()!==l.SpectatingPlaybackSpeed.Paused&&super.isReadyForMoreGameEvents()}}function v(e){n.inject.ui.transitionsSpeed.set(function(e){switch(e){case l.SpectatingPlaybackSpeed.Paused:return w.TransitionsSpeed.Instant;case l.SpectatingPlaybackSpeed.UltraFast:case l.SpectatingPlaybackSpeed.Fast:return w.TransitionsSpeed.Fast;case l.SpectatingPlaybackSpeed.Normal:return w.TransitionsSpeed.Normal}}(e))}t.SpectatorMode=b,t.updateTransitionSpeedForSpectatorMode=v},55241:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleBanditsActed=void 0;const s=i(35171),n=i(71203);t.handleBanditsActed=async function(e,t){const i=s.HexGroup.fromIds(t.pillagedHexes.map((e=>e.hexId)));e.worldMapScene.regions.refreshHexes(t.stateAfter,i),e.worldMapScene.tiles.syncWithModel(n.inject.gameStateModel,i),e.worldMapScene.play(t.worldUpdates,t.stateAfter),Object.keys(t.coinTransactions.pillage).length>0&&await e.worldMapScene.coins.cinematics.transactions(t.coinTransactions.pillage).play(),Object.keys(t.coinTransactions.buyUnits)&&await e.worldMapScene.coins.cinematics.transactions(t.coinTransactions.buyUnits).play(),e.worldMapScene.coins.applyTransactions(t.coinTransactions.baseIncome)}},58060:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleFactionEconomyUpdated=void 0;const s=i(26244),n=i(71203),a=i(73508),o=i(73664),r=i(55912);t.handleFactionEconomyUpdated=async function(e,t){const i=new s.ParallelCinematic(e);n.inject.gameStateModel.factions.byId(t.factionId)?.controller===a.FactionController.LocalUser?(t.regionReports.forEach((s=>{i.add(e.worldMapScene.cinematics.coinTransaction(s.coinTransfers)),n.inject.scene.worldMap.play(s.worldUpdates,t.stateAfter)})),i.play()):t.regionReports.forEach((e=>{n.inject.scene.worldMap.coins.applyTransactions(e.coinTransfers),n.inject.scene.worldMap.play(e.worldUpdates,t.stateAfter)}));const c=new o.StaticGameStateModel(t.stateAfter),l=t.regionReports.map((e=>c.regions.byId(e.regionId)));e.refreshTownVariantInRegions(l),(0,r.updateCutOffSymbols)(l),e.uiScene.updateFromGameState(t.stateAfter)}},55912:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateCutOffSymbols=t.handleHexCaptured=void 0;const s=i(71203),n=i(16115),a=i(34594),o=i(21300),r=i(92940);t.handleHexCaptured=async function(e,t){t.capturedHexId,n.Regions.model(t.stateAfter),e.uiScene.updateFromGameState(t.stateAfter),e.uiScene.updatePowerBalanceFromGameState(t.stateAfter),s.inject.ui.regionsLedger.refreshAvailableRegions(t.stateAfter),await s.inject.scene.worldMap.play(t.worldUpdates,t.stateAfter),o.TileSymbolsUpdater.afterHexCaptured(e,t)},t.updateCutOffSymbols=function(e){const t=e.filter((e=>!e.isAlive()||e.treasury+e.budget.balance<0)),i=e.filter((e=>e.isAlive()&&e.treasury+e.budget.balance>=0)),n=s.inject.scene.worldMap;for(let e of t)e.getPawns().filter((e=>e.upkeep>0&&e.hasTrait(r.PawnTraits.Unit))).forEach((e=>{n.pawnSymbols.has(e.id,a.PawnSymbolType.CrossedCoin)||n.pawnSymbols.add(e.id,a.PawnSymbolType.CrossedCoin,"Unit can't get paid! It will turn into bandit next turn!")}));for(let e of i)e.getPawns().filter((e=>e.upkeep>0&&e.hasTrait(r.PawnTraits.Unit))).forEach((e=>{n.pawnSymbols.has(e.id,a.PawnSymbolType.CrossedCoin)&&n.pawnSymbols.remove(e.id,a.PawnSymbolType.CrossedCoin)}))}},75981:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handlePawnBought=void 0;const s=i(92940),n=i(23803),a=i(73664),o=i(62136),r=i(55912);t.handlePawnBought=async function(e,t){e.uiScene.updateFromGameState(t.stateAfter),e.uiScene.updatePowerBalanceFromGameState(t.stateAfter);const i=(0,a.readOnlyModelOf)(t.stateAfter),c=i.currentPhase.isLocalPlayerTurn(),l=(i.rules.pawns(t.pawnType),i.regions.byHex(t.destinationHexId));i.rules.pawns(t.pawnType).hasTrait(s.PawnTraits.Unit)&&i.economy.nearestTownHexFrom((0,n.getHex)(t.destinationHexId))?.id,c?(e.worldMapScene.cinematics.coinTransaction(t.payment).play(),o.WorldMapUpdater.refreshTownFlagsAndBacklightInRegion(l)):e.worldMapScene.coins.applyTransactions(t.payment),await e.worldMapScene.play(t.worldUpdates,t.stateAfter),c&&(0,r.updateCutOffSymbols)([l])}},59002:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handlePawnMoved=void 0;const s=i(22919);t.handlePawnMoved=async function(e,t){await e.worldMapScene.play(t.worldUpdates,t.stateAfter),(t.eradicatedPest||t.mergedInto)&&(e.uiScene.updateFromGameState(t.stateAfter),e.uiScene.updatePowerBalanceFromGameState(t.stateAfter)),t.eradicatedPest&&(0,s.showWorldMapOverlaysBasedOnSelectedRegion)()}},21300:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TileSymbolsUpdater=void 0;const s=i(23803),n=i(34594),a=i(2011),o=i(22919),r=i(33376),c=i(55912),l=i(16115);t.TileSymbolsUpdater={afterHexCaptured(e,t){if(a.CurrentPhase.model(t.stateAfter).isLocalPlayerTurn()){const i=t.worldUpdates.find((e=>e.type===r.UpdateType.PawnMoved&&e.hexCaptured));if(i?.defeatedUnit?.retreatHex&&e.worldMapScene.pawnSymbols.remove(i.defeatedUnit.pawnId,n.PawnSymbolType.Alert),e.worldMapScene.attitudeEmojis.remove((0,s.getHex)(t.capturedHexId)),(0,o.showWorldMapOverlaysBasedOnSelectedRegion)(),i?.hexCaptured){const e=l.Regions.model(t.stateAfter);(0,c.updateCutOffSymbols)(i.hexCaptured.affectedRegions.map((t=>e.byId(t))).filter((e=>e)))}}}}},8635:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBuyablePawnsConfig=t.BUYABLE_BUILDINGS=t.BUYABLE_UNITS=t.PlayUIScene=void 0;const s=i(84612),n=i(71203),a=i(62199),o=i(73508),r=i(18995),c=i(52163),l=i(9095),d=i(87832),h=i(30634),u=i(29323),g=i(32389),p=i(58609),m=i(94459),y=i(48289),f=i(46299),w=i(2011),b=i(9724),v=i(48565),S=i(82260),P=i(18518),T=i(16115),x=a.logger.for("PlayUIScene"),M=S.Input.Keyboard.KeyCodes;class C extends b.BaseUIScene{constructor(){super({key:s.Scenes.PlayUI}),this.currentState=p.DEFAULT_PLAY_UI_STATE,this.preUpdate=(0,v.whenDirty)((()=>{this.activeUI?.updateLayout()})),this.alreadyShaking=!1}get pawnHolder(){return this.activeUI.pawnHolder}create(){super.create(),this.watchWhileActive(n.inject.gameStateController.undoAvailable,(e=>this.updateState({undoAvailable:e}))),this.watchWhileActive(n.inject.ui.spectatingSpeed,(e=>this.updateState({spectatingSpeed:e}))),this.watchWhileActive(n.inject.device.uiVariant,this.setControlsBasedOnScreenSize.bind(this)),this.handleEventWhileActive(r.UserActions.OpenRollbackMenu,(()=>this.activeUI.openRollbackPanel())),this.setControlsBasedOnScreenSize(n.inject.device.uiVariant()),this.bindKey(M.TAB,r.UserActions.SelectNextRegion),this.bindKey(M.ONE,(()=>r.UserActions.BuyablePawnPointerDown(o.PawnType.Villager))),this.bindKey(M.TWO,(()=>r.UserActions.BuyablePawnPointerDown(o.PawnType.Pikeman))),this.bindKey(M.THREE,(()=>r.UserActions.BuyablePawnPointerDown(o.PawnType.Knight))),this.bindKey(M.FOUR,(()=>r.UserActions.BuyablePawnPointerDown(o.PawnType.Hero))),this.bindKey(M.BACKSPACE,this.handleUndoHotkey.bind(this)),this.bindKey(M.BACKTICK,this.handleUndoHotkey.bind(this)),this.bindKey(M.E,(()=>r.UserActions.EndTurn())),this.input.keyboard.addKey(M.ESC),this.arrowKeys=this.input.keyboard.addKeys({up:M.UP,down:M.DOWN,left:M.LEFT,right:M.RIGHT}),this.arrowKeys2=this.input.keyboard.addKeys({up:M.W,down:M.S,left:M.A,right:M.D})}handleUndoHotkey(){return n.inject.gameStateController.undoAvailable()===p.UndoAvailability.Available?r.UserActions.Undo():void 0}updateState(e){this.currentState={...this.currentState,...e},this.activeUI.updateState(e)}setControlsBasedOnScreenSize(e){if(this.latestScreenSize!==e)switch(this.latestScreenSize=e,x.warning(`Updating controls to fit screen size "${e}"`),this.activeUI?.destroy(),e){case m.UiVariant.Compact:this.activeUI=new y.CompactPlayUI(this,this.currentState);break;case m.UiVariant.Large:this.activeUI=new g.LargePlayUI(this,this.currentState)}}setFactionColor(e){this.updateState({activeFactionColor:e})}update(e,t){super.update(e,t),this.activeUI?.update(),this.applyKeyboardScrolling(t)}applyKeyboardScrolling(e){const t=10*e,i=n.inject.scene.worldMap.cameraController.scrollController;(this.arrowKeys.up.isDown||this.arrowKeys2.up.isDown)&&(n.inject.tooltips.close(),i.cameraY.accelerate(-t)),(this.arrowKeys.down.isDown||this.arrowKeys2.down.isDown)&&(n.inject.tooltips.close(),i.cameraY.accelerate(t)),(this.arrowKeys.left.isDown||this.arrowKeys2.left.isDown)&&(n.inject.tooltips.close(),i.cameraX.accelerate(-t)),(this.arrowKeys.right.isDown||this.arrowKeys2.right.isDown)&&(n.inject.tooltips.close(),i.cameraX.accelerate(t))}updateFromGameState(e=n.inject.currentGameState){const t=d.Economy.model(e),i=(h.Rules.model(e),n.inject.screen.play.selectedRegion),s=w.CurrentPhase.model(e),a=s.faction,o=n.inject.ui.regionsLedger.hasPendingRegions(),r=n.inject.ui.regionsLedger.availableRegions.some((t=>T.Regions.model(e).byId(t)?.isActionable())),c=s.turnNumber;if(![p.PlayUIMode.Standby,p.PlayUIMode.OwnedRegionSelected,p.PlayUIMode.HostileRegionSelected].includes(this.currentState.mode))return;const l={showLevelSummary:c>1,turnNumber:c,activeFactionColor:a?.landColor||0,hasPendingRegions:o,enableNextRegion:n.inject.ui.regionsLedger.availableRegions.length>1,enableRollback:n.inject.gameStateController.rollbackAvailable&&n.inject.screen.play.remainingLives>0||n.inject.config.debug.cheats,highlightEndTurn:!r,livesLeft:n.inject.screen.play.remainingLives};if(i?.exists){const s=(0,u.isRegionControllable)(i),n=t.treasuryOf(i);this.updateState({...l,mode:s?p.PlayUIMode.OwnedRegionSelected:p.PlayUIMode.HostileRegionSelected,regionData:{id:i.id,name:i.name,income:i.budget?.balance||0,treasury:n,buyablePawns:s?I(e,n):[],townLevel:i.power.maxObtainableUnitMight}})}else this.updateState({...l,mode:p.PlayUIMode.Standby,regionData:null})}grabNewPawnFromShop(e){const t=this.getPawnXY(e);return c.assert.defined(t),this.grabNewPawnFrom(e,t.x,t.y),!0}getPawnXY(e){const t=this.activeUI.shoppingTray.getPawnXY(e);if(t)return{x:t.x+this.activeUI.shoppingTray.x,y:t.y+this.activeUI.shoppingTray.y}}grabNewPawnFromTown(e,t){const{x:i,y:s}=n.inject.scene.worldMap.getPawnObjectPositionOnScreen(t.id);this.grabNewPawnFrom(e,i,s)}grabNewPawnFrom(e,t,i){this.pawnHolder.pickUpPawn(e,t,i,1);const s=n.inject.gameStateModel.rules.pawns(e);this.updateState({heldPawnData:{name:e.toString(),cost:s.cost,upkeep:s.upkeep,context:"buying"}}),this.activeUI.shoppingTray.setPawnTaken(e,!0),n.inject.audio.playEffect(l.SoundEffects.Grab)}returnPawnToShop(e,t){const i=this.activeUI.shoppingTray.getPawnXY(e);c.assert.defined(i),this.pawnHolder.dropPawn(this.activeUI.shoppingTray.x+i.x,this.activeUI.shoppingTray.y+i.y,1,(()=>{this.activeUI.shoppingTray.setPawnTaken(e,!1),t?.()})),this.updateState({heldPawnData:null}),n.inject.events.trigger(r.UiEvents.PawnReturnedToShop())}restockPawnInShop(e,t=!1){t?this.activeUI.shoppingTray.setPawnTaken(e,!1):this.activeUI.shoppingTray.restockPawn(e),this.updateState({heldPawnData:null})}shakeRegionControls(){this.alreadyShaking||(this.alreadyShaking=!0,this.tweens.add({targets:[this.activeUI.shoppingTray],y:e=>e.y+10,tween:"Sine.easeInOut",duration:100,yoyo:!0,onComplete:()=>{this.alreadyShaking=!1}}))}updatePowerBalanceFromGameState(e){const t=f.Factions.model(e).all().filter((e=>e.isAlive())).map((t=>({id:t.id,size:t.power,color:t.landColor,highlight:w.CurrentPhase.getFaction(e)===t.id})));this.updateState({powerBalance:t})}canBuyPawn(e){return this.currentState.regionData?.buyablePawns.find((t=>t.pawnType===e))?.mode===P.BuyablePawnMode.Available}getTooltipFor(e){return this.activeUI.getTooltipFor(e)}}function I(e,i){const s=h.Rules.model(e);let n=[];for(let e of t.BUYABLE_UNITS.map((e=>s.pawns(e))).filter((e=>e.cost>0))){if(!(e.cost<=i)){n.push({pawnType:e.type,mode:P.BuyablePawnMode.Unaffordable,priceTag:e.cost});break}n.push({pawnType:e.type,mode:P.BuyablePawnMode.Available,priceTag:e.cost})}for(let e of t.BUYABLE_BUILDINGS.map((e=>s.pawns(e))).filter((e=>e.cost>0))){if(!(e.cost<=i)){n.push({pawnType:e.type,mode:P.BuyablePawnMode.Unaffordable,priceTag:e.cost});break}n.push({pawnType:e.type,mode:P.BuyablePawnMode.Available,priceTag:e.cost})}return n}t.PlayUIScene=C,t.BUYABLE_UNITS=[o.PawnType.Villager,o.PawnType.Pikeman,o.PawnType.Knight,o.PawnType.Hero],t.BUYABLE_BUILDINGS=[o.PawnType.Castle],t.getBuyablePawnsConfig=I},85478:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PowerBalanceRibbon=void 0;const s=i(59824),n=i(1951),a=i(62199),o=i(73432),r=i(71203),c=i(95569);a.logger.for("ui:PowerBalanceRibbon");class l extends c.ResponsiveContainer{constructor(e,t){super(e),this.props=t,this.currentState=[],this.colorBars=[],this.setPosition(t.x,t.y),this.height=o.RibbonTexture.ColorBar.height,this.backgroundBar=new s.ColorBar(this.scene,{x:0,y:0,width:t.width,color:9474192}),this.setSize(t.width,this.backgroundBar.height),this.add([this.backgroundBar])}setDimensions(e,t,i){return this.setPosition(e,t),this.backgroundBar.width=i,this.width=i,r.inject.ui.withoutTransitions((()=>{this.updateState(this.currentState)})),this}updateState(e){this.currentState=e;const t=function(e,t,i){if(0===e.length)return e;const s=t/e.reduce(((e,t)=>e+t.size),0);let a=e.map((e=>({...e,size:Math.floor(e.size*s)})));const o=a.filter((e=>e.size<i)),r=a.filter((e=>e.size>i));if(o.length&&r.length){const e=o.map((e=>i-e.size)).reduce(n.sum,0)/r.length;o.forEach((e=>e.size=i)),r.forEach((t=>t.size=Math.ceil(t.size-e)))}let c=t-a.reduce(((e,t)=>e+t.size),0);for(let e=0;c>0&&r.length>0;c--,e++)r[e%r.length].size+=1;return a}(e,this.width,this.props.minSize);let i=0;for(let e=0;e<t.length;++e){const n=t[e].size+(e===t.length-1?0:2);this.colorBars[e]?(this.colorBars[e].adjustSize.transitionTo(n),this.colorBars[e].adjustX.transitionTo(i),this.colorBars[e].adjustY.transitionTo(t[e].highlight?-2:0)):(this.colorBars[e]=new s.ColorBar(this.scene,{x:i,y:0,width:n}),this.colorBars[e].adjustY.setTo(t[e].highlight?-2:0),this.colorBars[e].adjustX.setTo(i),this.colorBars[e].adjustSize.setTo(n),this.add(this.colorBars[e]),this.colorBars[e].setVisible(!0)),this.colorBars[e].setTint(t[e].color),i+=t[e].size}this.colorBars.slice(t.length).map((e=>{e.destroy()})),this.colorBars.splice(t.length),this.preUpdate.makeDirty()}}t.PowerBalanceRibbon=l},17983:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionSummaryPopup=void 0;const s=i(2592),n=i(71203),a=i(52163),o=i(98439),r=i(1157),c=i(10445),l=i(97306);var d=Phaser.GameObjects.BitmapText,h=Phaser.GameObjects.Image;const u=i(95569);class g extends s.ToolTipBox{constructor(e){super(e),this.summary=new p(this.scene),this.setContent(this.summary)}showOverRegion(e){const t=n.inject.gameStateModel.regions.byId(e);a.assert.defined(t);const i=n.inject.gameStateModel.economy.townHexesOf(t).members[0];if(!i)return;this.worldCoords={x:i.display.centerX,y:i.display.centerY+20},this.summary.updateFromRegion(t);const{x:s,y:r}=(0,o.convertWorldXYToCameraXY)(n.inject.scene.worldMap.cameras.main,i.display.centerX,i.display.centerY);this.showAt(s,r+20)}updatePosition(){if(!this.worldCoords)return;const{x:e,y:t}=(0,o.convertWorldXYToCameraXY)(n.inject.scene.worldMap.cameras.main,this.worldCoords.x,this.worldCoords.y);this.repositionTo(e,t)}}t.RegionSummaryPopup=g;class p extends u.ResponsiveContainer{constructor(e){super(e),this.currentGoldText=new d(this.scene,0,0,r.BitmapFont.MiniBold,"0").setTint(c.Colors.woodenUi.primaryText),this.rightArrow=new h(this.scene,0,0,"atlas","ui/mini-icons/arrow-right").setTint(c.Colors.woodenUi.primaryText),this.predictedGoldText=new d(this.scene,0,0,r.BitmapFont.Mini,"0").setTint(c.Colors.woodenUi.primaryText),this.goldIcon=new h(this.scene,0,0,"atlas","ui/mini-icons/coins").setOrigin(0,0),this.add([this.goldIcon,this.currentGoldText,this.rightArrow,this.predictedGoldText]),this.updateLayout()}updateFromRegion(e){const t=e.treasury,{balance:i,upkeep:s}=e.budget,n=i>=0?c.Colors.woodenUi.primaryText:c.Colors.woodenUi.redText;this.currentGoldText.setText(t.toFixed(0));const a=t+i;this.rightArrow.setTint(n),this.predictedGoldText.setText(a.toFixed(0)).setTint(n),this.updateLayout()}updateLayout(){(0,l.layoutFromLeftToRight)(0,0,2,[this.goldIcon,this.currentGoldText,this.rightArrow,this.predictedGoldText]),this.width=this.predictedGoldText.x+this.predictedGoldText.width,this.height=this.currentGoldText.height,(0,l.centerVertically)(this.rightArrow,0,0,this.height),(0,l.centerVertically)(this.goldIcon,0,0,this.height)}}},18518:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BuyablePawnGameObject=t.BuyablePawnMode=t.ShoppingTray=void 0;const s=i(62199),n=i(71203),a=i(73432),o=i(58609),r=i(18995),c=i(63286),l=i(12e3),d=i(95569),h=i(14067),u=i(10445),g=i(17225),p=i(79578),m=i(1157),y=i(82382),f=i(9095),w=i(44031),b=i(92536),v=i(84477),S=i(52584);var P=Phaser.GameObjects.Container,T=Phaser.Geom.Rectangle;const x=s.logger.for("ShoppingDesk");class M extends d.ResponsiveContainer{constructor(e,t){super(e),this.config=t,this.pawnSprites={},this.shadows=[],this.displayedPawns=[],this._openRef=(0,y.ref)(!1),this.activePawnBacklight=new S.PawnBacklight(this.scene,48).setTint(u.Colors.highlight.ownedRegion).setVisible(!1),this.yController=c.Control.propOf(this,"y",{duration:l.LARGE_PLAY_UI_LAYOUT.shoppingTray.panelTransitionsDuration}),this.cloth=new a.Ribbon(e,a.RibbonTexture.Cloth,-this.config.width/2,0,this.config.width),this.setSize(this.config.width,this.cloth.height),this.cloth.setInteractive(),this.cloth.on("pointerdown",(()=>n.inject.events.trigger(r.UserActions.ShopAreaPointerDown()))),this.cloth.on("pointerup",(()=>n.inject.events.trigger(r.UserActions.ShopAreaPointerUp()))),this.config.style===o.ShoppingTrayStyle.Elaborate&&(this.tray=new a.Ribbon(e,a.RibbonTexture.UnitTray,-this.config.width/2,0,this.config.width),this.closeButton=new h.MiniCloseButton(e,this.config.width/2-21,6).setTint(u.Colors.woodenUi.primaryText),this.closeButton.onClicked((()=>n.inject.events.trigger(r.UserActions.DeselectRegion())))),this.add([this.tray,this.cloth,this.closeButton,this.activePawnBacklight].filter((e=>e)))}setColor(e){this.cloth.setTint(e)}setOpen(e){if(e===this._openRef.current)return;this._openRef.set(e);const t=this.scene.cameras.main.displayHeight-(e?this.config.openOffsetFromBottom:this.config.closedOffsetFromBottom);this.yController.transitionTo(t)}get isOpen(){return this._openRef.current}updateLayout(){const e=this.scene.cameras.main.displayHeight,t=this.scene.cameras.main.displayWidth;this.cloth.setPosition(Math.round(-this.width/2),0),this.isOpen?this.setPosition(Math.round(t/2),e-this.config.openOffsetFromBottom):this.setPosition(Math.round(t/2),e),this.yController.setTo(this.y)}setBuyablePawns(e){this.displayedPawns=e,Object.values(this.pawnSprites).forEach((e=>e.setVisible(!1))),e.forEach(((e,t)=>{const i=this.getOrCreatePawnObject(e);i.setVisible(!0),i.updateLayout()})),this.activePawnBacklight.setVisible(!1),this.updatePawnSprites()}updatePawnSprites(){const e=this.config.pawnsSpacing,t=Math.round(-e*(this.displayedPawns.length-1)/2);Object.values(this.pawnSprites).forEach((e=>e.setVisible(!1))),this.displayedPawns.forEach(((i,s)=>{this.getOrCreatePawnObject(i).setVisible(!0).setPosition(t+s*e,this.config.pawnsVerticalOffset)}))}destroy(){Object.values(this.pawnSprites).forEach((e=>e.destroy())),this.pawnSprites={}}getOrCreatePawnObject(e){const{pawnType:t,priceTag:i}=e;if(this.pawnSprites[t])this.pawnSprites[t].setConfig(e);else{const i=new I(this.scene,e,this._openRef);this.add(i),this.pawnSprites[t]=i}return this.pawnSprites[t]}setPawnTaken(e,t){const i=this.pawnSprites[e];i?(i.setTaken(t),t?(this.activePawnBacklight.setPosition(i.x,this.height),this.activePawnBacklight.setVisible(!0),this.activePawnBacklight.animateIn()):Object.values(this.pawnSprites).find((e=>e.taken))||this.activePawnBacklight.setVisible(!1)):x.warning(`pawnType ${e} not found in shopping tray`)}getPawnXY(e){const t=this.pawnSprites[e];if(!t)return;const{x:i,y:s}=t;return{x:i,y:s}}restockPawn(e){this.pawnSprites[e]?.restock()}getTooltipFor(e){const t=Object.entries(this.pawnSprites).find((([t,i])=>i===e));if(t){const[e]=t;switch(this.displayedPawns.find((t=>t.pawnType===e)).mode){case C.Available:return(0,v.getPawnTypeTooltip)(e,"buyable");case C.Unaffordable:return(0,v.getPawnTypeTooltip)(e,"unaffordable")}}}}var C;t.ShoppingTray=M,function(e){e.Available="available",e.Unaffordable="unaffordable"}(C=t.BuyablePawnMode||(t.BuyablePawnMode={}));class I extends P{constructor(e,t,i){super(e),this.inputEnabled=i,this.ui=p.UiBuilder.for(this.scene),this.shadow=this.ui.image("pawn-shadow"),this.priceTag=this.ui.text("0",m.BitmapFont.Mini,1052688).setOrigin(0,0),this.priceIcon=this.ui.image("ui/budget-icons/neutral").setAlpha(.7).setOrigin(0,0),this.taken=!1,this.tweener=new b.Tweener(this.scene),this.image=this.ui.image((0,g.getFrameForPawnType)(t.pawnType)),this.width=this.image.displayWidth,this.height=this.image.displayHeight,this.setInteractive({cursor:"pointer",hitArea:new T(this.width-this.image.displayWidth/2,1.5*this.height-this.image.displayHeight,this.width,this.height),hitAreaCallback:T.Contains}),this.on("pointerdown",(()=>{this.mode===C.Unaffordable?(n.inject.audio.playEffect(f.SoundEffects.Deny),n.inject.events.trigger(r.UserActions.ToggleTooltip({object:this}))):n.inject.events.trigger(r.UserActions.BuyablePawnPointerDown(t.pawnType))})),this.on("pointerup",(()=>{this.inputEnabled.current&&n.inject.events.trigger(r.UserActions.BuyablePawnPointerUp(t.pawnType))})),this.add([this.shadow,this.image,this.priceTag,this.priceIcon]),this.setConfig(t)}getWorldTransformMatrix(e,t){return super.getWorldTransformMatrix(e,t).translate(-this.width/2,-this.height)}setConfig(e){this.mode===e.mode&&this.priceTag.text===e.priceTag.toFixed()||(this.mode=e.mode,this.priceTag.setText(e.priceTag.toFixed()),this.taken=!1,this.updateLayout())}setTaken(e){this.taken=e,this.updateLayout()}restock(){this.taken&&(this.image.clearTint(),this.shadow.setVisible(!0),this.tweener.add({targets:[this.image,this.shadow],props:{alpha:{start:.1,to:1}},duration:300,onComplete:()=>{this.setTaken(!1)}}))}updateLayout(){if(this.tweener.stop(),this.taken)this.priceTag.setVisible(!0),this.priceIcon.setVisible(!0),this.priceIcon.setAlpha(1),this.image.setTint(0),this.image.setAlpha(.3,.3,0,0),this.shadow.setVisible(!1);else switch(this.mode){case C.Available:this.priceTag.setVisible(!1),this.priceIcon.setVisible(!1),this.shadow.setVisible(!0),this.image.clearTint(),this.image.setAlpha(1);break;case C.Unaffordable:this.priceTag.setVisible(!0),this.priceIcon.setVisible(!0),this.priceIcon.setAlpha(.7),this.shadow.setVisible(!1),this.image.setTint(0),this.image.setAlpha(.3,.3,0,0)}w.Arrange.horizontally({content:[{object:this.priceTag},{object:this.priceIcon}],x:0,origin:.5,spacing:3}),w.Arrange.alignHorizontally([this.priceTag,this.priceIcon],{y:0,origin:.5})}}t.BuyablePawnGameObject=I},48289:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompactPlayUI=void 0;const s=i(58609),n=i(95071),a=i(18518),o=i(15363),r=i(62199),c=i(58970),l=i(38760),d=i(71203),h=i(18995),u=i(85478),g=i(17983),p=i(46252),m=i(19399),y=i(99809),f=i(76344),w=i(39999),b=i(271);r.logger.for("ui:PlayUI"),t.CompactPlayUI=class{constructor(e,t){this.scene=e,this.state=t,this.pawnHolder=new n.PawnHolder(this.scene),this.regionSummaryPopup=new g.RegionSummaryPopup(this.scene),this.statusHeader=new b.StatusHeaderUI(this.scene),this.regionPanel=new c.CompactRegionPanel(this.scene),this.shoppingTray=new a.ShoppingTray(this.scene,l.COMPACT_PLAY_UI_LAYOUT.shoppingTray),this.powerBalanceRibbon=new u.PowerBalanceRibbon(this.scene,{x:0,y:0,width:100,minSize:24}),this.endTurnButton=new v(this.scene),this.undoButton=new S(this.scene),this.nextPendingRegionButton=new P(this.scene),this.skipSpectatingButton=new T(this.scene),this.rollbackPanel=new m.FullScreenRollbackPanel(this.scene,{onAction:()=>this.closeRollbackPanel()}),this.endTurnButton.onClicked((()=>d.inject.events.trigger(h.UserActions.EndTurn()))),this.undoButton.onClicked((()=>d.inject.events.trigger(h.UserActions.Undo()))),this.nextPendingRegionButton.onClicked((()=>d.inject.events.trigger(h.UserActions.SelectNextPendingRegion()))),this.skipSpectatingButton.onClicked((()=>d.inject.events.trigger(h.UserActions.SkipSpectating()))),this.layer=new p.ResponsiveLayer(this.scene,[this.powerBalanceRibbon,this.shoppingTray,this.regionPanel,this.endTurnButton,this.skipSpectatingButton,this.nextPendingRegionButton,this.undoButton,this.regionSummaryPopup,this.rollbackPanel,this.statusHeader]),this.scene.add.existing(this.layer),this.rollbackPanel.setVisible(!1),this.updateLayout(),d.inject.ui.withoutTransitions((()=>{this.updateState(this.state)}))}openRollbackPanel(){this.scene.children.bringToTop(this.rollbackPanel),this.rollbackPanel.show(),d.inject.scene.worldMap.setMode(new y.PreviewMode),d.inject.scene.globalUI.updateLayout()}closeRollbackPanel(){this.rollbackPanel.setVisible(!1),d.inject.scene.worldMap.setMode(new f.InteractiveMode),d.inject.scene.play.skipToCurrentState(w.NewGameStateContext.ResumingGame),d.inject.scene.globalUI.updateLayout()}isRollbackPanelOpen(){return this.rollbackPanel.visible}transitionIn(e){}transitionOut(e){}burnLife(){}destroy(){this.layer.destroy()}update(){this.pawnHolder.update(),this.regionSummaryPopup.updatePosition()}updateLayout(){const e=this.scene.cameras.main.displayWidth,t=this.scene.cameras.main.displayHeight;this.regionPanel.reflow(),this.shoppingTray.updateLayout(),this.statusHeader.updateLayout(),this.undoButton.setPosition(0,t-this.undoButton.height),this.endTurnButton.setPosition(e-this.endTurnButton.width,t-this.endTurnButton.height),this.nextPendingRegionButton.copyPosition(this.endTurnButton),this.skipSpectatingButton.copyPosition(this.endTurnButton),this.powerBalanceRibbon.setDimensions(l.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides,t-this.powerBalanceRibbon.height,e-2*l.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides),this.rollbackPanel.setSize(this.scene.bounds.width,this.scene.bounds.height)}updateState(e){if(this.state,this.state={...this.state,...e},this.regionPanel.updateState(e),void 0!==e.mode)switch(e.mode){case s.PlayUIMode.Hidden:this.endTurnButton.setVisible(!1),this.nextPendingRegionButton.setVisible(!1),this.undoButton.setVisible(!1),this.shoppingTray.setOpen(!1),this.skipSpectatingButton.setVisible(!1),this.regionSummaryPopup.hide();break;case s.PlayUIMode.Spectating:this.endTurnButton.setVisible(!1),this.nextPendingRegionButton.setVisible(!1),this.undoButton.setVisible(!1),this.shoppingTray.setOpen(!1),this.skipSpectatingButton.setVisible(this.state.enableSkipSpectating),this.regionSummaryPopup.hide();break;case s.PlayUIMode.OwnedRegionSelected:case s.PlayUIMode.HostileRegionSelected:case s.PlayUIMode.Standby:e.mode!==s.PlayUIMode.OwnedRegionSelected?this.shoppingTray.setOpen(!1):this.shoppingTray.setOpen(!0),this.endTurnButton.setVisible(!this.state.hasPendingRegions),this.nextPendingRegionButton.setVisible(this.state.hasPendingRegions),this.skipSpectatingButton.setVisible(!1),this.undoButton.setVisible(!0),e.mode!==s.PlayUIMode.HostileRegionSelected&&this.regionSummaryPopup.hide()}void 0!==e.undoAvailable&&this.undoButton.setEnabled(e.undoAvailable!==s.UndoAvailability.Unavailable),e.regionData&&(e.mode===s.PlayUIMode.HostileRegionSelected?(console.log("SHOWING REGION SUMMARY OVER",e.regionData.id),this.regionSummaryPopup.showOverRegion(e.regionData.id)):e.mode===s.PlayUIMode.OwnedRegionSelected&&this.shoppingTray.setBuyablePawns(e.regionData?.buyablePawns)),void 0!==e.activeFactionColor&&e.mode===s.PlayUIMode.OwnedRegionSelected&&this.shoppingTray.setColor(e.activeFactionColor),void 0!==e.powerBalance&&this.powerBalanceRibbon.updateState(e.powerBalance),void 0!==e.enableSkipSpectating&&this.skipSpectatingButton.setVisible(e.enableSkipSpectating),void 0!==e.highlightEndTurn&&this.endTurnButton.setHighlight(e.highlightEndTurn),void 0!==e.enableRollback&&this.rollbackPanel.setRewindEnabled(e.enableRollback),void 0!==e.heldPawnData&&d.inject.device.isUsingTouch()&&this.statusHeader.updateState(e.heldPawnData)}setVisible(e){this.layer.setVisible(e)}getTooltipFor(e){return this.shoppingTray.getTooltipFor(e)}};class v extends o.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-turn",down:!0})}setHighlight(e){e?this.setBaseFrame("ui/compact/btn-turn-glow"):this.setBaseFrame("ui/compact/btn-turn")}}class S extends o.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-undo",down:!0,disabled:!0})}}class P extends o.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-next",down:!0})}}class T extends o.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-skip",down:!0})}}},16943:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompactRegionLabel=void 0;const s=i(76114),n=i(63286),a=i(5538),o=i(38760);var r=Phaser.GameObjects.Image;class c extends Phaser.GameObjects.Container{constructor(e,t,i){super(e),this.width=t,this.height=i,this.treasuryTextController=new n.TransitionController(this.scene,{duration:400,initialValue:0,applyValue:e=>{this.treasuryText.setText(e.toFixed(0))}}),this.incomeTextController=new n.TransitionController(this.scene,{duration:400,initialValue:0,applyValue:e=>{this.incomeText.setText((0,a.withSign)(Math.trunc(e))),this.updateTrendIcon(e),this.updateNumbersLayout()}}),this.visibilityController=n.Control.visibilityOf(this,{duration:o.COMPACT_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.regionInfo={buyablePawns:[],name:"",treasury:0,income:0,id:-1,townLevel:1};const c=this.width;this.treasuryText=new s.RegionLabelText(e,c-16-64,24,"0").setOrigin(1,.5),this.goldIcon=new r(e,c-16-60,24,"atlas","ui/budget-icons/treasury").setOrigin(0,.5),this.incomeText=new s.RegionLabelText(e,c-16-16,24,"+8").setOrigin(1,.5),this.trendIcon=new r(e,c-16-6,24,"atlas","ui/budget-icons/surplus"),this.add([this.treasuryText,this.goldIcon,this.incomeText,this.trendIcon])}setBuyingPawnInfo(e){if("buying"===e?.context){const{cost:t,upkeep:i}=e;this.treasuryTextController.transitionTo(this.regionInfo.treasury-t),this.incomeTextController.transitionTo(this.regionInfo.income-i)}else this.treasuryTextController.transitionTo(this.regionInfo.treasury),this.incomeTextController.transitionTo(this.regionInfo.income)}updateTrendIcon(e){this.trendIcon.setFrame((0,s.getBudgetIcon)(e))}show(){this.visibilityController.transitionTo(1)}hide(){this.visibilityController.transitionTo(0)}setRegionInfo(e){const t=this.regionInfo.id===e.id;this.regionInfo=e,t?(this.treasuryTextController.transitionTo(e.treasury),this.incomeTextController.transitionTo(e.income)):(this.treasuryTextController.setTo(e.treasury),this.incomeTextController.setTo(e.income)),this.updateNumbersLayout()}updateNumbersLayout(){const e=this.width/2;(0,s.layoutFromCenter)(e,6,[this.goldIcon,this.treasuryText,this.incomeText,this.trendIcon])}}t.CompactRegionLabel=c},58970:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompactRegionPanel=t.ExpandedState=void 0;const s=i(10780),n=i(38760),a=i(58609),o=i(16943),r=i(63286);var c;!function(e){e.Hidden="hidden",e.Collapsed="collapsed",e.Expanded="expanded"}(c=t.ExpandedState||(t.ExpandedState={}));const l={[c.Expanded]:n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height,[c.Collapsed]:0,[c.Hidden]:0};class d extends s.Box{constructor(e){super(e,s.BoxTexture.Plate,0,0,0,n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height),this.expandedState=c.Collapsed,this.mode=a.PlayUIMode.Standby,this.regionLabel=new o.CompactRegionLabel(this.scene,0,n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height),this.yController=r.Control.propOf(this,"y",{duration:n.COMPACT_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.add(this.regionLabel)}updateState(e){void 0!==e.mode&&this.setMode(e.mode),e.regionData&&this.mode===a.PlayUIMode.OwnedRegionSelected&&this.regionLabel.setRegionInfo(e.regionData),void 0!==e.heldPawnData&&this.regionLabel.setBuyingPawnInfo(e.heldPawnData)}setMode(e){e!==this.mode&&(this.mode=e,e===a.PlayUIMode.OwnedRegionSelected?this.setExpandedState(c.Expanded):this.setExpandedState(c.Hidden))}setExpandedState(e){const t=this.scene.cameras.main.displayHeight-l[e];this.yController.transitionTo(t),this.expandedState=e}reflow(){const e=this.scene.cameras.main.displayHeight,t=this.scene.cameras.main.displayWidth-2*n.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides;let i=0;switch(this.expandedState){case c.Hidden:case c.Collapsed:i=e;break;case c.Expanded:i=e-n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height}this.setPosition(n.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides,i),this.setSize(t,n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height),this.yController.setTo(i),this.regionLabel.width=t,this.regionLabel.updateNumbersLayout()}}t.CompactRegionPanel=d},19399:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SmallRoundedRectButton=t.FullScreenRollbackPanel=void 0;const s=i(95569),n=i(79578),a=i(10445),o=i(2214),r=i(1157),c=i(71203),l=i(18995),d=i(9095),h=i(44031),u=i(1951),g=i(84809),p=i(67299);var m=Phaser.Geom.Rectangle;class y extends s.BaseResponsiveContainer{constructor(e,t){super(e),this.props=t,this.ui=n.UiBuilder.for(this.scene),this.background=this.ui.rectangle(a.Colors.glassUi.background,.85).setInteractive({hitArea:new m(0,0,0,0),hitAreaCallback:m.Contains,cursor:"default"}),this.headingPanel=new f(this.scene),this.buttons=new w(this),this.resumeButton=new S(this.scene,(()=>this.handleActionTaken())),this.add([this.background,this.headingPanel,this.buttons,this.resumeButton])}updateLayout(){this.background.setPosition(0,0),this.background.setSize(this.scene.bounds.width,this.scene.bounds.height),this.background.input.hitArea=new m(0,0,this.width,this.height),this.headingPanel.width=this.width;const e=(0,u.min)(200,this.width-60);this.buttons.width=e,this.resumeButton.width=e,h.Arrange.vertically({content:[{object:this.headingPanel},{object:this.buttons},{object:this.resumeButton}],y:this.height/2,origin:.5,spacing:40}),h.Arrange.alignVertically([this.headingPanel,this.buttons,this.resumeButton],{x:this.width/2,origin:.5})}show(){this.headingPanel.updateContent(),this.buttons.rewindButton.livesCounter.setCount(c.inject.screen.play.remainingLives),this.setVisible(!0)}handleActionTaken(){this.props.onAction()}setRewindEnabled(e){this.buttons.rewindButton.setEnabled(e)}}t.FullScreenRollbackPanel=y;class f extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.campaignTitle=this.ui.text("",r.BitmapFont.Small,a.Colors.glassUi.primaryText),this.levelName=this.ui.text("",r.BitmapFont.Main,a.Colors.glassUi.primaryText),this.turnNumber=this.ui.text("",r.BitmapFont.Mini,a.Colors.glassUi.secondaryText),this.add([this.campaignTitle,this.levelName,this.turnNumber])}updateContent(){const e=g.LevelModel.for(c.inject.ui.playedLevelId());this.campaignTitle.setText(e.campaignContext?.campaign.name??"Conquest"),this.levelName.setText(e.getTitle(g.LevelTitleStyle.Full)),this.turnNumber.setText(`turn ${c.inject.gameStateModel.currentPhase.turnNumber}`),this.preUpdate.makeDirty()}updateLayout(){h.Arrange.vertically({content:[{object:this.campaignTitle},{object:this.levelName},{object:this.turnNumber}],y:0,spacing:6}),h.Arrange.alignVertically([this.campaignTitle,this.levelName,this.turnNumber],{x:this.width/2}),this.updateSize()}calculateHeight(){return this.turnNumber.y+this.turnNumber.height}}class w extends s.AutoHeightResponsiveContainer{constructor(e){super(e.scene),this.parent=e,this.rewindButton=new v(this.scene,{title:"Rewind",icon:"ui/button-icons/rollback",onClick:()=>{this.parent.handleActionTaken(),c.inject.events.trigger(l.UserActions.RollbackTurn()),c.inject.audio.playEffect(d.SoundEffects.Rewind)}}),this.restartButton=new b(this.scene,{title:"Restart",icon:"ui/button-icons/restart",onClick:()=>{this.parent.handleActionTaken(),c.inject.events.trigger(l.UserActions.RestartLevel({levelId:c.inject.ui.playedLevelId()}))}}),this.leaveButton=new b(this.scene,{title:"Leave",icon:"ui/mini-close-button",onClick:()=>{this.parent.handleActionTaken(),c.inject.events.trigger(l.UserActions.GoBack())}}),this.buttons=[this.rewindButton,this.restartButton,this.leaveButton],this.add(this.buttons)}updateLayout(){for(let e of this.buttons)e.width=this.width;h.Arrange.vertically({content:this.buttons.map((e=>({object:e}))),y:0,origin:0,spacing:20}),this.updateSize()}calculateHeight(){return this.leaveButton.y+this.leaveButton.height}}class b extends o.RoundedRectButton{constructor(e,{title:t,icon:i,onClick:s,extraContent:o}){const c=n.UiBuilder.for(e),l=c.image(i).setTint(a.Colors.glassUi.primaryText),d=c.text(t,r.BitmapFont.Small,a.Colors.glassUi.primaryText);super(e,{raised:2,content:c.hLayout({content:[l,d,...o??[]],spacing:20,originY:.5,originX:0,horizontalPadding:20})}),this.image=l,this.text=d,this.height=40,this.onClicked(s)}setEnabled(e){super.setEnabled(e);const t=e?a.Colors.glassUi.primaryText:a.Colors.glassUi.disabledText;this.image.setTint(t),this.text.setTint(t)}}t.SmallRoundedRectButton=b;class v extends b{constructor(e,t){const i=new p.LivesCounter(e).setMode(p.LivesCounterMode.FullColor);super(e,{...t,extraContent:[i]}),this.livesCounter=i}setEnabled(e){super.setEnabled(e),this.livesCounter.setMode(e?p.LivesCounterMode.FullColor:p.LivesCounterMode.Muted)}updateLayout(){super.updateLayout(),this.livesCounter.x=164}}class S extends o.RoundedRectButton{constructor(e,t){const i=n.UiBuilder.for(e);super(e,{raised:2,content:i.hLayout({content:[i.image("ui/level-icons/in-progress"),i.text("Resume",r.BitmapFont.Main,a.Colors.glassUi.primaryText)],spacing:20,originY:.5,originX:0,horizontalPadding:30})}),this.height=48,this.onClicked(t)}}},271:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HeaderButton=t.StatusHeaderUI=void 0;const s=i(95569),n=i(79578),a=i(1157),o=i(10445),r=i(44031),c=i(71203),l=i(18995),d=i(63520);var h=Phaser.GameObjects.Image;const u=i(63286);class g extends s.BaseResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.icon=this.ui.image("ui/icons/hand"),this.background=this.ui.rectangle(o.Colors.tooltip.background),this.description=this.ui.text("description",a.BitmapFont.Small,o.Colors.tooltip.text),this.exitButton=new p(this.scene,"ui/button-icons/exit",(()=>{c.inject.events.trigger(l.UserActions.ReturnHeldPawn())})),this.visibility=new u.TransitionController(this.scene,{initialValue:-32,applyValue:e=>{this.y=-32*(1-e)},duration:300,ease:"Sine.easeInOut"}),this.add([this.background,this.icon,this.description,this.exitButton]),this.visibility.setTo(0)}updateLayout(){this.width=this.scene.bounds.width,this.height=32,this.background.setSize(this.width,this.height),r.Arrange.horizontally({content:[{object:this.icon},{object:this.description}],spacing:10,x:10}),r.Arrange.horizontally({content:[{object:this.exitButton}],spacing:6,x:this.width-1,origin:1}),r.Arrange.alignHorizontally([this.icon,this.description,this.exitButton],{y:16,origin:.5})}updateState(e){e?(c.inject.scene.globalUI.headerButtons.hide(),this.visibility.transitionTo(1),this.description.setText(`${e.context} ${e.name}`)):(this.visibility.transitionTo(0),c.inject.scene.globalUI.headerButtons.adjustLayoutBasedOnScreen(c.inject.navigator.currentScreen))}}t.StatusHeaderUI=g;class p extends d.StealthButton{constructor(e,t,i){super(e,{content:new h(e,0,0,"atlas",t),radius:4}),this.height=30,this.width=34,this.onClicked(i)}}t.HeaderButton=p},38760:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.COMPACT_PLAY_UI_LAYOUT=void 0;const s=i(58609),n=i(94459);t.COMPACT_PLAY_UI_LAYOUT={regionPanel:{offsetFromSides:70,height:50},shoppingTray:{openOffsetFromBottom:106,pawnsVerticalOffset:44,pawnsSpacing:50,width:n.COMPACT_UI_MAX_WIDTH,style:s.ShoppingTrayStyle.Simple,closedOffsetFromBottom:-20,panelTransitionsDuration:500},panelTransitionsDuration:500}},32389:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LargePlayUI=t.LevelSummaryVisibility=void 0;const s=i(71203),n=i(18995),a=i(15363),o=i(58609),r=i(15171),c=i(95071),l=i(5538),d=i(62199),h=i(18518),u=i(12e3),g=i(33946),p=i(17983),m=i(74528),y=i(46252),f=i(40709),w=i(63286),b=i(56819),v=i(67299);var S,P=Phaser.GameObjects.Image;d.logger.for("ui:PlayUI"),function(e){e[e.Hidden=0]="Hidden",e[e.Shown=1]="Shown",e[e.ShownWithRollbackPanel=2]="ShownWithRollbackPanel"}(S=t.LevelSummaryVisibility||(t.LevelSummaryVisibility={})),t.LargePlayUI=class{constructor(e,t){this.scene=e,this.state=t,this.pawnHolder=new c.PawnHolder(this.scene),this.regionSummaryPopup=new p.RegionSummaryPopup(this.scene),this.headerPanel=new m.MenuPanel(this.scene),this.shoppingTray=new h.ShoppingTray(this.scene,u.LARGE_PLAY_UI_LAYOUT.shoppingTray),this.regionPanel=new r.LargeRegionPanel(this.scene),this.spectatorPanel=new g.LargeSpectatorPanel(this.scene),this.levelSummary=new b.LevelSummaryPanel(this.scene),this.livesCounter=new v.LivesCounter(this.scene),this.rollbackPanel=new f.RollbackPanel(this.scene,{onActionTaken:()=>{this.closeRollbackPanel()}}),this.rewindButton=this.rollbackPanel.rollbackButton,this.rollbackPanelVisibility=new w.TransitionController(this.scene,{duration:u.LARGE_PLAY_UI_LAYOUT.rollbackPanel.transitionDuration,ease:"Sine.easeInOut",initialValue:0,applyValue:e=>{this.rollbackPanel.y=this.scene.bounds.height-this.rollbackPanel.height*e,this.rollbackPanel.setAlpha(e)}}),this.levelSummaryVisibility=new w.TransitionController(this.scene,{initialValue:S.Hidden,ease:"Sine.easeInOut",applyValue:e=>{if(e>=1){const t=e-1,i=this._getLivesCounterY(-8*t);this.levelSummary.y=i,this.livesCounter.y=i,this.levelSummary.setAlpha(1-t),this.livesCounter.setAlpha(1),e===S.ShownWithRollbackPanel&&s.inject.gameStateController.rollbackAvailable?this.livesCounter.setMode(v.LivesCounterMode.FullColor):this.livesCounter.setMode(v.LivesCounterMode.Muted)}else{const t=this._getLivesCounterY(20*(1-e));this.levelSummary.setAlpha(e),this.livesCounter.setAlpha(e),this.levelSummary.y=t,this.livesCounter.y=t}},delay:u.LARGE_PLAY_UI_LAYOUT.rollbackPanel.transitionDuration/2,duration:u.LARGE_PLAY_UI_LAYOUT.rollbackPanel.transitionDuration/2}),this.endTurnButton=new T(this.scene),this.undoButton=new M(this.scene),this.buttonGlow=new x(this.scene),this.skipSpectatingButton=new I(this.scene),this.nextPendingRegionButton=new C(this.scene),this.bottomAnchoredComponents=[this.shoppingTray,this.regionPanel,this.spectatorPanel,this.endTurnButton,this.skipSpectatingButton,this.nextPendingRegionButton,this.undoButton,this.buttonGlow.overlayGlow,this.buttonGlow.staticGlow,this.rollbackPanel,this.levelSummary,this.livesCounter],this.endTurnButton.onClicked((()=>s.inject.events.trigger(n.UserActions.EndTurn()))),this.undoButton.on("pointerdown",(()=>{this.state.undoAvailable!==o.UndoAvailability.RollbackOnly&&this.state.undoAvailable!==o.UndoAvailability.Unavailable||s.inject.events.trigger(n.UserActions.OpenRollbackMenu())})),this.undoButton.onClicked((()=>{this.state.undoAvailable===o.UndoAvailability.Available&&s.inject.events.trigger(n.UserActions.Undo())})),this.nextPendingRegionButton.onClicked((()=>s.inject.events.trigger(n.UserActions.SelectNextPendingRegion()))),this.skipSpectatingButton.onClicked((()=>s.inject.events.trigger(n.UserActions.SkipSpectating()))),this.layer=new y.ResponsiveLayer(this.scene,[this.levelSummary,this.rollbackPanel,this.regionPanel,this.spectatorPanel,this.buttonGlow.staticGlow,this.endTurnButton,this.buttonGlow.overlayGlow,this.skipSpectatingButton,this.nextPendingRegionButton,this.undoButton,this.shoppingTray,this.regionSummaryPopup,this.headerPanel,this.livesCounter]),this.scene.add.existing(this.layer),this.updateLayout(),s.inject.ui.withoutTransitions((()=>{this.updateState(this.state)})),this.rollbackPanel.hovering.watch((e=>{e?this.cancelRollbackPanelAutoHide():this.scheduleRollbackPanelAutoHide()})),this.rollbackPanelVisibility.applyValue(0)}burnLife(){this.livesCounter.burnLife()}openRollbackPanel(){this.cancelRollbackPanelAutoHide(),this.rollbackPanelVisibility.transitionTo(1),this.levelSummaryVisibility.transitionTo(S.ShownWithRollbackPanel)}closeRollbackPanel(){this.rollbackPanelVisibility.currentTarget>0&&(s.inject.events.trigger(n.UiEvents.RollbackMenuClosed()),this.rollbackPanelVisibility.transitionTo(0),this.levelSummaryVisibility.transitionTo(S.Shown))}isRollbackPanelOpen(){return this.rollbackPanelVisibility.currentTarget>0}cancelRollbackPanelAutoHide(){this.rollbackPanelHideTimeout&&(clearTimeout(this.rollbackPanelHideTimeout),this.rollbackPanelHideTimeout=void 0)}scheduleRollbackPanelAutoHide(){this.rollbackPanelHideTimeout||(this.rollbackPanelHideTimeout=setTimeout((()=>this.closeRollbackPanel()),500))}setVisible(e){this.layer.setVisible(e)}updateLayout(){const e=this.scene.cameras.main.displayWidth,t=this.scene.cameras.main.displayHeight;this.regionPanel.updateLayout(),this.shoppingTray.updateLayout(),this.spectatorPanel.updateLayout(),this.endTurnButton.setPosition(e/2+u.LARGE_PLAY_UI_LAYOUT.spectatorPanel.width/2+u.LARGE_PLAY_UI_LAYOUT.primaryButtons.offsetFromMainPanel,t-u.LARGE_PLAY_UI_LAYOUT.primaryButtons.playModeOffsetFromBottom-this.endTurnButton.height),this.nextPendingRegionButton.copyPosition(this.endTurnButton),this.skipSpectatingButton.copyPosition(this.endTurnButton),this.undoButton.setPosition(e/2-u.LARGE_PLAY_UI_LAYOUT.spectatorPanel.width/2-u.LARGE_PLAY_UI_LAYOUT.primaryButtons.offsetFromMainPanel-this.undoButton.width,t-u.LARGE_PLAY_UI_LAYOUT.primaryButtons.playModeOffsetFromBottom-this.undoButton.height),this.buttonGlow.setPosition(this.endTurnButton.x+this.endTurnButton.width/2,this.endTurnButton.y+this.endTurnButton.height/2),this.headerPanel.setPosition(e/2,0),this.levelSummaryVisibility.setTo(this.levelSummaryVisibility.currentTarget),this.levelSummary.x=this.undoButton.x,this.levelSummary.setSize(this.undoButton.width,20),this.livesCounter.setSize(this.undoButton.width,20),this.livesCounter.x=this.undoButton.x,this.rollbackPanel.x=this.undoButton.x-6,this.rollbackPanel.width=this.undoButton.width+12}_getLivesCounterY(e){return this.undoButton.y-4-this.levelSummary.height+e}updateState(e,t=!1){if(this.state,this.state={...this.state,...e},this.spectatorPanel.updateState(e),this.regionPanel.updateState(e),void 0!==e.mode)switch(e.mode){case o.PlayUIMode.Hidden:this.endTurnButton.setVisible(!1),this.buttonGlow.setVisible(!1),this.nextPendingRegionButton.setVisible(!1),this.undoButton.setVisible(!1),this.shoppingTray.setOpen(!1),this.skipSpectatingButton.setVisible(!1),this.regionSummaryPopup.hide(),this.levelSummaryVisibility.transitionTo(S.Hidden);break;case o.PlayUIMode.Spectating:this.endTurnButton.setVisible(!1),this.buttonGlow.setVisible(!1),this.nextPendingRegionButton.setVisible(!1),this.undoButton.setVisible(!1),this.shoppingTray.setOpen(!1),this.regionSummaryPopup.hide(),this.levelSummaryVisibility.transitionTo(S.Hidden);break;case o.PlayUIMode.OwnedRegionSelected:case o.PlayUIMode.HostileRegionSelected:case o.PlayUIMode.Standby:e.mode===o.PlayUIMode.OwnedRegionSelected?this.shoppingTray.setOpen(!0):this.shoppingTray.setOpen(!1),this.endTurnButton.setVisible(!this.state.hasPendingRegions),this.nextPendingRegionButton.setVisible(this.state.hasPendingRegions),this.skipSpectatingButton.setVisible(!1),this.undoButton.setVisible(!0),e.mode!==o.PlayUIMode.HostileRegionSelected&&this.regionSummaryPopup.hide()}void 0!==e.undoAvailable&&this.undoButton.setEnabled(!0),void 0!==e.enableRollback&&this.rollbackPanel.setRollbackEnabled(e.enableRollback),void 0!==e.showLevelSummary&&this.levelSummaryVisibility.transitionTo(e.showLevelSummary?S.Shown:S.Hidden),void 0!==e.turnNumber&&this.levelSummary.setTurnNumber(e.turnNumber),e.regionData&&(e.mode===o.PlayUIMode.HostileRegionSelected?this.regionSummaryPopup.showOverRegion(e.regionData.id):e.mode===o.PlayUIMode.OwnedRegionSelected&&this.shoppingTray.setBuyablePawns(e.regionData.buyablePawns)),void 0!==e.activeFactionColor&&e.mode===o.PlayUIMode.OwnedRegionSelected&&this.shoppingTray.setColor(e.activeFactionColor),void 0!==e.enableSkipSpectating&&this.skipSpectatingButton.setVisible(this.state.enableSkipSpectating),void 0!==e.highlightEndTurn&&(this.buttonGlow.setVisible(e.highlightEndTurn),this.endTurnButton.setHighlighted(e.highlightEndTurn)),void 0!==e.livesLeft&&this.livesCounter.setCount(e.livesLeft)}update(){this.pawnHolder.update(),this.regionSummaryPopup.updatePosition()}destroy(){this.layer.destroy()}transitionIn(e=s.inject.config.screenTransitionDuration){this.updateLayout(),this.scene.tweens.add({targets:this.bottomAnchoredComponents,props:{y:{getStart:e=>e.y+160,getEnd:e=>e.y}},duration:e,ease:"Sine.easeOut"})}transitionOut(e=s.inject.config.screenTransitionDuration){this.updateLayout(),this.scene.tweens.add({targets:this.bottomAnchoredComponents,y:"+=160",duration:e,ease:"Sine.easeIn"})}getTooltipFor(e){switch(e){case this.undoButton:return this.state.undoAvailable===o.UndoAvailability.Unavailable?{title:"No more moves to undo!"}:{title:"Undo last action"};case this.endTurnButton:return{title:"End your turn now"};case this.rollbackPanel.restartButton:return{title:"Restart this island"};case this.rollbackPanel.rollbackButton:return{title:"Revert to start of previous turn",description:"This will cost you one life!"};case this.regionPanel.nextRegionButton:return{title:"Select next province"};case this.regionPanel.prevRegionButton:return{title:"Select previous province"};case this.headerPanel.menuButton:return{title:"Return to menu",description:"Don't worry, your progress is saved automatically"};case this.nextPendingRegionButton:return{title:"Select next idle province"};case this.regionPanel.box:const t=this.state.regionData;if(!t)return;return function(e,t){const i=s.inject.gameStateModel,n=i.regions.byId(e);if(!n)return;const{incomeFromHexes:a,upkeep:o,balance:r}=i.economy.budgetOf(n),c={};n.getPawns().forEach((e=>{c[e.type]?++c[e.type]:c[e.type]=1}));const d=Object.entries(c).map((([e,t])=>{const s=i.rules.pawns(e)?.upkeep??0;if(s)return` - ${s*t} coins for ${t} x ${e}`})).filter((e=>e));return{icon:"chest",title:`Income:\n + ${a} coins from ${n.size} tiles\nExpenses:\n`+d.join("\n")+"\nBalance:\n"+` ${(0,l.withSign)(r)} coins per turn`}}(t.id,t.townLevel);default:return this.shoppingTray.getTooltipFor(e)}}};class T extends a.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/end-turn",down:!0})}setHighlighted(e){this.setBaseFrame(e?"ui/primary-buttons/end-turn-glow":"ui/primary-buttons/end-turn")}}class x{constructor(e){this.scene=e,this.staticGlow=new P(this.scene,0,0,"atlas","ui/primary-buttons/static-glow").setTint(16777088),this.overlayGlow=new P(this.scene,0,0,"atlas","ui/primary-buttons/overlay-glow").setTint(16777088),this.scene.tweens.add({targets:this.staticGlow,scaleX:{from:.95,to:1.05},scaleY:{from:.9,to:1.1},yoyo:!0,repeat:-1,duration:350,ease:"Sine.easeInOut"}),this.scene.tweens.add({targets:this.overlayGlow,alpha:{from:0,to:1},duration:350,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}setVisible(e){this.staticGlow.setVisible(e),this.overlayGlow.setVisible(e)}setPosition(e,t){this.staticGlow.setPosition(e,t),this.overlayGlow.setPosition(e,t)}}class M extends a.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/undo",down:!0,disabled:!0})}}class C extends a.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/next",down:!0})}}class I extends a.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/skip",down:!0})}}},76114:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBudgetIcon=t.layoutFromCenter=t.layoutFromRight=t.RegionLabelText=t.LargeRegionLabel=void 0;var s=Phaser.GameObjects.Image,n=Phaser.GameObjects.BitmapText;const a=i(1951),o=i(1157),r=i(5538),c=i(63286),l=i(17225),d=i(73508),h=i(76038),u=i(44031),g=30;class p extends Phaser.GameObjects.Container{constructor(e,t,i){super(e),this.width=t,this.height=i,this.regionInfo={buyablePawns:[],name:"",treasury:0,income:0,id:-1,townLevel:1},this.treasuryTextController=new c.TransitionController(this.scene,{duration:400,initialValue:0,applyValue:e=>{this.treasuryText.setText(e.toFixed(0)),this.updateNumbersLayout()}}),this.incomeTextController=new c.TransitionController(this.scene,{duration:400,initialValue:0,applyValue:e=>{this.incomeText.setText((0,r.withSign)(Math.trunc(e))),this.updateTrendIcon(e),this.updateNumbersLayout()}}),this.line1center=38,this.line2center=this.line1center-24;const n=this.width,a=this.line1center,l=this.line2center;this.regionIcon=new s(e,40,a,"atlas","pawns/town-1").setScale(.5,.5).setOrigin(.5,.5),this.regionNameText=new m(e,66,a,"Kingdom"),this.treasuryText=new m(e,n-g-54,a,"0").setOrigin(0,0),this.treasuryIcon=new s(e,this.treasuryText.x-34-16,a,"atlas","ui/budget-icons/treasury").setOrigin(0,0),this.incomeText=new m(e,n-g-16,a,"+8").setOrigin(0,0),this.trendIcon=new s(e,n-g-20,a,"atlas","ui/budget-icons/surplus"),this.selectedPawnArrow=new s(e,78,l+5,"atlas","ui/arrow-icon"),this.selectedPawnArrow.flipY=!0,this.selectedPawnText=new m(e,90,l,"",o.BitmapFont.Mini),this.selectedPawnCostText=new m(e,this.treasuryText.x,l,"",o.BitmapFont.Mini).setOrigin(1,.5),this.selectedPawnUpkeepText=new m(e,this.incomeText.x,l,"",o.BitmapFont.Mini).setOrigin(1,.5),this.add([this.regionIcon,this.regionNameText,this.treasuryText,this.treasuryIcon,this.incomeText,this.trendIcon,this.selectedPawnText,this.selectedPawnCostText,this.selectedPawnArrow,this.selectedPawnUpkeepText])}setRegionInfo(e){this.regionNameText.setText(e.name),this.regionInfo.id===e.id?(this.treasuryTextController.transitionTo(e.treasury),this.incomeTextController.transitionTo(e.income)):(this.treasuryTextController.setTo(e.treasury),this.incomeTextController.setTo(e.income)),this.regionInfo=e,this.regionIcon.setFrame((0,l.getFrameForPawnType)(d.PawnType.Town,(0,h.cropNumber)(e.townLevel,1,4))).setOrigin(.5,.5)}updateNumbersLayout(){u.Arrange.fromLeftToRightOld([this.treasuryIcon,this.treasuryText,this.incomeText],{x:this.width-g-34,y:this.line1center,originY:.5,originX:1,spacing:8}),this.selectedPawnCostText.x=this.treasuryText.x+this.treasuryText.width,this.selectedPawnUpkeepText.x=this.incomeText.x+this.incomeText.width}updateTrendIcon(e){this.trendIcon.setFrame(y(e))}setBuyingPawnInfo(e){if("buying"===e?.context){const{name:t,cost:i,upkeep:s}=e;this.selectedPawnText.setText(t),this.selectedPawnCostText.setText("-"+i.toString()),this.selectedPawnUpkeepText.setText("-"+s.toString()),[this.selectedPawnArrow,this.selectedPawnText,this.selectedPawnCostText].forEach((e=>e.setVisible(!0))),this.selectedPawnUpkeepText.setVisible(!!s),this.treasuryTextController.transitionTo(this.regionInfo.treasury-i),this.incomeTextController.transitionTo(this.regionInfo.income-s),this.goToVerticalOffset(8)}else this.clearSelectedPawnData(),this.treasuryTextController.transitionTo(this.regionInfo.treasury),this.incomeTextController.transitionTo(this.regionInfo.income),this.goToVerticalOffset(0)}clearSelectedPawnData(){[this.selectedPawnArrow,this.selectedPawnText,this.selectedPawnCostText,this.selectedPawnUpkeepText].forEach((e=>e.setVisible(!1)))}goToVerticalOffset(e){this.scene.tweens.add({targets:this,y:e,scale:1,ease:"Sine.easeOut",duration:200})}}t.LargeRegionLabel=p;class m extends n{constructor(e,t,i,s,n=o.BitmapFont.Main){super(e,t,i,n,s),this.setTint(5583648),this.setOrigin(0,.5)}}function y(e){return 0===e?"ui/budget-icons/neutral":e>0?"ui/budget-icons/surplus":"ui/budget-icons/deficit"}t.RegionLabelText=m,t.layoutFromRight=function(e,t,i){let s=e;for(let e of i.reverse())e.x=s-(1-e.originX)*e.width,s=s-e.width-t},t.layoutFromCenter=function(e,t,i){let s=e-(i.map((e=>e.width)).reduce(a.sum)+t*(i.length-1))/2;for(let e of i)e.x=s+e.originX*e.width,s=s+e.width+t},t.getBudgetIcon=y},15171:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LargeRegionPanel=t.ExpandedState=void 0;const s=i(10780),n=i(76114),a=i(12e3),o=i(58609),r=i(71203),c=i(77949),l=i(18995),d=i(63286);var h=Phaser.GameObjects.Image;const u=i(95569);var g;!function(e){e.Hidden="hidden",e.Collapsed="collapsed",e.Expanded="expanded"}(g=t.ExpandedState||(t.ExpandedState={}));const p={[g.Expanded]:a.LARGE_PLAY_UI_LAYOUT.regionPanel.expandedOffsetFromBottom,[g.Collapsed]:a.LARGE_PLAY_UI_LAYOUT.regionPanel.collapsedOffsetFromBottom,[g.Hidden]:0};class m extends u.BaseResponsiveContainer{constructor(e){super(e),this.expandedState=g.Collapsed,this.browseRegionButtonsEnabled=!1,this.mode=o.PlayUIMode.Standby,this.regionLabel=new n.LargeRegionLabel(this.scene,a.LARGE_PLAY_UI_LAYOUT.regionPanel.width,a.LARGE_PLAY_UI_LAYOUT.regionPanel.height),this.nextRegionButton=new y(this.scene,!1),this.prevRegionButton=new y(this.scene,!0),this.sizeController=d.Control.propOf(this,"y",{duration:a.LARGE_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.box=new s.Box(e,s.BoxTexture.RoundedPlate,0,0,a.LARGE_PLAY_UI_LAYOUT.regionPanel.width,a.LARGE_PLAY_UI_LAYOUT.regionPanel.height),this.setDepth(o.PlayUILayers.MainPanel),this.add([this.nextRegionButton,this.prevRegionButton,this.box,this.regionLabel]),this.box.setInteractiveAuto(),this.box.input.cursor="default",this.box.on("pointerdown",(()=>{r.inject.events.trigger(l.UserActions.ToggleTooltip({object:this.box}))})),this.nextRegionButton.onClicked((()=>r.inject.events.trigger(l.UserActions.SelectNextRegion()))),this.prevRegionButton.onClicked((()=>r.inject.events.trigger(l.UserActions.SelectPreviousRegion())))}updateState(e){void 0!==e.mode&&this.setMode(e.mode),e.regionData&&this.mode===o.PlayUIMode.OwnedRegionSelected&&this.regionLabel.setRegionInfo(e.regionData),void 0!==e.enableNextRegion&&this.setBrowseRegionsButtonsEnabled(e.enableNextRegion),void 0!==e.heldPawnData&&this.regionLabel.setBuyingPawnInfo(e.heldPawnData)}setMode(e){e!==this.mode&&(this.mode=e,e===o.PlayUIMode.OwnedRegionSelected?this.setExpandedState(g.Expanded):(this.setExpandedState(g.Hidden),this.setBrowseRegionsButtonsEnabled(!1)))}setExpandedState(e){const t=this.scene.cameras.main.displayHeight-p[e];this.sizeController.transitionTo(t),this.expandedState=e}setBrowseRegionsButtonsEnabled(e){this.browseRegionButtonsEnabled=e;const t=this.prevRegionButton.props.width,i=e?4-t:0,s=e?a.LARGE_PLAY_UI_LAYOUT.regionPanel.width-4:a.LARGE_PLAY_UI_LAYOUT.regionPanel.width-t;if(r.inject.ui.skipTransitions())return this.nextRegionButton.x=s,void(this.prevRegionButton.x=i);this.scene.tweens.add({targets:this.prevRegionButton,x:i,scale:1,ease:"Sine.easeOut",duration:a.LARGE_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.scene.tweens.add({targets:this.nextRegionButton,x:s,scale:1,ease:"Sine.easeOut",duration:a.LARGE_PLAY_UI_LAYOUT.panelTransitionsDuration})}updateLayout(){const e=this.scene.cameras.main.displayHeight;let t=0;switch(this.expandedState){case g.Hidden:t=e;break;case g.Collapsed:t=e-a.LARGE_PLAY_UI_LAYOUT.regionPanel.collapsedOffsetFromBottom;break;case g.Expanded:t=e-a.LARGE_PLAY_UI_LAYOUT.regionPanel.expandedOffsetFromBottom}r.inject.ui.withoutTransitions((()=>{this.setBrowseRegionsButtonsEnabled(this.browseRegionButtonsEnabled)})),this.setPosition(this.scene.cameras.main.displayWidth/2-a.LARGE_PLAY_UI_LAYOUT.regionPanel.width/2,t),this.sizeController.setTo(t)}}t.LargeRegionPanel=m;class y extends c.RibbonButton{constructor(e,t){super(e,0,a.LARGE_PLAY_UI_LAYOUT.regionPanel.nextRegionButtonOffsetFromTop,{audio:!1,type:c.RibbonButtonStyle.Medium,width:36,content:f(e,t),contentOffset:{y:-3}})}}function f(e,t){const i=new h(e,0,0,"atlas","ui/button-icons/play");return i.flipX=t,i}},33946:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LargeSpectatorPanel=t.ExpandedState=void 0;const s=i(10780),n=i(12e3),a=i(58609),o=i(71203),r=i(85478),c=i(98538),l=i(63286),d=i(91895),h=i(18995),u=i(56421),g=i(1157);var p=Phaser.GameObjects.Image,m=Phaser.GameObjects.BitmapText;const y=i(95569),f=n.LARGE_PLAY_UI_LAYOUT;var w;!function(e){e.Hidden="hidden",e.Collapsed="collapsed",e.Expanded="expanded"}(w=t.ExpandedState||(t.ExpandedState={}));const b={[w.Expanded]:f.spectatorPanel.expandedOffsetFromBottom,[w.Collapsed]:f.spectatorPanel.collapsedOffsetFromBottom,[w.Hidden]:0};class v extends y.ResponsiveContainer{constructor(e){super(e),this.expandedState=w.Collapsed,this.mode=a.PlayUIMode.Standby,this.statusIcon=new p(this.scene,0,0,"atlas","ui/hourglass"),this.sizeController=l.Control.propOf(this,"y",{duration:f.panelTransitionsDuration}),this.spectatingMessage="",this.powerBalanceRibbon=new r.PowerBalanceRibbon(this.scene,{x:f.spectatorPanel.padding,y:f.spectatorPanel.padding,width:f.spectatorPanel.width-2*f.spectatorPanel.padding,minSize:36}),this.box=new s.Box(e,s.BoxTexture.RoundedPlate,0,0,f.spectatorPanel.width,f.spectatorPanel.height),this.statusMessage=new m(this.scene,0,0,g.BitmapFont.Main,"").setTint(5583648),this.playSpeedButtons=new c.MiniButtonsRow(this.scene,["ui/mini-icons/play","ui/mini-icons/fast-forward","ui/mini-icons/super-fast-forward"]),this.pauseButton=new d.ImageButtonWithContent(this.scene,0,0,{frame:"ui/mini-buttons/wide",content:new p(this.scene,0,0,"atlas","ui/mini-icons/pause"),down:!0,controller:null}),this.playSpeedButtonsGroupController=u.ButtonControllers.options({[a.SpectatingPlaybackSpeed.Paused]:this.pauseButton,[a.SpectatingPlaybackSpeed.Normal]:this.playSpeedButtons.buttons[0],[a.SpectatingPlaybackSpeed.Fast]:this.playSpeedButtons.buttons[1],[a.SpectatingPlaybackSpeed.UltraFast]:this.playSpeedButtons.buttons[2]}),this.playSpeedButtonsGroupController.onButtonClicked((e=>{const t=Number(e);t!==o.inject.ui.spectatingSpeed()?o.inject.events.trigger(h.UserActions.SetSpectatingPlayBackSpeed(t)):t===a.SpectatingPlaybackSpeed.Paused&&o.inject.events.trigger(h.UserActions.SetSpectatingPlayBackSpeed(a.SpectatingPlaybackSpeed.Normal))})),this.playSpeedButtons.setPosition(this.box.width-f.spectatorPanel.padding-this.playSpeedButtons.width,f.spectatorPanel.centerLineOffsetFromTop),this.pauseButton.setPosition(this.playSpeedButtons.x-this.pauseButton.width-8,this.playSpeedButtons.y),this.statusMessage.setPosition(f.spectatorPanel.padding+36,f.spectatorPanel.centerLineOffsetFromTop-2),this.statusIcon.setPosition(f.spectatorPanel.padding+10,f.spectatorPanel.centerLineOffsetFromTop),this.setDepth(a.PlayUILayers.MainPanel),this.add([this.box,this.powerBalanceRibbon,this.playSpeedButtons,this.pauseButton,this.statusMessage,this.statusIcon])}updateState(e){void 0!==e.mode&&this.setMode(e.mode),e.powerBalance&&this.powerBalanceRibbon.updateState(e.powerBalance),void 0!==e.spectatingSpeed&&(this.playSpeedButtonsGroupController.selectButton(e.spectatingSpeed.toString()),this.statusMessage.setText(e.spectatingSpeed===a.SpectatingPlaybackSpeed.Paused?"< PAUSED >":this.spectatingMessage)),e.spectatingState&&(this.spectatingMessage=e.spectatingState,this.statusMessage.setText(e.spectatingState))}setMode(e){if(e!==this.mode)switch(this.mode=e,e){case a.PlayUIMode.Spectating:this.setExpandedState(w.Expanded);break;case a.PlayUIMode.Standby:default:this.setExpandedState(w.Collapsed)}}setExpandedState(e){const t=this.scene.cameras.main.displayHeight-b[e];this.sizeController.transitionTo(t)}updateLayout(){const e=this.scene.cameras.main.displayWidth,t=this.scene.cameras.main.displayHeight;let i=0;switch(this.expandedState){case w.Hidden:i=t;break;case w.Collapsed:i=t-f.spectatorPanel.collapsedOffsetFromBottom;break;case w.Expanded:i=t-f.spectatorPanel.expandedOffsetFromBottom}this.setPosition(e/2-f.spectatorPanel.width/2,i),this.sizeController.setTo(i)}}t.LargeSpectatorPanel=v},56819:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelSummaryPanel=void 0;const s=i(79578),n=i(1157),a=i(10445),o=i(95569),r=i(7721),c=i(71203),l=i(18995),d=i(9095);class h extends o.BaseResponsiveContainer{constructor(e){super(e),this.ui=s.UiBuilder.for(this.scene),this.background=new r.RoundedRect(this.scene,{fillStyle:{color:a.Colors.glassUi.shape,alpha:1},radius:8}).setVisible(!1),this.turnNumberText=this.ui.text("Turn 2",n.BitmapFont.MiniBold,a.Colors.darker(a.Colors.glassUi.shapeShadow)),this.add([this.background,this.turnNumberText]),this.setInteractiveAuto(),this.on("pointerover",(()=>{this.background.setVisible(!0)})),this.on("pointerdown",(()=>{c.inject.audio.playEffect(d.SoundEffects.ButtonUp),c.inject.events.trigger(l.UserActions.OpenRollbackMenu())})),this.on("pointerout",(()=>{this.background.setVisible(!1)}))}updateLayout(){this.turnNumberText.setOrigin(0,.5).setPosition(8,this.height/2),this.background.setSize(this.width,this.height)}setTurnNumber(e){this.turnNumberText.setText(`Turn ${e}`)}}t.LevelSummaryPanel=h},67299:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LivesCounter=t.LivesCounterMode=void 0;const s=i(79578),n=i(10445),a=i(95569),o=i(44031),r=i(87951),c=i(52163),l=i(62199).logger.for("LivesCounter");var d;!function(e){e.Muted="muted",e.FullColor="full-color"}(d=t.LivesCounterMode||(t.LivesCounterMode={}));class h extends a.BaseResponsiveContainer{constructor(e){super(e),this.ui=s.UiBuilder.for(this.scene),this.displayMode=d.Muted,this.pool=new r.Pool((()=>this.ui.image("ui/mini-icons/heart"))).preload(3),this.lives=[]}setMode(e){return this.displayMode===e||(this.displayMode=e,this.lives.forEach((t=>u(t,e)))),this}setCount(e){(0,c.assert)(e>=0);for(let t=this.lives.length;t<e;++t){const e=u(this.pool.take(),this.displayMode);this.lives.push(e),this.add(e)}for(;this.lives.length>e;){const e=this.lives.pop();this.pool.free(e),this.remove(e)}this.preUpdate.makeDirty()}updateLayout(){o.Arrange.fromLeftToRightOld(this.lives,{x:this.width-2,y:this.height/2,originX:1,spacing:4})}burnLife(){const e=this.lives.shift();e?(this.remove(e),this.scene.add.existing(e),e.setPosition(this.x+e.x,this.y+e.y),this.scene.tweens.add({targets:[e],props:{y:"-=20",alpha:0},duration:1e3,ease:"Sine.easeOut",onComplete:()=>this.pool.free(e)}),this.preUpdate.makeDirty()):l.warning("Requested to burn one life, but there are no lives left.")}}function u(e,t){switch(e.setAlpha(1),t){case d.FullColor:return e.setFrame("ui/mini-icons/heart-colored"),e.clearTint(),e;case d.Muted:return e.setFrame("ui/mini-icons/heart"),e.setTint(n.Colors.glassUi.disabledText),e}}t.LivesCounter=h},74528:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MenuPanel=void 0;var s=Phaser.GameObjects.Graphics,n=Phaser.GameObjects.Image;const a=i(71203),o=i(18995),r=i(95569);var c=Phaser.GameObjects.BitmapText;const l=i(1157),d=i(10445),h=i(77949),u=100,g=30;class p extends r.ResponsiveContainer{constructor(e){super(e),this.background=new s(this.scene),this.menuButton=new h.RibbonButton(this.scene,0,0,{type:h.RibbonButtonStyle.Small,icon:new n(this.scene,0,0,"atlas","ui/mini-icons/up").setTint(d.Colors.woodenUi.primaryText),content:new c(this.scene,0,0,l.BitmapFont.Small,"MENU").setTint(d.Colors.woodenUi.primaryText),width:u}),this.width=u+8,this.height=g+8,this.menuButton.onClicked((()=>{a.inject.events.trigger(o.UserActions.GoBack())})),this.add([this.background,this.menuButton])}updateLayout(){this.background.clear(),this.background.fillStyle(16777215,.5),this.background.fillRoundedRect(-this.width/2,0,this.width,this.height,{tl:0,tr:0,bl:16,br:16}),this.menuButton.setPosition(4-this.width/2,4)}}t.MenuPanel=p},95071:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnHolder=void 0;var s=Phaser.GameObjects.Image;const n=i(13872),a=i(52163);t.PawnHolder=class{constructor(e){this.scene=e}pickUpPawn(e,t,i,o=1){a.assert.undefined(this.heldPawn),this.heldPawn=e,this.heldPawnImage=new s(this.scene,t,i,"atlas","pawns/"+e),this.followCursor=!0,this.scene.add.existing(this.heldPawnImage),console.log("FROM",t,i),this.pickupTween=this.scene.tweens.add({targets:this.heldPawnImage,x:this.scene.input.activePointer.x,y:this.scene.input.activePointer.y,scale:{from:o,to:1},duration:n.TIMING.pawnPickupTransition,ease:"Sine.easeInOut",onComplete:()=>{this.pickupTween=void 0}})}update(){this.followCursor&&(!this.heldPawnImage||this.pickupTween||this.dropTween?this.pickupTween&&(this.pickupTween.updateTo("x",this.scene.input.activePointer.x,!0),this.pickupTween.updateTo("y",this.scene.input.activePointer.y,!0)):this.heldPawnImage.setPosition(this.scene.input.activePointer.x,this.scene.input.activePointer.y))}setFixedPosition(e,t){this.pickupTween&&this.pickupTween.stop(),this.followCursor=!1,this.pickupTween=this.scene.tweens.add({targets:this.heldPawnImage,x:e,y:t,scale:1,duration:n.TIMING.pawnPickupTransition,ease:"Sine.easeInOut",onComplete:()=>{this.pickupTween=void 0}})}dropPawn(e,t,i,s){const a=this.heldPawnImage;this.heldPawnImage=void 0,this.heldPawn=void 0,a&&(this.pickupTween?.stop(),this.dropTween?.stop(),this.dropTween=this.scene.tweens.add({targets:a,x:e,y:t,scale:i,duration:n.TIMING.pawnDropTransition,ease:"Sine.easeInOut",onComplete:()=>{a.destroy(),this.dropTween=void 0,s()}}))}clear(){this.heldPawnImage?.destroy(),this.heldPawnImage=void 0,this.heldPawn=void 0,this.pickupTween?.stop(),this.pickupTween=void 0}setPawnType(e){this.heldPawnImage?.setFrame("pawns/"+e)}}},40709:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RollbackPanel=void 0;const s=i(95569),n=i(79578),a=i(1157),o=i(10445),r=i(44031),c=i(7721),l=i(71203),d=i(18995),h=i(65641),u=i(9095);var g=Phaser.GameObjects.Rectangle;class p extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.hovering=(0,h.watchable)(!1),this.background=new c.RoundedRect(e,{radius:{tl:8,tr:8,bl:0,br:0},fillStyle:{color:o.Colors.glassUi.shape,alpha:1}}),this.restartButton=new m(this.scene,{icon:"ui/button-icons/restart",text:"Restart level",onClick:()=>{l.inject.events.trigger(d.UserActions.RestartLevel({levelId:l.inject.ui.playedLevelId()})),l.inject.audio.playEffect(u.SoundEffects.ButtonUp),t.onActionTaken()},onHover:this.handleButtonHover.bind(this)}),this.rollbackButton=new m(this.scene,{icon:"ui/button-icons/rollback",text:"Rewind",onClick:()=>{l.inject.events.trigger(d.UserActions.RollbackTurn()),l.inject.audio.playEffect(u.SoundEffects.Rewind),t.onActionTaken()},onHover:this.handleButtonHover.bind(this)}),this.setInteractiveAuto(),this.input.cursor="default",this.on("pointerover",(()=>{this.hovering.set(!0)})),this.on("pointerout",(()=>{this.hovering.set(!1)})),this.menuItems=[this.restartButton,this.rollbackButton],this.add([this.background,...this.menuItems])}setRollbackEnabled(e){this.rollbackButton.setEnabled(e)}handleButtonHover(e){this.hovering.set(e)}updateLayout(){for(let e of this.menuItems)e.setSize(this.width,30);r.Arrange.fromTopToBottomOld(this.menuItems,{x:0,y:6,spacing:0}),this.updateSize(),this.background.setSize(this.width,this.height)}calculateHeight(){return 6+30*this.menuItems.length+60}}t.RollbackPanel=p;class m extends s.BaseResponsiveContainer{constructor(e,t){super(e);const i=n.UiBuilder.for(e);this._text=i.text(t.text,a.BitmapFont.Small,o.Colors.glassUi.primaryText).setOrigin(0,.5),this._icon=i.image(t.icon,o.Colors.glassUi.primaryText).setOrigin(.5,.5),this._background=new g(e,0,0,0,0,o.Colors.glassUi.shapeLightAccent).setVisible(!1),this.setInteractiveAuto(),this.on("pointerdown",(()=>{t.onClick()})),this.on("pointerover",((e,i,s,n)=>{t.onHover(!0),this._background.setVisible(!0)})),this.on("pointerout",((e,i,s,n)=>{t.onHover(!1),this._background.setVisible(!0)})),this.on("pointerout",((e,t)=>{t.stopPropagation(),this._background.setVisible(!1)})),this.add([this._background,this._icon,this._text])}setEnabled(e){const t=e?o.Colors.glassUi.primaryText:o.Colors.glassUi.disabledText;this._text.setTint(t),this._icon.setTint(t),this.input.enabled=e}updateLayout(){this._icon.setPosition(22,15),this._background.setSize(this.width,this.height),this._text.setPosition(38,15)}}},12e3:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LARGE_PLAY_UI_LAYOUT=void 0;const s=i(58609);t.LARGE_PLAY_UI_LAYOUT={regionPanel:{width:354,height:300,collapsedOffsetFromBottom:52,expandedOffsetFromBottom:96,nextRegionButtonOffsetFromTop:42},spectatorPanel:{width:418,height:300,collapsedOffsetFromBottom:26,expandedOffsetFromBottom:70,padding:10,centerLineOffsetFromTop:34},shoppingTray:{pawnsVerticalOffset:46,pawnsSpacing:60,width:354,style:s.ShoppingTrayStyle.Elaborate,openOffsetFromBottom:154,closedOffsetFromBottom:0,panelTransitionsDuration:500},primaryButtons:{offsetFromMainPanel:12,playModeOffsetFromBottom:6},rollbackPanel:{transitionDuration:200},panelTransitionsDuration:500}},58609:(e,t)=>{"use strict";var i,s,n,a,o,r,c,l;Object.defineProperty(t,"__esModule",{value:!0}),t.PlayUILayers=t.ShoppingTrayStyle=t.MainPanelMode=t.DEFAULT_PLAY_UI_STATE=t.SpectatingState=t.UndoAvailability=t.SpectatingPlaybackSpeed=t.PrimaryButton=t.PlayUIMode=void 0,function(e){e.Standby="standby",e.OwnedRegionSelected="owned-region-selected",e.HostileRegionSelected="hostile-region-selected",e.Spectating="spectating",e.Hidden="hidden"}(i=t.PlayUIMode||(t.PlayUIMode={})),(l=t.PrimaryButton||(t.PrimaryButton={})).None="none",l.EndTurn="end-turn",l.NextRegion="next-region",function(e){e[e.Paused=0]="Paused",e[e.Normal=1]="Normal",e[e.Fast=2]="Fast",e[e.UltraFast=3]="UltraFast"}(s=t.SpectatingPlaybackSpeed||(t.SpectatingPlaybackSpeed={})),function(e){e.Unavailable="unavailable",e.RollbackOnly="rollback-only",e.Available="available"}(n=t.UndoAvailability||(t.UndoAvailability={})),function(e){e.EnemyTurn="Enemy turn...",e.BanditsAct="Bandits activity...",e.GatherIncome="Collecting income..."}(a=t.SpectatingState||(t.SpectatingState={})),t.DEFAULT_PLAY_UI_STATE={mode:i.Hidden,activeFactionColor:0,enableNextRegion:!1,enableRollback:!1,undoAvailable:n.Unavailable,enableSkipSpectating:!1,hasPendingRegions:!1,highlightEndTurn:!1,heldPawnData:null,regionData:null,powerBalance:[],showLevelSummary:!1,spectatingSpeed:s.UltraFast,spectatingState:a.EnemyTurn,turnNumber:1,livesLeft:0},(c=t.MainPanelMode||(t.MainPanelMode={})).Hidden="hidden",c.RegionInfo="region-info",c.SpectatorControls="spectator-controls",c.Overview="overview",(r=t.ShoppingTrayStyle||(t.ShoppingTrayStyle={})).Simple="simple",r.Elaborate="elaborate",(o=t.PlayUILayers||(t.PlayUILayers={}))[o.BackroundButtons=0]="BackroundButtons",o[o.ShoppingTray=1]="ShoppingTray",o[o.ShoppingTrayCloth=2]="ShoppingTrayCloth",o[o.SpectatingPanel=3]="SpectatingPanel",o[o.MainPanel=4]="MainPanel",o[o.Pawns=5]="Pawns",o[o.Label=6]="Label",o[o.Buttons=7]="Buttons"},18866:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegenerateLevelButton=t.LevelNamePanel=void 0;const s=i(95569),n=i(79578),a=i(1157),o=i(10445),r=i(2214),c=i(71203),l=i(18995);class d extends s.BaseResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.bgImage=this.ui.image("logos/ship"),this.headerText=this.ui.text("Setting sail for",a.BitmapFont.Small,o.Colors.glassUi.primaryText),this.levelNameText=this.ui.text("Unknown Island",a.BitmapFont.Main,o.Colors.glassUi.primaryText),this.regenerateLevelButton=new h(this.ui),this.regenerateLevelButton.onClicked((()=>c.inject.events.trigger(l.UserActions.GenerateNewIsland()))),this.add([this.bgImage,this.headerText,this.levelNameText,this.regenerateLevelButton])}updateLayout(){this.bgImage.setPosition(this.width/2-this.bgImage.width/2,20),this.headerText.setOrigin(.5,.5).setPosition(this.width/2,this.height-d.Layout.spaceForButton-60),this.levelNameText.setOrigin(.5,.5).setPosition(this.width/2,this.height-d.Layout.spaceForButton-30),this.regenerateLevelButton.setSize(150,30),this.regenerateLevelButton.setPosition(this.width/2-this.regenerateLevelButton.width/2,this.height-this.regenerateLevelButton.height/2-d.Layout.spaceForButton/2)}}t.LevelNamePanel=d,d.Layout={spaceForButton:56};class h extends r.RoundedRectButton{constructor(e){const t=e.image("ui/button-icons/restart").setTint(o.Colors.glassUi.secondaryText),i=e.text("Next Island",a.BitmapFont.Small,o.Colors.glassUi.secondaryText),s=e.hLayout({spacing:10,originY:.5,originX:.5,content:[t,i]});super(e.scene,{raised:2,audio:!0,contentOriginX:.5,content:s}),this.icon=t,this.label=i,this.layout=s}setEnabled(e){this.icon.setFrame(e?"ui/button-icons/restart":"ui/button-icons/search"),this.label.setText(e?"Next Island":"Searching..."),super.setEnabled(e)}}t.RegenerateLevelButton=h},68488:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapSettingsPanel=void 0;const s=i(95569),n=i(79578),a=i(36139),o=i(8988),r=i(44031),c=i(14090);class l extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.compressLayout=!1,this.ui=n.UiBuilder.for(this.scene),this.onSettingChanged=(0,c.signal)(),this.sizeSelector=new a.SelectBoxWithArrows(this.scene,{title:"Size",options:[o.MapSize.Small,o.MapSize.Medium,o.MapSize.Large].map((e=>({value:e,title:e}))),selectedOption:o.MapSize.Medium}),this.shapeSelector=new a.SelectBoxWithArrows(this.scene,{title:"Island Type",options:[o.MapShape.Temperate,o.MapShape.Marshlands,o.MapShape.Flat].map((e=>({value:e,title:e}))),selectedOption:o.MapShape.Temperate,infinite:!0}),this.modeSelector=new a.SelectBoxWithArrows(this.scene,{title:"Mode",options:[o.MapMode.Classic,o.MapMode.Colonization,o.MapMode.Crowded].map((e=>({value:e,title:e}))),selectedOption:o.MapMode.Classic,infinite:!0}),this.difficultySelector=new a.SelectBoxWithArrows(this.scene,{title:"Difficulty",options:[o.MapDifficulty.Casual,o.MapDifficulty.Challenging,o.MapDifficulty.Unfair].map((e=>({value:e,title:e}))),selectedOption:o.MapDifficulty.Challenging}),this.sizeSelector.onSelect((({value:e,direction:t})=>{this.onSettingChanged.fire({update:{size:e},direction:"left"===t?"right":"left"})})),this.shapeSelector.onSelect((({value:e,direction:t})=>{this.onSettingChanged.fire({update:{shape:e},direction:"left"===t?"right":"left"})})),this.modeSelector.onSelect((({value:e,direction:t})=>{this.onSettingChanged.fire({update:{mode:e}})})),this.difficultySelector.onSelect((({value:e,direction:t})=>{this.onSettingChanged.fire({update:{difficulty:e}})})),this.add([this.sizeSelector,this.shapeSelector,this.modeSelector,this.difficultySelector])}applyState(e,t,i){e.mode&&this.modeSelector.setSelection(e.mode),e.size&&this.sizeSelector.setSelection(e.size),e.shape&&this.shapeSelector.setSelection(e.shape),e.difficulty&&this.difficultySelector.setSelection(e.difficulty)}updateLayout(){[this.sizeSelector,this.shapeSelector,this.modeSelector,this.difficultySelector].forEach((e=>e.width=this.width)),r.Arrange.fromTopToBottomOld([this.sizeSelector,this.shapeSelector,this.modeSelector,this.difficultySelector],{x:0,y:0,spacing:this.compressLayout?4:14}),this.updateSize()}calculateHeight(){return this.difficultySelector.y+this.difficultySelector.height}}t.MapSettingsPanel=l,l.Layout={}},46900:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BeginButton=t.RandomMapSelectScene=t.DEFAULT_STATE=void 0;const s=i(84612),n=i(48565),a=i(9724),o=i(61720),r=i(79578),c=i(1157),l=i(91089),d=i(10445),h=i(2214),u=i(44031),g=i(71203),p=i(18995),m=i(77949),y=i(8988),f=i(18866),w=i(68488),b=i(38918),v=i(30707),S=i(9095),P=i(38735);var T=Phaser.GameObjects.Image;t.DEFAULT_STATE={preset:{seed:0,size:y.MapSize.Medium,shape:y.MapShape.Temperate,difficulty:y.MapDifficulty.Challenging,mode:y.MapMode.Classic}};class x extends a.BaseUIScene{constructor(){super({key:s.Scenes.RandomMapSelectUI}),this.state=(0,o.StateContainer)(this,t.DEFAULT_STATE),this.mapGenerator=new v.AsyncJobExclusiveRunner(((e,t)=>this._generateMap(e,t))),this.preUpdate=(0,n.whenDirty)((()=>{const e=this.bounds.height,t=e<555;this.mainPanelUI.updateLayout(),this.settingsPanel.compressLayout=t,this.settingsPanel.updateLayout(),this.backButton.setPosition(this.mainPanelUI.mainPanel.x+30,20),u.Arrange.vertically({content:[{object:this.levelNamePanel,size:250,minSize:130},{object:this.settingsPanel},{object:this.beginButton,size:50}],y:e/2,origin:.5,spacing:t?15:30,maxSize:e-60}),u.Arrange.alignVertically([this.levelNamePanel,this.settingsPanel,this.beginButton],{x:this.mainPanelUI.mainPanel.x+this.mainPanelUI.mainPanel.width/2,origin:.5,width:this.mainPanelUI.mainPanel.width-60})}))}applyState(e,t,i){e.preset&&this.settingsPanel.applyState(e.preset,t.preset,i.preset)}create(){super.create();const e=r.UiBuilder.for(this);this.mainPanelUI=new l.VerticalStripePanelUI(this),this.mainPanelUI.addToScene(),this.levelNamePanel=new f.LevelNamePanel(this),this.settingsPanel=new w.MapSettingsPanel(this),this.beginButton=new M(e),this.backButton=new m.RibbonButton(this,0,0,{icon:new T(this,0,0,"atlas","ui/mini-icons/back").setTint(d.Colors.woodenUi.primaryText),type:m.RibbonButtonStyle.Small,width:120,content:e.text("MENU",c.BitmapFont.Small,d.Colors.woodenUi.primaryText)}),this.backButton.onClicked((()=>{g.inject.events.trigger(p.UserActions.GoBack())})),this.beginButton.onClicked((()=>{if(this.mapGenerator.isRunning())return void g.inject.audio.playEffect(S.SoundEffects.Deny);const e=this.state().preset;g.inject.userData.rememberChoice("randomMapOptions",{...e,seed:g.inject.random.integerBetween(0,1e5)}),P.track.randomMapSelected({level_id:g.inject.gameStateModel.map.levelId,map_seed:e.seed,map_size:e.size,map_shape:e.shape,map_mode:e.mode,map_difficulty:e.difficulty}),g.inject.events.trigger(p.UserActions.StartNewGame())})),this.settingsPanel.onSettingChanged((e=>{this.state.update({preset:{...this.state().preset,...e.update}}),g.inject.userData.rememberChoice("randomMapOptions",this.state().preset),this.startGenerating(e.direction)})),this.levelNamePanel.regenerateLevelButton.onClicked((async()=>{g.inject.random.reset();const e=this.state().preset;this.state.update({preset:{...e,seed:g.inject.random.integerBetween(1,Number.MAX_SAFE_INTEGER)}}),P.track.randomMapRerolled({map_mode:e.mode,map_difficulty:e.difficulty,map_size:e.size,map_shape:e.shape,map_seed:e.seed}),this.startGenerating("down")})),this.mapGenerator.onJobStarted((()=>{this.levelNamePanel.regenerateLevelButton.setEnabled(!1)})),this.mapGenerator.onJobFinished((()=>{this.levelNamePanel.regenerateLevelButton.setEnabled(!0)})),this.components=[this.backButton,this.levelNamePanel,this.settingsPanel,this.beginButton],this.addAll(this.components)}startGenerating(e){this.mapGenerator.run({preset:this.state().preset,panDirection:e})}async _generateMap(e,t){const i=(0,y.buildGeneratorConfig)(e.preset);await Promise.all([(0,b.generateMap)(i,t),this._maybePanAway(e.panDirection)]),g.inject.scene.worldMap.syncState(),this._maybePanBack(e.panDirection)}async _maybePanAway(e){e&&await g.inject.scene.worldMap.cameraController.panAway(e,g.inject.config.screenTransitionDuration)}async _maybePanBack(e){e&&await g.inject.scene.worldMap.cameraController.panIntoCenter(e,g.inject.config.screenTransitionDuration)}getTooltipFor(e){switch(e){case this.levelNamePanel.regenerateLevelButton:return{title:"Click to find a different island."};case this.backButton:return{title:"Return to main menu."}}}}t.RandomMapSelectScene=x,x.Layout={};class M extends h.RoundedRectButton{constructor(e){const t=e.text("Begin!",c.BitmapFont.Main,d.Colors.glassUi.primaryText),i=e.image("ui/level-icons/in-progress"),s=e.hLayout({originX:.5,originY:.5,content:[i,t],spacing:10});super(e.scene,{raised:4,contentOriginX:.5,content:s}),this.label=t,this.layout=s,this.icon=i}}t.BeginButton=M},27596:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RandomMapSelectScreen=void 0;const s=i(84612),n=i(83928),a=i(71203),o=i(18995),r=i(99809),c=i(95471),l=i(91332),d=i(32055);class h extends n.BaseScreen{constructor(){super("RandomMapSelect",[s.Scenes.WorldMap,s.Scenes.RandomMapSelectUI]),this.handleEventWhileActive(o.UserActions.Escape,(async()=>{a.inject.navigator.goTo(a.inject.screen.title)})),this.handleEventWhileActive(o.UserActions.GoBack,(async()=>{a.inject.navigator.goTo(a.inject.screen.title)}))}async activate(e){a.inject.scene.randomMapSelect.state.update({preset:a.inject.userData.recallChoice("randomMapOptions")}),a.inject.scene.worldMap.setMode(new r.PreviewMode)}async transitionIn(e){e===a.inject.screen.title?await(0,c.titleToRandomMapSelectTransition)():await(0,d.randomMapInTransition)()}async transitionOut(e){e===a.inject.screen.play&&await(0,l.randomMapOutTransition)({keepWorldMap:!0})}deactivate(){}}t.RandomMapSelectScreen=h},91089:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VerticalStripePanelUI=void 0;const s=i(79578),n=i(10445),a={width:400,padding:10,stripeWidth:6};t.VerticalStripePanelUI=class{constructor(e,t={}){this.scene=e;const i=s.UiBuilder.for(this.scene);this.props={...a,...t},this.mainPanel=i.rectangle(n.Colors.glassUi.background,.85),this.decorativeStripe=i.rectangle(n.Colors.glassUi.background,.77),this.decorativeStripeRight=i.rectangle(n.Colors.glassUi.background,.77),this.components=[this.decorativeStripeRight,this.decorativeStripe,this.mainPanel]}addToScene(){this.scene.addAll(this.components)}updateLayout(){const e=this.props,t=(this.scene.bounds.width,this.scene.bounds.height);this.scene.bounds.contentWidth<1.5*e.width?(this.mainPanel.setPosition(0,0),this.mainPanel.setSize(this.scene.bounds.contentWidth,t)):(this.mainPanel.setPosition(this.scene.bounds.contentRight-e.width,0),this.mainPanel.setSize(e.width,t)),this.decorativeStripe.setPosition(this.mainPanel.x-2*e.stripeWidth,0),this.decorativeStripe.setSize(e.stripeWidth,t),this.decorativeStripeRight.setPosition(this.mainPanel.x+this.mainPanel.width+e.stripeWidth,0),this.decorativeStripeRight.setSize(e.stripeWidth,t)}async transitionIn(e){return new Promise((t=>{this.scene.tweens.add({targets:this.components,props:{alpha:{from:0,to:1}},duration:e,ease:"Sine.easeIn",onComplete:t})}))}async transitionOut(e){return new Promise((t=>{this.scene.tweens.add({targets:this.components,props:{alpha:{from:1,to:0}},duration:e,ease:"Sine.easeIn",onComplete:t})}))}setVisible(e){this.components.forEach((t=>{t.setVisible(e),e&&t.setAlpha(1)}))}}},32055:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomMapInTransition=void 0;const s=i(71203);t.randomMapInTransition=async function(e={}){s.inject.scene.titleScreenUI;const t=s.inject.scene.randomMapSelect,i=e.duration??s.inject.config.screenTransitionDuration;return new Promise((s=>{t.scene.setVisible(!0),t.preUpdate.force(),e.keepBackgroundPanel?t.mainPanelUI.setVisible(!0):t.mainPanelUI.transitionIn(i),t.startGenerating("up"),t.tweens.add({targets:t.components.filter((e=>e!==t.backButton&&e!==t.levelNamePanel)),props:{x:{getStart:e=>e.x+400,getEnd:e=>e.x},alpha:{from:0,to:1}},duration:i/2,onComplete:s,ease:"Sine.easeOut"}),t.tweens.add({targets:[t.backButton,t.levelNamePanel],props:{alpha:{from:0,to:1}},duration:i/2,ease:"Sine.easeOut"})}))}},91332:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomMapOutTransition=void 0;const s=i(71203);t.randomMapOutTransition=async function(e){const t=s.inject.scene.randomMapSelect,i=e.duration??s.inject.config.screenTransitionDuration;return new Promise((n=>{t.preUpdate.force(),e.keepWorldMap||s.inject.scene.worldMap.cameraController.panAway("down",i),e.keepBackground||t.mainPanelUI.transitionOut(i),t.tweens.add({targets:t.components.filter((e=>e!==t.backButton&&e!==t.levelNamePanel)),props:{x:{getStart:e=>e.x,getEnd:e=>e.x+400},alpha:{from:1,to:0}},duration:i,onComplete:n,ease:"Sine.easeOut"}),t.tweens.add({targets:[t.backButton,t.levelNamePanel],props:{alpha:{from:1,to:0}},duration:i,ease:"Sine.easeOut"})}))}},61255:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomMapSelectToTileTransition=void 0;const s=i(71203),n=i(55748),a=i(91332);t.randomMapSelectToTileTransition=async function(){const e=s.inject.scene.titleScreenUI,t=s.inject.scene.randomMapSelect,i=s.inject.config.screenTransitionDuration;return e.scene.setVisible(!1),(0,a.randomMapOutTransition)({duration:i/2,keepWorldMap:!1,keepBackground:!0}).then((async()=>{e.scene.setVisible(!0),t.scene.setVisible(!1),await(0,n.titleInTransition)({keepBackgroundPanel:!0,duration:i/2})}))}},95471:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.titleToRandomMapSelectTransition=void 0;const s=i(71203),n=i(32505),a=i(32055);t.titleToRandomMapSelectTransition=async function(){const e=s.inject.scene.titleScreenUI;return s.inject.scene.randomMapSelect.scene.setVisible(!1),new Promise((t=>{const i=s.inject.config.screenTransitionDuration;e.tweens.add({targets:e.buttonsPanel.buttons[1],props:{alpha:{from:1,to:0}},duration:i,ease:"Sine.easeOut"}),(0,n.titleOutTransition)({excludeButton:1,keepBackgroundPanel:!0,duration:i/2}).then((async()=>{e.scene.setVisible(!1),await(0,a.randomMapInTransition)({duration:i/2,keepBackgroundPanel:!0})}))})).then((()=>{e.buttonsPanel.buttons[1].setAlpha(1),e.scene.setVisible(!0)}))}},3255:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createScreens=void 0;const s=i(19121),n=i(79036),a=i(79668),o=i(55994),r=i(95867),c=i(96873),l=i(59286),d=i(41195),h=i(26602),u=i(10068),g=i(27596);t.createScreens=function(){return{play:new s.PlayScreen,mapEditor:new n.MapEditorScreen,breakpoint:new a.BreakPointScreen,debugHistory:new o.DebugHistoryScreen,title:new r.TitleScreen,levelSelect:new c.LevelSelectScreen,levelDetail:new l.LevelDetailScreen,victory:new d.VictoryScreen,defeat:new h.DefeatScreen,mapGeneration:new u.MapGenerationScreen,randomMapSelect:new g.RandomMapSelectScreen}}},95867:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TitleScreen=void 0;const s=i(83928),n=i(84612),a=i(18995),o=i(71203),r=i(30905),c=i(86201),l=i(78664),d=i(52163),h=i(99809),u=i(39999),g=i(80266),p=i(92940),m=i(32505),y=i(55748),f=i(84809),w=i(61255),b=i(42574),v=i(94459);class S extends s.BaseScreen{constructor(){super("Title",[n.Scenes.WorldMap,n.Scenes.TitleScreenUI]),this.autoSavedState=void 0,this.lockOrientation=!0,this.handleEventWhileActive(a.UserActions.GoToLevelSelect,(async({campaignId:e})=>{const t=await o.inject.mapRegistry.getCampaignById(e);d.assert.defined(t),o.inject.ui.selectedCampaign.set(t),o.inject.navigator.goTo(o.inject.screen.levelSelect,(()=>(0,l.transitionToLevelSelect)(0)))})),this.handleEventWhileActive(a.UserActions.ResumeGame,(()=>{o.inject.events.trigger(a.UserActions.PlayLevel({levelId:o.inject.gameStateModel.map.levelId}))}))}async activate(e){let t;await super.activate(e),e===o.inject.screen.levelSelect&&(t=0),b.NewsBox.show(),await this.loadAutosaveMetadata()}deactivate(){b.NewsBox.hide()}async transitionOut(e){e===o.inject.screen.play&&await(0,m.titleOutTransition)({keepWorldMap:!0})}async transitionIn(e){let t=e===o.inject.screen.play;o.inject.scene.worldMap.scene.setVisible(t),t&&o.inject.scene.worldMap.cameraController.center(o.inject.config.screenTransitionDuration,1),e===o.inject.screen.randomMapSelect?await(0,w.randomMapSelectToTileTransition)():await(0,y.titleInTransition)(),t||this.loadLevel()}async loadAutosaveMetadata(){const e=o.inject.userData.recallChoice("latestLevelId");if(e)try{this.autoSavedState=await o.inject.userData.loadGame(e,g.SaveGameTags.Autosave);const t=f.LevelModel.for(this.autoSavedState.map.levelId);return void o.inject.scene.titleScreenUI.state.update({resumeButton:{enable:!0,levelName:t.getTitle(f.LevelTitleStyle.IncludingCampaign),turnNumber:this.autoSavedState.currentPhase.turnNumber}})}catch(t){console.error("failed to load level "+e,t),this.autoSavedState=void 0}this.autoSavedState||o.inject.scene.titleScreenUI.state.update({resumeButton:{enable:!1}})}async loadLevel(){let e=this.autoSavedState??(0,c.decodeGameState)(r.BUILT_IN_MAPS.titleScreenLevel);o.inject.gameStateController.loadState(e,u.NewGameStateContext.Preview),o.inject.scene.worldMap.cameraController.zoomController.cameraDistance.setTo(1),o.inject.scene.worldMap.setMode(new h.PreviewMode),o.inject.scene.worldMap.syncState(o.inject.currentGameState),o.inject.device.uiVariant()===v.UiVariant.Large&&o.inject.scene.worldMap.cameraController.panIntoCenter("up"),o.inject.scene.worldMap.scene.setVisible(!0),o.inject.gameStateModel.pawns.select({traits:[p.PawnTraits.Unit]}).map((e=>o.inject.scene.worldMap.pawns.getById(e.id))).forEach((e=>e?.startJumping()))}}t.TitleScreen=S,S.Layout={buttons:{height:63,spacing:14,maxWidth:400}}},30697:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SocialsPanel=t.DiscordButton=t.ButtonsPanel=t.TitleScreenUIScene=void 0;const s=i(84612),n=i(71203),a=i(95867),o=i(2214),r=i(48565),c=i(44031),l=i(18995),d=i(9724),h=i(61720),u=i(79578),g=i(10445),p=i(1157),m=i(5085),y=i(95569),f=i(38735),w=i(91089),b=i(1951);class v extends d.BaseUIScene{constructor(){super({key:s.Scenes.TitleScreenUI}),this.state=(0,h.StateContainer)(this,{resumeButton:{enable:!1}}),this.preUpdate=(0,r.whenDirty)((()=>{const e=a.TitleScreen.Layout,t=(this.bounds.width,this.bounds.height);if(this.background.updateLayout(),this.buttonsPanel.width=(0,b.min)(this.background.mainPanel.width-60,a.TitleScreen.Layout.buttons.maxWidth),this.buttonsPanel.updateLayout(),t<900?this.gameLogo.setFrame("logos/game-title-compact"):this.gameLogo.setFrame("logos/game-title"),this.state().resumeButton.enable?(this.background.mainPanel.width===this.bounds.contentWidth?(this.resumeButton.x=this.background.mainPanel.x+30,this.resumeButton.setSize(this.background.mainPanel.width-60,e.buttons.height+10),console.log("SMALL MODE",this.resumeButton.x)):(this.resumeButton.x=this.background.mainPanel.x-80,this.resumeButton.setSize(this.background.mainPanel.width+160,e.buttons.height+10),console.log("LARGE MODE",this.resumeButton.x)),this.resumeButton.setVisible(!0),this.resumeSubtitle.setText(this.state().resumeButton.levelName??"Custom game")):this.resumeButton.setVisible(!1),c.Arrange.vertically({content:[{object:this.gameLogo},{object:this.buttonsPanel},{object:this.resumeButton}],y:t/2,origin:.5,spacing:30,maxSize:t-60}),c.Arrange.alignVertically([this.gameLogo,this.buttonsPanel],{x:this.background.mainPanel.x+this.background.mainPanel.width/2,origin:.5}),t<640)this.socialsPanel.setVisible(!1);else{this.socialsPanel.setVisible(!0);let e=t<750?20:40;this.socialsPanel.setSize(this.background.mainPanel.width-80,32),this.socialsPanel.setPosition(this.background.mainPanel.x+40,this.bounds.height-e-this.socialsPanel.height)}}))}applyState(e,t,i){this.preUpdate.makeDirty()}create(){super.create();const e=u.UiBuilder.for(this);this.gameLogo=e.image("logos/game-title"),this.background=new w.VerticalStripePanelUI(this),this.background.addToScene(),this.buttonsPanel=new S(this),this.resumeSubtitle=e.text("?",p.BitmapFont.Mini,g.Colors.glassUi.primaryText),this.resumeButton=new o.RoundedRectButton(this,{raised:4,content:e.hLayout({spacing:20,layoutPolicy:m.LayoutChildrenPolicy.None,horizontalPadding:24,originY:.5,content:[e.image("ui/level-icons/in-progress"),e.vLayout({spacing:4,layoutPolicy:m.LayoutChildrenPolicy.None,content:[e.text("Continue",p.BitmapFont.Main,g.Colors.glassUi.primaryText),this.resumeSubtitle]})]})}),this.resumeButton.onClicked((()=>n.inject.events.trigger(l.UserActions.ResumeGame()))),this.socialsPanel=new T(e),this.addAll([this.gameLogo,this.buttonsPanel,this.resumeButton,this.socialsPanel])}getTooltipFor(e){switch(e){case this.socialsPanel.twitterButton:return{title:"Tweet at me!"};case this.socialsPanel.discordButton:return{title:"Join konkr.io discord server!"};case this.socialsPanel.feedbackButton:return{title:"Send me an email!"}}}}t.TitleScreenUIScene=v;class S extends y.AutoHeightResponsiveContainer{constructor(e){super(e);const t=u.UiBuilder.for(e),i=(i,s,n)=>{const a=t.hLayout({content:[t.image(i),t.text(s,p.BitmapFont.Main,g.Colors.glassUi.primaryText)],horizontalPadding:24,originY:.5,originX:0,layoutPolicy:m.LayoutChildrenPolicy.None,spacing:18}),r=new o.RoundedRectButton(e,{content:a,raised:2,audio:!0});return r.onClicked(n),r};this.buttons=[i("ui/icons/campaign","Campaign",(()=>{f.track.interaction("open_campaigns"),n.inject.events.trigger(l.UserActions.GoToLevelSelect({campaignId:"intro"}))})),i("ui/icons/conquest","Conquest",(()=>{f.track.interaction("open_conquest"),n.inject.events.trigger(l.UserActions.GoToRandomMapSelect())})),i("ui/icons/book","How to play",(()=>{n.inject.events.trigger(l.UserActions.ShowHowToPlay())})),new P(t)],this.add(this.buttons)}calculateHeight(){return this.buttons[this.buttons.length-1].y+a.TitleScreen.Layout.buttons.height}updateLayout(){this.buttons.forEach((e=>{e.setSize(this.width,a.TitleScreen.Layout.buttons.height),e.rounded=1,e.x=0})),c.Arrange.vertically({content:this.buttons.map((e=>({object:e}))),spacing:a.TitleScreen.Layout.buttons.spacing,origin:0,y:0}),this.updateSize()}}t.ButtonsPanel=S;class P extends o.RoundedRectButton{constructor(e){const t=e.image("ui/icons/new-window").setTint(g.Colors.glassUi.disabledText),i=e.hLayout({content:[e.image("ui/icons/discord-large"),e.vLayout({spacing:2,layoutPolicy:m.LayoutChildrenPolicy.None,content:[e.text("Community",p.BitmapFont.Main,g.Colors.glassUi.primaryText),e.text("Join the konkr.io Discord server",p.BitmapFont.Mini,g.Colors.glassUi.primaryText)]}),t],horizontalPadding:24,originY:.5,originX:0,layoutPolicy:m.LayoutChildrenPolicy.None,spacing:18});super(e.scene,{content:i,raised:2,audio:!0}),this.newWindowIcon=t,this.onClicked((()=>{f.track.interaction("join_discord"),n.inject.events.trigger(l.UserActions.JoinDiscord())}))}updateLayout(){super.updateLayout(),this.newWindowIcon.x=this.width-26-this.newWindowIcon.width}}t.DiscordButton=P;class T extends y.BaseResponsiveContainer{constructor(e){super(e.scene),this.ui=e,this.callToActionText=this.ui.text("Give me feedback!",p.BitmapFont.Small,g.Colors.glassUi.primaryText),this.twitterButton=new o.RoundedRectButton(this.ui.scene,{raised:0,content:this.ui.centered(this.ui.image("ui/icons/twitter",g.Colors.glassUi.primaryText))}),this.discordButton=new o.RoundedRectButton(this.ui.scene,{raised:0,content:this.ui.centered(this.ui.image("ui/icons/discord",g.Colors.glassUi.primaryText).setOrigin(.5,.5))}),this.feedbackButton=new o.RoundedRectButton(this.ui.scene,{raised:0,content:this.ui.centered(this.ui.image("ui/icons/mail",g.Colors.glassUi.primaryText))}),this.twitterButton.setSize(40,40),this.discordButton.setSize(40,40),this.feedbackButton.setSize(40,40),this.twitterButton.onClicked((()=>{n.inject.events.trigger(l.UserActions.SendTweet())})),this.discordButton.onClicked((()=>{n.inject.events.trigger(l.UserActions.JoinDiscord())})),this.feedbackButton.onClicked((()=>{n.inject.events.trigger(l.UserActions.SendEmail())})),this.add([this.callToActionText,this.twitterButton,this.discordButton,this.feedbackButton])}updateLayout(){c.Arrange.fromLeftToRightOld([this.callToActionText,this.feedbackButton,this.twitterButton,this.discordButton],{x:this.width,y:this.height/2,originY:.5,originX:1,spacing:12})}}t.SocialsPanel=T},55748:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.titleInTransition=void 0;const s=i(71203),n=i(96486);t.titleInTransition=async function(e={}){const t=s.inject.scene.titleScreenUI,i=e.duration??s.inject.config.screenTransitionDuration;return t.preUpdate.force(),t.scene.setVisible(!0),new Promise((a=>{let o=t.buttonsPanel.buttons;if(void 0!==e.excludeButton){const a=t.buttonsPanel.buttons[e.excludeButton];o=(0,n.without)(t.buttonsPanel.buttons,a);const r={x:a.x,y:a.y,width:a.width,height:a.height,rounded:1,alpha:1};a.x=0,a.y=0,a.setSize(s.inject.device.screenWidth,200),a.rounded=0,t.tweens.add({targets:a,props:r,duration:i,onComplete:()=>{t.preUpdate.makeDirty()}})}t.tweens.add({targets:[...o,t.resumeButton],props:{x:{getStart:e=>e.x+400,getEnd:e=>e.x},alpha:{from:0,to:1}},duration:i,onComplete:()=>{t.preUpdate.force(),a()},ease:"Sine.easeOut"}),e.keepBackgroundPanel||t.background.transitionIn(i),t.tweens.add({targets:[t.socialsPanel,t.gameLogo],props:{alpha:{from:0,to:1}},duration:i,ease:"Sine.easeOut"})}))}},32505:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.titleOutTransition=void 0;const s=i(71203);t.titleOutTransition=async function(e={}){const t=s.inject.scene.titleScreenUI;return new Promise((i=>{const n=e.duration??s.inject.config.screenTransitionDuration,a=t.buttonsPanel.buttons.filter(((t,i)=>i!==e.excludeButton));e.keepWorldMap||s.inject.scene.worldMap.cameraController.panAway("up",n),t.tweens.add({targets:[...a,t.resumeButton],props:{x:"+="+(s.inject.device.screenWidth-t.background.decorativeStripe.x),alpha:{from:1,to:0}},duration:n,ease:"Sine.easeIn",onComplete:i}),t.tweens.add({targets:[t.socialsPanel,t.gameLogo],props:{alpha:0},duration:n,ease:"Sine.easeOut"}),e.keepBackgroundPanel||t.background.transitionOut(n)}))}},78664:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.transitionToLevelSelect=void 0;const s=i(71203),n=i(52700),a=i(32505);t.transitionToLevelSelect=async function(e){const t=s.inject.scene.titleScreenUI,i=s.inject.scene.levelSelectUI,o=s.inject.scene.menuHeaderUI;return(0,a.titleOutTransition)({excludeButton:e}),new Promise((a=>{const r=s.inject.config.screenTransitionDuration;t.tweens.add({targets:t.buttonsPanel.buttons[e],props:{x:0-t.buttonsPanel.x,y:0-t.buttonsPanel.y,width:s.inject.device.screenWidth,height:n.MenuHeaderUIScene.Layout.panelHeight,rounded:0},duration:r,onComplete:()=>{t.preUpdate.makeDirty(),a()}}),t.tweens.add({targets:[s.inject.scene.worldMap.cameras.main],scrollY:1e3,duration:r,ease:"Sine.easeIn"}),i.preUpdate(),o.preUpdate(),o.scene.setVisible(!1),i.tweens.add({targets:i.levelCards,y:{start:(e,t,s,n)=>e.y+i.bounds.height,to:"-="+i.bounds.height},delay:(e,t,i,s)=>s*(r/100),duration:r,ease:"Sine.easeOut"})})).then((()=>{o.scene.setVisible(!0)}))}},28989:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VictoryScene=void 0;const s=i(48565),n=i(9724),a=i(84612),o=i(73432),r=i(1157),c=i(10445),l=i(71203),d=i(18995),h=i(79578),u=i(15641),g=i(10780);var p=Phaser.GameObjects.Image,m=Phaser.GameObjects.BitmapText,y=Phaser.GameObjects.Rectangle;const f=i(44031),w=i(77949);class b extends n.BaseUIScene{constructor(){super({key:a.Scenes.Victory}),this.availableActions=[],this.preUpdate=(0,s.whenDirty)((()=>{this.shield.setPosition(this.bounds.centerX,this.bounds.centerY+20),this.shieldOutline.setPosition(this.bounds.centerX,this.bounds.centerY+26),this.victoryHalo.setPosition(this.bounds.centerX,this.bounds.centerY),this.victoryRays.setPosition(this.bounds.centerX,this.bounds.centerY),this.ribbon.width=400,this.ribbon.setPosition(this.bounds.centerX-this.ribbon.width/2,this.bounds.centerY+60),this.ribbonText.setPosition(this.bounds.centerX,this.bounds.centerY+66),this.ribbonText.setText("You are victorious!"),this.trophy.setPosition(this.bounds.centerX,this.bounds.centerY),this.backgroundOverlay.setSize(this.bounds.width,this.bounds.height),this.primaryButton.setVisible(this.availableActions.length>0),this.secondaryButton.setVisible(this.availableActions.length>1),f.Arrange.fromTopToBottomOld([this.primaryButton,this.secondaryButton],{x:this.bounds.centerX,originX:.5,y:this.bounds.centerY+200,originY:0,spacing:10})}))}create(){super.create(),this.ui=h.UiBuilder.for(this),this.shield=this.createImage("shield"),this.shieldOutline=this.createImage("shieldOutline"),this.victoryHalo=this.createImage("victoryHalo"),this.victoryRays=this.createImage("victoryRays"),this.ribbon=new o.Ribbon(this,o.RibbonTexture.Pergamen,0,0,200),this.ribbonText=new m(this,0,0,r.BitmapFont.Main).setTint(c.Colors.woodenUi.primaryText).setOrigin(.5,0),this.trophy=this.createImage("trophy"),this.backgroundOverlay=new y(this,0,0,0,0,16777215,.5),this.primaryButtonText=this.ui.caption("NEXT ISLAND"),this.primaryButton=new u.BoxButton(this,0,0,{content:this.primaryButtonText,width:200,height:46,baseTexture:g.BoxTexture.DialogButton,downTexture:g.BoxTexture.DialogButtonDown}),this.secondaryButtonText=this.ui.caption("MENU"),this.secondaryButton=new w.RibbonButton(this,0,0,{type:w.RibbonButtonStyle.Small,width:180,content:this.secondaryButtonText}),this.addAll([this.backgroundOverlay,this.shieldOutline,this.victoryHalo,this.victoryRays,this.shield,this.trophy,this.ribbon,this.ribbonText,this.primaryButton,this.secondaryButton]),this.tweens.add({targets:this.victoryRays,props:{angle:{from:0,to:360}},repeat:-1,duration:1e4}),this.primaryButton.onClicked((()=>{this.availableActions[0]?.executor?.()})),this.secondaryButton.onClicked((()=>{this.availableActions[1]?.executor?.()}))}setAvailableActions(e){this.availableActions=e,e[0]&&this.primaryButtonText.setText(e[0].title),e[1]&&this.secondaryButtonText.setText(e[1].title),this.preUpdate.makeDirty()}continueAutomaticallyAfter(e=5e3){setTimeout((()=>this.continue()),e)}continue(){this.scene.isActive()&&l.inject.events.trigger(d.UserActions.GoToLevelDetail({levelId:l.inject.ui.playedLevelId()}))}createImage(e){return new p(this,0,0,"gameOverAtlas",e)}}t.VictoryScene=b},41195:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VictoryScreen=void 0;const s=i(84612),n=i(83928),a=i(71203),o=i(18995),r=i(99809),c=i(13933),l=i(64546),d=i(84809);class h extends n.BaseScreen{constructor(){super("Victory",[s.Scenes.WorldMap,s.Scenes.Victory]),this.handleEventWhileActive(o.UserActions.GoToLevelDetail,(({levelId:e})=>{(0,c.returnToMenuFromGame)()})),this.handleEventWhileActive(o.UserActions.Escape,(async()=>{a.inject.scene.victory.continue()}))}async activate(){a.inject.scene.play;const e=d.LevelModel.for(a.inject.ui.playedLevelId()).getNextUnfinishedLevelId(),t=[{title:"NEXT ISLAND",executor:()=>{e?a.inject.events.trigger(o.UserActions.PlayLevel({levelId:e})):a.inject.events.trigger(o.UserActions.GoToRandomMapSelect())}},{title:"MENU",executor:()=>{a.inject.events.trigger(o.UserActions.GoToLevelDetail({levelId:a.inject.ui.playedLevelId()}))}}];a.inject.scene.victory.setAvailableActions(t),a.inject.scene.worldMap.setMode(new r.PreviewMode),a.inject.scene.worldMap.cameraController.center(1e3)}async transitionOut(e){return e===a.inject.screen.levelDetail?(0,l.victoryToLevelDetailTransition)():(0,l.victoryBaseTransitionOut)()}deactivate(){a.inject.scene.globalUI.ambientGlitterVolume.transitionTo(0)}}t.VictoryScreen=h},64546:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.victoryBaseTransitionOut=t.victoryToLevelDetailTransition=void 0;const s=i(71203),n=i(20069),a=i(74760);function o(){const e=s.inject.config.screenTransitionDuration,t=s.inject.scene.victory;return new Promise((i=>{t.preUpdate(),t.tweens.add({targets:t.backgroundOverlay,alpha:{start:1,to:0},duration:e}),t.tweens.add({targets:t.ribbonText,alpha:{from:1,to:0},duration:e/2}),t.tweens.add({targets:t.ribbon,x:{from:t.ribbon.x,to:t.ribbon.x+150},width:{from:400,to:100},alpha:{from:1,to:0},duration:e,ease:Phaser.Math.Easing.Expo.Out,onComplete:i}),t.tweens.add({delay:2*e/3,targets:t.trophy,alpha:{start:1,to:0},duration:e/3}),t.tweens.add({delay:e/2,targets:[t.shield],scale:{from:1,to:0},alpha:{start:1,to:0},duration:e/2}),t.tweens.add({targets:[t.shieldOutline,t.victoryHalo,t.victoryRays],alpha:{start:1,to:0},scale:{start:1,to:.2},duration:2*e/3,ease:Phaser.Math.Easing.Sine.In}),t.tweens.add({targets:[t.primaryButton,t.secondaryButton].filter((e=>e.visible)),alpha:{start:1,to:0},duration:e/3})}))}t.victoryToLevelDetailTransition=async function(){const e=s.inject.config.screenTransitionDuration,t=s.inject.scene.victory,i=s.inject.scene.levelDetailUI;(0,n.playSceneToLevelDetailTransition)(),t.tweens.add({targets:t.trophy,delay:0,props:{x:i.layout.cardLeft(0)+i.bounds.contentLeft+a.LargeLevelCardContent.Layout.iconOffsetFromLeft+20,y:i.layout.cardTop+i.layout.cardHeight-i.layout.cards.footerSize/2,scale:{from:1,to:.5}},duration:e,ease:Phaser.Math.Easing.Sine.InOut}),await o()},t.victoryBaseTransitionOut=o},91763:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.victoryTransition=void 0;const s=i(71203),n=i(9095);t.victoryTransition=async function(e=1e3){const t=s.inject.scene.victory;return s.inject.scene.playUI.activeUI.transitionOut(),s.inject.audio.playEffect(n.SoundEffects.Victory),s.inject.scene.globalUI.ambientGlitterVolume.transitionTo(1),new Promise((i=>{t.preUpdate.makeDirty(),t.preUpdate(),t.ribbon.setAlpha(1),t.tweens.add({targets:t.backgroundOverlay,alpha:{start:0,to:1},duration:e/2}),t.tweens.add({targets:t.ribbonText,alpha:{from:0,to:1},duration:e,onComplete:i}),t.tweens.add({targets:t.ribbon,x:{from:t.ribbon.x+150,to:t.ribbon.x},width:{from:100,to:400},duration:e,ease:Phaser.Math.Easing.Expo.Out}),t.tweens.add({targets:t.trophy,delay:0,scale:{from:10,to:1},duration:e,ease:Phaser.Math.Easing.Bounce.Out}),t.tweens.add({delay:e/3,targets:t.trophy,alpha:{start:0,to:1},duration:e/2}),t.tweens.add({targets:[t.shield],scale:{from:.2,to:1},alpha:{start:0,to:1},duration:e/2,ease:Phaser.Math.Easing.Expo.Out}),t.tweens.add({delay:e/3,targets:[t.shieldOutline,t.victoryHalo,t.victoryRays],alpha:{start:0,to:1},scale:{start:.2,to:1},duration:2*e/3,ease:Phaser.Math.Easing.Back.Out}),t.tweens.add({delay:2*e/3,targets:[t.primaryButton,t.secondaryButton].filter((e=>e.visible)),alpha:{start:0,to:1},duration:e/3})}))}},13872:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.TIMING=t.TransitionsSpeed=void 0,(i=t.TransitionsSpeed||(t.TransitionsSpeed={}))[i.Normal=600]="Normal",i[i.Fast=300]="Fast",i[i.Instant=0]="Instant",t.TIMING={pawnPickupTransition:100,pawnDropTransition:100,pawnJumpDuration:500}},85421:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tooltip=t.TooltipPlacement=t.LAYOUT=void 0;const s=i(10445),n=i(92536),a=i(62199),o=i(38697),r=i(98439),c=i(71203),l=i(26792),d=i(96486);a.logger.for("Tooltips"),t.LAYOUT={triangleSize:10,padding:8,spacing:8,maxWidth:240,expandTransitionDuration:200,showHideTransitionDuration:100,screenMargin:10},t.TooltipPlacement={overUiObject:e=>()=>(0,r.getObjectCameraRect)(e),atGlobalXY:(e,t,i)=>()=>({x:e,y:t-i,width:0,height:2*i}),atWorldMapHex:e=>()=>{const{x:t,y:i}=(0,r.convertWorldXYToCameraXY)(c.inject.scene.worldMap.cameras.main,e.display.centerX,e.display.centerY);return{x:t,y:i-l.HEX_HEIGHT/2,width:0,height:l.HEX_HEIGHT}}};class h extends o.Container{constructor(e){super(e),this.tweener=new n.Tweener(this.scene),this.preferBelow=!1,this.mode=o.TooltipMode.Hidden,this.recentlyShown=!1,this.content=new o.TooltipContent(e);const i=t.LAYOUT.triangleSize;this.backgroundTriangle=new o.Triangle(e,0,0,.69*-i,-i,.69*i,-i,0,0,s.Colors.tooltip.background).setOrigin(0,0).setPosition(0,0),this.add([this.backgroundTriangle,this.content])}showDelayed(e){const t=this.recentlyShown&&!e.enforceDelay?0:e.delayMs??1e3;this.mode=o.TooltipMode.ScheduledToShow,this._queueAction((()=>this.show(e)),t)}_queueAction(e,t){this._clearQueuedAction(),this.queuedAction=setTimeout(e,t)}_clearQueuedAction(){this.queuedAction&&clearTimeout(this.queuedAction)}updatePosition(){if(this.mode===o.TooltipMode.Hidden||this.mode==o.TooltipMode.ScheduledToShow)return;const e=this.placement(this);if(this.previousPlacement&&(0,d.isEqual)(e,this.previousPlacement))return;this.previousPlacement=e;const i=this.scene.cameras.main,{x:s,y:n}=i.getWorldPoint(10,10),{x:a,y:r}=i.getWorldPoint(i.displayWidth-10,i.displayHeight-10);this.setPosition(e.x+e.width/2,e.y);const c=this.y-this.content.fullSize.height-t.LAYOUT.triangleSize,l=this.y+e.height+this.content.fullSize.height+t.LAYOUT.triangleSize;c<n||this.preferBelow&&l<r?(this.backgroundTriangle.setRotation(Math.PI),this.content.setPosition(-this.content.width/2,t.LAYOUT.triangleSize),this.setPosition(e.x+e.width/2,e.y+e.height)):(this.backgroundTriangle.setRotation(0),this.content.setPosition(-this.content.width/2,-this.content.height-t.LAYOUT.triangleSize)),this.content.x=this.adjustContentXToFitScreen(this.content.x)}show(e){this.tweener.stop(),this.mode=o.TooltipMode.Shown,this.recentlyShown=!0,this._clearQueuedAction(),this.setVisible(!0),this.content.setProps(e),this.placement=e.placement,this.preferBelow=e.displayBelow||!1,this.updatePosition(),this.tweener.add({targets:this,scale:{from:0,to:1},alpha:{from:0,to:1},duration:t.LAYOUT.showHideTransitionDuration}),this._queueAction((()=>{this.mode=o.TooltipMode.Expanded,this.content.expand(),this.backgroundTriangle.rotation?this.content.tweener.add({targets:this.content,x:this.adjustContentXToFitScreen(-this.content.width/2)}):this.content.tweener.add({targets:this.content,x:this.adjustContentXToFitScreen(-this.content.width/2),y:-this.content.height-t.LAYOUT.triangleSize})}),1500)}get shown(){return this.mode===o.TooltipMode.Shown||this.mode===o.TooltipMode.Expanded}async hide(){if(this.mode===o.TooltipMode.ScheduledToShow&&this._clearQueuedAction(),this.shown)return this.mode=o.TooltipMode.Hidden,this.previousPlacement=void 0,this._queueAction((()=>{this.recentlyShown=!1}),500),new Promise((e=>{this.tweener.add({targets:this,scale:0,alpha:0,duration:t.LAYOUT.showHideTransitionDuration,onComplete:()=>{this.setVisible(!1),e()}})}))}adjustContentXToFitScreen(e){const i=this.scene.cameras.main,{x:s,y:n}=i.getWorldPoint(t.LAYOUT.screenMargin,t.LAYOUT.screenMargin),{x:a,y:o}=i.getWorldPoint(i.displayWidth-t.LAYOUT.screenMargin,i.displayHeight-t.LAYOUT.screenMargin),r=this.x-this.content.width/2,c=this.x+this.content.width/2;return r<s?e+(s-r):c>a?e-(c-a):e}toString(){return`[Tooltip "${this.content.title}" (${this.mode})]`}}t.Tooltip=h},38697:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TooltipMode=t.TooltipContent=t.Container=t.Triangle=void 0,t.Triangle=Phaser.GameObjects.Triangle,t.Container=Phaser.GameObjects.Container;const s=i(7721),n=i(87951),a=i(92536),o=i(79578),r=i(1157),c=i(10445),l=i(44031),d=i(85421);class h extends t.Container{constructor(e){super(e),this.counters=[],this.tweener=new a.Tweener(this.scene,{duration:d.LAYOUT.expandTransitionDuration,ease:"Sine.easeInOut"}),this.fullSize={width:0,height:0};const t=o.UiBuilder.for(e);this.countersPool=new n.Pool((()=>({icon:t.image("").setOrigin(0,.5),text:t.text("",r.BitmapFont.Mini,c.Colors.glassUi.primaryText).setOrigin(0,.5)}))).preload(1),this.icon=t.image(""),this.title=t.text("title",r.BitmapFont.Mini,c.Colors.tooltip.text),this.description=t.text("tooltip description",r.BitmapFont.Mini,c.Colors.tooltip.text).setMaxWidth(d.LAYOUT.maxWidth),this.backgroundBox=new s.RoundedRect(e,{radius:6,fillStyle:{color:c.Colors.tooltip.background,alpha:1}}),this.backgroundBox.preUpdate.enableEagerUpdates(),this.add([this.backgroundBox,this.title,this.icon,this.description])}setProps(e){e.icon?(this.icon.setFrame(e.icon),this.icon.setVisible(!0)):this.icon.setVisible(!1),this.title.setText(e.title),this.description.setText(e.description??""),this.description.setVisible(!1),this.counters.forEach((e=>{this.remove([e.icon,e.text]),e.icon.setVisible(!1),e.text.setVisible(!1),this.countersPool.free(e)})),this.counters=[],e.counters?.forEach((e=>{const t=this.countersPool.take();t.icon.setFrame(e.icon).setOrigin(0,.5).setTint(e.color).setVisible(!0),t.text.setText(e.value.toString()).setTint(e.color).setVisible(!0),this.add([t.icon,t.text]),this.counters.push(t)})),this.updateLayout()}updateLayout(){const e=!!this.description.text.length;this.icon.setOrigin(0,0),l.Arrange.fromLeftToRightOld([this.icon,this.title],{x:d.LAYOUT.padding,y:d.LAYOUT.padding+this.title.height/2,originY:.5,spacing:d.LAYOUT.spacing});let t=this.title.x+this.title.width;this.counters.length&&(t+=d.LAYOUT.spacing);const i=d.LAYOUT.padding+this.title.height/2;for(const e of this.counters)t+=d.LAYOUT.spacing,e.icon.setPosition(t,i),t+=e.icon.width+4,e.text.setPosition(t,i),t+=e.text.width;this.description.setPosition(d.LAYOUT.padding,this.title.y+this.title.height+d.LAYOUT.spacing),this.width=t+d.LAYOUT.padding,this.height=this.title.y+this.title.height+d.LAYOUT.padding,this.fullSize.width=Math.max(this.width,this.description.x+this.description.width+d.LAYOUT.padding),this.fullSize.height=e?this.description.y+this.description.height+d.LAYOUT.padding:this.height,this.backgroundBox.setPosition(0,0),this.backgroundBox.setSize(this.width,this.height)}expand(){if(!this.description.text.length)return;this.description.setVisible(!0),this.height=this.fullSize.height,this.width=this.fullSize.width;const e=this.description.maxWidth;this.tweener.add({targets:this.description,alpha:{from:0,to:1},maxWidth:{from:0,to:e},scale:{from:0,to:1}}),this.tweener.add({targets:this.backgroundBox,width:this.width,height:this.height})}}var u;t.TooltipContent=h,(u=t.TooltipMode||(t.TooltipMode={})).Hidden="hidden",u.Shown="shown",u.Expanded="expanded",u.ScheduledToShow="about-to-show"},84477:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnDescriptions=t.getPawnDescription=t.getPawnTypeTooltip=t.TooltipCounters=t.TooltipsManager=t.TooltipType=void 0;const s=i(71203),n=i(79578),a=i(85421),o=i(92940),r=i(10445),c=i(73508),l=i(96486),d=i(17225),h=i(38697);var u;function g(e,t){const i=s.inject.scene.worldMap.pawnSymbols.getCurrentSymbol(e.id);if(i)return{title:i.message,icon:(0,d.getFrameForPawnSymbol)(i.type),enforceDelay:!1,type:u.Hover};{const i=p(e.type,e.faction?.isLocalPlayer()?"own":"hostile");return{...i,counters:[...i.counters??[],...t],enforceDelay:!0,type:u.Hover}}}function p(e,i="own"){const n=[],a=s.inject.gameStateModel.rules.pawns(e);return a.might>0&&!a.isInvincible()&&n.push(t.TooltipCounters.might(a.might)),"buyable"!==i&&"unaffordable"!==i||n.push(t.TooltipCounters.coins(a.cost)),a.upkeep>0&&"hostile"!==i&&n.push(t.TooltipCounters.upkeep(a.upkeep)),{title:(0,l.capitalize)(e),description:m(a,i),counters:n}}function m(e,t){return[y(e,t),f(e,t)].filter((e=>e)).join("\n")}function y(e,t){return"own"===t&&e.upkeep?`Costs you ${e.upkeep} coins each turn.`:"buyable"===t?`Costs ${e.cost} coins now and ${e.upkeep} coins each turn.`:void 0}function f(e,i){if("unaffordable"==i)return"Not enough coins in treasury to buy this unit!";const s=t.PawnDescriptions[e.type];return s?s["hostile"===i?i:"default"]??s.default:void 0}!function(e){e.Hover="hover",e.Permanent="permanent"}(u=t.TooltipType||(t.TooltipType={})),t.TooltipsManager=class{get activeTooltip(){const e=this.scene.comps.tooltip;if(e?.mode!==h.TooltipMode.ScheduledToShow&&e?.mode!==h.TooltipMode.Hidden)return e}get ui(){return this._builder||(this._builder=n.UiBuilder.for(s.inject.scene.globalUI)),this._builder}get scene(){return s.inject.scene.globalUI}close(){s.inject.scene.globalUI.comps.tooltip.hide()}show(e){return s.inject.scene.globalUI.addTooltip(e)}showOver(e,t){return this.show({...t,placement:a.TooltipPlacement.overUiObject(e)})}showAt(e,t,i,s){return this.show({...s,placement:a.TooltipPlacement.atGlobalXY(e,t,i)})}showAtHex(e,t){return this.show({...t,placement:a.TooltipPlacement.atWorldMapHex(e)})}showHexTooltip(e,t=!1){const i=s.inject.gameStateModel,n=i.pawns.findOne({hexes:e,traits:[o.PawnTraits.OccupiesTile]}),a=i.pawns.findOne({hexes:e,type:[c.PawnType.Coins]});let l=[];if(n){a&&a.count>0&&l.push({value:a.count,icon:"ui/mini-icons/coins-flat",color:r.Colors.tooltip.coinsCounter});const i=this.showAtHex(e,{...g(n,l),delayMs:t?0:void 0});return this.latestHexTooltip={hex:e,tooltip:i},i}s.inject.tooltips.close()}toggleHexTooltip(e){this.latestHexTooltip?.hex===e&&this.latestHexTooltip.tooltip.visible?this.close():this.showHexTooltip(e,!0)}removeTooltip(e){s.inject.scene.globalUI.removeTooltip(e)}},t.TooltipCounters={coins:e=>({value:e,color:r.Colors.tooltip.coinsCounter,icon:"ui/mini-icons/coins-flat"}),might:e=>({value:e,color:r.Colors.tooltip.mightCounter,icon:"ui/mini-icons/might"}),upkeep:e=>({value:e,color:r.Colors.tooltip.coinsCounter,icon:"ui/mini-icons/upkeep"})},t.getPawnTypeTooltip=p,t.getPawnDescription=m,t.PawnDescriptions={[c.PawnType.Town]:{hostile:"The province treasury is stored here. Would be real shame if something happened to it!\nTowns also protect adjacent tiles from enemy villagers.",default:"The province treasury is stored here. Don't let your enemies raze it!\nTowns also protect adjacent tiles from enemy villagers."},[c.PawnType.Villager]:{default:"Great for capturing undefended territory and dealing with bandits. Protects surrounding tiles from enemy villagers."},[c.PawnType.Pikeman]:{default:"Stronger than towns and villagers, but can't deal with castles."},[c.PawnType.Knight]:{default:"Borderline unstopabble, only other knights or heroes can stand in his way."},[c.PawnType.Hero]:{default:"Unstopabble tool of destruction, only other heroes can hope to challenge him."},[c.PawnType.Castle]:{default:"Protects adjacent tiles from enemy villagers and pikemen."},[c.PawnType.Forest]:{default:"Impassable terrain."},[c.PawnType.Bandit]:{default:"Loyal to no one but himself, a bandit moves randomly around the map and plunders tiles for coins. It can be defeated by any unit, even a villager."},[c.PawnType.Camp]:{default:"Bandits store any coins they plunder in the nearest camp.\nWhen the camp has enough coins stored, it will produce a new bandit!"}}},14341:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CenterLayout=t.LayoutChildrenPolicy=void 0;const s=i(95569);var n;(n=t.LayoutChildrenPolicy||(t.LayoutChildrenPolicy={})).None="none",n.Stretch="stretch";class a extends s.BaseResponsiveContainer{constructor(e,t){super(e),this.content=t,this.add(t)}updateLayout(){this.content.setPosition(this.width/2,this.height/2)}}t.CenterLayout=a},56767:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HLayout=void 0;const s=i(95569),n=i(44031),a=i(5085);var o=Phaser.GameObjects.BitmapText;class r extends s.AutoWidthResponsiveContainer{constructor(e,t){super(e),this.props={layoutPolicy:a.LayoutChildrenPolicy.Stretch,originX:0,originY:0,horizontalPadding:0,verticalPadding:0,...t},this.add(t.content),t.height?this.height=t.height:this.height=Math.max(...t.content.map((e=>e.height)))}handleChildResize(e){this.preUpdate.makeDirty(),this.updateSize()}updateLayout(){const e=this.props.content;if(this.props.layoutPolicy===a.LayoutChildrenPolicy.Stretch)for(let t of e)t instanceof o||(t.height=this.height);n.Arrange.fromLeftToRightOld(e,{x:this.props.horizontalPadding+this.width*this.props.originX,y:(this.height-2*this.props.verticalPadding)*this.props.originY,originX:this.props.originX??0,originY:this.props.originY??0,spacing:this.props.spacing}),this.updateSize()}calculateWidth(){const e=this.props.content[0],t=this.props.content[this.props.content.length-1];return e&&t?t.x+t.width-e.x:0}}t.HLayout=r},60932:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalDialogContentLayout=t.DialogButtonRole=void 0;const s=i(10780),n=i(32285),a=i(95569),o=i(1951);var r;(r=t.DialogButtonRole||(t.DialogButtonRole={}))[r.Regular=0]="Regular",r[r.PrimaryGreen=1]="PrimaryGreen",r[r.PrimaryDanger=2]="PrimaryDanger";const c=16;class l extends a.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.contentBox=new s.Box(e,s.BoxTexture.InnerPlate),this.content=t.content,this.buttonGroup=new n.DialogButtonGroup(e,{buttons:t.buttons,onClicked:t.onClicked}),this.add([this.contentBox,this.content,this.buttonGroup]),this.width=(0,o.min)(t.maxWidth,this.content.width+32)}updateLayout(){this.content.width+32>this.width&&(this.content.width=this.width-32),this.content.setPosition(c,c),this.contentBox.setSize(this.width,this.content.height+32+this.buttonGroup.height/2),this.buttonGroup.setPosition(this.width/2-this.buttonGroup.width/2,this.contentBox.y+this.contentBox.height-this.buttonGroup.height/2),this.updateSize()}calculateHeight(){return this.contentBox.height+this.buttonGroup.height/2}}t.ModalDialogContentLayout=l},82382:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ref=t.Ref=void 0;const s=i(14090);t.Ref=class{constructor(e){this.current=e,this.onChanged=(0,s.signal)()}set(e){this.current!==e&&(this.current=e,this.onChanged.fire(e))}},t.ref=function(e){const t=(0,s.signal)(),i={current:e,set:e=>{e!==i.current&&(i.current=e,t.fire(e))},onChanged:t};return i}},79578:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ButtonTemplate=t.UiBuilder=void 0;const s=i(1157),n=i(10445),a=i(5085),o=i(56767),r=i(14341),c=i(77949),l=i(63520),d=i(15641),h=i(10780);var u=Phaser.GameObjects.BitmapText;class g{constructor(e){this.scene=e}static for(e){let t=this._instances.get(e.scene.key);return t||(t=new g(e),this._instances.set(e.scene.key,t)),t}caption(e){return this.text(e,s.BitmapFont.Main,n.Colors.glassUi.primaryText)}paragraph(e){return this.text(e,s.BitmapFont.Small,n.Colors.glassUi.primaryText)}rectangle(e,t=1){return new Phaser.GameObjects.Rectangle(this.scene,0,0,0,0,e,t)}image(e,t){const i=new Phaser.GameObjects.Image(this.scene,0,0,"atlas",e);return void 0!==t&&i.setTint(t),i}centered(e){return new r.CenterLayout(this.scene,e)}vLayout(e){return new a.VLayout(this.scene,e)}hLayout(e){return new o.HLayout(this.scene,e)}text(e,t,i){const{ref:s,value:n}="object"==typeof(a=e)?{ref:a,value:a.current}:{ref:void 0,value:a};var a;const o=new u(this.scene,0,0,t,n).setTint(i);return s&&s.onChanged((e=>o.setText(e))),o}button(e,t){return e(this.scene,t)}}t.UiBuilder=g,g._instances=new Map,t.ButtonTemplate={SmallRibbonButton:(e,t)=>{const i=new c.RibbonButton(e,0,0,{type:c.RibbonButtonStyle.Small,content:new u(e,0,0,s.BitmapFont.Small,t.text).setTint(n.Colors.glassUi.primaryText),width:120});return i.onClicked(t.onClicked),i},MiniStealthButton(e,t){const i=function(e,t,i){const a=g.for(e),o=i?a.text(i,s.BitmapFont.Mini,n.Colors.glassUi.primaryText).setOrigin(0,0):void 0,r=t?"string"==typeof t?a.image(t).setOrigin(0,0):t.setOrigin(0,0):void 0;return o&&r?a.hLayout({content:[r,o],spacing:4,originY:.5,originX:0}):o||r}(e,t.icon,t.text),a=new l.StealthButton(e,{content:i});return a.width=i.width+14,a.height=20,a.onClicked(t.onClicked),a},MainActionButton(e,t){const i=g.for(e),s=new d.BoxButton(e,0,0,{content:i.caption(t.text??""),width:200,height:46,baseTexture:h.BoxTexture.DialogButton,downTexture:h.BoxTexture.DialogButtonDown});return s.onClicked(t.onClicked),s},AlternativeActionButton(e,t){const i=g.for(e),s=new c.RibbonButton(e,0,0,{type:c.RibbonButtonStyle.Small,width:180,content:i.caption(t.text??"")});return s.onClicked(t.onClicked),s}}},88698:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UiDebugLayer=t.getDebugRect=t.DebugColors=void 0;var i,s=Phaser.GameObjects.Line,n=Phaser.GameObjects.Rectangle;function a(e,t,i,s,a,o=255){const r=new n(e,t,i,s,a).setStrokeStyle(1,o,1);return r.setOrigin(0,0),r.setPosition(t,i),r}!function(e){e[e.blue=255]="blue",e[e.green=65280]="green",e[e.red=16711680]="red"}(i=t.DebugColors||(t.DebugColors={})),t.getDebugRect=a,t.UiDebugLayer=class{constructor(e,t){this.scene=e,this.objects=[],this.target=t||{add:e=>this.scene.add.existing(e)}}clear(){return this.objects.forEach((e=>e.destroy())),this}addRect(e,t,s,n,o=i.blue){const r=a(this.scene,e,t,s,n,o);return this.target.add(r),this.objects.push(r),this}addRectAround(e,t=i.blue){return this.addRect(e.x,e.y,e.width,e.height,t),this}addHorizontalLine(e,t=i.blue){const n=this.scene.cameras.main,a=new s(this.scene,0,0,n.x,e,n.x+n.width,e,t).setStrokeStyle(1,t).setOrigin(0,0);return this.target.add(a),this}addVerticalLine(e,t=i.blue){const n=this.scene.cameras.main,a=new s(this.scene,0,0,e,n.y,e,n.y+n.height,t).setStrokeStyle(1,t).setOrigin(0,0);return this.target.add(a),this}}},5085:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VLayout=t.LayoutChildrenPolicy=void 0;const s=i(95569),n=i(44031);var a,o=Phaser.GameObjects.BitmapText;!function(e){e.None="none",e.Stretch="stretch"}(a=t.LayoutChildrenPolicy||(t.LayoutChildrenPolicy={}));class r extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.props={layoutPolicy:a.Stretch,originX:0,originY:0,horizontalPadding:0,verticalPadding:0,width:0,...t},this.width=this.props.width,this.add(t.content)}handleChildResize(e){this.preUpdate.makeDirty(),this.updateSize()}updateLayout(){const e=this.props.content;if(this.props.layoutPolicy===a.Stretch)for(let t of e)t instanceof o?t.setMaxWidth(this.width):t.width=this.width;n.Arrange.fromTopToBottomOld(e,{x:this.width*this.props.originX,y:this.height*this.props.originY,originX:this.props.originX,originY:this.props.originY,spacing:this.props.spacing}),this.updateSize()}calculateHeight(){const e=this.props.content[this.props.content.length-1];return e?e.y+e.height:0}}t.VLayout=r},32285:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DialogButtonGroup=void 0;const s=i(73432),n=i(60932),a=i(97306),o=i(15641),r=i(10780),c=i(1157),l=i(10445),d=i(95569);var h=Phaser.GameObjects.BitmapText;const u=16,g=4;class p extends d.AutoWidthResponsiveContainer{constructor(e,t){super(e),this.props=t,this.buttonRibbon=new s.Ribbon(this.scene,s.RibbonTexture.ButtonGroup),this.buttons=[],this.buttons=this.props.buttons.map((e=>this.createButton(e))),this.height=this.buttonRibbon.height,this.add([this.buttonRibbon,...this.buttons])}getButtonWidth(){return this.buttons[0].width||0}updateLayout(){const e=this.calculateWidth();this.buttonRibbon.width=e,(0,a.layoutFromLeftToRight)(u,g,4,this.buttons),this.updateSize()}calculateWidth(){return 2*u+this.getButtonWidth()*this.buttons.length+4*(this.buttons.length-1)}doCreateButton(e,t,i=l.Colors.woodenUi.primaryText,s){const n=new o.BoxButton(this.scene,0,0,{baseTexture:r.BoxTexture.DialogButton,downTexture:r.BoxTexture.DialogButtonDown,content:new h(this.scene,0,0,c.BitmapFont.Small,e).setTint(i),buttonTint:s,width:142,height:46});return n.onClicked(t),n}createButton(e){switch(e.role){case n.DialogButtonRole.Regular:return this.doCreateButton(e.text,(()=>this.props.onClicked(e.text)));case n.DialogButtonRole.PrimaryGreen:return this.doCreateButton(e.text,(()=>this.props.onClicked(e.text)),2376723,10026855);case n.DialogButtonRole.PrimaryDanger:return this.doCreateButton(e.text,(()=>this.props.onClicked(e.text)),4461331,16750968)}}}t.DialogButtonGroup=p},76733:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Label=void 0;var s=Phaser.GameObjects.BitmapText;const n=i(1157);t.Label=class extends s{constructor(e,t,i={}){super(e,0,0,n.BitmapFont.Main,t),this.props=i,this.setTint(i.color??5583648).setOrigin(0,0),i.width&&this.setMaxWidth(i.width),i.shadow&&this.setDropShadow(2,2,0,1)}set width(e){this.setMaxWidth(e)}get width(){return super.getTextBounds().global.width}}},16705:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalWindow=void 0;const s=i(10780),n=i(73432),a=i(76733),o=i(92536),r=i(95569),c=i(79578),l=10,d=55,h=10,u=6,g=4,p=6,m=30;class y extends r.BaseResponsiveContainer{constructor(e,t){super(e),this.scene=e,this.ui=c.UiBuilder.for(this.scene),this.chrome=new s.Box(this.scene,s.BoxTexture.WindowFrame),this.headerRibbon=new n.Ribbon(this.scene,n.RibbonTexture.WindowHeader),this.headerLeftStrap=this.ui.image("ui/ribbon/window-header/straps").setFlipX(!0).setOrigin(1,0),this.headerRightStrap=this.ui.image("ui/ribbon/window-header/straps"),this.headerText=new a.Label(this.scene,"",{color:16777215,align:"center",shadow:!0}),this.tweener=new o.BasicTweener,this.props={title:""},this.add([this.headerLeftStrap,this.headerRightStrap,this.chrome,this.headerRibbon,this.headerText]),this.setProps(t)}animateIn(){this.addToDisplayList();const e=[];e.push(this.scene.tweens.add({targets:this,scale:{from:.1,to:1},alpha:{from:.1,to:1},duration:400,ease:"Back.easeOut"}));const t=this.headerLeftStrap.x;this.headerLeftStrap.x=t+24,e.push(this.scene.tweens.add({targets:this.headerLeftStrap,x:t,duration:400,ease:"Sine.easeIn"}));const i=this.headerRightStrap.x;this.headerRightStrap.x=i-24,e.push(this.scene.tweens.add({targets:this.headerRightStrap,x:i,duration:400,ease:"Sine.easeIn"})),this.tweener.setTweens(e)}animateOut(){this.tweener.setTweens([this.scene.tweens.add({targets:this,scale:{from:1,to:.1},alpha:{from:1,to:0},duration:200,ease:"Sine.easeOut"})],(()=>this.removeFromDisplayList()))}setProps(e){this.props=e,this.headerText.setText(e.title),e.content&&this.setContent(e.content),this.preUpdate.makeDirty()}setContent(e){this.content!==e&&(this.content&&(this.remove(this.content),this.scene.children.remove(this.content)),this.content=e,this.add(e),this.preUpdate.makeDirty())}updateLayout(){if(!this.content)return;console.log("CONTENT",this.content,"SIZE",this.content.width,"x",this.content.height);let e=this.content.width+2*l,t=this.content.height+d+h;e>this.scene.bounds.width&&(this.content.width=this.scene.bounds.width-2*l,e=this.scene.bounds.width);const i={x:-e/2,y:-t/2-d};this.headerText.setPosition(-this.headerText.width/2,i.y+g+9),this.chrome.setPosition(i.x,i.y),this.chrome.setSize(e,t),this.headerRibbon.setPosition(i.x-u,i.y+g),this.headerRibbon.width=e+2*u,this.headerLeftStrap.setPosition(i.x-u-m,i.y+g+p),this.headerRightStrap.setPosition(i.x+e+u-this.headerRightStrap.width+m,i.y+g+p),console.log("SETTING CONTENT POSITION",i.x+l,i.y+d),this.content.setPosition(i.x+l,i.y+d)}}t.ModalWindow=y},75255:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaletteSlot=t.Palette=void 0;var s=Phaser.GameObjects.Image,n=Phaser.GameObjects.BitmapText;const a=i(97306),o=i(71203),r=i(9095),c=i(1157),l=i(95569);class d extends l.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.props=t,this.slots=[],this.slotByValue=new Map,this.currentSelection=void 0,this.setProps(this.props)}setProps(e){this.destroySlots(),this.slotByValue.clear();for(let t of e.items){const e=t.map((e=>{const t=new u(this.scene,{icon:e.image,hotkey:e.hotkey,onClick:()=>this.handleValueClicked(e.value)});return this.slotByValue.set(e.value,t),t}));this.slots.push(e),this.add(e)}this.preUpdate.makeDirty()}handleValueClicked(e){o.inject.audio.playEffect(r.SoundEffects.ButtonDown),this.select(e),this.props.onItemSelected(e)}select(e){if(this.currentSelection){const e=this.slotByValue.get(this.currentSelection);e&&e.setSelected(!1)}if(this.currentSelection=e,e){const t=this.slotByValue.get(e);t&&t.setSelected(!0)}}forEachSlot(e){for(let t of this.slots)for(let i of t)e(i)}destroySlots(){for(let e of this.slots)for(let t of e)t.destroy();this.slots=[]}updateLayout(){let e=0,t=0;for(let i of this.slots)if((0,a.layoutFromLeftToRight)(0,t,this.props.spacing,i),i.length>0){const s=i[i.length-1].x+i[i.length-1].width;s>e&&(e=s),t+=i[0].height+this.props.spacing}this.updateSize()}calculateHeight(){const e=this.slots[this.slots.length-1][0];return e?(console.log("CALCULATED HEIGHT",e.y+e.height),e.y+e.height):0}}t.Palette=d;const h="ui/palette-slot";class u extends l.ResponsiveContainer{constructor(e,{icon:t,hotkey:i,onClick:a}){super(e),this.background=new s(e,0,0,"atlas",h),this.icon=t,this.background.setInteractive({useHandCursor:!0}),this.background.on("pointerdown",(()=>a())),this.hotkey=new n(e,0,0,c.BitmapFont.Debug,i).setTint(986895),this.hotkey.setPosition(this.background.width-this.hotkey.width-2,2),this.add([this.background,this.icon,this.hotkey]),this.width=this.background.width,this.height=this.background.height}setSelected(e){this.background.setFrame(e?"ui/palette-slot-selected":h)}updateLayout(){this.icon.setOrigin(.5,.5).setPosition(this.background.width/2,this.background.height/2)}}t.PaletteSlot=u},56849:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.DialogButtons=void 0,(i=t.DialogButtons||(t.DialogButtons={})).OK="OK",i.Save="SAVE",i.Cancel="CANCEL",i.NewGame="START",i.Launch="LAUNCH",i.GiveUp="GIVE UP",i.Restart="RESTART",i.Load="LOAD"},97306:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.centerVertically=t.center=t.centerHorizontally=t.layoutFromLeftToRight=void 0,t.layoutFromLeftToRight=function(e,t,i,s){let n=e;for(let e of s)e.setPosition(n,t),n=n+e.width+i},t.centerHorizontally=function(e,t,i,s){e.setPosition(t+s/2-e.width/2,i)},t.center=function(e,t,i,s,n){e.setPosition(t+s/2-e.width/2,i+n/2-e.height/2)},t.centerVertically=function(e,t,i,s){e.y=i+s/2-e.height/2}},30132:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AbandonLevelDialog=void 0;const s=i(56849),n=i(60932),a=i(11e3),o=i(76733);class r extends a.BaseDialogUIProvider{getTitle(){return"Abandon game"}createContent(e){return this.label=new o.Label(e,"Are you sure you want to give up your progress on this island?"),this.label}getButtons(){return[{text:s.DialogButtons.Cancel,role:n.DialogButtonRole.Regular},{text:s.DialogButtons.GiveUp,role:n.DialogButtonRole.PrimaryDanger}]}applyProps(e){e.message&&this.label.setText(e.message),super.applyProps(e)}}t.AbandonLevelDialog=r},11e3:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseDialogUIProvider=void 0;const s=i(39052),n=i(96486),a=i(76733),o=i(60932);class r extends s.BaseUiProvider{constructor(){super(...arguments),this.onClose=n.noop}createElement(e){let t=this.createContent(e);return"string"==typeof t&&(t=new a.Label(e,t,{width:e.bounds.contentWidth})),this.plate=new o.ModalDialogContentLayout(e,{content:t,maxWidth:e.bounds.contentWidth,buttons:this.getButtons(),onClicked:e=>this.handleClose(e)}),this.plate}handleClose(e){this.onClose(e)}applyProps(e){this.props=e,this.onClose=e.onClose,this.plate.preUpdate.makeDirty()}}t.BaseDialogUIProvider=r},39052:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseUiProvider=void 0,t.BaseUiProvider=class{getContent(e,t){return this.element||(this.element=this.createElement(e)),this.applyProps(t),this.element}dispose(){}}},97947:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EditMapJSONDialog=void 0;const s=i(11e3),n=i(56849),a=i(76733),o=i(60932),r=i(69893),c=i(71203),l=i(9095),d=i(1956),h=i(5085);class u extends s.BaseDialogUIProvider{getTitle(){return"Edit map JSON data"}applyProps(e){super.applyProps(e),this.gameState=e.gameState;const t=JSON.stringify(this.gameState,null,2);this.textArea.setText(t),this.validate(t)}createContent(e){return this.textArea=new d.TextArea(e,{width:c.inject.device.screenWidth-200,height:c.inject.device.screenHeight-300,autoSelectAll:!1,onChange:this.validate.bind(this),customCss:"font-family: monospace, monospace;font-size:8pt"}),this.statusLabel=new a.Label(e,"Sanity check OK!"),new h.VLayout(e,{content:[this.textArea,this.statusLabel],spacing:16,width:c.inject.device.screenWidth-200})}getButtons(){return[{text:n.DialogButtons.Cancel,role:o.DialogButtonRole.Regular},{text:n.DialogButtons.Save,role:o.DialogButtonRole.PrimaryGreen}]}handleClose(e){super.handleClose(e),e===n.DialogButtons.Save&&(this.validate(this.textArea.text)?(c.inject.gameStateModel.restore(this.gameState),c.inject.scene.worldMap.scene.isActive()&&c.inject.scene.worldMap?.syncState(c.inject.currentGameState)):c.inject.audio.playEffect(l.SoundEffects.Deny)),this.textArea.destroy()}validate(e){let t;try{t=JSON.parse(e)}catch(e){return this.statusLabel.setText(`Invalid JSON: ${e.message.replaceAll("\n","\\n")}`),!1}try{(0,r.decompressGameState)(t)}catch(e){return this.statusLabel.setText(`Invalid GameState: ${e.message.replaceAll("\n","\\n")}`),!1}return this.statusLabel.setText("Sanity check OK!"),this.gameState=t,!0}}t.EditMapJSONDialog=u},26151:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExportMapDialog=void 0;const s=i(56849),n=i(60932),a=i(76733),o=i(11e3),r=i(5085),c=i(1956);class l extends o.BaseDialogUIProvider{getTitle(){return"Export Map"}applyProps(e){super.applyProps(e),this.textArea.setText(e.saveData)}createContent(e){return this.textArea=new c.TextArea(e,{readOnly:!0,autoSelectAll:!0}),new r.VLayout(e,{content:[new a.Label(e,"This is your map. Keep it somewhere safe!"),this.textArea],spacing:16,width:800})}getButtons(){return[{text:s.DialogButtons.OK,role:n.DialogButtonRole.Regular}]}handleClose(e){super.handleClose(e),this.textArea.destroy()}}t.ExportMapDialog=l},67381:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HtmlDialog=void 0;const s=i(56849),n=i(60932),a=i(11e3),o=i(92924);class r extends a.BaseDialogUIProvider{getTitle(){return this.title}applyProps(e){super.applyProps(e),this.title=e.title,this.iframe.node.src=e.url}createContent(e){return this.iframe=new o.IFrame(e,{url:"",customCss:"width: 800px; height: 430px"}),this.iframe}handleClose(e){super.handleClose(e),this.iframe.destroy(),this.element=void 0}getButtons(){return[{text:s.DialogButtons.OK,role:n.DialogButtonRole.Regular}]}}t.HtmlDialog=r},28337:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoadGameDialog=void 0;const s=i(56849),n=i(60932),a=i(76733),o=i(11e3),r=i(96486),c=i(5085),l=i(1956);class d extends o.BaseDialogUIProvider{constructor(){super(...arguments),this.onLoad=r.noop}getTitle(){return"Load Game"}applyProps(e){super.applyProps(e),this.onLoad=e.onLoad,this.textArea.setText("")}createContent(e){return this.textArea=new l.TextArea(e,{readOnly:!1,width:800,height:600}),new c.VLayout(e,{spacing:16,content:[new a.Label(e,"Paste your map data in the text area below:"),this.textArea],width:800})}getButtons(){return[{text:s.DialogButtons.Cancel,role:n.DialogButtonRole.Regular},{text:s.DialogButtons.Load,role:n.DialogButtonRole.PrimaryDanger}]}handleClose(e){super.handleClose(e),e===s.DialogButtons.Load&&this.onLoad(this.textArea.text.trim()),this.textArea.destroy()}}t.LoadGameDialog=d},65953:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OopsDialog=void 0;const s=i(56849),n=i(60932),a=i(76733),o=i(11e3);class r extends o.BaseDialogUIProvider{getTitle(){return"Oops!"}applyProps(e){super.applyProps(e),this.label.setText(e.message)}createContent(e){return this.label=new a.Label(e,"Something went wrong :("),this.label}getButtons(){return[{text:s.DialogButtons.OK,role:n.DialogButtonRole.Regular}]}}t.OopsDialog=r},76350:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RestartGameDialog=void 0;const s=i(56849),n=i(60932),a=i(11e3),o=i(76733);class r extends a.BaseDialogUIProvider{getTitle(){return"Restart Island"}createContent(e){return this.label=new o.Label(e,"Are you sure? All progress will be lost!"),this.label}getButtons(){return[{text:s.DialogButtons.Cancel,role:n.DialogButtonRole.Regular},{text:s.DialogButtons.Restart,role:n.DialogButtonRole.PrimaryDanger}]}applyProps(e){super.applyProps(e),e.message&&this.label.setText(e.message)}}t.RestartGameDialog=r},9095:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AudioManager=t.SoundEffects=void 0;const s=i(62199);var n;!function(e){e.Grab="grab.wav",e.Drop="drop.wav",e.Deny="deny.wav",e.ButtonDown="button-down.wav",e.ButtonUp="button-up.wav",e.ShutterClick="shutter-click.wav",e.Victory="victory.mp3",e.Glitter="glitter.mp3",e.Rewind="rewind.mp3",e.Defeat="defeat.mp3"}(n=t.SoundEffects||(t.SoundEffects={})),s.logger.for("audio"),t.AudioManager=class{constructor(e){this.game=e}load(e){for(let t of Object.values(n))e.load.audio(t,`assets/audio/${t}`)}playEffect(e){this.game.sound.play(e)}stopEffect(e){this.game.sound.stopByKey(e)}get mute(){return this.game.sound.mute}set mute(e){this.game.sound.mute=e}}},92536:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ObjectTweener=t.Tweener=t.BasicTweener=t.Tween=void 0,t.Tween=Phaser.Tweens.Tween;const s=i(96486),n=i(62199),a=i(73735),o=n.logger.for("Tweener");t.BasicTweener=class{constructor(){this.currentTweens=new Set,this.currentCallback=s.noop}setTweens(e,t){this.currentTweens.forEach((e=>e.stop())),this.currentTweens=new Set(e),this.currentCallback=t||s.noop,e.forEach((e=>e.on("complete",(e=>this.handleCompleted(e)))))}handleCompleted(e){0!==this.currentTweens.size&&(this.currentTweens.delete(e),0===this.currentTweens.size&&(this.currentCallback(),this.currentCallback=s.noop))}},t.Tweener=class{constructor(e,t={}){this.scene=e,this.defaultTweenConfig=t,this.tweensByTarget=new Map}add(e){const t=e.onComplete,i=Array.isArray(e.targets)?e.targets:[e.targets];if(0===i.length)return void o.trace("ignoring request to add tween with no targets");e.onComplete=(...e)=>{for(let e of i)this.tweensByTarget.delete(e);t?.(...e)};const s=this.scene.tweens.add({...e,...this.defaultTweenConfig});if(e.targets)for(let e of i){const t=this.tweensByTarget.get(e);t&&(1===t.targets.length&&t.targets[0]===e?t.stop(1):(0,a.removeFromArrayInPlace)(t.targets,e)),this.tweensByTarget.set(e,s)}return s}stop(e=!0){(0,a.stripDuplicatesFrom)(Array.from(this.tweensByTarget.values())).forEach((t=>{t.stop(1),e&&t.complete()})),this.tweensByTarget.clear()}},t.ObjectTweener=class{constructor(e){this.parent=e,this.tag=""}stop(e=!0){this.tween&&(this.tween.stop(1),this.tween=void 0,this.tag="")}set(e,t="anonymous"){this.tween&&this.stop(),this.tween=this.parent.scene.tweens.add(e),this.tag=t}}},47287:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Chunk=t.ChunkedRenderer=t.ChunksRenderingController=void 0;const s=i(73735),n=i(46438),a=i(36504),o=i(26792),r=i(62199),c=i(71203);r.logger.for("ChunkedRenderer"),t.ChunksRenderingController=class{constructor(e,t,i=o.HEX_WIDTH){this.scene=e,this.renderer=t,this.margin=i,this.camera=this.scene.cameras.main}update(){const e=Phaser.Geom.Rectangle.Inflate(this.camera.worldView,this.margin,this.margin);for(const t of this.renderer.getVisibleChunks())Phaser.Geom.Intersects.RectangleToRectangle(e,t.boundingBox)||t.setVisible(!1);for(const t of this.renderer.getChunksInRect(e))t.setVisible(!0);c.inject.debugData.set("visibleChunks",this.renderer.getVisibleChunks().size.toString())}renderEverything(){this.renderer.getAllChunks().forEach((e=>e.setVisible(!0)))}},t.ChunkedRenderer=class{constructor(e,t=5){this.scene=e,this.chunkSize=t,this.chunks={},this.visibleChunks=new Set,this.sectorMap=new n.HexGridSectors(t)}getVisibleChunks(){return this.visibleChunks}getAllChunks(){return Object.values(this.chunks)}getByHex(e){return this.getById(this.sectorMap.getSectorOf(e))}getById(e){return(0,s.getOrCreate)(this.chunks,e,(()=>new l(this,e)))}add(e,t){const i=this.sectorMap.getSectorOf(e);return this.getById(i).add(t),t}remove(e,t){const i=this.sectorMap.getSectorOf(e);return this.getById(i).remove(t),t}getChunksInRect(e){return this.getAllChunks().filter((t=>Phaser.Geom.Intersects.RectangleToRectangle(e,t.boundingBox)))}};class l{constructor(e,t){this.parent=e,this.visible=!1,this.id=t,this.group=new Phaser.GameObjects.Group(e.scene),this.visible=!1,this.boundingBox=(0,a.rectToPhaser)((0,a.multiplyRect)(e.sectorMap.getSectorRect(t),o.HEX_WIDTH,o.HEX_INNER_HEIGHT))}add(e){return this.parent.scene.add.existing(e),this.group.add(e),this.visible?e.addToDisplayList():(e.addToDisplayList(),e.removeFromDisplayList()),e}remove(e){return this.group.remove(e,!0),e}setVisible(e){if(e===this.visible)return;const t=this.group.getChildren();e?(this.visible=!0,this.parent.visibleChunks.add(this),t.forEach((e=>e.addToDisplayList()))):(this.visible=!1,this.parent.visibleChunks.delete(this),t.forEach((e=>e.removeFromDisplayList())))}}t.Chunk=l},26244:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ParallelCinematic=t.BaseCinematic=t.BlankCinematic=void 0,t.BlankCinematic={async play(){},playAfter:e=>new Promise((t=>setTimeout(t,e)))};class i{constructor(e){this.scene=e}play(){return new Promise((e=>{this.execute(e)}))}playAfter(e,t){return new Promise((t=>{this.scene.time.addEvent({delay:e,callback:()=>this.execute(t)})}))}}t.BaseCinematic=i,t.ParallelCinematic=class extends i{constructor(e){super(e),this.subCinematics=[]}add(e){this.subCinematics.push(e)}execute(e){Promise.all(this.subCinematics.map((e=>e.play()))).then(e)}}},42519:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.debugBreakPointProvider=void 0;const s=i(71203);t.debugBreakPointProvider=async function(e,t){if(!s.inject.config.debug.overlay||!s.inject.config.debug.breakpoints)return;const i=s.inject.config.debug.breakpoints;if(Array.isArray(i)&&!i.find((t=>e.startsWith(t))))return;const n=s.inject.scene.debug,a=s.inject.scene.worldMap,o=s.inject.navigator.currentScreen;s.inject.navigator.goTo(s.inject.screen.breakpoint),a.syncState(s.inject.gameStateModel.state),console.warn("HANDLING BREAKPOINT"),await n.handleBreakpoint(e,t?t():{}),console.info("BREAKPOINT HANDLED, WILL RETURN TO",o.constructor.name),s.inject.navigator.goTo(o)}},95794:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IsoTileGroup=t.Image=void 0,t.Image=Phaser.GameObjects.Image;const s=i(35171);i(62199).logger.for("IsoTileGroup"),t.IsoTileGroup=class{constructor(e,t,i){this.renderer=e,this.recipe=t,this.postProcessor=i,this.triangles={},this.hexes=s.HexGroup.empty,this.dirtyCorners=[]}addHexes(e){const t=e.filter((e=>!this.hexes.has(e)));this.hexes=this.hexes.with(...t.members);const i=t.getCorners();this.dirtyCorners.push(...i)}setHexes(e){const t=this.hexes.without(e),i=e.without(this.hexes);this.addHexes(i),this.removeHexes(t),this.update()}removeHexes(e){this.hexes=this.hexes.without(e);const t=e.getCorners();this.dirtyCorners.push(...t)}update(){this.dirtyCorners.forEach((e=>this.updateCorner(e))),this.dirtyCorners=[]}updateCorner(e){if(this.triangles[e.id]?.destroy(),this.hexes.hasCorner(e)){const t=this.renderTriangle(e.display,e.sortedHexes);t&&(this.triangles[e.id]=t)}else delete this.triangles[e.id]}renderTriangle(e,i){const s=i.sort(((e,t)=>e.id-t.id)),n=s[0].y===s[1].y,a=(n?"V":"A")+s.map((e=>this.hexes.has(e)?"1":"0")).join(""),o=this.recipe.frames[a];if(!o)return;const r=new t.Image(this.renderer.scene,e.x,e.y,"atlas",`${this.recipe.frameIdBase}/${o.frame}`);if(r.setDepth(this.recipe.baseDepth+r.y),r.setOrigin(.5,0),o.flipY&&(r.flipY=!0,r.y+=r.height),o.flipX&&(r.flipX=!0),o.crop){const{x:e,y:t,width:i,height:s}=o.crop;r.setOrigin(0,0),r.setCrop(e,t,i,s),r.x=r.x-e-i/2,r.y=r.y-t}return r.y-=(n?this.recipe.offsetV:this.recipe.offsetA)||0,this.postProcessor(r),this.renderer.add(s[0],r),r}clear(){Object.values(this.triangles).forEach((e=>e.destroy())),this.triangles={},this.hexes=s.HexGroup.empty}}},1245:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KineticValue=t.KineticValuePhase=void 0;const s=i(62199),n=i(1951);var a;s.logger.for("KineticValue"),function(e){e.Frozen="frozen",e.Sliding="sliding",e.Tweening="tweening",e.Stable="stable"}(a=t.KineticValuePhase||(t.KineticValuePhase={})),t.KineticValue=class{constructor(e,t){this.value=e,this.speed=0,this.phase=a.Stable,this.continueToNextStopThreshold=100,this.min=-99999,this.max=99999,this.drag=t.drag,void 0!==t.min&&(this.min=t.min),void 0!==t.max&&(this.max=t.max),t.continueToNextStopThreshold&&(this.continueToNextStopThreshold=t.continueToNextStopThreshold),this.stops=Array.isArray(t.stops)?new o(t.stops):t.stops,this.apply=t.apply,this.scene=t.scene,this.apply(this.value)}accelerate(e){this.phase!==a.Frozen&&(this.cancelSnap(),this.phase=a.Sliding,this.speed+=e)}cancelSnap(){this.tween&&(this.tween.stop(),this.tween=void 0),this.targetStop=void 0,this.phase===a.Tweening&&(this.phase=a.Sliding)}freeze(){this.phase=a.Frozen,this.targetStop=void 0}unfreeze(){this.phase=a.Sliding,this.speed=0}pushToNextStop(){if(this.cancelSnap(),this.unfreeze(),this.targetStop=this.stops?.getNextFrom(this.value+.001),void 0!==this.targetStop){const e=c(this.value,this.targetStop,this.drag);this.accelerate(e)}}pushToPrevStop(){if(this.cancelSnap(),this.unfreeze(),this.targetStop=this.stops?.getPreviousFrom(this.value-.001),void 0!==this.targetStop){const e=c(this.value,this.targetStop,this.drag);this.accelerate(e)}}pushTo(e){this.cancelSnap(),this.unfreeze();const t=c(this.value,e,this.drag);this.accelerate(t)}update(e,t){const i=t/1e3,s=this.drag*i;switch(this.phase){case a.Tweening:return this.value=this.tween.getValue(),void this.apply(this.value);case a.Stable:case a.Frozen:return;case a.Sliding:if(this.stops&&(void 0===this.targetStop&&(this.targetStop=function(e,t,i,s,n){const a=n.getPreviousFrom(e-.001),o=n.getNextFrom(e+.001);let r=d(n,e);const c=l(e,t,s,0);if(Math.abs(t)>i){const e=d(n,c);r=t>0?e===r&&o||e:e===r&&a||e}return r}(this.value,this.speed,this.continueToNextStopThreshold,this.drag,this.stops)),void 0!==this.targetStop)){const e=c(this.value,this.targetStop,this.drag);if(this.speed||this.targetStop!==this.value)if(this.speed<e){const t=e-this.speed;this.speed+=Math.min(t,this.drag*i*2)}else if(this.speed>e){const t=this.speed-e;this.speed-=Math.min(t,this.drag*i*2)}}this.speed&&l(this.value,this.speed,this.drag,s),this.speed>0?this.speed-=(0,n.min)(this.speed,s):this.speed<0&&(this.speed+=(0,n.min)(-this.speed,s)),Math.abs(this.speed)<.001&&(void 0===this.targetStop||Math.abs(this.value-this.targetStop)<1)?(this.phase=a.Stable,this.speed=0,this.targetStop&&(this.value=this.targetStop)):this.value+=this.speed*i,this.applyHardLimits(),this.apply(this.value)}}async tweenTo(e,t,i){return this.cancelSnap(),this.phase=a.Tweening,new Promise((s=>{this.tween=this.scene.tweens.addCounter({from:this.value,to:e,duration:t,ease:i,onComplete:()=>{this.apply(e),this.phase=a.Stable,this.tween=void 0,s()},onStop:()=>{s()}})}))}applyHardLimits(){this.value<this.min&&(this.value=this.min),this.value>this.max&&(this.value=this.max)}setTo(e){this.cancelSnap(),this.speed=0,this.value=e,this.applyHardLimits(),this.apply(e)}};class o{constructor(e){this.stops=e}getNextFrom(e){if(0!==this.stops.length)return this.stops.find((t=>t>=e))}getPreviousFrom(e){if(0!==this.stops.length)return this.stops.slice().reverse().find((t=>t<=e))}}let r=0;function c(e,t,i){const s=Math.abs(e-t),n=e>t?-1:1;return Math.sqrt(2*s*i)*n}function l(e,t,i,s){const n=t>0?1:-1,a=Math.abs(t)-s/2,o=e+a*a/(2*i)*n;return o!==r&&(r=o),o}function d(e,t){const i=e.getPreviousFrom(t),s=e.getNextFrom(t);return void 0===i?s:void 0===s?i:Math.abs(t-i)>Math.abs(t-s)?s:i}},694:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LODManager=void 0,t.LODManager=class{constructor(e,t=[]){this.camera=e,this.latestZoom=void 0,this.handlers=t}registerLODlevel(e){this.handlers.push(e)}update(){this.apply(this.camera.zoom)}apply(e,t){if(e!==this.latestZoom||t){for(let i of this.handlers)!i.when(e)||void 0!==this.latestZoom&&!t&&i.when(this.latestZoom)||i.activate(e);this.latestZoom=e}}}},17225:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getShadowFrameForPawnType=t.getFrameForEmojiFace=t.getFrameForPawnSymbol=t.getScaleForPawnType=t.getFrameForPawnType=t.WorldObjectsPool=void 0;var s=Phaser.GameObjects.Group,n=Phaser.GameObjects.Image,a=Phaser.GameObjects.Sprite;const o=i(73508),r=i(62199),c=i(71203),l=i(105);function d(e,t=1){return e===o.PawnType.Town?"pawns/town-"+t:"pawns/"+e}function h(e){return"tile-symbols/"+e.slice(2)}function u(e){return"attitude-emoji/"+e}function g(e,t=1){return e===o.PawnType.Town?`pawns/town-${t}-shadow`:"pawn-shadow"}r.logger.for("WorldObjectPools"),t.WorldObjectsPool=class{constructor(e){this.scene=e,this.coins=new s(this.scene,{defaultKey:"coin",classType:a}),this.coinStacks=new s(this.scene,{defaultKey:"atlas",defaultFrame:"coinstack",classType:n}),this.pawnImages=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"pawns/villager",classType:a}),this.pawnShadows=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"pawn-shadow",classType:n}),this.flags=new s(this.scene,void 0,{defaultKey:"flag",classType:a}),this.flagPoles=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"flag-pole",classType:n}),this.tileSymbols=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"tile-symbols/alert",classType:n}),this.emojiFaces=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"attitude-emoji/22",classType:n}),this.emojiCrowns=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"attitude-emoji/crown",classType:n}),this.scene.anims.create({key:"wave-flag",frames:this.scene.anims.generateFrameNumbers("flag",{frames:[0,1,2,3,4,5,6,7]}),frameRate:20,repeat:-1})}updateDebugData(){c.inject.config.debug.objectPools?c.inject.debugData.set("worldObjects",`\n  coins: ${this.printGroupStats(this.coins)}\n  coinStacks: ${this.printGroupStats(this.coinStacks)}\n  pawnImages: ${this.printGroupStats(this.pawnImages)}\n  pawnShadows: ${this.printGroupStats(this.pawnShadows)}`):c.inject.debugData.clear("worldObjects")}printGroupStats(e){return`${e.getTotalUsed()}/${e.getChildren().length}`}getPawnImage(e,t){return this.getAndActivate(this.pawnImages).setFrame(d(e,t)).setScale(.5).setRotation(0)}getPawnShadow(e,t){return this.getAndActivate(this.pawnShadows).setFrame(g(e,t)).setScale(.5)}getCoin(e,t){return this.getAndActivate(this.coins).setOrigin(.5,.57143).setPosition(e,t).setFrame(0).setScale(.5)}getCoinStack(e,t){return this.getAndActivate(this.coinStacks).setOrigin(.5,1).setScale(.5).setPosition(e,t)}getFlag(e,t){return this.getAndActivate(this.flags,e,t).setOrigin(0,0)}getFlagPole(e,t){return this.getAndActivate(this.flagPoles,e,t)}getTileSymbol(e){return this.getAndActivate(this.tileSymbols).setFrame(h(e))}getEmojiFace(e){return this.getAndActivate(this.emojiFaces).setFrame(u(e))}getEmojiCrown(){return this.getAndActivate(this.emojiCrowns)}free(e){c.inject.config.debug.objectPools&&e.setActive(!1),e.setVisible(!1)}getAndActivate(e,t,i){e.defaultFrame||e.defaultKey;const s=e.get(t,i).setVisible(!0).setActive(!0).setAlpha(1);return c.inject.config.debug.objectPools&&("?"!==(0,l.getObjId)(s)||(0,l.assignObjId)(s)),s}},t.getFrameForPawnType=d,t.getScaleForPawnType=function(e){return.5},t.getFrameForPawnSymbol=h,t.getFrameForEmojiFace=u,t.getShadowFrameForPawnType=g},59869:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PropTransitionController=void 0;const s=i(71203);t.PropTransitionController=class{constructor(e,t,i,s){this.scene=e,this.target=t,this.propName=i,this._targetValue=0,this.defaultTweenOptions={duration:s.duration??500,ease:s.ease??"Sine.easeOut"}}applyValue(e){this.target[this.propName]=e}get currentValue(){return this.target[this.propName]}get targetValue(){return this.tween?this._targetValue:this.currentValue}setTo(e){this.stopTransition(),this.applyValue(e)}transitionTo(e,t){if(s.inject.ui.skipTransitions())return void this.setTo(e);this.tween&&this.tween.stop(),this._targetValue=e;const i=t?{...this.defaultTweenOptions,...t}:this.defaultTweenOptions;this.tween=this.scene.tweens.add({targets:this.target,props:{[this.propName]:{from:this.target[this.propName],to:e}},duration:i.duration,ease:i.ease,onComplete:()=>{this.setTo(e)}})}stopTransition(){this.tween&&(this.tween.stop(),this.tween=void 0)}}},63286:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Control=t.TransitionController=void 0;const s=i(71203),n=i(59869);class a{constructor(e,t){this.scene=e,this.currentValue=0,this.currentTarget=0,this.currentValue=t.initialValue||0,this.defaultTweenOptions={duration:500,ease:"Sine.easeOut",...t},this.applyValue=t.applyValue}setTo(e){return this.tween&&(this.tween.stop(),this.tween=void 0),this.currentValue=e,this.currentTarget=e,this.applyValue(e),this}transitionTo(e,t){if(s.inject.ui.skipTransitions())return void this.setTo(e);if(this.currentTarget===e)return;this.currentTarget=e,this.tween&&this.tween.stop();const i=t?{...this.defaultTweenOptions,...t}:this.defaultTweenOptions;this.tween=this.scene.tweens.addCounter({from:this.currentValue,to:e,...i,onComplete:()=>{this.setTo(e)}}),this.tween.on("update",(()=>this.onTweenUpdated()))}onTweenUpdated(){this.currentValue=this.tween.getValue(),this.applyValue(this.currentValue)}}t.TransitionController=a,t.Control={visibilityOf:(e,t)=>new a(e.scene,{...t,initialValue:e.alpha,applyValue:t=>e.setAlpha(t)}),propOf:(e,t,i)=>new n.PropTransitionController(e.scene,e,t,{...i})}},3724:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TwoPointersTracker=void 0;const s=i(62199),n=i(73735),a=i(36504);var o;s.logger.for("TwoPointersTracker"),function(e){e.Idle="idle",e.InteractionStarted="interaction-started",e.Drag="drag",e.Pinch="pinch"}(o||(o={})),t.TwoPointersTracker=class{constructor(e){this.scene=e,this.pointers=[],this.pointerMoved={},this.state=o.Idle,this.scene.input.on("pointerdown",this.onPointerDown,this),this.scene.input.on("pointerup",this.onPointerUp,this),this.scene.input.on("gameout",this.dragCancel,this),this.scene.input.on("pointermove",this.onPointerMove,this)}onPointerDown(e){if(2!==this.pointers.length&&-1===this.pointers.indexOf(e))switch(this.pointerMoved[e.id]=!1,this.pointers.push(e),this.state){case o.Idle:this.hasInteraction(e)?(this.onStartInteraction(e),setTimeout((()=>this.transitionToDrag(e)),200),this.state=o.InteractionStarted):(this.onStartDrag(e),this.state=o.Drag);break;case o.InteractionStarted:this.state=o.Pinch,this.onAbortInteraction(e),this.onStartPinch(e);break;case o.Drag:this.state=o.Pinch,this.onEndDrag(e),this.onStartPinch(e)}}onPointerUp(e){if(-1!==this.pointers.indexOf(e))switch((0,n.removeFromArrayInPlace)(this.pointers,e),this.state){case o.InteractionStarted:this.state=o.Idle,this.onCompleteInteraction(e);break;case o.Drag:this.state=o.Idle,this.onEndDrag(e);break;case o.Pinch:this.state=o.Drag,this.onEndPinch(e),this.onStartDrag(e)}else this.onCompleteInteraction(e)}onPointerMove(e){if(e.isDown&&(this.pointerMoved[e.id]||(this.pointerMoved[e.id]=e.x!==e.downX||e.y!==e.downY),this.pointerMoved[e.id]))switch(this.state){case o.Drag:this.onDrag(e);break;case o.Pinch:this.onPinch(e)}}transitionToDrag(e){this.state===o.InteractionStarted&&(this.onStartDrag(e),this.state=o.Drag)}dragCancel(){return this.state===o.Pinch&&this.onEndPinch(this.scene.input.activePointer),this.state===o.Drag&&this.onEndDrag(this.scene.input.activePointer),this.clear(),this}hasInteraction(e){return!1}clear(){this.pointers.length=0,this.pointerMoved={},this.state=o.Idle}get distanceBetweenPointers(){if(this.state!==o.Pinch)return 0;const e=this.pointers[0],t=this.pointers[1];return(0,a.euclidDistance)(e,t)}onStartDrag(e){}onStartInteraction(e){}onAbortInteraction(e){}onCompleteInteraction(e){}onEndDrag(e){}onStartPinch(e){}onEndPinch(e){}onDrag(e){}onPinch(e){}}},98439:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getObjectCameraRect=t.convertWorldXYToCameraXY=void 0,t.convertWorldXYToCameraXY=function(e,t,i){const s=e.getWorldPoint(0,0);return{x:(t-s.x)*e.zoom,y:(i-s.y)*e.zoom}},t.getObjectCameraRect=function(e){const t={x:0,y:0},i={x:0,y:0},s=e.getWorldTransformMatrix();return s.transformPoint(0,0,t),s.transformPoint(e.displayWidth,e.displayHeight,i),{x:t.x,y:t.y,width:i.x-t.x,height:i.y-t.y}}},105:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MEMORY_MARKER=t.debugMethodCalls=t.assignObjId=t.getObjId=void 0;const s=i(52163);let n=1;t.getObjId=function(e){return e.getData("id")||"?"},t.assignObjId=function(e){return e.setData("id",n++),n-1},t.debugMethodCalls=function(e,t,i){(0,s.assert)("function"==typeof e[t]);const n=e[t].bind(e);e[t]=(...s)=>(i?i(...s):console.warn(`${e.constructor.name}.${String(t)} called with`,...s),n(...s))},t.MEMORY_MARKER=class{constructor(){this.stuff=Array(200).fill(0).map((()=>Math.random()))}}},50737:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jump2=t.jump=void 0,t.jump=function(e,t){return e-Math.sin(e*Math.PI)*-t},t.jump2=function(e){return Math.sin(e*Math.PI)}},96532:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getLevelIcon=t.LevelIcons=void 0;const s=i(71203),n=i(80266);var a;!function(e){e.Gold="ui/level-icons/gold",e.Silver="ui/level-icons/silver",e.Bronze="ui/level-icons/bronze",e.Fighting="ui/level-icons/in-progress",e.NotStarted="ui/level-icons/no-trophy",e.Defeated="ui/level-icons/rip"}(a=t.LevelIcons||(t.LevelIcons={})),t.getLevelIcon=function(e){const t=s.inject.userData.getLevelProgressById(e);return t?t.bestResult?.outcome===n.LevelOutcome.Victory?a.Gold:t.inProgress?a.Fighting:a.NotStarted:a.NotStarted}},76038:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Probability=t.cropNumber=void 0,t.cropNumber=function(e,t,i){return Math.min(i,Math.max(t,e))},t.Probability={ofEither:(e,t)=>1-(1-e)*(1-t)}},32304:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createStaggeredDelay2Dfn=void 0;const s=i(36504),n=i(71203);t.createStaggeredDelay2Dfn=function(e,t=0,i=1e3,a=0){const o=(0,s.getBoundingBox)(e),r=o.width+o.height,c=i-t;return e=>t+(e.x-o.x+(e.y-o.y))/r*c+n.inject.random.integerBetween(0,a)}},5694:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.verifyWorldMapInSync=void 0;const s=i(73664),n=i(73508),a=i(62199).logger.for("integrity");t.verifyWorldMapInSync=function(e,t){const i=new s.StaticGameStateModel(t),o=i.map.getAllHexes();for(const e of o.members)r(e);function r(t){const s=i.pawns.getCount(t,n.PawnType.Coins);var o,r,c;o=t,(r=e.coins.getOrCreatePile(t).getCurrentAmount())!==(c=s)&&a.error(`Integrity check failed on ${o}! Expected coinsx${r}, found ${c}`)}a.info("WorldMapScene integrity check completed.")}},98616:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameStateHistory=void 0;const s=i(62616),n=i(71203);i(62199).logger.for("StateRecorder"),t.GameStateHistory=class{constructor(){this.capacity=20,this.data=new s.FixedCapacityArray(20),this.currentFrame=0,this.paused=!1}add(e,t=n.inject.gameStateModel.state){this.paused||this.data.push({state:t,label:e})}suspendRecording(){this.paused=!0}resumeRecording(){this.paused=!1}getAll(){return this.data.getItems()}get(e){return this.data.get(e)}length(){return this.data.length}}},42574:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NewsBox=void 0;const i=document.getElementById("news-box");let s=!1;t.NewsBox={show(){i&&(i.style.left="40px",i.style.bottom="40px",s=!1)},hide(){i&&!s&&(i.style.bottom=-i.offsetHeight-10+"px",s=!0)}}},59257:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameplayStatsCollector=t.BLANK_GAMEPLAY_STATS=void 0;const s=i(62199),n=i(18995),a=i(71203),o=i(27358),r=i(44188);s.logger.for("StatsCollector"),t.BLANK_GAMEPLAY_STATS=Object.freeze({playTimeSeconds:0,undoCount:0,clicks:0,turns:0,startTime:0,endTime:0}),t.GameplayStatsCollector=class{constructor(){this.stats={...t.BLANK_GAMEPLAY_STATS},this.playTimeMeasurementPaused=!0,this.currentLevelId=void 0;const e=a.inject.events;document.addEventListener("visibilitychange",(()=>{document.hidden?this.pausePlayTimeMeasurement():this.resumePlayTimeMeasurement()})),e.on(n.SystemEvents.ScreenActivated,(({screen:e})=>{e===a.inject.screen.play?(this.reset(),this.resumePlayTimeMeasurement()):this.pausePlayTimeMeasurement()})),e.on(n.SystemEvents.UserBecameInactive,(()=>{this.pausePlayTimeMeasurement()})),e.on(n.SystemEvents.UserBecameActive,(()=>{a.inject.navigator.currentScreen===a.inject.screen.play&&this.resumePlayTimeMeasurement()})),e.on(n.UserActions.Undo,(()=>{++this.stats.undoCount})),e.on(n.UserActions.EndTurn,(()=>{++this.stats.turns})),e.on(o.WorldMapEvents.StartInteraction,(()=>{++this.stats.clicks})),a.inject.ui.playedLevelId.watch((e=>{this.currentLevelId=e,this.reset()}))}getStats(e){return this.updatePlayTime(),e?{playTimeSeconds:e.playTimeSeconds+this.stats.playTimeSeconds,undoCount:e.undoCount+this.stats.undoCount,clicks:e.clicks+this.stats.clicks,turns:e.turns+this.stats.turns,startTime:this.stats.startTime,endTime:this.stats.endTime}:{...this.stats}}getSessionStats(e){return!e||(0,r.differenceInMinutes)(Date.now(),e.endTime)>=1?this.getStats():this.getStats(e)}pausePlayTimeMeasurement(){this.updatePlayTime(),this.stats.endTime=Date.now(),this.playTimeMeasurementPaused=!0}resumePlayTimeMeasurement(){this.playTimeMeasurementPaused=!1,this.stats.endTime=Date.now()}updatePlayTime(){if(this.stats.endTime&&!this.playTimeMeasurementPaused){const e=Math.round((Date.now()-this.stats.endTime)/1e3);e>0&&(this.stats.playTimeSeconds+=e)}this.stats.endTime=Date.now()}getDebugString(){const e=this.playTimeMeasurementPaused?0:(Date.now()-this.stats.endTime)/1e3;return`${this.playTimeMeasurementPaused?"[PAUSED]":`t=${(this.stats.playTimeSeconds+e).toFixed()}s`} undos=${this.stats.undoCount} clicks=${this.stats.clicks} turns=${this.stats.turns}`}reset(){this.stats={...t.BLANK_GAMEPLAY_STATS,startTime:Date.now(),endTime:Date.now()}}}},51059:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ActivityWatcher=void 0;const s=i(71203),n=i(18995),a=function(){let e,t=0,i=!0;function a(){t++,t>10&&i&&(i=!1,s.inject.events.trigger(n.SystemEvents.UserBecameInactive())),s.inject.config.debug.overlay&&s.inject.debugData.set("GameplayStats",s.inject.gameplayStats.getDebugString())}function o(){i||s.inject.events.trigger(n.SystemEvents.UserBecameActive()),i=!0,t=0}return["mousedown","mousemove","keydown","scroll","touchstart"].forEach((e=>{document.addEventListener(e,o,!0)})),{start:()=>{e||(e=setInterval(a,1e3))},stop:()=>{e&&(clearInterval(e),e=void 0)}}}();t.ActivityWatcher={start:a.start,stop:a.stop}},72591:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getLevelIdFromSaveGameKey=t.LocalStorageUserData=void 0;const s=i(69893),n=i(98697),a=i(38735),o=i(59286),r=i(71203),c=i(84809),l=i(68179),d=i(80266),h=i(62199),u=i(18995),g="konkr.userData",p=h.logger.for("UserData");function m(e,t){return l.SAVE_GAME_LOCAL_STORAGE_PREFIX+e+"."+t}function y(e){return e.slice(l.SAVE_GAME_LOCAL_STORAGE_PREFIX.length,e.lastIndexOf("."))}t.LocalStorageUserData=class{constructor(){}async initialize(){this.readMetadata(),await this.cleanup()}async cleanup(){await r.inject.mapRegistry.initialize(),this.deleteOrphanedLevelsFromLocalStorage(),this.writeMetadata()}deleteOrphanedLevelsFromLocalStorage(){const e=[],t=l.SAVE_GAME_LOCAL_STORAGE_PREFIX;for(const[i,s]of Object.entries(localStorage))if(i.startsWith(t)){const t=y(i);t&&!r.inject.mapRegistry.getLevelInfoById(t)&&this.recallChoice("latestLevelId")!==t&&e.push(i)}for(let t of e)p.info(`deleting orphaned save data ${t}`),delete this.metadata.savedGamesById[t],localStorage.removeItem(t)}getLevelProgressById(e){return this.metadata.savedGamesById[e]}async loadGame(e,t){const i=m(e,t),s=localStorage.getItem(i);if(!s)throw new Error(`no data found for save "${i}"`);let a;try{a=JSON.parse(s)}catch(e){throw new Error(`save data corrupted for ${i}`)}if(a.version!==n.CORE_GAMESTATE_SCHEMA_VERSION)throw new Error(`save data not compatible with current version of the game in ${i}`);if(a.map.levelId!==e)throw new Error(`Level id mismatch - expected "${e}", found ${a.map.levelId}"`);return a}rememberChoice(e,t){this.metadata.rememberedChoices[e]=t,this.writeMetadata()}recallChoice(e){return this.metadata.rememberedChoices[e]}deleteSavedGame(e,t=d.SaveGameTags.Autosave){const i=this.metadata.savedGamesById[e];switch(t){case d.SaveGameTags.Autosave:if(!i?.inProgress)break;a.track.levelDefeat({level_id:e,turns:i.inProgress.turnNumber,lives_left:i.inProgress.lives||o.DEFAULT_LIVES_PER_LEVEL}),i.inProgress=void 0,this.recallChoice("latestLevelId")===e&&this.rememberChoice("latestLevelId",void 0);break;case d.SaveGameTags.BestResult:i&&(i.bestResult=void 0)}localStorage.removeItem(m(e,t)),this.writeMetadata()}writeMetadata(){localStorage.setItem(g,JSON.stringify(this.metadata))}readMetadata(){const e=localStorage.getItem(g)??"{}";this._parseMetadata(e),p.info("User data initialized from local storage (key konkr.userData)"),console.debug(this.metadata),r.inject.events.trigger(u.SystemEvents.UserMetaDataLoaded(this.metadata)),this.writeMetadata()}_parseMetadata(e){let t,i;try{i=JSON.parse(e)}catch(e){p.error("Failed parsing metadata:",e),i={}}function s(){return t||(t=(0,d.defaultMetadata)()),t}"object"==typeof i&&i||(p.error("Ignoring invalid metadata"),i={});const n={...s(),userId:i.userId??s().userId,savedGamesById:i.savedGamesById??s().savedGamesById,rememberedChoices:{...s().rememberedChoices,...i.rememberedChoices},stats:i.stats??s().stats,feedbacks:i.feedbacks??s().feedbacks,tutorialsCompleted:i.tutorialsCompleted??s().tutorialsCompleted};this.metadata=n,t&&this.writeMetadata()}saveNewLevel(){r.inject.gameStateModel,this._saveLevelData(d.SaveGameTags.Start)}saveLevelProgress(){const e=r.inject.gameStateModel,t=r.inject.gameplayStats.getStats();t.playTimeSeconds>0&&a.track.levelProgress({level_id:r.inject.gameplayStats.currentLevelId,play_time_seconds:t.playTimeSeconds,undo_count:t.undoCount,clicks:t.clicks,turns:t.turns});const i=this.metadata.savedGamesById[e.map.levelId];this.metadata.savedGamesById[e.map.levelId]={...i,levelId:e.map.levelId,inProgress:{turnNumber:e.currentPhase.turnNumber,lives:r.inject.screen.play.remainingLives}},this.metadata.rememberedChoices.latestLevelId=e.map.levelId,this._updateLevelStats(e.map.levelId),this._saveLevelData(d.SaveGameTags.Autosave),this.writeMetadata()}_updateLevelStats(e){const t=this.metadata.stats.perLevel[e];this.metadata.stats.perLevel[e]={...t,latestSession:r.inject.gameplayStats.getSessionStats(t?.latestSession),total:r.inject.gameplayStats.getStats(t?.total)},this.metadata.stats.total=r.inject.gameplayStats.getStats(this.metadata.stats.total),this.metadata.stats.latestSession=r.inject.gameplayStats.getSessionStats(this.metadata.stats.latestSession),r.inject.gameplayStats.reset()}saveLevelOutcome(e){const t=r.inject.gameStateModel,i=c.LevelModel.for(t.map.levelId),s=t.currentPhase.turnNumber;if(i.parentCampaign){const t=this.metadata.savedGamesById[i.id],n=t.bestResult,a=n?.outcome===d.LevelOutcome.Victory?n.turnNumber:Number.MAX_VALUE,o={outcome:e,turnNumber:s};let r=n;(n?.outcome!==d.LevelOutcome.Victory||s<a)&&(r=o,this._saveLevelData(d.SaveGameTags.BestResult)),this.metadata.savedGamesById[i.id]={...t,levelId:i.id,inProgress:void 0,bestResult:r},this.metadata.rememberedChoices.latestLevelId=void 0,this._updateLevelStats(i.id)}this.deleteSavedGame(i.id,d.SaveGameTags.Autosave),this.writeMetadata(),(e===d.LevelOutcome.Victory?a.track.levelVictory:a.track.levelDefeat)({level_id:i.id,turns:s,lives_left:r.inject.screen.play.remainingLives})}_saveLevelData(e){const t=JSON.stringify((0,s.compressGameState)(r.inject.gameStateModel.stateEngine)),i=m(r.inject.gameStateModel.map.levelId,e);localStorage.setItem(i,t),p.info(`Current game state saved into local storage as "${i}"`)}getStats(){return this.metadata.stats}getUserId(){return this.metadata?.userId||""}async findFeedback(e={}){return this.metadata.feedbacks.find((t=>!(e.levelId&&e.levelId!==t.levelId||e.campaignId&&e.campaignId!==t.campaignId)))}saveFeedback(e){this.metadata.feedbacks.push(e),this.writeMetadata()}completeTutorial(e){this.metadata.tutorialsCompleted[e]=!0,this.writeMetadata()}hasCompletedTutorial(e){return this.metadata.tutorialsCompleted[e]??!1}},t.getLevelIdFromSaveGameKey=y},80266:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultMetadata=t.SaveGameTags=t.LevelOutcome=void 0;const s=i(71203),n=i(62199),a=i(59257),o=i(41682),r=i(58609),c=i(8988),l=i(94459);var d,h;n.logger.for("UserData"),(h=t.LevelOutcome||(t.LevelOutcome={})).Victory="Victory",h.Defeat="Defeat",(d=t.SaveGameTags||(t.SaveGameTags={})).Start="start",d.Autosave="auto",d.BestResult="best",t.defaultMetadata=()=>({userId:s.inject.random.id(o.ID_TYPE.User),stats:{perLevel:{},latestSession:a.BLANK_GAMEPLAY_STATS,total:a.BLANK_GAMEPLAY_STATS},rememberedChoices:{randomMapOptions:{seed:s.inject.random.integerBetween(1,1e5),shape:c.MapShape.Temperate,mode:c.MapMode.Classic,difficulty:c.MapDifficulty.Challenging,size:s.inject.device.uiVariant()===l.UiVariant.Compact?c.MapSize.Small:c.MapSize.Medium},latestLevelId:void 0,feedbackEmail:void 0,spectatingSpeed:r.SpectatingPlaybackSpeed.Normal},tutorialsCompleted:{},savedGamesById:{},feedbacks:[]})},78823:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ViewsManager=void 0;const s=i(29429),n=i(35670),a=i(88048),o=i(72005),r=i(45996),c=i(88316);t.ViewsManager=class{constructor(){this.allies=new s.AlliesView,this.attitude=new o.AttitudeView,this.fear=new n.FearView,this.factionInfluenceByRegion=new a.FactionInfluenceByRegionView,this.attritionByFaction=new r.AttritionByFactionView,this.hexProximityToRegion=new c.HexProximityToRegionView}}},21669:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AnalyticsReporter=void 0;const s=i(18995);t.AnalyticsReporter=class{constructor(e){this.activeProps={},e.on(s.SystemEvents.UserMetaDataLoaded,(e=>{this.setUserProperties({uid:e.userId,total_play_time_seconds:e.stats.total.playTimeSeconds})}))}setUserProperties(e){gtag("set","user_properties",e)}setConfig(e){this.activeProps={...this.activeProps,...e},gtagConfig(this.activeProps)}}},38735:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimingEvent=t.track=void 0;const s=i(71203),n=i(62199),a=i(84809);function o(e){return t=>{gtag("event",e,c(t))}}function r(e){return t=>{const i=a.LevelModel.for(t.level_id);gtag("event",e,c({level_status:i.getLevelStatus(),level_name:i.getTitle(a.LevelTitleStyle.IncludingCampaign),...t}))}}function c(e){const t=s.inject.navigator.currentScreen;return e||(e={}),{user_id:s.inject.userData.getUserId(),screen:t?.name,...l(t),...e}}function l(e){switch(e){case s.inject.screen.play:case s.inject.screen.victory:const e=a.LevelModel.for(s.inject.ui.playedLevelId());return{level_id:e.id,level_name:e.getTitle(a.LevelTitleStyle.IncludingCampaign),campaign_id:e.parentCampaign?.id,map_color_theme:s.inject.gameStateModel.map.theme};case s.inject.screen.levelDetail:const t=a.LevelModel.for(s.inject.ui.selectedLevelId());return{level_id:t.id,level_name:t.getTitle(a.LevelTitleStyle.IncludingCampaign),campaign_id:s.inject.ui.selectedCampaign()?.id};default:return{}}}n.logger.for("analytics"),t.track={timingComplete:o("timing_complete"),exception:o("exception"),pageView:o("page_view"),interaction:("interaction","type",e=>{gtag("event","interaction",c({type:e}))}),ui:{dismissFeedbackForm:o("dismiss_feedback_form")},playerFeedback:o("player_feedback"),levelStart:r("level_start"),levelVictory:r("level_victory"),levelDefeat:r("level_defeat"),levelResume:r("level_resume"),levelLeave:r("level_leave"),randomMapSelected:o("random_map_started"),randomMapRerolled:o("random_map_rerolled"),levelProgress:o("level_progress")},(t.TimingEvent||(t.TimingEvent={})).BootGame="boot_game"},68843:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.instrumentBrowserHistory=void 0;const s=i(71203),n=i(62199),a=i(18995),o=i(9095);n.logger.for("browserHistory"),t.instrumentBrowserHistory=function(){function e(){history.pushState(null,"",window.location.pathname)}s.inject.device.isMobile()&&(e(),window.addEventListener("popstate",(function(t){s.inject.navigator.currentScreen===s.inject.screen.title?confirm("Exit the game?")?history.back():e():(e(),s.inject.audio.playEffect(o.SoundEffects.ButtonDown),s.inject.events.trigger(a.UserActions.Escape()))}),!1))}},82334:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.generationPresets=t.setDatGUIVisible=void 0;const o=a(i(84376)),r=i(71203),c=i(18995),l=i(38918),d=i(96486),h=i(73508),u=i(73735),g=i(9095),p=i(5538);let m;t.setDatGUIVisible=function(e){e?(m||function(){m=new o.GUI({width:300});const e=m.addFolder("debug");e.add(r.inject.config.debug,"overlay"),e.add(r.inject.config.debug,"gameObjects"),e.add(r.inject.config.debug,"ai"),e.add(r.inject.config.debug,"objectPools"),e.add(r.inject.config.debug,"chunkBorders"),e.add(r.inject.config.debug,"tweenSpeedFactor",.1,2),e.add(r.inject.config,"screenTransitionDuration",0,3e3);const i=(0,d.throttle)(b,100,{trailing:!0}),s=(0,d.debounce)(b,300,{trailing:!0}),n=async()=>{w.generateRegions?await s():await i()};let a=!1;const y={mapGen:{preset:t.generationPresets[1].key,players:6,playerAdvantage:1,randomize:async function(){w.seed=r.inject.random.integerBetween(0,1e4),localStorage.setItem("seed",w.seed.toString()),f.updateDisplay(),await b()},"edit map":()=>{r.inject.navigator.currentScreen===r.inject.screen.mapEditor?r.inject.events.trigger(c.UserActions.ResumeGame()):r.inject.events.trigger(c.UserActions.EditMap())},breakpoints:!!r.inject.config.debug.breakpoints}},f=m.addFolder("map generation"),w={seed:Number(localStorage.getItem("seed"))||r.inject.random.integerBetween(0,1e4),...(0,d.cloneDeep)(t.generationPresets.find((e=>e.key===y.mapGen.preset)))};async function b(){try{if(a)return void r.inject.audio.playEffect(g.SoundEffects.Deny);a=!0,r.inject.events.trigger(c.UserActions.GoToMapGeneration()),await(0,l.generateMap)(w,(async()=>{await(0,p.sleep)(1)})),r.inject.scene.worldMap.syncState(),a=!1}catch(e){console.error(e)}}function v(){w.regions.factions=[{controller:h.FactionController.LocalUser,startingTilesMultiplier:y.mapGen.playerAdvantage},...(0,u.range)(2,y.mapGen.players).map((e=>({controller:h.FactionController.Ai})))],n()}m.add(y.mapGen,"edit map"),f.add(y.mapGen,"preset",t.generationPresets.map((e=>e.key))).onChange((function(){const e=t.generationPresets.find((e=>e.key===y.mapGen.preset));Object.assign(w.land,(0,d.cloneDeep)(e.land)),Object.assign(w.regions,(0,d.cloneDeep)(e.regions)),f.updateDisplay(),b()})),f.add(w,"seed").onChange(n),f.add(y.mapGen,"randomize"),f.add(w.land,"width",8,40,1).onChange(n),f.add(w.land,"height",8,40,1).onChange(n),f.add(w.land,"smoothness",1,10,.1).onChange(n),f.add(w.land,"water",0,1).onChange(n),f.add(w.land,"inlandForests",0,1).onChange(n),f.add(w.land,"coastalForests",0,1).onChange(n),f.add(w.land,"coastalForestsCohesion",0,1).onChange(n),f.add(w,"generateRegions").onChange(n),f.add(y.mapGen,"players",2,6,1).onChange(v),f.add(y.mapGen,"playerAdvantage",0,3,.1).onChange(v),f.add(w.regions,"minCellSize",1,15,1).onChange(n),f.add(w.regions,"maxCellSize",1,15,1).onChange(n),f.add(w.regions,"cellSeparation",0,5,1).onChange(n),f.add(w.regions,"coloration",0,1).onChange(n),f.add(w.regions,"clustering",0,1,.1).onChange(n),f.add(w,"spawnTowns").onChange(n),f.add(w.regions,"startingTiles",1,20,1).onChange(n),f.add(w.regions,"startingCoins",1,20,1).onChange(n),f.add(y.mapGen,"breakpoints").onChange((e=>{r.inject.config.debug.breakpoints=e?["mapgen"]:[]})),m.close()}(),m.show()):m?.hide()};const y={minCellSize:3,maxCellSize:6,cellSeparation:2,factions:[{controller:h.FactionController.LocalUser},{controller:h.FactionController.Ai},{controller:h.FactionController.Ai},{controller:h.FactionController.Ai},{controller:h.FactionController.Ai},{controller:h.FactionController.Ai}],cellCohesion:.5,coloration:1,startingTiles:5,startingCoins:10,clustering:0};t.generationPresets=[{key:"small",land:{width:10,height:14,smoothness:4.5,water:.25,inlandForests:.4,coastalForests:.2,coastalForestsCohesion:.6},generateRegions:!0,spawnTowns:!0,regions:{...y,minCellSize:4}},{key:"medium",land:{width:18,height:18,smoothness:7,water:.25,inlandForests:.4,coastalForests:.2,coastalForestsCohesion:.6},generateRegions:!1,spawnTowns:!0,regions:y},{key:"large",land:{width:24,height:24,smoothness:7,water:.25,inlandForests:.5,coastalForests:.2,coastalForestsCohesion:.6},generateRegions:!0,spawnTowns:!0,regions:y}]},41e3:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.savedGameExists=t.loadGame=void 0;const s=i(98697),n=i(68179);t.loadGame=function(e){const t=localStorage.getItem(n.SAVE_GAME_LOCAL_STORAGE_PREFIX+e);if(!t)throw new Error(`no data found for save "${e}"`);let i;try{i=JSON.parse(t)}catch(e){throw new Error("save data corrupted")}if(i.version!==s.CORE_GAMESTATE_SCHEMA_VERSION)throw new Error("save data not compatible with current version of the game");return i},t.savedGameExists=function(e){return!!localStorage.getItem(e)}},84809:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelModel=t.LevelTitleStyle=t.getUnlockedLevels=t.LevelCategory=t.LevelStatus=void 0;const s=i(71203),n=i(80266),a=i(73735);var o,r,c;function l(e){let t=0,i=!0;return e.levels.filter((e=>{const s=function(e){switch(e.unlockCondition?.type){case void 0:return!0;case"completed-previous":return i;case"max-incomplete":return t<=e.unlockCondition.maxIncomplete}}(e);return s?(t++,i=!0):i=!1,s})).map((e=>e.id))}!function(e){e.Locked="Locked",e.NotStarted="NotStarted",e.InProgress="InProgress",e.Replaying="Replaying",e.Completed="Completed",e.Defeated="Defeated"}(o=t.LevelStatus||(t.LevelStatus={})),function(e){e.CampaignLevel="campaign-level",e.QuickPlay="quick-play"}(r=t.LevelCategory||(t.LevelCategory={})),t.getUnlockedLevels=l,function(e){e.Full="full",e.IncludingCampaign="with-campaign"}(c=t.LevelTitleStyle||(t.LevelTitleStyle={}));class d{constructor(e){this.id=e}get userData(){return s.inject.userData.getLevelProgressById(this.id)}getTitle(e=c.Full){const t=s.inject.mapRegistry.getLevelInfoById(this.id),i=this.campaignContext?.indexInCampaign;if(void 0!==i){const s=e===c.IncludingCampaign?this.campaignContext?.campaign.name+" > ":"";return t?.name?`${s}Island ${i+1}: ${t.name}`:`${s}Island ${i+1}`}return t?.name?`${t.name}`:"Unknown Island"}get category(){return this.campaignContext?r.CampaignLevel:r.QuickPlay}get campaignContext(){return s.inject.mapRegistry.getLevelLocationInCampaign(this.id)}get parentCampaign(){return this.campaignContext?.campaign}getNextUnfinishedLevelId(){if(this.parentCampaign)return[...this.parentCampaign.levels.slice(this.campaignContext.indexInCampaign+1),...this.parentCampaign.levels.slice(0,this.campaignContext.indexInCampaign)].find((e=>{const t=d.for(e.id).getLevelStatus();return t===o.NotStarted||t===o.InProgress}))?.id}async getStartingState(){switch(this.category){case r.QuickPlay:return s.inject.userData.loadGame(this.id,n.SaveGameTags.Start);case r.CampaignLevel:return s.inject.mapRegistry.loadLevelById(this.id)}}async getCurrentState(){if(this.userData?.inProgress)try{return await s.inject.userData.loadGame(this.id,n.SaveGameTags.Autosave)}catch(e){return console.error(`Failed to load level "${this.id}" state from user data, falling back to start`,e),s.inject.userData.deleteSavedGame(this.id,n.SaveGameTags.Autosave),this.getCurrentState()}else{if(!this.userData?.bestResult)return this.getStartingState();try{return await s.inject.userData.loadGame(this.id,n.SaveGameTags.BestResult)}catch(e){return console.error(`Failed to load level "${this.id}" bets result state from user data, falling back to start`,e),this.getStartingState()}}}async getVictoryState(){if(this.userData)try{return s.inject.userData.loadGame(this.id,n.SaveGameTags.BestResult)}catch(e){return void console.error(`Failed to load victory state for level "${this.id}"`,e)}}getLevelStatus(){return this.campaignContext?.campaign,this.isUnlocked()?this.userData?.bestResult&&this.userData.bestResult.outcome===n.LevelOutcome.Victory&&this.userData?.inProgress?o.Replaying:this.userData?.inProgress?o.InProgress:this.userData?.bestResult?this.userData.bestResult.outcome===n.LevelOutcome.Victory?o.Completed:o.Defeated:o.NotStarted:o.Locked}isUnlocked(){const e=this.campaignContext,t=e?.levelData.unlockCondition;return!t||!e||l(e.campaign).includes(this.id)}static for(e){return(0,a.getOrCreate)(this._instances,e,(()=>new d(e)))}}t.LevelModel=d,d._instances={}},93808:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleMapRegistry=void 0;const s=i(73735),n=i(86201),a=i(62199).logger.for("MapRegistry");t.SimpleMapRegistry=class{constructor(e){this.dataSource=e,this.initialized=!1,this.campaigns=[],this.levelsById={}}initialize(){return this.initializedPromise||(this.initializedPromise=this.dataSource.fetchCampaignsAndLevels().then((e=>{a.info(`${e.campaigns.length} campaigns and ${e.levels.length} maps loaded`),this.campaigns=e.campaigns,this.levelsById=(0,s.dictionaryOf)(e.levels,"id"),this.initialized=!0,this.initializedPromise=void 0})).catch((e=>{a.error("Failed to load maps from registry",e)}))),this.initializedPromise}async loadLevelById(e){const t=this.levelsById[e]?.data;if(t)return(0,n.decodeGameState)(t)}_assertInitialized(){if(!this.initialized)throw new Error("Using mapRegistry synchronous api before initialization complete")}getCampaignById(e){return this._assertInitialized(),this.campaigns.find((t=>t.id===e))}getLevelInfoById(e){return this._assertInitialized(),this.levelsById[e]}getLevelLocationInCampaign(e){this._assertInitialized();for(let t of this.campaigns){const i=t.levels.findIndex((t=>t.id===e));if(-1!==i)return{campaign:t,indexInCampaign:i,levelData:t.levels[i]}}}}},31763:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MockMapRegistryDataSource=void 0;const s=i(71203);t.MockMapRegistryDataSource=class{constructor(e={campaigns:[],levels:[]}){this.mockData=e}setData(e){this.mockData=e,s.inject.mapRegistry.initialize()}async fetchCampaignsAndLevels(){return this.mockData}}},35702:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RestMapRegistryDataSource=void 0,t.RestMapRegistryDataSource=class{constructor(e){this.url=e}async fetchCampaignsAndLevels(){return fetch(this.url).then((e=>e.json()))}}},80880:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.blank=t.plains=t.avoidEdges=t.generateLandmass=void 0;const s=i(13225),n=i(71203),a=i(62199),o=i(73664),r=i(52163),c=i(73508),l=i(35171),d=a.logger.for("generateLandmass");function h(e,t){return Math.pow(1-2*((.5-e)*(.5-e)+(.5-t)*(.5-t)),2)}t.generateLandmass=async function e(t,i){const a=i.minSize??t.map.innerWidth*t.map.innerHeight*(1-i.water)*.33,u=i.smoothness,g=i.water,p=g+(1-g)*(1-i.inlandForests),m=n.inject.random,y=(e,i)=>(w.simplex2(e.x/u,e.y/u)+1)/2*h((e.x-.5)/t.map.innerWidth,(e.y-.5)/t.map.innerHeight)>=i;let f,w;d.info("Generating new random map"),f=i.seed??m.integerBetween(0,Number.MAX_SAFE_INTEGER),w=new s.Noise(f),n.inject.random.reset(f),t.useProjections(o.ProjectionPresets.coreEntities);const b=t.map.getInnerHexes().filter((e=>y(e,g))).components().getLargestGroup()??l.HexGroup.empty;if(d.info(`Base landmass generated (${b?.length} hexes, target is at least ${a})`),b.length<a)return d.warning("Not enough land, decreasing water level and trying again"),await e(t,{...i,minSize:a,water:.75*i.water});t.factions.byId(0)?.addNewRegion("land",b);const v=b.border(),S=b.without(v).filter((e=>y(e,p)));S.forEach((e=>{t.pawns.create({hex:e,type:c.PawnType.Forest})}));let P=b.without(S),T=Math.floor(P.length*i.coastalForests);console.log(`adding ${T} coastal forest tiles`);let x=n.inject.random.shuffle(v.filter(M).toArray());for(;T>0&&x.length;){let e=x.shift();if(r.assert.defined(e),M(e)&&(t.pawns.create({hex:e,type:c.PawnType.Forest}),P=P.without(e),T--,T>0&&n.inject.random.boolean(i.coastalForestsCohesion))){const t=e.neighbours(M);if(t.length){const e=n.inject.random.hex(t);x.unshift(e)}}}function M(e){return v.has(e)&&P.has(e)&&1===P.disjointedNeighbourGroupsOf(e).getGroups().length}},t.avoidEdges=h,t.plains=function(e){e.regions.clear(),e.factions.byId(0)?.addNewRegion("land",e.map.getInnerHexes())},t.blank=function(e){e.regions.clear()}},38918:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createBlankMap=t.generateMap=void 0;const s=i(80880),n=i(76270),a=i(73664),o=i(24011),r=i(71203),c=i(5538);async function l(e,t){const i=(0,o.createBlankGameState)({width:e,height:t,theme:"default"}),s=r.inject.gameStateModel;s.restore(i),s.useProjections(a.ProjectionPresets.coreEntities)}t.generateMap=async function(e,t=(async()=>{await(0,c.sleep)(1)})){await l(e.land.width,e.land.height),await(0,s.generateLandmass)(r.inject.gameStateModel,{...e.land,seed:e.seed}),e.generateRegions?await(0,n.generateRegions)(r.inject.gameStateModel,{seed:e.seed,...e.regions,startingTiles:e.spawnTowns?e.regions.startingTiles:0},t):r.inject.gameStateModel.activateAllProjections()},t.createBlankMap=l},76270:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateRegions=void 0;const s=i(52163),n=i(71203),a=i(62199),o=i(65314),r=i(67899),c=i(24011),l=i(6778);a.logger.for("mapgen"),t.generateRegions=async function(e,t,i){n.inject.random.reset(t.seed);const a=e.regions.all()[0];s.assert.defined(a,"map generator expects the first region in regions.all() to represent available landmass, but no regions were found"),a.size;let d=await(0,o.partitionLand)(e,a,t,i);await(0,r.colorizeRegions)(e,d,t,i),t.startingTiles>0&&await(0,l.spawnTowns)(e,d.filter((e=>e.faction?.id!==c.SpecialFaction.neutral)),t,i),e.regions.destroy(...e.regions.all().filter((e=>0===e.size))),e.factions.neutral.mergeAdjacentRegions()}},8988:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildGeneratorConfig=t.MapDifficulty=t.MapMode=t.MapShape=t.MapSize=void 0;const s=i(18380),n=i(16654);var a,o,r,c;(c=t.MapSize||(t.MapSize={})).Small="Small",c.Medium="Medium",c.Large="Large",(r=t.MapShape||(t.MapShape={})).Temperate="Temperate",r.Marshlands="Marshlands",r.Flat="Flat",(o=t.MapMode||(t.MapMode={})).Classic="Classic",o.Colonization="Colonization",o.Crowded="Crowded",(a=t.MapDifficulty||(t.MapDifficulty={})).Casual="Casual",a.Challenging="Challenging",a.Unfair="Unfair",t.buildGeneratorConfig=function(e){return{seed:e.seed,land:(0,n.buildLandGenerationConfig)(e),regions:(0,s.buildRegionsGenerationConfig)(e),generateRegions:!0,spawnTowns:!0}}},16654:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.flat=t.marshland=t.temperate=t.buildLandGenerationConfig=void 0;const s=i(71203),n=i(8988);function a(e){const t=s.inject.random,i={seed:e.seed,water:t.numberBetween(.2,.3),inlandForests:t.numberBetween(.2,.4),coastalForests:t.numberBetween(.01,.3),coastalForestsCohesion:t.numberBetween(.1,.3)};switch(e.size){case n.MapSize.Small:default:return{...i,width:10,height:t.integerBetween(16,18),smoothness:t.numberBetween(4,6)};case n.MapSize.Medium:return{...i,width:18,height:18,smoothness:t.numberBetween(5,7)};case n.MapSize.Large:return{...i,width:24,height:24,inlandForests:t.numberBetween(.3,.4),coastalForests:t.numberBetween(.1,.3),smoothness:t.numberBetween(6,8)}}}function o(e){const t=s.inject.random,i={seed:e.seed,water:.25,inlandForests:0,smoothness:1,coastalForests:t.numberBetween(.2,.4),coastalForestsCohesion:t.numberBetween(.1,.3)};switch(e.size){case n.MapSize.Small:default:return{...i,smoothness:.5,coastalForests:.2,width:10,height:t.integerBetween(16,18)};case n.MapSize.Medium:return{...i,width:18,height:18};case n.MapSize.Large:return{...i,width:24,height:24}}}function r(e){s.inject.random;const t={seed:e.seed,water:.1,inlandForests:0,smoothness:10,coastalForests:.2,coastalForestsCohesion:0};switch(e.size){case n.MapSize.Small:default:return{...t,width:9,height:15};case n.MapSize.Medium:return{...t,width:16,height:16};case n.MapSize.Large:return{...t,width:22,height:22}}}t.buildLandGenerationConfig=function(e){switch(s.inject.random.reset(e.seed),e.shape){case n.MapShape.Temperate:return a(e);case n.MapShape.Marshlands:return o(e);case n.MapShape.Flat:return r(e)}},t.temperate=a,t.marshland=o,t.flat=r},18380:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildRegionsGenerationConfig=void 0;const s=i(73508),n=i(71203),a=i(8988),o=i(73735);function r(e,t){return[{controller:s.FactionController.LocalUser,startingTilesMultiplier:t.playerAdvantage},...(0,o.range)(2,e).map((e=>({controller:s.FactionController.Ai,startingTilesMultiplier:t.aiAdvantage})))]}t.buildRegionsGenerationConfig=function(e){let t=1,i=1;switch(e.difficulty){case a.MapDifficulty.Casual:t=2;break;case a.MapDifficulty.Unfair:i=2}const s={...e,aiAdvantage:i,playerAdvantage:t};switch(e.mode){case a.MapMode.Classic:return function(e){const t={startingCoins:10,seed:e.seed,coloration:1,clustering:n.inject.random.numberBetween(0,.3),cellSeparation:2};let i;switch(e.size){case a.MapSize.Small:return i=n.inject.random.integerBetween(2,3),{...t,minCellSize:i,maxCellSize:4,startingTiles:i*n.inject.random.integerBetween(1,2),factions:r(n.inject.random.integerBetween(3,5),e),cellCohesion:n.inject.random.numberBetween(.5,1)};case a.MapSize.Medium:return i=n.inject.random.integerBetween(2,3),{...t,minCellSize:i,maxCellSize:n.inject.random.integerBetween(i+1,7),startingTiles:i*n.inject.random.integerBetween(2,3),factions:r(n.inject.random.integerBetween(4,6),e),cellCohesion:n.inject.random.numberBetween(.5,1)};case a.MapSize.Large:return i=n.inject.random.integerBetween(3,4),{...t,minCellSize:i,maxCellSize:n.inject.random.integerBetween(i+1,7),startingTiles:i*n.inject.random.integerBetween(3,4),factions:r(6,e),cellCohesion:n.inject.random.numberBetween(.5,1)}}}(s);case a.MapMode.Colonization:return function(e){const t={startingCoins:10,seed:e.seed,coloration:0,clustering:n.inject.random.numberBetween(0,.5),cellSeparation:2};let i;switch(e.size){case a.MapSize.Small:return i=n.inject.random.integerBetween(2,3),{...t,minCellSize:i,maxCellSize:4,startingTiles:i,factions:r(n.inject.random.integerBetween(3,5),e),cellCohesion:n.inject.random.numberBetween(.5,1)};case a.MapSize.Medium:return i=n.inject.random.integerBetween(2,3),{...t,minCellSize:i,maxCellSize:n.inject.random.integerBetween(i+1,7),startingTiles:i,factions:r(n.inject.random.integerBetween(4,6),e),cellCohesion:n.inject.random.numberBetween(.5,1)};case a.MapSize.Large:return i=n.inject.random.integerBetween(3,4),{...t,minCellSize:i,maxCellSize:n.inject.random.integerBetween(i+1,7),startingTiles:i,factions:r(6,e),cellCohesion:n.inject.random.numberBetween(.5,1)}}}(s);case a.MapMode.Crowded:return function(e){const t={startingCoins:10,seed:e.seed,coloration:1,clustering:0,cellSeparation:2};let i;switch(e.size){case a.MapSize.Small:return i=n.inject.random.integerBetween(3,5),{...t,minCellSize:2,maxCellSize:4,startingTiles:n.inject.random.integerBetween(30,50)/i,factions:r(i,e),cellCohesion:n.inject.random.numberBetween(.5,1)};case a.MapSize.Medium:return i=n.inject.random.integerBetween(4,6),{...t,minCellSize:n.inject.random.integerBetween(2,3),maxCellSize:5,startingTiles:n.inject.random.integerBetween(50,80)/i,factions:r(i,e),cellCohesion:n.inject.random.numberBetween(.5,1)};case a.MapSize.Large:return i=6,{...t,minCellSize:n.inject.random.integerBetween(2,3),maxCellSize:6,startingTiles:n.inject.random.integerBetween(80,120)/i,factions:r(6,e),cellCohesion:n.inject.random.numberBetween(.5,1)}}}(s)}}},67899:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.colorizeRegions=void 0;const s=i(73735),n=i(71203),a=i(35171),o=i(88048),r=i(14090),c=i(23803),l=i(5538),d=i(1951),h=i(74817),u=i(62199).logger.for("colorizeRegions");t.colorizeRegions=async function(e,t,i,g){let p={},m=new Set(n.inject.random.shuffle(t));const y=Math.ceil(a.HexGroup.union(t.map((e=>e.hexes))).length*i.coloration),f=Math.ceil(y/i.factions.length),w={},b={},v={},S=(0,h.getFactionsFromConfig)(e,i.factions);for(let e of S){const t=Math.round(i.factions[e.id-1].startingTilesMultiplier??1);w[e.id]=f*t,b[e.id]=0,v[e.id]=(0,d.max)(1,Math.round(t))}for(let e of t)p[e.id]=new Set(S);for(;m.size;){await g();const e=P(m);if(!e){u.warning(`Failed to assign any faction to the ${m.size} remaining region(s)`);break}const t=T(e);t&&(await M(`Region ${e.id} will belong to faction ${t.id}`,e.hexes),t.captureRegions(e),w[t.id]-=e.size,b[t.id]+=e.size,x()),m.delete(e)}function P(e){if(i.coloration>.7)return(0,s.findMin)(Array.from(e),(e=>p[e.id]?.size??1/0));{const t=e=>e.getNeighbours().filter((e=>!e.faction?.isNeutral())).length;return n.inject.random.boolean(i.clustering)?(0,s.findMax)(Array.from(e),t):(0,s.findMin)(Array.from(e),t)}}function T(e){const t=p[e.id];if(t?.size)return(0,s.findMax)(Array.from(t),(e=>w[e.id]))}function x(){for(let t of m){const s=S.filter((s=>!(s.getRegions().length>=v[s.id]&&w[s.id]<t.size/2)&&0===n.inject.views.factionInfluenceByRegion.get(e.state,{influencingFaction:s.id,targetRegion:t.id,maxDistance:i.cellSeparation,powerMeasurement:o.PowerMeasurement.RegionSize}).total));0===s.length?delete p[t.id]:p[t.id]=new Set(s)}}async function M(t,i){await n.inject.debugBreakpoint(`[mapgen:assignFactions] ${t}`,(()=>({hexes:i,debugLayer:{onChange:(0,r.signal)(),getGroups:()=>Array.from(m).map((e=>e.hexes)),getMap:()=>({getHexIds:()=>a.HexGroup.union(e.regions.all().map((e=>e.hexes))).toIdsArray(),get:t=>{const i=e.regions.byHex((0,c.getHex)(t));return Array.from(p[i.id]??[]).map((e=>e.id)).toString()}}),getDetail:e=>""}})))}u.debug(`Final stats:\n\nassigned hexes per faction:\b\n${(0,l.prettyPrintObject)(b,2)}\n`)}},74817:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getFactionsFromConfig=void 0,t.getFactionsFromConfig=function(e,t){return t.map(((t,i)=>e.factions.byId(i+1)))}},65314:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.partitionLand=void 0;const n=i(35171),a=s(i(43991)),o=i(52163),r=i(73735),c=i(71203),l=i(14090),d=i(23803),h=i(73664),u=i(24011);t.partitionLand=async function(e,t,i,s){let g=t.hexes.filter((t=>!e.warfare.isImpassable(t)));(0,o.assert)(g.length),g.length;const p=await async function(e,t,i){const s=new a.default;let h;for(e.forEach((e=>s.addToGroup(e.id,e))),await p("starting state");h=u(s.keys());){await i();const e=g(h);e||await p("about to fail - no valid neighbour",n.HexGroup.from(h.hexes)),o.assert.defined(e),await p("merging groups",n.HexGroup.union([n.HexGroup.from(e.hexes),n.HexGroup.from(h.hexes)])),s.addToGroup(e.key,...h.hexes)}return s;function u(e){let i,n=1/0;for(let a of e){const e=s.byKey(a);if(e.hexes.size>=t.minCellSize)continue;const o=s.getGroupsAdjacentTo(a),r=o.filter((i=>i.hexes.size+e.hexes.size<t.maxCellSize));if(0!==o.length){if(r.length<=1)return e;r.length>0&&r.length<n&&(i=e,n=r.length)}}return i}function g(e){let i=s.getGroupsAdjacentTo(e.key);return(0,r.findMax)(i,(i=>{let s=0;return e.hexes.size+i.hexes.size>t.maxCellSize&&(s=-100),i.hexes.size<t.minCellSize&&(s=1),i.borderSize+s}))}async function p(e,t){await c.inject.debugBreakpoint(`mapgen: ${e}`,(()=>({hexes:t,debugLayer:{onChange:(0,l.signal)(),getGroups:()=>s.getGroups(),getMap:()=>({getHexIds:()=>n.HexGroup.union(s.getGroups()).toIdsArray(),get:e=>s.getOwnerOf((0,d.getHex)(e))}),getDetail:e=>""}})))}}(g,i,s),m=[];e.useProjections(h.ProjectionPresets.coreEntities);const y=e.factions.byId(u.SpecialFaction.neutral);for(let e of p.getGroups())(0,o.assert)(e.length>0),await s(),m.push(y.addNewRegion(c.inject.random.townName(),e));return e.activateAllProjections(),m}},6778:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PickRegionsMemory=t.spawnTowns=void 0;const s=i(74817),n=i(96486),a=i(73735),o=i(1951),r=i(73508),c=i(71203),l=i(52163),d=i(62199),h=i(35171),u=i(21189),g=d.logger.for("spawnTowns");t.spawnTowns=async function(e,t,i,d){const u=(0,s.getFactionsFromConfig)(e,i.factions);for(let e of u){const t=i.factions[e.id-1].startingTilesMultiplier??1,s=await y(e,t);await c.inject.debugBreakpoint(`mapgen.spawnTowns: picked regions for ${e}`,(()=>({hexes:h.HexGroup.union(s.map((e=>e.hexes)))})));for(let t of c.inject.random.shuffle(s))await d(),m(t,1!==e.id)}function m(t,s){const n=(0,a.findMax)(t.hexes.members,(i=>function(t,i){return i.neighbours().map((i=>{let s=0;return e.warfare.isImpassable(i)&&s++,e.regions.byHex(i)===t&&s++,e.pawns.byHex(i,r.PawnType.Town)&&(s-=5),s-=e.warfare.getHexDefense(i),s})).reduce(o.sum,0)+c.inject.random.number()}(t,i)));l.assert.defined(n),e.pawns.create({hex:n,type:r.PawnType.Town});const d=s?(0,o.max)(0,i.startingCoins-t.budget.incomeFromHexes):i.startingCoins;e.pawns.create({hex:n,type:r.PawnType.Coins,count:d})}async function y(s,n=1){const a=new p;return await f({model:e,faction:s,tilesLeft:Math.floor(i.startingTiles*n),penalty:0,solutionSoFar:[],remainingRegions:c.inject.random.shuffle(t.filter((e=>e.faction===s))),memory:a,minRegionCount:Math.round(n)}),a.bestSolution.regions}async function f(e){const{model:t,faction:s,tilesLeft:a,solutionSoFar:r,remainingRegions:c,penalty:l,memory:h}=e;await d(),h.steps++;let u={regions:r,penalty:l+a*a+100*(0,o.max)(0,e.minRegionCount-r.length)};if(function(e,t){t.memory.cache.store(e.regions,e),e.penalty<t.memory.bestSolution.penalty&&(t.memory.bestSolution=e)}(u,e),!(a<=0||u.penalty>e.memory.bestSolution.penalty))for(let t of c){const s=a-t.size,o=[...r,t];h.cache.find(o)||(g.group(`given a pick of region ${t.id}`),await f({...e,tilesLeft:s,solutionSoFar:[...r,t],remainingRegions:(0,n.without)(c,t),penalty:l+(p=t,p.getNeighbours().filter((e=>e.isAlive())).length*(.5-i.clustering)*3)}),g.groupEnd())}var p}};class p{constructor(){this.cache=new u.ObjectCache((e=>e.map((e=>e.id)).sort().join(","))),this.steps=0,this.bestSolution={regions:[],penalty:1/0}}}t.PickRegionsMemory=p},20444:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AutoPrompts=void 0;const s=i(18995),n=i(71203),a=i(62199),o=i(44188);a.logger.for("AutoPrompts"),t.AutoPrompts=class{constructor(e){this.events=e,e.on(s.SystemEvents.ScreenActivated,(async e=>{const t=[n.inject.screen.play],i=n.inject.ui.selectedLevelId();if(i&&(e.screen===n.inject.screen.levelDetail||e.screen===n.inject.screen.victory)&&e.previousScreen&&t.includes(e.previousScreen)){const e=n.inject.userData.recallChoice("dismissedFeedbackForm")??0;if((0,o.differenceInDays)(Date.now(),e)<1)return;const t=n.inject.userData.getStats().perLevel[i]?.latestSession.playTimeSeconds;if(t<=60)return;if(await n.inject.userData.findFeedback({levelId:i}))return;n.inject.notifications.askForLevelFeedback(i)}}))}}},51897:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ErrorTracking=void 0;const o=a(i(87308)),r=i(87308),c=i(74530),l=i(71203),d=i(18995),h=i(62199),u=i(86201),g=i(41682),p=i(38735),m=h.logger.for("Telemetry"),y=new Set([d.SystemEvents.ScreenActivated].map((e=>e.eventName)));function f(){try{return(0,u.encodeGameState)(l.inject.gameStateModel.exportState())}catch(e){return`<failed to export: ${e.message}>`}}function w(e){let t="";try{t=(0,u.encodeGameState)(l.inject.gameStateModel.exportState())}catch(e){t=`<failed to export: ${e.message}>`}return e.extra={...e.extra,levelState:t},e}t.ErrorTracking={gameRunning:!1,hadErrors:!1,setup(e){window.onunhandledrejection=e=>{console.warn("window.onunhandledrejection",e),t.ErrorTracking.captureException(e),t.ErrorTracking.hadErrors=!0},window.onerror=function(e,i,s,n,a){i&&(t.ErrorTracking.captureException(a),t.ErrorTracking.hadErrors=!0)},o.init({enabled:e.reporting.sentry.enabled,dsn:e.reporting.sentry.dsn,integrations:[new c.BrowserTracing],environment:"production",release:"2.0.19-build-2727693328",beforeSend:w,tracesSampleRate:1})},logEvent(e){y.has(e.name)||o.addBreadcrumb({type:"default",level:r.Severity.Debug,category:e.category,message:e.name,data:e.payload})},captureException(e){if(!window.navigator.onLine)return void m.warning("Ignoring exception in offline mode",e);if(!this.gameRunning)return void function(e){let t=Math.floor(1e6*Math.random()).toString();setLoadingStatus(`Oh no! Something went really wrong and the game failed to load :(\n             \nerror-id: ${t}`),gtag("event","exception",{description:`Failed to boot: ${e}`,correlation_id:t,fatal:!0,during_boot:!0}),o.captureException(e,{tags:{correlationId:t}})}(e);const t=l.inject.random.id(g.ID_TYPE.Error);o.captureException(e,{extra:{levelState:f()},tags:{correlationId:t}}),p.track.exception({description:e.toString(),fatal:!0,correlation_id:t}),this.gameRunning&&l.inject.notifications.uncaughtError(t)},captureNonFatalError(e,t){window.navigator.onLine?(console.error(`[silent error: ${t}]`,e),o.captureException(e,{extra:{levelState:f()},tags:{backgroundErrorContext:t}}),p.track.exception({description:e.toString(),fatal:!1})):m.warning("Ignoring exception in offline mode",e)},initializeContext(){l.inject.events.on(d.SystemEvents.UserMetaDataLoaded,(e=>{o.setUser({id:e.userId})})),o.setTags({scale:l.inject.ui.scale().toString(),logicalDpr:l.inject.device.dpr,realDpr:window.devicePixelRatio??1,uiVariant:l.inject.device.uiVariant().toString()}),l.inject.events.on(d.SystemEvents.ScreenActivated,(({screen:e,previousScreen:t})=>{o.addBreadcrumb({type:"navigation",data:{from:t?.name,to:e?.name}})})),l.inject.ui.selectedLevelId.watch((e=>{o.setTag("levelId",e)}))}}},91058:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Reporter=t.ReportingEvents=t.reportingEvent=void 0;const s=i(70780),n=i(52163),a=i(86578),o=i(72196),r=i(20444),c=i(38735);function l(e){return(0,s.createEventFactory)(s.EventCategory.GameState,e)}t.reportingEvent=l,t.ReportingEvents={SubmitFeedbackForm:l("SUBMIT_FEEDBACK_FORM")},t.Reporter=class{constructor(e,i){this.slackClient=new a.SlackClient(i.reporting.slack.feedbackHook),this.autoPrompts=new r.AutoPrompts(e),e.on(t.ReportingEvents.SubmitFeedbackForm,(e=>{if(e.comment&&i.reporting.slack.enabled){const t=(0,o.reportFeedback)(e);this.slackClient.sendMessage(t)}c.track.playerFeedback({mood:e.mood,level_id:e.levelId})}))}on(e,t){return(0,n.assert)(void 0===this.actionHandlers[e.eventName],`a handler is already assigned to event type ${e.eventName}!`),this.actionHandlers[e.eventName]=t,this}}},72196:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.reportFeedback=void 0;const s=i(84809),n=i(28218),a=i(93122),o=i(71203),r=i(44188),c=i(86201);function l(e){return(0,a.prefixEachLineWith)("> ",`${t=e.mood,void 0===t?"":u[t]??`<${t}>`} ${e.comment}\n-- ${e.email||"user <"+o.inject.userData.getUserId()+">"}`);var t}function d(e){return(e.campaignContext?`*${e.campaignContext.campaign.name} progress:* ${t=e.campaignContext,t.campaign.levels.map(((e,t)=>{const i=s.LevelModel.for(e.id);return`[${t+1}${p[i.getLevelStatus()]}]`})).join(" ")}\n`:"")+`*${function(e){const t=e.campaignContext;return t?`Level ${t.indexInCampaign+1}`:`Custom level \`${e.id}\`*`}(e)} progress:* ${p[e.getLevelStatus()]} ${function(e){const t=e.userData;switch(e.getLevelStatus()){case s.LevelStatus.Replaying:return`replaying (turn ${t?.inProgress?.turnNumber??"?"}), previous victory in ${t?.bestResult?.turnNumber??"?"} turns`;case s.LevelStatus.NotStarted:return"not started";case s.LevelStatus.InProgress:return`turn ${t?.inProgress?.turnNumber??"?"}`;case s.LevelStatus.Completed:return`won in ${t?.bestResult?.turnNumber??"?"} turns`;case s.LevelStatus.Locked:return"locked";case s.LevelStatus.Defeated:return`defeated in ${t?.bestResult?.turnNumber??"?"} turns`}}(e)}`;var t}function h(e){const t=e.campaignContext;return t?`*level ${t.indexInCampaign+1}* of *${t.campaign.name}*`:`*custom level \`${e.id}\`*`}t.reportFeedback=function(e){if(e.levelId){const t=s.LevelModel.for(e.levelId);return{blocks:[n.SlackMessage.section.text(`:incoming_envelope: Feedback on ${h(t)}:`),n.SlackMessage.section.text(l(e),d(t)),n.SlackMessage.section.text(n.SlackMessage.codeBlock(m(),g(t)))]}}return{blocks:[n.SlackMessage.section.text(`:incoming_envelope: Feedback from *${o.inject.navigator.currentScreen?.name??"<unknown screen>"}*:`),n.SlackMessage.section.text(l(e)),n.SlackMessage.section.text(n.SlackMessage.codeBlock(m()))]}};const u=[void 0,":rage:",":angry:",":neutral_face:",":slightly_smiling_face:",":smile:"];function g(e){const t=o.inject.userData.getStats().perLevel[e.id];return`level:\n  id: ${e.id} (campaign_id: ${e.campaignContext?.campaign.id})\n  status: ${e.getLevelStatus()}\n  session_stats: ${t?y(t.latestSession):"N/A"}\n  total_stats: ${t?y(t.total):"N/A"}\n  turn: ${e.userData?.inProgress?.turnNumber??e.userData?.bestResult?.turnNumber}\n  state: ${(0,c.encodeGameState)(o.inject.gameStateModel.exportState())}\n`}const p={[s.LevelStatus.Completed]:":trophy:",[s.LevelStatus.Replaying]:":trophy::crossed_swords:",[s.LevelStatus.InProgress]:":crossed_swords:",[s.LevelStatus.Defeated]:":headstone:",[s.LevelStatus.Locked]:":lock:",[s.LevelStatus.NotStarted]:":white_square:"};function m(){const e=o.inject.userData.getStats();return`game:\n  build: 2.0.19-build-2727693328 (environment=production)\n  url: ${window.location.toString()}\n  screen: ${o.inject.navigator.currentScreen?.name??"?"}\nuser:\n  id: ${o.inject.userData.getUserId()}\n  timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}\n  total_playtime: ${(0,r.secondsToHours)(e.total.playTimeSeconds).toFixed(0)}h\n  latest_session_playtime: ${(0,r.secondsToMinutes)(e.latestSession.playTimeSeconds).toFixed(0)}m\ndevice:\n  user_agent: ${window.navigator.userAgent}\n  current_fps: ${o.inject.game.loop.actualFps.toFixed()}\n  viewport: ${o.inject.device.screenWidth}x${o.inject.device.screenHeight} (dpr=${o.inject.device.dpr} uiVariant=${o.inject.device.uiVariant()}]\n  os: ${o.inject.device.os()})\n  touch: ${o.inject.game.device.input.touch}`}function y(e){return`${e.playTimeSeconds}s, ${e.turns} turns, ${e.clicks} clicks, ${e.undoCount} undos`}},68179:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.saveGame=t.SAVE_GAME_LOCAL_STORAGE_PREFIX=void 0;const s=i(62199),n=i(69893),a=i(71203),o=i(98697),r=i(73664);t.SAVE_GAME_LOCAL_STORAGE_PREFIX=`konkr.savedGame.v${o.CORE_GAMESTATE_SCHEMA_VERSION}.`,t.saveGame=function(e,i){let o=a.inject.gameStateModel.stateEngine;i&&(o=new r.GameStateModel(i).stateEngine);const c=JSON.stringify((0,n.compressGameState)(o));localStorage.setItem(t.SAVE_GAME_LOCAL_STORAGE_PREFIX+e,c),s.logger.for("saveGame").info(`Current games state saved into local storage as "${e}"`)}},86578:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SlackClient=void 0;const s=i(71203);t.SlackClient=class{constructor(e){this.webhookUrl=e}async sendMessage(e){await fetch(s.inject.config.reporting.slack.feedbackHook,{method:"POST",body:JSON.stringify(e)}).then((e=>{if(!e.ok)throw new Error(`Failed to send slack message - hook responded with status ${e.status}`)}))}}},28218:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SlackMessage=void 0,t.SlackMessage={codeBlock:(...e)=>`\`\`\`\n${e.join("\n")}\n\`\`\``,section:{text:(...e)=>({type:"section",text:{type:"mrkdwn",text:e.join("\n")}})}}},59753:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.THEMES=void 0,t.THEMES={default:{colors:[29184,14393427,5939244,14382416,8347466,6052185]},grounded:{colors:[29184,5939244,9019436,8421376,7101779,5066061]},highContrast:{colors:[13385760,28876,29184,14532608,12303291,13582480]}}},52754:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameStateDebugLayer=void 0;const s=i(14090),n=i(71203),a=i(19764);t.GameStateDebugLayer=class{constructor(e){this.adapter=e,this.onChange=(0,s.signal)(),this.listener=(()=>this.onChange.fire()).bind(this)}getGroups(){return this.adapter.getGroups?.(n.inject.gameStateModel.state)||[]}activate(){n.inject.gameStateModel.stateEngine.watchAll(this.listener)}deactivate(){n.inject.gameStateModel.stateEngine.stopWatching(this.listener)}getMap(){const e=n.inject.gameStateModel.state,t=new a.CustomHexGroupValuation(void 0);for(const i of this.adapter.getHexes(e).members)t.set(i.id,this.adapter.getValue(e,i.id));return t}getDetail(e){return this.adapter.getDetail(n.inject.gameStateModel.state,e.id)}getArrows(){if(!this.adapter.getParents&&!this.adapter.getChildren)return[];let e=[];const t=n.inject.gameStateModel.state,i=this.adapter.getHexes(t);for(const s of i.members)this.adapter.getParents&&this.adapter.getParents(t,s.id)?.forEach((t=>{e.push([t,s.id])})),this.adapter.getChildren&&this.adapter.getChildren(t,s.id)?.forEach((t=>{e.push([s.id,t])}));return e}}},94632:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gettersFromDataSet=t.factionDataSetAdapter=t.regionDataSetAdapter=t.dataSetAdapter=void 0;const s=i(85044),n=i(35171),a=i(13446),o=i(10997),r=i(57775);function c(e,t){const i=t.getValue||(t=>e.entryToString(t)),n=t.getDetail||(t=>e.entryToDebugString(t));return{getValue(t,n){const a=(0,s.selectFromState)(t,e,n);return a&&i(a)},getDetail(t,i){const a=(0,s.selectFromState)(t,e,i);return a&&n(a)}}}t.dataSetAdapter=function(e,t={}){const i=t.arrowDataRetriever||((t,i)=>(0,s.selectFromState)(t,e,i));return{getHexes:t=>n.HexGroup.fromIds(e.getEntryIds(t)),getGroups:t.getGroups,...c(e,t),...(0,a.autoArrowsGenerator)(i)}},t.regionDataSetAdapter=function(e,t={}){return(0,o.regionBasedAdapter)(c(e,t))},t.factionDataSetAdapter=function(e,t={}){return(0,r.factionBasedAdapter)(c(e,t))},t.gettersFromDataSet=c},57775:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.factionBasedAdapter=void 0;const s=i(35171),n=i(16115),a=i(87832),o=i(46299);t.factionBasedAdapter=function(e){return{getHexes:e=>s.HexGroup.union(n.Regions.model(e).all().filter((e=>e.isAlive())).map((t=>s.HexGroup.fromIds(a.Economy.getTownHexesByRegion(e,t.id).toArray())))),getValue(t,i){const s=o.Factions.getByHex(t,i);if(void 0!==s)return e.getValue(t,s)},getDetail(t,i){const s=o.Factions.getByHex(t,i);if(void 0!==s)return e.getDetail(t,s)}}}},1522:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hexBasedAdapter=void 0;const s=i(35171),n=i(16115),a=i(13446);t.hexBasedAdapter=function(e){return{getHexes:e=>s.HexGroup.union(n.Regions.model(e).all().map((e=>e.hexes))),getValue:(t,i)=>e.getValue(t,i),getDetail:(t,i)=>e.getDetail(t,i),getGroups:e.getGroups,...(0,a.autoArrowsGenerator)(((t,i)=>e.getDetail(t,i)))}}},10997:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.regionBasedAdapter=void 0;const s=i(35171),n=i(16115),a=i(87832),o=i(1947);t.regionBasedAdapter=function(e){return{getHexes:e=>s.HexGroup.union(n.Regions.model(e).all().map((t=>s.HexGroup.fromIds(a.Economy.getTownHexesByRegion(e,t.id).concat(o.Bandits.getCampsByRegion(e,t.id)).toArray())))),getValue(t,i){const s=n.Regions.getByHex(t,i);if(void 0!==s)return e.getValue(t,s)},getDetail(t,i){const s=n.Regions.getByHex(t,i);if(void 0!==s)return e.getDetail(t,s)}}}},90016:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldDebugLayersManager=void 0;const s=i(96486),n=i(71203),a=i(14090),o=i(19764);i(62199).logger.for("DebugLayersManager");class r{constructor(){this.layers={blank:r.blankLayer},this.activeLayer=r.blankLayer,this.activeLayerName=void 0,this.onActiveLayerUpdated=(0,a.signal)()}register(e,t){this.layers[e]&&(this.layers[e].deactivate&&this.layers[e].deactivate(),this.layers[e].onChange.unsubscribeAll()),this.layers[e]=t,t.onChange((()=>this._layerChanged(t)))}registerAndActivate(e,t){this.register(e,t),this.activate(e)}_layerChanged(e){e===this.activeLayer&&this.onActiveLayerUpdated.fire(this.activeLayer)}get(e){return this.layers[e]}activate(e,t){if(this.activeLayer&&this.activeLayer.deactivate&&this.activeLayer.deactivate(),e){if(!this.layers[e]){if(!t)throw new Error(`No debug layer found for name ${e}`);this.register(e,t())}this.activeLayerName=e,this.activeLayer=this.layers[e],this.activeLayer.activate&&this.activeLayer.activate(),n.inject.debugData.set("debugLayer",e)}else this.activeLayer=r.blankLayer,this.activeLayerName=void 0,n.inject.debugData.clear("debugLayer");this.onActiveLayerUpdated.fire(this.activeLayer)}}t.WorldDebugLayersManager=r,r.blankLayer={onChange:(0,a.signal)(),activate:s.noop,deactivate:s.noop,getMap:()=>new o.CustomHexGroupValuation(void 0),getDetail:()=>{}}},13446:(e,t)=>{"use strict";function i(e){return"object"==typeof e?e.id:e}Object.defineProperty(t,"__esModule",{value:!0}),t.autoArrowsGenerator=void 0,t.autoArrowsGenerator=function(e){return{getParents(t,s){const n=e(t,s);if("object"==typeof n)return n.parent?[i(n.parent)]:n.parents?n.parents.map(i):void 0},getChildren(t,s){const n=e(t,s);if("object"==typeof n)return n.child?[i(n.parent)]:n.children?n.children.map(i):void 0}}}},20680:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createDiplomacyDebugLayer=void 0;const s=i(52754),n=i(10997),a=i(95077),o=i(46299),r=i(71203),c=i(73508);t.createDiplomacyDebugLayer=function(){return new s.GameStateDebugLayer((0,n.regionBasedAdapter)({getDetail(e,t){const i=o.Factions.getByRegion(e,t);if(!i)return;a.AI.getFactionAttrition(e,i);const s=o.Factions.model(e).all().filter((e=>e.controller!==c.FactionController.None&&e.id!==i)).map((t=>{const s=t.id,n=r.inject.views.fear.getComponents(e,{fromFactionId:i,towardsFactionId:s});return{id:s,theirApprovalOfMe:a.AI.getFactionApproval(e,s,i),myApprovalOfThem:a.AI.getFactionApproval(e,i,s),theirAttitudeToMe:a.AI.getFactionAttitude(e,s,i),myAttitudeToThem:a.AI.getFactionAttitude(e,i,s),theirFearOfMe:r.inject.views.fear.getComponents(e,{fromFactionId:i,towardsFactionId:s}),myFearOfThem:n,theirTotalAttrition:a.AI.getFactionAttrition(e,s),theirAttritionInflictedByMe:a.AI.getFactionAttrition(e,s,i),myAttritionInflictedByThem:a.AI.getFactionAttrition(e,i,s)}}));return`[Faction ${i}]\nWho I like:\n${s.sort(((e,t)=>t.myApprovalOfThem-e.myApprovalOfThem)).map((e=>` - ${e.myAttitudeToThem} (${e.myApprovalOfThem}) towards F${e.id} (they are ${e.theirAttitudeToMe} (${e.theirApprovalOfMe}))`)).join("\n")}\nWho I fear:\n${s.sort(((e,t)=>t.myFearOfThem.fear.totalFear-e.myFearOfThem.fear.totalFear)).map((e=>` - F${e.id}: ${e.myFearOfThem.fear.totalFear} (power ${e.myFearOfThem.rivalFactionPower} vs my ${e.myFearOfThem.myPower})\n     their alliance (${e.myFearOfThem.rivalAllianceMembers.join(",")}) domination ${e.myFearOfThem.rivalAlliancePower}/${e.myFearOfThem.totalPower} (compared to my ${e.myFearOfThem.myAlliancePower})`)).join("\n")}\nWho has been fighting me:\n${s.sort(((e,t)=>t.myAttritionInflictedByThem-e.myAttritionInflictedByThem)).filter((e=>e.myAttritionInflictedByThem>0)).map((e=>` - F${e.id} inflicted ${e.myAttritionInflictedByThem} attrition`)).join("\n")}\nWho have I been fighting:\n${s.sort(((e,t)=>t.theirAttritionInflictedByMe-e.theirAttritionInflictedByMe)).filter((e=>e.myAttritionInflictedByThem>0)).map((e=>` - F${e.id} received ${e.theirAttritionInflictedByMe} attrition`)).join("\n")}`},getValue(e,t){const i=o.Factions.getByRegion(e,t);if(i)return i}}))}},11274:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldNews=t.NewsEvents=void 0;const s=i(70780),n=i(18995),a=i(46299),o=i(16115),r=i(92940),c=i(9332),l=i(35171),d=i(73508),h=i(71203),u=i(23803),g=i(34594),p=i(62199),m=i(33376),y=i(52163);var f;(f=t.NewsEvents||(t.NewsEvents={})).Rebellion="rebellion",f.HexLost="hexLost",f.UnitTurnedBandit="unitTurnedBandit",p.logger.for("WorldNews"),t.WorldNews=class{constructor(){this.feed=(0,s.createTypedEventHandler)(),this.newsByRegion={},this.newBanditCamps=[],this.feed.on(n.GameEvents.FactionEconomyUpdated,(e=>{if(!a.Factions.model(e.stateAfter).byId(e.factionId)?.isLocalPlayer())return;const t=o.Regions.model(e.stateAfter);for(let i of e.regionReports){const e=t.byId(i.regionId);if(!e?.isAlive())continue;const s=[];i.worldUpdates.forEach((e=>{e.type===m.UpdateType.PawnMoved&&e.created?.pawnType===d.PawnType.Camp?this.newBanditCamps.push({pawnId:e.pawnId,regionId:i.regionId}):e.type===m.UpdateType.PawnReplaced&&e.newType===d.PawnType.Camp&&this.newBanditCamps.push({pawnId:e.newPawnId,regionId:i.regionId}),e.type===m.UpdateType.PawnReplaced&&e.newType===d.PawnType.Bandit&&s.push(e.newPawnId)})),s.length&&this.updateRegionReport(i.regionId,{name:e.name,unitsTurnedBandits:s})}})),this.feed.on(n.GameEvents.HexCaptured,(e=>{if(!e.victimFactionId||!a.Factions.model(e.stateAfter).byId(e.victimFactionId)?.isLocalPlayer()||!o.Regions.model(e.stateBefore).byId(e.victimRegionId)?.isAlive())return;const t=e.worldUpdates.find((e=>e.type===m.UpdateType.PawnMoved)).hexCaptured;y.assert.defined(t);const i=c.Pawns.model(e.stateAfter),s=l.HexGroup.union(t.killedRegions.map((t=>o.Regions.model(e.stateAfter).byId(t)?.hexes??l.HexGroup.empty))),n=i.select({hexes:s,traits:[r.PawnTraits.Unit]}),h=i.select({hexes:s,type:[d.PawnType.Castle]});i.lockToState(e.stateBefore);const u=o.Regions.model(e.stateBefore).byId(e.victimRegionId),g=[];e.defeatedUnit&&g.push(i.byId(e.defeatedUnit?.pawnId));const p=g.filter((e=>e.hasTrait(r.PawnTraits.Unit))),f=g.filter((e=>e.type===d.PawnType.Town)),w=g.filter((e=>e.type===d.PawnType.Castle)),b=t.splitOffRegions.map((t=>o.Regions.model(e.stateAfter).byId(t))).filter((e=>e?.isAlive()));this.updateRegionReport(e.victimRegionId,{name:u?.name||"?",hexesLost:[e.capturedHexId],unitsLost:p.map((e=>e.hex.id)),townsLost:f.map((e=>e.hex.id)),castlesLost:w.map((e=>e.hex.id)),hexesCutOff:s.map((e=>e.id)),unitsCutOff:n.map((e=>e.hex.id)),castlesCutOff:h.map((e=>e.hex.id)),regionsSplitOff:b.map((e=>e.id))}),f.length>0&&!o.Regions.model(e.stateAfter).byId(e.victimRegionId)?.isAlive()&&this.updateRegionReport(e.victimRegionId,{died:!0})}))}updateRegionReport(e,t){const i=this.newsByRegion[e]??{name:"",hexesCutOff:[],unitsCutOff:[],castlesCutOff:[],hexesLost:[],townsLost:[],unitsLost:[],castlesLost:[],unitsTurnedBandits:[],regionsSplitOff:[],died:!1};this.newsByRegion[e]=i,["hexesLost","hexesCutOff","unitsLost","unitsCutOff","castlesLost","castlesCutOff","townsLost","unitsTurnedBandits","regionsSplitOff"].forEach((e=>{i[e].push(...t[e]??[])})),i.name=t.name??i.name,i.died=t.died??i.died}handle(e){this.feed.handle(e)}display(){const e=h.inject.scene.worldMap.pawnSymbols;this.newBanditCamps.forEach((t=>()=>{e.add(t.pawnId,g.PawnSymbolType.Alert,"Nearby bandits have set up a camp here!")})),Object.entries(this.newsByRegion).forEach((([t,i])=>{const s=[];if(i.hexesLost.forEach((t=>{const i=h.inject.gameStateModel.pawns.findOne({hexes:(0,u.getHex)(t),traits:[r.PawnTraits.Unit]});i&&e.add(i.id,g.PawnSymbolType.Alert,"They took our land!")})),i.unitsTurnedBandits.forEach((t=>e.add(t,g.PawnSymbolType.Alert,"Unit was not payed and turned into bandit!"))),i.died&&s.push({title:`We have lost ${i.name}!`,description:"The last remaining town in this province was razed by the enemy. The province descended into chaos and we no longer control it!"}),i.townsLost.length&&!i.died){const e=i.townsLost.length>1;e&&i.townsLost.length,s.push({title:`Town${e?"s":""} razed in ${i.name}!`,description:e?`We have lost ${i.townsLost.length} towns in the province!`:"One of the towns in the province was razed by the enemy!"})}if(i.castlesLost.length&&!i.died){const e=i.castlesLost.length>1;s.push({title:`Castle${e?"s":""} lost in ${i.name}!`,description:(e?i.castlesLost.length+" castles were":"A castle was")+" destroyed by the enemy!"})}if(i.unitsCutOff.length>0&&!i.died){const e=i.unitsCutOff.length>1;s.push({title:`Unit${e?"s":""} cut off from ${i.name}!`,description:`${e?i.unitsCutOff.length+" units were":"A unit was"} cut off from the province and became ${e?"bandits":"a bandit"}!`})}if(i.castlesCutOff.length>0&&!i.died){const e=i.castlesCutOff.length>1;s.push({title:`Castle${e?"s":""} cut off from ${i.name}!`,description:`${e?i.unitsCutOff.length+" castles":"A castle"} was cut off from the province and became ${e?"bandit camps":"a bandit camp"}!`})}if(i.unitsTurnedBandits.length&&!i.died&&s.push({title:`Rebellion in ${i.name}!`,description:`We did not have enough gold to pay our army in ${i.name} this turn. The treacherous soldiers in the province turned to banditry!`}),i.regionsSplitOff.length){const e=i.regionsSplitOff.map((e=>h.inject.gameStateModel.regions.byId(e))).filter((e=>e?.exists));e.length>1?s.push({title:`${i.name} fractured!`,description:`Parts of ${i.name} became disconnected and formed new provinces known as ${e.map((e=>e.name)).join(", ")}.`}):s.push({title:`${i.name} fractured!`,description:`Part of ${i.name} became disconnected and formed a new province known as ${e[0]?.name}.`})}if(s.length>1){const e=s.map((e=>` • ${e.description}`)).join("\n");h.inject.notifications.regionDisaster(`Dire news from ${i.name}!`,`${e}`,Number(t))}else 1===s.length&&h.inject.notifications.regionDisaster(s[0].title,s[0].description,Number(t))}))}clear(){this.newsByRegion={},this.newBanditCamps=[]}}},32036:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugData=void 0;const s=i(71203);t.DebugData=class{constructor(){this.items={}}set(e,t){this.items[e]=t}get(e){return this.items[e]}clear(e){delete this.items[e]}getText(){const e=s.inject.config.debug.dataFilter;return Object.entries(this.items).filter((([t])=>!e||t.includes(e))).map((([e,t])=>`${e}: ${t}`)).join("\n")}}},94459:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceInfo=t.scaleDown=t.getLogicalDpr=t.DEFAULT_CONTENT_PADDING=t.MAX_CONTENT_WIDTH=t.COMPACT_UI_MAX_WIDTH=t.UiVariant=void 0;const s=i(65641),n=i(71203),a=i(1951);var o;function r(){let e=c(window.devicePixelRatio||1);for(;e*window.innerWidth>2560&&e*window.innerHeight>1e3;)e/=2;return e}function c(e){return e>=4?e/4:e>=3?e/3:e>=2?e/2:e}!function(e){e.Large="large",e.Compact="small"}(o=t.UiVariant||(t.UiVariant={})),t.COMPACT_UI_MAX_WIDTH=740,t.MAX_CONTENT_WIDTH=1200,t.DEFAULT_CONTENT_PADDING=30,t.getLogicalDpr=r,t.scaleDown=c,t.DeviceInfo=class{constructor(e){this.game=e,this.uiVariant=(0,s.watchable)(o.Large),this.dpr=r(),this.hasBrowserChrome=window.innerHeight!==window.screen.height,this.supports={touch:e.device.input.touch},e.scale.on("resize",(()=>setTimeout((()=>this.updateScreenSize()),100)),this),this.updateScreenSize()}get screenWidth(){return n.inject.game.scale.width}get screenHeight(){return n.inject.game.scale.height}get contentLeft(){return this.screenWidth<=t.MAX_CONTENT_WIDTH?0:Math.trunc((this.screenWidth-t.MAX_CONTENT_WIDTH)/2)}get contentRight(){return this.screenWidth<=t.MAX_CONTENT_WIDTH?this.screenWidth:this.contentLeft+t.MAX_CONTENT_WIDTH}get contentWidth(){return Math.min(this.screenWidth,t.MAX_CONTENT_WIDTH)}isMobile(){return!this.game.device.os.desktop}isUsingTouch(){return n.inject.game.input.activePointer.wasTouch}os(){return`${window.navigator.platform??"?"} (${Object.entries(n.inject.game.device.os).filter((([e,t])=>!0===t)).map((([e,t])=>e)).join(", ")})`}updateScreenSize(){(0,a.min)(this.game.scale.displaySize.width,this.game.scale.displaySize.height)>=t.COMPACT_UI_MAX_WIDTH?this.uiVariant.set(o.Large):this.uiVariant.set(o.Compact)}}},24909:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HtmlDocs=t.UI=t.ModalsManager=void 0;const s=i(84612),n=i(76350),a=i(26151),o=i(28337),r=i(67381),c=i(30132),l=i(97947),d=i(65953);t.ModalsManager=class{constructor(e){this.game=e}getModalWindowScene(){return this.game.scene.getScene(s.Scenes.ModalWindow)}show(e,t,i=(()=>{})){this.game.scene.isActive(s.Scenes.ModalWindow)||this.game.scene.run(s.Scenes.ModalWindow),this.getModalWindowScene().pushModal(e,{...t,onClose:i})}close(){this.getModalWindowScene().closeModal()}},t.UI={restartGameDialog:new n.RestartGameDialog,abandonLevelDialog:new c.AbandonLevelDialog,exportMap:new a.ExportMapDialog,loadGame:new o.LoadGameDialog,editMapJSONDialog:new l.EditMapJSONDialog,htmlDialog:new r.HtmlDialog,oopsMessage:new d.OopsDialog},t.HtmlDocs={howToPlay:{url:"/how-to-play",title:"How to play"},about:{url:"/about",title:"About Konkr.io"}}},41421:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getHexUnderCursor=t.watchableHexUnderCursor=void 0;const s=i(71203),n=i(26792),a=i(65641),o=i(23803);function r(e,t){let i,a,r=(e.input.activePointer.worldX+n.HEX_WIDTH/2)/n.HEX_WIDTH,c=e.input.activePointer.worldY/n.HEX_INNER_HEIGHT,l=r%1,d=c%1;s.inject.debugData,Math.floor(c)%2?l<.5?d<(1-2*l)/3?(i=Math.floor(r),a=Math.floor(c)-1/3):(i=Math.floor(r)+.5,a=Math.floor(c)+2/3):d<1/3-2*(1-l)/3?(i=Math.floor(r)+1,a=Math.floor(c)-1/3):(i=Math.floor(r)+.5,a=Math.floor(c)+2/3):l<.5?d<2*l/3?(i=Math.floor(r)+.5,a=Math.floor(c)-1/3):(i=Math.floor(r),a=Math.floor(c)+2/3):d<2/3-2*l/3?(i=Math.floor(r)+.5,a=Math.floor(c)-1/3):(i=Math.floor(r)+1,a=Math.floor(c)+2/3),i-=1,a-=2/3;let h=Math.round(a),u=Math.round(i+h%2/2);if(t.map.isWithinBounds({r:h,c:u}))return(0,o.getHex)({r:h,c:u})}t.watchableHexUnderCursor=function(){const e=(0,a.watchable)(void 0);return e.update=t=>{const i=s.inject.gameStateModel;t.input.activePointer.updateWorldPoint(t.cameras.main);const n=r(t,i);e.set(n)},e.clear=()=>{e.set(void 0)},e},t.getHexUnderCursor=r},52361:()=>{},94616:()=>{}},i={};function s(e){var n=i[e];if(void 0!==n)return n.exports;var a=i[e]={id:e,loaded:!1,exports:{}};return t[e].call(a.exports,a,a.exports,s),a.loaded=!0,a.exports}s.m=t,s.c=i,e=[],s.O=(t,i,n,a)=>{if(!i){var o=1/0;for(d=0;d<e.length;d++){for(var[i,n,a]=e[d],r=!0,c=0;c<i.length;c++)(!1&a||o>=a)&&Object.keys(s.O).every((e=>s.O[e](i[c])))?i.splice(c--,1):(r=!1,a<o&&(o=a));if(r){e.splice(d--,1);var l=n();void 0!==l&&(t=l)}}return t}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[i,n,a]},s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e={179:0};s.O.j=t=>0===e[t];var t=(t,i)=>{var n,a,[o,r,c]=i,l=0;if(o.some((t=>0!==e[t]))){for(n in r)s.o(r,n)&&(s.m[n]=r[n]);if(c)var d=c(s)}for(t&&t(i);l<o.length;l++)a=o[l],s.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return s.O(d)},i=self.webpackChunkkonkr=self.webpackChunkkonkr||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var n=s.O(void 0,[216],(()=>s(s.s=66024)));n=s.O(n)})();
(()=>{var e,t={8:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.convertWorldXYToCameraXY=a,t.convertWorldRectToCameraRect=function(e,t){const{x:i,y:s}=a(e,t.x,t.y),{x:n,y:o}=a(e,t.right,t.bottom);return new Phaser.Geom.Rectangle(i,s,n-i,o-s)},t.convertHexRectToWorldRect=function(e){let t=e.width*o.HEX_WIDTH,i=(e.height-1)*o.HEX_INNER_HEIGHT+o.HEX_HEIGHT,n=e.x*o.HEX_WIDTH,a=e.y*o.HEX_INNER_HEIGHT;return new s(n,a,t,i)},t.getObjectCameraRect=function(e,t=0){if(!e)return n.INVALID_PLACEMENT;const i={x:0,y:0},s={x:0,y:0},o=e.getWorldTransformMatrix();o.transformPoint(0,0,i),o.transformPoint(e.displayWidth??e.width,e.displayHeight??e.height,s);const a=e.scene.cameras.main;i.x+=a.x-a.scrollX,s.x+=a.x-a.scrollX,i.y+=a.y-a.scrollY,s.y+=a.y-a.scrollY;const{x:r,y:l}="object"==typeof t?t:{x:t,y:t};return{x:i.x-r,y:i.y-l,width:s.x-i.x+2*r,height:s.y-i.y+2*l}};var s=Phaser.Geom.Rectangle;const n=i(51384),o=i(87936);function a(e,t,i){const s=e.getWorldPoint(0,0);return{x:(t-s.x)*e.zoom,y:(i-s.y)*e.zoom}}},444:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapPointersTracker=void 0;const s=i(93413),n=i(62277),o=i(45664),a=i(91622),r=i(54825),l=i(36868),c=i(56824);c.logger.for("TwoPointersTracker");class d extends s.TwoPointersTracker{constructor(e){super(e),this.dragOriginHexId=void 0}hasInteraction(e){const t=this.buildPointerEventContext(e);return this.scene.mode.isHexInteractive(void 0===t.hexId?void 0:(0,o.getHex)(t.hexId))}onStartInteraction(e){const t=this.buildPointerEventContext(e);this.dragOriginHexId=t.hexId,c.events.trigger(l.WorldMapEvents.StartInteraction(this.buildPointerEventContext(e)))}onCompleteInteraction(e){const t=this.buildPointerEventContext(e);this.dragOriginHexId=void 0,a.inject.ui.defaultPointerAction.set((()=>{c.events.trigger(l.WorldMapEvents.CompleteInteraction(t))}))}onAbortInteraction(e){c.events.trigger(l.WorldMapEvents.AbortInteraction(this.buildPointerEventContext(e)))}onStartDrag(e){const t=this.buildPointerEventContext(e);this.dragOriginHexId&&(t.hexId=this.dragOriginHexId,this.dragOriginHexId=void 0),c.events.trigger(l.WorldMapEvents.StartDrag(t))}onEndDrag(e){this.dragOriginHexId=void 0,c.events.trigger(l.WorldMapEvents.EndDrag(this.buildPointerEventContext(e)))}onStartPinch(e){r.app.scene.worldMap.cameraController.stopDragScroll(),r.app.scene.worldMap.cameraController.zoomController.startPinchZoom(),c.events.trigger(l.WorldMapEvents.StartPinch(this.buildPointerEventContext(e)))}onEndPinch(e){r.app.scene.worldMap.cameraController.zoomController.stopPinchZoom(),c.events.trigger(l.WorldMapEvents.EndPinch(this.buildPointerEventContext(e)))}buildPointerEventContext(e){const t=(0,n.getHexUnderCursor)(this.scene,a.inject.gameStateModel);let i=0;return(e.middleButtonDown()||e.middleButtonReleased())&&(i|=l.PointerEventFlags.MiddleButton),(e.rightButtonDown()||e.rightButtonReleased())&&(i|=l.PointerEventFlags.RightButton),e.event.shiftKey&&(i|=l.PointerEventFlags.Shift),e.event.altKey&&(i|=l.PointerEventFlags.Alt),e.event.ctrlKey&&(i|=l.PointerEventFlags.Ctrl),e.wasTouch&&(i|=l.PointerEventFlags.Touch),{hexId:t?.id,flags:i}}}t.WorldMapPointersTracker=d},551:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RewindMode=void 0;const s=i(41569),n=i(39420),o=i(91622),a=i(54825),r=i(36868),l=i(56824),c=i(2543),d=i(45084),h=i(81434),u=i(79465),p=i(30484),g=i(43046),m=i(79694),y=i(98963),f=i(75742),w=l.logger.for("RewindMode");class v extends s.BaseMode{constructor(e){super(e),this.name="Rewind",this.observe.event(r.UserActions.RewindForward,(()=>{this.isOnTurnEnd()?this.moveCursor((e=>{e.move(g.Move.stepForward,g.Move.seekForwardTag("turnStart",1))})):this.moveCursor((e=>{e.move(g.Move.seekForward((e=>1!==e.activeFaction)),g.Move.stepBack),e.move(g.Move.seekForward((e=>1!==e.activeFaction)))?e.move(g.Move.stepBack):e.goToLastStep()}))})),this.observe.event(r.UserActions.RewindBack,(()=>{this.isOnTurnStart()?this.moveCursor((e=>{0!==e.currentIndex&&e.move(g.Move.stepBack,g.Move.seekBackTag("turnStart",1),g.Move.seekForward((e=>1!==e.activeFaction)),g.Move.stepBack)})):this.moveCursor((e=>{0!==e.currentIndex&&e.move(g.Move.seekBackTag("turnStart",1))}))})),this.observe.event(r.UserActions.RewindStepForward,(()=>{this.moveCursor((e=>{e.move(g.Move.stepForward,g.Move.seekForwardFaction(1))}))})),this.observe.event(r.UserActions.RewindStepBack,(()=>{this.moveCursor((e=>{e.move(g.Move.stepBack,g.Move.seekBackFaction(1))}))}))}isOnTurnStart(){return this.scene.cursor.currentStep.tags.has("turnStart")&&1===this.scene.cursor.currentStep.activeFaction}isOnTurnEnd(){const e=this.scene.cursor.nextStep;return!e||(0,n.isEvent)(e.play,r.Plays.EndTurn)}moveCursor(e){e(this.scene.cursor),a.app.scene.worldMap.syncState(this.scene.cursor.currentState,p.OverlayModes.spectating()),this.refreshPlayUI()}activate(){super.activate(),a.app.scene.play.gameEventQueue.clear(),this.scene.worldMapScene.pawns.clearAllJumping(),a.app.worldNews.clear(),a.app.scene.worldMap.overlays.set(this.scene.cursor.currentState,p.OverlayModes.spectating()),a.app.scene.worldMap.endSession(),this.scene.uiScene.updateState({layout:{name:"rewind",label:"?",guidelineLabel:"?",canGoForward:!1,canGoBack:!1,lives:0,burningLife:!1}}),this.moveCursor((e=>{1!==d.CurrentPhase.getFaction(e.currentState)?e.move(g.Move.seekBackFaction(1)):e.move(g.Move.seekBackTag("turnStart",1),g.Move.stepBack,g.Move.seekBackFaction(1))})),this.refreshPlayUI()}deactivate(){super.deactivate()}refreshPlayUI(){const e=(0,u.getLivesAdjustmentAfterRewind)(o.inject.currentGameState,this.scene.cursor.currentState);let t="refill"===e?f.DEFAULT_LIVES_PER_LEVEL:o.inject.levelSession.remainingLives;a.app.scene.playUI.updateRewindLayout({label:this.getLabel(),canGoBack:this.canGoBack(),canGoForward:this.canGoForward(),lives:t,guidelineLabel:this.getGuidelineLabel(),burningLife:"burn-one"===e}),a.app.scene.playUI.updatePowerBalanceFromGameState(this.scene.cursor.currentState)}canGoBack(){return this.scene.cursor.isValidMove(g.Move.stepBack,g.Move.seekBackFaction(1))}canGoForward(){return this.scene.cursor.isValidMove(g.Move.stepForward,g.Move.seekForwardFaction(1))}getLabel(){const e=this.scene.cursor.currentState,t=d.CurrentPhase.getTurnNumber(e),i=o.inject.gameStateModel.currentPhase.turnNumber;if(!this.scene.cursor.nextStep)return"Present";const s=i===t?"this turn":`turn ${t}`;return this.isOnTurnStart()?`Start of ${s}`:this.isOnTurnEnd()?`End of ${s}`:(0,c.capitalize)(s)}isHexInteractive(e){return!0}handleStartDrag(e){a.app.scene.worldMap.cameraController.startDragScroll()}handleEndDrag(e){a.app.scene.worldMap.cameraController.stopDragScroll()}handleAbort(){if(o.inject.levelSession.outcome)return console.warn("Cannot abort rewind after game over"),void a.app.audio.playEffect(y.SoundEffects.Deny);this.moveCursor((e=>e.goToLastStep())),this.scene.setMode(new m.PlayMode(this.scene))}canEndTurn(){return!0}handleStartInteraction(e,t){const i=a.app.getCurrentGameStateModel().regions;e&&i.byHex(e)?.faction?.isLocalPlayer()?(l.events.trigger(r.UserActions.ConfirmRewind()),this.scene.mode.handleStartInteraction(e,t)):a.app.scene.worldMap.cameraController.startDragScroll()}handleNewHexUnderCursor(e){const t=e&&this.getMovablePawnAtHex(e);t?(this.scene.worldMapScene.pawns.setHangingPawn(t.id),this.scene.input.setDefaultCursor("pointer")):this.scene.worldMapScene.pawns.clearHangingPawn()}getMovablePawnAtHex(e){const t=this.scene.cursor.currentState;return h.Pawns.model(t).byHex(e).find((e=>d.CurrentPhase.isMovable(t,e.id)))}async doHandleEvent(e){w.warning(`Ignoring event ${e.name} in RewindMode`)}getGuidelineLabel(){return this.scene.cursor.hasNext()?"select your province to confirm rewind":"select your province to cancel rewind"}}t.RewindMode=v},897:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.whenDirty=function(e,t){let i=!0,n=!1;const o=(0,s.signal)(),a=()=>{i&&(i=!1,e()),t&&t()};return a.enableEagerUpdates=()=>{n=!0},a.isDirty=()=>i,a.makeDirty=()=>{i||o.fire(),i=!0,n&&a()},a.force=()=>{i=!0,a()},a.onBecameDirty=o,a},t.hasPreUpdate=function(e){return e.preUpdate};const s=i(18957)},1055:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AIModel=void 0;const s=i(90952),n=i(94399),o=i(20026),a=i(70712);class r extends n.BaseModel{getHexDepth(e){return(0,o.selectFromState)(this.state,s.GameState.ai.hexDepth,e.id)||0}getHexImportance(e){return(0,o.selectFromState)(this.state,s.GameState.ai.hexImportance,e.id)?.value||0}getHexAge(e){return a.AI.getHexAge(this.state,e.id)}}t.AIModel=r},1132:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ParallelCinematic=t.BaseCinematic=t.BlankCinematic=void 0,t.BlankCinematic={async play(){},playAfter:e=>new Promise((t=>setTimeout(t,e)))};class i{constructor(e){this.scene=e}play(){return new Promise((e=>{this.execute(e)}))}playAfter(e,t){return new Promise((t=>{this.scene.time.addEvent({delay:e,callback:()=>this.execute(t)})}))}}t.BaseCinematic=i,t.ParallelCinematic=class extends i{constructor(e){super(e),this.subCinematics=[]}add(e){this.subCinematics.push(e)}execute(e){Promise.all(this.subCinematics.map((e=>e.play()))).then(e)}}},1187:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameObjectList=void 0,t.GameObjectList=class{constructor(e){this.factory=e,this.gameObjects=[],this.model=[]}get(){return this.gameObjects.filter((e=>e.visible))}getModel(){return this.model}find(e){const t=this.model.findIndex(e);if(-1!==t)return this._getOrCreateObjectByIndex(t)}set(e){this.model=e,e.forEach(((e,t)=>{this._getOrCreateObjectByIndex(t)}));for(let t=e.length;t<this.gameObjects.length;t++)this.gameObjects[t].setVisible(!1)}get length(){return this.model.length}_getOrCreateObjectByIndex(e){if(this.gameObjects[e]){const t=this.gameObjects[e];return t.setVisible(!0),this.factory(this.model[e],e,t),t}{const t=this.factory(this.model[e],e);return this.gameObjects[e]=t,t}}}},1326:(e,t)=>{"use strict";function i(e,t){for(var i=0,s=e.length;i<s;){var n=i+s>>>1;e[n]<t?i=n+1:s=n}return i}function s(e,t){let i,s=-1/0;for(let n of e){const e=t(n);e>s&&(i=n,s=e)}return i}Object.defineProperty(t,"__esModule",{value:!0}),t.replaceArrayItem=function(e,t,i){if(t<0||t>=e.length)throw new Error(`index out of bounds (array length: ${e.length}, index: ${t})`);return[...e.slice(0,t),i,...e.slice(t+1)]},t.insertBetween=function(e,t){return e.reduce(((e,i,s,n)=>(e.push(i),s<n.length-1&&e.push(t),e)),[])},t.stripDuplicatesFrom=function(e){return Array.from(new Set(e))},t.cloneArrayWithout=function(e,...t){return e.filter((e=>!t.includes(e)))},t.cloneArrayWithoutItemAt=function(e,t){return[...e.slice(0,t),...e.slice(t+1)]},t.pushIntoArrayByKey=function(e,t,...i){void 0===e[t]&&(e[t]=[]),e[t].push(...i)},t.removeFromArrayInPlace=function(e,t){return-1===e.indexOf(t)||e.splice(e.indexOf(t),1),e},t.dictionaryOf=function(e,t){const i={};for(const s of e)i[s[t]]=s;return i},t.mergeArrays=function(...e){return[].concat(...e)},t.omit=function(e,...t){return Object.keys(e).reduce(((i,s)=>(t.includes(s)||(i[s]=e[s]),i)),{})},t.pick=function(e,...t){return Object.keys(e).reduce(((i,s)=>(t.includes(s)&&(i[s]=e[s]),i)),{})},t.mapDictionary=function(e,t){return Object.assign({},...Object.keys(e).map((i=>({[i]:t(e[i],i)}))))},t.filterDictionary=function(e,t){const i={};for(const s in e)t(e[s],s)&&(i[s]=e[s]);return i},t.filterDictionaryInPlace=function(e,t){for(const i in e)t(e[i],i)||delete e[i];return e},t.isObject=function(e){return e&&"object"==typeof e&&!Array.isArray(e)},t.getOrCreate=function(e,t,i){if(void 0!==e[t])return e[t];const s=i();return e[t]=s,s},t.insertIntoSortedArray=function(e,t){const s=i(e,t);return e.splice(s,0,t),e},t.getInsertionIndexInSortedArray=i,t.ascendingSortFn=function(e,t){return e-t},t.range=function(e,t){return t<e||isNaN(e)||isNaN(t)?[]:Array(t-e+1).fill(0).map(((t,i)=>e+i))},t.findMax=s,t.findMin=function(e,t){return s(e,(e=>-t(e)))},t.inverseLookup=function(e,t){return Object.entries(e).find((([e,i])=>i===t))?.[0]}},1397:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StationaryUnits=void 0,t.createStationaryUnitsDebugLayer=function(){return new c.GameStateDebugLayer((0,d.hexBasedAdapter)({getValue(e,t){const i=r.Warfare.getOccupyingPawn(e,(0,h.getHex)(t));if(i)return o.inject.ui.stationaryUnits.isStationary(i.id)?`${u.GLYPH.defense}`:void 0},getDetail:(e,t)=>""}))};const s=i(36868),n=i(56824),o=i(91622),a=i(43046),r=i(78635),l=i(70712),c=i(76439),d=i(12543),h=i(45664),u=i(19506);n.logger.for("StationaryUnits"),t.StationaryUnits=class{constructor(){this.stationaryUnits=new Set,n.events.on(s.GameStateEvents.HexCaptured,(e=>{o.inject.gameStateModel.currentPhase.isLocalPlayerTurn()&&(this.stationaryUnits.delete(e.capturingPawnId),e.defeatedUnit&&this.stationaryUnits.delete(e.defeatedUnit.pawnId))})),n.events.on(s.GameStateEvents.PawnMoved,(e=>{o.inject.gameStateModel.currentPhase.isLocalPlayerTurn()&&(e.eradicatedPest?this.stationaryUnits.delete(e.pawnId):this.stationaryUnits.add(e.pawnId))})),n.events.on(s.GameStateEvents.NewGameState,(()=>{this.initialize()}))}isStationary(e){return this.stationaryUnits.has(e)}initialize(){this.stationaryUnits.clear();const e=o.inject.gameStateController.history.getCursor(),t=o.inject.gameStateModel.factions.localPlayer;if(!e.move(a.Move.seekBackTag("turnStart",t.id),a.Move.stepBack,a.Move.seekBackTag("turnStart",t.id)))return;const i=e.currentState;for(const e of t.getRegions())for(const t of o.inject.gameStateModel.warfare.getUnitsByRegion(e)){if(l.AI.getHexAge(t.state,t.hex.id)<=1)continue;const e=r.Warfare.getOccupyingPawn(i,t.hex);e&&e.id!==t.id||this.stationaryUnits.add(t.id)}}toDebugString(){return Array.from(this.stationaryUnits).join(", ")}}},1409:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TorchCircle=t.TorchesManager=void 0;const s=i(56824),n=i(24598),o=i(90824),a=i(20693),r=i(19618),l=i(81434);s.logger.for("coins"),t.TorchesManager=class{constructor(e,t,i){this.scene=e,this.pools=t,this.tiles=i,this.circles={}}syncWithModel(e){const t=a.HexGroup.union(e.factions.alive().filter((e=>e.persona.race===o.Race.Undead)).flatMap((e=>e.getLiveRegions().map((e=>e.getTownHexes())))));for(const e in this.circles)t.hasId(Number(e))||this.destroyTorchesAt(Number(e));for(const i of t)this.getOrCreateTorchCircle(i).setValue(e.pawns.getCount(i,n.PawnType.Mana))}isTorchHex(e,t){return r.Factions.model(e).byHex(t)?.persona.race===o.Race.Undead&&l.Pawns.model(e).presentAtHex(t,n.PawnType.Town)}getOrCreateTorchCircle(e){return this.circles[e.id]||(this.circles[e.id]=new d(this.pools,this.tiles.getByHex(e.id))),this.circles[e.id]}addMana(e,t){if(this.isTorchHex(e,t)){const e=this.getOrCreateTorchCircle(t);e.setValue(e.currentValue+1)}}syncHex(e,t){this.isTorchHex(e,t)?this.getOrCreateTorchCircle(t).setValue(l.Pawns.model(e).getCount(t,n.PawnType.Mana)):this.destroyTorchesAt(t.id)}destroyTorchesAt(e){const t=this.circles[e];t&&(t.destroy(),delete this.circles[e])}};const c=[{x:-8,y:10},{x:-13,y:2},{x:-8,y:-8},{x:8,y:-8},{x:13,y:2},{x:8,y:10}];class d{constructor(e,t){this.pool=e,this.tile=t,this.currentValue=0,this.torches=c.map((({x:t,y:i})=>{const s=e.getTorch();return this.tile.addObject(s,t,i),s}))}destroy(){this.torches.forEach((e=>this.pool.free(e))),this.torches=[],this.vortex&&(this.pool.free(this.vortex),this.vortex=void 0)}setValue(e){this.currentValue=e,e>6?this.torches.forEach((e=>e.setFrame("pawns/torch-blue"))):this.torches.forEach(((t,i)=>{t.setFrame(i>=e||6===e?"pawns/torch-empty":"pawns/torch-red")})),6===e?this.vortex||(this.vortex=this.pool.getVortex(),this.tile.addObject(this.vortex,-this.vortex.width/4,-20,100)):this.vortex&&(this.tile.removeObject(this.vortex),this.pool.free(this.vortex),this.vortex=void 0)}}t.TorchCircle=d},1554:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.myLibraryTransitionIn=async function(){const e=s.config.screenTransitionDuration,t=n.app.scene.myLibraryUI;await new Promise((i=>{const s=t.bounds.width;t.cameras.main.setPosition(-s,0),t.tweens.add({targets:t.cameras.main,x:`+=${s}`,alpha:{from:0,to:1},duration:e,ease:"Sine.easeOut",onComplete:()=>i()})}))};const s=i(56824),n=i(54825)},1565:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NotificationToast=t.NotificationCategory=t.NotificationScope=t.NotificationStyle=t.NotificationType=void 0;var s=Phaser.GameObjects.BitmapText;const n=i(96137),o=i(86545),a=i(2426),r=i(14767),l=i(7782),c=i(11466),d=i(54825),h=i(9292);var u,p,g;!function(e){e.Info="info",e.Success="success",e.Alert="alert"}(u||(t.NotificationType=u={})),t.NotificationStyle={Default:{palette:{shape:n.Colors.glassUi_old.shape,shadow:n.Colors.glassUi_old.shapeShadow,timeoutBar:n.Colors.darker(n.Colors.glassUi_old.shapeShadow),highlight:n.Colors.glassUi_old.shapeLightAccent}},Alert:{palette:{shape:n.Colors.glassUi_old.alert.main,shadow:n.Colors.glassUi_old.alert.shadow,timeoutBar:n.Colors.darker(n.Colors.glassUi_old.alert.shadow),highlight:n.Colors.glassUi_old.alert.lightAccent}},Success:{palette:{shape:n.Colors.glassUi_old.success.main,shadow:n.Colors.glassUi_old.success.shadow,timeoutBar:n.Colors.darker(n.Colors.glassUi_old.success.shadow),highlight:n.Colors.glassUi_old.success.lightAccent}}},function(e){e.Global="global",e.Screen="screen",e.Level="level"}(p||(t.NotificationScope=p={})),function(e){e.FeedbackForm="feedback-form",e.InvalidUserActionHint="invalid-user-action-hint",e.SurrenderOffer="surrender-offer",e.UpdatePrompt="update-prompt",e.Error="error"}(g||(t.NotificationCategory=g={}));class m extends o.AutoHeightResponsiveContainer{constructor(e){super(e.scene),this.parent=e,this.shadowRect=new a.RoundedRect(this.scene,{x:0,y:0,radius:this.parent.layout.radius}),this.backgroundRect=new a.RoundedRect(this.scene,{x:1,y:1,radius:this.parent.layout.radius}),this.timerBar=new a.RoundedRect(this.scene,{x:0,y:0,radius:0}),this.cancelTimeoutOnHover=!1,this.clickable=!1,this.closeButton=(0,r.miniCloseButton)(this.scene),this.offset=l.Control.propOf(this,"y",{duration:this.parent.layout.tweenDuration,ease:"Sine.easeInOut"}),this.add([this.shadowRect,this.backgroundRect,this.timerBar]),this.closeButton.onClicked((async()=>{this.onBeforeDismissed&&!await this.onBeforeDismissed()||(e.closeToast(this),this.onDismissed?.())})),this.setInteractiveAuto(),this.on("pointerdown",(async()=>{this.clickable&&(this.onBeforeDismissed&&!await this.onBeforeDismissed()||(this.onClicked?this.onClicked():e.closeToast(this)))})),this.on("pointerover",(()=>{this.clickable&&this.backgroundRect.setFillStyle(this.style.palette.highlight,.7),this.cancelTimeoutOnHover&&this.timeoutTween&&(this.timeoutTween.stop(),this.timeoutTween=void 0,this.timerBar.setVisible(!1)),this.timeoutTween?.isActive()&&this.timeoutTween.pause()})),this.on("pointerout",(()=>{this.backgroundRect.setFillStyle(this.style.palette.shape,.7),this.timeoutTween?.isActive()&&this.timeoutTween.resume()}))}handleChildResize(e){const t=this.height;this.preUpdate.makeDirty(),this.updateSize();const i=this.height;this.parent.handleToastResized(this,i-t)}setProps(e){this.clearContent(),this.icon=e.icon,this.content=e.content,this.scope=e.scope,this.category=e.category,this.style=e.style,e.timeout&&(this.timeoutTween=this.scene.tweens.add({targets:this.timerBar,scaleX:{from:1,to:0},duration:e.timeout,onComplete:()=>{this.parent.closeToast(this)}})),this.clickable=e.clickable??!1,this.cancelTimeoutOnHover=e.cancelTimeoutOnHover??!1,this.onBeforeDismissed=e.onBeforeDismissed,this.onDismissed=e.onDismissed,this.onClicked=e.onClicked,this.timerBar.setFillStyle(e.style.palette.timeoutBar,1),this.backgroundRect.setFillStyle(e.style.palette.shape,.7),this.shadowRect.setFillStyle(e.style.palette.shadow,.7),this.closeButton.setTint(e.style.palette.shadow),this.add([this.icon,this.content,this.closeButton])}clearContent(){this.icon&&(this.icon.destroy(),this.remove(this.icon)),this.content&&(this.remove(this.content),this.content.destroy(),this.content=void 0),this.timeoutTween&&(this.timeoutTween.stop(),this.timeoutTween=void 0)}updateLayout(){const e=this.parent.layout;if(this.content){const t=this.width-3*e.padding-e.spaceForIcon-this.closeButton.width;this.content instanceof s?this.content.setMaxWidth(t):this.content.width=t}this.preUpdateChildren(),d.app.device.uiVariant()===c.UiVariant.Compact?(this.backgroundRect.radius=0,this.shadowRect.radius=0,this.backgroundRect.setPosition(0,1),this.backgroundRect.setSize(this.width,this.height-7),this.shadowRect.setSize(this.width,this.height),this.timerBar.radius=0):(this.backgroundRect.radius=e.radius,this.shadowRect.radius=e.radius,this.backgroundRect.setPosition(1,1),this.backgroundRect.setSize(this.width-2,this.height-7),this.shadowRect.setSize(this.width,this.height),this.timerBar.radius={tl:0,tr:0,bl:6,br:6}),this.timerBar.setPosition(0,this.height-6),this.timerBar.setSize(this.width,6),this.icon.setOrigin(.5,.5).setPosition(e.padding+e.spaceForIcon/2,(0,h.pickSmaller)(this.height/2,e.padding+this.icon.height/2)),this.content?.setPosition(e.padding+e.spaceForIcon+e.padding,e.padding),this.closeButton.setPosition(this.width-e.padding/2-this.closeButton.width,(0,h.pickSmaller)(this.height/2-this.closeButton.height/2,e.padding/2)),this.updateSize()}calculateHeight(){return 2*this.parent.layout.padding+(this.content?.height??0)}destroy(){this.clearContent(),super.destroy()}}t.NotificationToast=m},1574:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BuyingPawnMode=void 0;const s=i(36868),n=i(79694),o=i(41569),a=i(56824),r=i(78635),l=i(64244),c=i(98963),d=i(24598),h=i(97849),u=i(91622),p=i(54825),g=i(50105),m=i(12933),y=i(30484),f=i(38021),w=a.logger.for("BuyingPawnMode");class v extends o.BaseMode{constructor(e,t){super(e),this.buyingPawn=t,this.bought=!1,this.name="BuyingPawn",this.isDraggingPawn=!0,this.justInitiated=!0,this.buyAnother=!1,setTimeout((()=>this.justInitiated=!1),200)}activate(){p.app.scene.worldMap.cameraController.stopDragScroll(),p.app.scene.worldMap.overlays.set(u.inject.currentGameState,y.OverlayModes.playing({holdingPawnType:this.buyingPawn,selectedRegionId:p.app.screen.play.selectedRegion?.id})),p.app.tooltips.close(),a.events.trigger(s.UiEvents.PawnPickedUpFromShop(this.buyingPawn))}deactivate(){!this.bought&&this.scene.uiScene.pawnHolder.heldPawnImage&&this.scene.uiScene.returnPawnToShop(this.buyingPawn),p.app.scene.worldMap.overlays.hexMarkers.clearHoveredHex()}isHexInteractive(e){return!0}canDropPawn(e){return!0}canReturnPawnAtHex(e){const t=p.app.screen.play.selectedRegion,i=u.inject.gameStateModel.regions.byHex(e);return i?.id===t?.id&&!!u.inject.gameStateModel.pawns.byHex(e,d.PawnType.Town)}handleCompleteInteraction(e,t){this.bought?w.warning("ignoring duplicate completeInteraction call - already bought a pawn in this instance of BuyingPawnMode "):this.isDraggingPawn&&this.justInitiated?this.isDraggingPawn=!1:(this.buyAnother=!!(t&s.PointerEventFlags.Shift&&this.canAffordAnother()),this.tryDropPawn(e)||(p.app.scene.worldMap.cameraController.stopDragScroll(),this.isDraggingPawn&&a.events.trigger(s.UserActions.ReturnHeldPawn())))}handleStartInteraction(e){this.isDraggingPawn||p.app.scene.worldMap.cameraController.startDragScroll()}handleEndDrag(e){this.isDraggingPawn?this.tryDropPawn(e)||a.events.trigger(s.UserActions.ReturnHeldPawn()):p.app.scene.worldMap.cameraController.stopDragScroll()}handlePawnInShopPointerDown(e){e!==this.buyingPawn?p.app.screen.play.selectedRegion.treasury>=u.inject.gameStateModel.rules.pawns(e).cost&&this.scene.uiScene.returnPawnToShop(this.buyingPawn,(()=>{this.scene.uiScene.grabNewPawnFromShop(e),this.buyingPawn=e,p.app.scene.worldMap.overlays.set(u.inject.currentGameState,y.OverlayModes.playing({holdingPawnType:this.buyingPawn,selectedRegionId:p.app.screen.play.selectedRegion.id})),this.fixPawnHolderPositionOnTouchDevice()})):this.scene.uiScene.returnPawnToShop(this.buyingPawn,(()=>this.goToNextMode()))}handlePawnInShopPointerUp(e){if(h.assert.defined(this.buyingPawn),e===this.buyingPawn&&this.justInitiated)return this.isDraggingPawn=!1,void this.fixPawnHolderPositionOnTouchDevice()}fixPawnHolderPositionOnTouchDevice(){if(p.app.device.isUsingTouch()){const{x:e,y:t}=p.app.scene.playUI.getPawnXY(this.buyingPawn);p.app.scene.playUI.pawnHolder.setFixedPosition(e,t-10)}}tryDropPawn(e){if(!e)return!1;const t=this.buyingPawn,i=p.app.screen.play.selectedRegion;if(h.assert.defined(t),h.assert.defined(i),this.canReturnPawnAtHex(e))return this.scene.uiScene.restockPawnInShop(this.buyingPawn,!0),this.scene.dropHeldPawnAtHex({hexId:e.id,willBeMovable:!0}),this.bought=!1,this.goToNextMode(),!1;const n=i=>{this.scene.uiScene.restockPawnInShop(this.buyingPawn),this.scene.dropHeldPawnAtHex({hexId:e.id,willBeMovable:i}),u.inject.gameStateController.executePlay(s.Plays.BuyPawn({pawnType:t,destinationHexId:e.id,buyerRegionId:u.inject.levelSession.selectedRegionId,tapUnit:!1})),p.app.audio.playEffect(c.SoundEffects.Drop),(0,f.playCoinSoundEffect)(u.inject.gameStateModel.rules.pawns(t).cost)},o=u.inject.gameStateModel.warfare.getDropPawnResult(e,this.buyingPawn,i);switch(o.type){case r.DropPawnResultType.Reposition:case r.DropPawnResultType.EradicatePest:case r.DropPawnResultType.Combine:return n(o.type===r.DropPawnResultType.Reposition),this.bought=!0,this.goToNextMode(),!0;case r.DropPawnResultType.Conquest:return this.bought=!0,this.scene.uiScene.restockPawnInShop(this.buyingPawn,!0),u.inject.gameStateController.executePlay(s.Plays.BuyPawn({pawnType:t,destinationHexId:e.id,buyerRegionId:u.inject.levelSession.selectedRegionId,tapUnit:!1})),(0,f.playCoinSoundEffect)(u.inject.gameStateModel.rules.pawns(t).cost),!0;case r.DropPawnResultType.Invalid:return p.app.audio.playEffect(c.SoundEffects.Deny),o.reason===r.InvalidDropPawnReason.PreventedByPawn&&(p.app.scene.worldMap.pawns.transitions.defendTile(e,o.blockers),p.app.notifications.movePreventedByPawn(this.buyingPawn,o.blockers),p.app.tooltips.showDefenderTaunt(e,this.buyingPawn,o.blockers[0])),!1}}handleShopAreaPointerUp(){a.events.trigger(s.UserActions.ReturnHeldPawn())}handleReturnPawn(){h.assert.defined(this.buyingPawn),p.app.scene.worldMap.cameraController.stopDragScroll(),this.scene.uiScene.returnPawnToShop(this.buyingPawn,(()=>{this.goToNextMode()}))}async handleHexCaptured(e){e.originatingHexId?w.warning(`ignoring hexCaptured as the capture originated from pawn at hex ${e.originatingHexId}, rather than freshly bought pawn`):(p.app.audio.playEffect(c.SoundEffects.Drop),this.scene.dropHeldPawnAtHex({hexId:e.capturedHexId,willBeMovable:!1}),await(0,g.handleHexCaptured)(this.scene,e,!1),this.goToNextMode())}goToNextMode(){this.buyAnother?(this.scene.uiScene.grabNewPawnFromShop(this.buyingPawn),this.scene.setMode(new v(this.scene,this.buyingPawn))):this.scene.setMode(new n.PlayMode(this.scene))}canAffordAnother(){return u.inject.gameStateModel.economy.treasuryOf(p.app.screen.play.selectedRegion)>=2*u.inject.gameStateModel.rules.pawns(this.buyingPawn).cost}handleNewHexUnderCursor(e){const t=p.app.screen.play.selectedRegion;t&&(0,l.updateHighlightWhileMovingPawn)(this.scene,e,this.buyingPawn,t)}handleAbort(){a.events.trigger(s.UserActions.ReturnHeldPawn())}canReturnPawn(){return!0}doHandleEvent(e){return(0,m.doHandleEvent)(this,e)}}t.BuyingPawnMode=v},2008:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playPawnMove=async function(e,t,i){const C=d.CurrentPhase.model(i).isLocalPlayerTurn(),M=C&&!(p.app.scene.play.mode instanceof y.SpectatorMode),A=[];if(t.hexCaptured){const L=g.Regions.model(i),_=t.hexCaptured.affectedRegions.map((e=>L.byId(e)));p.app.scene.worldMap.syncTownVariantInRegions(i,_.filter((e=>e)))}else{const D=g.Regions.model(i).byHex((0,h.getHex)(t.destHex));D&&p.app.scene.worldMap.syncTownVariantInRegions(i,[D])}M&&t.hexCaptured&&(0,n.playHexCaptured)(e,t.hexCaptured,i),M&&e.overlays.set(i,w.OverlayModes.playing({selectedRegionId:p.app.screen.play.selectedRegion?.id})),!M&&t.hexCaptured&&e.overlays.conquerableHexesHighlight.add((0,h.getHex)(t.destHex),d.CurrentPhase.model(i).isLocalPlayerTurn()?m.Colors.highlight.friendlyRegion:m.Colors.highlight.hostileRegion);let B=[],E=[];const O=e.session();if(!u.inject.ui.skipTransitions()){for(let j of t.pawns){let F;if(j.created){const U=l.Rules.model(i).pawns(j.created.pawnType);F=e.pawns.createOrUpdatePawnObject({id:j.pawnId,type:j.created.pawnType,hexId:M||U.hasTrait(c.PawnTraits.Building)?t.destHex:j.created.hex??t.destHex,jumping:!1,visible:!0}),U.hasTrait(c.PawnTraits.Building)&&e.chunkedRenderer.sync((0,b.syncRequest)(i,(0,h.getHex)(t.destHex),b.RenderLayerKey.Palisade))}else F=e.pawns.getById(j.pawnId);if(!F)return s.errors.handleNonFatalError(`Unable to play pawn move - pawn with id ${j.pawnId} not found`,"playPawnMove"),void(s.config.debug.overlay||p.app.scene.worldMap.syncState(i));A.push(F),F.visible&&!u.inject.ui.skipTransitions()&&(F.tile?.hex.id!==t.destHex?(B.push(e.pawns.transitions.pawnMove(F,{srcHex:j.created?.hex,destHex:t.destHex,fadeIn:!!j.created})),E.push(F)):j.created&&!M&&(B.push(e.pawns.transitions.pawnCreated(F,t.destHex)),E.push(F)))}for(let G of E)G.setJumping(!1),G.setHighlight(null);if(t.defeatedUnit){const N=e.pawns.getById(t.defeatedUnit.pawnId);if(N)if(t.defeatedUnit.retreatHex)H(P.SoundEffects.Dodge),await async function(e,t){e&&await t}(!M,e.pawns.transitions.pawnMove(N,{destHex:t.defeatedUnit.retreatHex}));else{const V=E.length>0?.6*u.inject.ui.transitionsSpeed():0;p.app.scene.play.time.delayedCall(V,(()=>{if(!O.isActive())return;e.pawns.transitions.destroyPawn(N,E.length>0?(0,h.getHex)(t.pawns[0].srcHex):void 0),N.type===S.PawnType.Town&&e.torches.syncHex(i,(0,h.getHex)(t.destHex));const s=u.inject.gameStateModel.rules.pawns(N.type);s.hasTrait(c.PawnTraits.Building)||!C&&s.hasTrait(c.PawnTraits.Treasure)?H(P.SoundEffects.ConquerBuilding):(s.hasTrait(c.PawnTraits.Unit)||s.hasTrait(c.PawnTraits.Pest)&&!s.hasTrait(c.PawnTraits.Treasure))&&H(P.SoundEffects.ConquerUnit)}))}else I.warning(`invalid defeated unit ${t.defeatedUnit.pawnId}`)}function H(e){p.app.audio.playEffect(e)}if(await Promise.all(B),!O.isActive())return;for(let W of E)W.setJumping(!1),W.setHighlight(null),W.setVisible(!0),W.isDestroyed()||W.attachToTile(e.tileObjects.getByHex(t.destHex))}if(!O.isActive())return;let R,k;if(!M&&t.hexCaptured&&((0,n.playHexCaptured)(e,t.hexCaptured,i),e.overlays.conquerableHexesHighlight.remove((0,h.getHex)(t.destHex))),t.merged){let z;if(t.merged.mergedWith&&(z=e.pawns.getById(t.merged.mergedWith)),R=o.Pawns.model(i).byId(t.merged.newPawnId),!R)return s.errors.handleNonFatalError(new Error("unable to play merge animation, output pawn object not found"),"playPawnMove"),void(s.config.debug.overlay||p.app.scene.worldMap.syncState(i));a.assert.defined(R),k=e.pawns.createOrUpdatePawnObject({id:R.id,hexId:R.hex.id,type:R.type,jumping:!1,visible:!0}),A.forEach((e=>e.destroy())),z&&!z.isDestroyed()&&z.destroy()}else if(t.replaced){k=e.pawns.createOrUpdatePawnObject({id:t.replaced.newPawnId,type:t.replaced.newType,hexId:t.destHex,jumping:!1,visible:!0});const $=e.pawns.getById(t.pawns[0].pawnId);A.forEach((e=>e.destroy())),$&&!$.isDestroyed()&&$.destroy(),R=o.Pawns.model(i).byId(t.replaced.newPawnId),(0,f.redrawPalisadeIfReplacedByBuilding)(i,t.destHex,t.replaced.oldType,t.replaced.newType)}else{const Y=t.pawns.filter((e=>t.defeatedUnit?.pawnId!=e.pawnId));(0,a.assert)(1===Y.length,`unexpected number of pawns involved in non-merge move - expected: 1; actual: ${t.pawns.length} (${(0,v.str)(t)})`),R=o.Pawns.model(i).byId(Y[0].pawnId),a.assert.defined(R,`pawn not found for id ${Y[0].pawnId}`),k=e.pawns.createOrUpdatePawnObject({id:R.id,hexId:R.hex.id,type:R.type,jumping:!1,visible:!0,variant:(0,x.getPawnVariant)(i,R)})}k.setJumping(M&&R.isMovable()),k.hanging&&k.setHighlight(k.jumping?r.Highlight.Hang:null),M&&(0,T.updateBankrupcySymbols)(i,e.overlays.pawnSymbols)};const s=i(56824),n=i(42824),o=i(81434),a=i(97849),r=i(76314),l=i(19162),c=i(63521),d=i(45084),h=i(45664),u=i(91622),p=i(54825),g=i(56038),m=i(96137),y=i(97869),f=i(34348),w=i(30484),v=i(7334),b=i(73230),S=i(24598),x=i(19693),T=i(25862),P=i(98963),I=s.logger.for("PawnsManager");new class{constructor(e,t,i){this.start=e,this.step=t,this.fadeTimeMs=i,this.lastUsed=0,this.currentAdjustment=0}getNextAdjustment(){const e=performance.now()-this.lastUsed>this.fadeTimeMs;return this.lastUsed=performance.now(),e?this.currentAdjustment=this.start:this.currentAdjustment+=this.step,this.currentAdjustment}}(-600,300,2e3)},2195:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SurrenderForm=void 0;const s=i(86545),n=i(76049),o=i(96137),a=i(56793),r=i(21941),l=i(20087),c=i(54825),d=i(36868),h=i(1565),u=i(11466),p=i(51496),g=i(56824);var m=Phaser.GameObjects.BitmapText;class y extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.title=new m(this.scene,0,0,n.BitmapFont.Main,"Congratulations!").setTint(o.Colors.glassUi_old.primaryText),this.content=new m(this.scene,0,0,n.BitmapFont.Small,"Your rivals have lost all hope! Accept their surrender?").setTint(o.Colors.glassUi_old.primaryText),this.submitButton=new a.BoxButton_LEGACY(this.scene,0,0,{baseTexture:r.BoxTextures.DialogButton,downTexture:r.BoxTextures.DialogButtonDown,text:"CLAIM VICTORY!",font:n.BitmapFont.Small,textColor:o.Colors.glassUi_old.primaryText,width:200,height:36}),this.cancelButton=new a.BoxButton_LEGACY(this.scene,0,0,{baseTexture:r.BoxTextures.DialogButton,downTexture:r.BoxTextures.DialogButtonDown,text:"I'M NOT DONE YET!",font:n.BitmapFont.Small,textColor:o.Colors.glassUi_old.primaryText,width:200,height:36}),this.add([this.title,this.content,this.submitButton,this.cancelButton]),this.submitButton.onClicked((()=>{g.events.trigger(d.UserActions.AcceptSurrender())})),this.cancelButton.onClicked((()=>{g.events.trigger(d.UserActions.DismissSurrender()),p.track.interaction("dismiss_surrender"),c.app.scene.worldMap.overlays.attitudeEmojis.clearChatter(),c.app.scene.globalUI.notifications.clearToasts(h.NotificationScope.Level)}))}updateLayout(){this.title.setMaxWidth(this.width),this.content.setMaxWidth(this.width),l.Arrange.fromTopToBottomOld([this.title,this.content,this.submitButton,this.cancelButton],{x:0,y:0,originX:0,originY:0,spacing:16});const e=c.app.scene.globalUI.notifications.layout;c.app.device.uiVariant()===u.UiVariant.Compact?l.Arrange.alignX({content:[this.submitButton,this.cancelButton],x:this.width/2-e.padding,origin:.5}):(l.Arrange.leftToRight({content:[this.submitButton,this.cancelButton],spacing:10,x:this.width/2-e.padding,origin:.5}),l.Arrange.alignY({content:[this.submitButton,this.cancelButton],y:this.submitButton.y,origin:0})),this.updateSize()}calculateHeight(){return this.cancelButton.y+this.submitButton.height}}t.SurrenderForm=y},2297:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.TooltipType=void 0,function(e){e.Hover="hover",e.Permanent="permanent"}(i||(t.TooltipType=i={}))},2386:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VictoryScreen=void 0;const s=i(81700),n=i(95568),o=i(36868),a=i(42880),r=i(80778),l=i(66143),c=i(91622),d=i(54825),h=i(51496),u=i(71021),p=i(56824),g=i(69238),m=i(32410),y=i(5365),f=i(68878);class w extends n.BaseScreen{constructor(){super("Victory",[s.Scenes.WorldMap,s.Scenes.Victory]),this.observe.event(o.UserActions.Escape,(async()=>{const e=c.inject.levelSession.data?.origin;c.inject.levelSession.end({origin:"victory/return-to-menu",wipeAutoSave:!0}),(0,r.returnToMenuFromGame)(e)})),this.observe.event(o.UserActions.ViewReplay,(async()=>{h.track.interaction("view_replay"),d.app.navigator.goTo(d.app.screen.play,u.NewGameStateContext.ViewReplayAfterGameOver)}))}async activate(){const e=l.LevelModel.for(c.inject.levelSession.levelId);let t=e.getNextUnfinishedLevelInExpedition(c.inject.levelSession.levelId);const i="l-tutorial3"===e.id;i&&(t="l-intro2");const s=[{title:"NEXT ISLAND",executor:async()=>{t?(i&&await d.app.modals.confirmDifficulty(),p.events.trigger(o.UserActions.PlayLevel({levelId:t,origin:"victory/play-next"}))):(c.inject.levelSession.end({origin:"victory/play-next",wipeAutoSave:!0}),p.events.trigger(o.UserActions.GoToRandomMapSelect()))}},{title:"LEAVE",executor:()=>{p.events.trigger(o.UserActions.Escape())}},{title:"PLAY AGAIN",executor:async()=>{let e=c.inject.levelSession.aiDifficulty;const t=await d.app.modals.playAgainDialog(c.inject.levelSession.levelId);if(t.result!==y.DialogButtons.Restart)return!1;e=t.aiDifficulty??e,p.events.trigger(o.UserActions.PlayLevel({levelId:c.inject.levelSession.levelId,restart:!0,origin:"victory/play-again",aiDifficulty:e}))}},{title:"VIEW REPLAY",executor:()=>{p.events.trigger(o.UserActions.ViewReplay())}}];(!t&&e.expeditionContext||(0,f.isPlayingEditorLevel)())&&s.splice(0,1),d.app.scene.victory.setAvailableActions(s),d.app.scene.victory.updateContent(),d.app.scene.worldMap.setMode(new a.PreviewMode),d.app.scene.worldMap.cameraController.center(1e3)}async transitionOut(e){return e===d.app.screen.overworld?await(0,g.victoryToOverworldTransition)():(0,m.victoryBaseTransitionOut)()}deactivate(){d.app.scene.globalUI.ambientGlitterVolume.transitionTo(0)}}t.VictoryScreen=w},2426:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DashedMask=t.RoundedRect=void 0;var s=Phaser.Display.Masks.GeometryMask;const n=i(61727);class o extends n.GraphicsContainer{constructor(e,t){super(e,{x:t.x??0,y:t.y??0,fillStyle:t.fillStyle,lineStyle:t.lineStyle}),this.radius=t.radius,this._fillStyle=t.fillStyle,this._lineStyle=t.lineStyle,this._bevel=t.bevel??"flat"}getFillOffsets(){if(!this._lineStyle)return[0,0];switch(this._bevel){case"inset":return[0,1];case"button":return[1,1];default:return[1,2]}}render(e,t){if(this._fillStyle){this.fillStyle(this._fillStyle.color??0,this._fillStyle.alpha);const[i,s]=this.getFillOffsets();this.fillRoundedRect(i,i,e-s,t-s,this.radius)}this._lineStyle&&(this.lineStyle(1,this._lineStyle.color??0,this._lineStyle.alpha),this.strokeRoundedRect(.5,.5,e-1,t-1,this.radius))}setStyle(e){this._fillStyle=e.fill,this._lineStyle=e.line,this._radius=e.radius??0,this.preUpdate.makeDirty()}setFillStyle(e,t=1){this._fillStyle={color:e,alpha:t},this.preUpdate.makeDirty()}setLineStyle(e,t,i=1){this._lineStyle={color:e,width:t,alpha:i},this.preUpdate.makeDirty()}set radius(e){this._radius=e,this.preUpdate.makeDirty()}get radius(){return this._radius}set bevel(e){this._bevel=e,this.preUpdate.makeDirty()}get bevel(){return this._bevel}}t.RoundedRect=o,t.DashedMask=class extends s{}},2520:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GlobalUIScene=void 0;const s=i(81700),n=i(30948),o=i(897),a=i(4440),r=i(7782),l=i(36868),c=i(4639),d=i(1565),h=i(98963),u=i(72843),p=i(87521),g=i(56824),m=i(91622),y=i(68871),f=i(93868),w=i(54825),v=i(15890),b=i(34963),S=i(85610),x=i(96137),T=i(52528),P=i(2297);var I=Phaser.GameObjects.Rectangle;const C=g.logger.for("GlobalUIScene");class M extends n.BaseUIScene{constructor(){super({key:s.Scenes.GlobalUI,bounds:f.BOUNDS.FullScreen}),this.permanentTooltips=[],this.tooltipsPool=new p.Pool((()=>new u.Tooltip(this))),this.modalOverlayVisibility=new r.TransitionController(this,{duration:400,ease:"Sine.easeOut",initialValue:0,applyValue:e=>{0===e?this.modalOverlay.setVisible(!1):(this.modalOverlay.setVisible(!0),this.modalOverlay.setAlpha(e))}}),this.backgroundTween=null,this.oldOceanColor=null,this.preUpdate=(0,o.whenDirty)((()=>{this.updateLayout()}))}addTooltip(e){switch(e.type){case P.TooltipType.Hover:return this.tooltip.showDelayed(e),this.tooltip.setDepth(9e3),this.tooltip;case P.TooltipType.Permanent:const t=this.tooltipsPool.take();return this.add.existing(t),t.depth=-1,t.setVisible(!1),this.permanentTooltips.push(t),t.showDelayed(e),t}}create(){super.create(),this.tooltip=new u.Tooltip(this),this.notifications=new c.Notifications(this),this.tooltip.setVisible(!1),this.objectsPool=new b.WorldObjectsPool(this),this.sidebarButtons=new y.SidebarButtons(this),this.promptButtons=new v.PromptButtonsUI(this),this.promptButtons.addToScene(),this.modalOverlay=new I(this,0,0,0,0,0,.3).setOrigin(0,0),this.modalOverlayVisibility.setTo(0),this.fastForwardOverlay=new S.FastForwardOverlay(this),this.addAll([this.tooltip,this.notifications,this.modalOverlay,this.fastForwardOverlay,this.sidebarButtons]),this.observe.event(l.SystemEvents.ScreenActivated,(e=>{this.sidebarButtons.updateLayout(),this.notifications.clearToasts(d.NotificationScope.Screen),this.notifications.preUpdate.makeDirty(),this.promptButtons.updateLayout()})),this.observe.watch(m.inject.ui.selectedLevelId,(e=>{this.notifications.clearToasts(d.NotificationScope.Level)})),this.observe.watch(m.inject.ui.sidebarMode,(e=>{w.app.scene.globalUI?.tooltip.hide(),this.sidebarButtons.updateLayout()})),g.events.on(l.SystemEvents.ScreenActivated,(e=>{this.updateLayout()})),this.input.on("pointerdown",((...e)=>{w.app.scene.dropdownUI.closeDropdown()})),this.bindKey(a.Input.Keyboard.KeyCodes.ESC,l.UserActions.Escape),this.bindKey(a.Input.Keyboard.KeyCodes.F8,l.UserActions.OpenLoadGameDialog),this.typeWriterSound=this.sound.add(h.SoundEffects.TypeWriter,{loop:!0,volume:.1}),this.ambientGlitterSound=this.sound.add(h.SoundEffects.Glitter,{loop:!0,volume:0}),this.ambientGlitterVolume=new r.TransitionController(this,{duration:1e3,ease:"Sine.easeInOut",initialValue:0,applyValue:e=>{0===e?this.ambientGlitterSound.stop():(this.ambientGlitterSound.isPlaying||this.ambientGlitterSound.play(),this.ambientGlitterSound.setVolume(e))}}),this.load.multiatlas("gameOverAtlas","assets/gameOverAtlas.json","assets"),this.load.start(),this.tweens.addCounter({from:0,to:100,duration:300})}setOceanColor(e,t=g.config.screenTransitionDuration){const i=document.getElementById("phaser-game");if(!i)return;if(!this.oldOceanColor)return this.oldOceanColor=e,void(i.style.backgroundColor=x.Colors.toCss(e));if(e===this.oldOceanColor)return;this.backgroundTween&&this.backgroundTween.stop();const s=Phaser.Display.Color.IntegerToColor(this.oldOceanColor),n=Phaser.Display.Color.IntegerToColor(e);this.oldOceanColor=e,this.backgroundTween=this.tweens.addCounter({from:0,to:100,duration:t,onUpdate:(e,t,o,a)=>{const r=Phaser.Display.Color.Interpolate.ColorWithColor(s,n,100,a);i.style.backgroundColor=x.Colors.toCss(Phaser.Display.Color.ObjectToColor(r).color)}})}updateLayout(){this.notifications.preUpdate.makeDirty(),this.promptButtons.updateLayout(),this.modalOverlay.setSize(this.bounds.width,this.bounds.height),this.modalOverlay.setInteractive({useHandCursor:!1}),this.fastForwardOverlay.setPosition(0,0),this.fastForwardOverlay.setSize(this.bounds.width,this.bounds.height),this.sidebarButtons.width=T.SIDEBAR_LAYOUT.buttons.width+2*T.SIDEBAR_LAYOUT.buttons.padding,this.sidebarButtons.setPosition(this.bounds.width-this.sidebarButtons.width-T.SIDEBAR_LAYOUT.buttons.padding,T.SIDEBAR_LAYOUT.buttons.padding),this.sidebarButtons.updateLayout()}update(e,t){super.update(e,t),this.permanentTooltips.forEach((e=>e.updatePosition()))}showModalOverlay(e=!1){e?this.modalOverlayVisibility.setTo(1):this.modalOverlayVisibility.transitionTo(1)}hideModalOverlay(){return this.modalOverlayVisibility.transitionTo(0)}showFastForwardOverlay(e=0){w.app.navigator.activeScreen===w.app.screen.play&&(this.fastForwardOverlay.initializeProgressIndicator(m.inject.gameStateModel),this.fastForwardOverlay.getEstimatedTimeLeft(m.inject.gameStateModel)>e&&(this.showModalOverlay(!0),this.fastForwardOverlay.setVisible(!0)))}hideFastForwardOverlay(){this.hideModalOverlay(),this.fastForwardOverlay.setVisible(!1)}removeTooltip(e){const t=this.permanentTooltips.indexOf(e);-1!==t?(this.permanentTooltips.splice(t,1),e.hide().then((()=>this.tooltipsPool.free(e)))):C.warning(`Invalid attempt to remove tooltip "${e}", no such tooltip present among permanent tooltips`)}clearTooltips(){this.permanentTooltips.forEach((e=>{e.hide().then((()=>this.tooltipsPool.free(e)))})),this.permanentTooltips=[]}}t.GlobalUIScene=M},2523:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RewindModeControls=void 0;const s=i(80959),n=i(36868),o=i(76049),a=i(20087),r=i(85711),l=i(54825),c=i(11466),d=i(39648),h=i(56824),u=i(91622);var p=Phaser.GameObjects.Graphics;function g(e,t){return e.wood.primaryButton({width:48,icon:`ui/primary-button-icons/${t}`,tintIcon:!1})}t.RewindModeControls=class{constructor(e,t){this.scene=e,this.layout=t,this.ui=s.UiBuilder.for(this.scene),this.nextStopButton=g(this.ui,"next-stop"),this.prevStopButton=g(this.ui,"prev-stop"),this.stepForwardButton=g(this.ui,"step-forward"),this.stepBackButton=g(this.ui,"step-back"),this.labelText=(0,r.ref)("unknown"),this.mainLabel=this.ui.textContainer(this.labelText,o.BitmapFont.Main,0),this.guideline=this.ui.image("ui/guideline-up"),this.guidelineText=this.ui.text("select your province to confirm",o.BitmapFont.Mini,0),this.livesCounter=new d.LivesCounter(this.scene,.5),this.background=new p(this.scene),this.gameObjects=[this.background,this.livesCounter,this.prevStopButton,this.nextStopButton,this.stepForwardButton,this.stepBackButton,this.mainLabel,this.guidelineText,this.guideline],this.setVisible(!1),this.nextStopButton.onClicked((()=>h.events.trigger(n.UserActions.RewindForward()))),this.prevStopButton.onClicked((()=>h.events.trigger(n.UserActions.RewindBack()))),this.stepForwardButton.onClicked((()=>h.events.trigger(n.UserActions.RewindStepForward()))),this.stepBackButton.onClicked((()=>h.events.trigger(n.UserActions.RewindStepBack()))),u.inject.theme.use((e=>{this.guideline.setTint(e.oceanContrastDark),this.guidelineText.setTint(e.oceanContrastDark),this.mainLabel.setTint(e.oceanContrastDark)}))}getGameObjects(){return this.gameObjects}setVisible(e){for(let t of this.gameObjects)t.setVisible(e);e&&this.updateLayout()}updateState(e){e.layout&&("rewind"===e.layout.name?(this.setVisible(!0),this.labelText.set(e.layout.label),this.prevStopButton.setEnabled(e.layout.canGoBack),this.stepBackButton.setEnabled(e.layout.canGoBack),this.nextStopButton.setEnabled(e.layout.canGoForward),this.stepForwardButton.setEnabled(e.layout.canGoForward),this.guidelineText.setText(e.layout.guidelineLabel),this.livesCounter.setMode(e.layout.burningLife?d.LivesCounterMode.Cracked:d.LivesCounterMode.FullColor),this.livesCounter.setCount(e.layout.lives)):this.setVisible(!1))}updateLayout(){const e=this.scene.bounds.width,t=this.scene.bounds.height,i=this.layout;this.mainLabel.setSize(i.labelWidth,this.prevStopButton.height),a.Arrange.alignY({content:[this.prevStopButton,this.stepBackButton,this.mainLabel,this.stepForwardButton,this.nextStopButton],y:t-i.buttonsOffsetFromEdge-this.prevStopButton.height/2,origin:.5}),l.app.device.uiVariant()===c.UiVariant.Large?a.Arrange.leftToRight({content:[this.prevStopButton,this.stepBackButton,this.mainLabel,this.stepForwardButton,this.nextStopButton],origin:.5,x:e/2,spacing:i.buttonsSpacing}):(a.Arrange.leftToRight({content:[this.prevStopButton,this.stepBackButton],x:i.buttonsOffsetFromEdge,origin:0,spacing:i.buttonsSpacing}),a.Arrange.leftToRight({content:[this.stepForwardButton,this.nextStopButton],x:e-i.buttonsOffsetFromEdge,origin:1,spacing:i.buttonsSpacing}),a.Arrange.leftToRight({content:[this.mainLabel],x:e/2,origin:.5})),this.livesCounter.setSize(160,20),this.livesCounter.setMode(d.LivesCounterMode.Cracked),a.Arrange.topToBottom({content:[this.guideline,this.guidelineText,this.livesCounter],y:t-i.guidePromptOffsetFromBottom,spacing:4,origin:1}),a.Arrange.alignX({content:[this.guidelineText,this.guideline,this.livesCounter],origin:.5,x:e/2}),this.background.setPosition(0,0),this.background.clear();const s=u.inject.theme.getCurrent().oceanShades.light2;this.background.fillGradientStyle(s,s,s,s,0,0,.85,.85),this.background.fillRect(0,t-200,e,200)}}},2558:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lichKingStrategy=void 0;const s=i(56824),n=i(39409),o=i(24598),a=i(81434),r=i(78635),l=i(70712),c=i(1326),d=i(36868),h=i(56038),u=i(63521),p=i(9292),g=s.logger.for("ai:strategy");function m(e){return!!y(e)||function(e){return!!e.region.getTownHexes().find((t=>6===a.Pawns.model(e.state).getCount(t,o.PawnType.Mana)))}(e)}function y(e){return e.region.getPawns().find((e=>e.type===o.PawnType.DreadKnight&&e.isMovable()))}const f={[o.PawnType.Town]:100,[o.PawnType.Castle]:50,walls:100,[o.PawnType.Pikeman]:30,[o.PawnType.Villager]:15,[o.PawnType.HauntedTown]:-1e3};function w(e,t){const i=r.Warfare.model(e.state),s=i.getOccupyingUnit(t);let n=(s&&f[s.type])??0;const o=i.getHexStaticDefense(t)>0,a=!!h.Regions.model(e.state).byHex(t)?.isAlive();return o&&(n+=f.walls??0),a&&(n+=1),n-2*t.neighbours((t=>e.region.hexes.has(t))).map((t=>l.AI.getHexImportance(e.state,t.id).distanceFromTown)).reduce(p.pickSmaller,Number.POSITIVE_INFINITY)}t.lichKingStrategy=async e=>{for(;m(e);){const t=h.Regions.getAdjacentForeignHexes(e.state,e.region.id).filter((t=>r.Warfare.getHexDefense(e.state,t)<3&&!a.Pawns.isTraitPresentOnHex(e.state,t.id,u.PawnTraits.PreventsHeavyUnits))).toArray();if(0===t.length){const i=(0,n.createAiViews)(e),s=e.region.getHostileBorderHexes().filter((t=>!r.Warfare.getOccupyingPawn(e.state,t)&&!a.Pawns.isTraitPresentOnHex(e.state,t.id,u.PawnTraits.PreventsHeavyUnits))),o=(0,c.findMax)(s.toArray(),(e=>i.defenderBenefit.getForMight(e.id,3)));o&&t.push(o)}if(0===t.length)break;const i=(0,c.findMax)(t,(t=>w(e,t))),s=y(e);if(!i){g.warning("no viable target found for Dread Knight");break}s?e.addPlay(d.Plays.MovePawn({pawnId:s.id,tapUnit:!0,destinationHexId:i.id})):e.addPlay(d.Plays.BuyPawn({buyerRegionId:e.region.id,destinationHexId:i.id,tapUnit:!0,pawnType:o.PawnType.DreadKnight}))}}},2812:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SlackClient=void 0;const s=i(56824);t.SlackClient=class{constructor(e){this.webhookUrl=e}async sendMessage(e){await fetch(s.config.reporting.slack.feedbackHook,{method:"POST",body:JSON.stringify(e)}).then((e=>{if(!e.ok)throw new Error(`Failed to send slack message - hook responded with status ${e.status}`)}))}}},3122:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalWindowScene=void 0;const s=i(81700),n=i(11322),o=i(5365),a=i(30948),r=i(897),l=i(70046),c=i(91622),d=i(54825),h=i(93868),u=i(36868),p=i(56824);class g extends a.BaseUIScene{constructor(){super({key:s.Scenes.ModalWindow,bounds:h.BOUNDS.FullScreen}),this.debugLayer=new n.UiDebugLayer(this),this.modalsStack=[],this.preUpdate=(0,r.whenDirty)((()=>{this.window.setPosition(this.cameras.main.width/2,this.cameras.main.height/2),this.debugLayer.clear(),p.config.debug.uiLayout&&(this.debugLayer.addHorizontalLine(this.cameras.main.height/2),this.debugLayer.addVerticalLine(this.cameras.main.width/2))})),this.observe.event(u.UserActions.SubmitForm,(()=>{this.submitCurrentModal()})),this.observe.event(u.UserActions.Cancel,(()=>{this.cancelCurrentModal()}))}pushModal(e,t){const i={uiProvider:e,props:t};d.app.navigator.currentScreen?.pause(),this.modalsStack.push(i),this.doShowModal(i),this.updateDebugData()}updateDebugData(){this.modalsStack.length?c.inject.debugData.set("modalWindow",this.modalsStack.map((e=>e.uiProvider.constructor.name)).join(" > ")):c.inject.debugData.clear("modalWindow")}submitCurrentModal(){this.modalsStack.length&&(this.modalsStack[this.modalsStack.length-1].uiProvider.handleSubmit(),this.closeModal())}cancelCurrentModal(){this.modalsStack.length&&(this.modalsStack[this.modalsStack.length-1].uiProvider.handleCancel(),this.closeModal())}doShowModal({uiProvider:e,props:t}){const i=this.window.onCancel((()=>{this.closeModal(),i.unsubscribe(),t.onClose(o.DialogButtons.Cancel)})),s=e.getContent(this,{...t,onClose:e=>{i.unsubscribe(),this.closeModal(),t.onClose(e)}},{width:this.bounds.width,height:this.bounds.height});this.window.setProps({title:e.getTitle(t),content:s}),this.preUpdate(),e.onShown?.(),this.fadeIn()}async fadeIn(){this.window.animateIn(),d.app.scene.globalUI.showModalOverlay()}async fadeOut(){this.window.animateOut(),await d.app.scene.globalUI.hideModalOverlay()}closeModal(){this.modalsStack.pop();const e=this.modalsStack[this.modalsStack.length-1];e?this.doShowModal(e):(d.app.navigator.currentScreen?.resume(),this.fadeOut().then((()=>{0===this.modalsStack.length&&this.scene.sleep()}))),this.updateDebugData()}create(){if(super.create(),this.cameras.main.roundPixels=!0,this.window)throw new Error("Attempt to create ModalWindowScene for a second time");this.window=new l.ModalWindow(this,{title:""})}isModalActive(){return this.modalsStack.length>0}}t.ModalWindowScene=g},3234:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverworldScreen=void 0;const s=i(95568),n=i(81700),o=i(36868),a=i(54825),r=i(91622),l=i(56824),c=i(66143),d=i(97849),h=i(98963),u=i(31138),p=i(54429),g=i(16082),m=i(75726),y=i(9292);class f extends s.BaseScreen{constructor(){super("Overworld",[n.Scenes.OverworldMap,n.Scenes.OverworldUI,n.Scenes.MenuHeaderUI,n.Scenes.LevelList]),this.lockOrientation=!1,this.observe.event(o.UserActions.GoBack,(()=>{a.app.navigator.goTo(a.app.screen.expeditions)})),this.observe.watch(r.inject.ui.selectedLevelId,(e=>{this.updateUIState()})),this.observe.event(o.UserActions.SelectIsland,(e=>{e?a.app.audio.playEffect(h.SoundEffects.ShutterClick):r.inject.ui.selectedLevelId()&&a.app.audio.playEffect(h.SoundEffects.ButtonUp),this.selectIsland(e)})),this.observe.event(o.SystemEvents.UserDataLoaded,(()=>{this.loadExpedition(this.selectedExpedition.id)})),this.observe.event(o.UserActions.Escape,(async()=>{l.events.trigger(o.UserActions.GoBack())})),this.observe.event(o.UserActions.FindNextIsland,(()=>{const e=w(this.selectedExpedition);this.selectIsland(e.id)})),this.observe.event(o.UserActions.AbandonLevelProgress,(()=>{r.inject.levelSession.clearInProgressLevelRecord(),this.updateUIState(),this.updateSelectedIslandState()})),this.observe.event(o.UserActions.ToggleLevelList,(()=>{const e=!a.app.scene.overworldUI.currentState.levelListExpanded;a.app.scene.overworldUI.updateState({levelListExpanded:e}),a.app.scene.menuHeaderUI.currentState.update({header:{...a.app.scene.menuHeaderUI.currentState().header,fullHeight:e}}),a.app.scene.levelList.state.update({open:e})})),this.observe.event(o.UserActions.SetLevelListFilter,(e=>{a.app.scene.overworldUI.updateState({levelListFilter:e}),a.app.scene.overworld.islands.setAlwaysShowStartingState(e!==p.LevelFilter.Unlocked&&e!==p.LevelFilter.All),a.app.scene.levelList.state.update({levelFilter:e})})),this.observe.event(o.UserActions.SetLevelListSortBy,(e=>{a.app.scene.levelList.state.update({sortBy:e}),a.app.scene.overworldUI.updateState({levelListSortBy:e})}))}selectIsland(e,t="transition"){e?(a.app.scene.overworld.islands.selectIslands(e),a.app.scene.overworld.focusIsland(e,t)):a.app.scene.overworld.islands.selectIslands(),r.inject.ui.selectedLevelId.set(e),this.updateUIState()}updateSelectedIslandState(){r.inject.ui.selectedLevelId()&&a.app.scene.overworld.islands.objectsById[r.inject.ui.selectedLevelId()]?.refresh()}async updateUIState(){const e=r.inject.ui.selectedLevelId();if(!e)return void a.app.scene.overworldUI.updateState({footerLayout:{mode:"no-level-selected"},primaryButton:{title:"NEXT",tooltip:"Find next island to conquer!",icon:void 0,onClick:()=>{l.events.trigger(o.UserActions.FindNextIsland())}},levelDetail:null});const t=c.LevelModel.for(e),i=t.getLevelStatus(),s=await t.getStartingState(),n=t.author?`\n(by ${t.author})`:"",d={title:t.getTitle(c.LevelTitleStyle.Short),description:(s.map.description??"An unexplored island ripe for conquest!")+n,status:t.getLevelStatus(),bestVictory:t.userVictoryRecord,features:t.getFeatures({includeIsNew:!0})},h=t.inProgressRecord;if(h){const i=t.manifest?.fixedAIDifficulty?"":` - ${h.sessionData.aiDifficulty}`;a.app.scene.overworldUI.updateState({footerLayout:{mode:"in-battle",subtitle:`Turn ${h.turnNumber}${i}`},levelDetail:d,primaryButton:{title:"CONTINUE",tooltip:"Continue where you left off.",icon:"ui/wood-icons/arrow-right",onClick:()=>{l.events.trigger(o.UserActions.PlayLevel({levelId:e,origin:"campaign/continue"}))}}})}else a.app.scene.overworldUI.updateState({footerLayout:{mode:"unlocked-level-selected",canSelectDifficulty:!t.manifest?.fixedAIDifficulty},levelDetail:d,primaryButton:{title:i===c.LevelStatus.Unlocked?"BEGIN":"PLAY AGAIN",tooltip:"Start your conquest of this level!",icon:"ui/wood-icons/arrow-right",onClick:()=>{l.events.trigger(o.UserActions.PlayLevel({levelId:e,origin:i===c.LevelStatus.Unlocked?"campaign/play":"campaign/play-again"}))}}})}async transitionOut(e){if(e===a.app.screen.play)return await(0,u.overworldToPlaySceneTransition)()}async loadExpedition(e,t){await r.inject.mapRegistry.initialize();const i=a.app.scene.levelList.state().open;this.selectedExpedition=g.ExpeditionModel.for(e),d.assert.defined(this.selectedExpedition,`unknown expedition id "${e}"`),a.app.scene.menuHeaderUI.currentState.update({header:{title:this.selectedExpedition.metadata.name,subtitle:v(this.selectedExpedition),icon:"rosetta-light",overlayIcon:`expedition-icons/${this.selectedExpedition.id}`,extraHeight:50,fullHeight:i},footer:{backButton:!0}});const s=w(this.selectedExpedition),n=this.selectedExpedition.config.theme;r.inject.theme.sync(n),await a.app.scene.overworld.loadExpedition(this.selectedExpedition,t||s.id);const o=g.ExpeditionModel.for(e).levels,l=o.length>=10?p.LevelFilter.All:p.LevelFilter.Disabled;a.app.scene.levelList.state.update({levels:o,levelFilter:l,open:i}),i||a.app.scene.levelList.scene.sleep(),a.app.scene.overworldUI.updateState({levelListFilter:l}),r.inject.ui.selectedLevelId.set(s.id)}async activate(e,t){a.app.scene.overworld.fadeIn(0);const i=function(e){if(e.expeditionId)return e.expeditionId;const t=r.inject.ui.selectedLevelId()??r.inject.levelSession.getInProgressLevelRecord()?.sessionData.levelId,i=t&&c.LevelModel.for(t).expeditionContext?.expedition;return i?i.id:r.inject.mapRegistry.getExpeditions()[0].id}(e);a.app.scene.overworld.cameras.main,await this.loadExpedition(i,e.focusObject),t===a.app.screen.expeditions&&await(0,m.expeditionsToOverworldTransition)(this.selectedExpedition.id),this.updateUIState()}}function w(e){const t=r.inject.ui.selectedLevelId();if(t&&c.LevelModel.for(t).expeditionContext?.expedition.id===e.id)return c.LevelModel.for(t);const i=r.inject.levelSession.getInProgressLevelRecord()?.sessionData.levelId,s=i&&c.LevelModel.for(i);if(s&&s.expeditionContext?.expedition.id===e.id)return s;const n=e.objects.filter((e=>"island"===e.type)).map((e=>c.LevelModel.for(e.id))),o=n.filter((e=>e.isUnlocked()));return o.find((e=>!e.isCompleted()&&e.isInProgress()))??o.find((e=>!c.LevelModel.for(e.id).isCompleted()))??o.find((e=>!c.LevelModel.for(e.id).isCompleted("hard")))??o[o.length-1]??n[0]}function v(e){if(!e)return"? out of ? islands conquered";const t=e.levels.filter((e=>c.LevelModel.for(e.id)?.isCompleted())).length,i=Math.round(t/e.levels.length*100);return 100===i?`Expedition completed in ${e.levels.map((e=>c.LevelModel.for(e.id).userVictoryRecord?.turns??0)).reduce(y.sum,0)} turns.`:`Expedition ${i.toFixed()}% complete`}t.OverworldScreen=f},3767:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IDBUserContentStorage=void 0;const s=i(60602),n=i(10131),o=i(56824),a=i(9292),r=o.logger.for("IDBUserContentService");t.IDBUserContentStorage=class{constructor(){this.state="not-initialized",this.initialize=(0,n.asyncInitializer)((async()=>{this.db=await(0,s.openDB)("user-content",5,{upgrade(e,t,i,s){if(t)n("type","type"),n("typeAndLevelId",["type","levelId"]);else{const t=e.createObjectStore("library",{keyPath:"id"});t.createIndex("created","created"),t.createIndex("type","type"),t.createIndex("typeAndLastInteraction",["type","lastInteraction"]),t.createIndex("typeAndCreated",["type","created"]),t.createIndex("typeAndLevelId",["type","levelId"])}function n(e,t){s.objectStore("library").indexNames.contains(e)||s.objectStore("library").createIndex(e,t)}}})}))}isAvailable(){return this.initialize.wasSuccessful()}async storeContent(e){await this.initialize(),await this.db.put("library",e)}async getById(e){return await this.db.get("library",e)}async getByLevelId(e,t){return await this.db.getFromIndex("library","typeAndLevelId",[e,t])}async getAllByLevelId(e,t){const i=IDBKeyRange.bound([e,t],[e,t]);return await this.db.getAllFromIndex("library","typeAndLevelId",i)}async getLatestByType(e){await this.initialize();const t=IDBKeyRange.bound([e,-1/0],[e,1/0]);return(await this.db.getAllFromIndex("library","typeAndLastInteraction",t)).reverse()}async getAllLevelIds(e){const t=IDBKeyRange.bound([e,""],[e,""]),i=this.db.transaction("library","readonly").objectStore("library").index("typeAndLevelId");let s=await i.openCursor(t);const n=[];for(;s;){const e=s.value;n.push(e.levelId),s=await s.continue()}return n}async keepOnlyLatest(e,t){const i=IDBKeyRange.bound([e,-1/0],[e,1/0]),s=await this.db.getAllKeysFromIndex("library","typeAndLastInteraction",i),n=s.slice(0,(0,a.pickLarger)(0,s.length-t));n.length&&n.forEach((e=>this.db.delete("library",e)))}async deleteContent(e){await this.db.delete("library",e)}touchContent(e){this.getById(e).then((t=>{t?this.db.put("library",{...t,lastInteraction:Date.now()}):r.warning(`Tried to touch content that does not exist (id=${e})`)}))}}},3904:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.debugBreakPointProvider=async function(e,t){if(!n.config.debug.overlay||!n.config.debug.breakpoints)return;const i=n.config.debug.breakpoints;if(Array.isArray(i)&&!i.find((t=>e.startsWith(t))))return;const a=o.app.scene.debug,r=o.app.scene.worldMap,l=(o.app.navigator.currentScreen,t?t():{});r.syncState(l.state??s.inject.gameStateModel.state),console.info("========= BREAKPOINT ========="),await a.handleBreakpoint(e,t?t():{})};const s=i(91622),n=i(56824),o=i(54825)},4005:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseUpdater=void 0,i(56824).logger.for("BaseUpdater"),t.BaseUpdater=class{constructor(e){this.dataSet=e,this.handlers=[],this.initFromState=e=>{this.newState=e,this.oldState=void 0,this.builder.init(e),this.initialize()},this.update=(e,t,i)=>(this.newState=e,this.changeSet=t,this.oldState=i,this.builder.init(e),this.initialize(),this.handlers.forEach((({dataSet:e,handler:t})=>{const i=this.changeSet.of(e);i&&t(i)})),this.createMutation()),this.registerHandlers(((e,t)=>this.handlers.push({dataSet:e,handler:t.bind(this)})))}createMutation(){return this.builder.createMutation("parents changed")}initialize(){}}},4112:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.outlineButtonStory=void 0;const s=i(80959);t.outlineButtonStory={name:"ui.outlineButton",content:e=>{const t=s.UiBuilder.for(e);function i(e){return t.outlineButton({icon:"ui/button-icons/settings",text:"Settings",tooltip:"Tooltip text",onClicked:()=>{console.log("clicked")},...e})}return[...["light","dark","white","islandCard","glassUi","subtle"].map((e=>({name:"THEME: "+e,component:i({theme:e})}))),...["small","large"].map((e=>({name:"VARIANT: "+e,component:i({variant:e})}))),{name:"VARIANT: circle",component:i({text:void 0,variant:"circle"})},{name:"Text only",component:i({icon:void 0,variant:"small"})},{name:"Icon left",component:i({icon:"ui/button-icons/settings",iconPlacement:"left"})},{name:"Icon right",component:i({icon:"ui/button-icons/settings",iconPlacement:"right"})},{name:"Disabled",component:i({icon:"ui/button-icons/settings",text:"Settings"}).setEnabled(!1)},...["inset","button","flat"].map((e=>({name:`BEVEL: ${e}`,component:i({icon:"ui/button-icons/settings",text:e,theme:"islandCard",bevel:e})})))]}}},4120:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DistanceFromCoastView=void 0;const s=i(20754),n=i(90952),o=i(56038),a=i(78635),r=i(20693),l=i(23618);class c extends s.LazyView{constructor(){super([n.GameState.map,n.GameState.warfare.hexStaticDefense,n.GameState.regions.byHex]),this.name="DistanceFromCoastView"}calculate(e){let t=o.Regions.getCoastalHexes(e).filter((t=>this.isAccessible(e,t)));const i=r.HexGroup.from(t),s=a.Warfare.model(e),n=o.Regions.model(e).allRegionsHexes().filter((e=>!s.isImpassable(e))),c=new l.DistanceMap(n);return c.addSources(i),c}isAccessible(e,t){return!a.Warfare.model(e).isImpassable(t)}getCacheKey(){return""}}t.DistanceFromCoastView=c},4356:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TreasuryByRegionProjection=void 0;const s=i(31011),n=i(56038),o=i(20026),a=i(67274),r=i(19618),l=i(78635),c=i(45664),d=i(24598),h=i(88023),u=i(9292);class p extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.builder=new s.MapMutationBuilder(this)}bootstrap(e){return(0,h.ImmutableMap)().withMutations((t=>{(0,o.selectFromState)(e,this.sources.townsByRegion).forEach(((i,s)=>{const n=i.toArray().map((t=>(0,o.selectFromState)(e,this.sources.coinsByHex,t)||0)).reduce(u.sum,0);n>0&&t.set(s,n)}))}))}update(e,t,i){return this.builder.init(e),this._handleCoinsByHexChange(e,t.of(this.sources.coinsByHex),i),this._handleTownsByRegionChange(e,t.of(this.sources.townsByRegion),i),this.builder.createMutation("parent changed")}_handleCoinsByHexChange(e,t,i){t?.updated?.forEach((([t,s])=>{const h=l.Warfare.getOccupyingPawn(i,(0,c.getHex)(t))?.type===d.PawnType.Town,u=l.Warfare.getOccupyingPawn(e,(0,c.getHex)(t))?.type===d.PawnType.Town,p=n.Regions.getByHex(e,t),g=n.Regions.getByHex(i,t);if(!p||r.Factions.getByRegion(e,p)===a.SpecialFaction.neutral)return;void 0===s&&(s=0);const m=g===p&&h?(0,o.selectFromState)(i,this.sources.coinsByHex,t)??0:0;u||(s=0);const y=(this.builder.getCurrent(p)||0)+s-m;y?this.builder.set(p,y):this.builder.delete(p)}))}_handleTownsByRegionChange(e,t,i){t?.updated?.forEach((e=>{const t=e.id;let s=this.builder.getCurrent(t)||0;e.added&&(s+=e.added.map((e=>(0,o.selectFromState)(i,this.sources.coinsByHex,e)||0)).reduce(u.sum,0)),e.removed&&(s-=e.removed.map((e=>(0,o.selectFromState)(i,this.sources.coinsByHex,e)||0)).reduce(u.sum,0)),s>0?this.builder.set(t,s):this.builder.delete(t)}))}}t.TreasuryByRegionProjection=p},4419:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameStateHistory=void 0;const s=i(49484),n=i(56824),o=i(20026),a=i(91622),r=i(75136);n.logger.for("StateRecorder"),t.GameStateHistory=class{constructor(){this.capacity=40,this.data=new s.FixedCapacityArray(40),this.currentFrame=0,this.paused=!1}add(e,t=a.inject.gameStateModel.state){this.paused||this.data.push({state:t,label:e})}debugMutationBuilder(e,t,i){const s=new r.Mutator((0,o.getParentEngine)(t),[i.createMutation(e)]).apply();this.add(e,s)}suspendRecording(){this.paused=!0}resumeRecording(){this.paused=!1}getAll(){return this.data.getItems()}get(e){return this.data.get(e)}length(){return this.data.length}}},4456:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PalisadeRenderer=void 0;const s=i(5178),n=i(78635),o=i(82226),a=i(20026),r=i(90952),l=i(73230);class c extends s.FactionBasedIsoRenderer{constructor(e){super(l.RenderLayerKey.Palisade,e.scene,e,o.IsoTileRecipes.Palisade)}shouldRun(e){return!!(0,a.getParentEngine)(e).isDataSetActive(r.GameState.warfare.hexStaticDefense)}shouldIncludeHex(e,t){return!n.Warfare.model(e.state).isImpassable(t)&&n.Warfare.getHexStaticDefense(e.state,t.id)>0}sync(e){if("all"===e.hexesToSync)super.sync(e);else{const t=e.hexesToSync,i=t.with(t.neighbours());super.syncHexes({...e,hexesToSync:i})}}}t.PalisadeRenderer=c},4586:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeZombiesAct=function(e){const t=new r.WorldUpdateBuilder(e),i=e.factions.all().filter((e=>e.persona.race===h.Race.Undead||e.isNeutral())),o=[],c=i.flatMap((e=>e.getRegions())).map((e=>e.getPawns().filter((e=>e.type===s.PawnType.HauntedTown)))).flat().map((e=>e.hex)),d=e.factions.all().filter((e=>e.persona.race===h.Race.Undead)).flatMap((e=>e.getRegions())).flatMap((e=>e.getPawns().filter((e=>e.type===s.PawnType.Town)))).map((e=>e.hex));(0,a.moveZombies)(e,t,o),[...c,...d].forEach((i=>{const n=(0,a.pickHexToEnter)(e,i,!1,!0);if(n){const a=e.warfare.getOccupyingUnit(n),r=e.regions.byHex(n)?.faction,c=(0,u.isUndeadTerritory)(e.state,i)&&!(0,u.isUndeadTerritory)(e.state,n);c&&r&&o.push({hexId:n.id,originalFactionId:r.id}),a?.hasTrait(l.PawnTraits.Unit)?t.create({hex:n,sourceHex:i,type:s.PawnType.Zombie,mergeData:{mergedWith:a?.id,outputType:s.PawnType.Zombie},captureHex:c,tapUnit:!1}):a?.type===s.PawnType.Town?(t.create({hex:n,sourceHex:i,type:s.PawnType.HauntedTown,defeatedUnit:{pawnId:a.id},captureHex:c,tapUnit:!1}),c||t.takeOverHex(n,e.factions.neutral)):t.create({hex:n,sourceHex:i,type:s.PawnType.Zombie,captureHex:c,defeatedUnit:a&&{pawnId:a.id},tapUnit:!1})}else i.neighbours().some((t=>(0,u.isUndeadTerritory)(e.state,t)))&&(0,u.collectManaToNearestUndeadTown)(t,i)})),e.map.plugins.has(p.PluginKey.SpawnGifts)&&(0,g.spawnPresents)(e,t);const y=n.GameStateEvents.ZombiesActed({convertedHexes:o,worldUpdates:t.getUpdates()});return[y,...(0,m.checkWinLoseConditions)(e,[y])]},t.getDangerousZombies=function(e){const t=[];for(let i of e.getTownHexes())for(let s of e.sameRegionNeighboursOf(i))d.Warfare.getOccupyingPawn(e.state,s)?.hasTrait(l.PawnTraits.Pest)&&t.push(s);return c.HexGroup.from(t)};const s=i(24598),n=i(36868),o=i(56824),a=i(53320),r=i(78933),l=i(63521),c=i(20693),d=i(78635),h=i(90824),u=i(52307),p=i(18497),g=i(87452),m=i(46471);o.logger.for("zombies")},4639:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Notifications=void 0;const s=i(897),n=i(61116),o=i(87521),a=i(20087),r=i(11466),l=i(20227),c=i(56824),d=i(1565),h=i(25e3),u=i(54825),p=i(9292),g={padding:20,spaceForIcon:50,tweenDuration:300,maxWidth:900},m={[r.UiVariant.Compact]:{...g,spacing:0,radius:0,playModeOffsetFromBottom:82,baseOffsetFromBottom:0},[r.UiVariant.Large]:{...g,spacing:10,radius:6,playModeOffsetFromBottom:200,baseOffsetFromBottom:20}},y=c.logger.for("Notifications");class f extends n.ResponsiveLayer{constructor(e){super(e,[]),this.pool=new o.Pool((()=>new d.NotificationToast(this))),this.displayedToasts=[],this.tweener=new l.Tweener(this.scene,{duration:this.layout.tweenDuration}),this.preUpdate=(0,s.whenDirty)((()=>{this.tweener.stop(),this.displayedToasts.forEach((e=>e.offset.stopTransition()));let e=(0,p.pickSmaller)(this.layout.maxWidth,this.scene.bounds.contentWidth-20);u.app.device.uiVariant()===r.UiVariant.Compact&&(e=this.scene.bounds.width),this.displayedToasts.forEach((t=>{t.width=e,t.alpha=1,t.preUpdate()}));const{x:t,y:i}=this.getToastAreaBottomCenter();a.Arrange.fromTopToBottomOld(this.displayedToasts,{x:t,y:i,originY:1,originX:.5,spacing:this.layout.spacing})}),(()=>super.preUpdate()))}get layout(){return m[u.app.device.uiVariant()]}addToast(e){h.NewsBox.hide();const t=this.pool.take();t.setProps(e),t.width=this.getToastWidth(),t.updateLayout(),this.add(t),this.displayedToasts.forEach((e=>{e.offset.transitionTo(e.offset.targetValue-(this.layout.spacing+t.height))}));const{x:i,y:s}=this.getToastAreaBottomCenter();if(t.setPosition(i-t.width/2,s),t.offset.transitionTo(s-t.height),this.tweener.add({targets:t,alpha:{from:0,to:1},ease:"Sine.easeIn"}),e.category){const t=this.displayedToasts.filter((t=>t.category===e.category));for(let e of t)this.closeToast(e)}return this.displayedToasts.push(t),t}handleToastResized(e,t){const i=this.displayedToasts.indexOf(e);-1!==i?this.displayedToasts.slice(0,i+1).forEach((e=>{e.offset.transitionTo(e.offset.targetValue-t)})):y.warning("invalid call to handleToastResized - object not found among displayed toasts",e)}closeToast(e){return new Promise((t=>{const i=this.displayedToasts.indexOf(e);if(-1===i)return t();this.displayedToasts.splice(i,1),this.displayedToasts.slice(0,i).forEach((t=>{t.offset.transitionTo(t.offset.targetValue+(this.layout.spacing+e.height))})),this.tweener.add({targets:e,alpha:0,onComplete:()=>{e.destroy(),t()},ease:"Sine.easeOut"})}))}clearToasts(e){const t=this.displayedToasts.filter((t=>e===d.NotificationScope.Global||e===d.NotificationScope.Screen&&t.scope!==d.NotificationScope.Global||t.scope===e));for(let e of t)this.closeToast(e)}clearToastsByCategory(e){const t=this.displayedToasts.filter((t=>t.category===e));for(let e of t)this.closeToast(e)}getToastAreaBottomCenter(){return{x:this.scene.bounds.width/2,y:this.scene.bounds.height-this.getOffsetFromBottom()}}getOffsetFromBottom(){return u.app.navigator.currentScreen===u.app.screen.play||u.app.navigator.currentScreen===u.app.screen.overworld?this.layout.playModeOffsetFromBottom:this.layout.baseOffsetFromBottom}getToastWidth(){return u.app.device.uiVariant()===r.UiVariant.Compact?this.scene.bounds.width:(0,p.pickSmaller)(this.layout.maxWidth,this.scene.bounds.contentWidth-20)}}t.Notifications=f},4782:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EMPTY_SPLIT_REGION_OUTPUT=t.FactionModel=void 0;const s=i(20693),n=i(68778),o=i(56824),a=i(10326),r=i(24598),l=i(97849),c=i(19618),d=i(56038),h=i(29172),u=i(1326),p=i(23382),g=i(70712),m=i(67274),y=i(78933),f=i(13602),w=i(31011),v=i(90952),b=i(20026),S=i(75136),x=i(83958),T=i(98490),P=i(91622),I=i(9292);o.logger.for("FactionsModel");class C extends n.BaseEntityModel{constructor(){super(...arguments),this.getCurrentPersonality=(0,h.lazyAdapter)({source:()=>this.state,transform:e=>(0,x.adjustPersonalityBasedOnSituation)(this)}),this.getRegions=(0,h.lazyAdapter)({source:()=>c.Factions.getFactionRegions(this.state,this.id),transform:e=>e.map((e=>d.Regions.model(this.state).byId(e)))}),this.getLiveRegions=(0,h.lazyAdapter)({source:()=>c.Factions.getFactionRegions(this.state,this.id),transform:e=>e.map((e=>d.Regions.model(this.state).byId(e))).filter((e=>e.isAlive()))})}data(){return c.Factions.getData(this.state,this.id)}get exists(){return!!this.data()}get name(){return this.data()?.name||""}get themeIndex(){return this.data()?.themeIndex||0}get landColorLight(){return Phaser.Display.Color.IntegerToColor(this.landColor).lighten(10).color}get landColor(){return P.inject.theme.getFactionColor(this.themeIndex)}get landColorDark(){return Phaser.Display.Color.IntegerToColor(this.landColor).darken(20).color}get size(){return this.getLiveRegions().map((e=>e.size)).reduce(I.sum,0)}get controller(){return this.data()?.controller}get persona(){return T.AIPersonas.get(this.data()?.persona)}get powerFactors(){return g.AI.getFactionPower(this.state,this.id).factors}get scaledPower(){return g.AI.getFactionScaledPower(this.state,this.id)}get rawPower(){return g.AI.getFactionRawPower(this.state,this.id)}get relativeScaledPower(){const e=this.scaledPower,t=this.parentModel.all().reduce(((e,t)=>t===this||!t.isAlive()||t.isNeutral()||e&&e.scaledPower>t.scaledPower?e:t),void 0);return t?e/(e+t.scaledPower):1e5}get relativeForecast(){const e=this.forecast,t=this.parentModel.all().filter((e=>e!==this&&!e.isNeutral())).map((e=>e.forecast)).reduce(I.pickLarger,0);return t?e/(e+(0,I.pickLarger)(t,.01)):1e5}get income(){return this.getRegions().reduce(((e,t)=>e+(0,I.pickLarger)(0,t.budget.balance)),0)}get confidence(){return(this.relativeScaledPower+this.relativeForecast)/2}get forecast(){return this.isAlive()?this.getRegions().reduce(((e,t)=>e+(0,I.pickLarger)(0,f.AIMetrics.snowballScale(t.forecast,1.25))),0):0}get basePersonality(){return this.data()?.aiPersonality??this.persona.personality}setAiPersonality(e){this.state=c.Factions.setData(this.state,this.id,{controller:r.FactionController.Ai,aiPersonality:{...this.basePersonality,...e}})}get hexes(){return s.HexGroup.union(this.getRegions().map((e=>e.hexes)))}get liveHexes(){return s.HexGroup.union(this.getRegions().filter((e=>e.isAlive())).map((e=>e.hexes)))}isAlive(){return this.controller!==r.FactionController.None&&!!this.getRegions().find((e=>e.isAlive()))}isLocalPlayer(){return this.controller===r.FactionController.LocalUser}isNeutral(){return this.id==m.SpecialFaction.neutral}getPawns(e){const t=(0,u.mergeArrays)(...this.getRegions().map((e=>e.getPawns())));return e?(0,a.filterPawns)(this.state,t,e):t}addNewRegion(e,t){const i=d.Regions.getNextId(this.state);return this.state=c.Factions.addNewRegion(this.state,this.id,e,t.toIdsArray(),i),d.Regions.model(this.state).byId(i)}disownRegions(...e){return this.state=c.Factions.disownRegions(this.state,...e.map((e=>e.id))),this}captureRegions(...e){this.state=c.Factions.captureRegions(this.state,this.id,...e.map((e=>e.id)));for(const t of e){if(!t.exists)continue;const e=t.getNeighbours().filter((e=>e.faction===this));if(e.length>0){const i=[t,...e],s=(0,u.findMax)(i,(e=>e.hexes.length));s.absorbRegions(i.filter((e=>e!==s)))}}return this}takeOverHex(e,i){const n=d.Regions.model(this.state),a=this.parentModel,r=n.byHex(e),h=r?.id;let p=i?.id;const g=!!r?.isAlive();if(r?.faction===this)return;let m=e.neighbours().map((e=>({region:n.byHex(e),faction:a.byHex(e)}))).filter((({region:e,faction:t})=>t===this)).map((({region:e,faction:t})=>e));m=(0,u.stripDuplicatesFrom)(m);const f=new w.MapMutationBuilder(v.GameState.regions.byHex).init(this.state);p?m=m.filter((e=>e.id!==i.id)):(p=m.pop()?.id,p||(p=d.Regions.getNextId(this.state),c.Factions.addNewRegion(this.state,this.id,o.random.townName(),[e.id],p))),f.set(e.id,p);let x=s.HexGroup.empty;const T=m.map((e=>e.id));if(m.length>0){x=s.HexGroup.union(m.map((e=>e.hexes)));for(let e of x)f.set(e.id,p)}const P=h?function(e,i,s,n=d.Regions.getNextId(e)){const a=s;if(!a)return t.EMPTY_SPLIT_REGION_OUTPUT;l.assert.defined(a);const r=c.Factions.getByRegion(e,a);l.assert.defined(r);const h=[],u=[],p=[];if(i.disjointedNeighbourGroups((t=>d.Regions.getByHex(e,t.id)===a)).getGroups().length<2)return t.EMPTY_SPLIT_REGION_OUTPUT;const g=d.Regions.model(e).byId(a).hexes.without(i).components();if(g.length>1)for(g.popLargestGroup();g.length>0;){let e=g.popLargestGroup(),t=n++;p.push(t),u.push(...e),h.push(d.RegionMutations.createRegion(t,o.random.townName()),d.RegionMutations.addHexesToRegion(t,e.toIdsArray()),c.FactionMutations.captureRegions(r,[t]))}return{splitOffHexes:u,mutations:h,splitOffRegionIds:p}}(this.state,e,h):t.EMPTY_SPLIT_REGION_OUTPUT;return(0,b.applyMutations)(this.state,...(0,S.mergeMutations)([f.createMutation("faction.takeOverHex")],P.mutations)),{type:y.UpdateType.HexTakeover,newFactionId:this.id,newRegionId:p,conqueredHex:e.id,connectedHexes:x.toIdsArray(),affectedHexes:s.HexGroup.union([e,x,s.HexGroup.from(P.splitOffHexes)]).toIdsArray(),victimRegionId:h,victimRegionWasAlive:g,splitOffRegions:P.splitOffRegionIds,affectedRegions:[p,...[r?.id].filter((e=>e)),...T,...P.splitOffRegionIds]}}ownsHex(e){return c.Factions.getByHex(this.state,e.id)===this.id}absorbOwnRegionsAdjacentTo(e){(0,l.assert)(this.ownsHex(e),`${e} is not owned by ${this}!`);const t=d.Regions.model(this.state),i=t.byHex(e);l.assert.defined(i);const s=Array.from(new Set(e.neighbours().map((e=>t.byHex(e))).filter((e=>e&&e!==i&&e.faction===this))));if(0===s.length)return[];const n=s.map((e=>({originalRegionId:e.id,hexes:e.hexes})));return i.absorbRegions(s),n}splitRegionIfDisconnected(e){const t=e.hexes.components(),i=[];if(t.length>1)for(t.popLargestGroup();t.length>0;){let e=t.popLargestGroup();i.push(this.addNewRegion(o.random.townName(),e))}return i}setController(e){this.state=c.Factions.setController(this.state,this.id,e)}toString(){return`[Faction #${this.id} "${this.name}"]`}getLargestLiveRegion(){const e=this.getLiveRegions();if(0!==e.length)return e.reduce(((e,t)=>t.hexes.length>e.hexes.length?t:e))}setLandColor(e){p.THEMES.default.factionColors[this.themeIndex]=e}fearOf(e){return g.AI.getFactionFear(this.state,this.id,e.id)}creditOf(e){return g.AI.getFactionCredit(this.state,this.id,e.id)}attitudeTowards(e){return g.AI.getFactionAttitude(this.state,this.id,e.id)}mergeAdjacentRegions(){for(let e of this.getRegions()){let t=e.getNeighbours().filter((e=>e.faction===this));for(;t.length;)e.addHexes(s.HexGroup.union(t.map((e=>e.hexes)))),e.parentModel.destroy(...t),t=e.getNeighbours().filter((e=>e.faction===this))}}}t.FactionModel=C,t.EMPTY_SPLIT_REGION_OUTPUT={mutations:[],splitOffHexes:[],splitOffRegionIds:[]}},5003:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveTextContainer=void 0;const s=i(86545);class n extends s.BaseResponsiveContainer{constructor(e,t){super(e),this.text=t,this.text.setOrigin(.5,.5),this.add(t)}updateLayout(){this.text.setPosition(this.width/2,this.height/2)}setTint(e){this.text.setTint(e)}}t.ResponsiveTextContainer=n},5116:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.PawnSymbolType=void 0,function(e){e.Arrow="0-arrow",e.Plus="1-plus",e.Confused="2-confused",e.Alert="3-alert",e.Warning="4-warning"}(i||(t.PawnSymbolType=i={}))},5178:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionBasedIsoRenderer=void 0;const s=i(15974),n=i(19618);t.FactionBasedIsoRenderer=class{constructor(e,t,i,s){this.id=e,this.scene=t,this.renderer=i,this.recipe=s,this.groupByFaction={},this.groupByHex={},this.rendersToTexture=this.recipe.renderToTexture??!1,this.debug=!1}shouldRun(e){return!0}postProcessImage(e,t){}getTint(e){}sync(e){this.shouldRun(e.state)&&("all"===e.hexesToSync?this.syncWithState(e):this.syncHexes(e))}syncWithState(e){const t=n.Factions.model(e.state);t.all().map((e=>this.getFactionGroup(e)));const i=Object.keys(this.groupByFaction).map((e=>Number(e)));for(const s of i){const i=t.byId(s);if(i){const t=i.hexes.filter((e=>this.shouldIncludeHex(i,e)));this.getFactionGroup(i).setHexes(t,e),t.forEach((e=>this.groupByHex[e.id]=this.groupByFaction[s]))}else this.groupByFaction[s].hexes.forEach((e=>delete this.groupByHex[e.id])),this.groupByFaction[s].clear(),this.groupByFaction[s].update()}}clear(){Object.values(this.groupByFaction).forEach((e=>e.clear())),this.groupByFaction={},this.groupByHex={}}syncHexes(e){if(!this.shouldRun(e.state))return;const t=e.hexesToSync,i=new Set;for(let s of t){const t=this.groupByHex[s.id],o=n.Factions.model(e.state).byHex(s),a=o&&this.getFactionGroup(o);t&&t!==a&&t.removeHexes(s,e),a?(this.groupByHex[s.id]=a,this.shouldIncludeHex(o,s)?a.addHexes(s,e):a.removeHexes(s,e)):delete this.groupByHex[s.id],a&&i.add(a),t&&t!==a&&i.add(t)}for(let e of i)e.update()}getFactionGroup(e){return void 0===this.groupByFaction[e.id]&&(this.groupByFaction[e.id]=new s.IsoTileGroupWithRenderer(this.recipe.frameIdBase+"/"+e.id,this.renderer,this.recipe,this.postProcessImage.bind(this,e),this.getTint(e))),this.groupByFaction[e.id]}}},5365:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.DialogButtons=void 0,function(e){e.OK="OK",e.Save="SAVE",e.Cancel="CANCEL",e.NewGame="START",e.Launch="LAUNCH",e.GiveUp="GIVE UP",e.Restart="RESTART",e.Load="LOAD",e.TurnStart="FIRST MOVE",e.TurnEnd="LAST MOVE",e.EndTurn="END TURN",e.Import="IMPORT",e.Keep="KEEP",e.DontImport="DON'T IMPORT",e.Wipe="DELETE ALL",e.Reset="RESET",e.Leave="LEAVE",e.Remove="REMOVE",e.Restore="RESTORE"}(i||(t.DialogButtons=i={}))},5833:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PassiveMode=void 0;const s=i(41569),n=i(12933);class o extends s.BaseMode{constructor(e){super(e),this.name="Passive"}isReadyForMoreGameEvents(){return!1}doHandleEvent(e){return(0,n.doHandleEvent)(this,e)}}t.PassiveMode=o},6217:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BlockTownAccessPlanner=void 0;const s=i(78635),n=i(56824),o=i(70712),a=i(1326),r=i(56038),l=i(89262),c=i(45664),d=i(13602),h=i(9292),u=i(20693),p=i(80268),g=i(19618),m=i(91622),y=i(76985),f=n.logger.for("BlockDefensePlanner");t.BlockTownAccessPlanner=class{constructor(e=3){this.maxAllowedMight=e,this.name="Block",this.isConquest=!1}async*generatePlans(e,t){if(e.faction.basePersonality.defenseSkill<.5)return;const i=e.region.getTownHexes().filter((e=>t.planningSecurity.get(e.id)<1));this.regionAssets=e.region.getMyAssets(),this.context=e,this.views=t,this.plans=[];for(let e of i)this.protectTown(e);for(let e of this.plans)yield e}protectTown(e){const t=this.context.state,i=s.Warfare.getHexDefenseWithoutMovableUnits(t,e),n=o.AI.getHexImportance(t,e.id).value,p=[],g=this.views.threatAssessment.calculateComponents(e.id).filter((e=>e.riskByDefenderMight[i]&&m.inject.views.perceivedThreat.get(t,{attackerRegionId:e.regionId,defenderRegionId:this.context.region.id})>=.4*this.context.focus.daring)).map((e=>e.regionId)),w=!!d.AIMetrics.getObviousGameEndingThreat(this.context.region,this.views.threatAssessment),v=w?this.regionAssets.getMaxAvailableMight():(0,h.pickSmaller)(this.regionAssets.getMaxRemainingSustainableMight(),2),b=(0,h.cropNumber)((0,h.pickSmaller)(this.views.threatAssessment.get(e.id).strongestUnit,v),1,2);if(0===b||0===g.length)return;let S=e.id;for(;!g.includes(r.Regions.getByHex(t,S));){const e=g.map((e=>o.AI.getHexInfluence(t,S,e)?.parent)).filter((e=>e));if(1!==(0,a.stripDuplicatesFrom)(e).length)break;S=e[0].id,this.isHexSuitableForDefender((0,c.getHex)(S))&&p.push((0,c.getHex)(S))}const x=r.Regions.getByHex(t,S)===this.context.region.id,T=(0,y.getMaxMightForHex)(this.context.state,(0,c.getHex)(S)),P=this.regionAssets.useUnit({requiredMight:b,allowNegativeIncome:w,incomeGain:x?0:1,maxAllowedMight:Math.min(this.maxAllowedMight,v,T.maxAllowedMight),bannedMightLevels:T.bannedMightLevels,allowOverkill:!0});if(!P)return void f.warning(`BlockDefense plan creation aborted for town at hex #${e.id}, could not muster unit with might ${b}`);const I=p.slice(-3).reverse(),C=p[0]?p[0].with(p[0].neighbours()):u.HexGroup.empty,M=e.neighbours().filter((e=>!(this.context.region.hexes.has(e)&&s.Warfare.getHexDefenseWithoutMovableUnits(this.context.state,e)>v)&&s.Warfare.canConquerHexWith(this.context.state,e,v))).sort(((e,t)=>C.has(e)!=C.has(t)?C.has(e)?-1:1:this.views.defenderBenefit.get(t.id)[v]-this.views.defenderBenefit.get(e.id)[v]));this.plans.push(new l.BlockTownAccessPlan({hex:(0,c.getHex)(S),townSecurityBaseLine:this.views.planningSecurity.get(e.id),candidateHexes:[...I,...M],townHex:e,might:b,maxMight:(0,h.pickSmaller)(this.maxAllowedMight,v),isLifeOrDeath:w,allowCastles:this.context.faction.persona.buildsCastles,utilityFactors:{threatReduction:n-70,conquestValue:this.views.conquestValue.get(S),joinRegionsBonus:0,eradicatePestBonus:0,diplomacyPenalty:0,mightInvestment:P.might,downstreamMovesBonus:0,economyHealth:d.AIMetrics.economyHealth(P.assets,this.context.focus),focusMismatchPenalty:1,vulnerabilityPenalty:1}}))}isHexSuitableForDefender(e){const t=this.context.state,i=r.Regions.getByHex(t,e.id),s=g.Factions.getByHex(t,e.id);if(i===this.context.region.id)return!0;const n=e.neighbours().members.some((e=>r.Regions.getByHex(t,e.id)===this.context.region.id)),a=!s||o.AI.isUnderAttackByRegion(t,this.context.region.id,s)||p.AIPolitics.getHostilityTowards(this.context.state,e,this.context.faction.id)>=.4;return n&&a}}},6528:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TileAttachmentsManager=void 0;const s=i(45664),n=i(20693),o=i(2543);t.TileAttachmentsManager=class{constructor(e,t,i,s){this.name=e,this.renderer=t,this.tiles=i,this.log=s,this.objectsByHex={},this.scene=this.renderer.scene}alreadyHas(e,t){const i=this.objectsByHex[e.id];if(i)return(0,o.isEqual)(i.options,t)}updateAll(e){for(let[t,i]of Object.entries(this.objectsByHex)){const n=(0,s.getHex)(Number(t));e(i.attachedObject,n,i.options)}}add(e,t){if(!this.alreadyHas(e,t)){if(this.objectsByHex[e.id])return this.objectsByHex[e.id].options=t,void this.updateObject(this.objectsByHex[e.id].attachedObject,e,t);{const i=this.tiles.getByHex(e.id);if(!i)return void this.log.warning(`cannot attach object to hex ${e} - no such tile found`);const s=this.createObject(e,t);this.objectsByHex[e.id]={attachedObject:s,options:t},this.attachObject(s,i)}}}set(e,t){for(let[t]of Object.entries(this.objectsByHex)){const i=(0,s.getHex)(Number(t));e.has(i)||this.remove(i)}for(let i of e)this.add(i,t)}setDiverse(e){const t=n.HexGroup.union(e.map((e=>e.hexes)));for(let[e]of Object.entries(this.objectsByHex)){const i=(0,s.getHex)(Number(e));t.has(i)||this.remove(i)}for(let{hexes:t,options:i}of e)for(let e of t)this.add(e,i)}update(e){const t=[];e(((e,i)=>t.push({hexes:e,options:i}))),this.setDiverse(t)}remove(e){this.objectsByHex[e.id]&&this.doRemoveObject(e,this.objectsByHex[e.id].attachedObject)}clear(){Object.entries(this.objectsByHex).forEach((([e,t])=>{this.doRemoveObject((0,s.getHex)(Number(e)),t.attachedObject)})),this.objectsByHex={}}doRemoveObject(e,t){const i=this.tiles.getByHex(e.id);this.removeObject(t,i),delete this.objectsByHex[e.id]}}},6772:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelDetailRow=t.LockedLevelsRow=void 0;const s=i(86545),n=i(80959),o=i(76049),a=i(96137),r=i(70033),l=i(20087),c=i(66143),d=i(18957),h=i(91622),u=i(87047);class p extends s.ResponsiveContainer{constructor(e){super(e);const t=n.UiBuilder.for(e);this.title=t.text("",o.BitmapFont.Small,a.Colors.glassUi_old.shapeLightAccent),this.icon=t.image("ui/level-icons/locked"),this.add([this.title,this.icon]),h.inject.theme.use((e=>{this.title.setTint(e.oceanShades.dark3),this.icon.setTint(e.oceanShades.dark3)}))}setCount(e){this.setVisible(e>0),this.title.setText(`${e} island${e>1?"s":""} left to unlock`)}updateLayout(){l.Arrange.leftToRight({content:[this.icon,this.title],x:20,spacing:8,origin:0}),l.Arrange.alignY({content:[this.icon,this.title],y:this.height/2,origin:.5})}}t.LockedLevelsRow=p;class g extends s.ResponsiveContainer{constructor(e){super(e),this.onClick=(0,d.signal)(),this.onPointerOver=(0,d.signal)(),this.onPointerOut=(0,d.signal)();const t=n.UiBuilder.for(e);this.title=t.text("",o.BitmapFont.Small,a.Colors.glassUi_old.shapeLightAccent),this.textAttachment=t.text("",o.BitmapFont.Small,a.Colors.glassUi_old.shapeLightAccent),this.icon=t.image(r.LevelIcons.Gold).setScale(.5),this.features=new u.LevelFeaturesGallery(e,{interactive:!1}),this.add([this.title,this.icon,this.features,this.textAttachment]),this.setInteractiveAuto(),this.on("pointerdown",(()=>{this.onClick.fire()})),this.on("pointerover",(e=>{this.onPointerOver.fire(e)})),this.on("pointerout",(e=>{this.onPointerOut.fire(e)})),this.updateStyle()}updateLayout(){l.Arrange.leftToRight({content:[this.icon,this.title],x:20,spacing:8,origin:0}),this.features.setPosition(this.width-this.features.width-20,this.height-7),this.textAttachment.x=this.width-this.textAttachment.width-20,l.Arrange.alignY({content:[this.icon,this.title,this.textAttachment],y:this.height/2,origin:.5})}updateStyle(){const e=h.inject.theme.getCurrent();this.title.setTint(e.oceanContrastLight),this.textAttachment.setTint(e.oceanContrastLight)}updateContent(e){const{level:t,showNumber:i,attachment:s}=e,n=i?`${t.expeditionContext?.levelData.ordinalNumber}. `:"";this.title.setText(`${n}${t.getTitle(c.LevelTitleStyle.Short)}`),this.icon.setFrame((0,r.getLevelIcon)(t.getLevelStatus())),this.features.updateState(t.getFeatures({includeIsNew:!0}));const o=t.userVictoryRecord?.turns;this.textAttachment.setText(o?`${o}t`:""),this.textAttachment.setVisible("turn-count"===s),this.features.setVisible("modes"===s),this.updateLayout()}}t.LevelDetailRow=g},6838:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TextInput=void 0,t.setKeyboardCaptureEnabled=a;const s=i(54306),n=i(54825);class o extends s.ResizableDOMElement{constructor(e,t){super(e,0,0,document.createElement("input"),t.customCss??""),this.props=t,this.hasFocus=!1;const i=this.node;i.readOnly=this.props.readOnly??!1,i.placeholder=this.props.placeholder??"",this.props.autoSelectAll&&(i.onclick=function(){this.focus(),this.select()}),this.props.onChange&&(i.oninput=()=>{t.onChange(i.value)}),i.onfocus=()=>{this.hasFocus=!0,a(!1)},i.onblur=()=>{this.hasFocus=!1,t.onBlur?.(this.text),a(!0)},i.innerText=this.props.text??"",this.setElement(i),this.setOrigin(0,0),t.height?this.height=t.height:i.style.height="auto",t.className?this.node.className=`game ${t.className}`:this.node.className="game",t.width&&(this.width=t.width)}get text(){return this.node.value}destroy(){super.destroy(),this.hasFocus&&a(!0)}setValue(e){this.node.value=e}focus(){this.node.focus()}selectAll(){this.node.select()}}function a(e){n.app.game.input.keyboard.enabled=e}t.TextInput=o},7169:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TextArea=void 0,t.setKeyboardCaptureEnabled=a;const s=i(54306),n=i(54825);class o extends s.ResizableDOMElement{constructor(e,t){super(e,0,0,document.createElement("textarea"),t.customCss??""),this.props=t,this.hasFocus=!1;const i=this.node;i.readOnly=this.props.readOnly??!1,i.placeholder=this.props.placeholder??"",i.maxLength=this.props.maxLength??999999,this.props.autoSelectAll&&(i.onclick=function(){this.focus(),this.select()}),this.props.onChange&&(i.oninput=()=>{t.onChange(i.value)}),i.onfocus=()=>{this.hasFocus=!0,a(!1)},i.onblur=()=>{this.hasFocus=!1,a(!0)},i.innerText=this.props.text??"",t.rows&&this.resizeToRows(t.rows),t.className?this.node.className=`game ${t.className}`:this.node.className="game",t.width&&(this.width=t.width),t.height&&(this.height=t.height),this.setElement(i),this.setOrigin(0,0)}resizeToRows(e){this.node.rows=e,this.node.style.height="auto"}get text(){return this.node.value}destroy(){this.node.remove(),super.destroy(),this.hasFocus&&a(!0)}setValue(e){this.node.textContent=e}setSize(e,t){this.width=e,this.height=t}setText(e){return this.node.value=e,this}}function a(e){n.app.game.input.keyboard.enabled=e}t.TextArea=o},7230:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MovesCache=void 0;const s=i(2543);t.MovesCache=class{constructor(){this.data=new Map}get(e,t){const i=this.data.get(e);if(i)for(let e of i)if((0,s.isEqual)(e.play,t))return e.result}set(e,t,i,s){let n=this.data.get(e);n||(n=[],this.data.set(e,n)),n.push({play:t,result:{state:i,events:s}})}flush(){this.data.clear()}}},7297:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScrollableText=void 0;const s=i(54306);class n extends s.ResizableDOMElement{constructor(e,t){super(e,0,0,document.createElement("div"),"\n    text-align: left;\n    overflow-y: auto;\n    font-size: 10pt;\n    font-family: sans-serif;\n"+(t.customCss??"")),this.props=t;const i=this.node;i.innerText=this.props.text??"",t.width&&(this.width=t.width),t.height&&(this.height=t.height),this.setElement(i),this.setOrigin(0,0)}get text(){return this.node.innerText}destroy(){this.node.remove(),super.destroy()}setSize(e,t){this.width=e,this.height=t}setText(e){return this.node.innerText=e,this}}t.ScrollableText=n},7334:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.OBJECT_TO_STRING_WHITELIST=t.TIMEOUT=void 0,t.str=function(e,t){if(void 0===e)return"";e=l(e);const i=(0,n.default)(e);return t&&i.length>t?i.slice(0,t)+"(...)":i},t.sizeOf=function e(t){return t?Array.isArray(t)?new Blob(t).size:"object"==typeof t?new Blob(Object.values(t)).size:e([t]):0},t.describeSize=function(e){return e<1e3?`${e} bytes`:e<1e6?`${(e/1e3).toFixed(1)} KB`:`${(e/1e6).toFixed(1)} MB`},t.replaceClassObjects=l,t.shallowStr=function(e){return(0,n.default)(e,((e,t)=>e&&t&&"number"!=typeof t?Array.isArray(t)?"[object Array]":""+t:t))},t.compressStr=function(e){return o.default.compress(e,{outputEncoding:"StorageBinaryString"})},t.decompressStr=function(e){return o.default.decompress(e,{inputEncoding:"StorageBinaryString"})},t.isDefined=function(e){return null!=e},t.deepFreeze=function e(t){const i=Object.getOwnPropertyNames(t);for(const s of i){const i=t[s];i&&"object"==typeof i&&e(i)}return Object.freeze(t)},t.withTimeout=function(e,i,s){return Promise.race([i,new Promise((i=>{e.time.addEvent({delay:s,callback:()=>i(t.TIMEOUT)})}))])},t.withSign=function(e,t=0){return e>=0?"+"+e.toFixed(t):e.toFixed(t)},t.prettyPrintObject=function e(i,s=0){if(null==i)return String(i);const n=Array(s+1).join(" ");return Object.entries(i).map((([i,o])=>null==o?`${n}${i}: `:Array.isArray(o)?0===o.length?`${n}${i}: `:"object"!=typeof o[0]?`${n}${i}: ${o.join(",")}`:`${n}${i}:\n${o.map((t=>e(t,s+2))).join(`\n${n}  \n`)}`:"object"==typeof o&&null!==o?o.constructor===Object?`${n}${i}:\n${e(o,s+2)}`:t.OBJECT_TO_STRING_WHITELIST.has(o.constructor.name)?`${n}${i}: ${o.toString()}`:`${n}${i}: [${o.constructor.name}]`:"number"==typeof o?`${n}${i}: ${d(o)}`:`${n}${i}: ${o}`)).join("\n")},t.numberToDots=function(e){return e>8?"":c[e]},t.dec2bin=function(e){return(e>>>0).toString(2)},t.isWholeNumber=function(e){return Math.floor(e)===e},t.singleton=function(e){let t;return{get:i=>(void 0===t&&(t=e(...i)),t)}},t.cleanse=function e(t){if(null==t)return t;if(Array.isArray(t))return t.map(e);if("object"==typeof t){const i={};for(let[s,n]of Object.entries(t))null!=n&&(i[s]=e(n));return i}return t},t.formatNumber=d,t.withOrdinalSuffix=function(e){var t=e%10,i=e%100;return 1==t&&11!=i?e+"st":2==t&&12!=i?e+"nd":3==t&&13!=i?e+"rd":e+"th"},t.isShallowEqual=function(e,t){for(var i in e)if(!(i in t)||e[i]!==t[i])return!1;for(var i in t)if(!(i in e)||e[i]!==t[i])return!1;return!0},t.simpleDateStamp=function(e=new Date){return`${e.getFullYear()}-${(0,r.padLeft)((e.getMonth()+1).toString(),2,"0")}-${(0,r.padLeft)(e.getDate().toString(),2,"0")}`};const n=s(i(81401)),o=s(i(95474)),a=i(1326),r=i(8358);function l(e){return"object"!=typeof e||null==e?e:Array.isArray(e)?e.map(l):"Object"!==e.constructor.name?`[${e.constructor.name}]`:(0,a.mapDictionary)(e,(e=>l(e)))}t.TIMEOUT=Symbol("TIMEOUT"),t.OBJECT_TO_STRING_WHITELIST=new Set(["UnitsByMight"]);const c=" ";function d(e){return e>=1e8?(e/1e6).toFixed()+"M":e>=1e5?(e/1e3).toFixed()+"K":e>=1e3?e.toFixed():parseFloat(e.toPrecision(3))}},7338:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createOrUpdateText=function(e,t,i){return t&&d(t,i)?t:(t?.destroy(),h(e,i))},t.tryUpdateText=d,t.createText=h;const s=i(50575),n=i(85711),o=i(76049),a=i(91622);var r=Phaser.GameObjects.BitmapText,l=Phaser.GameObjects.Text;const c={Cinzel32:{fontFamily:o.FontFamily.Cinzel,fontSize:"32px"},Cinzel20:{fontFamily:o.FontFamily.Cinzel,fontSize:"20px"},Cinzel16:{fontFamily:o.FontFamily.Cinzel,fontSize:"16px"},Roboto:{fontFamily:o.FontFamily.Roboto,fontSize:"14px"},RobotoMini:{fontFamily:o.FontFamily.Roboto,fontSize:"12px"},RobotoLarge:{fontFamily:o.FontFamily.Roboto,fontSize:"16px"}};function d(e,t){if("function"==typeof t.color)return!1;if(u(t)){if(t.bbCode&&e instanceof s.RichText||!t.bbCode&&e instanceof l)return e.setText((0,n.toValueAndRef)(t.text).value),e.setStyle(c[t.font]),t.color&&e.setTint(t.color),!0}else e instanceof r&&(e.setText((0,n.toValueAndRef)(t.text).value),e.setFont(t.font),void 0!==t.color&&e.setTint(t.color))}function h(e,t){const{text:i,color:o,font:d,bbCode:h}=t,{ref:p,value:g}=(0,n.toValueAndRef)(i);let m;if(u(d)){const t=c[d];m=h?new s.RichText(e,0,0,g,{wrap:{mode:1,width:0},...t}).setLineSpacing(3):new l(e,0,0,g,t)}else m=new r(e,0,0,d,g);return"function"==typeof o?a.inject.theme.use((e=>m.setTint(o(e))),m):void 0!==o&&m.setTint(o),p&&p.onChanged((e=>m.setText(e))),m}function u(e){return Object.values(o.VectorFont).includes(e)}},7548:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.themer=t.Themer=void 0;const s=i(91622),n=i(18957);class o{use(e){return this._signal(e),this.initializing||e(this.get()),this}constructor(e,t){this.target=e,this.defaultTheme=t,this.initializing=!0,this._signal=(0,n.signal)(),this.themeConsumer=t,s.inject.theme.use((e=>{this.initializing||(this._appliedTheme=this.themeConsumer(e),this.apply())}),this.target),this.initializing=!1}set(e){this.themeConsumer=e,this._appliedTheme=this.themeConsumer(s.inject.theme.getCurrent()),this.apply()}get(){return this._appliedTheme||(this._appliedTheme=this.themeConsumer(s.inject.theme.getCurrent())),this._appliedTheme}apply(){this._signal.fire(this.get())}}t.Themer=o,t.themer=(e,t)=>new o(e,t)},7701:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SceneInjector=void 0,t.setupInjectionContainer=function(e,t,i,f={},U={}){if(!t)throw new Error('No configuration found for ENVIRONMENT="production", unable to setup injection container!');const te=i,oe=new s.GameStateController,ae=new p.DeviceInfo(e),re=function(e){return e.mapRegistryUrls?new A.SimpleMapRegistry(new E.RestMapRegistryDataSource(e.mapRegistryUrls)):new A.SimpleMapRegistry(new B.MockMapRegistryDataSource)}(t),le={scale:(0,r.watchable)(1),withoutTransitions:ie,spectatingSpeed:(0,r.watchable)(V.SpectatingPlaybackSpeed.Fast),transitionsSpeed:(0,r.watchable)(L.TransitionsSpeed.Fast),skipTransitions:()=>O.inject.ui.transitionsSpeed()===L.TransitionsSpeed.Instant,hexUnderCursor:(0,a.watchableHexUnderCursor)(),defaultPointerAction:new z.DefaultPointerAction,regionsLedger:new m.RegionsLedger,stationaryUnits:new G.StationaryUnits,selectedLevelId:(0,r.watchable)(void 0),sidebarMode:(0,r.watchable)(void 0),pointerDragLock:new Y.TempMutex},ce={ai:new d.AIController,login:new _.LoginService(N.storage),debugBreakpoint:h.debugBreakPointProvider,mapRegistry:re,userData:new M.UserDataService(N.storage),userContent:new Z.UserContentService(new J.IDBUserContentStorage),gameStateController:oe,theme:new W.Theme,performance:new $.PerformanceController,ui:le,levelSession:new j.LevelSession,editorSession:new ee.EditorSession};(0,O.setCoreContext)(ce);const de={...ce,get currentGameState(){return oe.model.state},set currentGameState(e){oe.currentState!==e&&(u.assert.defined(e,"attempt to set current game state to undefined value"),oe.model.restore(e))},gameStateModel:oe.model,get plugins(){return oe.model.plugins},views:new v.ViewsManager,history:new n.GameStateHistory,mapRegistry:re,userDataCloudStorage:(0,K.isRunningAt)("kongregate")?new X.KongregateUserDataStorage:new X.FirebaseAuthUserDataStorage,userProgressStats:new q.ProgressStatsProvider(ce.userData),debugData:new o.DebugData,debugBreakpoint:h.debugBreakPointProvider,debugLayers:new c.WorldDebugLayersManager(F.getDefaultDebugLayers),scriptRunner:new I.LevelScriptRunner(new k.ScriptModulesRegistry),...f};(0,O.setCoreContext)(de);const he={game:e,appController:te,device:ae,audio:new l.AudioManager(e),fonts:new g.Fonts,navigator:new w.Navigator(e),scene:new se(e),screen:(0,b.createScreens)(),modals:new y.ModalsManager(e),notifications:new x.NotificationsManager,tooltips:new P.TooltipsManager,dropdowns:new Q.DropdownsManager,worldNews:new T.WorldNews,cloudSync:new D.CloudSyncService,analytics:new C.AnalyticsReporter,reporting:new S.Reporter,remoteConfig:new H.FirebaseRemoteConfig,getCurrentGameStateModel:ne,...U};(0,R.setAppContext)(he)};const s=i(97819),n=i(4419),o=i(39435),a=i(62277),r=i(96130),l=i(98963),c=i(75676),d=i(88410),h=i(3904),u=i(97849),p=i(11466),g=i(76049),m=i(17128),y=i(56643),f=i(81700),w=i(98760),v=i(76087),b=i(40244),S=i(76816),x=i(10237),T=i(42231),P=i(13659),I=i(94223),C=i(94382),M=i(43656),A=i(30221),B=i(27441),E=i(40021),O=i(91622),R=i(54825),k=i(63303),L=i(40951),_=i(70080),D=i(89413),H=i(11360),j=i(98121),F=i(64738),U=i(72273),G=i(1397),N=i(56824),V=i(16007),W=i(62367),z=i(81697),$=i(10131),Y=i(95922),K=i(13419),X=i(60181),q=i(73415),J=i(3767),Z=i(68188),Q=i(46265),ee=i(41671),te=i(68878);function ie(e){const t=O.inject.ui.transitionsSpeed();O.inject.ui.transitionsSpeed.set(L.TransitionsSpeed.Instant),e(),O.inject.ui.transitionsSpeed.set(t)}class se{constructor(e){this.game=e}get preload(){return this.game.scene.getScene(f.Scenes.Preload)}get worldMap(){return this.game.scene.getScene(f.Scenes.WorldMap)}get debug(){return this.game.scene.getScene(f.Scenes.Debug)}get debugHistory(){return this.game.scene.getScene(f.Scenes.DebugHistory)}get play(){return this.game.scene.getScene(f.Scenes.Play)}get playUI(){return this.game.scene.getScene(f.Scenes.PlayUI)}get titleScreenUI(){return this.game.scene.getScene(f.Scenes.TitleScreenUI)}get titleScreenFooterUI(){return this.game.scene.getScene(f.Scenes.TitleScreenFooterUI)}get mapEditorSidebar(){return this.game.scene.getScene(f.Scenes.MapEditorSidebar)}get mapEditorOverlay(){return this.game.scene.getScene(f.Scenes.MapEditorOverlay)}get menuHeaderUI(){return this.game.scene.getScene(f.Scenes.MenuHeaderUI)}get victory(){return this.game.scene.getScene(f.Scenes.Victory)}get defeat(){return this.game.scene.getScene(f.Scenes.Defeat)}get globalUI(){return this.game.scene.getScene(f.Scenes.GlobalUI)}get randomMapSelect(){return this.game.scene.getScene(f.Scenes.RandomMapSelectUI)}get sidePanelUI(){return this.game.scene.getScene(f.Scenes.SidePanel)}get backgroundUI(){return this.game.scene.getScene(f.Scenes.BackgroundUI)}get overworld(){return this.game.scene.getScene(f.Scenes.OverworldMap)}get overworldUI(){return this.game.scene.getScene(f.Scenes.OverworldUI)}get levelList(){return this.game.scene.getScene(f.Scenes.LevelList)}get expeditions(){return this.game.scene.getScene(f.Scenes.Expeditions)}get playMenuUI(){return this.game.scene.getScene(f.Scenes.PlayMenuUI)}get myLibraryUI(){return this.game.scene.getScene(f.Scenes.MyLibraryUI)}get dropdownUI(){return this.game.scene.getScene(f.Scenes.DropdownUI)}}function ne(){return N.config.debug.ai&&!(0,te.isViewingReplay)()?O.inject.gameStateModel:R.app.navigator.currentScreen===R.app.screen.play&&R.app.scene.play.cursor.isValid()&&R.app.scene.play.cursor.currentState!==O.inject.currentGameState?new U.StaticGameStateModel(R.app.scene.play.cursor.currentState):O.inject.gameStateModel}t.SceneInjector=se},7782:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Control=t.TransitionController=void 0;const s=i(46735),n=i(91622);class o{constructor(e,t){this.scene=e,this._destroyed=!1,this.currentValue=0,this.currentTarget=0,this.currentValue=t.initialValue||0,this.defaultTweenOptions={duration:500,ease:"Sine.easeOut",...t},this.applyValue=t.applyValue}setTo(e,t="instant"){return"transition"===t?(this.transitionTo(e),this):(this.tween&&(this.tween.stop(),this.tween=void 0),this.currentValue=e,this.currentTarget=e,this.applyValue(e,e),this)}async transitionTo(e,t){return new Promise((i=>{if(n.inject.ui.skipTransitions())return void this.setTo(e);if(this.currentTarget===e)return;this.currentTarget=e,this.tween&&this.tween.stop();const s=t?{...this.defaultTweenOptions,...t}:this.defaultTweenOptions;this.tween=this.scene.tweens.addCounter({from:this.currentValue,to:e,...s,onComplete:()=>{this.setTo(e),i()}}),this.tween.on("update",(()=>this.onTweenUpdated()))}))}applyCurrentValue(){this.applyValue(this.currentValue,this.currentTarget)}isInTransition(){return this.currentTarget!==this.currentValue}onTweenUpdated(){this.currentValue=this.tween.getValue(),this.applyValue(this.currentValue,this.currentTarget)}destroy(){this.tween?.destroy(),this.tween=void 0}}t.TransitionController=o,t.Control={visibilityOf:(e,t)=>new o(e.scene,{...t,initialValue:e.alpha,applyValue:t=>e.setAlpha(t)}),propOf:(e,t,i)=>new s.PropTransitionController(e.scene,e,t,{...i})}},7966:function(e,t,i){"use strict";var s,n=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(s=function(e){return s=Object.getOwnPropertyNames||function(e){var t=[];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[t.length]=i);return t},s(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i=s(e),a=0;a<i.length;a++)"default"!==i[a]&&n(t,e,i[a]);return o(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.SentryErrorHandler=void 0;const r=a(i(81797)),l=i(36868),c=i(56824),d=i(35800),h=i(51496),u=i(91622),p=i(54825),g=i(68243),m=i(37208),y=i(38620),f=i(55577),w=i(11585),v=i(80334),b=c.logger.for("Telemetry"),S=["Failed to start the audio device","Illegal invocation","The database connection is closing"],x=[f.FirebaseError],T=new Set([l.SystemEvents.ScreenActivated].map((e=>e.eventName)));function P(e){return e.extra={...e.extra,replay:(0,y.tryToEncodeCurrentReplay)()},e}function I(e){return e instanceof Error?(e.message||(e.message="Error without message"),{error:e,extras:{}}):"string"==typeof e?{error:new Error(e),extras:{}}:"object"==typeof e?{error:new Error(e.message??"Error without message"),extras:e}:{error:e,extras:{}}}t.SentryErrorHandler=class{constructor(e){this.gameRunning=!1,this.hadErrors=!1,this.tamperingDetected=!1,window.onunhandledrejection=e=>{console.error("window.onunhandledrejection",e.reason),this.handleException(e.reason),this.hadErrors=!0},window.onerror=(e,t,i,s,n)=>{t&&(this.handleException(n),this.hadErrors=!0)},r.init({enabled:e.reporting.sentry.enabled,dsn:e.reporting.sentry.dsn,environment:"production",release:"2.35.24-build-16101088196",beforeSend:P})}logEvent(e){T.has(e.name)||r.addBreadcrumb({type:"default",level:"debug",category:e.category,message:(0,l.describeEvent)(e)})}handleException(e){const{error:t,extras:i}=I(e),s=c.random.id(d.ID_TYPE.Error);let n=!1;this.gameRunning&&(A(t)?this.gameRunning&&u.inject&&c.events.trigger(l.SystemEvents.FatalError({correlationId:s,message:t.toString()})):b.info(`Error popup for ${t} was supressed`)),window.navigator.onLine?this.tamperingDetected?b.warning("Not reporting exception after unsupported operations were performed",t):this.gameRunning?(A(t)&&(r.setTag("correlationId",s),r.setTag("fatal",!0),r.captureException(t,{extra:{...i}})),h.track.exception({description:t.toString(),fatal:!0,correlation_id:s})):function(e){let t=Math.floor(1e6*Math.random()).toString();console.error(e),r.setTag("correlationId",t),r.setTag("fatal",!0),r.setTag("bootError",!0),r.captureException(e),window.document.getElementById("phaser-game")?.classList?.add("hidden"),setLoadingStatus(`Oh no! Something went wrong and the game failed to load :(<br/><br/>\nerror-id: ${t}\n`);const i=v.configProfiles.production.socials;setLoadingStatus(`Oh no! Something went really wrong and the game failed to load :(<br/><br/>\n    error-id: ${t}<br/><br/>\n    Please try refreshing the page. If the problem persists, you can ask me about the error id \n    on <a href='${i.discordUrl}'>discord</a> or via <a href='mailto:${i.email}?subject=Error ${t}"'>email</a>.`,!1),g.Firebase.analytics&&(0,m.logEvent)(g.Firebase.analytics,"exception",{description:`Failed to boot: ${e}`,correlation_id:t,fatal:!0,during_boot:!0})}(t):b.warning("Not reporting exception in offline mode",t)}handleNonFatalError(e,t){const{error:i,extras:s}=I(e);window.navigator.onLine?(console.warn(`[silent error: ${t}]`,i),A(i)&&(r.setTag("fatal",!1),r.setTag("backgroundErrorContext",t),r.captureException(i,{extra:{...s}})),h.track.exception({description:i.toString(),fatal:!1})):b.warning("Ignoring exception in offline mode",i)}initializeContext(){c.events.on(l.SystemEvents.UserSignedIn,(({userId:e})=>{r.setUser({id:e})})),c.events.on(l.UserActions.EditMap,(()=>{this.tamperingDetected=!0})),c.events.on(l.UserActions.InternalLoadGame,(()=>{this.tamperingDetected=!0})),c.events.on(l.UserActions.OpenLoadGameDialog,(()=>{this.tamperingDetected=!0})),r.setTags({scale:u.inject.ui.scale().toString(),logicalDpr:p.app.device.dpr,realDpr:window.devicePixelRatio??1,frameParent:p.app.device.frameParent,uiVariant:p.app.device.uiVariant().toString()}),c.events.on(l.SystemEvents.ScreenActivated,(({screen:e,previousScreen:t})=>{r.addBreadcrumb({type:"navigation",data:{from:t?.name,to:e?.name}})})),u.inject.ui.selectedLevelId.watch((e=>{r.setTag("levelId",e)}))}};const C=new w.RateLimiter(5,1),M=new w.RateLimiter(50,1440);function A(e){if(!C.check())return!1;if(!M.check())return!1;for(const t of x)if(e instanceof t)return!1;for(const t of S)if(e.message?.includes(t))return!1;return!0}},7986:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Telemetry=void 0;const n=i(91622),o=i(36868),a=i(54825),r=i(79815),l=i(68243),c=i(89413),d=i(56824),h=i(52031),u=i(83544),p=i(2543),g=s(i(81401)),m=i(76816),y=i(10131);d.logger.for("Telemetry"),t.Telemetry=class{constructor(){this.sampleThreshold=0,this.observe=new h.Observer((()=>a.app.remoteConfig.levelTelemetrySampleRate>this.sampleThreshold)),this.storedPendingEvents=new u.PersistentEntry("konkr.telemetryEvents.v1"),this.pendingEvents=[],this.initialize=(0,y.asyncInitializer)((()=>{this.sampleThreshold=d.random.numberBetween(0,1);const e=this.storedPendingEvents.take();if(e)for(let t of e)this.sendEvent(t);this.observe.event(o.SystemEvents.LevelSessionStarted,(e=>{this.sendEvent({type:"LEVEL_ENTER",origin:e.origin,device:{build:"2.35.24-build-16101088196",env:"production",realDpr:window.devicePixelRatio,logicalDpr:a.app.device.dpr,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,userAgent:window.navigator.userAgent,vw:window.innerWidth,vh:window.innerHeight,os:a.app.device.os(),touch:a.app.game.device.input.touch,uiVariant:a.app.device.uiVariant()},userId:n.inject.login.getUserId(),parentFrame:a.app.device.frameParent,levelId:e.levelId,aiDifficulty:e.aiDifficulty,levelSessionId:e.sessionId})})),this.observe.event(o.SystemEvents.LevelSessionOver,(e=>{this.sendEvent({type:"LEVEL_LEAVE",origin:e.origin,victoryDistance:e.victoryDistance,levelSessionId:e.sessionId,timestamp:e.timestamp,playLog:e.playLog,avgFps:e.avgFps,minFps:e.minFps,replay:e.replay,tampering:d.errors.tamperingDetected})})),this.observe.event(m.ReportingEvents.SubmitFeedbackForm,(e=>{e.levelId&&this.sendEvent({type:"LEVEL_FEEDBACK",levelId:e.levelId,userId:n.inject.login.getUserId(),mood:e.mood,comment:e.comment})}))})),this.scheduleTelemetryRequest=(0,p.debounce)(this.flushPendingEvents.bind(this),200,{trailing:!0})}sendEvent(e){this.pendingEvents.push(e),this.scheduleTelemetryRequest()}async flushPendingEvents(){const e=this.pendingEvents;if(0!==e.length){this.pendingEvents=[];try{if(!d.config.flags.telemetry)return;await(0,r.addDoc)((0,r.collection)(l.Firebase.db,c.Collections.telemetryEvents),{events:(0,g.default)(e),timestamp:(0,r.serverTimestamp)()})}catch(e){d.errors.handleNonFatalError(e,"Telemetry.sendEvent")}}}}},8062:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RestartDialog=void 0;const s=i(58609),n=i(80959),o=i(54118),a=i(96137),r=i(85711),l=i(36014),c=i(9292),d=i(76049);t.RestartDialog=class{constructor(){this.aiDifficultyRef=(0,r.ref)("medium")}getTitle(e){return e.title}getContent(e,t,i){return this.label||(this.label=n.UiBuilder.for(e).richText("",a.Colors.woodenUi.primaryText,d.VectorFont.RobotoLarge),this.toggle=new s.DifficultyToggle(e,{theme:l.ToggleThemes.wood,onSelected:e=>{this.aiDifficultyRef.set(e)}}),this.layout=n.UiBuilder.for(e).vLayout({content:[this.label,this.toggle],spacing:16,layoutPolicy:o.LayoutChildrenPolicy.None,originX:.5})),this.label.setText(t.message),this.label.setWordWrapWidth(i.width),this.aiDifficultyRef=t.aiDifficulty,this.toggle.setValue(t.aiDifficulty.current),this.toggle.setVisible(t.showDifficultySelector),this.layout.width=(0,c.pickLarger)(this.label.width,354),this.layout.updateLayout(),this.layout}getButtons(e){return e.buttons}}},8065:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.aggregateScoreFactors=function(e){return(e.conquestValue.total+e.joinRegionsBonus+e.downstreamMovesBonus+e.threatReduction+e.eradicatePestBonus)*(e.focusMismatchPenalty*e.economyHealth*e.vulnerabilityPenalty/e.mightInvestment)+e.diplomacyPenalty},t.describeScoreFactors=function(e){return`from conquered hex: ${e.conquestValue.total} \n${(0,s.prettyPrintObject)(e.conquestValue.factors,2)} \nfrom downstream potential: ${e.downstreamMovesBonus} \nfrom connecting regions: ${e.joinRegionsBonus}\nfrom threat reduction: ${e.threatReduction}\nfrom eradicating bandit: ${e.eradicatePestBonus}\n---\nmight investment: ${e.mightInvestment}\nfocus mismatch penalty: x${e.focusMismatchPenalty.toPrecision(2)}\neconomy health multiplier: x${e.economyHealth.toPrecision(2)}\nvulnerability multiplier: x${e.vulnerabilityPenalty.toPrecision(2)}\n---\ndiplomatic penalty: ${e.diplomacyPenalty}\n`};const s=i(7334)},8358:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.padRight=function(e,t){return e.length===t?e:e.length>t?e.slice(0,t):e+" ".repeat(t-e.length)},t.padLeft=function(e,t,i=" "){return e.length===t?e:e.length>t?e.slice(0,t):i.repeat(t-e.length)+e},t.prefixEachLineWith=function(e,t){return t.split("\n").map((t=>e+t)).join("\n")},t.compareStrings=function(e,t){return e>t?1:e<t?-1:0},t.stringToHash=function(e){var t,i=0;if(0===e.length)return i;for(e=e.toLowerCase(),t=0;t<e.length;t++)i=(i<<5)-i+e.charCodeAt(t),i|=0;return i},t.estimateReadingTimeMs=function(e,t=100){const i=e.trim().split(/\s+/).length+2;return Math.ceil(i/t*60*1e3)},t.addLineBreaks=function(e,t,i=!0){const s=t.split(" ");let n="",o=[];for(let t of s)n.length+t.length>e&&n.length>0&&(o.push(n.slice(0,-1)),n=""),n+=t+" ";return o.push(n.slice(0,-1)),i&&2===o.length&&o[1].length<e/2&&(o[0]+=" "+o[1],o.pop()),o.join("\n")},t.shortenText=function(e,t,i=["\n","."," "]){if(e.length<=t)return e;const s=e.slice(0,t);for(let e of i)if(-1!==s.lastIndexOf(e))return s.slice(0,s.lastIndexOf(e)+1).trim();return s.trim()},t.pluralize=function(e,t,i){return 1===e?`${e} ${t}`:`${e} ${i}`}},8458:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.userContentToStr=function(e){return`[${e.type} #${e.id} (${e.title})]`}},8482:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncJobQueue=t.QueueStatus=void 0,t.simpleAsyncJobQueue=function(){return new l((e=>e()))};const s=i(56824),n=i(34263),o=i(96130),a=i(10131);var r;s.logger.for("AsyncJobQueue"),function(e){e.Processing="processing",e.Paused="paused",e.Idle="idle"}(r||(t.QueueStatus=r={}));class l{constructor(e){this.jobRunner=e,this.pendingJobs=[],this.status=(0,o.watchable)(r.Idle),this.paused=!1,this.currentPromise=void 0,this.jobsCompletePromise=(0,n.controlledPromise)()}addJob(e){this.pendingJobs.push((()=>this.jobRunner(e))),this.startNextJobIfIdle()}startNextJobIfIdle(){if(this.currentPromise||this.paused)return;const e=this.pendingJobs.shift();if(!e)return this.status.set(r.Idle),this.jobsCompletePromise?.resolve(),void(this.jobsCompletePromise=void 0);this.jobsCompletePromise||(this.jobsCompletePromise=(0,n.controlledPromise)()),this.status.set(r.Processing),this.currentPromise=e().then((()=>{this.currentPromise=void 0,(0,a.sleep)(0).then((()=>{this.startNextJobIfIdle()}))}))}async jobsComplete(){if(this.jobsCompletePromise)return this.jobsCompletePromise}pause(){this.paused||(this.status.set(r.Paused),this.paused=!0)}resume(){this.paused&&(this.paused=!1,this.startNextJobIfIdle())}clear(){this.pendingJobs=[]}}t.AsyncJobQueue=l},8570:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleFactionTurnStarted=function({state:e,factionId:t}){const i=h.inject.gameStateModel.factions.byId(t);r.assert.defined(i);const b=u.app.scene.play,S=(0,v.isAISpectatingMode)();if(function(e){return w.Factions.model(e).all().some((e=>e.controller===a.FactionController.LocalUser&&e.isAlive()))}(e)||(0,v.isAISpectatingMode)()){switch(i.controller){case a.FactionController.LocalUser:if(S)return void f.events.trigger(n.UserActions.EndTurn({force:!0}));f.config.autoSaveOnTurnStart&&h.inject.levelSession.saveLevelProgress(),b.setMode(new s.PlayMode(b)),b.worldMapScene.syncTownVariantInAllRegions(e),h.inject.ui.regionsLedger.reset(e),h.inject.ui.stationaryUnits.initialize(),d.WorldMapUpdater.setPawnJumpingInRegions(i.getLiveRegions()),u.app.screen.play.selectRegion(h.inject.ui.regionsLedger.getNextPendingRegionId(),{clickEffect:!1,panCamera:!1}),b.uiScene.updateFromGameState(h.inject.currentGameState,"play"),setTimeout((()=>{0===g.CurrentPhase.model(e).tappedUnits().length&&!1!==h.inject.userData.recallChoice("rivalsSurrender")&&h.inject.ai.allowSurrender&&!h.inject.levelSession.dismissedSurrender&&(0,p.shouldOfferSurrender)(e)&&function(e){if(u.app.notifications.claimVictory(),"on"===h.inject.userData.recallChoice("rivalAIChatter")){const t=new Set;for(let i of e.parentModel.all().filter((e=>e.isAlive()&&e.controller===a.FactionController.Ai))){const s=i.getLargestLiveRegion()?.getTownHexes().first();if(s){const n=(0,y.generateChatter)(i.getLargestLiveRegion(),e,{requiredTags:["surrendering"],bannedPhrases:t});n&&(t.add(n),u.app.scene.worldMap.overlays.attitudeEmojis.showChatter(s,n,void 0,f.random.integerBetween(0,300)))}}}}(i)}),1);break;case a.FactionController.Ai:f.config.autoSaveOnTurnStart&&h.inject.levelSession.saveLevelProgress(),b.mode instanceof o.SpectatorMode||b.setMode(new o.SpectatorMode(b)),h.inject.ai.play(i).then((async e=>{"session-aborted"===e||h.inject.gameStateController.hasLocalPlayerWon()||h.inject.gameStateController.executePlay(n.Plays.EndTurn())}));break;case a.FactionController.None:i.id===c.SpecialFaction.neutral&&(b.mode instanceof o.SpectatorMode||b.setMode(new o.SpectatorMode(b)),h.inject.gameStateController.executePlay(n.Plays.BanditsAct())),h.inject.gameStateController.executePlay(n.Plays.EndTurn());break;default:throw new Error(`Faction ${i} uses unsupported controller ${i.controller}`)}b.uiScene.updatePowerBalanceFromGameState(h.inject.currentGameState),f.config.debug.checkWorldMapIntegrity&&(0,l.verifyWorldMapInSync)(b.worldMapScene,e)}else(0,m.handleGameOver)({winningFactionId:void 0,state:h.inject.currentGameState})};const s=i(79694),n=i(36868),o=i(97869),a=i(24598),r=i(97849),l=i(31722),c=i(67274),d=i(77563),h=i(91622),u=i(54825),p=i(86183),g=i(45084),m=i(32408),y=i(52724),f=i(56824),w=i(19618),v=i(53360)},8971:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AI_PERSONALITY_PRESETS=t.DEFAULT_AI_PERSONALITY=t.DEFAULT_AI_PERSONA=void 0,t.adjustMultiplierByFocus=function(e,t){const i=2*t;return Math.pow(e,i)},t.DEFAULT_AI_PERSONA="king",t.DEFAULT_AI_PERSONALITY={combative:.4,daring:.5,honorable:.5,thrifty:.5,ambitious:.5,attackSkill:1,defenseSkill:1},t.AI_PERSONALITY_PRESETS={competitive:t.DEFAULT_AI_PERSONALITY,roleplaying:{...t.DEFAULT_AI_PERSONALITY,ambitious:0,defenseSkill:.3,attackSkill:.3},maniac:{...t.DEFAULT_AI_PERSONALITY,daring:1,combative:.75,ambitious:1},neutral:{...t.DEFAULT_AI_PERSONALITY,ambitious:0,honorable:0}}},9185:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LEVEL_FEATURES=t.DIFFICULTY_HARD=t.DIFFICULTY_NORMAL=void 0,t.getLevelFeatures=function(e){const t=[],i=e.map.plugins;i.has(s.PluginKey.PickLandingSpot)&&t.push("kings-landing"),e.factions.all().some((e=>e.persona.race===o.Race.Undead))&&t.push("necromancer");const a=e.pawns.select({type:[n.PawnType.UniqueHero]});return a.length>0&&(a.some((e=>e.name?.toLowerCase().includes("rosaline")))?t.push("unique-hero-rosaline"):t.push("unique-hero")),i.has(s.PluginKey.Zombies)&&t.push("zombies"),i.has(s.PluginKey.CaptureTowns)&&t.push("capture-towns"),i.has(s.PluginKey.AlwaysRetreat)&&t.push("always-retreat"),i.has(s.PluginKey.SpawnGifts)&&t.push("spawn-gifts"),i.has(s.PluginKey.BuyGifts)&&t.push("buy-gifts"),i.has(s.PluginKey.BuyTowns)&&t.push("buy-towns"),t};const s=i(18497),n=i(24598),o=i(90824);t.DIFFICULTY_NORMAL={id:"difficulty-normal",description:"Playing on normal difficulty."},t.DIFFICULTY_HARD={id:"difficulty-hard",description:"Playing on hard difficulty."},t.LEVEL_FEATURES={new:{description:"This level was added to the expedition in a recent update."},"difficulty-normal":{description:"Playing on normal difficulty."},"difficulty-hard":{description:"Playing on hard difficulty."},necromancer:{description:"Hostile necromancer is present.",helpDocument:"modes/necromancers"},zombies:{description:"Undead are present.",helpDocument:"modes/zombies"},"unique-hero":{description:"Unique hero is present.",helpDocument:"modes/unique-heroes"},"unique-hero-rosaline":{description:"Unique hero is present.",helpDocument:"modes/unique-heroes"},"kings-landing":{description:"Choose your landing zone."},"capture-towns":{description:"Towns get captured instead of razed."},"always-retreat":{description:"Defeated units always retreat."},"spawn-gifts":{description:"New presents spawn on the island each turn."},"buy-gifts":{description:"You can buy and give presents to your neighbours."},"buy-towns":{description:"You can buy towns new towns."}}},9292:(e,t)=>{"use strict";function i(e,t){return Math.log(t)/Math.log(e)}function s(e){return e>=0?1:-1}function n(e,t,i){return Math.min(i,Math.max(t,e))}Object.defineProperty(t,"__esModule",{value:!0}),t.pickSmaller=t.pickLarger=t.sum=t.Probability=void 0,t.logWithBase=i,t.sign=s,t.deltaToMultiplier=function(e){return n(.8*i(3,Math.pow(Math.abs(e),.7)+1)*s(e)+1,.25,2)},t.cropNumber=n,t.Probability={ofEither:(e,t)=>1-(1-e)*(1-t),ofAny:(...e)=>1-e.map((e=>1-e)).reduce(((e,t)=>e*t),1),ofEvery:(...e)=>e.reduce(((e,t)=>e*t),1)},t.sum=(e,t)=>e+t,t.pickLarger=(e,t)=>e>=t?e:t,t.pickSmaller=(e,t)=>e>=t?t:e},9537:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.UndoAvailability=void 0,function(e){e.Unavailable="unavailable",e.RollbackOnly="rollback-only",e.Available="available"}(i||(t.UndoAvailability=i={}))},9557:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveDOMContent=void 0;var s=Phaser.GameObjects.DOMElement;const n=i(9292);function o(e){e.stopPropagation()}t.ResponsiveDOMContent=class extends s{constructor(e,t,i={}){super(e,0,0),this.cacheItem=t,i={suppressEvents:!0,...i},this.createFromCache(t),this.setOrigin(0,0),this.rootDiv=this.node,this.node.style.transform="translate(-10000px, -10000px)",this.node.style.left="0px",Object.defineProperties(this,{width:{set:e=>{this.node.style.width=`${e}px`},get:()=>this.node.offsetWidth},height:{set:e=>{this.node.style.height=`${e}px`},get:()=>(0,n.pickLarger)(this.node.offsetHeight,this.displayHeight)}}),this.addListener("click mouseup mousedown touchstart touchend"),i.suppressEvents&&(this.on("mousedown",o),this.on("mouseup",o),this.on("touchstart",o),this.on("touchend",o))}preUpdate(){this.scene.scene.isVisible()||(this.rootDiv.style.display="none"),this.parentContainer?.willRender(this.scene.cameras.main)||(this.rootDiv.style.display="none")}}},9767:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FilteredMultiMapProjection=void 0;const s=i(83874),n=i(20026);class o extends s.MultiMapDataSet{constructor(e,t,i=[]){super(e),this.key=e,this.filteredDataSet=t,this.parents=[t,...i]}bootstrap(e){return(0,n.selectFromState)(e,this.filteredDataSet).map((t=>t.filter((t=>this.constraint(e,t))))).filter((e=>!e.isEmpty())).map((t=>t.map((t=>this.transform(e,t)))))}update(e,t,i){const n=t.of(this.filteredDataSet);if(!n)return;const o=new s.MultiMapMutationBuilder(this,e);return n.updated?.forEach((t=>{let s=t.id;if(t.added&&o.add(s,...t.added.filter((t=>this.constraint(e,t))).map((t=>this.transform(e,t)))),t.removed){const n=this.getEntryById(e,s);if(!n)return;o.remove(s,...t.removed.filter((e=>this.constraint(i,e))).map((e=>this.transform(i,e))).filter((e=>n.has(e))))}})),o.createMutation(this.filteredDataSet.key)}}t.FilteredMultiMapProjection=o},10131:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PerformanceController=void 0,t.sleep=n,t.asyncInitializer=function(e){let t=null,i=!1;const s=()=>t||(t=Promise.resolve().then(e).then((e=>(i=!0,e))),t);return s.wasSuccessful=()=>i,s.reset=()=>{i=!1,t=null},s};const s=i(9292);function n(e){return new Promise((t=>setTimeout(t,e)))}t.PerformanceController=class{constructor(){this.avgFrameTimeMs=0,this.rerenderIntervalMs=16,this.lastRenderTimestamp=0}async preventFreeze(){const e=performance.now();if(this.lastRenderTimestamp+this.rerenderIntervalMs<e){const t=performance.now();await n(0);const i=performance.now()-t;this.avgFrameTimeMs=(4*this.avgFrameTimeMs+i)/5,this.lastRenderTimestamp=e,this.rerenderIntervalMs=(0,s.pickLarger)(16,2*this.avgFrameTimeMs)}}}},10237:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NotificationsManager=t.DETAILED_NOTIFICATIONS_WHITELIST=void 0;const s=i(87790),n=i(1565),o=i(28454),a=i(80959),r=i(51496),l=i(91622),c=i(54825),d=i(2195),h=i(79611);t.DETAILED_NOTIFICATIONS_WHITELIST=["intro1","l-intro-castles-v2","l-fracture"],t.NotificationsManager=class{constructor(){this.displayedFeedbackToast=void 0}get ui(){return this._builder||(this._builder=a.UiBuilder.for(c.app.scene.globalUI)),this._builder}get scene(){return c.app.scene.globalUI}add(e){return c.app.scene.globalUI.notifications.addToast(e)}close(e){c.app.scene.globalUI.notifications.closeToast(e)}toggleFeedback(){this.displayedFeedbackToast&&this.displayedFeedbackToast.visible?this.close(this.displayedFeedbackToast):(this.displayedFeedbackToast=(0,o.showFeedbackForm)(),r.track.interaction("open_feedback_form"))}askForLevelFeedback(e){this.displayedFeedbackToast&&this.displayedFeedbackToast.visible||setTimeout((()=>{this.displayedFeedbackToast=(0,o.askForLevelFeedback)(e)}),500)}uncaughtError(e){(0,s.showErrorNotification)(this.scene,e)}isTutorialLevel(){return t.DETAILED_NOTIFICATIONS_WHITELIST.includes(l.inject.levelSession.levelId)}movePreventedByPawn(e,t){if(0===t.length)return;if(!this.isTutorialLevel())return;const i=t.reduce(((e,t)=>t.might>e?.might?t:e));if(i.might>3)return;let s=i.faction===l.inject.gameStateModel.currentPhase.faction?`Cannot place ${e} on a tile that already has ${i.type}`:`This tile is protected by an enemy ${i.type}. We needed a stronger unit to capture it!`;this.add({category:n.NotificationCategory.InvalidUserActionHint,style:n.NotificationStyle.Default,scope:n.NotificationScope.Screen,timeout:2500,clickable:!0,icon:this.ui.image((0,h.getPawnRenderRecipe)(i.type).getFrame()),cancelTimeoutOnHover:!1,content:this.ui.glassUi.caption(s)})}regionDisaster(e,t,i){const s=this.add({style:n.NotificationStyle.Default,scope:n.NotificationScope.Screen,timeout:5e3,clickable:!0,icon:this.ui.image("ui/icons/alert"),cancelTimeoutOnHover:!0,content:this.ui.vLayout({spacing:10,content:[this.ui.glassUi.caption(e),this.ui.glassUi.paragraph(t)]}),onClicked:()=>{this.close(s);const e=i&&l.inject.gameStateModel.regions.byId(i);e&&e?.exists&&e.isAlive()&&c.app.screen.play.selectRegion(i,{clickEffect:!1,panCamera:!0})}});return s}warning(e,t,i=5e3){return this.add({style:n.NotificationStyle.Alert,scope:n.NotificationScope.Global,timeout:i||void 0,clickable:!0,icon:this.ui.image("ui/icons/alert"),cancelTimeoutOnHover:!0,content:this.ui.vLayout({spacing:10,content:[this.ui.glassUi.caption(e),this.ui.glassUi.paragraph(t)]})})}info(e,t,i="ui/icons/mail",s=5e3){return this.add({style:n.NotificationStyle.Default,scope:n.NotificationScope.Global,timeout:s||void 0,clickable:!0,icon:this.ui.image(i),cancelTimeoutOnHover:!0,content:this.ui.vLayout({spacing:10,content:[this.ui.glassUi.caption(e),this.ui.glassUi.paragraph(t)]})})}success(e,t,i="ui/icons/mail"){return this.add({style:n.NotificationStyle.Success,scope:n.NotificationScope.Global,timeout:5e3,clickable:!0,icon:this.ui.image(i),cancelTimeoutOnHover:!0,content:this.ui.vLayout({spacing:10,content:[this.ui.glassUi.caption(e),this.ui.glassUi.paragraph(t)]})})}claimVictory(){return this.add({style:n.NotificationStyle.Default,scope:n.NotificationScope.Level,category:n.NotificationCategory.SurrenderOffer,clickable:!1,icon:this.ui.image("ui/icons/campaign"),cancelTimeoutOnHover:!0,content:new d.SurrenderForm(c.app.scene.globalUI),onDismissed:()=>{l.inject.levelSession.onDismissedSurrender()}})}}},10326:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnModel=void 0,t.filterPawns=function(e,t,i){return i.type&&(t=t.filter((e=>i.type.includes(e.type)))),i.traits&&(t=t.filter((e=>i.traits.every((t=>e.hasTrait(t)))))),t};const s=i(68778),n=i(63521),o=i(81434),a=i(19162),r=i(56038),l=i(19618),c=i(45084),d=i(45664);class h extends s.BaseEntityModel{get exists(){return!!o.Pawns.getPawnData(this.state,this.id)}get name(){return o.Pawns.getPawnData(this.state,this.id)?.name||""}get type(){return o.Pawns.getPawnData(this.state,this.id).type}get count(){return o.Pawns.getPawnCount(this.state,this.id)||0}get traits(){return this.rules?.traits}get cost(){return this.rules.cost}get upkeep(){return this.rules.upkeep}get income(){return this.rules.income}get might(){return this.rules.might}get defenseMight(){return this.rules.defenseMight}get protection(){return this.hasTrait(n.PawnTraits.GuardsAdjacentTiles)?this.rules.defenseMight:0}get rules(){return a.Rules.model(this.state).pawns(this.type)}get region(){return r.Regions.model(this.state).byHex(this.hex)}get faction(){return l.Factions.model(this.state).byHex(this.hex)}hasTrait(e){return this.traits.includes(e)}get hex(){return(0,d.getHex)(o.Pawns.getPawnHex(this.state,this.id))}replaceWith(e){const t=this.hex,i=o.Pawns.getNextId(this.state);return this.state=o.Pawns.replacePawn(this.state,this.id,e,i),this.parentModel.byHex(t,e)}isMovable(){return c.CurrentPhase.isMovable(this.state,this.id)&&this.region?.isAlive()}isInvincible(){return this.might>=10}moveTo(e){return this.state=o.Pawns.movePawn(this.state,this.id,e.id),this}setCount(e){return this.state=o.Pawns.setPawnCount(this.state,this.id,e),this}toString(){const e=this.type+(void 0!==this.count&&1!==this.count?`${this.count}`:"");return`[Pawn #${this.id} (${e} at ${this.hex})]`}destroy(){this.parentModel.destroy(this)}}t.PawnModel=h},10711:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.colorizeRegions=async function(e,t,i,l,u){let p={},g=new Set(t.shuffle(i));const m=Math.ceil(o.HexGroup.union(i.map((e=>e.hexes))).length*l.coloration),y=Math.ceil(m/l.factions.length),f={},w={},v={};let b=new Set;if(l.factions[0].banCoastalProvinces){const t=c.inject.views.landingSpots.get(e.state),s=t.with(t.neighbours());for(let t of s)b.add(e.regions.byHex(t));for(let e of i)e.size>4&&b.add(e)}const S=(0,r.getFactionsFromConfig)(e,l.factions);for(let e of S){const t=Math.round(l.factions[e.id-1].startingTilesMultiplier??1);f[e.id]=y*t,w[e.id]=0,v[e.id]=(0,d.pickLarger)(1,Math.round(t))}for(let t of i)p[t.id]=new Set(S),b.has(t)&&p[t.id].delete(e.factions.byId(1));for(;g.size;){await u();const e=x(g);if(!e){h.warning(`Failed to assign any faction to the ${g.size} remaining region(s)`);break}const t=T(e);t&&(t.captureRegions(e),f[t.id]-=e.size,w[t.id]+=e.size,P()),g.delete(e)}0!==(l.factions[0].townsMultiplier??l.factions[0].startingTilesMultiplier)&&0===w[1]&&e.factions.byId(1).captureRegions(t.oneOf(i));for(let t of o.HexGroup.union(Array.from(g).map((e=>e.hexes))))e.pawns.create({hex:t,type:s.PawnType.Swamp});function x(e){if(l.coloration>.7)return(0,n.findMin)(Array.from(e),(e=>p[e.id]?.size||1/0));{const i=e=>e.getNeighbours().filter((e=>!e.faction?.isNeutral())).length;return t.boolean(l.clustering)?(0,n.findMax)(Array.from(e),i):(0,n.findMin)(Array.from(e),i)}}function T(e){const t=p[e.id];if(t?.size)return(0,n.findMax)(Array.from(t),(e=>f[e.id]))}function P(){for(let t of g)for(let i of p[t.id])i.getRegions().length>=v[i.id]&&f[i.id]<t.size/2&&p[t.id].delete(i),c.inject.views.factionInfluenceByRegion.get(e.state,{influencingFaction:i.id,targetRegion:t.id,maxDistance:l.cellSeparation,powerMeasurement:a.PowerMeasurement.RegionSize}).total>0&&p[t.id].delete(i)}};const s=i(24598),n=i(1326),o=i(20693),a=i(23867),r=(i(18957),i(45664),i(62049)),l=i(56824),c=i(91622),d=i(9292),h=l.logger.for("colorizeRegions")},10809:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EditorMode=void 0;const s=i(90379),n=i(25098),o=i(54825);class a extends s.BaseWorldMapMode{constructor(){super(...arguments),this.handlesPointerEvents=!0,this.allowsJumpingPawns=!1}activate(){super.activate(),o.app.device.disableContextMenu(),this.scene.editorOverlay||(this.scene.editorOverlay=new n.WorldMapEditorOverlay(this.scene)),this.scene.editorOverlay.setVisible(!0),this.scene.editorOverlay?.update()}deactivate(){this.scene.editorOverlay?.setVisible(!1),o.app.device.enableContextMenu()}onSyncState(e){this.scene.editorOverlay?.update()}isHexInteractive(e){return!1}}t.EditorMode=a},10990:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HostilityView=void 0;const s=i(90952),n=i(20754),o=i(56824),a=i(76439),r=i(91622),l=i(80268),c=i(78436),d=i(97849),h=i(7334);o.logger.for("HostilityView");class u extends n.LazyView{constructor(){super([s.GameState.ai.powerByRegion,s.GameState.ai.credit]),this.name="attitude"}calculate(e,{victim:t,attacker:i}){return l.AIPolitics.getHostilityTowards(e,t,i.id)}getCacheKey(e){return`${e.attacker.id}->${e.victim.id}`}getDebugLayer(e){const t=r.inject.gameStateModel.regions.byId(e),i=this;return d.assert.defined(t),new a.GameStateDebugLayer((0,c.regionBasedAdapter)({getValue:(s,n)=>{const o=r.inject.gameStateModel.regions.byId(n);if(o&&n!==e)return i.get(s,{attacker:o.faction,victim:t.faction}).toFixed(2)},getDetail:(s,n)=>{const o=r.inject.gameStateModel.regions.byId(n);if(o&&n!==e)return(0,h.prettyPrintObject)(l.AIPolitics.getHostilityFactors(s,t.faction,o.faction.id))+"\nTOTAL: "+i.get(s,{victim:t.faction,attacker:o.faction}).toFixed(2)}}))}}t.HostilityView=u},11079:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSpatial=function(e){return e.hasOwnProperty("x")},t.isTabular=function(e){return e.hasOwnProperty("r")},t.isOrdinal=function(e){return"number"==typeof e},t.ordinalToTabular=function(e){return{r:Math.floor(e/s.GRID_MAX_DIMENSION),c:Math.floor(e%s.GRID_MAX_DIMENSION)}},t.tabularToSpatial=function({r:e,c:t}){return{x:t-e%2/2,y:e}},t.tabularToOrdinal=function({r:e,c:t}){return e*s.GRID_MAX_DIMENSION+t},t.spatialToTabular=function({x:e,y:t}){return{r:t,c:Math.ceil(e)}};const s=i(45664)},11255:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.developmentConfig=void 0;const s=i(13419),n=i(60681);t.developmentConfig={...n.common,mode:"standard",mapRegistryUrls:["assets/content.json"],debug:{datgui:{expand:!1,sections:{debug:"on",factions:"on",level:"on",mapgen:"on",colors:"on",palette:"expanded"}},overlay:!0,dataFilter:"",ai:!1,breakpoints:["ai"],cheats:!0,chunkBorders:!1,isoTiles:!1,gameObjects:!0,objectPools:!0,recordStateChanges:!1,uiLayout:!1,integrityChecks:{pawns:!1,gameState:!1},checkWorldMapIntegrity:!1,tweenSpeedFactor:1,loadTestMaps:!0,gameHistory:!0},allowEditing:!1,editOverworld:!1,autoSaveOnTurnStart:!0,autoSaveOnTurnEnd:!0,serviceWorker:{enabled:!1,scope:"http://localhost:3000/"},antialiasing:!0,screenTransitionDuration:300,feedbackPrompts:{expeditions:["x-community-maps"]},flags:{cloudSync:!1,skipTutorial:!1,seeEnemyAttitudes:!1,mergeMutations:!0,avoidBottomRightCorner:(0,s.isRunningAt)("itch"),fullScreenToggleButton:!(0,s.isRunningAt)("itch"),telemetry:!0,halloween:!0,undeadIslandsExpedition:!0,portableMode:(0,s.isPortableModeRequested)()},reporting:{...n.common.reporting,sentry:{enabled:!1,dsn:"https://63ec8bedbe5345db9b76689cadb81eea@o364314.ingest.sentry.io/6446750"},googleAnalytics:{enabled:!1}},remoteConfigDefaults:{replaysSampleRate:1,levelTelemetrySampleRate:1},helpPagesBaseUrl:"https://michal-bures.github.io/konkr_data/help-v2/",levelStatsBaseUrl:"https://www.konkr.io/level-stats/",cloudFunctionsUrl:"http://0.0.0.0:5001/konkr-io/us-central1/"}},11322:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UiDebugLayer=t.DebugColors=void 0,t.getDebugRect=o;var i,s=Phaser.GameObjects.Line,n=Phaser.GameObjects.Rectangle;function o(e,t,i,s,o,a=255){const r=new n(e,t,i,s,o).setStrokeStyle(1,a,1);return r.setOrigin(0,0),r.setPosition(t,i),r}!function(e){e[e.blue=255]="blue",e[e.green=65280]="green",e[e.red=16711680]="red"}(i||(t.DebugColors=i={})),t.UiDebugLayer=class{constructor(e,t){this.scene=e,this.objects=[],this.target=t||{add:e=>this.scene.add.existing(e)}}clear(){return this.objects.forEach((e=>e.destroy())),this}addRect(e,t,s,n,a=i.blue){const r=o(this.scene,e,t,s,n,a);return this.target.add(r),this.objects.push(r),this}addRectAround(e,t=i.blue){return this.addRect(e.x,e.y,e.width,e.height,t),this}addHorizontalLine(e,t=i.blue){const n=this.scene.cameras.main,o=new s(this.scene,0,0,n.x,e,n.x+n.width,e,t).setStrokeStyle(1,t).setOrigin(0,0);return this.target.add(o),this}addVerticalLine(e,t=i.blue){const n=this.scene.cameras.main,o=new s(this.scene,0,0,e,n.y,e,n.y+n.height,t).setStrokeStyle(1,t).setOrigin(0,0);return this.target.add(o),this}}},11360:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FirebaseRemoteConfig=void 0;const s=i(40081),n=i(68243),o=i(56824);t.FirebaseRemoteConfig=class{get levelTelemetrySampleRate(){return this.number("levelTelemetrySampleRate")}get replaysSampleRate(){return this.number("replaysSampleRate")}number(e){const t=o.config.remoteConfigDefaults[e];return n.Firebase.remoteConfig?(0,s.getValue)(n.Firebase.remoteConfig,e).asNumber()??t:t}}},11421:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConsoleLogger=void 0;const n=s(i(17833)),o=i(36530),a=i(56824);function r(e){return n.default.enabled("game:"+e)}t.ConsoleLogger=class{log(e,t,i,...s){const l=`[${t}] ${i}`;switch(e){case o.LogLevel.Trace:r(t)&&console.trace(l,...s);break;case o.LogLevel.Debug:(0,n.default)("game:"+t)(i,...s);break;case o.LogLevel.Error:console.error(Error(l),...s),a.errors.handleNonFatalError({message:i,data:s},"logger.error");break;case o.LogLevel.Warning:console.warn(l,...s);break;case o.LogLevel.Info:console.info(l,...s)}}group(e,t){r(e)&&console.group(t)}groupEnd(e){r(e)&&console.groupEnd()}}},11466:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceInfo=t.DEFAULT_CONTENT_PADDING=t.MAX_CONTENT_WIDTH=t.MIN_HEIGHT_FOR_LARGE_UI=t.MIN_WIDTH_FOR_LARGE_UI=t.UiVariant=void 0,t.getLogicalDpr=c,t.scaleDown=d;const s=i(96130),n=i(54825),o=i(13419),a=i(56824),r=i(41815);var l;function c(){let e=d(window.devicePixelRatio||1);for(;e*window.innerWidth>2560&&e*window.innerHeight>1e3;)e/=2;return e}function d(e){return e>=2?1:e}function h(e){return e.preventDefault(),!1}!function(e){e.Large="large",e.Compact="small"}(l||(t.UiVariant=l={})),t.MIN_WIDTH_FOR_LARGE_UI=820,t.MIN_HEIGHT_FOR_LARGE_UI=540,t.MAX_CONTENT_WIDTH=1200,t.DEFAULT_CONTENT_PADDING=30,t.DeviceInfo=class{constructor(e){this.game=e,this.uiVariant=(0,s.watchable)(l.Large),this.dpr=c(),this.hasBrowserChrome=window.innerHeight!==window.screen.height,this.frameParent=(0,o.getFrameParent)(),this.supports={touch:e.device.input.touch},this.hasLocalStorage=(0,r.hasLocalStorage)(),e.scale.on("resize",(()=>setTimeout((()=>this.updateScreenSize()),100)),this)}get screenWidth(){return n.app.game.scale.width}get url(){return window.location!=window.parent.location?document.referrer:document.location.href}get screenHeight(){return n.app.game.scale.height}get contentLeft(){return this.screenWidth<=t.MAX_CONTENT_WIDTH?0:Math.trunc((this.screenWidth-t.MAX_CONTENT_WIDTH)/2)}get contentRight(){return this.screenWidth<=t.MAX_CONTENT_WIDTH?this.screenWidth:this.contentLeft+t.MAX_CONTENT_WIDTH}get contentWidth(){return Math.min(this.screenWidth,t.MAX_CONTENT_WIDTH)}isMobile(){return!this.game.device.os.desktop}isUsingTouch(){return n.app.game.input.activePointer.wasTouch}os(){return`${window.navigator.platform??"?"} (${Object.entries(n.app.game.device.os).filter((([e,t])=>!0===t)).map((([e,t])=>e)).join(", ")})`}updateScreenSize(){this.screenWidth>=t.MIN_WIDTH_FOR_LARGE_UI&&this.screenHeight>=t.MIN_HEIGHT_FOR_LARGE_UI?this.uiVariant.set(l.Large):this.uiVariant.set(l.Compact)}isFullScreenAvailable(){return a.config.flags.fullScreenToggleButton&&n.app.device.hasBrowserChrome&&n.app.game.scale.fullscreen.available}disableContextMenu(){document.body.addEventListener("contextmenu",h)}enableContextMenu(){document.body.removeEventListener("contextmenu",h)}}},11505:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RulesModel=t.PawnTypeRulesModel=void 0;const s=i(63521),n=i(24598),o=i(91622);class a{constructor(e,t){this.pawnRules=e,this.type=t}get state(){return this.pawnRules}get cost(){return this.state?.cost??0}get upkeep(){return this.state?.upkeep??0}get income(){return this.state?.income??0}get loot(){return this.state?.loot??0}get might(){return this.state?.might??0}get defenseMight(){return this.state?.defenseMight??this.state?.might??0}get traits(){return this.state?.traits??[]}get mergeRules(){return this.state?.merge??{}}isInvincible(){return this.might>=10}hasTrait(e){return this.traits.includes(e)}toString(){return`[PawnType ${this.type}]`}}t.PawnTypeRulesModel=a,t.RulesModel=class{constructor(e){this.rules=e,this.pawnModels={},this.unitsByMight={},this.castlesByMight={},this.getAllPawnTypes().forEach((e=>{e.hasTrait(s.PawnTraits.Unit)&&e.cost&&e.might&&(this.unitsByMight[e.might]=e),e.hasTrait(s.PawnTraits.Building)&&e.cost&&e.might&&(this.castlesByMight[e.might]=e)}))}get state(){return this.rules}pawns(e){let t=this.pawnModels[e];return t||(t=new a(this.state.pawns[e],e),this.pawnModels[e]=t),t}unitByMight(e){return this.unitsByMight[e]}castleByMight(e){return this.castlesByMight[e]}getAllPawnTypes(){return Object.keys(this.state.pawns).map((e=>this.pawns(e)))}getPawnTypesByTrait(e){this.getAllPawnTypes().filter((t=>t.hasTrait(e)))}getBanditUnitType(){return o.inject.gameStateModel.plugins.zombies?n.PawnType.Zombie:n.PawnType.Bandit}getBanditCampUnitType(){return o.inject.gameStateModel.plugins.zombies?n.PawnType.HauntedTown:n.PawnType.Camp}}},11585:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RateLimiter=void 0,t.RateLimiter=class{constructor(e,t){this.maxRate=e,this.perIntervalMinutes=t,this.history=[]}check(){return this.clearOldEntries(),this.history.push(Date.now()),this.history.length,this.maxRate,this.history.length<=this.maxRate}clearOldEntries(){const e=Date.now()-60*this.perIntervalMinutes*1e3;for(;this.history.length>0&&this.history[0]<e;)this.history.shift()}}},11599:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RivalDefeatsPawnConditionModel=t.AnyTownDestroyedConditionModel=void 0,t.getDefeatConditionModel=function(e){switch(e.type){case"any-town-destroyed":return new h(e);case"rival-defeats-pawn":return new u(e);default:throw new Error(`Unknown defeat condition type: ${e.type}`)}};const s=i(24598),n=i(36868),o=i(39420),a=i(78635),r=i(45664),l=i(45084),c=i(26386),d=i(78933);class h{constructor(e){}getDescription(e){return"Prevent any towns from being destroyed."}test(e,t){return t.some((e=>{if((0,o.isEvent)(e,n.GameStateEvents.HexCaptured)){const t=e.payload.capturedHexId,i=a.Warfare.getOccupyingPawn(e.payload.worldUpdates.stateBefore,(0,r.getHex)(t));if(i?.type===s.PawnType.Town)return!0}if((0,o.isEvent)(e,n.GameStateEvents.ZombiesActed))for(let t of e.payload.worldUpdates.updates)if(t.type===d.UpdateType.PawnsMoved){const i=a.Warfare.getOccupyingPawn(e.payload.worldUpdates.stateBefore,(0,r.getHex)(t.destHex));if(i?.type===s.PawnType.Town)return!0}return!1}))}}t.AnyTownDestroyedConditionModel=h;class u{constructor(e){this.config=e}getDescription(e){return"Rival captures the Bunny."}test(e,t){return!l.CurrentPhase.model(e).isLocalPlayerTurn()&&(0,c.wasPawnDefeated)(this.config.pawnId,t)}}t.RivalDefeatsPawnConditionModel=u},11612:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionForecastView=void 0;const s=i(90952),n=i(20754),o=i(76439),a=i(78436),r=i(56038),l=i(7334),c=i(24336);class d extends n.LazyView{constructor(){super([s.GameState.ai.assetsValueByRegion]),this.name="regionForecastView"}calculate(e,t){const i=r.Regions.model(e).byId(t).getMyAssets();return c.RegionForecast.getTotal(i)}calculateFactors(e,t){const i=r.Regions.model(e).byId(t).getMyAssets();return c.RegionForecast.getFactors(i)}getCacheKey(e){return e}getDebugLayer(){return new o.GameStateDebugLayer((0,a.regionBasedAdapter)({getValue:(e,t)=>this.get(e,t),getDetail:(e,t)=>{const i=this.calculateFactors(e,t);return(0,l.prettyPrintObject)(i)}}))}}t.RegionForecastView=d},11651:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.loadReplay=function(e){"string"==typeof e&&(e=(0,s.decodeReplay)(e));const t=e.steps[0].snapshot;n.assert.defined(t),o.inject.gameStateController.loadState({...t,replay:e},a.NewGameStateContext.LoadReplay),r.app.navigator.goTo(r.app.screen.play,a.NewGameStateContext.LoadReplay)};const s=i(85026),n=i(97849),o=i(91622),a=i(71021),r=i(54825)},11796:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TitleButton=void 0;const s=i(86545),n=i(21941),o=i(80959),a=i(76049),r=i(96137),l=i(91622),c=i(54825),d=i(98963),h=i(18957),u=i(20227),p=i(7782),g=i(9292);class m extends s.ResponsiveContainer{constructor(e,t){super(e),this.arrowOffset=new p.TransitionController(this.scene,{duration:100,ease:"Sine.easeInOut",applyValue:e=>{this.arrow.x=e+10,this.title.x=m.Layout.contentOffsetLeft+(0,g.pickSmaller)(e/2,5)},initialValue:0}),this.frameGlintVisibility=new p.TransitionController(this.scene,{duration:100,ease:"Sine.easeInOut",applyValue:e=>{this.frameGlint.setAlpha(e),this.arrow.setAlpha(.075*(1+e))},initialValue:0}),this.tweener=new u.Tweener(this.scene),this.onClicked=(0,h.signal)();const i=o.UiBuilder.for(e);this.frame=i.box(n.BoxTextures.GlassButtonSlim),this.icon=i.image("ui/level-icons/gold").setOrigin(.5,.5),this.background=i.rectangle(0,0),this.arrow=i.image("ui/background-arrow").setAlpha(.075),this.title=i.text("?",a.BitmapFont.Main,r.Colors.glassUi_old.shapeLightAccent),this.frameGlint=i.image("glass-ui/card-horizontal-glint").setScale(.5,.5).setAlpha(0),this.add([this.background,this.arrow,this.frame,this.frameGlint,this.icon,this.title]),this.on("pointerover",(()=>{this.frame.setFrameFrom(n.BoxTextures.GlassButtonSlimHover),this.arrowOffset.transitionTo(10),this.frameGlintVisibility.transitionTo(1)})),this.on("pointerout",(()=>{this.frame.setFrameFrom(n.BoxTextures.GlassButtonSlim),this.arrowOffset.transitionTo(0),this.frameGlintVisibility.transitionTo(0)})),this.setInteractiveAuto(),this.on("pointerdown",(()=>{c.app.audio.playEffect(d.SoundEffects.ButtonDown)})),this.on("pointerup",(()=>{c.app.audio.playEffect(d.SoundEffects.ButtonUp),this.onClicked.fire()})),t&&this.updateContent(t)}updateContent(e){this.title.setText(e.text),this.setBackgroundColor(e.backgroundColor),this.icon.setFrame(e.icon).setOrigin(.5,.5),e.rightIcon&&(this.rightIcon?this.rightIcon.setFrame(e.rightIcon).setOrigin(1,.5):(this.rightIcon=o.UiBuilder.for(this.scene).image(e.rightIcon).setOrigin(1,.5).setAlpha(.25),this.add(this.rightIcon))),this.onClicked.unsubscribeAll(),this.onClicked((()=>e.onClicked())),this.preUpdate.force()}setBackgroundColor(e){this.background.setFillStyle(e)}takeOverScreen(e){return new Promise((t=>{this.tweener.stop(),this.background.fillColor=l.inject.theme.getCurrent().oceanColor,this.tweener.add({targets:[this],props:{x:0,y:0,alpha:0,width:c.app.device.screenWidth,height:c.app.device.screenHeight},duration:e,ease:"Sine.easeInOut",onComplete:()=>t()})}))}shrinkToSize(e,{x:t,y:i,width:s,height:n}){this.tweener.stop();const o=this.background.fillColor;this.background.fillColor=l.inject.theme.getCurrent().oceanColor,this.setPosition(0,0),this.setSize(c.app.device.screenWidth,c.app.device.screenHeight),this.tweener.add({targets:this,props:{x:t,y:i,width:s,height:n,alpha:1},duration:e,ease:"Sine.easeInOut",onComplete:()=>{this.background.fillColor=o}})}updateLayout(){const e=m.Layout;this.title.setPosition(e.contentOffsetLeft,this.height/2-this.title.height/2),this.icon.setPosition(e.iconOffsetLeft,this.height/2),this.background.setSize(this.width-2*e.frameMargin,this.height-2*e.frameMargin),this.background.setPosition(e.frameMargin,e.frameMargin),this.arrow.setPosition(e.innerFrameMargin,this.height/2).setOrigin(0,.5),this.icon.setPosition(e.frameMargin+e.iconOffsetLeft+this.icon.width/2,this.height/2);const t=this.height-2*e.innerFrameMargin-2,i=(this.arrow.height-t)/2;this.arrow.setCrop(0,i,this.arrow.width,t),this.frame.setSize(this.width,this.height),this.frameGlint.setOrigin(.5,0).setPosition(this.width/2,e.innerFrameMargin),this.rightIcon&&this.rightIcon.setPosition(this.width-e.innerFrameMargin-16,this.height/2),this.ribbon&&this.ribbon.setPosition(this.width-e.frameMargin-1,e.frameMargin+1)}}t.TitleButton=m,m.Layout={width:120,height:60,frameMargin:4,iconOffsetLeft:20,contentOffsetLeft:100,innerFrameMargin:8,rosettaMaxY:60}},11835:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnTransitions=void 0;const s=i(56824),n=i(63521),o=i(76314),a=i(87936),r=i(91622),l=i(40951),c=s.logger.for("PawnsManager");t.PawnTransitions=class{constructor(e,t){this.pawns=e,this.tiles=t,this.scene=this.pawns.scene}async defendTile(e,t){const i=new Map;for(const e of t)i.set(e.hex.id,i.get(e.hex.id)??e);if(i.has(e.id))return this.defendWithPawn(e.id,e.id,i.get(e.id));await Promise.all(Array.from(i.entries()).map((([t,i])=>this.defendWithPawn(e.id,t,i))))}defendWithPawn(e,t,i){let s=this.pawns.getById(i.id);return new Promise((o=>{if(s)if(t==e)this.pawns.jumpOnce(t);else if(r.inject.gameStateModel.rules.pawns(s.type).hasTrait(n.PawnTraits.Building))this.pawns.jumpOnce(t);else{const n=this.tiles.getByHex(t).centerX,a=this.tiles.getByHex(e).centerX,r=s.baseY,l=(a-n)/2,c=(this.tiles.getByHex(e).centerY+3-r)/2;console.log(`X ${t} ${i.type}@${i.hex.id}  ${n} -> ${a}`),this.scene.tweens.add({targets:[s.image,s.shadow],y:{from:r,to:r+c},x:{from:n,to:n+l},ease:"Sine.easeInOut",duration:200,yoyo:!0,onComplete:o})}else c.warning(`Request to play jump animation from ${t} ignored as there is no pawn there`)}))}pawnArrival(e,t,i){return new Promise((s=>{const n=this.tiles.getByHex(t).centerX,o=this.tiles.getByHex(t).centerY+3,a=this.tiles.getByHex(i).centerX,r=this.tiles.getByHex(i).centerY+3;this.scene.tweens.add({targets:[e.image,e.shadow],x:{from:n,to:a},y:{from:o,to:r},alpha:{from:0,to:1},duration:l.TransitionsSpeed.Normal,ease:"Sine.easeIn",onComplete:s})}))}pawnMove(e,t){return new Promise((i=>{const s=r.inject.ui.transitionsSpeed(),n=t.srcHex||e.tile.hex.id,a=(this.tiles.getByHex(n).centerX,this.tiles.getByHex(n).centerY,t.destHex),l=this.tiles.getByHex(a).centerX,c=this.tiles.getByHex(a).centerY+3,d=[{targets:[e.image,e.shadow],x:{from:e.image.x,to:l},y:{from:e.image.y,to:c},duration:s,alpha:{from:t.fadeIn?0:1,to:1},ease:"Sine.easeOut",onComplete:()=>{e.isDestroyed()||e.attachToTile(this.tiles.getByHex(t.destHex)),i()}}];if(e.symbol){const t=c-3+o.SYMBOL_VERTICAL_OFFSET;d.push({targets:e.symbol,x:l,y:t,duration:s,ease:"Sine.easeOut"})}e.setTweens(d)}))}async destroyPawn(e,t){return new Promise((i=>{const s=2*r.inject.ui.transitionsSpeed();let n=a.HEX_WIDTH/2,o=-a.HEX_HEIGHT/4;t&&(n=(e.tile.hex.display.centerX-t.display.centerX)/2,o=(e.tile.hex.display.centerY-t.display.centerY)/2);const l=[{x:e.image.x+n,y:e.image.y+o,targets:[e.image],ease:"Sine.easeOut",duration:s,onComplete:()=>{e.isDestroyed()||e.destroy(),i()}},{scale:1.25*e.image.scale,targets:[e.image],duration:s/2,ease:"Sine.easeOut",yoyo:!0},{rotation:{from:0,to:Math.PI/2*(n>0?1:-1)},targets:[e.image],duration:s,ease:"Sine.easeIn"},{targets:[e.image],delay:s/2,duration:s/2,alpha:{from:1,to:0},ease:"Sine.easeIn"}];e.shadow&&l.push({targets:[e.shadow],x:e.shadow.x+n,y:e.shadow.y+o,alpha:{from:1,to:0},duration:s,ease:"Sine.easeOut"}),e.setTweens(l)}))}async pawnCreated(e,t){return new Promise((i=>{const s=r.inject.ui.transitionsSpeed(),n=this.tiles.getByHex(t).centerX,a=this.tiles.getByHex(t).centerY+3,l=[{targets:[e.image,e.shadow],y:{from:a+10,to:a},duration:s,alpha:{from:0,to:1},ease:"Sine.easeIn",onComplete:()=>{e.isDestroyed()||e.attachToTile(this.tiles.getByHex(t)),i()}}];if(e.symbol){const t=a-3+o.SYMBOL_VERTICAL_OFFSET;l.push({targets:e.symbol,x:n,y:t,duration:s,alpha:{from:0,to:1},ease:"Sine.easeIn"})}e.setTweens(l)}))}}},11862:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Typewriter=void 0,t.tokenize=n;const s=i(54825);function n(e){const t=[];let i="",s=0;for(let n of e)"["===n&&++s,0===s?("\n"===n&&(t.push(""),t.push("")),t.push(i+n),i=""):i+=n,"]"===n&&--s;return t}t.Typewriter=class{constructor(e){this.textObject=e,this.scene=e.scene}start(e,t=20){this.finalText=e;let i=n(e),o="";this.timer&&(this.scene.time.removeEvent(this.timer),this.timer.destroy()),this.textObject.setText(o),s.app.scene.globalUI.typeWriterSound.play(),this.timer=this.scene.time.addEvent({loop:!0,delay:t,callback:()=>{this.textObject.visible?(o+=i.shift(),this.textObject.setText(o),0===i.length&&this.stop()):this.stop()}})}fastForward(){this.stop(),this.textObject.setText(this.finalText)}stop(){this.timer&&(this.scene.time.removeEvent(this.timer),this.timer.destroy()),s.app.scene.globalUI.typeWriterSound.stop()}}},11872:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TextInputDialog=void 0,i(63032);const s=i(29821),n=i(2543),o=i(54118),a=i(6838),r=i(36868),l=i(56824),c=i(9292);t.TextInputDialog=class{constructor(){this.onSubmit=n.noop}getTitle(e){return e.title}getContent(e,t,i){const n=(0,c.pickSmaller)(350,i.width);return this.value=t.value,this.textInput||(this.textInput=new a.TextInput(e,{placeholder:t.inputPlaceholder,text:t.value.current}),this.layout=new o.VLayout(e,{content:[new s.Label(e,t.message),this.textInput],spacing:16,width:n}),this.textInput.node.onkeyup=e=>{13===e.keyCode||"Enter"===e.code?l.events.trigger(r.UserActions.SubmitForm()):27!==e.keyCode&&"Escape"!==e.code||l.events.trigger(r.UserActions.Cancel())}),this.textInput.setValue(this.value.current),this.textInput.selectAll(),this.textInput.node.maxLength=t.maxLength??1e3,this.textInput.width=n,this.layout.preUpdate.force(),this.layout}getButtons(e){return e.buttons}onBeforeClose(e){return this.value.set(this.textInput.text),!0}onShown(){this.textInput.focus()}}},11874:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CHATTER_DEFS=void 0,t.updateChatterRules=function(e){Object.assign(s.AIPersonas.get(void 0).chatter,e)};const s=i(98490);t.CHATTER_DEFS=[{tags:["surrendering","hostile"],lines:["Screw this, I give up.","Goddamnit, this is hopeless.","This is bloody hopeless.","Who am I kidding, I'm done.","Damn, this is getting too depressing.","What's the point of fighting anymore?","You've beaten me.","Oh well.","So be it.","I'm defeated.","Well, that's that.","Give me a break...","Fine, you win.","Yeah, this is going nowhere."]},{tags:["surrendering","friendly"],lines:["Well played!","Congratulations!","I concede.","I acknowledge my defeat.","Very impressive.","Well done.","I knew you could do it!"]},{tags:["surrendering","not hostile"],lines:["Well, I know when I'm outmatched.","Well played... Damnit.","Sigh... I guess you win.","Fine, you win.","Fine, I give up.","Alright, you got me.","I see I was outmatched.","Okay, you win.","Well, I'm beat.","Yeah, this is going nowhere.","Whatever."]},{tags:["surrender declined","much weaker","hostile"],lines:["Fine! I'll go down swinging!","Bastard! Come at me then!","Damn you!","To the death it is.","I'll gladly fight this to the bitter end.","Good, I didn't REALLY want to surrender anyway!","Fine then. Bring it!","Let's get on with it then.","You tyrant."]},{tags:["surrender declined","much weaker","truce","not hostile"],lines:["Hey, thanks for sparing me! You ARE sparing me, right?","Wait, why am I still alive?","I have no idea what's going on right now...","What, am I supposed to be your pet or something now?","Very funny...","Sigh... Done gloating?","So uh, what is this, anyway?","So now you expect me to do what exactly?","Waiting for me to compliment you or something?"]},{tags:["furious","much weaker","caused major damage","did not suffer major damage"],lines:["Ahahahaha! That felt good!","Didn't expect that, did you?!","Now THAT was satisfying.","Didn't think I could still bite, did you?","Take that!","Hah! That's what you get!","You like that?! Hahaha!","Who's the big guy now?!"]},{tags:["furious","much weaker","was not hostile","suffered major damage","did not cause major damage","angry reaction"],lines:["How could you!","You bastard!","GAH! Should have seen that coming!","@#$%!","No... No. NO!","Arrrgh!","I can't believe you've done this!","NOOOOOO!","You snake!","Oh no!","This can't be happening!","I can't believe this!","You are impossible!","Wait, WHAT?!"]},{tags:["furious","much weaker","suffered damage","angry reaction"],lines:["@#$%!","I hate you!","You... You!","No. No. NO!","Arrrgh!","You bastard!","This is so unfair!","Ugh!","Why you!"]},{tags:["furious","much weaker","fighting"],lines:["I'm not going out without a fight!","I'll go down swinging!","Never give up! Never surrender!","I'll take you down with me!","Maybe I can't win, but I can still bite!","I'll never give in!","I will not yield!","I'm not finished yet!"]},{tags:["furious","much weaker","truce"],lines:["Ugh...","Grrr...","Screw you.","...","Shut up.","Here to gloat?","Bastard.","Foul villain.","Your mother was a hamster and your father smelt of elderberries!","Satisfied, you monster?"]},{tags:["furious","much stronger","caused major damage","did not suffer major damage"],lines:["It will be over soon enough!","AHA! Take THAT!","Yes, yes, YES!","That's what you get!","AHA!","Taste my wrath!","Your time has come!","Now you're done!","Yes, I'm unstoppable!","Too late for words!","You're done for!","No amount of begging will save you now.","Nowhere left to hide, eh?","There is no escape.","Your reign ends here.","Justice has arrived.","This is just too easy.","This won't take long.","The glory is all mine!","Damn, I'm good."]},{tags:["furious","much stronger","fighting"],lines:["Came to beg for mercy?","Time to say goodbye.","We both know it's over.","It's too late for apologies!","You'll die for this.","I've had enough of you.","You're done for.","It's time to end this.","Your defiance will not go unpunished."]},{tags:["furious","stronger","suffered major damage","did not cause major damage","angry reaction"],lines:["Hey, that hurt! I'll get you for that!","You'll pay for that!","Ow! Insolent little...","Trust me, you're not getting away with this!","Ohhh NOW you've done it!","How dare you!","This is going to cost you!","You picked the wrong fight!","This will not go unpunished!","For that, I'll make it slow and painful.","Mark my words, I'll have your head."]},{tags:["furious","stronger","truce"],lines:["Just you wait...","You'll pay for that, you know.","Don't worry, I'll get to you soon enough.","You're next.","Insolent little...","Your time will come.","I will have my vengeance in due time.","Do you think you can just walk away?"]},{tags:["furious","stronger","fighting"],lines:["You're going down.","It's over for you, you know.","Let's face it, you're done for.","You picked the wrong fight.","Came to beg for mercy?","It's too late for apologies.","We're done talking.","You don't scare me.","It's time you learnt to fear my name.","Trust me, this isn't ending well for you."]},{tags:["furious","caused major damage","did not suffer major damage"],lines:["Take THAT!","That's what you get!","I'm winning! I'm winning, right?","Yaaaah!","Yes, I can do this!","AHA! I got this!","Hahahaha! Do your worst!","Yeehaaaw!","Bring it on!","Yeah, that's right!","I'm not scared of you!","You think I'm scared of you?","You are SO dead!"]},{tags:["furious","suffered major damage","did not cause major damage","angry reaction"],lines:["You'll regret that!","You'll pay for that soon enough!","I'll get you for this!","Damnit!","You bastard!","No! Damnit!","This is preposterous!","You fiend!","You won't get away with this, villain!","I'll have my revenge!","Your head will roll, tyrant!"]},{tags:["furious","suffered major damage","angry reaction"],lines:["Bastard!","Grrr...","Gah!","No! Damnit!","Not fair!","Damn you!","Damn it all!","This can't be!","How in the...?","Nooo!"]},{tags:["furious","truce"],lines:["Just you wait...","You... You!","You'll pay.","You'll pay. You'll PAY!","@#$% you!","My time will come.","I'll have my vengeance soon enough.","I can be patient.","This is not over!","Mark my words, you will fall."]},{tags:["furious","fighting"],lines:["Shut up.","Get out of my face.","Begone from my sight.","We're done talking.","We're beyond words.","There's nothing left to be said.","Words are cheap.","I refuse to deal with you.","Let our armies do the talking."]},{tags:["invaded","suffered major damage","was friendly","friendly","not weaker","angry reaction"],lines:["Fine, maybe just this once, I'll let you get away with this.","Uh... I'm sure you had a good reason for this?","So what was this supposed to accomplish exactly?","What the... Are you done?","My patience has its limits, you know?","I guess I still owe you one, but don't push it.",'Oh, I get it. This is your way of saying "hello", isn\'t it?',"I'm not mad, just disappointed.","You're joking, right?","With allies like these, who needs enemies...","That was just a prank, right? Right?"]},{tags:["invaded","suffered major damage","was friendly","friendly","angry reaction"],lines:["Wait, what...?","I don't understand...","Um, what is the meaning of this?","Eh, what are you doing...?","Wait, no! Stop!","What are you doing?!","What's going on here?!","Hey, what did I do to deserve this?","What? No!","Hold on, what is this?!","Are you kidding me...?","Can we talk about this?"]},{tags:["invaded","suffered major damage","was ally","not friendly","angry reaction"],lines:["How could you!","Should have seen that coming!","You'll pay for that!","You betray me?!","This is outrageous!","You... You!","I have no words for what you just did.","Disgraceful!","You just made yourself an enemy.","It didn't have to be this way.","A shameful display.","Your dishonor will not be forgotten!","You treacherous snake!","It's a dog-eat-dog world, isn't it?","What an appalling disgrace.","My disappointment is immeasurable and my day is ruined.","Unbelievable!","You will regret the day you crossed me!"]},{tags:["invaded","suffered major damage","was friendly","not friendly","angry reaction"],lines:["I knew you couldn't be trusted.","So that's how it is.","You want to play it like that, huh?","Of course you would do that.","I don't know what I expected.","This is why we cant have nice things.","Should have seen that coming.","You just made yourself an enemy.","Of course. I'm not even surprised.","Say hello to my complete lack of surprise.","I knew you were trouble.","How disappointing.","This is going to end badly for you.","It didn't have to be this way."]},{tags:["invaded","suffered major damage","was friendly","had common enemy","angry reaction"],lines:["Really? You chose to focus on ME?","What?! I'm not the one you should be worried about!","You're making a mistake here!","Wow! You must really want the other guy to win.","How stupid of you...","This is why we cant have nice things.","A very poor choice, a fatal mistake even.","Oh. How disappointing.","Sigh... This is going to end badly for both of us.","Wow. This is really disappointing.","Oh, you have got to be kidding me...","Seriously? Don't we have a bigger problem to worry about?","Great strategy, see how it works out for ya!"]},{tags:["invaded","suffered major damage","weaker","was weaker","was not hostile","common enemy","angry reaction"],lines:["Pick a fight with someone your own size!","I could have helped, you know?","Sure, pick on the little guy.","How very brave of you...","Seriously? You're picking on ME?","Oh, you have got to be kidding me...","You sure I'm the one you want to be fighting right now?","Don't you have bigger problems to worry about?","You sure I'm the threat here?"]},{tags:["invaded","suffered major damage","had common enemy","angry reaction"],lines:["Don't you have bigger problems then me?","Why me? Why now?!","Wow! You must really want the other guy to win.","How stupid of you.","You're making a mistake here!","Oh, you have got to be kidding me...","You sure I'm the one you want to be fighting right now?","Well, that was dumb.","Seriously? You choose to attack me NOW?"]},{tags:["invaded","suffered major damage","stronger","angry reaction"],lines:["Ohhh! Okay, let's dance!","Ha, you're going to regret that!","You'll pay for that!","Oh man, you have no idea what you just signed up for.","Okay, it's on now!","Ohhh, someone's just asking for trouble!","I'm going to make you regret this!","You'll wish you had never done that!","You're asking for a world of hurt!","Someone is going to get a royal beating today.","Oh, you want to play it like that?","Oh wow, that was a terrible mistake.","A fateful error.","And this is where it all goes wrong for you.","How dare you challenge me?","You'll pay dearly for that.","You know this won't end well for you.","How foolish of you to challenge me.","Making a big mistake right now.","Oh, hell no!"]},{tags:["invaded","suffered major damage","similar strength","angry reaction"],lines:["Bastard!","You'll pay for that!","Should have seen that coming, I suppose...","That's the best you can do?","Fine, let's dance.","Curse you!","You're going to regret this.","Alright, you asked for it.","You'll pay dearly for that.","This won't end well for you.","Prepare for your doom!","Let the fun begin.","Challenge accepted.","So be it."]},{tags:["invaded","suffered minor damage","friendly","stronger","angry reaction"],lines:["Careful now...","Really? You sure you want to do that?","My patience has its limits, you know.","You're really pushing it, you know.","Now you're really pressing your luck...","Testing my patience, are you?","Sure, be a nuisance. See where that gets you.","Last chance to behave. Don't say I didn't warn you.","Hey, be nice!","You really should stop before things get ugly.","You like living dangerously, don't you?","You sure you want to make me angry?","Maybe you should think twice about this.","Don't do something you'll regret.","I hope you realize my benevolence has limits.","You sure you want to poke this particular hornet's nest?","Fancy testing the limits of my patience?","You are walking a very thin line, my friend.","If you keep pushing me, I'll have no choice but to push back."]},{tags:["invaded","suffered minor damage","friendly","angry reaction"],lines:["Hey! What was that for?","What the hell?","What was that?","Like, seriously?","Oh, come on...","Hey, cut it out!","Stop that!","Hey, I needed that land!","Hey, that's not yours!","For real?","That's not cool!","Keep pushing me and I'll have to push back."]},{tags:["invaded","suffered minor damage","neutral","stronger","angry reaction"],lines:["Hey! What do you think you're doing?!","I did not allow you to take that!","Looking for trouble, huh?","You're really pushing it, you know.","Listen here you little...","Why you little...","Try that again and see what happens.","Think twice before you try something like that again.","Last warning: back off.","Want me to end you?","One more stunt like that and it's over for you.","Your arrogance will be your demise.","I am not one to be toyed with.","I shall not tolerate such insolence.","Do not test me.","Don't tempt fate.","Do you have a death wish or something?"]},{tags:["invaded","suffered minor damage","hostile","stronger","angry reaction"],lines:["You will regret that.","No, I will not let that slide.","You're going to pay for that.","Looking for more trouble, huh?","Thanks for reminding me that it's time to end you.","Oh right, you're still here. Let's fix that.","I guess you haven't learned your lesson yet.","I've had enough of you.","Don't worry, I'll get to you soon enough.","Prepare for the reckoning."]},{tags:["invaded","suffered minor damage","not friendly","angry reaction"],lines:["I figured this was coming...","I knew you couldn't be trusted.","I knew you were up to no good.","I always get the worst neighbours.","You've made a grave mistake, my friend.","If you press me, I'll make sure you regret it.","Go ahead, keep messing with me. See what it gets you.","And here it is... No one can be trusted these days.","You want a fight?","Hey! Not cool!","I'm warning you...","I knew you'd be trouble.","You shouldn't have done that.","Can't we all just get along for once?"]},{tags:["invading","was angered by rivalry","not hostile","not weaker"],lines:["I'm sorry, but it's you or me now. And I prefer me.","Sorry, but you know this island isn't big enough for the both of us.","It's time to finish this.","Don't take it personally, but I intend to win this one.","Let's finish this.","It's you and me now, let the better one win.","Time to find out who's the true ruler of this island.","It's time we finally settle this, don't you think?","The time has come for one of us to fall. I choose you.","Let's settle this once and for all.","Prepare for battle, for this shall be our final clash.","It's either you or me, and I want to prevail.","Don't act like you weren't about to do the same.","I've come this far, I won't let you take the win."]},{tags:["invading","was angered by rivalry","not hostile","weaker"],lines:["Can't blame me for trying, right?","I'm sorry, but I can't just let you win, can I?","I'm sorry, but I want to win this too.","I had to try... It's you or me now.","Sorry, but I wasn't born yesterday. Better to strike first.","Sorry, figured it was worth a shot.","Don't act like you weren't about to do the same.","Sometimes you have to take a chance to win.","I guess I'm the last one who can try to stop you.","Sorry, can't let you have it all.","Don't take this personally, but I want to win too."]},{tags:["invading","was angered by rivalry","hostile","not weaker"],lines:["Let's get this over with.","It's you and me now, just how I like it.","Time to finish this once and for all.","Finally, I can focus on ending you.","Let's see how you handle a real fight.","I've been waiting for this moment.","I've been looking forward to this.","It's about time we faced each other one on one.","Let's finally end this, shall we?","The end is near.","Prepare to taste defeat."]},{tags:["invading","was angered by dominance","not hostile","not weaker"],lines:["Nothing personal, but you were getting too powerful for your own good.","Look, I'm sorry, but somebody had to clip your wings a bit.","Sorry, you were just getting too big for comfort there.","Apologies, had to rein you in a little there.","Sorry, somebody had to put a stop to your sprawl.","You were getting a bit too powerful for your own good.","Someone had to put your ambitions in check.","Sorry, but someone had to put a limit on your greed.","Look, you got a bit too big for your britches there, my friend.","What can I say, it was time someone tamed that ambition of yours a little.","You have to admit, you were becoming a bit too dangerous for anyone around.","Sorry, it was time to bring you down to Earth a bit.","Sorry, it was time someone cut your wings before you flew too high.","Look, I couldn't sit by and let your ambitions ruin everyone else.","It was a tough decision, but someone had to step up and stop your expansion.","You needed to be taken down a peg or two. You understand."]},{tags:["invading","was angered by dominance","friendly"],lines:["I'm sorry it came to this, but you're scaring me at this point!","I didn't want to do this, but you're just growing way too powerful.","I'm sorry, but you're getting too big for your own good.","I hate to do this, but I can't let your power grow unchecked.","Sorry to say, but I can't have you getting any bigger.","I'm so sorry to do this, but you've simply become too dangerous.","I'm sorry, but your power has to be kept in check.","I'm not proud of this, but it was necessary.","Please forgive me, but I had to act before your power gets out of hand.","I'm sorry, but you've grown too dangerous.","I'm not proud of this, but it was time to act."]},{tags:["invading","was angered by dominance"],lines:["You can't be allowed to wield this kind of power.","I won't just sit here and watch you crush everyone.","Someone had to try to stop your expansion.","I will not just stand by waiting to be crushed.","Someone has to put a stop to your reign before it's too late.","You can't be allowed to get away with such unchecked expansion.","Somebody has to resist you.","It's time to put your ambitions in check.","It's time to rein you in a bit.","Your greed must be put in check.","You can't expect the rest of us to just roll over.","Your unchecked expansion simply cannot continue.","Did you expect me to just sit here and watch you take over everything?","Oh, did you expect me to just wait for my turn to be crushed?","Someone had to stand up for those who can't.","You must know that I can't let you just roll over everyone."]},{tags:["invading","was angered by credit","caused major damage","not hostile","common enemy"],lines:["I know we have bigger problems now, but you had this coming.","Just because we have a common enemy doesn't mean I've forgotten what you did.","Sorry, common enemy or not, I had a score to settle with you.","Oh, you wanted me to help? Should have thought of that before messing with my land.","Yeah, I might have doomed us there, but damn was it worth it.","This may have been a mistake, but damn did it feel good.","Sure, we might be doomed now, but at least I got my revenge!","If you wanted me to focus on our common foe, maybe you shouldn't have messed with me.","Oh, you thought I would just forget what you did to me?"]},{tags:["invading","was angered by credit","not hostile","not weaker"],lines:["I hope you've learned your lesson now.","Learned your lesson yet?","Ah, sweet justice.","Consider that a taste of your own medicine.","Ah, sweet retribution.","Ahhh, the sweet taste of vindication.","There, now we're even.","Consider this a taste of your own medicine.","Sweet justice.","Think twice before you cross me next time.","What goes around, comes around."]},{tags:["invading","was angered by credit","not hostile"],lines:["There, now we're even.","You know you deserved that.","Justice has been served, my friend.","Actions have consequences.","Sweet justice.","Think twice before you cross me next time.","You reap what you sow.","What goes around, comes around.","This is the price you pay for your misdeeds.","Karma has its ways of balancing things out, doesn't it?"]},{tags:["invading","was angered by credit","hostile"],lines:["You know you had that one coming.","You reap what you sow.","Don't act surprised now...","You deserve that and more.","And I'm just getting started.","You know you deserved that.","It's time to pay the piper.","You've seen nothing yet.","That's right.","Time to get what you deserve.","It's time to answer for your actions.","It's time you got yours.","Justice will be served.","For justice!","I have not forgotten your treachery."]},{tags:["invading","was angered by losses","caused major damage","not hostile","common enemy"],lines:["I know we have bigger problems now, but you had this coming.","Just because we have a common enemy doesn't mean I've forgotten what you did.","Sorry, common enemy or not, I had a score to settle with you.","Oh, you wanted me to help? Should have thought of that before attacking me.","This might have been a mistake, but you deserved some justice.","Oh, did you think I would just forget what you did to me?"]},{tags:["invading","was angered by losses","not hostile","not weaker"],lines:["I hope you've learned your lesson now.","Learned your lesson yet?","Ah, sweet justice.","Consider that a taste of your own medicine.","Ah, sweet retribution.","Ahhh, the sweet taste of vindication.","There, now we're even.","Consider this a taste of your own medicine.","Sweet justice.","Think twice before you cross me next time.","What goes around, comes around."]},{tags:["invading","was angered by losses","not hostile"],lines:["There, now we're even.","You know you deserved that.","Justice has been served, my friend.","Actions have consequences.","Sweet justice.","Think twice before you cross me next time.","You reap what you sow.","This is the price you pay for your misdeeds.","Karma has its ways of balancing things out, doesn't it?","What goes around, comes around."]},{tags:["invading","was angered by losses","hostile"],lines:["You know you had that one coming.","You reap what you sow.","Don't act surprised now...","You deserve that and more.","And I'm just getting started.","You know you deserved that.","It's time to pay the piper.","You've seen nothing yet.","That's right.","Time to get what you deserve.","It's time to answer for your actions.","It's time you got yours.","Justice will be served.","For justice!","I have not forgotten your treachery."]},{tags:["invading","caused minor damage","stronger","friendly"],lines:["I needed to take that, I'm sure you understand.","Surely you can spare a bit of land for me.","Sorry about that, just really needed that land.","I'll just grab this tiny piece of land over here... There we go, now I'm good!","Don't worry, we're still good, just needed that land over there.","Sorry for the land grab, but you were kind of in my way.","Sorry, but that little chunk of land over there just caught my eye.","Oops, did you need that land? I'm sure you can spare it.","I'm sure you can spare a bit of land for a good friend, right?","Oh, was that yours? Sorry!"]},{tags:["invading","caused minor damage","stronger","neutral"],lines:["I had to take that land, no need to overreact.","I needed that land, don't make a fuss.","Don't worry, just needed a bit more land.","I just needed that land, okay?","Come on, don't make a big deal out of this.","Hey, no hard feelings, right?","Relax, it's not like I'm trying to wipe you off the map or anything.","Just expanding a bit, don't take it personally now.","Calm down, it's just a bit of land.","It's not like you needed all that land anyway, right?"]},{tags:["invading","caused minor damage","stronger","hostile"],lines:["I needed that land, going to do anything about it?","Yeah, yeah. I grabbed some of your land, big deal.","Look, I take what I want, and I wanted that land.","You should be glad I didn't take more.","Oh, right, that was your land I guess. Well, not anymore.","You didn't need that land anyway.","I'm not apologizing for taking what I want.","Your fault for not defending that.","Pff, cry me a river.","Consider yourself lucky I didn't take more.","Yeah no, that land is mine now. Deal with it.","I'm just getting started."]},{tags:["invading","caused minor damage","similar strength","friendly"],lines:["I can have a bit more land, right?","Surely you can spare a bit of land for me? Please?","See, I really needed that bit of land. Don't be mad!","Sorry about that, just really needed that land.","I'll just grab this tiny piece of land over here... There we go, now I'm good!","Oops, did you care about that piece of land? Sorry!","Sorry for that little land grab, but that spot was really important to me.","Ah, don't be so sour about it. Just a small piece of land."]},{tags:["invading","caused minor damage","similar strength","neutral"],lines:["Hey, nothing personal, just needed that land.","You know I needed that land, right? No need to get mad over it.","I just needed that land, okay?","Just a teensy tiny little land grab. No hard feelings, right?","Ahem, let's not make this a big deal?","If I say I'm sorry, will you leave me alone?","I'm sorry, okay? I just needed that land.","Sorry, had to take that. Let's not dwell on it.","Come on, you know I didn't mean it.","Don't be overly dramatic about this now, it's just a little bit of land.","Sorry, I need to expand somewhere too!","I need that land, sorry.","Surely you don't care about that teensy-weensy little incursion?","Just look at that land, it practically begged me to take it."]},{tags:["invading","caused minor damage","similar strength","hostile"],lines:["Let's not start a big fight over this just yet.","Pfft, like you care about a few bits of land.","Want to start something bigger over this? Because I'm ready.","Yeah, that's mine now.","I can do much worse if you want.","You should be glad that's all I took for now.","Come on, that's barely worth fighting over.","Just taking some land, but we can have a real war too if you want!","No, I'm not done.","Looks like you're giving away land for free. I'll take it!","I mostly just needed that land, hurting you was a nice bonus though.","You deserved to lose that land.","I'm just getting started.","This is just the beginning."]},{tags:["invading","caused minor damage","weaker","friendly"],lines:["Look I really had to take that land. Please forgive me?","Oh hi, please don't be mad? I just really needed to take that.","I can have a bit more land, right, my friend?","Oh no... Don't be mad!","Oh crap, he noticed. I mean hi, sorry about that!","Oh, you saw that? Sorry!","Please forgive me, that piece of land is just really important to me.","I promise I'll give it back later, okay?","You said I could take that, right? Or did I misunderstand?","Sorry! I'll make it up to you, I swear!"]},{tags:["invading","caused minor damage","weaker","neutral"],lines:["Look I just need a bit more land, so have mercy?","Uhh, surely you didn't care about that tiny bit of land?","I just needed that land, okay? Please don't be mad.","Uh, can you let it slide just this once?","I'm sorry, okay? I just needed that land.","Surely you have bigger things to worry about than little ol' me?","So, uh, maybe I overstepped a little... Didn't mean to!","Look, I didn't mean to steal your land. It just kind of happened.","I promise I'm not going to take any more land, so can we call a truce?","I suppose I was being a bit greedy, sorry."]},{tags:["invading","caused minor damage","weaker","hostile"],lines:["I'm in trouble now, aren't I?","Come on, you have better things to do.","Come on, let this one slide.","Huh, I guess you actually noticed. Unfortunate.","I guess this may have been a mistake.","Come on, you have bigger things to worry about.","It's not like you'll miss that land anyway.","Don't you have more important things to worry about?","Come on, don't pretend like you cared about that bit of land."]},{tags:["invading","caused major damage","stronger","was friendly"],lines:["I... Don't know what to say.","Oh. This is awkward.","Oops... I guess I got a bit carried away there.","Oh no, how did that happen?","Oh dear. I may have accidentally... Sorry!","Whoops. Guess I should've thought twice before doing that...","Oh. Oh no. I'm so sorry.","That... was not supposed to happen.","Oh my. I guess saying sorry doesn't quite cut it here, does it?","Oh no. Sometimes I just do things without thinking."]},{tags:["invading","caused major damage","was angered by nature","not hostile"],lines:["What can I say, sometimes I just can't help myself.","Oops, I guess that was too tempting.","Hehe... Sorry, I just couldn't resist.","You were kind of asking for that, you know?","Sorry, it was kind of an impulse decision.","Well, what can I say, you were just too easy to conquer.","I mean, just look at that land. It practically begged me to take it.","See, I'm a conqueror. It's what I do.","For glory!","Ah, the thrill of conquest.","To the victors go the spoils!","Conquer and plunder, that's just how I like it."]},{tags:["invading","caused major damage","stronger","not hostile"],lines:["Nothing personal, but you were kind of in the way.","Sorry, have to look after my own interests.","Sorry, but you were kind of a nuisance.","Oh, did I just ruin your day? Wasn't really my intention, but oh well.","How do I put it... You were a bit of an obstacle there.","Don't take it personally, just had to do what was best for my kingdom.","Sorry for trampling over your lands, but sometimes these things just happen.","Sorry for taking over your lands, but hey, now you have less to worry about!","Sorry, just figured I can make better use of that land.","Sorry for ruining your plans, but I have my own to take care of."]},{tags:["fighting","was not weaker","much weaker"],lines:["Oh my, what have I done?!","Oh no, that was not supposed to happen!","Oh no, it wasn't supposed to go like this at all!","Well, that didn't go as planned.","Oh no, this is not good at all.","Aaand I'm doomed.","Well, that didn't work.","Well, that went horribly wrong.","This worked out differently in my head.","I think I've made a huge mistake.","Gah! I'm doomed!","Oh no, how did I let this happen?!","Oh no, what have I done?","Oh no. I should have seen this coming.","Well, this is a disaster!","Sigh... I'm such a failure.","Oh my, that did not go well at all.","Well, that wasn't the plan.","I may have misjudged the situation.","Well, that was not how things were supposed to go.","Oh my, I may have miscalculated.","Ahh, this is bad, this is really bad..."]},{tags:["fighting","was stronger","weaker"],lines:["Gah, I'm in trouble now.","Oh crap, I guess I missed that.","Oh no! How did this happen?!","Oh no. I'm in trouble now, aren't I?","Well, that wasn't the plan.","I may have misjudged the situation a bit.","Never mind, I'll just have to try harder.","I can still turn this around, don't worry.","This is far from over.","Don't count me out just yet.","Shut up!","I'm not done yet!","I can still turn this around!","You may have won the battle, but not the war!","I can turn this around, just you wait!","I shall not be defeated so easily!","I refuse to be bested by the likes of you!","My kingdom, my precious kingdom..."]},{tags:["was weaker","stronger","hostile"],lines:["Well well well, how the turntables...","Not so cocky now, are you?","Oh, you're in trouble now, aren't you?","Yes! Now we're getting somewhere.","Hahaha, how unfortunate for you.","Enjoy your downfall, I know I will!","Overconfidence is a slow and insidious killer, isn't it?","Ah, a fall from grace is always a sight to behold.","Seems fortune has finally turned its back on you. Was about time!","Pride always comes before the fall, doesn't it?","See the vultures circling above?","He! Can't wait to feast on the remains of your kingdom!","Oh, how the mighty have fallen.","Look at you, brought low by your own hubris.","Haha, your deeds finally caught up with you, didn't they?"]},{tags:["fighting","angered by rivalry","hostile","not weaker"],lines:["What is there left to say?","Words won't help you now. Time to fight.","Less talk, more fight.","I'm not letting you win this.","This is it, it's you or me now.","It's time to end this.","Let's settle this once and for all.","This is where it ends.","Time to fight.","Victory will be mine!","For my people!","A day for glory!","The time has come for you to bow to my rule.","Prepare to taste the cold steel of defeat!","Your kingdom will fall before the might of my army!","Your kingdom will pay the price for defying me!","You can never defeat me!"]},{tags:["fighting","angered by rivalry","not hostile","stronger"],lines:["Sorry, but there can be only one king.","It's you or me now... And it's gonna be me.","It's time to finish this.","Bow to your new ruler.","Time to stop throwing lives away and surrender.","It's over. Time to admit defeat.","Surrender and I'll spare your life.","It's time to put an end to your reign.","Your time has come to an end.","Time to give up and admit defeat.","Your reign is coming to an end.","Do you really think you can still defeat me?","It's time for you to accept defeat.","It's over. Time to accept your fate.","You're like a flea trying to take on a lion!"]},{tags:["fighting","angered by rivalry","not hostile","similar strength"],lines:["It's between you and me now. Let the better one prevail.","Finally, an honest battle. Let's see who wins.","So it's just you and me now, huh? Let's see who's better.","This is it, it's you or me now. Good luck.","It's you or me now. May the best kingdom win.","It's you or me now. Let's see who's better.","A sword day! A red day!","Everything hangs in the balance now! I'm not letting it slip!","It's you or me now. May the better one prevail.","Finally, a worthy opponent. Let's see who's better.","Allright, bring it!","Today, it's me or you. May the better one prevail.","The die is cast! It's you or me!","It's the end of the line. Let this be a battle for the ages!"]},{tags:["fighting","angered by rivalry","weaker"],lines:["Maybe I can still stop you?","What is there left to say?","I guess it's just you and me now, great...","Damn, how do I win this now?","Damnit. I guess all I can do is keep fighting...","Don't think this is over yet, I've still got fight in me.","Don't underestimate me, I'm not done yet.","I'll never surrender!","If this is my last stand, so be it.","If I go down, I'll go down swinging.","This may be the end, but I won't go down without a fight.","If this is where I meet my maker, so be it!","Come what may, I will prevail.","You may have the power, but I have the heart.","I may not have the power, but I have the will."]},{tags:["fighting","angered by credit","hostile"],lines:["I still have a score to settle with you.","I'm not done with you yet.","I'm not letting you get away with this.","I'll make you regret the day you crossed me.","It's time for revenge.","I shall have my vengeance.","Time to settle the score.","You'll pay for what you've done.","Justice will prevail.","This is your reckoning.","No mercy for the wicked.","Your days are numbered.","My retribution is nigh."]},{tags:["fighting","angered by dominance","hostile"],lines:["If we don't stop you now, it will be too late.","You must be stopped before it's too late.","Someone needs to put a halt to your expansion.","I'm not letting you grow any stronger!","Your greed must be put in check!","Your thirst for power cannot go unanswered!","Your expansion must be stopped before it's too late.","Someone must stand up against your greed!","Your sprawl cannot go unchecked!","It's time someone stood up to your ambition.","Your hunger for power must be contained.","You're growing too dangerous to be left alone.","Someone has to stop you before it's too late.","Nobody should have the kind of power you strive for. Except me, perhaps.","This is for the good of everyone."]},{tags:["fighting","angered by dominance","not hostile"],lines:["Sorry, but you're still too large for comfort.","Sorry, a balance has to be restored.","It pains me to do this, but you've become too dangerous.","This is for the good of everyone.","It's for the best if you're taken down a notch.","I'm sorry, but you're too dangerous to be left alone.","Your power cannot be left unchallenged.","The greed of your expansion leaves me no other choice.","I'm not proud of this, but you've become too much of a threat."]},{tags:["fighting","angered by losses","hostile"],lines:["You will pay.","My fallen warriors will be avenged!","You will regret this.","You have crossed a line you cannot uncross.","I will show you the true meaning of war.","I will have my revenge before this is over!","Vengeance will be mine!","You shall rue the day you crossed me!","I will not be so easily defeated!","You want a total war? You got it!","Retribution is coming!","You'll pay... You'll pay dearly!","You will pay for this!","I'll get you for this.","You just unleashed a fury you cannot quell.","You will wish you had never started this war."]},{tags:["suffered damage","not hostile","common enemy"],lines:["We should stop this fight, we have a bigger problem brewing.","Our common foe smiles as we fight. We should stop this.","You sure you want to keep fighting ME?","You sure I'm still your biggest problem?","Think about it, we could be allies if you weren't so damn stubborn.","What do you say we put down our swords and call a truce?","We have more important battles to fight than this petty feud.","Wouldn't you rather fight alongside me than against me?","Open your eyes, we have a bigger problem than one another.","Put down your sword, let's focus on the real enemy.","Don't you have a bigger fish to fry? I know I do.","Let's not waste our energy on each other when we have a bigger problem to solve.","Why don't we join forces instead and focus on the bigger picture?"]},{tags:["suffered damage","not hostile","stronger"],lines:["You should stop messing with me while you still can.","This is your chance to back down.","Don't be a fool. Stand down.","You can't win this fight. Stop it before it's too late.","You know you stand no chance. Don't tempt fate.","Think of your people. Don't do this.","Walk away from this while you still can.","You are playing with fire. Stop it before you get burned.","This is a battle you can't win. Be smart.","This will bring you only destruction and despair. Walk away."]},{tags:["suffered damage","not hostile","similar strength"],lines:["We don't HAVE to fight this to the bitter end, you know?","I'm getting tired of fighting you.","You sure you want to keep going at this?","Look, I COULD leave you alone... If you do the same.","Don't you have better things to do than fight me?","Look, I'm willing to move past this if you are.","Let's call it even?","Why don't we talk this through like civilized people?","If we keep fighting, we'll both lose in the end.","Come on, I don't want to fight you.","I'm willing to make a truce. Are you?","Let's stop this before things get out of hand.","If we keep this up, neither of us will win."]},{tags:["suffered damage","not hostile","weaker"],lines:["I don't enjoy this fight at all...","Any chance you could leave me alone?","Any chance of a truce?","Could we, uh, call it a tie and go our separate ways?","Do we really have to keep fighting?","Maybe we can find some common ground?","Fine, you win. Can we stop now?","Wouldn't peace be better than war?","Do you really want to waste more resources on this fight?"]},{tags:["angered by dominance","not friendly"],lines:["Oh man, this is getting out of hand...","Not gonna lie, you're making me nervous.","Oh wow, you've grown... A LOT.","Damn... You're getting powerful.","I don't like where this is going...","Damn, how did you get so far ahead?","Doing quite well for yourself, aren't you?","Your rise in power is unsettling...","Care to share some of that land with the rest of us?","Your strength is impressive... And a bit unsettling, if I'm being honest.","You're getting a bit too big for comfort, you know."]},{tags:["angered by dominance","friendly"],lines:["I'm impressed... And a bit worried, if I'm being honest.","O-oh hey, friend!","Sure glad to be on your good side, haha. Ha...","H-hi?","W-we're still good, right?","I can still trust you, right?","A-are we still cool?","We're still good, yeah?","An impressive empire you've built there. Not that I'm jealous or anything...","Uh, so... Just checking, we're good, yeah?","Wouldn't want to get on your bad side, haha...","You're not, like, plotting my demise or anything, right?"]},{tags:["truce","angered by rivalry","not hostile","not weaker"],lines:["You're kind of undermining my authority here.","Looks like we have a problem.","This island isn't large enough for the two of us, is it?","Ready to finish this?","Shall we get this over with?","Time for a final showdown?","This will be a battle for the ages.","Ready to settle this once and for all?","I think it's time we find out who's the better ruler.","Ready to face your destiny?","I hope you're ready for a fight.","Let's see if you're truly fit to rule your kingdom.","This island cannot have two kings.","It's time for you to bow to me.","This island needs a true leader.","You'll soon realize that I'm the true ruler of this island."]},{tags:["truce","common enemy","neutral"],lines:["It's not me you should worry about.","You know who the real enemy is, right?","We should be working together if we want to survive.","If you want to survive, we need to work together.","Let's put aside our differences and face this together.","Now is not the time for petty squabbles.","I'm ready to pitch in if you are.","We have to fight together if we want to survive.","Now is the time to join forces."]},{tags:["truce","common enemy","friendly","weaker"],lines:["I can help you turn this around!","Let's team up!","I'm on your side!","I'm in this with you!","I'll pitch in if you lead the charge!","With my help, we can turn this around!","I'm ready to fight by your side!","Let me lend a hand!","Together we can face this threat!","I will not disappoint you!"]},{tags:["truce","common enemy","friendly"],lines:["We should work together!","Let's team up!","I'm ready to fight by your side!","Together we can do this!","I'm ready to help!","It will be an honor to fight by your side!","Let's give them hell!","Right behind you!","Don't worry, I've got your back!","We can do this!","Let's show 'em what we're made of!"]},{tags:["truce","hostile","much stronger"],lines:["I don't talk to ants.","Pathetic.","You're nothing to me.","You're not worth my time.","Don't waste my time.","Don't make me laugh.","You amuse me.","You're like an irritating bug.","You're like a pebble in my shoe.","You're like a buzzing fly that I'd love to squish.","Your words are worth nothing.","You're not worth my time.","Nothing but an insect."]},{tags:["truce","hostile","stronger"],lines:["Mhhh...","I'll get to you soon enough.","You want to start something? Yeah?","Wanna dance?","You'll face the music soon enough.","You'll get yours, just wait and see.","I'll have your head soon enough.","Just you wait...","You'll pay for your insolence soon enough.","I'm coming for you.","Get out of my sight.","My army will crush yours into dust.","I have a score to settle with you."]},{tags:["truce","hostile","similar strength"],lines:["I have nothing to say to you.","I look forward to meeting you in battle.","We shall meet on the battlefield soon enough.","Wanna dance?","I'm coming for you.","Just you wait...","Get out of my sight.","I have a score to settle with you."]},{tags:["truce","hostile","weaker"],lines:["This is not good...","Oh man, oh man...","Damnit...","Sweet mother of mercy...","Ahh, this is bad, this is really bad.","What do I do, what do I do...","Oh no, he's looking at me...","It's over for me, isn't it...?","I'm in trouble, aren't I?","*gulp*","This is not looking so good..."]},{tags:["truce","neutral","much stronger"],lines:["Oh, it's you. How quaint.","Ah, it's you again.","Oh, it's you.","I don't care.","You better behave.","I'm watching you.","Be nice, now.","I have more important things to do.","Whatever you want, I don't care.","Are you sure you want to draw my attention?","Not interested.","You're insignificant.","Don't waste my time.","I have bigger things to worry about.","I'm not in the mood for your nonsense.","Wow, you're so small and insignificant!","You're so weak, it's embarrassing!","Ha! Your little kingdom is nothing compared to mine!","Hahaha, keep dreaming little one!"]},{tags:["truce","neutral","stronger"],lines:["Ah, it's you again.","Oh, it's you.","I'm watching you.","I'm keeping my eye on you.","Don't even think about it.","Don't start any trouble, ok?","Trust me, you don't want to mess with me.","You're not about to start anything, are you?","If you cross me, I won't show any mercy.","Look, I'm warning you right now.","Think twice before you do anything stupid.","You're not going to cause any problems now, are you?"]},{tags:["truce","neutral","similar strength"],lines:["Oh, it's you.","I'm watching you.","I'm keeping my eye on you.","Don't even think about it.","You don't want to mess with me, trust me.","You're not about to start anything, are you?","...","Don't cross me.","Go ahead, test me if you want.","Trust me, you'd rather be on my good side.","I'm not someone you'd want to mess with.","Don't get on my bad side if you know what's good for you."]},{tags:["truce","neutral","much weaker"],lines:["Oh no. I mean, hi?","Don't look at me like that!","Please don't.","I know my place, okay?","You know I'm not worth worrying about.","Just ignore me?","No need to worry about me.","Hey, don't get distracted by me.","I'll just stay out of the way.","Look, I'm not worth your time.","Yes, I'm still alive."]},{tags:["truce","neutral","weaker"],lines:["Trust me, I'm not worth the trouble.","Is there a problem?","Should I be worried?","I assure you, I can still bite if you mess with me.","Oh, hi.","Y-You don't scare me.","...","Can we talk about this?","I have a bad feeling about this.","Please stop staring at me like that.","So, um.","Don't worry about me."]},{tags:["truce","ally","stronger"],lines:["Don't worry, I've got you covered.","I can protect you.","I'll keep you safe.","You're safe with me.","I've got your back.","I'll protect you.","My army can handle whatever comes our way.","Your help is appreciated!","We've got this!"]},{tags:["truce","ally","similar strength"],lines:["We're in this together!","Together we can prevail!","Let's do this!","I've got your back!","You can count on me!","I'm ready to fight by your side!","We can do this!","We've got this!","Let's show them what we've got!","Let's fight for our people!","I'm with you every step of the way!"]},{tags:["truce","ally","much weaker"],lines:["Hey, it's just little ol' me, your humble servant!","I know it's not much, but I'll do what I can to help!","Don't worry, I won't get in your way!","I'll do my best to help!","I'll do what I can to help!","I know I can't do much, but I can still help!","I may not have much, but I'll do my best!","I may be small, but I'll give it my all!","I'll do my part, even if it's not much!","Ready to follow your lead!","I'm ready to back you up!","I'll try my best to support you!"]},{tags:["truce","ally","weaker"],lines:["I'm here to help!","I'll do my best!","We can do this!","We've got this!","Let's show them what we've got!","You can count on me!","Together we can do this!","Together we shall prevail!","I'm ready to fight by your side!","I will not let you down!","I will not fail you!"]},{tags:["truce","friendly","stronger"],lines:["Hey there little fella.","Hey there, buddy.","Oh, what a quaint little kingdom you have!","Aww, you're cute.","You're doing great, little buddy!","Your kingdom is adorable!","I love your little kingdom.","Don't worry, you're still the cutest.","Your little kingdom is the cutest!","What's up, my friend?"]},{tags:["truce","friendly","not weaker"],lines:["Hi hi!","Hey there, friend.","Hey, what's up?","Hi!","How's it going?","Good to see you.","Howdy!","Greetings!","How do you do?","Hey, how are you?","Hello there.","How's the weather?","Nice to see you.","Salutations!","Nice day for fishing, ain't it?","Hello!","Take care!"]},{tags:["truce","friendly","weaker"],lines:["I'm impressed... And a bit worried, if I'm being honest.","O-oh hey, friend!","Sure glad to be on your good side, haha. Ha...","H-hi?","W-we're still good, right?","I can still trust you, right?","A-are we still cool?","We're still good, yeah?","An impressive empire you've built there. Not that I'm jealous or anything...","Wouldn't want to get on your bad side, haha.","Wow, you're doing great!","I'm glad we're friends!","I'm sure glad we're on the same side!","You wouldn't turn against me, would you?","Uh, so... Just checking, we're good, yeah?","You're not, like, plotting my demise or anything, right?"]},{tags:["approving attack","friendly"],lines:["Right on!","That's the spirit!","Nicely done!","Good job!","Well done!","Wow, nice one!","Impressive!","Outstanding!","Bravo!","Great work!","Well played!","Wonderful!","Keep it up!","Fantastic!","Excellent!","Good work!","Amazing!","That was badass!","That was awesome!","Hell yeah!","That's what I'm talking about!"]},{tags:["approving attack","not friendly"],lines:["Hmm, not bad.","Huh, maybe you're not so bad after all.","Not bad.","Not half bad. Maybe I was wrong about you.","Keep it up and I might even like you.","Hmph, you're not as useless as I thought.","Very well, you've earned my begrudging respect.","You're not completely useless, I suppose.","Huh, that was kind of impressive."]},{tags:["approving non-aggression","friendly"],lines:["Wow, thanks!","I knew I could trust you.","I appreciate that!","Thank you!","Thanks!","You have my gratitude.","Thank you for your wise decision!"]},{tags:["approving non-aggression","not friendly"],lines:["Wait, what?","Huh.","Wow, did not expect you to hold back.","Hmm, maybe you're not so bad after all.","Huh, didn't think you had it in you.","Hm, wasn't expecting that from you.","Wait, why are you not attacking?","A truce? I'll consider it.","Wow, didn't expect you to show restraint.","Fine, maybe you're not as bad as I thought."]}]},11948:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toggleStory=void 0;const s=i(36014),n=i(58609),o=i(96137),a=i(16007);t.toggleStory={name:"Toggle",content:e=>[{name:"difficulty toggle / wood theme",component:new n.DifficultyToggle(e,{theme:s.ToggleThemes.wood}),backgroundColor:o.Colors.woodenUi.pergamen},{name:"difficulty toggle / ocean contrast theme",component:new n.DifficultyToggle(e,{theme:s.ToggleThemes.oceanDark})},{name:"difficulty toggle / on card & small",component:new n.DifficultyToggle(e,{theme:s.ToggleThemes.onCard,size:"small"})},{name:"zombify toggle (glass theme)",backgroundColor:e=>o.Colors.glassUi.card,component:new s.Toggle(e,{enabled:!0,initialValue:"on",theme:s.ToggleThemes.glass,width:120,onSelected:e=>{console.log("selected",e)},options:[{value:"on",text:"ON",bgColor:7166575,icon:"ui/level-features/zombies"},{value:"off",text:"OFF",bgColor:o.Colors.glassUi.textMain}]})},{name:"playback speed toggle",backgroundColor:e=>e.oceanShades.dark3,component:new s.Toggle(e,{height:30,width:150,options:[{icon:"ui/mini-icons/play",tintIcon:!0,value:a.SpectatingPlaybackSpeed.Normal},{icon:"ui/mini-icons/fast-forward",tintIcon:!0,value:a.SpectatingPlaybackSpeed.Fast},{icon:"ui/mini-icons/super-fast-forward",tintIcon:!0,value:a.SpectatingPlaybackSpeed.UltraFast}],enabled:!0,onSelected:e=>{console.log(e)},theme:s.ToggleThemes.onCard})}]}},12051:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelListScene=void 0;const s=i(897),n=i(30948),o=i(81700),a=i(12605),r=i(20087),l=i(28937),c=i(56824),d=i(6772),h=i(36868),u=i(93938),p=i(2426),g=i(91622),m=i(7782),y=i(55275),f=i(54429),w=i(73054),v=i(1187),b=i(66272);c.logger.for("LevelListScene");class S extends n.BaseUIScene{constructor(){super({key:o.Scenes.LevelList,bounds:new u.LevelListBounds}),this.preUpdate=(0,s.whenDirty)((()=>{this.clickTrap.setSize(this.bounds.width,this.bounds.height),this.highlightBox.x=10,this.highlightBox.setSize(this.bounds.width-20,30),this.selectedRowBox.x=10,this.selectedRowBox.setSize(this.bounds.width-20,30);const e=this._getRowsToDisplay();for(let t of e)t.setSize(this.bounds.width,30);r.Arrange.alignX({content:e,x:0,origin:0}),r.Arrange.topToBottom({content:e,origin:0,y:0,spacing:0})}))}get contentHeight(){const e=this._getRowsToDisplay();if(!e.length)return 0;const t=e[e.length-1];return t.y+t.height}create(){this.scrollController=(0,a.makeSceneScrollable)(this),super.create(),this.state=(0,y.stateContainer)({open:!1,levelFilter:f.LevelFilter.Unlocked,levels:[],sortBy:b.SortBy.LevelNumber},this.applyState.bind(this)),this.model=new w.LevelListModel,this.clickTrap=new l.ClickTrap(this).setScrollFactor(0),this.highlightBox=new p.RoundedRect(this,{radius:4}),this.selectedRowBox=new p.RoundedRect(this,{radius:4}),this.highlightY=m.Control.propOf(this.highlightBox,"y",{duration:100,ease:"Sine.easeIn"}),this.levelRows=new v.GameObjectList(((e,t,i)=>(i||((i=new d.LevelDetailRow(this)).onClick((()=>this._handleRowClick(t))),i.onPointerOver((()=>this._handlePointerOverRow(t))),i.onPointerOut((()=>this._handlePointerOut(t))),this.add.existing(i)),i.updateContent(e),i))),this.lockedLevelsRow=new d.LockedLevelsRow(this),this.lockedLevelsRow.setVisible(!1),this.addAll([this.clickTrap,this.highlightBox,this.selectedRowBox,this.lockedLevelsRow]),this.highlightBox.setVisible(!1),this.selectedRowBox.setVisible(!1),this.scene.sleep(),g.inject.theme.use((e=>{this.highlightBox.setLineStyle(e.oceanShades.light2,1),this.selectedRowBox.setFillStyle(e.oceanShades.light2,.5),this.levelRows.get().forEach((e=>e.updateStyle()))})),this.observe.watch(g.inject.ui.selectedLevelId,(e=>{const t=this.model.shownLevels.findIndex((t=>t.id===e));-1===t?this.selectedRowBox.setVisible(!1):(this.updateContent(),this.selectedRowBox.setVisible(!0),this.selectedRowBox.y=this.levelRows.get()[t].y)})),this.visibility=new m.TransitionController(this,{initialValue:0,duration:c.config.screenTransitionDuration,ease:"Sine.easeOut",applyValue:e=>{0===e&&this.scene.sleep(),this.cameras.main.scrollX=this.bounds.width*(1-e)}}),this.visibility.applyCurrentValue()}applyState(e,t,i,s){(e.levels||e.levelFilter||e.sortBy)&&(this.model.updateState(t.levels,t.levelFilter,t.sortBy),this.scrollController.cameraY.setTo(0),this.selectedRowBox.setVisible(!1)),t.open?(this.updateContent(),this.scene.wake(),this.visibility.setTo(1,s)):this.visibility.setTo(0,s)}updateContent(){const e=this.state().sortBy===b.SortBy.TurnCount?"turn-count":"modes",t=this.state().sortBy===b.SortBy.LevelNumber;this.levelRows.set(this.model.shownLevels.map((i=>({level:i,attachment:e,showNumber:t})))),this.lockedLevelsRow.setCount(this.model.lockedLevelsCount),this.preUpdate.force()}_handleRowClick(e){const t=this.model.shownLevels[e];t&&c.events.trigger(h.UserActions.SelectIsland(t.id))}_handlePointerOverRow(e){this.model.shownLevels[e]&&(this.highlightBox.setVisible(!0),this.highlightY.setTo(this.levelRows.get()[e].y))}_handlePointerOut(e){this.highlightBox.y===this.levelRows.get()[e].y&&this.highlightBox.setVisible(!1)}_getRowsToDisplay(){const e=[...this.levelRows.get()];return this.lockedLevelsRow.visible&&e.push(this.lockedLevelsRow),e}update(e,t){super.update(e,t)}}t.LevelListScene=S},12156:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.spawnCamps=async function(e,t,i,s){const n=e.regions.all().filter((e=>!e.isAlive())).flatMap((e=>e.hexes.members)).filter((t=>!e.pawns.traitPresentAtHex(t,l.PawnTraits.PreventsBuilding))),d=new o.default(((t,i)=>c(e,i)-c(e,t)));for(let e of n)d.push(e);for(let s=0;s<t.count;s++){const s=d.pop(),n=i.oneOf(t.pool);s&&(e.factions.byId(a.SpecialFaction.neutral).takeOverHex(s),e.pawns.create({type:n,hex:s}),n===r.PawnType.Camp&&e.pawns.create({type:r.PawnType.Coins,hex:s,count:6}),d.heapify())}};const n=i(77330),o=s(i(65731)),a=i(67274),r=i(24598),l=i(63521);function c(e,t){const i=n.Bandits.getNearestCampDistance(e.state,t.id),s=i===Number.POSITIVE_INFINITY?0:1/(i+1)*10;return n.Bandits.getNearestLootDistance(e.state,t.id)-s}},12167:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FloatingWorldMapPanel=t.DIALOG_BUTTONS=void 0;const s=i(86545),n=i(96137),o=i(91622),a=i(36868),r=i(20087),l=i(55776),c=i(54825),d=i(74783),h=i(11862),u=i(7782),p=i(8),g=i(87936),m=i(9292),y=i(21941),f=i(56824),w=i(79899);t.DIALOG_BUTTONS={leaveTutorial:{text:"Leave Tutorial",icon:"ui/button-icons/leave",action:"leaveTutorial"},restartTutorial:{text:"Restart Tutorial",icon:"ui/button-icons/restart",action:"restartTutorial"},howToPlay:{text:"How To Play",icon:"ui/button-icons/question-mark",action:"viewHelp"},moreInfo:{text:"More info",icon:"ui/button-icons/question-mark",action:"viewHelp"},showMe:{text:"Show me",icon:"ui/button-icons/search",action:"viewHelp"},shutUp:{text:"Shut up!",icon:"ui/button-icons/exit",action:"mute"},readFullIntro:{text:"Read more",icon:"ui/button-icons/help",action:"readFullIntro"}};const v=32;class b extends s.AutoHeightResponsiveContainer{constructor(e){super(e.scene),this.ui=e,this.bgCard=this.ui.box(y.BoxTextures.FloatingCard),this.emoji=new l.EmojiContainer(c.app.scene.backgroundUI.objectsPool),this.text=this.ui.richText("Sample text",n.Colors.glassUi.textMain),this.buttons=[],this.glint=this.ui.image("glass-ui/card-horizontal-glint"),this.typewriter=new h.Typewriter(this.text),this.baseY=0,this.finalTextHeight=0,this.explicitlyHidden=!1,this.hasShowIntroButton=!1,this.dismissButton=new w.ImageButton(this.scene,0,0,{frame:"ui/mini-close-button"}),this.visibility=new u.TransitionController(this.scene,{applyValue:e=>{this.setAlpha(e),this.setVisible(e>0),this.y=this.baseY+40*(1-e)},duration:200,initialValue:0}),this.width=460,this.bgCard.setInteractive({cursor:"default"}),this.bgCard.on("pointerdown",(()=>{this.typewriter.fastForward()})),this.emoji.setColor(d.EMOJI_COLORS[2]),this.emoji.setScale(2,2),this.dismissButton.onClicked((()=>{this.explicitlyHidden=!0,this.visibility.transitionTo(0)})),o.inject.theme.use((e=>{this.bgCard.setTint(e.oceanShades.light1).setAlpha(.85),this.text.setColor(e.oceanContrastDark),this.dismissButton.setConfig({tint:{default:e.oceanShades.dark3,hover:e.oceanContrastDark}})})),this.add([this.bgCard,this.glint,this.text,this.emoji,this.dismissButton]),this.setVisible(!1)}updateState(e){const t=1===this.visibility.currentTarget;if(e){if(this.explicitlyHidden&&this.typewriter.finalText===e.text)return;this.visibility.transitionTo(1),this.updateButtons(e),this.emoji.setFace(e.emojiEmotion),t&&this.typewriter.finalText===e.text||(this.updateFinalTextSize(e.text),this.typewriter.start(e.text)),this.updateLayout(),this.hasShowIntroButton=e.buttons.some((e=>"readFullIntro"===e.action))}else this.visibility.transitionTo(0),this.explicitlyHidden=!1}updateFinalTextSize(e){this.typewriter.finalText!==e&&(this.text.setText(e),this.finalTextHeight=this.text.displayHeight,this.updateLayout())}updatePosition(e){this.updateFinalTextSize(e);const t=o.inject.views.mapGeometry.get(o.inject.currentGameState).topCenterPoint,i=(c.app.scene.worldMap.cameras.main.zoom,(0,p.convertWorldXYToCameraXY)(c.app.scene.worldMap.cameras.main,t.x,t.y));this.x=(0,m.cropNumber)(i.x-this.width/2,4,c.app.scene.backgroundUI.bounds.width-this.width-44),this.baseY=i.y-this.height,this.buttons.length>0&&!this.hasShowIntroButton&&(this.baseY+=g.HEX_HEIGHT)}updateButtons(e){for(let t=0;t<e.buttons.length;t++)this.createOrUpdateButton(t,e.buttons[t]);for(let t=e.buttons.length;t<this.buttons.length;t++)this.buttons[t].destroy();this.buttons.splice(e.buttons.length)}createOrUpdateButton(e,t){this.buttons[e]&&this.buttons[e].destroy(),this.buttons[e]=this.ui.outlineButton({icon:t.icon,text:t.text,theme:"dark",onClicked:()=>{o.inject.ui.defaultPointerAction.clear(),f.events.trigger(a.UserActions.WorldMapPanelButtonClicked(t.action))}}),this.add(this.buttons[e])}calculateHeight(){if(this.buttons.length){const e=this.buttons[this.buttons.length-1];return e.y+e.height+v}return this.finalTextHeight+64}updateLayout(){const e=this.emoji.faceBg.height;this.glint.setOrigin(.5,0),this.glint.setPosition(this.width/2,3),this.text.setPosition(v+e+28,v),this.text.setWordWrapWidth(this.width-v-this.text.x),r.Arrange.topToBottom({content:[...this.buttons],y:64+this.finalTextHeight,origin:0,spacing:8}),r.Arrange.alignX({content:this.buttons,x:this.width-v,origin:1}),this.updateSize(),this.dismissButton.setPosition(this.width-this.dismissButton.width-12,14),this.bgCard.setSize(this.width,this.height+20),this.emoji.setPosition(v+e/2,this.text.y+this.finalTextHeight/2)}}t.FloatingWorldMapPanel=b},12543:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hexBasedAdapter=function(e){return{getHexes:e=>s.HexGroup.union(n.Regions.model(e).all().map((e=>e.hexes))),getValue:(t,i)=>e.getValue(t,i),getDetail:(t,i)=>e.getDetail(t,i),getGroups:e.getGroups}};const s=i(20693),n=i(56038)},12605:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StopsProviders=t.ScrollableViewController=void 0,t.makeSceneScrollable=function(e,t){return new c(e.cameras.main,{horizontal:!1,vertical:!0,maxSpeed:1e3,allowanceAfterLastStop:50,verticalStops:{getNextFrom:e=>e<0?0:void 0,getPreviousFrom:t=>{const i=(0,l.pickLarger)(e.contentHeight-e.bounds.height,0);return t>i?(0,l.pickLarger)(i,0):void 0}},...t})};const s=i(49796),n=i(56824),o=i(41229),a=i(91622),r=i(2426),l=i(9292);n.logger.for("ScrollableViewController");class c{constructor(e,t={}){this.camera=e,this.dragging=!1,this.deadzone=20,this.dragMomentumX=0,this.dragMomentumY=0,this.drag=3e3,this.dragStartPosition=void 0,this.enableX=!0,this.enableY=!0,this.scene=this.camera.scene,t.scrollbar&&(this.scrollbar=new r.RoundedRect(this.scene,{radius:3,fillStyle:{color:16777215,alpha:.1}}).setScrollFactor(0),this.scene.add.existing(this.scrollbar)),this.cameraY=new o.KineticValue(e.scrollX,{drag:this.drag,scene:this.scene,maxSpeed:t.maxSpeed,apply:e=>this.camera.scrollY=e,continueToNextStopThreshold:t.continueToNextStopThreshold,stops:t.verticalStops,allowancePastLastStop:t.allowanceAfterLastStop}),this.cameraX=new o.KineticValue(0,{drag:this.drag,scene:this.scene,maxSpeed:t.maxSpeed,apply:e=>{this.camera.scrollX=e},continueToNextStopThreshold:t.continueToNextStopThreshold,stops:t.horizontalStops,allowancePastLastStop:t.allowanceAfterLastStop}),t.drag&&(this.drag=t.drag),!1===t.vertical&&(this.enableY=!1),!1===t.horizontal&&(this.enableX=!1),void 0!==t.deadzone&&(this.deadzone=t.deadzone),this.pointer=this.scene.input.activePointer,this.scene.input.on("pointerdown",this.handlePointerDown,this),this.scene.input.on("pointermove",this.handlePointerMove,this),this.scene.input.on("pointerup",this.handlePointerUp,this),this.scene.input.on("wheel",((e,t,i,s,n)=>{if(!this.acquireDragLockIfOverScene(e))return;let o=5*s;this.enableY?(this.cameraY.accelerate(o),Math.abs(this.cameraY.speed)<this.cameraY.continueToNextStopThreshold&&(this.cameraY.speed>0?this.cameraY.pushToNextStop():this.cameraY.pushToPrevStop())):(this.cameraX.accelerate(o),Math.abs(this.cameraX.speed)<this.cameraX.continueToNextStopThreshold&&(this.cameraX.speed>0?this.cameraX.pushToNextStop():this.cameraX.pushToPrevStop())),setTimeout((()=>a.inject.ui.pointerDragLock.release()),0)}),this),this.scene.events.on("update",this.update,this)}acquireDragLockIfOverScene(e){return!!Phaser.Geom.Rectangle.FromXY(this.camera.x,this.camera.y,this.camera.x+this.camera.width,this.camera.y+this.camera.height).contains(e.x,e.y)&&a.inject.ui.pointerDragLock.acquire()}detach(){this.scene.input.removeListener("pointermove",this.handlePointerMove),this.scene.input.removeListener("update",this.update)}update(e,t){if(this.dragMomentumX*=.8,this.dragMomentumY*=.8,this.enableX&&this.cameraX.update(e,t),this.enableY&&this.cameraY.update(e,t),this.scrollbar){const e=this.cameraY.stops?.getNextFrom(Number.MIN_SAFE_INTEGER)??0,t=this.cameraY.stops?.getPreviousFrom(Number.MAX_SAFE_INTEGER)??0,i=t-e;if(i>0){this.scrollbar.setToTop();const s=i+this.scene.bounds.height,n=this.scene.bounds.height,o=n/s*n,a=e+(this.cameraY.value-e)/(t-e)*(n-o);this.scrollbar.setVisible(!0),this.scrollbar.setPosition(this.scene.bounds.width-6,a),this.scrollbar.setSize(6,o)}else this.scrollbar.setVisible(!1)}}startDrag(){this.dragging=!0,this.dragCursorIconOn(),this.cameraX.freeze(),this.cameraY.freeze()}stopDrag(){if(!this.dragging)return 0;this.dragging=!1,this.cameraX.unfreeze(),this.cameraY.unfreeze(),this.cameraX.accelerate(this.dragMomentumX),this.cameraY.accelerate(this.dragMomentumY),this.dragCursorIconOff()}async panTo(e,t,i=0){const s=e-this.camera.width/2,n=t-this.camera.height/2;0===i?(this.enableX&&this.cameraX.setTo(s),this.enableY&&this.cameraY.setTo(n)):await Promise.all([this.enableX&&this.cameraX.tweenTo(s,i,"Sine.easeInOut"),this.enableY&&this.cameraY.tweenTo(n,i,"Sine.easeInOut")])}dragCursorIconOn(){this.scene.game.canvas.style.cursor="grabbing"}dragCursorIconOff(){this.scene.game.canvas.style.cursor="default"}handlePointerMove(e){if(this.dragging){if(!e.isDown)return this.cameraX.unfreeze(),this.cameraY.unfreeze(),void this.stopDrag();const t=e.position.x-e.prevPosition.x,i=e.position.y-e.prevPosition.y;this.dragMomentumX-=10*t,this.dragMomentumY-=10*i,this.enableX&&this.cameraX.setTo(this.cameraX.value-t/this.camera.zoom),this.enableY&&this.cameraY.setTo(this.cameraY.value-i/this.camera.zoom)}else this.dragStartPosition&&e.isDown&&(0,s.euclidDistance)(this.dragStartPosition,{x:this.pointer.x,y:this.pointer.y})>this.deadzone&&this.startDrag()}handlePointerDown(e){this.acquireDragLockIfOverScene(e)&&(this.dragStartPosition={...e.position})}handlePointerUp(){a.inject.ui.pointerDragLock.release(),this.dragStartPosition=void 0,this.stopDrag()}}t.ScrollableViewController=c,t.StopsProviders={range:(e,t)=>({getNextFrom(e){if(!(e>t))return t},getPreviousFrom(t){if(!(t<e))return e}}),dynamicBounds:(e,t)=>({getNextFrom(t){const i=e();if(t<i)return i},getPreviousFrom(e){const i=t();if(e>i)return i}})}},12686:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BulldozerTool=void 0,t.deleteTile=n;const s=i(91622);function n(e){const t=s.inject.gameStateModel,i=t.regions.byHex(e),n=t.factions.byHex(e);i&&n&&(t.pawns.destroy(...t.pawns.byHex(e)),t.regions.byHex(e).removeHexes(e),n.splitRegionIfDisconnected(i))}t.BulldozerTool=class{constructor(){this.options={title:"Delete Tile",description:"click = delete tile\nshift-click = larger brush        \nctrl-click = delete objects",allowLargeBrushes:!0},this.iconRecipe="editor/buldozer"}useOn(e,t){t.ctrl?function(e){const t=s.inject.gameStateModel;t.pawns.destroy(...t.pawns.byHex(e))}(e):n(e)}}},12784:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playCoinTransaction=async function(e,t,i){n.CurrentPhase.model(i).isLocalPlayerTurn()&&!(0,o.isViewingReplay)()?s.app.scene.worldMap.coins.play(t.coinTransaction):s.app.scene.worldMap.coins.applyTransactions(t.coinTransaction)};const s=i(54825),n=i(45084),o=i(68878)},12933:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.doHandleEvent=async function(e,t){switch(t.name){case s.GameStateEvents.NewGameState.eventName:return(0,r.handleNewGameState)(n.app.scene.play,t.payload.state,t.payload.context);case s.GameStateEvents.GameOver.eventName:return(0,o.handleGameOver)(t.payload);case s.GameStateEvents.PawnBought.eventName:return e.handlePawnBought(t.payload);case s.GameStateEvents.FactionEconomyUpdated.eventName:return e.handleFactionEconomyUpdated(t.payload);case s.GameStateEvents.HexCaptured.eventName:return e.handleHexCaptured(t.payload);case s.GameStateEvents.PawnMoved.eventName:return e.handlePawnMoved(t.payload);case s.GameStateEvents.FactionTurnOver.eventName:return e.handleFactionTurnOver(t.payload);case s.GameStateEvents.CutOffUnitsTurnedBandits.eventName:return e.handleCutOffUnitsTurnedBandits(t.payload);case s.GameStateEvents.FactionCreditChanged.eventName:return e.handleCreditChange(t.payload)}};const s=i(36868),n=i(54825),o=i(32408),a=i(56824),r=i(75131);a.logger.for("BaseMode")},13363:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MultiColorBox=void 0;const s=i(61727);class n extends s.GraphicsContainer{constructor(e,t){super(e),this.props=t}setTint(e){return this}clearTint(){return this}render(e,t){const i=this.props.radius??8,[s,n,o,a]=this.props.colors;this.fillStyle(s,1),this.fillRoundedRect(0,0,e/2,t/2,{tl:i,tr:0,bl:0,br:0}),this.fillStyle(n,1),this.fillRoundedRect(e/2,0,e/2,t/2,{tl:0,tr:i,bl:0,br:0}),this.fillStyle(o,1),this.fillRoundedRect(0,t/2,e/2,t/2,{tl:0,tr:0,bl:i,br:0}),this.fillStyle(a,1),this.fillRoundedRect(e/2,t/2,e/2,t/2,{tl:0,tr:0,bl:0,br:i}),this.props.lineColor&&(this.lineStyle(1,this.props.lineColor.color,this.props.lineColor.alpha),this.strokeRoundedRect(0,0,e,t,this.props.radius??8))}}t.MultiColorBox=n},13419:(e,t,i)=>{"use strict";function s(){if(!i.g.window)return null;const e=new URLSearchParams(window.location.search);return"iframe"===e.get("utm_medium")?e.get("utm_source"):e.get("kongregate")?"kongregate":null}Object.defineProperty(t,"__esModule",{value:!0}),t.getFrameParent=s,t.isRunningAt=function(...e){const t=s();return!(!t||!e.includes(t))},t.isPortableModeRequested=function(){if(!i.g.window)return!1;const e=i.g.window.location.search;return!!new URLSearchParams(e).get("portable")}},13426:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CloudSyncStatusLabel=t.StatusLabel=void 0;const s=i(89413),n=i(86545),o=i(80959),a=i(9292),r={[s.CloudSyncState.Synchronized]:{icon:"ui/icons/cloud-ok",text:"Progress saved."},[s.CloudSyncState.Synchronizing]:{icon:"ui/icons/cloud-syncing",text:"Saving progress..."},[s.CloudSyncState.NotAvailable]:{icon:"ui/icons/cloud-failed",text:"Disconnected."},[s.CloudSyncState.Disabled]:{icon:"ui/icons/cloud-failed",text:"Disconnected."}};class l extends n.AutoHeightResponsiveContainer{constructor(e){super(e);const t=o.UiBuilder.for(this.scene);this.label=t.richText("",(e=>e.white)).setOrigin(0,.5),this.icon=t.image(r[s.CloudSyncState.Synchronizing].icon),this.add([this.label,this.icon])}updateLayout(){this.icon.setPosition(0,0),this.label.setPosition(30,this.icon.height/2),this.updateSize()}setProps({text:e,icon:t}){this.label.setText(e),this.icon.setFrame(t).setOrigin(0,0),this.updateLayout()}calculateHeight(){return(0,a.pickLarger)(this.label.height,this.icon.height)}}t.StatusLabel=l,t.CloudSyncStatusLabel=class extends l{setSyncState(e){this.setProps(r[e])}}},13521:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnHolder=void 0;var s=Phaser.GameObjects.Image;const n=i(97849),o=i(40951),a=i(79611);t.PawnHolder=class{constructor(e){this.scene=e}pickUpPawn(e,t,i,r=1,l){n.assert.undefined(this.heldPawn),this.heldPawn=e;const c=(0,a.getPawnRenderRecipe)(e).getFrame(l);this.heldPawnImage=new s(this.scene,t,i,"atlas",c),this.followCursor=!0,this.scene.add.existing(this.heldPawnImage),this.pickupTween=this.scene.tweens.add({targets:this.heldPawnImage,x:this.scene.input.activePointer.x,y:this.scene.input.activePointer.y,scale:{from:r,to:1},duration:o.TIMING.pawnPickupTransition,ease:"Sine.easeInOut",onComplete:()=>{this.pickupTween=void 0}})}update(){this.followCursor&&(this.heldPawnImage&&!this.pickupTween?this.heldPawnImage.setPosition(this.scene.input.activePointer.x,this.scene.input.activePointer.y):this.pickupTween?.isActive()&&(this.pickupTween.updateTo("x",this.scene.input.activePointer.x,!0),this.pickupTween.updateTo("y",this.scene.input.activePointer.y,!0)))}setFixedPosition(e,t){this.pickupTween&&this.pickupTween.stop(),this.followCursor=!1,this.pickupTween=this.scene.tweens.add({targets:this.heldPawnImage,x:e,y:t,scale:1,duration:o.TIMING.pawnPickupTransition,ease:"Sine.easeInOut",onComplete:()=>{this.pickupTween=void 0}})}dropPawn(e,t,i,s){const n=this.heldPawnImage;this.heldPawnImage=void 0,this.heldPawn=void 0,n?(this.pickupTween?.stop(),this.pickupTween=void 0,this.scene.tweens.add({targets:n,x:e,y:t,scale:i,duration:o.TIMING.pawnDropTransition,ease:"Sine.easeInOut",onComplete:()=>{n.destroy(),s?.()}})):s?.()}clear(){this.heldPawnImage?.destroy(),this.heldPawnImage=void 0,this.heldPawn=void 0,this.pickupTween?.stop(),this.pickupTween=void 0}setPawnType(e){this.heldPawnImage?.setFrame("pawns/"+e)}}},13554:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseKonkrData=async function e(t){if((0,s.isEncodedGameState)(t)){const e=(0,s.decodeGameState)(t);n.inject.editorSession.end(),n.inject.levelSession.startNew({origin:"file-import",levelId:e.map.levelId,turnNumber:e.currentPhase.turnNumber,aiDifficulty:n.inject.userData.recallChoice("aiDifficulty"),startingState:e}),n.inject.gameStateController.loadState(e,o.NewGameStateContext.LoadingGame),a.app.navigator.goTo(a.app.screen.play,o.NewGameStateContext.LoadingGame),a.app.scene.worldMap.syncState()}else if((0,s.isEncodedReplay)(t)){n.inject.editorSession.end(),n.inject.levelSession.end({origin:"file-import",wipeAutoSave:!1});try{(0,y.loadReplay)(t),await n.inject.userContent.importReplay(t)}catch(e){a.app.notifications.warning("Couldn't import replay.","Sorry, it seems this file is corrupted or no longer compatible with the current version of the game")}}else if((0,s.isEncodedV2UserData)(t))try{const e=(0,s.decodeV2UserData)(t);await f((0,g.migrateProgress)(e.levels))}catch(e){a.app.notifications.warning("Couldn't import player profile.","Sorry, it seems this file is corrupted or no longer compatible with the current version of the game")}else if((0,s.isEncodedUserData)(t))try{const e=(0,s.decodeUserData)(t);await f((0,m.mergeProgressData)(e.progress.local,e.progress.synced))}catch(e){a.app.notifications.warning("Couldn't import player profile.","Sorry, it seems this file is corrupted or no longer compatible with the current version of the game")}else if((0,s.isChatterFile)(t)){const{rules:e,errors:i}=(0,r.importChatter)(t);if(i.length>0){c.track.importChatterFile({success:!1});const e=i.map((e=>`[LINE ${e.line}] ${e.snippet}\n  ERROR: ${e.message}\n`)).join("\n");a.app.notifications.warning("Couldn't import chatter file. Found issues:",e,0)}else c.track.importChatterFile({success:!0}),(0,l.updateChatterRules)(e),a.app.notifications.success("Chatter file imported!",`${e.length} chatter rules were added to the game.`)}else{if(!(0,p.isDiscordAttachmentUrl)(t))throw new Error("File content is not compatible with this version of the game.");{const i=await(0,p.downloadDiscordAttachment)(t);i&&await e(i)}}};const s=i(85026),n=i(91622),o=i(71021),a=i(54825),r=i(44503),l=i(11874),c=i(51496),d=i(5365),h=i(63032),u=i(21817),p=i(62146),g=i(52979),m=i(83240),y=i(11651);async function f(e){await a.app.modals.simpleDialog({title:"Import progress",message:"Are you sure you want to import progress from this file?\nThe completed levels statistics from this file will be added to your current progress.",buttons:[{text:d.DialogButtons.Cancel,role:h.DialogButtonRole.Regular},{text:d.DialogButtons.Import,role:h.DialogButtonRole.PrimaryGreen}]})===d.DialogButtons.Import&&(n.inject.userData.importProgress(e),a.app.notifications.success("Progress imported!",`Completion record for ${Object.keys(e).length} islands was added your progress.`),a.app.scene.sidePanelUI.panels[u.SideBarMode.Settings].statsWidget.updateContent())}},13560:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NO_ASSET_VALUE=t.AssetValue=void 0,t.createAssetValueDebugLayer=function(){let e=(0,o.signal)();const i=()=>e.fire();return{name:"assetValue",onChange:e,getMap(){let e=new a.CustomHexGroupValuation("");for(let i of r.inject.gameStateModel.regions.allRegionsHexes())e.set(i.id,t.AssetValue.getTotal(r.inject.currentGameState,i).toFixed(0));return e},getDetail(e){const i=t.AssetValue.getFactors(r.inject.currentGameState,e);return(0,l.prettyPrintObject)(i)},activate(){r.inject.gameStateModel.stateEngine.watchAll(i)},deactivate(){r.inject.gameStateModel.stateEngine.stopWatching(i)}}},t.assetValueToDebugStr=function(e){return`${t.AssetValue.total(e)}\n(${c.GLYPH.sword}${e.offensive} ${c.GLYPH.defense}${e.defensive} ${c.GLYPH.coin}${e.economic})`};const s=i(81434),n=i(24598),o=i(18957),a=i(65415),r=i(91622),l=i(7334),c=i(19506),d=i(63521),h=i(9292),u={offensive:0,defensive:0,economic:10},p={[n.PawnType.Coins]:{defensive:1,offensive:1,economic:3},[n.PawnType.Town]:{offensive:0,defensive:60,economic:0},[n.PawnType.Villager]:{offensive:10,defensive:10,economic:30},[n.PawnType.Pikeman]:{offensive:60,defensive:60,economic:-30},[n.PawnType.Knight]:{offensive:160,defensive:80,economic:-90},[n.PawnType.Hero]:{offensive:200,defensive:80,economic:-270},[n.PawnType.UniqueHero]:{offensive:200,defensive:80,economic:100},[n.PawnType.Castle]:{offensive:0,defensive:120,economic:-20},[n.PawnType.Bandit]:{offensive:0,defensive:0,economic:-5},[n.PawnType.DreadKnight]:{offensive:160,defensive:80,economic:-90},[n.PawnType.Swamp]:{offensive:0,defensive:0,economic:-8},[n.PawnType.GoldMine]:{economic:90,offensive:0,defensive:0}};t.AssetValue={HEX_BASE_VALUE:u.defensive+u.economic+u.offensive,getTotal(e,t,i=!0,s=!1){const n=this.getFactors(e,t,i,s);return n.offensive+n.defensive+n.economic},getFactors(e,i,n=!0,o=!1){let a={...u};for(let r of s.Pawns.model(e).byHex(i))!n&&r.isMovable()||o&&r.hasTrait(d.PawnTraits.Unit)||(a=t.AssetValue.sum(a,this.getPawnFactors(r.type,r.count)));return a.economic=(0,h.pickLarger)(a.economic,5),a},getPawnFactors(e,i){const s=p[e];return s?{offensive:s.offensive*i,defensive:s.defensive*i,economic:s.economic*i}:t.NO_ASSET_VALUE},total:e=>e.economic+e.defensive+e.offensive,sum:(...e)=>e.reduce(((e,t)=>({economic:e.economic+t.economic,offensive:e.offensive+t.offensive,defensive:e.defensive+t.defensive})),{...t.NO_ASSET_VALUE}),subtract:(e,t)=>({economic:e.economic-t.economic,offensive:e.offensive-t.offensive,defensive:e.defensive-t.defensive})},t.NO_ASSET_VALUE=Object.freeze({offensive:0,economic:0,defensive:0})},13602:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AIMetrics=void 0,t.getJoinRegionsBonus=f,t.getObviousGameEndingThreat=b;const s=i(90048),n=i(8971),o=i(9292),a=i(70712),r=i(56038),l=i(19618),c=i(78635),d=i(80268),h=i(91622),u=i(24336),p=i(76985),g=i(81434),m=i(63521),y=i(13560);function f(e,t){const i=e.region,s=i.state,n=i.faction,o=r.Regions.model(s).byHex(t),l={incomeGain:0,conquestValueBonus:0};return a.AI.getHexInfluence(s,t.id).map(((t,c)=>{const d=r.Regions.model(s).byId(c);if(!d||d.faction!==n||d===i||d===o)return l;const h=a.AI.getRegionInfluence(s,d.id,i.id)?.proximity??Number.POSITIVE_INFINITY;if(t.distance>h)return l;const u=1===t.distance,p=u?1:1/(20+t.resistance*t.resistance);return d.isAlive()?{conquestValueBonus:Math.floor(5*p*(d.treasury+Math.abs(d.budget?.balance||0)))*e.focus.daring,incomeGain:u?d.budget?.balance??0:0}:{conquestValueBonus:Math.floor(50*p*d.budget.potentialIncome)*e.focus.daring,incomeGain:u?d.budget.potentialIncome:0}})).reduce(((e,t)=>({conquestValueBonus:e.conquestValueBonus+t.conquestValueBonus,incomeGain:e.incomeGain+t.incomeGain})),l)}function w(e){return 0===e?1:e>=1?.05/e:.95*(1-e)}var v;function b(e,t){const i=e.getTownHexes();if(1!==i.length)return 0;const s=i.first(),n=c.Warfare.getHexDefenseWithoutMovableUnits(e.state,s),r=h.inject.views.powerBalance.get(e.state),u=t.calculateComponents(s.id).find((t=>{const i=l.Factions.getByRegion(e.state,t.regionId),c=l.Factions.model(e.state).byId(i),u=a.AI.getHexInfluence(e.state,s.id,t.regionId),p=d.AIPolitics.is1v1BattleBetween(r,e.faction,c);return!!u&&!(!i||!t.riskByDefenderMight[n]||h.inject.views.perceivedThreat.get(e.state,{attackerRegionId:t.regionId,defenderRegionId:e.id})<.2)&&(u.distance<=1||n<2&&u.cost<=(0,o.pickSmaller)(e.size,20)||!(!p&&!a.AI.isUnderAttackByRegion(e.state,e.id,i))&&n<2&&t.riskByDefenderMight[n]>.2)}));return u?u.riskByDefenderMight[n]:0}t.AIMetrics={unitMightAverage:function(e){const t=e.totalUnits.getTotalMight()+e.getBuyableMight();if(0===t)return 1;return t/(e.totalUnits.count()+Math.floor(e.remainingGold/s.CHEAPEST_UNIT_COST))},economyHealth:function(e,t){if(1===t.daring)return 1;const i=2*e.regionSize;let s=u.RegionForecast.getTotal(e);return e.remainingGold<20&&e.remainingGold+e.remainingIncome>=20&&(s*=1.5),(0,o.cropNumber)(s/i,0,100)},riskToVulnerabilityPenalty:function(e,t){const i=(0,o.pickLarger)(0,e-1);return i?.875-i/16*t:1},getDefenseContribution:function(e){const{isFrontlineHex:t,hexExistingDefense:i,hexThreat:s,hexImportance:n,hasTown:a,defenderMight:r,expansionFocus:l}=e,c=t?1:.1;if(i>=r||i>s.strongestUnit)return 0;const d=(0,o.pickSmaller)(i,s.strongestUnit),h=(0,o.pickSmaller)(r,s.strongestUnit);let u=0;for(let e=d+1;e<=h;e++){const t=s.riskByDefenderMight[e-1]??0;u+=n*(t>0&&a?1:t)*(1-l)*c}return u},getJoinRegionsBonus:f,focusMismatchPenaltyV2:function(e,t,i){const s=(t.regionSize-e.initialRegionSize)/e.expansionTarget;return"defense"===i?(0,o.cropNumber)(s,.1,1):s<1?1:(0,o.cropNumber)(1/s,.5,1)},getRiskTolerance:e=>(0,n.adjustMultiplierByFocus)(.2,1-e),riskToSecurity:w,riskToTownSecurity:function(e,t){if(0===e)return 1;let i=(0,o.cropNumber)(.5-e,.01,.5);return t&&(i/=1.5),w(e)*i},getBaseAttackProbability:function(e,t,i,s,n){const a=n-(0,p.mightToUpkeep)(i+1)+(0,p.mightToUpkeep)(t),r=1===s&&e.totalUnits.getStrongest()>=t,l=e.getRawIncome()+1-(0,o.pickSmaller)(e.remainingIncome,0),c=l-a,d=((0,o.pickLarger)(c/2,0)+s)/e.regionSize,h=e.regionSize<10?1:2*d;return e.getMaxAvailableMight()<t?0:r?1:(0,o.cropNumber)((1-a/(l+6))*h,.01,1)},getObviousGameEndingThreat:b,defenseSkillToMaxThreatAwarenessRange:function(e){return 1===e?Number.POSITIVE_INFINITY:e<=.5?Math.ceil(10*e):Math.ceil(5+20*(e-.5))},attackSkillToPlanningRange:function(e){return 1===e?Number.POSITIVE_INFINITY:e<=.5?Math.ceil(15*e):Math.ceil(5+30*(e-.5))},snowballScale:function(e,t=1.1){return e<0?0:Math.pow(e,t)},getExpansionTarget:function(e){const t=.5*e.region.getMyAssets().getObtainableUnitCount();return Math.round(t*e.focus.daring)},getExpansionTargetScoreMultiplier:function(e){const t=e.expansionTarget,i=e.region.size-e.initialRegionSize;return i>=t?1:(0,o.pickLarger)(.01,i/t)},getPestEradicationBonus:function(e,t){if(!g.Pawns.isTraitPresentOnHex(e,t.id,m.PawnTraits.Pest))return 0;const i=2*y.AssetValue.getFactors(e,t).economic;return(0,o.cropNumber)(i,10,100)}},function(e){e[e.AlreadyHasUnit=0]="AlreadyHasUnit",e[e.CanAfford=1]="CanAfford",e[e.CanAffordButNotSupport=2]="CanAffordButNotSupport",e[e.CannotAfford=3]="CannotAfford"}(v||(v={}))},13622:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverworldPointersTracker=void 0;const s=i(93413),n=i(56824),o=i(36868),a=i(66143),r=i(91622),l=i(54825),c=i(98963);class d extends s.TwoPointersTracker{constructor(e,t){super(e),this.scrollController=t}getIslandUnderCursor(e,t){if(t.length)return t[0].getData("islandId")}hasInteraction(e,t){return!0}onStartInteraction(e,t){r.inject.ui.pointerDragLock.locked||this.scrollController.startDrag()}onStartPinch(e){l.app.scene.overworld.scrollController.stopDragging(),l.app.scene.overworld.zoomController.startPinchZoom()}onEndPinch(e){l.app.scene.overworld.zoomController.stopPinchZoom()}onCompleteInteraction(e,t){let i=this.getIslandUnderCursor(e,t);if(i){const e=a.LevelModel.for(i);e.isUnlocked()||e.isInProgress()||n.config.editOverworld||(i=void 0),i&&i===r.inject.ui.selectedLevelId()&&!e.isCompleted()?(n.events.trigger(o.UserActions.PlayLevel({levelId:i,origin:"campaign/play"})),l.app.audio.playEffect(c.SoundEffects.ShutterClick)):n.config.editOverworld&&i?l.app.scene.overworld.editor?.handleIslandClicked(i):n.events.trigger(o.UserActions.SelectIsland(i))}else n.events.trigger(o.UserActions.SelectIsland(i));this.scrollController.stopDragging()}onStartDrag(e){this.scrollController.startDrag()}onEndDrag(e){this.scrollController.stopDragging()}}t.OverworldPointersTracker=d},13659:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TooltipsManager=void 0;const s=i(80959),n=i(72843),o=i(63521),a=i(96137),r=i(24598),l=i(53010),c=i(91622),d=i(54825),h=i(34174),u=i(56824),p=i(2297),g=i(57189);t.TooltipsManager=class{get currentTooltip(){return this.scene?.tooltip}get activeTooltip(){const e=this.scene?.tooltip;if(e?.mode!==l.TooltipMode.ScheduledToShow&&e?.mode!==l.TooltipMode.Hidden)return e}get ui(){return this._builder||(this._builder=s.UiBuilder.for(d.app.scene.globalUI)),this._builder}get scene(){return d.app.scene.globalUI}close(){d.app.scene.globalUI?.tooltip.hide()}show(e){return d.app.scene.globalUI.addTooltip(e)}showOver(e,t){return this.show({...t,placement:h.Placement.aroundUiObject(e)})}showAt(e,t,i,s){return this.show({...s,placement:h.Placement.atGlobalXY(e,t,i)})}showAtHex(e,t){return this.show({...t,placement:h.Placement.atWorldMapHex(e)})}showDefenderTaunt(e,t,i){if(i.hasTrait(o.PawnTraits.Impenetrable)||i.faction===c.inject.gameStateModel.currentPhase.faction)return;let s=i.hex===e?u.random.oneOf(["Nice try!","Nope!","You wish!","@#!"]):"Not on my watch!";const a=i.hex===e?0:300;return i.type===r.PawnType.DreadKnight&&(s="Deeeath!"),this.show({placement:h.Placement.atWorldMapHex(i.hex),title:s,type:p.TooltipType.Hover,style:n.TOOLTIP_STYLE.speechBubble,typewriter:!0,delayMs:a,expireAfterMs:900,enforceDelay:!0})}showHexTooltip(e,t=!1){const i=c.inject.gameStateModel,s=i.pawns.findOne({hexes:e,traits:[o.PawnTraits.OccupiesTile]})??i.pawns.findOne({hexes:e,traits:[o.PawnTraits.Terrain]}),n=i.pawns.findOne({hexes:e,type:[r.PawnType.Coins]});let l=[];const h=d.app.worldNews.getTooltip(e);if(s){n&&n.count>0&&l.push({value:n.count,icon:"ui/mini-icons/coins-flat",color:a.Colors.tooltip.coinsCounter});const i=(0,g.getPawnTooltip)(s,l);h&&(i.title=i.title+"\n(!) "+h.title);const o=this.showAtHex(e,{...i,delayMs:t?0:void 0});return this.latestHexTooltip={hex:e,tooltip:o},o}h?this.showAtHex(e,{...h,delayMs:t?0:void 0}):d.app.tooltips.close()}toggleHexTooltip(e){this.latestHexTooltip?.hex===e&&this.latestHexTooltip.tooltip.visible?this.close():this.showHexTooltip(e,!0)}removeTooltip(e){d.app.scene.globalUI.removeTooltip(e)}}},13777:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Goose=void 0;const s=i(34947),n=i(90824),o=i(83958);t.Goose=class{constructor(){this.names=["Godfrey the Goose","Gideon the Goose","Gilbert the Goose","Gaston the Goose","Gulliver the Goose"],this.chatter=s.CHATTER_DEFS,this.headwear="peasant-hat",this.personality={daring:1,ambitious:0,combative:1,attackSkill:.1,defenseSkill:0,honorable:1,thrifty:.5},this.buildsCastles=!1,this.race=n.Race.Human,this.aiStrategy=o.defaultStrategy}}},14033:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VirtualStack=void 0;const s=i(94233),n=i(56824),o=i(79573),a=i(91622),r=n.logger.for("coins");t.VirtualStack=class{constructor(e){this.pools=e,this.scene=this.pools.scene,this.currentAmount=0,this.x=0,this.y=0}setPosition(e,t){this.x=e,this.y=t}addCoins(e){this.currentAmount+=e}consumeCoins(e){this.currentAmount+=e.length,a.inject.ui.skipTransitions()?e.forEach((e=>this.pools.free(e))):e.forEach(((e,t)=>{e.setDepth(o.WorldLayers.FlyingObject+10*this.y),(0,s.consumeCoin)(this.pools,e,this.x,this.y)}))}deleteCoins(e,t){this.currentAmount<e?(r.warning(`Attempted to delete ${e} coins from a virtual stack that already has only ${this.currentAmount} coins. Extra coins not deleted.`),this.currentAmount=0):this.currentAmount-=e}destroy(){}remainingCapacity(){return Number.POSITIVE_INFINITY}addToTile(e,t,i){}removeFromTile(e){}spawnCoin(){return this.y,this.currentAmount-=1,this.pools.getCoin(this.x,this.y)}}},14360:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConquestPlanner=void 0;const s=i(70589),n=i(89764),o=i(78635),a=i(90048),r=i(70712),l=i(13602),c=i(80268),d=i(19580),h=i(91622),u=i(76985),p=i(61634),g=i(9292);t.ConquestPlanner=class{constructor(e=Number.POSITIVE_INFINITY){this.hardRangeLimit=e,this.name=this.constructor.name,this.isConquest=!0}async*generatePlans(e,t){this.regionAssets=n.RegionAssets.fromMyRegion(e.region),this.state=e.state,this.context=e,this.views=t,this.plans=[],this.maxPlanningRange=(0,g.pickSmaller)(this.hardRangeLimit,l.AIMetrics.attackSkillToPlanningRange(e.aiPersonality.attackSkill));const i=this.regionAssets.remainingUnits.add(1,Math.trunc(this.regionAssets.remainingGold/a.CHEAPEST_UNIT_COST)),s=(i.count(),i.getTotalMight()),r=o.Warfare.getConquerableHexes(this.state,e.region.id,(0,g.pickSmaller)(4,s)).filter((t=>!e.region.hexes.has(t))).members;for(let e of r)this.explore(e,[],this.regionAssets,0,0);for(let e of this.plans)yield e}explore(e,t,i,n,a,m=0,y=0){if(m>=h.inject.plugins.ai.maxConquestPlanningRangeAdjustment.apply(this.maxPlanningRange,this.context.state,e))return 0;const f=r.AI.getHexInfluence(this.context.state,e.id,this.context.region.id)?.hexDefense??0,w=f+1,v=l.AIMetrics.getJoinRegionsBonus(this.context,e)??{conquestValueBonus:0,incomeGain:0};m+=f+1;const b=o.Warfare.getPotentialLoot(this.state,e);let S;if(f>=0){const t=i.useUnit({requiredMight:f+1,allowOverkill:!0,loot:b,incomeGain:p.Economy.getPotentialIncomeFromHex(this.context.state,e.id)+v.incomeGain,...(0,u.getMaxMightForHex)(this.context.state,e)});if(!t)return 0;S=t.assets}else S=i;const x=[...t,e],T=(0,g.pickLarger)(this.views.threatAssessment.get(e.id).riskByDefenderMight[f]??0,n),P=a+this.views.defenderBenefit.getForMight(e.id,w),I=(0,g.pickSmaller)(c.AIPolitics.getDiplomaticPenalty(this.context,e),y);let C=this.views.conquestValue.get(e.id);C.factors.damageToEnemy=(0,d.estimateDamage)(this.context.state,x);const M=C.factors.damageToEnemy>=d.GAME_ENDING_MOVE_SCORE;C.total=C.factors.damageToEnemy*C.factors.damageMultiplier+C.factors.valueForMe+C.factors.loot+C.factors.fromPlugins;let A=0;if(!M){const t=r.AI.getHexInfluence(this.state,e.id,this.context.region.id);for(let e of t?.children||[]){const t=this.explore(e,x,S,T,P,m,I);t>A&&(A=t)}}let B=this.regionAssets.getRemainingAvailableMight()-S.getRemainingAvailableMight();return B<=0&&(B=.1/(1-B)),this.plans.push(new s.ConquestPlan(e,x,{conquestValue:C,diplomacyPenalty:I,downstreamMovesBonus:Math.floor(A/10),joinRegionsBonus:v.conquestValueBonus,threatReduction:P,eradicatePestBonus:0,mightInvestment:B,vulnerabilityPenalty:l.AIMetrics.riskToVulnerabilityPenalty(T,this.context.focus.daring)*h.inject.plugins.ai.hexVulnerabilityMultiplier.apply(1,this.context.state,this.context.faction.id,e,w),economyHealth:l.AIMetrics.economyHealth(S,this.context.focus),focusMismatchPenalty:l.AIMetrics.focusMismatchPenaltyV2(this.context,S,"offense")})),M?d.GAME_ENDING_MOVE_SCORE:Math.max(C.total/x.length,A)}}},14616:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidMoveError=void 0,t.executeMovePawn=function(e,t){const i=e.pawns.byId(t.pawnId),p=new l.WorldUpdateBuilder(e);if(!i?.isMovable())throw new u({reason:"the pawn is not movable in the current game state"},i?.hex?.id,t);return e.stateEngine.transaction((()=>{a.assert.defined(i);const l=i.region,g=i.hex,m=(0,r.getHex)(t.destinationHexId);if(a.assert.defined(l),a.assert.defined(m),g===m)return t.tapUnit&&c.CurrentPhase.tapPawn(e.state,i.id),[];const y=e.warfare.getDropPawnResult(m,i.type,l);switch(y.type){case n.DropPawnResultType.Conquest:return(0,o.captureHex)(e,m,l,i,t.tapUnit);case n.DropPawnResultType.Reposition:p.move({pawnId:i.id,destHex:m,captureHex:!0,tapUnit:t.tapUnit});const a=p.getUpdates();return[s.GameStateEvents.PawnMoved({...t,sourceHexId:g.id,worldUpdates:a})];case n.DropPawnResultType.EradicatePest:let r;y.pest.hasTrait(d.PawnTraits.Elusive)&&(r=e.warfare.getRetreatDestination(y.pest)?.id),p.move({pawnId:i.id,destHex:m,defeatedUnit:{pawnId:y.pest.id,retreatHex:r},captureHex:!0,tapUnit:t.tapUnit});const c=[s.GameStateEvents.PawnMoved({...t,sourceHexId:g.id,eradicatedPest:!0,worldUpdates:p.getUpdates()})];return c.push(...(0,h.checkWinLoseConditions)(e,c)),c;case n.DropPawnResultType.Combine:const f=y.combineWith.type;return y.combineWith.isMovable(),p.move({pawnId:i.id,destHex:m,mergeData:{mergedWith:y.combineWith.id,outputType:y.combineInto},captureHex:!0,tapUnit:t.tapUnit}),[s.GameStateEvents.PawnMoved({...t,sourceHexId:g.id,mergedWith:f,mergedInto:y.combineInto,worldUpdates:p.getUpdates()})];case n.DropPawnResultType.Invalid:default:throw new u(y,g.id,t)}}))};const s=i(36868),n=i(78635),o=i(63853),a=i(97849),r=i(45664),l=i(78933),c=i(45084),d=i(63521),h=i(46471);class u extends Error{constructor(e,t,i){super(`Invalid move of pawn #${i.pawnId} from hex#${t} to hex #${i.destinationHexId}: ${e?.reason}`),this.moveResult=e,this.context=i}}t.InvalidMoveError=u},14739:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoundedRectButton_LEGACY=void 0;var s=Phaser.Geom.Rectangle;const n=i(86545),o=i(96137),a=i(2426),r=i(22663),l=i(83176),c={face:o.Colors.glassUi_old.shape,shadow:o.Colors.glassUi_old.shapeShadow,highlight:o.Colors.glassUi_old.shapeLightAccent};class d extends n.BaseResponsiveContainer{constructor(e,t){super(e),this._rounded=1,this._raised=0,this._contentOriginX=0,this.palette=t.palette??c,this.background=new a.RoundedRect(this.scene,{x:0,y:0,fillStyle:{color:this.palette.face,alpha:1},radius:0}),t.raised&&(this._raised=t.raised,this.shadow=new a.RoundedRect(this.scene,{x:0,y:0,fillStyle:{color:this.palette.shadow,alpha:1},radius:0}),this.add(this.shadow)),this.content=t.content,this._contentOriginX=t.contentOriginX??0,this.add([this.background,this.content]),this.setInteractive({hitArea:this.getHitArea(),hitAreaCallback:s.Contains,cursor:"pointer"}),this.setController((0,l.setupController)({audio:t.audio}))}setTheme(e){}getHitArea(){return this._raised?new s(this.width/2-4,this.height/2-4,this.width+4,this.height+4):new s(this.width/2,this.height/2,this.width,this.height)}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.onNewButtonState(e))))}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}set rounded(e){this._rounded=e}get rounded(){return this._rounded}onNewButtonState(e){switch(e){case r.ButtonState.Disabled:this.background.setFillStyle(this.palette.face),this.background.setAlpha(.5),this.preUpdate.makeDirty();break;case r.ButtonState.Hover:case r.ButtonState.Down:this.background.setAlpha(1),this.background.setFillStyle(this.palette.highlight),this.preUpdate.makeDirty();break;default:this.background.setAlpha(1),this.background.setFillStyle(this.palette.face),this.preUpdate.makeDirty()}}updateLayout(){const e=this._raised?this.controller.getState()===r.ButtonState.Down||this.controller.getState()===r.ButtonState.Disabled?-1:-this._raised:0;this.input.hitArea.setTo(this.width/2,this.height/2,this.width,this.height),this.background.radius=this.height/2*this._rounded,this.background.setSize(this.width,this.height),this.content.setSize(this.width,this.height),this.background.setPosition(e,e),this.content.setPosition(e+this._contentOriginX*this.width-this.content.width*this._contentOriginX,e),this._raised&&this.shadow&&(this.shadow.setPosition(0,0),this.shadow.radius=this.background.radius,this.shadow.setSize(this.width,this.height))}}t.RoundedRectButton_LEGACY=d},14767:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.miniCloseButton=function(e,t=0,i=0){return new s.ImageButton(e,t,i,{frame:"ui/mini-close-button",hover:!0})};const s=i(79899)},15052:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.reportFeedback=function(e){if(e.levelId){const t=s.LevelModel.for(e.levelId);return{blocks:[n.SlackMessage.section.text(`:incoming_envelope: Feedback on ${u(t)}:`),n.SlackMessage.section.text(d(e),h(t)),n.SlackMessage.section.text(n.SlackMessage.codeBlock(y(),g(t)))]}}return{blocks:[n.SlackMessage.section.text(`:incoming_envelope: Feedback from *${r.app.navigator.currentScreen?.name??"<unknown screen>"}*:`),n.SlackMessage.section.text(d(e)),n.SlackMessage.section.text(n.SlackMessage.codeBlock(y()))]}};const s=i(66143),n=i(60300),o=i(8358),a=i(91622),r=i(54825),l=i(7334),c=i(56824);function d(e){return(0,o.prefixEachLineWith)("> ",`${t=e.mood,void 0===t?"":p[t]??`<${t}>`} ${e.comment}\n-- ${e.email||"user <"+a.inject.login.getUserId()+">"}`);var t}function h(e){return(e.expeditionContext?`*${e.expeditionContext.expedition.metadata.name} progress:* ${t=e.expeditionContext,t.expedition.objects.filter((e=>"island"===e.type)).map(((e,t)=>`[${t+1}${f(s.LevelModel.for(e.id))}]`)).join(" ")}\n`:"")+`*${e.name} progress:* ${f(e)} ${function(e){const t=e.userVictoryRecord,i=e.inProgressRecord;switch(e.getLevelStatus()){case s.LevelStatus.Unlocked:return"not won yet";case s.LevelStatus.InProgress:return`turn ${i?.turnNumber??"?"} on ${i?.sessionData.aiDifficulty??"unknown"} difficulty`;case s.LevelStatus.GoldMedal:case s.LevelStatus.SilverMedal:return`won in ${t?.turns??"?"} turns on ${t?.difficulty??"hard"} difficulty`;case s.LevelStatus.Locked:return"locked"}}(e)}`;var t}function u(e){const t=e.expeditionContext;return t?`*${e.getTitle(s.LevelTitleStyle.Full)}* in *${t.expedition.metadata.name}*`:`*custom level \`${e.id}\`*`}const p=[void 0,":rage:",":angry:",":neutral_face:",":slightly_smiling_face:",":smile:"];function g(e){return`level:\n  id: ${e.id} (expedition_id: ${e.expeditionContext?.expedition.id})\n  status: ${e.getLevelStatus()}\n  turn: ${e.inProgressRecord?.turnNumber??e.userVictoryRecord?.turns}\n`}const m={[s.LevelStatus.GoldMedal]:":trophy:",[s.LevelStatus.SilverMedal]:":second_place_medal:",[s.LevelStatus.InProgress]:":crossed_swords:",[s.LevelStatus.Locked]:":lock:",[s.LevelStatus.Unlocked]:":white_square:"};function y(){return`game:\n  build: 2.35.24-build-16101088196 (environment=production)\n  url: ${window.location.toString()}\n  screen: ${r.app.navigator.currentScreen?.name??"?"}\nuser:\n  id: ${a.inject.login.getUserId()}\n  email: ${a.inject.login.getUsername()}\n  auth_provider: ${a.inject.login.describeCurrentAuthProvider()}\n  timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}\n  local_storage_usage: ${(0,l.describeSize)(c.storage.getSizeInBytes())}\ndevice:\n  user_agent: ${window.navigator.userAgent}\n  current_fps: ${r.app.game.loop.actualFps.toFixed()}\n  raw viewport: ${window.innerWidth}x${window.innerHeight} dpr=${window.devicePixelRatio||1}\n  scaled viewport: ${r.app.device.screenWidth}x${r.app.device.screenHeight} (dpr=${r.app.device.dpr} uiVariant=${r.app.device.uiVariant()})\n  os: ${r.app.device.os()})\n  touch: ${r.app.game.device.input.touch}`}function f(e){return e.getLevelStatus()===s.LevelStatus.GoldMedal?"normal"===e.userVictoryRecord?.difficulty?":second_place_medal:":":first_place_medal:":m[e.getLevelStatus()]}},15143:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EndTurnPlan=void 0;const s=i(7334),n=i(13602),o=i(9292);t.EndTurnPlan=class{constructor(e,t){this.endsTurn=!0,this.isConquest=!1,this.hex=e.region.getTownHexes().first(),this.utilityFactors={base:10,economyMultiplier:n.AIMetrics.economyHealth(t,e.focus),unusedUnitsPenalty:20*t.remainingUnits.getTotalMight(),focusMultiplier:2*e.focus.thrifty,focusMismatchPenalty:n.AIMetrics.focusMismatchPenaltyV2(e,t,"defense"),unusedGoldPenalty:this.getUnusedGoldMultiplier(t)},this.score=(this.utilityFactors.base-this.utilityFactors.unusedUnitsPenalty)*this.utilityFactors.economyMultiplier*this.utilityFactors.focusMultiplier*this.utilityFactors.focusMismatchPenalty*this.utilityFactors.unusedGoldPenalty}getUnusedGoldMultiplier(e){const t=e.remainingGold+e.remainingIncome;if(e.remainingIncome<0){const t=Math.floor(e.remainingGold/-e.remainingIncome);return 0===t?.01/-e.remainingIncome:-e.remainingIncome/e.totalUnits.count()>t?.1:1}return e.remainingGold<20&&t>=20?2:t>20?(0,o.cropNumber)(.1-(t-20)/50,.01,.1):1}execute(e){return!0}hash(){return"end turn"}toString(){return`[${(0,s.formatNumber)(this.score)} | End Turn]`}toDebugString(){return(0,s.prettyPrintObject)(this.utilityFactors,2)}}},15160:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverworldMapScene=void 0;const s=i(20518),n=i(81700),o=i(93868),a=i(90845),r=i(69313),l=i(56824),c=i(54513),d=i(81807),h=i(95613),u=i(13622),p=i(62993),g=i(66143),m=i(4440),y=i(30963),f=m.Input.Keyboard.KeyCodes;class w extends s.BaseScene{constructor(){super({key:n.Scenes.OverworldMap,bounds:o.BOUNDS.Main}),this.scrollBounds={minX:0,maxX:0,minY:0,maxY:0},this.bbGuide=(0,c.guides)(this,"purple")}async create(){super.create(),this.islands=new r.OverworldObjectsManager(this),this.arrowKeys=this.input.keyboard.addKeys({up:f.UP,down:f.DOWN,left:f.LEFT,right:f.RIGHT}),this.arrowKeys2=this.input.keyboard.addKeys({up:f.W,down:f.S,left:f.A,right:f.D}),l.config.editOverworld&&(this.editor=new d.OverworldMapEditor(this),this.editor.enable()),this.cameras.main.roundPixels=!0,this.scrollController=new h.CameraScrollController(this.cameras.main),this.pointersTracker=new u.OverworldPointersTracker(this,this.scrollController),this.zoomController=new y.CameraZoomController({name:"Overworld.Zoom",camera:this.cameras.main,zoomLevels:[y.DEFAULT_CAMERA_ZOOM,7,10],zoomDelay:0,pointersTracker:this.pointersTracker}),this.input.on("wheel",((e,t,i,s,n)=>{this.zoomController.applyScroll(s)}),this),(0,a.ensureIsoTilesPrerendered)(this),(0,c.guides)(this).horizontal(0,"0").vertical(0,"0")}applyTheme(e){this.islands.refresh(!0)}resize(e){super.resize(e),this.updateWorldBounds()}update(e,t){super.update(e,t),this.islands.update(),this.zoomController.update(e,t),l.config.editOverworld?this.editor?.update(e,t):this.applyKeyboardScrolling(t)}applyKeyboardScrolling(e){const t=1e3,i=10*e,s=this.scrollController;(this.arrowKeys.up.isDown||this.arrowKeys2.up.isDown)&&s.cameraY.accelerateTo(-t,i),(this.arrowKeys.down.isDown||this.arrowKeys2.down.isDown)&&s.cameraY.accelerateTo(t,i),(this.arrowKeys.left.isDown||this.arrowKeys2.left.isDown)&&s.cameraX.accelerateTo(-t,i),(this.arrowKeys.right.isDown||this.arrowKeys2.right.isDown)&&s.cameraX.accelerateTo(t,i)}async loadExpedition(e,t){this.islands.loadExpedition(e),this.islands.selectIslands(t),this.focusIsland(t,"instant"),this.updateWorldBounds()}focusIsland(e,t="instant"){const i=this.getIslandPreviewById(e).getLinkAnchorPoint(),s=i.x-this.cameras.main.displayWidth/2*this.cameras.main.zoom,n=i.y-this.cameras.main.displayHeight/2*this.cameras.main.zoom;"transition"===t?(this.scrollController.cameraX.pushTo(s),this.scrollController.cameraY.pushTo(n),this.zoomController.zoomTo(y.DEFAULT_CAMERA_ZOOM,500)):(this.scrollController.cameraX.setTo(s),this.scrollController.cameraY.setTo(n),this.zoomController.zoomTo(y.DEFAULT_CAMERA_ZOOM,500))}updateWorldBounds(){const e=this.islands.streamer.getBoundingBox(!0,(e=>{if(e instanceof p.LazyIslandPreview){const t=g.LevelModel.for(e.props.levelInfo.id);return l.config.editOverworld||t.isUnlocked()||t.isInProgress()}return!1})),t=this.bounds.width/2,i=this.bounds.height/2;this.scrollBounds={minX:e.x-t,maxX:e.x+e.width+t,minY:e.y-i,maxY:e.y+e.height+i},this.bbGuide.clear(),this.bbGuide.rect(e,"worldBounds"),this.bbGuide.rect(new Phaser.Geom.Rectangle(this.scrollBounds.minX,this.scrollBounds.minY,this.scrollBounds.maxX-this.scrollBounds.minX,this.scrollBounds.maxY-this.scrollBounds.minY),"scrollBounds");const{minX:s,minY:n,maxX:o,maxY:a}=this.scrollBounds;this.scrollController.setBounds(Phaser.Geom.Rectangle.FromXY(s,n,o,a))}getIslandPreviewById(e){return this.islands.objectsById[e]}getExpeditionPortalById(e){return this.islands.objectsById[e]}}t.OverworldMapScene=w},15316:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RibbonButton=t.RibbonButtonStyle=void 0;const s=i(76738),n=i(88389),o=i(22663),a=i(86545),r=i(83176),l=i(20087);var c=Phaser.GameObjects.Image,d=Phaser.GameObjects.BitmapText;t.RibbonButtonStyle={Small:{base:s.RibbonTextures.SmallButton,down:s.RibbonTextures.SmallButtonDown},Medium:{base:s.RibbonTextures.MediumButton,down:s.RibbonTextures.MediumButtonDown}};class h extends a.BaseResponsiveContainer{set buttonState(e){this._state=e,this.preUpdate.makeDirty()}get buttonState(){return this._state}constructor(e,t,i,a){super(e),this.props=a,this._state=o.ButtonState.Rest,this.button=new s.Ribbon(this.scene,a.type.base,0,0,a.width),this.setSize(this.props.width,this.button.height),this.setInteractiveAuto(),u(a.content)&&a.content.setOrigin(.5,.5),a.buttonTint&&this.button.setTint(a.buttonTint),this.add([this.button,this.props.content]),a.icon&&this.add(a.icon),this.setPosition(t,i),this.setController((0,r.setupController)(a)),void 0===a.controller?this.setController(new n.SimpleButtonStateController({audio:this.props.audio})):null!==a.controller&&this.setController(a.controller)}setTheme(e){}setEnabled(e){this.controller.setEnabled(e)}get onClicked(){return this.controller.onClicked}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.buttonState=e)))}setTint(e,t){return this.button.setTint(t),u(this.props.content)&&this.props.content.setTint(e),this}updateLayout(){this.button.width=this.width;let e=this.button.width/2+(this.props.icon?this.props.icon.width/2:0),t=this.button.height/2;this.buttonState===o.ButtonState.Down&&(e+=2,t+=2),this.props.content instanceof c&&this.props.content.setAlpha(this.buttonState===o.ButtonState.Disabled?.25:1),this.props.icon?.setPosition(this.props.icon?.width/2+14,t),this.button.setFrameFrom(this.getCurrentTexture());const i=e+(this.props.contentOffset?.x??0),s=t+(this.props.contentOffset?.y??0);u(this.props.content)?this.props.content.setPosition(i,s):(l.Arrange.alignX({content:[this.props.content],x:i,origin:.5}),l.Arrange.alignY({content:[this.props.content],y:s,origin:.5}))}getCurrentTexture(){switch(this.buttonState){case o.ButtonState.Disabled:return this.props.type.disabled??this.props.type.base;case o.ButtonState.Down:return this.props.type.down;default:return this.props.type.base}}}function u(e){return e instanceof d||e instanceof c}t.RibbonButton=h},15340:()=>{},15350:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ComponentContainer=t.StorybookScene=void 0;const s=i(81700),n=i(93868),o=i(54825),a=i(30948),r=i(897),l=i(42383),c=i(46099),d=i(80959),h=i(76049),u=i(20087),p=i(86545),g=i(1187),m=i(91622);class y extends n.BaseBoundsProvider{get width(){return o.app.device.screenWidth-l.MENU_WIDTH}get height(){return o.app.device.screenHeight}get x(){return l.MENU_WIDTH}}class f extends a.BaseUIScene{constructor(){super({key:s.Scenes.Storybook,bounds:new y}),this.content=[],this.storyItems=new g.GameObjectList(((e,t,i)=>(i||(i=new w(this),this.add.existing(i)),i.loadStoryItem(e),i))),this.preUpdate=(0,r.whenDirty)((()=>{const e=this.storyItems.get();e.forEach((e=>e.updateLayout())),u.Arrange.alignX({content:e,x:20,origin:0}),u.Arrange.topToBottom({content:e,y:20,origin:0,spacing:8})}))}create(){super.create(),this.ui=d.UiBuilder.for(this),this.observe.event(c.StorybookEvents.SelectStory,(e=>{this.handleStoryChange(e)}))}handleStoryChange(e){this.storyItems.set(e.content(this)),this.preUpdate.makeDirty()}}t.StorybookScene=f;class w extends p.AutoHeightResponsiveContainer{constructor(e){super(e);const t=d.UiBuilder.for(e);this.label=t.text("",h.BitmapFont.Mini,(e=>e.oceanContrastLight)),this.background=t.rectangle(0),this.add([this.background,this.label]),m.inject.theme.use((e=>{this.backgroundColorFunc&&this.background.setFillStyle(this.backgroundColorFunc(e))}),this)}loadStoryItem(e){this.component&&this.component.destroy(),this.label.setText(e.name),this.component=e.component,this.add(this.component),this.background.setVisible(void 0!==e.backgroundColor),e.backgroundColor&&("function"==typeof e.backgroundColor?(this.backgroundColorFunc=e.backgroundColor,this.background.setFillStyle(e.backgroundColor(m.inject.theme.getCurrent()))):(this.backgroundColorFunc=void 0,this.background.setFillStyle(e.backgroundColor))),this.preUpdate.makeDirty()}handleChildResize(e){super.handleChildResize(e)}updateLayout(){"updateLayout"in this.component&&"function"==typeof this.component.updateLayout&&this.component.updateLayout();const e=this.background.visible?8:0;this.width=this.background.width,u.Arrange.topToBottom({content:[this.label,this.component],y:e,origin:0,spacing:4+e}),u.Arrange.alignX({content:[this.label,this.component],x:e,origin:0}),this.background.setPosition(0,this.component.y-e),this.background.setSize(this.component.width+2*e,this.component.height+2*e),this.updateSize()}calculateHeight(){return this.background.y+this.background.height}}t.ComponentContainer=w},15458:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorOverlayScene=void 0;const s=i(81700),n=i(30948),o=i(897),a=i(93525),r=i(55275),l=i(93868),c=i(91622),d=i(7169),h=i(54825),u=i(4440),p=i(56824),g=i(36868),m=i(80959),y=i(20087),f=u.Input.Keyboard.KeyCodes;class w extends n.BaseUIScene{constructor(){super({key:s.Scenes.MapEditorOverlay,bounds:l.BOUNDS.FullScreen}),this.currentState=(0,r.stateContainer)({jsonEditorShown:!1},((e,t,i,s)=>{if(void 0!==e.jsonEditorShown){const t=c.inject.gameStateModel.exportState();this.jsonEditor.setJSON(t),this.jsonEditor.setVisible(e.jsonEditorShown),(0,d.setKeyboardCaptureEnabled)(!e.jsonEditorShown),e.jsonEditorShown?(h.app.scene.mapEditorSidebar.scene.pause(),this.scene.pause(),setTimeout((()=>this.jsonEditor.focus()),100)):(this.scene.resume(),h.app.scene.mapEditorSidebar.scene.resume())}})),this.preUpdate=(0,o.whenDirty)((()=>{this.jsonEditor.setVisible(this.currentState().jsonEditorShown),this.jsonEditor.setPosition(0,0),this.jsonEditor.width=this.bounds.width,this.jsonEditor.height=this.bounds.height,y.Arrange.place(this.backButton,{bottom:this.bounds.height-8,left:8})}))}create(){super.create(),this.jsonEditor=new a.JSONEditor(this),this.modifierKeys=this.input.keyboard.addKeys({shift:f.SHIFT,ctrl:f.CTRL,alt:f.ALT});const e=()=>{p.events.trigger(g.UserActions.ToolModifierChanged(this.getActiveModifiers()))};this.backButton=m.UiBuilder.for(this).wood.primaryButton({text:"BACK",icon:"ui/wood-icons/arrow-left",width:120,iconPlacement:"left",onClicked:()=>{p.events.trigger(g.UserActions.ExitMapEditor())}}),Object.values(this.modifierKeys).forEach((t=>{t.on("down",e),t.on("up",e)})),this.addAll([this.jsonEditor,this.backButton]),this.currentState.apply()}getActiveModifiers(){return{ctrl:this.modifierKeys.ctrl.isDown,shift:this.modifierKeys.shift.isDown}}update(){}}t.MapEditorOverlayScene=w},15686:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SelectedRegionHighlight=t.HighlightStyle=void 0;const s=i(56824),n=i(82226),o=i(15974),a=i(96137);var r;s.logger.for("SelectedRegionHighlight"),function(e){e.Gold="gold",e.Muted="muted"}(r||(t.HighlightStyle=r={})),r.Gold,r.Muted,t.SelectedRegionHighlight=class{constructor(e){this.renderer=e,this.tileGroup=new o.IsoTileGroupWithRenderer("SelectedRegionHighlight",this.renderer,n.IsoTileRecipes.Highlight,(e=>{e.setTint(this.color)})),this.color=a.Colors.highlight.ownedRegion}getHexes(e){return e.hexes}clear(){this.tileGroup.clear(),this.selectedRegion=void 0}setColor(e){e!==this.color&&(this.clear(),this.color=e)}set(e,t){t&&this.setColor(t),this.selectedRegion=e,this.tileGroup.setHexes(this.selectedRegion.hexes)}setHexes(e,t){t&&this.setColor(t),this.selectedRegion=void 0,this.tileGroup.setHexes(e)}refresh(){this.selectedRegion?this.tileGroup.setHexes(this.selectedRegion.hexes):this.tileGroup.clear()}includesHex(e){return this.tileGroup.hexes.has(e)}add(e){this.tileGroup.addHexes(e),this.tileGroup.update()}}},15890:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PromptButtonsUI=void 0;const s=i(14739),n=i(80959),o=i(76049),a=i(96137),r=i(54118),l=i(7782),c=i(54825),d=i(11466),h=i(91622),u=i(56824),p=i(36868);t.PromptButtonsUI=class{constructor(e){this.scene=e;const t=n.UiBuilder.for(e),i=t.hLayout({content:[t.image("ui/button-icons/fullscreen-enter",a.Colors.glassUi_old.primaryText),t.text("Enter fullscreen",o.BitmapFont.Main,a.Colors.glassUi_old.primaryText)],horizontalPadding:24,originY:.5,originX:0,layoutPolicy:r.LayoutChildrenPolicy.None,spacing:18});this.fullScreenButton=new s.RoundedRectButton_LEGACY(e,{content:i,raised:2,audio:!0}),this.fullScreenButton.y=-70,this.fullScreenButton.width=260,this.fullScreenButton.height=50,this.fullScreenButton.onClicked((()=>{u.events.trigger(p.UserActions.SetFullScreenMode(!0))})),this.fullScreenButtonOffset=l.Control.propOf(this.fullScreenButton,"y",{ease:"Sine.easeInOut"})}addToScene(){this.scene.addAll([this.fullScreenButton])}updateLayout(){this.fullScreenButton.x=this.scene.bounds.centerX-this.fullScreenButton.width/2,this.shouldShowFullScreenPrompt()?this.fullScreenButtonOffset.transitionTo(20):this.fullScreenButtonOffset.transitionTo(0-this.fullScreenButton.height-20)}shouldShowFullScreenPrompt(){return c.app.device.uiVariant()===d.UiVariant.Compact&&c.app.device.isMobile()&&c.app.navigator.currentScreen===c.app.screen.play&&!h.inject.ui.sidebarMode()&&!this.scene.scale.isFullscreen&&c.app.device.isFullScreenAvailable()}}},15956:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetsContainer=void 0;const s=i(86545),n=i(20087);class o extends s.AutoHeightResponsiveContainer{constructor(e,t={}){super(e),this.padding=t.padding??16}setWidgets(e){this.widgets=e,this.add(e)}updateLayout(){for(let e of this.widgets)e.width=this.width-2*this.padding;n.Arrange.topToBottom({content:this.widgets,y:this.padding,spacing:this.padding}),n.Arrange.alignX({content:this.widgets,x:this.width/2,origin:.5}),this.updateSize()}calculateHeight(){const e=this.widgets[this.widgets.length-1];return e.y+e.height}}t.WidgetsContainer=o},15974:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IsoTileGroupWithRenderer=t.Image=void 0,t.Image=Phaser.GameObjects.Image;const s=i(20693),n=i(56824),o={A111:0,V111:0,V001:-1,A010:-1,V100:1,A100:1,V010:1,A001:-1,V110:1,A101:1,V011:-1,A011:-1,V101:-1,A110:1};n.logger.for("IsoTileGroup"),t.IsoTileGroupWithRenderer=class{constructor(e,t,i,n,o){this.id=e,this.renderer=t,this.recipe=i,this.postProcessor=n,this.tint=o,this.triangles={},this.hexes=s.HexGroup.empty,this.dirtyCorners=[]}addHexes(e,t){const i=e.filter((e=>!this.hexes.has(e)));this.hexes=this.hexes.with(i);const s=i.getCorners();this.dirtyCorners.push(...s),t&&s.forEach((e=>t.dirtyCorners.add(e)))}setHexes(e,t){const i=this.hexes.without(e),s=e.without(this.hexes);this.addHexes(s,t),this.removeHexes(i,t),this.update()}removeHexes(e,t){const i=e.filter((e=>this.hexes.has(e)));this.hexes=this.hexes.without(i);const s=i.getCorners();this.dirtyCorners.push(...s),t&&s.forEach((e=>t.dirtyCorners.add(e)))}clear(){Object.values(this.triangles).forEach((e=>e.destroy())),this.triangles={},this.hexes=s.HexGroup.empty}markForRedraw(e){if(0===e.length)return;const t=e.getCorners();this.dirtyCorners.push(...t)}update(){for(const e of this.dirtyCorners)this.updateCorner(e);this.clearDirtyCorners()}clearDirtyCorners(){this.dirtyCorners.length=0}updateCorner(e){if(this.triangles[e.id]?.destroy(),this.hexes.hasCorner(e)){const t=this.renderTriangle(e.display,e);t&&(this.triangles[e.id]=t)}else delete this.triangles[e.id]}getCornerVariant(e){return e.variant+e.sortedHexes.map((e=>this.hexes.has(e)?"1":"0")).join("")}renderTriangle(e,i){const s=this.getCornerVariant(i);let n=this.recipe.frames[s];if(!n)return;const a=("V"===i.variant?this.recipe.offsetV:this.recipe.offsetA)||0,r=this.recipe.scale||1,l=new t.Image(this.renderer.scene,e.x,e.y,"atlas",`${this.recipe.frameIdBase}/${n.frame}`);if(l.setScale(r),l.setDepth(this.recipe.baseDepth+l.y-o[s]),l.setOrigin(.5,0),n.flipY&&(l.flipY=!0,l.y+=l.height*r),n.flipX&&(l.flipX=!0),n.crop){const{x:e,y:t,width:i,height:s}=n.crop;l.setOrigin(0,0),l.setCrop(e,t,i,s),l.x=l.x-e*r-i*r/2,l.y=l.y-t*r}return l.y-=a,this.postProcessor(l),this.renderer.add(i.sortedHexes[0],l),l}}},16007:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.SpectatingPlaybackSpeed=void 0,function(e){e[e.Paused=0]="Paused",e[e.Normal=1]="Normal",e[e.Fast=2]="Fast",e[e.UltraFast=3]="UltraFast"}(i||(t.SpectatingPlaybackSpeed=i={}))},16079:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handlePawnMoved=async function(e,t){await e.worldMapScene.play(t.worldUpdates),(t.eradicatedPest||t.mergedInto)&&(s.app.worldNews.clearNewsOnHex(t.destinationHexId),s.app.scene.worldMap.overlays.update(t.worldUpdates.stateAfter),e.uiScene.updateFromGameState(t.worldUpdates.stateAfter),e.uiScene.updatePowerBalanceFromGameState(t.worldUpdates.stateAfter))};const s=i(54825)},16082:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExpeditionModel=void 0;const s=i(1326),n=i(91622),o=i(66143);i(56824).logger.for("ExpeditionModel");class a{constructor(e){if(this.orderedLevels=[],this.id=e,this.data=n.inject.mapRegistry.getExpeditionById(e),!this.data)throw new Error(`Expedition "${e}" not found`);this.objectsById=(0,s.dictionaryOf)(this.data.objects,"id")}get config(){return this.data.config}get objects(){return this.data.objects}get metadata(){return this.data.metadata}get userData(){return n.inject.userData.getLevelVictoryRecordById(this.id)}getObjectById(e){return this.objectsById[e]}getLevelsAdjacentTo(e){const t=this.getObjectById(e);return t?t.links?.map((e=>this.getObjectById(e))).filter((e=>"island"===e.type))??[]:[]}isCompleted(){return this.levels.every((e=>e.isCompleted()))}get levels(){return this.orderedLevels.length||(this.orderedLevels=this.data.objects.filter((e=>"island"===e.type)).sort(((e,t)=>e.ordinalNumber-t.ordinalNumber)).map((e=>o.LevelModel.for(e.id)))),this.orderedLevels}static for(e){return(0,s.getOrCreate)(this._instances,e,(()=>new a(e)))}}t.ExpeditionModel=a,a._instances={}},16222:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ForestRenderer=void 0;const s=i(82226),n=i(24598),o=i(81434),a=i(52409),r=i(73230),l=i(19618);class c extends a.SimpleIsoRenderer{constructor(e){super(r.RenderLayerKey.Forest,e,s.IsoTileRecipes.Forest)}getHexes(e){return l.Factions.model(e).neutral.hexes.filter((t=>this.shouldIncludeHex(e,t)))}shouldIncludeHex(e,t){return!!o.Pawns.model(e).findOne({hexes:t,type:[n.PawnType.Forest]})}}t.ForestRenderer=c},16231:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AddChestTool=void 0;const s=i(91622),n=i(24598),o=i(63521);t.AddChestTool=class{constructor(){this.options={title:"Place Treasure Chest",description:"click = add chest\nctrl-click = remove chest"},this.iconRecipe={image:"pawns/chest",postProcess:e=>e.setScale(.5,.5).setOrigin(0,0)}}useOn(e,t){const i=s.inject.gameStateModel;if(!i.regions.byHex(e))return;const a=n.PawnType.Chest,r=i.pawns.byHex(e).find((e=>e.hasTrait(o.PawnTraits.OccupiesTile)));t.ctrl?r&&r.destroy():r?(r.type!==a&&r.replaceWith(a),i.pawns.setCount(e,n.PawnType.Coins,10)):(i.pawns.create({hex:e,type:a}),i.pawns.setCount(e,n.PawnType.Coins,10))}}},16860:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MovableUnitsProjection=void 0;const s=i(24598),n=i(20541),o=i(20026),a=i(88023);class r extends n.SetDataSet{constructor(e,t){super(e),this.key=e,this.sources=t,this.parents=Object.values(this.sources),this.builder=new n.SetDataSetMutationBuilder(this)}bootstrap(e){const t=(0,o.selectFromState)(e,this.sources.currentPhase);if(t.type!==s.PhaseTypes.FactionTurn)return(0,a.ImmutableSet)();const i=(0,o.selectFromState)(e,this.sources.unitsByFaction,t.faction);return i&&0!==i.size?i.filter((t=>!this._isTapped(e,t))):(0,a.ImmutableSet)()}update(e,t,i){this.builder.init(e);const s=t.of(this.sources.currentPhase);return s?(this._handleCurrentPhaseChange(e,s,i),this.builder.createMutation("phase changed")):(this._handleTappedUnitsChange(e,t.of(this.sources.currentPhaseTappedUnits),i),this._handleFactionUnitsChange(e,t.of(this.sources.unitsByFaction),i),this.builder.createMutation("units changed"))}_isTapped(e,t){return(0,o.selectFromState)(e,this.sources.currentPhaseTappedUnits).has(t)}_handleFactionUnitsChange(e,t,i){if(!t)return;const s=(0,o.selectFromState)(e,this.sources.currentPhase).faction;void 0!==s&&t.updated?.forEach((t=>{t.id===s&&(t.added&&this.builder.add(...t.added.filter((t=>!this._isTapped(e,t)))),t.removed&&this.builder.delete(...t.removed.filter((t=>!this._isTapped(e,t)))))}))}_handleTappedUnitsChange(e,t,i){t&&(t.addedEntries?.forEach((e=>this.builder.delete(e))),t.deletedEntries?.forEach((e=>{this.builder.add(e)})))}_handleCurrentPhaseChange(e,t,i){if(t.type!==s.PhaseTypes.FactionTurn)this.builder.clear();else{this.builder.clear();const i=(0,o.selectFromState)(e,this.sources.unitsByFaction,t.faction);i&&this.builder.add(...i.toArray())}return this.builder.createMutation("currentPhaseChanged")}}t.MovableUnitsProjection=r},17128:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionsLedger=void 0;const s=i(45084),n=i(97849),o=i(56824),a=i(91622);o.logger.for("RegionsLedger"),t.RegionsLedger=class{constructor(){this.ledger=[],this.visited=new Set}get availableRegions(){return this.ledger}refreshAvailableRegions(e){const t=s.CurrentPhase.model(e).faction;n.assert.defined(t);const i=t.getRegions().filter((e=>e.exists&&e.isAlive())).sort(((e,t)=>t.size-e.size));this.ledger=i.map((e=>e.id)),i.filter((e=>!e.isActionable())).forEach((e=>this.visited.add(e.id))),this.updateDebugData()}regionVisited(e){this.visited.add(e),this.updateDebugData()}reset(e){this.visited.clear(),this.refreshAvailableRegions(e)}updateDebugData(){a.inject.debugData.set("regionsLedger",a.inject.ui.regionsLedger.toDebugString())}getNextPendingRegionId(){return this.getPendingRegions()[0]}getPendingRegions(){return this.ledger.filter((e=>!this.visited.has(e)))}getNext(e){if(void 0===e)return this.ledger[0];const t=this.ledger.indexOf(e);return this.ledger[(t+1)%this.ledger.length]}getPrevious(e){if(!e)return this.ledger[this.ledger.length-1];const t=this.ledger.indexOf(e);return 0===t?this.ledger[this.ledger.length-1]:this.ledger[t-1]}isVisited(e){return this.visited.has(e)}isPending(e){return!this.visited.has(e)}hasPendingRegions(){return this.getPendingRegions().length>0}toDebugString(){return Array.from(this.ledger).map((e=>e+(this.visited.has(e)?"":"*"))).join(",")}}},17301:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateRegions=async function(e,t,i,n){t.reset(i.seed);const d=e.regions.all()[0];s.assert.defined(d,"map generator expects the first region in regions.all() to represent available landmass, but no regions were found"),d.size;let h=await(0,o.partitionLand)(e,t,d,i,n);await(0,a.colorizeRegions)(e,t,h,i,n),i.startingTiles>0&&await(0,l.spawnTowns)(e,t,h.filter((e=>e.faction?.id!==r.SpecialFaction.neutral)),i,n),i.features>0&&await(0,c.spawnCamps)(e,{count:i.features,pool:i.featuresPool},t,n),e.regions.destroy(...e.regions.all().filter((e=>0===e.size))),e.factions.neutral.mergeAdjacentRegions()};const s=i(97849),n=i(56824),o=i(24832),a=i(10711),r=i(67274),l=i(60875),c=i(12156);n.logger.for("mapgen")},17491:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SettingsPanel=void 0;const s=i(80959),n=i(56824),o=i(45651),a=i(38497),r=i(15956),l=i(60989);n.logger.for("SettingsPanel");class c extends r.WidgetsContainer{constructor(e){super(e),this.ui=s.UiBuilder.for(this.scene),this.loginWidget=new o.LoginWidget(this.scene),this.settingsWidget=new a.SettingsWidget(this.scene),this.statsWidget=new l.StatsWidget(this.scene),n.config.flags.cloudSync?this.setWidgets([this.loginWidget,this.settingsWidget,this.statsWidget]):this.setWidgets([this.settingsWidget,this.statsWidget])}setVisible(e){return e&&this.statsWidget.updateContent(),super.setVisible(e)}}t.SettingsPanel=c},17519:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.productionConfig=void 0;const s=i(13419),n=i(60681);t.productionConfig={...n.common,mode:"standard",mapRegistryUrls:["assets/content.json"],debug:{datgui:!1,overlay:!1,dataFilter:void 0,ai:!1,breakpoints:!1,cheats:!1,gameObjects:!1,objectPools:!1,chunkBorders:!1,isoTiles:!1,recordStateChanges:!1,integrityChecks:void 0,checkWorldMapIntegrity:!1,tweenSpeedFactor:1,loadTestMaps:!1},allowEditing:!0,editOverworld:!1,autoSaveOnTurnStart:!0,autoSaveOnTurnEnd:!0,serviceWorker:{enabled:!0,scope:"https://www.konkr.io/"},antialiasing:!0,screenTransitionDuration:300,feedbackPrompts:{expeditions:["x-community-maps"]},flags:{cloudSync:!1,skipTutorial:!1,seeEnemyAttitudes:!1,mergeMutations:!0,halloween:!0,undeadIslandsExpedition:!0,fullScreenToggleButton:!(0,s.isRunningAt)("itch","newgrounds"),avoidBottomRightCorner:(0,s.isRunningAt)("itch"),telemetry:!0,portableMode:(0,s.isPortableModeRequested)()},remoteConfigDefaults:{replaysSampleRate:0,levelTelemetrySampleRate:1},helpPagesBaseUrl:"https://michal-bures.github.io/konkr_data/help-v2/",levelStatsBaseUrl:"https://www.konkr.io/level-stats/",cloudFunctionsUrl:"https://us-central1-konkr-io.cloudfunctions.net/"}},17565:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ThreatAssessmentDebugLayer=t.ThreatAssessment=void 0,t.estimateStrongestUnitAtRange=v;const s=i(70712),n=i(19618),o=i(45664),a=i(78635),r=i(76439),l=i(52434),c=i(56038),d=i(9292),h=i(56824),u=i(91622),p=i(19506),g=i(2543),m=i(13602),y=i(24307);h.logger.for("ThreatAssessment");class f extends l.CalculatedHexGroupValuationWithCache{constructor(e){super(),this.faction=e,this.instanceId=h.random.id({size:5,prefix:"t"})}calculate(e){const t=this.calculateComponents(e),i=[0,0,0,0];for(const e of t)for(let t=0;t<e.riskByDefenderMight.length;++t)i[t]=d.Probability.ofEither(i[t],e.riskByDefenderMight[t]);const s=i.map(((e,t)=>e/(t+1)*3)).reduce(d.pickLarger);return{riskByDefenderMight:i,regions:t.map((e=>e.regionId)),strongestUnit:t.map((e=>e.riskByDefenderMight.length)).reduce(d.pickLarger,0),risk:s}}getDebugLayer(){return new w(this)}calculateComponents(e){const t=this.faction.parentModel.state,i=c.Regions.model(t),r=n.Factions.getByHex(t,e);if(void 0===r)return[];const l=s.AI.getHexInfluence(t,e).filter(((e,s)=>{const o=n.Factions.getByRegion(t,s);return e&&o&&o!==this.faction.id&&o!==r&&i.byId(s)?.isAlive()})).map(((i,s)=>{const n=c.Regions.model(t).byId(s);if(!n)return{regionId:s,riskByDefenderMight:[]};const l=a.Warfare.getHexDefenseWithoutMovableUnits(t,(0,o.getHex)(e)),d=c.Regions.model(t).byHex(e),h=n.getEnemyAssets(),p=v({totalMight:h.getTotalAvailableMight(),maxUnitMight:h.getMaxAvailableMight(),maxUnitCount:h.getObtainableUnitCount(),resistance:i.resistance-(0,y.defenseToResistance)(l),distance:i.distance,cost:i.cost,skill:this.faction.basePersonality.defenseSkill});return p<=l?{regionId:s,riskByDefenderMight:[]}:{regionId:s,riskByDefenderMight:[1,2,3,4].filter((e=>e<=p)).map((e=>{if(e<=l)return 0;const s=m.AIMetrics.getBaseAttackProbability(h,e,l,i.distance,i.cost);let o=1;r===this.faction.id&&(o=u.inject.views.perceivedThreat.get(t,{attackerRegionId:n.id,defenderRegionId:d.id}));const a=o*s;return a<.01?0:a>1?1:a}))}})).valueSeq().toArray().filter((({regionId:e,riskByDefenderMight:t})=>t.length>0)),d=i.byHex((0,o.getHex)(e));if(d.faction?.id!==this.faction.id&&d.isAlive()){const i=d.getEnemyAssets(),s=i.getMaxAvailableMight(),n=i.getMaxSustainableMight();l.push({regionId:c.Regions.getByHex(t,e),riskByDefenderMight:[1,2,3,4].filter((e=>e<=s)).map((e=>e>n?.1:1))})}return l}}t.ThreatAssessment=f;class w extends r.GameStateDebugLayer{constructor(e){super({getValue(t,i){const s=e.get(i);if(s&&0!==s.strongestUnit)return`${(0,g.round)(s.risk,2)}`},getDetail(t,i){const s=u.inject.gameStateModel;if(!s.regions.byHex((0,o.getHex)(i)))return;const a=e.calculateComponents(i).sort(((e,t)=>e.regionId-t.regionId)).map((e=>{const i=n.Factions.getByRegion(t,e.regionId)??0;return e.riskByDefenderMight.map(((t,s)=>`  ${p.GLYPH.sword}${s+1} (${(100*t).toFixed(0)}%) from ${p.GLYPH.factions[i]}${e.regionId}`)).join("\n")})),r=Object.entries(e.get(i).riskByDefenderMight).filter((([e,t])=>t>0)).map((([e,t])=>`  ${p.GLYPH.sword}${Number(e)+1} ${(100*t).toFixed(0)}%`));return a.join("\n")+"\n----- total -----\n"+r.join("\n")+"\n"+`game ending threat: ${m.AIMetrics.getObviousGameEndingThreat(s.regions.byHex((0,o.getHex)(i)),e)}`},getHexes:e=>c.Regions.model(e).allRegionsHexes()}),this.assessment=e}}function v(e){const t=.5+.5*e.skill,i=Math.ceil((e.maxUnitCount-(e.distance-1))*t),s=e.totalMight*t-e.resistance;return i<=0?0:(0,d.pickLarger)(0,(0,d.pickSmaller)(Math.ceil(s),e.maxUnitMight))}t.ThreatAssessmentDebugLayer=w},17647:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryWithCache=void 0,t.FactoryWithCache=class{constructor(e){this.maker=e,this.instances=new WeakMap}getOrCreateFor(e){let t=this.instances.get(e);return t||(t=this.maker(e),this.instances.set(e,t)),t}}},18051:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexAlerts=void 0;const s=i(6528),n=i(56824),o=i(79573),a=i(57189);class r extends s.TileAttachmentsManager{constructor(e){super("HexAlerts",e.chunkedRenderer,e.tileObjects,n.logger.for("HexAlerts")),this.pool=e.objectsPool}attachObject(e,t){t.addObject(e,0,-25),e.setDepth(o.WorldLayers.UIOverlay+t.hex.y)}createObject(e,t){return this.pool.getTileSymbol(t).setDepth(o.WorldLayers.UIOverlay+e.y)}removeObject(e,t){t.removeObject(e),this.pool.free(e)}updateObject(e,t,i){e.setFrame((0,a.getFrameForPawnSymbol)(i))}}t.HexAlerts=r},18144:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorPointerEventsController=t.EditorPointerState=void 0;const s=i(56824),n=i(91622),o=i(54825);var a;!function(e){e.Idle="idle",e.CameraHoldDrag="camera-drag",e.Paint="paint"}(a||(t.EditorPointerState=a={})),s.logger.for("ui:MapEditorPointerEventsController"),t.MapEditorPointerEventsController=class{constructor(e){this.actionImpls=e,this.pointerState=a.Idle}startPaint(){this.setState(a.Paint)}startCameraDrag(){o.app.scene.worldMap.cameraController.startDragScroll(),this.setState(a.CameraHoldDrag)}stop(){this.pointerState===a.CameraHoldDrag&&o.app.scene.worldMap.cameraController.stopDragScroll(),this.pointerState=a.Idle}setState(e){e!==this.pointerState&&(this.pointerState=e,e!==a.Idle?n.inject.debugData.set("editorScene.pointerState",e):n.inject.debugData.clear("editorScene.pointerState"))}}},18315:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CenteredImage=void 0;const s=i(86545);class n extends s.BaseResponsiveContainer{constructor(e,t){super(e),this.content=t,this.add(t)}updateLayout(){this.content.setPosition(this.width/2-(this.content.displayWidth??this.content.width)/2,this.height/2-(this.content.displayHeight??this.content.height)/2)}clearTint(){return this.content.clearTint(),this}setTint(e){return this.content.setTint(e),this}}t.CenteredImage=n},18486:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameObjectCollection=void 0;const s=i(87521),n=i(18957);t.GameObjectCollection=class{constructor(e){this.scene=e,this.pool=new s.Pool((()=>this.createGameObject(this.scene))),this.onObjectCreated=(0,n.signal)(),this.activeObjects=[]}get(){return this.activeObjects}indexOf(e){return this.activeObjects.indexOf(e)}update(e){this.model=e;for(let t=0;t<e.length;t++){const i=e[t];if(this.activeObjects.length<=t){const e=this.createGameObject(this.scene);this.activeObjects[t]=e,this.scene.add.existing(e),this.onObjectCreated.fire(e)}const s=this.activeObjects[t];this.updateGameObject(s,i)}for(let t=e.length;t<this.activeObjects.length;t++){const e=this.activeObjects[t];e.setVisible(!1),this.pool.free(e)}this.activeObjects.splice(e.length)}}},18497:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensionHook=t.PluginKey=void 0,function(e){e.BuyTowns="buy-towns",e.Zombies="zombies",e.AiNoKnights="ai-no-knights",e.NormalDifficultyLevel="normal-difficulty-level",e.PickLandingSpot="pick-landing-spot",e.SpawnGifts="spawn-gifts",e.BuyGifts="buy-gifts",e.LowUpkeep="low-upkeep",e.CaptureTowns="capture-towns",e.AlwaysRetreat="always-retreat"}(i||(t.PluginKey=i={})),t.ExtensionHook=class{constructor(){this.registrations=[]}register(e){this.registrations.push(e)}apply(e,...t){return this.registrations.reduce(((e,i)=>i(e,...t)),e)}}},18811:(e,t)=>{"use strict";var i,s;Object.defineProperty(t,"__esModule",{value:!0}),t.STORED_COUNTERS=t.LevelOutcome=t.CameraFollowPreset=void 0,function(e){e.Off="off",e.NoZoom="no-zoom",e.On="on"}(i||(t.CameraFollowPreset=i={})),function(e){e.Victory="Victory",e.Defeat="Defeat"}(s||(t.LevelOutcome=s={})),t.STORED_COUNTERS=["cqlPlayed","cqlWon","cqlWonChallenging","cqlWonUnfair","cqlWonWithZombies"]},18922:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TutorialStep=t.TutorialDoubleTrouble=void 0;const s=i(37971),n=i(36868),o=i(91622),a=i(34174),r=i(12167),l=i(95428),c=i(85671),d=i(24598),h=i(45664),u=i(54825),p=i(56824);t.TutorialDoubleTrouble=class{constructor(){this.turn1_intro=new y(this),this.turn1_provinces_merged=new f(this),this.turn1_slow_them_down=new w(this),this.turn3_strategy_tip=new b(this),this.introduce_retreat_and_replay=new v(this),this.comment_on_successful_cutoff=new S(this),this.comment_on_north_town_destruction=new x(this),this.introShown=!1,this.provincesMerged=!1,this.hadRetreated=!1,this.commentedOnSuccessfulCutoff=!1,this.main=new g(this),this.idle=new m(this)}};class g extends s.LevelScript{activate(){o.inject.ai.maxAllowedUnitMight=2;const e=o.inject.gameStateModel.currentPhase.turnNumber;1!==e||this.module.introShown?1===e&&P()&&T()?this.goTo("turn1_slow_them_down"):!this.module.provincesMerged&&function(){const e=o.inject.gameStateModel.factions.localPlayer.getLargestLiveRegion();return e.size>=12&&e.treasury>=10}()?(this.module.provincesMerged=!0,this.goTo("turn1_provinces_merged")):3===e&&o.inject.gameStateModel.currentPhase.faction?.isLocalPlayer()?this.goTo("turn3_strategy_tip"):this.goTo("idle"):(this.module.introShown=!0,this.goTo("turn1_intro"))}}class m extends c.SimpleStep{onHexCaptured(e){25===e.victimRegionId&&e.defeatedUnit?.retreatHex?this.module.hadRetreated=!0:4===e.victimFactionId&&I()&&!this.module.commentedOnSuccessfulCutoff?(this.module.commentedOnSuccessfulCutoff=!0,this.goTo("comment_on_successful_cutoff")):4===e.victimFactionId&&309===e.capturedHexId&&I()?this.goTo("comment_on_north_town_destruction"):super.onHexCaptured(e)}onRegionSelected(e){1===o.inject.gameStateModel.currentPhase.turnNumber&&P()&&T()&&this.goTo("turn1_slow_them_down")}onPlayerTurnStart(){this.module.hadRetreated?(this.module.hadRetreated=!1,this.goTo("introduce_retreat_and_replay")):super.onPlayerTurnStart()}}t.TutorialStep=m;class y extends m{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:l.EmojiEmotion.Angry,buttons:[],text:"He just won't leave us alone, will he? Godfrey is trying to attack us from two sides on this island! Let's quickly [b]consolidate our forces![/b]"}})}}class f extends m{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:l.EmojiEmotion.Happy,buttons:[r.DIALOG_BUTTONS.moreInfo],text:"Nice move! With our two provinces merged into one, we can [b]buy another villager[/b] using their combined treasury!"},tutorialArrowTarget:a.Placement.aroundBuyablePawn(d.PawnType.Villager)}),this.onButtonClicked(r.DIALOG_BUTTONS.moreInfo,(()=>{p.events.trigger(n.UserActions.ShowHelp("advanced/multi-town-provinces"))})),this.onEvent(n.UiEvents.PawnPickedUpFromShop,(e=>{this.goTo("main")}))}onRegionSelected(e){this.goTo("main")}}class w extends m{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:l.EmojiEmotion.Neutral,buttons:[],text:"We should [b]move our villager here[/b] to slow down Godfreys advance."},tutorialArrowTarget:a.Placement.atWorldMapHex((0,h.getHex)(904))})}onRegionSelected(e){25!==e&&this.goTo("main")}}class v extends m{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:l.EmojiEmotion.Happy,buttons:[r.DIALOG_BUTTONS.moreInfo],text:"Ha! Did you see our villager retreat down there? Let's [b]hit the replay button[/b] to watch it again!"},tutorialArrowTarget:a.Placement.aroundReplayButton,tutorialFrameTarget:a.Placement.aroundReplayButton}),this.onEvent(n.UserActions.ViewReplay,(()=>{u.app.scene.playUI.updateState({worldMapPanel:{type:"tutorial",emojiEmotion:l.EmojiEmotion.Happy,buttons:[r.DIALOG_BUTTONS.moreInfo],text:"It's [b]the palisade walls[/b] around our towns and castles that allow units within the walls to retreat instead of perishing. This can prove quite useful!"},tutorialArrow:null,tutorialFrame:null})})),this.onButtonClicked(r.DIALOG_BUTTONS.moreInfo,(()=>{p.events.trigger(n.UserActions.ShowHelp("advanced/walls"))}))}}class b extends m{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:l.EmojiEmotion.Happy,buttons:[r.DIALOG_BUTTONS.moreInfo],text:"It's hard to defeat Godfreys pikeman head on, but the Goose is known to be reckless. We should be on the lookout for a [b]chance to get around his pikeman and strike directly at the town[/b]."}}),this.onButtonClicked(r.DIALOG_BUTTONS.moreInfo,(()=>{p.events.trigger(n.UserActions.ShowHelp("how-to-play/bandits"))}))}}class S extends m{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:l.EmojiEmotion.VeryHappy,buttons:[r.DIALOG_BUTTONS.moreInfo],text:"Oh yes, that's how you do it! Godfreys stranded pikeman will now become a harmless bandit!"}}),this.onButtonClicked(r.DIALOG_BUTTONS.moreInfo,(()=>{p.events.trigger(n.UserActions.ShowHelp("how-to-play/bandits"))}))}}class x extends m{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:l.EmojiEmotion.VeryHappy,buttons:[],text:"Yes, great move! [b]Finding ways around enemy units is almost always more powerful[/b] than trying to beat them head on!"}})}}function T(){return(o.inject.gameStateModel.regions.byId(25)?.getMovableUnitsByMight().count()??0)>0}function P(){return 25===o.inject.levelSession.selectedRegionId}function I(){return o.inject.gameStateModel.factions.byId(4).getPawns({type:[d.PawnType.Pikeman]}).filter((e=>!e.region.isAlive())).length>0}},18957:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.signal=function(){const e=[],t=function(t){return e.push(t),{unsubscribe(){i(t)}}};return t.fire=t=>e.map((e=>e(t))),t.unsubscribe=i,t.unsubscribeAll=()=>e.length=0,t;function i(t){const i=e.indexOf(t);-1!==i&&e.splice(i,1)}}},19009:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WaterHighlight=void 0;const s=i(56824),n=i(87936);var o=Phaser.GameObjects.Image;const a=1e3;t.WaterHighlight=class extends o{constructor(e){super(e,0,0,"atlas","ocean/hl1"),this.timeline=void 0,this.baseX=0,this.baseY=0,this.setAlpha(0),this.setOrigin(0,.5)}showAt(e,t,i=s.random.integerBetween(0,5e3)){this.baseX=e,this.baseY=t,this.respawn(i)}shuffle(){const{x:e,y:t}=s.random.point(n.HALF_HEX_WIDTH-8);this.setPosition(this.baseX+e,this.baseY+t),this.flipX=s.random.boolean(.5),this.setFrame(s.random.oneOf(["ocean/hl1","ocean/hl2","ocean/hl3"]))}respawn(e=0){this.shuffle();const t=s.random.integerBetween(1e3,5e3),i=this.respawn.bind(this);this.timeline&&(this.timeline.stop(),this.timeline.destroy()),this.timeline=this.scene.add.timeline([{at:e,tween:{targets:[this],alpha:{from:0,to:.75},duration:a,ease:"Sine.easeInOut"}},{at:e+a+t,tween:{targets:[this],alpha:{from:.75,to:0},duration:a,ease:"Sine.easeInOut"}},{at:e+t+2e3+s.random.integerBetween(1e3,3e3),run:i}]).play()}stopAnimating(){this.timeline?.destroy(),this.timeline=void 0}}},19048:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugScene=void 0;const s=i(81700),n=i(7334),o=i(20026),a=i(90952),r=i(76049),l=i(24598),c=i(8358),d=i(30948),h=i(897),u=i(19506),p=i(91622),g=i(54825),m=i(56824);class y extends d.BaseUIScene{constructor(){super({key:s.Scenes.Debug,pixelArt:!1}),this.suppressBreakPoints=!1,this.preUpdate=(0,h.whenDirty)((()=>{}))}create(){super.create(),this.cameras.main.setOrigin(0,0),this.debugData=p.inject.debugData,this.controller=p.inject.gameStateController,this.cursorPosLabel=new r.DebugTextBox(this,100,100,"(left, top)",{padding:10}),this.topLeftLabel=new r.DebugTextBox(this,10,30,"[left, top] - [left,top]",{dropShadow:!1,padding:10}),this.cursorPosLabel.setVisible(!1),this.pointer=this.input.activePointer,this.horizontalGuideLine=this.add.line(0,0,1,1).setOrigin(0,0).setLineWidth(.5).setStrokeStyle(1,255,.1),this.verticalGuideLine=this.add.line(0,0,1,1).setOrigin(0,0).setLineWidth(.5).setStrokeStyle(1,255,.1),this.breakpointLabel=this.add.text(0,0,"",{fontFamily:'"Monospace"',color:"#0000ff",fontSize:"24px"}).setVisible(!1).setOrigin(.5);const e=this.input.keyboard.addKey("N"),t=this.input.keyboard.addKey("C");e.on("down",(e=>{this.resumeFromBreakpoint()})),t.on("down",(e=>{this.suppressBreakPoints=!0,this.resumeFromBreakpoint(),setTimeout((()=>this.suppressBreakPoints=!1),3e3)})),p.inject.ui.hexUnderCursor.watch((e=>{if(e){const t=this.scene.get(s.Scenes.WorldMap).chunkedRenderer.getByHex(e);m.config.debug.overlay&&this.debugData.set("hexInfo",function(e,t){try{const i=g.app.getCurrentGameStateModel(),r=g.app.game.scene.getScene(s.Scenes.WorldMap),c=i.regions.byHex(e),d=i.factions.byHex(e),h=i.currentPhase.faction,y=c?`\n${u.GLYPH.factions[d?.id??0]} R#${c.id} F#${d?.id??0} ${function(e){const t=g.app.getCurrentGameStateModel();if(!(0,o.isDataSetActive)(t.state,a.GameState.economy.budgetByRegion))return"";const i=t.economy.budgetOf(e);return`(${e.hexes.length}${u.GLYPH.hex} ${t.economy.treasuryOf(e)}${(0,n.withSign)(i.balance)}=${t.economy.treasuryOf(e)+t.economy.budgetOf(e).balance}${u.GLYPH.coin})`}(c)} "${c.name||"region"}"`:"",w=i.pawns.byHex(e).map(f).join("\n "),v=w.length?"\n "+w:"";let b=m.config.debug.gameObjects&&r.tileObjects.getByHex(e.id)?.getDebugData()||"";b&&(b="\n"+b);let S="";return p.inject.debugLayers.activeLayerName&&(S=`\n${p.inject.debugLayers.activeLayerName}:\n  ${p.inject.debugLayers.activeLayer.getDetail(e)?.replace(/\n/g,"\n  ")}`),i.pawns.presentAtHex(e,l.PawnType.Town)&&d&&h&&(S+=`\nFaction ${d.id}:\n  Attitude: ${d.attitudeTowards(h)} (F: ${d.fearOf(h)} A: ${d.creditOf(h)})`),`${e}[c:${e.c},r:${e.r}][chunk #${t}]${y}${v}${S}${b}`}catch(e){return` ${e.toString()}`}}(e,t.id))}else this.debugData.clear("hexInfo")}))}resumeFromBreakpoint(){this.resumeFromBreakpointCallback&&(this.resumeFromBreakpointCallback(),this.resumeFromBreakpointCallback=void 0,this.breakpointLabel.setVisible(!1))}update(){const e=this.scene.get(s.Scenes.WorldMap);e&&this.pointer.updateWorldPoint(e.cameras.main),this.cursorPosLabel.setText(`C(${Math.round(this.pointer.x)},${Math.round(this.pointer.y)}) W(${Math.round(this.pointer.worldX)},${Math.round(this.pointer.worldY)})\n${this.debugData.get("hexInfo")||""}`);const t=this.cameras.main;this.topLeftLabel.setText(`v2.35.24-build-16101088196 ${t.width}x${t.height} DPR=${g.app.device.dpr} (real=${window.devicePixelRatio||1}), variant=${g.app.device.uiVariant()}\n${Math.floor(this.game.loop.actualFps)} FPS (${p.inject.performance.avgFrameTimeMs.toFixed()}ms/frame, force render every ${p.inject.performance.rerenderIntervalMs.toFixed()}ms)\n${function(e){if(m.config.debug.dataFilter&&!"scenes".includes(m.config.debug.dataFilter))return"";return["scenes:          state    DL  UL  TW A V",...e.map((e=>(0,c.padRight)("-"+e.scene.key,16)+" "+(0,c.padRight)(w[e.sys.settings.status],8)+(0,c.padLeft)(e.sys.displayList.length.toString(),3)+" "+(0,c.padLeft)(e.sys.updateList.length.toString(),3)+" "+(0,c.padLeft)(e.tweens.getTweens().length.toString(),3)+" "+(e.sys.isActive()?"* ":"  ")+(e.sys.isVisible()?"* ":"  ")))].join("\n")}(this.game.scene.getScenes(!0))}\n${function(){if(m.config.debug.dataFilter&&!"level".includes(m.config.debug.dataFilter))return"";if(!p.inject.currentGameState)return"level: N/A";const e=p.inject.gameStateModel.map,t=p.inject.gameStateModel.currentPhase;return`level: ${e.levelId} ${e.width}x${e.height} turn ${t.turnNumber} (${t.type} ${t.faction?.id??""}) [${e.plugins.plugins.map((e=>e.name))}]`}()}\n${function(){const e=p.inject.levelSession;return e.active?`session: ${e.id} (level=${e.levelId} outcome=${e.data?.outcome}, origin=${e.data?.origin})`:"session: INACTIVE"}()}\n${p.inject.debugData.getText()}`),0===this.pointer.x&&0===this.pointer.y||(this.cursorPosLabel.setPosition((this.pointer.x+20)/p.inject.ui.scale(),(this.pointer.y+20)/p.inject.ui.scale()),this.cursorPosLabel.setVisible(!0)),this.horizontalGuideLine.setTo(0,this.pointer.y-.5,this.cameras.main.width,this.pointer.y-.5),this.verticalGuideLine.setTo(this.pointer.x-.5,0,this.pointer.x-.5,this.cameras.main.height)}async handleBreakpoint(e,t){const i=g.app.scene.worldMap;if(!this.suppressBreakPoints)return new Promise((s=>{t.region&&i.overlays.selectedRegionHighlight.set(t.region),t.hexes?setTimeout((()=>{i.overlays.conquerableHexesHighlight.set(t.hexes)}),100):i.overlays.conquerableHexesHighlight.clear();let n=p.inject.debugLayers.activeLayerName;t.debugLayer&&("string"==typeof t.debugLayer?p.inject.debugLayers.activate(t.debugLayer):p.inject.debugLayers.registerAndActivate("breakpointDebugLayer",t.debugLayer)),this.resumeFromBreakpointCallback=()=>{i.overlays.selectedRegionHighlight.clear(),i.overlays.conquerableHexesHighlight.clear(),t.debugLayer&&p.inject.debugLayers.activate(n),s()},this.breakpointLabel.setVisible(!0),this.breakpointLabel.setText(" "+e+"\n [N] step [C] continue"),this.breakpointLabel.setPosition(this.cameras.main.centerX,this.cameras.main.height-100)}))}}function f(e){const t=g.app.scene.worldMap.pawns.getById(e.id);return`${e.type}${1!==e.count?` x${e.count}`:""} #${e.id} ${e.isMovable()?"(M)":""} (${t?.mode??"-"}${t?.hanging?":h":""}${t?.jumping?":j":""})`}t.DebugScene=y;const w={0:"pending",1:"init",2:"start",3:"loading",4:"creating",5:"running",6:"paused",7:"sleeping",8:"shutdown",9:"destroyed"}},19162:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rules=void 0;const s=i(90952),n=i(11505),o=i(63521),a=i(17647),r=i(20026),l=i(81434);class c{static get(e){return(0,r.selectFromState)(e,s.GameState.ruleSet)}static model(e){const t=this.get(e);return this.modelFactory.getOrCreateFor(t)}static getPawnRules(e,t){return(0,r.selectFromState)(e,s.GameState.ruleSet).pawns[t]??{}}static getPawnCost(e,t){return this.getPawnRules(e,t).cost||0}static getMergeResult(e,t,i){const s=l.Pawns.model(e).select({hexes:t,traits:[o.PawnTraits.OccupiesTile]})[0];if(!s)return i;const n=this.model(e).pawns(s.type).mergeRules;return n&&n[i]}static update(e,t){return(0,r.applyMutations)(e,s.GameState.ruleSet.createMutation(t,"update"))}}t.Rules=c,c.modelFactory=new a.FactoryWithCache((e=>new n.RulesModel(e)))},19506:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GLYPH=void 0,t.GLYPH={defense:String.fromCodePoint(57344),sword:String.fromCodePoint(57345),pawn:String.fromCodePoint(57346),kingdom:String.fromCodePoint(57347),coin:String.fromCodePoint(57348),hex:String.fromCodePoint(57349),checkMark:String.fromCodePoint(57350),crossMark:String.fromCodePoint(57351),pawns:{milita:"",pikeman:"",knight:"",hero:""},whiteFlag:"",redFlag:"",blueFlag:"",blackFlag:"",greenFlag:"",factions:[0,1,2,3,4,5,6].map((e=>String.fromCodePoint(57360+e))),source:"",movable:"",error:""}},19580:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GAME_ENDING_MOVE_SCORE=void 0,t.estimateDamage=y,t.createDamageSimDebugLayer=function(){return new c.GameStateDebugLayer((0,d.hexBasedAdapter)({getValue:(e,t)=>y(e,[(0,h.getHex)(t)]),getDetail:(e,t)=>y(e,[(0,h.getHex)(t)]).toString()}))};const s=i(56038),n=i(61634),o=i(78635),a=i(13560),r=i(70712),l=i(20693),c=i(76439),d=i(12543),h=i(45664),u=i(24598),p=i(63521),g=i(91622),m=i(19618);function y(e,i){if(0===i.length)return 0;const c=s.Regions.getByHex(e,i[i.length-1].id);if(void 0===c||!n.Economy.isRegionAlive(e,c))return 0;const d=l.HexGroup.from(i.filter((t=>s.Regions.getByHex(e,t.id)===c))),h=d.find((t=>s.Regions.isPotentialChokePoint(e,t.id)))?l.HexGroup.fromIds(s.Regions.getRegionHexes(e,c).toArray()).without(d).components():void 0;return function(e,t,i){if(!f(e,t))return!1;return n.Economy.getTownHexesByRegion(e,t).every((e=>i.some((t=>t.id===e))))}(e,c,i)?t.GAME_ENDING_MOVE_SCORE:h&&h.length>0?function(e,t,i){const s=a.AssetValue.total(r.AI.getRegionAssetsValue(e,t));let l=0;for(let t of i){let i=0,s=0,r=0,c=0,d=0,h=!1;for(let l of t){const t=o.Warfare.getOccupyingPawn(e,l);if(i+=a.AssetValue.HEX_BASE_VALUE,r+=n.Economy.getCurrentIncomeFromHex(e,l.id),t){c+=t?.upkeep??0;const o=a.AssetValue.total(a.AssetValue.getPawnFactors(t.type,t.count));t.hasTrait(p.PawnTraits.Unit)?s+=o:i+=o,t?.type===u.PawnType.Town&&(d+=n.Economy.getNumberOfCoinsAt(e,l.id),h=!0)}}h&&(l+=!h||d+r<0?i:i+s)}return s-l}(e,c,h.getGroups()):function(e,i,s){let l=0,c=0,d=0,h=0;for(let t of s){const i=o.Warfare.getOccupyingPawn(e,t);i?.type===u.PawnType.Town&&++h;const s=i?i.upkeep:0;l+=a.AssetValue.getTotal(e,t),c=n.Economy.getCurrentIncomeFromHex(e,t.id)-s,d+=n.Economy.getNumberOfCoinsAt(e,t.id)}const p=n.Economy.getTreasuryOf(e,i)-d,g=n.Economy.getRegionBudget(e,i).balance-c,m=n.Economy.getTownHexesByRegion(e,i).size-h===0,y=n.Economy.isRegionBankrupt(e,i),w=p+g<0||m;return m&&f(e,i)?t.GAME_ENDING_MOVE_SCORE:!y&&w?a.AssetValue.total(r.AI.getRegionAssetsValue(e,i)):y&&!w?-a.AssetValue.total(r.AI.getRegionAssetsValue(e,i)):l}(e,c,d)}function f(e,t){if(g.inject.views.powerBalance.get(e).factionsByPower.length>2)return!1;const i=m.Factions.getByRegion(e,t);if(!i)return!1;const s=m.Factions.model(e).byId(i)?.getLiveRegions();return 1===s?.length&&s[0].id===t}t.GAME_ENDING_MOVE_SCORE=1e6},19618:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionMutations=t.Factions=void 0;const s=i(90952),n=i(56038),o=i(24598),a=i(20026),r=i(38399),l=i(97849),c=i(27109);class d{static model(e){return this.models.get(e)}static getAll(e){return(0,a.selectFromState)(e,s.GameState.factions.byId).keySeq().toArray()}static getData(e,t){return(0,a.selectFromState)(e,s.GameState.factions.byId,t)}static getByRegion(e,t){return(0,a.selectFromState)(e,s.GameState.factions.byRegion,t)}static getByHex(e,t){const i=n.Regions.getByHex(e,t);if(i)return d.getByRegion(e,i)}static getNextId(e){return(0,a.getParentEngine)(e).getNextId(s.GameState.factions.byId)}static getFactionRegions(e,t){return(0,a.selectFromState)(e,s.GameState.factions.regions,t)?.toArray()||[]}static setThemeIndex(e,t,i){const n=d.getData(e,t);return l.assert.defined(n),(0,a.applyMutations)(e,s.GameState.factions.byId.createMutation({set:{[t]:{...n,themeIndex:i}}},"faction.setLandColor"))}static setController(e,t,i){const n=d.getData(e,t);return l.assert.defined(n),(0,a.applyMutations)(e,s.GameState.factions.byId.createMutation({set:{[t]:{...n,controller:i}}},"faction.setController"))}static setData(e,t,i){const n=d.getData(e,t);return l.assert.defined(n),(0,a.applyMutations)(e,s.GameState.factions.byId.createMutation({set:{[t]:{...n,...i}}},"faction.setData"))}static createFaction(e,{name:t,regions:i,themeIndex:n,controller:r,persona:l,id:c}){const d={id:c,name:t,controller:r??o.FactionController.None,themeIndex:n??0,persona:l};return(0,a.applyMutations)(e,s.GameState.factions.byId.createMutation({set:{[c]:d}},"createFaction"),h.captureRegions(c,i||[]))}static captureRegions(e,t,...i){return 0===i.length?e:(0,a.applyMutations)(e,h.captureRegions(t,i))}static addNewRegion(e,t,i,s,o){const r=o;return(0,a.applyMutations)(e,n.RegionMutations.createRegion(r,i),n.RegionMutations.addHexesToRegion(r,s),h.captureRegions(t,[r]))}static disownRegions(e,...t){const i=t.filter((t=>void 0!==this.getByRegion(e,t)));return(0,a.applyMutations)(e,s.GameState.factions.byRegion.createMutation({delete:i},"faction.disownRegions"))}static getSameFactionNeighbours(e,t,i){const s=i??this.getByHex(e,t.id);return t.neighbours((t=>this.getByHex(e,t.id)===s))}}t.Factions=d,d.models=new c.ModelsCache((e=>new r.FactionsDataSetModel(e)));class h{static captureRegions(e,t){const i={};return t.forEach((t=>i[t]=e)),s.GameState.factions.byRegion.createMutation({set:i},"faction.captureRegions")}}t.FactionMutations=h},19693:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsManager=t.HOVERING_HEIGHT=t.PawnEffects=void 0,t.getPawnVariant=b;const s=i(56824),n=i(76314),o=i(8),a=i(24598),r=i(97849),l=i(63521),c=i(1326),d=i(11835),h=i(40951),u=i(81434),p=i(56038),g=i(52307),m=i(78635),y=i(54825);var f;!function(e){e.Jump="jump",e.SpawnFromAbove="spawn-from-above"}(f||(t.PawnEffects=f={}));t.HOVERING_HEIGHT=10;const w=[a.PawnType.Coins,a.PawnType.Forest,a.PawnType.Mana,a.PawnType.Swamp],v=s.logger.for("PawnsManager");function b(e,t){return t.type==a.PawnType.Town?(0,g.isUndeadTerritory)(e,t.hex)?"undead":p.Regions.model(e).byHex(t.hex)?.getLevel()??1:t.type===a.PawnType.TownRuins?!m.Warfare.model(e).isOccupied(t.hex)&&p.Regions.model(e).byHex(t.hex)?.isAlive()?"rebuilding":void 0:t.type===a.PawnType.UniqueHero?t.name:void 0}t.PawnsManager=class{constructor(e,t,i){this.scene=e,this.pools=t,this.tiles=i,this.transitions=new d.PawnTransitions(this,this.tiles),this.pawnsById={},this.jumpClock=this.scene.tweens.addCounter({from:0,to:1,ease:"Linear",repeat:-1,duration:h.TIMING.pawnJumpDuration})}update(){Object.values(this.pawnsById).filter((e=>e.mode===n.PawnObjectModes.AttachedToTile&&e.jumping&&!e.highlight)).forEach((e=>{const t=(this.getJumpPhaseForPawn(e)+e.jumpingDeSync)%1;e.setJumpPhase(t),e.jumpingDeSync>0&&e.jumpingDeSync<=.5?e.jumpingDeSync-=.002:e.jumpingDeSync>=.998?e.jumpingDeSync=0:e.jumpingDeSync>.5&&(e.jumpingDeSync+=.002)}))}getJumpPhaseForPawn(e,t=0){const i=e.baseY%h.TIMING.pawnJumpDuration/h.TIMING.pawnJumpDuration;return(this.jumpClock.getValue()+t/h.TIMING.pawnJumpDuration+i)%1}createOrUpdatePawnObject(e){const t=e.id,i=e.hexId,s=e.type,o=this.pawnsById[t],a=e.variant??o?.variant,l=this.tiles.getByHex(i);if((0,r.assert)(l,`unable to get or create pawn on hex #${i} - no tile available for this hex!`),o)return o.setType(s,a),void 0!==e.visible&&o.setVisible(e.visible),o.attachToTile(this.tiles.getByHex(i)),o.setJumping(e.jumping),o;{const o=new n.PawnObject(this,t,s,a);return this.pawnsById[t]=o,o.attachToTile(this.tiles.getByHex(i)),o.setJumping(e.jumping),void 0!==e.visible&&o.setVisible(e.visible),o}}syncWithModel(e){const t=e.pawns.all().filter((e=>!w.includes(e.type))),i=(0,c.dictionaryOf)(t,"id");this.clearAllJumping(),Object.entries(this.pawnsById).map((([e,t])=>{i[e]||(t.destroy(),delete this.pawnsById[e])}));const s=y.app.scene.worldMap.mode.allowsJumpingPawns;for(const i of t)this.createOrUpdatePawnObject({id:i.id,hexId:i.hex.id,jumping:s&&i.isMovable()&&!!i.faction?.isLocalPlayer(),type:i.type,visible:!0,variant:b(e.state,i)})}partialSync(e,t){const i=e.pawns.select({hexes:t}).filter((e=>!w.includes(e.type))),s=(0,c.dictionaryOf)(i,"id");for(const e of i)this.createOrUpdatePawnObject({id:e.id,hexId:e.hex.id,jumping:!1,type:e.type,visible:!0});Object.entries(this.pawnsById).map((([e,i])=>{t.contains(i.tile?.hex)&&!s[e]&&(i.destroy(),delete this.pawnsById[e])}))}_remove(e){e.isDestroyed()?(delete this.pawnsById[e.id],this.hangingPawn===e&&this.clearHangingPawn()):e.destroy()}show(e){const t=this.pawnsById[e];t?(t.setVisible(!0),t.jumpingDeSync=this._getCurrentJumpingDeSyncForPawn(t)):v.warning(`Ignoring request to show pawn ${e}, no such pawn exists`)}hide(e){const t=this.pawnsById[e];t?t.setVisible(!1):v.warning(`Ignoring request to hide pawn ${e}, no such pawn exists`)}_getCurrentJumpingDeSyncForPawn(e,t=1){return(1+t-this.getJumpPhaseForPawn(e))%1}getPawnObjectPositionOnScreen(e,t){const i=this.getByHex(t);if(i)return{...(0,o.convertWorldXYToCameraXY)(e,i.image.x,i.image.y),scale:e.zoom*i.image.scale};{const i=this.tiles.getByHex(t);return r.assert.defined(i,`hex ${t} not found`),{...(0,o.convertWorldXYToCameraXY)(e,i.centerX,i.centerY+3),scale:.5*e.zoom}}}setHangingPawn(e){const t=this.pawnsById[e];t!==this.hangingPawn&&(this.hangingPawn&&this.clearHangingPawn(),this.hangingPawn=t),this.hangingPawn&&this.hangingPawn.setHighlight(n.Highlight.Hang)}clearHangingPawn(){this.hangingPawn&&(this.hangingPawn.isDestroyed()||this.hangingPawn.clearHighlight(),this.hangingPawn=void 0)}clearAllJumping(){Object.values(this.pawnsById).map((e=>e.stopJumping()))}resetJumpingState(e){e.setJumpPhase(0)}async replace(e,t,i){let s=this.pawnsById[e];s?s.setType(t,i):v.warning(`Request to replace pawn ${e} with ${t} but there is no existing pawn with this id => ignoring`)}jumpOnce(e){let t=this.pawnsById[e];if(t){if(t.jumping)return void v.warning(`Request to play jump animation on ${e} ignored as pawn is already jumping`);this.scene.tweens.add({targets:t.image,y:{from:t.baseY,to:t.baseY-n.PAWN_JUMPING_HEIGHT},ease:"Sine.easeOut",duration:200,yoyo:!0}),this.scene.tweens.add({targets:t.shadow,scale:{from:.5,to:.2},ease:"Sine.easeOut",duration:200,yoyo:!0})}else v.warning(`Request to play jump animation on ${e} ignored as there is no pawn there`)}getByHex(e){return Object.values(this.pawnsById).find((t=>t.tile?.hex.id===e&&t.mode===n.PawnObjectModes.AttachedToTile))}getById(e){return this.pawnsById[e]}syncPawnVariant(e,t){const i=u.Pawns.model(e).select({hexes:t}).filter((e=>e.hasTrait(l.PawnTraits.OccupiesTile)||e.type===a.PawnType.TownRuins));for(let t of i)this.replace(t.id,t.type,b(e,t))}integrityCheck(){if(s.config.debug.integrityChecks?.pawns)for(let e in this.pawnsById){const t=this.pawnsById[e];(0,r.assert)(!t.isDestroyed(),`found destroyed ${t.type} at hex ${e} (v${t.variant??"-"}) still in pawnsByHex collection`)}}}},19746:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createEmptyProgressData=void 0,t.createEmptyProgressData=()=>({counters:{},completedLevels:{}})},19748:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Marshal=void 0,t.getCostPerUnitOfMight=function(e){return e.rules.pawns(a.PawnType.Villager).cost};const s=i(63521),n=i(36868),o=i(56824),a=i(24598),r=i(97849),l=i(89764),c=o.logger.for("ai:Marshal");t.Marshal=class{constructor(e){this.ctx=e,this.model=this.ctx.game.model}moveUnit(e,t){try{return this.tryMoveUnit(e,t),!0}catch(e){return c.warning(`Failed to execute plan ${(0,l.describePlan)(t)}: ${e.message}`),!1}}moveToHexSuitableForMerge(e){const t=this.model.rules.unitByMight(e.might+1);r.assert.defined(t,`cannot merge unit with might ${e.might}`);const i=this.model.warfare.getNearestSuitableHexAfterMerge(e,t);if(!i)throw new Error("cannot find hex suitable for merging into heavy unit");return i!==e.hex&&this.ctx.addPlay(n.Plays.MovePawn({pawnId:e.id,destinationHexId:i.id,tapUnit:!1})),i}tryMoveUnit(e,t){const i=[...t.recipe];let s=null,o=e;for(let e of i)switch(e.action){case"buy":if(s)throw new Error("invalid recipe: two buy unit steps in a row");s=e.might;break;case"merge":const t=this.grabUnit(o,e.might);if(r.assert.defined(t,`invalid recipe: cannot find first unit with might ${e.might} for merge`),o=this.moveToHexSuitableForMerge(t),s){if(e.might!==s)throw new Error(`invalid recipe: merge units of might ${e.might} cannot follow buying of unit with might ${s}`);const i=this.model.rules.unitByMight(s)?.type;if(!i)throw new Error(`invalid recipe: cannot buy unit with might ${s}`);this.ctx.addPlay(n.Plays.BuyPawn({pawnType:i,buyerRegionId:this.ctx.region.id,destinationHexId:t.hex.id,tapUnit:!1})),s=null}else{const i=this.grabUnit(o,e.might,t);r.assert.defined(i,`invalid recipe: cannot find second unit with might ${e.might} for merge`),this.ctx.addPlay(n.Plays.MovePawn({pawnId:i.id,destinationHexId:t.hex.id,tapUnit:!1}))}}if(s){(0,r.assert)(s===t.might,`invalid recipe: last step is buying unit with might ${s}, but required might is ${t.might}`);const i=this.model.rules.unitByMight(s)?.type;r.assert.defined(i,`invalid recipe: cannot buy unit with might ${s}`),this.freeUpHexIfObstructed(e),this.ctx.addPlay(n.Plays.BuyPawn({pawnType:i,buyerRegionId:this.ctx.region.id,destinationHexId:e.id,tapUnit:!0}),e)}else{const i=this.grabUnit(o,t.might);r.assert.defined(i,`invalid recipe: failed to find any unit with might ${t.might}`),this.ctx.addPlay(n.Plays.MovePawn({pawnId:i.id,destinationHexId:e.id,tapUnit:!0}),e)}return!0}grabUnit(e,t,i){const s=this.model.pawns.findClosest(e,this.ctx.region.hexes,(e=>e!==i&&this.model.currentPhase.isMovable(e)&&e.might===t));return s?.hex!==e&&i?.hex!==e&&this.freeUpHexIfObstructed(e),s}freeUpHexIfObstructed(e){if(this.model.regions.byHex(e)!==this.ctx.region)return!0;const t=this.model.pawns.findOne({hexes:e,traits:[s.PawnTraits.Unit]});if(t){const i=this.ctx.region.hexes.findClosest(e,(e=>this.model.warfare.isFreeToEnterFor(e,t.type)));return i?(this.ctx.addPlay(n.Plays.MovePawn({pawnId:t.id,destinationHexId:i.id,tapUnit:!1})),!0):(c.warning(`Unable to free up space for defender on hex ${e} - there's nowhere to move obstructing unit ${t}`),!1)}return!0}buildCastle(e,t){try{const i=this.model.rules.castleByMight(t).type;return!!this.freeUpHexIfObstructed(e)&&(this.ctx.addPlay(n.Plays.BuyPawn({pawnType:i,buyerRegionId:this.ctx.region.id,destinationHexId:e.id,tapUnit:!0})),!0)}catch(t){return c.warning(`Failed to build castle at ${e}: ${t.message}`),!1}}}},19970:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnBacklight=void 0;const s=i(79573),n=i(56824);var o=Phaser.GameObjects.Sprite;n.logger.for("PawnBacklight"),t.PawnBacklight=class extends o{constructor(e,t){super(e,0,0,"atlas","pawn-backlight"),this.baseWidth=t,this.setOrigin(.5,1),this.setTint(65280),this.setDepth(s.WorldLayers.UIOverlay),this.setDisplaySize(t,128),this.baseScaleX=this.scaleX,this.baseScaleY=this.scaleY,this.pulseTween=this.scene.add.tween({targets:this,scaleY:{from:.9*this.baseScaleY,to:this.baseScaleY},alpha:{from:.7,to:1},duration:1e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut",paused:!0}),this.animateIn()}setBaseWidth(e){this.baseWidth=e,this.setDisplaySize(this.baseWidth,128)}animateIn(){this.scene.tweens.add({targets:this,scaleX:{from:0,to:this.baseScaleX},scaleY:{from:.5,to:this.baseScaleY},alpha:{from:0,to:.7},ease:"Sine.easeOut",duration:300,onComplete:()=>this.pulseTween.play()})}destroy(){super.destroy()}}},20026:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PARENT_ENGINE_KEY=t.ACTIVE_DATASETS_KEY=t.EMPTY_SET=void 0,t.createImmutableState=function(e,i){return(0,s.ImmutableMap)({[t.ACTIVE_DATASETS_KEY]:(0,s.ImmutableSet)(i),[t.PARENT_ENGINE_KEY]:e})},t.applyMutations=function(e,...t){const i=n(e);if(i.currentState!==e)throw new Error("Attempt to apply mutation to state that is no longer active in the parent engine");return i.apply(...t),i.currentState},t.setParentEngine=function(e,i){return e.set(t.PARENT_ENGINE_KEY,i)},t.getParentEngine=n,t.assertStateHasDataSet=function(e,t){if(!o(e,t))throw new Error(`dataSet ${t} not available in the state (available dataSets: ${a(e).map((e=>`"${e.key}"`)).join(",")})`)},t.isDataSetActive=o,t.getActiveDataSets=a,t.getActiveProjections=function(e){return a(e).filter((e=>r(e)))},t.selectFromState=function(e,t,i){if(!o(e,t))throw new Error(`dataSet ${t} not available in the state`);return void 0!==i?t.getEntryById(e,i):e.get(t.key)},t.selectFromSuspendedState=function(e,t,i){return t.getEntryById(e,i)},t.isProjectionDataSet=r,t.updateActiveDataSets=function(e,i){return e.update(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET,i)},t.isImmutableState=function(e){return s.ImmutableMap.isMap(e)};const s=i(88023);function n(e){return e.get(t.PARENT_ENGINE_KEY)}function o(e,i){return e.get(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET).has(i)}function a(e){return e.get(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET)}function r(e){return!!e.bootstrap}t.EMPTY_SET=(0,s.ImmutableSet)(),t.ACTIVE_DATASETS_KEY="_activeDataSets",t.PARENT_ENGINE_KEY="_parentEngine"},20034:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorActions=void 0;const s=i(60190);t.MapEditorActions={SelectTool:(0,s.editorAction)()("SET_TOOL"),SelectBrush:(0,s.editorAction)()("SET_BRUSH"),ResetStartingCoins:(0,s.editorAction)()("RESET_STARTING_COINS"),SetMode:(0,s.editorAction)()("SET_MODE"),PreviewSnapshot:(0,s.editorAction)()("PREVIEW_SNAPSHOT"),CancelSnapshotPreview:(0,s.editorAction)()("CANCEL_SNAPSHOT_PREVIEW"),DownloadLevel:(0,s.editorAction)()("DOWNLOAD_LEVEL"),DeleteSnapshot:(0,s.editorAction)()("DELETE_SNAPSHOT"),RestoreSnapshot:(0,s.editorAction)()("RESTORE_SNAPSHOT"),RenameSnapshot:(0,s.editorAction)()("RENAME_SNAPSHOT"),SaveSnapshot:(0,s.editorAction)()("SAVE_SNAPSHOT"),AddPlugin:(0,s.editorAction)()("ADD_PLUGIN"),RemovePlugin:(0,s.editorAction)()("REMOVE_PLUGIN")}},20087:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Arrange=t.horizontalAlign=void 0;const s=i(9292);var n;function o(e){return"number"==typeof e?{size:e}:function(e){return"number"!=typeof e&&e.hasOwnProperty("type")}(e)?{object:e}:e}function a(e){const t=e.content.map(o).filter((e=>!e.object||e.object.visible));!function(e){const t=new Set;for(let i of e)i.object&&t.add(i.object.parentContainer);if(t.size>1){const t=e.filter((e=>e.object&&!e.object.parentContainer));console.error("SOME OBJECTS NOT ADDED TO CONTAINER",t.length?t:e)}}(t);const i=e.spacing??0,n=e.origin??0;let a=t.map(c).reduce(s.sum,0)+i*(t.length-1),r=0;if(e.maxSize&&a>e.maxSize){let i=a-e.maxSize;const n=t.map((e=>e.minSize?c(e)-e.minSize:0)).reduce(s.sum,0);r=(0,s.pickSmaller)(1,i/n),a=e.maxSize}let l=e.offset-a*n;for(let s of t){const t=c(s,r);s.object&&(s.object[e.layoutAxis]=l,e.maxSize&&s.object[e.secondarySizeProp]!==t&&(s.object[e.secondarySizeProp]=t)),l+=t+i}function c(t,i=0){const s=(t.size||t.object?.[e.primarySizeProp]||t.object?.[e.secondarySizeProp])??0;if(i&&t.minSize){const e=s-t.minSize;return t.minSize+e*(1-i)}return s}}function r(e){return e.displayWidth||e.width}!function(e){e[e.Left=0]="Left",e[e.Middle=.5]="Middle",e[e.Right=1]="Right"}(n||(t.horizontalAlign=n={})),t.Arrange={fromTopToBottomOld(e,t){const i=(e=e.filter((e=>e.visible))).map((e=>e.height)).reduce(s.sum,0)+t.spacing*(e.length-1)+2*(t.padding??0);e.map(r).reduce(s.pickLarger,0);let n=t.y-i*(t.originY??0);for(let i of e)i.setPosition(t.x-r(i)*(t.originX??0),n),n=n+i.height+t.spacing},alignX(e){const t=e.origin??.5;for(let i of e.content){const s=e.width??(i.displayWidth||i.width);i.x=e.x-s*t,e.width&&i.width!==e.width&&(i.width=e.width)}},alignY(e){const t=e.origin??.5;for(let i of e.content){const s=e.height??(i.displayHeight||i.height);i.y=e.y-s*t,e.height&&i.height!==e.height&&(i.height=e.height)}},topToBottom:e=>a({...e,offset:e.y,layoutAxis:"y",primarySizeProp:"displayHeight",secondarySizeProp:"height"}),leftToRight:e=>a({...e,offset:e.x,layoutAxis:"x",primarySizeProp:"displayWidth",secondarySizeProp:"width"}),place(e,t){t.left&&(e.x=t.left),t.right&&(e.x=t.right-e.width),t.top&&(e.y=t.top),t.bottom&&(e.y=t.bottom-e.height)}}},20227:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tweener=t.BasicTweener=t.Tween=void 0,t.Tween=Phaser.Tweens.Tween;const s=i(2543),n=i(56824),o=i(1326),a=n.logger.for("Tweener");t.BasicTweener=class{constructor(){this.currentTweens=new Set,this.currentCallback=s.noop}setTweens(e,t){this.currentTweens.forEach((e=>e.stop())),this.currentTweens=new Set(e),this.currentCallback=t||s.noop,e.forEach((e=>e.on("complete",(e=>this.handleCompleted(e)))))}handleCompleted(e){0!==this.currentTweens.size&&(this.currentTweens.delete(e),0===this.currentTweens.size&&(this.currentCallback(),this.currentCallback=s.noop))}};let r=0;t.Tweener=class{constructor(e,t={}){this.scene=e,this.defaultTweenConfig=t,this.tweensByTarget=new Map}getAllTweens(){return(0,o.stripDuplicatesFrom)(Array.from(this.tweensByTarget.values()).flat())}set(e){this.stop(!1);for(let t of e)this.add(t,!1)}add(e,t=!0){const i=e.onComplete,s=Array.isArray(e.targets)?[...e.targets]:[e.targets];let n="t"+ ++r;if(0===s.length)return void a.trace("ignoring request to add tween with no targets");e.onComplete=(...e)=>{for(let e of s)this.tweensByTarget.delete(e);i?.(...e)};const o=this.scene.tweens.add({...e,targets:s,...this.defaultTweenConfig});if(s)for(let e of s)if(t)this.stopAllTweensForTarget(e,n),this.tweensByTarget.set(e,[o]);else{const t=this.tweensByTarget.get(e);t?t.push(o):this.tweensByTarget.set(e,[o])}return o}stopAllTweensForTarget(e,t){const i=this.tweensByTarget.get(e);if(i?.length)for(const t of i)if(1===t.targets.length&&t.targets[0]===e){if(t.progress>0)try{t.seek()}catch(e){a.warning(`failed to seek to 0: ${e}`)}t.stop()}else(0,o.removeFromArrayInPlace)(t.targets,e)}stop(e=!0){(0,o.stripDuplicatesFrom)(Array.from(this.tweensByTarget.values()).flat()).forEach((t=>{t.stop(),e&&t.complete()})),this.tweensByTarget.clear()}hasTweens(){return!!this.tweensByTarget.size}}},20276:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SecurityView=void 0,t.createSecurityDebugLayer=S;const s=i(78635),n=i(18957),o=i(90952),a=i(65415),r=i(70712),l=i(19506),c=i(91622),d=i(52434),h=i(45664),u=i(13602),p=i(9292),g=i(19618),m=i(56038),y=i(97849),f=i(1326),w=i(24598),v=i(8971);class b extends d.CalculatedHexGroupValuationWithCache{constructor(e,t){super(),this.params=e,this.tag=t}calculate(e,t){const{isTownHex:i,parentsSecurity:s,hexSecurity:n}=this.getFactors(e,t);return i?n:0===s.length?0:p.Probability.ofEvery(n,Math.max(...s))}getFactors(e,t){const i=this.params.faction.state,n=m.Regions.getByHex(i,e);y.assert.defined(n);const o=s.Warfare.getOccupyingPawn(i,(0,h.getHex)(e))?.type===w.PawnType.Town,a=this.params.threatAssessment.get(e),l=(0,p.pickLarger)(s.Warfare.getHexDefenseWithoutMovableUnits(i,(0,h.getHex)(e)),t?.defense??0);if(o){const e=(0,f.stripDuplicatesFrom)(a.regions.map((e=>g.Factions.getByRegion(i,e)))).some((e=>e&&r.AI.getRegionAttrition(i,n,e)>2));return{isTownHex:!0,parentsSecurity:[],hexSecurity:(0,v.adjustMultiplierByFocus)(u.AIMetrics.riskToTownSecurity(a.riskByDefenderMight[l]??0,e),1-this.params.recklessness)}}{const s=r.AI.getHexImportance(i,e);return{isTownHex:!1,parentsSecurity:(t?.parents??s.parents).map((e=>this.get(e.id))),hexSecurity:(0,v.adjustMultiplierByFocus)(u.AIMetrics.riskToSecurity(a.riskByDefenderMight[l]??0),1-this.params.recklessness)}}}afterPlacingDefender(e,t){const i=this.params.faction.state;let n;n=g.Factions.getByHex(i,e)===this.params.faction.id?r.AI.getHexImportance(i,e).parents:(0,h.getHex)(e).neighbours((e=>g.Factions.getByHex(i,e.id)===this.params.faction.id)).members;const o=this.getFactors(e,{defense:s.Warfare.getHexDefenseAfterCapturedBy(i,(0,h.getHex)(e),this.params.faction.id,t),parents:n}),a=n.map((e=>this.calculate(e.id,{defense:t})));return 0===a.length&&a.push(1),p.Probability.ofEvery(o.hexSecurity,Math.max(...a))}getDebugLayer(){return S(this)}setRecklessness(e){e!==this.params.recklessness&&(this.params.recklessness=e,this.flush())}}function S(e){let t=(0,n.signal)();const i=c.inject.gameStateModel;return i.stateEngine.watchDataSet(o.GameState.ai.regionInfluenceByHex,(()=>{t.fire()})),i.stateEngine.watchDataSet(o.GameState.ai.hexImportance,(()=>{t.fire()})),{name:"ai.exposedAssets",onChange:t,getMap(){let t=new a.CustomHexGroupValuation("");return e.params.faction.hexes.forEach((i=>{const s=100*e.get(i.id);t.set(i.id,100===s?l.GLYPH.defense:s.toFixed())})),t},getDetail(t){const n=e.getFactors(t.id);return`this hex total risk: ${e.params.threatAssessment.get(t.id).risk}            \nthis hex relevant risk: ${e.params.threatAssessment.get(t.id).riskByDefenderMight[s.Warfare.getHexDefense(i.state,t)]}\nthis hex security: ${n.hexSecurity.toFixed(2)}\nparents: ${n.parentsSecurity.map((e=>e.toFixed(2))).join(", ")}\ntotal: ${e.get(t.id)}\nwith villager: ${e.afterPlacingDefender(t.id,1)}\nwith pikeman: ${e.afterPlacingDefender(t.id,2)}\n`}}}t.SecurityView=b},20290:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugLayer=t.SwampLayer=t.GreenLayer=t.GroundLayer=t.LandmassLayer=void 0;const s=i(82226),n=i(35592),o=i(80829),a=i(56038),r=i(70712),l=i(76049),c=i(54825),d=i(78635),h=i(81434),u=i(24598);var p=Phaser.GameObjects.BitmapText;class g extends o.SimplePaintedLayer{constructor(){super(s.IsoTileRecipes.Landmass)}}t.LandmassLayer=g;class m extends n.FactionBasedPaintedLayer{constructor(){super(s.IsoTileRecipes.Ground)}shouldIncludeHex(e,t){return!e.isNeutral()}getTint(e){return e.landColor}}t.GroundLayer=m;class y extends n.FactionBasedPaintedLayer{constructor(){super(s.IsoTileRecipes.Green)}shouldIncludeHex(e,t){return!!a.Regions.model(e.state).byHex(t)?.isAlive()&&d.Warfare.canBeProtectedByWalls(e.state,t.id)&&(r.AI.getHexAge(e.state,t.id)>0||e.isLocalPlayer())}getTint(e){return e?.landColorLight||0}}t.GreenLayer=y;class f extends n.FactionBasedPaintedLayer{constructor(){super(s.IsoTileRecipes.Swamp)}shouldIncludeHex(e,t){return h.Pawns.isPresentOnHex(e.state,t.id,u.PawnType.Swamp)}getTint(e){return e?.landColorLight||0}}t.SwampLayer=f;class w extends o.SimplePaintedLayer{constructor(){super(s.IsoTileRecipes.Debug)}paintCorner(e,t,i,s,n){super.paintCorner(e,t,i,s,n),this.text||(this.text=new p(t.scene,0,0,l.BitmapFont.Mini));const o=c.app.scene.worldMap.chunkedRenderer,a=o.sectorMap.getSectorsForCorner(i.id),r=a.map((e=>o.getById(e))).some((e=>!e.corners.find((e=>e.id===i.id))));this.text.setText(i.id.toString()+"\nC: "+a.join(" ")+(r?"\nMISMATCH":"")),t.batchDraw(this.text,s,n,1,16777215)}}t.DebugLayer=w},20389:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CursorAttachment=void 0,t.CursorAttachment=class{constructor(e){this.scene=e}setImage(e){if(this.image){if(this.image===e)return;this.image.destroy()}this.image=e,e&&this.scene.add.existing(e)}update(){if(this.image){const e=this.scene.input.activePointer.x+this.scene.cameras.main.scrollX,t=this.scene.input.activePointer.y+this.scene.cameras.main.scrollY;this.image.setPosition(e+8,t+8)}}clear(){this.setImage(void 0)}}},20518:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseScene=void 0;const s=i(56824),n=i(91622),o=i(93868),a=i(54825),r=i(52031),l=i(20227);class c extends Phaser.Scene{constructor(e){super(e),this.observe=new r.Observer((()=>this.scene.isActive())),this.pendingThemeData=void 0,this.pools={},this.tweener=new l.Tweener(this),this.previousSize=void 0,this.domElements=[],this.bounds=e.bounds??o.BOUNDS.Main,this.log=s.logger.for((e.key??"")+"Scene")}async fadeIn(e){return new Promise((t=>{this.tweener.add({targets:this.cameras.main,alpha:{from:0,to:1},duration:e,onComplete:t})}))}async fadeOut(e){return new Promise((t=>{this.tweener.add({targets:this.cameras.main,alpha:0,duration:e,onComplete:t})}))}applyBounds(){const e=this.previousSize?this.previousSize.width:this.bounds.width,t=this.previousSize?this.previousSize.height:this.bounds.height;this.cameras.main.setPosition(this.bounds.x,this.bounds.y),this.cameras.main.setSize(this.bounds.width,this.bounds.height),this.resize({oldWidth:e,oldHeight:t,newWidth:this.cameras.main.width,newHeight:this.cameras.main.height}),this.previousSize={width:this.bounds.width,height:this.bounds.height}}applyTheme(e){}create(){s.config.watchFuture((e=>this.applyConfig(e))),n.inject.theme.use((e=>{this.scene.isActive()?(this.applyTheme(e),this.pendingThemeData=void 0):this.pendingThemeData=e})),this.observe.watch(n.inject.ui.sidebarMode,(e=>{this.applyBounds()})),this.scale.on("resize",((e,t,i,s,n)=>{a.app.device.updateScreenSize(),this.applyBounds()})),this.events.on(Phaser.Scenes.Events.WAKE,(()=>{this.pendingThemeData&&(this.applyTheme(this.pendingThemeData),this.pendingThemeData=void 0),this.observe.wakeUp()})),this.events.on(Phaser.Scenes.Events.SLEEP,(()=>{})),this.events.on(Phaser.Scenes.Events.PAUSE,(()=>{this.domElements.forEach((e=>{e._suppress()}))})),this.events.on(Phaser.Scenes.Events.RESUME,(()=>{this.domElements.forEach((e=>{e._unsuppress()}))})),this.events.on(Phaser.Scenes.Events.START,(()=>{})),this.events.on(Phaser.Scenes.Events.SHUTDOWN,(()=>{})),this.events.on(Phaser.Scenes.Events.DESTROY,(()=>{})),this.events.on(Phaser.Scenes.Events.PRE_UPDATE,(()=>{this.preUpdate()}))}resize(e){}destroy(){this.observe.destroy()}applyConfig(e){this.tweens.timeScale=e.debug.tweenSpeedFactor||1,this.time.timeScale=e.debug.tweenSpeedFactor||1,this.anims.globalTimeScale=e.debug.tweenSpeedFactor||1}addAll(e){for(let t of e)this.add.existing(t)}addImage(e,t="atlas"){return this.add.image(0,0,t,e)}preUpdate(){}registerDOMElement(e){this.domElements.push(e)}bindKey(e,t){this.input.keyboard.addKey(e).on("down",(async()=>{if(this.input.activePointer.event?.ctrlKey||this.input.activePointer.event?.altKey)return;const e=await Promise.resolve(t());e&&s.events.trigger(e)}))}}t.BaseScene=c},20541:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SetDataSetMutationBuilder=t.SetDataSet=void 0;const s=i(20026),n=i(97849),o=i(88023);t.SetDataSet=class{constructor(e){this.key=e,this.defaultValue=(0,o.ImmutableSet)()}deserialize(e){return(0,o.ImmutableSet)(e)}serialize(e){return e.toArray()}apply(e,t){let i=e.get(this.key);return t.addedEntries&&(i=i.union(t.addedEntries)),t.deletedEntries&&(i=i.subtract(t.deletedEntries)),e.set(this.key,i)}getEntryById(e,t){return e.get(this.key).has(t)}getEntryIds(e){return[]}entryToString(e){return e.toString()}entryToDebugString(e){return e.toString()}createMutation(e,t){let i={};return e.add&&e.add.length&&(i.addedEntries=e.add),e.delete&&e.delete.length&&(i.deletedEntries=e.delete),{dataSet:this,changes:i,context:`${this.key}/${t}`}}toString(){return`[SetDataSet "${this.key}"]`}mergeMutations(e,t){const i={addedEntries:e.addedEntries?[...e.addedEntries]:[],deletedEntries:e.deletedEntries?[...e.deletedEntries]:[]};let s=t.deletedEntries,n=t.addedEntries;return i.addedEntries&&t.deletedEntries&&(s=s.filter((e=>!i.addedEntries.includes(e)&&!i.deletedEntries.includes(e))),i.addedEntries=i.addedEntries.filter((e=>!t.deletedEntries?.includes(e)))),i.deletedEntries&&t.addedEntries&&(n=n.filter((e=>!i.deletedEntries.includes(e)&&!i.addedEntries.includes(e))),i.deletedEntries=i.deletedEntries.filter((e=>!t.addedEntries?.includes(e)))),i.addedEntries.push(...n??[]),i.deletedEntries.push(...s??[]),i.addedEntries.length||delete i.addedEntries,i.deletedEntries.length||delete i.deletedEntries,i}},t.SetDataSetMutationBuilder=class{constructor(e){this.dataSet=e}init(e){this.state=e,this._itemsToDelete=new Set,this._itemsToAdd=new Set}add(...e){n.assert.defined(this.state,"builder not initialized!"),e.forEach((e=>{this._itemsToDelete.has(e)?this._itemsToDelete.delete(e):this._itemsToAdd.add(e)}))}delete(...e){n.assert.defined(this.state,"builder not initialized!"),e.forEach((e=>{this._itemsToAdd.has(e)?this._itemsToAdd.delete(e):this._itemsToDelete.add(e)}))}createMutation(e){const t=(0,s.selectFromState)(this.state,this.dataSet);return this.dataSet.createMutation({add:Array.from(this._itemsToAdd).filter((e=>!t.has(e))),delete:Array.from(this._itemsToDelete).filter((e=>t.has(e)))},e)}clear(){n.assert.defined(this.state,"builder not initialized!");const e=this.state.get(this.dataSet.key);this._itemsToDelete=e,this._itemsToAdd.clear()}}},20693:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexGroup=void 0;const n=s(i(95608)),o=i(1326),a=s(i(65731)),r=i(45664),l=i(97849),c=i(88424),d=i(56824),h=i(2543);class u{constructor(e={},t){this.membersByIndex=e,this._membersList=t}get length(){return this.members.length}get members(){return this._membersList||(this._membersList=Object.values(this.membersByIndex),Object.freeze(this._membersList)),this._membersList}first(){return this.members[0]}[Symbol.iterator](){return this.members[Symbol.iterator]()}static from(e){const t={};e instanceof Set&&(e=Array.from(e));const i=e.filter((e=>void 0!==e));for(let e of i)t[e.id]=e;return new u(t,i)}static fromIds(e){return u.from(e.map(r.getHex))}static union(e){const t=(0,o.stripDuplicatesFrom)((0,o.mergeArrays)(...e.map((e=>e.members))));return u.from(t)}getDisplayBoundingBox(){if(0===this.length)return{x:0,y:0,height:0,width:0};let e=Number.MAX_SAFE_INTEGER,t=Number.MAX_SAFE_INTEGER,i=-Number.MAX_SAFE_INTEGER,s=-Number.MAX_SAFE_INTEGER;for(let n of this)n.display.left<e&&(e=n.display.left),n.display.right>i&&(i=n.display.right),n.display.top<t&&(t=n.display.top),n.display.bottom>s&&(s=n.display.bottom);return{x:e,y:t,width:i-e,height:s-t}}getBoundingBox(){if(0===this.length)return null;let e=Number.MAX_SAFE_INTEGER,t=Number.MAX_SAFE_INTEGER,i=-Number.MAX_SAFE_INTEGER,s=-Number.MAX_SAFE_INTEGER;for(let n of this)n.x<e&&(e=n.x),n.x>i&&(i=n.x),n.y<t&&(t=n.y),n.y>s&&(s=n.y);return{x:e,y:t,width:i-e+1,height:s-t+1}}getHex(e){if(0===this.length)return;if(!e)return this.members[0];let t;switch(e){case c.HexFromGroupSelection.Leftmost:t=(e,t)=>t.x<e.x?t:e;break;case c.HexFromGroupSelection.Rightmost:t=(e,t)=>t.x>e.x?t:e;break;case c.HexFromGroupSelection.Topmost:t=(e,t)=>t.y<e.y?t:e;break;case c.HexFromGroupSelection.Bottommost:t=(e,t)=>t.y>e.y?t:e}return l.assert.defined(t),this.members.reduce(t)}toIdsArray(){return this.members.map((e=>e.id))}toArray(){return[...this.members]}has(e){return!!this.membersByIndex[e.id]}contains(e){return void 0!==e&&this.hasId(e.id)}hasId(e){return!!this.membersByIndex[e]}border(e=!0){return this.filter((t=>{const i=t.neighbours();return!!(e&&i.length<6)||!!i.find((e=>!this.has(e)))}))}borderIncludingShoreline(){return this.border(!0)}neighbours(){return u.union(this.map((e=>e.neighbours().filter((e=>!this.has(e))))))}neighboursOf(e){return e.neighbours((e=>this.has(e)))}components(e=()=>!0){let t=new n.default,i=1;const s=(t,i)=>!i||e(t,i);return this.forEach((e=>{t.getOwnerOf(e)||(t.addToGroup(i,e),t.addToGroup(i,...this.floodFillFrom(e,s)),++i)})),t}with(e){return Array.isArray(e)?u.from([...this.members,...e]):u.from([...this.members,...e.members])}without(e){const t={...this.membersByIndex};return e.forEach((e=>delete t[e.id])),new u(t)}filter(e){return u.from(this.members.filter(e))}forEach(e){return this.members.forEach(e)}map(e){return this.members.map(e)}find(e){return this.members.find(e)}sort(e=(e,t)=>e.id-t.id){return this.members.sort(e)}bfsFrom(e,t=()=>!0){let i=[];e.forEach((e=>i.push({hex:e,d:0})));let s=new Set(e);const n=({hex:e,d:n,parent:o})=>{s.add(e),t(e,o,n)&&e.neighbours().filter((e=>this.has(e)&&!s.has(e))).members.forEach((t=>{s.add(t),i.push({hex:t,d:n+1,parent:e})}))};for(;i.length>0;)n(i.shift())}floodFillOut(e=()=>!0){let t=[];this.forEach((e=>t.push({hex:e,d:0})));let i=new Set(this);for(;t.length>0;)s(t.shift());return u.from(Array.from(i));function s({hex:s,d:n,parent:o}){if(e(s,o,n)){i.add(s);const e=s.neighbours().filter((e=>!i.has(e))).members;for(let o of e)i.add(o),t.push({hex:o,d:n+1,parent:s})}}}customSearchFrom(e,t,i){let s=new a.default(((e,t)=>t.score-e.score));e.forEach((e=>s.push({hex:e,d:0,score:i(e)})));let n=new Set(e);const o=({hex:e,d:o,parent:a})=>{n.add(e),t(e,a,o)&&e.neighbours().filter((e=>this.has(e)&&!n.has(e))).members.forEach((t=>{n.add(t),s.push({hex:t,d:o+1,score:i(t),parent:e})}))};for(;s.size()>0;)o(s.pop())}findClosest(e,t){let i;return this.bfsFrom(e,(e=>!(i||t(e)&&(i=e,1)))),i}toString(){const e=this.members.slice(0,3).map((e=>e.toString())).join(",")+(this.length>3?",...":"");return`[HexGroup (${this.length}): ${e}]`}findInnerMostHex(){let e=this,t=this;for(;t.length>0;)e=t,t=t.without(t.border());return e.findMax((e=>e.neighbours((e=>this.has(e))).length))}findMax(e){return this.members.reduce(((t,i)=>{const s=e(i);return s>t.score?{score:s,hex:i}:t}),{hex:void 0,score:Number.MIN_SAFE_INTEGER}).hex}findGeometricMedian(){if(0===this.length)return;const e=this.members.reduce(((e,t)=>e+t.x),0),t=this.members.reduce(((e,t)=>e+t.y),0),i=(0,r.getHex)({x:(0,h.round)(e/this.length),y:(0,h.round)(t/this.length)});return(0,o.findMin)(this.members,(e=>e.getDistanceTo(i)))}floodFillFrom(e,t){const i=[...e.members];return this.bfsFrom(e,((e,s,n)=>!s||!!t(e,s,n)&&(i.push(e),!0))),u.from(i)}getCorners(){return(0,o.stripDuplicatesFrom)(this.members.map((e=>e.getCorners())).flat())}hasCorner(e){return!!e.sortedHexes.find((e=>this.has(e)))}disjointedNeighbourGroupsOf(e){return e.disjointedNeighbourGroups((e=>this.has(e)))}getRandomHex(e=d.random){if(this.length)return e.oneOf(this.members)}some(e){return this.members.some(e)}}t.HexGroup=u,u.empty=new u({})},20754:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LazyView=t.ViewCache=void 0;const s=i(56824),n=i(18957);s.logger.for("ViewCache");class o{constructor(e){this.parentDataSets=e,this.onFlushed=(0,n.signal)()}handleNewState(e,t=""){e!==this.lastState&&this.didParentDataSetsChangedInNewState(e,t)&&this.flush(),this.lastState=e}didParentDataSetsChangedInNewState(e,t){return this.parentDataSets.find((t=>e.get(t.key)!==this.lastState?.get(t.key)))}flush(){this.data={},this.onFlushed.fire()}set(e,t){this.data[e]=t}get(e){return this.data[e]}has(e){return this.data.hasOwnProperty(e)}getOrCalculate(e,t,i=""){return void 0===e?t():(this.has(e)||this.set(e,t()),this.get(e))}}t.ViewCache=o,t.LazyView=class{constructor(e){this.cache=new o(e)}get(e,t){this.cache.handleNewState(e,this.name);const i=this.getCacheKey(t)?.toString();return this.cache.getOrCalculate(i,(()=>this.calculate(e,t)),this.name)}onFlush(){}}},20938:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LargeRegionPanel=t.ExpandedState=void 0;const s=i(21941),n=i(23754),o=i(42067),a=i(15316),r=i(36868),l=i(7782),c=i(86545),d=i(91622),h=i(56824);var u,p=Phaser.GameObjects.Image;!function(e){e.Hidden="hidden",e.Collapsed="collapsed",e.Expanded="expanded",e.ShowBudget="show-budget"}(u||(t.ExpandedState=u={}));const g={[u.Expanded]:o.LARGE_PLAY_UI_LAYOUT.regionPanel.expandedOffsetFromBottom,[u.Collapsed]:o.LARGE_PLAY_UI_LAYOUT.regionPanel.collapsedOffsetFromBottom,[u.Hidden]:0};class m extends c.BaseResponsiveContainer{constructor(e){super(e),this.expandedState=u.Collapsed,this.browseRegionButtonsEnabled=!1,this.regionLabel=new n.LargeRegionLabel(this.scene,o.LARGE_PLAY_UI_LAYOUT.regionPanel.width,o.LARGE_PLAY_UI_LAYOUT.regionPanel.height),this.nextRegionButton=new y(this.scene,!1),this.prevRegionButton=new y(this.scene,!0),this.sizeController=l.Control.propOf(this,"y",{duration:o.LARGE_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.box=new s.Box(e,s.BoxTextures.RoundedPlate,0,0,o.LARGE_PLAY_UI_LAYOUT.regionPanel.width,o.LARGE_PLAY_UI_LAYOUT.regionPanel.height),this.add([this.nextRegionButton,this.prevRegionButton,this.box,this.regionLabel]),this.box.setInteractive(),this.box.input.cursor="default",this.nextRegionButton.onClicked((()=>h.events.trigger(r.UserActions.SelectNextRegion()))),this.prevRegionButton.onClicked((()=>h.events.trigger(r.UserActions.SelectPreviousRegion())))}updateState(e){if(e.layout)if("play"===e.layout.name&&e.layout.regionData?.controllable){this.expandedState!==u.ShowBudget||e.layout.showRegionBudget?e.layout.showRegionBudget&&this.expandedState!==u.ShowBudget&&h.events.trigger(r.UiEvents.RegionLedgerOpened()):h.events.trigger(r.UiEvents.RegionLedgerClosed());const t=e.layout.regionData;this.regionLabel.setRegionInfo(t),this.setBrowseRegionsButtonsEnabled(e.layout.enableNextRegion),this.regionLabel.setBuyingPawnInfo(e.layout.heldPawnData),e.layout.showRegionBudget?this.setExpandedState(u.ShowBudget):this.setExpandedState(u.Expanded)}else this.setExpandedState(u.Hidden),this.setBrowseRegionsButtonsEnabled(!1)}setExpandedState(e){let t;t=e===u.ShowBudget?this.scene.bounds.height-this.regionLabel.hideLedgerButton.y-this.regionLabel.hideLedgerButton.height-o.LARGE_PLAY_UI_LAYOUT.spectatorPanel.collapsedOffsetFromBottom:this.scene.bounds.height-g[e],this.sizeController.transitionTo(t),this.expandedState=e}setBrowseRegionsButtonsEnabled(e){this.browseRegionButtonsEnabled=e;const t=this.prevRegionButton.props.width,i=e?4-t:0,s=e?o.LARGE_PLAY_UI_LAYOUT.regionPanel.width-4:o.LARGE_PLAY_UI_LAYOUT.regionPanel.width-t;if(d.inject.ui.skipTransitions())return this.nextRegionButton.x=s,void(this.prevRegionButton.x=i);this.scene.tweens.add({targets:this.prevRegionButton,x:i,scale:1,ease:"Sine.easeOut",duration:o.LARGE_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.scene.tweens.add({targets:this.nextRegionButton,x:s,scale:1,ease:"Sine.easeOut",duration:o.LARGE_PLAY_UI_LAYOUT.panelTransitionsDuration})}updateLayout(){const e=this.scene.bounds.height;let t=0;switch(this.expandedState){case u.Hidden:t=e;break;case u.Collapsed:t=e-o.LARGE_PLAY_UI_LAYOUT.regionPanel.collapsedOffsetFromBottom;break;case u.Expanded:t=e-o.LARGE_PLAY_UI_LAYOUT.regionPanel.expandedOffsetFromBottom;break;case u.ShowBudget:t=e-this.regionLabel.hideLedgerButton.y-this.regionLabel.hideLedgerButton.height-o.LARGE_PLAY_UI_LAYOUT.spectatorPanel.collapsedOffsetFromBottom}d.inject.ui.withoutTransitions((()=>{this.setBrowseRegionsButtonsEnabled(this.browseRegionButtonsEnabled)})),this.setPosition(this.scene.bounds.width/2-o.LARGE_PLAY_UI_LAYOUT.regionPanel.width/2,t),this.sizeController.setTo(t)}}t.LargeRegionPanel=m;class y extends a.RibbonButton{constructor(e,t){super(e,0,o.LARGE_PLAY_UI_LAYOUT.regionPanel.nextRegionButtonOffsetFromTop,{audio:!1,type:a.RibbonButtonStyle.Medium,width:36,content:f(e,t),contentOffset:{y:-3}})}}function f(e,t){const i=new p(e,0,0,"atlas","ui/button-icons/play").setTint(3355443);return i.flipX=t,i}},21473:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReplayModel=void 0;const s=i(2543),n=i(85026);class o{static for(e){return new o(e)}constructor(e){this.data=e}get levelId(){return this.initialSnapshot.map.levelId}get meta(){return this.data.meta}get initialSnapshot(){const e=this.data.steps.find((e=>e.snapshot))?.snapshot;if(!e)throw new Error("No initial snapshot found in replay");return e}get finalSnapshot(){const e=(0,s.findLast)(this.data.steps,(e=>Boolean(e.snapshot)))?.snapshot;if(!e)throw new Error("No final snapshot found in replay");return e}get turnCount(){if(void 0!==this.data.meta.victoryTurn)return this.data.meta.victoryTurn;const e=(0,s.findLastIndex)(this.data.steps,(e=>!!e.snapshot))??0,t=this.data.steps[e]?.snapshot;return(t?.currentPhase.turnNumber??0)+this.data.steps.slice(e).filter(a).length}toFinalGameState(){return{...this.finalSnapshot,replay:this.data}}isBetterResultThen(e){const t=o.for(e);return this.meta.aiDifficulty!==t.meta.aiDifficulty?"hard"===this.meta.aiDifficulty:this.turnCount<t.turnCount}exportWithMetadata(e){return{outcome:e,data:(0,n.encodeReplay)(this.data),turns:this.turnCount,aiDifficulty:this.meta.aiDifficulty}}}function a(e){return e.tags?.includes("turnStart")&&0===e.faction}t.ReplayModel=o},21817:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.SideBarMode=void 0,function(e){e.Close="exit",e.Menu="menu",e.Settings="settings",e.BugReport="bug-report",e.Help="help"}(i||(t.SideBarMode=i={}))},21941:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Box=t.BoxTextures=void 0;var i=Phaser.GameObjects.NineSlice;function s(e,t){return{frame:e,bottomHeight:t/3,leftWidth:t/3,rightWidth:t/3,topHeight:t/3}}t.BoxTextures={Plate:s("ui/box/plate",48),RoundedPlate:s("ui/box/rounded-plate",48),InnerPlate:s("ui/box/inner-plate",30),WindowFrame:s("ui/box/window",48),Tooltip:s("ui/box/tooltip",12),RoundedRectArea:s("ui/box/rounded-rect-area",30),TutorialFrame:s("ui/box/tutorial-frame",24),FloatingCard:{frame:"glass-ui/floating-card-box",leftWidth:20,rightWidth:20,topHeight:24,bottomHeight:40},DetailWindow:{frame:"ui/box/floating-panel",leftWidth:32,rightWidth:32,topHeight:59,bottomHeight:38},GlassButton:{frame:"ui/box/glass-button",leftWidth:22,rightWidth:22,topHeight:22,bottomHeight:22},GlassButtonHover:{frame:"ui/box/glass-button-hover",leftWidth:22,rightWidth:22,topHeight:22,bottomHeight:22},GlassButtonSlim:{frame:"ui/box/glass-button-slim",leftWidth:22,rightWidth:22,topHeight:22,bottomHeight:22},GlassButtonSlimHover:{frame:"ui/box/glass-button-slim-hover",leftWidth:22,rightWidth:22,topHeight:22,bottomHeight:22},CorneredFrame:{frame:"ui/box/cornered-frame",leftWidth:22,rightWidth:22,topHeight:22,bottomHeight:22},DialogButton:s("ui/box/dialog-button",48),DialogButtonDown:s("ui/box/dialog-button-down",48)},t.Box=class extends i{constructor(e,t,i=0,s=0,n=0,o=0){super(e,0,0,"atlas",t.frame,n,o,t.leftWidth,t.rightWidth,t.topHeight,t.bottomHeight),this.setOrigin(0,0)}setFrameFrom(e){return this.setFrame(e.frame),this}}},22006:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.expeditionsTransitionIn=async function(){const e=n.config.screenTransitionDuration,t=s.app.scene.expeditions;let i=t.expeditionButtons.get();t.preUpdate.force(),t.disableLayoutUpdates=!0,await new Promise((s=>{const n=(t.bounds.height-i[0].y)/2;for(let e of i)e.y+=n,e.setAlpha(0);t.tweens.add({targets:i,y:`-=${n}`,alpha:{from:0,to:1},delay:t.tweens.stagger(50,{}),duration:e,ease:"Sine.easeOut",onComplete:()=>s()})})),t.disableLayoutUpdates=!1};const s=i(54825),n=i(56824)},22312:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaceUnitPlan=void 0;const s=i(91622),n=i(89764),o=i(8065),a=i(7334),r=i(76985);t.PlaceUnitPlan=class{constructor(e,t,i){this.hex=e,this.might=t,this.utilityFactors=i,this.endsTurn=!1,this.isConquest=!1,this.score=(0,o.aggregateScoreFactors)(i)}execute(e){const t=n.RegionAssets.fromMyRegion(e.region).useUnit({requiredMight:this.might,allowOverkill:!1,...(0,r.getMaxMightForHex)(e.state,this.hex)});return!!t&&e.marshal.moveUnit(this.hex,t)}hash(){return`Defend with ${s.inject.gameStateModel.rules.unitByMight(this.might)?.type} at #${this.hex.id}`}toString(){return`[${(0,a.formatNumber)(this.score)} | Defend with ${s.inject.gameStateModel.rules.unitByMight(this.might)?.type} at #${this.hex.id}]`}toDebugString(){return(0,o.describeScoreFactors)(this.utilityFactors)}}},22319:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InlineContentGallery=void 0;const s=i(86545),n=i(80959),o=i(1187),a=i(28952),r=i(91622),l=i(20087),c=i(60373),d=i(68785),h=i(36868),u=i(56824),p=i(76049),g={paddingX:20,cardWidth:{min:250,max:500},cardSpacing:12,cardHeight:110,spaceUnderHeader:12};class m extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.props=t,this.ui=n.UiBuilder.for(this.scene),this.cards=new o.GameObjectList(((e,t,i)=>(i?i.setProps({content:e,selected:!1,showFavoriteButton:!!this.props.showFavoriteButton}):(i=new a.IslandCard(this.scene,this.props.loadQueue,this.props.engine,{content:e,selected:!1,showFavoriteButton:!!this.props.showFavoriteButton}),this.add(i)),i))),this.headerText=this.ui.vectorText(t.headerText,p.VectorFont.Cinzel20,(e=>e.oceanContrastLight)),this.headerIcon=this.ui.image(t.headerIcon),this.props.showAddButton&&(this.addButton=new d.ButtonCard(e,{title:"+ CREATE NEW",onClicked:()=>{u.events.trigger(h.UserActions.OpenMapEditor({}))}}),this.add(this.addButton)),r.inject.theme.use((e=>{this.headerIcon.setTint(e.oceanContrastLight)})),this.updateContent(t.content),this.add([this.headerText,this.headerIcon])}updateContent(e){this.cards.set(e),this.preUpdate.makeDirty()}updateLayout(){l.Arrange.leftToRight({content:[this.headerIcon,this.headerText],x:0,spacing:8,origin:0}),l.Arrange.alignY({content:[this.headerIcon,this.headerText],y:this.headerText.height/2,origin:.5});const e=this.getGridItems(),t=(0,c.calculateGridLayout)({width:this.width,spacing:g.cardSpacing,itemWidth:g.cardWidth,itemCount:e.length});e.forEach((e=>e.setSize(t.itemWidth,g.cardHeight)));let i=this.headerText.y+this.headerText.height+g.spaceUnderHeader;for(let s=0;s<e.length;s+=t.itemsPerRow){const n=e.slice(s,s+t.itemsPerRow);l.Arrange.leftToRight({content:n,x:0,spacing:g.cardSpacing,origin:0}),l.Arrange.alignY({content:n,y:i,origin:0}),i+=n[0].height+g.cardSpacing}this.updateSize()}getGridItems(){let e=this.cards.get();return this.props.showAddButton&&(e=[this.addButton,...e]),e}calculateHeight(){const e=this.getGridItems(),t=e[e.length-1]??this.headerText;return t.y+t.height}}t.InlineContentGallery=m},22411:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildLandGenerationConfig=function(e){switch(s.random.reset(e.seed),e.shape){case n.MapShape.Temperate:return o(e);case n.MapShape.Marshlands:return a(e);case n.MapShape.Flat:return r(e)}},t.temperate=o,t.marshland=a,t.flat=r;const s=i(56824),n=i(85072);function o(e){const t={seed:e.seed,water:s.random.numberBetween(.2,.3),inlandForests:s.random.numberBetween(.2,.4),coastalForests:s.random.numberBetween(.01,.6),coastalForestsCohesion:s.random.numberBetween(.1,.3)};switch(e.size){case n.MapSize.Small:default:return{...t,width:10,height:s.random.integerBetween(16,18),smoothness:s.random.numberBetween(4,6)};case n.MapSize.Medium:return{...t,width:18,height:18,smoothness:s.random.numberBetween(5,7)};case n.MapSize.Large:return{...t,width:24,height:24,inlandForests:s.random.numberBetween(.3,.4),coastalForests:s.random.numberBetween(.1,.6),smoothness:s.random.numberBetween(6,8)}}}function a(e){const t={seed:e.seed,water:.25,inlandForests:0,smoothness:1,coastalForests:s.random.numberBetween(.2,.6),coastalForestsCohesion:s.random.numberBetween(.1,.3)};switch(e.size){case n.MapSize.Small:default:return{...t,smoothness:.5,coastalForests:.2,width:10,height:s.random.integerBetween(16,18)};case n.MapSize.Medium:return{...t,width:18,height:18};case n.MapSize.Large:return{...t,width:24,height:24}}}function r(e){const t={seed:e.seed,water:.1,inlandForests:0,smoothness:10,coastalForests:s.random.numberBetween(.4,.8),coastalForestsCohesion:0};switch(e.size){case n.MapSize.Small:default:return{...t,width:9,height:15};case n.MapSize.Medium:return{...t,width:16,height:16};case n.MapSize.Large:return{...t,width:22,height:22}}}},22640:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DialogButtonGroup=void 0;const s=i(76738),n=i(63032),o=i(56793),a=i(21941),r=i(76049),l=i(96137),c=i(86545),d=i(34043),h=16,u=4;class p extends c.AutoWidthResponsiveContainer{constructor(e,t){super(e),this.props=t,this.buttonRibbon=new s.Ribbon(this.scene,s.RibbonTextures.ButtonGroup),this.buttons=[],this.buttons=this.props.buttons.map((e=>this.createButton(e))),this.height=this.buttonRibbon.height,this.add([this.buttonRibbon,...this.buttons])}getButtonWidth(){return this.buttons[0].width||0}updateLayout(){const e=this.calculateWidth();this.buttonRibbon.width=e,(0,d.layoutFromLeftToRight)(h,u,4,this.buttons),this.updateSize()}calculateWidth(){return 2*h+this.getButtonWidth()*this.buttons.length+4*(this.buttons.length-1)}doCreateButton(e,t,i=l.Colors.woodenUi.primaryText,s){const n=new o.BoxButton_LEGACY(this.scene,0,0,{baseTexture:a.BoxTextures.DialogButton,downTexture:a.BoxTextures.DialogButtonDown,text:e,font:r.BitmapFont.Small,textColor:i,buttonTint:s,width:142,height:46});return n.onClicked(t),n}createButton(e){switch(e.role){case n.DialogButtonRole.Regular:return this.doCreateButton(e.text,(()=>this.props.onClicked(e.text)));case n.DialogButtonRole.PrimaryGreen:return this.doCreateButton(e.text,(()=>this.props.onClicked(e.text)),2376723,10026855);case n.DialogButtonRole.PrimaryDanger:return this.doCreateButton(e.text,(()=>this.props.onClicked(e.text)),4461331,16750968)}}}t.DialogButtonGroup=p},22663:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ButtonControllers=t.ButtonState=void 0;const s=i(88389),n=i(39970),o=i(63277),a=i(56824);var r;!function(e){e.Rest="rest",e.Hover="hover",e.Down="down",e.Disabled="disabled"}(r||(t.ButtonState=r={})),t.ButtonControllers={triggerEvent:e=>{const t=new s.SimpleButtonStateController({});return t.onClicked((()=>a.events.trigger(e()))),t},simple:(e={})=>new s.SimpleButtonStateController(e),passive:()=>new n.PassiveButtonStateController,options:(e,t)=>new o.OptionsGroupButtonController(e,t)}},22881:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeEndTurn=function(e){(0,a.assert)(e.currentPhase.type===o.PhaseTypes.FactionTurn,`Cannot end turn in phase ${e.currentPhase.type}`);const t=[],i=e.currentPhase.faction;a.assert.defined(i);const h=d.inject.ai.dataLayer.onTurnEnd(e,e.currentPhase.faction);return function(e){const t=e.currentPhase.getNextFaction();1!==t&&0!==e.currentPhase.faction?.id||e.currentPhase.incrementTurnNumber(),e.currentPhase.set({type:o.PhaseTypes.FactionTurn,faction:t})}(e),t.push(n.GameStateEvents.FactionTurnOver({state:e.state,factionId:i.id}),...h,function(e){const t=new l.WorldUpdateBuilder(e),i=e.state;return e.regions.all().filter((e=>!e.isAlive()&&!e.faction?.isNeutral())).forEach((i=>{i.getPawns().filter((e=>e.hasTrait(r.PawnTraits.Unit)&&!e.hasTrait(r.PawnTraits.Loyal))).forEach((i=>t.replace(i,e.rules.getBanditUnitType()))),i.getPawns().filter((e=>e.type===o.PawnType.Castle)).forEach((i=>{t.takeOverHex(i.hex,e.factions.neutral),t.replace(i,e.rules.getBanditCampUnitType())}))})),e.currentPhase.faction?.isAlive()&&function(e,t){const i=t.getLiveRegions().flatMap((e=>e.getPawns().filter((e=>e.type===o.PawnType.TownRuins))));for(const t of i)e.model.warfare.isOccupied(t.hex)||e.replace(t,o.PawnType.Town)}(t,e.currentPhase.faction),n.GameStateEvents.CutOffUnitsTurnedBandits({stateBefore:i,stateAfter:e.state,worldUpdates:t.getUpdates()})}(e),...(0,c.checkWinLoseConditions)(e,[]),...(0,s.startPhase)(e),n.GameStateEvents.FactionTurnStarted({state:e.state,factionId:e.currentPhase.faction.id})),t};const s=i(33613),n=i(36868),o=i(24598),a=i(97849),r=i(63521),l=i(78933),c=i(46471),d=i(91622)},22913:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScalingPOC=t.TestScene=void 0;const s=i(27126),n=i(36868),o=i(19048),a=i(81700),r=i(30948),l=i(897),c=i(91622),d=i(54825),h=i(56824);class u extends r.BaseUIScene{constructor(){super({key:"testScene"}),this.preUpdate=(0,l.whenDirty)((()=>{this.contentAreaRectangle.setOrigin(0,0).setPosition(this.bounds.contentLeft,0).setSize(this.bounds.contentWidth,this.bounds.height);const e=this.cameras.main;c.inject.debugData.set("game.device",`\n  screenWidth/Height=${d.app.device.screenHeight}x${d.app.device.screenWidth}\nBaseUiScene.bounds:\n  width/height=${this.bounds.width}x${this.bounds.height}\n  center=${this.bounds.centerX},${this.bounds.centerY}\n  contentArea=${this.bounds.contentLeft}-${this.bounds.contentRight} (width ${this.bounds.contentWidth})\nCamera:\n zoom=${e.zoom}\n x,y=${e.x},${e.y}\n size=${e.width}x${e.height}\n worldView=from ${e.worldView.x},${e.worldView.y} size ${e.worldView.width}x${e.worldView.height}\n`)}))}create(){super.create(),this.contentAreaRectangle=this.add.rectangle().setStrokeStyle(4,65280)}}t.TestScene=u,t.ScalingPOC=class{constructor(){this.initialized=!1}getScenes(){return[s.PreloadScene,u,o.DebugScene]}run(){h.events.on(n.SystemEvents.EngineInitialized,(()=>{d.app.game.scene.run(a.Scenes.Debug),d.app.game.scene.run("testScene"),c.inject.debugData.set("---------------","")})),this.initialized=!0}}},22973:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fortification=void 0;const s=i(78635),n=i(56038),o=i(45664),a=i(81434),r=i(63521),l=i(9292);t.Fortification={get:(e,t)=>s.Warfare.getHexStaticDefense(e,t)/2,getDeltaAfterConquest(e,t,i){const a=(0,o.getHex)(t).neighbours((t=>n.Regions.getByHex(e,t.id)===i));let r=0;for(let t of a){const i=s.Warfare.getHexProjectedStaticDefense(e,t.id);r=(0,l.pickLarger)(r,i)}return r},getDeltaAfterCastleBuilt(e,i){const s=n.Regions.getByHex(e,i),l=(0,o.getHex)(i),c=l.with(l.neighbours((t=>n.Regions.getByHex(e,t.id)===s&&!a.Pawns.isTraitPresentOnHex(e,t.id,r.PawnTraits.PreventsWalls))));let d=0;for(let i of c)d+=1-t.Fortification.get(e,i.id);return d}}},23202:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugHistoryScene=void 0;const s=i(4440),n=i(81700),o=i(76049),a=i(91622),r=i(54825),l=i(71021),c=i(30484);class d extends s.Scene{constructor(){super({key:n.Scenes.DebugHistory,pixelArt:!1}),this.currentIndex=0}create(){this.controller=a.inject.gameStateController,this.historyLabel=new o.DebugTextBox(this,10,40,"Frames:",{dropShadow:!1,origin:[0,1]});const e=this.input.keyboard.addKey(s.Input.Keyboard.KeyCodes.ESC),t=this.input.keyboard.createCursorKeys();e.on("down",(e=>{r.app.navigator.goTo(r.app.screen.play,l.NewGameStateContext.ResumingGame)})),t.down.on("down",(e=>{this.goToNextFrame()})),t.up.on("down",(()=>{this.goToPreviousFrame()}))}goToNextFrame(){this.currentIndex!==a.inject.history.length()&&(this.currentIndex++,this.currentIndex===a.inject.history.length()?this.loadState(this.suspendedCurrentState):this.loadState(a.inject.history.get(this.currentIndex).state))}goToPreviousFrame(){0!==this.currentIndex&&(this.currentIndex===a.inject.history.length()&&(this.suspendedCurrentState=a.inject.gameStateModel.state),this.currentIndex--,this.loadState(a.inject.history.get(this.currentIndex).state))}loadState(e){a.inject.gameStateModel.restore(e),r.app.scene.worldMap.syncState(e,c.OverlayModes.disabled)}resetCursor(){this.currentIndex=a.inject.history.length()}update(){const e=[...a.inject.history.getAll(),{label:"(CURRENT STATE)",state:a.inject.gameStateModel.state}];this.currentIndex>e.length&&(this.currentIndex=e.length-1);const t=e.map(((e,t)=>(this.currentIndex===t?"->":"  ")+e.label)).join("\n");this.historyLabel.setText(t),this.historyLabel.setPosition(10,this.cameras.main.displayHeight-10)}}t.DebugHistoryScene=d},23382:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.THEMES=t.OCEAN_COLOR_PRESETS=t.DEFAULT_OCEAN_COLOR=void 0,t.DEFAULT_OCEAN_COLOR="astral",t.OCEAN_COLOR_PRESETS={gentle:5801886,legacy:10213106,night:3487290,"deep sea":3557460,acapulco:8171681,blueprint:3308960,allports:30371,"algae green":9691064,amazon:3897943,"deep green":2176564,aquamarine:8388564,"aquamarine blue":7461346,atoll:683893,ash:13026229,"atomic tangerine":16750950,astral:3308960,azure:37098,axolotl:5137993,bahia:10865420,"baltic sea":2762288,biscay:1782114,"bay of many":2570881,bermuda:8247494,"bay leaf":8235405,opal:11126466,pacific:40388,carribean:50349,"royal blue":89733,oracle:3634293,olivine:10140019,oxley:7839366,pelorous:4107199,bluewood:3228761,pistachio:10338825,"polo blue":9283788,plum:8663417,watercourse:356183,aqualand:424126},t.THEMES={default:{title:"Default",factionColors:[1074688,14197587,7319091,14316883,8938311,5528674],oceanColor:t.OCEAN_COLOR_PRESETS.blueprint},muted:{title:"Muted",factionColors:[3891771,11639421,6389837,12223857,7430488,5522773],oceanColor:t.OCEAN_COLOR_PRESETS["deep sea"],forestsTexture:"iso-tiles/forest-gloomy"},grounded:{title:"Grounded",factionColors:[29184,5939244,9019436,8421376,7101779,5066061],oceanColor:t.OCEAN_COLOR_PRESETS.gentle},highContrast:{title:"High Contrast",factionColors:[13385760,28876,29184,14532608,12303291,13582480],oceanColor:t.OCEAN_COLOR_PRESETS.night},inferno:{title:"Inferno",factionColors:[16176709,16287757,14109503,10168676,5968238,1510458],oceanColor:t.OCEAN_COLOR_PRESETS.gentle},christmas:{title:"Christmas",factionColors:[24832,10645803,3633232,11742766,13227228,2960685],oceanColor:7580365}}},23449:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tile=void 0;var s=Phaser.GameObjects.Container;const n=i(87936),o=i(79573),a=i(63617);function r(e){let t="(unknown)";return t=e instanceof s?e.constructor.name:e.frame.name,`\n- ${t}(#${(0,a.getObjId)(e)} V:${e.visible?1:0} A:${e.alpha.toFixed(1)} D:${e.depth.toFixed()})`}i(56824).logger.for("Tile"),t.Tile=class{constructor(e,t,i=0){this.renderer=e,this.hex=t,this.frame=i,this.attachedObjects=new Set,this.decals=new Set,this.active=!0}get baseDepth(){return o.WorldLayers.Tiles+this.bottom}get bottom(){return this.hex.y*n.HEX_INNER_HEIGHT+n.HEX_HEIGHT}get centerX(){return(this.hex.x+.5)*n.HEX_WIDTH}get centerY(){return this.hex.y*n.HEX_INNER_HEIGHT+.5*n.HEX_HEIGHT}addObject(e,t,i,s=0){this.attachedObjects.add(e),this.renderer.add(this.hex,e),e.setPosition(this.centerX+t,this.centerY+i).setDepth(o.WorldLayers.TileObjects+this.bottom-n.HEX_HEIGHT/2+i+s)}addDecal(e,t,i){e.setOrigin(.5,.5),this.decals.add(e),this.renderer.add(this.hex,e).setDepth(o.WorldLayers.TileDecals),e.setPosition(this.centerX+t,this.centerY+i)}removeObject(e){this.attachedObjects.delete(e),this.renderer.remove(this.hex,e)}activate(e){this.active||[...this.decals,...this.attachedObjects].forEach((e=>this.renderer.add(this.hex,e))),this.active=!0,e.isNeutral()?this.decals.forEach((e=>e.setVisible(!1))):this.decals.forEach((t=>{t.setVisible(!0),t.setTint(e.landColor)}))}deactivate(){this.active=!1,[...this.decals,...this.attachedObjects].forEach((e=>{this.renderer.remove(this.hex,e),e.setVisible(!1)}))}toString(){return`[Tile #${this.hex.id}]`}getDebugData(){return`[Tile #${this.hex.id}]\nactive: ${this.active}\nattachedObjects:${Array.from(this.attachedObjects).map(r).join("")}\ndecals:${Array.from(this.decals).map(r)}\n`}}},23618:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DistanceMap=void 0;const s=i(65415),n=i(97849);class o extends s.CustomHexGroupValuation{constructor(e){super(1/0),this.hexes=e}addSources(e){(0,n.assert)(e.members.every((e=>{const t=this.hexes.has(e);return t||console.error(`hex ${e} not found in the hexes group`),t})),`Some source hexes (${e.toIdsArray()}) are not in the hexes group (${this.hexes.toIdsArray()})`),this.hexes.bfsFrom(e,((e,t,i)=>(this.get(e.id)>i||0===i)&&(this.set(e.id,i),!0)))}getDistanceTo(e){return this.get(e.id)}getMostDistantHex(){return this.hexes.findMax((e=>this.getDistanceTo(e)))}dump(){return this.hexes.map((e=>`${e} = ${this.getDistanceTo(e)}`)).join("\n")}}t.DistanceMap=o},23636:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DropdownUIScene=t.DropdownBoundsProvider=void 0;const s=i(30948),n=i(81700),o=i(93868),a=i(91622),r=i(897),l=i(12605),c=i(54825),d=i(7782),h=i(2426),u=i(9292);i(56824).logger.for("dropdowns");class p extends o.BaseBoundsProvider{constructor(){super(...arguments),this.width=0,this.height=0,this._x=0,this._y=0}get x(){return this._x}get y(){return this._y}setPosition(e,t){this._x=e,this._y=t}setSize(e,t){this.width=e,this.height=t}}t.DropdownBoundsProvider=p;class g extends s.BaseUIScene{constructor(){super({key:n.Scenes.DropdownUI,bounds:new p}),this.dropdownComponent=void 0,this.preUpdate=(0,r.whenDirty)((()=>{this.backgroundRect.setPosition(0,-1),this.backgroundRect.setSize(this.bounds.width,this.bounds.height+1),this.hasScrollbar()?this.backgroundRect.radius=0:this.backgroundRect.radius={tl:0,tr:0,bl:8,br:8}}))}get contentHeight(){return this.sceneHeight.isInTransition()?0:(this.dropdownComponent?.height??0)+8}create(){super.create(),this.scrollController=(0,l.makeSceneScrollable)(this,{allowanceAfterLastStop:0,scrollbar:!0}),this.sceneHeight=new d.TransitionController(this,{initialValue:0,applyValue:e=>{this.bounds.setSize((this.dropdownComponent?.width??0)+2,e),this.applyBounds(),this.preUpdate.makeDirty()},duration:120}),this.backgroundRect=new h.RoundedRect(this,{radius:{tl:0,tr:0,bl:8,br:8}}).setScrollFactor(0),this.addAll([this.backgroundRect]),a.inject.theme.use((e=>{this.backgroundRect.setFillStyle(e.oceanShades.dark5,1),this.backgroundRect.setLineStyle(e.white,1,.5)}))}hasScrollbar(){return this.contentHeight>this.bounds.height}setDropdown(e,t,i){if(this.dropdownComponent===e)return;this.closeDropdown(),this.dropdownComponent=e,this.dropdownComponent.setPosition(1,0);const s=t();this.bounds.setPosition(s.x,s.y+s.height),this.sceneHeight.setTo(1,"instant"),this.scrollController.cameraY.setTo(0),this.add.existing(this.dropdownComponent);const n=c.app.device.screenHeight-this.bounds.y;this.sceneHeight.transitionTo((0,u.pickSmaller)(this.dropdownComponent.height+8,n)),this.scene.setVisible(!0),i&&(this.onDismissedCallback=i)}closeDropdown(e=!0){this.dropdownComponent&&this.dropdownComponent.destroy(),this.onDismissedCallback&&(e&&this.onDismissedCallback(),this.onDismissedCallback=void 0),this.scene.setVisible(!1)}}t.DropdownUIScene=g},23754:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HideLedgerButton=t.ExpandCollapsedClickZone=t.RegionLabelText=t.LargeRegionLabel=void 0,t.getBudgetIcon=I;var s=Phaser.GameObjects.Image,n=Phaser.GameObjects.BitmapText;const o=i(76049),a=i(7334),r=i(7782),l=i(24598),c=i(9292),d=i(20087),h=i(86545),u=i(21941),p=i(36868),g=i(54825),m=i(98963),y=i(86306),f=i(85647),w=i(96137),v=i(56824),b=i(91622),S=i(79611),x=30;class T extends Phaser.GameObjects.Container{constructor(e,t,i){super(e),this.width=t,this.height=i,this.regionInfo={buyablePawns:[],controllable:!1,name:"",treasury:0,income:0,id:-1,townLevel:1},this.treasuryTextController=new r.TransitionController(this.scene,{duration:400,initialValue:0,applyValue:e=>{this.treasuryText.setText(e.toFixed(0)),this.updateNumbersLayout()}}),this.incomeTextController=new r.TransitionController(this.scene,{duration:400,initialValue:0,applyValue:e=>{this.incomeText.setText((0,a.withSign)(Math.trunc(e))),this.updateTrendIcon(e),this.updateNumbersLayout()}}),this.ledger=new y.RegionLedger(this.scene),this.hideLedgerButton=new M(this.scene),this.line1center=38,this.line2center=this.line1center-24,this.expandClickZone=new C(this.scene);const n=this.width,l=this.line1center,c=this.line2center;this.expandClickZone.setPosition(18,18),this.expandClickZone.setSize(n-36,l),this.expandClickZone.updateLayout(),this.regionIcon=new s(e,40,l,"atlas","pawns/town-1").setScale(.5,.5).setOrigin(.5,.5),this.regionNameText=new P(e,66,l,"Kingdom"),this.treasuryText=new P(e,0,0,"0").setOrigin(0,0),this.treasuryIcon=new s(e,0,0,"atlas","ui/budget-icons/treasury").setOrigin(0,0),this.incomeText=new P(e,0,0,"+8").setOrigin(0,0).setTint(7954256),this.trendIcon=new s(e,0,0,"atlas","ui/budget-icons/surplus").setOrigin(0,0),this.selectedPawnArrow=new s(e,78,c+5,"atlas","ui/arrow-icon"),this.selectedPawnArrow.flipY=!0,this.selectedPawnText=new P(e,90,c,"",o.BitmapFont.Mini),this.selectedPawnCostText=new P(e,this.treasuryText.x,c,"",o.BitmapFont.Mini).setOrigin(1,.5),this.selectedPawnUpkeepText=new P(e,this.incomeText.x,c,"",o.BitmapFont.Mini).setOrigin(1,.5),this.ledger.setPosition(0,this.expandClickZone.y+this.expandClickZone.height+12),this.hideLedgerButton.setSize(this.width-10,32),this.add([this.expandClickZone,this.regionIcon,this.regionNameText,this.treasuryText,this.treasuryIcon,this.incomeText,this.trendIcon,this.selectedPawnText,this.selectedPawnCostText,this.selectedPawnArrow,this.selectedPawnUpkeepText,this.ledger,this.hideLedgerButton])}setRegionInfo(e){this.regionNameText.setText(e.name),this.regionInfo.id===e.id?(this.treasuryTextController.transitionTo(e.treasury),this.incomeTextController.transitionTo(e.income)):(this.treasuryTextController.setTo(e.treasury),this.incomeTextController.setTo(e.income)),this.regionInfo=e,this.regionIcon.setFrame((0,S.getPawnRenderRecipe)(l.PawnType.Town).getFrame((0,c.cropNumber)(e.townLevel,1,4))).setOrigin(.5,.5),this.ledger.updateState({entries:b.inject.views.regionLedger.get(b.inject.currentGameState,e.id)}),this.ledger.updateLayout(),this.hideLedgerButton.setPosition(5,this.ledger.y+this.ledger.height+3),this.hideLedgerButton.updateLayout()}updateNumbersLayout(){d.Arrange.leftToRight({content:[this.treasuryIcon,this.treasuryText,this.incomeText,this.trendIcon],spacing:8,x:this.width-x,origin:1}),d.Arrange.alignY({content:[this.treasuryIcon,this.treasuryText,this.incomeText,this.trendIcon],y:this.line1center,origin:.5}),this.selectedPawnCostText.x=this.treasuryText.x+this.treasuryText.width,this.selectedPawnUpkeepText.x=this.incomeText.x+this.incomeText.width,this.ledger.setLayout([5,this.regionNameText.x,this.incomeText.x+this.incomeText.width,this.width-5])}updateTrendIcon(e){this.trendIcon.setFrame(I(e)).setOrigin(0,0)}setBuyingPawnInfo(e){if("buying"===e?.context){const{name:t,cost:i,upkeep:s}=e;this.selectedPawnText.setText(t),this.selectedPawnCostText.setText("-"+i.toString()),this.selectedPawnUpkeepText.setText("-"+s.toString()),[this.selectedPawnArrow,this.selectedPawnText,this.selectedPawnCostText].forEach((e=>e.setVisible(!0))),this.selectedPawnUpkeepText.setVisible(!!s),this.treasuryTextController.transitionTo(this.regionInfo.treasury-i),this.incomeTextController.transitionTo(this.regionInfo.income-s),this.goToVerticalOffset(8)}else this.clearSelectedPawnData(),this.treasuryTextController.transitionTo(this.regionInfo.treasury),this.incomeTextController.transitionTo(this.regionInfo.income),this.goToVerticalOffset(0)}clearSelectedPawnData(){[this.selectedPawnArrow,this.selectedPawnText,this.selectedPawnCostText,this.selectedPawnUpkeepText].forEach((e=>e.setVisible(!1)))}goToVerticalOffset(e){this.scene.tweens.add({targets:this,y:e,scale:1,ease:"Sine.easeOut",duration:200})}}t.LargeRegionLabel=T;class P extends n{constructor(e,t,i,s,n=o.BitmapFont.Main){super(e,t,i,n,s),this.setTint(5583648),this.setOrigin(0,.5)}}function I(e){return 0===e?"ui/budget-icons/neutral":e>0?"ui/budget-icons/surplus":"ui/budget-icons/deficit"}t.RegionLabelText=P;class C extends h.ResponsiveContainer{constructor(e){super(e),this.box=new u.Box(this.scene,u.BoxTextures.RoundedRectArea).setAlpha(.01).setTint(w.Colors.woodenUi.darkerPergamen),this.visibility=r.Control.propOf(this.box,"alpha"),this.box.setInteractive({useHandCursor:!0}),this.box.setData("tooltip","Inspect province income and expenses"),this.box.on("pointerdown",(()=>{g.app.audio.playEffect(m.SoundEffects.ButtonDown),v.events.trigger(p.UserActions.ToggleLedger())})),this.box.on("pointerover",(()=>{this.visibility.setTo(1)})),this.box.on("pointerout",(()=>{this.visibility.setTo(.01)})),this.add([this.box]),this.updateLayout()}updateLayout(){this.box.setSize(this.width,this.height)}}t.ExpandCollapsedClickZone=C;class M extends h.BaseResponsiveContainer{constructor(e){super(e),this.area=new f.ClickableArea(this.scene,{audio:!0,color:w.Colors.woodenUi.darkerPergamen}),this.chevron=new s(this.scene,0,0,"atlas","ui/icons/chevron-down").setTint(w.Colors.woodenUi.primaryText),this.area.onClicked((()=>{v.events.trigger(p.UserActions.ToggleLedger())})),this.add([this.area,this.chevron])}updateLayout(){this.area.setSize(this.width,this.height),this.area.updateLayout(),this.chevron.setPosition(this.width/2,this.height/2).setOrigin(.5,.5)}}t.HideLedgerButton=M},23867:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionInfluenceByRegionView=t.PowerMeasurement=void 0;const s=i(90952),n=i(20026),o=i(19618),a=i(20754),r=i(76439),l=i(78436),c=i(56038);var d;!function(e){e.MilitaryMight="might",e.RegionSize="size"}(d||(t.PowerMeasurement=d={}));class h extends a.LazyView{constructor(){super([s.GameState.ai.regionInfluenceByRegion,s.GameState.factions.byRegion,s.GameState.ai.assetsValueByRegion]),this.name="factionInfluenceByRegion"}calculate(e,t){const i=this.getComponents(e,t);return{total:i.reduce(((e,t)=>e+t.influence),0),proximity:i.reduce(((e,t)=>Math.min(e,t.proximity)),1/0)}}getComponents(e,{influencingFaction:t,targetRegion:i,maxDistance:a,powerMeasurement:r}){const l=(0,n.selectFromState)(e,s.GameState.ai.regionInfluenceByRegion,i);return l?l.entrySeq().filter((([i,s])=>o.Factions.getByRegion(e,i)===t&&s.proximity<=a)).map((([t,i])=>({regionId:t,influence:i.total*this.getRegionReach(e,t,r),proximity:i.proximity}))).filter((({influence:e})=>e>0)).toArray():[]}getRegionReach(e,t,i){switch(i){case d.MilitaryMight:return c.Regions.model(e).byId(t).getMyAssets().getTotalAvailableMight();case d.RegionSize:return c.Regions.getRegionHexes(e,t).size}}getCacheKey({influencingFaction:e,targetRegion:t,maxDistance:i,powerMeasurement:s}){return`${e}.${t}.${i}.${s}`}getDebugLayer(e,t,i=99){return new r.GameStateDebugLayer((0,l.regionBasedAdapter)({getValue:(s,n)=>{const o=this.get(s,{influencingFaction:e,targetRegion:n,maxDistance:i,powerMeasurement:t});return`${o.total}\n(${o.proximity})`},getDetail:(s,n)=>this.getComponents(s,{influencingFaction:e,targetRegion:n,maxDistance:i,powerMeasurement:t}).map((e=>`${e.influence} from region ${e.regionId} (proximity ${e.proximity})`)).join("\n")}))}}t.FactionInfluenceByRegionView=h},24040:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DetailItem=t.DetailsPanel=void 0;const s=i(86545),n=i(80959),o=i(55275),a=i(1187),r=i(20087),l=i(91622),c=i(56824),d=i(36868),h=i(9292);class u extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.levelDescription=this.ui.richText("?",0),this.items=new a.GameObjectList(((e,t,i)=>(i||((i=new p(this.scene)).text.setTint(l.inject.theme.getCurrent().oceanContrastLight),this.add(i)),i.props.update(e),i))),this.props=(0,o.stateContainer)({levelDescription:"",items:[]},((e,t)=>{this.levelDescription.setText(`[i]${t.levelDescription}[/i]`),this.items.set(t.items),this.updateLayout()})),l.inject.theme.use((e=>{this.levelDescription.setTint(e.oceanContrastLight),this.items.get().forEach((t=>{t.text.setTint(e.oceanContrastLight)}))})),this.add([this.levelDescription])}updateLayout(){this.levelDescription.setVisible(Boolean(this.levelDescription.text)),this.levelDescription.setWordWrapWidth(this.width),r.Arrange.topToBottom({content:[this.levelDescription,...this.items.get()],y:0,spacing:16}),r.Arrange.alignX({content:[this.levelDescription,...this.items.get()],x:0,origin:0,width:this.width}),this.updateSize()}calculateHeight(){const e=this.items.length?this.items.get()[this.items.length-1]:this.levelDescription;return e.y+e.height}}t.DetailsPanel=u;class p extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.icon=this.ui.image(""),this.text=this.ui.vectorText("?"),this.helpIcon=this.ui.helpIcon({onClicked:()=>{const e=this.props().helpDocument;e&&c.events.trigger(d.UserActions.ShowHelp(e))},tooltip:"Click for more information"}),this.props=(0,o.stateContainer)({text:"",icon:""},((e,{icon:t,text:i,helpDocument:s})=>{this.icon.setFrame(t??""),this.text.setText(i),this.helpIcon.setVisible(Boolean(s)),this.updateLayout()})),this.add([this.icon,this.text,this.helpIcon])}updateLayout(){this.icon.setOrigin(.5,.5),this.text.setOrigin(0,.5),this.text.setWordWrapWidth((0,h.pickLarger)(100,this.width-this.text.x),!0),this.icon.setPosition(16,this.text.height/2),this.text.setPosition(32,this.text.height/2),this.helpIcon.setPosition(this.text.x+this.text.width+6,this.text.height/2-this.helpIcon.height/2),this.updateSize()}calculateHeight(){return this.text.height}}t.DetailItem=p},24239:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConquerableHexesView=void 0;const s=i(20754),n=i(78635),o=i(90952);class a extends s.LazyView{constructor(){super([o.GameState.warfare.hexDefense,o.GameState.regions.byHex,o.GameState.pawns.byHex,o.GameState.factions.byRegion]),this.name="conquerableHexes"}calculate(e,t){return n.Warfare.getConquerableHexes(e,t.regionId,t.unitMight,t.unitMightWithoutHeavyUnits)}getCacheKey(e){return`${e.regionId}/${e.unitMight}/${e.unitMightWithoutHeavyUnits}`}}t.ConquerableHexesView=a},24307:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexRegionInfluenceUpdater=t.InfluenceSpreadHeap=t.RegionInfluenceByHexProjection=void 0,t.createHexInfluenceDebugLayer=function(e){return new p.GameStateDebugLayer((0,g.dataSetAdapter)(u.GameState.ai.regionInfluenceByHex,{getValue:t=>t.get(e)?.cost?.toString(),arrowDataRetriever:(t,i)=>(0,r.selectFromState)(t,u.GameState.ai.regionInfluenceByHex,i)?.get(e)}))},t.defenseToResistance=M;const n=i(31011),o=s(i(65731)),a=i(56038),r=i(20026),l=i(4005),c=i(56824),d=i(19618),h=i(45664),u=i(90952),p=i(76439),g=i(97377),m=i(67274),y=i(35444),f=i(91622),w=i(76985),v=i(39838),b=i(9292),S=i(88023),x=c.logger.for("RegionInfluenceByHexProjection");function T(e){if(!e)return 0;let t=(0,b.pickLarger)(e.size,2*e.getEnemyAssets().getObtainableUnitCount());switch(t){case 0:case 1:return 0;case 2:case 3:return 2;case 4:case 5:return 3;case 6:case 7:case 8:case 9:return 5;default:return 5*Math.ceil(t/10)}}class P extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new C(this),this.update=this.updater.update}bootstrap(e){return this.updater.initFromState(e),a.Regions.getAll(e).forEach((t=>{a.Regions.getRegionHexes(e,t).size>=1&&this.updater.addSourcesFromRegion(t)})),this.updater.getMap()}entryToString(e){return e.size?`[${e.size}]`:""}entryToDebugString(e){return e.entrySeq().sort(((e,t)=>e[0]-t[0])).map((([e,t])=>`from ${(0,v.getGlyphForRegionId)(e)}${e} dist ${t.distance} resist ${t.resistance} cost ${t.cost} def ${t.hexDefense} (parent ${t.parent?.id} children ${t.children.toArray().map((e=>e.id)).join(",")} range ${T(f.inject.gameStateModel.regions.byId(e))})`)).join("\n")}}t.RegionInfluenceByHexProjection=P;class I extends o.default{constructor(){super(((e,t)=>e.cost===t.cost?t.sim.latestBreachedDefense-e.sim.latestBreachedDefense:e.cost-t.cost))}}t.InfluenceSpreadHeap=I;class C extends l.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet),this.invalidation=new Map}createMutation(){return this.updateInvalidated(),super.createMutation()}addSourcesFromRegion(e){const t=a.Regions.getRegionBorderHexes(this.newState,e);for(const i of t)this.addRoot(e,y.ConquestSim.fromState(this.newState),(0,h.getHex)(i))}updateInvalidated(){for(const e of this.invalidation.keys())this.updateInvalidatedForRegion(e)}updateInvalidatedForRegion(e){const{roots:t,dirtyHexes:i}=this.getOrCreateInvalidationData(e),s=T(a.Regions.model(this.newState).byId(e));this.updateInfluenceRange(e,s);const n=d.Factions.getByRegion(this.newState,e);if(void 0===n)return x.warning(`[R${e}] ignoring request to generate influence, it has no faction assigned`),void this.invalidation.delete(e);const o=new Set;for(const i of t.toArray())0===i.resistance&&this.updateInfluence(e,i.hex,null,0,0,0,0);for(const t of i)t.neighbours((e=>!i.has(e))).forEach((t=>{const i=this.builder.getCurrent(t.id)?.get(e);void 0!==i?.resistance&&this.addRoot(e,y.ConquestSim.fromState(this.newState).conquerHex(t),t,i.resistance,i.distance,i.cost)}));for(;!t.empty();){const{hex:i,resistance:r,distance:l,sim:c,cost:d}=t.pop();o.add(i);const h=this.builder.getCurrent(i.id)?.get(e);if(!h)continue;const u=i.neighbours((t=>{if(o.has(t))return!1;const i=a.Regions.getByHex(this.newState,t.id);return void 0!==i&&i!==e}));for(let a of u){const h=this.getHexDefense(c,n,a),u=this.getInfluenceSpreadResistance(c,n,a),p=d+(0,w.mightToUpkeep)(h+1),g=r+u,m=this.builder.getCurrent(a.id)?.get(e)?.resistance??1/0;g<=s&&g<m&&(this.updateInfluence(e,a,i,g,l+1,p,h),o.add(a),t.push({sim:c.conquerHex(a),hex:a,resistance:g,distance:l+1,cost:p}))}}this.invalidation.delete(e)}getMap(){return this.updateInvalidated(),(0,S.ImmutableMap)(this.builder.getEntries()).mapKeys((e=>Number(e)))}registerHandlers(e){e(this.dataSet.sources.borderHexes,this.handleRegionBorderChange),e(this.dataSet.sources.regionsByHex,this.handleHexRegionChanged),e(this.dataSet.sources.hexDefense,this.handleHexDefenseChanged)}handleRegionBorderChange(e){for(let t of e.updated||[]){const e=t.id;for(let i of t.added||[])this.addRoot(e,y.ConquestSim.fromState(this.newState),(0,h.getHex)(i));for(let i of t.removed||[])this.invalidateSource(e,(0,h.getHex)(i))}}invalidateSource(e,t){a.Regions.getByHex(this.newState,t.id)!==e&&this.markDirty(e,t);const i=this.builder.getCurrent(t.id)?.get(e);if(i){this.removeInfluence(t,e);for(const t of i.children)this.invalidateSource(e,t)}}getOrCreateInvalidationData(e){let t=this.invalidation.get(e);return t||(t={dirtyHexes:new Set,roots:new I},this.invalidation.set(e,t)),t}addRoot(e,t,i,s=0,n=0,o=0){this.getOrCreateInvalidationData(e).roots.push({hex:i,sim:t,resistance:s,distance:n,cost:o})}markDirty(e,t){this.getOrCreateInvalidationData(e).dirtyHexes.add(t)}getParentOf(e,t){return t.findNeighbour((i=>!!this.builder.getCurrent(i.id)?.get(e)?.children.includes(t)))}clearParent(e,t){const i=this.getParentOf(e,t);if(!i)return;const s=this.builder.getCurrent(i.id),n=s?.get(e)?.children??(0,S.ImmutableSet)();this.builder.set(i.id,s.set(e,{...s.get(e),children:n.delete(t)})),this.builder.set(t.id,s.set(e,{...s.get(e),parent:null}))}updateInfluence(e,t,i,s,n,o,a){const r=this.builder.getCurrent(t.id)||(0,S.ImmutableMap)();if(r.get(e)&&(this.invalidateSource(e,t),this.clearParent(e,t)),this.builder.set(t.id,r.set(e,{parent:i,children:(0,S.ImmutableSet)(),hexDefense:a,resistance:s,distance:n,cost:o})),i){const s=this.builder.getCurrent(i.id);if(s){const n=s.get(e)?.children||(0,S.ImmutableSet)();this.builder.set(i.id,s.set(e,{...s.get(e),children:n.add(t)}))}else c.errors.handleNonFatalError(new Error(`tried to make #${i.id} the parent of #${t.id}, but the parent hex has no influence record for region ${e}!`),"RegionInfluenceByHexProjection")}}removeInfluence(e,t){const i=this.builder.getCurrent(e.id);if(!i)return;this.clearParent(t,e);const s=i.delete(t);0===s.size?this.builder.delete(e.id):this.builder.set(e.id,s)}getHexDefense(e,t,i){return t!==m.SpecialFaction.neutral&&d.Factions.getByHex(this.newState,i.id)===t?-1:e.getHexDefense(i)}getInfluenceSpreadResistance(e,t,i){return M(this.getHexDefense(e,t,i))}handleHexRegionChanged(e){for(let[t,i]of e.updated||[]){const e=(0,h.getHex)(t),s=a.Regions.getByHex(this.oldState,t),n=d.Factions.getByHex(this.oldState,t),o=d.Factions.getByHex(this.newState,t);if(s===i)return;let r;s?(this.getOrCreateInvalidationData(s),this.invalidateSource(s,e),r=this.builder.getCurrent(t)?.keySeq().filter((e=>{const t=d.Factions.getByRegion(this.newState,e);return t===o||t===n||void 0===o})).toArray()):r=e.neighbours().map((e=>this.builder.getCurrent(e.id)?.keySeq().toSet()||(0,S.ImmutableSet)())).reduce(((e,t)=>t?.union(e))).toArray(),i&&this.getOrCreateInvalidationData(i),r?.forEach((t=>{this.invalidateSource(t,e)}))}}updateInfluenceRange(e,t){if(!this.oldState)return;const i=T(a.Regions.model(this.oldState).byId(e));t>i?this.addLeafsAsRoots(e):t<i&&this.cullInfluenceRange(e,t)}addLeafsAsRoots(e){const t=y.ConquestSim.fromState(this.newState);let i=a.Regions.getRegionBorderHexes(this.oldState,e).toArray().map((e=>({hexId:e,simState:t})));for(;i.length>0;){const{hexId:t,simState:s}=i.pop(),n=this.builder.getCurrent(t)?.get(e);n&&(n.children.size>0?i.push(...n.children.toArray().map((e=>({hexId:e.id,simState:s.conquerHex(e)})))):this.addRoot(e,s,(0,h.getHex)(t),n.resistance,n.distance,n.cost))}}cullInfluenceRange(e,t){let i=a.Regions.getRegionBorderHexes(this.oldState,e).toArray();for(;i.length>0;){const s=i.pop(),n=this.builder.getCurrent(s)?.get(e);n&&(n.resistance>t?this.removeSubTree(e,(0,h.getHex)(s)):i.push(...n.children.toArray().map((e=>e.id))))}}removeSubTree(e,t){const i=this.builder.getCurrent(t.id)?.get(e)?.children.toArray()||[];this.removeInfluence(t,e),i.forEach((t=>this.removeSubTree(e,t)))}handleHexDefenseChanged(e){for(let[t,i]of e.updated||[])this.invalidateForAllRegionsExceptOwner((0,h.getHex)(t))}invalidateForAllRegionsExceptOwner(e){const t=a.Regions.getByHex(this.newState,e.id),i=new Set(this.builder.getCurrent(e.id)?.keySeq().filter((e=>e!==t)));for(const s of e.neighbours())this.builder.getCurrent(s.id)?.keySeq().filter((e=>e!==t)).forEach((e=>i.add(e)));i?.forEach((t=>this.invalidateSource(t,e)))}}function M(e){switch(e){case-1:return 0;case 0:return 1;case 1:return 2;case 2:return 4;case 3:return 8;default:return 100}}t.HexRegionInfluenceUpdater=C},24336:(e,t)=>{"use strict";function i(e){const t=s(e);if(1===t.turnsToBankruptcy)return 1e-5;let i=t.treasuryScore+t.unitsScore+t.incomeScore+t.fortificationScore;return void 0!==t.turnsToBankruptcy&&(i*=.001*t.turnsToBankruptcy),i}function s(e){const t=e.remainingIncome>=1?e.remainingIncome:1/-(e.remainingIncome-1);return{turnsToBankruptcy:e.turnsToBankruptcy(),incomeScore:t,unitsScore:5*e.totalUnits.countOf(1)+2*e.totalUnits.countOf(2),treasuryScore:3*Math.floor(e.remainingGold/10),fortificationScore:e.fortification/2}}Object.defineProperty(t,"__esModule",{value:!0}),t.RegionForecast=void 0,t.getTotal=i,t.getFactors=s,t.RegionForecast={getTotal:i,getFactors:s}},24385:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BehaviorSummaryView=void 0;const s=i(90952),n=i(20754),o=i(70712),a=i(76439),r=i(29322),l=i(19618),c=i(19506),d=i(63521),h=i(56824),u=i(9292);h.logger.for("BehaviorSummaryView");class p extends n.LazyView{constructor(){super([s.GameState.ai.hexHistory,s.GameState.ai.assetsValueByRegion]),this.name="behaviorSummary"}calculate(e,t){const i={};let s=0,n=0;const a=l.Factions.model(e).byId(t),r=a.getPawns({traits:[d.PawnTraits.Unit]});for(const t of r){const a=t.hex,r=o.AI.getHexAge(e,a.id),l=o.AI.getHexHistory(e,a.id);0===r&&(s+=t.might,"deadHex"!==l.spoils&&0!==l.previousFactionId?i[l.previousFactionId]=i[l.previousFactionId]?i[l.previousFactionId]+t.might:t.might:n+=t.might)}const c=a.getRegions().map((e=>e.getMyAssets().getTotalAvailableMight())).reduce(u.sum,0);return{mightUsedForConquest:i,mightUsedForPeacefulExpansion:n,totalMightUsed:s,unusedMight:(0,u.pickLarger)(0,c-s),totalMight:c}}getCacheKey(e){return e}getDebugLayer(){return new a.GameStateDebugLayer((0,r.factionBasedAdapter)({getValue:(e,t)=>{const i=this.get(e,t);return`${c.GLYPH.sword}${i.totalMightUsed}/${i.totalMight}`},getDetail:(e,t)=>{const i=this.get(e,t);return`${Object.entries(i.mightUsedForConquest).map((([e,t])=>`${t} used vs ${c.GLYPH.factions[Number(e)]}`)).join("\n")}                \n${i.mightUsedForPeacefulExpansion} used to expand\n${i.unusedMight} unused`}}))}}t.BehaviorSummaryView=p},24560:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommentsBuilder=void 0;const s=i(52724),n=i(91622),o=i(68649),a=i(56824),r=i(28250);a.logger.for("CommentsBuilder"),t.CommentsBuilder=class{constructor(e){this.emojiManager=e,this.cooldown=new r.Cooldown(1e3),this.reactionByHex=new Map,this.cooldown.onFinished((()=>{const e=new Set;for(const[t,i]of this.reactionByHex.entries())this.triggerReaction(t,i,e);this.clear()}))}triggerReaction(e,t,i=new Set){const r=n.inject.gameStateModel.regions.byHex(e),l=n.inject.gameStateModel.factions.localPlayer,c=function({reason:e,delta:t}){if(t>.1)return"angry reaction";if(t<-.1)switch(e){case o.CreditShiftReason.EndOfTurnAdjustment:return"approving non-aggression";case o.CreditShiftReason.ObservedAttack:return"approving attack";default:return null}return null}(t);if(r?.isAlive()&&l&&c){const t=(0,s.generateChatter)(r,l,{requiredTags:[c],bannedPhrases:i});t&&(this.emojiManager.showChatter(e,t,void 0,a.random.integerBetween(0,300)),i.add(t))}}addReaction(e,t,i){if(i===o.CreditShiftReason.EndOfTurnAdjustment)this.triggerReaction(e,{delta:t,reason:i});else if(i===o.CreditShiftReason.ObservedAttack||i===o.CreditShiftReason.Attacked){const s=(this.reactionByHex.get(e)?.delta??0)+t;this.reactionByHex.set(e,{delta:s,reason:i}),this.cooldown.isRunning()||this.cooldown.start()}}clear(){this.cooldown.cancel(),this.reactionByHex.clear()}}},24598:(e,t)=>{"use strict";var i,s,n;Object.defineProperty(t,"__esModule",{value:!0}),t.PawnType=t.FactionController=t.PhaseTypes=void 0,function(e){e.FactionTurn="faction-turn",e.GameOver="game-over"}(i||(t.PhaseTypes=i={})),function(e){e.None="none",e.LocalUser="local-user",e.Ai="ai"}(s||(t.FactionController=s={})),function(e){e.GoldMine="gold-mine",e.Town="town",e.Castle="castle",e.Camp="camp",e.Swamp="swamp",e.Forest="forest",e.Villager="villager",e.Pikeman="pikeman",e.Knight="knight",e.Hero="hero",e.UniqueHero="unique-hero",e.Bandit="bandit",e.Bunny="bunny",e.Coins="coins",e.Chest="chest",e.Present="present",e.Spawner="spawner",e.Refuge="refuge",e.Zombie="zombie",e.LadderZombie="ladder-zombie",e.DreadKnight="dread-knight",e.HauntedTown="haunted-town",e.Mana="mana",e.TownRuins="town-ruins"}(n||(t.PawnType=n={}))},24649:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Planners=void 0;const s=i(39816),n=i(89939),o=i(14360),a=i(6217),r=i(24893);t.Planners={BasicDefense:new s.BasicDefensePlanner(!1),BasicDefenseWithTownProtection:new s.BasicDefensePlanner(!0),FrontlineDefense:new n.FrontlineDefensePlanner,BlockTownAccess:new a.BlockTownAccessPlanner(3),BlockTownAccessMaxPikeman:new a.BlockTownAccessPlanner(2),Conquest:new o.ConquestPlanner,LimitedConquest:new o.ConquestPlanner(5),ObviousMoves:new r.ObviousMovesPlanner}},24832:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.partitionLand=async function(e,t,i,s,c){let d=i.hexes.filter((t=>!e.warfare.isImpassable(t)));(0,o.assert)(d.length);const h=await async function(e,t,i){const s=new n.default;let r;for(e.forEach((e=>s.addToGroup(e.id,e)));r=l(s.keys());){await i();const e=c(r);o.assert.defined(e),s.addToGroup(e.key,...r.hexes)}return s;function l(e){let i,n=1/0;for(let o of e){const e=s.byKey(o);if(e.hexes.size>=t.minCellSize)continue;const a=s.getGroupsAdjacentTo(o),r=a.filter((i=>i.hexes.size+e.hexes.size<t.maxCellSize));if(0!==a.length){if(r.length<=1)return e;r.length>0&&r.length<n&&(i=e,n=r.length)}}return i}function c(e){let i=s.getGroupsAdjacentTo(e.key);return(0,a.findMax)(i,(i=>{let s=0;return e.hexes.size+i.hexes.size>t.maxCellSize&&(s=-100),i.hexes.size<t.minCellSize&&(s=1),i.borderSize+s}))}}(d,s,c),u=[];e.useProjections(r.ProjectionPresets.coreEntities);const p=e.factions.byId(l.SpecialFaction.neutral);for(let e of h.getGroups())(0,o.assert)(e.length>0),await c(),u.push(p.addNewRegion(t.townName(),e));return e.activateAllProjections(),u},i(20693);const n=s(i(95608)),o=i(97849),a=i(1326),r=(i(18957),i(45664),i(72273)),l=i(67274);i(91622),i(56824).logger.for("partitionLand")},24893:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ObviousMovesPlanner=void 0;const s=i(89764),n=i(22312),o=i(63521),a=i(29064),r=i(91622),l=i(24598);t.ObviousMovesPlanner=class{constructor(){this.isConquest=!0,this.name=this.constructor.name}async*generatePlans(e,t){const i=s.RegionAssets.fromMyRegion(e.region);let c=e.region.getPawns().find((e=>e.hasTrait(o.PawnTraits.Treasure)));if(r.inject.gameStateModel.map.plugins.zombies)c=r.inject.gameStateModel.pawns.findOne({hexes:e.region.getTownHexes().neighbours(),type:[l.PawnType.LadderZombie]}),c||(c=r.inject.gameStateModel.pawns.findOne({hexes:e.region.getTownHexes().neighbours(),type:[l.PawnType.Zombie]}));else if(!i.getObtainableMightLevels().includes(1))return;const d=i.getObtainableMightLevels()[0];c&&d&&(yield new n.PlaceUnitPlan(c.hex,d,{conquestValue:{total:1e3,factors:{...a.NO_CONQUEST_VALUE.factors,loot:1e3}},eradicatePestBonus:0,downstreamMovesBonus:0,joinRegionsBonus:0,threatReduction:0,diplomacyPenalty:0,mightInvestment:1,economyHealth:1,focusMismatchPenalty:1,vulnerabilityPenalty:1}))}}},24966:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TutorialFrame=void 0;const s=i(7782),n=i(21941),o=i(9292);class a extends n.Box{constructor(e){super(e,n.BoxTextures.TutorialFrame),this.position=null,this.visibility=new s.TransitionController(this.scene,{applyValue:(e,t)=>{if(this.alpha=e,e<t){const t=(0,o.pickSmaller)(1/e,4);this.setScale(t)}else this.setScale(1)},initialValue:0,delay:100,ease:"Sine.easeOut"}),this.setOrigin(.5,.5),this.visibility.applyValue(0,0)}showAt(e){this.position=e,this.updatePosition(),this.visibility.transitionTo(1)}updatePosition(){if(this.position)try{const{x:e,y:t,width:i,height:s}=this.position();this.setPosition(e+this.width/2,t+this.height/2),this.setSize(i,s)}catch(e){this.setVisible(!1)}}hide(){this.position=null,this.visibility.setTo(0)}}t.TutorialFrame=a},25e3:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NewsBox=void 0;const s=i(96137),n=i(91622),o=document.getElementById("news-box"),a=document.getElementById("news-box-body"),r=document.getElementById("news-box-button");let l=!1;t.NewsBox={show(){o&&(o.style.left="40px",o.style.bottom="40px",l=!1)},hide(){o&&!l&&(o.style.left=-o.offsetWidth-10+"px",l=!0)},syncWithTheme(){a&&(a.style.backgroundColor=s.Colors.toCss(n.inject.theme.getCurrent().oceanShades.dark4)),r&&(r.style.backgroundColor=s.Colors.toCss(n.inject.theme.getCurrent().oceanShades.dark5))}}},25098:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapEditorOverlay=void 0;const s=i(56824),n=i(87936),o=i(79573),a=i(91622),r=i(20389),l=i(55275),c=i(8),d=i(80959),h=s.logger.for("WorldMapEditorOverlay");t.WorldMapEditorOverlay=class{updateBrush(e){const t=this.brushConfig[e];this.hexPolygon.setVisible(!!t.hexPolygon),this.hexImage.setVisible(!!t.hexImage),t.hexPolygon&&this.hexPolygon.setTo(t.hexPolygon),t.hexImage&&this.hexImage.setFrame(t.hexImage).setOrigin(.5,.5)}constructor(e){this.scene=e,this.signalSubs=[],this.active=!1,this.brushConfig={none:{},"single-hex":{hexPolygon:n.HEX_POLYGON},"9-hexes":{hexPolygon:n.NINE_HEXES_POLYGON},flood:{hexPolygon:n.HEX_POLYGON,hexImage:"editor/flood-fill"}},this.currentState=(0,l.stateContainer)({brush:"single-hex",cursorAttachmentImage:null,worldBounds:null},(e=>{if(e.brush&&this.updateBrush(e.brush),void 0!==e.cursorAttachmentImage)if(null===e.cursorAttachmentImage)this.cursorAttachment.clear();else{const t=d.UiBuilder.for(this.scene).createIcon(e.cursorAttachmentImage);t.setScale(t.scaleX/2,t.scaleY/2).setDepth(o.WorldLayers.UIOverlay+1),this.cursorAttachment.setImage(t)}if(void 0!==e.worldBounds)if(null===e.worldBounds)this.worldBoundsRectangle.setVisible(!1);else{this.worldBoundsRectangle.setVisible(!0);const t=(0,c.convertHexRectToWorldRect)(e.worldBounds);this.worldBoundsRectangle.setPosition(t.x,t.y),this.worldBoundsRectangle.setSize(t.width,t.height)}h.info("WorldMapEditorOverlay state changed",e)})),this.worldBoundsRectangle=this.scene.add.rectangle(0,0,0,0).setStrokeStyle(4,14942208,.2).setDepth(o.WorldLayers.UIOverlay).setOrigin(0,0),this.hexPolygon=this.scene.add.polygon(0,0,n.HEX_POLYGON).setStrokeStyle(1,16777215,.5).setFillStyle(16777215,.2).setVisible(!1).setDepth(o.WorldLayers.UIOverlay).setOrigin(0,0),this.hexImage=this.scene.add.image(0,0,"atlas","editor/flood-fill").setVisible(!1).setDepth(o.WorldLayers.UIOverlay+1).setOrigin(.5,.5),this.cursorAttachment=new r.CursorAttachment(this.scene),this.scene.add.existing(this.hexPolygon),this.scene.add.existing(this.worldBoundsRectangle),this.registerSignals()}setVisible(e){this.worldBoundsRectangle.setVisible(e&&!!this.currentState().worldBounds),this.active=e,e?(this.registerSignals(),this.updateBrush(this.currentState().brush)):(this.unRegisterSignals(),this.hexPolygon.setVisible(!1),this.hexImage.setVisible(!1))}registerSignals(){this.unRegisterSignals(),this.signalSubs.push(a.inject.ui.hexUnderCursor.watch((e=>{const t=this.brushConfig[this.currentState().brush];this.isCurrentBrushUsableOn(e)?(t.hexPolygon&&(this.hexPolygon.setVisible(!0),this.hexPolygon.setPosition(e.x*n.HEX_WIDTH,e.y*n.HEX_INNER_HEIGHT)),t.hexImage&&(this.hexImage.setVisible(!0),this.hexImage.setPosition((e.x+.5)*n.HEX_WIDTH,e.y*n.HEX_INNER_HEIGHT+n.HEX_HEIGHT/2))):(this.hexPolygon.setVisible(!1),this.hexImage.setVisible(!1))})))}isCurrentBrushUsableOn(e){return!!e&&"none"!==this.currentState().brush&&("flood"===this.currentState().brush?void 0!==a.inject.gameStateModel.regions.byHex(e):!e.isAtGridBorder(a.inject.gameStateModel.map))}unRegisterSignals(){this.signalSubs.forEach((e=>e.unsubscribe())),this.signalSubs=[]}update(){this.active&&this.cursorAttachment.update()}}},25099:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ActivityWatcher=void 0;const s=i(36868),n=i(56824),o=function(){let e,t=0,i=!0;function o(){t++,t>10&&a()}function a(){i&&(i=!1,n.events.trigger(s.SystemEvents.UserBecameInactive()))}function r(){i||n.events.trigger(s.SystemEvents.UserBecameActive()),i=!0,t=0}return["mousedown","mousemove","keydown","scroll","touchstart"].forEach((e=>{document.addEventListener(e,r,!0)})),document.addEventListener("visibilitychange",(()=>{document.hidden?a():r()})),{start:()=>{e||(e=setInterval(o,1e3))},stop:()=>{e&&(clearInterval(e),e=void 0)}}}();t.ActivityWatcher={start:o.start,stop:o.stop}},25342:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RandomMapHash=void 0,t.serializeMapPresetInput=u,t.serializeMapSettings=p,t.deserializeMapPresetInput=g,t.isMapPresetHash=m,t.migrateMapPresetInput=function(e){return e.version<2?{version:r.MAP_GENERATOR_VERSION,name:a.random.townName(),size:e.size,mode:e.mode,shape:e.shape,difficulty:e.difficulty}:(Object.values(r.MapSize).includes(e.size)||(e.size=r.MapSize.Medium),Object.values(r.MapMode).includes(e.mode)||(e.mode=r.MapMode.Classic),Object.values(r.MapShape).includes(e.shape)||(e.shape=r.MapShape.Temperate),Object.values(r.MapDifficulty).includes(e.difficulty)||(e.difficulty=r.MapDifficulty.Normal),{version:r.MAP_GENERATOR_VERSION,...e})};const s=i(97849),n=i(2543),o=i(1326),a=i(56824),r=i(85072),l={[r.MapSize.Small]:"S",[r.MapSize.Medium]:"M",[r.MapSize.Large]:"L"},c={[r.MapShape.Temperate]:"T",[r.MapShape.Marshlands]:"M",[r.MapShape.Flat]:"F"},d={[r.MapMode.Classic]:"1",[r.MapMode.Crowded]:"2",[r.MapMode.Colonization]:"3",[r.MapMode.Zombies]:"Z",[r.MapMode.KingsLanding]:"L",[r.MapMode.Christmas]:"X",[r.MapMode.Occupation]:"O"},h={[r.MapDifficulty.Casual]:"1",[r.MapDifficulty.Challenging]:"2",[r.MapDifficulty.Normal]:"0",[r.MapDifficulty.Unfair]:"3"};function u(e){return`gl${r.MAP_GENERATOR_VERSION}-${p(e)}-${e.name.replaceAll(" ","_")}`}function p(e){const t=e.regionsVariation&&1!==e.regionsVariation?e.regionsVariation:"";return l[e.size]+c[e.shape]+d[e.mode]+h[e.difficulty]+t}function g(e){const t=e.match(/^gl(\d+)-([a-zA-Z])([a-zA-Z])([\dA-Z])(\d)(\d?)-(\w+)$/);s.assert.defined(t),(0,s.assert)(8===t.length,`failed to interpret "${e} as a conquest map config"`);const i=t[1];(0,s.assert)(i===r.MAP_GENERATOR_VERSION.toString(),`expected generator version ${r.MAP_GENERATOR_VERSION}, found ${i}`);const a=(0,o.inverseLookup)(l,t[2]),u=(0,o.inverseLookup)(c,t[3]),p=(0,o.inverseLookup)(d,t[4]),g=(0,o.inverseLookup)(h,t[5]),m=t[6];return(0,s.assert)(a&&u&&p&&g,"failed to decode map settings"),{version:r.MAP_GENERATOR_VERSION,name:(0,n.startCase)(t[7].replaceAll("_"," ")),size:a,shape:u,mode:p,difficulty:g,regionsVariation:m?parseInt(m):void 0}}function m(e){return e.startsWith("gl")}t.RandomMapHash={generate:u,parse:g,isValid:m}},25430:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defeatToOverworldTransition=async function(){await Promise.all([(0,n.playScreenToOverworldTransition)(),(0,s.defeatTransitionOut)()])};const s=i(89069),n=i(99816)},25777:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionGeographyView=void 0;const s=i(20754),n=i(90952),o=i(56038),a=i(76439),r=i(12543),l=i(1326),c=i(19506);class d extends s.LazyView{constructor(){super([n.GameState.regions.byHex]),this.name="regionGeographyView"}calculate(e,t){const i=o.Regions.model(e).byId(t),s=i?.hexes;if(!s||0===s.length)return{centralHex:void 0,centralTownHex:void 0};const n=s.findGeometricMedian();if(!n)return{centralHex:void 0,centralTownHex:void 0};const a=(0,l.findMin)(i.getTownHexes().toArray(),(e=>e.getDistanceTo(n)));return{centralHex:n,centralTownHex:a}}getCacheKey(e){return e}getDebugLayer(){return new a.GameStateDebugLayer((0,r.hexBasedAdapter)({getValue:(e,t)=>{const i=o.Regions.model(e).byHex(t)?.id;if(!i)return;const s=this.get(e,i);return s.centralHex?.id===t?c.GLYPH.whiteFlag:s.centralTownHex?.id===t?c.GLYPH.defense:void 0},getDetail:(e,t)=>{}}))}}t.RegionGeographyView=d},25862:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateBankrupcySymbols=function(e,t){const i=s.Regions.model(e).all().filter((e=>!e.faction?.isNeutral()&&(!e.isAlive()||e.isBankrupt())));t.clear(y.PawnSymbolType.Confused);for(let e of i)for(let i of e.getPawns().filter((t=>(t.upkeep>0||!e.isAlive())&&t.hasTrait(n.PawnTraits.Unit)&&!t.hasTrait(n.PawnTraits.Loyal))))t.add(i.id,y.PawnSymbolType.Confused,(o=i.type)===d.PawnType.DreadKnight?"Separated from it's master, this Dread Knight will turn into a regular zombie next turn!":`${(0,m.capitalize)(o)} can't get paid! It will turn into bandit next turn!`);var o},t.updateAttitudeEmojis=function(e,t,i){const s=new o.StaticGameStateModel(e),n=s.factions.localPlayer;if(t.syncWithModel(s,n),i&&n){const o=s.regions.byId(i),r=o?.faction,d=o?.getTownHexes().members[0];if(t.setSelectedEmoji(d),r&&d&&!r.isLocalPlayer()&&"off"!==a.inject.userData.recallChoice("rivalAIChatter")){const s=a.inject.views.idleChatter.get(e,i);if(s){const i=r.scaledPower,o=i/(i+n.scaledPower),a=c.AIPolitics.getOpenHostilityTowards(e,n,r.id),h=(0,l.getEmojiIndex)(o,a).toString();t.showChatter(d,s,h)}}}else t.setSelectedEmoji(void 0)},t.updateConquerableHexesBasedOn=function(e,t){e.clearHighlightedHex(),e.set(function({state:e,regionId:t,pawnType:i,includeMerging:o}){const a=u.Warfare.model(e);if(!t)return h.HexGroup.empty;const l=s.Regions.model(e).byId(t);if(!l||!l.faction?.isLocalPlayer())return h.HexGroup.empty;if(!i){const e=o?f.UnitsByMight.fromUnitList(l.getMyAssets().getObtainableMightLevels()):l.getMovableUnitsByMight();return a.getConquerableHexes(l,e.getStrongest(),e.getStrongestLightUnit())}if(i===d.PawnType.Present)return a.getConquerableHexes(r.app.screen.play.selectedRegion,4,4).filter((e=>!a.isOccupied(e)));const c=p.Rules.model(e).pawns(i);if(c.hasTrait(n.PawnTraits.Unit)){const e=c.might;return a.getConquerableHexes(l,e,3===e?0:e)}return h.HexGroup.empty}(t),g.Colors.highlight.ownedRegion,t.pawnType?1:.5)},t.updateNewsAlerts=function(e){const t=r.app.worldNews.getSymbols().map((({hexes:t,options:i})=>({options:i,hexes:t.filter((t=>0===e.pawnSymbols.byHex(t).length))})));e.newsAlerts.setDiverse(t)};const s=i(56038),n=i(63521),o=i(72273),a=i(91622),r=i(54825),l=i(74783),c=i(80268),d=i(24598),h=i(20693),u=i(78635),p=i(19162),g=i(96137),m=i(2543),y=i(5116),f=i(64884)},25988:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SideBarWidget=void 0;const s=i(86545),n=i(80959),o=i(96137),a=i(52528),r=i(91622);var l=Phaser.GameObjects.BitmapText;class c extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.hasCustomBackground=!1;const i=n.UiBuilder.for(e);this.padding=t.padding??a.SIDEBAR_LAYOUT.widgets.padding,this.offsetFromTitle=t.offsetFromTitle??this.padding,this.hasCustomBackground=void 0!==t.backgroundColor,this.background=i.roundedRect(a.SIDEBAR_LAYOUT.widgets.radius,{color:t.backgroundColor??0,alpha:.5}),this.icon&&this.add(this.icon),this.add([this.background]),t.title&&(this.title=i.richText(`[b]${t.title}[/b]`,o.Colors.glassUi_old.backgroundText),this.add(this.title)),r.inject.theme.use((e=>{this.applyTheme(e)})),t.content&&this.setContent(t.content)}setContent(e){this.content&&(this.content.setVisible(!1),this.remove(this.content)),this.content=e,e&&(this.add(e),e.setVisible(!0)),this.preUpdate.makeDirty()}setTitle(e){this.title?.setText(`[b]${e}[/b]`),this.preUpdate.makeDirty()}setIcon(e){this.icon&&this.icon.destroy(),this.icon=e,e&&(this.add(e),e.setVisible(!0)),this.preUpdate.makeDirty()}setBackground(e,t=.5){this.background.setFillStyle(e,t),this.hasCustomBackground=!0}clearCustomBackground(){this.hasCustomBackground=!1,this.applyTheme(r.inject.theme.getCurrent())}applyTheme(e){this.hasCustomBackground||this.background.setFillStyle(e.oceanShades.dark2,1),this.title?.setTint(e.oceanShades.light3)}calculateHeight(){return this.content?this.content.y+this.content.height+this.padding:2*this.padding}updateLayout(){let e=this.padding,t=this.padding;this.icon&&(this.icon.setPosition(this.padding,this.padding),t+=(this.icon.displayWidth??this.icon.width)+this.padding/2),this.title&&(this.title.setPosition(t,this.padding),this.title.setWordWrapWidth(this.width-this.padding-this.title.x),e=this.title.y+this.title.height+this.offsetFromTitle,this.icon&&(this.icon.y=this.title.y+(this.title.height-(this.icon.displayHeight??this.icon.height))/2)),this.content&&(this.content.setPosition(this.padding,e),this.content instanceof l?this.content.maxWidth=this.width-2*this.padding:this.content.width=this.width-2*this.padding),this.updateSize(),this.background.setSize(this.width,this.height)}}t.SideBarWidget=c},25992:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PickLandingSpotMode=void 0;const s=i(41569),n=i(56824),o=i(91622),a=i(54825),r=i(40951),l=i(12933),c=i(30484),d=i(95428),h=i(24598),u=i(79694),p=i(59956);n.logger.for("PlayMode");class g extends s.BaseMode{constructor(){super(...arguments),this.name="PickLandingSpot",this.currentDefaultCursor=void 0}activate(){o.inject.ui.transitionsSpeed.set(r.TransitionsSpeed.Fast),a.app.scene.playUI.updateState({layout:{name:"hidden"},worldMapPanel:{text:`Land sighted, Sir! Where do we drop anchor?\n(starting treasury: ${this.getStartingCoins()} [img=coin-hd])`,buttons:[],type:"tutorial",emojiEmotion:d.EmojiEmotion.Happy}}),a.app.scene.worldMap.overlays.set(o.inject.currentGameState,c.OverlayModes.pickLandingSpot()),a.app.scene.worldMap.pawns.clearAllJumping()}canPickupPawn(e){return!1}canEndTurn(){return!1}getStartingCoins(){return p.WorldMap.get(o.inject.currentGameState).pluginOptions?.initialTreasury??20}handleStartInteraction(e,t){if(e)if(this.isValidLandingSpot(e)){const t=this.getStartingCoins();o.inject.gameStateController.beginTransaction(),o.inject.gameStateModel.factions.localPlayer.takeOverHex(e),o.inject.gameStateModel.pawns.create({hex:e,type:h.PawnType.Town}),o.inject.gameStateModel.pawns.setCount(e,h.PawnType.Coins,t),o.inject.gameStateController.commitTransaction(),a.app.scene.playUI.updateState({worldMapPanel:null});const i={pluginOptions:{landingSpotPicked:!0}};o.inject.gameStateModel.stateEngine.setState(p.WorldMap.update(o.inject.currentGameState,i)),o.inject.gameStateController.history.reset(o.inject.currentGameState),o.inject.ui.regionsLedger.refreshAvailableRegions(o.inject.currentGameState),a.app.scene.worldMap.syncState(),this.scene.setMode(new u.PlayMode(this.scene))}else a.app.scene.worldMap.cameraController.startDragScroll();else a.app.scene.worldMap.cameraController.startDragScroll()}isHexInteractive(e){return!0}handleCompleteInteraction(e){e&&a.app.scene.worldMap.cameraController.stopDragScroll()}handleStartDrag(e){a.app.scene.worldMap.cameraController.startDragScroll()}handleEndDrag(e){a.app.scene.worldMap.cameraController.stopDragScroll()}isValidLandingSpot(e){return o.inject.views.landingSpots.get(o.inject.currentGameState).has(e)}handleNewHexUnderCursor(e){a.app.scene.worldMap.overlays.conquerableHexesHighlight.clearHighlightedHex(),e&&this.isValidLandingSpot(e)?(a.app.scene.worldMap.overlays.conquerableHexesHighlight.setHighlightedHex(e),this.updateDefaultCursor("pointer")):this.updateDefaultCursor("default")}updateDefaultCursor(e){this.currentDefaultCursor!==e&&(this.scene.input.setDefaultCursor(e),this.currentDefaultCursor=e)}doHandleEvent(e){return(0,l.doHandleEvent)(this,e)}}t.PickLandingSpotMode=g},26294:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NearestTownUpdater=t.NearestTownProjection=t.UNREACHABLE=void 0;const n=i(31011),o=i(56824),a=i(4005),r=i(56038),l=i(45664),c=s(i(65731)),d=i(7334),h=i(20693),u=i(97849),p=i(61634),g=i(19506),m=i(88023);o.logger.for("NearestTownProjection"),t.UNREACHABLE=Object.freeze({rootId:0,distance:Number.POSITIVE_INFINITY});class y extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new f(this).update}bootstrap(e){const t=new f(this);return t.initFromState(e),r.Regions.getAll(e).forEach((e=>{t.addRootsFromRegion(e)})),t.getMap()}entryToString(e){return 0===e.distance?g.GLYPH.whiteFlag:e.rootId}entryToDebugString(e){return(0,d.prettyPrintObject)(e)}}t.NearestTownProjection=y;class f extends a.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.sources=new Set,this}registerHandlers(e){e(this.dataSet.sources.townsByRegion,this.handleTownsByRegionChange),e(this.dataSet.sources.regionByHex,this.handleRegionByHexChange)}handleTownsByRegionChange(e){e.updated?.forEach((e=>{e.added?.forEach((e=>{this.addNewRoot((0,l.getHex)(e))})),e.removed?.forEach((e=>{this.invalidateFrom((0,l.getHex)(e))}))}))}handleRegionByHexChange(e){e.updated?.forEach((([e,t])=>{this.invalidateFrom((0,l.getHex)(e))}))}addRootsFromRegion(e){r.Regions.model(this.newState).byId(e)&&p.Economy.getTownHexesByRegion(this.newState,e).forEach((e=>this.addNewRoot((0,l.getHex)(e))))}updateInvalidated(){this.addSourcesFromInvalidatedHexes();const e=new c.default(((e,t)=>e.distance-t.distance));for(this.sources.forEach((t=>{const i=this.builder.getCurrent(t.id);u.assert.defined(i),e.push({hex:t,rootHex:(0,l.getHex)(i.rootId),distance:i?.distance})}));!e.empty();){const t=e.pop(),i=t.hex;this.getCurrentDistanceFrom(i)<=t.distance||(this.invalidatedHexes.delete(i),this.builder.set(i.id,{distance:t.distance,rootId:t.rootHex.id}),i.neighbours((e=>r.Regions.getByHex(this.newState,e.id)===r.Regions.getByHex(this.newState,i.id)&&this.getCurrentDistanceFrom(e)>=t.distance+1)).forEach((i=>{e.push({hex:i,rootHex:t.rootHex,distance:t.distance+1})})))}this.invalidatedHexes.forEach((e=>this.builder.delete(e.id)))}addSourcesFromInvalidatedHexes(){h.HexGroup.from(Array.from(this.invalidatedHexes)).neighbours().filter((e=>this.getCurrentDistanceFrom(e)<Number.POSITIVE_INFINITY)).forEach((e=>{this.sources.add(e),this.invalidateFrom(e)}))}getMap(){return this.updateInvalidated(),(0,m.ImmutableMap)(this.builder.getEntries()).mapKeys((e=>Number(e)))}createMutation(){return this.updateInvalidated(),super.createMutation()}invalidateFrom(e){if(this.invalidatedHexes.has(e))return;this.invalidatedHexes.add(e);const i=this.builder.getCurrent(e.id);i&&e.neighbours((e=>{const s=this.builder.getCurrent(e.id)??t.UNREACHABLE;return i.rootId==s.rootId&&s.distance===i.distance+1})).forEach((e=>this.invalidateFrom(e)))}getCurrentDistanceFrom(e){return this.invalidatedHexes.has(e)?Number.POSITIVE_INFINITY:this.builder.getCurrent(e.id)?.distance??Number.POSITIVE_INFINITY}addNewRoot(e){this.sources.add(e),this.builder.set(e.id,{rootId:e.id,distance:0}),this.invalidatedHexes.add(e)}}t.NearestTownUpdater=f},26386:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.wasPawnDefeated=function(e,t){const i=t.filter((e=>(0,s.isEvent)(e,n.GameStateEvents.HexCaptured)||(0,s.isEvent)(e,n.GameStateEvents.PawnMoved)||(0,s.isEvent)(e,n.GameStateEvents.PawnBought)));for(const t of i)for(const i of t.payload.worldUpdates.updates)if(i.type===o.UpdateType.PawnsMoved){if(!i.defeatedUnit||i.defeatedUnit.retreatHex)continue;return i.defeatedUnit.pawnId===e}return!1};const s=i(39420),n=i(36868),o=i(78933)},26502:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageButtonWithContent=void 0;const s=i(22663),n=i(83176);var o=Phaser.GameObjects.Container,a=Phaser.GameObjects.Sprite;t.ImageButtonWithContent=class extends o{constructor(e,t,i,s){super(e,t,i),this.config=s,this.buttonSprite=new a(this.scene,0,0,"atlas",s.frame),this.buttonSprite.setInteractive({cursor:"pointer"}),this.setController((0,n.setupController)(s)),this.config.content.setOrigin(.5,.5).setPosition(this.buttonSprite.width/2,this.buttonSprite.height/2-1),this.add([this.buttonSprite,this.config.content]),this.width=this.buttonSprite.width,this.height=this.buttonSprite.height}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}setController(e){e&&(this.controller=e,e.bindTo(this.buttonSprite,(e=>this.setButtonState(e))))}setButtonState(e){const t=this.buttonSprite.width/2,i=this.buttonSprite.height/2-1;switch(e){case s.ButtonState.Rest:this.buttonSprite.setFrame(this.config.frame),this.config.content.setPosition(t,i);break;case s.ButtonState.Disabled:this.buttonSprite.setFrame(this.config.frame+(this.config.disabled?"-disabled":"")),this.config.content.setPosition(t,i);break;case s.ButtonState.Hover:this.buttonSprite.setFrame(this.config.frame+(this.config.hover?"-hover":"")),this.config.content.setPosition(t,i);break;case s.ButtonState.Down:this.buttonSprite.setFrame(this.config.frame+(this.config.down?"-down":"")),this.config.content.setPosition(t+1,i+1)}}}},26539:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapModel=void 0;const s=i(45664),n=i(59255),o=i(90667),a=i(40294),r=i(8358);t.WorldMapModel=class{constructor(e){this.state=e,this.innerWidth=this.state.width-2,this.innerHeight=this.state.height-2,this.width=this.state.width,this.height=this.state.height,this.plugins=new n.PluginsModel(this.state.plugins),this.winConditions=new o.WinConditionsModel(this.state.winConditions),this.defeatConditions=new a.DefeatConditionsModel(this.state.defeatConditions)}get script(){return this.state.script}get fixedAIDifficulty(){return this.state.fixedAIDifficulty}get name(){return this.state.name||"Unknown Island"}get author(){return this.state.author}get created(){return this.state.created}get introduction(){return this.state.introduction}get description(){return this.state.description}get levelId(){return this.state.levelId}get shortIntroduction(){const e=this.introduction;if(!e)return;const t=(0,r.shortenText)(e,300);return t!==e?t+" [...]":e}getAllHexes(){return s.HexGrid.getAllHexes(this.state)}getInnerHexes(){return s.HexGrid.getInnerHexes(this.state)}isWithinBounds(e){return s.HexGrid.isWithinBounds(e,this.state)}}},26596:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jump=function(e,t){return e-Math.sin(e*Math.PI)*-t},t.jump2=function(e){return Math.sin(e*Math.PI)}},26942:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SituationScoreByRegionView=t.SituationScoreComponentsEvaluation=void 0;const s=i(90952),n=i(20754),o=i(56824),a=i(76439),r=i(39409),l=i(56038),c=i(69447),d=i(78436),h=i(7334),u=i(70712),p=i(13560),g=i(91622),m=i(13602),y=i(24336),f=i(78635),w=i(9292),v=(o.logger.for("AttritionByFactionView"),{factorsByRegion:[],forecast:1,diplomacy:1,base:0});class b{constructor(e,t){this.context=e,this.views=t,this.factorsByRegion=e.faction.getRegions().filter((e=>e.isAlive())).map((t=>{const i=p.AssetValue.total(u.AI.getRegionAssetsValue(this.context.state,t.id));let s=0;for(let e of t.hexes){const t=1-this.views.evaluationSecurity.get(e.id),i=f.Warfare.getOccupyingPawn(this.context.state,e);let n=p.AssetValue.HEX_BASE_VALUE;if(i){const t=0===u.AI.getHexAge(this.context.state,e.id)?1:.25;n+=p.AssetValue.total(p.AssetValue.getPawnFactors(i.type,i.count))*t}s+=t*n}const n=this.getAdvancedRegionForecast(t),o=t.scaledPower,a=i-s;let r=t.id===e.region.id?m.AIMetrics.getExpansionTargetScoreMultiplier(e):1;return{expansionTargetMultiplier:r,regionId:t.id,safeAssets:a,exposedAssets:s,totalAssets:i,forecast:n,power:o,score:a*o*n*r}})),this.base=this.factorsByRegion.reduce(((e,t)=>e+t.score),0),this.forecast=this.context.faction.relativeForecast,this.diplomacy=g.inject.views.factionDiplomacyScore.get(e.state,e.faction.id),this.expansionTarget=m.AIMetrics.getExpansionTargetScoreMultiplier(e)}getAdvancedRegionForecast(e){const t=m.AIMetrics.getObviousGameEndingThreat(e,this.views.threatAssessment);if(t)return 1/t*1e-6;let i=1;e.treasury>=20&&(i=1-(0,w.cropNumber)((e.treasury-20)/20,0,.999));const s=e.getMySafeAssets(this.views.evaluationSecurity,this.context.focus.daring);return y.RegionForecast.getTotal(s)*i}}t.SituationScoreComponentsEvaluation=b;class S extends n.LazyView{constructor(){super([s.GameState.ai.powerByRegion,s.GameState.ai.hexImportance,s.GameState.factions.regions,s.GameState.warfare.hexDefense,s.GameState.currentPhase.movableUnits,s.GameState.currentPhase.data]),this.name="situationScoreByRegion"}calculate(e,t){const i=this.getComponents(t);return this.calculateFromComponents(i)}calculateFromComponents(e){return e.base*e.diplomacy}getComponents({context:e,views:t}){return e.faction?new b(e,t):v}getCacheKey(e){return e.context.uniqueId}getDebugLayer(e){return new a.GameStateDebugLayer((0,d.regionBasedAdapter)({getValue:(t,i)=>{const s=x(t,i,e);if(!s)return;const n=this.getComponents(s),o=this.get(t,s);return(0,h.formatNumber)(o)+"\n="+`${(0,h.formatNumber)(n.base)} * D${(100*n.diplomacy).toFixed()}`},getDetail:(t,i)=>{const s=x(t,i,e);if(!s)return;const n=g.inject.gameStateModel.regions.byId(i),o=this.getComponents(s);return`${o.factorsByRegion.map((e=>`#${e.regionId}: ${e.safeAssets.toFixed(0)}/${e.totalAssets} * F${(0,h.formatNumber)(e.forecast)} * P${(0,h.formatNumber)(e.power)} * ET${(0,h.formatNumber)(e.expansionTargetMultiplier)} = ${(0,h.formatNumber)(e.score)}`)).join("\n")}\n                    \nfaction forecast: ${(0,h.formatNumber)(o.forecast)}                    \nlocal forecast: ${n?.forecast}\nlocal power: ${p.AssetValue.total(u.AI.getRegionAssetsValue(g.inject.currentGameState,i))}\noffensive action required: ${s.context.isOffensiveActionRequired()}\ngame ending threat: ${m.AIMetrics.getObviousGameEndingThreat(n,s.views.threatAssessment)}\npersonality shift: \n  expansion ${n?.faction?.basePersonality.daring.toFixed(2)} => ${s.context.aiPersonality.daring.toFixed(2)}\n  disruption ${n?.faction?.basePersonality.combative.toFixed(2)} => ${s.context.aiPersonality.combative.toFixed(2)}`}}))}}function x(e,t,i){let s,n;if(i?.region.id===t)s=i,n=(0,r.createAiViews)(i);else{const i=l.Regions.model(e).byId(t);if(!i)return;s=new c.RegionAIContext(i),n=(0,r.createAiViews)(s)}return{views:n,context:s}}t.SituationScoreByRegionView=S},27109:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelsCache=void 0;const s=i(75136),n=i(20026);t.ModelsCache=class{constructor(e){this.factory=e,this.cache=new WeakMap}get(e){if(!(e instanceof s.StateEngine)){const t=(0,n.getParentEngine)(e);t.currentState===e&&(e=t)}let t=this.cache.get(e);return t||(t=this.factory(e),this.cache.set(e,t)),t}}},27126:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PreloadScene=void 0;const s=i(81700),n=i(36868),o=i(4440),a=i(25e3),r=i(91622),l=i(54825),c=i(56824),d=i(76049);class h extends o.Scene{constructor(){super({key:s.Scenes.Preload})}preload(){}update(){}create(){if(this.load.spritesheet("coin","assets/img/coin-animated.png",{frameWidth:20,frameHeight:18}),this.load.spritesheet("coin-hd","assets/img/coin-animated-hd.png",{frameWidth:20,frameHeight:18}),this.load.spritesheet("flag","assets/img/flag-animated.png",{frameWidth:24,frameHeight:22}),this.load.multiatlas("atlas","assets/atlas.json","assets"),this.load.bitmapFont("debug","assets/fonts/debug.png","assets/fonts/debug.xml"),this.load.html("login-buttons","assets/html/login-buttons.html"),this.load.html("json-editor","assets/html/json-editor.html"),l.app.audio.load(this),l.app.fonts.load(this),this.dataFetchPromise=Promise.all([r.inject.userData.initialize().then((()=>r.inject.theme.initialize())).catch((e=>this.handleFatalLoadingError(e))),r.inject.mapRegistry.initialize().catch((e=>this.handleFatalLoadingError(e))),r.inject.userContent.initialize().catch((e=>c.errors.handleNonFatalError(e,"userContent.initialize"))),(0,d.loadVectorFonts)()]),this.game.renderer.type===Phaser.CANVAS)return c.errors.handleException(new Error("Canvas renderer detected")),void setLoadingStatus("Your browser/device does not seem to support WebGL, which is required to run this game. Sorry!");this.load.once(Phaser.Loader.Events.COMPLETE,(async()=>{this.anims.create({key:"wave-flag",frames:this.anims.generateFrameNumbers("flag",{frames:[0,1,2,3,4,5,6,7]}),frameRate:20,repeat:-1}),await this.dataFetchPromise,this.sanityCheck()?(c.errors.gameRunning=!0,setLoadingStatus("",!1),a.NewsBox.show(),c.events.trigger(n.SystemEvents.EngineInitialized()),this.scene.stop(),setTimeout((()=>window.document.getElementById("phaser-game")?.classList?.remove("hidden")),100)):this.game.destroy(!0)})),this.load.start()}handleFatalLoadingError(e){c.errors.handleException(e),this.failedToLoadLevelData=!0}sanityCheck(){return this.verifyTexturesLoaded()?l.app.appController.initialized?!this.failedToLoadLevelData||(c.errors.handleException(new Error("Failed to load level data")),!1):(c.errors.handleException(new Error("AppController did not start")),!1):(c.errors.handleException(new Error("Failed to load textures")),!1)}verifyTexturesLoaded(){return void 0!==this.textures.getFrame("atlas","logos/game-title")}}t.PreloadScene=h},27235:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoxButton=void 0;const s=i(22663),n=i(21941),o=i(83176),a=i(86545),r=i(18957);class l extends a.ResponsiveContainer{set buttonState(e){this._state=e,this.onStateChanged.fire(e),this.preUpdate.makeDirty()}constructor(e,t){super(e),this.props=t,this._state=s.ButtonState.Rest,this.onStateChanged=(0,r.signal)(),this.raisedPx=t.raised??0,this.content=this.props.content,this.setSize(t.width,t.height),this.box=new n.Box(this.scene,t.baseTexture,0,0,t.width,t.height),this.add(this.box),t.tint&&this.box.setTint(t.tint),this.add(this.content),this.setInteractiveAuto(),this.setController((0,o.setupController)(t)),this.updateLayout()}get buttonState(){return this._state}setEnabled(e){this.controller.setEnabled(e)}get onClicked(){return this.controller.onClicked}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.buttonState=e)))}setTint(e){return this.props.tint=e,this.box.setTint(e),this}updateLayout(){if(super.updateLayout(),!this.active)return;const e=this.buttonState===s.ButtonState.Down?this.raisedPx:0,t=this.buttonState===s.ButtonState.Down?this.raisedPx:0;this.content.setPosition(e,t),this.content.width=this.width,this.content.height=this.height,this.box.setSize(this.width,this.height),this.box.setFrameFrom(this.props.downTexture&&this.buttonState===s.ButtonState.Down?this.props.downTexture:this.props.baseTexture)}}t.BoxButton=l},27387:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalDialogUIProvider=void 0;const s=i(5365),n=i(2543),o=i(63032),a=i(4440),r=i(36868),l=i(56824),c=i(9292),d=26,h=70,u=80;t.ModalDialogUIProvider=class{constructor(e){this.contentProvider=e,this.onClose=n.noop}getContent(e,t,i){this.props=t,t.onClose&&(this.onClose=t.onClose),this.plate&&(this.plate.remove(this.plate.content),this.plate.destroy(),this.plate=void 0);const s=this.contentProvider.getContent(e,t,this.toContentMaxSize(i)),n=this.contentProvider.getButtons(t);if(this.plate||(this.plate=new o.ModalDialogContentLayout(e,{content:s,buttons:n,onClicked:e=>this.handleClose(e)})),this.plate.setMaxWidth(i.width),this.primaryButton=n.find((e=>e.role===o.DialogButtonRole.PrimaryDanger||e.role===o.DialogButtonRole.PrimaryGreen))?.text,!this.keys){const t=e.input.keyboard.addKey(a.Input.Keyboard.KeyCodes.ENTER).on("down",(()=>l.events.trigger(r.UserActions.SubmitForm()))),i=e.input.keyboard.addKey(a.Input.Keyboard.KeyCodes.SPACE).on("down",(()=>l.events.trigger(r.UserActions.SubmitForm()))),s=e.input.keyboard.addKey(a.Input.Keyboard.KeyCodes.ESC).on("down",(()=>l.events.trigger(r.UserActions.Cancel())));this.keys=[t,i,s]}return this.plate}handleSubmit(){this.primaryButton&&this.handleClose(this.primaryButton)}toContentMaxSize(e){return{width:(0,c.pickLarger)(100,e.width-2*d),height:(0,c.pickLarger)(100,e.height-h-u)}}handleCancel(){this.props.canCancel&&this.handleClose(s.DialogButtons.Cancel)}handleClose(e){this.keys.forEach((e=>e.enabled=!1)),this.contentProvider.onBeforeClose&&!this.contentProvider.onBeforeClose(e)||this.onClose(e)}getTitle(e){return this.contentProvider.getTitle(e)}onShown(){this.contentProvider.onShown?.()}}},27441:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MockMapRegistryDataSource=void 0;const s=i(91622);t.MockMapRegistryDataSource=class{constructor(e={levels:{},expeditions:[]}){this.mockData=e}async setData(e){this.mockData=e,await s.inject.mapRegistry.reload()}async fetchContent(){return this.mockData}}},27654:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EconomySim=void 0;const s=i(56824),n=i(9292);s.logger.for("EconomySim");class o{constructor(e){this.turnsSimulated=0,this.state=e}simulateTurn(e){++this.turnsSimulated;const t=2*this.state.fortification+4*this.state.unitCount,i=Math.ceil((0,n.pickLarger)(this.state.regionSize-t,0)*(.2*(1-e))),s=this.state.netIncome-i,o={regionSize:this.state.regionSize-i,netIncome:this.state.netIncome-i,treasury:this.state.treasury+s,unitCount:this.state.unitCount,fortification:this.state.fortification,bankrupt:!1};o.treasury<0&&(o.unitCount=0,o.treasury=0,o.netIncome=0,o.bankrupt=!0);const a=(0,n.pickSmaller)(Math.floor(o.treasury/10),Math.floor(o.netIncome/2));a>0&&(o.unitCount+=a,o.netIncome-=2*a,o.treasury-=10*a);const r=Math.ceil(o.unitCount*e);o.netIncome+=r,o.regionSize+=r,this.state=o}simulateTurns(e,t=.5){for(let i=0;i<e;++i)this.simulateTurn(t)}getState(){return this.state}getScore(){return this.state.netIncome+5*this.state.unitCount+3*Math.floor(this.state.treasury/10)}static fromRegion(e){return this.fromRegionAssets(e.getMyAssets())}static fromRegionAssets(e){return new o({regionSize:e.regionSize,unitCount:e.totalUnits.count(),netIncome:e.remainingIncome,treasury:e.remainingGold,fortification:e.fortification,bankrupt:!1})}}t.EconomySim=o},27700:(e,t)=>{"use strict";var i,s,n,o,a,r;Object.defineProperty(t,"__esModule",{value:!0}),t.PlayUILayers=t.ShoppingTrayStyle=t.DEFAULT_PLAY_UI_STATE=t.SpectatingContext=t.BuyablePawnMode=t.PrimaryButton=t.PlayUIMode=void 0,function(e){e.Standby="standby",e.OwnedRegionSelected="owned-region-selected",e.HostileRegionSelected="hostile-region-selected",e.Spectating="spectating",e.Hidden="hidden",e.Rewind="rewind"}(i||(t.PlayUIMode=i={})),function(e){e.None="none",e.EndTurn="end-turn",e.NextRegion="next-region"}(s||(t.PrimaryButton=s={})),function(e){e.Available="available",e.Unaffordable="unaffordable"}(n||(t.BuyablePawnMode=n={})),function(e){e.Live="live",e.LiveReplay="live-replay",e.ReplayOnly="replay",e.Rewind="rewind"}(o||(t.SpectatingContext=o={})),t.DEFAULT_PLAY_UI_STATE={visible:!1,layout:{name:"hidden"},levelInfo:{name:"Unknown Island",features:[],difficulty:"normal",isFixedDifficulty:!0,icon:"expedition-icons/conquest"},powerBalance:[],turnNumber:1,livesLeft:0,worldMapPanel:null,tutorialArrow:null,tutorialFrame:null},function(e){e.Simple="simple",e.Elaborate="elaborate"}(a||(t.ShoppingTrayStyle=a={})),function(e){e[e.Background=0]="Background",e[e.MainPanel=1]="MainPanel",e[e.Pawns=2]="Pawns"}(r||(t.PlayUILayers=r={}))},28104:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.chunksDebugLayer=function(){return new s.GameStateDebugLayer((0,n.hexBasedAdapter)({getDetail(e,t){const i=o.app.scene.worldMap.chunkedRenderer.getByHex((0,a.getHex)(t));return`CHUNK ${i.id}\nVisible: ${i.visible}\nHas ${i.group.getChildren().length} children`},getValue:(e,t)=>o.app.scene.worldMap.chunkedRenderer.getByHex((0,a.getHex)(t)).id.toString()}))};const s=i(76439),n=i(12543),o=i(54825),a=i(45664)},28250:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Cooldown=void 0;const s=i(18957);t.Cooldown=class{constructor(e){this.delay=e,this.onFinished=(0,s.signal)(),this.currentTimer=void 0}start(e=this.delay){this.currentTimer&&clearTimeout(this.currentTimer),this.currentTimer=setTimeout((()=>{this.onFinished.fire(),this.currentTimer=void 0}),e)}isRunning(){return!!this.currentTimer}finishEarly(){this.currentTimer&&(this.cancel(),this.onFinished.fire())}cancel(){this.currentTimer&&clearTimeout(this.currentTimer),this.currentTimer=void 0}}},28304:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Cheats=t.PlayScreen=void 0;const s=i(81700),n=i(95568),o=i(36868),a=i(86148),r=i(5833),l=i(71021),c=i(80778),d=i(66313),h=i(5365),u=i(66143),p=i(56824),g=i(98963),m=i(49796),y=i(77563),f=i(51496),w=i(66825),v=i(97869),b=i(45664),S=i(11466),x=i(91622),T=i(54825),P=i(18811),I=i(1565),C=i(97849),M=i(551),A=i(27700),B=i(79694),E=i(79465),O=i(45084),R=i(30484),k=i(43046),L=i(47269),_=i(99816),D=i(95428),H=i(30963),j=i(12167),F=i(16007),U=i(53360),G=i(80075),N=i(73875),V=i(68878);p.logger.for("PlayScreen");class W extends n.BaseScreen{get isReplay(){return this.context===l.NewGameStateContext.LoadReplay}get currentMode(){return T.app.scene.play.mode}get isPlayMenuOpen(){return T.app.scene.playMenuUI.currentState().open}get selectedRegion(){const e=x.inject.levelSession.selectedRegionId;if(void 0!==e)return x.inject.gameStateModel.regions.byId(e)}constructor(){function e(){return!T.app.scene.play.mode.canSwitchRegion()&&(T.app.audio.playEffect(g.SoundEffects.Deny),!0)}super("Play",[s.Scenes.BackgroundUI,s.Scenes.Play,s.Scenes.PlayUI,s.Scenes.WorldMap,s.Scenes.PlayMenuUI]),this.worldMapPanelController=new L.WorldMapPanelController,this.observe.event(o.UserActions.GoBack,(async()=>{this.isPlayMenuOpen?p.events.trigger(o.UserActions.ExitLevel()):p.events.trigger(o.UserActions.TogglePlayMenu())})),this.observe.event(o.UserActions.ExitLevel,(async()=>{if(this.context===l.NewGameStateContext.ContinueSpectatingAfterGameOver)return T.app.scene.play.skipToCurrentState(l.NewGameStateContext.Preview),void T.app.navigator.goTo(T.app.screen.defeat,{returning:!0});if(this.isReplay)return void T.app.navigator.goTo(T.app.screen.myLibrary,void 0);let e;x.inject.gameStateModel.currentPhase.isLocalPlayerTurn()&&void 0===x.inject.levelSession.outcome&&x.inject.levelSession.saveLevelProgress(),x.inject.levelSession.active&&(e=x.inject.levelSession.data?.origin,x.inject.levelSession.end({origin:"play/leave",wipeAutoSave:!1})),await(0,c.returnToMenuFromGame)(e)})),this.observe.event(o.UserActions.ToggleLedger,(()=>{const e=T.app.scene.playUI.currentState;"play"===e.layout.name&&T.app.scene.playUI.updateState({layout:{...e.layout,showRegionBudget:!e.layout.showRegionBudget}})})),this.observe.event(o.UserActions.Escape,(async()=>{this.currentMode.handleAbort()})),this.observe.event(o.UserActions.Cancel,(async()=>{T.app.scene.playUI.activeUI.closeRollbackPanel()})),this.observe.event(o.UserActions.Undo,(()=>{x.inject.gameStateController.undo()})),this.observe.event(o.UserActions.UndoAll,(()=>{x.inject.gameStateController.undoAll()})),this.observe.event(o.UserActions.StartRewind,(()=>{(0,G.canRewind)()?(T.app.scene.play.setMode(new M.RewindMode(T.app.scene.play)),T.app.audio.playEffect(g.SoundEffects.Rewind),this.closePlayMenu()):T.app.audio.playEffect(g.SoundEffects.Deny)})),this.observe.event(o.UserActions.ConfirmRewind,(()=>{const e=T.app.scene.play.cursor.currentState,t=x.inject.currentGameState,i=(0,E.getLivesAdjustmentAfterRewind)(t,e),s=(0,E.getTurnDelta)(t,e),n=O.CurrentPhase.getTurnNumber(e);switch(x.inject.gameStateController.rewindTo(T.app.scene.play.cursor),this.context=l.NewGameStateContext.ResumingGame,T.app.scene.play.setMode(new B.PlayMode(T.app.scene.play)),x.inject.ui.regionsLedger.reset(e),x.inject.levelSession.selectedRegionId&&x.inject.ui.regionsLedger.regionVisited(x.inject.levelSession.selectedRegionId),i){case"refill":x.inject.levelSession.startNew({levelId:x.inject.levelSession.levelId,origin:"play/rewind-to-start",turnNumber:n,aiDifficulty:x.inject.levelSession.aiDifficulty,startingState:u.LevelModel.for(x.inject.levelSession.levelId).getStartingState()??x.inject.gameStateModel.exportState()}),T.app.scene.playUI.updateState({livesLeft:x.inject.levelSession.remainingLives});break;case"burn-one":setTimeout((()=>{x.inject.levelSession.burnLife(),T.app.scene.playUI.activeUI.burnLife(),p.events.trigger(o.UiEvents.RewindConfirmed({turns:s,targetTurn:n}))}),200)}x.inject.levelSession.saveLevelProgress(),T.app.scene.globalUI.notifications.clearToastsByCategory(I.NotificationCategory.SurrenderOffer)})),this.observe.event(o.UserActions.ViewReplay,(()=>{f.track.interaction("view_replay"),this.closePlayMenu();const e=T.app.scene.play.cursor,t=x.inject.gameStateModel.factions.all().find((e=>e.isLocalPlayer()));C.assert.defined(t),T.app.scene.play.setMode(new v.SpectatorMode(T.app.scene.play,A.SpectatingContext.LiveReplay)),(0,U.isAISpectatingMode)()?e.goTo(0):e.move(k.Move.seekBackTag("turnStart",t.id),k.Move.stepBack,k.Move.seekBackTag("turnStart",t.id),k.Move.stepForward,k.Move.seekForwardTag("turnStart")),T.app.scene.worldMap.syncState(e.currentState,R.OverlayModes.spectating()),T.app.scene.play.mode.processEvents(e)})),this.observe.event(o.UserActions.RestartLevel,(async({skipConfirmation:e})=>{const t=x.inject.levelSession.levelId,{result:i,aiDifficulty:s}=e?{result:h.DialogButtons.Restart}:await T.app.modals.confirmRestart(t);i===h.DialogButtons.Restart&&(this.closePlayMenu(),p.events.trigger(o.UiEvents.RestartConfirmed({aiDifficulty:s})),T.app.audio.playEffect(g.SoundEffects.Rewind))})),this.observe.event(o.UserActions.AcceptSurrender,(async()=>{f.track.interaction("accept_surrender"),x.inject.gameStateController.executePlay(o.Plays.AcceptSurrender())})),this.observe.event(o.SystemEvents.ShowGameOverScreen,(async e=>{e!==P.LevelOutcome.Victory||x.inject.levelSession.outcome===P.LevelOutcome.Victory||"victory/play-again"===x.inject.levelSession.data?.origin||x.inject.userData.getLevelVictoryRecordById(x.inject.levelSession.levelId)||p.events.trigger(o.SystemEvents.LevelCompleted({levelId:x.inject.levelSession.levelId,newRecord:{difficulty:x.inject.levelSession.aiDifficulty,turns:x.inject.gameStateModel.currentPhase.turnNumber}})),x.inject.userData.saveLevelOutcome(e),x.inject.levelSession.setOutcome(e),(0,V.isPlayingEditorLevel)()&&x.inject.editorSession.savePlayTestResult(e),e===P.LevelOutcome.Victory?T.app.navigator.goTo(T.app.screen.victory):T.app.navigator.goTo(T.app.screen.defeat,{returning:!1})})),this.observe.event(o.UserActions.DeselectRegion,(()=>{this.selectRegion(void 0,{panCamera:!1,clickEffect:!1})})),this.observe.event(o.UserActions.SelectNextRegion,(()=>{if(e())return;const t=x.inject.ui.regionsLedger.getNext(x.inject.levelSession.selectedRegionId);this.selectRegion(t,{panCamera:!0,clickEffect:!0})})),this.observe.event(o.UserActions.SelectPreviousRegion,(()=>{if(e())return;const t=x.inject.ui.regionsLedger.getPrevious(x.inject.levelSession.selectedRegionId);this.selectRegion(t,{panCamera:!0,clickEffect:!0})})),this.observe.event(o.UserActions.SelectNextPendingRegion,(()=>{if(e())return;const t=x.inject.ui.regionsLedger.getNextPendingRegionId();this.selectRegion(t,{clickEffect:!1,panCamera:!0})})),this.observe.event(o.UserActions.SetSpectatingPlayBackSpeed,(e=>{this.currentMode instanceof v.SpectatorMode&&(0,v.updateTransitionSpeedForSpectatorMode)(e)})),this.observe.event(o.WorldMapEvents.StartInteraction,(e=>{const i=e.hexId&&(0,b.getHex)(e.hexId);i&&p.config.debug.cheats&&(e.flags&o.PointerEventFlags.MiddleButton||e.flags&o.PointerEventFlags.Ctrl)?t.Cheats.toggleTapped(i):(T.app.device.uiVariant()!==S.UiVariant.Compact&&T.app.scene.playUI.activeUI.closeRollbackPanel(),e.flags&o.PointerEventFlags.RightButton&&this.currentMode.canReturnPawn()?p.events.trigger(o.UserActions.ReturnHeldPawn()):this.currentMode.handleStartInteraction((0,b.getHex)(e.hexId),e.flags))})),this.observe.event(o.WorldMapEvents.CompleteInteraction,(e=>{e.flags&o.PointerEventFlags.RightButton||this.currentMode.handleCompleteInteraction((0,b.getHex)(e.hexId),e.flags)})),this.observe.event(o.WorldMapEvents.StartDrag,(e=>{e.hexId?this.currentMode.handleStartDrag((0,b.getHex)(e.hexId)):T.app.scene.worldMap.cameraController.startDragScroll()})),this.observe.event(o.WorldMapEvents.EndDrag,(e=>{this.currentMode.handleEndDrag((0,b.getHex)(e.hexId))})),this.observe.event(o.UserActions.BuyablePawnPointerDown,(e=>{T.app.scene.playUI.canBuyPawn(e)?this.currentMode.handlePawnInShopPointerDown(e):T.app.audio.playEffect(g.SoundEffects.Deny)})),this.observe.event(o.UserActions.BuyablePawnPointerUp,(e=>{T.app.scene.playUI.canBuyPawn(e)&&this.currentMode.handlePawnInShopPointerUp(e)})),this.observe.event(o.UserActions.ShopAreaPointerUp,(e=>{this.currentMode.handleShopAreaPointerUp()})),this.observe.event(o.UserActions.ReturnHeldPawn,(()=>{this.currentMode.handleReturnPawn()})),this.observe.event(o.GameStateEvents.NewGameState,(({context:e})=>{e!==l.NewGameStateContext.LoadReplay&&e!==l.NewGameStateContext.Rewind&&e!==l.NewGameStateContext.Preview&&T.app.scene.play.skipToCurrentState(e)})),this.observe.event(o.UserActions.EndTurn,(async({force:e})=>{if(!this.currentMode.canEndTurn())return void p.events.trigger(o.UserActions.Escape());p.config.autoSaveOnTurnEnd&&x.inject.levelSession.saveLevelProgress();const t=x.inject.gameStateModel.currentPhase.faction?.getRegions().filter((e=>e.isActionable()));!e&&x.inject.gameStateController.isOnTurnStart()&&t?.length&&await T.app.modals.confirmEndTurn()!==h.DialogButtons.EndTurn||(T.app.scene.globalUI.notifications.clearToasts(I.NotificationScope.Level),x.inject.gameStateModel.map.script||T.app.scene.playUI.updateState({worldMapPanel:null}),this.currentMode.handleEndTurn())})),this.observe.watch(x.inject.ui.hexUnderCursor,(e=>{try{this.currentMode.handleNewHexUnderCursor(e)}catch(e){p.errors.handleNonFatalError(e,"handleNewHexUnderCursor")}})),this.observe.event(o.UserActions.SkipSpectating,(()=>{this.currentMode.handleSkipSpectating(),T.app.scene.playUI.updateSpectatingLayout({enableSkipSpectating:!1})})),this.observe.event(o.UserActions.ExitSpectatingMode,(({returnTo:e})=>{if(this.context!==l.NewGameStateContext.ContinueSpectatingAfterGameOver)switch(e){case"defeatScreen":T.app.navigator.goTo(T.app.screen.defeat,{returning:!0});break;case"victoryScreen":T.app.navigator.goTo(T.app.screen.victory);break;case"menu":T.app.navigator.goTo(T.app.screen.title)}else T.app.navigator.goTo(T.app.screen.defeat,{returning:!0})})),this.observe.event(o.UserActions.DownloadReplay,(()=>{const e=x.inject.gameStateController.history.export({snapshotPolicy:(0,V.isViewingReplay)()?["preserve"]:["initial","p1-start","final"],includeRewinds:!1,sizeLimit:1e5,remainingLives:x.inject.levelSession.remainingLives});(0,N.downloadReplay)(e)})),this.observe.event(o.UserActions.ResetZoom,(()=>{T.app.scene.worldMap.cameraController.zoomController.zoomTo(H.DEFAULT_CAMERA_ZOOM,"fast")})),this.observe.event(o.UserActions.WorldMapPanelButtonClicked,(e=>{if("readFullIntro"===e&&x.inject.gameStateModel.map.introduction){const e=u.LevelModel.for(x.inject.gameStateModel.map.levelId);T.app.modals.showIntro(e.getTitle(u.LevelTitleStyle.Full),x.inject.gameStateModel.map.introduction)}})),this.observe.event(o.UserActions.TogglePlayMenu,(()=>{const e=T.app.scene.play.mode;if(e instanceof v.SpectatorMode&&e.isSkipping())return;if(this.isReplay)return void p.events.trigger(o.UserActions.ExitLevel());const t=!this.isPlayMenuOpen;t?(this.selectRegion(void 0),T.app.scene.playMenuUI.updateContent(),T.app.scene.playUI.updateState({visible:!1}),T.app.scene.play.mode instanceof v.SpectatorMode&&p.events.trigger(o.UserActions.SetSpectatingPlayBackSpeed(F.SpectatingPlaybackSpeed.Paused))):this.closePlayMenu(),T.app.scene.playMenuUI.currentState.update({open:t}),T.app.scene.globalUI.updateLayout()})),this.observe.event(o.WorldMapEvents.CompleteInteraction,(()=>{this.isPlayMenuOpen&&p.events.trigger(o.UserActions.TogglePlayMenu())})),this.observe.event(o.UserActions.SetShowBudgetNumbers,(e=>{setTimeout((()=>{T.app.scene.worldMap.overlays.update(T.app.getCurrentGameStateModel().state)}),1)}))}closePlayMenu(){this.isPlayMenuOpen&&(T.app.scene.playMenuUI.currentState.update({open:!1}),T.app.scene.playUI.updateState({visible:!0}),T.app.scene.play.mode instanceof v.SpectatorMode&&p.events.trigger(o.UserActions.SetSpectatingPlayBackSpeed(x.inject.userData.recallChoice("spectatingSpeed"))),T.app.scene.globalUI.updateLayout())}async activate(e){this.context=e;const t=T.app.scene.play,i=x.inject.gameStateModel.map.levelId;x.inject.ui.selectedLevelId.set(i),x.inject.ui.regionsLedger.reset(x.inject.gameStateModel.state);const s=u.LevelModel.for(i);if(T.app.scene.playMenuUI.currentState.update({open:e.showPlayMenu},"instant"),e===l.NewGameStateContext.ViewReplayAfterGameOver){const e=T.app.scene.play.cursor;return e.goTo(0),T.app.scene.worldMap.setMode(new a.InteractiveMode),T.app.scene.worldMap.syncState(e.currentState,R.OverlayModes.spectating()),T.app.scene.play.setMode(new v.SpectatorMode(T.app.scene.play,A.SpectatingContext.LiveReplay)),void T.app.scene.play.mode.processEvents(e)}if(e===l.NewGameStateContext.ContinueSpectatingAfterGameOver)return T.app.worldNews.clear(),T.app.scene.worldMap.setMode(new a.InteractiveMode),T.app.scene.play.setMode(new v.SpectatorMode(T.app.scene.play,A.SpectatingContext.Live)),void T.app.scene.play.mode.processEvents(T.app.scene.play.cursor);if(e===l.NewGameStateContext.LoadReplay){const e=T.app.scene.play.cursor;e.goTo(0),T.app.scene.worldMap.setMode(new a.InteractiveMode),T.app.scene.worldMap.syncState(e.currentState,R.OverlayModes.spectating()),T.app.scene.play.setMode(new v.SpectatorMode(T.app.scene.play,A.SpectatingContext.ReplayOnly)),T.app.scene.play.gameEventQueue.clear(),T.app.scene.play.mode.processEvents(e);const t=u.LevelModel.for(x.inject.gameStateModel.map.levelId);return void T.app.scene.playUI.updateState({levelInfo:{name:t.name,isFixedDifficulty:Boolean(t.manifest?.fixedAIDifficulty),difficulty:x.inject.gameStateController.history.metadata?.aiDifficulty||"hard",icon:t.getIcon(),features:t.getFeatures({includeIsNew:!1})},worldMapPanel:null,tutorialFrame:null,tutorialArrow:null})}T.app.scene.playUI.updateState({visible:!0,levelInfo:{name:s.getTitle(u.LevelTitleStyle.Full)+(this.isReplay?" (replay)":""),isFixedDifficulty:x.inject.levelSession.isFixedDifficulty,difficulty:x.inject.levelSession.isFixedDifficulty?"hard":x.inject.levelSession.aiDifficulty,features:s.getFeatures(),icon:s.getIcon()},tutorialArrow:null,tutorialFrame:null,worldMapPanel:null}),T.app.scene.worldMap.setMode(new a.InteractiveMode),t.skipToCurrentState(e);const n=x.inject.gameStateModel.map.script;if(n)x.inject.scriptRunner.setScript(n);else if(x.inject.gameStateModel.map.shortIntroduction&&e.showIntro&&x.inject.gameStateModel.currentPhase.turnNumber<=1){const e=x.inject.gameStateModel.map.shortIntroduction,t=x.inject.gameStateModel.map.introduction;T.app.scene.playUI.updateState({worldMapPanel:{type:"tutorial",emojiEmotion:D.EmojiEmotion.Happy,text:e,buttons:e.length!==t.length?[j.DIALOG_BUTTONS.readFullIntro]:[]}})}}deactivate(){T.app.scene.globalUI.hideFastForwardOverlay(),T.app.scene.play.setMode(new r.PassiveMode(T.app.scene.play)),T.app.scene.worldMap.endSession(),T.app.scene.globalUI.typeWriterSound.stop(),x.inject.scriptRunner.setScript(void 0)}async transitionIn(e){e===T.app.screen.title&&await T.app.scene.menuHeaderUI.waves.transitionOut(p.config.screenTransitionDuration),T.app.scene.playUI.updateState({visible:!0}),T.app.scene.worldMap.cameraController.center(p.config.screenTransitionDuration,{zoom:H.DEFAULT_CAMERA_ZOOM})}async transitionOut(e){switch(e){case T.app.screen.overworld:return await(0,_.playScreenToOverworldTransition)();case T.app.screen.victory:return await(0,d.victoryTransition)();case T.app.screen.defeat:return await(0,w.defeatTransition)();default:T.app.scene.playMenuUI.transitionOut(),T.app.scene.playUI.updateState({visible:!1})}}selectRegion(e,t={panCamera:!1,clickEffect:!0}){const i=x.inject.levelSession.selectedRegionId;x.inject.levelSession.setSelectedRegionId(e),void 0!==e&&x.inject.ui.regionsLedger.regionVisited(e);const s=void 0!==e&&x.inject.gameStateModel.regions.byId(e),n=e?x.inject.gameStateModel.regions.byId(e):void 0,a=i?x.inject.gameStateModel.regions.byId(i):void 0;if(n!==a&&this.currentMode.canReturnPawn()&&p.events.trigger(o.UserActions.ReturnHeldPawn()),n!==a&&T.app.scene.worldMap.overlays.set(x.inject.currentGameState,R.OverlayModes.playing({selectedRegionId:n?.id})),T.app.scene.playUI.updateFromGameState(),n&&n.isAlive()&&n.faction&&n.faction===x.inject.gameStateModel.currentPhase.faction&&y.WorldMapUpdater.setPawnsJumpingInRegion(n,!0),t.clickEffect&&s&&T.app.audio.playEffect(g.SoundEffects.ShutterClick),t.panCamera&&s){const e=(0,m.rectToPhaser)(s.hexes.getDisplayBoundingBox());T.app.scene.worldMap.cameraController.ensureRectVisible(e,{allowZoom:!1})}p.events.trigger(o.UiEvents.RegionSelected(e))}}t.PlayScreen=W,t.Cheats={toggleTapped(e){const t=x.inject.gameStateModel;let i=t.warfare.getOccupyingUnit(e);i&&(t.currentPhase.isTapped(i)?(t.currentPhase.unTapPawn(i),T.app.scene.worldMap.pawns.getById(i.id)?.startJumping()):(t.currentPhase.tapPawn(i),T.app.scene.worldMap.pawns.getById(i.id)?.stopJumping()))}}},28361:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BUILT_IN_MAPS=void 0,t.BUILT_IN_MAPS={titleScreenLevel:"konkrmap.v7.eyJtYXAiOnsibGV2ZWxJZCI6InRpdGxlU2NyZWVuTMQVIiwid2lkdGgiOjIwLCJoZWlnaHTGDHRoZW1lIjoiZGVmYXVsdCJ9LCJ2ZXJzaW9uIjo3LCJyZWdpb25zIjpbeyJpZCI6MSwibmHFMWtpbmdkb20ixE94ZcQiNjEwLDYxMSw2MTIsNjEzXX0sxjQy2zQxNTA0LDE1MDXEBTfEBTgsMTbGFDnECjXEBTfEBTgsMTLEDzPGBTYsMTTEKDTEDzTEDzUwynQ03HQzMTIsMTMxMywxNMQKNTEwxAUxxAUyLDEyxA8yxA8yxigxyVY121Y3MDUsNzA2LOQAzDUwNizkAMXkAL82MDbJQDfcQDEyLDcxMyw4MTIsODEzLDnFDDEsODEwLDfrAIQ420Q5MDYsOTA3LDkwOCw55AFAMOQBGDDkAUAw5AFAMeQBLDDEGTHEGTHEGTHGGTnkAV42xAU3yWsx/AG6NTE2LDUxNyw2MeoA4DH8AOE4MDQsOcUE5QCFM8QFNMk7MvwCWjExxC8x5AHvMsYF6wJeM9w5M8Q5M8xo/QIaMeQB9zExMMov/ADSMTfkAUE35AFBOMQKODA4yjn8Aag4MDgsODA5LDnMajndMTUsOOsCSTT8AS43y1Y0/AEeNzE0LDcxNcot/AEc5ADs5ADrNzA5LDjrAiU0/AMVMTAwy1822yo07AO9/AF1OeYCOjLKLvwBajE17AE2/AFjMTTrANU1MNwqMuQDLjPrAWY1/QK9M8RZXSwiZmFjdO0FTcplbmF0dXJlIucFj0luZGV4xR9jb250cm9sbGVyxCVvbsQj6gWT5ASjLDQ0LDQ1LDQ2LDQ3LDQ4LDQ5LDUwLDLqAU3qAJtQbGF5ZXIgMSLPWGxvY2FsLXVzZXLyAIHKbTIsNDMsMeoBI+oEHMdYMtBYYWnPUDHMUDQsNDEsNeoE2OoCqcdQM99Q5QCDylAyNywy6gN/6gLKx040307lAIHKTjUsMjEsMuoEN+oC5cdQNd9Q5QCDylA3LDI5yU3qAwjHTTbfTeUAgMpN6gDnLeoB3v8CQ/cCQ+UCmXBhd+4H43R5cMRTdG93buYCySI65AepyHYy1SI2MDXIITPWQzMxMsgiNNYiMjA3yCI11SI5MTPIITbJIWNhc3Rs5ADYxkU1MMkkN9gkNOoAizjLJG1wyCI2MTDIITHkCSfSIuQGXMkj6gE1Y29pbnPJJOQI3yJjb3VudMRIyS/qAULOLzIwN9Qv6gFQzi/kCMnTL+oBXc0v5AhS0y7qAWnNLuQIvMgu6QEsMeoBdWZvcmVzdMku6gGY5AgF1yTKSOoBddAkMckkOdckNTE2yCTlCsLUJDcwOckk6gGc0CQ4ySTqAZHQJOkCkeQIadUkOMsk6gF7ziTkBwnJJeoBcs4lNOoCUTL4AWnkBvvJJfgBajnLSfgBauQJFskl+AFr5Ac/yCUz+AFs5Ac6ySX4AW3kBzDJJfgBbuQHWskl6gFLcGlrZW1h6gQmNOsEauoBA2tu5QzWyCUx6wCV6gEEdmlsbGFn5QbqxSc46gJwM+oBBdAm5AwPyCc06gEH0Cc36gCY5Amh1yY5MDnkBXVydWxlU2V06w17LCJjdXJyZW50UGhhc2XkDdF0dXJuTnVtYuQFvDHpCEHsBaPHEy3EKuQF/GFwcGVkVW5pdOYF3X0=",benchmark:"konkrmap.v7.eyJtYXAiOnsid2lkdGgiOjIxLCJoZWlnaHQiOjI0LCJsZXZlbElkIjoibC1leHBhbnNpb24iLCJwbHVnaW5zIjpbXX0sInZlcsUYOjcsInJlZ2lvxRp7ImlkIjoxLCJuYW1lxEJhbmQixF94ZcQfMTgwOV19LMYmMskmU3VubWlsZcspNzA0LDYwOSw3MDUsNjEwLDcwNiw4MDMsNzA4LDgwNCw3xBwxMCw4xRg3LDgwOCw5MDQsODA5LDkwOSwxMTAsMTExLDIwOSwyMTAsMzExLDUwNCw1MDUsNDEwLDUwNiw0MTEsNsVoNSw1MTAsNjA2LDXFFDddLCJhdHRyaXTlAOJ7IjIiOjUsIjMiOjB96AC+M+kAvkdyYXlydeQBIugAvjQxNiw2xHLFCDIsNjE1LDfEWjE2LDcxMiw3MTMsOOQAvjExLDcxNiw4xRQ3LDjFGDQsODE1LDgxNiw5MTIsOTEzLDkxNSw5MTYsMTAxMsQFNOQA3DPEBTTwAKo0IjoxOOkApTTpAKVEZWVwdHVja2V07AGPNDA4LDE05AEw5AEZMeQBFjE1MDfEBTgsMeQBHTE1xB7kARsxNsQZNsQZ5AGWMeQBkznEE+QBlDnGFzksMTjEHOQBlzExMDMsMTDEIjHESeQBozEwxAUxxh43LDEyxCPFRTHEGTLEKMVLMcRLMsRLMzAxxBQ5xAoyxBQ3xAozxAo4xAo0xAXFKDbEBcUe5QDVNMQFNcQFNsQF8QHUNuwBzjXpASlMYWR5bGVkZ+wCjjEy5AF9M+QBfTPkAX0zMcRYxg83xAozxAXEccYZ5AFBxBQwMTHkAaXFBeQAvMQKMsYKNMQF5AC3MTHzAm00LCI1Ijox6gCgN+kAoEtpbmdiYW5r6wCfMuUC5uQC5zHkAtQx5ALNMeQCyjE1xG3kA0gx5ANFMeQClDHkApExNuQAnzbkAIbkA0Yx5AKdMeQCmjHkApsxN8QZ5AKhMTfkAKTkAqcx5AKcMeQCnTE5xBk5xBTkAqAx5AKhMjDEZDkxNCwyMDEwxAUzLDIxMTDzAp4yLOQBejHpANox6gQHUmljaHJheewA2jE0LDMxNekEMzE2yS1TYWdlaW5s7gLQNzAyyizqATREZWFkYnJh7ASK5AGlNDE4LDUxNyw1MTgsNjE3LDYxOCw3xQQ5LDjlA484LDkxNyw5MTgs5QICMDE2LDIxNyzkAfYzMTjKazjJa0FsZG9yZstpMTIwNskpMjDJKVF1aWV0d2lsbMssNzA3yivqBUVNYXNzd29v7QVJ5ACHMTMx5ALqxAU16wCOMuoEm0FnYXRlc2917QWFNTHqASXkBfDHLEhlYXJ0aGJyae4C/OQB1TEwMTPKM+oDLFdoaXRlcuUGOsox5AQiMzEwLOQEV+QETOQESzXsBffqAS1FYm9ud2XtAQMyMTHKKjnJKkJlbGx0b3duc2hpcMsuMctYM+oBXEJhbGR1cnPlBrbIK+QC1DfrAksz6gFgV2lsZHNoaW7sAPc4MMsr6gKjUHJpbmNlc3RlcHDMLjEy5AMeM+sBJjPqAYXkBFJob23NMOQF4jE4MeoCGjPqAVZIaWxsc2dhcuwBtDIxzFzqAtpSYXZlbu8EDzEyMOoBRDPqAW7kA19jcm9zc3Jv7QMLMTUwNMow6gF0Q2VkYXJqb+wDkDHkB2QyMMYFNcQF6gDCNOoBgFN0cmF0aHNoYXLuASYw5AXCMDAzXX1dLCJmYWPkBBfqCDbKQG5hdHVyxDp0aGVtZUluZGV4xR9jb250cm9sbGVyxCVv5QGx6gh8MzIsMSwzMywzNSwzNywzOCwzOSw0MCzlBO8s5AMvOCwyMCwyMSwyMywyNCwyNSwyOCwyOSwz5Agf5ASqcHByb3ZhbOQEqTEiOi00NTAwLOQFji0zMzYw5Qf/LTMxODAs5ATHLTE5OTDlBaYtMjc1MOUE1S3kBPPqBNnqAjVsYXllciAx/wDRbG9jYWwtdXNlcu0A1zLvAJsyIjoxNC43MDU5MzEyMDk2MjU3NzTlAJ42Mi4wMjE0NDQ4NzgxNjU1NOUAqjLmAKYx5QCjNekAn+sC1OYAnzLvAJ8x7wCfYWnuAW7yATI1Ny4xNDU0ODgxNTI4MOQD6OQBMzHmATAzMC4wMTI1MDc4MjIyODA5MeYG4y4wMDA0MTY5Mjc0MDkzNuQC2zYiOjbzCWfnAKcz7wCnMv4Ap+UJIe4ApzQwLjQyMDYzNTM5OTY55Qgg5QHm5AaKNCI6NC4xM80B5QCpMy4xNjXkB9Y4OTkxMTY3OeYAqTLzCWvnAKk07wCpM/4AqTXzAoIxNOcCgDIuNDQ1NTYyNzM5ODk3NTHlAVoyLjE1NzEyMjc5NDA1NzY5MzbnAeowLjcxNjk4NzYwMzk5MjQ35wCr8ADYM/MI/ucAvDXvALw0/gC85Qlc8AC85gFWNy40MTc2NjEzNjE4NjYwODblALs0Mi7kA1Q4NzkyNTE2OTU15QF6MTAuMzk2MDc4MDU0MzcxMeQEvOUDV+oDVeoIAOcAqjbvAKo1/gCq9ACpOOYBZTIwLjXvAfjlAr825ACH5QLCLuQJrssB5gFvODB95ATPcGF37g0CdHlw5ACoZm9yZXPnByDkB9Yx6wOB1SM3MDfIIzTXIzkxNMgjNdcj5AezyCQ22CQyMDbIJDEw1yU3ymzkAPLXJDXJJDfXJDQxOMkkONkk6QD7MTnXJDXKJOQH8tUk5AeKySX4ALXkB7TJJfgBauQJXskl+AFsNeoBsuQEwNUkN8tI+AD/OOoA2zQz1yQ5yyT5ALUwMekB2DT4ALU4MOkBtDT4AiEy6gH8NOoAteQJiMlr6wLR5AcG0yM4MDnJIuoBjM1FMcsj6gD5zSM1y2jqAPjMIzkxMski+AGG5BCAySX5AobLJPgChjMxMMgk5Agb1SQ1ykg2+AKFNTDpAhc2+AQRNssk+AIXNeoA/TbqAR9jYW3nCy7lA+3pAUI26gIVzSM16gKlNuoCFM0j6wDU6gFlzCIy6gKhNuoBYs4i6wSb6gFhY2/kEl3LJOQFynVudCI6yXM36gFrzS7kALnJLukC++QJqscudmlsbGFn5QlZxTE1MOkC2eQGkvcB4+kDITj5AlA3MOkBeDjqAO5iYW5kacolMOoEIDnqAeXPJTfqARU56gHm8AC5N+oAuTnqAejQJjXqBAAx5ArE1nI06wXaMMpzzyY26gJa5BHH9QGA5BN26AF/MuoGCzDrAiLML+URCcgw6gXyxEX2AIQz6gSs5BFJ1iY36wD1MeoC4c9LN+oESDHrBqzQcesG0esGrvABaDjqAY4x5A/b1yfkE2LKKOoAwHBpa2VtYeoE5DDrAJwy6gCczyc4zCbqAJzQTTHqBDYx5A9J+ACc6wReMeQI9PgBN+oCBuQKaPUB1+sCBuoBGOsG7s4uMjDqAgXqAbrkDkbVL+sEejHrBvrxAKjKeusG12Nhc3ToFmDkAbfqAPPrBtjtBOgz6wiv6waU8gIC6QO2MesGmNAn5BUkyijqAdvRKDTrAnnrBn3tBT8w6wm26wZZ7gVAMOQM1ugDk8ov+AE5MusDPe0Ft+wBODbqBvUx6wW58QDFMOsCLesFs9AoNMt0N+oAyNFPNuoFPzE3+QKiMusDjOQPENdOOcwn6wcH7AE95BTX6AE86gG3N+oCT/EDkuoCBeQNbdd75BdGyij3AnjrBz8xN/cHHcQl8wHd6wbwzi/rCTwxOPsBaTTMKPkCKjDrBY04+AVo7AM/6wc+ziXkES7JJfcEJ+wBEDj4ARDMbuQQWfcFEzTrAknrB2TPJ+wBpvsHZOQX9soo+QIc5BcVyif7Ah05MTDkDkdydWxlU2V0IjoiZGVmYXVs5AEtY3VycmVudFBoYXNl5A62dHVybk51bWLkDuHkAqvnE0rtDnbGEy3EK+QPImFwcGVkVW5pdOYbv30="}},28454:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.askForLevelFeedback=function(e){const t=new n.FeedbackForm(c.app.scene.globalUI);t.applyProps({mode:n.FeedbackFormMode.Minimal,title:"Thanks for playing! How did you like this level?",subtitle:"Your feedback matters!",email:l.inject.userData.recallChoice("feedbackEmail")??"",message:"",onSubmit:t=>h(i,e,t)});const i=c.app.scene.globalUI.notifications.addToast({category:s.NotificationCategory.FeedbackForm,style:s.NotificationStyle.Default,icon:new Phaser.GameObjects.Image(c.app.scene.globalUI,0,0,"atlas","ui/icons/please"),content:t,scope:s.NotificationScope.Level,onDismissed:()=>{l.inject.userData.rememberChoice("dismissedFeedbackForm",Date.now())}});return i},t.showFeedbackForm=function(){const e=l.inject.ui.selectedLevelId();if(!window.navigator.onLine)return c.app.notifications.warning("Feedback not available while offline.","Sorry, please try again when you are connected to the internet.\nSending feedback via messenger pigeons is not supported yet.");const t=new n.FeedbackForm(c.app.scene.globalUI);t.applyProps({mode:n.FeedbackFormMode.Full,email:l.inject.userData.recallChoice("feedbackEmail")??"",autoFocus:c.app.device.uiVariant()===r.UiVariant.Large,message:"",title:"Hi there!",subtitle:"\nI'm Mike, the developer behind this game, and I'd love to hear from you!\nBug reports, improvement ideas, or just a simple thank you, all feedback is much appreciated.\n",onSubmit:t=>h(i,e,t)});const i=c.app.scene.globalUI.notifications.addToast({style:s.NotificationStyle.Default,icon:new Phaser.GameObjects.Image(c.app.scene.globalUI,0,0,"atlas","ui/icons/please"),content:t,scope:s.NotificationScope.Global,cancelTimeoutOnHover:!0,onDismissed:()=>{a.track.ui.dismissFeedbackForm()}});return i};const s=i(1565),n=i(93102),o=i(76816),a=i(51496),r=i(11466),l=i(91622),c=i(54825),d=i(56824);function h(e,t,i){e.clickable=!0,e.icon.setFrame("ui/icons/heart"),e.preUpdate.makeDirty(),l.inject.userData.rememberChoice("feedbackEmail",i.email),l.inject.userData.saveFeedback({levelId:t,mood:i.mood,comment:i.comment,screen:c.app.navigator.currentScreen?.name??"",timestamp:Date.now()}),d.events.trigger(o.ReportingEvents.SubmitFeedbackForm({levelId:t,email:i.email,mood:i.mood,comment:i.comment})),setTimeout((()=>c.app.scene.globalUI.notifications.closeToast(e)),1e3)}},28681:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleFactionEconomyUpdated=async function(e,t){const i=r.inject.gameStateModel.factions.byId(t.factionId);if(i?.controller===s.FactionController.LocalUser&&t.regionReports.length>0){const e=t.regionReports.map((e=>e.coinTransfers)).reduce(a.mergeTransactions);o.app.scene.worldMap.coins.play(e),t.regionReports.forEach((e=>{o.app.scene.worldMap.play(e.worldUpdates)}))}else t.regionReports.forEach((e=>{o.app.scene.worldMap.coins.applyTransactions(e.coinTransfers),o.app.scene.worldMap.play(e.worldUpdates)}));const l=new n.StaticGameStateModel(t.stateAfter),c=t.regionReports.map((e=>l.regions.byId(e.regionId)));e.worldMapScene.syncTownVariantInRegions(t.stateAfter,c),e.worldMapScene.overlays.update(t.stateAfter),e.uiScene.updateFromGameState(t.stateAfter)};const s=i(24598),n=i(72273),o=i(54825),a=i(61510),r=i(91622)},28937:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SidePanelScene=t.ClickTrap=void 0;const s=i(897),n=i(30948),o=i(81700),a=i(93868),r=i(91622),l=i(33077),c=i(54825),d=i(11466),h=i(17491),u=i(86545),p=i(32869),g=i(29005),m=i(52528),y=i(21817),f=i(12605),w=i(7782),v=i(51216),b=i(80959),S=i(95070);class x extends u.ResponsiveContainer{constructor(e){super(e),this.setInteractiveAuto("default")}}t.ClickTrap=x;class T extends n.BaseUIScene{constructor(){super({key:o.Scenes.SidePanel,bounds:a.BOUNDS.SidePanel}),this.preUpdate=(0,s.whenDirty)((()=>{const e=this.getCurrentPanel();e&&(e.width=this.bounds.width-m.SIDEBAR_LAYOUT.separatorWidth-m.SIDEBAR_LAYOUT.buttons.outerWidth,this.sidePanelVisibility.applyCurrentValue(),e.preUpdate.makeDirty()),this.leftSeparatorGlint.height=this.bounds.height,this.leftSeparatorGlint.scaleX=this.bounds.height/this.leftSeparatorGlint.width,this.leftSeparatorGlint.scaleY=.5,this.background.width=this.bounds.width,this.background.height=this.bounds.height,this.tabSwitcher.setPosition(this.bounds.width-m.SIDEBAR_LAYOUT.buttons.outerWidth,m.SIDEBAR_LAYOUT.buttons.padding),this.tabSwitcherBackground.setPosition(this.bounds.width-m.SIDEBAR_LAYOUT.buttons.outerWidth,0),this.tabSwitcherBackground.setSize(m.SIDEBAR_LAYOUT.buttons.outerWidth,this.bounds.height)}))}get contentHeight(){const e=this.getCurrentPanel();return e?e.height+m.SIDEBAR_LAYOUT.contentPadding:0}create(){super.create(),(0,f.makeSceneScrollable)(this);const e=b.UiBuilder.for(this);this.panels={[y.SideBarMode.Settings]:new h.SettingsPanel(this),[y.SideBarMode.Menu]:new l.LevelMenuPanel(this,{onAction:()=>{c.app.device.uiVariant()===d.UiVariant.Compact&&r.inject.ui.sidebarMode.set(void 0)}}),[y.SideBarMode.BugReport]:new p.FeedbackPanel(this),[y.SideBarMode.Help]:new g.HelpPanel(this)},this.leftSeparatorGlint=e.image("glass-ui/card-horizontal-glint").setRotation(Math.PI/2).setScrollFactor(0),this.tabSwitcherBackground=e.rectangle((e=>e.oceanShades.dark3)).setScrollFactor(0),this.background=e.rectangle((e=>e.oceanShades.dark1)).setScrollFactor(0),this.sidePanelVisibility=new w.TransitionController(this,{applyValue:e=>{const t=this.getCurrentPanel();t&&t.setVisible(!0);const i=Object.values(this.panels).find((e=>e.visible)),s=(1-e)*this.bounds.width;0===e&&0===this.sidePanelVisibility.currentTarget?(this.scene.setVisible(!1),Object.values(this.panels).forEach((e=>{e.visible&&(e.updateLayout(),e.setVisible(!1))})),this.scene.pause()):i&&(i.x=m.SIDEBAR_LAYOUT.separatorWidth+s),this.leftSeparatorGlint.x=s+1,this.background.x=s,this.scene.setVisible(e>0)},duration:m.SIDEBAR_LAYOUT.transitionDuration,initialValue:0}),this.tabSwitcher=new v.VerticalTabSwitcher(this,{width:m.SIDEBAR_LAYOUT.buttons.outerWidth,tabHeight:m.SIDEBAR_LAYOUT.buttons.outerHeight,theme:v.VerticalTabSwitcher.Themes.white,glintSize:60,allowDeselection:!0}).setScrollFactor(0),this.tabSwitcher.onTabSelected((e=>{e===y.SideBarMode.Close?r.inject.ui.sidebarMode.set(void 0):r.inject.ui.sidebarMode.set(e)})),this.tabSwitcher.setTabs([{key:y.SideBarMode.Close,content:new S.IconOnly(this,"ui/button-icons/exit")},{key:y.SideBarMode.Settings,content:new S.IconOnly(this,"ui/button-icons/settings")},{key:y.SideBarMode.BugReport,content:new S.IconOnly(this,"ui/button-icons/bug-report")},{key:y.SideBarMode.Help,content:new S.IconOnly(this,"ui/button-icons/help")}]),this.addAll([this.background,...Object.values(this.panels),this.leftSeparatorGlint,this.tabSwitcherBackground,this.tabSwitcher]),r.inject.ui.sidebarMode.watch((e=>{if(e){this.scene.resume(),this.applyBounds();for(let[t,i]of Object.entries(this.panels))i.setVisible(t===e);this.tabSwitcher.selectTab(e,!1),this.preUpdate.makeDirty()}this.sidePanelVisibility.transitionTo(e?1:0)})),this.sidePanelVisibility.applyCurrentValue()}getCurrentPanel(){return r.inject.ui.sidebarMode()?this.panels[r.inject.ui.sidebarMode()]:void 0}update(e,t){super.update(e,t)}}t.SidePanelScene=T},28952:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IslandCard=void 0;const s=i(86545),n=i(56887),o=i(80959),a=i(76049),r=i(20087),l=i(96704),c=i(22663),d=i(21941),h=i(88389),u=i(91622),p=i(2426),g=i(56824),m=i(36868),y=i(7782),f=i(54825),w=i(98963),v=i(47618),b=i(90966),S=i(2297),x=i(80374),T=i(9292),P=g.logger.for("IslandCard");class I extends s.BaseResponsiveContainer{constructor(e,t,i,s){super(e),this.jobQueue=t,this.engine=i,this.isFavorite=!1;const l=o.UiBuilder.for(e);this.preview=new n.IslandPreview(e),this.title=l.text("?",a.BitmapFont.Small,(e=>e.white)),this.subtitle=l.text("?",a.BitmapFont.Mini,(e=>e.white)),this.innerFrame=new p.RoundedRect(e,{radius:8}),this.selectedFrame=l.box(d.BoxTextures.CorneredFrame),this.selectedBackground=l.rectangle(0),this.gradient=l.image("ui/horizontal-gradient"),this.controls=new v.IslandCardControls(e),this._favoriteButton=l.imageButton({frame:"ui/button-icons/star-empty",onClicked:()=>{let e="";this.model.isFavorite()?(g.events.trigger(m.UserActions.RemoveLevelFromFavorites(this.model.getLevelId())),e="Removed from Favorites!"):(g.events.trigger(m.UserActions.AddLevelToFavorites({levelId:this.model.getLevelId(),startingState:this.model.getPreviewGameState()})),e="Added to Favorites!"),f.app.tooltips.close(),f.app.tooltips.showOver(this.favoriteButton,{title:e,type:S.TooltipType.Hover,icon:"ui/icons/ok",delayMs:0,expireAfterMs:1500})}}),this.selectedFrameVisibility=new y.TransitionController(e,{applyValue:e=>{const t=2+4*e,i=6+4*e;this.selectedBackground.setAlpha(e),this.selectedFrame.setAlpha(e),this.gradient.setAlpha(e/10),this.selectedBackground.setPosition(-t,-t),this.selectedBackground.setSize(this.width+2*t,this.height+2*t),this.selectedBackground.setFillStyle(u.inject.theme.getCurrent().oceanShades.dark3),this.selectedFrame.setPosition(-i,-i),this.selectedFrame.setSize(this.width+2*i,this.height+2*i),this.innerFrame.setPosition(0,0),this.innerFrame.setSize(this.width,this.height),this.gradient.setPosition(this.selectedBackground.x+7,this.selectedBackground.y+7);const s=this.selectedBackground.height-14,n=this.height-7;this.gradient.setScale(n/this.gradient.width*(.5+.5*e),s/this.gradient.height),this.controls.y=this.height-this.controls.height-10;const o=this.height/2,a=6+(this.controls.y-6)/2,l=a+(o-a)*(1-e);r.Arrange.topToBottom({content:[this.title,this.subtitle],y:l,origin:.5,spacing:4})},initialValue:0,duration:200}),this.setInteractiveAuto(),this.interactionController=new h.SimpleButtonStateController({audio:!1,onClicked:()=>{this.currentProps.selected||(f.app.audio.playEffect(w.SoundEffects.ButtonDown),g.events.trigger(m.UserActions.SelectContent(this.currentProps.content.id)))}}),this.add([this.selectedBackground,this.selectedFrame,this.gradient,this.innerFrame,this.title,this.preview,this.subtitle,this.controls,this._favoriteButton]),this.setProps(s),this._favoriteButton.controller.onStateChanged((()=>{this.updateFavoriteButton(),this.updateInnerFrame()})),this.interactionController.bindTo(this,(e=>{this.updateFavoriteButton(),this.updateInnerFrame()})),u.inject.theme.use((e=>{this.updateInnerFrame()}))}get favoriteButton(){return this._favoriteButton||(this._favoriteButton=o.UiBuilder.for(this.scene).imageButton({frame:"ui/button-icons/star-empty",onClicked:()=>{this.model.isFavorite()?g.events.trigger(m.UserActions.RemoveLevelFromFavorites(this.model.getLevelId())):g.events.trigger(m.UserActions.AddLevelToFavorites({levelId:this.model.getLevelId(),startingState:this.model.getPreviewGameState()}))}})),this._favoriteButton}updateFavoriteButton(){if(!this.currentProps.showFavoriteButton)return void this._favoriteButton?.setVisible(!1);this._favoriteButton?.setVisible(!0);const e=f.app.device.isUsingTouch(),t=this.favoriteButton.controller.getState(),i=this.interactionController.getState(),s=this.model.isFavorite();t===c.ButtonState.Hover?(this.favoriteButton.setBaseFrame((0,x.getFavoriteButtonFrame)(s)),this.favoriteButton.setAlpha(.8)):t===c.ButtonState.Down?(this.favoriteButton.setBaseFrame((0,x.getFavoriteButtonFrame)(s)),this.favoriteButton.setAlpha(1)):i!==c.ButtonState.Rest||s||e?(this.favoriteButton.setBaseFrame((0,x.getFavoriteButtonFrame)(s)),this.favoriteButton.setAlpha(this.currentProps.selected?.4:.2)):this.favoriteButton.setAlpha(0),this.favoriteButton.setData("tooltip",s?"Remove from Favorites":"Add to Favorites")}updateInnerFrame(){let e=this.interactionController.getState();this.currentProps.selected&&(e=c.ButtonState.Rest);const t={[c.ButtonState.Hover]:.4,[c.ButtonState.Rest]:.2,[c.ButtonState.Down]:.4,[c.ButtonState.Disabled]:.2};this.innerFrame.setLineStyle(u.inject.theme.getCurrent().oceanContrastLight,1,t[e])}setProps(e){this.currentProps=e,this.model=(0,b.createUserContentModelFor)(e.content),this.title.setText(this.model.getTitle()),this.subtitle.setText(this.model.getSubtitle()),this.subtitle.setVisible(!!this.subtitle.text),this.setSelected(e.selected,"instant"),this.preview.clear(),this.jobQueue.addJob((async()=>{const e=this.model.getPreviewGameState();e?(this.engine.deserialize((0,l.decompressGameState)(e)),this.active&&(this.preview.redraw({gameState:this.engine.currentState,displayMode:n.IslandPreviewDisplayMode.Default,outline:n.IslandOutline.None}),this.preUpdate.makeDirty())):P.warning(`Failed to load preview for ${this.model.toString()}`)}))}setSelected(e,t="transition"){this.currentProps.selected=e,this.selectedFrameVisibility.setTo(e?1:0,t),this.controls.setActions(this.model.getActions()),this.preUpdate.makeDirty()}updateLayout(){const e=this.height-10;r.Arrange.alignX({content:[this.title,this.subtitle],x:e+10+4,origin:0});const t=this.width-this.title.x-5;this.title.setMaxWidth(t-25),this.subtitle.setMaxWidth(t),this.selectedFrameVisibility.applyCurrentValue(),this.updateFavoriteButton(),this.updateInnerFrame(),this.controls.setVisible(this.currentProps.selected),this.controls.updateLayout(),this.controls.x=(0,T.pickSmaller)(e-20,this.width-10-this.controls.width);const i=this.preview.height,s=this.preview.width,n=Math.min(1,e/i,e/s);this.preview.setScale(n),this.preview.setPosition(5+(e-s*n)/2,5+(e-i*n)/2),this.favoriteButton.x=this.width-this.favoriteButton.width-10,this.favoriteButton.y=10,function(e,t){e.setScale(1);const i=(0,T.pickSmaller)(1,t/e.width);e.setScale(i,1)}(this.title,this.width-this.title.x-5)}}t.IslandCard=I},29005:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HelpPanel=void 0;const s=i(86545),n=i(89995),o=i(56824);class a extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.frame=new n.IFrame(this.scene,{url:o.config.helpPagesBaseUrl}),this.add(this.frame)}updateLayout(){this.frame.setPosition(1,0),this.frame.width=this.width-1,this.frame.height=this.scene.bounds.height,this.updateSize()}calculateHeight(){return this.frame.height}}t.HelpPanel=a},29064:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConquestValueDebugLayer=t.ConquestValue=t.NO_CONQUEST_VALUE=void 0;const s=i(24598),n=i(56038),o=i(70712),a=i(45664),r=i(19618),l=i(61634),c=i(76439),d=i(20693),h=i(7334),u=i(91622),p=i(78635),g=i(19580),m=i(81434),y=i(9292);t.NO_CONQUEST_VALUE=Object.freeze({total:0,factors:{damageMultiplier:1,damageToEnemy:0,loot:0,valueForMe:0,fromPlugins:0}}),t.ConquestValue=class{constructor(e,t){this.context=e,this.views=t,this.state=this.context.state}get(e){const t="number"==typeof e?[(0,a.getHex)(e)]:e,i=t[t.length-1],s=this.calculateDamageMultiplier(i),n={damageToEnemy:0!==s?(0,g.estimateDamage)(this.state,t):0,damageMultiplier:s,valueForMe:this.calculateHexValueForMe(i),loot:t.map((e=>2*p.Warfare.getPotentialLoot(this.state,e,!0))).reduce(y.sum),fromPlugins:u.inject.plugins.ai.hexConquestBonus.apply(0,this.state,i)};return{total:n.valueForMe+n.damageToEnemy*n.damageMultiplier+n.loot+n.fromPlugins,factors:n}}calculateDamageMultiplier(e){const t=n.Regions.model(this.state).byHex(e);if(!t||t===this.context.region)return 0;const i=(0,y.pickLarger)(1-this.context.aiPersonality.honorable,u.inject.views.hostility.get(this.state,{attacker:this.context.faction,victim:t.faction}));return Math.pow(i,3)}calculateHexValueForMe(e){if(this.context.region.hexes.has(e))return 0;const t=(0,y.pickLarger)(1-this.context.focus.daring,.5),i=p.Warfare.getHexDefenseWithoutMovableUnits(this.state,e)+1,n=.5+.5*this.views.planningSecurity.afterPlacingDefender(e.id,i),a=e.neighbours((e=>r.Factions.getByHex(this.state,e.id)===this.context.faction.id)).map((e=>{const t=o.AI.getHexImportance(this.state,e.id),s=.5+1/(0,y.pickLarger)(t.distanceFromTown,1),n=.25+.75*this.views.planningSecurity.calculate(e.id,{defense:i});return t.value*n*s})).reduce(y.sum,0)*t/2;let l=40;return m.Pawns.isPresentOnHex(this.state,e.id,s.PawnType.Swamp)&&(l-=40),m.Pawns.isPresentOnHex(this.state,e.id,s.PawnType.TownRuins)&&(l+=40),m.Pawns.isPresentOnHex(this.state,e.id,s.PawnType.GoldMine)&&(l+=100),l*n+a}calculateLootValue(e){const t=p.Warfare.getOccupyingPawn(this.state,e);return 2*((t?.rules.loot??0)+l.Economy.model(this.state).numberOfCoinsAt(e))}getDebugLayer(){return new f(this)}};class f extends c.GameStateDebugLayer{constructor(e){super({getValue(t,i){const s=e.get(i);if(s&&0!==s.total)return s.total.toFixed()},getDetail(t,i){const s=e.get(i);if(s&&0!==s.total)return`${(0,h.prettyPrintObject)(s.factors)}`},getHexes:e=>d.HexGroup.union(n.Regions.model(e).all().map((e=>e.hexes)))}),this.conquestValue=e}}t.ConquestValueDebugLayer=f},29074:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexProximityToRegionView=void 0;const s=i(90952),n=i(20026),o=i(20754),a=i(76439),r=i(12543),l=i(9292);class c extends o.LazyView{constructor(){super([s.GameState.ai.regionInfluenceByHex,s.GameState.regions.byHex,s.GameState.factions.byRegion]),this.name="hexProximityToRegionView"}calculate(e,t){return this.getComponents(e,t).map((e=>e.score)).reduce(l.sum,0)}getComponents(e,t){const i=(0,n.selectFromState)(e,s.GameState.ai.regionInfluenceByHex,t.hexId);return i?i.entrySeq().map((([e,i])=>({regionId:e,distance:i.distance,score:t.scoreCalculator(e,i.distance)}))).toArray():[]}getCacheKey(e){return e.cacheId+"."+e.hexId}getDebugLayer(e){return new a.GameStateDebugLayer((0,r.hexBasedAdapter)({getValue:(t,i)=>this.get(t,{...e,hexId:i}),getDetail:(t,i)=>this.getComponents(t,{...e,hexId:i}).map((({regionId:e,score:t,distance:i})=>`${t} from region ${e} (d=${i})`)).join("\n")}))}}t.HexProximityToRegionView=c},29135:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncJobExclusiveRunner=void 0;const s=i(56824),n=i(18957),o=i(91622),a=s.logger.for("AsyncJobExclusiveRunner");t.AsyncJobExclusiveRunner=class{constructor(e){this.jobRunner=e,this.paused=!1,this.currentInput=null,this.currentPromise=null,this.onJobStarted=(0,n.signal)(),this.onJobFinished=(0,n.signal)()}run(e){this.currentInput!==e&&(this.currentInput=e,this.currentPromise||this._runPendingJob())}_runPendingJob(){if(this.currentInput&&!this.currentPromise){const e=this.currentInput;this.currentPromise=this.jobRunner(e,(async()=>{this.currentInput!==e?(a.warning("Aborting job"),this.currentPromise=null,this._runPendingJob(),await new Promise((()=>{}))):await o.inject.performance.preventFreeze()})),this.onJobStarted.fire(e),this.currentPromise.then((()=>{this.currentInput===e?(this.currentInput=null,this.currentPromise=null,this.onJobFinished.fire(e)):this._runPendingJob()}))}}isRunning(){return!!this.currentPromise}clear(){this.currentInput=null,this.currentPromise=null}}},29168:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ObjectCache=void 0;const s=i(49568);t.ObjectCache=class{constructor(e=s.hash){this.hashFunction=e,this.data={}}find(e){return this.data[this.hashFunction(e)]}store(e,t){this.data[this.hashFunction(e)]=t}flush(){this.data={}}}},29172:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazyAdapter=function(e){let t,i;return()=>{const s=e.source();return void 0!==s&&s===i||(t=e.transform(s),i=s),t}}},29191:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AlwaysRetreatPlugin=void 0;const s=i(18497),n=i(78635),o=i(70712);t.AlwaysRetreatPlugin={name:s.PluginKey.AlwaysRetreat,displayName:"Always Retreat",icon:"ui/level-features/always-retreat",register(e){},getRetreatDestination:(e,t)=>{const i=e.region,s=n.Warfare.model(e.state),a=o.AI.getHexImportance(e.state,e.hex.id).distanceFromTown;return i.hexes.findClosest(e.hex,(t=>!!s.isFreeToEnterFor(t,e.type)&&o.AI.getHexImportance(e.state,t.id).distanceFromTown<=a))??i.hexes.findClosest(e.hex,(e=>!s.isOccupied(e)))}}},29322:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.factionBasedAdapter=function(e){return{getHexes:e=>s.HexGroup.union(n.Regions.model(e).all().filter((e=>e.isAlive())).map((t=>s.HexGroup.fromIds(o.Economy.getTownHexesByRegion(e,t.id).toArray())))),getValue(t,i){const s=a.Factions.getByHex(t,i);if(void 0!==s)return e.getValue(t,s)},getDetail(t,i){const s=a.Factions.getByHex(t,i);if(void 0!==s)return e.getDetail(t,s)}}};const s=i(20693),n=i(56038),o=i(61634),a=i(19618)},29454:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScriptModules=void 0;const s=i(95073),n=i(70224),o=i(76639),a=i(32636),r=i(18922),l=i(81721),c=i(51624);t.ScriptModules={tutorial1:()=>new s.Tutorial1,tutorial2:()=>new n.Tutorial2,tutorialDoubleTrouble:()=>new r.TutorialDoubleTrouble,tutorial3:()=>new o.Tutorial3,reinforcements:()=>new a.ReinforcementsLevelModule,deadIslands1:()=>new l.DeadIslands1,deadIslands2:()=>new c.DeadIslands2}},29469:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeAcceptSurrender=function(e){return[s.GameStateEvents.GameOver({state:e.state,winningFactionId:e.currentPhase.faction?.id})]};const s=i(36868)},29481:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelDetailWindow=t.LevelDetailUI=void 0;const s=i(86545),n=i(21941),o=i(66143),a=i(80959),r=i(96137),l=i(76049),c=i(87047),d=i(54825),h=i(11466),u=i(72172),p=i(7782),g=i(83221),m=i(9292),y={offsetFromRight:16,offsetFromWaves:30,offsetFromWavesCompact:0,outerWidth:320,contentLeft:28,withRibbon:{contentLeft:72,innerWidth:220},innerWidth:264,headerHeight:50,footerHeight:35,spaceAroundDescription:22,minRibbonHeight:72};t.LevelDetailUI=class{constructor(e){this.scene=e,this.window=new f(e),this.scene.add.existing(this.window),this.windowVisibilityController=new p.TransitionController(e,{duration:100,ease:"Sine.easeOut",applyValue:e=>{this.window.setAlpha(e),this.window.y=this._getWindowY()+20*(1-e)}})}_getWindowY(){return d.app.device.uiVariant()===h.UiVariant.Compact?this.scene.bounds.height-g.MenuHeaderUIScene.Layout.wavesHeight-this.window.height+4:this.scene.bounds.height-g.MenuHeaderUIScene.Layout.wavesHeight-y.offsetFromWaves-this.window.height}updateLayout(){this.window.width=y.outerWidth;const e=this.scene.bounds.contentRight-y.offsetFromRight;d.app.device.uiVariant()===h.UiVariant.Compact?(this.window.width=this.scene.bounds.width+60,this.window.setPosition(this.scene.bounds.centerX-this.window.width/2,this._getWindowY()),this.window.setVisible(null!==this.state.levelDetail&&!this.state.levelListExpanded)):(this.window.setPosition(e-this.window.width,this._getWindowY()),this.window.setVisible(null!==this.state.levelDetail))}updateState(e){this.state=e,e.levelDetail?(this.window.updateState(e.levelDetail),this.transitionIn(),this.updateLayout()):this.transitionOut()}transitionOut(){this.window.flapsPosition.transitionTo(0),this.windowVisibilityController.transitionTo(0),this.window.victoryTurnsRibbon.hide()}hide(){this.window.flapsPosition.setTo(0),this.windowVisibilityController.setTo(0),this.window.victoryTurnsRibbon.hide()}transitionIn(){this.windowVisibilityController.transitionTo(1),this.window.flapsPosition.transitionTo(1),this.updateLayout()}};class f extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.currentState={bestVictory:void 0,status:o.LevelStatus.Locked,title:"",features:[],description:""};const t=a.UiBuilder.for(e);this.title=t.text("Arrival",l.BitmapFont.Main,r.Colors.glassUi_old.shapeLightAccent),this.description=t.richText("[i]...[/i]",r.Colors.woodenUi.primaryText),this.features=new c.LevelFeaturesGallery(e,{interactive:!0}),this.mainBox=t.box(n.BoxTextures.DetailWindow),this.coatOfArms=t.image("ui/detail-window/gold-medal"),this.leftFlap=t.image("ui/detail-window/ribbon-flap").setFlipX(!0),this.rightFlap=t.image("ui/detail-window/ribbon-flap"),this.flapsPosition=new p.TransitionController(e,{applyValue:e=>{const t=10*(1-e);this.leftFlap.setPosition(24+t,27),this.rightFlap.setPosition(this.width-24-t,27)}}),this.victoryTurnsRibbon=new u.VictoryTurnsRibbon(e),this.add([this.leftFlap,this.rightFlap,this.mainBox,this.victoryTurnsRibbon,this.coatOfArms,this.title,this.description,this.features])}updateState(e,t="transition"){this.currentState=e,this.title.setText(e.title),this.description.setText(`[i]${e.description} [/i]`),this.coatOfArms.setFrame(this._getCoatOfArmsFrame(e.status)),this.features.updateState(e.features),e.bestVictory&&this.victoryTurnsRibbon.setCount(e.bestVictory.turns??"?"),this.updateLayout()}_getCoatOfArmsFrame(e){switch(e){case o.LevelStatus.GoldMedal:return"ui/detail-window/gold-medal";case o.LevelStatus.SilverMedal:return"ui/detail-window/silver-medal";case o.LevelStatus.Unlocked:default:return"ui/detail-window/in-progress"}}updateLayout(){const e=d.app.device.uiVariant()===h.UiVariant.Compact?20:0;this.coatOfArms.setPosition(e+24,10),this.victoryTurnsRibbon.setPosition(this.coatOfArms.x+4,30),this.flapsPosition.applyCurrentValue(),this.title.setPosition(e+76,21);const t=(i=this.currentState).status===o.LevelStatus.GoldMedal||i.status===o.LevelStatus.SilverMedal;var i;let s=t?y.withRibbon:y;if(this.description.setPosition(s.contentLeft+e,y.headerHeight+y.spaceAroundDescription),this.description.setWordWrapWidth(this.width-this.description.x-e-32),t){const e=(0,m.pickLarger)(this.description.height+(this.description.y-this.victoryTurnsRibbon.y),y.minRibbonHeight);this.victoryTurnsRibbon.show(this.currentState.status,e)}else this.victoryTurnsRibbon.hide();this.features.setPosition(y.contentLeft+e,this.description.y+this.description.height+y.spaceAroundDescription+12),this.updateSize(),this.mainBox.setSize(this.width,this.height)}calculateHeight(){return y.headerHeight+2*y.spaceAroundDescription+this.description.height+y.footerHeight}}t.LevelDetailWindow=f},29555:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Calculator=void 0,t.Calculator=class{constructor(e,t){this.getFactors=e,this.calculateOutput=t}get(...e){const t=this.getFactors(...e);return this.calculateOutput(t)}}},29751:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.King=void 0;const s=i(11874),n=i(8971),o=i(90824),a=i(83958);t.King=class{constructor(){this.names=["Arthur the Great","Gordic the Conqueror","Gustav the Wise","Reginald the Righteous"],this.chatter=s.CHATTER_DEFS,this.headwear="crown",this.personality=n.DEFAULT_AI_PERSONALITY,this.buildsCastles=!0,this.race=o.Race.Human,this.aiStrategy=a.defaultStrategy}}},29815:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LichKing=void 0;const s=i(94917),n=i(8971),o=i(90824),a=i(2558);t.LichKing=class{constructor(){this.names=["Malachor the Eternal","Netherion Frostbane","Morbryn Shadowreaver","Valtharion Blackthorn","Drakul the Undying","Xylothar the Cursed","Seraphus Dreadmourne","Zephyrak the Soulflayer","Thalador the Necrofiend","Baelgrim the Malevolent","Voragoth Frostheart","Nerulith Darkcrown","Zyraxis the Deathlord","Azrathel Nightshroud","Vesperian Soulharvest","Mordrak the Forsaken","Vyraxis the Damned","Gloomfang the Unholy","Thanevius the Bonecaster","Sylvarax the Lich King"],this.chatter=s.CHATTER_DEFS,this.headwear="crown",this.personality=n.DEFAULT_AI_PERSONALITY,this.buildsCastles=!0,this.race=o.Race.Undead,this.aiStrategy=a.lichKingStrategy}}},29821:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Label=void 0;var s=Phaser.GameObjects.BitmapText;const n=i(76049);t.Label=class extends s{constructor(e,t,i={}){super(e,0,0,n.BitmapFont.Main,t),this.props=i,this.setTint(i.color??5583648).setOrigin(0,0),i.width&&this.setMaxWidth(i.width),i.shadow&&this.setDropShadow(2,2,0,1)}set width(e){this.setMaxWidth(e)}get width(){return super.getTextBounds().global.width}}},30161:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dropdownListStory=void 0;const s=i(80959);function n(e,t){return s.UiBuilder.for(e).selectBox({theme:"islandCard",selectedItem:{key:"default",text:"default"},width:150,options:[{key:"muted",text:"Muted"},{key:"default",text:"Default"},{key:"ground",text:"Grounded"},{key:"highContrats",text:"High Contrast"},{key:"christmas",text:"Christmas"}],onSelected:e=>{console.log("SELECTED",e?.text)},...t})}t.dropdownListStory={name:"ui.dropdownList",content:e=>[{name:"simple dropdown",component:n(e)},{name:"color picker",component:n(e,{selectedItem:{text:"Select Color",icon:{color:65280}},options:[{text:"Red",icon:{color:16711680}},{text:"Green",icon:{color:65280}},{text:"Blue",icon:{color:255}},{text:"Yellow",icon:{color:16776960}},{text:"Purple",icon:{color:8388736}}]})},{name:"multicolor picker",component:n(e,{selectedItem:{text:"Select Theme",icon:{multiColorBox:{colors:[16711680,65280,255,16776960]}}},options:[{text:"MultiColor",icon:{multiColorBox:{colors:[16711680,65280,255,16776960]}}},{text:"Green",icon:{color:65280}},{text:"Blue",icon:{color:255}},{text:"Yellow",icon:{color:16776960}},{text:"Purple",icon:{color:8388736}}]})}]}},30221:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleMapRegistry=void 0;const s=i(85026),n=i(56824),o=i(84757),a=i(16082),r=i(10131),l=n.logger.for("MapRegistry");t.SimpleMapRegistry=class{constructor(e){this.dataSource=e,this.initialized=!1,this.levelsById={},this.expeditions=[],this.loadTime=0,this.initialize=(0,r.asyncInitializer)((async()=>{const e=o.timing.start("MapRegistry.initialize"),t=await this.dataSource.fetchContent();l.info(`${t.expeditions.length} expeditions and ${Object.values(t.levels).length} maps loaded`),this.expeditions=t.expeditions,this.levelsById=t.levels,this.initialized=!0,this.initializedPromise=void 0,this.loadTime=e.complete()}))}async reload(){this.initialized=!1,this.initialize.reset(),await this.initialize()}loadLevelById(e){const t=this.levelsById[e]?.data;if(t)return(0,s.decodeGameState)(t)}_assertInitialized(){if(!this.initialized)throw new Error("Using mapRegistry synchronous api before initialization complete")}getLevelManifestById(e){return this._assertInitialized(),this.levelsById[e]?.manifest}getLevelExpeditionContext(e){this._assertInitialized();for(let t of this.expeditions){const i=a.ExpeditionModel.for(t.id),s=t.objects.findIndex((t=>t.id===e));if(-1!==s)return{expedition:i,levelData:t.objects[s]}}}getExpeditions(){return this.expeditions}getExpeditionById(e){return this.expeditions.find((t=>t.id===e))}getAllLevelIds(){return Object.keys(this.levelsById)}}},30256:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sanitizeTile=function(e,t){const i=e.pawns.byHex(t).find((e=>e.type===s.PawnType.Coins));i&&(e.pawns.presentAtHex(t,...n)||i.destroy());const r=e.warfare.getOccupyingUnit(t)?.type;r&&o.includes(r)&&!e.factions.byHex(t)?.isNeutral()?e.factions.neutral.takeOverHex(t):r&&a.includes(r)&&e.factions.byHex(t)?.isNeutral()&&e.factions.byId(1).takeOverHex(t);const l=e.pawns.byHex(t,s.PawnType.Chest);l&&0===e.pawns.getCount(t,s.PawnType.Coins)&&l.destroy()};const s=i(24598),n=[s.PawnType.Camp,s.PawnType.Town,s.PawnType.Chest],o=[s.PawnType.Camp,s.PawnType.Forest,s.PawnType.HauntedTown],a=[s.PawnType.Refuge,s.PawnType.Town,s.PawnType.Villager,s.PawnType.Pikeman,s.PawnType.Knight,s.PawnType.Hero,s.PawnType.DreadKnight]},30308:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IdleChatterView=void 0;const s=i(20754),n=i(90952),o=i(19618),a=i(56038),r=i(52724);class l extends s.LazyView{constructor(){super([n.GameState.ai.powerByRegion,n.GameState.factions.regions]),this.name="IdleChatter",this.usedPhrases=new Set,this.cache.onFlushed((()=>{this.usedPhrases.clear()}))}calculate(e,t){const i=o.Factions.model(e).localPlayer,s=(0,r.generateChatter)(a.Regions.model(e).byId(t),i,{bannedPhrases:this.usedPhrases});return s&&this.usedPhrases.add(s),s}getCacheKey(e){return e}}t.IdleChatterView=l},30310:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WarfareModel=void 0;const s=i(94399),n=i(19162),o=i(63521),a=i(56038),r=i(81434),l=i(78635),c=i(20693),d=i(91622),h=i(57230);class u extends s.BaseModel{getUnitsByRegion(e){const t=r.Pawns.model(this.state);return l.Warfare.getUnitsByRegion(this.state,e.id).map((e=>t.byId(e)))}getConquerableHexes(e,t,i){if(0===t)return c.HexGroup.empty;let s;if("number"==typeof t)s=t;else{const e=n.Rules.model(this.state).pawns(t);s=e.hasTrait(o.PawnTraits.Unit)?e.might:0}return d.inject.views.conquerableHexes.get(this.state,{regionId:e.id,unitMight:s,unitMightWithoutHeavyUnits:i})}getHexLocalDefense(e){return l.Warfare.getHexLocalDefense(this.state,e.id)}getHexDefenders(e,t=1){return l.Warfare.getHexDefenders(this.state,e,t)}getHexDefense(e){return l.Warfare.getHexDefense(this.state,e)}getHexDefenseWithoutMovableUnits(e){return l.Warfare.getHexDefenseWithoutMovableUnits(this.state,e)}getHexStaticDefense(e){return l.Warfare.getHexStaticDefense(this.state,e.id)}canConquerHexWith(e,t){return l.Warfare.canConquerHexWith(this.state,e,t)}getMergeResult(e,t){return n.Rules.getMergeResult(this.state,e,t)}isOccupied(e){return!!this.getOccupyingUnit(e)}isImpassable(e){return!a.Regions.getByHex(this.state,e.id)||!!this.getOccupyingUnit(e)?.isInvincible()}getOccupyingUnit(e){return l.Warfare.getOccupyingPawn(this.state,e)}getMightOf(e){return n.Rules.model(this.state).pawns(e).might}isSuitableTerrain(e,t){return!(n.Rules.model(this.state).pawns(t).hasTrait(o.PawnTraits.HeavyUnit)&&r.Pawns.isTraitPresentOnHex(this.state,e.id,o.PawnTraits.PreventsHeavyUnits))}isFreeToEnterFor(e,t){return!this.isOccupied(e)&&this.isSuitableTerrain(e,t)}_withTerrainCheck(e,t,i){return this.isSuitableTerrain(e,t)?i:{type:l.DropPawnResultType.Invalid,reason:l.InvalidDropPawnReason.UnsuitableTerrain}}getNearestSuitableHexAfterMerge(e,t){if(t.hasTrait(o.PawnTraits.HeavyUnit)&&r.Pawns.isTraitPresentOnHex(this.state,e.hex.id,o.PawnTraits.PreventsHeavyUnits)){const t=r.Pawns.model(this.state);return e.region.hexes.findClosest(e.hex,(e=>!t.traitPresentAtHex(e,o.PawnTraits.PreventsHeavyUnits)&&!this.isOccupied(e)))}return e.hex}getDropPawnResult(e,t,i,s=!1){const c=a.Regions.model(this.state),d=n.Rules.model(this.state),h=c.byHex(e),u=d.pawns(t);if(u.hasTrait(o.PawnTraits.HeavyUnit)&&r.Pawns.isTraitPresentOnHex(this.state,e.id,o.PawnTraits.PreventsHeavyUnits))return{type:l.DropPawnResultType.Invalid,reason:l.InvalidDropPawnReason.UnsuitableTerrain};if(h?.id===i.id){if(u.hasTrait(o.PawnTraits.Building)&&!this.canBuildAt(e))return{type:l.DropPawnResultType.Invalid,reason:l.InvalidDropPawnReason.UnsuitableTerrain};const i=this.getOccupyingUnit(e);if(!i)return this._withTerrainCheck(e,t,{type:l.DropPawnResultType.Reposition});if(i.hasTrait(o.PawnTraits.Pest))return d.pawns(t).hasTrait(o.PawnTraits.Unit)&&i.might<this.getMightOf(t)?this._withTerrainCheck(e,t,{type:l.DropPawnResultType.EradicatePest,pest:i}):d.pawns(t).hasTrait(o.PawnTraits.Unit)&&s?this._withTerrainCheck(e,t,{type:l.DropPawnResultType.Reposition,displacedUnit:i}):{type:l.DropPawnResultType.Invalid,reason:l.InvalidDropPawnReason.PreventedByPawn,blockers:[i]};const n=d.pawns(i.type).mergeRules[t];return n?this._withTerrainCheck(e,n,{type:l.DropPawnResultType.Combine,combineWith:i,combineInto:n}):{type:l.DropPawnResultType.Invalid,reason:l.InvalidDropPawnReason.PreventedByPawn,blockers:[i]}}return this.isSuitableTerrain(e,t)?void 0===h||h.faction===i.faction?{type:l.DropPawnResultType.Invalid,reason:l.InvalidDropPawnReason.InvalidRegion}:u.hasTrait(o.PawnTraits.Unit)||u.hasTrait(o.PawnTraits.Treasure)?e.neighbours().find((e=>c.byHex(e)===i))?this.canConquerHexWith(e,t)?{type:l.DropPawnResultType.Conquest}:u.hasTrait(o.PawnTraits.Treasure)&&!l.Warfare.getOccupyingPawn(this.state,e)?{type:l.DropPawnResultType.Reposition}:{type:l.DropPawnResultType.Invalid,reason:l.InvalidDropPawnReason.PreventedByPawn,blockers:this.getHexDefenders(e,d.pawns(t).might)}:{type:l.DropPawnResultType.Invalid,reason:l.InvalidDropPawnReason.OutOfRange}:{type:l.DropPawnResultType.Invalid,reason:l.InvalidDropPawnReason.InvalidRegion}:{type:l.DropPawnResultType.Invalid,reason:l.InvalidDropPawnReason.UnsuitableTerrain}}getRetreatDestination(e,t){const i=e.region;return e.hasTrait(o.PawnTraits.Elusive)?(0,h.getBunnyDestination)(e):i.hexes.neighboursOf(e.hex).filter((t=>this.isFreeToEnterFor(t,e.type))).findMax((e=>100*this.getHexStaticDefense(e)+i.hexes.neighboursOf(e).length))}canBuildAt(e){return l.Warfare.canBuildAt(this.state,e)}}t.WarfareModel=u},30330:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameLogo=t.ButtonsPanel=t.TitleScreenUIScene=void 0;const s=i(81700),n=i(48694),o=i(897),a=i(20087),r=i(36868),l=i(30948),c=i(55275),d=i(80959),h=i(86545),u=i(51496),p=i(70560),g=i(25e3),m=i(56824),y=i(91622),f=i(11796),w=i(98277),v=i(83221),b=i(12605),S=i(54825),x=i(9292);class T extends l.BaseUIScene{constructor(){super({key:s.Scenes.TitleScreenUI}),this.state=(0,c.stateContainer)({resumeButton:{enable:!1}},(()=>{this.preUpdate.makeDirty()})),this.preUpdate=(0,o.whenDirty)((()=>{const e=n.TitleScreen.Layout,t=this.bounds.width,i=this.bounds.height-v.MenuHeaderUIScene.Layout.wavesHeight;if(this.background.updateLayout(),this.buttonsPanel.width=(0,x.pickSmaller)(this.background.mainPanel.width-60,n.TitleScreen.Layout.buttons.maxWidth),this.buttonsPanel.updateLayout(),this.gameLogo.variant=i<660?"compact":"full",this.gameLogo.updateLayout(),this.state().resumeButton.enable){if(this.background.mainPanel.width===this.bounds.contentWidth)this.resumeButton.x=this.background.mainPanel.x+30,this.resumeButton.setSize(this.background.mainPanel.width-60,e.buttons.height+20),this.resumeButton.setStretchRight(!1);else{this.resumeButton.x=this.background.mainPanel.x-80;const t=this.background.mainPanel.width+160,i=this.bounds.width-this.resumeButton.x;this.resumeButton.setSize((0,x.pickSmaller)(t,i),e.buttons.height+20),this.resumeButton.setStretchRight(i<t)}this.resumeButton.setVisible(!0),this.resumeButton.updateContent(this.state().resumeButton)}else this.resumeButton.setVisible(!1);a.Arrange.topToBottom({content:[this.gameLogo,this.buttonsPanel,this.resumeButton],y:i/2,origin:.5,spacing:30,maxSize:i-60}),a.Arrange.alignX({content:[this.gameLogo,this.buttonsPanel],x:this.background.mainPanel.x+this.background.mainPanel.width/2,origin:.5}),t>=960?g.NewsBox.show():g.NewsBox.hide()}))}create(){super.create(),(0,b.makeSceneScrollable)(this),this.gameLogo=new I(this),this.background=new p.VerticalStripePanelUI(this),this.background.addToScene(),this.buttonsPanel=new P(this),this.resumeButton=new w.TitleSceneContinueButton(this),this.addAll([this.gameLogo,this.buttonsPanel,this.resumeButton]),y.inject.theme.use((e=>{this.resumeButton.updateLayout()}))}get contentHeight(){return this.resumeButton.visible?this.resumeButton.y+this.resumeButton.height+S.app.scene.menuHeaderUI.wavesHeight.currentTarget:this.buttonsPanel.y+this.buttonsPanel.height+S.app.scene.menuHeaderUI.wavesHeight.currentTarget}}t.TitleScreenUIScene=T;class P extends h.AutoHeightResponsiveContainer{constructor(e){super(e),d.UiBuilder.for(e);const t=(t,i,s,n)=>new f.TitleButton(e,{text:i,icon:t,onClicked:s,rightIcon:n,backgroundColor:y.inject.theme.getCurrent().oceanShades.dark3});this.buttons=[t("ui/icons/campaign","Expeditions",(()=>{u.track.interaction("open_expeditions"),m.events.trigger(r.UserActions.GoToExpeditions())})),t("ui/icons/conquest","Conquest",(()=>{u.track.interaction("open_conquest"),m.events.trigger(r.UserActions.GoToRandomMapSelect())})),t("ui/icons/my-domain","My Domain",(()=>{m.events.trigger(r.UserActions.GoToMyLibrary())})),t("ui/icons/discord-large","Community",(()=>{u.track.interaction("join_discord"),m.events.trigger(r.UserActions.JoinDiscord())}),"ui/icons/new-window")],this.add(this.buttons),y.inject.theme.use((e=>{this.buttons.forEach((t=>t.setBackgroundColor(e.oceanShades.dark3)))}))}calculateHeight(){return this.buttons[this.buttons.length-1].y+n.TitleScreen.Layout.buttons.height}updateLayout(){this.buttons.forEach((e=>{e.setSize(this.width,n.TitleScreen.Layout.buttons.height),e.x=0})),a.Arrange.topToBottom({content:this.buttons.map((e=>({object:e}))),spacing:n.TitleScreen.Layout.buttons.spacing,origin:0,y:0}),this.updateSize()}}t.ButtonsPanel=P;class I extends h.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=d.UiBuilder.for(this.scene),this.gameLogo=this.ui.image("logos/game-icon"),this.gameTitle=this.ui.image("logos/game-title"),this.variant="full",this.add([this.gameLogo,this.gameTitle])}updateLayout(){switch(this.variant){case"full":a.Arrange.alignX({content:[this.gameLogo,this.gameTitle],x:this.width/2,origin:.5}),a.Arrange.topToBottom({content:[this.gameLogo,this.gameTitle],y:0,origin:0,spacing:14});break;case"compact":a.Arrange.leftToRight({content:[this.gameLogo,this.gameTitle],x:this.width/2,origin:.5,spacing:14}),this.gameLogo.y=-10,this.gameTitle.y=0}this.updateSize()}calculateHeight(){return this.gameTitle.y+this.gameTitle.height}}t.GameLogo=I},30353:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DashedLine=void 0;const s=i(56824);var n=Phaser.GameObjects.Graphics;t.DashedLine=class extends n{constructor(e,t){super(e),this.opts=t,this.redraw()}redraw(){const{from:e,to:t,dashLength:i}=this.opts,n=new Phaser.Math.Vector2(e.x,e.y);s.random.reset(e.x+e.y+t.x+t.y),new Phaser.Math.Vector2(s.random.numberBetween(e.x,t.x),s.random.numberBetween(e.y,t.y));const o=new Phaser.Math.Vector2(t.x,t.y),a=new Phaser.Curves.Line(n,o).getSpacedPoints(void 0,i);this.clear(),this.lineStyle(8,this.opts.color),this.fillStyle(this.opts.color);for(let e=0;e<a.length-1;e+=2){const t=a[e],i=a[e+1];this.lineBetween(t.x,t.y,i.x,i.y)}}updateGeometry(e,t){this.opts.from=e,this.opts.to=t,this.redraw()}}},30484:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverlayModes=void 0;const s=i(61271),n=i(42415),o=i(58963),a=i(67177);t.OverlayModes={disabled:new s.DisabledOverlayMode,spectating:(e={})=>new n.SpectatingOverlayMode(e),playing:e=>new o.PlayingOverlayMode(e),pickLandingSpot:()=>new a.PickLandingSpotOverlayMode}},30650:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AttitudeEmojiManager=void 0;const s=i(56824),n=i(55776),o=i(20693),a=i(80268),r=i(97849),l=i(8358),c=i(24560),d=i(91622),h=i(45084),u=i(54825),p=i(68878),g=s.logger.for("AttitudeEmoji");t.AttitudeEmojiManager=class{constructor(e,t,i){this.scene=e,this.pool=t,this.tiles=i,this.emojis=new Map,this.originFaction=void 0,this.alpha=1,this.focusedHex=void 0,this.lastSyncedState=void 0,this.scheduledForRemoval=new Set,this.commentsBuilder=new c.CommentsBuilder(this)}clear(){Array.from(this.emojis.keys()).forEach((e=>this.remove(e))),this.originFaction=void 0}syncWithModel(e,t,i=1){const s=t??e.currentPhase.faction;this.lastSyncedState===e.state&&this.originFaction?.id===s?.id||(this.lastSyncedState=e.state,this.originFaction?.id!==s?.id&&this.clear(),this.originFaction=s,this.alpha=i,s&&this.updateAll(e.factions))}setFocusedHex(e){const t=u.app.getCurrentGameStateModel().regions;this.focusedHex=e;const i=e?t.byHex(e):void 0;for(let[s,n]of this.emojis.entries())void 0!==i&&t.byHex(s)===i?n.lookAtHex(e):n.resetLook()}setSelectedEmoji(e){if(this.selected&&!this.selected.isDestroyed){if(this.selected.tile?.hex===e)return;this.selected.horizontalOffset.transitionTo(0),this.selected.shutUp(),this.selected=void 0}e?(this.selected=this.emojis.get(e),this.selected&&this.selected.horizontalOffset.transitionTo(-6)):this.selected=void 0}showChatter(e,t,i,s){const n=this.emojis.get(e);if(n){const o=(0,l.estimateReadingTimeMs)(t);n.talk((0,l.addLineBreaks)(30,t),s??300,o),i&&this.showEmotion(e,i,o)}}setThinkingFaction(e){if(this.thinkingFactionId!==e?.id){if(this.thinkingFactionId){const e=u.app.getCurrentGameStateModel().factions.byId(this.thinkingFactionId);this.thinkingFactionId=void 0,e&&this.originFaction&&this.update(e,this.originFaction)}if(e){this.thinkingFactionId=e.id;const t=o.HexGroup.union(e.getRegions().map((e=>e.getTownHexes())));for(let e of t)g.info(`setting thinking face on ${e}`),this.emojis.get(e)?.container.setFace("thinking-1")}}}updateAll(e){if(this.originFaction){this.scheduledForRemoval=new Set(this.emojis.keys());for(let t of e.all())t.id===this.originFaction.id||t.isLocalPlayer()||t.isNeutral()||!t.isAlive()||this.update(t,this.originFaction);for(let e of this.scheduledForRemoval)this.remove(e)}}update(e,t,i){if(!e.isAlive())return;const s=o.HexGroup.union(e.getRegions().map((e=>e.getTownHexes()))),n=e.relativeScaledPower;if(!e.isAlive())return;if(this.thinkingFactionId===e.id)return void s.forEach((e=>this.scheduledForRemoval.delete(e)));const l=a.AIPolitics.getOpenHostilityTowards(e.state,t,e.id);for(let t of s)this.setHex(t,e.persona.race,e.persona.headwear,n,l);if(i){(0,r.assert)(i.stateBefore!==i.stateAfter,"invalid change.stateAfter (same as stateBefore)");const o=l-a.AIPolitics.getOpenHostilityTowards(i.stateBefore,t,e.id);for(let e of s)this.emojis.get(e).reactTo({reason:i.reason,creditDelta:i.creditDelta,openHostilityDelta:o,newOpenHostility:l,newConfidence:n,sourceHex:i.sourceHex});const c=e.getLiveRegions().sort(((e,t)=>t.size-e.size)).flatMap((e=>e.getTownHexes().toArray())).find((e=>u.app.scene.worldMap.cameraController.isHexVisible(e)));c&&"on"===d.inject.userData.recallChoice("rivalAIChatter")&&!(0,p.isViewingReplay)()&&h.CurrentPhase.model(i.stateBefore).faction?.isLocalPlayer()&&this.commentsBuilder.addReaction(c,o,i.reason)}}setHex(e,t,i,s,o){const a=this.emojis.get(e);if(this.scheduledForRemoval.delete(e),a&&!a.isDestroyed)a.setAttitude(s,o),a.setAlpha(this.alpha),a.setRace(t),a.setHeadwear(i);else{const a=new n.EmojiObject(this.pool);a.attachToTile(this.tiles.getByHex(e.id)),this.emojis.set(e,a),a.setAttitude(s,o),a.setAlpha(this.alpha),a.setRace(t),a.setHeadwear(i),this.focusedHex&&this.focusedRegion?.id===u.app.getCurrentGameStateModel().regions.byHex(this.focusedHex)?.id?a.lookAtHex(this.focusedHex):a.resetLook()}}get focusedRegion(){if(this.focusedHex)return u.app.getCurrentGameStateModel().regions.byHex(this.focusedHex)}remove(e){const t=this.emojis.get(e);t&&(t.destroy(),this.emojis.delete(e))}getAll(){return Array.from(this.emojis.values())}playCreditChange(e){const t=u.app.getCurrentGameStateModel().factions;if(!t.byId(e.towardsFactionId)?.isLocalPlayer())return;const i=t.byId(e.fromFactionId),s=t.byId(e.towardsFactionId);r.assert.defined(i),r.assert.defined(s),this.update(i,s,e)}showEmotion(e,t,i){const s=this.emojis.get(e);s&&s.showEmotion(t,i)}clearChatter(){this.getAll().forEach((e=>e.shutUp()))}}},30948:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseUIScene=void 0;const s=i(20518),n=i(36868),o=i(91622),a=i(54825),r=i(2297);class l extends s.BaseScene{constructor(e){super(e)}create(){super.create(),this.cameras.main.setZoom(o.inject.ui.scale()).setOrigin(0,0).setRoundPixels(!0),this.observe.watch(o.inject.ui.scale,(e=>{e!==this.cameras.main.zoom&&(this.cameras.main.setZoom(e).setOrigin(0,0).setRoundPixels(!0),this.preUpdate.makeDirty())})),this.observe.watch(o.inject.ui.sidebarMode,(e=>{this.preUpdate.makeDirty()})),this.scale.on("resize",(()=>{a.app.device.updateScreenSize(),this.preUpdate.makeDirty()})),this.input.on("pointerdown",((e,t)=>{this.currentTooltipToggledManually||this.closeCurrentTooltip()})),this.input.on("pointerover",((e,t)=>{t.length&&(e.wasTouch||t[0]!==this.currentTooltipTarget&&this.showTooltipFor(t[0],!1))})),this.input.on("pointerout",((e,t)=>{e.wasTouch||this.closeCurrentTooltip()})),this.events.on(Phaser.Scenes.Events.WAKE,(()=>{this.preUpdate.makeDirty()})),this.observe.event(n.UserActions.ToggleTooltip,(({object:e})=>{e.scene===this&&this.toggleTooltipFor(e)}))}closeCurrentTooltip(){this.currentTooltip===a.app.tooltips.currentTooltip&&(a.app.tooltips.close(),this.currentTooltip=void 0,this.currentTooltipTarget=void 0,this.currentTooltipToggledManually=void 0)}showTooltipFor(e,t=!0){const i=this.getTooltipFor(e);i?(this.currentTooltip=a.app.tooltips.showOver(e,i&&{...i,delayMs:t?0:i.delayMs,type:r.TooltipType.Hover}),this.currentTooltipTarget=e,this.currentTooltipToggledManually=t):a.app.tooltips.close()}toggleTooltipFor(e){this.currentTooltipTarget===e&&this.currentTooltip?.visible?this.closeCurrentTooltip():this.showTooltipFor(e,!0)}getTooltipFor(e){const t=e.getData("tooltip");return"string"==typeof t?{title:t,delayMs:e.getData("tooltipDelay")}:void 0}}t.BaseUIScene=l},30963:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CameraZoomController=t.CAMERA_ZOOM_LEVELS=t.DEFAULT_CAMERA_ZOOM=void 0;const s=i(56824),n=i(41229),o=i(9292),a=i(2543);t.DEFAULT_CAMERA_ZOOM=3.945,t.CAMERA_ZOOM_LEVELS=[2.35,3,t.DEFAULT_CAMERA_ZOOM,5,6,7],s.logger.for("CameraZoomController"),t.CameraZoomController=class{constructor(e){this.pinchStartPointerDistance=0,this.pinchStartCameraDistance=0,this.camera=e.camera,this.scene=e.camera.scene,this.pointersTracker=e.pointersTracker;const i=e.zoomLevels??t.CAMERA_ZOOM_LEVELS;this.cameraDistance=new n.KineticValue(t.DEFAULT_CAMERA_ZOOM,{name:e.name+".cameraDistance",scene:this.scene,drag:40,min:i[0],max:i[i.length-1],continueToNextStopThreshold:.1,stops:i,apply:e=>{const t=e*e*.0654762-.0952381*e+.357143;this.camera.setZoom(1/(0,a.round)(t,2))}})}applyScroll(e){const t=.015*e;(0,o.sign)(this.cameraDistance.speed)!==(0,o.sign)(t)&&(this.cameraDistance.freeze(),this.cameraDistance.unfreeze()),0!==e&&this.cameraDistance.accelerate(t)}get currentZoom(){return this.cameraDistance.value}zoomTo(e,t){switch(this.cameraDistance.ignoreBounds=!0,t){case"instant":this.cameraDistance.setTo(e);break;case"fast":this.cameraDistance.tweenTo(e,200,"Sine.easeInOut");break;default:this.cameraDistance.tweenTo(e,t,"Sine.easeInOut")}}startPinchZoom(){this.pinchStartPointerDistance=this.pointersTracker.distanceBetweenPointers,this.cameraDistance.freeze(),this.pinchStartCameraDistance=this.cameraDistance.value}stopPinchZoom(){this.cameraDistance.unfreeze(),this.pinchStartCameraDistance=0,this.pinchStartPointerDistance=0}get isPinchZooming(){return 0!==this.pinchStartCameraDistance}update(e,t){if(this.isPinchZooming){const e=this.pointersTracker.distanceBetweenPointers,t=this.pinchStartPointerDistance/e;this.cameraDistance.setTo(this.pinchStartCameraDistance*t)}else this.cameraDistance.update(e,t)}}},31011:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapMutationBuilder=t.MapDataSet=void 0;const s=i(2543),n=i(20026),o=i(97849),a=i(1326),r=i(88023);t.MapDataSet=class{constructor(e){this.key=e,this.defaultValue=(0,r.ImmutableMap)()}deserialize(e){let t=(0,r.ImmutableMap)();return Object.entries(e).forEach((([e,i])=>{t=t.set(Number(e),i)})),t}serialize(e){return e.toJS()}apply(e,t){return e.withMutations((e=>{t.updated?.forEach((([t,i])=>{void 0===i?e.deleteIn([this.key,t]):e.setIn([this.key,t],i)}))}))}createMutation(e,t){let i={updated:[]};if(e.set&&!(0,s.isEmpty)(e.set)&&(i.updated=Object.entries(e.set).map((([e,t])=>[Number(e),t]))),e.delete&&!(0,s.isEmpty)(e.delete)){const t=e.delete.map((e=>[e,void 0]));i.updated.push(...t)}return{dataSet:this,changes:i,context:`${this.key}/${t}`}}getEntryById(e,t){return e.getIn([this.key,t])}entryToString(e){return e.toString()}entryToDebugString(e){return JSON.stringify(e)}getEntryIds(e){return e.get(this.key)?.keySeq().toArray()||[]}toString(){return`[MapDataSet "${this.key}"]`}mergeMutations(e,t){const i=(0,a.dictionaryOf)(e.updated??[],0),s=(0,a.dictionaryOf)(t.updated??[],0);return console.log("MERGING MapDataSet mutations",this.key,e,t),Object.assign(i,s),{updated:Object.values(i)}}},t.MapMutationBuilder=class{constructor(e){this.dataSet=e}init(e){return this.state=e,this._entriesToSet={},this._entriesToDelete=new Set,this}set(e,t){return o.assert.defined(this.state,"builder not initialized!"),this._entriesToDelete.delete(e),this._entriesToSet[e]=t,this}setFromBootstrap(){o.assert.defined(this.state,"builder not initialized!"),(0,o.assert)((0,n.isProjectionDataSet)(this.dataSet),`Cannot call setFromBootstrap on ${this.dataSet} - it's not a projection`),this._entriesToSet=this.dataSet.bootstrap(this.state).toObject()}delete(e){o.assert.defined(this.state,"builder not initialized!"),delete this._entriesToSet[e],this._entriesToDelete.add(e)}deleteAll(){this.dataSet.getEntryIds(this.state).forEach((e=>this.delete(e)))}getCurrent(e){if(o.assert.defined(this.state,"builder not initialized!"),!this._entriesToDelete.has(e))return this._entriesToSet.hasOwnProperty(e)?this._entriesToSet[e]:this.state.getIn([this.dataSet.key,e])}has(e){return!!this.get(e)}get(e){if(o.assert.defined(this.state,"builder not initialized!"),!this._entriesToDelete.has(e))return this._entriesToSet[e]}getEntries(){return o.assert.defined(this.state,"builder not initialized!"),this._entriesToSet}clear(){throw new Error("Not Implemented")}createMutation(e){return o.assert.defined(this.state,"builder not initialized!"),this.dataSet.createMutation({set:this._entriesToSet,delete:Array.from(this._entriesToDelete).filter((e=>void 0!==this.state.getIn([this.dataSet.key,e])))},e)}setAll(e,t){e.forEach((e=>this.set(e,t)))}}},31055:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionNeighboursView=void 0;const s=i(24598),n=i(90952),o=i(20754),a=i(56824),r=i(76439),l=i(19618),c=i(78635),d=i(56038),h=i(70712),u=i(12543),p=i(45664);a.logger.for("FactionNeighbours");class g extends o.LazyView{constructor(){super([n.GameState.ai.regionInfluenceByHex,n.GameState.regions.byHex,n.GameState.factions.byRegion]),this.name="factionNeighbours"}calculate(e,t){const i={};for(let s of this.getInfluencedHexes(e,t)){const t=h.AI.getHexImportance(e,s.id).value,n=m(c.Warfare.getHexDefense(e,s))*t,o=d.Regions.model(e).byHex(s);if(!o?.isAlive())continue;const a=o.faction.id;i[a]=i[a]?i[a]+n:n}return i}getInfluencedHexes(e,t){const i=new Set,s=l.Factions.model(e).byId(t);for(let t of s.getLiveRegions()){const s=t.getAssets().getMaxSustainableMight(),n=t.getHostileBorderHexes().filter((t=>h.AI.getHexAge(e,t.id)>0)).neighbours().filter((i=>d.Regions.getByHex(e,i.id)!==t.id));for(let t of n)s>c.Warfare.getHexDefense(e,t)&&i.add(t)}return i}getCacheKey(e){return e}getDebugLayer(e){return new r.GameStateDebugLayer((0,u.hexBasedAdapter)({getValue:(t,i)=>{const n=(0,p.getHex)(i);if(l.Factions.model(t).byId(e),l.Factions.getByHex(t,i)!==e&&c.Warfare.getOccupyingPawn(t,n)?.type===s.PawnType.Town){const s=l.Factions.getByHex(t,i);return this.get(t,e)[s]}if(this.getInfluencedHexes(t,e).has(n))return(m(c.Warfare.getHexDefense(t,n))*h.AI.getHexImportance(t,n.id).value).toFixed(1)},getDetail:(t,i)=>{const s=(0,p.getHex)(i);if(this.getInfluencedHexes(t,e).has(s))return`= ${m(c.Warfare.getHexDefense(t,s))} x ${h.AI.getHexImportance(t,s.id).value}`}}))}}function m(e){switch(e){case 0:return 1;case 1:return.25;default:return.05}}t.FactionNeighboursView=g},31138:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.overworldToPlaySceneTransition=async function(){const e=n.app.scene.overworldUI,t=n.app.scene.overworld,i=s.config.screenTransitionDuration,a=n.app.scene.worldMap;a.cameraController.center(0,{offsetY:-58,offsetX:12}),a.cameraController.zoomController.zoomTo(2.1*o.DEFAULT_CAMERA_ZOOM,"instant"),a.cameraController.zoomController.zoomTo(o.DEFAULT_CAMERA_ZOOM,i),t.zoomController.zoomTo(.25,i);const r=t.islands.objectsById[t.islands.selectedIslands[0]];r?.preview?.setVisible(!1),e.selectedLevelControls.activeUI.transitionOut(),e.levelDetailUI.transitionOut(),await new Promise((e=>{n.app.scene.menuHeaderUI.waves.transitionIn(i).then(e),t.tweens.add({targets:[t.cameras.main],props:{alpha:0},duration:i})})),t.scene.setVisible(!1),t.cameras.main.setAlpha(1),t.zoomController.zoomTo(o.DEFAULT_CAMERA_ZOOM,"instant"),r?.preview?.setVisible(!0)};const s=i(56824),n=i(54825),o=i(30963)},31371:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SpawnGiftsPlugin=void 0;const s=i(18497),n=i(74370);t.SpawnGiftsPlugin={name:s.PluginKey.SpawnGifts,displayName:"Spawn Presents",icon:"ui/level-features/spawn-gifts",register(e){e.mapEditor.adjustToolPalette.register((e=>(e.other.push({tool:n.EDITOR_TOOL.addSpawner}),e)))}}},31722:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.verifyWorldMapInSync=function(e,t){const i=new s.StaticGameStateModel(t),a=i.map.getAllHexes();for(const e of a)r(e);function r(t){const s=i.pawns.getCount(t,n.PawnType.Coins);var a,r,l;a=t,(r=e.coins.getOrCreatePile(t).getCurrentAmount())!==(l=s)&&o.error(`Integrity check failed on ${a}! Expected coinsx${r}, found ${l}`)}o.info("WorldMapScene integrity check completed.")};const s=i(72273),n=i(24598),o=i(56824).logger.for("integrity")},31835:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionsDataSetModel=void 0;const s=i(20026),n=i(48042),o=i(90952),a=i(1326),r=i(20693),l=i(56038),c=i(94399);class d extends c.BaseModel{constructor(){super(...arguments),this.regionModels={}}all(){return(0,s.selectFromState)(this.state,o.GameState.regions.byId).keySeq().toArray().map((e=>this.byId(e)))}allRegionsHexes(){return r.HexGroup.fromIds(l.Regions.getAllRegionsHexes(this.state))}boundingBox(){return l.Regions.getBoundingBox(this.state)}byHex(e){let t="number"==typeof e?e:e.id;const i=l.Regions.getByHex(this.state,t);return i?this.byId(i):void 0}byId(e){if(l.Regions.getRegionData(this.state,e))return(0,a.getOrCreate)(this.regionModels,e,(()=>new n.RegionModel(this,e)))}nextId(){return l.Regions.getNextId(this.state)}create(e,t=r.HexGroup.empty){const i=this.nextId();return this.state=l.Regions.createRegion(this.state,i,e,t.toIdsArray()),this.byId(i)}destroy(...e){this.state=l.Regions.destroyRegions(this.state,...e.map((e=>e.id)))}clear(){this.destroy(...this.all())}}t.RegionsDataSetModel=d},32202:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.zombifyLevel=function(e){const t=new Set;let i=(e.pawns??{}).map((e=>e.type===s.PawnType.Bandit?{...e,type:s.PawnType.Zombie}:e.type===s.PawnType.Camp?(t.add(e.hex),{...e,type:s.PawnType.HauntedTown}):e));return i=i.filter((e=>e.type!==s.PawnType.Coins||!t.has(e.hex))),{...e,pawns:i}},t.dezombifyLevel=function(e){return{...e,pawns:e.pawns?.map((e=>[s.PawnType.Zombie,s.PawnType.LadderZombie,s.PawnType.DreadKnight].includes(e.type)?{...e,type:s.PawnType.Bandit}:e.type===s.PawnType.HauntedTown?{...e,type:s.PawnType.Camp}:e))}},t.zombifyLevelModel=function(e){const t=e.pawns.select({type:[s.PawnType.Camp]});for(let i of t){const t=e.pawns.findOne({hexes:i.hex,type:[s.PawnType.Coins]});t&&t.destroy(),i.replaceWith(s.PawnType.HauntedTown)}const i=e.pawns.select({type:[s.PawnType.Bandit]});for(let e of i)e.replaceWith(s.PawnType.Zombie);const r={plugins:(0,a.stripDuplicatesFrom)([...n.WorldMap.get(e.state).plugins,o.PluginKey.Zombies]),winConditions:[{type:"defeat-all-rivals"},{type:"destroy-haunted-towns"}]};e.stateEngine.setState(n.WorldMap.update(e.state,r))};const s=i(24598),n=i(59956),o=i(18497),a=i(1326)},32402:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.autoArrowsGenerator=function(e){return{getParents(t,i){const s=e(t,i);if("object"==typeof s)return s.parent?[n(s.parent)]:s.parents?s.parents.map(n):void 0},getChildren(t,i){const o=e(t,i);if("object"==typeof o)return o.child?[n(o.parent)]:o.children?o.children.map(n):o.rootId&&o.distance?(0,s.getHex)(i).neighbours((i=>{const s=e(t,i.id);return s&&s.rootId===o.rootId&&s.distance<o.distance})).toIdsArray():void 0}}};const s=i(45664);function n(e){return"object"==typeof e?e.id:e}},32408:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleGameOver=function(e){const t=1===e.winningFactionId?s.LevelOutcome.Victory:s.LevelOutcome.Defeat;o.events.trigger(n.SystemEvents.ShowGameOverScreen(t))};const s=i(18811),n=i(36868),o=i(56824)},32410:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.victoryBaseTransitionOut=async function(){const e=s.config.screenTransitionDuration,t=n.app.scene.victory;await new Promise((i=>{t.preUpdate(),t.tweens.add({targets:t.backgroundOverlay,alpha:{start:1,to:0},duration:e}),t.tweens.add({targets:t.ribbonText,alpha:{from:1,to:0},duration:e/2}),t.tweens.add({targets:t.ribbon,x:{from:t.ribbon.x,to:t.ribbon.x+150},width:{from:400,to:100},alpha:{from:1,to:0},duration:e,ease:Phaser.Math.Easing.Expo.Out,onComplete:i}),t.tweens.add({delay:2*e/3,targets:t.trophy,alpha:{start:1,to:0},duration:e/3}),t.tweens.add({delay:e/2,targets:[t.shield],scale:{from:1,to:0},alpha:{start:1,to:0},duration:e/2}),t.tweens.add({targets:[t.shieldOutline,t.victoryHalo,t.victoryRays],alpha:{start:1,to:0},scale:{start:1,to:.2},duration:2*e/3,ease:Phaser.Math.Easing.Sine.In}),t.tweens.add({targets:[t.primaryButton,t.secondaryButton,t.ternaryButton,t.replayButton,t.levelInfoPanel].filter((e=>e.visible)),alpha:{start:1,to:0},duration:e/3})}))};const s=i(56824),n=i(54825)},32636:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReinforcementsLevelModule=void 0;const s=i(37971),n=i(45664),o=i(91622),a=i(54825),r=i(95428),l=i(36868),c=i(24598),d=i(2297);t.ReinforcementsLevelModule=class{constructor(){this.main=new h(this)}};class h extends s.LevelScript{constructor(){super(...arguments),this.reinforcementsTooltip=null}activate(){super.activate();const e=o.inject.gameStateModel.currentPhase.turnNumber;1===e&&a.app.scene.playUI.updateState({worldMapPanel:{type:"tutorial",emojiEmotion:r.EmojiEmotion.DeeplyWorried,text:"The invasion has begun! We have to [b]SURVIVE[/b] until our reinforcements arrive!",buttons:[]}}),this.updateReinforcementsTooltip(),this.onEvent(l.GameStateEvents.FactionTurnStarted,(t=>{1===t.factionId&&10===o.inject.gameStateModel.currentPhase.turnNumber?(o.inject.gameStateController.executePlay(l.Plays.SpawnUnits({hexId:2012,factionId:1,units:[{pawnType:c.PawnType.Town,count:1},{pawnType:c.PawnType.Coins,count:400}]})),a.app.scene.playUI.updateState({worldMapPanel:{type:"tutorial",emojiEmotion:r.EmojiEmotion.VeryHappy,text:"The reinforcements are here!",buttons:[]}}),this.reinforcementsTooltip&&(this.reinforcementsTooltip.hide(!0),this.reinforcementsTooltip=null)):e<10&&this.updateReinforcementsTooltip()})),this.onEvent(l.GameStateEvents.HexCaptured,(e=>{a.app.scene.playUI.updateState({worldMapPanel:null})}))}deactivate(){super.deactivate(),this.reinforcementsTooltip?.hide(!0)}updateReinforcementsTooltip(){this.reinforcementsTooltip?.hide(!0);const e=10-o.inject.gameStateModel.currentPhase.turnNumber;e<=0||(this.reinforcementsTooltip=a.app.tooltips.showAtHex((0,n.getHex)(2012),{type:d.TooltipType.Permanent,icon:"lock",typewriter:!1,displayBelow:!0,delayMs:0,title:"Reinforcements\n arrive "+(e>1?`in ${e} turns.`:"next turn!")}))}}},32869:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FeedbackWidgetContent=t.FeedbackWidget=t.FeedbackPanel=void 0,t.createSocialsFootnote=I;const s=i(80959),n=i(96137),o=i(52528),a=i(7169),r=i(6838),l=i(76049),c=i(20087),d=i(25988),h=i(15956),u=i(86545),p=i(54118),g=i(91622),m=i(93102),y=i(54825),f=i(76816),w=i(1565),v=i(56824),b=i(75742);var S=Phaser.GameObjects.BitmapText;class x extends h.WidgetsContainer{constructor(e){super(e),this.setWidgets([new T(e),I(e,0)])}}t.FeedbackPanel=x;class T extends d.SideBarWidget{constructor(e){super(e,{title:"Have feedback?"}),this.setContent(new P(e))}}t.FeedbackWidget=T;class P extends u.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=s.UiBuilder.for(this.scene),this.messageField=new a.TextArea(this.scene,{rows:7,maxLength:b.MAX_FEEDBACK_LENGTH,placeholder:"Write your message here",onChange:e=>{this.submitButton.setEnabled(!!e.trim())},className:"themed"}),this.emailField=new r.TextInput(this.scene,{width:200,placeholder:"email@example.com",className:"themed"}),this.emailFieldLabel=new S(this.scene,0,0,l.BitmapFont.Mini,"Add email if you'd like to hear back from me").setTint(n.Colors.glassUi_old.backgroundText),this.submitButton=this.ui.outlineButton({text:"Send!",variant:"large",theme:"islandCard",onClicked:()=>{var e,t,i;e=s.UiBuilder.for(this.scene),t=g.inject.levelSession.levelId,i={comment:this.messageField.text.trim()||void 0,email:this.emailField.text.trim()||void 0},g.inject.userData.rememberChoice("feedbackEmail",i.email),v.events.trigger(f.ReportingEvents.SubmitFeedbackForm({levelId:t,email:i.email,mood:i.mood,comment:i.comment})),g.inject.ui.sidebarMode.set(void 0),y.app.notifications.add({style:w.NotificationStyle.Success,scope:w.NotificationScope.Global,timeout:3e3,clickable:!0,icon:e.image("ui/icons/heart"),cancelTimeoutOnHover:!1,content:e.vLayout({spacing:10,content:[e.glassUi.caption("Thank you so much!"),e.glassUi.paragraph("Feedback sent.")]})}),this.messageField.setText(""),this.submitButton.setEnabled(!1)}}),this.message=s.UiBuilder.for(e).richText("Hi, I'm Mike, the developer behind this game, and I'd love to hear from you!\n\nWhether it's a [b]bug report[/b], an [b]idea for improvement[/b], or just a simple thank you, [b]all feedback is much appreciated![/b]",n.Colors.glassUi_old.backgroundText),this.submitButton.setEnabled(!1),this.emailField.setValue(g.inject.userData.recallChoice("feedbackEmail")??""),g.inject.theme.use((e=>{this.message.setTint(e.white),this.emailFieldLabel.setTint(e.white)})),this.add([this.message,this.messageField,this.emailFieldLabel,this.emailField,this.submitButton])}calculateHeight(){return this.submitButton.y+this.submitButton.height}updateLayout(){const e=o.SIDEBAR_LAYOUT.contentPadding,t=this.width;this.message.setWordWrapWidth(t),this.message.setPosition(e,e).setOrigin(0,0),this.messageField.width=t,this.emailField.width=t,this.submitButton.width=t;const i=[this.message,20,this.messageField,10,this.emailFieldLabel,5,this.emailField,20,this.submitButton];c.Arrange.topToBottom({content:i,y:0,origin:0,spacing:0}),c.Arrange.alignX({content:[this.message,this.messageField,this.emailFieldLabel,this.emailField,this.submitButton],x:0,origin:0}),this.updateSize()}}function I(e,t=1){const i=s.UiBuilder.for(e);return i.vLayout({layoutPolicy:p.LayoutChildrenPolicy.None,originY:0,content:[i.hLayout({layoutPolicy:p.LayoutChildrenPolicy.None,originX:t,content:[i.text("You can also",l.BitmapFont.Mini,(e=>e.white)),(0,m.createTwitterStealthButton)(i,"white")],originY:.5,spacing:2,horizontalPadding:o.SIDEBAR_LAYOUT.contentPadding}),i.hLayout({layoutPolicy:p.LayoutChildrenPolicy.None,originX:t,content:[i.text("or",l.BitmapFont.Mini,(e=>e.white)),(0,m.createDiscordStealthButton)(i,"white")],originY:.5,spacing:2,horizontalPadding:o.SIDEBAR_LAYOUT.contentPadding})],spacing:6})}t.FeedbackWidgetContent=P},33020:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverworldFooterControlsLarge=t.LARGE_LAYOUT=void 0;const s=i(58609),n=i(80959),o=i(7782),a=i(76049),r=i(91622),l=i(20087),c=i(56824),d=i(85311),h=i(61116),u=i(11466),p=i(20227),g=i(36014);t.LARGE_LAYOUT={footerHeight:80,contentPadding:u.DEFAULT_CONTENT_PADDING},t.OverworldFooterControlsLarge=class{constructor(e,t){this.scene=e,this.tweener=new p.Tweener(this.scene);const i=n.UiBuilder.for(e);this.primaryButton=i.wood.primaryButton({text:"PLAY",iconPlacement:"right",icon:"ui/wood-icons/arrow-right",width:180,onClicked:this.handlePrimaryButtonClicked.bind(this)}),this.primaryButtonX=o.Control.propOf(this.primaryButton,"x",{duration:200,ease:"Sine.easeOut"}),this.primaryButtonVisibility=o.Control.propOf(this.primaryButton,"alpha",{duration:200}),this.flatButton=i.outlineButton({text:"?",iconPlacement:"left",icon:"ui/button-icons/search",onClicked:this.handlePrimaryButtonClicked.bind(this),variant:"large",theme:"white",width:180}),this.flatButtonVisibilty=o.Control.propOf(this.flatButton,"alpha"),this.difficultyLabel=i.text("Rivals Difficulty",a.BitmapFont.Mini,0),this.difficultyToggle=new s.DifficultyToggle(e,{theme:g.ToggleThemes.oceanDark,height:42}),this.difficultyControlsVisibility=new o.TransitionController(e,{duration:100,ease:"Sine.easeInOut",initialValue:0,applyValue:e=>{this.difficultyToggle.setAlpha(e),this.difficultyLabel.setAlpha(e)}}),this.inBattleOverlay=new d.InBattleOverlay(e).setSize(460,64),this.inBattleOverlayVisibility=new o.TransitionController(e,{ease:"Sine.easeInOut",initialValue:0,duration:100,applyValue:e=>{this.inBattleOverlay.x=this._getBattleOverlayX()+60*(1-e),this.inBattleOverlay.setAlpha(e)}}),this.bottomAnchoredObjects=[this.inBattleOverlay,this.difficultyToggle,this.difficultyLabel,this.primaryButton,this.flatButton],this.layer=new h.ResponsiveLayer(this.scene,this.bottomAnchoredObjects),this.scene.add.existing(this.layer),this.updateState(t),r.inject.theme.use((e=>{this.difficultyLabel.setTint(e.oceanContrastLight)}))}handlePrimaryButtonClicked(){this.onPrimaryButtonClick()}_getBattleOverlayX(){return this.scene.bounds.contentRight-this._getRightPadding()-this.inBattleOverlay.width}updateLayout(){this.primaryButtonX.setTo(this._getPrimaryButtonX(this.currentState)),this.flatButton.x=this.scene.bounds.contentRight-this._getRightPadding()-this.flatButton.width,l.Arrange.leftToRight({content:[this.difficultyLabel,this.difficultyToggle],spacing:8,origin:1,x:this.scene.bounds.contentRight-this._getRightPadding()-t.LARGE_LAYOUT.contentPadding-this.primaryButton.width}),l.Arrange.alignY({content:[this.difficultyLabel,this.difficultyToggle,this.primaryButton,this.inBattleOverlay,this.flatButton],y:this.scene.bounds.height-t.LARGE_LAYOUT.footerHeight/2,origin:.5}),this.inBattleOverlay.x=this._getBattleOverlayX(),this.inBattleOverlay.updateLayout(),this.updateState(this.currentState,"instant")}transitionOut(e=c.config.screenTransitionDuration,t=void 0){this.tweener.stop(),this.updateLayout(),this.tweener.add({targets:this.bottomAnchoredObjects,y:"+=160",duration:e,ease:"Sine.easeIn"})}transitionIn(e=c.config.screenTransitionDuration){this.tweener.stop(),this.updateLayout(),this.tweener.add({targets:this.bottomAnchoredObjects,props:{y:{getStart:e=>e.y+160,getEnd:e=>e.y}},duration:e,ease:"Sine.easeIn"})}_getPrimaryButtonX(e){const t="in-battle"===e.footerLayout.mode?46:0;return this.scene.bounds.contentRight-this._getRightPadding()-t-this.primaryButton.width}_getRightPadding(){return t.LARGE_LAYOUT.contentPadding+(c.config.flags.avoidBottomRightCorner?32:0)}updateState(e,t="transition"){switch(this.currentState=e,this.primaryButtonX.setTo(this._getPrimaryButtonX(e),t),this.onPrimaryButtonClick=e.primaryButton?.onClick??(()=>{}),e.footerLayout.mode){case"no-level-selected":this.flatButton.content.setText(e.primaryButton?.title),this.flatButtonVisibilty.setTo(e.primaryButton?1:0,t),this.primaryButtonVisibility.setTo(0,t),this.difficultyControlsVisibility.setTo(0,t),this.inBattleOverlayVisibility.setTo(0,t);break;case"unlocked-level-selected":this.flatButtonVisibilty.setTo(0,t),this.primaryButton.content.setText(e.primaryButton?.title),this.primaryButtonVisibility.setTo(1,t),this.difficultyControlsVisibility.setTo(e.footerLayout.canSelectDifficulty?1:0,t),this.difficultyToggle.setValue(r.inject.userData.recallChoice("aiDifficulty")),this.inBattleOverlayVisibility.setTo(0,t);break;case"in-battle":this.flatButtonVisibilty.setTo(0,t),this.primaryButton.content.setText(e.primaryButton?.title),this.primaryButtonVisibility.setTo(1,t),this.difficultyControlsVisibility.setTo(0,t),this.inBattleOverlayVisibility.setTo(1,t),this.inBattleOverlay.subTitle.setText(e.footerLayout.subtitle)}}activate(e){this.layer.setVisible(!0),this.updateState(e,"instant"),this.updateLayout()}deactivate(){this.layer.setVisible(!1)}}},33071:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SnapshotDetailsWidgetContent=t.VersionsWidgetContent=t.ManageTabContent=void 0;const s=i(86545),n=i(80959),o=i(15956),a=i(91622),r=i(56824),l=i(20034),c=i(20087);var d=Phaser.GameObjects.Line;class h extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.widgets=new o.WidgetsContainer(this.scene),this.versionsWidget=this.ui.sidebarWidget({title:"Version History",content:new u(this.scene)}),this.detailsWidget=this.ui.sidebarWidget({title:"Latest changes",content:new p(this.scene)}),this.widgets.setWidgets([this.versionsWidget,this.detailsWidget]),this.add([this.widgets])}applyState(e){const t=e.availableSnapshots.map(((t,i)=>({text:g(t),key:i.toString(),icon:m(e,0,i),addons:y(t)})));e.hasUnsavedChanges&&t.unshift({text:"[i]Current version[/i]",key:"latest",icon:"ui/button-icons/circled-bullet-point"}),this.versionsWidget.content.listView.setItems(t),this.updateSelection(e),this.versionsWidget.content.updateLayout(),this.versionsWidget.updateLayout()}updateSelection(e){const{selectedVersion:t,hasUnsavedChanges:i,availableSnapshots:s}=e;let n=-1;t?(n=s.indexOf(t.snapshot),this.detailsWidget.setTitle(g(t.snapshot))):this.detailsWidget.setTitle("Current version"),i&&n++,this.detailsWidget.content.applyState(e),this.versionsWidget.content.listView.setSelectedIndex(n,!1)}calculateHeight(){return 0}updateLayout(){this.widgets.width=this.width,this.updateSize()}}t.ManageTabContent=h;class u extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.listView=this.ui.buttonsListView(),this.verticalLine=new d(this.scene).setOrigin(0,0).setLineWidth(1),this.listView.onItemSelected((({item:e})=>{const t=a.inject.editorSession?.getAllSnapshots()[parseInt(e.key)];t?r.events.trigger(l.MapEditorActions.PreviewSnapshot(t)):r.events.trigger(l.MapEditorActions.CancelSnapshotPreview())})),a.inject.theme.use((e=>{this.verticalLine.setStrokeStyle(1,e.white)}),this.verticalLine),this.add([this.verticalLine,this.listView])}calculateHeight(){return this.listView.height}updateLayout(){this.listView.width=this.width,this.listView.updateLayout();const e=this.listView.rows.get();if(e.length>1){const t=e[0],i=e[e.length-1];this.verticalLine.setVisible(!0),this.verticalLine.setPosition();const s=17.5;this.verticalLine.setTo(t.x+s,t.y+t.height/2,i.x+s,i.y+i.height/2),this.verticalLine.setToTop()}else this.verticalLine.setVisible(!1);this.updateSize()}}t.VersionsWidgetContent=u;class p extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.saveButton=this.ui.outlineButton({text:"Save this version",theme:"subtle",icon:"ui/button-icons/checkmark",tooltip:"Save the current state as new version",onClicked:()=>{r.events.trigger(l.MapEditorActions.SaveSnapshot())}}),this.downloadButton=this.ui.outlineButton({text:"Download",theme:"subtle",icon:"ui/button-icons/download",tooltip:"Download this version as a file",onClicked:()=>{r.events.trigger(l.MapEditorActions.DownloadLevel())}}),this.restoreButton=this.ui.outlineButton({text:"Restore",theme:"subtle",tooltip:"Restore this version as the current version",icon:"ui/button-icons/rewind-clock",onClicked:()=>{r.events.trigger(l.MapEditorActions.RestoreSnapshot())}}),this.discardButton=this.ui.outlineButton({theme:"subtle",tooltip:"Discard this version",icon:"ui/button-icons/trash",variant:"circle",onClicked:()=>{r.events.trigger(l.MapEditorActions.DeleteSnapshot())}}),this.renameButton=this.ui.outlineButton({theme:"subtle",variant:"circle",tooltip:"Change the name of this version",icon:"ui/button-icons/edit",onClicked:()=>{r.events.trigger(l.MapEditorActions.RenameSnapshot())}}),this.buttons=[this.saveButton,this.restoreButton,this.downloadButton],this.miniButtons=[this.renameButton,this.discardButton],this.add([...this.buttons,...this.miniButtons])}applyState(e){const t=!!e.selectedVersion,i=e.activeSnapshot!==e.selectedVersion?.snapshot,s=t||e.availableSnapshots.length>0;this.restoreButton.setVisible(t&&i),this.renameButton.setVisible(t),this.saveButton.setVisible(!t&&e.hasUnsavedChanges),this.discardButton.setVisible(s),this.updateLayout()}calculateHeight(){const e=this.buttons[this.buttons.length-1];return e.y+e.height}updateLayout(){this.buttons.forEach((e=>e.width=this.width)),c.Arrange.topToBottom({content:this.buttons,spacing:4,y:0}),c.Arrange.alignY({content:this.miniButtons,y:-10,origin:1}),c.Arrange.leftToRight({content:this.miniButtons,x:this.width,spacing:4,origin:1}),this.updateSize()}}function g(e){return e.label??new Date(e.created).toLocaleString()}function m(e,t,i){return e.hasUnsavedChanges||0!==i?"ui/button-icons/bullet-point":"ui/button-icons/circled-bullet-point"}function y(e){return e.bestReplay?"normal"===e.bestReplay.aiDifficulty?[{icon:"ui/level-features/difficulty-normal"}]:[{icon:"ui/level-features/difficulty-hard"}]:[]}t.SnapshotDetailsWidgetContent=p},33077:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SmallRoundedRectButton=t.LevelMenuPanel=void 0;const s=i(86545),n=i(80959),o=i(96137),a=i(14739),r=i(76049),l=i(36868),c=i(20087),d=i(66143),h=i(39648),u=i(91622),p=i(54825),g=i(11466),m=i(56824),y=i(9292);class f extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.props=t,this.ui=n.UiBuilder.for(this.scene),this.headingPanel=new w(this.scene),this.buttons=new v(this),this.resumeButton=new x(this.scene,(()=>this.handleActionTaken())),this.add([this.headingPanel,this.buttons,this.resumeButton])}updateLayout(){this.headingPanel.width=this.width,this.headingPanel.updateLayout();const e=(0,y.pickSmaller)(200,this.width-60);this.buttons.width=e,this.resumeButton.width=e,this.resumeButton.setVisible(p.app.device.uiVariant()===g.UiVariant.Compact),c.Arrange.topToBottom({content:[{object:this.headingPanel},{object:this.buttons},{object:this.resumeButton}],y:40,origin:0,spacing:40}),c.Arrange.alignX({content:[this.headingPanel,this.buttons,this.resumeButton],x:this.width/2,origin:.5}),this.updateSize()}calculateHeight(){return this.resumeButton.y+this.resumeButton.height}setVisible(e){return e&&(this.headingPanel.updateContent(),this.buttons.rewindButton.livesCounter.setCount(u.inject.levelSession.remainingLives)),super.setVisible(e)}show(){this.headingPanel.updateContent(),this.buttons.rewindButton.livesCounter.setCount(u.inject.levelSession.remainingLives),this.setVisible(!0)}handleActionTaken(){this.props.onAction()}setRewindEnabled(e){this.buttons.rewindButton.setEnabled(e)}}t.LevelMenuPanel=f;class w extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.campaignTitle=this.ui.text("",r.BitmapFont.Small,o.Colors.glassUi_old.primaryText),this.levelName=this.ui.text("",r.BitmapFont.Main,o.Colors.glassUi_old.primaryText),this.turnNumber=this.ui.text("",r.BitmapFont.Mini,o.Colors.glassUi_old.secondaryText),this.add([this.campaignTitle,this.levelName,this.turnNumber])}updateContent(){const e=d.LevelModel.for(u.inject.levelSession.levelId);this.campaignTitle.setText(e.expeditionContext?.expedition.metadata.name??"Conquest"),this.levelName.setText(e.getTitle(d.LevelTitleStyle.Full));const t=u.inject.levelSession.isFixedDifficulty?"":`, ${u.inject.levelSession.aiDifficulty} difficulty`;this.turnNumber.setText(`turn ${u.inject.gameStateModel.currentPhase.turnNumber}${t}`),this.preUpdate.makeDirty()}updateLayout(){c.Arrange.topToBottom({content:[{object:this.campaignTitle},{object:this.levelName},{object:this.turnNumber}],y:0,spacing:6}),c.Arrange.alignX({content:[this.campaignTitle,this.levelName,this.turnNumber],x:this.width/2}),this.updateSize()}calculateHeight(){return this.turnNumber.y+this.turnNumber.height}}class v extends s.AutoHeightResponsiveContainer{constructor(e){super(e.scene),this.parent=e,this.rewindButton=new S(this.scene,{title:"Rewind",icon:"ui/button-icons/rewind",onClick:()=>{this.parent.handleActionTaken(),m.events.trigger(l.UserActions.StartRewind())}}),this.restartButton=new b(this.scene,{title:"Restart",icon:"ui/button-icons/restart",onClick:()=>{this.parent.handleActionTaken(),m.events.trigger(l.UserActions.RestartLevel({}))}}),this.replayButton=new b(this.scene,{title:"View Replay",icon:"ui/button-icons/replay",onClick:()=>{this.parent.handleActionTaken(),u.inject.ui.sidebarMode.set(void 0),m.events.trigger(l.UserActions.ViewReplay())}}),this.leaveButton=new b(this.scene,{title:"Leave",icon:"ui/mini-close-button",onClick:()=>{this.parent.handleActionTaken(),u.inject.ui.sidebarMode.set(void 0),m.events.trigger(l.UserActions.GoBack())}}),this.buttons=[this.rewindButton,this.restartButton,this.replayButton,this.leaveButton],this.add(this.buttons)}updateLayout(){for(let e of this.buttons)e.width=this.width;c.Arrange.topToBottom({content:this.buttons,y:0,origin:0,spacing:20}),this.updateSize()}calculateHeight(){return this.leaveButton.y+this.leaveButton.height}}class b extends a.RoundedRectButton_LEGACY{constructor(e,{title:t,icon:i,onClick:s,extraContent:a}){const l=n.UiBuilder.for(e),c=l.image(i).setTint(o.Colors.glassUi_old.primaryText),d=l.text(t,r.BitmapFont.Small,o.Colors.glassUi_old.primaryText);super(e,{raised:2,content:l.hLayout({content:[c,d,...a??[]],spacing:20,originY:.5,originX:0,horizontalPadding:20})}),this.image=c,this.text=d,this.height=40,this.onClicked(s)}setEnabled(e){super.setEnabled(e);const t=e?o.Colors.glassUi_old.primaryText:o.Colors.glassUi_old.disabledText;this.image.setTint(t),this.text.setTint(t)}}t.SmallRoundedRectButton=b;class S extends b{constructor(e,t){const i=new h.LivesCounter(e).setMode(h.LivesCounterMode.FullColor);super(e,{...t,extraContent:[i]}),this.livesCounter=i}setEnabled(e){super.setEnabled(e),this.livesCounter.setMode(e?h.LivesCounterMode.FullColor:h.LivesCounterMode.Muted)}updateLayout(){super.updateLayout(),this.livesCounter.x=162}}class x extends a.RoundedRectButton_LEGACY{constructor(e,t){const i=n.UiBuilder.for(e);super(e,{raised:2,content:i.hLayout({content:[i.image("ui/level-icons/in-progress"),i.text("Resume",r.BitmapFont.Main,o.Colors.glassUi_old.primaryText)],spacing:20,originY:.5,originX:0,horizontalPadding:30})}),this.height=48,this.onClicked(t)}}},33226:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.titleInTransition=async function(e={}){const t=o.app.scene.titleScreenUI,i=e.duration??n.config.screenTransitionDuration;return t.preUpdate.force(),t.scene.setVisible(!0),new Promise((n=>{let a=t.buttonsPanel.buttons;if(void 0!==e.excludeButton){const n=t.buttonsPanel.buttons[e.excludeButton];a=(0,s.without)(t.buttonsPanel.buttons,n);const o={x:n.x,y:n.y,width:n.width,height:n.height,rounded:1,alpha:1};n.x=0,n.y=0,n.setSize(t.bounds.width,200),t.tweens.add({targets:n,props:o,duration:i,onComplete:()=>{t.preUpdate.makeDirty()}})}t.tweens.add({targets:[...a,t.resumeButton],props:{x:{getStart:e=>e.x+400,getEnd:e=>e.x},alpha:{from:0,to:1}},duration:i,delay:t.tweens.stagger(30,{}),onComplete:()=>{t.preUpdate.force(),n()},ease:"Sine.easeOut"}),e.keepBackgroundPanel||t.background.transitionIn(i),t.tweens.add({targets:[t.gameLogo],props:{alpha:{from:0,to:1}},duration:i,ease:"Sine.easeOut"}),o.app.scene.titleScreenFooterUI.transitionIn(i)}))};const s=i(2543),n=i(56824),o=i(54825)},33613:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.startPhase=function(e){if(e.currentPhase.type===n.PhaseTypes.FactionTurn){const t=e.currentPhase.faction;return o.assert.defined(t),function(e,t){const i=[],n=e.state;if(t.persona.race===l.Race.Undead)return[];t.getRegions().forEach((t=>{o.assert.defined(t);const s=e.economy.gatherIncomeAndPayUpkeep(e,t);(s.worldUpdates.updates.length>0||Object.keys(s.coinTransfers).length>0)&&i.push(s)}));const c=i.flatMap((e=>e.worldUpdates.updates)),d=i.length>0?i.map((e=>e.coinTransfers)).reduce(r.mergeTransactions):void 0;return d&&c.push({type:a.UpdateType.CoinTransaction,coinTransaction:d}),[s.GameStateEvents.FactionEconomyUpdated({stateAfter:e.state,factionId:t.id,regionReports:i,worldUpdates:{stateBefore:n,stateAfter:e.state,affectedRegions:i.map((e=>e.regionId)),updates:c}})]}(e,t)}return[]};const s=i(36868),n=i(24598),o=i(97849),a=i(78933),r=i(61510),l=i(90824)},34043:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.layoutFromLeftToRight=function(e,t,i,s){let n=e;for(let e of s)e.setPosition(n,t),n=n+e.width+i}},34102:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexDepthUpdater=t.HexDepthProjection=void 0;const n=i(31011),o=s(i(65731)),a=i(56038),r=i(20026),l=i(4005),c=i(45664),d=i(88023);class h extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new u(this).update.bind(this)}bootstrap(e){return(0,d.ImmutableMap)().withMutations((t=>{(0,r.selectFromState)(e,this.sources.regionHexes).forEach(((i,s)=>{const n=a.Regions.model(e).byId(s);n.getHostileBorderHexes().length?n.hexes.bfsFrom(n.getHostileBorderHexes(),((e,i,s)=>(t.set(e.id,s+1),!0))):n.hexes.forEach((e=>t.set(e.id,1/0)))}))}))}}t.HexDepthProjection=h;class u extends l.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.borderHexes,this.handleHostileBorderHexesChanged.bind(this)),e(this.dataSet.sources.regionHexes,this.handleRegionHexesChanged.bind(this))}handleHostileBorderHexesChanged(e){e.updated?.forEach((e=>{const t=e.id,i=a.Regions.model(this.newState).byId(e.id);if(e.removed){const t=(0,c.getHexes)(e.removed),s=t.filter((e=>a.Regions.getByHex(this.newState,e.id)===i.id));this.updateDueToNewlyInternalHexes(i,s);const n=t.without(s);this.updateAfterHexesLost(i,n)}e.added&&a.Regions.getRegionBorderHexes(this.oldState,t).isEmpty()&&i.hexes.bfsFrom(i.getBorderHexes(),((e,t,i)=>(this.builder.set(e.id,i+1),!0)))}))}handleRegionHexesChanged(e){return e.updated?.forEach((e=>{const t=a.Regions.model(this.newState).byId(e.id);e.added,e.removed&&this.updateAfterHexesLost(t,(0,c.getHexes)(e.removed))})),this.builder.createMutation("regionHexes changed")}updateDueToNewlyInternalHexes(e,t){let i=new Set(t),s=new o.default(((e,t)=>e.candidateDepth-t.candidateDepth)),n=[...t.members];const r=a.Regions.getRegionBorderHexes(this.newState,e.id);for(;n.length;){let t=n.shift();for(let o of e.hexes.neighboursOf(t))if(!i.has(o))if(r.has(o.id))s.push({hex:t,candidateDepth:2});else{const a=this.dataSet.getEntryById(this.newState,o.id);this.hexCanJustifyDepth(this.newState,e,o,a,i)?s.push({hex:t,candidateDepth:a+1}):(n.push(o),i.add(o))}}for(i.forEach((e=>this.builder.delete(e.id)));!s.empty()&&i.size;){let t=s.pop();if(i.has(t.hex)){i.delete(t.hex),this.builder.set(t.hex.id,t.candidateDepth);for(let n of e.hexes.neighboursOf(t.hex))i.has(n)&&s.push({hex:n,candidateDepth:t.candidateDepth+1})}}i.forEach((e=>this.builder.set(e.id,1/0)))}updateAfterHexesLost(e,t){e.hexes.bfsFrom(t,((e,t,i)=>!t||(this.dataSet.getEntryById(this.newState,e.id)||1/0)>i&&(this.builder.set(e.id,i),!0)))}isForeignRegion(e,t,i){const s=a.Regions.getByHex(e,t);return void 0!==s&&s!==i}hexCanJustifyDepth(e,t,i,s,n){return 1===s?!!i.findNeighbour((i=>!n.has(i)&&this.isForeignRegion(e,i.id,t.id))):!!t.hexes.neighboursOf(i).find((t=>!n.has(t)&&this.dataSet.getEntryById(e,t.id)===s-1))}}t.HexDepthUpdater=u},34174:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Placement=void 0;const s=i(8),n=i(54825),o=i(87936),a=i(56622),r=i(56824),l=i(24598),c=i(51384),d=i(68871),h=r.logger.for("Placement");function u(){return n.app.scene.globalUI.sidebarButtons.buttons.get().find((e=>e.content.icon?.frame?.name===d.SIDEBAR_BUTTONS.levelMenu.icon))}t.Placement={aroundUiObject:(e,t=0)=>()=>e.scene?(0,s.getObjectCameraRect)(e,t):(h.warning("Target object not in scene",e),{x:0,y:0,width:0,height:0}),atGlobalXY:(e,t,i)=>()=>({x:e,y:t-i,width:0,height:2*i}),atWorldMapHex:(e,t=0)=>()=>{if(!e)return c.INVALID_PLACEMENT;const{x:i,y:a}=(0,s.convertWorldXYToCameraXY)(n.app.scene.worldMap.cameras.main,e.display.centerX,e.display.centerY);return{x:i,y:a-o.HEX_HEIGHT/2+t,width:0,height:o.HEX_HEIGHT}},aroundUndoButton:()=>t.Placement.aroundUiObject(n.app.scene.playUI.activeUI.undoButton),aroundIncomeLabel:()=>Phaser.Geom.Rectangle.Inflate(n.app.scene.playUI.activeUI.getIncomeLabelBounds(),10,10),aroundTreasuryLabel:()=>Phaser.Geom.Rectangle.Inflate(n.app.scene.playUI.activeUI.getTreasuryLabelBounds(),10,10),aroundRegionPopup:()=>{const e=(0,s.convertWorldRectToCameraRect)(n.app.scene.worldMap.cameras.main,n.app.scene.worldMap.overlays.regionSummaryPopup.getBounds());return Phaser.Geom.Rectangle.Inflate(e,10,10)},aroundHideLedgerButton:()=>{const e=n.app.scene.playUI.activeUI;return e instanceof a.LargePlayUI?e.regionPanel.regionLabel.expandClickZone.getBounds():c.INVALID_PLACEMENT},aroundRestartButton(){const e=n.app.scene.playUI.activeUI;return e instanceof a.LargePlayUI?e.isRollbackPanelOpen()?(0,s.getObjectCameraRect)(e.rollbackPanel.restartButton):(0,s.getObjectCameraRect)(e.levelSummary.restartButton):(0,s.getObjectCameraRect)(u())},aroundRewindButton:()=>{const e=n.app.scene.playUI.activeUI;return e instanceof a.LargePlayUI?e.isRollbackPanelOpen()?(0,s.getObjectCameraRect)(e.rollbackPanel.rollbackButton):(0,s.getObjectCameraRect)(e.levelSummary.rewindButton):(0,s.getObjectCameraRect)(u())},aroundReplayButton:()=>{const e=n.app.scene.playUI.activeUI;return e instanceof a.LargePlayUI?e.isRollbackPanelOpen()?(0,s.getObjectCameraRect)(e.rollbackPanel.replayButton):(0,s.getObjectCameraRect)(e.levelSummary.replayButton):(0,s.getObjectCameraRect)(u())},aroundBuyablePawn:e=>()=>{const t=n.app.scene.playUI.activeUI.shoppingTray.pawnSprites[e];return t?.scene?(0,s.getObjectCameraRect)(t,e===l.PawnType.Castle?-10:0):c.INVALID_PLACEMENT}}},34194:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RandomMapSelectScreen=void 0;const s=i(81700),n=i(95568),o=i(36868),a=i(42880),r=i(61408),l=i(43319),c=i(47102),d=i(91622),h=i(54825),u=i(25342),p=i(25e3);class g extends n.BaseScreen{constructor(){super("RandomMapSelect",[s.Scenes.WorldMap,s.Scenes.RandomMapSelectUI]),this.observe.event(o.UserActions.Escape,(async()=>{h.app.navigator.goTo(h.app.screen.title)})),this.observe.event(o.UserActions.SyncWithModel,(()=>{h.app.scene.worldMap.syncState()})),this.observe.event(o.UserActions.GoBack,(async()=>{h.app.navigator.goTo(h.app.screen.title)}))}async activate(e,t){p.NewsBox.hide(),h.app.scene.randomMapSelect.state.update({preset:(0,u.migrateMapPresetInput)(e.preset??d.inject.userData.recallChoice("randomMapOptions"))}),h.app.scene.worldMap.setMode(new a.PreviewMode)}async transitionIn(e){e===h.app.screen.title?await(0,r.titleToRandomMapSelectTransition)():await(0,c.randomMapInTransition)()}async transitionOut(e){e===h.app.screen.play&&await(0,l.randomMapOutTransition)({keepWorldMap:!0})}deactivate(){h.app.scene.randomMapSelect.mapGenerator.clear()}}t.RandomMapSelectScreen=g},34263:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.controlledPromise=function(){let e,t;const i=new Promise(((i,s)=>{e=i,t=s}));return i.resolve=t=>e(t),i.reject=e=>t(e),i}},34348:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.redrawPalisadeIfReplacedByBuilding=function(e,t,i,l){const c=s.Rules.model(e);(c.pawns(l).hasTrait(n.PawnTraits.Building)||c.pawns(i).hasTrait(n.PawnTraits.Building))&&a.app.scene.worldMap.chunkedRenderer.sync((0,r.syncRequest)(e,(0,o.getHex)(t),r.RenderLayerKey.Palisade))};const s=i(19162),n=i(63521),o=i(45664),a=i(54825),r=i(73230)},34445:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UndeadTownsView=void 0;const s=i(20754),n=i(90952),o=i(20693),a=i(19618),r=i(90824);class l extends s.LazyView{constructor(){super([n.GameState.map,n.GameState.economy.townsByRegion]),this.name="UndeadTownsView"}calculate(e){const t=a.Factions.model(e).alive().filter((e=>e.persona.race===r.Race.Undead)).flatMap((e=>e.getRegions()));return o.HexGroup.union(t.map((e=>e.getTownHexes())))}getCacheKey(){return""}}t.UndeadTownsView=l},34476:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelInfoPanel=t.VictoryScene=void 0,t.getCurrentTrophyVariant=I;const s=i(897),n=i(30948),o=i(81700),a=i(76738),r=i(76049),l=i(96137),c=i(80959),d=i(56793),h=i(21941),u=i(20087),p=i(15316),g=i(91622),m=i(66143),y=i(86545),f=i(64589),w=i(79712),v=i(9292);var b=Phaser.GameObjects.Image,S=Phaser.GameObjects.BitmapText,x=Phaser.GameObjects.Rectangle;class T extends n.BaseUIScene{constructor(){super({key:o.Scenes.Victory}),this.availableActions=[],this.preUpdate=(0,s.whenDirty)((()=>{const e=this.bounds.height<=650?-50:0,t=this.bounds.centerY+e;this.shield.setPosition(this.bounds.centerX,t+20),this.shieldOutline.setPosition(this.bounds.centerX,t+26),this.victoryHalo.setPosition(this.bounds.centerX,t),this.victoryRays.setPosition(this.bounds.centerX,t),this.ribbon.width=400,this.ribbon.setPosition(this.bounds.centerX-this.ribbon.width/2,t+60),this.ribbonText.setPosition(this.bounds.centerX,t+66),this.ribbonText.setText("You are victorious!"),this.trophy.setPosition(this.bounds.centerX,t),this.backgroundOverlay.setSize(this.bounds.width,this.bounds.height),this.primaryButton.setVisible(this.availableActions.length>0),this.secondaryButton.setVisible(this.availableActions.length>1),this.ternaryButton.setVisible(this.availableActions.length>2),this.replayButton.setVisible(this.availableActions.length>3),this.levelInfoPanel.updateLayout();let i=this.bounds.centerY-300;(i<0||i<200&&this.bounds.width<600)&&(i=0),this.levelInfoPanel.setPosition(this.bounds.centerX,i);const s=(0,v.pickSmaller)(this.bounds.centerY+200+e,this.bounds.height-190+e);u.Arrange.fromTopToBottomOld([this.replayButton,this.primaryButton,this.secondaryButton,this.ternaryButton],{x:this.bounds.centerX,originX:.5,y:s,originY:0,spacing:10})}))}create(){super.create(),this.ui=c.UiBuilder.for(this),this.shield=this.createImage("shield"),this.shieldOutline=this.createImage("shieldOutline"),this.victoryHalo=this.createImage("victoryHalo"),this.victoryRays=this.createImage("victoryRays"),this.ribbon=new a.Ribbon(this,a.RibbonTextures.Pergamen,0,0,200),this.ribbonText=new S(this,0,0,r.BitmapFont.Main).setTint(l.Colors.woodenUi.primaryText).setOrigin(.5,0),this.levelInfoPanel=new P(this),this.trophy=this.createImage("trophy"),this.backgroundOverlay=new x(this,0,0,0,0,16777215,.5).setOrigin(0,0),this.primaryButtonText=this.ui.glassUi.caption("?"),this.replayButtonText=this.ui.glassUi.caption("VIEW REPLAY"),this.replayButton=new p.RibbonButton(this,0,0,{type:p.RibbonButtonStyle.Small,width:180,content:this.replayButtonText}),this.primaryButton=new d.BoxButton_LEGACY(this,0,0,{text:this.primaryButtonText,width:200,height:46,baseTexture:h.BoxTextures.DialogButton,downTexture:h.BoxTextures.DialogButtonDown}),this.secondaryButtonText=this.ui.glassUi.caption("?"),this.secondaryButton=new p.RibbonButton(this,0,0,{type:p.RibbonButtonStyle.Small,width:180,content:this.secondaryButtonText}),this.ternaryButtonText=this.ui.glassUi.caption("?"),this.ternaryButton=new p.RibbonButton(this,0,0,{type:p.RibbonButtonStyle.Small,width:180,content:this.ternaryButtonText}),this.addAll([this.backgroundOverlay,this.shieldOutline,this.victoryHalo,this.victoryRays,this.shield,this.trophy,this.ribbon,this.ribbonText,this.levelInfoPanel,this.secondaryButton,this.ternaryButton,this.replayButton,this.primaryButton]),this.tweens.add({targets:this.victoryRays,props:{angle:{from:0,to:360}},repeat:-1,duration:1e4}),this.primaryButton.onClicked((()=>{this.availableActions[0]?.executor?.()})),this.secondaryButton.onClicked((()=>{this.availableActions[1]?.executor?.()})),this.ternaryButton.onClicked((()=>{this.availableActions[2]?.executor?.()})),this.replayButton.onClicked((()=>{this.availableActions[3]?.executor?.()}))}setAvailableActions(e){this.availableActions=e,e[0]&&this.primaryButtonText.setText(e[0].title),e[1]&&this.secondaryButtonText.setText(e[1].title),e[2]&&this.ternaryButtonText.setText(e[2].title),e[3]&&this.replayButtonText.setText(e[3].title),this.preUpdate.makeDirty()}createImage(e){return new b(this,0,0,"gameOverAtlas",e)}updateContent(){this.levelInfoPanel.updateContent(),this.trophy.setFrame(I())}}t.VictoryScene=T;class P extends y.BaseResponsiveContainer{constructor(e){super(e),this.ui=c.UiBuilder.for(this.scene),this.background=new b(this.scene,0,0,"gameOverAtlas","levelPanel"),this.levelLabel=new S(this.scene,0,0,r.BitmapFont.Main).setTint(l.Colors.glassUi_old.secondaryText).setOrigin(0,0).setAlpha(.8),this.turnCountLabel=this.ui.text("won in ? turns",r.BitmapFont.Mini,l.Colors.glassUi_old.secondaryText).setOrigin(0,0).setAlpha(.8),this.favoriteButton=new w.ToggleFavoriteButton(this.ui),this.copyLinkButton=(0,f.createLevelLinkButton)(this.ui),this.levelStatsButton=(0,f.createLevelStatsButton)(this.ui),this.add([this.background,this.levelLabel,this.turnCountLabel,this.levelStatsButton,this.copyLinkButton,this.favoriteButton]),g.inject.theme.use((e=>{const t=.75;this.background.setTint(e.oceanShades.light1).setAlpha(t),this.copyLinkButton.setAlpha(t),this.levelStatsButton.setAlpha(t),this.favoriteButton.setAlpha(t),this.levelLabel.setTint(e.oceanContrastDark).setAlpha(t),this.turnCountLabel.setTint(e.oceanContrastDark).setAlpha(t)}))}updateContent(){const e=g.inject.levelSession.levelId,t=e?m.LevelModel.for(e):void 0;this.levelLabel.setText(t?.getTitle()??""),this.levelStatsButton.setVisible(Boolean(t?.hasStats())),t?.manifest?.fixedAIDifficulty?this.turnCountLabel.setText(`Won in ${g.inject.levelSession.getTurnsToVictory()} turns.`):this.turnCountLabel.setText(`Won in ${g.inject.levelSession.getTurnsToVictory()} turns on ${g.inject.levelSession.aiDifficulty} difficulty.`),this.favoriteButton.updateContent(e)}updateLayout(){this.background.setPosition(0,0).setOrigin(.5,0);const e=(0,v.pickSmaller)(this.scene.bounds.width/2,this.background.width/2);this.levelLabel.setPosition(0,24).setOrigin(.5,0),this.turnCountLabel.setPosition(0,24+this.levelLabel.height+6).setOrigin(.5,0),u.Arrange.leftToRight({content:[this.favoriteButton,this.levelStatsButton,this.copyLinkButton],x:e-24,origin:1,spacing:10}),u.Arrange.alignY({content:[this.favoriteButton,this.levelStatsButton,this.copyLinkButton],y:24,origin:0})}}function I(){return g.inject.levelSession.isFixedDifficulty||"hard"===g.inject.levelSession.aiDifficulty?"gold-trophy":"silver-trophy"}t.LevelInfoPanel=P},34562:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameEventModel=t.ScreenWriter=void 0,t.playByPlayScreenwriter=function(e){if(!e.move(h.Move.stepForward))return;const t=e.currentStepEvents;let i=new Set,s=[];for(let e of t)if(y(e)){s.push(e.payload.worldUpdates);for(let t of e.payload.worldUpdates.affectedRegions)i.add(t)}else"GAME_STATE.FACTION_TURN_STARTED"===e.name?s.push({stateBefore:e.payload.state,stateAfter:e.payload.state,updates:[{type:l.UpdateType.FactionTurnStarted,factionId:e.payload.factionId}],affectedRegions:[]}):"GAME_STATE.FACTION_TURN_OVER"===e.name&&s.push({stateBefore:e.payload.state,stateAfter:e.payload.state,updates:[{type:l.UpdateType.FactionTurnOver,factionId:e.payload.factionId}],affectedRegions:[]});return{gameEvents:t,worldUpdates:s,affectedRegions:Array.from(i),focusRegions:p(t),highlightHexes:g(t)}},t.groupByRegionsScreenWriter=function(e){if(!e.hasNext())return;const t=new u((t=>"GAME_STATE.HEX_CAPTURED"===t.name&&d.Economy.isRegionAlive(e.currentState,t.payload.victimRegionId)&&t.payload.victimFactionId===a.Factions.model(e.currentState).localPlayer?.id?"capture hex "+t.payload.capturedHexId:"GAME_STATE.NEW_GAME_STATE"===t.name||"GAME_STATE.FACTION_TURN_STARTED"===t.name?"new game state "+r.random.number():p([t])[0]??!0));for(t.addEvents(e.consumeNextPlay());e.hasNext()&&t.fitsIntoCurrentBeat(e.nextStepEvents);)t.addEvents(e.consumeNextPlay());return t.getScreenPlay()},t.groupByFactionsScreenWriter=function(e){if(!e.hasNext())return;const t=new u((t=>"GAME_STATE.HEX_CAPTURED"===t.name&&d.Economy.isRegionAlive(e.currentState,t.payload.victimRegionId)&&t.payload.victimFactionId===a.Factions.model(e.currentState).localPlayer?.id?"capture hex "+t.payload.capturedHexId:"GAME_STATE.NEW_GAME_STATE"===t.name||"GAME_STATE.FACTION_TURN_STARTED"===t.name?"new game state "+r.random.number():m.of(t).getFocusFactionId()??!0));for(t.addEvents(e.consumeNextPlay());e.hasNext()&&t.fitsIntoCurrentBeat(e.nextStepEvents);)t.addEvents(e.consumeNextPlay());return t.getScreenPlay()};const s=i(39420),n=i(36868),o=i(56038),a=i(19618),r=i(56824),l=i(78933),c=i(97849),d=i(61634),h=i(43046);r.logger.for("ScreenWriters");class u{constructor(e){this.grouper=e,this.beatState=void 0,this.screenPlay={gameEvents:[],highlightHexes:new Set,focusRegions:new Set,affectedRegions:new Set,worldUpdates:[]}}getEventKey(e){return this.grouper(e)}fitsIntoCurrentBeat(e){return!!this.beatState&&(!e?.length||e.every((e=>{const t=this.getEventKey(e);return!0===t||t===this.beatState.updateListKey})))}startNewBeat(e){this.beatState&&this.endCurrentBeat();const t=this.getEventKey(e);this.beatState={updateListKey:t,affectedRegions:new Set,moveByTargetHex:{},initialState:void 0,finalState:void 0,updateList:[],retreatDestinations:{}}}endCurrentBeat(){const e=this.beatState;e&&(e.updateList.push(...Object.values(e.moveByTargetHex)),e.updateList.length&&this.screenPlay.worldUpdates.push({updates:e.updateList,affectedRegions:Array.from(e.affectedRegions),stateBefore:e.initialState,stateAfter:e.finalState}),this.beatState=void 0)}processEvent(e){if(c.assert.defined(this.beatState,"processEvent called outside of beat"),y(e)){for(let t of e.payload.worldUpdates.affectedRegions)this.beatState.affectedRegions.add(t);e.payload.worldUpdates.affectedRegions.forEach((e=>this.screenPlay.affectedRegions.add(e)));for(let t of e.payload.worldUpdates.updates)switch(t.type){case l.UpdateType.PawnsMoved:this.addPawnMoveUpdate(t);break;case l.UpdateType.PawnReplaced:this.addPawnReplacedUpdate(t);break;default:this.beatState.updateList.push(t)}this.beatState.initialState||(this.beatState.initialState=e.payload.worldUpdates.stateBefore),this.beatState.finalState=e.payload.worldUpdates.stateAfter}else"GAME_STATE.FACTION_TURN_STARTED"===e.name?(this.beatState.initialState||(this.beatState.initialState=e.payload.state),this.beatState.finalState=e.payload.state,this.beatState.updateList.push({type:l.UpdateType.FactionTurnStarted,factionId:e.payload.factionId})):"GAME_STATE.FACTION_TURN_OVER"===e.name&&(this.beatState.initialState||(this.beatState.initialState=e.payload.state),this.beatState.finalState=e.payload.state,this.beatState.updateList.push({type:l.UpdateType.FactionTurnOver,factionId:e.payload.factionId}))}getWorldUpdatesForEvent(e){}addEvents(e){this.screenPlay.gameEvents.push(...e),g(e).forEach((e=>this.screenPlay.highlightHexes.add(e))),p(e).forEach((e=>this.screenPlay.focusRegions.add(e)));for(let t of e)this.fitsIntoCurrentBeat([t])||this.startNewBeat(t),this.processEvent(t)}addPawnReplacedUpdate(e){const t=e.hexId,i=this.beatState;c.assert.defined(i);const s=i.moveByTargetHex[t];s?i.moveByTargetHex[t]={...s,replaced:{newPawnId:e.newPawnId,oldType:e.oldType,newType:e.newType}}:i.updateList.push(e)}addPawnMoveUpdate(e){const t=e.pawns[0]?.srcHex,i=e.pawns[0]?.pawnId,s=this.beatState;if(c.assert.defined(t),c.assert.defined(s),e={...e},e.defeatedUnit?.retreatHex){const t=e.defeatedUnit?.retreatHex;c.assert.undefined(s.retreatDestinations[t],"invalid retreat to hex which already has a retreating unit"),s.retreatDestinations[t]=e}const n=s.retreatDestinations[e.destHex],o=s.moveByTargetHex[t],a=s.moveByTargetHex[e.destHex];if(n){const t={...n,defeatedUnit:e.defeatedUnit};s.moveByTargetHex[n.destHex]=t,delete s.retreatDestinations[e.destHex],e.defeatedUnit?.retreatHex&&(s.retreatDestinations[e.defeatedUnit?.retreatHex]=t),delete e.defeatedUnit}if(a||o){c.assert.undefined(o?.defeatedUnit,`attempt to follow-up a move which defeated a unit (capture ${o?.destHex} => move to ${e.destHex})`),c.assert.undefined(o?.hexCaptured,`attempt to follow-up a move after hexCaptured move (capture ${o?.destHex} => move ${t}->${e.destHex})`);let n=e.merged&&{...e.merged};!n&&o?.merged&&(n={newPawnId:o.merged.newPawnId,outputType:o.merged.outputType});const r=[];o&&!e.pawns[0]?.created?(delete s.moveByTargetHex[t],i===o?.merged?.newPawnId?(r.push(...o.pawns),o.merged?.mergedWith&&r.push({pawnId:o.merged.mergedWith,srcHex:o.destHex})):(c.assert.equal(o.pawns.map((e=>e.pawnId)),e.pawns,"previousMoveToSrcHex has different pawns than the follow-up move"),r.push(...o.pawns))):r.push(...e.pawns),a?.merged?e.merged&&e.merged?.mergedWith===a?.merged?.newPawnId?(r.push(...a.pawns),a.merged.mergedWith&&r.push({pawnId:a.merged.mergedWith,srcHex:a.destHex}),n&&delete n.mergedWith):r.push({pawnId:a.merged.newPawnId,srcHex:a.destHex}):a&&(r.push(...a.pawns),n&&delete n.mergedWith),s.moveByTargetHex[e.destHex]={type:l.UpdateType.PawnsMoved,pawns:r,destHex:e.destHex,defeatedUnit:e.defeatedUnit,hexCaptured:a?.hexCaptured??e.hexCaptured,merged:n}}else s.moveByTargetHex[e.destHex]=e}getScreenPlay(){return this.endCurrentBeat(),{gameEvents:this.screenPlay.gameEvents,worldUpdates:this.screenPlay.worldUpdates,affectedRegions:Array.from(this.screenPlay.affectedRegions),focusRegions:Array.from(this.screenPlay.focusRegions),highlightHexes:Array.from(this.screenPlay.highlightHexes)}}}function p(e){const t=new Set;for(let i of e)m.of(i).getFocusRegionIds().forEach((e=>t.add(e)));return Array.from(t)}function g(e){const t=new Set;for(let i of e)(0,s.isEvent)(i,n.GameStateEvents.HexCaptured)&&t.add(i.payload.capturedHexId);return Array.from(t)}t.ScreenWriter=u;class m{constructor(e){this.event=e}static of(e){return new m(e)}getSourceHexId(){const e=this.event;return(0,s.isEvent)(e,n.GameStateEvents.HexCaptured)?e.payload.originatingHexId:(0,s.isEvent)(e,n.GameStateEvents.PawnMoved)?e.payload.sourceHexId:void 0}getDestinationHexId(){const e=this.event;switch(e.name){case n.GameStateEvents.HexCaptured.eventName:return e.payload.capturedHexId;case n.GameStateEvents.PawnMoved.eventName:case n.GameStateEvents.PawnBought.eventName:return e.payload.destinationHexId;default:return}}getFocusFactionId(){const e=this.getFocusRegionIds()[0];if(e&&y(this.event))return a.Factions.getByRegion(this.event.payload.worldUpdates.stateBefore,e)}getFocusRegionIds(){const e=this.event;switch(e.name){case n.GameStateEvents.HexCaptured.eventName:return[e.payload.capturingRegionId];case n.GameStateEvents.PawnMoved.eventName:return[o.Regions.getByHex(e.payload.worldUpdates.stateBefore,e.payload.sourceHexId)];case n.GameStateEvents.PawnBought.eventName:return[e.payload.buyerRegionId];case n.GameStateEvents.FactionEconomyUpdated.eventName:return this.getFactionLiveRegionIds(e.payload.stateAfter,e.payload.factionId);case n.GameStateEvents.FactionTurnStarted.eventName:return this.getFactionLiveRegionIds(e.payload.state,e.payload.factionId);default:return[]}}getFactionLiveRegionIds(e,t){return a.Factions.model(e).byId(t)?.getLiveRegions().map((e=>e.id))??[]}}function y(e){return e.payload.hasOwnProperty("worldUpdates")}t.GameEventModel=m},34564:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.describeEventVerbose=function(e){return`${e.name}(${(0,s.str)(e.payload)})`};const s=i(7334)},34696:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExpansionOptionsView=void 0;const s=i(90952),n=i(20754),o=i(56824),a=i(76439),r=i(20693),l=i(56038),c=i(78635),d=i(78436);o.logger.for("AttritionByFactionView");class h extends n.LazyView{constructor(){super([s.GameState.ai.attritionByRegion]),this.name="expansionOptions"}calculate(e,t){const i=l.Regions.model(e).byId(t);if(!i)return r.HexGroup.empty;const s=c.Warfare.model(e);return i.getHostileBorderHexes().neighbours().filter((t=>!s.isImpassable(t)&&!i.hexes.has(t)&&0===c.Warfare.getHexDefense(e,t)))}getCacheKey(e){return e}getDebugLayer(){return new a.GameStateDebugLayer((0,d.regionBasedAdapter)({getValue:(e,t)=>this.calculate(e,t).length,getDetail:(e,t)=>this.calculate(e,t).toIdsArray().join(",")}))}}t.ExpansionOptionsView=h},34831:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorControlPanel=void 0;const s=i(86545),n=i(80959),o=i(51216),a=i(56824),r=i(36868),l=i(76049),c=i(20034),d=i(20087),h=i(76540),u=i(96604),p=i(46973),g=i(95070),m=i(58609),y=i(36014),f={tabWidth:h.MAP_EDITOR_TABS_WIDTH,tabHeight:60,buttonPanelHeight:62,buttonPanelPadding:8};class w extends s.ResponsiveContainer{constructor(e){var t;super(e),this.ui=n.UiBuilder.for(this.scene),this.tabSwitcher=new o.HorizontalTabSwitcher(this.scene,{tabWidth:f.tabWidth,height:f.tabHeight,glintSize:60,allowDeselection:!1,theme:o.HorizontalTabSwitcher.Themes.white}),this.undoButton=b(this.scene,{icon:"ui/button-icons/restart",tooltip:"Undo last action",onClicked:()=>a.events.trigger(r.UserActions.Undo())}),this.downloadButton=b(this.scene,{icon:"ui/button-icons/download",tooltip:"Download level",onClicked:()=>a.events.trigger(c.MapEditorActions.DownloadLevel())}),this.saveButton=b(this.scene,{icon:"ui/button-icons/checkmark",tooltip:"Save current version to history",onClicked:()=>a.events.trigger(c.MapEditorActions.SaveSnapshot())}),this.playButton=this.ui.wood.primaryButton({text:"PLAY",icon:"ui/wood-icons/arrow-right",width:120,onClicked:()=>{a.events.trigger(r.UserActions.ResumeGame())}}),this.difficultyToggle=new m.DifficultyToggle(this.scene,{height:42,theme:y.ToggleThemes.light,size:"small",onSelected:e=>{a.events.trigger(r.UserActions.SelectAIDifficulty(e))}}),this.secondaryButtons=[this.undoButton,this.saveButton,this.difficultyToggle],this.tabsBackground=this.ui.rectangle((e=>e.oceanShades.dark4)),this.controlsBackground=this.ui.rectangle((e=>e.oceanShades.dark5)),this.tabSwitcher.setTabs([{key:"generate",content:v(t=this.ui,"Generate","ui/button-icons/settings")},{key:"paint",content:v(t,"Paint","ui/button-icons/settings")},{key:"setup",content:v(t,"Setup","ui/button-icons/settings")},{key:"manage",content:v(t,"Manage","ui/button-icons/settings")}]),this.tabSwitcher.onTabSelected((e=>{e&&a.events.trigger(c.MapEditorActions.SetMode(e))})),this.setScrollFactor(0),this.height=f.tabHeight+f.buttonPanelHeight,this.add([this.controlsBackground,this.tabsBackground,this.tabSwitcher,this.playButton,...this.secondaryButtons])}setUndoEnabled(e){this.undoButton.setEnabled(e),this.preUpdate.makeDirty()}setSnapshotEnabled(e){this.saveButton.setEnabled(e),this.preUpdate.makeDirty()}setDifficulty(e){this.difficultyToggle.setValue(e)}updateLayout(){this.tabsBackground.setSize(this.width,f.tabHeight),this.controlsBackground.setPosition(0,f.tabHeight),this.controlsBackground.setSize(this.width,f.buttonPanelHeight),d.Arrange.leftToRight({content:[this.playButton],x:this.width-f.buttonPanelPadding,origin:1,spacing:8}),d.Arrange.leftToRight({content:this.secondaryButtons,x:f.buttonPanelPadding,origin:0,spacing:8}),d.Arrange.alignY({content:[this.playButton,...this.secondaryButtons],y:f.tabHeight+f.buttonPanelPadding,origin:0}),this.tabSwitcher.updateSize(),this.tabSwitcher.setPosition(this.width/2-this.tabSwitcher.width/2,0)}}function v(e,t,i){return new u.IconAndText(e.scene,{icon:e.image(i),text:e.text(t,l.BitmapFont.Mini,0),layout:u.BUTTON_LAYOUT.iconAbove,spacing:4,tintIcon:!0})}function b(e,t){const{icon:i,...s}=t;return new p.RoundedRectButton(e,{content:new g.IconOnly(e,{image:i,tintWithText:!0}),width:42,height:42,theme:p.RoundedRectButton.Themes.light,...s})}t.MapEditorControlPanel=w},34947:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CHATTER_DEFS=void 0,t.updateChatterRules=function(e){t.CHATTER_DEFS=e},t.CHATTER_DEFS=[{tags:["suffered major damage","weaker","angry reaction"],lines:["Wait what?! Not fair!","NO! That's cheating!","This is so not fair!","This is a load of poppycock!","I'm telling my mom!"]},{tags:["neutral","stronger"],lines:["You are no match for the Goose!","Hahahaha. Run!","Hahaha, you think you stand a chance against me?","Tremble before the mighty Goose!","Run and hide, for Godfrey the Goose is nigh!"]},{tags:["neutral"],lines:["Tremble before the mighty Goose!","Run and hide, for Godfrey the Goose is nigh!","I'm Godfrey the Goose and you're about to lose!"]},{tags:["hostile"],lines:["You will rue the day you chose to cross the Goose!","Once I learn to count, your days will be numbered!","Just you wait!"]},{tags:["friendly","weaker"],lines:["Hmm, let's be friends?","Don't worry, I have no idea what I'm doing either!"]}]},34963:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldObjectsPool=void 0;var s=Phaser.GameObjects.Group,n=Phaser.GameObjects.Image,o=Phaser.GameObjects.Sprite;const a=i(56824),r=i(63617),l=i(91622),c=i(87521),d=i(72843),h=i(19009),u=i(79573),p=i(79611),g=i(57189);a.logger.for("WorldObjectPools"),t.WorldObjectsPool=class{constructor(e){this.scene=e,this.torches=new s(this.scene,{defaultKey:"atlas",classType:n,defaultFrame:"pawns/torch-empty"}),this.manaVortexes=new s(this.scene,{defaultKey:"atlas",classType:n,defaultFrame:"pawns/mana-vortex"}),this.coins=new s(this.scene,{defaultKey:"coin",classType:o}),this.coinStacks=new s(this.scene,{defaultKey:"atlas",defaultFrame:"coinstack",classType:n}),this.manaGlobes=new s(this.scene,{defaultKey:"atlas",defaultFrame:"pawns/mana",classType:n}),this.pawnImages=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"pawns/villager",classType:o}),this.pawnShadows=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"pawn-shadow",classType:n}),this.tooltips=new c.Pool((()=>new d.Tooltip(this.scene)),{onReturn:e=>e.hide(!0)}).preload(2),this.flags=new s(this.scene,void 0,{defaultKey:"flag",classType:o}),this.flagPoles=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"flag-pole",classType:n}),this.tileSymbols=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"tile-symbols/alert",classType:n}),this.emojiFaces=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"attitude-emoji/12",classType:n}),this.emojiFaceBg=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"attitude-emoji/human-bg",classType:n}),this.emojiCrowns=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"attitude-emoji/crown",classType:n}),this.hearts=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"ui/mini-icons/heart-colored",classType:n}),this.waterHighlights=new s(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"ocean/hl1",classType:h.WaterHighlight})}updateDebugData(){a.config.debug.objectPools?l.inject.debugData.set("worldObjects",`\n  coins: ${this.printGroupStats(this.coins)}\n  coinStacks: ${this.printGroupStats(this.coinStacks)}\n  pawnImages: ${this.printGroupStats(this.pawnImages)}\n  pawnShadows: ${this.printGroupStats(this.pawnShadows)}\n  tooltips: ${this.tooltips.getUsageStats()}\n  torches: ${this.printGroupStats(this.torches)}`):l.inject.debugData.clear("worldObjects")}printGroupStats(e){return`${e.getTotalUsed()}/${e.getChildren().length}`}getPawnImage(e,t){const i=(0,p.getPawnRenderRecipe)(e);return this.getAndActivate(this.pawnImages).setFrame(i.getFrame(t)).setScale(i.scale).setRotation(0)}getPawnShadow(e,t){const i=(0,p.getPawnRenderRecipe)(e).getShadowFrame(t);return this.getAndActivate(this.pawnShadows).setFrame(i).setScale(.5)}getCoin(e,t){return this.getAndActivate(this.coins).setOrigin(.5,.57143).setPosition(e,t).setFrame(0).setScale(.5)}getCoinStack(e,t){return this.getAndActivate(this.coinStacks).setOrigin(.5,1).setScale(.5).setPosition(e,t)}getFlag(e,t){return this.getAndActivate(this.flags,e,t).setOrigin(0,0).setScale(.5)}getFlagPole(e,t){return this.getAndActivate(this.flagPoles,e,t).setScale(.5)}getTileSymbol(e){return this.getAndActivate(this.tileSymbols).setFrame((0,g.getFrameForPawnSymbol)(e)).setScale(.5)}getEmojiFace(e){return this.getAndActivate(this.emojiFaces).setFrame((0,g.getFrameForEmojiFace)(e)).setScale(.5)}getEmojiFaceBg(e){return this.getAndActivate(this.emojiFaceBg).setFrame(`attitude-emoji/${e}-bg`).setScale(.5)}getTorch(){return this.getAndActivate(this.torches).setFrame("pawns/torch-red").setScale(.5)}getVortex(){return this.getAndActivate(this.manaVortexes).setScale(.5)}getManaGlobe(){return this.getAndActivate(this.manaGlobes).setScale(.5).setDepth(u.WorldLayers.FlyingObject)}getEmojiCrown(){return this.getAndActivate(this.emojiCrowns).setScale(.5)}getWaterHighlight(){return this.getAndActivate(this.waterHighlights)}getHeart(){return this.getAndActivate(this.hearts)}free(e){a.config.debug.objectPools&&e.setActive(!1),e.setVisible(!1),e.clearTint(),e.clearAlpha()}getAndActivate(e,t,i){e.defaultFrame||e.defaultKey;const s=e.get(t,i).setVisible(!0).setActive(!0).setAlpha(1);return a.config.debug.objectPools&&("?"!==(0,r.getObjId)(s)||(0,r.assignObjId)(s)),s}}},35003:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExpeditionButton=void 0;const s=i(86545),n=i(21941),o=i(80959),a=i(76049),r=i(96137),l=i(79772),c=i(20087),d=i(91622),h=i(54825),u=i(98963),p=i(18957),g=i(20227),m=i(9292);class y extends s.ResponsiveContainer{constructor(e){super(e),this.tweener=new g.Tweener(this.scene),this.onClicked=(0,p.signal)();const t=o.UiBuilder.for(e);this.frame=t.box(n.BoxTextures.GlassButton),this.icon=t.image("expedition-icons/x-dead-islands").setOrigin(.5,.5),this.background=t.rectangle(0,0),this.rosetta=t.image("rosetta").setAlpha(.075),this.title=t.text("Expedition",a.BitmapFont.Main,r.Colors.glassUi_old.shapeLightAccent),this.tapestry=new l.CompletionTapestry(e),this.frameGlint=t.image("glass-ui/card-horizontal-glint").setScale(.5,.5),this.add([this.background,this.rosetta,this.frame,this.frameGlint,this.icon,this.title,this.tapestry]),this.on("pointerover",(()=>{this.frame.setFrameFrom(n.BoxTextures.GlassButtonHover)})),this.on("pointerout",(()=>{this.frame.setFrameFrom(n.BoxTextures.GlassButton)})),this.setInteractiveAuto(),this.on("pointerdown",(()=>{h.app.audio.playEffect(u.SoundEffects.ButtonDown)})),this.on("pointerup",(()=>{h.app.audio.playEffect(u.SoundEffects.ButtonUp),this.onClicked.fire()}))}updateContent(e){this.expedition=e,this.title.setText(e.metadata.name);const t=d.inject.theme.get(e.config.theme??"default");this.background.setFillStyle(t.oceanShades.dark3);const i=e.levels.map((e=>e.getLevelStatus()));this.tapestry.updateContent(i,t.oceanShades.dark4),this.icon.setFrame(`expedition-icons/${e.id}`).setOrigin(.5,.5),e.metadata.isNew&&!this.ribbon&&(this.ribbon=o.UiBuilder.for(this.scene).image("ui/new-level-sticker").setOrigin(1,0),this.add(this.ribbon)),this.preUpdate.force()}takeOverScreen(e){return new Promise((t=>{this.tweener.stop(),this.background.fillColor=d.inject.theme.getCurrent().oceanColor,this.tweener.add({targets:[this],props:{x:0,y:0,alpha:0,width:h.app.device.screenWidth,height:h.app.device.screenHeight},duration:e,ease:"Sine.easeInOut",onComplete:()=>t()})}))}shrinkToSize(e,{x:t,y:i,width:s,height:n}){this.tweener.stop();const o=this.background.fillColor;this.background.fillColor=d.inject.theme.getCurrent().oceanColor,this.setPosition(0,0),this.setSize(h.app.device.screenWidth,h.app.device.screenHeight),this.tweener.add({targets:this,props:{x:t,y:i,width:s,height:n,alpha:1},duration:e,ease:"Sine.easeInOut",onComplete:()=>{this.background.fillColor=o}})}updateSize(){this.tweener.hasTweens()||(this.height=this.calculateHeight())}updateLayout(){const e=y.Layout;this.tapestry.width=this.width-e.contentOffsetLeft-e.contentPadding,this.tapestry.updateLayout(),c.Arrange.topToBottom({content:[this.title,this.tapestry],y:e.contentPadding,origin:0,spacing:6}),c.Arrange.alignX({content:[this.title,this.tapestry],x:e.contentOffsetLeft,origin:0}),this.updateSize(),this.background.setSize(this.width-2*e.frameMargin,this.height-2*e.frameMargin),this.background.setPosition(e.frameMargin,e.frameMargin),this.rosetta.setPosition(e.innerFrameMargin+(e.contentOffsetLeft-e.innerFrameMargin)/2,(0,m.pickSmaller)(this.height/2,e.rosettaMaxY)),this.icon.setPosition(this.rosetta.x,this.rosetta.y);const t=this.height-2*e.innerFrameMargin-2,i=(this.rosetta.height-t)/2,s=this.rosetta.x-e.innerFrameMargin,n=this.rosetta.width*this.rosetta.originX-s;this.rosetta.setCrop(n,i,this.rosetta.width-e.innerFrameMargin,t),this.frame.setSize(this.width,this.height),this.frameGlint.setOrigin(.5,0).setPosition(this.width/2,e.innerFrameMargin),this.ribbon&&this.ribbon.setPosition(this.width-e.frameMargin-1,e.frameMargin+1)}calculateHeight(){return this.tapestry.y+this.tapestry.height+y.Layout.contentPadding}}t.ExpeditionButton=y,y.Layout={width:340,frameMargin:4,contentPadding:20,contentOffsetLeft:100,innerFrameMargin:10,rosettaMaxY:60}},35300:(e,t)=>{"use strict";function i(e){try{var t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t),t.focus(),t.select();const i=document.execCommand("copy");if(document.body.removeChild(t),!i)throw Error("failed to copy to clipboard")}catch(t){!function(e){window.prompt("Oops! I failed to access your clipboard directly, but you can still copy the follow link manually with Ctrl+C!",e)}(e)}}Object.defineProperty(t,"__esModule",{value:!0}),t.copyTextToClipboard=async function(e){try{if(!navigator.clipboard)return void i(e);await navigator.clipboard.writeText(e)}catch(t){i(e)}}},35347:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexImportanceUpdater=t.HexImportanceProjection=t.TOWN_HEX_BASE_IMPORTANCE=t.NO_IMPORTANCE=void 0;const n=i(31011),o=s(i(65731)),a=i(7334),r=i(56824),l=i(24598),c=i(56038),d=i(97849),h=i(4005),u=i(45664),p=i(13560),g=i(78635),m=i(63521),y=i(70712),f=i(9292),w=i(88023);t.NO_IMPORTANCE=Object.freeze({distanceFromTown:1/0,value:0,factors:{fromConnectedHexes:0,fromTownProximity:0,fromHex:0,multiplier:.5},parents:[],children:[],connectivity:0});const v=r.logger.for("HexImportanceProjection");t.TOWN_HEX_BASE_IMPORTANCE=40;class b extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new S(this).update}bootstrap(e){const t=new S(this);return t.initFromState(e),c.Regions.getAll(e).filter((t=>c.Regions.model(e).byId(t).isAlive())).forEach((e=>t.invalidateRegion(e))),t.getMap()}entryToString(e){return e.value.toFixed(0)}entryToDebugString(e){return(0,a.prettyPrintObject)(e)}}t.HexImportanceProjection=b;class S extends h.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.invalidatedRegions=new Set,this.roots=new Map,this.regionId=-1,this}registerHandlers(e){e(this.dataSet.sources.townsByRegion,this.handleTownsByRegionChange),e(this.dataSet.sources.regionsHexes,this.handleRegionsHexesChange),e(this.dataSet.sources.hexAssetValue,this.handleHexAssetValueChanged),e(this.dataSet.sources.capitalTown,this.handleCapitalTownChange)}handleCapitalTownChange(e){for(let[t]of e.updated??[])this.invalidateRegion(t)}handleTownsByRegionChange(e){e.updated?.forEach((e=>{this.invalidateRegion(e.id)}))}handleRegionsHexesChange(e){e.updated?.forEach((e=>{const t=e.id;e.added?.forEach((e=>{const i=(0,u.getHex)(e);this.invalidateAfterCapturedHex(i,t)})),e.removed?.forEach((e=>{const i=(0,u.getHex)(e);this.invalidateAfterCapturedHex(i,t)}))}))}handleHexAssetValueChanged(e){for(let[t]of e.updated??[])this.onHexImportanceChanged(t)}onHexImportanceChanged(e){const t=c.Regions.getByHex(this.newState,e);t&&!this.invalidatedRegions.has(t)&&(this.setRegion(t),this.region.isAlive()&&this.invalidateHexAndParents((0,u.getHex)(e)))}createMutation(){return this.updateInvalidated(),super.createMutation()}setRegion(e){e!==this.regionId&&(this.regionId=e,this.region=c.Regions.model(this.newState).byId(this.regionId),d.assert.defined(this.region,`no region matched for id ${this.regionId}`))}invalidateAfterCapturedHex(e,t){if(this.setRegion(t),!this.region.isAlive())return;this.invalidateHex(e);let i=this.region.hexes.neighboursOf(e);for(let e of i)this.invalidateHex(e),this.findNewParents(e).parents.forEach((e=>{this.invalidateHexAndParents(e)}));for(let e of i)this.invalidatePotentialChildren(e)}invalidateHex(e){this.invalidatedHexes.has(e)||(this.invalidatedHexes.add(e),y.AI.isCapitalTown(this.newState,e.id)&&this.addRoot(e))}findNewParents(e){d.assert.defined(this.region,`must first set region before calling findParents (called with ${e})`);let t=1/0,i=[];return this.region.hexes.neighboursOf(e).filter((e=>this.builder.has(e.id)||!this.isInvalidated(e))).forEach((e=>{const s=(this.builder.getCurrent(e.id)?.distanceFromTown??1/0)+(7-(this.builder.getCurrent(e.id)?.connectivity??0));s===t?i.push(e):s<t&&(t=s,i=[e])})),{parents:i,distance:t}}addRoot(e){const t=c.Regions.getByHex(this.newState,e.id),i=this.roots.get(t)||new Set;i.add(e),this.roots.set(t,i)}invalidateParents(e){let t=this.dataSet.getEntryById(this.newState,e.id)?.parents||[];0===t.length&&y.AI.isCapitalTown(this.newState,e.id)&&this.addRoot(e),t.filter((e=>!this.isInvalidated(e))).forEach((e=>{this.invalidateHexAndParents(e)}))}invalidatePotentialParents(e){this.region.hexes.neighboursOf(e).filter((e=>!this.isInvalidated(e))).forEach((e=>{this.invalidateHexAndParents(e)}))}invalidateHexAndParents(e){this.invalidatedHexes.has(e)||(this.invalidateHex(e),this.invalidateParents(e))}invalidatePotentialChildren(e){if(this.invalidatedRegions.has(this.regionId))return;const t=this.dataSet.getEntryById(this.newState,e.id)?.distanceFromTown||0;let i=this.region.hexes.neighboursOf(e).filter((e=>this.dataSet.getEntryById(this.newState,e.id)?.distanceFromTown>t));for(let e of i)this.invalidatedHexes.has(e)||(this.invalidateHex(e),this.invalidatePotentialParents(e),this.invalidatePotentialChildren(e))}invalidateRegion(e){const i=c.Regions.model(this.newState).byId(e);if(i&&!this.invalidatedRegions.has(i.id))if(i.isAlive()){this.invalidatedRegions.add(e);const t=this.dataSet.sources.capitalTown.getEntryById(this.newState,e)?.townHexId;void 0!==t&&this.addRoot((0,u.getHex)(t))}else i.hexes.forEach((e=>this.builder.set(e.id,t.NO_IMPORTANCE)))}updateInvalidated(){for(let[e,t]of this.roots.entries())this.updateForRegion(e,t);this.invalidatedHexes.forEach((e=>this.builder.delete(e.id)))}updateForRegion(e,i){this.setRegion(e);const s=new Set,n=new Map,a=new Set,r=new o.default(((e,t)=>e.distance-t.distance));for(i.forEach((e=>r.push({hex:e,distance:0})));!r.empty();){const e=r.pop(),i=e.hex;if(a.has(i))continue;const o=this.getHexConnectivity(i);if(a.add(i),s.add(i),this.invalidatedHexes.delete(i),0===e.distance)this.builder.set(i.id,{connectivity:o,parents:[],value:0,distanceFromTown:0,factors:{fromHex:this.getHexBaseImportance(i),fromConnectedHexes:0,fromTownProximity:t.TOWN_HEX_BASE_IMPORTANCE,multiplier:1}});else{let{parents:e,distance:a}=this.findNewParents(i);const r={connectivity:o,parents:e,distanceFromTown:a,value:0,factors:{fromHex:this.getHexBaseImportance(i),fromConnectedHexes:0,fromTownProximity:1===a?t.TOWN_HEX_BASE_IMPORTANCE/2:0,multiplier:this.getChokePointMultiplier(i)}};this.builder.set(i.id,r),e.forEach((e=>{const t=(n.get(e)||0)+1;s.delete(e),n.set(e,t)}))}this.region.hexes.neighboursOf(i).filter((e=>(!this.builder.getCurrent(e.id)||this.isInvalidated(e))&&!a.has(e))).forEach((e=>{const t=this.builder.get(i.id);r.push({hex:e,distance:t.distanceFromTown+(7-t.connectivity)})}))}const l=Array.from(s);for(;l.length;){const e=l.pop(),t=this.builder.getCurrent(e.id),i=t.factors;this.addValueFromUnchangedChildren(e),t.value=Math.floor((i.fromHex+i.fromConnectedHexes)*i.multiplier);for(let i of t.parents){const t=n.get(i)??0;0===t&&v.error(`${i} considered parent of ${e.id}, but his children count is ${t}`),t<=1&&l.push(i),n.set(i,(0,f.pickLarger)(0,t-1)),this.addValueToParent(e,i)}}this.invalidatedRegions.delete(this.regionId)}isInvalidated(e){return!!this.invalidatedRegions.has(this.regionId)||this.invalidatedHexes.has(e)}getChokePointMultiplier(e){return c.Regions.isPotentialChokePoint(this.region.state,e.id)||this.doesHexContainVulnerablePawn(e)?1:.5}doesHexContainVulnerablePawn(e){const t=g.Warfare.getOccupyingPawn(this.newState,e);return!!t&&(t.might>0&&t?.hasTrait(m.PawnTraits.Building)||0===g.Warfare.getHexStaticDefense(this.newState,e.id))}addValueToParent(e,t){const i=this.builder.getCurrent(e.id),s=this.builder.getCurrent(t.id);d.assert.defined(s),d.assert.defined(i);const n=i.parents.length,o=((g.Warfare.getOccupyingPawn(this.newState,e)?.type===l.PawnType.Town?p.AssetValue.HEX_BASE_VALUE:i?.factors.fromHex)+i.factors.fromConnectedHexes)/n;s.factors.fromConnectedHexes+=o}getHexConnectivity(e){return 6-e.neighbours((e=>{const t=c.Regions.getByHex(this.newState,e.id);return void 0!==t&&t!==this.regionId})).length}getHexBaseImportance(e){return p.AssetValue.getTotal(this.newState,e,!1)}getMap(){return this.updateInvalidated(),(0,w.ImmutableMap)(this.builder.getEntries()).mapKeys((e=>Number(e)))}addValueFromUnchangedChildren(e){this.region.hexes.neighboursOf(e).filter((t=>!this.builder.get(t.id)&&!!this.dataSet.getEntryById(this.newState,t.id)?.parents.includes(e))).forEach((t=>this.addValueToParent(t,e)))}}t.HexImportanceUpdater=S},35444:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConquestSim=void 0;const s=i(78635),n=i(56038),o=i(63521),a=i(81434),r=i(88023),l=i(9292);class c{static fromState(e){return new c(e,{dirtyHexes:(0,r.ImmutableSet)(),defenderOverrides:(0,r.ImmutableMap)(),latestBreachedDefense:0})}constructor(e,t){this.state=e,this.overrides=t}get latestBreachedDefense(){return this.overrides.latestBreachedDefense}getHexDefense(e){if(!this.overrides.dirtyHexes.has(e))return s.Warfare.getHexDefense(this.state,e);const t=a.Pawns.isTraitPresentOnHex(this.state,e.id,o.PawnTraits.PreventsWalls),i=s.Warfare.getHexLocalDefense(this.state,e.id);return n.Regions.getSameRegionNeighbours(this.state,e).map((e=>this.overrides.defenderOverrides.get(e)??(t?s.Warfare.getHexProjectedUnitDefense(this.state,e.id):s.Warfare.getHexProjectedDefense(this.state,e.id)))).reduce(l.pickLarger,i)}conquerHex(e){const t=this.overrides.defenderOverrides.get(e)??s.Warfare.getHexLocalDefense(this.state,e.id);if(!t)return new c(this.state,{...this.overrides,latestBreachedDefense:0});const i=s.Warfare.getOccupyingPawn(this.state,e),n=s.Warfare.getHexStaticDefense(this.state,e.id)>0&&i?.hasTrait(o.PawnTraits.Unit)&&s.Warfare.model(this.state).getRetreatDestination(i);return new c(this.state,{dirtyHexes:this.overrides.dirtyHexes.concat(e.neighbours()),defenderOverrides:n?this.overrides.defenderOverrides:this.overrides.defenderOverrides.set(e,0),latestBreachedDefense:t})}}t.ConquestSim=c},35473:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverworldFlavorText=void 0;const s=i(80959),n=i(76049),o=i(48063),a=i(91622);t.OverworldFlavorText=class{getLinkAnchorPoint(){const{x:e,y:t}=this.getBoundingBox();return{x:e+this.text.width/2,y:t+this.text.height/2}}constructor(e,t){this.props=t,this.text=s.UiBuilder.for(e).text(t.text,n.BitmapFont.Main,16777215).setVisible(!1).setOrigin(0,0).setAlpha(.4),t.maxWidth&&this.text.setMaxWidth(t.maxWidth),e.add.existing(this.text),this.refresh()}getBoundingBox(){return new Phaser.Geom.Rectangle(this.props.shape.x*o.PREVIEW_HEX_WIDTH,this.props.shape.y*o.PREVIEW_HEX_INNER_HEIGHT,this.text.width,this.text.height)}async show(){this.text.setVisible(!0);const{x:e,y:t}=this.getBoundingBox();this.text.setPosition(e,t)}destroy(){this.text.destroy()}refresh(e){this.text.setTint(a.inject.theme.getCurrent().oceanContrastLight)}updatePosition(){}}},35592:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionBasedPaintedLayer=void 0;const s=i(56337),n=i(19618),o=i(2543);t.FactionBasedPaintedLayer=class{constructor(e){this.recipe=e,this.groupByFaction={},this.groupByHex={}}getTint(e){}addDirtyCorners(e){"all"===e.hexesToSync?this.syncWithState(e):this.syncHexes(e)}getGroupByHex(e){return this.groupByHex[e.id]}updateTint(e){for(const[t,i]of Object.entries(this.groupByFaction)){const s=n.Factions.model(e.state).byId(Number(t)),o=s&&this.getTint(s);void 0!==o&&o!==i.tint&&(i.tint=o,i.clear(e))}}syncWithState(e){this.updateTint(e);const t=n.Factions.model(e.state);t.all().map((e=>this.getFactionGroup(e)));const i=Object.keys(this.groupByFaction).map((e=>Number(e))),s={};for(const n of i){const i=t.byId(n);if(i){const t=this.getFactionGroup(i),n=i.hexes.filter((e=>this.shouldIncludeHex(i,e)));t.setHexes(n,e),n.forEach((e=>s[e.id]=t))}else this.groupByFaction[n].clear(e)}this.groupByHex=s}syncHexes(e){const t=e.hexesToSync;for(let i of t){const t=this.groupByHex[i.id],s=n.Factions.model(e.state).byHex(i),o=s&&this.getFactionGroup(s);t&&t!==o&&t.removeHexes(i,e),o?this.shouldIncludeHex(s,i)?(o.addHexes(i,e),this.groupByHex[i.id]=o):(o.removeHexes(i,e),delete this.groupByHex[i.id]):delete this.groupByHex[i.id]}}getFactionGroup(e){return void 0===this.groupByFaction[e.id]&&(this.groupByFaction[e.id]=new s.IsoTileGroup(this.recipe.frameIdBase+"/"+e.id),this.groupByFaction[e.id].tint=this.getTint(e)),this.groupByFaction[e.id]}paintCorner(e,t,i,s,n){const a=(0,o.uniq)(i.sortedHexes.map((e=>this.groupByHex[e.id])).filter((e=>e)));for(const e of a){const o=e.getCornerVariant(i);t.batchDrawFrame("atlas",this.recipe.frameIdBase+"/"+o,s,n,1,e.tint)}}}},35728:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExpeditionButtons=t.ExpeditionsScene=void 0;const s=i(81700),n=i(93868),o=i(897),a=i(20087),r=i(18486),l=i(35003),c=i(30948),d=i(36868),h=i(56824),u=i(16082),p=i(12605),g=i(54825),m=i(83221),y=i(9292),f=["x-first-steps","x-old-world","x-islands-of-pain","x-dead-islands","x-experimental","x-community-maps"],w=16;class v extends c.BaseUIScene{get contentHeight(){const e=this.expeditionButtons.get(),t=e[e.length-1];return t.y+t.height+150}constructor(){super({key:s.Scenes.Expeditions,bounds:n.BOUNDS.Main}),this.expeditionButtons=new b(this),this.lines=[],this.disableLayoutUpdates=!1,this.preUpdate=(0,o.whenDirty)((()=>{if(this.disableLayoutUpdates)return void this.preUpdate.makeDirty();const e=this.expeditionButtons.get(),t=Math.floor(this.bounds.contentWidth/(l.ExpeditionButton.Layout.width+w)),i=e.map((e=>e.height)).reduce(y.sum,0)+w*(e.length-1),s=this.bounds.height-150-m.MenuHeaderUIScene.Layout.wavesHeight;let n=i/(0,y.pickSmaller)(Math.ceil(i/s),t),o=0,r=[],c=[];for(let t of e)c.push(t),o+=t.height+w,o>n&&(a.Arrange.topToBottom({content:c,spacing:w,y:150,origin:0}),r.push(c),c=[],o=0);c.length>0&&r.push(c);const d=r.length*l.ExpeditionButton.Layout.width+w*(r.length-1);let h=0;for(let e of r)a.Arrange.topToBottom({content:e,spacing:w,y:150,origin:0}),a.Arrange.alignX({content:e,x:this.bounds.width/2-d/2+h*(l.ExpeditionButton.Layout.width+w),origin:0}),++h}))}create(){super.create(),this.cameras.main.setRoundPixels(!0),this.scrollableViewController=(0,p.makeSceneScrollable)(this)}refresh(){const e=f.map((e=>u.ExpeditionModel.for(e))).filter((e=>e));this.expeditionButtons.update(e)}}t.ExpeditionsScene=v;class b extends r.GameObjectCollection{createGameObject(){const e=new l.ExpeditionButton(this.scene);return e.width=l.ExpeditionButton.Layout.width,e.onClicked((()=>{this.handleButtonClick(this.indexOf(e))})),e}updateGameObject(e,t){e.updateContent(t),e.setData("tooltip",t.metadata.description)}handleButtonClick(e){const t=this.model[e];t&&!g.app.scene.expeditions.scrollableViewController.dragging&&h.events.trigger(d.UserActions.GoToExpedition({expeditionId:t.id}))}}t.ExpeditionButtons=b},35758:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompactRegionLabel=void 0;const s=i(23754),n=i(7782),o=i(7334),a=i(66253),r=i(20087);var l=Phaser.GameObjects.Image;class c extends Phaser.GameObjects.Container{constructor(e,t,i){super(e),this.width=t,this.height=i,this.treasuryTextController=new n.TransitionController(this.scene,{duration:400,initialValue:0,applyValue:e=>{this.treasuryText.setText(e.toFixed(0))}}),this.incomeTextController=new n.TransitionController(this.scene,{duration:400,initialValue:0,applyValue:e=>{this.incomeText.setText((0,o.withSign)(Math.trunc(e))),this.updateTrendIcon(e),this.updateNumbersLayout()}}),this.visibilityController=n.Control.visibilityOf(this,{duration:a.COMPACT_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.regionInfo={controllable:!1,buyablePawns:[],name:"",treasury:0,income:0,id:-1,townLevel:1};const r=this.width;this.treasuryText=new s.RegionLabelText(e,r-16-64,24,"0").setOrigin(0,.5),this.goldIcon=new l(e,r-16-60,24,"atlas","ui/budget-icons/treasury").setOrigin(0,.5),this.incomeText=new s.RegionLabelText(e,r-16-16,24,"+8").setOrigin(0,.5),this.trendIcon=new l(e,r-16-6,24,"atlas","ui/budget-icons/surplus").setOrigin(0,.5),this.add([this.treasuryText,this.goldIcon,this.incomeText,this.trendIcon])}setBuyingPawnInfo(e){if("buying"===e?.context){const{cost:t,upkeep:i}=e;this.treasuryTextController.transitionTo(this.regionInfo.treasury-t),this.incomeTextController.transitionTo(this.regionInfo.income-i)}else this.treasuryTextController.transitionTo(this.regionInfo.treasury),this.incomeTextController.transitionTo(this.regionInfo.income)}updateTrendIcon(e){this.trendIcon.setFrame((0,s.getBudgetIcon)(e)).setOrigin(0,.5)}show(){this.visibilityController.transitionTo(1)}hide(){this.visibilityController.transitionTo(0)}setRegionInfo(e){const t=this.regionInfo.id===e.id;this.regionInfo=e,t?(this.treasuryTextController.transitionTo(e.treasury),this.incomeTextController.transitionTo(e.income)):(this.treasuryTextController.setTo(e.treasury),this.incomeTextController.setTo(e.income)),this.updateNumbersLayout()}updateNumbersLayout(){const e=this.width/2;r.Arrange.leftToRight({content:[this.goldIcon,this.treasuryText,this.incomeText,this.trendIcon],spacing:6,origin:.5,x:e})}}t.CompactRegionLabel=c},35800:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ID_TYPE=void 0,t.createRandomGenerator=function(e){const t=(0,n.customAlphabet)("01234567890qwertzuiopasdfghjklyxcvbnmQWERTZUIOPASDFGHJKLYXCVBNM");function i(t=Math.floor(1e9*Math.random())){e=t}function o(){var t=1e4*Math.sin(e++);return t-Math.floor(t)}function a(e){return e[r(0,e.length-1)]}function r(e,t){return Math.floor(o()*(t-e+1))+e}return i(e),{reset:i,number:o,numberBetween:function(e,t){return o()*(t-e)+e},oneOf:a,popFrom:function(e){return e.splice(r(0,e.length-1),1)[0]},property:function(e){var t,i=0;for(var s in e)o()<1/++i&&(t=s);return t},integerBetween:r,shuffle:function(e){let t,i,s=[...e],n=s.length;for(;0!==n;)i=Math.floor(o()*n),n-=1,t=s[n],s[n]=s[i],s[i]=t;return s},boolean:function(e=.5){return o()<e},point:function(e){const t=e*Math.sqrt(o()),i=o()*l;return{x:t*Math.cos(i),y:t*Math.sin(i)}},townName:function e(t=12){const i=a(s.townNamePrefixes),n=a(s.townNameSuffixes);return i.length+n.length>t?e(t):i+n.toLowerCase()},id:function(e){return(e.prefix?e.prefix+"-":"")+t(e.size)}}},t.deterministicRandomHexFrom=function(e,t){return o.random.reset(e.currentPhase.turnNumber+t.toIdsArray().reduce(r.sum,0)),t.getRandomHex(o.random)},t.deterministicRandomNumber=function(e){return o.random.reset(a.CurrentPhase.getTurnNumber(e)),o.random.number()};const s=i(92111),n=i(43561),o=i(56824),a=i(45084),r=i(9292),l=2*Math.PI;t.ID_TYPE={User:{prefix:"u",size:8},Level:{prefix:"l",size:8},CustomLevel:{prefix:"cl",size:8},Error:{prefix:"e",size:8},Session:{prefix:"s",size:12},UserContent:{size:12}}},36014:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Toggle=t.BaseButtonThemeProvider=t.ToggleThemes=void 0;const s=i(86545),n=i(2426),o=i(80959),a=i(20087),r=i(7782),l=i(56824),c=i(96137),d=i(46973),h=i(76049),u=i(22663),p=i(7548),g=i(96604),m=i(36257),y={padding:4,spacing:0,defaultColor:16777215},f=l.logger.for("Toggle");t.ToggleThemes={glass:()=>({selectedItem:{text:{color:c.Colors.white}},text:{color:c.Colors.glassUi.textMain},border:{color:c.Colors.glassUi.textMain}}),wood:()=>({selectedItem:{text:{color:c.Colors.white}},text:{color:c.Colors.woodenUi.primaryText},border:{color:c.Colors.woodenUi.primaryText}}),oceanDark:e=>({text:{color:e.white},border:{color:e.oceanShades.dark3}}),onCard:e=>({selectedItem:{background:{color:e.oceanShades.dark1},text:{color:e.white},border:{color:e.white,alpha:.1}},text:{color:e.white,alpha:.5},border:{color:e.white,alpha:.1},background:{color:e.oceanShades.dark3},radius:8}),light:e=>({selectedItem:{background:{color:e.oceanShades.dark1},text:{color:e.white},border:{color:e.white,alpha:.1}},text:{color:e.white,alpha:.5},border:{color:e.white},radius:8})},t.BaseButtonThemeProvider=e=>{const t={};return{[u.ButtonState.Down]:t,[u.ButtonState.Hover]:t,[u.ButtonState.Rest]:t,[u.ButtonState.Disabled]:t}};class w extends s.BaseResponsiveContainer{constructor(e,i){super(e),this.config=i,this.frame=new n.RoundedRect(this.scene,{radius:8,bevel:"inset"}),this.selectionRectangle=new n.RoundedRect(this.scene,{radius:6,fillStyle:{color:y.defaultColor,alpha:1},bevel:"inset"}),this.ui=o.UiBuilder.for(this.scene),this.selectedValue=this.config.initialValue??this.config.options[0].value,this.selectionRectangleX=new r.TransitionController(this.scene,{ease:"Sine.easeOut",duration:200,initialValue:0,applyValue:e=>{const t=y.padding+e*(this.selectionRectangle.width+y.spacing);this.selectionRectangle.x=t}}),this.theme=(0,p.themer)(this,t.ToggleThemes.wood),this.setSize(i.width??200,i.height??40),this.add([this.frame,this.selectionRectangle,...this.createButtons()]),this.theme.set(i.theme),this.theme.use((e=>{this.frame.setStyle({fill:e.background,line:e.border,radius:e.radius??8});for(let t=0;t<this.buttons.length;t++){const i=this.config.options[t],{text:s,icon:n}=this.buttons[t].content;let o;this.selectedValue===i.value?(o=e.selectedItem?.text??e.text,this.updateSelectionRectangleColor(),e.selectedItem?.border&&this.selectionRectangle.setLineStyle(e.selectedItem.border.color,1,e.selectedItem.border.alpha)):o=e.text,s?.setTint(o.color),s?.setAlpha(o.alpha??1),i.tintIcon&&(n?.setTint(o.color),n?.setAlpha(o.alpha??1))}}))}createButtons(){return this.buttons=this.config.options.map(((e,i)=>new d.RoundedRectButton(this.scene,{theme:t.BaseButtonThemeProvider,content:new g.IconAndText(this.scene,{text:e.text?this.ui.text(e.text,h.BitmapFont.Mini,0):void 0,spacing:8,layout:g.BUTTON_LAYOUT.iconLeft,icon:e.icon?(0,m.createIcon)(this.scene,e.icon):void 0,tintIcon:!1}),onClicked:async()=>{if(this.selectedValue===e.value){if(2!==this.config.options.length)return;i=1-i,e=this.config.options[i]}!1!==await this.config.onSelected(e.value)&&this.handleSelect(e.value,i)},width:10,height:20,bevel:"inset"}))),this.buttons}updateSelectionRectangleColor(){const e=this.config.options.find((e=>e.value===this.selectedValue));if(!e)return void f.warning(`Selected value "${this.selectedValue}" not found in options`);const t=this.theme.get().selectedItem?.background;e.bgColor||!t?this.selectionRectangle.setFillStyle(e.bgColor??y.defaultColor,1):this.selectionRectangle.setFillStyle(t.color,t.alpha??1),this.selectionRectangle.setVisible(!0)}setValue(e,t=!0){if(this.selectedValue===e)return;const i=this.config.options.findIndex((t=>t.value===e));-1!==i?this.handleSelect(e,i,t):f.warning(`Attempted to set Toggle value to non-existing option "${e}" (valid options are ${this.config.options.map((e=>e.value))})`)}handleSelect(e,t,i=!1){this.selectedValue=e,i?this.selectionRectangleX.setTo(t):this.selectionRectangleX.transitionTo(t),this.theme.apply()}updateLayout(){const{padding:e,spacing:t}=y;this.frame.setSize(this.width,this.height);const i=(this.width-2*e-(this.buttons.length-1)*t)/this.buttons.length;for(let t of this.buttons)t.width=i,t.height=this.height-2*e,t.y=e;const s=this.config.options.findIndex((e=>e.value===this.selectedValue));if(-1===s)this.selectionRectangle.setVisible(!1);else{const e=this.buttons[s];this.selectionRectangle.setVisible(!0),this.selectionRectangle.setSize(e.width,e.height),this.selectionRectangle.y=e.y,this.selectionRectangleX.setTo(s),this.updateSelectionRectangleColor()}a.Arrange.leftToRight({content:this.buttons,spacing:t,x:e})}}t.Toggle=w},36257:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createIcon=function e(t,i,s){const m="number"==typeof s?{width:s,height:s}:s??{width:20,height:20};if("string"==typeof i)return e(t,{image:i},s);if(h(i)){const e=new d(t,0,0,"atlas",i.image),n=i.tint;return n&&("function"==typeof n?r.inject.theme.use((t=>e.setTint(n(t))),e):e.setTint(n)),i.scale&&e.setScale(i.scale,i.scale),e.setOrigin(0,0),i.postProcess&&i.postProcess(e),s?new c.CenteredImage(t,e).setSize(m.width,m.height):e}if(u(i)){const e=new n.ColorBox(t,{fillColor:{color:i.color},radius:4});return e.setSize(m?.width,m?.height),e}if(p(i)){const e=new a.MultiColorBox(t,{colors:i.multiColorBox.colors,radius:4});return e.setSize(m?.width,m.height),e}if(g(i)){const{size:e,color:s}=i.bulletPoint,n=new l.BulletPoint(t,e);return"function"==typeof s?r.inject.theme.use((e=>n.setTint(s(e)))):n.setTint(s),n}throw Error(`Unknown icon config: ${(0,o.default)(i)}`)},t.isImageConfig=h,t.isColorBoxConfig=u,t.isMultiColorBoxConfig=p,t.isBulletPointConfig=g,t.isTintAllowed=function(e){return Boolean(h(e)&&e.tintWithText)};const n=i(41040),o=s(i(81401)),a=i(13363),r=i(91622),l=i(47668),c=i(18315);var d=Phaser.GameObjects.Image;function h(e){return void 0!==e.image}function u(e){return void 0!==e.color}function p(e){return void 0!==e.multiColorBox}function g(e){return void 0!==e.bulletPoint}},36530:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.NamedLogger=t.RootLogger=t.LogLevel=void 0,function(e){e.Error="error",e.Warning="warning",e.Info="info",e.Debug="debug",e.Trace="trace"}(i||(t.LogLevel=i={})),t.RootLogger=class{constructor(){this.transportsByName=new Map,this.loggersByModule=new Map}addTransport(e,t){this.transportsByName.set(e,t)}removeTransport(e){this.transportsByName.delete(e)}for(e){const t=this.loggersByModule.get(e)||new s(e,this);return this.loggersByModule.set(e,t),t}log(e,t,i,...s){for(let n of this.transportsByName.values())n.log(e,t,i,...s)}group(e,t){for(let i of this.transportsByName.values())i.group(e,t)}groupEnd(e){for(let t of this.transportsByName.values())t.groupEnd(e)}};class s{constructor(e,t){this.name=e,this.parentLogger=t}trace(e,...t){this.parentLogger.log(i.Trace,this.name,e,...t)}debug(e,...t){this.parentLogger.log(i.Debug,this.name,e,...t)}error(e,...t){this.parentLogger.log(i.Error,this.name,e,...t)}info(e,...t){this.parentLogger.log(i.Info,this.name,e,...t)}warning(e,...t){this.parentLogger.log(i.Warning,this.name,e,...t)}group(e){this.parentLogger.group(this.name,e)}groupEnd(){this.parentLogger.groupEnd(this.name)}wrap(e,t){return this.debug(e,t),t}}t.NamedLogger=s},36868:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapEvents=t.PointerEventFlags=t.SystemEvents=t.UiEvents=t.UserActions=t.GameStateEvents=t.Plays=void 0,t.pointerEventFlagsToString=l,t.describeEvent=function(e){return`${e.name}(${String(function(e){switch(e.name){case"SYSTEM.FACTION_AI_BEGIN":case"SYSTEM.FACTION_AI_END":case"GAME_STATE.FACTION_TURN_OVER":case"GAME_STATE.FACTION_TURN_STARTED":case"GAME_STATE.FACTION_ECONOMY_UPDATED":return e.payload.factionId;case"GAME_STATE.GAME_OVER":return`winner=${e.payload.winningFactionId}`;case"GAME_STATE.PAWN_MOVED":return`#${e.payload.pawnId} -> hex #${e.payload.destinationHexId}`;case"GAME_STATE.PAWN_BOUGHT":return`${e.payload.pawnType} #${e.payload.pawnId} -> hex #${e.payload.destinationHexId}`;case"GAME_STATE.HEX_CAPTURED":return`${e.payload.capturedHexId}, using ${e.payload.capturingPawnType}#${e.payload.capturingPawnId}, faction ${e.payload.victimFactionId}=>${e.payload.capturingFactionId}, `;case"GAME_STATE.FACTION_CREDIT_CHANGED":return`${e.payload.fromFactionId} -> ${e.payload.towardsFactionId}: ${(0,o.withSign)(e.payload.creditDelta,3)}`;case"GAME_STATE.NEW_GAME_STATE":return e.payload.context.name;case"USER_ACTION.PLAY_LEVEL":return`${e.payload.levelId}, ${e.payload.origin}, ${e.payload.startingState?"[custom starting state]":"[default starting state]"}`;case"USER_ACTION.PREVIEW_LEVEL":return e.payload.levelId;case"USER_ACTION.GOTO_EXPEDITION":return`${e.payload.expeditionId}, focusObjectId=${e.payload.focusObjectId}`;case"USER_ACTION.GENERATE_NEW_ISLAND":return e.payload?e.payload.name:"";case"USER_ACTION.TOOL_MODIFIER_CHANGED":return(0,o.str)(e.payload);case"SYSTEM.FATAL_ERROR":return`${e.payload.correlationId}, ${e.payload.message}`;case"UI_EVENT.PAWN_PICKED_UP":return`${e.payload.pawnType} from hex ${e.payload.hexId}`;case"UI_EVENT.REWIND_CONFIRMED":return`${e.payload.turns} turns back to turn ${e.payload.targetTurn}`;case"UI_EVENT.REGION_SELECTED":return e.payload??"none";case"UI_EVENT.RESTART_CONFIRMED":return e.payload.aiDifficulty;case"USER_ACTION.RESTART_LEVEL":return e.payload.skipConfirmation?"skipConfirmation":"";case"SYSTEM.SCREEN_ACTIVATED":return e.payload.previousScreen?`${e.payload.screen.name}, previous=${e.payload.previousScreen.name}`:e.payload.screen.name;case"SYSTEM.LEVEL_SESSION_STARTED":return`${e.payload.sessionId}, origin=${e.payload.origin}, levelId=${e.payload.levelId}, turn=${e.payload.turnNumber}`;case"SYSTEM.LEVEL_SESSION_OVER":return`${e.payload.sessionId}, origin=${e.payload.origin}, levelId=${e.payload.levelId}`;case"SYSTEM.USER_SIGNED_IN":return e.payload.previousUserId?`${e.payload.userId}, previous=${e.payload.previousUserId}`:e.payload.userId;case"SYSTEM.REGION_AI_BEGIN":return e.payload.regionId;case"SYSTEM.FAVORITE_LEVELS_CHANGED":return(0,a.default)(e.payload);default:return e.category===n.EventCategory.WorldMap?`${e.payload.hexId??"no hex"}, flags=${l(e.payload.flags)}`:void 0===e.payload?"":null===e.payload?"null":"object"==typeof e.payload?"...":e.payload}}(e))})`};const n=i(39420),o=i(7334),a=s(i(81401));var r;function l(e){let t=[];return e&r.Ctrl&&t.push("CTRL"),e&r.Alt&&t.push("ALT"),e&r.Shift&&t.push("SHIFT"),e&r.MiddleButton&&t.push("Middle"),e&r.RightButton&&t.push("Right"),e&r.Touch&&t.push("Touch"),t.length?t.join("+"):"none"}t.Plays={EndTurn:(0,n.playEvent)()("END_TURN"),MovePawn:(0,n.playEvent)()("MOVE_PAWN"),BuyPawn:(0,n.playEvent)()("BUY_PAWN"),BanditsAct:(0,n.playEvent)()("BANDITS_ACT"),EditMap:(0,n.playEvent)()("EDIT_MAP"),SpawnUnits:(0,n.playEvent)()("SPAWN_UNITS"),AcceptSurrender:(0,n.playEvent)()("ACCEPT_SURRENDER")},t.GameStateEvents={NewGameState:(0,n.gameStateEvent)()("NEW_GAME_STATE"),FactionCreditChanged:(0,n.gameStateEvent)()("FACTION_CREDIT_CHANGED"),FactionTurnStarted:(0,n.gameStateEvent)()("FACTION_TURN_STARTED"),FactionTurnOver:(0,n.gameStateEvent)()("FACTION_TURN_OVER"),BanditsActed:(0,n.gameStateEvent)()("BANDITS_ACTED"),ZombiesActed:(0,n.gameStateEvent)()("ZOMBIES_ACTED"),FactionEconomyUpdated:(0,n.gameStateEvent)()("FACTION_ECONOMY_UPDATED"),PawnMoved:(0,n.gameStateEvent)()("PAWN_MOVED"),PawnBought:(0,n.gameStateEvent)()("PAWN_BOUGHT"),HexCaptured:(0,n.gameStateEvent)()("HEX_CAPTURED"),CutOffUnitsTurnedBandits:(0,n.gameStateEvent)()("CUTOFF_UNITS_TURNED_BANDITS"),GameOver:(0,n.gameStateEvent)()("GAME_OVER")},t.UserActions={CreateBlankMap:(0,n.userAction)()("CREATE_BLANK_MAP"),SetFullScreenMode:(0,n.userAction)()("SET_FULLSCREEN_MODE"),SetAudioVolume:(0,n.userAction)()("SET_AUDIO_VOLUME"),SelectAIDifficulty:(0,n.userAction)()("SELECT_AI_DIFFICULTY"),OpenMapEditor:(0,n.userAction)()("EDIT_LEVEL"),EditMapJSON:(0,n.userAction)()("EDIT_MAP_JSON"),JSONEditorSave:(0,n.userAction)()("JSON_EDITOR_SAVE"),JSONEditorCancel:(0,n.userAction)()("JSON_EDITOR_CANCEL"),OpenLoadGameDialog:(0,n.userAction)()("OPEN_LOAD_GAME_DIALOG"),ExitMapEditor:(0,n.userAction)()("EXIT_MAP_EDITOR"),ToolModifierChanged:(0,n.userAction)()("TOOL_MODIFIER_CHANGED"),SaveGame:(0,n.userAction)()("SAVE_GAME"),InternalLoadGame:(0,n.userAction)()("LOAD_GAME_INTERNAL"),ResumeGame:(0,n.userAction)()("RESUME_GAME"),ViewReplay:(0,n.userAction)()("VIEW_REPLAY"),DeselectRegion:(0,n.userAction)()("DESELECT_REGION"),SelectNextRegion:(0,n.userAction)()("SELECT_NEXT_REGION"),SelectPreviousRegion:(0,n.userAction)()("SELECT_PREVIOUS_REGION"),SelectNextPendingRegion:(0,n.userAction)()("SELECT_NEXT_PENDING_REGION"),ToggleLedger:(0,n.userAction)()("TOGGLE_LEDGER"),ShowLevelMenu:(0,n.userAction)()("SHOW_LEVEL_MENU"),EndTurn:(0,n.userAction)()("END_TURN"),Undo:(0,n.userAction)()("UNDO"),UndoAll:(0,n.userAction)()("UNDO_ALL"),OpenRollbackMenu:(0,n.userAction)()("OPEN_ROLLBACK_MENU"),TogglePlayMenu:(0,n.userAction)()("TOGGLE_PLAY_MENU"),BuyablePawnPointerDown:(0,n.userAction)()("BUYABLE_PAWN_POINTER_DOWN"),BuyablePawnPointerUp:(0,n.userAction)()("BUYABLE_PAWN_POINTER_UP"),ReturnHeldPawn:(0,n.userAction)()("RETURN_HELD_PAWN"),ShopAreaPointerDown:(0,n.userAction)()("SHOP_AREA_POINTER_DOWN"),ShopAreaPointerUp:(0,n.userAction)()("SHOP_AREA_POINTER_UP"),DebugGameState:(0,n.userAction)()("DEBUG_GAME_STATE"),EditMap:(0,n.userAction)()("EDIT_MAP"),SyncWithModel:(0,n.userAction)()("SYNC_WITH_MODEL"),SetSpectatingPlayBackSpeed:(0,n.userAction)()("SET_SPECTATING_PLAYBACK_SPEED"),SkipSpectating:(0,n.userAction)()("SKIP_SPECTATING"),GoToStart:(0,n.userAction)()("GO_TO_START"),GoToPreviousTurn:(0,n.userAction)()("GO_TO_PREVIOUS_TURN"),GoToNextTurn:(0,n.userAction)()("GO_TO_NEXT_TURN"),GoToEnd:(0,n.userAction)()("GO_TO_END"),ExitSpectatingMode:(0,n.userAction)()("EXIT_SPECTATING_MODE"),DownloadReplay:(0,n.userAction)()("DOWNLOAD_REPLAY"),KeepWatching:(0,n.userAction)()("KEEP_WATCHING"),StartRewind:(0,n.userAction)()("START_REWIND"),RewindBack:(0,n.userAction)()("REWIND_BACK"),RewindForward:(0,n.userAction)()("REWIND_FORWARD"),RewindStepForward:(0,n.userAction)()("REWIND_STEP_FORWARD"),RewindStepBack:(0,n.userAction)()("REWIND_STEP_BACK"),ConfirmRewind:(0,n.userAction)()("CONFIRM_REWIND"),GoToMapGeneration:(0,n.userAction)()("GOTO_MAP_GENERATION"),GoToCampaigns:(0,n.userAction)()("GOTO_CAMPAIGNS"),GoToQuickGame:(0,n.userAction)()("GOTO_QUICK_GAME"),GoToRandomMapSelect:(0,n.userAction)()("GOTO_RANDOM_MAP_SELECT"),GoToExpeditions:(0,n.userAction)()("GOTO_EXPEDITIONS"),GoToExpedition:(0,n.userAction)()("GOTO_EXPEDITION"),GoToMyLibrary:(0,n.userAction)()("GOTO_MY_LIBRARY"),PreviewLevel:(0,n.userAction)()("PREVIEW_LEVEL"),PlayLevel:(0,n.userAction)()("PLAY_LEVEL"),RestartLevel:(0,n.userAction)()("RESTART_LEVEL"),AbandonLevelProgress:(0,n.userAction)()("ABANDON_LEVEL_PROGRESS"),Escape:(0,n.userAction)()("ESCAPE"),SubmitForm:(0,n.userAction)()("SUBMIT_FORM"),GoBack:(0,n.userAction)()("GO_BACK"),Cancel:(0,n.userAction)()("CANCEL"),ExitLevel:(0,n.userAction)()("EXIT_LEVEL"),FindNextIsland:(0,n.userAction)()("FIND_NEXT_ISLAND"),SelectIsland:(0,n.userAction)()("SELECT_ISLAND"),GenerateNewIsland:(0,n.userAction)()("GENERATE_NEW_ISLAND"),AcceptSurrender:(0,n.userAction)()("ACCEPT_SURRENDER"),DismissSurrender:(0,n.userAction)()("DISMISS_SURRENDER"),SendTweet:(0,n.userAction)()("SEND_TWEET"),SendEmail:(0,n.userAction)()("SEND_EMAIL"),JoinDiscord:(0,n.userAction)()("JOIN_DISCORD"),ToggleTooltip:(0,n.userAction)()("TOGGLE_TOOLTIP"),ShowHelp:(0,n.userAction)()("SHOW_HELP"),SignInWithGoogle:(0,n.userAction)()("SIGN_IN_WITH_GOOGLE"),SignInWithFacebook:(0,n.userAction)()("SIGN_IN_WITH_FACEBOOK"),SignInWithEmail:(0,n.userAction)()("SIGN_IN_WITH_EMAIL"),SignOut:(0,n.userAction)()("SIGN_OUT"),WorldMapPanelButtonClicked:(0,n.userAction)()("WORLD_MAP_PANEL_BUTTON_CLICKED"),ResetZoom:(0,n.userAction)()("RESET_ZOOM"),ToggleLevelList:(0,n.userAction)()("TOGGLE_LEVEL_LIST"),SetLevelListFilter:(0,n.userAction)()("SET_LEVEL_LIST_FILTER"),SetLevelListSortBy:(0,n.userAction)()("SET_LEVEL_LIST_SORT_BY"),SelectContent:(0,n.userAction)()("SELECT_CONTENT"),SetShowBudgetNumbers:(0,n.userAction)()("SET_SHOW_BUDGET_NUMBERS"),LoadReplay:(0,n.userAction)()("LOAD_REPLAY"),AddLevelToFavorites:(0,n.userAction)()("ADD_LEVEL_TO_FAVORITES"),RemoveLevelFromFavorites:(0,n.userAction)()("REMOVE_LEVEL_FROM_FAVORITES"),DeleteLevel:(0,n.userAction)()("DELETE_LEVEL")},t.UiEvents={PawnReturnedToShop:(0,n.uiEvent)()("PAWN_RETURNED_TO_SHOP"),RollbackMenuClosed:(0,n.uiEvent)()("ROLLBACK_MENU_CLOSED"),PawnPickedUp:(0,n.uiEvent)()("PAWN_PICKED_UP"),RegionSelected:(0,n.uiEvent)()("REGION_SELECTED"),RewindConfirmed:(0,n.uiEvent)()("REWIND_CONFIRMED"),RegionLedgerOpened:(0,n.uiEvent)()("REGION_LEDGER_OPENED"),RegionLedgerClosed:(0,n.uiEvent)()("REGION_LEDGER_CLOSED"),PawnPickedUpFromShop:(0,n.uiEvent)()("PAWN_PICKED_UP_FROM_SHOP"),RestartConfirmed:(0,n.uiEvent)()("RESTART_CONFIRMED")},t.SystemEvents={EngineInitialized:(0,n.systemEvent)()("ENGINE_INITIALIZED"),ScreenActivated:(0,n.systemEvent)()("SCREEN_ACTIVATED"),RequestLevelFeedback:(0,n.systemEvent)()("REQUEST_LEVEL_FEEDBACK"),UserBecameInactive:(0,n.systemEvent)()("USER_INACTIVE"),UserBecameActive:(0,n.systemEvent)()("USER_ACTIVE"),LevelSessionStarted:(0,n.systemEvent)()("LEVEL_SESSION_STARTED"),LevelSessionOver:(0,n.systemEvent)()("LEVEL_SESSION_OVER"),UserDataLoaded:(0,n.systemEvent)()("USER_DATA_LOADED"),LocalProgressUpdated:(0,n.systemEvent)()("LOCAL_PROGRESS_UPDATED"),LocalProgressWiped:(0,n.systemEvent)()("LOCAL_PROGRESS_WIPED"),LevelRecordDeleted:(0,n.systemEvent)()("LEVEL_RECORD_DELETED"),UserSignedIn:(0,n.systemEvent)()("USER_SIGNED_IN"),KongregateSignIn:(0,n.systemEvent)()("KONGREGATE_USER_SIGNED_IN"),FactionAiBegin:(0,n.systemEvent)()("FACTION_AI_BEGIN"),RegionAiBegin:(0,n.systemEvent)()("REGION_AI_BEGIN"),FactionAiEnd:(0,n.systemEvent)()("FACTION_AI_END"),FatalError:(0,n.systemEvent)()("FATAL_ERROR"),ShowGameOverScreen:(0,n.systemEvent)()("SHOW_GAME_OVER_SCREEN"),LevelCompleted:(0,n.systemEvent)()("LEVEL_COMPLETED"),FavoriteLevelsChanged:(0,n.systemEvent)()("FAVORITE_LEVELS_CHANGED"),MyIslandsChanged:(0,n.systemEvent)()("MY_ISLANDS_CHANGED"),ResetZoom:(0,n.userAction)()("RESET_ZOOM")},function(e){e[e.MiddleButton=1]="MiddleButton",e[e.RightButton=2]="RightButton",e[e.Shift=4]="Shift",e[e.Alt=8]="Alt",e[e.Ctrl=16]="Ctrl",e[e.Touch=32]="Touch"}(r||(t.PointerEventFlags=r={})),t.WorldMapEvents={StartInteraction:(0,n.worldMapAction)()("START_INTERACTION"),AbortInteraction:(0,n.worldMapAction)()("ABORT_INTERACTION"),CompleteInteraction:(0,n.worldMapAction)()("COMPLETE_INTERACTION"),StartDrag:(0,n.worldMapAction)()("START_DRAG"),EndDrag:(0,n.worldMapAction)()("END_DRAG"),StartPinch:(0,n.worldMapAction)()("START_PINCH"),EndPinch:(0,n.worldMapAction)()("END_PINCH")}},37320:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HeadingPanel=void 0;const s=i(86545),n=i(80959),o=i(20087),a=i(55275),r=i(79899),l=i(56824),c=i(36868),d=i(9292),h=i(76049);class u extends s.BaseResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.rosettaBg=this.ui.image("rosetta").setAlpha(.125).setOrigin(.5,.5),this.rosettaIcon=new r.ImageButton(this.scene,0,0,{frame:"expedition-icons/x-dead-islands",onClicked:()=>{l.events.trigger(c.UserActions.ExitLevel())}}),this.expeditionTitle=this.ui.vectorText("",h.VectorFont.Cinzel16,(e=>e.oceanContrastLight)),this.levelName=this.ui.vectorText("",h.VectorFont.Cinzel32,(e=>e.oceanContrastLight)),this.props=(0,a.stateContainer)({expeditionIcon:"expedition-icons/x-dead-islands",levelName:"?",expeditionTitle:"?"},((e,t)=>{this.expeditionTitle.setText(t.expeditionTitle),this.levelName.setText(t.levelName),this.rosettaIcon.setBaseFrame(t.expeditionIcon),this.updateLayout()})),this.add([this.rosettaBg,this.rosettaIcon,this.levelName,this.expeditionTitle])}updateLayout(){if(this.height>150)this.expeditionTitle.setAlign("center"),this.levelName.setAlign("center"),this.levelName.setWordWrapWidth(this.width,!0),this.expeditionTitle.setWordWrapWidth(this.width,!0),o.Arrange.topToBottom({content:[this.rosettaIcon,20,this.expeditionTitle,this.levelName],origin:.5,spacing:6,y:this.height/2}),o.Arrange.alignX({content:[this.rosettaIcon,this.expeditionTitle,this.levelName],origin:.5,x:this.width/2}),this.rosettaBg.setPosition(this.rosettaIcon.x+this.rosettaIcon.width/2,this.rosettaIcon.y+this.rosettaIcon.height/2);else{this.rosettaBg.setPosition(this.rosettaBg.width/2,this.height/2);const e=this.rosettaBg.x+this.rosettaBg.width/2+8,t=(0,d.pickLarger)(100,this.width-8-e);this.expeditionTitle.setAlign("left"),this.levelName.setAlign("left"),this.expeditionTitle.setWordWrapWidth(t,!0),this.levelName.setWordWrapWidth(t,!0),o.Arrange.alignX({content:[this.expeditionTitle,this.levelName],x:this.rosettaBg.x+this.rosettaBg.width/2+8,origin:0}),o.Arrange.topToBottom({content:[this.expeditionTitle,this.levelName],y:this.height/2,origin:.5}),this.rosettaIcon.setPosition(this.rosettaBg.x-this.rosettaIcon.width/2,this.rosettaBg.y-this.rosettaIcon.height/2)}}}t.HeadingPanel=u},37485:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createLevelSelectMenu=function(e){const t={campaign:"",level:"","quick save":()=>{a.commands.game.save("1")},"quick load":()=>{a.commands.game.load("1")},import:()=>{r.events.trigger(n.UserActions.OpenLoadGameDialog())},export:()=>{r.events.trigger(h.MapEditorActions.DownloadLevel())},"edit current map":()=>{o.app.navigator.currentScreen===o.app.screen.mapEditor?r.events.trigger(n.UserActions.ResumeGame()):r.events.trigger(n.UserActions.EditMap())}};let i;function u(s){if("test-maps"===s)return async function(){const s=(await fetch("/assets/test-maps.json").then((e=>e.json()))).levels,a=(0,c.dictionaryOf)(s,"id"),l=s.map((e=>e.id));i&&i.remove(),i=e.add(t,"level",l).onChange((async e=>{localStorage.setItem(d.SAVE_GAME_LOCAL_STORAGE_PREFIX+"test-map",a[e].data),o.app.notifications.success(a[e].name,""),r.events.trigger(n.UserActions.InternalLoadGame("test-map"))}))}();const a=l.ExpeditionModel.for(s);i&&i.remove();const h=a.levels.map((e=>e.id));i=e.add(t,"level",h).onChange((async e=>{r.events.trigger(n.UserActions.PlayLevel({levelId:e,origin:"debug-tool"})),o.app.scene.worldMap.syncState()}))}e.add(t,"quick save"),e.add(t,"edit current map"),e.add(t,"quick load"),e.add(t,"import"),e.add(t,"export"),s.inject.mapRegistry.initialize().then((()=>{const i=s.inject.mapRegistry.getExpeditions().map((e=>e.id));i.push("test-maps"),0!==i.length&&(t.campaign=i[0],e.add(t,"campaign",i).onChange(u),u(i[0]))}))};const s=i(91622),n=i(36868),o=i(54825),a=i(99545),r=i(56824),l=i(16082),c=i(1326),d=i(91693),h=i(20034)},37600:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NearestLootUpdater=t.NearestLootProjection=t.UNREACHABLE=void 0;const n=i(31011),o=i(56824),a=i(4005),r=i(56038),l=i(45664),c=s(i(65731)),d=i(7334),h=i(20693),u=i(97849),p=i(61634),g=i(19506),m=i(78635),y=i(90824),f=i(88023);o.logger.for("NearestLootProjection"),t.UNREACHABLE=Object.freeze({rootId:0,distance:Number.POSITIVE_INFINITY});class w extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new v(this).update}bootstrap(e){const t=new v(this);return t.initFromState(e),r.Regions.getAll(e).forEach((e=>{t.addRootsFromRegion(e)})),t.getMap()}entryToString(e){return 0===e.distance?g.GLYPH.whiteFlag:e.distance}entryToDebugString(e){return(0,d.prettyPrintObject)(e)}}t.NearestLootProjection=w;class v extends a.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.sources=new Set,this}registerHandlers(e){e(this.dataSet.sources.townsByRegion,this.handleTownsByRegionChange),e(this.dataSet.sources.regionsByHex,this.handleRegionByHexChange),e(this.dataSet.sources.factions,this.handleFactionsChange)}handleTownsByRegionChange(e){e.updated?.forEach((e=>{const t=e.id;r.Regions.model(this.newState).byId(t)?.faction?.persona.race!==y.Race.Undead&&(e.added?.forEach((e=>{this.addNewRoot((0,l.getHex)(e))})),e.removed?.forEach((e=>{this.invalidateFrom((0,l.getHex)(e))})))}))}handleRegionByHexChange(e){e.updated?.forEach((([e,t])=>{this.invalidateFrom((0,l.getHex)(e))}))}handleFactionsChange(e){this.builder.deleteAll(),this.initialize(),r.Regions.getAll(this.newState).forEach((e=>{this.addRootsFromRegion(e)}))}addRootsFromRegion(e){const t=r.Regions.model(this.newState).byId(e);t&&t.faction?.persona.race!==y.Race.Undead&&p.Economy.getTownHexesByRegion(this.newState,e).forEach((e=>this.addNewRoot((0,l.getHex)(e))))}updateInvalidated(){this.addSourcesFromInvalidatedHexes();const e=new c.default(((e,t)=>e.distance-t.distance));for(this.sources.forEach((t=>{const i=this.builder.getCurrent(t.id);u.assert.defined(i),e.push({hex:t,rootHex:(0,l.getHex)(i.rootId),distance:i?.distance})}));!e.empty();){const t=e.pop(),i=t.hex;this.getCurrentDistanceFrom(i)<=t.distance||(this.invalidatedHexes.delete(i),this.builder.set(i.id,{distance:t.distance,rootId:t.rootHex.id}),i.neighbours((e=>{const i=r.Regions.getByHex(this.newState,e.id);return!m.Warfare.model(this.newState).isImpassable(e)&&void 0!==i&&this.getCurrentDistanceFrom(e)>=t.distance+1})).forEach((i=>{e.push({hex:i,rootHex:t.rootHex,distance:t.distance+1})})))}this.invalidatedHexes.forEach((e=>this.builder.delete(e.id)))}addSourcesFromInvalidatedHexes(){h.HexGroup.from(Array.from(this.invalidatedHexes)).neighbours().filter((e=>this.getCurrentDistanceFrom(e)<Number.POSITIVE_INFINITY)).forEach((e=>{this.sources.add(e),this.invalidateFrom(e)}))}getMap(){return this.updateInvalidated(),(0,f.ImmutableMap)(this.builder.getEntries()).mapKeys((e=>Number(e)))}createMutation(){return this.updateInvalidated(),super.createMutation()}invalidateFrom(e){if(this.invalidatedHexes.has(e))return;this.invalidatedHexes.add(e);const i=this.builder.getCurrent(e.id);i&&e.neighbours((e=>{const s=this.builder.getCurrent(e.id)??t.UNREACHABLE;return i.rootId==s.rootId&&s.distance===i.distance+1})).forEach((e=>this.invalidateFrom(e)))}getCurrentDistanceFrom(e){return this.invalidatedHexes.has(e)?Number.POSITIVE_INFINITY:this.builder.getCurrent(e.id)?.distance??Number.POSITIVE_INFINITY}addNewRoot(e){this.sources.add(e),this.builder.set(e.id,{rootId:e.id,distance:0}),this.invalidatedHexes.add(e)}}t.NearestLootUpdater=v},37659:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChangeSet=void 0;const s=i(97849),n=i(7334);t.ChangeSet=class{constructor(e){this.mutations=new Map,this.title="empty",e?.forEach((e=>this.add(e)))}add(e){s.assert.undefined(this.mutations.get(e.dataSet),`changeSet already contains mutation for "${e.dataSet.key}" (${(0,n.str)(e)})`),this.title=e.dataSet.key,this.mutations.set(e.dataSet,e)}all(){return Array.from(this.mutations.values())}of(e){return this.mutations.get(e)?.changes}require(e){const t=this.of(e);return s.assert.defined(t,`DataSet "${e.key}" not found in ${this}`),t}toString(){return`[ChangeSet<${Array.from(this.mutations.values()).map((e=>e.dataSet.key)).join(",")}>]`}}},37971:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelScript=void 0;const s=i(91622),n=i(54825),o=i(36868),a=i(56824),r=i(2297);t.LevelScript=class{constructor(e){this.module=e,this.subscriptions=[],this.tooltips=[],this.watchers=[]}onEvent(e,t){const i=a.events.on(e,t);return this.subscriptions.push(i),i}onButtonClicked(e,t){this.onEvent(o.UserActions.WorldMapPanelButtonClicked,(i=>{i===e.action&&t()}))}watch(e,t){this.watchers.push(e.watchFuture(t))}addTooltip(e){const t=n.app.tooltips.show({...e,type:r.TooltipType.Permanent});return this.tooltips.push(t),t}goTo(e){void 0===e?s.inject.scriptRunner.setScript(void 0):s.inject.scriptRunner.setScript(this.module.name+"."+e)}setScript(e){void 0===e?s.inject.scriptRunner.setScript(void 0):s.inject.scriptRunner.setScript(e)}activate(){this.watch(s.inject.ui.sidebarMode,(e=>{e&&n.app.scene.globalUI.clearTooltips()})),this.onEvent(o.UserActions.OpenRollbackMenu,(()=>{n.app.scene.globalUI.clearTooltips()}))}deactivate(){this.subscriptions.forEach((e=>e.unsubscribe())),this.subscriptions=[],this.tooltips.forEach((e=>n.app.tooltips.removeTooltip(e))),this.tooltips=[],this.watchers.forEach((e=>e.unsubscribe())),this.watchers=[]}}},38021:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playCoinSoundEffect=void 0;const s=i(54825),n=i(98963);t.playCoinSoundEffect=e=>{0!==e&&(e<=10?s.app.audio.playEffect(n.SoundEffects.CoinsFew):e<=30?s.app.audio.playEffect(n.SoundEffects.CoinsHandful):s.app.audio.playEffect(n.SoundEffects.CoinPile))}},38348:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.V2_SaveGameTags=void 0,function(e){e.Start="start",e.Autosave="auto",e.BestResult="best"}(i||(t.V2_SaveGameTags=i={}))},38399:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionsDataSetModel=void 0;const s=i(4782),n=i(19618),o=i(56038),a=i(94399),r=i(67274);class l extends a.BaseModel{constructor(){super(...arguments),this.factionModels={}}byId(e){let t=this.factionModels[e];if(t||(t=new s.FactionModel(this,e),this.factionModels[t.id]=t),t.exists)return t}get neutral(){return this.byId(r.SpecialFaction.neutral)}get localPlayer(){return this.byId(1)}byRegion(e){const t=n.Factions.getByRegion(this.state,e.id);if(void 0!==t)return this.byId(t)}byHex(e){const t=o.Regions.getByHex(this.state,e.id);if(!t)return;const i=n.Factions.getByRegion(this.state,t);return void 0!==i?this.byId(i):void 0}nextId(){return n.Factions.getNextId(this.state)}all(){return n.Factions.getAll(this.state).map((e=>this.byId(e)))}alive(){return this.all().filter((e=>e.isAlive()))}create(e){const t=this.nextId();return this.state=n.Factions.createFaction(this.state,{...e,id:t,regions:e.regions?.map((e=>e.id))}),this.byId(t)}}t.FactionsDataSetModel=l},38497:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SettingsWidget=void 0;const s=i(25988),n=i(86545),o=i(80959),a=i(91622),r=i(23382),l=i(36868),c=i(18811),d=i(2543),h=i(56824),u=i(16007),p=i(20087),g=i(41331),m=i(54825),y=i(46512),f=i(5365),w=i(11466),v=i(9292);class b extends s.SideBarWidget{constructor(e){super(e,{title:"Preferences",offsetFromTitle:14}),this.setContent(new S(e))}}t.SettingsWidget=b;class S extends n.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=o.UiBuilder.for(this.scene),this.formItems={soundEffects:this.ui.formItem({label:"Sound effects",component:E(this.ui)}),fullScreenMode:this.ui.formItem({label:"Fullscreen mode",component:O(this.ui)}),theme:this.ui.formItem({label:"Theme",component:x(this.ui),helpTooltip:"If you suffer from color vision deficiency, try the High Contrast or Inferno themes.\nInferno is recommended for playing the game in grayscale: darker players move later."}),oceanColor:this.ui.formItem({label:"Ocean color",component:P(this.ui)}),speed:this.ui.formItem({label:"Enemy turn speed",component:A(this.ui)}),surrender:this.ui.formItem({label:"Rivals surrender",component:B(this.ui)}),rivalChatter:this.ui.formItem({label:"Rival comments",helpTooltip:"Allow the AI rivals to chat about what's happening in the game?\nOnly on select = Rivals speak only when the player selects their province.",component:I(this.ui)}),cameraFollow:this.ui.formItem({label:"Smart camera",helpTooltip:"Should the camera automatically follow rivals moves during their turn?\nNo zoom-out = The camera will follow rival moves, but always maintain the current zoom level.",component:M(this.ui)}),budgetLabels:this.ui.formItem({label:"Economy numbers",component:R(this.ui),helpTooltip:"Shows treasury and income for each province directly on the map."})},this.restoreButton=this.ui.outlineButton({theme:"islandCard",icon:"ui/button-icons/restart",variant:"circle",tooltip:"Restore default settings",onClicked:async()=>{const e=(0,y.defaultUserData)().rememberedChoices;await m.app.modals.confirmRevertSettings()===f.DialogButtons.Reset&&(["muteSoundEffects","preferredOceanColor","rivalAIChatter","cameraFollow","spectatingSpeed","rivalsSurrender"].forEach((t=>{a.inject.userData.rememberChoice(t,e[t])})),a.inject.theme.set("default"),a.inject.ui.spectatingSpeed.set(a.inject.userData.recallChoice("spectatingSpeed")),h.events.trigger(l.SystemEvents.UserDataLoaded(a.inject.userData.current)))}}),this.add([...Object.values(this.formItems),this.restoreButton]),a.inject.theme.use((e=>{Object.values(this.formItems).forEach((t=>{t.label.setTint(e.white)}))}))}calculateHeight(){const e=Object.values(this.formItems).slice(-1)[0];return e.y+e.height}updateLayout(){const e=Object.values(this.formItems),t=m.app.device.uiVariant()===w.UiVariant.Compact;this.formItems.fullScreenMode.setVisible(t);const i=(0,v.cropNumber)(.5*this.width,120,150);e.forEach((t=>{t.component.width=i,t.width=this.width,t.setLabelWidth(this.width-e[0].component.width)})),p.Arrange.topToBottom({content:e,y:0,origin:0,spacing:8}),this.restoreButton.setPosition(this.width-this.restoreButton.width,-this.restoreButton.height-8),this.updateSize()}}function x(e){const t=(0,g.createSelectBox)(e,{options:Object.entries(r.THEMES).map((([e,t])=>({key:e,text:t.title??"(custom)",icon:{multiColorBox:{colors:t.factionColors}}}))),onSelected:e=>{e&&a.inject.theme.set(e.key)}});return a.inject.theme.use((e=>{t.setSelection(function(e){const t=a.inject.theme.getUserPreferredTheme();return t?{key:t,text:e.title??"(unknown)",icon:{multiColorBox:{colors:r.THEMES[t]?.factionColors}}}:{key:"_custom",text:"(custom)"}}(e))}),t),t}const T=["legacy","gentle","night","pacific","pelorous","azure","aqualand","blueprint","allports","royal blue","deep sea","bluewood","acapulco","bermuda","carribean","bay leaf","oracle","watercourse","amazon","deep green","axolotl"];function P(e){const t={key:"_default",text:"Theme-based"};const i=(0,g.createSelectBox)(e,{options:[t].concat(T.map((e=>({key:e,text:(0,d.capitalize)(e),icon:{color:r.OCEAN_COLOR_PRESETS[e]}})))),onSelected:e=>{e.key===t.key?a.inject.userData.rememberChoice("preferredOceanColor",void 0):a.inject.userData.rememberChoice("preferredOceanColor",r.OCEAN_COLOR_PRESETS[e.key]),a.inject.theme.sync()}});return a.inject.theme.use((e=>{i.setSelection(function(e){if(e.presetName&&void 0===a.inject.userData.recallChoice("preferredOceanColor"))return t;{const t=(0,d.capitalize)(function(e){const t=Object.entries(r.OCEAN_COLOR_PRESETS).find((([t,i])=>i===e));return t?t[0]:"(custom)"}(e.oceanColor));return{key:t,text:(0,d.capitalize)(t),icon:{color:e.oceanColor}}}}(e))}),i),i}function I(e){function t(){const e=a.inject.userData.recallChoice("rivalAIChatter")??"on";return{key:e,text:"on"===e?"Enabled":"Disabled"}}const i=(0,g.createSelectBox)(e,{selectedItem:t(),options:[{key:"on",text:"Enabled"},{key:"only on select",text:"Only on select"},{key:"off",text:"Disabled"}],onSelected:e=>{a.inject.userData.rememberChoice("rivalAIChatter",e.key)}});return h.events.on(l.SystemEvents.UserDataLoaded,(()=>{i.setSelection(t())})),i}const C={[c.CameraFollowPreset.On]:"Enabled",[c.CameraFollowPreset.NoZoom]:"No zoom-out",[c.CameraFollowPreset.Off]:"Disabled"};function M(e){function t(){const e=a.inject.userData.recallChoice("cameraFollow")??c.CameraFollowPreset.On;return{key:e,text:C[e]}}const i=(0,g.createSelectBox)(e,{selectedItem:t(),options:[c.CameraFollowPreset.On,c.CameraFollowPreset.NoZoom,c.CameraFollowPreset.Off].map((e=>({key:e,text:C[e]}))),onSelected:e=>{a.inject.userData.rememberChoice("cameraFollow",e.key)}});return h.events.on(l.SystemEvents.UserDataLoaded,(()=>{i.setSelection(t())})),i}function A(e){const t=(0,g.createToggle)(e,{options:[{icon:"ui/mini-icons/play",tintIcon:!0,value:u.SpectatingPlaybackSpeed.Normal},{icon:"ui/mini-icons/fast-forward",tintIcon:!0,value:u.SpectatingPlaybackSpeed.Fast},{icon:"ui/mini-icons/super-fast-forward",tintIcon:!0,value:u.SpectatingPlaybackSpeed.UltraFast}],onSelected:e=>{a.inject.userData.rememberChoice("spectatingSpeed",e),a.inject.ui.spectatingSpeed()!==u.SpectatingPlaybackSpeed.Paused&&h.events.trigger(l.UserActions.SetSpectatingPlayBackSpeed(e))}}),i=a.inject.ui.spectatingSpeed();return i!==u.SpectatingPlaybackSpeed.Paused&&i!==t.selectedValue&&t.setValue(i,!0),a.inject.ui.spectatingSpeed.watch((e=>{e!==u.SpectatingPlaybackSpeed.Paused&&e!==t.selectedValue&&t.setValue(e,!1)})),t}function B(e){const t=(0,g.createToggle)(e,{options:[{text:"ON",value:!0},{text:"OFF",value:!1}],onSelected:e=>{a.inject.userData.rememberChoice("rivalsSurrender",e)}});return h.events.on(l.SystemEvents.UserDataLoaded,(()=>{t.setValue(a.inject.userData.recallChoice("rivalsSurrender")??!0,!0)})),t}function E(e){const t=(0,g.createToggle)(e,{options:[{icon:"ui/button-icons/sound-off",value:0},{text:"1",value:.25},{text:"2",value:.5},{text:"3",value:.75},{icon:"ui/button-icons/sound-on",value:1}],initialValue:function(){const e=a.inject.userData.recallChoice("soundEffectsVolume")??1;return a.inject.userData.recallChoice("muteSoundEffects")?0:e}(),onSelected:e=>{t.setValue(e,!1),h.events.trigger(l.UserActions.SetAudioVolume({enabled:e>0,volume:e}))}});return h.events.on(l.UserActions.SetAudioVolume,(({enabled:e,volume:i})=>{t.setValue(e?i??m.app.audio.volume:0,!1)})),t}function O(e){const t=(0,g.createToggle)(e,{options:[{text:"ON",value:!0},{text:"OFF",value:!1}],initialValue:Boolean(e.scene.scale.isFullscreen),onSelected:e=>{t.setValue(e,!1),h.events.trigger(l.UserActions.SetFullScreenMode(e))}});return h.events.on(l.UserActions.SetFullScreenMode,(e=>{t.setValue(e)})),t}function R(e){const t=(0,g.createToggle)(e,{options:[{text:"ON",value:!0},{text:"OFF",value:!1}],initialValue:Boolean(a.inject.userData.recallChoice("showBudgetOverlay")),onSelected:e=>{h.events.trigger(l.UserActions.SetShowBudgetNumbers(e))}});return h.events.on(l.UserActions.SetShowBudgetNumbers,(e=>{t.setValue(e,!1)})),t}},38620:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tryToEncodeCurrentReplay=function(){try{const e=s.inject.gameStateController.history.export({snapshotPolicy:["initial","final"],includeRewinds:!0,sizeLimit:2e3,remainingLives:s.inject.levelSession.remainingLives});return(0,n.encodeReplay)(e)}catch(e){return`[failed to export] ${e.message}`}};const s=i(91622),n=i(85026)},38632:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionLedgerView=void 0;const s=i(90952),n=i(20754),o=i(76439),a=i(78436),r=i(56038),l=i(61634),c=i(81434),d=i(45664),h=i(63521),u=i(57189);class p extends n.LazyView{constructor(){super([s.GameState.pawns.byHex,s.GameState.regions.byHex]),this.name="regionLedgerView"}calculate(e,t){const i=r.Regions.model(e).byId(t),s=c.Pawns.model(e),n={},o={},a={};if(!i)return[];for(let i of r.Regions.getRegionHexes(e,t)){const t=l.Economy.getPotentialIncomeFromHex(e,i),a=l.Economy.getCurrentIncomeFromHex(e,i),r=s.findOne({hexes:(0,d.getHex)(i),traits:[h.PawnTraits.NegatesTileIncome,h.PawnTraits.Pest]}),c=s.findOne({hexes:(0,d.getHex)(i),traits:[h.PawnTraits.Terrain]});c?a>0&&g(n,(0,u.pawnTypeToStr)(c.type),1,c.income):g(n,"Fertile land",1,1),r&&g(o,(0,u.pawnTypeToStr)(r.type),1,a-t)}for(let e of i.getPawns())e.upkeep>0&&g(a,(0,u.pawnTypeToStr)(e.type),1,-e.upkeep);return[...Object.values(n),...Object.values(o),...Object.values(a)]}getCacheKey(e){return e}getDebugLayer(){return new o.GameStateDebugLayer((0,a.regionBasedAdapter)({getValue:(e,t)=>`[${this.get(e,t).length}]`,getDetail:(e,t)=>this.get(e,t).map((e=>`- ${e.count} x ${e.label}: ${e.incomeEffect}`)).join("\n")}))}}function g(e,t,i,s){e[t]||(e[t]={label:t,count:0,incomeEffect:0}),e[t].count+=i,e[t].incomeEffect+=s}t.RegionLedgerView=p},38746:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Frontlines=void 0,t.createDebugLayer=E,t.createPlacementDebugLayer=O,t.createDefensePlanDebugLayer=R,t.describeFrontline=function(e){return`${e.toLevel}@${Object.keys(e.plan).join(",")}`};const n=i(20693),o=i(65415),a=i(19506),r=i(91622),l=s(i(95608)),c=i(18957),d=i(56824),h=i(70712),u=i(1326),p=i(78635),g=i(89764),m=s(i(65731)),y=i(53096),f=i(45664),w=i(7334),v=i(63521),b=i(24598),S=i(97849),x=i(13602),T=i(13560),P=i(22973),I=i(76985),C=i(9292),M=d.logger.for("Frontlines");var A;!function(e){e.safe="safe",e.frontline="frontline",e.vulnerable="vulnerable"}(A||(A={}));const B={defenseContribution:0,pestEradicationBonus:0,expansionBonus:0,total:0,orphansPenaltyMultiplier:1,exposedUnitPenaltyMultiplier:1,diplomacyMultiplier:1};function E(e){return{name:"frontline",onChange:(0,c.signal)(),getGroups:()=>e.state.groups.getGroups(),getMap(){let t=new o.CustomHexGroupValuation("");const i=e.state.groups.byKey(A.safe),s=e.state.groups.byKey(A.frontline);for(let s of i.hexes)t.set(s.id,e.state.alreadySecureHexes.has(s)?a.GLYPH.blueFlag:a.GLYPH.whiteFlag);for(let i of s.hexes)t.set(i.id,e.isSecure(i)?a.GLYPH.defense:a.GLYPH.redFlag);return t},getDetail:t=>e.state.groups.getOwnerOf(t)?.toString()}}function O(e,t){return{name:"frontline defender placement",onChange:(0,c.signal)(),getGroups:()=>[e.gap.without(n.HexGroup.from(e.coveredHexes))],getMap:()=>t.map((e=>e.total.toFixed(1))),getDetail:e=>(0,w.prettyPrintObject)(t.get(e.id))}}function R(e){return{name:"frontline defender placement",onChange:(0,c.signal)(),getGroups:()=>[e.gap],getMap(){let t=new o.CustomHexGroupValuation("");const i=e.safeHexes,s=e.gap;for(let e of i)t.set(e.id,a.GLYPH.whiteFlag);for(let e of s)t.set(e.id,a.GLYPH.defense);for(let[i,s]of Object.entries(e.plan))t.set(Number(i),`${s}${a.GLYPH.pawn}`);return t},getDetail(e){}}}t.Frontlines=class{constructor(e,t,i){this.context=e,this.views=t,this.defenseLevel=i,this.threatAssessment=t.threatAssessment,this.region=e.region,this.myAssets=g.RegionAssets.fromMyRegion(e.region),this.warfare=p.Warfare.model(e.state),this.regionAssetsValue=T.AssetValue.total(h.AI.getRegionAssetsValue(e.state,e.region.id)),this.availableMight=this.myAssets.getRemainingAvailableMight()}async calculate(){let e,t;this.initialSetup(),await this.updateDefendedHexes(),await this.breakpoint("initial setup");do{do{e=this.safeHexes.size,this.optimizeFrontline(),await this.breakpoint("optimized frontline"),t=this.safeHexes.size,e!==t&&(await this.updateDefendedHexes(),await this.breakpoint("updated defended hexes"))}while(e!==t);await this.saveCandidateFrontline(),await this.breakpoint("candidate frontline"),e=this.vulnerableHexes.size,await this.advanceFrontline(),t=this.vulnerableHexes.size}while(e!==t);M.debug(`CANDIDATES:\n${this.candidates.map((e=>{const t=((this.region.hexes.length-e.vulnerableHexes.length)/this.region.hexes.length*100).toFixed(0),i=(e.safeAssets/this.regionAssetsValue*100).toFixed(0);return` - ${e.gap.map((e=>e.id)).join(",")} to level ${e.toLevel} protects ${t}% hexes (${this.region.hexes.length-e.vulnerableHexes.length}/${this.region.hexes.length}) and ${i}% assets (${e.safeAssets}/${this.regionAssetsValue}), spending ${e.requiredMight} might`})).join("\n")}`);for(let e of this.candidates)await this.processCandidateFront(e)?await this.defensePlanBreakpoint(e,`frontlines: candidate plan L${e.toLevel} with score ${e.score}\ncost ${e.requiredMight} coverage ${this.region.hexes.length-e.vulnerableHexes.length} hexes, ${e.safeAssets} might`):await this.defensePlanBreakpoint(e,`frontlines: DISCARDED plan L${e.toLevel} with score ${e.score}\ncost ${e.requiredMight} coverage ${this.region.hexes.length-e.vulnerableHexes.length} hexes, ${e.safeAssets} might`);const i=this.bestFronts.peek();if(i){const e=i;await this.defensePlanBreakpoint(e,`frontlines: best plan L${e.toLevel} with score ${e.score}\ncost ${e.requiredMight} coverage ${this.region.hexes.length-e.vulnerableHexes.length} hexes, ${e.safeAssets} might`)}}scoreCandidate(e){if(0===e.requiredMight)return 0;const t=2===e.toLevel?20:5;return e.defendedHexes*t/e.requiredMight*(e.safeAssets/this.regionAssetsValue)*(e.finalAssets?x.AIMetrics.economyHealth(e.finalAssets,this.context.focus):1)}async breakpoint(e){"number"==typeof d.config.debug.ai&&this.region.id!==d.config.debug.ai||await r.inject.debugBreakpoint("frontlines: "+e,(()=>({debugLayer:E(this)})))}async defensePlanBreakpoint(e,t){"number"==typeof d.config.debug.ai&&this.region.id!==d.config.debug.ai||await r.inject.debugBreakpoint(t,(()=>({hexes:n.HexGroup.fromIds(Object.keys(e.plan).map((e=>Number(e)))),debugLayer:R(e)})))}async saveCandidateFrontline(){const e=1-this.vulnerableHexes.size/this.state.regionHexes.length;let t,i=new Set;for(let e of this.frontlineHexes)this.isSecure(e)||i.add(e);if(t=0===i.size?this.defenseLevel:0,0===i.size)return;const s=function(e){let t=0;return n.HexGroup.from(e).components().forEach((e=>t+=Math.ceil(e.size/3))),t}(i)*this.defenseLevel,o=this.region.hexes.without(n.HexGroup.from(this.vulnerableHexes));this.candidates.push({hexes:n.HexGroup.from(this.frontlineHexes),safeHexes:o,vulnerableHexes:n.HexGroup.from(this.vulnerableHexes),safeAssets:this.state.protectedAssetValue+this.state.alreadySecureAssetValue,defendedAssets:this.state.protectedAssetValue,defendedHexes:o.length-this.state.alreadySecureHexes.size,plan:{},finalAssets:null,fromLevel:0,toLevel:this.defenseLevel,requiredMight:s,coveredHexes:new Set,gap:n.HexGroup.from(i),score:100*e/(1+s)})}async processCandidateFront(e){const t=this.bestFronts.peek()?.score??0;if(2*this.scoreCandidate(e)<t)return;if(e.requiredMight*(2===e.toLevel?3:2)>=this.safeHexes.size)return;if(e.requiredMight>2*this.availableMight)return;if(1===e.toLevel&&3*e.requiredMight<2*this.myAssets.remainingUnits.countOf(1))return;const i=this,s=e.toLevel,n={};let o=e.gap.with(e.gap.neighbours()).filter((e=>h.AI.canPlaceDefenderAt(this.region.state,e,this.region,s)));const a=new Set(e.gap.toArray());let l=this.myAssets,c=0;const d=new y.HexGroupValuationWithHeap(B,(e=>-e.total));let u;for(p(o);u=await g();){S.assert.defined(l);const t=this.choosePawnType(u,s,e,l);if(!t)return;if(n[u.id]=t,l=t===b.PawnType.Castle?l.remainingIncome>=2?l.buildCastle({fortificationGain:P.Fortification.getDeltaAfterCastleBuilt(this.context.state,u.id)}):void 0:l.useUnit({requiredMight:s,allowNegativeIncome:!1,...(0,I.getMaxMightForHex)(this.context.state,u)})?.assets,!l)return;if(l.remainingIncome<=0)return;e.coveredHexes.add(u),a.delete(u),c+=e.toLevel;const i=u.floodFillOut(((e,t,i)=>i<=2)).filter((e=>d.get(e.id).defenseContribution>0));for(let t of u.neighbours())e.coveredHexes.add(t),a.delete(t);for(let e of i)d.unset(e.id);p(i.filter((e=>a.has(e)||!!e.neighbours().find((e=>a.has(e))))))}return e.plan=n,e.requiredMight=c,e.finalAssets=l,e.score=this.scoreCandidate(e),this.bestFronts.push(e),n;function p(t){for(let s of t){const t=i.calculateDefenderPlacementScore(e,s);d.set(s.id,t)}}async function g(){const t=d.pop()?.id;if(void 0===t)return;const i=(0,f.getHex)(t);return await r.inject.debugBreakpoint(`frontlines: defensePlan ${e.fromLevel} -> ${e.toLevel}`,(()=>({hexes:(0,f.getHex)(i.id),debugLayer:O(e,d)}))),i}}choosePawnType(e,t,i,s){return 1===t?b.PawnType.Villager:2===t?p.Warfare.canBuildCastleAt(this.context.state,e,this.context.region.id)&&s.remainingGold>=20&&this.context.faction.persona.buildsCastles?b.PawnType.Castle:b.PawnType.Pikeman:void 0}calculateDefenderPlacementScore(e,t){const i=t.with(t.neighbours()).neighbours().filter((t=>e.gap.has(t)&&!e.coveredHexes.has(t)));let s=0;for(let t of i)t.neighbours().find((t=>e.gap.has(t)&&!e.coveredHexes.has(t)))||++s;const n=t.with(t.neighbours()).filter((e=>this.region.hexes.has(e))).map((t=>{if(e.coveredHexes.has(t))return 0;const i=this.warfare.getHexDefenseWithoutMovableUnits(t),s=this.threatAssessment.get(t.id).strongestUnit,n=(0,C.pickSmaller)(s,e.toLevel);return n<=i?0:(n-i)*(e.hexes.has(t)?1:.1)})),o=this.context.region.parentModel.byHex(t);let a,l;o!==this.region&&o?(a=(0,C.pickSmaller)(1,2*r.inject.views.hostility.get(this.context.state,{attacker:this.context.faction,victim:o.faction})),l=.5):(a=1,l=0),this.warfare.getOccupyingUnit(t)?.hasTrait(v.PawnTraits.Pest);const c={expansionBonus:l,pestEradicationBonus:x.AIMetrics.getPestEradicationBonus(this.context.state,t)/10,defenseContribution:n.reduce(C.sum,0),diplomacyMultiplier:a,exposedUnitPenaltyMultiplier:this.getExposedUnitPenalty(e,t),orphansPenaltyMultiplier:1/(1+s)};return{...c,total:(c.defenseContribution+c.pestEradicationBonus+c.expansionBonus)*c.diplomacyMultiplier*c.exposedUnitPenaltyMultiplier*c.orphansPenaltyMultiplier}}getExposedUnitPenalty(e,t){const i=e.toLevel;let s;return s=this.threatAssessment.get(t.id)?.riskByDefenderMight[i]??0,0===s||this.safeHexes.has(t)?1:p.Warfare.getHexStaticDefense(this.region.state,t.id)>0?.9:(0,C.pickLarger)(.5,1-s)}isSecure(e){const t=p.Warfare.getHexDefenseWithoutMovableUnits(this.region.state,e);return t>=this.defenseLevel||t>=this.threatAssessment.get(e.id).strongestUnit}initialSetup(){this.state={groups:new l.default,regionHexes:this.region.hexes,hostileBorderHexes:this.region.getHostileBorderHexes(),protectedAssetValue:0,alreadySecureHexes:new Set,alreadySecureAssetValue:0},this.candidates=[],this.bestFronts=new m.default(((e,t)=>t.score-e.score));const{groups:e,regionHexes:t,hostileBorderHexes:i}=this.state;for(let i of t)e.addToGroup(A.vulnerable,i);for(let e of this.region.getTownHexes())this.addToFrontline(e)}async updateDefendedHexes(){const{groups:e}=this.state,t=this.state.hostileBorderHexes.filter((t=>!!this.threatAssessment.get(t.id).strongestUnit&&!!this.isStillThreatened(t)&&e.getOwnerOf(t)===A.vulnerable)).floodFillOut((t=>e.getOwnerOf(t)===A.vulnerable)),i=n.HexGroup.from(e.byKey(A.vulnerable).hexes).without(t);this.addToSafeHexes(...i)}isStillThreatened(e){const t=e.neighbours((e=>!this.safeHexes.has(e)&&!this.frontlineHexes.has(e)));for(let i of t){const t=h.AI.getHexInfluence(this.region.state,i.id).entrySeq();for(let[s,n]of t)if(this.threatAssessment.get(e.id).regions.includes(s)&&!this.isAttackVectorPassingThroughFrontline(i,s))return!0}return!1}isAttackVectorPassingThroughFrontline(e,t,i=new Set){if(this.frontlineHexes.has(e))return!0;if(i.has(e))throw new Error(`Cycle detected while following influence vector of region ${t} passing through hex ${e.id}!`);i.add(e);const s=h.AI.getHexInfluence(this.context.state,e.id,t)?.parent;return!!s&&this.isAttackVectorPassingThroughFrontline(s,t,i)}addToSafeHexes(...e){this.countProtectedUnitsAndHexesFrom(e),this.state.groups.addToGroup(A.safe,...e)}countProtectedUnitsAndHexesFrom(e){for(let t of e){if(!this.vulnerableHexes.has(t))continue;const e=h.AI.getTotalHexAssetValue(this.region.state,t.id);this.isSecure(t)?(this.state.alreadySecureHexes.add(t),this.state.alreadySecureAssetValue+=e):this.state.protectedAssetValue+=e}}addToFrontline(...e){this.countProtectedUnitsAndHexesFrom(e),this.state.groups.addToGroup(A.frontline,...e)}optimizeFrontline(){const e=new Set(this.frontlineHexes),{groups:t,hostileBorderHexes:i}=this.state;for(;e.size>0;){const s=e[Symbol.iterator]().next().value;e.delete(s);const n=s.neighbours((e=>t.getOwnerOf(e)===A.vulnerable)),o=n.filter((e=>!this.isSecure(e))),a=n.filter((e=>this.isSecure(e)));if(a&&(this.addToFrontline(...a),a.forEach((t=>e.add(t)))),i.has(s)&&this.isStillThreatened(s));else if(0===n.length)this.addToSafeHexes(s);else if(0===o.length)n.forEach((e=>this.addToFrontline(e))),this.addToSafeHexes(s);else if(1===n.length){const t=n.first();this.isSecure(s)&&!this.isSecure(t)||(this.addToSafeHexes(s),this.addToFrontline(t),t.neighbours((e=>this.frontlineHexes.has(e))).forEach((t=>e.add(t))),e.add(t))}}}async advanceFrontline(){const{groups:e,hostileBorderHexes:t}=this.state,i=n.HexGroup.from(this.frontlineHexes).neighbours().filter((t=>e.getOwnerOf(t)===A.vulnerable)).components().map((e=>({hexes:n.HexGroup.from(e)}))).filter((({hexes:e})=>e.length>0)),s=(0,u.findMax)(i,(e=>e.hexes.members.reduce(((e,t)=>{const i=h.AI.getHexImportance(this.region.state,t.id);if(!i)return e;const s=i.value/(5+i.distanceFromTown);return(0,C.pickLarger)(e,s)}),0)));if(!s)return;await r.inject.debugBreakpoint("frontlines: to advance",(()=>({hexes:s.hexes,debugLayer:E(this)})));const o=s.hexes;o.members.filter((e=>this.frontlineHexes.has(e)&&this.isSecure(e))).forEach((e=>this.addToSafeHexes(e))),o.forEach((e=>this.addToFrontline(e)))}get frontlineHexes(){return this.state.groups.byKey(A.frontline).hexes}get safeHexes(){return this.state.groups.byKey(A.safe).hexes}get vulnerableHexes(){return this.state.groups.byKey(A.vulnerable).hexes}}},39217:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UIVariantSwitcher=void 0;const s=i(84006),n=i(11466),o=i(54825);t.UIVariantSwitcher=class{constructor(e){this.activeVariant=null,this.scene=e.scene,this.getLargeUI=(0,s.singletonFactory)(e.largeUI),this.getCompactUI=(0,s.singletonFactory)(e.compactUI),e.scene.observe.watch(o.app.device.uiVariant,(e=>{this.visible&&this.handleVariantChange(e)})),this.handleVariantChange(o.app.device.uiVariant())}get visible(){return!!this.activeVariant}setVisible(e){!e&&this.activeVariant?this.handleVariantChange(null):e&&!this.activeVariant&&this.handleVariantChange(o.app.device.uiVariant())}_getUI(e){return e===n.UiVariant.Large?this.getLargeUI():this.getCompactUI()}handleVariantChange(e){e!==this.activeVariant&&(this.activeVariant&&this._getUI(this.activeVariant).deactivate(),this.activeVariant=e,null!==e&&(this.activeUI=this._getUI(e),this.activeUI.activate(this.scene.currentState)))}}},39261:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.listViewStory=void 0,i(69572);const s=i(80959),n=i(54825),o=i(34174);function a(e){const t=e.simpleListView();return t.width=200,t.setItems(["First Item","Second Item","Third Item"]),t}function r(e){const t=e.dropdownListView({theme:"dropdownList"});return t.setItems([{text:"Option 1"},{text:"Option 2"},{icon:{color:25600},text:"Option 3"}]),t}function l(e){const t=e.buttonsListView({});let i=[{icon:{color:16711680},text:"Row with trophy",addons:[{icon:"ui/level-features/difficulty-hard"}]},{text:"Deletable row",addons:[{icon:"ui/button-icons/edit",onClicked:()=>n.app.notifications.info("Edit clicked","This is a placeholder for edit action")},{icon:"ui/button-icons/trash",onClicked:()=>{i.splice(1,1),t.setItems(i)}}]},{text:"Simple row"},{text:"[i]+ Add new item[/i]",key:"add"}];return t.onItemSelected((async({item:e})=>{if("add"===e.key){let s=["Foo","Bar","Baz"];t.setItems(i);const a=t.rows.find((t=>t===e)),{promise:r,cancel:l}=n.app.dropdowns.dropdownList(o.Placement.aroundUiObject(a),{items:s.map((e=>({text:e})))}),c=await r;if(!c)return;const d={text:c.text,key:c.key,addons:[{icon:"ui/button-icons/trash",onClicked:()=>{i=i.filter((e=>e.text!==d.text)),t.setItems(i)}}]};i.splice(i.length-1,0,d),t.setItems(i)}})),t.setItems(i),t}t.listViewStory={name:"ListView",content:e=>{const t=s.UiBuilder.for(e);return[{name:"simpleListView",component:a(t)},{name:"dropdownListView",component:r(t),backgroundColor:e=>e.oceanShades.dark3},{name:"buttonsListView",component:l(t),backgroundColor:e=>e.oceanShades.dark1}]}}},39409:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SituationExplorer=void 0,t.createAiViews=p;const s=i(56824),n=i(17565),o=i(97425),a=i(91622),r=i(29064),l=i(20276),c=i(44616),d=i(7334),h=i(87310),u=s.logger.for("SituationExplorer");function p(e){const t=new n.ThreatAssessment(e.faction),i=new l.SecurityView({faction:e.faction,threatAssessment:t,recklessness:e.focus.daring},"planning");return{threatAssessment:t,planningSecurity:i,evaluationSecurity:new l.SecurityView({faction:e.faction,threatAssessment:t,recklessness:e.aiPersonality.daring},"evaluation"),conquestValue:new r.ConquestValue(e,{planningSecurity:i}),defenderBenefit:new c.DefenderBenefitView(e,i)}}t.SituationExplorer=class{constructor(e){this.context=e,this.situationStack=[],this.situationCache=new Map,this.gameWon=!1;const t=p(e);this.situationStack=[{label:"start",...e.game.createCheckpoint(),score:Number.NEGATIVE_INFINITY,views:t}],this.bestOutcomeSoFar=this.situationStack[0]}async tryBest(e,t){this.context.abortWatcher.throwIfAborted();let i=new o.CompositePlanner({allowedTactics:t});this.context.focus={...this.context.aiPersonality,daring:e},this.currentSituation.views.planningSecurity.setRecklessness(e),this.refreshViewsAffectedByFocus();const s=this.context.region.size-this.context.initialRegionSize;return await this.executeBestPlan(i,`CR ${e.toFixed(2)} EX ${s}/${this.context.expansionTarget}`)}async explore(e,t){this.context.abortWatcher.throwIfAborted();let i,s=new o.CompositePlanner({allowedTactics:t});this.context.focus={...this.context.aiPersonality,daring:e},this.currentSituation.views.planningSecurity.setRecklessness(e),this.refreshViewsAffectedByFocus();do{const t=this.context.region.size-this.context.initialRegionSize;if(i=await this.executeBestPlan(s,`CR ${e.toFixed(2)} EX ${t}/${this.context.expansionTarget}`),i?.endsTurn)return}while(i&&!i.endsTurn)}async executeBestPlan(e,t=""){this.context.abortWatcher.throwIfAborted();const i=e.generatePlans(this.context,this.currentSituation.views);let s=!1,n=(await i.next()).value;for(;n;){const o=n.hash(),r=(await i.next()).value;if(this.context.blacklistedPlans.has(o)){n=r;continue}await this.context.breakpoint(`ai:chosen-plan (${t}): ${n}`,(()=>({debugLayer:e.getDebugLayer(),hexes:n.hexes??n.hex})));const l=this.context.game.createCheckpoint();if(s=n.execute(this.context,(r?.score??0)/2),await a.inject.performance.preventFreeze(),this.context.abortWatcher.throwIfAborted(),s){if(n.endsGame)throw new h.AIEarlyExitException;return this.addSituation(n.constructor.name,n),n}u.warning(`Failed to execute ${n}`),this.context.blacklistedPlans.add(o),await this.context.breakpoint("ai:next-plan FAILED",(()=>({debugLayer:e.getDebugLayer(),hexes:n.hex??n.hexes}))),this.context.game.restoreCheckpoint(l),n=r}}get currentSituation(){return this.situationStack[this.situationStack.length-1]}backtrack(e=1){const t=this.situationStack[0].score,i=this.situationStack[this.situationStack.length-1].score;if(i<=t)this.goTo(this.situationStack[0]);else{const s=i-(i-t)/e,n=this.situationStack.find((e=>e.score>=s));this.situationStack.splice(this.situationStack.indexOf(n)+1),this.context.game.restoreCheckpoint(n)}}rollback(e){let t=this.situationStack.length-1;for(;t>e.keep;)--t;this.situationStack.splice(t+1),this.context.game.restoreCheckpoint(this.situationStack[this.situationStack.length-1]),this.updateDebugData()}rollbackPointlessMoves(e){let t=this.situationStack.length-1;const i=t;for(;t>e.keepAtLeast&&(i-t<e.rollbackAtLeast||this.situationStack[t].score-this.situationStack[t-1].score<e.scoreThreshold);)--t;this.situationStack.splice(t+1),this.context.game.restoreCheckpoint(this.situationStack[this.situationStack.length-1]),this.updateDebugData()}goToBestOutcomeSoFar(){this.goTo(this.bestOutcomeSoFar)}goTo(e){this.context.game.restoreCheckpoint(e),this.updateDebugData();const t=this.situationStack.indexOf(e);-1===t?this.situationStack=[e]:this.situationStack.splice(t+1)}addSituation(e,t){let i;if(t.endsGame)return this.gameWon=!0,void(this.bestOutcomeSoFar={...this.context.game.createCheckpoint(),score:Number.POSITIVE_INFINITY,label:e,views:this.currentSituation.views});if(this.situationCache.has(this.context.game.currentState))i=this.situationCache.get(this.context.game.currentState),this.refreshViewsAffectedByFocus(i.views);else{const t=p(this.context),s=this.appraiseCurrentSituation(t);i={...this.context.game.createCheckpoint(),score:s,label:e,views:t}}this.situationStack.push(i),this.situationCache.set(this.context.game.currentState,i),this.updateDebugData()}async considerCurrentSituation(){this.context.abortWatcher.throwIfAborted(),this.currentSituation.score>this.bestOutcomeSoFar.score?(this.bestOutcomeSoFar=this.currentSituation,await this.context.breakpoint(`ai: considering:  NEW BEST RESULT: ${this.currentSituation.label} ${(0,d.formatNumber)(this.currentSituation.score)}`,(()=>({debugLayer:a.inject.views.situationScoreByRegion.getDebugLayer(this.context)})))):await this.context.breakpoint(`ai: considering:  worse result: ${this.currentSituation.label} ${(0,d.formatNumber)(this.currentSituation.score)} (vs ${this.bestOutcomeSoFar.label} ${this.bestOutcomeSoFar.score})`,(()=>({debugLayer:a.inject.views.situationScoreByRegion.getDebugLayer(this.context)})))}updateDebugData(){s.config.debug.ai&&a.inject.debugData.set("SituationExplorer","\n"+this.situationStack.map((e=>` - ${e.label}(${(0,d.formatNumber)(e.score)})`)).join("\n")+`\nWinner: ${this.bestOutcomeSoFar.label}(${this.bestOutcomeSoFar.score})`)}appraiseCurrentSituation(e){return this.context.isOffensiveActionRequired()?0:a.inject.views.situationScoreByRegion.get(this.context.state,{views:e,context:this.context})}refreshViewsAffectedByFocus(e=this.currentSituation.views){e.planningSecurity.setRecklessness(this.context.focus.daring)}}},39420:(e,t)=>{"use strict";var i;function s(e){return t=>{const i=e+"."+t,s=function(t){return{name:i,payload:t,category:e,isTypedEvent:!0}};return s.eventName=e+"."+t,s.category=e,s}}Object.defineProperty(t,"__esModule",{value:!0}),t.EventCategory=void 0,t.gameStateEvent=function(){return s(i.GameState)},t.systemEvent=function(){return s(i.System)},t.userAction=function(){return s(i.UserAction)},t.uiEvent=function(){return s(i.UiEvent)},t.playEvent=function(){return s(i.Play)},t.worldMapAction=function(){return s(i.WorldMap)},t.createEventFactory=s,t.isEvent=function(e,t){return!(!e||!e.hasOwnProperty("isTypedEvent")||t&&e.name!==t.eventName)},t.createTypedEventHandler=function(){const e={};return{on(t,i){if(e[t.eventName])throw new Error(`${t.eventName} already has a handler!`);e[t.eventName]=i},handle:t=>e[t.name]?.(t.payload)}},function(e){e.GameState="GAME_STATE",e.System="SYSTEM",e.UserAction="USER_ACTION",e.UiEvent="UI_EVENT",e.ReportingEvent="TELEMETRY",e.IFrame="IFRAME",e.MapEditor="UI_MAP_EDITOR",e.WorldMap="UI_WORLD_MAP",e.Play="PLAY",e.News="NEWS"}(i||(t.EventCategory=i={}))},39435:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugData=void 0;const s=i(56824),n=["hexInfo"];t.DebugData=class{constructor(){this.items={}}set(e,t){this.items[e]=t}get(e){return this.items[e]}clear(e){delete this.items[e]}getText(){const e=s.config.debug.dataFilter;return Object.entries(this.items).filter((([t])=>(!e||t.includes(e))&&-1===n.indexOf(t))).map((([e,t])=>`${e}: ${t}`)).join("\n")}}},39481:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayLogAutoBuilder=void 0;const s=i(56824),n=i(36868),o=i(91622),a=i(54825),r=i(53720),l=i(80987),c=i(75742),d=i(24598),h=i(2543),u=i(9292);s.logger.for("PlayLog"),t.PlayLogAutoBuilder=class{update(e){document.hidden||e!==a.app.screen.play?(this.stopwatch.pause(),this.isPlayerTurn=!1):(this.stopwatch.start(),this.updateCurrentItemFromGameState())}constructor(){this.stopwatch=new r.Stopwatch,this.aiTimeStopwatch=new r.Stopwatch,this.currentItem={...l.BLANK_PLAY_LOG_ITEM},this.log=[],this.isPlayerTurn=!1,this.hasErrors=!1,s.events.on(n.SystemEvents.LevelSessionStarted,(({sessionId:e})=>{this.reset()})),s.events.on(n.SystemEvents.ScreenActivated,(({screen:e})=>{this.update(e)})),s.events.on(n.SystemEvents.UserBecameInactive,(()=>{this.stopwatch.pause()})),s.events.on(n.SystemEvents.UserBecameActive,(()=>{this.update(a.app.navigator.currentScreen)})),s.events.on(n.UserActions.Undo,(()=>{++this.currentItem.undos})),s.events.on(n.UiEvents.RewindConfirmed,(({targetTurn:e})=>{this.currentItem.rewindTo=e,this.commitEntry()})),s.events.on(n.GameStateEvents.FactionTurnOver,(e=>{1===e.factionId&&(this.logElapsedTime(),this.updateCurrentItemFromGameState(),this.aiTimeStopwatch.pause(),this.aiTimeStopwatch.reset(),this.isPlayerTurn=!1)})),s.events.on(n.GameStateEvents.FactionTurnStarted,(e=>{1===e.factionId&&(this.currentItem.aiSeconds=this.aiTimeStopwatch.getElapsedSeconds(),this.commitEntry(),this.updateCurrentItemFromGameState())})),s.events.on(n.SystemEvents.FactionAiBegin,(()=>{this.aiTimeStopwatch.start()})),s.events.on(n.SystemEvents.FactionAiEnd,(()=>{this.aiTimeStopwatch.pause()})),s.events.on(n.SystemEvents.FatalError,(e=>{this.currentItem.errors||(this.currentItem.errors=[]),this.currentItem.errors.push({id:e.correlationId,message:e.message}),this.hasErrors=!0}));const e=()=>{o.inject.gameStateModel.currentPhase.isLocalPlayerTurn()&&++this.currentItem.moves};s.events.on(n.GameStateEvents.PawnBought,e),s.events.on(n.GameStateEvents.PawnMoved,e),s.events.on(n.GameStateEvents.HexCaptured,e)}commitEntry(){this.logElapsedTime(),this.log.push({...this.currentItem,aiSeconds:(0,h.round)(this.currentItem.aiSeconds,1),seconds:(0,h.round)(this.currentItem.seconds,1)}),this.startNewEntry()}startNewEntry(){this.stopwatch.reset(),this.aiTimeStopwatch.pause(),this.aiTimeStopwatch.reset(),this.currentItem={...l.BLANK_PLAY_LOG_ITEM}}reset(){this.log=[],this.startNewEntry()}getPlayLog(){return this.log}updateCurrentItemFromGameState(){this.currentItem.balance=function(){const e=[],t=o.inject.gameStateModel.factions;for(let i=1;i<=c.MAX_FACTIONS_COUNT;i++){const s=t.byId(i)?.size;s&&(e[i]=s)}const i=o.inject.gameStateModel.pawns.select({type:[d.PawnType.Forest]}).length,s=o.inject.gameStateModel.regions.all().filter((e=>!e.isAlive())).map((e=>e.size)).reduce(u.sum,0);return e[0]=s-i,e}(),this.currentItem.turn=o.inject.gameStateModel.currentPhase.turnNumber,this.isPlayerTurn=o.inject.gameStateModel.currentPhase.isLocalPlayerTurn(),this.isPlayerTurn&&this.logElapsedTime()}logElapsedTime(){this.currentItem.seconds+=this.stopwatch.getElapsedSeconds(),this.isPlayerTurn&&(this.currentItem.playSeconds+=this.stopwatch.getElapsedSeconds()),this.stopwatch.reset()}getTotalSeconds(){return this.logElapsedTime(),this.log.reduce(((e,t)=>e+t.seconds),0)+this.currentItem.seconds}}},39631:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LODManager=void 0,t.LODManager=class{constructor(e,t=[]){this.camera=e,this.latestZoom=void 0,this.handlers=t}registerLODlevel(e){this.handlers.push(e)}update(){this.apply(this.camera.zoom)}apply(e,t){if(e!==this.latestZoom||t){for(let i of this.handlers)!i.when(e)||void 0!==this.latestZoom&&!t&&i.when(this.latestZoom)||i.activate(e);this.latestZoom=e}}}},39648:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LivesCounter=t.LivesCounterMode=void 0;const s=i(80959),n=i(86545),o=i(20087),a=i(87521),r=i(97849),l=i(56824),c=i(91622),d=l.logger.for("LivesCounter");var h;!function(e){e.Muted="muted",e.FullColor="full-color",e.Cracked="cracked"}(h||(t.LivesCounterMode=h={}));class u extends n.BaseResponsiveContainer{constructor(e,t=1){super(e),this.origin=t,this.ui=s.UiBuilder.for(this.scene),this.displayMode=h.Muted,this.pool=new a.Pool((()=>this.ui.image("ui/mini-icons/heart").setOrigin(0,0))).preload(3),this.lives=[]}setMode(e){return this.displayMode===e||(this.displayMode=e,this.lives.forEach(((t,i)=>p(t,e,i===this.lives.length-1)))),this}setCount(e){(0,r.assert)(e>=0),this.displayMode===h.Cracked&&e>0&&(e>this.lives.length&&this.lives.length>0?p(this.lives[this.lives.length-1],this.displayMode,!1):e<this.lives.length&&p(this.lives[e-1],this.displayMode,!0));for(let t=this.lives.length;t<e;++t){const i=p(this.pool.take(),this.displayMode,t===e-1);i.setVisible(!0),this.lives.push(i),this.add(i)}for(;this.lives.length>e;){const e=this.lives.pop();this.pool.free(e),e.setVisible(!1),this.remove(e)}this.preUpdate.makeDirty()}getContentWidth(){if(!this.lives.length)return 0;const e=this.lives[this.lives.length-1];return e.x+e.width-this.lives[0].x}updateLayout(){o.Arrange.leftToRight({content:this.lives,x:this.origin*this.width,origin:this.origin,spacing:4}),o.Arrange.alignY({content:this.lives,y:this.height/2,origin:.5})}burnLife(){const e=this.lives.shift();e?(this.remove(e),this.scene.add.existing(e),e.setPosition(this.x+e.x,this.y+e.y),this.scene.tweens.add({targets:[e],props:{y:"-=20",alpha:0},duration:1e3,ease:"Sine.easeOut",onComplete:()=>this.pool.free(e)}),this.preUpdate.makeDirty()):d.warning("Requested to burn one life, but there are no lives left.")}}function p(e,t,i){const s=i||t!==h.Cracked?t:h.FullColor;switch(e.setAlpha(1),s){case h.FullColor:return e.setFrame("ui/mini-icons/heart-colored"),e.clearTint(),e.setAlpha(1),e;case h.Muted:return e.setFrame("ui/mini-icons/heart"),e.setTint(c.inject.theme.getCurrent().oceanContrastLight),e.setAlpha(.3),e;case h.Cracked:return e.setFrame("ui/mini-icons/heart-broken"),e.clearTint(),e.setAlpha(1),e}}t.LivesCounter=u},39816:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BasicDefensePlanner=void 0;const s=i(89764),n=i(78635),o=i(70712),a=i(81434),r=i(22312),l=i(80218),c=i(56824),d=i(15143),h=i(20693),u=i(63521),p=i(91622),g=i(4586),m=i(13602),y=i(29064),f=i(56038),w=i(80268),v=i(9292),b=i(22973),S=i(76985),x=i(61634);c.logger.for("BasicDefensePlanner"),t.BasicDefensePlanner=class{constructor(e){this.paranoidTownProtection=e,this.isConquest=!1,this.name=this.constructor.name}async*generatePlans(e,t){this.context=e,this.views=t,this.focus=e.focus,this.state=e.state,this.regionAssets=s.RegionAssets.fromMyRegion(e.region);const i=this.getObtainableCastles(this.regionAssets),a=this.regionAssets.getObtainableMightLevels({allowNegativeIncome:!0}),c=(0,v.pickLarger)(a[a.length-1]??0,i[i.length-1]??0);if(this.focus.daring<1){let t=this.context.region.hexes.filter((t=>n.Warfare.getOccupyingPawn(e.state,t)?.hasTrait(u.PawnTraits.Pest)||this.views.planningSecurity.get(t.id)<1&&n.Warfare.getHexDefenseWithoutMovableUnits(e.state,t)<c));const s=n.Warfare.getConquerableHexes(this.state,e.region.id,this.regionAssets.getMaxRemainingAvailableMight());if(e.isOffensiveActionRequired()&&(t=h.HexGroup.empty),t.length||s.length){const c=h.HexGroup.from([...s,...t,...t.neighbours()]);for(const t of c){const s=f.Regions.getByHex(this.state,t.id)===this.context.region.id,c=n.Warfare.getOccupyingPawn(this.state,t),d=n.Warfare.canBuildCastleAt(this.state,t,this.context.region.id),h=c&&!c.isMovable();for(let i=1;i<=4;++i){if(!a.includes(i))continue;if(i>=3&&s)continue;if(!o.AI.canPlaceDefenderAt(this.state,t,e.region,i))continue;const n=this.calculateFactorsForPlacingDefender(t,i);n&&this.isReasonableDefensiveMove(t,i,n)&&(yield new r.PlaceUnitPlan(t,i,n))}if(s&&!h&&d&&this.context.faction.persona.buildsCastles)for(const e of i){const i=this.calculateFactorsForPlacingDefender(t,e,!0);i&&i.threatReduction>0&&(yield new l.PlaceCastlePlan(t,e,i))}}}}if(0===this.regionAssets.remainingUnits.count()&&(yield new d.EndTurnPlan(this.context,this.regionAssets)),p.inject.gameStateModel.plugins.zombies&&this.regionAssets.remainingUnits.getTotalMight()>0){const e=a[0],t=(0,g.getDangerousZombies)(this.context.region);for(let i of t){const t=this.calculateFactorsForPlacingDefender(i,e);t&&(yield new r.PlaceUnitPlan(i,e,{...t,conquestValue:{...t.conquestValue,factors:{...t.conquestValue.factors,loot:500}},focusMismatchPenalty:1}))}}}isReasonableDefensiveMove(e,t,i){return 1===t||!(!this.regionAssets.remainingUnits.has(t)&&i.conquestValue.factors.damageToEnemy<10&&i.threatReduction<10)}getObtainableCastles(e){return e.remainingGold>=20&&e.remainingIncome>=2?[2]:[]}calculateFactorsForPlacingDefender(e,t,i=!1){const a=n.Warfare.model(this.context.state).getOccupyingUnit(e),r=a?.hasTrait(u.PawnTraits.Pest),l=x.Economy.model(this.context.state).potentialIncomeFromHex(e),c=a?.hasTrait(u.PawnTraits.Unit)&&a?.might===t;c&&++t;const d=!this.context.region.hexes.has(e);if(d&&n.Warfare.getHexDefenseWithoutMovableUnits(this.context.state,e)>=t)return;const h=m.AIMetrics.getPestEradicationBonus(this.context.state,e),g=m.AIMetrics.getJoinRegionsBonus(this.context,e)??{conquestValueBonus:0,incomeGain:0},f=s.RegionAssets.fromMyRegion(this.context.region);let T;if(T=i?f.buildCastle({fortificationGain:b.Fortification.getDeltaAfterCastleBuilt(this.context.state,e.id)}):f.useUnit({requiredMight:t,incomeGain:d||r?l+g.incomeGain:this.getDefenderLootBonus(e,t),loot:n.Warfare.getPotentialLoot(this.context.state,e,d),willSacrifice:!1,allowOverkill:!1,...(0,S.getMaxMightForHex)(this.context.state,e)})?.assets,!T)return;const P=this.views.threatAssessment.get(e.id).riskByDefenderMight[t]??0,I=n.Warfare.getHexStaticDefense(this.context.state,e.id)>=1,C=this.protectsImportantTown(e,t),M=1===t&&o.AI.getHexImportance(this.context.state,e.id).value>100&&f.regionSize>10?.75:1;return{conquestValue:d?this.views.conquestValue.get(e.id):y.NO_CONQUEST_VALUE,downstreamMovesBonus:0,joinRegionsBonus:d?g.conquestValueBonus:0,threatReduction:this.views.defenderBenefit.getForMight(e.id,t)*M,eradicatePestBonus:h,diplomacyPenalty:d?w.AIPolitics.getDiplomaticPenalty(this.context,e):0,mightInvestment:c?t-1:t,vulnerabilityPenalty:I&&!i?1:m.AIMetrics.riskToVulnerabilityPenalty(P,this.context.focus.daring)*p.inject.plugins.ai.hexVulnerabilityMultiplier.apply(1,this.context.state,this.context.faction.id,e,t),economyHealth:m.AIMetrics.economyHealth(T,this.context.focus),focusMismatchPenalty:C?10:(0,v.cropNumber)(m.AIMetrics.focusMismatchPenaltyV2(this.context,T,d?"offense":"defense"),.1,1)}}protectsImportantTown(e,t){if(!this.paranoidTownProtection)return!1;const i=this.context.region.getTownHexes();if(1!==i.length)return!1;const s=i.first(),o=n.Warfare.getHexDefenseWithoutMovableUnits(this.context.state,s);return!(o>=t||this.views.threatAssessment.get(s.id).strongestUnit<=o)}getDefenderLootBonus(e,t){const i=a.Pawns.model(this.state).findOne({traits:[u.PawnTraits.Pest],hexes:e});if(i?.hasTrait(u.PawnTraits.Undead)){const t=e.neighbours((e=>this.context.region.getTownHexes().has(e))).first();return t?10*(o.AI.getHexImportance(this.state,t.id).value||1):10}return i?10:0}}},39838:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionInfluenceByRegionUpdater=t.RegionInfluenceByRegionProjection=void 0,t.createFactionInfluenceDebugLayer=function(e){const t=g.inject.gameStateModel.stateEngine;let i=(0,c.signal)();return t.watchDataSet(d.GameState.ai.regionInfluenceByHex,(()=>{i.fire()})),{onChange:i,getMap:()=>new h.ProxyHexGroupValuation(new u.HexGroupValuationFromStateEngine(t,d.GameState.ai.regionInfluenceByHex),((t,i)=>{if(!t)return;const s=t.get(e);return s?0===s?.resistance?p.GLYPH.whiteFlag:s.resistance:void 0})),getArrows(){let i=[];return t.get(d.GameState.ai.regionInfluenceByHex).forEach(((t,s)=>{const n=t.get(e);n?.children&&n.children?.forEach((e=>{i.push([s,e.id])}))})),i},getDetail(i){const s=(0,o.selectFromState)(t.currentState,d.GameState.ai.regionInfluenceByHex,i.id);if(!s)return"";const n=s.get(e);return n?`${n.resistance?.toString()} -> ${n.children?.map((e=>e.id)).join(",")}`:""}}},t.getGlyphForRegionId=v;const s=i(31011),n=i(56038),o=i(20026),a=i(4005),r=i(56824),l=i(70712),c=(i(45664),i(18957)),d=i(90952),h=i(70582),u=i(98519),p=i(19506),g=i(91622),m=i(88023);r.logger.for("RegionInfluenceByRegionProjection");class y extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new w(this),this.update=this.updater.update}bootstrap(e){return this.updater.initFromState(e),(0,m.ImmutableMap)().withMutations((t=>{for(const i of n.Regions.getAll(e))f(e,i).size>0&&t.set(i,f(e,i))}))}entryToString(e){return e.size?`[${e.size}]`:""}entryToDebugString(e){return e.entrySeq().sort((([e],[t])=>e-t)).map((([e,t])=>`${v(e)}${e}: ${t.total} (proximity ${t.proximity})`)).join("\n")}}function f(e,t){const i=n.Regions.getRegionHexes(e,t);return(0,m.ImmutableMap)().withMutations((s=>{for(const n of i)for(const[i,o]of l.AI.getHexInfluence(e,n))i!==t&&s.update(i,{proximity:1/0,total:0},(e=>({proximity:Math.min(e.proximity,o.resistance),total:e.total+Math.floor(10/o.resistance)})));s.map((e=>({...e,total:Math.floor(e.total)}))).filter((e=>e.total>0))}))}t.RegionInfluenceByRegionProjection=y;class w extends a.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet),this.dirtyRegions=new Set}registerHandlers(e){e(this.dataSet.sources.regionHexes,this.handleRegionBorderChange),e(this.dataSet.sources.regionInfluenceByHex,this.handleHexRegionInfluenceChange)}initialize(){super.initialize(),this.dirtyRegions.clear()}createMutation(){return this.dirtyRegions.forEach((e=>{const t=f(this.newState,e);t.size>0?this.builder.set(e,t):this.builder.delete(e)})),super.createMutation()}handleRegionBorderChange(e){for(let t of e.updated||[]){const e=t.id;this.dirtyRegions.add(e)}}handleHexRegionInfluenceChange(e){for(let[t,i]of e.updated||[]){const e=n.Regions.getByHex(this.newState,t);e&&this.dirtyRegions.add(e)}}}function v(e){const t=g.inject.gameStateModel.factions.byRegion(g.inject.gameStateModel.regions.byId(e));return t?.isAlive()?p.GLYPH.factions[t.themeIndex+1]:p.GLYPH.whiteFlag}t.RegionInfluenceByRegionUpdater=w},39970:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PassiveButtonStateController=void 0;const s=i(18957),n=i(98963),o=i(22663),a=i(54825);t.PassiveButtonStateController=class{constructor(){this.enabled=!0,this.state=o.ButtonState.Rest,this.onClicked=(0,s.signal)(),this.selected=!1}getState(){return this.state}bindTo(e,t){this.applyState=t,e.removeAllListeners(),e.setInteractive({useHandCursor:!0}).on("pointerdown",(e=>{this.enabled?(this.onClicked.fire(e),a.app.audio.playEffect(n.SoundEffects.ButtonDown)):a.app.audio.playEffect(n.SoundEffects.Deny)}))}setSelected(e){this.selected=e,this.state!==o.ButtonState.Hover&&this.enabled&&this.setState(e?o.ButtonState.Down:o.ButtonState.Rest)}setEnabled(e){this.enabled=e,this.setState(e?this.getIdleState():o.ButtonState.Disabled)}setState(e){e!==this.state&&(this.state=e,this.applyState(e))}getIdleState(){return this.selected?o.ButtonState.Down:o.ButtonState.Rest}}},40020:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexDisplayDelegate=t.Hex=t.HEX_CORNER_NEIGHBOURS=t.HEX_CORNER_DIRECTIONS=t.HEX_DIRECTIONS=t.HexCornerDirection=t.HexDirection=void 0,t.neighbourBitmapHasDirection=function(e,t){return!!(e&1<<5-t)},t.isHexOnEvenRow=function(e){return Math.floor(e/n.GRID_MAX_DIMENSION)%2==0};const n=i(45664),o=i(11079),a=i(20693),r=s(i(95608)),l=i(87936),c=i(49796),d=i(47273),h=i(9292),u=2*Math.PI;var p,g;!function(e){e[e.UP_LEFT=0]="UP_LEFT",e[e.UP_RIGHT=1]="UP_RIGHT",e[e.RIGHT=2]="RIGHT",e[e.DOWN_RIGHT=3]="DOWN_RIGHT",e[e.DOWN_LEFT=4]="DOWN_LEFT",e[e.LEFT=5]="LEFT"}(p||(t.HexDirection=p={})),function(e){e[e.UP_LEFT=0]="UP_LEFT",e[e.TOP=1]="TOP",e[e.UP_RIGHT=2]="UP_RIGHT",e[e.DOWN_RIGHT=3]="DOWN_RIGHT",e[e.DOWN=4]="DOWN",e[e.DOWN_LEFT=5]="DOWN_LEFT"}(g||(t.HexCornerDirection=g={})),t.HEX_DIRECTIONS=[0,1,2,3,4,5],t.HEX_CORNER_DIRECTIONS=[0,1,2,3,4,5],t.HEX_CORNER_NEIGHBOURS=[[5,0],[0,1],[1,2],[2,3],[3,4],[4,5]];const m=[-u/3,-u/6,0,u/6,u/3,u/2],y=[[-.5,-1],[.5,-1],[1,0],[.5,1],[-.5,1],[-1,0]],f=[[-.5,-.25],[0,-.5],[.5,-.25],[.5,.25],[0,.5],[-.5,.25]];class w{constructor(e){this.id=e}get tabular(){return void 0===this._tabular&&(this._tabular=(0,o.ordinalToTabular)(this.id)),this._tabular}*[Symbol.iterator](){yield this}get display(){return this._display||(this._display=new v(this)),this._display}get r(){return this.tabular.r}get c(){return this.tabular.c}get x(){return(0,o.tabularToSpatial)(this.tabular).x}get y(){return this.r}get length(){return 1}get members(){return[this]}first(){return this}isAtGridBorder(e){return n.HexGrid.isHexOnGridBorder(this,e)}neighbours(e=e=>!0){return a.HexGroup.from(y.map((e=>n.HexGrid.getHex({x:this.x+e[0],y:this.y+e[1]}))).filter((t=>t&&e(t))))}disjointedNeighbourGroups(e){let i=new r.default,s=t.HEX_DIRECTIONS.map((t=>{const i=this.neighbour(t);return i&&e(i)?i:null}));const n=s.indexOf(null);let o=null;if(-1===n)i.addToGroup(s[0].id,...s);else{for(let e=n+1;e<s.length;++e)a(s[e]);for(let e=0;e<n;++e)a(s[e])}function a(e){null===e?o=null:(o||(o=e.id),i.addToGroup(o,e))}return i}neighboursByCornerDirection(e){const[i,s]=t.HEX_CORNER_NEIGHBOURS[e];return[this.neighbour(i),this.neighbour(s)].filter((e=>e))}neighbour(e){const t=y[e];return n.HexGrid.getHex({x:this.x+t[0],y:this.y+t[1]})}getDirectionTowards(e){let t=e.x-this.x,i=e.y-this.y;const s=(0,h.pickLarger)(Math.abs(t),Math.abs(i));return t/=Math.abs(s),i/=Math.abs(s),1===t?p.RIGHT:-1===t?p.LEFT:1===i?t<0?p.DOWN_LEFT:p.DOWN_RIGHT:t<0?p.UP_LEFT:p.UP_RIGHT}getCorners(){return(0,d.getCornerIdsForHexId)(this.id).map((e=>d.HexCorner.fromId(e)))}getCornerIds(){return(0,d.getCornerIdsForHexId)(this.id)}hasCorner(e){return e.sortedHexes.includes(this)}getAngleTowards(e){return m[this.getDirectionTowards(e)]}bfsFrom(e,t){t(this,void 0,0)}floodFillOut(e=()=>!0){return a.HexGroup.from([this]).floodFillOut(e)}getBoundingBox(){return{x:this.x,y:this.y,width:0,height:0}}findClosest(e,t){return a.HexGroup.from([this]).findClosest(e,t)}findGeometricMedian(){return this}neighboursOf(e){return a.HexGroup.from([this]).neighboursOf(e)}toString(){return`[Hex #${this.id} (${this.x},${this.y})]`}asGroup(){return a.HexGroup.from([this])}toIdsArray(){return this.asGroup().toIdsArray()}toArray(){return this.asGroup().toArray()}has(e){return this.asGroup().has(e)}contains(e){return this.id===e?.id}hasId(e){return this.id===e}border(e=!1){return this.asGroup().border(e)}getDisplayBoundingBox(){return{x:this.display.left,y:this.display.top,width:this.display.width,height:this.display.height}}getHex(){return this}components(e=()=>!0){return this.asGroup().components(e)}with(e){return Array.isArray(e)?a.HexGroup.from([this,...e]):a.HexGroup.from([this,...e.members])}without(e){return this.asGroup().without(e)}filter(e){return this.asGroup().filter(e)}forEach(e){return this.asGroup().forEach(e)}map(e){return this.asGroup().map(e)}find(e){return this.asGroup().find(e)}sort(e){return this.asGroup().sort(e)}findInnerMostHex(){return this}findMax(e){return this}floodFillFrom(e,t){return e}customSearchFrom(e,t,i){return a.HexGroup.from([this]).customSearchFrom(e,t,i)}findNeighbour(e){for(let t of y){const i=n.HexGrid.getHex({x:this.x+t[0],y:this.y+t[1]});if(i&&e(i))return i}}neighboursBitmap(e){let i=0;for(let s of t.HEX_DIRECTIONS){const t=this.neighbour(s);i<<=1,t&&e(t,s)&&++i}return i}disjointedNeighbourGroupsOf(e){return new r.default}getRandomHex(){return this}getDistanceTo(e){const t=Math.abs(this.y-e.y),i=Math.abs(this.x-e.x);return t+(0,h.pickLarger)(0,Math.ceil(i-t/2))}some(e){return e(this)}}t.Hex=w;class v{constructor(e){this.hex=e,this.width=l.HEX_WIDTH,this.height=l.HEX_HEIGHT}get left(){return this.hex.x*l.HEX_WIDTH}get right(){return(this.hex.x+1)*l.HEX_WIDTH}get top(){return this.hex.y*l.HEX_INNER_HEIGHT}get bottom(){return this.hex.y*l.HEX_INNER_HEIGHT+l.HEX_HEIGHT}get centerX(){return this.hex.x*l.HEX_WIDTH+l.HALF_HEX_WIDTH}get centerY(){return this.hex.y*l.HEX_INNER_HEIGHT+l.HALF_HEX_HEIGHT}distanceTo(e){return(0,c.euclidDistance)({x:this.centerX,y:this.centerY},{x:e.display.centerX,y:e.display.centerY})}getCornerPoint(e){return{x:this.centerX+f[e][0]*l.HEX_WIDTH,y:this.centerY+f[e][1]*l.HEX_HEIGHT}}}t.HexDisplayDelegate=v},40021:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RestMapRegistryDataSource=void 0,t.RestMapRegistryDataSource=class{constructor(e){this.urls=e}async fetchContent(){const e=await Promise.all(this.urls.map((e=>fetch(e).then((e=>e.json())).catch((async t=>{throw new Error(`Failed to read map data from ${e}: ${t.message}`)})))));return{levels:e.map((e=>e.levels)).reduce(((e,t)=>({...e,...t})),{}),expeditions:e.map((e=>e.expeditions)).flat().filter((e=>!!e))}}}},40054:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createWorldMapLODManager=function(e){const t=new n.TransitionController(e.scene,{applyValue:t=>{e.coins.setAlpha(t),e.coinStacks.setAlpha(t),o.app.scene.worldMap.overlays.regionSummaryPopup.setAlpha(t)},ease:"ease.sineInOut",duration:100,initialValue:1});return new s.LODManager(e.scene.cameras.main,[{when:e=>e<.9,activate:e=>{t.transitionTo(0)}},{when:e=>e>=.9,activate:e=>{t.transitionTo(1)}},{when:e=>e>=1.5,activate:()=>{e.coinStacks.defaultFrame="coinstack-hd",e.coins.defaultKey="coin-hd";for(let t of e.coinStacks.getChildren())t.setFrame("coinstack-hd");for(let t of e.coins.getChildren())t.setTexture("coin-hd")}},{when:e=>e<1.5,activate:()=>{e.coinStacks.defaultFrame="coinstack",e.coins.defaultKey="coin";for(let t of e.coinStacks.getChildren())t.setFrame("coinstack");for(let t of e.coins.getChildren())t.setTexture("coin")}},{when:e=>e>1.2,activate:()=>{o.app.scene.worldMap.overlays.regionSummaryPopup.summary.setLargeFont(!0),o.app.scene.worldMap.overlays.budgetLabels.setLargeFont(!0)}},{when:e=>e<=1.2,activate:()=>{o.app.scene.worldMap.overlays.budgetLabels.setLargeFont(!1),o.app.scene.worldMap.overlays.regionSummaryPopup.summary.setLargeFont(!1)}}])};const s=i(39631),n=i(7782),o=i(54825)},40244:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createScreens=function(){return{play:new s.PlayScreen,mapEditor:new g.MapEditorScreen,breakpoint:new n.BreakPointScreen,debugHistory:new o.DebugHistoryScreen,title:new a.TitleScreen,victory:new r.VictoryScreen,defeat:new l.DefeatScreen,mapGeneration:new c.MapGenerationScreen,randomMapSelect:new d.RandomMapSelectScreen,overworld:new h.OverworldScreen,expeditions:new u.ExpeditionsScreen,myLibrary:new p.MyLibraryScreen}};const s=i(28304),n=i(79914),o=i(97340),a=i(48694),r=i(2386),l=i(76594),c=i(69894),d=i(34194),h=i(3234),u=i(84954),p=i(67022),g=i(66002)},40294:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefeatConditionsModel=void 0;const s=i(56824),n=i(11599),o=i(19618);s.logger.for("DefeatConditions"),t.DefeatConditionsModel=class{constructor(e){this.data=(e??[]).map(n.getDefeatConditionModel)}test(e,t){return!o.Factions.model(e).localPlayer?.isAlive()||this.data.some((i=>i.test(e,t)))}}},40386:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionEconomyCalculator=void 0;const s=i(56824),n=i(61510),o=i(24598),a=i(97849),r=i(61634),l=i(45664),c=i(63521),d=i(67274),h=i(83109),u=i(78933);s.logger.for("RegionEconomyCalculator"),t.RegionEconomyCalculator=class{constructor(e,t){this.model=e,this.region=t,this.sinks=[],this.builder=new n.CoinTransactionBuilder,this.worldUpdateBuilder=new u.WorldUpdateBuilder(this.model)}run({gatherIncome:e,payUpkeep:t}){this.allRegionHexes=this.region.hexes,this.builder.reset();const i=r.Economy.getTownHexesByRegion(this.model.state,this.region.id).toArray();if(this.townHexes=(0,l.getHexes)(i).members,this.goldByHex={},this.spawnGoldInTreasury(),e&&this.spawnIncome(),t)for(this.assembleSinks();this.sinks.length;){const e=this.sinks[0],t=this.allRegionHexes.findClosest(e.pawn.hex,(e=>(this.goldByHex[e.id]||0)>0));if(!t)break;{const i=this.goldByHex[t.id];i>e.demand?this.sendMoneyToSink(t,0,e.demand):this.sendMoneyToSink(t,0,i)}}Object.entries(this.goldByHex).map((([e,t])=>({hexId:Number(e),remainingIncome:t}))).filter((({hexId:e})=>!i.includes(e))).forEach((({hexId:e,remainingIncome:t})=>{const i=(0,l.getHex)(e),s=this.model.economy.nearestTownHexFrom(i);s&&this.sendMoneyToTown(i,s,t)}));let s=!1;if(this.sinks.length>0){const e=this.model.pawns.select({hexes:this.region.hexes,traits:[c.PawnTraits.Unit]}).filter((e=>!e.hasTrait(c.PawnTraits.Loyal)));s=e.length>0,e.forEach((e=>{this.worldUpdateBuilder.replace(e,this.model.rules.getBanditUnitType())})),0!==this.townHexes.length||this.region.faction?.isNeutral()||(s=!0,this.model.pawns.select({hexes:this.region.hexes,type:[o.PawnType.Castle]}).forEach((e=>{const t=e.hex;this.worldUpdateBuilder.replace(e,this.model.rules.getBanditCampUnitType()),this.worldUpdateBuilder.takeOverHex(t,this.model.factions.byId(d.SpecialFaction.neutral))})))}return this.builder.apply(this.model.state),{regionId:this.region.id,sufferedRebellion:s,coinTransfers:this.builder.getTransactions(),worldUpdates:this.worldUpdateBuilder.getUpdates()}}assembleSinks(){this.model.pawns.select({hexes:this.region.hexes}).filter((e=>e.upkeep&&e.upkeep>0)).forEach((e=>{this.sinks.push({pawn:e,demand:e.upkeep})}))}sendMoneyToSink(e,t,i){const s=this.sinks[t];this.builder.from(e).send(s.pawn.hex,i).consume(),s.demand-=i,this.removeGoldFromHex(e,i),0===s.demand&&this.sinks.splice(t,1)}sendMoneyToTown(e,t,i){this.builder.from(e).send(t,i),this.removeGoldFromHex(e,i),this.addGoldToHex(t,i)}spawnIncome(){0!==this.townHexes.length&&(this.allRegionHexes.forEach((e=>{const t=this.model.economy.incomeFromHex(e.id);t>0&&(this.addGoldToHex(e,t),this.builder.from(e).spawn(t))})),this.evalBanditLooting())}spawnGoldInTreasury(){for(const e of this.townHexes)this.addGoldToHex(e,this.model.economy.numberOfCoinsAt(e)||0)}addGoldToHex(e,t){this.goldByHex[e.id]=(this.goldByHex[e.id]||0)+t}removeGoldFromHex(e,t){(0,a.assert)(this.goldByHex[e.id]>0),this.goldByHex[e.id]=this.goldByHex[e.id]-t,this.goldByHex[e.id]<=0&&delete this.goldByHex[e.id]}evalBanditLooting(){this.model.pawns.select({hexes:this.allRegionHexes,type:[o.PawnType.Bandit]}).map((e=>e.hex)).filter((e=>!this.model.pawns.byHex(e).some((e=>e.type!==o.PawnType.Bandit&&e.hasTrait(c.PawnTraits.NegatesTileIncome))))).forEach((e=>{const t=(0,h.getOrCreateNearestCamp)(this.model.state,e,this.worldUpdateBuilder);t&&this.builder.from(e).spawn(this.model.economy.potentialIncomeFromHex(e)).send(t.hex)}))}}},40894:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AttritionByFactionView=void 0;const s=i(90952),n=i(20754),o=i(70712),a=i(56824),r=i(76439),l=i(29322),c=i(19618),d=i(19506),h=i(9292);a.logger.for("AttritionByFactionView");class u extends n.LazyView{constructor(){super([s.GameState.ai.attritionByRegion,s.GameState.ai.extraAttritionByFaction]),this.name="attritionByFaction"}calculate(e,t){const i={...o.AI.getFactionExtraAttrition(e,t)};return c.Factions.getFactionRegions(e,t).map((t=>{const s=o.AI.getRegionAttrition(e,t);for(const[e,t]of Object.entries(s))i[Number(e)]=(i[Number(e)]||0)+t})),i}getCacheKey(e){return e}getDebugLayer(){return new r.GameStateDebugLayer((0,l.factionBasedAdapter)({getValue:(e,t)=>Object.values(this.get(e,t)).reduce(h.sum,0)+"\n"+Object.entries(this.get(e,t)).map((([e,t])=>`${d.GLYPH.factions[Number(e)]} ${t}`)).join(" "),getDetail:(e,t)=>{}}))}}t.AttritionByFactionView=u},40904:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PowerBalanceRibbon=void 0,t.scaleEntries=d,t.getTooltip=h;const s=i(50154),n=i(56824),o=i(76738),a=i(86545),r=i(91622),l=i(9292);n.logger.for("ui:PowerBalanceRibbon");class c extends a.ResponsiveContainer{constructor(e,t){super(e),this.props=t,this.currentState=[],this.colorBars=[],this.setPosition(t.x,t.y),this.height=o.RibbonTextures.ColorBar.height,this.backgroundBar=new s.ColorBar(this.scene,{x:0,y:0,width:t.width,color:9474192}),this.setSize(t.width,this.backgroundBar.height),this.add([this.backgroundBar])}setDimensions(e,t,i){return this.setPosition(e,t),this.backgroundBar.width=i,this.width=i,r.inject.ui.withoutTransitions((()=>{this.updateState(this.currentState)})),this}updateState(e){this.currentState=e;const t=d(e,this.width,this.props.minSize);let i=0;for(let n=0;n<t.length;++n){const o=t[n].size+(n===t.length-1?0:2);this.colorBars[n]?(this.colorBars[n].adjustSize.transitionTo(o),this.colorBars[n].adjustX.transitionTo(i),this.colorBars[n].adjustY.transitionTo(t[n].highlight?-2:0)):(this.colorBars[n]=new s.ColorBar(this.scene,{x:i,y:0,width:o}),this.colorBars[n].adjustY.setTo(t[n].highlight?-2:0),this.colorBars[n].adjustX.setTo(i),this.colorBars[n].adjustSize.setTo(o),this.colorBars[n].setInteractive(),this.add(this.colorBars[n]),this.colorBars[n].setVisible(!0)),this.colorBars[n].setTint(t[n].color),this.colorBars[n].setData("tooltip",h(e[n])),i+=t[n].size}this.colorBars.slice(t.length).map((e=>{e.destroy()})),this.colorBars.splice(t.length),this.preUpdate.makeDirty()}}function d(e,t,i){if(0===e.length)return e;const s=t/e.reduce(((e,t)=>e+t.size),0);let n=e.map((e=>({...e,size:Math.floor(e.size*s)})));const o=n.filter((e=>e.size<i)),a=n.filter((e=>e.size>i));if(o.length&&a.length){const e=o.map((e=>i-e.size)).reduce(l.sum,0)/a.reduce(((e,t)=>e+t.size),0);a.forEach((t=>{t.size=Math.floor(t.size-t.size*e)})),o.forEach((e=>e.size=i))}let r=t-n.reduce(((e,t)=>e+t.size),0);for(let e=0;r>0&&a.length>0;r--,e++)a[e%a.length].size+=1;return n}function h(e){return`${t=r.inject.gameStateModel.factions.byId(e.id),t?t.isLocalPlayer()?"You control":`${t.name} controls`:"Faction controls"} ${e.size} tiles`;var t}t.PowerBalanceRibbon=c},40951:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.TransitionsSpeed=t.TIMING=void 0,t.TIMING={pawnPickupTransition:100,pawnDropTransition:100,pawnJumpDuration:500,tutorialArrowJumpDuration:300,defenseMarkersShowDuration:300,defenseMarkersHideDuration:100,longPressDuration:800},function(e){e[e.Normal=600]="Normal",e[e.Fast=300]="Fast",e[e.Instant=0]="Instant"}(i||(t.TransitionsSpeed=i={}))},41040:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColorBox=void 0;const s=i(61727);class n extends s.GraphicsContainer{constructor(e,t){super(e),this.props=t}setTint(e){return this}clearTint(){return this}setColor(e,t=1){return this.props.fillColor={color:e,alpha:t},this.preUpdate.makeDirty(),this}render(e,t){this.props.fillColor&&(this.fillStyle(this.props.fillColor.color,this.props.fillColor.alpha),this.fillRoundedRect(0,0,e,t,this.props.radius??8)),this.props.lineColor&&(this.lineStyle(1,this.props.lineColor.color,this.props.lineColor.alpha),this.strokeRoundedRect(0,0,e,t,this.props.radius??8))}}t.ColorBox=n},41229:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KineticValue=t.KineticValuePhase=void 0;const s=i(56824),n=i(9292),o=s.logger.for("KineticValue");var a;!function(e){e.Frozen="frozen",e.Sliding="sliding",e.Tweening="tweening",e.Stable="stable"}(a||(t.KineticValuePhase=a={})),t.KineticValue=class{constructor(e,t){this.value=e,this._speed=0,this.phase=a.Stable,this.continueToNextStopThreshold=100,this.ignoreBounds=!1,this.min=Number.NEGATIVE_INFINITY,this.max=Number.POSITIVE_INFINITY,this.maxSpeed=99999,this.latestAccelerationTimestamp=0,this.drag=t.drag,this.name=t.name??"?",void 0!==t.min&&(this.min=t.min),void 0!==t.max&&(this.max=t.max),void 0!==t.maxSpeed&&(this.maxSpeed=t.maxSpeed),t.continueToNextStopThreshold&&(this.continueToNextStopThreshold=t.continueToNextStopThreshold),void 0!==t.allowancePastLastStop&&(this.allowancePastLastStop=t.allowancePastLastStop),this.stops=Array.isArray(t.stops)?new r(t.stops):t.stops,this.apply=t.apply,this.scene=t.scene,this.apply(this.value)}accelerate(e){this.phase!==a.Frozen&&0!==e&&(this.cancelSnap(),this.phase=a.Sliding,this._speed+=e,this.latestAccelerationTimestamp=Date.now())}get speed(){return this._speed}cancelSnap(){this.tween&&(this.tween.stop(),this.tween=void 0),this.targetStop=void 0,this.phase===a.Tweening&&(this.phase=a.Sliding)}freeze(){this.phase=a.Frozen,this.debug("frozen"),this.targetStop=void 0}unfreeze(){this.phase===a.Frozen&&(this.phase=a.Sliding,this.debug("unfrozen"),this._speed=0)}debug(...e){}pushToNextStop(){if(this.cancelSnap(),this.unfreeze(),this.targetStop=this.stops?.getNextFrom(this.value+.001),void 0!==this.targetStop){const e=c(this.value,this.targetStop,this.drag);this.accelerate(e)}}pushToPrevStop(){if(this.cancelSnap(),this.unfreeze(),this.targetStop=this.stops?.getPreviousFrom(this.value-.001),void 0!==this.targetStop){const e=c(this.value,this.targetStop,this.drag);this.accelerate(e)}}pushTo(e){this.cancelSnap(),this.unfreeze();const t=c(this.value,e,this.drag);this.accelerate(t)}update(e,t){const i=t/1e3,s=this.drag*i,o=Date.now()-this.latestAccelerationTimestamp<10;switch(this.phase){case a.Tweening:return this.value=this.tween.getValue(),void this.apply(this.value);case a.Stable:case a.Frozen:return;case a.Sliding:if(this.stops&&!o&&(void 0===this.targetStop&&(this.targetStop=function(e,t,i,s,n){const o=n.getPreviousFrom(e-.001),a=n.getNextFrom(e+.001);let r=d(n,e);const c=function(e,t,i){const s=t>0?1:-1,n=Math.abs(t)-0,o=e+n*n/(2*i)*s;return o!==l&&(l=o),o}(e,t,s);if(Math.abs(t)>i){const e=d(n,c);r=t>0?e===r&&a||e:e===r&&o||e}return r}(this.value,this._speed,this.continueToNextStopThreshold,this.drag,this.stops),void 0!==this.targetStop&&this.debug("new target stop: %s (current distance: %s)",this.targetStop,Math.abs(this.targetStop)-Math.abs(this.value))),void 0!==this.targetStop)){const e=c(this.value,this.targetStop,this.drag);if(this._speed||this.targetStop!==this.value)if(this.debug(`speed ${this._speed.toFixed(0)} >> ${e.toFixed(0)}`),this._speed<e){const t=e-this._speed;this._speed+=(0,n.pickSmaller)(t,this.drag*i*2)}else if(this._speed>e){const t=this._speed-e;this._speed-=(0,n.pickSmaller)(t,this.drag*i*2)}}o||(this._speed>0?(this.debug(`drag: ${s}`),this._speed-=(0,n.pickSmaller)(this._speed,s)):this._speed<0&&(this._speed+=(0,n.pickSmaller)(-this._speed,s))),!o&&Math.abs(this._speed)<.001&&(void 0===this.targetStop||Math.abs(this.value-this.targetStop)<1)?(this.phase=a.Stable,this.debug(`stopped at %s (speed=${this._speed})`,this.value.toFixed(0)),this._speed=0,this.targetStop&&(this.value=this.targetStop)):this.value+=this._speed*i,this.applyHardLimits(),this.apply(this.value)}}async tweenTo(e,t,i){return this.cancelSnap(),this.phase=a.Tweening,new Promise((s=>{this.tween=this.scene.tweens.addCounter({from:this.value,to:e,duration:t,ease:i,onComplete:()=>{this.apply(e),this.phase=a.Stable,this.tween=void 0,this.ignoreBounds=!1,s()},onStop:()=>{s()}})}))}applyHardLimits(){if(this.value<this.min&&!this.ignoreBounds&&(o.warning(`value clamped to hard minimum ${this.min}`),this.value=this.min),this.value>this.max&&!this.ignoreBounds&&(this.debug(`value clamped to hard maximum ${this.max}`),this.value=this.max),this.stops&&void 0!==this.allowancePastLastStop){const e=this.stops.getPreviousFrom(this.value),t=this.stops.getNextFrom(this.value);this.debug(`[${e}] (we are here) [${t}]`),(void 0===e||e>=this.value)&&void 0!==t&&(this.value=(0,n.pickLarger)(this.value,t-this.allowancePastLastStop)),(void 0===t||t<=this.value)&&void 0!==e&&(this.value=(0,n.pickSmaller)(this.value,e+this.allowancePastLastStop))}this._speed>this.maxSpeed?(this.debug(`exceeded max speed ${this.maxSpeed}`),this._speed=this.maxSpeed):this._speed<-this.maxSpeed&&(this.debug(`exceeded max speed -${this.maxSpeed}`),this._speed=-this.maxSpeed)}accelerateTo(e,t=100){let i=e-this._speed;i>t&&(i=t),i<-t&&(i=-t),this.accelerate(i)}setTo(e){this.cancelSnap(),this.debug("setTo",e,"ignoreBounds=",this.ignoreBounds),this._speed=0,this.value=e,this.ignoreBounds||this.applyHardLimits(),this.apply(e),this.ignoreBounds=!1}};class r{constructor(e){this.stops=e}getNextFrom(e){if(0!==this.stops.length)return this.stops.find((t=>t>=e))}getPreviousFrom(e){if(0!==this.stops.length)return this.stops.slice().reverse().find((t=>t<=e))}}let l=0;function c(e,t,i){const s=Math.abs(e-t),n=e>t?-1:1;return Math.sqrt(2*s*i)*n}function d(e,t){const i=e.getPreviousFrom(t),s=e.getNextFrom(t);return void 0===i?s:void 0===s?i:Math.abs(t-i)>Math.abs(t-s)?s:i}},41331:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createSelectBox=function(e,t){return e.selectBox({theme:"islandCard",selectedItem:t.selectedItem,width:150,height:32,options:t.options,onSelected:t.onSelected})},t.createToggle=function(e,t){return new s.Toggle(e.scene,{height:32,width:150,enabled:!0,theme:s.ToggleThemes.onCard,...t})};const s=i(36014)},41569:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseMode=void 0;const s=i(56824),n=i(98963),o=i(36868),a=i(77973),r=i(28681),l=i(50105),c=i(16079),d=i(7334),h=i(54825),u=i(19618),p=i(97849),g=i(52031),m=s.logger.for("BaseMode");t.BaseMode=class{isActive(){return this.scene.scene.isActive()&&this._active}constructor(e){this.scene=e,this.observe=new g.Observer((()=>this.isActive())),this._active=!1}isReadyForMoreGameEvents(){return!this.isProcessingEvents}canPickupPawn(e){return!1}canDropPawn(e){return!1}canEndTurn(){return!1}canSwitchRegion(){return!0}isHexInteractive(e){return!1}canReturnPawn(){return!1}handleReturnPawn(){m.warning(`returnPawn not available in ${this.name}`)}handleStartInteraction(e,t){}handleCompleteInteraction(e,t){}handleStartDrag(e){}handleEndDrag(e){}handleSkipSpectating(){m.warning(`skipSpectating not available in ${this.name}`)}handleShopAreaPointerUp(){h.app.audio.playEffect(n.SoundEffects.Deny)}handlePawnInShopPointerUp(e){}handlePawnInShopPointerDown(e){}activate(){this._active=!0}deactivate(){this._active=!1}handleNewHexUnderCursor(e){}handleEndTurn(){}async handleNewGameEventsAvailable(){if(this.isProcessingEvents)return!1;this.isProcessingEvents=!0,await this.processEvents(this.scene.cursor),this.isProcessingEvents=!1}async processEvents(e){for(;e.hasNext();){const t=e.consumeNextPlay();if(!t)return;for(let e of t)await this.playEvent(e)}}async playEvent(e){await(0,d.withTimeout)(this.scene,this.doHandleEvent(e),3e3)===d.TIMEOUT&&this.isProcessingEvents&&this.handleSkipSpectating()}async handlePawnBought(e){await(0,a.handlePawnBought)(this.scene,e)}async handleFactionEconomyUpdated(e){await(0,r.handleFactionEconomyUpdated)(this.scene,e)}async handleHexCaptured(e){await(0,l.handleHexCaptured)(this.scene,e)}async handlePawnMoved(e){await(0,c.handlePawnMoved)(this.scene,e)}async handleCutOffUnitsTurnedBandits(e){await h.app.scene.worldMap.play(e.worldUpdates)}handleAbort(){s.events.trigger(o.UserActions.GoBack())}handleCreditChange(e){h.app.scene.worldMap.overlays.attitudeEmojis.playCreditChange(e)}handleFactionTurnOver(e){const t=u.Factions.model(e.state).byId(e.factionId);p.assert.defined(t),h.app.scene.worldMap.syncTownVariantInRegions(e.state,t.getRegions())}}},41655:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionsBoundingBoxProjection=void 0;const s=i(95226),n=i(20026),o=i(20693),a=i(45664);class r extends s.SingletonDataSet{constructor(e,t){super(e,null),this.key=e,this.regionsByHex=t,this.parents=[this.regionsByHex]}bootstrap(e){return o.HexGroup.fromIds(this.regionsByHex.getEntryIds(e)).getBoundingBox()}update(e,t,i){const s=(0,n.selectFromState)(i,this);if(null===s)return this.createMutation(this.bootstrap(i),"regions.byHex");const o=t.of(this.regionsByHex);let r={...s},l=!1,c=!1;if(o)for(const[e,t]of o.updated){const i=(0,a.getHex)(e);if(void 0===t){if(i.x===r.x||i.x===r.x+r.width-1||i.y===r.y||i.y===r.y+r.height-1){l=!0;break}}else i.x<r.x&&(r.width=r.width+(r.x-i.x),r.x=i.x,c=!0),i.x>r.x+r.width&&(r.width=i.x-r.x,c=!0),i.y<r.y&&(r.height=r.height+(r.y-i.y),r.y=i.y,c=!0),i.y>r.y+r.height&&(r.height=i.y-r.y,c=!0)}return l?this.createMutation(this.bootstrap(e),"regions.byHex (recalculated)"):c?this.createMutation(r,"regions.byHex (updated)"):void 0}}t.RegionsBoundingBoxProjection=r},41671:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EditorSession=void 0;const s=i(56824),n=i(35800),o=i(85026),a=i(59956),r=i(91622),l=i(20026),c=i(2543),d=i(45664),h=i(88823),u=i(71021),p=i(75136),g=i(90952),m=i(72273),y=i(96704),f=i(18811),w=i(21473);function v(e){const t=d.GRID_MAX_DIMENSION-e.map.width,i=d.GRID_MAX_DIMENSION-e.map.height;return e.map.width+=t,e.map.height+=i,console.log("Maximizing map size to",e.map.width,e.map.height,t,i),(0,h.shiftMap)(e,Math.floor(t/2),Math.floor(i/2))}function b(e){const t=h.LINT_RULES.NoExtraSpace(e,{fix:!0});return t?t.fix():e}function S(e,t,i){return{gameState:(0,o.encodeGameState)(b((0,y.compressGameState)(e))),created:Date.now(),bestReplay:void 0,type:t,label:i}}s.logger.for("EditorSession"),t.EditorSession=class{constructor(){this.state=null,this._stateEngine=new p.StateEngine,this._latestSnapshotState=null,this._playTestingSnapshot=null,this._stateEngine.add(g.GameState.ruleSet,g.GameState.map,g.GameState.version,g.GameState.ai.hexHistory,g.GameState.ai.attritionByRegion,g.GameState.ai.extraAttritionByFaction,g.GameState.ai.credit,...m.ProjectionPresets.coreEntitiesAndSystems),this._stateEngine.activateAllProjections()}isActive(){return!!this.state}begin(e){if((0,l.isImmutableState)(e)){this.state={snapshots:[]};const t=S(e,"manual");this.loadSnapshot(t)}else{this.state=e;const t=this.getLatestSnapshot();t&&("autosave-on-exit"===t.type&&this.deleteSnapshot(t),this.loadSnapshot(t))}}hasUnsavedChanges(){if(!this.state)throw Error("Editor session is not active");return!this._latestSnapshotState||r.inject.currentGameState!==this._latestSnapshotState.gameState}beginPlayTest(e){this._playTestingSnapshot=e}savePlayTestResult(e){if(this._playTestingSnapshot){if(e===f.LevelOutcome.Victory){const t=w.ReplayModel.for(r.inject.gameStateController.history.export({snapshotPolicy:["initial","p1-start","final"],includeRewinds:!1,sizeLimit:1e4,remainingLives:r.inject.levelSession.remainingLives})),i=this._playTestingSnapshot.bestReplay&&(0,o.decodeReplay)(this._playTestingSnapshot.bestReplay.data);!i||t.isBetterResultThen(i)?this._playTestingSnapshot.bestReplay=t.exportWithMetadata(e):console.log("Play test result is not better than existing best replay, not saving")}}else s.errors.handleNonFatalError("endPlayTest called without a play test session","EditorSession.endPlayTest")}endPlayTest(){this._playTestingSnapshot=null}createSnapshot(e,t,i){if(!this.state)throw Error("Editor session is not active");const s=S(e,t,i);this.state.snapshots.unshift(s),this._latestSnapshotState={snapshot:s,gameState:r.inject.currentGameState}}moveSnapshotToTop(e){if(!this.state)throw Error("Editor session is not active");const t=this.state.snapshots.indexOf(e);-1===t&&s.errors.handleNonFatalError("Tried to move snapshot that does not exist","EditorSession.moveSnapshotToTop"),this.state.snapshots.splice(t,1),this.state.snapshots.unshift(e)}loadSnapshot(e){const t=v((0,o.decodeGameState)(e.gameState));r.inject.gameStateController.loadState(t,u.NewGameStateContext.LoadingGame),e===this.getLatestSnapshot()?this._latestSnapshotState={snapshot:e,gameState:r.inject.currentGameState}:this._latestSnapshotState=null}getAllSnapshots(){if(!this.state)throw Error("Editor session is not active");return this.state.snapshots}getUserContentId(){if(!this.state)throw Error("Editor session is not active");return this.state.userContentId}getSnapshotPreview(e){const t=v((0,o.decodeGameState)(e.gameState));return this._stateEngine.deserialize((0,y.decompressGameState)(t)),this._stateEngine.currentState}loadLatestSnapshot(){if(!this.state)throw Error("Editor session is not active");if(0===this.state.snapshots.length)throw Error("No snapshots available to load");this.loadSnapshot(this.getLatestSnapshot())}getLatestSnapshot(){if(!this.state)throw Error("Editor session is not active");return this.state.snapshots[0]}deleteSnapshot(e){if(!this.state)throw Error("Editor session is not active");this.state.snapshots=(0,c.without)(this.state.snapshots,e),this._latestSnapshotState?.snapshot===e&&(this._latestSnapshotState=null)}getMyIslandDBRecord(){if(!this.state)throw Error("Editor session is not active");const e=a.WorldMap.get(r.inject.currentGameState),t=[...this.state.snapshots];return this.hasUnsavedChanges()&&t.unshift(S(r.inject.currentGameState,"autosave-on-exit")),this.state.userContentId||(this.state.userContentId=s.random.id(n.ID_TYPE.UserContent)),{id:this.state.userContentId,levelId:e.levelId,title:e.name??"Unnamed Island",author:e.author,lastInteraction:Date.now(),created:e.created??Date.now(),snapshots:t,type:"my-island"}}end(){this.state=null}}},41815:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasLocalStorage=function(){try{return window.localStorage.getItem("test"),!0}catch(e){return!1}}},41856:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AutoHeightComponent=void 0;const s=i(93785);class n{constructor(e){this.parent=e,this._width=0,this._height=0,this.initialHeightSet=!1}get height(){return this._height}set width(e){this._width!==e&&(this._width=e,this.parent.preUpdate.force())}get width(){return this._width}updateSize(){const e=this.parent.calculateHeight();e!==this._height&&(this._height=e,this.initialHeightSet?this.parent.parentContainer?(0,s.handlesAutoSizeChildren)(this.parent.parentContainer)&&this.parent.parentContainer.handleChildResize(this.parent):(0,s.handlesAutoSizeChildren)(this.parent.scene)&&this.parent.scene.handleChildResize(this.parent):this.initialHeightSet=!0)}static overrideSizeComponent(e){const t=new n(e);Object.defineProperties(e,{width:{set:e=>{t.width=e},get:()=>t.width},height:{get:()=>t.height},updateSize:{value:t.updateSize.bind(t)}})}}t.AutoHeightComponent=n},42067:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LARGE_PLAY_UI_LAYOUT=void 0;const s=i(27700);t.LARGE_PLAY_UI_LAYOUT={regionPanel:{width:354,height:300,collapsedOffsetFromBottom:52,expandedOffsetFromBottom:96,nextRegionButtonOffsetFromTop:42},spectatorPanel:{width:418,height:300,collapsedOffsetFromBottom:26,expandedOffsetFromBottom:70,padding:10,centerLineOffsetFromTop:34},shoppingTray:{pawnsVerticalOffset:46,pawnsSpacing:60,narrowPawnsSpacing:48,width:354,height:45,style:s.ShoppingTrayStyle.Elaborate,openOffsetFromBottom:154,closedOffsetFromBottom:-20,panelTransitionsDuration:500,clothHorizontalPadding:5,clothOffsetTop:25},primaryButtons:{offsetFromMainPanel:12,playModeOffsetFromBottom:6,width:142},rollbackPanel:{transitionDuration:200},rewindControls:{buttonsOffsetFromEdge:6,buttonsSpacing:6,guidePromptOffsetFromBottom:50,labelWidth:180},panelTransitionsDuration:500}},42231:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldNews=t.NewsEvents=void 0;const s=i(39420),n=i(36868),o=i(19618),a=i(56038),r=i(81434),l=i(24598),c=i(45664),d=i(56824),h=i(78933),u=i(97849),p=i(63521),g=i(20693),m=i(2297),y=i(5116),f=i(57189);var w;!function(e){e.Rebellion="rebellion",e.TownRazed="town-razed",e.StrandedUnitTurnedBandit="stranded-unit-turned-bandit",e.UnpaidUnitTurnedBandit="unpaid-unit-turned-bandit",e.CastleTurnedBanditCamp="unit-turned-bandit-camp",e.UnitKilled="unit-killed",e.BanditCampSpawned="bandit-camp-spawned",e.HexLost="hex-lost",e.GoldMineOccupied="gold-mine-occupied",e.UnitInfected="unit-infected",e.OurTownInfected="our-town-infected",e.ForeignTownInfected="foreign-town-infected",e.StrandedUnitTurnedZombie="stranded-unit-turned-zombie",e.UnpaidUnitTurnedZombie="unpaid-unit-turned-zombie",e.CastleTurnedHauntedTown="castle-turned-haunted-town"}(w||(t.NewsEvents=w={}));const v={[w.HexLost]:{symbol:y.PawnSymbolType.Warning,message:()=>"They took our land!"},[w.UnitKilled]:{symbol:y.PawnSymbolType.Warning,message:e=>`They killed our ${e??"unit"}!`},[w.TownRazed]:{symbol:y.PawnSymbolType.Alert,message:()=>"They razed our town!"},[w.BanditCampSpawned]:{symbol:y.PawnSymbolType.Warning,message:()=>"Bandits have built a camp here!"},[w.StrandedUnitTurnedBandit]:{symbol:y.PawnSymbolType.Warning,message:e=>`Our stranded ${e??"unit"} became a bandit!`},[w.UnpaidUnitTurnedBandit]:{symbol:y.PawnSymbolType.Warning,message:e=>`Our unpaid ${e??"unit"} became a bandit!`},[w.CastleTurnedBanditCamp]:{symbol:y.PawnSymbolType.Alert,message:()=>"Our abandoned castle turned into a bandit camp!"},[w.Rebellion]:{symbol:y.PawnSymbolType.Alert,message:()=>"Disaster! We did not have enough coins to pay our army!\nOur treacherous soldiers rebelled!"},[w.OurTownInfected]:{symbol:y.PawnSymbolType.Alert,message:()=>"Our town was overrun by zombies!"},[w.ForeignTownInfected]:{symbol:y.PawnSymbolType.Warning,message:()=>"Town was overrun by zombies!"},[w.UnitInfected]:{symbol:y.PawnSymbolType.Warning,message:e=>`Our ${e??"unit"} turned into a zombie!`},[w.StrandedUnitTurnedZombie]:{symbol:y.PawnSymbolType.Warning,message:e=>`Our stranded ${e??"unit"} became a zombie!`},[w.UnpaidUnitTurnedZombie]:{symbol:y.PawnSymbolType.Warning,message:e=>`Our unpaid ${e??"unit"} became a zombie!`},[w.CastleTurnedHauntedTown]:{symbol:y.PawnSymbolType.Alert,message:()=>"Our abandoned castle turned into a haunted town!"},[w.GoldMineOccupied]:{symbol:y.PawnSymbolType.Alert,message:()=>"Our occupied gold mine produced no income!"}},b=d.logger.for("WorldNews");t.WorldNews=class{constructor(){this.feed=(0,s.createTypedEventHandler)(),this.news=[],this.feed.on(n.GameStateEvents.CutOffUnitsTurnedBandits,(e=>{const t=r.Pawns.model(e.stateBefore);for(const i of e.worldUpdates.updates)i.type===h.UpdateType.PawnReplaced&&t.byId(i.oldPawnId)?.faction?.isLocalPlayer()&&(i.newType===l.PawnType.Bandit?this.addNewsItem(i.hexId,w.StrandedUnitTurnedBandit,i.oldType):i.newType===l.PawnType.Camp?i.oldType===l.PawnType.Castle?this.addNewsItem(i.hexId,w.CastleTurnedBanditCamp,i.oldType):this.addNewsItem(i.hexId,w.StrandedUnitTurnedBandit,i.oldType):i.newType===l.PawnType.Zombie?this.addNewsItem(i.hexId,w.StrandedUnitTurnedZombie,i.oldType):i.newType===l.PawnType.HauntedTown&&(i.oldType===l.PawnType.Castle?this.addNewsItem(i.hexId,w.CastleTurnedHauntedTown,i.oldType):this.addNewsItem(i.hexId,w.StrandedUnitTurnedZombie,i.oldType)))})),this.feed.on(n.GameStateEvents.FactionEconomyUpdated,(e=>{if(!o.Factions.model(e.stateAfter).byId(e.factionId)?.isLocalPlayer())return;const t=a.Regions.model(e.stateAfter);for(let i of e.regionReports){const s=t.byId(i.regionId);if(s){if(i.worldUpdates.updates.forEach((e=>{e.type===h.UpdateType.PawnsMoved&&e.pawns[0]?.created?.pawnType===l.PawnType.Camp?this.addNewsItem(e.destHex,w.BanditCampSpawned):e.type!==h.UpdateType.PawnReplaced||e.newType!==l.PawnType.Camp&&e.newType!==l.PawnType.HauntedTown||e.oldType!==l.PawnType.Castle||this.addNewsItem(e.hexId,w.CastleTurnedBanditCamp,e.oldType),e.type!==h.UpdateType.PawnReplaced||e.newType!==l.PawnType.Bandit&&e.newType!==l.PawnType.Zombie||(s.isAlive()?this.addNewsItem(e.hexId,w.UnpaidUnitTurnedBandit,e.oldType):this.addNewsItem(e.hexId,w.StrandedUnitTurnedBandit,e.oldType))})),i.sufferedRebellion)for(let e of s.getTownHexes().toArray())this.addNewsItem(e.id,w.Rebellion);for(const t of s.getPawns().filter((e=>e.type===l.PawnType.GoldMine)))r.Pawns.isTraitPresentOnHex(e.stateAfter,t.hex.id,p.PawnTraits.NegatesTileIncome)&&this.addNewsItem(t.hex.id,w.GoldMineOccupied)}}})),this.feed.on(n.GameStateEvents.HexCaptured,(e=>{if(!e.victimFactionId||!o.Factions.model(e.worldUpdates.stateAfter).byId(e.victimFactionId)?.isLocalPlayer()||!a.Regions.model(e.worldUpdates.stateBefore).byId(e.victimRegionId)?.isAlive())return;const t=e.worldUpdates.updates.find((e=>e.type===h.UpdateType.PawnsMoved)).hexCaptured;let i;u.assert.defined(t),e.defeatedUnit&&!e.defeatedUnit.retreatHex&&(i=r.Pawns.model(e.worldUpdates.stateBefore).byId(e.defeatedUnit.pawnId)),i?.type===l.PawnType.Town?this.addNewsItem(e.capturedHexId,w.TownRazed):i&&!i?.hasTrait(p.PawnTraits.Pest)?this.addNewsItem(e.capturedHexId,w.UnitKilled,i.type):this.addNewsItem(e.capturedHexId,w.HexLost)})),this.feed.on(n.GameStateEvents.ZombiesActed,(e=>{e.worldUpdates.updates.forEach((t=>{if(t.type===h.UpdateType.PawnsMoved){const i=o.Factions.model(e.worldUpdates.stateBefore).byHex((0,c.getHex)(t.destHex));if(t.merged?.outputType===l.PawnType.HauntedTown)i?.isLocalPlayer()?this.addNewsItem(t.destHex,w.OurTownInfected):this.addNewsItem(t.destHex,w.ForeignTownInfected);else if(t.merged?.outputType===l.PawnType.Zombie&&i?.isLocalPlayer()){const i=r.Pawns.model(e.worldUpdates.stateBefore).byId(t.merged.mergedWith);this.addNewsItem(t.destHex,w.UnitInfected,i?.type)}for(const e of t.pawns.filter((e=>!e.created&&e.srcHex)).map((e=>e.srcHex)))this.hasNewsForHex((0,c.getHex)(e))&&this.updateNewsHex(e,t.destHex)}}))}))}updateNewsHex(e,t){const i=this.news.find((t=>t.hexId===e));i?i.hexId=t:b.warning(`Invalid attempt to update news from hex ${e} to ${t}. No news found for ${e}`)}addNewsItem(e,t,i){this.news.push({hexId:e,type:t,context:i})}handle(e){this.feed.handle(e)}getSymbols(){const e=new Set,t=new Set;for(let i of this.news)switch(v[i.type].symbol){case y.PawnSymbolType.Warning:e.add((0,c.getHex)(i.hexId));break;case y.PawnSymbolType.Alert:t.add((0,c.getHex)(i.hexId))}return[{hexes:g.HexGroup.from(e),options:y.PawnSymbolType.Warning},{hexes:g.HexGroup.from(t),options:y.PawnSymbolType.Alert}]}clear(){this.news=[]}getTooltip(e){const t=this.news.find((t=>t.hexId===e.id));if(t)return{type:m.TooltipType.Hover,title:v[t.type].message(t.context),icon:(0,f.getFrameForPawnSymbol)(v[t.type].symbol),enforceDelay:!1}}clearNewsOnHex(e){this.news=this.news.filter((t=>t.hexId!==e))}hasNewsForHex(e){return this.news.some((t=>t.hexId===e.id))}}},42383:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StorybookMenuScene=t.MENU_WIDTH=void 0;const s=i(30948),n=i(81700),o=i(12605),a=i(60882),r=i(56824),l=i(46099),c=i(897),d=i(93868),h=i(54825),u=i(91622),p=i(83544),g=i(80959);t.MENU_WIDTH=300;class m extends d.BaseBoundsProvider{get width(){return t.MENU_WIDTH}get height(){return h.app.device.screenHeight}}class y extends s.BaseUIScene{constructor(){super({key:n.Scenes.StorybookMenu,bounds:new m}),this.preUpdate=(0,c.whenDirty)((()=>{this.listView.setPosition(20,20),this.listView.setSize(this.bounds.width-40,this.bounds.height-40),this.listView.updateLayout()}))}create(){super.create();const e=g.UiBuilder.for(this);this.selectedStory=new p.PersistentString("storybook.selectedIndex",""),this.scrollController=(0,o.makeSceneScrollable)(this),this.listView=e.simpleListView({mapper:e=>e.name}),this.addAll([this.listView]),this.listView.setItems(a.STORIES),this.listView.onItemSelected((({item:e})=>{this.selectedStory.put(e.name),r.events.trigger(l.StorybookEvents.SelectStory(e))}));const t=a.STORIES.find((e=>e.name===this.selectedStory.read()));t&&this.listView.setSelection(t),u.inject.theme.use((e=>{this.cameras.main.setBackgroundColor(e.oceanShades.dark1)}))}get contentHeight(){return this.listView.height}}t.StorybookMenuScene=y},42415:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SpectatingOverlayMode=void 0;const s=i(20693),n=i(56038),o=i(61634),a=i(96137),r=i(25862),l=i(58440);t.SpectatingOverlayMode=class{constructor(e){this.type="spectating",this.highlightRegions=e.highlightRegions??[],this.highlightHexes=e.highlightHexes??s.HexGroup.empty}update(e,t){this.gameState=t;const i=this.getHighlightColor();this.updateRegionHighlight(e,i),this.updateTownBacklight(e,i),e.conquerableHexesHighlight.set(this.highlightHexes,i),e.townStatusFlags.clear(),e.pawnSymbols.clearAll(),e.newsAlerts.clear(),(0,r.updateBankrupcySymbols)(this.gameState,e.pawnSymbols),(0,r.updateAttitudeEmojis)(this.gameState,e.attitudeEmojis),e.hexMarkers.clear(),e.hexMarkers.clearHoveredHex(),e.regionSummaryPopup.hide(),(0,l.updateBudgetOverlay)(this.gameState,e)}updateRegionHighlight(e,t){const i=s.HexGroup.fromIds(this.highlightRegions.flatMap((e=>n.Regions.getRegionHexes(this.gameState,e).toArray())));e.selectedRegionHighlight.setHexes(i,t)}updateTownBacklight(e,t){const i=s.HexGroup.fromIds(this.highlightRegions.flatMap((e=>o.Economy.getTownHexesByRegion(this.gameState,e).toArray())));e.pawnBacklight.set(i,{color:t})}getHighlightColor(){if(!this.highlightRegions.length)return a.Colors.highlight.ownedRegion;const e=n.Regions.model(this.gameState).byId(this.highlightRegions[0]);return e&&e.exists?e.faction?.isLocalPlayer()?a.Colors.highlight.friendlyRegion:a.Colors.highlight.hostileRegion:a.Colors.highlight.ownedRegion}toString(){return`[SpectatingOverlay (regions=[${this.highlightRegions.join(",")}], hexes=[${this.highlightHexes.toString()}]`}}},42824:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playHexCaptured=async function(e,t,i){const d=i,h=s.Regions.model(d),u=c(t,i),p=(0,n.getHex)(t.conqueredHex).with(t.connectedHexes.map((e=>(0,n.getHex)(e)))).with(a.HexGroup.union(u.map((e=>h.byId(e)?.hexes||a.HexGroup.empty))));e.chunkedRenderer.sync((0,r.syncRequest)(d,p)),e.tileObjects.setTile((0,n.getHex)(t.conqueredHex),o.Factions.model(d).byId(t.newFactionId));const g=h.byId(t.newRegionId)?.hexes.find((e=>e.id!==t.conqueredHex)),m=e.overlays.selectedRegionHighlight;t.newFactionId===o.Factions.model(i).localPlayer?.id&&t.affectedRegions.map((e=>h.byId(e))).forEach((e=>{(0,l.setPawnsJumpingInRegion)(e,e.isAlive()&&!!e.faction?.isLocalPlayer())})),m.selectedRegion&&t.affectedRegions.includes(m.selectedRegion.id)?m.refresh():g&&m.includesHex(g)&&m.add((0,n.getHex)(t.conqueredHex))},t.getFreshlyDeadRegionIds=c;const s=i(56038),n=i(45664),o=i(19618),a=i(20693),r=i(73230),l=i(58547);function c(e,t){const i=[...e.splitOffRegions];return e.victimRegionId&&!s.Regions.model(t).byId(e.victimRegionId)?.isAlive()&&e.victimRegionWasAlive&&i.push(e.victimRegionId),i}},42880:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PreviewMode=void 0;const s=i(90379),n=i(56824);class o extends s.BaseWorldMapMode{constructor(){super(...arguments),this.handlesPointerEvents=!!n.config.debug.overlay,this.rendersEverything=!0}onSyncState(e){super.onSyncState(e),this.scene.cameraController.center()}onResize(){this.scene.cameraController.center()}}t.PreviewMode=o},43046:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameHistoryCursor=t.Move=void 0;const s=i(97849),n=i(19618),o=i(45084),a=i(56824).logger.for("GameHistory");t.Move={stepBack:{type:"step",delta:-1},stepForward:{type:"step",delta:1},seekBack:e=>({type:"seek",direction:"back",stopCondition:e}),seekForward:e=>({type:"seek",direction:"forward",stopCondition:e}),seekBackTag:(e,t)=>({type:"seek",direction:"back",stopCondition:i=>i.tags.has(e)&&(void 0===t||i.activeFaction===t)}),seekBackFaction:e=>({type:"seek",direction:"back",stopCondition:t=>t.activeFaction===e}),seekForwardTag:(e,t)=>({type:"seek",direction:"forward",stopCondition:i=>i.tags.has(e)&&(void 0===t||i.activeFaction===t)}),seekForwardFaction:e=>({type:"seek",direction:"forward",stopCondition:t=>t.activeFaction===e})};class r{constructor(e){this.history=e,this.currentIndex=0,this.currentIndex=e.latestMoveIndex()}isValid(){return this.currentIndex<this.history.length}canUndo(){if("PLAY.SPAWN_UNITS"===this.currentStep?.play?.name)return!1;const e=this.previousStep?.activeFaction;return this.currentStep&&e===this.currentStep.activeFaction}isValidMove(...e){return this.clone().move(...e)}move(...e){const t=this.clone();for(let i of e)switch(i.type){case"step":const e=t.currentIndex+i.delta;if(e<0||e>this.history.data.length-1)return!1;t.goTo(e);break;case"seek":if("back"===i.direction){if(!t.seekBack(i.stopCondition))return!1}else if(!t.seekForward(i.stopCondition))return!1}return this.goTo(t.currentIndex),!0}consumeNextPlay(){return this.move(t.Move.stepForward)?this.history.getEventsAt(this.currentIndex):[]}get currentStep(){return this.history.data[this.currentIndex]}get currentStepEvents(){return this.history.getEventsAt(this.currentIndex)}get currentState(){return this.currentIndex>=this.history.length&&(a.warning(`cursor is out of range (${this.currentIndex}>${this.history.length-1}), resetting to latest state`),this.currentIndex=this.history.length-1),this.history.getStateAt(this.currentIndex)}get latestEvent(){const e=this.history.getEventsAt(this.currentIndex);return e[e.length-1]}get previousStep(){return this.history.data[this.currentIndex-1]}peekNextEvent(){if(!this.hasNext())return;let e=this.currentIndex+1;for(;e<this.history.data.length&&0===this.history.getEventsAt(e).length;)++e;return this.history.getEventsAt(e)[0]}get nextStep(){return this.history.data[this.currentIndex+1]}get nextStepEvents(){if(this.hasNext())return this.history.getEventsAt(this.currentIndex+1)}goTo(e){return(0,s.assert)(e>=0&&e<this.history.data.length,`goTo index ${e} is out of valid range (0..${this.history.data.length-1})`),this.currentIndex=e,this}goToLastStep(){return this.currentIndex=this.history.data.length-1,this}seekBack(e){for(let t=this.currentIndex;t>=0;--t)if(e(this.history.data[t]))return this.goTo(t),!0;return!1}seekForward(e){for(let t=this.currentIndex;t<this.history.data.length;++t)if(e(this.history.data[t]))return this.goTo(t),!0;return!1}clone(){return new r(this.history).goTo(this.currentIndex)}canRollback(){if(!this.currentStep)return!1;const e=this.clone(),i=n.Factions.model(this.history.latestState).all().find((e=>e.isLocalPlayer()))?.id;return!!i&&!(o.CurrentPhase.model(this.history.latestState).faction?.id===i&&!e.move(t.Move.seekBackTag("turnStart",i),t.Move.stepBack))&&e.isValidMove(t.Move.seekBackTag("turnStart",i))}hasNext(){return this.currentIndex<this.history.data.length-1}hasStateInMemory(){return!!this.history.data[this.currentIndex]?.gameState}}t.GameHistoryCursor=r},43314:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexesByPawnTypeAndRegionProjection=void 0;const s=i(9767),n=i(81434);class o extends s.FilteredMultiMapProjection{constructor(e,t,i){super(e,i.pawnsByRegion),this.filteredPawnType=t,this.sources=i}constraint(e,t){return n.Pawns.getPawnType(e,t)===this.filteredPawnType}transform(e,t){return n.Pawns.getPawnHex(e,t)}}t.HexesByPawnTypeAndRegionProjection=o},43319:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomMapOutTransition=async function(e){const t=n.app.scene.randomMapSelect,i=e.duration??s.config.screenTransitionDuration;return new Promise((s=>{t.preUpdate.force(),e.keepWorldMap||n.app.scene.worldMap.cameraController.panAway("down",i),e.keepBackground||t.mainPanelUI.transitionOut(i),t.tweens.add({targets:t.components.filter((e=>e!==t.backButton&&e!==t.levelNamePanel)),props:{x:{getStart:e=>e.x,getEnd:e=>e.x+400},alpha:{from:1,to:0}},duration:i,onComplete:s,ease:"Sine.easeOut"}),t.tweens.add({targets:[t.backButton,t.levelNamePanel],props:{alpha:{from:1,to:0}},duration:i,ease:"Sine.easeOut"})}))};const s=i(56824),n=i(54825)},43656:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UserDataService=void 0,t.pickBetterResult=T,t.getLevelIdFromSaveGameKey=function(e){return e.slice(n.SAVE_GAME_LOCAL_STORAGE_PREFIX.length,e.lastIndexOf("."))};const s=i(66143),n=i(91693),o=i(56824),a=i(36868),r=i(91622),l=i(18811),c=i(78349),d=i(46512),h=i(2543),u=i(83240),p=i(97849),g=i(68415),m=i(66341),y=i(1326),f=i(19746),w=i(88128),v=i(73415),b=i(10131),S=i(9292),x=o.logger.for("UserData");function T(e,t){if(!t)return e;const i=t?.difficulty??"hard",s=e.difficulty??"hard";return"hard"===i&&"hard"!==s?t:"hard"===s&&"hard"!==i?e:{turns:(0,S.pickSmaller)(e.turns,t?.turns??1/0),difficulty:s}}t.UserDataService=class{constructor(e){this.storage=e,this.initialize=(0,b.asyncInitializer)((async()=>{this.counters.initialize(),this.storage.getItem(this.storageKey())||await this.applyMigrations(),this.readUserData(),await r.inject.mapRegistry.initialize(),this.importUserDataFromDefaultUser(),o.events.on(a.SystemEvents.UserSignedIn,(({userId:e,previousUserId:t})=>{this.handleNewUserSignedIn(e,t)}))})),this.counters=new m.StoredCountersUpdater(this),this.progressStats=new v.ProgressStatsProvider(this)}reload(){this.readUserData()}async applyMigrations(){const e=r.inject.login.getUserId();await(0,g.migrateUserData)(e)}getProgressData(){return(0,u.mergeProgressData)(this.current.progress.local,this.current.progress.synced)}flushProgressDataForUpload(){const e=this.current.progress.local;return e.completedLevels=(0,y.filterDictionary)(this.current.progress.local.completedLevels,((e,t)=>(0,h.isEqual)(T(e,r.inject.userData.current.progress.synced.completedLevels[t]),e))),this.current.progress={local:(0,f.createEmptyProgressData)(),synced:(0,u.mergeProgressData)(this.current.progress.synced,e)},e}handleProgressUploadSuccess(){this.writeUserData()}handleProgressUploadFailed(e){this.current.progress.local=(0,u.mergeProgressData)(this.current.progress.local,e);for(let[t,i]of Object.entries(e.counters)){const e=this.current.progress.synced.counters[t];e&&(this.current.progress.synced.counters[t]=(0,S.pickLarger)(0,e-i))}for(let t of Object.keys(e.completedLevels))delete this.current.progress.synced.completedLevels[t];this.writeUserData()}markAllProgressAsUnsynced(){this.current.progress.local=(0,u.mergeProgressData)(this.current.progress.local,this.current.progress.synced),this.current.progress.synced=(0,f.createEmptyProgressData)(),this.writeUserData()}hasUnsyncedProgressData(){const e=this.current.progress.local;return!(0,h.isEmpty)(e.completedLevels)||!(0,h.isEmpty)(e.counters)}handleNewUserSignedIn(e,t){t&&e!==t&&((0,p.assert)(e===r.inject.login.getUserId()),this.storage.getItem(this.storageKey(e))?this.reload():this.writeUserData())}getLevelVictoryRecordById(e){return this.getProgressData().completedLevels[e]}rememberChoice(e,t){this.current.rememberedChoices[e]=t,this.writeUserData()}recallChoice(e){return this.current.rememberedChoices[e]}wipeExpeditionProgress(){this.current.progress.local.completedLevels={},this.current.progress.synced.completedLevels={},this.writeUserData(),o.events.trigger(a.SystemEvents.LocalProgressWiped())}endLevelSession(e,t){if(!e.sessionData.id)return;const i=e.sessionData.levelId;var s;r.inject.levelSession.id===e.sessionData.id&&r.inject.levelSession.active?r.inject.levelSession.end({origin:t,wipeAutoSave:!0}):o.events.trigger(a.SystemEvents.LevelSessionOver({levelId:i,origin:t,timestamp:Date.now(),victoryDistance:(s=e.sessionData.outcome,s===l.LevelOutcome.Victory?1:s===l.LevelOutcome.Defeat?0:.5),avgFps:0,minFps:0,playLog:[],sessionId:e.sessionData.id}))}writeUserData(){const e=this.storageKey();this.storage.setObject(e,this.current)}storageKey(e=r.inject.login.getUserId()){return c.STORAGE_KEYS.USER_DATA_PREFIX+e}readUserData(){const e=this.storage.getItem(this.storageKey())??"{}";this._parseUserData(e),x.info(`User data initialized from local storage (key ${this.storageKey()})`),o.events.trigger(a.SystemEvents.UserDataLoaded(this.current)),this.checkStorageUsage(),this.writeUserData()}checkStorageUsage(){const e=this.storage.getSizeInBytes();e>2e6&&o.errors.handleNonFatalError({message:"Dangerously high local storage usage!",totalBytes:e,usageByKey:(0,c.getSizeByKey)(this.storage)},"userData.checkLocalStorage")}_parseUserData(e){let t;try{t=JSON.parse(e)}catch(e){x.error("Failed parsing metadata:",e),t={}}"object"==typeof t&&t||(x.error("Ignoring invalid metadata"),t={}),this._loadUserData(t)}_loadUserData(e){let t;function i(){return t||(t=(0,d.defaultUserData)()),t}const s={...i(),metadata:e.metadata??i().metadata,progress:e.progress??i().progress,rememberedChoices:{...i().rememberedChoices,aiDifficulty:e.rememberedChoices?"hard":"normal",...e.rememberedChoices},tutorialsCompleted:e.tutorialsCompleted??i().tutorialsCompleted,levelFeedbacksSubmitted:e.levelFeedbacksSubmitted??[]};this.current=s,t&&this.writeUserData()}saveLevelOutcome(e){const t=r.inject.gameStateModel,i=s.LevelModel.for(t.map.levelId);if(e===l.LevelOutcome.Victory&&i.expeditionContext){const e={turns:r.inject.levelSession.getTurnsToVictory(),difficulty:r.inject.levelSession.aiDifficulty},t=this.current.progress.local.completedLevels[i.id];this.current.progress.local.completedLevels[i.id]=T(e,t)}this.writeUserData(),o.events.trigger(a.SystemEvents.LocalProgressUpdated())}saveFeedback(e){const t=e.levelId;t&&!this.current.levelFeedbacksSubmitted.includes(t)&&(this.current.levelFeedbacksSubmitted.push(t),this.writeUserData())}completeTutorial(e){this.current.tutorialsCompleted[e]=!0,this.writeUserData()}hasCompletedTutorial(e){return this.current.tutorialsCompleted[e]??!1}async importRemoteProgress(e){const t=await(0,w.handleConflictBetweenRemoteAndSyncedProgress)(e);switch(t){case"upload-local":this.current.progress.synced=(0,u.updateProgressData)(this.current.progress.synced,e),this.markAllProgressAsUnsynced();break;case"wipe-local":this.current.progress={local:(0,f.createEmptyProgressData)(),synced:e};break;case"no-conflict":this.current.progress.synced=(0,u.updateProgressData)(this.current.progress.synced,e)}"no-changes"!==t&&(o.events.trigger(a.SystemEvents.UserDataLoaded(this.current)),this.writeUserData())}importProgress(e){this.current.progress.local=(0,u.mergeProgressData)(this.current.progress.local,e),o.events.trigger(a.SystemEvents.LocalProgressUpdated())}setMetadata(e){const t={...this.current.metadata,...e};(0,h.isEqual)(t,this.current.metadata)||(this.current.metadata=t,this.writeUserData())}import(e){this._loadUserData(e)}importUserDataFromDefaultUser(){try{if(this.storage.getItem(c.STORAGE_KEYS.DEFAULT_USER)!==this.storage.getItem(c.STORAGE_KEYS.CURRENT_USER)){const e=this.storage.getItem(c.STORAGE_KEYS.DEFAULT_USER),t=this.storage.getItem(c.STORAGE_KEYS.USER_DATA_PREFIX+e);if(t&&e!==r.inject.login.getUserId()){const i=JSON.parse(t);x.warning(`Found userData under defaultUserId ${e}, merging into ${r.inject.login.getUserId()}...`),this.import(i),this.storage.removeItem(c.STORAGE_KEYS.USER_DATA_PREFIX+e)}}}catch(e){o.errors.handleNonFatalError(e,"UserDataService.importUserDataFromDefaultUser")}}}},43736:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompactWorldMapPanel=void 0;const s=i(86545),n=i(96137),o=i(36868),a=i(20087),r=i(55776),l=i(54825),c=i(74783),d=i(11862),h=i(7782),u=i(56824),p=i(91622),g=i(11466),m=i(9292);class y extends s.AutoHeightResponsiveContainer{constructor(e){super(e.scene),this.ui=e,this.bgCard=this.ui.image("glass-ui/header-card-gradient"),this.emoji=new r.EmojiContainer(l.app.scene.playUI.objectsPool),this.text=this.ui.richText("Sample text",n.Colors.glassUi.textMain),this.buttons=[],this.explicitlyHidden=!1,this.hideButton=this.ui.stealthButton({icon:{image:"ui/icons/chevron-down",tintWithText:!0,color:n.Colors.glassUi.textMain,postProcess:e=>e.setFlipY(!0).setOrigin(0,1)},iconPlacement:"left",height:10,width:10,theme:"dark",onClicked:()=>{this.explicitlyHidden=!0,this.visibility.transitionTo(0)}}),this.glint=this.ui.image("glass-ui/card-horizontal-glint"),this.bottomLine=this.ui.rectangle(n.Colors.glassUi.textMain,1),this.typewriter=new d.Typewriter(this.text),this.fullTextHeight=0,this.visibility=new h.TransitionController(this.scene,{applyValue:e=>{this.setAlpha(e),this.setVisible(e>0),this.y=this.height*(e-1)},duration:300,ease:"Sine.easeOut",initialValue:0}),this.emoji.setColor(c.EMOJI_COLORS[2]),this.emoji.setScale(2,2),this.bgCard.setInteractive({cursor:"default"}),this.bgCard.on("pointerdown",(()=>{this.typewriter.fastForward()})),this.add([this.bgCard,this.bottomLine,this.glint,this.text,this.emoji,this.hideButton]),this.setVisible(!1),p.inject.theme.use((e=>{this.bgCard.setTint(e.oceanShades.light1),this.text.setTint(e.oceanContrastDark),this.bottomLine.setFillStyle(e.oceanShades.dark4)}))}updateState(e){const t=1===this.visibility.currentTarget;if(e){if(this.explicitlyHidden&&this.typewriter.finalText===e.text)return;this.explicitlyHidden=!1,this.visibility.transitionTo(1),this.updateButtons(e),this.emoji.setFace(e.emojiEmotion),t&&this.typewriter.finalText===e.text||(this.text.setText(e.text),this.fullTextHeight=this.text.height,this.typewriter.start(e.text)),this.updateLayout()}else this.visibility.transitionTo(0),this.explicitlyHidden=!1}updateButtons(e){for(let t=0;t<e.buttons.length;t++)this.createOrUpdateButton(t,e.buttons[t]);for(let t=e.buttons.length;t<this.buttons.length;t++)this.buttons[t].destroy();this.buttons.splice(e.buttons.length)}createOrUpdateButton(e,t){this.buttons[e]&&this.buttons[e].destroy(),this.buttons[e]=this.ui.outlineButton({icon:t.icon,text:t.text,theme:"dark",onClicked:()=>{u.events.trigger(o.UserActions.WorldMapPanelButtonClicked(t.action))}}),this.add(this.buttons[e])}calculateHeight(){if(this.buttons.length){const e=this.buttons[this.buttons.length-1];return e.y+e.height+16}return this.text.y+this.text.height+16}updateLayout(){this.width=l.app.scene.playUI.bounds.width;const e=this.emoji.faceBg.height,t=(0,m.pickSmaller)(this.width-54-16-e-16,500);this.text.x=this.width/2-t/2,this.text.setWordWrapWidth(t);const i=l.app.device.uiVariant()===g.UiVariant.Large;let s=i?40:0,n=i?40:0;a.Arrange.topToBottom({content:[{object:this.text,size:this.fullTextHeight},{size:0},...this.buttons],y:16+s,origin:0,spacing:6}),a.Arrange.alignX({content:this.buttons,x:this.width-54-n,origin:1}),this.emoji.setPosition(this.text.x-e/2-16,this.text.y+this.text.height/2),this.updateSize(),this.hideButton.width=40,this.hideButton.height=40,this.hideButton.update(),this.hideButton.setPosition(this.width-this.hideButton.width-8-n,this.height-8-this.hideButton.height),this.hideButton.setVisible(this.hideButton.y>48),this.bgCard.setOrigin(0,0),this.bgCard.setSize(this.width,this.height),this.bgCard.setDisplaySize(this.width,this.height),this.bottomLine.setOrigin(0,1),this.bottomLine.setPosition(0,this.height),this.bottomLine.setSize(this.width,2),this.glint.setOrigin(.5,1),this.glint.setPosition(this.width/2,this.height-3)}}t.CompactWorldMapPanel=y},43878:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VerticalStripePanelUI_OLD=void 0;const s=i(80959),n=i(96137),o={width:400,padding:10,stripeWidth:6,stickToRightSide:!1};t.VerticalStripePanelUI_OLD=class{constructor(e,t={}){this.scene=e;const i=s.UiBuilder.for(this.scene);this.props={...o,...t},this.mainPanel=i.rectangle(n.Colors.glassUi_old.background,.85).setScrollFactor(0),this.decorativeStripe=i.rectangle(n.Colors.glassUi_old.background,.77).setScrollFactor(0),this.decorativeStripeRight=i.rectangle(n.Colors.glassUi_old.background,.77).setScrollFactor(0),this.components=[this.decorativeStripeRight,this.decorativeStripe,this.mainPanel]}addToScene(){this.scene.addAll(this.components)}isFullScreen(){return this.scene.bounds.contentWidth<1.5*this.props.width}updateLayout(){const e=this.props,t=(this.scene.bounds.width,this.scene.bounds.height);if(this.isFullScreen())this.mainPanel.setPosition(0,0),this.mainPanel.setSize(this.scene.bounds.contentWidth,t);else{const i=this.props.stickToRightSide?this.scene.bounds.width:this.scene.bounds.contentRight;this.mainPanel.setPosition(i-e.width,0),this.mainPanel.setSize(e.width,t)}this.decorativeStripe.setPosition(this.mainPanel.x-2*e.stripeWidth,0),this.decorativeStripe.setSize(e.stripeWidth,t),this.decorativeStripeRight.setPosition(this.mainPanel.x+this.mainPanel.width+e.stripeWidth,0),this.decorativeStripeRight.setSize(e.stripeWidth,t)}async transitionIn(e){await new Promise((t=>{this.scene.tweens.add({targets:this.components,props:{alpha:{from:0,to:1}},duration:e,ease:"Sine.easeIn",onComplete:t})}))}async transitionOut(e){await new Promise((t=>{this.scene.tweens.add({targets:this.components,props:{alpha:{from:1,to:0}},duration:e,ease:"Sine.easeIn",onComplete:t})}))}setVisible(e){this.components.forEach((t=>{t.setVisible(e),e&&t.setAlpha(1)}))}}},44194:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompactPlayUI=void 0;const s=i(13521),n=i(60959),o=i(79899),a=i(56824),r=i(80750),l=i(66253),c=i(36868),d=i(40904),h=i(61116),u=i(33077),p=i(42880),g=i(86148),m=i(71021),y=i(94958),f=i(91622),w=i(54825),v=i(2523),b=i(70842),S=i(7782),x=i(24966),T=i(21817),P=i(22663),I=i(40951),C=i(98963),M=i(9537),A=i(20227),B=(a.logger.for("ui:PlayUI"),32);t.CompactPlayUI=class{constructor(e,t){this.scene=e,this.state=t,this.tweener=new A.Tweener(this.scene),this.pawnHolder=new s.PawnHolder(this.scene),this.statusHeaderVisibility=new S.TransitionController(this.scene,{applyValue:e=>{this.statusHeader.y=(1-e)*-B,w.app.scene.playUI.worldMapPanel.y=e*B},duration:300,ease:"Sine.easeInOut"}),this.statusHeader=new y.StatusHeaderUI(this.scene,this.statusHeaderVisibility),this.regionPanel=new r.CompactRegionPanel(this.scene),this.shoppingTray=new n.ShoppingTray(this.scene,{...l.COMPACT_PLAY_UI_LAYOUT.shoppingTray,width:this.scene.bounds.width}),this.powerBalanceRibbon=new d.PowerBalanceRibbon(this.scene,{x:0,y:0,width:100,minSize:24}),this.tutorialArrow=new b.TutorialArrow(this.scene),this.tutorialFrame=new x.TutorialFrame(this.scene),this.endTurnButton=new E(this.scene),this.undoButton=new O(this.scene),this.nextPendingRegionButton=new R(this.scene),this.skipSpectatingButton=new k(this.scene),this.rollbackPanel=new u.LevelMenuPanel(this.scene,{onAction:()=>this.closeRollbackPanel()}),this.rewindControls=new v.RewindModeControls(this.scene,l.COMPACT_PLAY_UI_LAYOUT.rewindControls),this.bottomAnchoredComponents=[this.shoppingTray,this.powerBalanceRibbon,this.regionPanel,this.endTurnButton,this.skipSpectatingButton,this.nextPendingRegionButton,this.undoButton,...this.rewindControls.getGameObjects()],this.endTurnButton.onClicked((e=>{e.rightButtonDown()||e.rightButtonReleased()?a.events.trigger(c.UserActions.Escape()):a.events.trigger(c.UserActions.EndTurn({force:e.event.ctrlKey}))})),this.undoButton.onClicked((()=>a.events.trigger(c.UserActions.Undo()))),this.nextPendingRegionButton.onClicked((()=>a.events.trigger(c.UserActions.SelectNextPendingRegion()))),this.skipSpectatingButton.onClicked((()=>a.events.trigger(c.UserActions.SkipSpectating()))),this.statusHeaderVisibility.setTo(0),this.layer=new h.ResponsiveLayer(this.scene,[...this.rewindControls.getGameObjects(),this.powerBalanceRibbon,this.shoppingTray,this.regionPanel,this.endTurnButton,this.skipSpectatingButton,this.nextPendingRegionButton,this.undoButton,this.rollbackPanel,this.statusHeader,this.tutorialFrame,this.tutorialArrow]),this.scene.add.existing(this.layer),this.rollbackPanel.setVisible(!1),this.updateLayout(),f.inject.ui.withoutTransitions((()=>{this.updateState(this.state)}))}openRollbackPanel(){this.scene.children.bringToTop(this.rollbackPanel),this.rollbackPanel.show(),w.app.scene.worldMap.setMode(new p.PreviewMode),w.app.scene.globalUI.updateLayout()}closeRollbackPanel(){this.rollbackPanel.setVisible(!1),w.app.scene.worldMap.setMode(new g.InteractiveMode),w.app.scene.play.skipToCurrentState(m.NewGameStateContext.ResumingGame),w.app.scene.globalUI.updateLayout()}isRollbackPanelOpen(){return this.rollbackPanel.visible}transitionIn(e=a.config.screenTransitionDuration){this.updateLayout(),this.tweener.add({targets:this.bottomAnchoredComponents,props:{y:{getStart:e=>e.y+160,getEnd:e=>e.y}},duration:e,ease:"Sine.easeOut"})}transitionOut(e=a.config.screenTransitionDuration){this.updateLayout(),this.setVisible(!0),this.tutorialArrow.visibility.transitionTo(0,{duration:e/2}),this.tutorialFrame.visibility.transitionTo(0,{duration:e/2}),this.tweener.add({targets:this.bottomAnchoredComponents,y:"+=160",duration:e,ease:"Sine.easeIn"})}burnLife(){}destroy(){this.layer.destroy()}update(){this.pawnHolder.update(),this.tutorialArrow.updatePosition(),this.tutorialFrame.updatePosition()}updateLayout(){this.setVisible(this.state.visible);const e=this.scene.bounds.width,t=this.scene.bounds.height;this.regionPanel.reflow(),this.shoppingTray.x=0,this.shoppingTray.width=e,this.shoppingTray.updateLayout(),this.statusHeader.updateLayout(),this.rewindControls.updateLayout(),this.undoButton.setPosition(0,t-this.undoButton.height),this.endTurnButton.setPosition(e-this.endTurnButton.width,t-this.endTurnButton.height),this.nextPendingRegionButton.copyPosition(this.endTurnButton),this.skipSpectatingButton.copyPosition(this.endTurnButton),this.powerBalanceRibbon.setDimensions(l.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides,t-this.powerBalanceRibbon.height,e-2*l.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides),this.rollbackPanel.setSize(e,t)}updateState(e){const t=this.state;if(this.state={...this.state,...e},this.regionPanel.updateState(e),this.rewindControls.updateState(e),void 0!==e.tutorialArrow&&(e.tutorialArrow?this.tutorialArrow.showAt(e.tutorialArrow):this.tutorialArrow.hide()),void 0!==e.tutorialFrame&&(e.tutorialFrame?this.tutorialFrame.showAt(e.tutorialFrame):this.tutorialFrame.hide()),void 0!==e.layout)switch(this.hideIrrelevantLayoutControls(e.layout.name),e.layout.name){case"hidden":break;case"spectate":this.skipSpectatingButton.setVisible(e.layout.enableSkipSpectating);break;case"rewind":this.powerBalanceRibbon.setVisible(!1);break;case"play":this.endTurnButton.setVisible("endTurn"===e.layout.primaryButton||"highlightEndTurn"===e.layout.primaryButton),this.endTurnButton.setHighlight("highlightEndTurn"===e.layout.primaryButton),this.nextPendingRegionButton.setVisible("nextRegion"===e.layout.primaryButton),this.undoButton.setVisible(!0),this.undoButton.setEnabled(e.layout.undoAvailable===M.UndoAvailability.Available),this.rollbackPanel.setRewindEnabled(e.layout.enableRollback);const t=e.layout.regionData;t&&t.controllable?(this.shoppingTray.setOpen(!0),this.shoppingTray.setColor(e.layout.activeFactionColor),this.shoppingTray.setBuyablePawns(t.buyablePawns)):this.shoppingTray.setOpen(!1),w.app.device.isUsingTouch()&&this.statusHeader.updateState(e.layout.heldPawnData)}void 0!==e.powerBalance&&this.powerBalanceRibbon.updateState(e.powerBalance),void 0!==e.visible&&e.visible!==t.visible&&(e.visible?this.transitionIn():this.transitionOut())}hideIrrelevantLayoutControls(e){"play"!==e&&(this.endTurnButton.setVisible(!1),this.nextPendingRegionButton.setVisible(!1),this.undoButton.setVisible(!1),this.shoppingTray.setOpen(!1)),"rewind"!==e&&this.powerBalanceRibbon.setVisible(!0),"spectate"!==e&&this.skipSpectatingButton.setVisible(!1)}setVisible(e){this.layer.setVisible(e)}getTooltipFor(e){return this.shoppingTray.getTooltipFor(e)}getBottomPanelHeight(){if(w.app.navigator.currentScreen!==w.app.screen.play)return 0;switch(this.state.layout.name){case"play":return 85;case"spectate":return 15;case"rewind":return 110;case"hidden":return 0}}getIncomeLabelBounds(){const e=this.regionPanel.regionLabel.incomeText.getBounds(),t=this.regionPanel.regionLabel.trendIcon.getBounds();return Phaser.Geom.Rectangle.Union(e,t)}getTreasuryLabelBounds(){const e=this.regionPanel.regionLabel.treasuryText.getBounds(),t=this.regionPanel.regionLabel.goldIcon.getBounds();return Phaser.Geom.Rectangle.Union(e,t)}get restartButton(){return w.app.scene.sidePanelUI.panels[T.SideBarMode.Menu].buttons.restartButton}activate(e){this.setVisible(!0),this.updateState(e)}deactivate(){this.setVisible(!1)}};class E extends o.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-turn",down:!0})}setHighlight(e){e?this.setBaseFrame("ui/compact/btn-turn-glow"):this.setBaseFrame("ui/compact/btn-turn")}}class O extends o.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-undo",down:!0,disabled:!0}),this.controller.onStateChanged((({newState:e})=>{e===P.ButtonState.Down?this.tmr||(this.tmr=setTimeout((()=>{w.app.audio.playEffect(C.SoundEffects.ButtonUp),a.events.trigger(c.UserActions.UndoAll())}),I.TIMING.longPressDuration)):this.tmr&&(clearTimeout(this.tmr),this.tmr=void 0)}))}}class R extends o.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-next",down:!0,tooltip:"Select next idle province"})}}class k extends o.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-skip",down:!0,tooltip:"Skip watching enemy turn"})}}},44373:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeSpawnUnits=function(e,t){new n.WorldUpdateBuilder(e);const i=(0,o.getHex)(t.hexId),s=e.factions.byId(t.factionId);for(let t of e.pawns.byHex(i))t.destroy();s.takeOverHex(i);for(let{pawnType:s,count:n}of t.units)e.pawns.create({hex:i,type:s,count:n});return[a.GameStateEvents.NewGameState({state:e.state,context:r.NewGameStateContext.LevelScript})]};const s=i(56824),n=i(78933),o=i(45664),a=i(36868),r=i(71021);s.logger.for("spawnUnits")},44503:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FOOTER=t.HEADER=t.CHATTERFILE_PREFIX=void 0,t.importChatter=function(e){const i=e.split("\n");let s=[];const n={rules:[],line:1,lineContent:"",currentRuleStartsAt:0,currentRule:null,logError:(e,t=n.line)=>s.push({line:t,message:e,snippet:i[t]})};if(!i[0]?.startsWith(t.CHATTERFILE_PREFIX))return n.logError(`This does not appear to be an AI chatter file (does not start with ${t.CHATTERFILE_PREFIX})`),{rules:[],errors:s};try{for(let e=0;e<i.length;++e){const t=i[e];n.line=e,n.lineContent=t,t.startsWith(">")?o(n):t.startsWith("-")&&n.currentRule&&n.currentRule.lines.push(t.slice(1).trim())}a(n)}catch(e){n.logError(e.message)}return{rules:n.rules,errors:s}};const s=i(75161);t.CHATTERFILE_PREFIX="konkraichatter.v1";const n={"caused crippling damage":["caused major damage","caused damage"],"caused major damage":["caused damage"],"caused minor damage":["did not cause major damage"],"caused no damage":["did not cause major damage"],"suffered crippling damage":["suffered major damage","suffered damage"],"suffered major damage":["suffered damage"],"suffered minor damage":["did not suffer major damage"],"suffered no damage":["did not suffer major damage"],truce:["suffered no damage","caused no damage"],ally:["friendly","not hostile"],friendly:["not hostile"],neutral:["not hostile","not friendly"],hostile:["not friendly"],furious:["hostile","not friendly"],"was ally":["was friendly","was not hostile"],"was friendly":["was not hostile"],"was neutral":["was not hostile","was not friendly"],"was hostile":["was not friendly"],"was furious":["was hostile","was not friendly"],"much stronger":["stronger","not weaker"],stronger:["not weaker"],"similar strength":["not weaker","not stronger"],weaker:["not stronger"],"much weaker":["weaker","not stronger"],"was much stronger":["was stronger","was not weaker"],"was stronger":["was not weaker"],"was similar strength":["was not weaker","was not stronger"],"was weaker":["was not stronger"],"was much weaker":["was weaker","was not stronger"]};function o(e){a(e);try{e.currentRuleStartsAt=e.line,e.currentRule={tags:e.lineContent.slice(1).split(",").map(r),lines:[]}}catch(t){e.logError(t.message),e.currentRule=null,e.currentRuleStartsAt=0}}function a(e){const{currentRule:t}=e;t&&(0===t.lines.length&&e.logError("Empty rule definition.",e.currentRuleStartsAt),function(e,t){const{rules:i,logError:s}=t,o=e.tags.flatMap((e=>n[e]??[])),a=e.tags.concat(o);let r=0;for(let o of i)if(++r,o!==e&&o.tags.every((e=>a.includes(e)))&&e.tags.every((e=>o.tags.includes(e)||(n[e]??[]).some((e=>o.tags.includes(e))))))return void s(`Rule is unreachable. An earlier rule on line ${r} (${o.tags.join(", ")}) will always take precedence`,t.currentRuleStartsAt)}(t,e),e.rules.push(t),e.currentRule=null,e.currentRuleStartsAt=0)}function r(e){const t=e.trim();if(!s.AI_SITUATION_TAGS.includes(t))throw Error(`Unknown tag "${t}"`);return t}t.HEADER="// This file is generated by dev-tools/generate-ai-chatter.ts\nimport { ChatterRule } from '../ai/chatter/types'\nexport let CHATTER_DEFS : Array<ChatterRule> = ",t.FOOTER="\nexport function updateChatterRules(newDefs: Array<ChatterRule>) {\n  CHATTER_DEFS = newDefs\n}\n"},44616:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefenderBenefitView=void 0;const s=i(52434),n=i(45664),o=i(70712),a=i(1326),r=i(76439),l=i(12543),c=i(7334),d=i(78635),h=i(20693),u=i(9292),p=.01;class g extends s.CalculatedHexGroupValuationWithCache{constructor(e,t){super(),this.context=e,this.security=t,this.isDisjointedCache={}}calculate(e){return(0,a.mapDictionary)({1:0,2:0,3:0},((t,i)=>this.calculateForMight(e,i)))}calculateForMight(e,t){const i=(0,n.getHex)(e);if(this.isDisjointed(i))return 0;let s=0;if(this.context.region.hexes.has(i)){const n=this.security.afterPlacingDefender(e,t);s+=this.getBenefit(i,n,t)}for(let e of this.context.region.hexes.neighboursOf(i)){const i=this.security.calculate(e.id,{defense:t});s+=this.getBenefit(e,i,t)}return s}isDisjointed(e){return void 0===this.isDisjointedCache[e.id]&&(this.isDisjointedCache[e.id]=this.calculateIsDisjointed(e)),this.isDisjointedCache[e.id]}calculateIsDisjointed(e){if(this.security.get(e.id)>p)return!1;const t=this.context.region.hexes.has(e)?o.AI.getHexImportance(this.context.state,e.id).parents:e.neighbours((e=>this.context.region.hexes.has(e))).members;return!t.some((e=>this.security.get(e.id)>p))&&!h.HexGroup.union(t.map((e=>h.HexGroup.from(o.AI.getHexImportance(this.context.state,e.id).parents)))).members.some((e=>this.security.get(e.id)>p))}getBenefit(e,t,i){const s=this.security.get(e.id),a=d.Warfare.getHexDefenseWithoutMovableUnits(this.context.state,(0,n.getHex)(e.id));let r=.01*(0,u.pickLarger)(0,i-a);return(0,u.pickLarger)(r,t-s)*o.AI.getHexImportance(this.context.state,e.id).value}getDebugLayer(){const e=this;return new r.GameStateDebugLayer((0,l.hexBasedAdapter)({getValue:(t,i)=>Object.entries(e.get(i)).reduce(((e,t)=>t[1]>e[1]?t:e))[1].toFixed(),getDetail:(t,i)=>(0,c.prettyPrintObject)(e.get(i))}))}getForMight(e,t){return this.get(e)[t]??0}}t.DefenderBenefitView=g},45084:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurrentPhase=void 0;const s=i(90952),n=i(20026),o=i(62899),a=i(20541),r=i(27109);class l{static model(e){return this.models.get(e)}static getFaction(e){return(0,n.selectFromState)(e,s.GameState.currentPhase.data)?.faction}static getType(e){return(0,n.selectFromState)(e,s.GameState.currentPhase.data)?.type}static getTurnNumber(e){return(0,n.selectFromState)(e,s.GameState.currentPhase.data)?.turnNumber}static isMovable(e,t){return(0,n.selectFromState)(e,s.GameState.currentPhase.movableUnits).has(t)}static getMovableUnits(e){return(0,n.selectFromState)(e,s.GameState.currentPhase.movableUnits).toArray()}static getTappedUnits(e){return(0,n.selectFromState)(e,s.GameState.currentPhase.tappedUnits).toArray()}static isTapped(e,t){return(0,n.selectFromState)(e,s.GameState.currentPhase.tappedUnits).has(t)}static tapPawn(e,t){return(0,n.applyMutations)(e,s.GameState.currentPhase.tappedUnits.createMutation({add:[t]},"currentPhase.tapPawn"))}static unTapPawn(e,t){return(0,n.applyMutations)(e,s.GameState.currentPhase.tappedUnits.createMutation({delete:[t]},"currentPhase.unTapPawn"))}static set(e,t){const i=(0,n.selectFromState)(e,s.GameState.currentPhase.data),o=new a.SetDataSetMutationBuilder(s.GameState.currentPhase.tappedUnits);return o.init(e),o.clear(),(0,n.applyMutations)(e,s.GameState.currentPhase.data.createMutation({...i,...t},"currentPhase.set"),o.createMutation("currentPhase.set"))}}t.CurrentPhase=l,l.models=new r.ModelsCache((e=>new o.CurrentPhaseModel(e)))},45145:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverworldUIScene=void 0;const s=i(897),n=i(30948),o=i(81700),a=i(33020),r=i(78614),l=i(39217),c=i(54825),d=i(29481),h=i(62845),u=i(54429),p=i(66272),g={levelListExpanded:!1,levelListFilter:u.LevelFilter.Unlocked,levelListSortBy:p.SortBy.LevelNumber,footerLayout:{mode:"no-level-selected"},levelDetail:null,primaryButton:null};class m extends n.BaseUIScene{constructor(){super({key:o.Scenes.OverworldUI}),this.currentState=g,this.preUpdate=(0,s.whenDirty)((()=>{this.selectedLevelControls.activeUI.updateLayout(),this.levelDetailUI.updateLayout(),this.levelListUI.updateLayout()}))}create(){super.create(),this.selectedLevelControls=new l.UIVariantSwitcher({scene:this,compactUI:()=>new r.OverworldFooterControlsCompact(this,this.currentState),largeUI:()=>new a.OverworldFooterControlsLarge(this,this.currentState)}),this.levelDetailUI=new d.LevelDetailUI(this),this.levelListUI=new h.LevelListUI(this)}updateState(e){this.currentState,this.currentState={...this.currentState,...e},this.selectedLevelControls.activeUI.updateState(this.currentState),this.levelDetailUI.updateState(this.currentState),this.levelListUI.state.update({open:this.currentState.levelListExpanded,levelFilter:this.currentState.levelListFilter,sortBy:this.currentState.levelListSortBy})}update(e,t){c.app.scene.menuHeaderUI.update(e,t)}}t.OverworldUIScene=m},45174:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.overworldToExpeditionsTransition=async function(e){const t=n.config.screenTransitionDuration;let i=s.app.scene.expeditions.expeditionButtons.get();const a=e?i.find((t=>t.expedition.id===e)):void 0,r=s.app.scene.menuHeaderUI,l=s.app.scene.overworldUI,c=s.app.scene.expeditions;c.preUpdate.force(),c.disableLayoutUpdates=!0;const d=s.app.scene.levelList.visibility.currentTarget,h=[r.overlayIcon,r.titleText,r.subtitleText,r.icon,r.background],u=[l.levelListUI.showHideButton,...l.levelListUI.filterButtons,l.levelListUI.filterSlider,l.levelListUI.sortButton];await new Promise((e=>{if(i.forEach((e=>e.setAlpha(0))),s.app.scene.expeditions.tweens.add({targets:(0,o.without)(i,a),alpha:1,delay:t/2,duration:t/2,ease:"Sine.easeOut",onComplete:()=>e()}),s.app.scene.overworld.fadeOut(t),s.app.scene.levelList.visibility.setTo(0,"transition"),a){const{x:e,y:i,width:n,height:o}=a;a.setPosition(0,0),a.setSize(s.app.device.screenWidth,s.app.device.screenHeight),a.shrinkToSize(t,{x:e,y:i,width:n,height:o})}l.levelDetailUI.transitionOut();const n={props:{alpha:0},duration:t/3,ease:"Sine.easeInOut"};r.tweens.add({targets:h,...n}),l.tweens.add({targets:u,...n})})),r.background.setAlpha(.87);for(let e of[...h,...u])e.setAlpha(1);r.background.setAlpha(.87);for(let e of i)e.alpha=1;s.app.scene.levelList.visibility.setTo(d,"instant"),c.disableLayoutUpdates=!1};const s=i(54825),n=i(56824),o=i(2543)},45592:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetsValueByRegionUpdater=t.AssetsValueByRegionProjection=void 0;const s=i(31011),n=i(7334),o=i(56038),a=i(4005),r=i(56824),l=i(13560),c=i(2543),d=i(88023);r.logger.for("AssetsValueByRegionProjection");class h extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new u(this).update}bootstrap(e){const t=o.Regions.model(e);return(0,d.ImmutableMap)().withMutations((e=>{t.all().forEach((t=>{const i=this.calculate(t);i!==l.NO_ASSET_VALUE&&e.set(t.id,i)}))}))}calculate(e){return l.AssetValue.sum(...e.hexes.members.map((t=>this.sources.hexAssetValue.getEntryById(e.state,t.id)??l.NO_ASSET_VALUE)))}entryToString(e){return(0,l.assetValueToDebugStr)(e)}entryToDebugString(e){return(0,n.prettyPrintObject)({...e})}}t.AssetsValueByRegionProjection=h;class u extends a.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}initialize(){this.invalidated=new Set}registerHandlers(e){e(this.dataSet.sources.hexAssetValue,this.handleHexAssetValueChange.bind(this)),e(this.dataSet.sources.regionHexes,this.handleRegionHexesChange.bind(this))}handleHexAssetValueChange(e){e.updated?.forEach((([e,t])=>{t||(t=l.NO_ASSET_VALUE);const i=o.Regions.getByHex(this.newState,e);if(o.Regions.getByHex(this.oldState,e)!==i)return;const s=this.dataSet.sources.hexAssetValue.getEntryById(this.oldState,e)??l.NO_ASSET_VALUE;if(!(0,c.isEqual)(s,t)){const e=this.builder.getCurrent(i)??l.NO_ASSET_VALUE;this.builder.set(i,{economic:e.economic-s.economic+t.economic,defensive:e.defensive-s.defensive+t.defensive,offensive:e.offensive-s.offensive+t.offensive})}}))}handleRegionHexesChange(e){e.updated?.forEach((e=>{for(let t of e.added??[]){const i=this.dataSet.sources.hexAssetValue.getEntryById(this.newState,t)??l.NO_ASSET_VALUE;this.builder.set(e.id,l.AssetValue.sum(this.builder.getCurrent(e.id)??l.NO_ASSET_VALUE,i))}for(let t of e.removed??[]){const i=this.dataSet.sources.hexAssetValue.getEntryById(this.oldState,t)??l.NO_ASSET_VALUE;this.builder.set(e.id,l.AssetValue.subtract(this.builder.getCurrent(e.id)??l.NO_ASSET_VALUE,i))}}))}}t.AssetsValueByRegionUpdater=u},45651:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoggedInUi=t.LoggingInUI=t.NotLoggedInUi=t.LoginWidget=void 0;const s=i(56824),n=i(86545),o=i(80959),a=i(96137),r=i(91622),l=i(36868),c=i(20087),d=i(25988),h=i(54825),u=i(70080),p=i(9557),g=i(98963),m=i(89413),y=i(13426),f=i(49527),w=i(21817),v=i(13419),b=i(72427),S={userEmail:"",loggedInState:u.LoginState.Disabled,cloudSyncState:m.CloudSyncState.Disabled,allowLogout:!1};class x extends d.SideBarWidget{constructor(e){super(e,{padding:20}),this.currentState=S,this.notLoggedInContent=new P(this.scene),this.loggedInContent=new C(this.scene),this.loggingInContent=new I(this.scene),r.inject.login.state.watch((e=>{r.inject.ui.sidebarMode()===w.SideBarMode.Settings&&this.updateStateFromCurrentLoginStatus()})),r.inject.ui.sidebarMode.watch((e=>{e===w.SideBarMode.Settings&&this.updateStateFromCurrentLoginStatus()})),h.app.cloudSync.status.watch((e=>{this.updateState({cloudSyncState:e})}))}updateStateFromCurrentLoginStatus(){this.updateState({userEmail:r.inject.login.getUsername(),authProvider:r.inject.login.describeCurrentAuthProvider(),loggedInState:r.inject.login.state(),signupEmail:s.storage.getItem("emailForSignIn")??void 0,allowLogout:!(0,v.isRunningAt)("kongregate")})}updateState(e){switch(this.currentState,this.currentState={...this.currentState,...e},this.currentState.loggedInState){case u.LoginState.SignedIn:this.loggedInContent.setProps(this.currentState),this.setContent(this.loggedInContent),this.clearCustomBackground();break;case u.LoginState.LoginFailed:case u.LoginState.Disabled:case u.LoginState.SignedOut:case u.LoginState.Offline:this.setContent(this.notLoggedInContent),this.notLoggedInContent.setProps({state:this.currentState.loggedInState,error:r.inject.login.signInErrorMessage}),this.setBackground(16771498,1);break;case u.LoginState.SigningIn:case u.LoginState.SignInEmailSent:this.setContent(this.loggingInContent),this.loggingInContent.setProps(this.currentState),this.clearCustomBackground()}}}t.LoginWidget=x;const T="[b]Sign in[/b] to [b]backup your progress[/b] and share it between devices!";class P extends n.AutoHeightResponsiveContainer{constructor(e){super(e);const t=o.UiBuilder.for(this.scene);this.warningPrompt=t.richText(T,a.Colors.glassUi_old.primaryText),this.warningPrompt.setStyle({halign:"center"}),this.kongregateLoginButton=t.outlineButton({text:"Sign in",onClicked:()=>{b.Kongregate.showSignInBox()},theme:"dark"}),this.buttons=new p.ResponsiveDOMContent(this.scene,"login-buttons"),this.buttons.addListener("click"),this.buttons.on("click",(e=>{const t=e.target?.id||e.target?.parentElement?.id;switch(h.app.audio.playEffect(g.SoundEffects.ButtonUp),t){case"login-google":s.events.trigger(l.UserActions.SignInWithGoogle());break;case"login-facebook":s.events.trigger(l.UserActions.SignInWithFacebook());break;case"login-email":s.events.trigger(l.UserActions.SignInWithEmail())}})),this.add([this.warningPrompt,this.buttons,this.kongregateLoginButton])}calculateHeight(){return this.kongregateLoginButton.visible?this.kongregateLoginButton.y+this.kongregateLoginButton.height:this.buttons.visible?this.buttons.y+this.buttons.height:this.warningPrompt.y+this.warningPrompt.height}setProps(e){switch(this.kongregateLoginButton.setVisible(!1),e.state){case u.LoginState.LoginFailed:this.warningPrompt.setText(r.inject.login.signInErrorMessage??"Oops! Something went wrong during the sign in process.\n\n[b]Please try again![/b]").setTint(a.Colors.glassUi_old.errorText),this.buttons.setVisible(!0);break;case u.LoginState.Offline:this.warningPrompt.setText("[b]You are offline![/b]\n\nReconnect to the internet in order to sign in.").setTint(a.Colors.glassUi_old.errorText),this.buttons.setVisible(!1);break;case u.LoginState.Disabled:case u.LoginState.SignedOut:default:(0,v.isRunningAt)("kongregate")?(this.warningPrompt.setText("[b]Sign in to your Kongregate account[/b][/area] to [b]backup your progress[/b] and share it between devices!").setTint(a.Colors.glassUi_old.primaryText),this.buttons.setVisible(!1),this.kongregateLoginButton.setVisible(!0)):(this.warningPrompt.setText(T).setTint(a.Colors.glassUi_old.primaryText),this.buttons.setVisible(!0))}this.preUpdate.makeDirty()}updateLayout(){const e=P.extraPadding,t=this.width-2*e;this.warningPrompt.setStyle({...this.warningPrompt.style,wrap:{mode:1,width:t}}),c.Arrange.topToBottom({content:[this.warningPrompt,this.buttons,this.kongregateLoginButton],y:e,origin:0,spacing:20}),c.Arrange.alignX({content:[this.warningPrompt,this.buttons,this.kongregateLoginButton],x:e+t/2,origin:.5}),this.updateSize()}}t.NotLoggedInUi=P,P.extraPadding=0;class I extends n.AutoHeightResponsiveContainer{constructor(e){super(e);const t=o.UiBuilder.for(this.scene);this.label=t.richText("[i]Signing in...[/i]",(e=>e.white)),this.label.setStyle({halign:"center"}),this.cancelButton=new f.StealthButton_LEGACY(e,{content:t.image("ui/mini-close-button").setTint(a.Colors.glassUi_old.backgroundText),width:24,height:24}),this.cancelButton.onClicked((()=>{r.inject.login.cancelSignIn()})),this.add([this.label,this.cancelButton])}calculateHeight(){return this.label.height+40}updateLayout(){this.label.setWordWrapWidth(this.width),this.label.setPosition(this.width/2-this.label.width/2,20),this.cancelButton.setPosition(this.width-this.cancelButton.width+6,-6),this.updateSize()}setProps(e){e.loggedInState===u.LoginState.SignInEmailSent?this.label.setText(`Sign-in link sent to \n\n[b]${e.signupEmail??"the provided address"}[/b]\n\nVisit your inbox to complete the sign-in!`):this.label.setText("[i]Signing in...[/i]"),this.cancelButton.setVisible(e.allowLogout),this.preUpdate.makeDirty()}}t.LoggingInUI=I;class C extends n.AutoHeightResponsiveContainer{constructor(e){super(e);const t=o.UiBuilder.for(this.scene);this.avatar=t.image("ui/avatar"),this.usernameLabel=t.richText("",(e=>e.oceanShades.light3)),this.authProviderLabel=new y.StatusLabel(e),this.logoutButton=t.outlineButton({icon:t.image("ui/button-icons/logout"),theme:"islandCard",variant:"circle",onClicked:()=>{s.events.trigger(l.UserActions.SignOut())}}),this.statusLabel=new y.CloudSyncStatusLabel(this.scene),this.add([this.avatar,this.usernameLabel,this.authProviderLabel,this.logoutButton,this.statusLabel])}calculateHeight(){return this.statusLabel.y+this.statusLabel.height}setProps(e){this.usernameLabel.setText("[b]"+e.userEmail+"[/b]"),this.statusLabel.setSyncState(e.cloudSyncState),this.authProviderLabel.setProps({text:`Signed in with ${e.authProvider}.`,icon:"ui/icons/ok"}),this.logoutButton.setVisible(e.allowLogout)}updateLayout(){this.logoutButton.width=32,this.logoutButton.height=32,c.Arrange.topToBottom({content:[this.avatar,this.authProviderLabel,this.statusLabel],y:0,origin:0,spacing:14}),c.Arrange.alignX({content:[this.authProviderLabel,this.statusLabel],x:(this.avatar.width-this.statusLabel.icon.width)/2,origin:0}),this.usernameLabel.setPosition(54,this.avatar.y+this.avatar.height/2-this.usernameLabel.height/2),this.logoutButton.setPosition(this.width-this.logoutButton.width,this.avatar.y+this.avatar.height/2-this.logoutButton.height/2),this.statusLabel.setSize(this.width,this.logoutButton.height),this.updateSize()}}t.LoggedInUi=C,s.logger.for("LoginWidget")},45664:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexGrid=t.CORNERID_ROW_OFFSET=t.GRID_MAX_DIMENSION=void 0,t.getHex=l,t.getHexes=function(e){return r.getHexes(e)};const s=i(7334),n=i(40020),o=i(11079),a=i(20693);i(56824).logger.for("HexGrid"),t.GRID_MAX_DIMENSION=100,t.CORNERID_ROW_OFFSET=10*t.GRID_MAX_DIMENSION;class r{constructor(){}static getHex(e){if(void 0!==e&&this.isWithinBounds(e,{width:t.GRID_MAX_DIMENSION,height:t.GRID_MAX_DIMENSION}))return(0,o.isOrdinal)(e)?(this._hexes[e]||(this._hexes[e]=new n.Hex(e)),this._hexes[e]):this.getHex(this.toOrdinal(e))}static getAllHexes(e){const t=Array(e.width*e.height).fill(void 0);for(let i=0;i<e.height;++i)for(let s=0;s<e.width;++s)t[i*e.width+s]=(0,o.tabularToOrdinal)({r:i,c:s});return a.HexGroup.from(t.map((e=>l(e))))}static getHexes(e){return a.HexGroup.from(e.map((e=>this.getHex(e))))}static getInnerHexes(e){return this.getAllHexes(e).filter((t=>!this.isHexOnGridBorder(t,e)))}static isWithinBounds(e,t){if((0,o.isTabular)(e))return!(e.c>=t.width||e.c<0||e.r>=t.height||e.r<0);if((0,o.isOrdinal)(e))return this.isWithinBounds((0,o.ordinalToTabular)(e),t);if((0,o.isSpatial)(e))return this.isWithinBounds((0,o.spatialToTabular)(e),t);throw new Error(`HexGrid.isOutOfBounds called with invalid grid position (${(0,s.str)(e)})`)}static isHexOnGridBorder(e,i){return e.id<t.GRID_MAX_DIMENSION||e.id%t.GRID_MAX_DIMENSION===0||e.id%t.GRID_MAX_DIMENSION===i.width-1||Math.floor(e.id/t.GRID_MAX_DIMENSION)===i.height-1}static toOrdinal(e){if((0,o.isOrdinal)(e))return e;if((0,o.isTabular)(e))return(0,o.tabularToOrdinal)(e);if((0,o.isSpatial)(e))return(0,o.tabularToOrdinal)((0,o.spatialToTabular)(e));throw new Error(`HexGrid.toOrdinal called with invalid grid position (${(0,s.str)(e)})`)}static bfs(e,t=()=>!0){let i=[];e.forEach((e=>i.push({hex:e,d:0})));let s=new Set(e);const n=({hex:e,d:n,parent:o})=>{s.add(e),t(e,o,n)&&e.neighbours().filter((e=>!s.has(e))).members.forEach((t=>{s.add(t),i.push({hex:t,d:n+1,parent:e})}))};for(;i.length>0;)n(i.shift())}}function l(e){return r.getHex(e)}t.HexGrid=r,r.upperBound=t.GRID_MAX_DIMENSION*t.GRID_MAX_DIMENSION-1,r._hexes=[]},45920:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getPlugin=function(e){switch(e){case a.PluginKey.Zombies:return s.ZombiesPlugin;case a.PluginKey.AiNoKnights:return n.AiNoKnightsPlugin;case a.PluginKey.NormalDifficultyLevel:return o.NormalDifficultyLevel;case a.PluginKey.PickLandingSpot:return r.PickLandingSpotPlugin;case a.PluginKey.SpawnGifts:return l.SpawnGiftsPlugin;case a.PluginKey.BuyGifts:return c.BuyGiftsPlugin;case a.PluginKey.BuyTowns:return d.BuyTownsPlugin;case a.PluginKey.LowUpkeep:return h.LowUpkeepPlugin;case a.PluginKey.CaptureTowns:return u.CaptureTownsPlugin;case a.PluginKey.AlwaysRetreat:return p.AlwaysRetreatPlugin;default:throw new Error(`Unknown plugin key ${e}`)}};const s=i(76872),n=i(49652),o=i(90386),a=i(18497),r=i(55535),l=i(31371),c=i(83234),d=i(68544),h=i(93209),u=i(83006),p=i(29191)},45933:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playPawnCreated=async function(e,t,i){e.pawns.createOrUpdatePawnObject({id:t.pawnId,type:t.pawnType,jumping:!1,hexId:t.hexId,visible:!0})},i(56824).logger.for("PawnsManager")},45945:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addPlugin=function(e){const t=s.inject.gameStateModel.map.state.plugins;if(t.includes(e))return void console.warn(`Plugin ${e} is already registered, addPlugin call is redundant.`);const i=(0,n.getPlugin)(e);if(a.WorldMap.update(s.inject.currentGameState,{plugins:[...t,e]}),i.onAdded){const e=s.inject.gameStateModel.exportState(),t=i.onAdded(e);s.inject.gameStateModel.restore(t)}},t.removePlugin=function(e){const t=s.inject.gameStateModel.map.state.plugins;if(!t.includes(e))return void console.warn(`Plugin ${e} is not registered, removePlugin call is redundant.`);const i=(0,n.getPlugin)(e);if(a.WorldMap.update(s.inject.currentGameState,{plugins:(0,o.cloneArrayWithout)(t,e)}),i.onRemoved){const t=s.inject.gameStateModel.exportState();t.map.plugins=(0,o.cloneArrayWithout)(t.map.plugins,e);const n=i.onRemoved(t);s.inject.gameStateModel.restore(n)}};const s=i(91622),n=i(45920),o=i(1326),a=i(59956)},46021:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LazyIslandConnection=void 0;const s=i(30353),n=i(54429),o=i(91622);var a=Phaser.Geom.Rectangle;function r(e,t){return{x:e.x,y:e.y+t}}t.LazyIslandConnection=class{constructor(e,t){this.scene=e,this.opts=t}getBoundingBox(){return this.boundingBox||(this.boundingBox=a.FromXY(this.opts.from.x,this.opts.from.y,this.opts.to.x,this.opts.to.y)),this.boundingBox}updateGeometry(e,t){this.opts.from=e,this.opts.to=t,this.boundingBox=void 0,this.line?.updateGeometry(e,t),this.line2?.updateGeometry(r(e,-2),r(t,-2))}async show(){if(this.line)return;const e=o.inject.theme.getCurrent();this.line=new s.DashedLine(this.scene,{...this.opts,color:e.oceanShades.light1}),this.line2=new s.DashedLine(this.scene,{from:r(this.opts.from,-2),to:r(this.opts.to,-2),dashLength:this.opts.dashLength,color:e.oceanShades.light2}),this.line.setDepth(n.OverworldMapLayers.Lines),this.line2.setDepth(n.OverworldMapLayers.Lines),this.scene.add.existing(this.line),this.scene.add.existing(this.line2),this.line2.setVisible(this.opts.unlocked)}destroy(){this.line&&(this.line.destroy(),this.line=void 0),this.line2&&(this.line2.destroy(),this.line2=void 0)}refresh(){this.line&&(this.line.opts.color=o.inject.theme.getCurrent().oceanShades.light1,this.line2.opts.color=o.inject.theme.getCurrent().oceanShades.light2,this.line.redraw(),this.line2.redraw(),this.line2.setVisible(this.opts.unlocked))}}},46099:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StorybookEvents=void 0;const s=i(39420);t.StorybookEvents={SelectStory:(0,s.userAction)()("SELECT_STORY")}},46265:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DropdownsManager=void 0;const s=i(54825),n=i(80959);i(56824).logger.for("dropdowns"),t.DropdownsManager=class{getUIBuilder(){return n.UiBuilder.for(s.app.scene.dropdownUI)}dropdownList(e,t){const i=this.getUIBuilder(),s=i.dropdownListView({theme:"dropdownList"});return s.setItems(t.items),s.setSelection(t.selectedItem),s.width=e().width-2,{cancel:()=>i.scene.closeDropdown(),promise:new Promise((t=>{i.scene.setDropdown(s,e,(()=>t(void 0))),s.onItemSelected((({item:e})=>{i.scene.closeDropdown(!1),t(e)}))}))}}}},46330:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.woodenPrimaryButton=function(e,t){const i=new s.BoxButton(e.scene,{content:c(e,t),width:t.width??200,height:46,baseTexture:n.BoxTextures.DialogButton,downTexture:n.BoxTextures.DialogButtonDown,raised:2});return t.onClicked&&i.onClicked(t.onClicked),i},t.woodenSecondaryButton=function(e,t){return new a.RibbonButton(e.scene,0,0,{type:a.RibbonButtonStyle.Small,content:c(e,t),width:t.width??180,controller:new r.SimpleButtonStateController({onClicked:t.onClicked})})};const s=i(27235),n=i(21941),o=i(96137),a=i(15316),r=i(88389),l=i(96604);function c(e,{text:t,iconPlacement:i,icon:s,tintIcon:n}){const a=new l.IconAndText(e.scene,{text:t?e.wood.caption(t):void 0,spacing:12,tintIcon:!1,layout:"left"===i?l.BUTTON_LAYOUT.iconLeft:l.BUTTON_LAYOUT.iconRight,icon:s?e.image(s):void 0});return n&&a.icon?.setTint(o.Colors.woodenUi.primaryText),a}},46471:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.checkWinLoseConditions=function(e,t){return(0,n.isAISpectatingMode)()?[]:e.map.defeatConditions.test(e.state,t)?[s.GameStateEvents.GameOver({winningFactionId:void 0,state:e.state})]:e.map.winConditions.test(e.state,t)?[s.GameStateEvents.GameOver({winningFactionId:e.factions.localPlayer?.id,state:e.state})]:[]};const s=i(36868),n=i(53360)},46512:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultUserData=void 0;const s=i(54825),n=i(11466),o=i(18811),a=i(56824),r=i(16007),l=i(85072),c=i(19746);t.defaultUserData=()=>({metadata:{cloudSyncUserId:void 0},rememberedChoices:{randomMapOptions:{version:l.MAP_GENERATOR_VERSION,name:a.random.townName(),shape:l.MapShape.Temperate,mode:l.MapMode.Classic,difficulty:l.MapDifficulty.Challenging,size:s.app.device.uiVariant()===n.UiVariant.Compact?l.MapSize.Small:l.MapSize.Medium},aiDifficulty:"normal",feedbackEmail:void 0,spectatingSpeed:r.SpectatingPlaybackSpeed.Normal,cameraFollow:o.CameraFollowPreset.On,rivalAIChatter:"on",rivalsSurrender:!0,preferredTheme:"default",unlockAllIslands:!1,muteSoundEffects:!1},progress:{local:(0,c.createEmptyProgressData)(),synced:(0,c.createEmptyProgressData)()},tutorialsCompleted:{},levelFeedbacksSubmitted:[]})},46735:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PropTransitionController=void 0;const s=i(91622);t.PropTransitionController=class{constructor(e,t,i,s){this.scene=e,this.target=t,this.propName=i,this._targetValue=0,this.defaultTweenOptions={duration:s.duration??500,ease:s.ease??"Sine.easeOut"}}applyValue(e){this.target[this.propName]=e}get currentValue(){return this.target[this.propName]}get targetValue(){return this.tween?this._targetValue:this.currentValue}setTo(e,t="instant"){"instant"===t?(this.stopTransition(),this.applyValue(e)):this.transitionTo(e)}updateTo(e){this.isInTransition()?this.transitionTo(e):this.setTo(e)}transitionTo(e,t){if(s.inject.ui.skipTransitions())return void this.setTo(e);this.tween&&this.tween.stop(),this._targetValue=e;const i=t?{...this.defaultTweenOptions,...t}:this.defaultTweenOptions;this.tween=this.scene.tweens.add({targets:this.target,props:{[this.propName]:{from:this.target[this.propName],to:e}},duration:i.duration,ease:i.ease,onComplete:()=>{this.setTo(e)}})}stopTransition(){this.tween&&(this.tween.stop(),this.tween=void 0)}isInTransition(){return!!this.tween}}},46813:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LandingSpotsView=void 0;const s=i(20754),n=i(90952),o=i(56038),a=i(78635),r=i(20693),l=i(81434),c=i(63521);class d extends s.LazyView{constructor(){super([n.GameState.map,n.GameState.warfare.hexStaticDefense,n.GameState.regions.byHex]),this.name="LandingSpotsView"}calculate(e){let t=o.Regions.getCoastalHexes(e).filter((t=>this._isValidLandingSpot(e,t)));return r.HexGroup.from(t)}_isValidLandingSpot(e,t){return 0===a.Warfare.getHexStaticDefense(e,t.id)&&void 0===a.Warfare.getOccupyingPawn(e,t)&&!l.Pawns.isTraitPresentOnHex(e,t.id,c.PawnTraits.Terrain)}getCacheKey(){return""}}t.LandingSpotsView=d},46914:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugRectangle=void 0;const s=i(76049);var n=Phaser.GameObjects.BitmapText;t.DebugRectangle=class{constructor(e,t=255){this.target=e,this.rect=new Phaser.GameObjects.Rectangle(this.target.scene,0,0,0,0).setStrokeStyle(1,t,1).setOrigin(0,0).setDepth(1e4),this.label=new n(this.target.scene,0,0,s.BitmapFont.Debug).setTint(t).setOrigin(0,0).setDepth(1e4),this.target.parentContainer?this.target.parentContainer.add([this.rect,this.label]):(this.target.scene.add.existing(this.rect),this.target.scene.add.existing(this.label)),this.update()}syncParent(){this.target.parentContainer!==this.rect.parentContainer&&this.target.parentContainer.add([this.rect,this.label])}update(){this.syncParent();const e=this.target.displayWidth??this.target.width,t=this.target.displayHeight??this.target.height;this.rect.setPosition(this.target.x,this.target.y),this.rect.setSize(e,t),this.label.setPosition(this.target.x,this.target.y-12),this.label.setText(`${this.target.constructor.name}: ${e}x${t}`)}setVisible(e){this.rect.setVisible(e),this.label.setVisible(e)}}},46973:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoundedRectButton=void 0;const s=i(86545),n=i(55275),o=i(2426),a=i(7548),r=i(22663),l=i(83176),c=i(18957),d=i(96137),h=e=>({[r.ButtonState.Rest]:{line:{color:e.oceanContrastLight},content:{color:e.oceanContrastLight}},[r.ButtonState.Disabled]:{line:{color:e.oceanContrastLight,alpha:.3},content:{color:e.oceanContrastLight,alpha:.3}},[r.ButtonState.Hover]:{line:{color:e.oceanContrastLight},content:{color:e.oceanContrastLight},fill:{color:e.oceanShades.light2,alpha:.5}},[r.ButtonState.Down]:{line:{color:e.oceanContrastLight},content:{color:e.oceanContrastLight},fill:{color:e.oceanShades.light3}}});class u extends s.BaseResponsiveContainer{get content(){return this.props().content}get onClicked(){return this.controller.onClicked}constructor(e,t){super(e),this.buttonState=r.ButtonState.Rest,this.onStateChanged=(0,c.signal)(),this.theme=(0,a.themer)(this,h),this.roundedRect=new o.RoundedRect(this.scene,{radius:t.radius??8,bevel:t.bevel}),this.props=(0,n.stateContainer)(t,this.applyState.bind(this)),this.add(this.roundedRect),this.setController((0,l.setupController)(t)),this.setInteractiveAuto(),this.props.apply(),this.theme.use((e=>{const{fill:t,line:i,content:s}=e[this.buttonState];i?this.roundedRect.setLineStyle(i.color,1,i.alpha??1):this.roundedRect.setLineStyle(0,0,0),t?this.roundedRect.setFillStyle(t.color,t.alpha??1):this.roundedRect.setFillStyle(0,0),s&&this.content.setTextColor?.(s)}))}setEnabled(e){return this.props.update({disabled:!e}),this}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.setButtonState(e))))}setButtonState(e){this.buttonState=e,this.onStateChanged.fire(e),this.preUpdate.makeDirty()}setTooltip(e){this.setData("tooltip",e)}applyState(e,t,i,s){void 0!==e.content&&(i.content&&this.remove(i.content),e.content&&this.add(e.content)),void 0!==e.radius&&(this.roundedRect.radius=e.radius),e.theme&&this.theme.set(e.theme),void 0!==e.disabled&&this.controller.setEnabled(!e.disabled),e.width&&(this.width=e.width),e.height&&(this.height=e.height),e.tooltip&&this.setData("tooltip",e.tooltip),e.bevel&&(this.roundedRect.bevel=e.bevel),this.preUpdate.makeDirty()}updateLayout(){const e=this.props().content;this.theme.apply(),this.roundedRect.setSize(this.width,this.height),e.setPosition(0,0),e.width=this.width,e.height=this.height}}t.RoundedRectButton=u,u.Themes={glassUi:e=>({[r.ButtonState.Rest]:{line:{color:d.Colors.glassUi.textMain},content:{color:d.Colors.glassUi.textMain}},[r.ButtonState.Disabled]:{line:{color:d.Colors.glassUi.textLight},content:{color:d.Colors.glassUi.textLight}},[r.ButtonState.Hover]:{line:{color:d.Colors.glassUi.textMain},content:{color:d.Colors.glassUi.textMain},fill:{color:d.Colors.glassUi.textMain,alpha:.5}},[r.ButtonState.Down]:{line:{color:d.Colors.glassUi.textMain},content:{color:d.Colors.glassUi.textMain},fill:{color:d.Colors.glassUi.textMain,alpha:.5}}}),light:h,dark:e=>({[r.ButtonState.Rest]:{line:{color:e.oceanContrastDark},content:{color:e.oceanContrastDark}},[r.ButtonState.Disabled]:{line:{color:e.oceanContrastDark,alpha:.3},content:{color:e.oceanContrastDark,alpha:.3}},[r.ButtonState.Hover]:{line:{color:e.oceanContrastDark},content:{color:e.oceanContrastDark},fill:{color:e.oceanShades.light2}},[r.ButtonState.Down]:{line:{color:e.oceanContrastDark},content:{color:e.oceanContrastDark},fill:{color:e.oceanShades.light3}}}),white:e=>({[r.ButtonState.Rest]:{line:{color:e.white},content:{color:e.white}},[r.ButtonState.Disabled]:{line:{color:e.white,alpha:.3},content:{color:e.white,alpha:.3}},[r.ButtonState.Hover]:{line:{color:e.white},content:{color:e.white},fill:{color:e.oceanShades.light2,alpha:.5}},[r.ButtonState.Down]:{line:{color:e.white},content:{color:e.white},fill:{color:e.oceanShades.light3,alpha:.5}}}),islandCard:e=>({[r.ButtonState.Rest]:{line:{color:e.white,alpha:.1},content:{color:e.white},fill:{color:e.oceanShades.dark3}},[r.ButtonState.Disabled]:{line:{color:e.oceanShades.dark3},fill:{color:e.oceanShades.dark3},content:{color:e.white,alpha:.3}},[r.ButtonState.Hover]:{line:{color:e.white,alpha:.3},content:{color:e.white},fill:{color:e.oceanShades.dark4}},[r.ButtonState.Down]:{line:{color:e.white,alpha:.5},content:{color:e.white},fill:{color:e.oceanShades.dark5}}}),subtle:e=>({[r.ButtonState.Rest]:{line:{color:e.oceanContrastLight,alpha:.1},content:{color:e.white}},[r.ButtonState.Disabled]:{line:{color:e.oceanContrastLight,alpha:.1},content:{color:e.white}},[r.ButtonState.Hover]:{line:{color:e.oceanContrastLight,alpha:.4},content:{color:e.white},fill:{color:e.oceanContrastLight,alpha:.1}},[r.ButtonState.Down]:{line:{color:e.oceanContrastLight,alpha:.4},fill:{color:e.oceanContrastLight,alpha:.2},content:{color:e.white}}}),insetButton:e=>({[r.ButtonState.Rest]:{line:{color:e.oceanContrastLight,alpha:.1},content:{color:e.white}},[r.ButtonState.Disabled]:{line:{color:e.oceanContrastLight,alpha:.1},content:{color:e.white}},[r.ButtonState.Hover]:{line:{color:e.oceanContrastLight,alpha:.4},content:{color:e.white},fill:{color:e.oceanContrastLight,alpha:.1}},[r.ButtonState.Down]:{line:{color:e.white,alpha:.1},content:{color:e.white},fill:{color:e.oceanShades.dark3}}})}},47102:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomMapInTransition=async function(e={}){n.app.scene.titleScreenUI;const t=n.app.scene.randomMapSelect,i=e.duration??s.config.screenTransitionDuration;return new Promise((s=>{t.scene.setVisible(!0),t.preUpdate.force(),e.keepBackgroundPanel?t.mainPanelUI.setVisible(!0):t.mainPanelUI.transitionIn(i),t.startGenerating("up"),t.tweens.add({targets:t.components.filter((e=>e!==t.backButton&&e!==t.levelNamePanel)),props:{x:{getStart:e=>e.x+400,getEnd:e=>e.x},alpha:{from:0,to:1}},duration:i/2,onComplete:s,ease:"Sine.easeOut"}),t.tweens.add({targets:[t.backButton,t.levelNamePanel],props:{alpha:{from:0,to:1}},duration:i/2,ease:"Sine.easeOut"})}))};const s=i(56824),n=i(54825)},47150:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.importReplay=function(e,t){const i=e.steps[0];return s.assert.defined(i?.snapshot,"invalid replay: missing snapshot in initial step"),s.assert.defined(i?.faction,"invalid replay: missing faction in initial step"),o(e.steps,t)};const s=i(97849),n=i(39420);function o(e,t,i=0){const s=[];for(let r of e)if(void 0!==r.faction&&(i=r.faction),s.push({events:null,gameState:null,compressedState:r.snapshot??null,play:r.play&&{...r.play,isTypedEvent:!0,category:n.EventCategory.Play},activeFaction:i,tags:new Set(r.tags),rewinds:r.rewinds&&!t.unpackRewinds?r.rewinds.map((e=>o(e,t,i))):void 0}),t.unpackRewinds&&r.rewinds){const e=a(r.rewinds,i);s.push(...e,{gameState:null,compressedState:null,events:null,tags:new Set,activeFaction:i,rewindSteps:e.length+1})}return s}function a(e,t){let i=[];for(let s of e)i.push(...o(s,{unpackRewinds:!0},t));return i}},47269:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapPanelController=void 0;const s=i(54825),n=i(11466);t.WorldMapPanelController=class{constructor(){this.activePanel=null,this.state=null}updateState(e){this.state=e,this.activePanel?.updateState(this.state)}determineActivePanel(){return this.state?s.app.device.uiVariant()===n.UiVariant.Compact?s.app.scene.playUI.worldMapPanel:(s.app.scene.backgroundUI.worldMapPanel.updatePosition(this.state.text),s.app.scene.backgroundUI.worldMapPanel.baseY<20?s.app.scene.playUI.worldMapPanel:s.app.scene.backgroundUI.worldMapPanel):null}update(){const e=this.determineActivePanel();e!==this.activePanel&&(this.activePanel?.visibility.setTo(0),e&&(e.visibility.setTo(1),e.updateState(this.state)),this.activePanel=e),this.activePanel===s.app.scene.backgroundUI.worldMapPanel&&(this.activePanel.updatePosition(this.state?.text??""),this.activePanel.visibility.applyValue(this.activePanel.visibility.currentValue,this.activePanel.visibility.currentTarget))}}},47273:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexCorner=t.CORNER_HEIGHT=t.CORNER_WIDTH=void 0,t.getHexesByCornerId=r,t.getCornerIdsForHexId=function(e){const t=10*e,i=(0,s.isHexOnEvenRow)(e)?10:0;return[t-5,t,t+5,t+n.CORNERID_ROW_OFFSET-10+i,t+n.CORNERID_ROW_OFFSET-5+i,t+n.CORNERID_ROW_OFFSET+i]},t.getCornerVariant=l,t.getCornerIdFromHexes=function(e,t,i){return 10*e.id},t.isCornerOnEvenRow=c;const s=i(40020),n=i(45664),o=i(87936);t.CORNER_WIDTH=24,t.CORNER_HEIGHT=36;class a{get variant(){return this.id%10==0?"V":"A"}constructor(e){this.id=e,this.isValid=!0,this.sortedHexes=r(this.id),this.sortedHexes[0]&&this.sortedHexes[1]&&this.sortedHexes[2]?(this.y=this.sortedHexes[0].display.centerY,"A"===this.variant?(this.x=this.sortedHexes[0].display.centerX-t.CORNER_WIDTH/2,this.display={x:this.sortedHexes[0].display.centerX,y:this.sortedHexes[0].display.centerY+o.HEX_HEIGHT/2}):(this.x=this.sortedHexes[2].display.centerX-t.CORNER_WIDTH/2,this.display={x:this.sortedHexes[0].display.centerX+o.HEX_WIDTH/2,y:this.sortedHexes[0].display.centerY+.25*o.HEX_HEIGHT})):this.isValid=!1}isEvenRow(){return c(this.id)}static fromId(e){return this.cache[e]||(this.cache[e]=new a(e)),this.cache[e]}}function r(e){const t=c(e)?1:0;return"V"===l(e)?[(0,n.getHex)(e/10-101+t),(0,n.getHex)(e/10-100+t),(0,n.getHex)(e/10)]:[(0,n.getHex)((e-1005)/10+t),(0,n.getHex)((e-5)/10),(0,n.getHex)((e+5)/10)]}function l(e){return e%10==0?"V":"A"}function c(e){return Math.floor(e/n.CORNERID_ROW_OFFSET)%2==0}t.HexCorner=a,a.cache={}},47545:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stealthButton=function(e,{text:t,icon:i,iconPlacement:d,onClicked:h,width:u,height:p,theme:g,tooltip:m,radius:y}){const f=new r.IconAndText(e.scene,{text:t?e.text(t,s.BitmapFont.Mini,0):void 0,spacing:8,layout:"left"===d?r.BUTTON_LAYOUT.iconLeft:r.BUTTON_LAYOUT.iconRight,icon:i?(0,l.createIcon)(e.scene,i):void 0,tintIcon:Boolean(i&&(0,l.isTintAllowed)(i))});return new n.RoundedRectButton(e.scene,{theme:(w=g,e=>{const t={content:{color:c(e,w)}},i="glassUi"===w?a.Colors.glassUi.textLight:e.oceanShades.light3;return{[o.ButtonState.Rest]:t,[o.ButtonState.Disabled]:t,[o.ButtonState.Hover]:{...t,fill:{color:i,alpha:.5}},[o.ButtonState.Down]:{...t,fill:{color:i,alpha:1}}}}),content:f,onClicked:h,width:u??(f.text?.width??0)+(f.icon?.width??0)+8,height:p,tooltip:m,radius:y});var w};const s=i(76049),n=i(46973),o=i(22663),a=i(96137),r=i(96604),l=i(36257);function c(e,t){switch(t){case"light":return e.oceanContrastLight;case"dark":return e.oceanContrastDark;case"white":return e.white;case"glassUi":return a.Colors.glassUi.textMain}}},47618:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IslandCardControls=void 0;const s=i(86545),n=i(46973),o=i(1187),a=i(80959),r=i(76049),l=i(20087),c=i(54825),d=i(98963),h=i(96604);class u extends s.AutoWidthResponsiveContainer{constructor(e){super(e),this.ui=a.UiBuilder.for(this.scene),this.primaryButton=new n.RoundedRectButton(this.scene,{height:36,radius:18,content:new h.IconAndText(this.scene,{layout:h.BUTTON_LAYOUT.iconLeft,tintIcon:!0,icon:this.ui.image("ui/button-icons/rewind"),text:this.ui.text("...",r.BitmapFont.Mini,0),spacing:4}),theme:n.RoundedRectButton.Themes.islandCard,onClicked:()=>{c.app.audio.playEffect(d.SoundEffects.ButtonDown),this.actions[0]?.onClick()}}),this.secondaryButtons=new o.GameObjectList(((e,t,i)=>(i?i.content.setIcon(e.icon):((i=new n.RoundedRectButton(this.scene,{height:30,width:30,radius:15,content:new h.IconAndText(this.scene,{layout:h.BUTTON_LAYOUT.iconLeft,tintIcon:!0,icon:this.ui.image(e.icon),spacing:0}),theme:n.RoundedRectButton.Themes.islandCard,onClicked:()=>{}})).setData("tooltipDelay",100),this.add(i)),i.onClicked.unsubscribeAll(),i.onClicked((()=>{c.app.audio.playEffect(d.SoundEffects.ButtonDown),e.onClick()})),i.setData("tooltip",e.label),i))),this.actions=[],this.add([this.primaryButton]),this.height=36}setActions(e){this.actions=e;const t=e[0];t?(this.primaryButton.setVisible(!0),this.primaryButton.content.setIcon(t.icon),this.primaryButton.content.setText(t.label)):this.primaryButton.setVisible(!1),this.secondaryButtons.set(e.slice(1)),this.preUpdate.makeDirty()}calculateWidth(){const e=this.secondaryButtons.get()[this.secondaryButtons.length-1]??this.primaryButton;return e.x+e.width}updateLayout(){const e=(this.primaryButton.content.text?.displayWidth??0)+40;this.primaryButton.width=e,this.primaryButton.setPosition(0,0),l.Arrange.leftToRight({content:this.secondaryButtons.get(),spacing:4,x:this.primaryButton.width+8}),l.Arrange.alignY({content:this.secondaryButtons.get(),y:this.primaryButton.height/2}),this.updateSize()}}t.IslandCardControls=u},47668:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BulletPoint=void 0;var i=Phaser.GameObjects.Ellipse;t.BulletPoint=class extends i{constructor(e,t){super(e,0,0,t,t),this.setStrokeStyle(0),this.setOrigin(0,0)}setTint(e){return this.setFillStyle(e),this}clearTint(){return this}}},47671:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FearView=void 0,t.calculateFear=p;const s=i(90952),n=i(20754),o=i(70712),a=i(56824),r=i(7334),l=i(76439),c=i(29322),d=i(2543),h=i(9292);a.logger.for("FearView");class u extends n.LazyView{constructor(){super([s.GameState.ai.powerByRegion,s.GameState.ai.credit]),this.name="fear"}calculate(e,{fromFactionId:t,towardsFactionId:i}){return p({myPower:o.AI.getFactionScaledPower(e,t),enemyPower:o.AI.getFactionScaledPower(e,i)})}getCacheKey(e){return`${e.fromFactionId}->${e.towardsFactionId}`}getDebugLayer(e){return new l.GameStateDebugLayer((0,c.factionBasedAdapter)({getValue:(t,i)=>{if(i!==e)return(0,r.withSign)((0,d.round)(this.get(t,{towardsFactionId:e,fromFactionId:i})))},getDetail:(t,i)=>{if(i!==e)return`my power ${o.AI.getFactionScaledPower(t,i)} vs their ${o.AI.getFactionScaledPower(t,e)} => ${(0,r.withSign)(this.get(t,{fromFactionId:i,towardsFactionId:e}))}`}}))}}function p({myPower:e,enemyPower:t}){const i=.75*(e/t-1);return i<0?Math.floor((0,h.pickSmaller)(200*-i,100)):Math.floor((0,h.pickLarger)(100*-i,-100))}t.FearView=u},47841:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.exportReplay=function(e,t){let i=0;e.length>t.sizeLimit&&(i=e.length-t.sizeLimit);let s=[];for(let n=i;n<e.length;++n)s.push(...l(e[n],t,d(e,n,n-i,t)));return{meta:{title:t.title,aiDifficulty:t.aiDifficulty,timestamp:t.timestamp??Date.now(),remainingLives:o.inject.levelSession.remainingLives,victoryTurn:t.victoryTurn},steps:s}};const s=i(36868),n=i(34564),o=i(91622),a=[s.Plays.EndTurn,s.Plays.AcceptSurrender,s.Plays.BanditsAct,s.Plays.MovePawn,s.Plays.BuyPawn,s.Plays.SpawnUnits],r=new Set(a.map((e=>e.eventName)));function l(e,t,i){if(e.rewindSteps)throw new Error("Attempt to serialize replay with unpacked rewinds!");return[{play:c(e.play),snapshot:i,tags:e.tags.size?Array.from(e.tags):void 0,faction:e.activeFaction,rewinds:h(e,t)}]}function c(e){if(e){if(!r.has(e.name))throw new Error(`Unable to serialize ${(0,n.describeEventVerbose)(e)}`);return{name:e.name,payload:e.payload}}}function d(e,t,i,s){if(function(e,t,i,s){if(s.snapshotPolicy.includes("preserve")&&e[t].compressedState)return!0;if(s.snapshotPolicy.includes("initial")&&0===i)return!0;if(s.snapshotPolicy.includes("final")&&t===e.length-1)return!0;const n=e[t],o=e[t+1];return!(!s.snapshotPolicy.includes("p1-start")&&!s.snapshotPolicy.includes("p1-rewind-checkpoints")||1!==n.activeFaction||!n.tags.has("turnStart"))||!(!s.snapshotPolicy.includes("p1-rewind-checkpoints")||1!==n.activeFaction||!o?.tags.has("turnStart"))}(e,t,i,s))return s.gameStateSerializer(t)}function h(e,t){if(!e.rewinds||!t.includeRewinds)return;let i=[];for(let s of e.rewinds)i.push(s.flatMap((e=>l(e,t,void 0))));return i}},48042:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionModel=void 0;const s=i(20693),n=i(29172),o=i(24598),a=i(56038),r=i(19618),l=i(61634),c=i(68778),d=i(81434),h=i(45664),u=i(78635),p=i(45084),g=i(1326),m=i(64884),y=i(9292),f=i(91622),w=i(63521),v=i(89764),b=i(19506);class S extends c.BaseEntityModel{constructor(){super(...arguments),this._hexes=(0,n.lazyAdapter)({source:()=>a.Regions.getRegionHexes(this.state,this.id),transform:e=>(0,h.getHexes)(e.toArray())}),this.getTownHexes=(0,n.lazyAdapter)({source:()=>l.Economy.getTownHexesByRegion(this.state,this.id),transform:e=>(0,h.getHexes)(e.toArray())}),this.getBorderHexes=(0,n.lazyAdapter)({source:()=>a.Regions.getRegionEdgeHexes(this.state,this.id),transform:e=>(0,h.getHexes)(e.toArray())}),this.getHostileBorderHexes=(0,n.lazyAdapter)({source:()=>a.Regions.getRegionBorderHexes(this.state,this.id),transform:e=>(0,h.getHexes)(e.toArray())}),this.getPawns=(0,n.lazyAdapter)({source:()=>d.Pawns.getByRegion(this.state,this.id),transform:e=>e.map((e=>d.Pawns.model(this.state).byId(e)))}),this.getAssets=(0,n.lazyAdapter)({source:()=>this.state,transform:e=>p.CurrentPhase.model(e).faction===this.faction?v.RegionAssets.fromMyRegion(this):v.RegionAssets.fromEnemyRegion(this)}),this.getMyAssets=(0,n.lazyAdapter)({source:()=>this.state,transform:e=>v.RegionAssets.fromMyRegion(this)}),this.getEnemyAssets=(0,n.lazyAdapter)({source:()=>this.state,transform:e=>v.RegionAssets.fromEnemyRegion(this)})}get name(){return a.Regions.getRegionData(this.state,this.id)?.name||""}get exists(){return!!a.Regions.getRegionData(this.state,this.id)}get hexes(){return this._hexes()}get fortification(){return u.Warfare.getRegionFortification(this.state,this.id)}getNeighbours(){let e=new Set;for(let t of this.getHostileBorderHexes().neighbours()){const i=this.parentModel.byHex(t);i&&e.add(i)}return e.delete(this),Array.from(e)}getGeography(){return f.inject.views.regionGeography.get(this.state,this.id)}getMySafeAssets(e,t){return v.RegionAssets.safeAssetsFromMyRegion(this,e,t)}get faction(){const e=r.Factions.getByRegion(this.state,this.id);if(void 0!==e)return r.Factions.model(this.state).byId(e)}get budget(){return l.Economy.getRegionBudget(this.state,this.id)}get treasury(){return l.Economy.getTreasuryOf(this.state,this.id)}isBankrupt(){return this.treasury+this.budget.balance<0}get forecast(){return this.isAlive()?f.inject.views.regionForecast.get(this.state,this.id):0}get size(){return a.Regions.getRegionHexes(this.state,this.id)?.size||0}get rawPower(){return a.Regions.getRegionPower(this.state,this.id).rawTotal}get scaledPower(){return a.Regions.getRegionPower(this.state,this.id).scaledTotal}getUnitsByMight(e=()=>!0){return this.faction&&this.faction?.controller!==o.FactionController.None&&this.isAlive()?m.UnitsByMight.fromUnitList(u.Warfare.model(this.state).getUnitsByRegion(this).filter(e).map((e=>e.might)).sort(g.ascendingSortFn)):m.UnitsByMight.empty}getMovableUnitsByMight(){return this.getUnitsByMight((e=>p.CurrentPhase.isMovable(this.state,e.id)))}isAlive(){return l.Economy.isRegionAlive(this.state,this.id)}isActionable(){const e=this.getMovableUnitsByMight(),t=e.getStrongest(),i=Math.floor(this.treasury/10),s=(0,y.pickLarger)(t,i),n=(0,y.pickLarger)(e.getStrongestLightUnit(),3===i?2:i);if(0===s)return!1;const o=u.Warfare.model(this.state);return this.hexes.find((e=>!o.getOccupyingUnit(e)||!!o.getOccupyingUnit(e)?.hasTrait(w.PawnTraits.Pest)))||o.getConquerableHexes(this,s,n).length>0}getLevel(){return this.getPawns().some((e=>e.type===o.PawnType.UniqueHero))?4:this.isBankrupt()?1:(0,y.cropNumber)(this.getAssets().getMaxAvailableMight()??1,1,4)}addHexes(e){return this.state=a.Regions.addHexesToRegion(this.state,this.id,e.toIdsArray()),this}removeHexes(e){return this.state=a.Regions.removeHexesFromRegion(this.state,e.toIdsArray()),this}absorbRegions(e){if(e.includes(this))throw new Error(`Invalid absorbRegion arguments - region ${this} cannot absorb itself`);return this.addHexes(s.HexGroup.union(e.map((e=>e.hexes)))),this.parentModel.destroy(...e),this}splitIntoComponents(){return a.Regions.splitRegionIntoComponents(this.state,this.id),this}toString(){return`[Region #${this.id} (${b.GLYPH.factions[this.faction?.id??0]} ${this.hexes.length})]`}sameRegionNeighboursOf(e){return a.Regions.getSameRegionNeighbours(this.state,e)}isControllable(){return this.faction?.id===p.CurrentPhase.getFaction(this.state)&&this.getTownHexes().length>0}}t.RegionModel=S},48063:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverworldIslandPreview=t.PREVIEW_HEX_INNER_HEIGHT=t.PREVIEW_HEX_HEIGHT=t.PREVIEW_HEX_WIDTH=void 0;var s=Phaser.GameObjects.Container;const n=i(59956),o=i(18957),a=i(66143),r=i(70033),l=i(69302),c=i(80959),d=i(76049),h=i(96137),u=i(7334),p=i(7782),g=i(56824),m=i(2543),y=i(56887);function f(e){let t=e.levelStatus;switch(e.showGameState&&(t=a.LevelStatus.InProgress),g.config.editOverworld&&(t=a.LevelStatus.Unlocked),t){case a.LevelStatus.Locked:return y.IslandPreviewDisplayMode.Outline;case a.LevelStatus.GoldMedal:case a.LevelStatus.SilverMedal:return y.IslandPreviewDisplayMode.Conquered;case a.LevelStatus.InProgress:case a.LevelStatus.Unlocked:return y.IslandPreviewDisplayMode.Default}}function w(e){switch(e){case a.LevelStatus.GoldMedal:return r.LevelIcons.Gold;case a.LevelStatus.SilverMedal:return r.LevelIcons.Silver;case a.LevelStatus.InProgress:case a.LevelStatus.Unlocked:return r.LevelIcons.Fighting;default:return}}g.logger.for("IslandPreview"),t.PREVIEW_HEX_WIDTH=12,t.PREVIEW_HEX_HEIGHT=12,t.PREVIEW_HEX_INNER_HEIGHT=9,t.OverworldIslandPreview=class extends s{constructor(e,t){super(e),this.props=t,this.onClicked=(0,o.signal)();const i=n.WorldMap.model(t.gameState);this.visibility=p.Control.propOf(this,"alpha"),this.visibility.setTo(0),this.renderTexture=new y.IslandPreview(e),this.renderTexture.setData("islandId",i.levelId),this.pergamen=new l.SmallPergamen(e),this.levelTitle=c.UiBuilder.for(e).text("?",d.BitmapFont.Mini,h.Colors.woodenUi.primaryText),this.pergamen.setContent(this.levelTitle),this.add([this.renderTexture,this.pergamen]),this.redraw()}setSelected(e){this.props.selected!==e&&(this.props.selected=e,this.redraw())}setProps(e,t=!1){(0,u.isShallowEqual)((0,m.omit)(this.props,"gameState"),(0,m.omit)(e,"gameState"))&&!t||(this.props=e,this.redraw())}redraw(){if(this.renderTexture.setInteractive({cursor:this.props.levelStatus===a.LevelStatus.Locked?"default":"pointer"}),this.renderTexture.redraw({gameState:this.props.gameState,displayMode:f(this.props),outline:this.props.selected?y.IslandOutline.Highlighted:y.IslandOutline.Default,overlayIcon:w(this.props.levelStatus)}),this.props.selected||(e=this.props.levelStatus)===a.LevelStatus.GoldMedal||e===a.LevelStatus.SilverMedal||e===a.LevelStatus.Unlocked||e===a.LevelStatus.InProgress){const e=a.LevelModel.for(n.WorldMap.model(this.props.gameState).levelId).getTitle(a.LevelTitleStyle.Short);this.levelTitle.setText(e),0===this.pergamen.visibilityController.currentTarget&&this.pergamen.showAt(this.renderTexture.width/2,this.renderTexture.height/2)}else this.pergamen.hide();var e}}},48087:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionDiplomacyScoreView=void 0;const s=i(90952),n=i(20754),o=i(70712),a=i(56824),r=i(7334),l=i(76439),c=i(29322),d=i(91622),h=i(19618),u=i(9292);a.logger.for("FearView");class p extends n.LazyView{constructor(){super([s.GameState.ai.powerByRegion,s.GameState.ai.credit]),this.name="factionDiplomacyScore"}calculate(e,t){const i=this.getComponents(e,t);if(0===i.length)return 1e6;const s=i.map((e=>e.effect)).reduce(u.sum,0)/(0,u.pickLarger)(1,d.inject.views.powerBalance.get(e).totalPower-o.AI.getFactionScaledPower(e,t));return(0,u.deltaToMultiplier)(s)}getComponents(e,t){const i=h.Factions.model(e);return i.byId(t),i.all().filter((e=>e.id!==t&&e.isAlive()&&!e.isNeutral())).map((i=>{const s=(0,u.cropNumber)(o.AI.getFactionCredit(e,i.id,t)/100,-1,1),n=1-o.AI.getFactionFear(e,t,i.id)/100,a=o.AI.getFactionAttrition(e,t,i.id)+o.AI.getFactionAttrition(e,i.id,t)>5,r=a?-.5:1,l=Math.min(s,n,r)*o.AI.getFactionScaledPower(e,i.id);return{factionId:i.id,effect:l,creditStrength:s,fearCap:n,isAtWar:a,warCap:r}}))}getCacheKey(e){return e}getDebugLayer(){return new l.GameStateDebugLayer((0,c.factionBasedAdapter)({getValue:(e,t)=>this.get(e,t).toFixed(2),getDetail:(e,t)=>(0,r.prettyPrintObject)(this.getComponents(e,t))}))}}t.FactionDiplomacyScoreView=p},48107:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.titleOutTransition=async function(e={}){const t=n.app.scene.titleScreenUI;await new Promise((i=>{const o=e.duration??s.config.screenTransitionDuration,a=t.buttonsPanel.buttons.filter(((t,i)=>i!==e.excludeButton));e.keepWorldMap||n.app.scene.worldMap.cameraController.panAway("up",o),t.tweens.add({targets:[...a,t.resumeButton],props:{x:"+="+(n.app.device.screenWidth-t.background.leftBorder.x),alpha:{from:1,to:0}},duration:o,delay:t.tweens.stagger(30,{}),ease:"Sine.easeIn",onComplete:i}),t.tweens.add({targets:[t.gameLogo],props:{alpha:0},duration:o,ease:"Sine.easeOut"}),n.app.scene.titleScreenFooterUI.transitionOut(o),void 0!==e.excludeButton&&t.tweens.add({targets:t.buttonsPanel.buttons[e.excludeButton],props:{alpha:{from:1,to:0}},duration:o,ease:"Sine.easeOut"}),e.keepBackgroundPanel||t.background.transitionOut(o)}))};const s=i(56824),n=i(54825)},48379:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayMenuUIScene=t.PLAY_MENU_LAYOUT=void 0,t.getPreviousBestTurns=x,t.getLevelDetailItems=P;const s=i(55275),n=i(30948),o=i(93868),a=i(81700),r=i(49314),l=i(7782),c=i(56824),d=i(897),h=i(11466),u=i(54825),p=i(70785),g=i(91622),m=i(66143),y=i(37320),f=i(24040),w=i(20087),v=i(12605),b=i(99847);t.PLAY_MENU_LAYOUT={[h.UiVariant.Large]:{padding:h.DEFAULT_CONTENT_PADDING,controlPanel:{padding:20,paddingBottom:8,paddingAfterIcon:12,horizontalMargin:10,bottomMargin:0,buttonSpacing:16,backButtonWidth:150,cornerRadius:8},buttonsVerticalSpacing:12},[h.UiVariant.Compact]:{padding:h.DEFAULT_CONTENT_PADDING,controlPanel:{padding:12,paddingAfterIcon:12,paddingBottom:12,horizontalMargin:0,cornerRadius:0,buttonSpacing:12,backButtonWidth:146},buttonsVerticalSpacing:8}};class S extends n.BaseUIScene{constructor(){super({key:a.Scenes.PlayMenuUI,bounds:o.BOUNDS.MenuPanel}),this.currentState=(0,s.stateContainer)({open:!1},((e,t,i,s)=>{void 0!==e.open&&(this.bgPanel.visibility.setTo(e.open?1:0,s),this.visibility.setTo(e.open?1:0,s))})),this.preUpdate=(0,d.whenDirty)((()=>{const e=this.getLayout();this.bgPanel.width=this.bounds.width,this.bgPanel.height=this.bounds.height,this.bgPanel.setAnchor(this.getAnchor()),this.bgPanel.updateLayout(),this.toolButtonsPanel.updateLayout(),this.toolButtonsPanel.setPosition(this.bounds.width-e.padding-this.toolButtonsPanel.width,e.padding),this.toolButtonsPanel.setVisible(u.app.device.uiVariant()===h.UiVariant.Large);const t=this.bounds.width-2*e.padding;this.detailsPanel.updateLayout();const i=this.bounds.height-3*e.padding-this.controlPanel.height-this.detailsPanel.height;this.headingPanel.height=i<250?100:250,this.headingPanel.updateLayout(),w.Arrange.topToBottom({content:[this.headingPanel,this.detailsPanel],y:e.padding,spacing:e.padding,origin:0}),w.Arrange.alignX({content:[this.headingPanel,this.detailsPanel],x:e.padding,origin:0,width:t});const s=e.controlPanel.horizontalMargin,n=this.bounds.width-2*s;this.controlPanel.width=n,this.controlPanel.updateLayout(),this.controlPanel.setPosition(s,this.getControlPanelY());const o=this.currentState().open?1:0;this.visibility.currentTarget!==o&&this.visibility.setTo(o)}))}get contentHeight(){return this.detailsPanel.y+this.detailsPanel.height+this.getLayout().padding+this.controlPanel.height}getLayout(){return t.PLAY_MENU_LAYOUT[u.app.device.uiVariant()]}create(){super.create(),(0,v.makeSceneScrollable)(this),this.bgPanel=new r.VerticalStripePanel(this),this.headingPanel=new y.HeadingPanel(this),this.controlPanel=new p.ControlPanel(this).setScrollFactor(0),this.detailsPanel=new f.DetailsPanel(this),this.toolButtonsPanel=new b.ToolButtonsPanel(this),this.visibility=new l.TransitionController(this,{ease:"Sine.easeOut",duration:c.config.screenTransitionDuration,applyValue:e=>{this.controlPanel.setAlpha(e),this.controlPanel.updateLayout();const t=this.getControlPanelY(),i=this.bounds.height-t;this.controlPanel.y=this.getControlPanelY()+(1-e)*i,this.headingPanel.setAlpha(e),this.detailsPanel.setAlpha(e),this.toolButtonsPanel.setAlpha(e)}}),this.addAll([this.bgPanel,this.toolButtonsPanel,this.headingPanel,this.detailsPanel,this.controlPanel])}updateContent(){const e=g.inject.gameStateModel,t=m.LevelModel.for(g.inject.levelSession.levelId),i=e.currentPhase.turnNumber,s=!e.currentPhase.faction?.isLocalPlayer()||u.app.scene.play.cursor.canUndo();this.controlPanel.props.update({turn:i,difficulty:g.inject.levelSession.aiDifficulty,isFixedDifficulty:g.inject.levelSession.isFixedDifficulty,previousBest:x(),rewindsLeft:g.inject.levelSession.remainingLives,firstMove:1===i&&!s,isPlayerTurn:e.currentPhase.isLocalPlayerTurn()}),this.headingPanel.props.update({expeditionIcon:t.getIcon(),expeditionTitle:t.getContextTitle(),levelName:t.getTitle(m.LevelTitleStyle.Short)});const n=e.map.author?`\n(by ${e.map.author})`:"";this.detailsPanel.props.update({levelDescription:e.map.description??"An unexplored island ripe for conquest!"+n,items:P(t)}),this.toolButtonsPanel.updateContent(t),this.preUpdate.makeDirty()}getControlPanelY(){return this.bounds.height-this.controlPanel.height}getAnchor(){return 0===this.bounds.x&&this.bounds.width===u.app.device.screenWidth?"fullscreen":0===this.bounds.x?"left":"center"}transitionOut(){this.bgPanel.visibility.transitionTo(0),this.visibility.transitionTo(0)}}function x(){const e=m.LevelModel.for(g.inject.levelSession.levelId).userVictoryRecord;if(!e)return;const t=g.inject.levelSession.aiDifficulty,i=e.difficulty??"hard";return"hard"===t||i===t?e.turns:void 0}t.PlayMenuUIScene=S;const T=["new","difficulty-normal","difficulty-hard"];function P(e){const t=g.inject.gameStateModel;let i=[];return t.map.winConditions.list().forEach((e=>{i.push({icon:"ui/level-features/difficulty-hard",text:"To win: "+e.getDescription(t.state)})})),e.getFeatures().filter((e=>!T.includes(e.id))).forEach((e=>{i.push({icon:`ui/level-features/${e.id}`,text:e.description,helpDocument:e.helpDocument})})),i}},48694:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TitleScreen=void 0;const s=i(95568),n=i(81700),o=i(36868),a=i(28361),r=i(85026),l=i(42880),c=i(71021),d=i(63521),h=i(48107),u=i(33226),p=i(66143),g=i(63460),m=i(25e3),y=i(11466),f=i(91622),w=i(54825),v=i(30484),b=i(56824),S=i(30963);class x extends s.BaseScreen{constructor(){super("Title",[n.Scenes.WorldMap,n.Scenes.TitleScreenUI,n.Scenes.MenuHeaderUI,n.Scenes.TitleScreenFooterUI]),this.autoSavedState=void 0,this.lockOrientation=!0,this.observe.event(o.UserActions.GoToExpeditions,(async()=>{w.app.navigator.goTo(w.app.screen.expeditions)})),this.observe.event(o.UserActions.ResumeGame,(()=>{this.autoSavedState&&b.events.trigger(o.UserActions.PlayLevel({levelId:this.autoSavedState.map.levelId,origin:"title/continue"}))})),this.observe.event(o.UserActions.SyncWithModel,(()=>{w.app.scene.worldMap.syncState()}))}async activate(e,t){await super.activate(e,t),m.NewsBox.show(),w.app.scene.menuHeaderUI.currentState.update({header:!1,footer:{backButton:!1}}),w.app.scene.titleScreenFooterUI.state.update({viewReplayButton:!1}),await this.loadAutosaveMetadata()}deactivate(){m.NewsBox.hide()}async transitionOut(e){e===w.app.screen.play?await(0,h.titleOutTransition)({keepWorldMap:!0}):e===w.app.screen.expeditions?await(0,h.titleOutTransition)({keepWorldMap:!1,excludeButton:0}):e===w.app.screen.myLibrary&&await(0,h.titleOutTransition)({keepWorldMap:!1,excludeButton:2})}async transitionIn(e){let t=e===w.app.screen.play;w.app.scene.worldMap.scene.setVisible(t),t&&w.app.scene.worldMap.setMode(new l.PreviewMode),e===w.app.screen.randomMapSelect?await(0,g.randomMapSelectToTileTransition)():await(0,u.titleInTransition)(),t||this.loadLevel()}async loadAutosaveMetadata(){const e=f.inject.levelSession.getInProgressLevelRecord();if(e)try{this.autoSavedState=(0,r.decodeGameState)(e.currentGameState);const t=p.LevelModel.for(e.sessionData.levelId);return void w.app.scene.titleScreenUI.state.update({resumeButton:{enable:!0,levelName:t.getTitle(p.LevelTitleStyle.Full),turnNumber:e.turnNumber,difficulty:t.manifest?.fixedAIDifficulty?void 0:e.sessionData.aiDifficulty}})}catch(t){b.errors.handleNonFatalError("failed to load level "+e.sessionData?.levelId+`: ${t}`,"loadAutosaveMetadata"),w.app.scene.titleScreenUI.state.update({resumeButton:{enable:!1}})}w.app.scene.titleScreenUI.state.update({resumeButton:{enable:!1}})}async loadLevel(){let e=this.autoSavedState??(0,r.decodeGameState)(a.BUILT_IN_MAPS.titleScreenLevel);f.inject.gameStateController.loadState(e,c.NewGameStateContext.Preview),w.app.scene.worldMap.cameraController.zoomController.zoomTo(S.DEFAULT_CAMERA_ZOOM,"instant"),w.app.scene.worldMap.setMode(new l.PreviewMode),w.app.scene.worldMap.syncState(f.inject.currentGameState,v.OverlayModes.disabled),w.app.device.uiVariant()===y.UiVariant.Large&&w.app.scene.worldMap.cameraController.panIntoCenter("up"),w.app.scene.worldMap.scene.setVisible(!0),f.inject.gameStateModel.pawns.select({traits:[d.PawnTraits.Unit]}).map((e=>w.app.scene.worldMap.pawns.getById(e.id))).forEach((e=>e?.startJumping()))}}t.TitleScreen=x,x.Layout={buttons:{height:63,spacing:14,maxWidth:280}}},48783:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Messages=void 0,t.isMessage=function(e){return(0,s.isEvent)(e)&&e.category===s.EventCategory.IFrame};const s=i(39420);function n(){return(0,s.createEventFactory)(s.EventCategory.IFrame)}t.Messages={ReadyToReceiveReplay:n()("READY_TO_RECEIVE_REPLAY"),LoadReplay:n()("LOAD_REPLAY"),GoToTurn:n()("GO_TO_TURN")}},48884:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createThemedStyleElement=function(){const e=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(e),s.inject.theme.use((t=>{e.innerHTML=`\n            \n            input.game {\n                height: 32px;\n            }\n            \n            input.game,\n            textArea.game {\n                box-sizing: border-box;\n                resize:none;\n                pointer-events: auto;\n                padding: 8px;\n                border-radius: 8px;\n                font-size: 10pt;\n                font-family: sans-serif;\n                \n                background-color: #${n.Colors.woodenUi.pergamen.toString(16)};\n                border: 2px solid #${n.Colors.glassUi_old.primaryText.toString(16)};\n            }\n            \n            input.game.themed,\n            textArea.game.themed {\n                background-color: ${n.Colors.toCss(t.oceanShades.dark4)};\n                border: 1px solid ${n.Colors.toCss(t.white,.1)};\n                color: ${n.Colors.toCss(t.white)};\n            }\n            \n            input.game.themed::placeholder,\n            textArea.game.themed::placeholder {\n                color: ${n.Colors.toCss(t.white,.3)};\n            }\n            \n            /* Override for browser custom styling after using autocomplete */\n            input.game.themed:-webkit-autofill,\n            input.game.themed:-webkit-autofill:hover,\n            input.game.themed:-webkit-autofill:focus,\n            textarea.game.themed:-webkit-autofill,\n            textarea.game.themed:-webkit-autofill:hover,\n            textarea.game.themed:-webkit-autofill:focus,\n            select.game.themed:-webkit-autofill,\n            select.game.themed:-webkit-autofill:hover,\n            select.game.themed:-webkit-autofill:focus {\n              border: 1px ${n.Colors.toCss(t.oceanColor)};\n              -webkit-text-fill-color: ${n.Colors.toCss(t.white)};\n              -webkit-box-shadow: 0 0 0px 1000px ${n.Colors.toCss(t.oceanShades.dark4)} inset;\n              transition: background-color 5000s ease-in-out 0s;\n            }\n            `}))};const s=i(91622),n=i(96137)},49055:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TabButton=void 0;const s=i(86545),n=i(18957),o=i(54825),a=i(98963);var r=Phaser.GameObjects.Graphics;class l extends s.ResponsiveContainer{constructor(e,t,i){super(e),this.themer=t,this.anchor=i,this.onClick=(0,n.signal)(),this.content=void 0,this.selected=!1,this.hovered=!1,this.setInteractiveAuto(),this.on("pointerover",(()=>{this.hovered=!0,this.updateContentStyle()})),this.on("pointerout",(()=>{this.hovered=!1,this.updateContentStyle()})),this.on("pointerdown",(()=>{o.app.audio.playEffect(a.SoundEffects.ButtonDown),this.onClick.fire()})),this.on("pointerup",(()=>{o.app.audio.playEffect(a.SoundEffects.ButtonUp)})),this.highlight=new r(e).setVisible(!1),this.add(this.highlight),this.themer.use((e=>{this.updateStyles(e)}))}setContent(e){this.content=e,this.add(e),this.updateContentStyle()}updateStyles(e=this.themer.get()){this.updateContentStyle(e);const t=e.lineColor,i=.125;this.highlight.clear(),"left"===this.anchor?this.highlight.fillGradientStyle(t,t,t,t,i,0,i,0):this.highlight.fillGradientStyle(t,t,t,t,i,i,0,0),this.highlight.fillRect(0,0,this.width,this.height)}updateContentStyle(e=this.themer.get()){this.selected||this.hovered?this.content?.setTextColor?.({color:e.lineColor,alpha:1}):this.content?.setTextColor?.({color:e.lineColor,alpha:.75}),this.highlight.setVisible(this.hovered&&!this.selected)}setSelected(e){this.selected!==e&&(this.selected=e,this.updateStyles())}updateLayout(){this.content&&(this.content.setPosition(0,0),this.content.width=this.width,this.content.height=this.height),this.updateStyles()}}t.TabButton=l},49314:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VerticalStripePanel=void 0;const s=i(80959),n=i(91622),o=i(86545),a=i(7782),r=i(56824);class l extends o.BaseResponsiveContainer{constructor(e){super(e),this.visibility=new a.TransitionController(this.scene,{duration:r.config.screenTransitionDuration,ease:"Sine.easeOut",initialValue:0,applyValue:e=>{this.preUpdate.makeDirty()}}),this.anchor="center";const t=s.UiBuilder.for(this.scene);this.mainPanel=t.rectangle(n.inject.theme.getOceanColor(),.9).setScrollFactor(0),this.leftBorder=t.image("glass-ui/card-horizontal-glint").setRotation(Math.PI/2).setScrollFactor(0),this.rightBorder=t.image("glass-ui/card-horizontal-glint").setRotation(Math.PI/2).setScrollFactor(0),this.setInteractiveAuto("default"),this.add([this.mainPanel,this.leftBorder,this.rightBorder]),n.inject.theme.use((e=>{this.mainPanel.setFillStyle(e.oceanColor,.93)}))}setAnchor(e){this.anchor=e,this.preUpdate.makeDirty()}updateLayout(){const e=this.visibility.currentValue,t=(this.width,this.height);switch(this.mainPanel.setAlpha(e),this.rightBorder.setAlpha(e),this.leftBorder.setAlpha(e),this.anchor){case"left":this.leftBorder.setVisible(!1),this.rightBorder.setVisible(!0),this.rightBorder.setPosition(e*this.width,0),this.mainPanel.setPosition(0,0),this.mainPanel.setSize(e*this.width,this.height);break;case"right":break;case"center":this.leftBorder.setPosition(this.width/2*(1-e)+1,0),this.rightBorder.setPosition(this.width/2+this.width/2*e,0),this.leftBorder.setVisible(!0),this.rightBorder.setVisible(!0),this.mainPanel.setPosition(this.width/2*(1-e),0),this.mainPanel.setSize(this.width*e,this.height);break;case"fullscreen":this.leftBorder.setVisible(!1),this.rightBorder.setVisible(!1),this.mainPanel.setSize(this.width,this.height)}this.leftBorder.height=t,this.leftBorder.scaleX=t/this.leftBorder.width,this.leftBorder.scaleY=.5,this.rightBorder.height=t,this.rightBorder.scaleX=t/this.rightBorder.width,this.rightBorder.scaleY=.5,this.input&&(this.input.enabled=1===e)}}t.VerticalStripePanel=l},49424:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.outlineButton=function(e,{text:t,icon:i,iconPlacement:r,onClicked:l,width:c,variant:d,theme:h,tooltip:u,bevel:p}){const g="large"===d?46:30,m="circle"===d?30:180,y="circle"===d?15:8,f="large"===d?s.BitmapFont.Main:s.BitmapFont.Mini,w=new n.RoundedRectButton(e.scene,{content:new o.IconAndText(e.scene,{icon:a(e,i),tintIcon:!0,text:t?e.text(t,f,0):void 0,spacing:8,layout:"right"===r?o.BUTTON_LAYOUT.iconRight:o.BUTTON_LAYOUT.iconLeft}),onClicked:l,width:c??m,height:g,radius:y,theme:n.RoundedRectButton.Themes[h??"light"],bevel:p});return u&&w.setData("tooltip",u),w},t.getImage=a;const s=i(76049),n=i(46973),o=i(96604);function a(e,t){if(t)return"string"==typeof t?e.image(t):t}},49484:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FixedCapacityArray=void 0,t.FixedCapacityArray=class{constructor(e){this.cursor=0,this.data=[],this.size=0,Array.isArray(e)?(this.data=e,this.size=this.data.length):this.size=e}get length(){return this.data.length}push(e){this.data[this.cursor]=e,this.cursor=(this.cursor+1)%this.size}getItems(){return this.data.slice(this.cursor,this.size).concat(...this.data.slice(0,this.cursor))}get(e){return this.data[(this.cursor+e)%this.data.length]}pop(){const e=this.getItems(),t=e[e.length-1];return this.data=this.getItems().slice(0,this.data.length-1),this.cursor=this.data.length,t}clear(){this.data=[],this.cursor=0}last(){const e=this.getItems();return e[e.length-1]}}},49527:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StealthButton_LEGACY=void 0;var s=Phaser.Geom.Rectangle,n=Phaser.GameObjects.Image;const o=i(86545),a=i(96137),r=i(2426),l=i(22663),c=i(83176),d=i(7548),h=e=>({background:void 0,highlight:{color:e.oceanShades.light1,alpha:.85},content:e.oceanContrastDark});class u extends o.BaseResponsiveContainer{constructor(e,t){super(e),this.props=t,this.colors=(0,d.themer)(this,this.props.colors??h).use((e=>{this.content instanceof n&&this.content.setTint(e.content),this.controller&&this.onNewButtonState(this.controller.getState())})),this._radius=10,this._radius=t.radius??this._radius,this._background=new r.RoundedRect(this.scene,{x:0,y:0,fillStyle:{color:a.Colors.glassUi_old.shapeLightAccent,alpha:.5},radius:this._radius}).setAlpha(0),this.width=t.width??10,this.height=t.height??10,this.content=t.content,this.add([this._background]),this.content&&this.add(this.content),this.setInteractive({hitArea:new s(this.width/2,this.height/2,this.width,this.height),hitAreaCallback:s.Contains,cursor:"pointer"}),this.setController((0,c.setupController)(t)),this.colors.apply()}setRadius(e){this._radius=e,this.updateLayout()}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.onNewButtonState(e))))}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}onNewButtonState(e){const t=this.colors.get();switch(e){case l.ButtonState.Hover:case l.ButtonState.Down:this._background.setAlpha(1),this._background.setFillStyle(t.highlight.color,t.highlight.alpha);break;default:t.background?(this._background.setAlpha(1),this._background.setFillStyle(t.background.color,t.background.alpha)):this._background.setAlpha(0)}}updateLayout(){this.input.hitArea.setTo(this.width/2,this.height/2,this.width,this.height),this._background.radius=this._radius,this._background.setSize(this.width,this.height),this.content?.setPosition(this.width/2-this.content.width/2,this.height/2-this.content.height/2)}}t.StealthButton_LEGACY=u},49652:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AiNoKnightsPlugin=void 0;const s=i(18497),n=i(9292);t.AiNoKnightsPlugin={name:s.PluginKey.AiNoKnights,register(e){e.ai.maxAllowedUnitMightLimit.register((e=>(0,n.pickSmaller)(e,2)))}}},49796:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rectToPhaser=function(e){return new Phaser.Geom.Rectangle(e.x,e.y,e.width,e.height)},t.enlargeRect=function(e,t){return e.x-=t,e.y-=t,e.width+=2*t,e.height+=2*t,e},t.multiplyRect=function(e,t,i){return e.x*=t,e.y*=i,e.width*=t,e.height*=i,e},t.manhattanDistance=function(e,t){return Math.abs(Math.abs(e.x)-Math.abs(t.x))+Math.abs(Math.abs(e.y)-Math.abs(t.y))},t.euclidDistance=function(e,t){const i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)},t.getRectMidPoint=function(e){return{x:e.x+e.width/2,y:e.y+e.height/2}},t.getBoundingBox=function(e){if(0===e.length)return{x:0,y:0,height:0,width:0};let t=Number.MAX_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER,s=-Number.MAX_SAFE_INTEGER,n=-Number.MAX_SAFE_INTEGER;for(let o of e)o.x<t&&(t=o.x),o.x>s&&(s=o.x),o.y<i&&(i=o.y),o.y>n&&(n=o.y);return{x:t,y:i,width:s-t,height:n-i}}},50105:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleHexCaptured=async function(e,t,i=!0){s.inject.ui.regionsLedger.refreshAvailableRegions(t.worldUpdates.stateAfter),e.uiScene.updateFromGameState(t.worldUpdates.stateAfter),e.uiScene.updatePowerBalanceFromGameState(t.worldUpdates.stateAfter),n.app.worldNews.clearNewsOnHex(t.capturedHexId);const o=n.app.scene.worldMap.play(t.worldUpdates);i&&await o};const s=i(91622),n=i(54825)},50154:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColorBar=void 0;const s=i(76738),n=i(7782);class o extends s.Ribbon{constructor(e,t){super(e,s.RibbonTextures.ColorBar,t.x,t.y,t.width),this.props=t,this.adjustX=n.Control.propOf(this,"x",{duration:500}),this.adjustY=n.Control.propOf(this,"y",{duration:500}),this.adjustSize=new n.TransitionController(this.scene,{duration:500,applyValue:e=>{this.active&&(this.width=e)},initialValue:this.width}),void 0!==t.color&&this.setTint(t.color)}}t.ColorBar=o},50575:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RichText=void 0;const s=i(6278);class n extends s.BBCodeText{getWorldPoint(e,t,i){throw new Error("Method not implemented.")}setToTop(){throw new Error("Method not implemented.")}setToBack(){throw new Error("Method not implemented.")}setAbove(e){throw new Error("Method not implemented.")}setBelow(e){throw new Error("Method not implemented.")}setWordWrapWidth(e){return this.setStyle({wrap:{mode:this.style.wrapMode,width:e}}),this}setTint(e){return this.setStyle({...this.style,color:e,delimiters:","}),this}setColor(e){return this.setTint(e),this}}t.RichText=n},51060:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HorizontalTabHighlighter=t.VerticalTabHighlighter=void 0;const s=i(61727);class n extends s.GraphicsContainer{constructor(e,t){super(e),this.props=t,t.themer.use((e=>{this.rerender()}))}render(e,t){const i=this.props.themer.get().lineColor;this.fillStyle(i,1),this.fillRect(0,0,4,t),this.fillGradientStyle(i,i,i,i,.25,0,.25,0),this.fillRect(0,0,e,t);const{haloSize:s}=this.props;this.fillGradientStyle(i,i,i,i,0,0,1,1),this.fillRect(0,-s,1,s),this.fillGradientStyle(i,i,i,i,1,1,0,0),this.fillRect(0,t,1,s)}}t.VerticalTabHighlighter=n;class o extends s.GraphicsContainer{constructor(e,t){super(e),this.props=t,t.themer.use((e=>{this.rerender()}))}render(e,t){const i=this.props.themer.get().lineColor;this.fillStyle(i,1),this.fillRect(0,0,e,4),this.fillStyle(i,1),this.fillGradientStyle(i,i,i,i,.25,.25,0,0),this.fillRect(0,0,e,t);const{haloSize:s}=this.props;this.fillGradientStyle(i,i,i,i,0,1,0,1),this.fillRect(-s,0,s,1),this.fillGradientStyle(i,i,i,i,1,0,1,0),this.fillRect(e,0,s,1)}}t.HorizontalTabHighlighter=o},51186:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MyLibraryUIScene=void 0;const s=i(30948),n=i(81700),o=i(897),a=i(55275),r=i(12605),l=i(8482),c=i(20087),d=i(75136),h=i(90952),u=i(72273),p=i(80959),g=i(22319),m=i(56824),y=i(36868),f=i(90845),w=i(11466),v=i(54825),b={recentlyPlayed:[],favorites:[],myIslands:[],selectedContentId:null};class S extends s.BaseUIScene{constructor(){super({key:n.Scenes.MyLibraryUI}),this.state=(0,a.stateContainer)(b,this.applyState.bind(this)),this.selectedContentId=null,this.preUpdate=(0,o.whenDirty)((()=>{const e=S.Layout[v.app.device.uiVariant()],t=this.bounds.contentWidth-2*e.contentMargin;this.galleries.forEach((e=>{e.width=t,e.updateLayout()})),c.Arrange.alignX({content:this.galleries,x:this.bounds.contentLeft+e.contentMargin,origin:0}),c.Arrange.topToBottom({content:this.galleries,y:e.offsetTop,spacing:36}),this.recentlyPlayed.preUpdate.force()}))}create(){super.create(),(0,f.ensureIsoTilesPrerendered)(this),this.loadQueue=(0,l.simpleAsyncJobQueue)(),this.engine=new d.StateEngine,this.engine.add(h.GameState.version,h.GameState.map,h.GameState.ruleSet,h.GameState.economy.townsByRegion,...u.ProjectionPresets.coreEntities).activateAllProjections(),(0,r.makeSceneScrollable)(this),p.UiBuilder.for(this),this.recentlyPlayed=new g.InlineContentGallery(this,{content:[],headerIcon:"ui/button-icons/history",headerText:"Recent Exploits",loadQueue:this.loadQueue,engine:this.engine,showFavoriteButton:!0}),this.favouriteIslands=new g.InlineContentGallery(this,{content:[],headerIcon:"ui/button-icons/star-full",headerText:"Favourite Islands",loadQueue:this.loadQueue,engine:this.engine,showFavoriteButton:!1}),this.myIslands=new g.InlineContentGallery(this,{content:[],headerIcon:"ui/button-icons/star-full",headerText:"My Islands",loadQueue:this.loadQueue,engine:this.engine,showFavoriteButton:!1,showAddButton:!0}),this.addAll([this.recentlyPlayed,this.favouriteIslands,this.myIslands]),this.input.on("pointerdown",((e,t)=>{0===t.length&&m.events.trigger(y.UserActions.SelectContent(null))}))}applyState(e,t,i){e.recentlyPlayed&&this.recentlyPlayed.updateContent(e.recentlyPlayed),e.favorites&&(this.favouriteIslands.updateContent(e.favorites),this.recentlyPlayed.cards.get().forEach((e=>{e.updateFavoriteButton()}))),e.myIslands&&this.myIslands.updateContent(e.myIslands),void 0!==e.selectedContentId&&this.handleContentSelected(e.selectedContentId),this.preUpdate.makeDirty()}handleContentSelected(e){this.selectedContentId&&this.getCardByContentId(this.selectedContentId)?.setSelected(!1),this.selectedContentId=e,e&&this.getCardByContentId(e)?.setSelected(!0)}get galleries(){return[this.recentlyPlayed,this.myIslands,this.favouriteIslands]}getAllCards(){return this.galleries.flatMap((e=>e.cards.get()))}getCardByContentId(e){return this.getAllCards().find((t=>t.currentProps.content.id===e))}get contentHeight(){return this.favouriteIslands.y+this.favouriteIslands.height+150}async activate(){}}t.MyLibraryUIScene=S,S.Layout={[w.UiVariant.Compact]:{offsetTop:100,contentMargin:10},[w.UiVariant.Large]:{offsetTop:150,contentMargin:10}}},51216:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HorizontalTabSwitcher=t.VerticalTabSwitcher=void 0;const s=i(86545),n=i(1187),o=i(18957),a=i(20087),r=i(7548),l=i(7782),c=i(51060),d=i(49055),h=e=>({lineColor:e.white});class u{constructor(e){this.props=e,this.onTabSelected=(0,o.signal)(),this.components=new n.GameObjectList(((e,t,i)=>(i||((i=new d.TabButton(this.props.parent.scene,this.props.theme,this.props.highlightAnchor)).setSize(this.props.tabWidth,this.props.tabHeight),i.onClick((()=>{this.selectedIndex===t&&this.props.allowDeselection?this.setSelectedIndex(-1,"transition",!0):this.setSelectedIndex(t,"transition",!0)})),this.props.parent.add(i)),i.setContent(e.content),i.setData("tooltip",e.tooltip),i))),this.selectedIndex=-1}setTabs(e){const t=this.components.getModel();t.length>0&&t.forEach((e=>e.content.destroy())),this.components.set(e)}setSelectedIndex(e,t,i){if(this.selectedIndex===e)return;const s=this.components.get();this.selectedIndex=e;const n=e>=0&&e<s.length;this.onTabSelected.fire({index:n?e:void 0,mode:t,fireEvent:i}),s.forEach(((e,t)=>{e.setSelected(t===this.selectedIndex)}))}selectTab(e,t=!0){if(void 0===e)this.setSelectedIndex(-1,"instant",t);else{const i=this.components.getModel().findIndex((t=>t.key===e));-1!==i?this.setSelectedIndex(i,"instant",t):console.warn(`Tab with key "${e}" not found.`)}}getSelectedTabKey(){if(this.selectedIndex>=0&&this.selectedIndex<this.components.getModel().length)return this.components.getModel()[this.selectedIndex].key}}class p extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.props=t,this.onTabSelected=(0,o.signal)(),this.theme=(0,r.themer)(this,p.Themes.white),this.tabs=new u({tabWidth:this.props.width,tabHeight:this.props.tabHeight,theme:this.theme,parent:this,allowDeselection:this.props.allowDeselection,highlightAnchor:"left"}),this.highlighter=new c.VerticalTabHighlighter(this.scene,{themer:this.theme,haloSize:this.props.glintSize??20}),this.highlighterY=l.Control.propOf(this.highlighter,"y",{duration:100}),this.theme.set(this.props.theme??p.Themes.white),this.width=t.width,this.highlighter.setSize(t.width,t.tabHeight),this.add(this.highlighter),this.tabs.onTabSelected((({index:e,mode:t,fireEvent:i})=>{const s=this.tabs.components.get();void 0!==e?(this.highlighter.visible?this.highlighterY.setTo(s[e].y,t):(this.highlighterY.setTo(s[e].y,t),this.highlighter.setVisible(!0)),i&&this.onTabSelected.fire(this.tabs.components.getModel()[e].key)):(this.highlighter.setVisible(!1),i&&this.onTabSelected.fire(void 0))}))}calculateHeight(){const e=this.tabs.components.get();return 0===e.length?0:e[e.length-1].y+e[e.length-1].height}updateLayout(){const e=this.tabs.components.get();a.Arrange.alignX({content:e,x:0,origin:0}),a.Arrange.topToBottom({content:e,y:0,origin:0,spacing:0}),-1===this.tabs.selectedIndex||this.tabs.selectedIndex>e.length-1?this.highlighter.setVisible(!1):(this.highlighter.setVisible(!0),this.highlighterY.setTo(e[this.tabs.selectedIndex].y)),this.updateSize()}selectTab(e,t=!0){this.tabs.selectTab(e,t)}setTabs(e){this.tabs.setTabs(e),this.preUpdate.makeDirty()}}t.VerticalTabSwitcher=p,p.Themes={white:h};class g extends s.AutoWidthResponsiveContainer{constructor(e,t){super(e),this.props=t,this.onTabSelected=(0,o.signal)(),this.theme=(0,r.themer)(this,p.Themes.white),this.tabs=new u({tabWidth:this.props.tabWidth,tabHeight:this.props.height,theme:this.theme,parent:this,allowDeselection:this.props.allowDeselection,highlightAnchor:"top"}),this.highlighter=new c.HorizontalTabHighlighter(this.scene,{themer:this.theme,haloSize:this.props.glintSize??20}),this.highlighterX=l.Control.propOf(this.highlighter,"x",{duration:100}),this.theme.set(this.props.theme??p.Themes.white),this.height=t.height,this.highlighter.setSize(t.tabWidth,t.height),this.add(this.highlighter),this.tabs.onTabSelected((({index:e,mode:t,fireEvent:i})=>{const s=this.tabs.components.get();void 0!==e?(this.highlighter.visible?this.highlighterX.setTo(s[e].x,t):(this.highlighterX.setTo(s[e].x,t),this.highlighter.setVisible(!0)),i&&this.onTabSelected.fire(this.tabs.components.getModel()[e].key)):(this.highlighter.setVisible(!1),i&&this.onTabSelected.fire(void 0))}))}calculateWidth(){const e=this.tabs.components.get();return 0===e.length?0:e[e.length-1].x+e[e.length-1].width}updateLayout(){const e=this.tabs.components.get();a.Arrange.alignY({content:e,y:0,origin:0}),a.Arrange.leftToRight({content:e,x:0,origin:0,spacing:0}),-1===this.tabs.selectedIndex||this.tabs.selectedIndex>e.length-1?this.highlighter.setVisible(!1):(this.highlighter.setVisible(!0),this.highlighterX.setTo(e[this.tabs.selectedIndex].x)),this.updateSize()}selectTab(e,t=!0){this.tabs.selectTab(e,t)}setTabs(e){this.tabs.setTabs(e),this.preUpdate.makeDirty()}}t.HorizontalTabSwitcher=g,g.Themes={white:h}},51384:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.INVALID_PLACEMENT=void 0,t.INVALID_PLACEMENT={x:-1e3,y:-1e3,width:0,height:0}},51496:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.track=void 0;const s=i(56824),n=i(66143),o=i(91622),a=i(54825),r=i(37208),l=i(68243),c=s.logger.for("analytics");function d(e,t){try{if(!l.Firebase.analytics)return void c.warning(`failed to log ${e} to firebase, analytics not initialized`);(0,r.logEvent)(l.Firebase.analytics,e,u(t))}catch(t){c.warning(`failed to log ${e} to firebase`)}}function h(e){return t=>{try{d(e,u(t))}catch(t){s.errors.handleNonFatalError(t,`track.event("${e}")`)}}}function u(e){const t=a.app?.navigator?.currentScreen;return e||(e={}),{user_id:o.inject?.login?.getUserId(),screen:t?.name,frameParent:a.app?.device?.frameParent,...p(t),...e}}function p(e){if(!a.app||!a.app.screen||!e)return{};switch(e){case a.app.screen.play:case a.app.screen.victory:const e=n.LevelModel.for(o.inject.levelSession.levelId);return{level_id:e.id,level_name:e.getTitle(n.LevelTitleStyle.IncludingModePrefix),expedition_id:e.expeditionContext?.expedition.id,map_color_theme:o.inject.theme.getUserPreferredTheme()};default:return{}}}t.track={bootComplete:h("boot_complete"),exception:h("exception"),pageView:h("page_view"),interaction:e=>{d(e,{})},ui:{dismissFeedbackForm:h("dismiss_feedback_form")},playerFeedback:h("player_feedback"),randomMapSelected:h("random_map_started"),randomMapRerolled:h("random_map_rerolled"),spectatingOver:h("spectating_over"),loginStart:h("login_start"),loginSuccess:h("login_success"),loginFailed:h("login_failed"),importChatterFile:h("import_chatter_file")}},51512:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupFileDropZone=function(e){const t=document.getElementById(e),i=document.getElementById("file-drop-zone"),l=document.getElementById("phaser-game");async function c(e){e.stopPropagation(),e.preventDefault(),i.classList.add("hidden");const t=e.dataTransfer?.files[0],s=e.dataTransfer?.items??[];try{if(!t){if(await async function(e){for(const t of e)if("text/uri-list"===t.type||"text/plain"===t.type)return new Promise(((e,i)=>{t.getAsString((t=>{(0,r.parseKonkrData)(t).then((()=>e(!0))).catch((t=>e(!1)))}))}));return!1}(s))return;throw Error("No file or URL found in the drop event.")}await async function(e){try{await async function(e){const t=await e.text();if(!t||"string"!=typeof t)throw new Error("File appears to be empty!");await(0,r.parseKonkrData)(t)}(e)}catch(e){n.app.modals.simpleDialog({title:"Data import failed",message:`Oops, that didn't work :(\n${e.message}`,buttons:[{text:a.DialogButtons.OK,role:o.DialogButtonRole.Regular}]})}}(t)}catch(e){n.app.modals.simpleDialog({title:"Data import failed",message:"Oops, sorry, I don't know what to do with this content.",buttons:[{text:a.DialogButtons.OK,role:o.DialogButtonRole.Regular}]})}}s.assert.defined(t,`cannot create file drop zone: no element found for id '${e}'`),t.ondrop=c,i.ondrop=c,l.ondrop=c,t.ondragover=e=>{e.stopPropagation(),e.preventDefault(),i.classList.remove("hidden")},i.ondragover=e=>{e.stopPropagation(),e.preventDefault()},i.ondragleave=e=>{e.stopPropagation(),e.preventDefault(),i.classList.add("hidden")}};const s=i(97849),n=i(54825),o=i(63032),a=i(5365),r=i(13554)},51590:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PerceivedThreatView=void 0;const s=i(20754),n=i(90952),o=i(80268),a=i(56038),r=i(91622),l=i(76439),c=i(12543),d=i(1326),h=i(45664),u=i(19506),p=i(70712),g=i(7334);class m extends s.LazyView{constructor(){super([n.GameState.ai.powerByRegion,n.GameState.ai.credit]),this.name="PerceivedThreat"}calculate(e,t){const i=a.Regions.model(e);return o.AIPolitics.perceivedThreat.get(i.byId(t.attackerRegionId),i.byId(t.defenderRegionId))}getCacheKey(e){return`${e.attackerRegionId}->${e.defenderRegionId}`}getDebugLayer(){function e(e,t){const i=a.Regions.model(e).byHex(t);return i?(0,d.stripDuplicatesFrom)(t.neighbours().map((t=>a.Regions.getByHex(e,t.id))).filter((e=>e&&e!==i.id)).map((t=>a.Regions.model(e).byId(t))).filter((e=>e?.faction&&e.isAlive()))):[]}return new l.GameStateDebugLayer((0,c.hexBasedAdapter)({getValue:(t,i)=>{const s=a.Regions.model(t).byHex(i);if(!s)return;const n=e(t,(0,h.getHex)(i)).map((e=>({region:e,faction:e?.faction,threat:r.inject.views.perceivedThreat.get(t,{attackerRegionId:e.id,defenderRegionId:s.id})}))).filter((({threat:e})=>e>0)).map((({faction:e,threat:t})=>`${u.GLYPH.factions[e.id]} ${(100*t).toFixed()}`));return n.length?n.join("\n"):void 0},getDetail:(t,i)=>{const s=a.Regions.model(t).byHex(i);if(s)return e(t,(0,h.getHex)(i)).map((e=>{const i=o.AIPolitics.perceivedThreat.getFactors(e,s),n=p.AI.getRegionAttrition(t,s.id,e.faction.id),a=p.AI.getRegionAttrition(t,e.id,s.faction.id);return`${e}:\n  base: ${i.base.toFixed(2)} (from confidence ${e.faction?.confidence.toFixed(2)}\n  hostilityModifier: ${(0,g.formatNumber)(i.hostilityModifier)} (from hostility ${o.AIPolitics.getHostilityTowards(e.state,s.faction,e.faction.id).toFixed(2)})\n  attritionBoost: ${i.attritionBoost} (my ${n}, theirs ${a})\n  rivalryBoost: ${i.rivalryBoost}\n  minimalThreat: ${i.minimalThreat.toFixed(2)} (confidence=${s.faction?.confidence.toFixed(2)} daring=${s.faction?.getCurrentPersonality().daring.toFixed(2)})\n  likelyHoodOfExpandingElsewhere: ${i.likelyHoodOfExpandingElsewhere.toFixed(2)}\n  likelyHoodOfFightingBackElsewhere: ${i.likelyHoodOfFightingBackElsewhere.toFixed(2)}`})).join("\n")}}))}}t.PerceivedThreatView=m},51624:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeadIslands2=void 0;const s=i(37971),n=i(91622),o=i(54825),a=i(95428),r=i(36868),l=i(24598),c=i(12167),d=i(56824);t.DeadIslands2=class{constructor(){this.freedRosaline=!1,this.main=new h(this)}};class h extends s.LevelScript{constructor(){super(...arguments),this.reinforcementsTooltip=null}activate(){super.activate(),1===n.inject.gameStateModel.currentPhase.turnNumber&&o.app.scene.playUI.updateState({worldMapPanel:{type:"tutorial",emojiEmotion:a.EmojiEmotion.Happy,text:"There's [b]Rosaline the Righteous[/b], diving head first into danger as usual! If we can get to her, she'll be an invaluable asset!\n(choose landing spot, starting treasury: 20 [img=coin-hd])",buttons:[]}}),this.onEvent(r.GameStateEvents.HexCaptured,(e=>{this.module.freedRosaline||e.capturingPawnType!==l.PawnType.UniqueHero||(this.module.freedRosaline=!0,o.app.scene.playUI.updateState({worldMapPanel:{type:"tutorial",emojiEmotion:a.EmojiEmotion.Happy,text:"With Rosaline on our side, we didn't gain just an unstoppable hero, but also a treasure trove of knowledge about the Necromancers!",buttons:[c.DIALOG_BUTTONS.showMe]}}))})),this.onEvent(r.UserActions.WorldMapPanelButtonClicked,(e=>{"viewHelp"===e&&d.events.trigger(r.UserActions.ShowHelp("modes/necromancers"))})),this.onEvent(r.GameStateEvents.FactionTurnOver,(e=>{1===e.factionId&&o.app.scene.playUI.updateState({worldMapPanel:null})}))}deactivate(){super.deactivate(),this.reinforcementsTooltip?.hide(!0)}}},51887:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playPawnDestroy=async function(e,t){const i=e.pawns.getById(t.pawnId);s.assert.defined(i),await e.pawns.transitions.destroyPawn(i)};const s=i(97849)},51986:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapSettingsPanel=void 0;const s=i(86545),n=i(80959),o=i(92846),a=i(20087),r=i(18957),l=i(85072);class c extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.compressLayout=!1,this.ui=n.UiBuilder.for(this.scene),this.onSettingChanged=(0,r.signal)(),this.sizeSelector=new o.SelectBoxWithArrows(this.scene,{title:"Size",options:[l.MapSize.Small,l.MapSize.Medium,l.MapSize.Large].map((e=>({value:e,title:e}))),selectedOption:l.MapSize.Medium}),this.shapeSelector=new o.SelectBoxWithArrows(this.scene,{title:"Island Type",options:[l.MapShape.Temperate,l.MapShape.Marshlands,l.MapShape.Flat].map((e=>({value:e,title:e}))),selectedOption:l.MapShape.Temperate,infinite:!0}),this.modeSelector=new o.SelectBoxWithArrows(this.scene,{title:"Mode",options:[l.MapMode.Classic,l.MapMode.Colonization,l.MapMode.Crowded,l.MapMode.Zombies,l.MapMode.KingsLanding,l.MapMode.Christmas,l.MapMode.Occupation].map((e=>({value:e,title:e}))),selectedOption:l.MapMode.Classic,infinite:!0}),this.difficultySelector=new o.SelectBoxWithArrows(this.scene,{title:"Challenge",options:[l.MapDifficulty.Casual,l.MapDifficulty.Normal,l.MapDifficulty.Challenging,l.MapDifficulty.Unfair].map((e=>({value:e,title:e}))),selectedOption:l.MapDifficulty.Challenging}),this.variationSelector=new o.SelectBoxWithArrows(this.scene,{title:"Starting Towns Variant",options:[1,2,3,4,5,6,7,8,9].map((e=>({value:e,title:e.toString()}))),selectedOption:1,infinite:!0}),this.sizeSelector.onSelect((({value:e,direction:t})=>{this.onSettingChanged.fire({update:{size:e},direction:"left"===t?"right":"left"})})),this.shapeSelector.onSelect((({value:e,direction:t})=>{this.onSettingChanged.fire({update:{shape:e},direction:"left"===t?"right":"left"})})),this.modeSelector.onSelect((({value:e,direction:t})=>{this.onSettingChanged.fire({update:{mode:e}})})),this.difficultySelector.onSelect((({value:e,direction:t})=>{this.onSettingChanged.fire({update:{difficulty:e}})})),this.variationSelector.onSelect((({value:e,direction:t})=>{this.onSettingChanged.fire({update:{regionsVariation:e}})})),this.add([this.sizeSelector,this.shapeSelector,this.modeSelector,this.difficultySelector,this.variationSelector])}applyState(e,t,i){e.mode&&this.modeSelector.setSelection(e.mode),e.size&&this.sizeSelector.setSelection(e.size),e.shape&&this.shapeSelector.setSelection(e.shape),e.difficulty&&this.difficultySelector.setSelection(e.difficulty),void 0!==e.regionsVariation&&this.variationSelector.setSelection(e.regionsVariation)}updateLayout(){[this.sizeSelector,this.shapeSelector,this.modeSelector,this.difficultySelector,this.variationSelector].forEach((e=>e.width=this.width)),a.Arrange.fromTopToBottomOld([this.sizeSelector,this.shapeSelector,this.modeSelector,this.difficultySelector,this.variationSelector],{x:0,y:0,spacing:this.compressLayout?4:14}),this.updateSize()}calculateHeight(){return this.variationSelector.y+this.variationSelector.height}}t.MapSettingsPanel=c,c.Layout={}},52031:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Observer=void 0;const s=i(56824);t.Observer=class{constructor(e){this.isActive=e,this._deferredHandlers=new Map,this._subs=[]}wakeUp(){this._deferredHandlers.forEach((e=>e())),this._deferredHandlers.clear()}event(e,t){this._subs.push(s.events.on(e,((e,i)=>{this.isActive()&&t.apply(this,[e,i])})))}signal(e,t){this._subs.push(e(((...e)=>{this.isActive()&&t.apply(this,e)})))}watch(e,t){this._subs.push(e.watch(((e,i)=>{this.isActive()?t.apply(this,[e,i]):this._deferredHandlers.set(t,(()=>t.apply(this,[e,i])))})))}destroy(){this._subs.forEach((e=>e.unsubscribe())),this._deferredHandlers.clear()}}},52197:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeBuyPawn=function(e,t){const i=(0,r.getHex)(t.destinationHexId),p=e.regions.byId(t.buyerRegionId);a.assert.defined(i),a.assert.defined(p);let g=[];return e.stateEngine.transaction((()=>{const a=e.warfare.getDropPawnResult(i,t.pawnType,p),r=e.regions.byHex(i);switch(t.pawnType===c.PawnType.Present&&r?.isAlive()&&r!==p&&g.push(...d.inject.ai.dataLayer.onReceivedGift({giftValue:e.rules.pawns(c.PawnType.Present).loot,model:e,fromFaction:p.faction,toFaction:r.faction})),a.type){case o.DropPawnResultType.Conquest:return(0,n.captureHex)(e,i,p,t.pawnType,t.tapUnit);case o.DropPawnResultType.Reposition:case o.DropPawnResultType.EradicatePest:case o.DropPawnResultType.Combine:let r,c;if(a.type===o.DropPawnResultType.EradicatePest){let t;a.pest.hasTrait(u.PawnTraits.Elusive)&&(t=e.warfare.getRetreatDestination(a.pest)?.id),c={pawnId:a.pest.id,retreatHex:t}}a.type===o.DropPawnResultType.Combine&&(r={outputType:a.combineInto,mergedWith:a.combineWith.id});const d=e.economy.payForNewPawn(i,p,t.pawnType);e.stateEngine.commitTransaction();const m=new l.WorldUpdateBuilder(e);m.addCoinTransaction(d);const y=m.create({type:t.pawnType,hex:i,regionId:p.id,sourceHex:(0,n.getBuyPawnSourceHex)(m,i,p,t.pawnType),mergeData:r,defeatedUnit:c,captureHex:!1,tapUnit:t.tapUnit}),f={...t,payment:d,pawnId:y.merged?.newPawnId??y.pawns[0].pawnId,mergedWith:y.pawns[1]?.pawnId,mergedInto:y.merged?.outputType,buyerRegionId:p.id,eradicatedPest:a.type===o.DropPawnResultType.EradicatePest,worldUpdates:m.getUpdates()},w=[s.GameStateEvents.PawnBought(f),...g];return w.concat((0,h.checkWinLoseConditions)(e,w));case o.DropPawnResultType.Invalid:default:throw new Error(`Invalid buy attempt (${a.reason})`)}}))};const s=i(36868),n=i(63853),o=i(78635),a=i(97849),r=i(45664),l=i(78933),c=i(24598),d=i(91622),h=i(46471),u=i(63521)},52201:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinsManager=void 0;const s=i(56824),n=i(1326),o=i(68961),a=i(45664),r=i(62244),l=i(24598),c=i(8482),d=i(54825),h=i(9292);s.logger.for("coins"),t.CoinsManager=class{constructor(e,t,i){this.scene=e,this.pools=t,this.tiles=i,this.piles={},this.coinTransactionsQueue=new c.AsyncJobQueue((async({transactions:e,session:t})=>{t.isActive()&&await new r.CoinTransactionCinematic(this,e,t).play()}))}async play(e){0!==Object.keys(e).length&&(this.coinTransactionsQueue.addJob({transactions:e,session:d.app.scene.worldMap.session()}),await this.coinTransactionsQueue.jobsComplete())}spawnOnHex(e,t){this.getOrCreatePile(e).addCoins(t)}setAmount(e,t){0===t?this.destroyPileAt(e.id):this.getOrCreatePile(e).setAmount(t)}syncWithModel(e){const t=e.pawns.select({type:[l.PawnType.Coins]}),i=new Set;for(const e of t)this.setAmount(e.hex,e.count),e.count>0&&i.add(e.hex.id);for(const e in this.piles)i.has(Number(e))||this.destroyPileAt(Number(e))}applyTransactions(e){const t={};for(let i of Object.keys(e).map((e=>Number(e)))){const s=e[i];Object.entries(s.send).forEach((([e,i])=>{const s=Number(e);t[s]?t[s]+=i:t[s]=i}))}const i=(0,n.stripDuplicatesFrom)(Object.keys(e).concat(Object.keys(t)).map((e=>Number(e))));for(let s of i){const i=e[s]||{spawn:0,send:[],consume:0},n=Object.values(i.send).reduce(h.sum,0),o=i?.spawn+(t[s]??0)-n-i.consume;o>0?this.spawnOnHex((0,a.getHex)(s),o):o<0&&this.removeFromHex((0,a.getHex)(s),-o)}}removeFromHex(e,t){this.getOrCreatePile(e).deleteCoins(t)}getOrCreatePile(e){return(0,n.getOrCreate)(this.piles,e.id,(()=>new o.CoinPile(this.pools,this.tiles,e)))}getAllPiles(){return Object.values(this.piles)}destroyPileAt(e){const t=this.piles[e];t&&(t.destroy(),delete this.piles[e])}destroyCoins(){Object.values(this.piles).forEach((e=>{e.destroy()})),this.piles={}}}},52307:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.crossesWall=function(e,t,i){const a=n.Warfare.model(e),r=![s.PawnType.Camp,s.PawnType.HauntedTown].includes(a.getOccupyingUnit(t)?.type)&&a.getHexStaticDefense(t)>0,l=a.getHexStaticDefense(i)>0,c=o.Regions.getByHex(e,t.id)!==o.Regions.getByHex(e,i.id);return r!==l||(r||l)&&c},t.isUndeadTerritory=function(e,t){return!(l.Factions.model(e).byHex(t)?.persona.race!==a.Race.Undead||!o.Regions.model(e).byHex(t)?.isAlive())},t.isUndeadTown=function(e,t){return!(e.factions.byHex(t)?.persona.race!==a.Race.Undead||!e.pawns.presentAtHex(t,s.PawnType.Town))},t.getClosestTownWithFullMana=function(e,t){return e.hexes.with(t).findClosest(t,(t=>r.Pawns.model(e.state).getCount(t,s.PawnType.Mana)>=6))},t.getClosestTownThatCanBuyDreadKnight=function(e,t){const i=e.hexes.with(t),n=r.Pawns.model(e.state);return i.findClosest(t,(e=>n.presentAtHex(e,s.PawnType.Town)&&6===n.getCount(e,s.PawnType.Mana)))},t.collectManaToNearestUndeadTown=function(e,t){const i=c.inject.views.undeadTowns.get(e.stateBefore).filter((t=>r.Pawns.model(e.stateBefore).getCount(t,s.PawnType.Mana)<6));if(i.length>0){const s=(0,d.findMin)(i.members,(e=>e.getDistanceTo(t)));e.collectMana(t,s)}};const s=i(24598),n=i(78635),o=i(56038),a=i(90824),r=i(81434),l=i(19618),c=i(91622),d=i(1326)},52409:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleIsoRenderer=void 0;const s=i(20693),n=i(15974),o=i(73230),a=i(56038);t.SimpleIsoRenderer=class{constructor(e,t,i){this.id=e,this.renderer=t,this.recipe=i,this.debug=!1,this.tint=void 0,this.group=new n.IsoTileGroupWithRenderer(o.RenderLayerKey[this.id],this.renderer,this.recipe,this.postProcess.bind(this),this.tint)}getHexes(e){const t=a.Regions.model(e);return s.HexGroup.union(t.all().map((e=>e.hexes))).filter((t=>this.shouldIncludeHex(e,t)))}postProcess(e){}sync(e){"all"===e.hexesToSync?this.syncWithState(e):this.syncHexes(e)}syncWithState(e){this.group.setHexes(this.getHexes(e.state),e)}syncHexes(e){const t=[],i=[];for(const s of e.hexesToSync){const n=this.shouldIncludeHex(e.state,s);n&&!this.group.hexes.has(s)?t.push(s):!n&&this.group.hexes.has(s)&&i.push(s)}this.group.addHexes(s.HexGroup.from(t),e),this.group.removeHexes(s.HexGroup.from(i),e),this.group.update()}clear(){this.group.clear()}}},52434:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CalculatedHexGroupValuationWithCache=void 0,t.CalculatedHexGroupValuationWithCache=class{constructor(){this.values={}}get(e){return this.values[e]||(this.values[e]=this.calculate(e)),this.values[e]}getHexIds(){return Object.keys(this.values).map((e=>Number(e)))}flush(){this.values={}}}},52528:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SIDEBAR_LAYOUT=void 0,t.SIDEBAR_LAYOUT={buttons:{radius:6,spacing:2,width:32,height:32,outerWidth:44,outerHeight:40,padding:4,stripeWidth:4},verticalOffset:10,background:{alpha:.9},contentWidth:392,contentPadding:16,separatorWidth:0,totalWidth:436,widgets:{radius:16,padding:16},transitionDuration:100}},52724:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateChatter=function(e,t,i={}){const s=h(e,t),n=i.requiredTags??[],o=i.bannedPhrases??new Set;for(let e of n)s.add(e);const a=e.faction?.persona.chatter||[];for(let e of a)if(e.tags.every((e=>s.has(e)))&&n.every((t=>e.tags.includes(t)))){const t=e.lines,i=t.filter((e=>!o.has(e))),s=0===i.length?t:i;return s[l.random.integerBetween(0,s.length-1)]}},t.generateTags=h;const s=i(70712),n=i(91622),o=i(80268),a=i(74783),r=i(19618),l=i(56824),c=i(86183),d=i(43046);function h(e,t){const i=new Set,s=e.state,o=e.faction;if(!o)return i;const a={state:s,tags:i,fromFaction:o,fromRegion:e,towardsFaction:t};u(a),p(a);const r=n.inject.gameStateController.history.getCursor();if(r.move(d.Move.seekBackTag("turnStart",o.id))&&r.hasStateInMemory()){const e={...a,state:r.currentState};u(e,"was"),p(e,"was"),g(a,e.state)}else g(a);return i}function u({state:e,tags:t,fromFaction:i,towardsFaction:s},n){const r=o.AIPolitics.getOpenHostilityTowards(e,s,i.id),l=o.AIPolitics.getHostilityFactors(e,s,i.id),c="was"===n?"was ":"";if(l){const e=Math.max(...Object.values({...l,rivalryBoost:l.rivalryBoost>50?l.rivalryBoost:0}));e>20&&(e===l.fightBackBoost?t.add(`${c}angered by losses`):e===l.combativeBoost?t.add(`${c}angered by nature`):e===l.fearBoost?t.add(`${c}angered by dominance`):e===l.creditBoost?t.add(`${c}angered by credit`):e===l.rivalryBoost&&t.add(`${c}angered by rivalry`))}switch((0,a.getHostilityIndex)(r)){case 0:t.add(`${c}furious`),t.add(`${c}hostile`),t.add(`${c}not friendly`);break;case 1:t.add(`${c}hostile`),t.add(`${c}not friendly`);break;case 2:t.add(`${c}neutral`),t.add(`${c}not hostile`),t.add(`${c}not friendly`);break;case 3:t.add(`${c}friendly`),t.add(`${c}not hostile`);break;case 4:t.add(`${c}ally`),t.add(`${c}friendly`),t.add(`${c}not hostile`)}}function p({tags:e,state:t,fromRegion:i,fromFaction:s,towardsFaction:o},a){const l=(r.Factions.model(t).byId(s.id)?.scaledPower??0)/(r.Factions.model(t).byId(o.id)?.scaledPower??0),d="was"===a?"was ":"";l>3?(e.add(`${d}not weaker`),e.add(`${d}stronger`),e.add(`${d}much stronger`)):l>1.5?(e.add(`${d}not weaker`),e.add(`${d}stronger`)):l>.75?(e.add(`${d}not stronger`),e.add(`${d}not weaker`),e.add(`${d}similar strength`)):l>.3?(e.add(`${d}not stronger`),e.add(`${d}weaker`)):(e.add(`${d}not stronger`),e.add(`${d}weaker`),e.add(`${d}much weaker`));const h=n.inject.views.powerBalance.get(t);if(h.dominance>20)switch(h.dominantFaction.id){case o.id:e.add(`player ${"was"===a?"was":"is"} dominant`);break;case s.id:e.add(`${d}dominant`);break;default:s.getCurrentPersonality().ambitious>0&&e.add(("was"===a?"had ":"")+"common enemy")}(0,c.shouldOfferSurrender)(t)&&(n.inject.levelSession.dismissedSurrender?e.add("surrender declined"):e.add("surrendering"))}function g({state:e,tags:t,fromRegion:i,fromFaction:n,towardsFaction:o},a){const r=i.hexes.find((t=>0===s.AI.getHexAge(e,t.id)&&s.AI.getHexHistory(e,t.id).previousFactionId===o.id))?s.AI.getFactionAttrition(e,o.id,n.id):0,l=s.AI.getFactionAttrition(e,n.id,o.id),c=o.rawPower,d=n.rawPower;if(!a)return void m(t,l/d,r/c,l,r);const h=s.AI.getFactionAttrition(a,o.id,n.id);m(t,(l-s.AI.getFactionAttrition(a,n.id,o.id))/d,(r-h)/c,l,r)}function m(e,t,i,s,n){t<=0&&i<=0?e.add("truce"):e.add("fighting"),t<=0&&i>0&&e.add("invading"),t>0&&i<=0&&e.add("invaded"),t>0&&(e.add("suffered damage"),e.add("angry reaction")),t>.5?(e.add("suffered crippling damage"),e.add("suffered major damage")):t>.1||s>=60?e.add("suffered major damage"):t>0?(e.add("suffered minor damage"),e.add("did not suffer major damage")):(e.add("suffered no damage"),e.add("did not suffer major damage")),i>0&&e.add("caused damage"),i>.5?(e.add("caused crippling damage"),e.add("caused major damage")):i>.1||n>=60?e.add("caused major damage"):i>0?(e.add("caused minor damage"),e.add("did not cause major damage")):(e.add("caused no damage"),e.add("did not cause major damage"))}l.logger.for("AiChatter")},52979:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.migrateFromV2=async function(e){const t=s.storage.getItem(`konkr.userData.v2.${e}`);if(t){const i=JSON.parse(t),n=c(i),u={progress:{local:d(i.levels),synced:(0,r.createEmptyProgressData)()},metadata:(0,a.cleanse)({cloudSyncUserId:i.metadata.cloudSyncUserId}),rememberedChoices:l(i.rememberedChoices),tutorialsCompleted:i.tutorialsCompleted,levelFeedbacksSubmitted:h(i)};n&&s.storage.setItem(o.STORAGE_KEYS.IN_PROGRESS_LEVEL,JSON.stringify(n)),s.storage.setItem(`konkr.userData.v3.beta.${e}`,JSON.stringify(u))}},t.stripDeprecatedChoices=l,t.extractInProgressLevelData=c,t.migrateProgress=d;const s=i(56824),n=i(38348),o=i(78349),a=i(7334),r=i(19746);function l(e){return(0,a.cleanse)({...e,rivalAI:void 0,latestLevelId:void 0,newGameOptions:void 0})}function c(e){const t=e.latestLevelId;if(!t)return;const i=e.levels[t];if(!i)return;const s=i.snapshots[n.V2_SaveGameTags.Autosave],o=i.snapshots[n.V2_SaveGameTags.Start];if(!s)return;const a=i.inProgress?.levelSessionId,r=i.inProgress;return a&&r?{sessionData:{levelId:t,origin:"unknown",aiDifficulty:r.aiDifficulty||"hard",id:a,remainingLives:r.lives,dismissedSurrenderTurn:void 0},currentGameState:s,startingGameState:o,turnNumber:r.turnNumber,created:Date.now()}:void 0}function d(e){const t={};for(const i in e){const s=e[i].won;s&&(t[i]={turns:s.turns,difficulty:s.difficulty||"hard"})}return{completedLevels:t,counters:{}}}function h(e){let t=[];for(const[i,s]of Object.entries(e.levels))s.feedback&&t.push(i);return t}},52985:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EconomyModel=void 0;const s=i(20026),n=i(40386),o=i(19162),a=i(56824),r=i(61634),l=i(94399),c=i(45664),d=i(90952);a.logger.for("EconomyModel");class h extends l.BaseModel{townHexesOf(e){const t=r.Economy.getTownHexesByRegion(this.state,e.id);return(0,c.getHexes)(t.toArray())}nearestTownHexFrom(e){const t=(0,s.selectFromState)(this.state,d.GameState.economy.nearestTown,e.id)?.rootId;if(t)return(0,c.getHex)(t)}nearestTownDistanceFrom(e){return(0,s.selectFromState)(this.state,d.GameState.economy.nearestTown,e.id)?.distance??Number.POSITIVE_INFINITY}potentialIncomeFromHex(e){return r.Economy.getPotentialIncomeFromHex(this.state,e.id)}incomeFromHex(e){return r.Economy.getCurrentIncomeFromHex(this.state,e)}gatherIncomeAndPayUpkeep(e,t){return new n.RegionEconomyCalculator(e,t).run({gatherIncome:!0,payUpkeep:!0})}treasuryOf(e){return r.Economy.getTreasuryOf(this.state,e.id)}numberOfCoinsAt(e){return r.Economy.getNumberOfCoinsAt(this.state,e.id)}payForNewPawn(e,t,i){const s=r.Economy.payToHex(this.state,t.id,e,o.Rules.getPawnRules(this.state,i)?.cost||0);return s.apply(this.state),s.getTransactions()}payToHex(e,t,i,s){const n=r.Economy.payToHex(this.state,i.id,t,s);return n.apply(this.state),n.getTransactions()}loot(e){const t=r.Economy.loot(e);return t.apply(this.state),t.getTransactions()}budgetOf(e){return r.Economy.getRegionBudget(this.state,e.id)}}t.EconomyModel=h},53010:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TooltipMode=t.TooltipContent=t.Container=t.Triangle=void 0,t.Triangle=Phaser.GameObjects.Triangle,t.Container=Phaser.GameObjects.Container;const s=i(2426),n=i(87521),o=i(20227),a=i(80959),r=i(76049),l=i(96137),c=i(20087),d=i(72843),h=i(11862);class u extends t.Container{constructor(e){super(e),this.counters=[],this.padding=0,this.tweener=new o.Tweener(this.scene,{duration:d.LAYOUT.expandTransitionDuration,ease:"Sine.easeInOut"}),this.fullSize={width:0,height:0};const t=a.UiBuilder.for(e);this.countersPool=new n.Pool((()=>({icon:t.image("").setOrigin(0,.5),text:t.text("",r.BitmapFont.Mini,l.Colors.glassUi_old.primaryText).setOrigin(0,.5)}))).preload(1),this.icon=t.image(""),this.title=t.text("title",r.BitmapFont.Mini,l.Colors.tooltip.text),this.titleRevealTypewriter=new h.Typewriter(this.title),this.description=t.text("tooltip description",r.BitmapFont.Mini,l.Colors.tooltip.text).setMaxWidth(d.LAYOUT.maxWidth),this.backgroundBox=new s.RoundedRect(e,{radius:6,fillStyle:{color:l.Colors.tooltip.background,alpha:1}}),this.backgroundBox.preUpdate.enableEagerUpdates(),this.add([this.backgroundBox,this.title,this.icon,this.description])}startTypeWriterEffect(e){this.titleRevealTypewriter.start(e,d.LAYOUT.typewriterInterval)}endTypeWriterEffect(){this.titleRevealTypewriter.stop()}setProps(e){const t=e.style??d.TOOLTIP_STYLE.default;this.padding=t.padding,e.icon?(this.icon.setFrame(e.icon),this.icon.setVisible(!0)):this.icon.setVisible(!1);const i=this.scene.cameras.main.zoom>1?r.BitmapFont.Mini2x:r.BitmapFont.Mini;this.title.setFont(i),this.description.setFont(i),this.title.setText(e.title),this.description.setText(e.description??""),this.description.setVisible(!1),this.counters.forEach((e=>{this.remove([e.icon,e.text]),e.icon.setVisible(!1),e.text.setVisible(!1),this.countersPool.free(e)})),this.counters=[],e.counters?.forEach((e=>{const t=this.countersPool.take();t.icon.setFrame(e.icon).setOrigin(0,.5).setTint(e.color).setVisible(!0),t.text.setText(e.value.toString()).setTint(e.color).setVisible(!0),this.add([t.icon,t.text]),this.counters.push(t)})),this.updateLayout(),e.typewriter&&this.startTypeWriterEffect(e.title)}updateLayout(){const e=!!this.description.text.length;this.icon.setOrigin(0,0),c.Arrange.leftToRight({content:[this.icon,this.title],x:this.padding,origin:0,spacing:d.LAYOUT.spacing}),c.Arrange.alignY({content:[this.icon,this.title],y:this.padding+this.title.height/2,origin:.5});let t=this.title.x+this.title.width;this.counters.length&&(t+=d.LAYOUT.spacing);const i=this.padding+this.title.height/2;for(const e of this.counters)t+=d.LAYOUT.spacing,e.icon.setPosition(t,i),t+=e.icon.width+4,e.text.setPosition(t,i),t+=e.text.width;this.description.setPosition(this.padding,this.title.y+this.title.height+d.LAYOUT.spacing),this.width=t+this.padding,this.height=this.title.y+this.title.height+this.padding,this.fullSize.width=Math.max(this.width,this.description.x+this.description.width+this.padding),this.fullSize.height=e?this.description.y+this.description.height+this.padding:this.height,this.backgroundBox.setPosition(0,0),this.backgroundBox.setSize(this.width,this.height)}expand(){if(!this.description.text.length)return;this.description.setVisible(!0),this.height=this.fullSize.height,this.width=this.fullSize.width;const e=this.description.maxWidth;this.tweener.add({targets:this.description,alpha:{from:0,to:1},maxWidth:{from:0,to:e},scale:{from:0,to:1}}),this.tweener.add({targets:this.backgroundBox,width:this.width,height:this.height})}destroy(e){this.endTypeWriterEffect(),super.destroy(e)}}var p;t.TooltipContent=u,function(e){e.Hidden="hidden",e.Shown="shown",e.Expanded="expanded",e.ScheduledToShow="about-to-show"}(p||(t.TooltipMode=p={}))},53096:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexGroupValuationWithHeap=void 0;const n=i(65415),o=s(i(65731));class a extends n.CustomHexGroupValuation{constructor(e,t){super(e),this.rankFn=t,this.clear()}set(e,t){super.set(e,t),this.heap.push({id:e,value:t})}pop(){const e=this.heap.pop();return void 0===e?e:super.get(e.id)!==e.value?this.pop():e}peek(){return this.heap.peek()}size(){return this.heap.size()}unset(e){super.unset(e)}clear(){super.clear(),this.heap=new o.default(((e,t)=>this.rankFn(e.value)-this.rankFn(t.value)))}}t.HexGroupValuationWithHeap=a},53320:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.moveZombies=function(e,t,i){const s=e.pawns.all().filter((e=>e.type===r.PawnType.LadderZombie)),n=e.pawns.all().filter((e=>e.type===r.PawnType.Zombie));for(;s.length;){let n=s.shift();g(e,t,n,i)}for(n.sort(((t,i)=>l.Bandits.getNearestLootDistance(e.state,t.hex.id)-l.Bandits.getNearestLootDistance(e.state,i.hex.id)));n.length;){let s=n.shift();g(e,t,s,i)}},t.pickHexToEnter=m;const s=i(56038),n=i(63521),o=i(56824),a=i(20693),r=i(24598),l=i(77330),c=i(35800),d=i(52307),h=i(78635),u=i(81434),p=i(9292);function g(e,t,i,s){if(!i.exists)return;const o=i.type===r.PawnType.LadderZombie,a=m(e,i.hex,o);if(a){const l=e.warfare.getOccupyingUnit(a),c=e.regions.byHex(a)?.faction,h=i.hex,u=(0,d.isUndeadTerritory)(e.state,i.hex)&&!(0,d.isUndeadTerritory)(e.state,a);u&&c&&s.push({hexId:a.id,originalFactionId:c?.id}),l?.hasTrait(n.PawnTraits.Unit)?(t.move({pawnId:i.id,destHex:a,mergeData:{mergedWith:l.id,outputType:r.PawnType.Zombie},captureHex:u,tapUnit:!1}),t.create({type:r.PawnType.Zombie,hex:h,captureHex:!1,sourceHex:h,tapUnit:!1})):l?.type===r.PawnType.Town?(t.move({pawnId:i.id,destHex:a,mergeData:{mergedWith:l.id,outputType:r.PawnType.HauntedTown},captureHex:u,tapUnit:!1}),u||t.takeOverHex(a,e.factions.neutral)):t.move({pawnId:i.id,destHex:a,captureHex:u,tapUnit:!1,defeatedUnit:l&&{pawnId:l.id},replace:o?r.PawnType.Zombie:void 0})}else!o&&i.hex.neighbours((t=>function(e,t,i){const s=l.Bandits.getNearestLootDistance(e,t.id);return l.Bandits.getNearestLootDistance(e,i.id)<s}(e.state,i.hex,t))).find((t=>f(e.state,i.hex,t)))&&t.replace(i,r.PawnType.LadderZombie)}function m(e,t,i,s=!1){const n=t.neighbours().map((n=>({hex:n,score:y(e,t,n,i,s)}))),o=n.reduce(((e,t)=>t.score>e?t.score:e),0);if(0!==o)return n.find((e=>e.score===o))?(0,c.deterministicRandomHexFrom)(e,a.HexGroup.from(n.filter((e=>e.score===o)).map((e=>e.hex)))):void 0}function y(e,t,i,o,a){if(!function(e,t,i,o){if(!s.Regions.getByHex(e,i.id))return!1;const a=h.Warfare.getOccupyingPawn(e,i),l=f(e,t,i);return!(a&&l&&a.type!==r.PawnType.Town||a&&(a.hasTrait(n.PawnTraits.ZombieResistant)||a.hasTrait(n.PawnTraits.Impenetrable)||a.type===r.PawnType.Town&&(0,d.isUndeadTerritory)(e,i))||l&&!o)}(e.state,t,i,o))return 0;let c=function(e,t,i){const s=e.warfare.getOccupyingUnit(i),o=i.neighbours((t=>[r.PawnType.Zombie,r.PawnType.LadderZombie].includes(e.warfare.getOccupyingUnit(t)?.type))).length;return s?.type===r.PawnType.Town?30-o:s?.hasTrait(n.PawnTraits.Unit)?20-o:(0,p.pickLarger)(1,(10-o)/l.Bandits.getNearestLootDistance(e.state,i.id))}(e,0,i);const u=e.warfare.getOccupyingUnit(i),g=l.Bandits.getNearestLootDistance(e.state,t.id),m=l.Bandits.getNearestLootDistance(e.state,i.id);return f(e.state,t,i)&&!o||!u&&m>g&&!a?0:c}function f(e,t,i){if((0,d.isUndeadTerritory)(e,t)){if((0,d.isUndeadTerritory)(e,i))return!1;if(0===h.Warfare.getHexStaticDefense(e,i.id))return!1}return!u.Pawns.model(e).presentAtHex(i,r.PawnType.HauntedTown)&&(0,d.crossesWall)(e,t,i)}o.logger.for("zombies")},53360:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isAISpectatingMode=function(){return s.app.screen.play.context===n.NewGameStateContext.ContinueSpectatingAfterGameOver},t.isHalloweenMode=function(){return a.config.flags.halloween&&!1===o.inject.userData.recallChoice("disableHalloweenMode")};const s=i(54825),n=i(71021),o=i(91622),a=i(56824)},53597:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildRegionsGenerationConfig=function(e){let t=1,i=1;switch(e.difficulty){case a.MapDifficulty.Casual:t=2;break;case a.MapDifficulty.Unfair:i=e.mode!==a.MapMode.KingsLanding?2:1.3}e.mode===a.MapMode.KingsLanding&&(t=.5);const n={...e,aiAdvantage:i,playerAdvantage:t,noPlayerTowns:e.mode===a.MapMode.KingsLanding,banCoastalProvinces:e.mode===a.MapMode.KingsLanding};switch(e.mode){case a.MapMode.Classic:case a.MapMode.Christmas:case a.MapMode.KingsLanding:case a.MapMode.Occupation:return r(n);case a.MapMode.Zombies:const e=r(n);return e.featuresPool=[s.PawnType.HauntedTown,s.PawnType.HauntedTown,s.PawnType.HauntedTown,s.PawnType.GoldMine],0===e.features&&(e.features=1),e;case a.MapMode.Colonization:return function(e){const t={startingCoins:10,seed:e.seed,coloration:0,clustering:o.random.numberBetween(0,.5),cellSeparation:2,features:l(e.size),featuresPool:[s.PawnType.Camp,s.PawnType.GoldMine]};let i;switch(e.size){case a.MapSize.Small:return i=o.random.integerBetween(2,3),{...t,minCellSize:i,maxCellSize:4,startingTiles:i,factions:c(o.random.integerBetween(3,5),e),cellCohesion:o.random.numberBetween(.5,1)};case a.MapSize.Medium:return i=o.random.integerBetween(2,3),{...t,minCellSize:i,maxCellSize:o.random.integerBetween(i+1,7),startingTiles:i,factions:c(o.random.integerBetween(4,6),e),cellCohesion:o.random.numberBetween(.5,1)};case a.MapSize.Large:return i=o.random.integerBetween(3,4),{...t,minCellSize:i,maxCellSize:o.random.integerBetween(i+1,7),startingTiles:i,factions:c(6,e),cellCohesion:o.random.numberBetween(.5,1)}}}(n);case a.MapMode.Crowded:return function(e){const t={startingCoins:10,seed:e.seed,coloration:1,clustering:0,cellSeparation:2,features:0,featuresPool:[]};let i;switch(e.size){case a.MapSize.Small:return i=o.random.integerBetween(5,6),{...t,minCellSize:2,maxCellSize:4,startingTiles:o.random.integerBetween(30,50)/i,factions:c(i,e),cellCohesion:o.random.numberBetween(.5,1)};case a.MapSize.Medium:return i=o.random.integerBetween(5,6),{...t,minCellSize:o.random.integerBetween(2,3),maxCellSize:5,startingTiles:o.random.integerBetween(50,80)/i,factions:c(i,e),cellCohesion:o.random.numberBetween(.5,1)};case a.MapSize.Large:return i=6,{...t,minCellSize:o.random.integerBetween(2,3),maxCellSize:6,startingTiles:o.random.integerBetween(80,120)/i,factions:c(6,e),cellCohesion:o.random.numberBetween(.5,1)}}}(n)}};const s=i(24598),n=i(1326),o=i(56824),a=i(85072);function r(e){const t={startingCoins:10,seed:e.seed,coloration:1,clustering:o.random.numberBetween(0,.3),cellSeparation:2,features:l(e.size),featuresPool:[s.PawnType.Camp,s.PawnType.GoldMine]};let i;switch(e.size){case a.MapSize.Small:return i=o.random.integerBetween(2,3),{...t,minCellSize:i,maxCellSize:4,startingTiles:i*o.random.integerBetween(1,2),factions:c(o.random.integerBetween(3,5),e),cellCohesion:o.random.numberBetween(.5,1)};case a.MapSize.Medium:return i=o.random.integerBetween(2,3),{...t,minCellSize:i,maxCellSize:o.random.integerBetween(i+1,7),startingTiles:i*o.random.integerBetween(2,3),factions:c(o.random.integerBetween(4,6),e),cellCohesion:o.random.numberBetween(.5,1)};case a.MapSize.Large:return i=o.random.integerBetween(3,4),{...t,minCellSize:i,maxCellSize:o.random.integerBetween(i+1,7),startingTiles:i*o.random.integerBetween(3,4),factions:c(6,e),cellCohesion:o.random.numberBetween(.5,1)}}}function l(e){switch(e){case a.MapSize.Small:return o.random.integerBetween(0,2);case a.MapSize.Medium:return o.random.integerBetween(0,3);case a.MapSize.Large:return o.random.integerBetween(0,5)}}function c(e,t){return[{controller:s.FactionController.LocalUser,startingTilesMultiplier:t.playerAdvantage,townsMultiplier:t.noPlayerTowns?0:void 0,banCoastalProvinces:t.banCoastalProvinces},...(0,n.range)(2,e).map((e=>({controller:s.FactionController.Ai,startingTilesMultiplier:t.aiAdvantage})))]}},53720:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Stopwatch=void 0,t.Stopwatch=class{constructor(){this.startTime=void 0,this.totalMs=0,this.paused=!1}isRunning(){return this.startTime}isPaused(){return!this.isRunning()}start(){this.startTime=Date.now()}pause(){this.updateTotalMs(),this.startTime=void 0}reset(){this.totalMs=0,this.isRunning()&&(this.startTime=Date.now())}updateTotalMs(){this.startTime&&(this.totalMs+=Date.now()-this.startTime,this.startTime=Date.now())}getElapsedSeconds(){return this.updateTotalMs(),this.totalMs/1e3}}},53847:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StubTool=t.SelectTool=void 0,t.SelectTool=class{constructor(){this.options={title:"Select",description:"Select objects/provinces",allowSelectBrush:!1},this.iconRecipe="editor/arrow"}useOn(e,t){}},t.StubTool=class{constructor(){this.options={title:"Stub Tool",description:"NOT IMPLEMENTED YET",allowSelectBrush:!1},this.iconRecipe="editor/arrow"}useOn(e,t){}}},53948:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Estimator=void 0;const s=i(56824);s.logger.for("Estimator"),t.Estimator=class{constructor(e,t){this.id=e,this.learningRate=.3;const i=Number(s.storage.getItem(this.storageKey));!i||isNaN(i)?this.ratio=t:this.ratio=i,this.storageKey=`konkr.estimator-${e}`}estimate(e){return e*this.ratio}learn(e,t){const i=t/e;this.setRatio(this.ratio*(1-this.learningRate)+i*this.learningRate)}setRatio(e){this.ratio=e,s.storage.setItem(this.storageKey,this.ratio.toString())}}},54118:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VLayout=t.LayoutChildrenPolicy=void 0;const s=i(86545),n=i(20087);var o,a=Phaser.GameObjects.BitmapText;!function(e){e.None="none",e.Stretch="stretch"}(o||(t.LayoutChildrenPolicy=o={}));class r extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.props={layoutPolicy:o.Stretch,originX:0,originY:0,horizontalPadding:0,verticalPadding:0,width:0,...t},this.width=this.props.width,this.add(t.content)}handleChildResize(e){this.preUpdate.makeDirty(),this.updateSize()}updateLayout(){const e=this.props.content;if(this.props.layoutPolicy===o.Stretch)for(let t of e)t instanceof a?t.setMaxWidth(this.width):t.width=this.width;n.Arrange.fromTopToBottomOld(e,{x:this.width*this.props.originX,y:this.height*this.props.originY,originX:this.props.originX,originY:this.props.originY,spacing:this.props.spacing}),this.updateSize()}calculateHeight(){const e=this.props.content[this.props.content.length-1];return e?e.y+e.height:0}}t.VLayout=r},54306:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResizableDOMElement=void 0;var s=Phaser.GameObjects.DOMElement;const n=i(9292);t.ResizableDOMElement=class extends s{constructor(e,t,i,s,o,a){super(e,t,i,s,o,a),this._suppressed=!1,this.storedPosition={x:0,y:0},this.node.style.transform="translate(-10000px, -10000px)",this.node.style.left="0px",Object.defineProperties(this,{width:{set:e=>{(0,n.pickLarger)(this.node.offsetWidth,this.displayWidth),this.node.style.width=`${e}px`},get:()=>this._width??this.node.offsetWidth},height:{set:e=>{this.node.style.height=`${e}px`},get:()=>(0,n.pickLarger)(this.node.offsetHeight,this.displayHeight)}}),this.scene.registerDOMElement(this)}_suppress(){this._suppressed||(this._suppressed=!0,this.storedPosition={x:this.node.style.left,y:this.node.style.top},this.node.style.top="-10000px",this.node.style.left="-10000px")}_unsuppress(){this._suppressed&&(this.node.style.top=this.storedPosition.y,this.node.style.left=this.storedPosition.x,this._suppressed=!1)}}},54330:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncBuffer=void 0,i(56824).logger.for("AsyncBuffer"),t.AsyncBuffer=class{constructor(){this.pendingKeys=new Set}flush(){this.currentPromise&&(this.currentCallback?.(),this.currentPromise=void 0,this.currentCallback=void 0,this.pendingKeys.clear())}async schedule(e,t){if(!this.pendingKeys.has(e))return this.pendingKeys.add(e),this.currentPromise||(this.currentPromise=new Promise((e=>{this.currentCallback=()=>{e()}}))),await this.currentPromise,t()}}},54429:(e,t)=>{"use strict";var i,s;Object.defineProperty(t,"__esModule",{value:!0}),t.LevelFilter=t.OverworldMapLayers=void 0,function(e){e[e.Lines=0]="Lines",e[e.Islands=1]="Islands"}(i||(t.OverworldMapLayers=i={})),function(e){e.Disabled="disabled",e.All="all",e.Unlocked="unlocked",e.Silver="silver",e.Gold="gold"}(s||(t.LevelFilter=s={}))},54513:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugColors=void 0,t.guides=function(e,t){return new r(e,t)};const s=i(4440),n=i(76049),o=i(56824);var a=Phaser.GameObjects.BitmapText;t.DebugColors={blue:255,purple:10944721};class r{_add(e){o.config.debug.overlay?(this.container?this.container.add(e):this.scene.add.existing(e),this.objects.push(e),e.setDepth(1e5)):e.destroy()}constructor(e,i="blue"){this.objects=[],this.color=t.DebugColors[i]??t.DebugColors.blue,e instanceof s.Scene?this.scene=e:(this.container=e,this.scene=e.scene)}clear(){for(let e of this.objects)e.destroy();this.objects=[]}rect(e,t){return this._add(new Phaser.GameObjects.Rectangle(this.scene,e.x-.5,e.y-.5,e.width,e.height).setOrigin(0,0).setStrokeStyle(1,this.color)),t&&this.text(e.x+2,e.y+2,t),this}point(e,t,i){return this._add(new Phaser.GameObjects.Line(this.scene,e-8-.5,t-.5,0,0,16,0,this.color).setOrigin(0,0).setLineWidth(1)),this._add(new Phaser.GameObjects.Line(this.scene,e-.5,t-8-.5,0,0,0,16,this.color).setOrigin(0,0).setLineWidth(1)),i&&this.text(e+2,t+2,i),this}text(e,t,i){return this._add(new a(this.scene,e,t,n.BitmapFont.Debug,i).setTint(this.color)),this}horizontal(e,t){return this._add(new Phaser.GameObjects.Line(this.scene,0,e-.5,0,0,this.scene.cameras.main.displayWidth,0,this.color).setLineWidth(.5).setOrigin(0,0)),t&&this.text(2,e+2,t),this}vertical(e,t){return this._add(new Phaser.GameObjects.Line(this.scene,e-.5,0,0,0,0,this.scene.cameras.main.displayHeight,this.color).setLineWidth(.5).setOrigin(0,0)),t&&this.text(e+2,2,t),this}}},54530:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionPoliticsView=t.DiplomaticStatus=void 0;const s=i(24598),n=i(90952),o=i(19618),a=i(20754),r=i(70712),l=i(76439),c=i(78436),d=i(56038),h=i(91622),u=i(74783),p=i(19506);var g;!function(e){e.Alliance="alliance",e.Truce="truce",e.Skirmish="skirmish",e.War="war"}(g||(t.DiplomaticStatus=g={}));class m extends a.LazyView{constructor(){super([n.GameState.ai.credit,n.GameState.ai.attritionByRegion,n.GameState.ai.assetsValueByRegion]),this.name="regionPoliticsView"}calculate(e,t){const i=o.Factions.getByRegion(e,t),n={};return o.Factions.model(e).all().filter((e=>e.controller!==s.FactionController.None&&e.id!==i&&e.isAlive())).forEach((s=>{const o={fear:h.inject.views.fear.get(e,{fromFactionId:i,towardsFactionId:s.id}),credit:r.AI.getFactionCredit(e,i,s.id),receivedAttrition:r.AI.getRegionAttrition(e,t,s.id),inflictedAttrition:r.AI.getFactionAttrition(e,s.id,i)};n[s.id]={...o,status:this.calculateStatus(d.Regions.model(e).byId(t),o)}})),n}calculateStatus(e,t){const i=e.size;return t.receivedAttrition<10&&t.inflictedAttrition<10?t.credit>u.CREDIT_MAJOR_THRESHOLD?g.Alliance:g.Truce:t.receivedAttrition<i&&t.credit>-u.CREDIT_MAJOR_THRESHOLD?g.Skirmish:g.War}getCacheKey(e){return e}getDebugLayer(){return new l.GameStateDebugLayer((0,c.regionBasedAdapter)({getValue:(e,t)=>{const i=this.get(e,t);return`${Object.values(i).map((e=>e.status[0].toUpperCase())).filter((e=>"T"!==e)).join("")}`},getDetail:(e,t)=>{const i=this.get(e,t);return Object.entries(i).map((([e,t])=>`${p.GLYPH.factions[Number(e)]} ${t.status} (${t.inflictedAttrition?p.GLYPH.sword+t.inflictedAttrition+" ":""}${t.receivedAttrition?p.GLYPH.defense+t.receivedAttrition+" ":""}credit ${t.credit.toFixed(0)}, fear ${t.fear})`)).join("\n")}}))}}t.RegionPoliticsView=m},54764:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefeatScene=void 0;const s=i(897),n=i(30948),o=i(81700),a=i(76738),r=i(76049),l=i(96137),c=i(36868),d=i(80959),h=i(20087),u=i(11466),p=i(54825),g=i(56824),m=i(80075),y=i(19618);var f=Phaser.GameObjects.Image,w=Phaser.GameObjects.BitmapText,v=Phaser.GameObjects.Graphics;class b extends n.BaseUIScene{constructor(){super({key:o.Scenes.Defeat}),this.preUpdate=(0,s.whenDirty)((()=>{let e;(0,m.canRewind)()?(e=this.rewindButton,this.replayButton.setVisible(!1)):(e=this.replayButton,this.rewindButton.setVisible(!1)),this.keepWatchingButton.setVisible(this.canKeepWatching()),e.setVisible(!0),this.ribbon.width=400,p.app.device.uiVariant()===u.UiVariant.Compact?(h.Arrange.topToBottom({content:[this.ribbon,this.keepWatchingButton,e,this.restartButton,this.menuButton],spacing:10,y:this.bounds.height-20,origin:1}),h.Arrange.alignX({content:[e,this.restartButton,this.menuButton,this.keepWatchingButton],x:this.bounds.centerX,origin:.5}),this.ribbon.x=this.bounds.centerX-this.ribbon.width/2):(this.ribbon.setPosition(this.bounds.centerX-this.ribbon.width/2,this.bounds.height-170),h.Arrange.leftToRight({content:[e,this.restartButton,this.menuButton],x:this.bounds.centerX,origin:.5,spacing:10}),h.Arrange.alignY({content:[e,this.restartButton,this.menuButton],y:this.bounds.height-60,origin:.5}),this.keepWatchingButton.setPosition(this.bounds.centerX-this.keepWatchingButton.width/2,this.restartButton.y-10-this.keepWatchingButton.height)),this.ribbonText.setPosition(this.bounds.centerX,this.ribbon.y+6),this.gravestone.setPosition(this.bounds.centerX,this.ribbon.y-20),this.background.clear(),this.background.fillGradientStyle(0,0,0,0,0,0,.5,.5),this.background.fillRect(0,this.bounds.height-200,this.bounds.width,200)}))}create(){super.create();const e=d.UiBuilder.for(this);this.restartButton=e.wood.primaryButton({text:"RESTART",onClicked:()=>{g.events.trigger(c.UserActions.RestartLevel({}))}}),this.rewindButton=e.wood.secondaryButton({text:"REWIND",icon:"ui/button-icons/rewind",iconPlacement:"left",tintIcon:!0,onClicked:()=>{g.events.trigger(c.UserActions.StartRewind())}}),this.replayButton=e.wood.primaryButton({text:"VIEW REPLAY",onClicked:()=>{g.events.trigger(c.UserActions.ViewReplay())}}),this.menuButton=e.wood.secondaryButton({text:"LEAVE",onClicked:()=>{g.events.trigger(c.UserActions.Escape())}}),this.keepWatchingButton=e.wood.secondaryButton({text:"SPECTATE",onClicked:()=>{g.events.trigger(c.UserActions.KeepWatching())}}),this.ribbon=new a.Ribbon(this,a.RibbonTextures.Pergamen,0,0,400),this.ribbonText=new w(this,0,0,r.BitmapFont.Main,"Oh no! We have been defeated!").setTint(l.Colors.woodenUi.primaryText).setOrigin(.5,0),this.gravestone=this.createImage("gravestone"),this.background=new v(this),this.addAll([this.background,this.gravestone,this.menuButton,this.restartButton,this.rewindButton,this.replayButton,this.keepWatchingButton,this.ribbon,this.ribbonText])}createImage(e){return new f(this,0,0,"gameOverAtlas",e)}canKeepWatching(){return y.Factions.model(p.app.scene.play.cursor.currentState).alive().length>1}}t.DefeatScene=b},54825:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.app=void 0,t.setAppContext=function(e){if(t.app)throw new Error("phaser context already initialized");t.app=new Proxy(e,{get(e,t,i){if(e.hasOwnProperty(t))return Reflect.get(e,t,i);throw new Error(`attempted to access unitialized property "${String(t)}"`)}})}},54843:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TypedEventBus=void 0;const s=i(1326),n=i(56824).logger.for("events");class o{constructor(e){this.parent=e,this.handlers={}}on(e,t){(0,s.pushIntoArrayByKey)(this.handlers,e.eventName,t);const i=this.on.bind(this),n=this.handlers;return{unsubscribe(){(0,s.removeFromArrayInPlace)(n[e.eventName],t)},on:i}}trigger(e){let t=!1,i=!1;for(let s of this.handlers[e.name]||[])if(i=!0,s(e.payload,(()=>t=!0)),t)return;t=!1,this.defaultHandler&&(this.defaultHandler(e,(()=>t=!0)),i=!0),t||(this.parent?this.parent.trigger(e):i||n.warning(`No handler currently registered for event ${e.name} - ignoring.`))}setDefaultHandler(e){this.defaultHandler=e}createChild(){return new o(this)}}t.TypedEventBus=o},55275:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stateContainer=function(e,t){let i=e;function s(){return i}return s.apply=(e="transition")=>{t(i,i,i,e)},s.update=(e,s="transition")=>{const n=i;i={...i,...e},t(e,i,n,s)},s},i(56824).logger.for("StateContainer")},55535:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PickLandingSpotPlugin=void 0;const s=i(18497);t.PickLandingSpotPlugin={name:s.PluginKey.PickLandingSpot,displayName:"King's Landing",icon:"ui/level-features/kings-landing",register(e){}}},55563:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Chest=void 0;const s=i(94233),n=i(56824),o=i(79573),a=i(91622);var r=Phaser.GameObjects.Image;const l=n.logger.for("coins");t.Chest=class extends r{constructor(e){super(e.scene,0,0,"atlas","chest"),this.pools=e,this.scene=this.pools.scene,this.currentAmount=0,this.setScale(.5)}addToTile(e,t,i){e.addObject(this,t,i)}addCoins(e){this.currentAmount+=e,this.updateVisibility()}consumeCoins(e){this.currentAmount+=e.length,this.updateVisibility(),a.inject.ui.skipTransitions()?e.forEach((e=>this.pools.free(e))):e.forEach(((e,t)=>{e.setDepth(o.WorldLayers.FlyingObject+10*this.y),(0,s.consumeCoin)(this.pools,e,this.x,this.y)}))}deleteCoins(e,t){this.currentAmount<e?(l.warning(`Attempted to delete ${e} coins from a virtual stack that already has only ${this.currentAmount} coins. Extra coins not deleted.`),this.currentAmount=0):this.currentAmount-=e,this.updateVisibility()}updateVisibility(){this.setVisible(this.currentAmount>0)}remainingCapacity(){return Number.POSITIVE_INFINITY}removeFromTile(e){e.removeObject(this)}spawnCoin(){return this.y,this.currentAmount-=1,this.updateVisibility(),this.pools.getCoin(this.x,this.y)}}},55776:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EmojiObject=t.EmojiContainer=void 0;var s=Phaser.GameObjects.Container;const n=i(97849),o=i(79573),a=i(56824),r=i(54825),l=i(7334),c=i(20227),d=i(74783),h=i(9292),u=i(7782),p=i(72843),g=i(68649),m=i(28250),y=i(34174),f=i(90824);a.logger.for("AttitudeEmoji");class w extends s{constructor(e){super(e.scene),this.pool=e,this.race=f.Race.Human,this.face=this.pool.getEmojiFace(12),this.faceBg=this.pool.getEmojiFaceBg(f.Race.Human),this.crown=this.pool.getEmojiCrown(),this.face.y=2,this.crown.y=-4,this.faceBg.y=0,this.add([this.faceBg,this.crown,this.face])}setFace(e,t){this.race===f.Race.Human&&this.face.setFrame("attitude-emoji/"+e)}setRace(e){this.race!==e&&(this.race=e,this.faceBg.setFrame(`attitude-emoji/${this.race}-bg`),this.hasEmotions()?this.face.setFrame("attitude-emoji/12"):(this.faceBg.clearTint(),this.face.setFrame(`attitude-emoji/${this.race}`)))}setColor(e){this.hasEmotions()&&this.faceBg.setTint(e)}hasEmotions(){return this.race===f.Race.Human}setLookingAt(e,t){this.face.setOrigin(e,t)}destroy(e){super.destroy(e),this.pool.free(this.face),this.pool.free(this.faceBg),this.pool.free(this.crown)}}t.EmojiContainer=w,t.EmojiObject=class{constructor(e){this.pools=e,this.isDestroyed=!1,this.tile=void 0,this.tween=void 0,this.tweener=new c.Tweener(this.pools.scene),this.container=new w(this.pools),this.emotionCooldown=new m.Cooldown(750),this.restingFaceIndex=12,this.speechBubble=void 0,this.horizontalOffset=new u.TransitionController(this.pools.scene,{ease:"Sine.easeInOut",duration:300,initialValue:0,applyValue:e=>{this.tile&&(this.container.y=this.tile.centerY-28+e)}}),this.emotionCooldown.onFinished((()=>{this.showRestingFace()}))}attachToTile(e){(0,n.assert)(!this.isDestroyed),this.tile=e,e.addObject(this.container,0,0),this.horizontalOffset.applyValue(0,0),this.container.setDepth(o.WorldLayers.UIOverlay+e.hex.y)}talk(e,t=0,i=1e3){if(this.tile&&!r.app.scene.worldMap.cameraController.isHexVisible(this.tile.hex))return;const s={placement:y.Placement.atGlobalXY(this.tile.centerX,this.tile.centerY,46),displayBelow:!1,style:p.TOOLTIP_STYLE.speechBubble,delayMs:t,enforceDelay:!0,title:e,typewriter:!0,expireAfterMs:i};this.speechBubble||(this.speechBubble=this.pools.tooltips.take(),this.pools.scene.add.existing(this.speechBubble)),this.speechBubble.showDelayed(s),this.speechBubble.setDepth(o.WorldLayers.UIOverlay+1e3)}shutUp(){this.speechBubble?.hide(),this.emotionCooldown.finishEarly()}setHeadwear(e){this.container.crown.setFrame("attitude-emoji/"+e)}setAttitude(e,t){this.setRestingFace((0,d.getEmojiIndex)(e,t)),this.container.setColor((0,d.getEmojiColor)(e,t))}setRestingFace(e){this.restingFaceIndex=e,this.emotionCooldown.isRunning()||this.showRestingFace()}startThinking(){this.container.setFace("thinking-1")}showRestingFace(){this.container.setFace(this.restingFaceIndex)}showEmotion(e,t){this.container.setFace(e),this.emotionCooldown.start(t)}setAlpha(e){this.container.setAlpha(e)}detachFromTile(){this.tile&&this.tile.removeObject(this.container)}reactTo(e){const t=e.openHostilityDelta;if(this.tile&&0!==t&&!(this.container.race===f.Race.Undead&&e.creditDelta>0)&&(a.config.flags.seeEnemyAttitudes&&r.app.scene.worldMap.vfx.popupText(this.tile.hex,(0,l.withSign)(100*t),t<0?52224:13369344),e.reason!==g.CreditShiftReason.Attacking)){if(e.creditDelta<-.01&&!this.tweener.hasTweens()&&e.reason!==g.CreditShiftReason.EndOfTurnAdjustment){this.showEmotion(this.pickEmotion(e));const t=Math.sqrt(Math.abs(100*e.openHostilityDelta)),i=(e.sourceHex?e.sourceHex.display.distanceTo(this.tile.hex)/2:0)+a.random.numberBetween(0,100);this.reactWithShock(t,i)}if(e.creditDelta>.01){if(e.newOpenHostility>=.6)return;const t=Math.ceil(Math.sqrt(Math.abs(100*e.openHostilityDelta)));this.reactWithHearts(t)}}}lookAtHex(e){if(!this.tile)return;const t=.1,i=(0,h.cropNumber)(this.tile.hex.x-e.x,-t,t),s=(0,h.cropNumber)(this.tile.hex.y-e.y,-t,t);this.container.setLookingAt(.5+i,.5+s)}resetLook(){this.container.setLookingAt(.5,.5)}reactWithShock(e,t=0){const i=100+4*e,s=e>=5?1.5*e:e;for(const e of this.tweener.getAllTweens())e.seek();this.tweener.add({targets:[this.container.face,this.container.faceBg],y:"-="+e,ease:"Sine.easeOut",delay:t,yoyo:!0,duration:i}),this.tweener.add({targets:[this.container.crown],y:"-="+s,ease:"Sine.easeOut",delay:t,yoyo:!0,duration:i})}pickEmotion(e){const{newOpenHostility:t,newConfidence:i}=e;return(0,d.getShockedFaceFor)(e.openHostilityDelta,i,t)}destroy(){(0,n.assert)(!this.isDestroyed),this.detachFromTile(),this.container.destroy(),this.speechBubble&&(this.pools.tooltips.free(this.speechBubble),this.speechBubble=void 0),this.isDestroyed=!0}reactWithHearts(e){const t=Array(e).fill(null).map(((e,t)=>this.pools.getHeart().setDepth(o.WorldLayers.UIOverlay+t).setOrigin(.5,.5))),i=(e,t,i,s)=>200*s;t.forEach((e=>{e.setAlpha(0)})),this.container.add(t),this.pools.scene.tweens.add({targets:t,x:{from:0,to:()=>0+a.random.numberBetween(-10,10)},y:{from:-16,to:-40+a.random.numberBetween(0,10)},delay:i,ease:"Sine.easeOut",duration:800,alpha:{from:0,to:1}}),this.pools.scene.tweens.add({targets:t,delay:(e,t,s,n)=>800+i(0,0,0,n),duration:200,alpha:{from:1,to:0},onComplete:()=>{t.forEach((e=>this.pools.free(e)))}})}setRace(e){this.container.setRace(e)}}},56038:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionMutations=t.Regions=void 0;const s=i(90952),n=i(19618),o=i(40020),a=i(20026),r=i(31835),l=i(97849),c=i(31011),d=i(45664),h=i(27109),u=i(13560),p=i(56824),g=i(88023),m=i(1326);class y{static model(e){return this.models.get(e)}static getAll(e){return(0,a.selectFromState)(e,s.GameState.regions.byId).keySeq().toArray()}static getByHex(e,t){return(0,a.selectFromState)(e,s.GameState.regions.byHex,t)}static getRegionData(e,t){return(0,a.selectFromState)(e,s.GameState.regions.byId,t)}static getAllRegionsHexes(e){return s.GameState.regions.byHex.getEntryIds(e)}static getRegionHexes(e,t){return(0,a.selectFromState)(e,s.GameState.regions.hexes,t)||a.EMPTY_SET}static getRegionEdgeHexes(e,t){return(0,a.selectFromState)(e,s.GameState.regions.edgeHexes,t)||a.EMPTY_SET}static getRegionBorderHexes(e,t){return(0,a.selectFromState)(e,s.GameState.warfare.borderHexes,t)||a.EMPTY_SET}static getBoundingBox(e){return(0,a.selectFromState)(e,s.GameState.regions.boundingBox)}static destroyRegions(e,...t){if(0===t.length)return e;const i=g.ImmutableSet.union(t.map((t=>y.getRegionHexes(e,t)))).toArray();return e=n.Factions.disownRegions(e,...t),e=(0,a.applyMutations)(e,s.GameState.regions.byHex.createMutation({delete:i},"destroyRegions"),s.GameState.regions.byId.createMutation({delete:t},"destroyRegions"),s.GameState.ai.attritionByRegion.createMutation({delete:t},"destroyRegions"))}static destroyAllEmptyRegions(e){const t=y.getAll(e).filter((t=>y.getRegionHexes(e,t).isEmpty()));return this.destroyRegions(e,...t)}static getSameRegionNeighbours(e,t){const i=this.getByHex(e,t.id);return t.neighbours((t=>this.getByHex(e,t.id)===i))}static getAdjacentForeignHexes(e,t){return this.model(e).byId(t).getHostileBorderHexes().neighbours().filter((i=>{const s=this.getByHex(e,i.id);return void 0!==s&&s!==t}))}static getRegionPower(e,t){return(0,a.selectFromState)(e,s.GameState.ai.powerByRegion,t)??{scaledTotal:0,rawTotal:0,factors:u.NO_ASSET_VALUE}}static getNextId(e){return(0,a.getParentEngine)(e).getNextId(s.GameState.regions.byId)}static getCoastalHexes(e){const t=new Set;let i=new Set(y.getAll(e));for(;i.size>0;){const n=Array.from(i).flatMap((t=>y.getRegionHexes(e,t).toArray()));let a=(0,m.findMin)(n,(e=>e));if(!a)return Array.from(t);const r=(0,d.getHex)(a).neighbour(o.HexDirection.UP_LEFT);l.assert.defined(r,`No top-left neighbour found for hex ${a}`),r.floodFillOut((i=>{const n=y.getByHex(e,i.id),o=i.neighbours().some((t=>!!y.getByHex(e,t.id)));return n?(t.add(i),s(n),!1):o}))}return Array.from(t);function s(t){if(!i.has(t))return;i.delete(t);const n=y.model(e).byId(t)?.getNeighbours().map((e=>e.id));n?.length&&n.forEach((e=>s(e)))}}static createRegion(e,t,i,s){const n=[f.createRegion(t,i)];return s&&n.push(f.addHexesToRegion(t,s)),(0,a.applyMutations)(e,...n)}static addHexesToRegion(e,t,i){const s=[f.addHexesToRegion(t,i)];return(0,a.applyMutations)(e,...s)}static removeHexesFromRegion(e,t){return(0,a.applyMutations)(e,s.GameState.regions.byHex.createMutation({delete:t},"removeHexesFromRegion"))}static isPotentialChokePoint(e,t){const i=(0,d.getHex)(t),s=this.getByHex(e,t);return i.disjointedNeighbourGroups((t=>this.getByHex(e,t.id)===s)).getGroups().length>1}static splitRegionIntoComponents(e,t){const i=this.model(e).byId(t),o=n.Factions.getByRegion(e,t);l.assert.defined(i,`no region found for id ${t}`);const r=i.hexes.components(),d=r.getLargestGroupKey();if(!d)return;r.removeGroup(d);const h=new c.MapMutationBuilder(s.GameState.regions.byId).init(e),u=new c.MapMutationBuilder(s.GameState.regions.byHex).init(e),g=new c.MapMutationBuilder(s.GameState.factions.byRegion).init(e);let m=y.getNextId(e);return r.forEach((e=>{h.set(m,{id:m,name:p.random.townName()}),u.setAll(Array.from(e).map((e=>e.id)),m),void 0!==o&&g.set(m,o),m++})),(0,a.applyMutations)(e,u.createMutation("regions.splitRegionIntoComponents"),h.createMutation("regions.splitRegionIntoComponents"),g.createMutation("regions.splitRegionIntoComponents"))}}t.Regions=y,y.models=new h.ModelsCache((e=>new r.RegionsDataSetModel(e)));class f{static createRegion(e,t){return s.GameState.regions.byId.createMutation({set:{[e]:{id:e,name:t}}},"createRegion")}static addHexesToRegion(e,t){const i={};return t.forEach((t=>{i[t]=e})),s.GameState.regions.byHex.createMutation({set:i},"addHexesToRegion")}}t.RegionMutations=f},56082:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FpsTracker=void 0;const s=i(54825);t.FpsTracker=class{constructor(){this.avgFps=0,this.minFps=0,this.samples=0}reset(){const e=s.app.game.loop.actualFps;this.avgFps=e,this.minFps=e,this.samples=1,this.timer||(this.timer=setInterval(this.update.bind(this),1e3))}update(){const e=s.app.game.loop.actualFps;e<this.minFps&&(this.minFps=e),this.avgFps=(this.avgFps*this.samples+e)/(this.samples+1),this.samples++}}},56337:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IsoTileGroup=t.Image=void 0,t.Image=Phaser.GameObjects.Image;const s=i(20693);i(56824).logger.for("IsoTileGroup"),t.IsoTileGroup=class{constructor(e){this.id=e,this.hexes=s.HexGroup.empty,this.tint=void 0}addHexes(e,t){const i=e.filter((e=>!this.hexes.has(e)));this.hexes=this.hexes.with(i);const s=i.getCorners();t&&s.forEach((e=>t.dirtyCorners.add(e)))}setHexes(e,t){const i=this.hexes.without(e),s=e.without(this.hexes);this.addHexes(s,t),this.removeHexes(i,t)}removeHexes(e,t){const i=e.filter((e=>this.hexes.has(e)));this.hexes=this.hexes.without(i);const s=i.getCorners();t&&s.forEach((e=>t.dirtyCorners.add(e)))}clear(e){this.hexes.getCorners().forEach((t=>e.dirtyCorners.add(t))),this.hexes=s.HexGroup.empty}getCornerVariant(e){return e.variant+e.sortedHexes.map((e=>this.hexes.has(e)?"1":"0")).join("")}}},56582:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeBanditsAct=function(e){const t=e.pawns.select({type:[o.PawnType.Bandit,o.PawnType.Bunny]}),i=new Set(t),l=new g.WorldUpdateBuilder(e),f=[],w={baseIncome:new s.CoinTransactionBuilder,buyUnits:new s.CoinTransactionBuilder,pillage:new s.CoinTransactionBuilder};for(let s of t){if(!s.exists||s.type!==o.PawnType.Bandit)continue;const t=e.regions.byHex(s.hex);c.assert.defined(t);const a=t?.id;if(!t?.isAlive()&&!t?.faction?.isNeutral()){const t=s.hex;l.takeOverHex(s.hex,e.factions.byId(n.SpecialFaction.neutral)),f.push({hexId:s.hex.id,originalRegionId:a});const o=(0,u.getOrCreateNearestCamp)(e.state,s.hex,l);o?.hex===t?w.pillage.from(t).spawn(1):void 0!==o&&w.pillage.from(t).spawn(1).send(o.hex),i.delete(s)}}e.restore(w.pillage.apply(e.state)),(0,p.moveBandits)(e,i,l);const v=e.factions.byId(n.SpecialFaction.neutral).getRegions().map((t=>Array.from(r.Bandits.getCampsByRegion(e.state,t.id)))).flat().map(d.getHex);v.forEach((t=>{if(e.economy.numberOfCoinsAt(t)>=3){const i=(0,p.pickHexToEnter)(e,t);if(i){const s=e.warfare.getOccupyingUnit(i),n=s?.id;l.create({hex:i,sourceHex:t,type:o.PawnType.Bandit,captureHex:!1,defeatedUnit:n?{pawnId:n}:void 0,tapUnit:!1}),w.buyUnits.from(t).consume(3)}}})),w.buyUnits.apply(e.state),v.forEach((e=>{w.baseIncome.from(e).spawn(1)})),w.baseIncome.apply(e.state),e.map.plugins.has(y.PluginKey.SpawnGifts)&&(0,m.spawnPresents)(e,l);const b=(0,h.mapDictionary)(w,(e=>e.getTransactions()));return l.addCoinTransaction(b.pillage),l.addCoinTransaction(b.buyUnits),l.addCoinTransaction(b.baseIncome),[a.GameStateEvents.BanditsActed({pillagedHexes:f,coinTransactions:b,worldUpdates:l.getUpdates()})]};const s=i(61510),n=i(67274),o=i(24598),a=i(36868),r=i(77330),l=i(56824),c=i(97849),d=i(45664),h=i(1326),u=i(83109),p=i(97337),g=i(78933),m=i(87452),y=i(18497);l.logger.for("bandits")},56622:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UndoButton=t.LargePlayUI=t.LevelSummaryVisibility=void 0,t.getUndoButtonX=V;const s=i(36868),n=i(79899),o=i(20938),a=i(13521),r=i(56824),l=i(60959),c=i(42067),d=i(63579),h=i(79349),u=i(61116),p=i(74023),g=i(7782),m=i(79589),y=i(39648),f=i(91622),w=i(2523),v=i(54825),b=i(80959),S=i(70842),x=i(24966),T=i(76049),P=i(96137),I=i(22663),C=i(98963),M=i(2426),A=i(86545),B=i(9292),E=i(2543),O=i(9537),R=i(67410),k=i(20227),L=i(80075);var _=Phaser.GameObjects.Image;const D=r.logger.for("PlayUI");var H;!function(e){e[e.Hidden=0]="Hidden",e[e.Shown=1]="Shown",e[e.ShownWithRollbackPanel=2]="ShownWithRollbackPanel"}(H||(t.LevelSummaryVisibility=H={})),t.LargePlayUI=class{constructor(e,t){this.scene=e,this.state=t,this.pawnHolder=new a.PawnHolder(this.scene),this.headerPanel=new h.HeaderMenuPanel(this.scene),this.menuButtonPanel=new R.MenuButtonPanel(this.scene),this.shoppingTray=new l.ShoppingTray(this.scene,c.LARGE_PLAY_UI_LAYOUT.shoppingTray),this.regionPanel=new o.LargeRegionPanel(this.scene),this.spectatorPanel=new d.LargeSpectatorPanel(this.scene),this.levelSummary=new m.LevelSummaryPanel(this.scene),this.livesCounter=new y.LivesCounter(this.scene,1),this.rewindControls=new w.RewindModeControls(this.scene,c.LARGE_PLAY_UI_LAYOUT.rewindControls),this.turnNumberText=b.UiBuilder.for(this.scene).text("Turn 2",T.BitmapFont.MiniBold,0),this.tutorialArrow=new S.TutorialArrow(this.scene),this.tutorialFrame=new x.TutorialFrame(this.scene),this.rollbackPanel=new p.RollbackPanel(this.scene,{onActionTaken:()=>{this.closeRollbackPanel()}}),this.restartButton=this.levelSummary.restartButton,this.rewindButton=this.levelSummary.rewindButton,this.rollbackPanelVisibility=new g.TransitionController(this.scene,{duration:c.LARGE_PLAY_UI_LAYOUT.rollbackPanel.transitionDuration,ease:"Sine.easeInOut",initialValue:0,applyValue:e=>{this.rollbackPanel.y=this.scene.bounds.height-this.rollbackPanel.height*e,this.rollbackPanel.setAlpha(e)}}),this.levelSummaryVisibility=new g.TransitionController(this.scene,{initialValue:H.Hidden,ease:"Sine.easeInOut",applyValue:e=>{if(e>=1){const t=e-1,i=this._getLevelSummaryY(-4*t);this.levelSummary.y=i,this.livesCounter.y=i+4,this.levelSummary.setAlpha(1-t),this.livesCounter.setAlpha(1),e===H.ShownWithRollbackPanel&&f.inject.gameStateController.rollbackAvailable,this.livesCounter.setMode(y.LivesCounterMode.FullColor)}else{const t=this._getLevelSummaryY(20*(1-e));this.levelSummary.setAlpha(e),this.livesCounter.setAlpha(e),this.levelSummary.y=t,this.livesCounter.y=t+4}},delay:c.LARGE_PLAY_UI_LAYOUT.rollbackPanel.transitionDuration/2,duration:c.LARGE_PLAY_UI_LAYOUT.rollbackPanel.transitionDuration/2}),this.visibility=new g.TransitionController(this.scene,{initialValue:1,applyValue:e=>{}}),this.endTurnButton=new j(this.scene),this.undoButton=new U(this.scene),this.buttonGlow=new F(this.scene),this.skipSpectatingButton=new N(this.scene),this.nextPendingRegionButton=new G(this.scene),this.bottomAnchoredComponents=[this.shoppingTray,this.regionPanel,this.spectatorPanel,this.endTurnButton,this.skipSpectatingButton,this.nextPendingRegionButton,this.undoButton,this.buttonGlow.overlayGlow,this.buttonGlow.staticGlow,this.rollbackPanel,this.levelSummary,this.livesCounter,this.turnNumberText,this.menuButtonPanel,...this.rewindControls.getGameObjects()],this.tweener=new k.Tweener(this.scene),f.inject.theme.use((e=>{this.turnNumberText.setTint(e.oceanContrastDark)})),this.endTurnButton.onClicked((e=>{e.rightButtonDown()||e.rightButtonReleased()?r.events.trigger(s.UserActions.Escape()):r.events.trigger(s.UserActions.EndTurn({force:e.event.ctrlKey}))})),this.nextPendingRegionButton.onClicked((()=>r.events.trigger(s.UserActions.SelectNextPendingRegion()))),this.skipSpectatingButton.onClicked((()=>r.events.trigger(s.UserActions.SkipSpectating()))),this.layer=new u.ResponsiveLayer(this.scene,[...this.rewindControls.getGameObjects(),this.levelSummary,this.shoppingTray,this.rollbackPanel,this.spectatorPanel,this.buttonGlow.staticGlow,this.endTurnButton,this.buttonGlow.overlayGlow,this.skipSpectatingButton,this.nextPendingRegionButton,this.undoButton,this.headerPanel,this.livesCounter,this.regionPanel,this.turnNumberText,this.tutorialFrame,this.tutorialArrow,this.menuButtonPanel]),this.scene.add.existing(this.layer),this.updateLayout(),f.inject.ui.withoutTransitions((()=>{this.updateState(this.state)})),this.rollbackPanel.hovering.watch((e=>{e?this.cancelRollbackPanelAutoHide():this.scheduleRollbackPanelAutoHide()})),this.rollbackPanelVisibility.applyValue(0,0)}getBottomPanelHeight(){if(v.app.navigator.currentScreen!==v.app.screen.play)return 0;switch(this.state.layout.name){case"play":return 155;case"spectate":return 70;case"rewind":return 110;case"hidden":return 0}}burnLife(){switch(this.state.layout.name){case"rewind":this.rewindControls.livesCounter.burnLife();break;case"play":this.livesCounter.burnLife(),(0,L.canRewind)()||this.levelSummary.rewindButton.setVisible(!1)}}openRollbackPanel(){this.cancelRollbackPanelAutoHide(),this.rollbackPanelVisibility.transitionTo(1),this.levelSummaryVisibility.transitionTo(H.ShownWithRollbackPanel)}closeRollbackPanel(){this.rollbackPanelVisibility.currentTarget>0&&(r.events.trigger(s.UiEvents.RollbackMenuClosed()),this.rollbackPanelVisibility.transitionTo(0),this.levelSummaryVisibility.transitionTo("play"===this.state.layout.name&&this.state.layout.showLevelSummary?H.Shown:H.Hidden))}isRollbackPanelOpen(){return this.rollbackPanelVisibility.currentTarget>0}cancelRollbackPanelAutoHide(){this.rollbackPanelHideTimeout&&(clearTimeout(this.rollbackPanelHideTimeout),this.rollbackPanelHideTimeout=void 0)}scheduleRollbackPanelAutoHide(){this.rollbackPanelHideTimeout||(this.rollbackPanelHideTimeout=setTimeout((()=>this.closeRollbackPanel()),500))}setVisible(e){this.layer.setVisible(e)}updateLayout(){this.setVisible(this.state.visible);const e=this.scene.bounds.width,t=this.scene.bounds.height;this.regionPanel.updateLayout(),this.shoppingTray.updateLayout(),this.spectatorPanel.updateLayout(),this.rewindControls.updateLayout(),this.menuButtonPanel.updateLayout(),this.endTurnButton.setPosition(e/2+c.LARGE_PLAY_UI_LAYOUT.spectatorPanel.width/2+c.LARGE_PLAY_UI_LAYOUT.primaryButtons.offsetFromMainPanel,t-c.LARGE_PLAY_UI_LAYOUT.primaryButtons.playModeOffsetFromBottom-this.endTurnButton.height),this.nextPendingRegionButton.copyPosition(this.endTurnButton),this.skipSpectatingButton.copyPosition(this.endTurnButton),this.undoButton.setPosition(V(this.scene),t-c.LARGE_PLAY_UI_LAYOUT.primaryButtons.playModeOffsetFromBottom-this.undoButton.height),this.buttonGlow.setPosition(this.endTurnButton.x+this.endTurnButton.width/2,this.endTurnButton.y+this.endTurnButton.height/2),this.headerPanel.setPosition(0,0),this.levelSummaryVisibility.setTo(this.levelSummaryVisibility.currentTarget),this.levelSummary.x=this.undoButton.x,this.levelSummary.setSize(this.undoButton.width,28),this.livesCounter.setSize(this.undoButton.width-10,20),this.livesCounter.x=this.undoButton.x,this.rollbackPanel.x=this.undoButton.x-6,this.rollbackPanel.width=this.undoButton.width+12,this.turnNumberText.setOrigin(.5,.5).setPosition(this.endTurnButton.x+this.endTurnButton.width/2,this.endTurnButton.y-4-this.levelSummary.height/2)}_getLevelSummaryY(e){return this.undoButton.y-4-this.levelSummary.height+e}hidePlayLayoutControls(){this.endTurnButton.setVisible(!1),this.buttonGlow.setVisible(!1),this.nextPendingRegionButton.setVisible(!1),this.undoButton.setVisible(!1),this.shoppingTray.setOpen(!1),this.turnNumberText.setVisible(!1),this.levelSummaryVisibility.transitionTo(H.Hidden)}updateState(e,t=!1){const i=this.state;if(this.state={...this.state,...e},this.spectatorPanel.updateState(e),this.regionPanel.updateState(e),this.rewindControls.updateState(e),void 0!==e.tutorialArrow&&(e.tutorialArrow?this.tutorialArrow.showAt(e.tutorialArrow):this.tutorialArrow.hide()),void 0!==e.tutorialFrame&&(e.tutorialFrame?this.tutorialFrame.showAt(e.tutorialFrame):this.tutorialFrame.hide()),void 0!==e.layout)switch(this.hideIrrelevantLayoutControls(e.layout.name),e.layout.name){case"hidden":case"rewind":break;case"spectate":this.skipSpectatingButton.setVisible(e.layout.enableSkipSpectating);break;case"play":this.endTurnButton.setVisible("endTurn"===e.layout.primaryButton||"highlightEndTurn"===e.layout.primaryButton),this.endTurnButton.setHighlighted("highlightEndTurn"===e.layout.primaryButton),this.buttonGlow.setVisible("highlightEndTurn"===e.layout.primaryButton),this.turnNumberText.setVisible(!0),this.nextPendingRegionButton.setVisible("nextRegion"===e.layout.primaryButton),this.undoButton.setVisible(!0),this.undoButton.setEnabled(e.layout.undoAvailable!==O.UndoAvailability.Unavailable),this.rollbackPanel.setRollbackEnabled(e.layout.enableRollback),this.levelSummary.rewindButton.setVisible(e.layout.enableRollback),this.rollbackPanel.setReplayEnabled(e.layout.enableReplay),this.levelSummaryVisibility.transitionTo(e.layout.showLevelSummary?H.Shown:H.Hidden);const t=e.layout.regionData;!t||e.layout.showRegionBudget?this.shoppingTray.setOpen(!1):t.controllable?(this.shoppingTray.setOpen(!0),this.shoppingTray.setColor(e.layout.activeFactionColor),this.shoppingTray.setBuyablePawns(t.buyablePawns)):t.controllable||this.shoppingTray.setOpen(!1)}void 0!==e.turnNumber&&this.turnNumberText.setText(`Turn ${e.turnNumber}`),void 0!==e.livesLeft&&this.livesCounter.setCount(e.livesLeft),void 0!==e.levelInfo&&this.headerPanel.props.update(e.levelInfo),void 0!==e.visible&&e.visible!==i.visible&&(e.visible?this.transitionIn(t?0:void 0):this.transitionOut(t?0:void 0))}hideIrrelevantLayoutControls(e){"play"!==e&&this.hidePlayLayoutControls(),"spectate"!==e&&this.skipSpectatingButton.setVisible(!1)}update(){this.pawnHolder.update(),this.tutorialArrow.updatePosition(),this.tutorialFrame.updatePosition()}destroy(){this.layer.destroy()}transitionIn(e=r.config.screenTransitionDuration){this.updateLayout(),this.tweener.add({targets:this.bottomAnchoredComponents,props:{y:{getStart:e=>e.y+160,getEnd:e=>e.y}},duration:e,ease:"Sine.easeOut",onComplete:()=>this.updateLayout()}),this.tweener.add({targets:this.headerPanel,props:{x:{getStart:e=>e.x-this.headerPanel.width,getEnd:e=>e.x}},ease:"Sine.easeOut",duration:e})}transitionOut(e=r.config.screenTransitionDuration){this.updateLayout(),this.setVisible(!0),this.tutorialArrow.visibility.transitionTo(0,{duration:e/2}),this.tutorialFrame.visibility.transitionTo(0,{duration:e/2}),this.tweener.add({targets:this.bottomAnchoredComponents,y:"+=160",duration:e,ease:"Sine.easeIn"}),this.tweener.add({targets:this.headerPanel,x:`-=${this.headerPanel.width}`,ease:"Sine.easeOut",duration:e})}getTooltipFor(e){switch(e){case this.undoButton.button:return"play"===this.state.layout.name&&this.state.layout.undoAvailable===O.UndoAvailability.Unavailable?{title:"No more moves to undo!"}:{title:"Undo last move.\nHold down to undo all moves."};case this.endTurnButton:return{title:"End your turn now"};case this.rollbackPanel.restartButton:case this.levelSummary.restartButton:return{title:"Restart level"};case this.rollbackPanel.rollbackButton:case this.levelSummary.rewindButton:return{title:"Rewind back to previous turn",description:"This will cost you one life!"};case this.levelSummary.replayButton:case this.rollbackPanel.replayButton:return{title:"View replay of last turn"};case this.regionPanel.nextRegionButton:return{title:"Select next province"};case this.regionPanel.prevRegionButton:return{title:"Select previous province"};case this.headerPanel.leaveButton:return{title:"Return to level selection",description:"Don't worry, your progress is saved automatically"};case this.nextPendingRegionButton:return{title:"Select next idle province"};default:return this.shoppingTray.getTooltipFor(e)??this.spectatorPanel.getTooltipFor(e)}}getIncomeLabelBounds(){const e=this.regionPanel.regionLabel.incomeText.getBounds(),t=this.regionPanel.regionLabel.trendIcon.getBounds();return Phaser.Geom.Rectangle.Union(e,t)}getTreasuryLabelBounds(){const e=this.regionPanel.regionLabel.treasuryText.getBounds(),t=this.regionPanel.regionLabel.treasuryIcon.getBounds();return Phaser.Geom.Rectangle.Union(e,t)}activate(e){this.setVisible(!0),this.updateState(e)}deactivate(){this.setVisible(!1)}};class j extends n.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/end-turn",down:!0})}setHighlighted(e){this.setBaseFrame(e?"ui/primary-buttons/end-turn-glow":"ui/primary-buttons/end-turn")}}class F{setVisible(e){this.staticGlow.setVisible(e),this.overlayGlow.setVisible(e)}constructor(e){this.scene=e,this.staticGlow=new _(this.scene,0,0,"atlas","ui/primary-buttons/static-glow").setTint(16777088),this.overlayGlow=new _(this.scene,0,0,"atlas","ui/primary-buttons/overlay-glow").setTint(16777088),this.scene.tweens.add({targets:this.staticGlow,scaleX:{from:.95,to:1.05},scaleY:{from:.9,to:1.1},yoyo:!0,repeat:-1,duration:350,ease:"Sine.easeInOut"}),this.scene.tweens.add({targets:this.overlayGlow,alpha:{from:0,to:1},duration:350,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}setPosition(e,t){this.staticGlow.setPosition(e,t),this.overlayGlow.setPosition(e,t)}}class U extends A.ResponsiveContainer{setEnabled(e){this.button.setEnabled(e)}constructor(e){super(e),this.button=new n.ImageButton(this.scene,0,0,{frame:"ui/primary-buttons/undo",down:!0,disabled:!0,audio:!1}),this.onClicked=this.button.onClicked,this.longPressProgress=new g.TransitionController(this.scene,{duration:800,ease:"Linear",applyValue:e=>{if(0===e)this.longPressProgressBar.setAlpha(0);else{this.longPressProgressBar.setAlpha((0,B.cropNumber)(1.5*(e-.25),0,1));const t=this.button.width+8,i=t*e;this.longPressProgressBar.setPosition(t-i-4,-4).setSize(i,this.button.height+8).preUpdate.force()}1===e&&this.undoAll()},initialValue:0}),this.longPressProgressBar=new M.RoundedRect(this.scene,{fillStyle:{color:P.Colors.glassUi.textDark,alpha:1},radius:8,y:0,x:0}).setAlpha(0),this.undoAll=(0,E.debounce)((()=>{v.app.audio.playEffect(C.SoundEffects.ButtonUp),r.events.trigger(s.UserActions.UndoAll()),this.button.setButtonState(I.ButtonState.Rest)}),500,{leading:!0,trailing:!1}),this.button.controller.onStateChanged((({newState:e,oldState:t})=>{const i=v.app.scene.playUI.currentState;"play"===i.layout.name?e===I.ButtonState.Down?(v.app.audio.playEffect(C.SoundEffects.ButtonDown),i.layout.undoAvailable===O.UndoAvailability.RollbackOnly?(this.longPressProgress.setTo(0),r.events.trigger(s.UserActions.OpenRollbackMenu())):i.layout.undoAvailable===O.UndoAvailability.Available?this.longPressProgress.transitionTo(1):this.longPressProgress.setTo(0)):t===I.ButtonState.Down&&this.longPressProgress.setTo(0):D.warning(`ignoring undoButton pointerdown in ${i.layout.name} layout`)})),this.button.onClicked((()=>{const e=v.app.scene.playUI.currentState;1!==this.longPressProgress.currentValue?(v.app.audio.playEffect(C.SoundEffects.ButtonUp),"play"===e.layout.name?e.layout.undoAvailable===O.UndoAvailability.Available&&r.events.trigger(s.UserActions.Undo()):D.warning(`ignoring undoButton click in ${e.layout.name} layout`)):this.longPressProgress.setTo(0)})),this.width=this.button.width,this.height=this.button.height,this.add([this.longPressProgressBar,this.button])}}t.UndoButton=U;class G extends n.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/next",down:!0})}}class N extends n.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/skip",down:!0,tooltip:"Skip watching enemy turn"})}}function V(e){return e.bounds.width/2-c.LARGE_PLAY_UI_LAYOUT.spectatorPanel.width/2-c.LARGE_PLAY_UI_LAYOUT.primaryButtons.offsetFromMainPanel-c.LARGE_PLAY_UI_LAYOUT.primaryButtons.width}},56643:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HtmlDocs=t.UI=t.ModalsManager=void 0;const s=i(81700),n=i(5365),o=i(79428),a=i(77328),r=i(75429),l=i(27387),c=i(25e3),d=i(84691),h=i(63032),u=i(11872),p=i(54825),g=i(8062),m=i(66143),y=i(91622),f=i(70080),w=i(68299),v=i(85711);t.ModalsManager=class{constructor(e){this.game=e}getModalWindowScene(){return this.game.scene.getScene(s.Scenes.ModalWindow)}show(e,t,i=()=>{}){c.NewsBox.hide(),this.ensureSceneRunning(),this.getModalWindowScene().pushModal(e,{...t,onClose:i})}close(){this.getModalWindowScene().closeModal()}message(e){return this.simpleDialog({title:"Message",message:e,buttons:[{text:n.DialogButtons.OK,role:h.DialogButtonRole.PrimaryGreen}]})}textInput(e){return new Promise((i=>{this.show(t.UI.textInputDialog,{...e},i)}))}simpleDialog(e){return new Promise((i=>{this.show(t.UI.simpleDialog,e,i)}))}async playAgainDialog(e){const i=m.LevelModel.for(e),s=i?.manifest?.fixedAIDifficulty;if(s||"hard"===y.inject.levelSession.aiDifficulty)return Promise.resolve({result:n.DialogButtons.Restart});const o=(0,v.ref)(y.inject.levelSession.aiDifficulty);return{result:await new Promise((e=>{this.show(t.UI.restartDialog,{title:"Play again",message:"Consider increasing the difficulty level for a greater challenge!",buttons:[{text:n.DialogButtons.Cancel,role:h.DialogButtonRole.Regular},{text:n.DialogButtons.Restart,role:h.DialogButtonRole.PrimaryGreen}],aiDifficulty:o,showDifficultySelector:!s},e)})),aiDifficulty:o.current}}async restartDialog(e,i){const s=m.LevelModel.for(e),o=s?.manifest?.fixedAIDifficulty,a=(0,v.ref)(y.inject.levelSession.aiDifficulty);return{result:await new Promise((e=>{this.show(t.UI.restartDialog,{title:"Restart Island",message:i??"Are you sure? Level progress will be lost!",buttons:[{text:n.DialogButtons.Cancel,role:h.DialogButtonRole.Regular},{text:n.DialogButtons.Restart,role:h.DialogButtonRole.PrimaryDanger}],aiDifficulty:a,showDifficultySelector:!o},e)})),aiDifficulty:a.current}}async confirmDifficulty(){const e=(0,v.ref)("normal");await new Promise((i=>{this.show(t.UI.restartDialog,{title:"From Ruler to Conqueror",message:"Well done, this concludes the tutorial!\nFrom now on, it's just you and a sea of Islands ripe for conquest!\n\nBefore you continue, you can [b]adjust the difficulty level[/b] of your rivals. \nUnless you really enjoy suffering, I recommend you stick with [i]Normal[/i] for now.\nYou can change this setting at any time on the level select screen!",buttons:[{text:n.DialogButtons.OK,role:h.DialogButtonRole.PrimaryGreen}],aiDifficulty:e,showDifficultySelector:!0},i)})),y.inject.userData.rememberChoice("aiDifficulty",e.current)}confirmEndTurn(){return this.defaultIfBypassed(n.DialogButtons.EndTurn)||this.simpleDialog({title:"End turn?",message:"Are you sure you want to end your turn already?",buttons:[{text:n.DialogButtons.Cancel,role:h.DialogButtonRole.Regular},{text:n.DialogButtons.EndTurn,role:h.DialogButtonRole.PrimaryDanger}]})}confirm(e,t,i){return this.defaultIfBypassed(e)||this.simpleDialog({title:t,message:i,buttons:[{text:n.DialogButtons.Cancel,role:h.DialogButtonRole.Regular},{text:e,role:h.DialogButtonRole.PrimaryDanger}]})}confirmRemoveFromFavorites(e){return this.defaultIfBypassed(n.DialogButtons.Remove)||this.simpleDialog({title:"Remove from Favorites?",message:`Are you sure you want to remove island [b]${e}[/b] from favorites?\n[i](next time you can hold Control to avoid this confirmation dialog)[/i]`,buttons:[{text:n.DialogButtons.Cancel,role:h.DialogButtonRole.Regular},{text:n.DialogButtons.Remove,role:h.DialogButtonRole.PrimaryDanger}]})}confirmDeleteMyIsland(e){return this.defaultIfBypassed(n.DialogButtons.Remove)||this.simpleDialog({title:"Delete Island?",message:`Are you sure you want to delete island [b]${e}[/b] from your domain?\nThis cannot be undone!`,buttons:[{text:n.DialogButtons.Cancel,role:h.DialogButtonRole.Regular},{text:n.DialogButtons.Remove,role:h.DialogButtonRole.PrimaryDanger}]})}confirmRevertSettings(){return this.simpleDialog({title:"Restore default preferences?",message:"Are you sure you want to reset user preferences back to defaults?",buttons:[{text:n.DialogButtons.Cancel,role:h.DialogButtonRole.Regular},{text:n.DialogButtons.Reset,role:h.DialogButtonRole.PrimaryDanger}]})}async confirmRestart(e,t){return this.defaultIfBypassed({result:n.DialogButtons.Restart})||this.restartDialog(e,t)}showIntro(e,i){return this.show(t.UI.scrollableTextDialog,{title:e,text:i.replaceAll(/\[[^\]]+\]/g,"")})}confirmWipe(){const e=y.inject.login.state()===f.LoginState.SignedIn?`\nSince you're logged in as ${y.inject.login.getUsername()}, this reset will also propagate to all your devices!`:"";return this.simpleDialog({title:"DANGER!",message:`Are you sure you want to reset your expedition progress?${e}\n[b]ALL OBTAINED TROPHIES WILL BE LOST![/b]`,buttons:[{text:n.DialogButtons.Cancel,role:h.DialogButtonRole.Regular},{text:n.DialogButtons.Wipe,role:h.DialogButtonRole.PrimaryDanger}]})}ensureSceneRunning(){this.game.scene.isActive(s.Scenes.ModalWindow)||this.game.scene.run(s.Scenes.ModalWindow)}defaultIfBypassed(e){if(p.app.scene.globalUI.input.activePointer.event?.ctrlKey)return e}isModalActive(){return this.getModalWindowScene().isModalActive()}},t.UI={loadGame:new l.ModalDialogUIProvider(new o.ImportMapDialog),editMapJSONDialog:new l.ModalDialogUIProvider(new r.EditMapJSONDialog),htmlDialog:new l.ModalDialogUIProvider(new a.HtmlDialog),simpleDialog:new l.ModalDialogUIProvider(new d.SimpleDialog),textInputDialog:new l.ModalDialogUIProvider(new u.TextInputDialog),restartDialog:new l.ModalDialogUIProvider(new g.RestartDialog),scrollableTextDialog:new l.ModalDialogUIProvider(new w.ScrollableTextDialog)},t.HtmlDocs={howToPlay:{url:"/how-to-play",title:"How to play"},about:{url:"/about",title:"About Konkr.io"}}},56647:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsDataSetModel=void 0;const s=i(1326),n=i(97849),o=i(10326),a=i(81434),r=i(94399),l=i(45664),c=i(56038);class d extends r.BaseModel{constructor(){super(...arguments),this.pawnModels={}}byId(e){let t=this.pawnModels[e];if(t||(t=new o.PawnModel(this,e),this.pawnModels[e]=t),t.exists)return t}byType(e,t){return this.select({hexes:e,type:[t]})}select(e){const t=e.hexes||c.Regions.model(this.state).allRegionsHexes();let i=(0,s.mergeArrays)(...t.map((e=>a.Pawns.getByHex(this.state,e.id)))).map((e=>this.byId(e)));return e.type&&(i=i.filter((t=>e.type.includes(t.type)))),e.traits&&(i=i.filter((t=>e.traits.every((e=>t.hasTrait(e)))))),void 0!==e.movable&&(i=i.filter((t=>t.isMovable()===e.movable))),i}findOne(e){return this.select(e)[0]}findClosest(e,t,i){let s;return t.bfsFrom(e,(e=>!s&&(s=this.byHex(e).filter(i)[0],!s))),s}byHex(e,t){return"number"==typeof e&&(e=(0,l.getHex)(e)),t?this.select({hexes:e,type:[t]})[0]:this.select({hexes:e})}byRegion(e){return a.Pawns.getByRegion(this.state,e.id).map((e=>this.byId(e)))}adjustCount(e,t,i){if(0===i)return;const s=this.byHex(e,t);s?s.setCount(s.count+i):((0,n.assert)(i>=0,`attempt to reduce ${t} count at ${e} below 0 (0-${-i}=${i})`),this.create({hex:e,type:t,count:i}))}setCount(e,t,i){const s=this.byHex(e,t);if(s)s.setCount(i);else{if(0===i)return;this.create({hex:e,type:t,count:i})}}presentAtHex(e,...t){return this.select({hexes:e,type:t.length>0?t:void 0}).length>0}traitPresentAtHex(e,t){return a.Pawns.isTraitPresentOnHex(this.state,e.id,t)}nextId(){return a.Pawns.getNextId(this.state)}all(){return a.Pawns.getAll(this.state).map((e=>this.byId(e)))}create(e){const t=this.nextId();return a.Pawns.getByHex(this.state,e.hex.id,e.type),this.state=a.Pawns.create(this.state,{...e,id:t}),this.byId(t)}destroy(...e){this.state=a.Pawns.destroy(this.state,...e.map((e=>e.id)))}clear(){this.destroy(...this.all())}getCount(e,t){const i=this.byHex(e,t);return i?i.count:0}}t.PawnsDataSetModel=d},56728:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinsByHexProjection=void 0;const s=i(31011),n=i(24598),o=i(20026),a=i(81434);class r extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.builder=new s.MapMutationBuilder(this)}bootstrap(e){return(0,o.selectFromState)(e,this.sources.pawnsByHex).map((t=>t.find((t=>a.Pawns.getPawnType(e,t)===n.PawnType.Coins)))).filter((t=>t&&0!==a.Pawns.getPawnCount(e,t))).map((t=>a.Pawns.getPawnCount(e,t)||0))}update(e,t,i){return this.builder.init(e),this._handlePawnByHexChange(e,t.of(this.sources.pawnsByHex),i),this._handlePawnsCountChange(e,t.of(this.sources.pawnsCount),i),this.builder.createMutation("parent changed")}_handlePawnByHexChange(e,t,i){t?.updated?.forEach((t=>{const s=t.id;t.added?.forEach((t=>{a.Pawns.getPawnType(e,t)===n.PawnType.Coins&&this.builder.set(s,a.Pawns.getPawnCount(e,t)||1)})),t.removed?.forEach((e=>{a.Pawns.getPawnType(i,e)===n.PawnType.Coins&&this.builder.delete(s)}))}))}_handlePawnsCountChange(e,t,i){t?.updated?.forEach((([t,i])=>{if(a.Pawns.getPawnType(e,t)===n.PawnType.Coins){const s=a.Pawns.getPawnHex(e,t);if(!s)return;i?this.builder.set(s,i):this.builder.delete(s)}}))}}t.CoinsByHexProjection=r},56793:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoxButton_LEGACY=void 0;const s=i(22663),n=i(21941),o=i(83176),a=i(86545),r=i(76049),l=i(20087),c=i(18957);var d=Phaser.GameObjects.Image,h=Phaser.GameObjects.BitmapText;class u extends a.ResponsiveContainer{set buttonState(e){this._state=e,this.onStateChanged.fire(e),this.preUpdate.makeDirty()}get buttonState(){return this._state}setTheme(e){this.text?.setTint(e.oceanContrastDark)}constructor(e,t,i,a){super(e),this.props=a,this._state=s.ButtonState.Rest,this.onStateChanged=(0,c.signal)(),this.raisedPx=a.raised??0,this.setSize(a.width,a.height),this.box=new n.Box(this.scene,a.baseTexture,0,0,a.width,a.height),this.add(this.box),a.buttonTint&&this.box.setTint(a.buttonTint),a.text&&("string"==typeof a.text?this.text=new h(this.scene,0,0,a.font??r.BitmapFont.Main,a.text):this.text=a.text,this.add(this.text)),a.icon&&("string"==typeof a.icon?this.icon=new d(this.scene,0,0,"atlas",a.icon):this.icon=a.icon,this.add(this.icon)),a.textColor&&this.setTextTint(a.textColor),this.setPosition(t,i),this.setInteractiveAuto(),this.setController((0,o.setupController)(a)),this.updateLayout()}setEnabled(e){this.controller.setEnabled(e)}get onClicked(){return this.controller.onClicked}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.buttonState=e)))}setTextTint(e){return this.props.textColor=e,this.text?.setTint(e),this.icon?.setTint(e),this}setTint(e){return this.props.buttonTint=e,this.box.setTint(e),this.icon?.setTint(e),this}updateLayout(){if(super.updateLayout(),!this.active)return;let e=Math.round(this.width/2+(this.props.contentOffset?.x??0)),t=Math.round(this.height/2+(this.props.contentOffset?.y??0));this.buttonState===s.ButtonState.Down&&(e+=this.raisedPx,t+=this.raisedPx),this.icon&&this.text?(l.Arrange.leftToRight({content:[this.icon,this.text],spacing:8,origin:.5,x:e,maxSize:this.width-8}),l.Arrange.alignY({content:[this.icon,this.text],y:t,origin:.5})):this.icon?(this.icon.setOrigin(.5,.5),this.icon.setPosition(e,t)):this.text&&(this.text.setOrigin(.5,.5),this.text.setPosition(e,t)),this.box.setFrameFrom(this.props.downTexture&&this.buttonState===s.ButtonState.Down?this.props.downTexture:this.props.baseTexture)}}t.BoxButton_LEGACY=u},56824:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.events=t.storage=t.errors=t.config=t.random=t.logger=void 0,t.initPlatform=function(e){t.events=e.events,t.random=e.random,t.config=e.config,t.errors=e.errors,t.storage=e.storage};const s=i(36530);t.logger=new s.RootLogger},56887:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IslandPreview=t.IslandOutline=t.IslandPreviewDisplayMode=t.ForestLayer=t.ConqueredGroundLayer=t.GroundLayer=t.LandmassLayer=void 0,t.paintTowns=b;const s=i(80829),n=i(82226),o=i(91622),a=i(35592),r=i(81434),l=i(24598),c=i(73230),d=i(56038),h=i(48063),u=i(59956);var p,g,m=Phaser.GameObjects.RenderTexture;class y extends s.SimplePaintedLayer{constructor(){super(n.IsoTileRecipes.MiniLandmass)}}t.LandmassLayer=y;class f extends a.FactionBasedPaintedLayer{constructor(){super(n.IsoTileRecipes.MiniGround)}shouldIncludeHex(e,t){return!e.isNeutral()}getTint(e){return e.landColor}}t.GroundLayer=f;class w extends s.SimplePaintedLayer{constructor(){super(n.IsoTileRecipes.MiniGround,o.inject.theme.getFactionColor(0))}}t.ConqueredGroundLayer=w;class v extends a.FactionBasedPaintedLayer{constructor(){super(n.IsoTileRecipes.MiniForest)}shouldIncludeHex(e,t){return e.isNeutral()&&!!r.Pawns.getByHex(e.state,t.id,l.PawnType.Forest)}}function b(e,t){for(let i of d.Regions.model(e).all())for(let e of i.getTownHexes())t.batchDrawFrame("atlas","island-preview/town",e.display.centerX/4-3,e.display.centerY/4-4)}t.ForestLayer=v,function(e){e.Default="default",e.Outline="outline",e.Conquered="conquered"}(p||(t.IslandPreviewDisplayMode=p={})),function(e){e.Default="default",e.Highlighted="highlighted",e.None="none"}(g||(t.IslandOutline=g={})),t.IslandPreview=class extends m{constructor(e){super(e,0,0)}redraw(e){const t=u.WorldMap.model(e.gameState);this.resize(t.width*h.PREVIEW_HEX_WIDTH,t.height*h.PREVIEW_HEX_INNER_HEIGHT).setOrigin(0,0),this.clear();const i=function(e){const t=[];if(e.displayMode===p.Outline)return[new s.SimplePaintedLayer(n.IsoTileRecipes.MiniCoast,o.inject.theme.getCurrent().oceanShades.light1)];switch(e.outline){case g.Default:t.push(new s.SimplePaintedLayer(n.IsoTileRecipes.MiniCoast,o.inject.theme.getCurrent().oceanShades.light2));break;case g.Highlighted:t.push(new s.SimplePaintedLayer(n.IsoTileRecipes.MiniCoastHighlight))}return e.displayMode===p.Conquered?t.push(new y,new w,new v):t.push(new y,new f,new v),t}(e);this.beginDraw();const a=(0,c.syncRequest)(e.gameState);for(let e of i)e.addDirtyCorners(a);for(let e of a.dirtyCorners)for(let t of i)t.paintCorner(a,this,e,e.x/4,e.y/4);e.displayMode===p.Default&&b(e.gameState,this),e.overlayIcon&&function(e,t){const i=e.width/2,s=e.height/2;e.batchDrawFrame("atlas","ui/level-icons/trophy-shadow",i-12,s+19-6),e.batchDrawFrame("atlas",t,i-14,s-19)}(this,e.overlayIcon),this.endDraw()}}},57189:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnDescriptions=t.PawnTypeTranslations=void 0,t.getPawnDescription=h,t.pawnTypeToStr=g,t.getUndeadTownTitle=m,t.getPawnTypeTooltip=y,t.getFrameForPawnSymbol=f,t.getFrameForEmojiFace=function(e){return"attitude-emoji/"+e},t.getPawnTooltip=function(e,t){const i=a.app.scene.worldMap.overlays.pawnSymbols.getCurrentSymbol(e.id);if(i&&i.type!==d.PawnSymbolType.Arrow&&i.type!==d.PawnSymbolType.Warning)return{title:i.message,icon:f(i.type),enforceDelay:!1,type:o.TooltipType.Hover};{const i=y(e.type,e.name,e.faction?.isLocalPlayer()?"own":"hostile");return e.type===s.PawnType.Town&&e.faction?.persona.race===r.Race.Undead&&(i.title=m(e),i.description="Sends out zombies to attack nearby towns and collects mana from destroyed zombies. Once 6 mana is accumulated, summons a Dread Knight."),{...i,counters:[...i.counters??[],...t],enforceDelay:!0,type:o.TooltipType.Hover}}};const s=i(24598),n=i(2543),o=i(2297),a=i(54825),r=i(90824),l=i(91622),c=i(85066),d=i(5116);function h(e,t){return[u(e,t),p(e,t)].filter((e=>e)).join("\n")}function u(e,t){return"own"===t&&e.upkeep?`Costs you ${e.upkeep} coins each turn.`:"buyable"===t?`Costs ${e.cost} coins now and ${e.upkeep} coins each turn.`:void 0}function p(e,i){if("unaffordable"==i)return"Not enough coins in treasury to buy this unit!";const s=t.PawnDescriptions[e.type];return s?s["hostile"===i?i:"default"]??s.default:void 0}function g(e){return t.PawnTypeTranslations[e]??(0,n.startCase)(e.replaceAll("-"," "))}function m(e){let t="Necromancer's Lair";const i=e.parentModel.getCount(e.hex,s.PawnType.Mana);return 7===i?`${t}\n(Dread Knight summoned)`:6===i?`${t}\n(summoning Dread Knight)`:`${t}\n (${i}/6 mana)`}function y(e,t,i="own"){const s=[],n=l.inject.gameStateModel.rules.pawns(e);return n.might>0&&!n.isInvincible()&&s.push(c.TooltipCounters.might(n.might)),"buyable"!==i&&"unaffordable"!==i||s.push(c.TooltipCounters.coins(n.cost)),n.upkeep>0&&"hostile"!==i&&s.push(c.TooltipCounters.upkeep(n.upkeep)),n.income>0&&s.push(c.TooltipCounters.income(n.income)),{title:t||g(e),description:h(n,i),counters:s}}function f(e){return"tile-symbols/"+e.slice(2)}t.PawnTypeTranslations={[s.PawnType.LadderZombie]:"Zombie with a ladder",[s.PawnType.Spawner]:"Christmas Tree"},t.PawnDescriptions={[s.PawnType.Town]:{hostile:"The province treasury is stored here. Would be real shame if something happened to it!\nTowns also protect adjacent tiles from enemy villagers.",default:"The province treasury is stored here. Don't let your enemies raze it!\nTowns also protect adjacent tiles from enemy villagers."},[s.PawnType.Villager]:{default:"Great for capturing undefended territory and dealing with bandits. Protects surrounding tiles from enemy villagers."},[s.PawnType.Pikeman]:{default:"Stronger than towns and villagers, but can't deal with castles."},[s.PawnType.Knight]:{default:"Borderline unstopabble, only other knights or heroes can stand in his way.\b Requires a lot of coins to maintain though!"},[s.PawnType.Hero]:{default:"Unstopabble tool of destruction, only other heroes can hope to challenge him.\b Demands insane amount of coins each turn though!"},[s.PawnType.Castle]:{default:"Protects adjacent tiles from enemy villagers and pikemen."},[s.PawnType.Forest]:{default:"Impassable terrain."},[s.PawnType.Refuge]:{default:"Only the faction that owns this tile can pass through it. This tile can never change ownership."},[s.PawnType.Bandit]:{default:"Loyal to no one but himself, a bandit moves randomly around the map and plunders tiles for coins. It can be defeated by any unit, even a villager."},[s.PawnType.Camp]:{default:"Bandits store any coins they plunder in the nearest camp.\nWhen the camp has enough coins stored, it will produce a new bandit!"},[s.PawnType.Zombie]:{default:"Zombies infect adjacent units and towns. Keep them at bay with walls and castles!"},[s.PawnType.LadderZombie]:{default:"This zombie built itself a ladder somehow. It may climb over undefended walls!"},[s.PawnType.UniqueHero]:{default:"True heroes don't require payment!"},[s.PawnType.HauntedTown]:{default:"This forsaken town spawns a zombie every turn!"},[s.PawnType.Present]:{default:"How sweet!"},[s.PawnType.Chest]:{default:"Sweet loot awaits for the first one to claim it!"},[s.PawnType.DreadKnight]:{default:"An undead Knight animated by dark magic. Powered from a connected Necromancer's Lair."},[s.PawnType.Spawner]:{default:"Delivers a present to a random free adjacent tile each turn!"},[s.PawnType.GoldMine]:{default:"Produces 8 coins each turn for its owner."},[s.PawnType.Swamp]:{default:"Swamp tiles do not produce any coins, they are inaccessible to knights, and they cannot be defended with walls or castles."},[s.PawnType.TownRuins]:{default:"Can be restored into a town once captured."}}},57230:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBunnyDestination=function(e){const t=e.state,i=a.Warfare.model(t);return e.hex.neighbours((o=>!!s.Regions.getByHex(t,o.id)&&!(0,n.crossesWall)(t,e.hex,o)&&!i.isOccupied(o))).findMax((e=>{const s=e.neighbours().filter((e=>i.isOccupied(e))),a=e.neighbours().filter((s=>i.isImpassable(s)||(0,n.crossesWall)(t,e,s))),l=o.Factions.model(t).byHex(e)?.isNeutral();return 10-2*s.length-a.length+(l?1:0)+(0,r.deterministicRandomNumber)(t)}))};const s=i(56038),n=i(52307),o=i(19618),a=i(78635),r=i(35800)},57246:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.migrateFromV1=async function(){if(o.storage.getItem("konkr.userData")){p.warning("Found user data in V1 format, migrating...");const e=JSON.parse(o.storage.getItem("konkr.userData"));o.storage.setItem(h.STORAGE_KEYS.DEFAULT_USER,e.userId),o.storage.setItem(h.STORAGE_KEYS.CURRENT_USER,e.userId);const t=await g(e);t&&(o.storage.setItem("konkr.userData.v2."+e.userId,JSON.stringify(t)),o.storage.removeItem("konkr.userData"))}},t.migrateUserMetadata=g,t.loadOldLevelData=m;const s=i(18811),n=i(91622),o=i(56824),a=i(85026),r=i(75742),l=i(46512),c=i(91693),d=i(62643),h=i(78349),u=i(38348),p=o.logger.for("migrate");async function g(e){const t={};await n.inject.mapRegistry.initialize();for(let l of Object.values(e.savedGamesById)){const c={type:n.inject.mapRegistry.getLevelManifestById(l.levelId)?"campaign":"conquest",snapshots:{},stats:e.stats.perLevel[l.levelId]?.total,feedback:i(l)};if(l.bestResult?.outcome===s.LevelOutcome.Victory?c.won={turns:l.bestResult.turnNumber}:l.bestResult?.outcome===s.LevelOutcome.Defeat&&(c.lost={turns:l.bestResult.turnNumber}),l.levelId&&l.inProgress)try{const e=m(o.storage,l.levelId,u.V2_SaveGameTags.Autosave),t=m(o.storage,l.levelId,u.V2_SaveGameTags.Start);e&&(c.snapshots[u.V2_SaveGameTags.Autosave]=(0,a.encodeGameState)(e)),t&&"conquest"===c.type&&(c.snapshots[u.V2_SaveGameTags.Start]=(0,a.encodeGameState)(t)),c.inProgress={turnNumber:l.inProgress.turnNumber,lives:l.inProgress.lives??r.DEFAULT_LIVES_PER_LEVEL,aiDifficulty:"hard"}}catch(e){p.error(`Failed to load save data for ${l.levelId}, skipping`,e)}t[l.levelId]=c}function i(t){const i=e.feedbacks.find((e=>e.levelId===t.levelId));if(i)return{mood:i.mood,comment:i.comment,timestamp:i.timestamp}}const c={...e.rememberedChoices,cameraFollow:s.CameraFollowPreset.On};delete c.latestLevelId,delete c.newGameOptions;const d=(0,l.defaultUserData)();return{metadata:{cloudSyncUserId:void 0},levels:t,latestLevelId:e.rememberedChoices.latestLevelId,rememberedChoices:{...d.rememberedChoices,...c},tutorialsCompleted:e.tutorialsCompleted,stats:{total:e.stats.total,latestSession:e.stats.latestSession}}}function m(e,t,i){const s=e.getItem(c.SAVE_GAME_LOCAL_STORAGE_PREFIX+t+"."+i);if(!s)return;let n;try{n=JSON.parse(s)}catch(e){throw new Error("save data corrupted")}if(n.version!==d.CORE_GAMESTATE_SCHEMA_VERSION)throw new Error("save data not compatible with current version of the game");return n}},58131:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexDefenseMarkers=void 0,t.deriveDefenseMarkerDataFromModel=function(e,t){const i=u.Pawns.model(e.state),s=p.Warfare.model(e.state),n=e.hexes,o=new r.CustomHexGroupValuation({defense:0});return i.select({hexes:n,traits:[a.PawnTraits.GuardsAdjacentTiles]}).filter((e=>e.id!==t)).forEach((i=>{const r=i.hasTrait(a.PawnTraits.Building);n.neighboursOf(i.hex).filter((e=>!s.isOccupied(e)||s.getOccupyingUnit(e)?.id===t)).filter((t=>!r||p.Warfare.canBeProtectedByWalls(e.state,t.id))).forEach((e=>{const t=o.get(e.id);i.defenseMight>t.defense&&o.set(e.id,{defense:i.defenseMight,origin:i.hex})}))})),o};const s=i(20693),n=i(56824),o=i(79573),a=i(63521),r=i(65415),l=i(97849),c=i(45664),d=i(40951),h=i(91622),u=i(81434),p=i(78635);n.logger.for("HexDefenseMarkers"),t.HexDefenseMarkers=class{constructor(e){this.scene=e,this.shapesByHex={},this.hovered={hex:void 0,defenseAuraStrength:0,defenseAuraHexes:s.HexGroup.empty},this.shapes=this.scene.add.group({defaultKey:"atlas",defaultFrame:"hex-markers/defense-1"}).setDepth(o.WorldLayers.TileHighlight)}clear(){this.clearHoveredHex(),this.removeShapes(Object.keys(this.shapesByHex).map((e=>Number(e))))}set(e){this.config=e;const t=Object.keys(this.shapesByHex).filter((t=>0===e.get(Number(t)).defense&&!this.hovered.defenseAuraHexes.has((0,c.getHex)(Number(t))))).map((e=>Number(e)));(0,c.getHexes)(e.getHexIds()).without(this.hovered.hex||s.HexGroup.empty).without(this.hovered.defenseAuraHexes).map((e=>{l.assert.defined(e);const t=this.config.get(e.id),i=this.setShapeOnHex(e,"defense-"+t.defense);return this.shapesByHex[e.id]||(this.shapesByHex[e.id]=i,this.scene.tweens.add({targets:i,x:{from:t.origin.display.centerX,to:e.display.centerX},y:{from:t.origin.display.centerY,to:e.display.centerY},scale:{from:.5,to:1},alpha:{from:0,to:1},duration:d.TIMING.defenseMarkersShowDuration,ease:"Sine.easeOut"})),i})).filter((e=>!!e)),this.removeShapes(t)}setShapeOnHex(e,t){const i=this.shapesByHex[e.id]||this.shapes.get(e.display.centerX,e.display.centerY,void 0,void 0,!1).setVisible(!0).setActive(!0).setDepth(o.WorldLayers.TileHighlight);return i.setFrame("hex-markers/"+t).setAlpha(1).setScale(1),i}setHoveredHex(e,t,i){this.clearHoveredHex(),this.hovered.hex=e,this.hovered.defenseAuraHexes=i,this.hovered.defenseAuraStrength=t,this.shapesByHex[e.id]=this.setShapeOnHex(e,"circle"),this.hovered.defenseAuraHexes.forEach((e=>{const i=this.config.get(e.id).defense;t>i&&(this.shapesByHex[e.id]=this.setShapeOnHex(e,"defense-"+t))}))}clearHoveredHex(){this.hovered.hex&&(s.HexGroup.union([this.hovered.hex,this.hovered.defenseAuraHexes]).forEach((e=>{const t=this.config.get(e.id).defense;t>0?this.shapesByHex[e.id]=this.setShapeOnHex(e,"defense-"+t):(this.scene.tweens.killTweensOf(this.shapesByHex[e.id]),this.shapes.killAndHide(this.shapesByHex[e.id]),delete this.shapesByHex[e.id])})),this.hovered.hex=void 0,this.hovered.defenseAuraStrength=0,this.hovered.defenseAuraHexes=s.HexGroup.empty)}removeShapes(e){const t=e.map((e=>this.shapesByHex[e]));if(h.inject.ui.skipTransitions())for(let e of t)this.shapes.killAndHide(e);else this.scene.tweens.add({targets:t,scale:{from:1,to:.5},alpha:{from:1,to:0},duration:d.TIMING.defenseMarkersHideDuration,ease:"Sine.easeIn",onComplete:()=>{t.forEach((e=>{this.shapes.killAndHide(e)}))}});e.forEach((e=>delete this.shapesByHex[e]))}}},58440:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateBudgetOverlay=function(e,t,i){s.inject.userData.recallChoice("showBudgetOverlay")?t.budgetLabels.setDiverse(r(e,i)):t.budgetLabels.clear()},t.deriveBudgetOverlay=r;const s=i(91622),n=i(56038),o=i(81434),a=i(1326);function r(e,t){const i=[],s=n.Regions.model(e).all().filter((e=>e.isAlive()&&e.id!==t?.id));for(let t of s){const s=l(e,t);s&&i.push({hexes:s,options:{color:t.faction.landColorDark,treasury:t.treasury,balance:t.budget.balance}})}return i}function l(e,t){const{centralHex:i,centralTownHex:s}=t.getGeography();if(!i||!s)return;const n=[];let r=1/0;return t.hexes.bfsFrom(s,((t,i,s)=>!function(e,t){return 0===o.Pawns.getByHex(e,t.id).length}(e,t)||(s<=r&&(r=s,n.push(t)),!1))),(0,a.findMax)(n,(e=>-e.getDistanceTo(i)+.1*t.sameRegionNeighboursOf(e).length))}},58547:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setPawnJumpingInRegions=function(e){e.forEach((e=>o(e,!0)))},t.setPawnsJumpingInRegion=o;const s=i(91622),n=i(54825);function o(e,t){const i=s.inject.gameStateModel.currentPhase.getMovablePawns().filter((t=>t.region.id===e.id)).map((e=>n.app.scene.worldMap.pawns.getById(e.id)));t?i.forEach((e=>e?.startJumping())):i.forEach((e=>e?.stopJumping()))}},58609:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DifficultyToggle=void 0;const s=i(36014),n=i(91622),o=i(70033);class a extends s.Toggle{constructor(e,t){const i="large"===(t.size??"large");super(e,{onSelected:t.onSelected??(e=>n.inject.userData.rememberChoice("aiDifficulty",e)),options:[{icon:{image:o.LevelIcons.Silver,scale:.5},text:i?"Normal":void 0,bgColor:40960,value:"normal"},{icon:{image:o.LevelIcons.Gold,scale:.5},text:i?"Hard":void 0,bgColor:13121335,value:"hard"}],theme:t.theme,enabled:!0,initialValue:"normal",height:t.height??40,width:i?200:90}),this.props=t}}t.DifficultyToggle=a},58884:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.unionRects=function(...e){return 0===e.length?new i:e.reduce(((e,t)=>Phaser.Geom.Rectangle.Union(e,t,e)),new Phaser.Geom.Rectangle)};var i=Phaser.Geom.Rectangle},58903:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ToggleButtonStateController=void 0;const s=i(18957),n=i(98963),o=i(22663),a=i(54825);t.ToggleButtonStateController=class{constructor(e){this.options=e,this.enabled=!0,this.toggledOn=!1,this.state=o.ButtonState.Rest,this.onToggled=(0,s.signal)(),this.onClicked=(0,s.signal)(),this.onStateChanged=(0,s.signal)(),this.options.onToggled&&this.onToggled((e=>this.options.onToggled(e)))}getState(){return this.state}bindTo(e,t){this.applyState=t,e.removeAllListeners(),e.on("pointerover",(()=>{this.state!==o.ButtonState.Rest||this.toggledOn||this.setState(o.ButtonState.Hover)})).on("pointerout",(()=>{this.enabled?this.setState(this.getRestingState()):this.setState(o.ButtonState.Disabled)})).on("pointerdown",(()=>{this.enabled?(this.setState(o.ButtonState.Down),this.playSoundEffect(n.SoundEffects.ButtonDown)):this.playSoundEffect(n.SoundEffects.Deny)})).on("pointerup",(e=>{this.enabled&&this.state===o.ButtonState.Down&&(this.toggledOn=!this.toggledOn,this.onClicked.fire(e),this.onToggled.fire(this.toggledOn),this.setState(this.toggledOn?o.ButtonState.Down:o.ButtonState.Hover),this.playSoundEffect(n.SoundEffects.ButtonUp))})),t(this.state)}getRestingState(){return this.toggledOn?o.ButtonState.Down:o.ButtonState.Rest}playSoundEffect(e){!1!==this.options.audio&&a.app.audio.playEffect(e)}setState(e){const t=this.state;e!==this.state&&(this.state=e,this.onStateChanged.fire({newState:e,oldState:t}),this.applyState(e))}setToggled(e){this.toggledOn=e,this.setState(this.getRestingState())}setEnabled(e){if(this.enabled===e)return!1;this.enabled=e,this.setState(e?this.getRestingState():o.ButtonState.Disabled)}}},58963:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayingOverlayMode=void 0;const s=i(20693),n=i(56038),o=i(96137),a=i(24598),r=i(19618),l=i(81434),c=i(19162),d=i(25862),h=i(58131),u=i(54825),p=i(7334),g=i(77330),m=i(45664),y=i(90824),f=i(5116),w=i(78635),v=i(58440);t.PlayingOverlayMode=class{constructor(e){this.options=e,this.type="playing"}update(e,t){this.gameState=t,this.updateRegionHighlight(e),this.updatePawnBacklight(e),this.updateConquerableHexes(e),this.updateTownStatusFlags(e),this.updatePlusSymbols(e),(0,d.updateBankrupcySymbols)(t,e.pawnSymbols),(0,d.updateNewsAlerts)(e),(0,d.updateAttitudeEmojis)(t,e.attitudeEmojis,this.options.selectedRegionId),e.pawnSymbols.clear(f.PawnSymbolType.Arrow),this.updateRegionSummary(e),this.updateDefenseMarkers(e),(0,v.updateBudgetOverlay)(t,e,this.getSelectedRegion())}updateRegionSummary(e){const t=this.getSelectedRegion();!t||t.faction?.isLocalPlayer()||t.faction?.persona.race===y.Race.Undead?e.regionSummaryPopup.hide():e.regionSummaryPopup.showOverRegion(t.id)}updateRegionHighlight(e){const{selectedRegionId:t}=this.options;if(!t)return void e.selectedRegionHighlight.clear();const i=n.Regions.model(this.gameState).byId(t),a=i?.faction?.isLocalPlayer()?o.Colors.highlight.ownedRegion:o.Colors.brighter(i?.faction?.landColorLight??0,20);e.selectedRegionHighlight.setHexes(s.HexGroup.fromIds(n.Regions.getRegionHexes(this.gameState,t).toArray()),a)}updatePawnBacklight(e){const{selectedPawnId:t,selectedRegionId:i}=this.options;if(t){const i=l.Pawns.model(this.gameState).byId(t);if(i&&u.app.device.isUsingTouch())return void e.pawnBacklight.set(i.hex,{color:o.Colors.highlight.ownedRegion,width:20})}const n=r.Factions.model(this.gameState).localPlayer?.getRegions().filter((e=>e.id!==i)).filter((e=>e.treasury>=10||e.getMovableUnitsByMight().count()>0))??[],a=s.HexGroup.union(n.map((e=>e.getTownHexes())));e.pawnBacklight.set(a,{color:o.Colors.highlight.friendlyRegion})}updateConquerableHexes(e){(0,d.updateConquerableHexesBasedOn)(e.conquerableHexesHighlight,{pawnType:this.options.holdingPawnType,regionId:this.options.selectedRegionId,state:this.gameState,includeMerging:u.app.scene.playUI.isInAutoMergeMode()})}updateTownStatusFlags(e){const t=r.Factions.model(this.gameState).localPlayer?.getRegions()??[];e.townStatusFlags.update((e=>{for(let i of t){const t=this.getFlagColor(i);void 0!==t&&e(i.getTownHexes(),t)}const i=l.Pawns.model(this.gameState),n=g.Bandits.getAllCampHexes(this.gameState).filter((e=>i.getCount((0,m.getHex)(e),a.PawnType.Coins)>=3));e(s.HexGroup.fromIds(n),3158064);const o=r.Factions.model(this.gameState).all().filter((e=>e.isAlive()&&!e.isLocalPlayer()&&!e.isNeutral()&&e.persona.race!==y.Race.Undead)).flatMap((e=>e.getLiveRegions()));for(let t of o)if(t.budget.balance+t.treasury>=10){const i=t.faction.landColor;e(t.getTownHexes(),i)}}))}getFlagColor(e){return e.budget.balance<0?e.treasury+e.budget.balance<0?3158064:16711680:e.treasury>=10?65280:void 0}updatePlusSymbols(e){const{holdingPawnType:t,selectedRegionId:i,selectedPawnId:s}=this.options;if(!t||!i)return void e.pawnSymbols.clear(f.PawnSymbolType.Plus);const o=n.Regions.model(this.gameState).byId(i);if(!o?.exists)return void e.pawnSymbols.clear(f.PawnSymbolType.Plus);const a=c.Rules.getPawnRules(this.gameState,t).merge;a&&o.getPawns().filter((e=>e.type===t&&e.id!==s&&w.Warfare.model(this.gameState).isSuitableTerrain(e.hex,a[t]))).forEach((t=>{e.pawnSymbols.add(t.id,f.PawnSymbolType.Plus,`Drop here to upgrade to ${a}.`)}))}getSelectedRegion(){if(this.options.selectedRegionId)return n.Regions.model(this.gameState).byId(this.options.selectedRegionId)}updateDefenseMarkers(e){const{selectedPawnId:t}=this.options,i=this.getSelectedRegion();if(!i)return void e.hexMarkers.clear();const s=(0,h.deriveDefenseMarkerDataFromModel)(i,t);e.hexMarkers.set(s)}toString(){return`[PlayingOverlay (${(0,p.str)(this.options)})]`}}},59019:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AutoWidthComponent=void 0;const s=i(93785);class n{constructor(e){this.parent=e,this._width=0,this._height=0,this.initialWidthSet=!1}get height(){return this._height}set height(e){this._height!==e&&(this._height=e,this.parent.preUpdate.force())}get width(){return this._width}updateSize(e=!0){const t=this.parent.calculateWidth();t!==this._width&&(this._width=t,this.initialWidthSet&&e?this.parent.parentContainer?(0,s.handlesAutoSizeChildren)(this.parent.parentContainer)&&this.parent.parentContainer.handleChildResize(this.parent):(0,s.handlesAutoSizeChildren)(this.parent.scene)&&this.parent.scene.handleChildResize(this.parent):this.initialWidthSet=!0)}static overrideSizeComponent(e){const t=new n(e);Object.defineProperties(e,{width:{get:()=>t.width},height:{set:e=>{t.height=e},get:()=>t.height},updateSize:{value:t.updateSize.bind(t)}})}}t.AutoWidthComponent=n},59113:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinsTool=void 0;const s=i(24598),n=i(91622),o=i(54825),a=i(96137),r=i(52307);t.CoinsTool=class{constructor(){this.options={title:"Add/Remove Coins",description:"click = add coin\nctrl-click = remove coin\nshift-click = add 5 coins"},this.iconRecipe="editor/coins"}useOn(e,t){const i=new Set([s.PawnType.Town,s.PawnType.Camp,s.PawnType.HauntedTown,s.PawnType.Chest]),l=n.inject.gameStateModel,c=l.regions.byHex(e);if(!c)return;const d=l.pawns.findClosest(e,c.hexes,(e=>i.has(e.type)));if(!d)return;const h=(0,r.isUndeadTown)(l,e)?s.PawnType.Mana:s.PawnType.Coins,u=function(e,t){const i=t.shift?5:1,s=t.ctrl?-1:1;return Math.max(0,e+i*s)}(l.pawns.getCount(d.hex,h),t);l.pawns.setCount(d.hex,h,u),o.app.scene.worldMap.vfx.popupText(d.hex,u.toFixed(0),a.Colors.highlight.ownedRegion)}}},59255:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PluginsModel=void 0;const s=i(45920),n=i(91622),o=i(18497),a=i(90386);t.PluginsModel=class{constructor(e){this.pluginKeys=e,this.ai={maxConquestPlanningRangeAdjustment:new o.ExtensionHook,hostilityInputAdjustment:new o.ExtensionHook,maxAllowedUnitMightLimit:new o.ExtensionHook,hexVulnerabilityMultiplier:new o.ExtensionHook,hexConquestBonus:new o.ExtensionHook},this.rules={adjustBuyableObjects:new o.ExtensionHook,adjustRuleset:new o.ExtensionHook},this.mapEditor={adjustToolPalette:new o.ExtensionHook},this.plugins=this.pluginKeys.map(s.getPlugin),"normal"===n.inject.levelSession.aiDifficulty&&this.plugins.push(a.NormalDifficultyLevel);for(let e of this.plugins)e.register(this)}has(e){return!!this.pluginKeys.find((t=>t===e))}getAll(){return this.plugins}get zombies(){return this.has(o.PluginKey.Zombies)}get pickLandingSpot(){return this.has(o.PluginKey.PickLandingSpot)}}},59811:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnBacklightManager=void 0;const s=i(6528),n=i(19970),o=i(56824).logger.for("PawnBacklightManager");class a extends s.TileAttachmentsManager{constructor(e,t,i){super("PawnBacklightManager",e,t,o),this.pawns=i}createObject(e,t){const i=this.pawns.getByHex(e.id),s=t.width??i?.image.displayWidth??18;return new n.PawnBacklight(this.scene,s).setTint(t.color)}updateObject(e,t,i){const s=this.pawns.getByHex(t.id);e.setBaseWidth(i.width??s.image.displayWidth??18),e.setTint(i.color)}attachObject(e,t){t.addObject(e,0,0)}removeObject(e,t){t.removeObject(e),e.destroy()}}t.PawnBacklightManager=a},59956:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMap=void 0;const s=i(45664),n=i(20026),o=i(90952),a=i(17647),r=i(26539);class l{static get(e){return(0,n.selectFromState)(e,o.GameState.map)}static getAllHexes(e){return s.HexGrid.getAllHexes(this.get(e))}static update(e,t){const i=this.get(e);return(0,n.applyMutations)(e,o.GameState.map.createMutation({...i,...t},"update"))}static model(e){const t=this.get(e);return this.modelFactory.getOrCreateFor(t)}}t.WorldMap=l,l.modelFactory=new a.FactoryWithCache((e=>new r.WorldMapModel(e)))},60181:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KongregateUserDataStorage=t.MockUserDataCloudStorage=t.FirebaseAuthUserDataStorage=void 0;const s=i(68243),n=i(91622),o=i(89413),a=i(79815),r=i(72427),l=i(56824),c=i(1326),d=i(2543);l.logger.for("CloudSync"),t.FirebaseAuthUserDataStorage=class{onSnapshot(e){return(0,a.onSnapshot)((0,a.doc)(s.Firebase.db,o.Collections.userdata,n.inject.login.getUserId()),e)}updateDoc(e){return(0,a.setDoc)((0,a.doc)(s.Firebase.db,o.Collections.userdata,n.inject.login.getUserId()),e,{merge:!0})}replaceDoc(e){return(0,a.setDoc)((0,a.doc)(s.Firebase.db,o.Collections.userdata,n.inject.login.getUserId()),e,{merge:!1})}},t.MockUserDataCloudStorage=class{constructor(){this.listeners=[]}async withErrorOnWrite(e){this._failWrite=!0,await e(),this._failWrite=!1}resetMock(){this.data=void 0,this.listeners=[]}emitCurrentDoc(){this.listeners.forEach((e=>e({data:()=>this.data})))}onSnapshot(e){return this.listeners.push(e),()=>(0,c.removeFromArrayInPlace)(this.listeners,e)}async updateDoc(e){if(this._failWrite)throw Error("simulated error writing doc");this.data?(this.data=(0,d.mergeWith)(this.data,e,((e,t)=>{if((0,d.isEqual)(t,{}))return{}})),this.emitCurrentDoc()):this.data=e}async replaceDoc(e){if(this._failWrite)throw Error("simulated error writing doc");this.data=e,this.emitCurrentDoc()}},t.KongregateUserDataStorage=class{onSnapshot(e){const t=r.Kongregate.user()?.gameAuthToken;return t?(0,a.onSnapshot)((0,a.doc)(s.Firebase.db,o.Collections.userdataKongregate,t),e):(l.errors.handleNonFatalError(new Error("User signed in on Kongregate, but gameAuthToken is not available"),"KongregateUserDataStorage.onSnapshot"),()=>{})}updateDoc(e){const t=r.Kongregate.user()?.gameAuthToken;return t?(0,a.setDoc)((0,a.doc)(s.Firebase.db,o.Collections.userdataKongregate,t),e,{merge:!0}):(l.errors.handleNonFatalError(new Error("User signed in on Kongregate, but gameAuthToken is not available"),"KongregateUserDataStorage.setDoc"),Promise.resolve())}replaceDoc(e){const t=r.Kongregate.user()?.gameAuthToken;return t?(0,a.setDoc)((0,a.doc)(s.Firebase.db,o.Collections.userdataKongregate,t),e,{merge:!1}):(l.errors.handleNonFatalError(new Error("User signed in on Kongregate, but gameAuthToken is not available"),"KongregateUserDataStorage.replaceDoc"),Promise.resolve())}}},60190:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorSidebarScene=void 0,t.editorAction=function(){return(0,o.createEventFactory)(o.EventCategory.MapEditor)};const s=i(81700),n=i(56824),o=i(39420),a=i(36868),r=i(74370),l=i(29821),c=i(4440),d=i(30948),h=i(897),u=i(55275),p=i(80959),g=i(34831),m=i(93868),y=i(12605),f=i(67878),w=i(91999),v=i(20034),b=i(86545),S=i(33071),x=i(7782),T=i(98886);n.logger.for(s.Scenes.MapEditorSidebar);class P extends d.BaseUIScene{constructor(){super({key:s.Scenes.MapEditorSidebar,bounds:m.BOUNDS.MapEditorSidebar}),this.currentState=(0,u.stateContainer)({mode:"paint",undoAvailable:!1,hasUnsavedChanges:!1,aiDifficulty:"normal",paint:{selectedTool:null,paletteLayout:T.EMPTY_PALETTE_LAYOUT},manage:{selectedVersion:null,availableSnapshots:[],activeSnapshot:null}},((e,t,i,s)=>{if(void 0!==e.mode){this.controlPanel.tabSwitcher.selectTab(e.mode,!1);for(const[t,i]of Object.entries(this.sections))i.setVisible(t===e.mode);"setup"===e.mode&&this.sections.setup.updateContent(),this.leftSeparatorGlintY.transitionTo(this.getSeparatorGlintYTarget())}e.paint&&this.sections.paint.currentState.update(e.paint),e.manage&&this.sections.manage.applyState({...e.manage,hasUnsavedChanges:t.hasUnsavedChanges}),void 0!==e.undoAvailable&&this.controlPanel.setUndoEnabled(e.undoAvailable),void 0!==e.hasUnsavedChanges&&this.controlPanel.setSnapshotEnabled(e.hasUnsavedChanges),void 0!==e.aiDifficulty&&this.controlPanel.setDifficulty(e.aiDifficulty)})),this.currentTool=r.EDITOR_TOOL.paintFaction1,this.preUpdate=(0,h.whenDirty)((()=>{this.background.setPosition(0,0),this.background.setSize(this.bounds.width,this.bounds.height),this.leftSeparatorGlint.x=1.5,this.leftSeparatorGlint.height=this.bounds.height,this.leftSeparatorGlint.scaleX=this.bounds.height/this.leftSeparatorGlint.width,this.leftSeparatorGlint.scaleY=.5,this.leftSeparatorGlintY.setTo(this.getSeparatorGlintYTarget()),this.controlPanel.width=this.bounds.width,this.controlPanel.setPosition(0,this.bounds.height-this.controlPanel.height),this.controlPanel.updateLayout()}))}get contentHeight(){return this.currentSection.height}get currentSection(){return this.sections[this.currentState().mode]}create(){super.create(),(0,y.makeSceneScrollable)(this);const e=p.UiBuilder.for(this);this.leftSeparatorGlint=e.image("glass-ui/card-horizontal-glint").setRotation(Math.PI/2).setScrollFactor(0),this.worldMapScene=this.scene.get(s.Scenes.WorldMap),this.currentToolDescription=new l.Label(this,""),this.handleToolSelected(this.currentTool),this.controlPanel=new g.MapEditorControlPanel(this),this.background=e.rectangle((e=>e.oceanShades.dark1)).setScrollFactor(0),this.sections={generate:new b.ResponsiveContainer(this),paint:new f.PaintTabContent(this),setup:new w.SetupTabContent(this),manage:new S.ManageTabContent(this)},Object.values(this.sections).forEach((e=>{e.width=this.bounds.width})),this.leftSeparatorGlintY=x.Control.propOf(this.leftSeparatorGlint,"y",{duration:100}),this.addAll([this.background,this.leftSeparatorGlint,...Object.values(this.sections),this.controlPanel]),this.input.keyboard.addKey(c.Input.Keyboard.KeyCodes.BACKTICK).on("down",(()=>{n.events.trigger(a.UserActions.Undo())})),this.bindKey(c.Input.Keyboard.KeyCodes.SPACE,(()=>a.UserActions.ResumeGame())),this.observe.event(a.GameStateEvents.NewGameState,(({state:e})=>{this.worldMapScene.loadNewGameState(e)})),n.events.on(v.MapEditorActions.SelectTool,(e=>{this.handleToolSelected(e)})),this.currentState.apply()}getSeparatorGlintYTarget(){const e=Object.keys(this.sections).indexOf(this.currentState().mode),t=this.bounds.height-this.controlPanel.height;return t/6*(3-e)-t/6}updateToolDescription(){this.currentToolDescription.setText(`${this.currentTool?.options?.description||""}\n~ = undo\nhold right mouse button to drag view`)}handleToolSelected(e){this.currentTool=e,this.updateToolDescription()}}t.MapEditorSidebarScene=P},60300:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SlackMessage=void 0,t.SlackMessage={codeBlock:(...e)=>`\`\`\`\n${e.join("\n")}\n\`\`\``,section:{text:(...e)=>({type:"section",text:{type:"mrkdwn",text:e.join("\n")}})}}},60373:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateGridLayout=function(e){e.itemCount??Number.POSITIVE_INFINITY;const t="number"==typeof(r=e.itemWidth)?r:r.min,i=function(e){return"number"==typeof e?e:e.max}(e.itemWidth),n=1+(0,s.pickLarger)(0,Math.floor((e.width-t)/(t+e.spacing))),o=e.width-e.spacing*(n-1),a=(0,s.pickSmaller)(i,Math.floor(o/n));var r;return{itemWidth:a,itemsPerRow:n,totalWidth:a*n+e.spacing*(n-1)}};const s=i(9292)},60681:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.common=void 0,t.common={reporting:{slack:{enabled:!0,feedbackHook:atob("aHR0cHM6Ly9ob29rcy5zbGFjay5jb20vc2VydmljZXMvVE0xQk01UzVCL0IwM0dVUkY4M0Q1L25YWGEwdHlraG1CNjBEYXExY3I3UzVHdg==")},sentry:{enabled:!0,dsn:"https://63ec8bedbe5345db9b76689cadb81eea@o364314.ingest.sentry.io/6446750"},googleAnalytics:{enabled:!0}},socials:{twitterUrl:"https://twitter.com/intent/tweet?text="+encodeURIComponent("@konkr_dev"),discordUrl:"https://discord.gg/C9HucB9arH",email:"dev@konkr.io"},canonicalUrl:"https://www.konkr.io"}},60729:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PowerByFactionView=void 0;const s=i(13560),n=i(20754),o=i(90952),a=i(19618),r=i(56038),l=i(76439),c=i(29322),d=i(91622),h=i(7334);class u extends n.LazyView{constructor(){super([o.GameState.ai.powerByRegion,o.GameState.factions.regions]),this.name="PowerByFaction"}calculate(e,t){const i=a.Factions.model(e).byId(t)?.getLiveRegions()||[];let n={factors:{...s.NO_ASSET_VALUE},rawTotal:0,scaledTotal:0};for(let t of i){const i=r.Regions.getRegionPower(e,t.id);n.factors=s.AssetValue.sum(n.factors,i.factors),n.scaledTotal+=i.scaledTotal,n.rawTotal+=i.rawTotal}return n}getCacheKey(e){return e}getDebugLayer(){return new l.GameStateDebugLayer((0,c.factionBasedAdapter)({getValue:(e,t)=>{const i=d.inject.views.powerByFactionView.get(e,t);return`${i.rawTotal} => ${i.scaledTotal}`},getDetail:(e,t)=>(0,h.prettyPrintObject)(d.inject.views.powerByFactionView.get(e,t))}))}}t.PowerByFactionView=u},60875:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PickRegionsMemory=void 0,t.spawnTowns=async function(e,t,i,l,d){const m=(0,s.getFactionsFromConfig)(e,l.factions);for(let e of m){const i=(y=e.id,l.factions[y-1].townsMultiplier??l.factions[y-1].startingTilesMultiplier??1),s=await w(e,i);await h.inject.debugBreakpoint(`mapgen.spawnTowns: picked regions for ${e}`,(()=>({hexes:c.HexGroup.union(s.map((e=>e.hexes)))})));for(let i of t.shuffle(s))await d(),f(i,1!==e.id)}var y;function f(i,s){const n=(0,o.findMax)(i.hexes.members,(s=>function(i,s){return s.neighbours().map((t=>{let s=0;return e.warfare.isImpassable(t)&&s++,e.regions.byHex(t)===i&&s++,e.pawns.byHex(t,a.PawnType.Town)&&(s-=5),s-=e.warfare.getHexDefense(t),s})).reduce(u.sum,0)+t.number()}(i,s)));r.assert.defined(n),e.pawns.create({hex:n,type:a.PawnType.Town});const c=s?(0,u.pickLarger)(0,l.startingCoins-i.budget.incomeFromHexes):l.startingCoins;e.pawns.create({hex:n,type:a.PawnType.Coins,count:c})}async function w(s,n=1){const o=new g;return await v({model:e,faction:s,tilesLeft:Math.floor(l.startingTiles*n),penalty:0,solutionSoFar:[],remainingRegions:t.shuffle(i.filter((e=>e.faction===s))),memory:o,minRegionCount:(0,u.pickLarger)(1,Math.round(n))}),o.bestSolution.regions}async function v(e){const{tilesLeft:t,solutionSoFar:i,remainingRegions:s,penalty:o,memory:a}=e;await d(),a.steps++;let r={regions:i,penalty:o+t*t+100*(0,u.pickLarger)(0,e.minRegionCount-i.length)};if(function(e,t){t.memory.cache.store(e.regions,e),e.penalty<t.memory.bestSolution.penalty&&(t.memory.bestSolution=e)}(r,e),!(t<=0||r.penalty>e.memory.bestSolution.penalty))for(let r of s){const d=t-r.size,h=[...i,r];a.cache.find(h)||(p.group(`given a pick of region ${r.id}`),await v({...e,tilesLeft:d,solutionSoFar:[...i,r],remainingRegions:(0,n.without)(s,r),penalty:o+(c=r,c.getNeighbours().filter((e=>e.isAlive())).length*(.5-l.clustering)*3)}),p.groupEnd())}var c}};const s=i(62049),n=i(2543),o=i(1326),a=i(24598),r=i(97849),l=i(56824),c=i(20693),d=i(29168),h=i(91622),u=i(9292),p=l.logger.for("spawnTowns");class g{constructor(){this.cache=new d.ObjectCache((e=>e.map((e=>e.id)).sort().join(","))),this.steps=0,this.bestSolution={regions:[],penalty:1/0}}}t.PickRegionsMemory=g},60882:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.STORIES=void 0;const s=i(30161),n=i(39261),o=i(4112),a=i(93862),r=i(11948);t.STORIES=[o.outlineButtonStory,a.tabSwitcherStory,s.dropdownListStory,r.toggleStory,n.listViewStory]},60959:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BuyablePawnGameObject=t.TakenMode=t.ShoppingTray=void 0;const s=i(56824),n=i(76738),o=i(27700),a=i(36868),r=i(7782),l=i(42067),c=i(86545),d=i(14767),h=i(96137),u=i(80959),p=i(76049),g=i(85711),m=i(98963),y=i(20087),f=i(20227),w=i(19970),v=i(54825),b=i(57189),S=i(79611);var x=Phaser.GameObjects.Container,T=Phaser.Geom.Rectangle;const P=s.logger.for("ShoppingDesk");class I extends c.ResponsiveContainer{constructor(e,t){super(e),this.config=t,this.pawnSprites={},this.shadows=[],this.displayedPawns=[],this._openRef=(0,g.ref)(!1),this.activePawnBacklight=new w.PawnBacklight(this.scene,48).setTint(h.Colors.highlight.ownedRegion).setVisible(!1),this.yController=r.Control.propOf(this,"y",{duration:l.LARGE_PLAY_UI_LAYOUT.shoppingTray.panelTransitionsDuration}),this.cloth=new Phaser.GameObjects.Rectangle(e,0,0,this.config.width,56).setStrokeStyle(2,0,1).setOrigin(.5,0),this.setSize(this.config.width,this.cloth.height),this.cloth.setInteractive(),this.cloth.on("pointerdown",(()=>s.events.trigger(a.UserActions.ShopAreaPointerDown()))),this.cloth.on("pointerup",(()=>s.events.trigger(a.UserActions.ShopAreaPointerUp()))),this.config.style===o.ShoppingTrayStyle.Elaborate&&(this.tray=new n.Ribbon(e,n.RibbonTextures.UnitTray,-this.config.width/2,0,this.config.width),this.tray.setInteractive(),this.tray.on("pointerdown",(()=>s.events.trigger(a.UserActions.ShopAreaPointerDown()))),this.tray.on("pointerup",(()=>s.events.trigger(a.UserActions.ShopAreaPointerUp()))),this.closeButton=(0,d.miniCloseButton)(e,this.config.width/2-21,6).setTint(h.Colors.woodenUi.primaryText),this.closeButton.setData("tooltip","Close the province details panel"),this.closeButton.onClicked((()=>s.events.trigger(a.UserActions.DeselectRegion())))),this.add([this.tray,this.cloth,this.closeButton,this.activePawnBacklight].filter((e=>e)))}setColor(e){this.cloth.setFillStyle(e,1)}setOpen(e){e!==this._openRef.current&&this._openRef.set(e);const t=this.scene.bounds.height-(e?this.config.openOffsetFromBottom:this.config.closedOffsetFromBottom);this.yController.transitionTo(t)}get isOpen(){return this._openRef.current}updateLayout(){const e=this.scene.bounds.height,t=this.scene.bounds.width;this.cloth.setOrigin(.5,0),this.cloth.setPosition(0,this.config.clothOffsetTop),this.cloth.setSize(this.width-2*this.config.clothHorizontalPadding,this.cloth.height),this.isOpen?this.setPosition(Math.round(t/2),e-this.config.openOffsetFromBottom):this.setPosition(Math.round(t/2),e-this.config.closedOffsetFromBottom),this.yController.setTo(this.y)}setBuyablePawns(e){this.displayedPawns=e,Object.values(this.pawnSprites).forEach((e=>e.setVisible(!1))),e.forEach(((e,t)=>{const i=this.getOrCreatePawnObject(e);i.setVisible(!0),i.updateLayout()})),this.activePawnBacklight.setVisible(!1),this.updatePawnSprites()}updatePawnSprites(){const e=this.displayedPawns.length>6?this.config.narrowPawnsSpacing:this.config.pawnsSpacing,t=Math.round(-e*(this.displayedPawns.length-1)/2);Object.values(this.pawnSprites).forEach((e=>e.setVisible(!1))),this.displayedPawns.forEach(((i,s)=>{this.getOrCreatePawnObject(i).setVisible(!0).setPosition(t+s*e,this.config.pawnsVerticalOffset)}))}destroy(){super.destroy(),Object.values(this.pawnSprites).forEach((e=>e.destroy())),this.pawnSprites={}}getOrCreatePawnObject(e){const{pawnType:t,priceTag:i}=e;if(this.pawnSprites[t])this.pawnSprites[t].setConfig(e);else{const i=new M(this.scene,e,this._openRef);this.add(i),this.pawnSprites[t]=i}return this.pawnSprites[t]}setPawnTaken(e,t){const i=this.pawnSprites[e];i?(i.setTaken(t),t===C.Taken?(this.activePawnBacklight.setPosition(i.x,this.height),this.activePawnBacklight.setVisible(!0),this.activePawnBacklight.animateIn()):Object.values(this.pawnSprites).find((e=>e.taken===C.Taken))||this.activePawnBacklight.setVisible(!1)):P.warning(`pawnType ${e} not found in shopping tray`)}getPawnXY(e){const t=this.pawnSprites[e];if(!t)return;const{x:i,y:s}=t;return{x:i,y:s}}restockPawn(e){const t=this.pawnSprites[e];t?.restock()}doneReturningPawn(e){const t=this.pawnSprites[e];t&&t.taken===C.Returning&&t.setTaken(C.NotTaken)}getTooltipFor(e){const t=Object.entries(this.pawnSprites).find((([t,i])=>i===e));if(t){const[e]=t;switch(this.displayedPawns.find((t=>t.pawnType===e)).mode){case o.BuyablePawnMode.Available:return(0,b.getPawnTypeTooltip)(e,void 0,"buyable");case o.BuyablePawnMode.Unaffordable:return(0,b.getPawnTypeTooltip)(e,void 0,"unaffordable")}}}}var C;t.ShoppingTray=I,function(e){e[e.NotTaken=0]="NotTaken",e[e.Taken=1]="Taken",e[e.Returning=2]="Returning"}(C||(t.TakenMode=C={}));class M extends x{constructor(e,t,i){super(e),this.inputEnabled=i,this.ui=u.UiBuilder.for(this.scene),this.shadow=this.ui.image("pawn-shadow"),this.priceTag=this.ui.text("0",p.BitmapFont.Mini,1052688).setOrigin(0,0),this.priceIcon=this.ui.image("ui/budget-icons/neutral").setAlpha(.7).setOrigin(0,0),this.taken=C.NotTaken,this.tweener=new f.Tweener(this.scene),this.image=this.ui.image((0,S.getPawnRenderRecipe)(t.pawnType).getFrame()),this.width=this.image.displayWidth,this.height=this.image.displayHeight,this.setInteractive({cursor:"pointer",hitArea:new T(this.width-this.image.displayWidth/2,1.5*this.height-this.image.displayHeight,this.width,this.height),hitAreaCallback:T.Contains}),this.on("pointerdown",(()=>{this.mode===o.BuyablePawnMode.Unaffordable?(v.app.audio.playEffect(m.SoundEffects.Deny),s.events.trigger(a.UserActions.ToggleTooltip({object:this}))):s.events.trigger(a.UserActions.BuyablePawnPointerDown(t.pawnType))})),this.on("pointerup",(()=>{this.inputEnabled.current&&s.events.trigger(a.UserActions.BuyablePawnPointerUp(t.pawnType))})),this.add([this.shadow,this.image,this.priceTag,this.priceIcon]),this.setConfig(t)}getWorldTransformMatrix(e,t){return super.getWorldTransformMatrix(e,t).translate(-this.width/2,-this.height)}setConfig(e){this.mode===e.mode&&this.priceTag.text===e.priceTag.toFixed()||(this.mode=e.mode,this.priceTag.setText(e.priceTag.toFixed()),this.taken=C.NotTaken,this.updateLayout())}setTaken(e){this.taken=e,this.updateLayout()}restock(){this.taken!==C.NotTaken&&(this.image.clearTint(),this.shadow.setVisible(!0),this.setTaken(C.NotTaken))}updateLayout(){if(this.tweener.stop(),this.taken===C.Taken)this.priceTag.setVisible(!0),this.priceIcon.setVisible(!0),this.priceIcon.setAlpha(1),this.image.setTint(0),this.image.setAlpha(.3,.3,0,0),this.shadow.setVisible(!1);else if(this.taken===C.Returning)this.priceTag.setVisible(!1),this.priceIcon.setVisible(!1),this.shadow.setVisible(!0),this.image.setTint(0),this.image.setAlpha(.3,.3,0,0);else switch(this.mode){case o.BuyablePawnMode.Available:this.priceTag.setVisible(!1),this.priceIcon.setVisible(!1),this.shadow.setVisible(!0),this.image.clearTint(),this.image.setAlpha(1);break;case o.BuyablePawnMode.Unaffordable:this.priceTag.setVisible(!0),this.priceIcon.setVisible(!0),this.priceIcon.setAlpha(.7),this.shadow.setVisible(!1),this.image.setTint(0),this.image.setAlpha(.3,.3,0,0)}y.Arrange.leftToRight({content:[{object:this.priceTag},{object:this.priceIcon}],x:0,origin:.5,spacing:3}),y.Arrange.alignY({content:[this.priceTag,this.priceIcon],y:0,origin:.5})}}t.BuyablePawnGameObject=M},60989:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StatsWidget=void 0,t.createExportUserDataButton=v,t.createWipeButton=b;const s=i(25988),n=i(86545),o=i(80959),a=i(91622),r=i(20087),l=i(85026),c=i(83282),d=i(7334),h=i(66143),u=i(54825),p=i(5365),g=i(56824),m=i(36868),y=i(41331);class f extends s.SideBarWidget{constructor(e){super(e,{offsetFromTitle:12,title:"Expeditions progress"}),this.setContent(new w(e))}updateContent(){this.content.updateContent()}}t.StatsWidget=f;class w extends n.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=o.UiBuilder.for(this.scene),this.progressLabel=this.ui.richText("? levels completed",0),this.exportButton=v(this.ui,(()=>this.updateContent())),this.wipeButton=b(this.ui,(()=>this.updateContent())),this.unlockAllButton=this.ui.formItem({label:"Unlock all levels",component:S(this.ui)}),this.add([this.progressLabel,this.exportButton,this.wipeButton,this.unlockAllButton]),a.inject.theme.use((e=>{this.progressLabel.setTint(e.white),this.unlockAllButton.label.setTint(e.white)}))}calculateHeight(){return this.unlockAllButton.y+this.unlockAllButton.height}updateLayout(){r.Arrange.alignY({content:[this.progressLabel,this.exportButton],y:this.exportButton.height/2,origin:.5}),this.progressLabel.x=0,r.Arrange.leftToRight({content:[this.exportButton,this.wipeButton],spacing:10,x:this.width,origin:1}),this.unlockAllButton.setLabelWidth(this.width-150),this.unlockAllButton.setPosition(0,this.progressLabel.y+this.progressLabel.height+18),this.updateSize()}updateContent(){const e=a.inject.mapRegistry.getAllLevelIds(),t=e.filter((e=>h.LevelModel.for(e).isCompleted()));this.progressLabel.setText(`${t.length}/${e.length} islands conquered.`)}}function v(e,t=()=>{}){return e.outlineButton({icon:"ui/button-icons/download",tooltip:"Export campaign progress to file",theme:"islandCard",variant:"circle",onClicked:async()=>{const e=a.inject.userData.current,i=(0,l.encodeUserData)(e);(0,c.downloadAsTextFile)(`player-profile-export-${(0,d.simpleDateStamp)()}.konkr`,i),u.app.notifications.success("Expeditions progress exported.","To import it on another device, drag and drop the file into the game window."),t()}})}function b(e,t=()=>{}){return e.outlineButton({icon:"ui/button-icons/trash",tooltip:"Wipe all expeditions progress",theme:"islandCard",variant:"circle",onClicked:async()=>{await u.app.modals.confirmWipe()===p.DialogButtons.Wipe&&a.inject.userData.wipeExpeditionProgress(),t()}})}function S(e){const t=(0,y.createToggle)(e,{options:[{text:"ON",value:!0},{text:"OFF",value:!1}],onSelected:e=>{a.inject.userData.rememberChoice("unlockAllIslands",e),g.events.trigger(m.SystemEvents.UserDataLoaded(a.inject.userData.current))}});return t.setValue(a.inject.userData.recallChoice("unlockAllIslands")??!1),t}},61116:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveLayer=void 0;const s=i(897);var n=Phaser.GameObjects.Layer;t.ResponsiveLayer=class extends n{constructor(e,t){super(e,t),this.updateList=[];for(let e of t)(0,s.hasPreUpdate)(e)&&this.updateList.push(e)}add(e){if(this.updateList||(this.updateList=[]),Array.isArray(e))for(let t of e)(0,s.hasPreUpdate)(t)&&this.updateList.push(t);else(0,s.hasPreUpdate)(e)&&this.updateList.push(e);return super.add(e)}remove(e,t){if(Array.isArray(e))for(let t of e){const e=this.updateList.indexOf(t);-1!==e&&this.updateList.splice(e,1)}else{const t=this.updateList.indexOf(e);-1!==t&&this.updateList.splice(t,1)}return super.remove(e,t)}preUpdate(){for(let e of this.updateList)e.preUpdate()}destroy(){super.destroy(),this.updateList.length=0}}},61271:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DisabledOverlayMode=void 0;const s=i(91622);t.DisabledOverlayMode=class{constructor(){this.type="disabled"}update(e,t){s.inject.ui.withoutTransitions((()=>{e.selectedRegionHighlight.clear(),e.pawnBacklight.clear(),e.conquerableHexesHighlight.clear(),e.townStatusFlags.clear(),e.pawnSymbols.clearAll(),e.hexMarkers.clear(),e.attitudeEmojis.clear(),e.regionSummaryPopup.hide(),e.newsAlerts.clear(),e.budgetLabels.clear()}))}toString(){return"[DisabledOverlay]"}}},61408:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.titleToRandomMapSelectTransition=async function(){const e=o.app.scene.titleScreenUI;return o.app.scene.randomMapSelect.scene.setVisible(!1),new Promise((t=>{const i=a.config.screenTransitionDuration;(0,s.titleOutTransition)({excludeButton:1,keepBackgroundPanel:!0,duration:i/2}).then((async()=>{e.scene.setVisible(!1),await(0,n.randomMapInTransition)({duration:i/2,keepBackgroundPanel:!0}),t()}))})).then((()=>{e.buttonsPanel.buttons[1].setAlpha(1),e.scene.setVisible(!0)}))};const s=i(48107),n=i(47102),o=i(54825),a=i(56824)},61510:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CoinTransactionBuilder=void 0,t.mergeTransactions=function(e,t){const i=d.default.cloneDeep(e);for(const e of Object.keys(t)){const s=Number(e),n=t[s];if(i[s]){i[s].consume+=n.consume;for(const e of Object.keys(n.send)){const t=Number(e);i[s].send[t]=(i[s].send[t]||0)+n.send[t]}i[s].spawn+=n.spawn}else i[s]=n}return i};const n=i(1326),o=i(24598),a=i(97849),r=i(20026),l=i(81434),c=i(45664),d=s(i(2543)),h=i(9292);function u(){return{consume:0,send:{},spawn:0}}t.CoinTransactionBuilder=class{constructor(){this.data={}}isEmpty(){return 0===Object.keys(this.data).length}from(e){return this.currentHex=e,this}spawn(e){return a.assert.defined(this.currentHex,"no hex selected"),(0,n.getOrCreate)(this.data,this.currentHex.id,u).spawn+=e,this.currentAmount=e,this}send(e,t=this.currentAmount,i){a.assert.defined(this.currentHex,"no hex selected"),a.assert.defined(t,"amount not specified");const s=(0,n.getOrCreate)(this.data,this.currentHex.id,u);return s.send[e.id]=(s.send[e.id]||0)+t,i&&(s.context=i),this.currentHex=e,this.currentAmount=t,this}consume(e=this.currentAmount){return a.assert.defined(e,"amount not specified"),a.assert.defined(this.currentHex,"no hex selected"),(0,n.getOrCreate)(this.data,this.currentHex.id,u).consume+=e,this}getTransactions(){return this.data}reset(){this.currentHex=void 0,this.currentAmount=void 0,this.data={}}apply(e){return function(e,t){const i={};Object.entries(t).forEach((([e,t])=>{i[e]=i[e]||0,i[e]+=t.spawn,i[e]-=t.consume,Object.entries(t.send).forEach((([t,s])=>{i[e]-=s,i[t]=(i[t]||0)+s}))}));const s=l.Pawns.model((0,r.getParentEngine)(e));return Object.entries(i).forEach((([e,t])=>{const i=(0,c.getHex)(Number(e));a.assert.defined(i),s.adjustCount(i,o.PawnType.Coins,t)})),s.state}(e,this.getTransactions())}getTotalLoot(){return Object.values(this.data).reduce(((e,t)=>{const i=Object.values(t.send).reduce(h.sum,0);return i>0&&"loot"===t.context?e+i:e}),0)}}},61595:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Chunk=t.ChunkedHexRenderer=t.ChunksRenderingController=void 0;var s=Phaser.GameObjects.RenderTexture;const n=i(1326),o=i(98953),a=i(87936),r=i(56824),l=i(91622),c=i(63617),d=i(73230),h=i(19618),u=i(20693),p=i(47273),g=i(99768),m=r.logger.for("ChunkedRenderer");t.ChunksRenderingController=class{constructor(e,t,i=a.HEX_WIDTH){this.scene=e,this.renderer=t,this.margin=i,this.camera=this.scene.cameras.main}update(){const e=Phaser.Geom.Rectangle.Inflate(this.camera.worldView,this.margin,this.margin);for(const t of this.renderer.getVisibleChunks())Phaser.Geom.Intersects.RectangleToRectangle(e,t.boundingBox)||t.setVisible(!1);for(const t of this.renderer.getChunksInRect(e))t.setVisible(!0);l.inject.debugData.set("visibleChunks",this.renderer.getVisibleChunks().size.toString()),r.config.debug.integrityChecks?.pawns&&this.integrityCheck()}integrityCheck(){const e=new Map;for(const t of this.renderer.getAllChunks())for(let i of t.group.getChildren()){if(e.has(i))throw new Error(`Object #${(0,c.getObjId)(i)} is owned by two different chunks! #${e.get(i)?.id} and #${t.id}`);e.set(i,t)}}renderEverything(){this.renderer.getAllChunks().forEach((e=>e.setVisible(!0)))}},t.ChunkedHexRenderer=class{constructor(e,t){this.scene=e,this.chunks={},this.visibleChunks=new Set,this.chunkSize=t.chunkSize,this.sectorMap=new o.HexGridSectors(t.chunkSize),this.isoTilePainter=new g.IsoTilesPainter(this,t.paintedLayers),this.spriteLayers=t.spriteLayers(this)}syncState(e){this.sync({...(0,d.syncRequest)(e)})}syncFaction(e,t,...i){const s=h.Factions.model(e).byId(t)?.hexes??u.HexGroup.empty;this.sync((0,d.syncRequest)(e,s,...i))}sync(e){m.group((0,d.describeSyncRequest)(e)),this.isoTilePainter.paint(e);for(let t of this.spriteLayers)("all"===e.layers||e.layers.has(t.id))&&t.sync(e);m.groupEnd()}getVisibleChunks(){return this.visibleChunks}getAllChunks(){return Object.values(this.chunks)}getByHex(e){return this.getById(this.sectorMap.getSectorOf(e))}getById(e){return(0,n.getOrCreate)(this.chunks,e,(()=>new y(this,e)))}add(e,t){const i=this.sectorMap.getSectorOf(e);return this.getById(i).add(t),t}remove(e,t){const i=this.sectorMap.getSectorOf(e);return this.getById(i).remove(t),t}getChunksInRect(e){return this.getAllChunks().filter((t=>Phaser.Geom.Intersects.RectangleToRectangle(e,t.boundingBox)))}getByCorner(e){return this.sectorMap.getSectorsForCorner(e.id).map((e=>this.getById(e)))}};class y{constructor(e,t){this.parent=e,this.visible=!1,this.corners=[],this.id=t,this.corners=this.parent.sectorMap.getSectorCorners(t).map((e=>p.HexCorner.fromId(e))).filter((e=>e.isValid)),this.group=new Phaser.GameObjects.Group(e.scene),this.visible=!1;const i=this.parent.chunkSize*p.CORNER_WIDTH*2,n=this.parent.chunkSize*p.CORNER_HEIGHT,o=this.id%e.sectorMap.sectorsPerRow*this.parent.chunkSize*(2*p.CORNER_WIDTH)+12,a=Math.floor(this.id/e.sectorMap.sectorsPerRow)*e.sectorMap.sectorSize*p.CORNER_HEIGHT-12;this.boundingBox=new Phaser.Geom.Rectangle(o,a,i,n),this.renderTexture=new s(e.scene,this.boundingBox.x,this.boundingBox.y,2*this.boundingBox.width,2*this.boundingBox.height),this.renderTexture.setOrigin(0,0).setScale(.5),this.group.add(this.renderTexture)}adjustSizeToZoom(e){const t=this.renderTexture.width/2,i=t*e,s=this.renderTexture.height/2*e,n=Math.ceil(i)-i,o=Math.ceil(s)-s,a=n/(i+n)/2,r=o/(s+o)/2;console.log(`CHUNK ${this.id} AT ZOOM ${e} NEEDS ${a} (${n}) EXTRA SCALE X`),this.renderTexture.setScale(.5+a,.5+r),console.log("ACTUAL WIDTH",t*e,"=>",t*e*this.renderTexture.scaleX*2)}add(e){return this.parent.scene.add.existing(e),this.group.add(e),this.visible?e.addToDisplayList():e.removeFromDisplayList(),e}remove(e){return this.group.remove(e,!0),e.addToDisplayList(),e}setVisible(e){if(e===this.visible)return;const t=this.group.getChildren();e?(this.visible=!0,this.parent.visibleChunks.add(this),t.forEach((e=>e.addToDisplayList()))):(this.visible=!1,this.parent.visibleChunks.delete(this),t.forEach((e=>e.removeFromDisplayList())))}}t.Chunk=y},61598:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LAST_PLAYED_HISTORY_SIZE=void 0,t.LAST_PLAYED_HISTORY_SIZE=8},61634:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Economy=t.EMPTY_BUDGET=void 0;const s=i(90952),n=i(20026),o=i(63521),a=i(24598),r=i(61510),l=i(20693),c=i(19162),d=i(81434),h=i(56038),u=i(56824),p=i(52985),g=i(19618),m=i(27109),y=i(83109),f=i(88023),w=u.logger.for("Economy");t.EMPTY_BUDGET={balance:0,upkeep:0,incomeFromHexes:0,potentialIncome:0};class v{static model(e){return this.models.get(e)}static getTownHexesByRegion(e,t){return(0,n.selectFromState)(e,s.GameState.economy.townsByRegion,t)||(0,f.ImmutableSet)()}static getPotentialIncomeFromHex(e,t){return d.Pawns.isPresentOnHex(e,t,a.PawnType.Swamp)?0:d.Pawns.isPresentOnHex(e,t,a.PawnType.GoldMine)?c.Rules.getPawnRules(e,a.PawnType.GoldMine).income??1:1}static getCurrentIncomeFromHex(e,t){return d.Pawns.isTraitPresentOnHex(e,t,o.PawnTraits.NegatesTileIncome)?0:this.getPotentialIncomeFromHex(e,t)}static getTreasuryOf(e,t){return(0,n.selectFromState)(e,s.GameState.economy.treasuryByRegion,t)||0}static getNumberOfCoinsAt(e,t){return(0,n.selectFromState)(e,s.GameState.economy.coinsByHex,t)||0}static isRegionBankrupt(e,t){return this.getTreasuryOf(e,t)+this.getRegionBudget(e,t).balance<0}static isRegionAlive(e,t){if(0===v.getTownHexesByRegion(e,t).size)return!1;const i=g.Factions.getByRegion(e,t);if(!i)return!1;const s=g.Factions.getData(e,i);return!(!s?.controller||s?.controller===a.FactionController.None)}static payForNewPawn(e,t,i,s){return this.payToHex(e,t,i,c.Rules.getPawnRules(e,s)?.cost||0)}static payToHex(e,t,i,s,n=new r.CoinTransactionBuilder){const o=h.Regions.model(e).byId(t),l=d.Pawns.model(e);let c=s;n.from(i).consume(s);let u=new Set;for(;c>0;){const t=o.hexes.with(i).findClosest(i,(t=>!u.has(t)&&l.presentAtHex(t,a.PawnType.Town)&&v.getNumberOfCoinsAt(e,t.id)>0));if(!t)throw new Error(`Unable to find enough gold to pay ${s}g to hex ${i} in region ${o}`);const r=v.getNumberOfCoinsAt(e,t.id),d=Math.min(r,c);c-=d,u.add(t),n.from(t).send(i,d,"upkeep")}return n}static loot(e){const{fromHex:t,looter:i,looterRegion:s,coinTransactionBuilder:n,worldUpdateBuilder:r,state:d,spawn:h}=e,u=function(){const e=c.Rules.model(d).pawns(i).hasTrait(o.PawnTraits.Undead);if(i===a.PawnType.Bandit)return(0,y.getOrCreateNearestCamp)(d,t,r)?.hex;if(!e){if(!s)return;const e=v.getTownHexesByRegion(d,s.id);return l.HexGroup.from([...s.hexes.members,t]).findClosest(t,(i=>i!==t&&e.includes(i.id)))}}();h&&n.from(t).spawn(h);const p=this.getNumberOfCoinsAt(d,t.id)+h;return 0===p||(u?n.from(t).send(u,p,"loot"):(w.warning(`did not find any town in ${s} that could receive loot from ${t}, the money will just disappear`),n.from(t).consume(p))),n}static getRegionBudget(e,i){return(0,n.selectFromState)(e,s.GameState.economy.budgetByRegion,i)||t.EMPTY_BUDGET}}t.Economy=v,v.models=new m.ModelsCache((e=>new p.EconomyModel(e)))},61727:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GraphicsContainer=void 0;const s=i(897),n=i(72349);var o=Phaser.GameObjects.Graphics;t.GraphicsContainer=class extends o{constructor(...e){super(...e),this.renderedWidth=0,this.renderedHeight=0,this.preUpdate=(0,s.whenDirty)((()=>{this.hasDimensionsChangedSinceLastRender()&&(this.clear(),this.width<=0||this.height<=0||this.render(this.width,this.height))})),n.ResponsiveSizeComponent.overrideSizeComponent(this)}rerender(){this.clear(),this.render(this.width,this.height)}hasDimensionsChangedSinceLastRender(){return this.renderedWidth!==this.width||this.renderedHeight!==this.height}}},61913:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LazyExpeditionPortal=t.ExpeditionPortalButton=void 0;const s=i(48063),n=i(18957),o=i(56824),a=i(35003),r=i(91622),l=i(36868),c=i(54825),d=i(54429),h=i(86545),u=i(80959),p=i(76049),g=i(20087),m=i(98963),y=o.logger.for("LazyIslandPreview");class f extends h.BaseResponsiveContainer{constructor(e,t){super(e),this.scene=e,this.props=t,this.onClicked=(0,n.signal)(),this.width=96,this.height=115;const i=u.UiBuilder.for(e);this.icon=i.image(`expedition-icons/${this.props.id}`),this.rosetta=i.image("rosetta-light").setTint(r.inject.theme.getCurrent().oceanShades.light2),this.caption=i.text("",p.BitmapFont.Main,16777215),this.props.id&&(this.icon.setInteractive({cursor:"pointer"}),this.icon.on("pointerdown",(()=>{c.app.audio.playEffect(m.SoundEffects.ButtonDown),this.onClicked.fire()}))),this.add([this.rosetta,this.icon,this.caption])}updateLayout(){const e=this.rosetta.width;g.Arrange.alignX({content:[this.icon,this.rosetta,this.caption],origin:.5,x:48}),g.Arrange.alignY({content:[this.icon,this.rosetta],origin:.5,y:e/2}),this.caption.y=this.rosetta.height-6}updateContent(e){e.title?(this.caption.setVisible(!0),this.caption.setText(e.title)):this.caption.setVisible(!1),e.id?(this.icon.setFrame(`expedition-icons/${e.id}`),this.icon.setVisible(!0)):this.icon.setVisible(!1)}}t.ExpeditionPortalButton=f,t.LazyExpeditionPortal=class{constructor(e,t){this.scene=e,this.props=t,this.onClicked=(0,n.signal)(),this.updateBoundingBox()}destroy(){this.button?.destroy(),this.button=void 0}updateBoundingBox(){const{x:e,y:t}=this.props.portal.shape;this.boundingBox=new Phaser.Geom.Rectangle(e*s.PREVIEW_HEX_WIDTH,t*s.PREVIEW_HEX_INNER_HEIGHT,96,115)}getBoundingBox(){return this.boundingBox}getLinkAnchorPoint(){const{x:e,y:t}=this.getBoundingBox(),i=this.button?.height??this.getBoundingBox().height;return{x:e+a.ExpeditionButton.Layout.contentOffsetLeft/2+a.ExpeditionButton.Layout.frameMargin,y:t+i/2}}refresh(){this.button&&(this.button.updateContent(this._getButtonProps()),this.button.rosetta.setTint(r.inject.theme.getCurrent().oceanShades.light2),this.button.caption.setTint(r.inject.theme.getCurrent().oceanContrastLight))}_getButtonProps(){if("entrypoint"===this.props.portal.type)return{title:void 0,id:void 0};{const e=r.inject.mapRegistry.getExpeditionById(this.props.portal.id);return e?{title:e.metadata.name,id:e.id}:(y.warning(`Ignoring reference to unknown expedition "${this.props.portal.id}"`),{title:void 0,id:void 0})}}async show(){this.button||(this.button=new f(this.scene,this._getButtonProps()),this.scene.add.existing(this.button),this.button.setDepth(d.OverworldMapLayers.Islands),this.button.updateLayout(),this.button.onClicked((()=>{o.events.trigger(l.UserActions.GoToExpedition({expeditionId:this.props.portal.id,focusObjectId:c.app.screen.overworld.selectedExpedition.id}))})),this.refresh(),this.updatePosition())}updatePosition(){this.button&&(this.updateBoundingBox(),this.button.setPosition(this.boundingBox.centerX-this.button.width/2,this.boundingBox.centerY-this.button.height/2))}}},62049:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getFactionsFromConfig=function(e,t){return t.map(((t,i)=>e.factions.byId(i+1)))}},62076:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GrassDecalsLayer=void 0;const s=i(73230),n=i(35800),o=i(96137),a=i(47273);t.GrassDecalsLayer=class{addDirtyCorners(e){}paintCorner(e,t,i,s,n){const r=this.greens.getGroupByHex(i.sortedHexes[0]);if(!r)return;const l=r?.getCornerVariant(i);if("A111"===l&&(this.random.reset(i.id),this.random.boolean(.75))){const e=this.random.boolean()?"grass":"grass2",i=a.CORNER_WIDTH-5-4,l=a.CORNER_HEIGHT-1-4;s+=2*this.random.integerBetween(2,i),n+=2*this.random.integerBetween(2,l),t.batchDrawFrame("atlas",`hex-decals/${e}`,s,n,1,o.Colors.darker(r.tint))}}constructor(e){this.greens=e,this.random=(0,n.createRandomGenerator)(),this.id=s.RenderLayerKey.GrassDecals}}},62146:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDiscordAttachmentUrl=function(e){return e.startsWith("https://cdn.discordapp.com/")},t.downloadDiscordAttachment=async function(e){const t=`${s.config.cloudFunctionsUrl}downloadDiscordAttachment?url=${encodeURIComponent(e)}`;try{window.setLoadingStatus("Downloading Discord attachment...",!0);const e=await fetch(t);if(!e.ok)throw new Error(e.statusText);return window.setLoadingStatus("",!1),e.text()}catch(e){window.setLoadingStatus("Oops, sorry! I was unable to download this Discord attachment for you.<br/><br/>To get around this issue, you can try to download the attachment to your device first, then drag and drop the file into this window.",!1)}};const s=i(56824)},62244:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinTransactionCinematic=void 0;const s=i(1132),n=i(45664),o=i(87936),a=i(79573),r=i(26596),l=i(97849),c=i(56824),d=i(91622),h=i(54825),u=i(98963),p=i(38021);c.logger.for("CoinTransactionCinematic");class g extends s.BaseCinematic{constructor(e,t,i){super(e.scene),this.coins=e,this.transactions=t,this.session=i}execute(e){if(!this.session.isActive())return void(e&&e());const t=this.scene;let i={};const s={};let r=0;const g=this.transactions,m=this.coins,y=this;for(let e in g){const t=(0,n.getHex)(Number(e));l.assert.defined(t);const h=g[e],u=[];for(let e=0;e<h.spawn;++e){const e=this.coins.pools.getCoin((t.x+.5)*o.HEX_WIDTH,t.y*o.HEX_INNER_HEIGHT+o.HEX_HEIGHT/2+c.random.integerBetween(-2,2));e.setDepth(a.WorldLayers.FlyingObject+e.y),u.push(e),this.scene.add.existing(e),e.setAlpha(0)}d.inject.ui.skipTransitions()||this.animateCoinSpawn(u),r+=u.length,i[e]=u,s[e]=h.consume||0}if(r>=10?h.app.audio.playEffect(u.SoundEffects.CoinsHandful):r>0&&h.app.audio.playEffect(u.SoundEffects.CoinsFew),d.inject.ui.skipTransitions())f(),w(),e&&e();else{const e=r>0?1e3:0;this.scene.time.addEvent({delay:e,callback:f})}function f(){if(!y.session.isActive())return function(){for(let e of Object.values(i).flat())y.coins.pools.free(e),i={};e&&e()}();let s=0,o=0;for(let e in g){const t=(0,n.getHex)(Number(e));l.assert.defined(t);const r=g[e],c=Object.values(r.send).reduce(((e,t)=>e+t),0);for(let s=r.spawn;s<c;++s){const s=m.getOrCreatePile(t).spawnCoin();s.setDepth(a.WorldLayers.FlyingObject-s.y),i[e].push(s),m.scene.add.existing(s)}for(let t in r.send){const a=(0,n.getHex)(Number(t)),c=r.send[t];l.assert.defined(a);const d=i[e];c>0&&(s=Math.max(s,c),"loot"===r.context&&(o+=c),m.getOrCreatePile(a).storeCoins(d.slice(0,c))),i[e]=i[e].slice(c)}i[e].length>0&&m.getOrCreatePile(t).storeCoins(i[e])}if(!d.inject.ui.skipTransitions()){const i=s>0?600:0;!function(){if(!y.session.isActive())return!1;for(let e in g)if(g[e].consume>0)return!0;return!1}()?e?.():(t.time.addEvent({delay:i,callback:w}),t.time.addEvent({delay:i+300,callback:e})),(0,p.playCoinSoundEffect)(o)}}function w(){if(y.session.isActive())for(let e in g){const t=(0,n.getHex)(Number(e));l.assert.defined(t);const i=g[e].consume;0!==i&&m.getOrCreatePile(t).deleteCoins(i)}else e&&e()}}animateCoinSpawn(e){const t=e.map((()=>c.random.integerBetween(-100,100)));e.forEach(((e,i)=>{this.scene.time.addEvent({delay:t[i],callback:()=>{e.play("spin-coin")}})})),this.scene.tweens.add({targets:e,duration:500,y:"-=1",ease:r.jump,easeParams:[80],delay:(e,i,s,n)=>t[n],onComplete:()=>e.forEach((e=>{e.anims.stop(),e.setFrame(0)}))}),this.scene.tweens.add({targets:e,duration:500,x:e=>e.x+c.random.integerBetween(-4,4),alpha:{from:0,to:1},delay:(e,i,s,n)=>t[n]})}}t.CoinTransactionCinematic=g},62277:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.watchableHexUnderCursor=function(){const e=(0,n.watchable)(void 0);return e.update=t=>{const i=a.inject.gameStateModel;t.input.activePointer.updateWorldPoint(t.cameras.main);const s=r(t,i);e.set(s)},e.clear=()=>{e.set(void 0)},e},t.getHexUnderCursor=r;const s=i(87936),n=i(96130),o=i(45664),a=i(91622);function r(e,t){let i,n,r=(e.input.activePointer.worldX+s.HEX_WIDTH/2)/s.HEX_WIDTH,l=e.input.activePointer.worldY/s.HEX_INNER_HEIGHT,c=r%1,d=l%1;a.inject.debugData,Math.floor(l)%2?c<.5?d<(1-2*c)/3?(i=Math.floor(r),n=Math.floor(l)-1/3):(i=Math.floor(r)+.5,n=Math.floor(l)+2/3):d<1/3-2*(1-c)/3?(i=Math.floor(r)+1,n=Math.floor(l)-1/3):(i=Math.floor(r)+.5,n=Math.floor(l)+2/3):c<.5?d<2*c/3?(i=Math.floor(r)+.5,n=Math.floor(l)-1/3):(i=Math.floor(r),n=Math.floor(l)+2/3):d<2/3-2*c/3?(i=Math.floor(r)+.5,n=Math.floor(l)-1/3):(i=Math.floor(r)+1,n=Math.floor(l)+2/3),i-=1,n-=2/3;let h=Math.round(n),u=Math.round(i+h%2/2);if(t.map.isWithinBounds({r:h,c:u}))return(0,o.getHex)({r:h,c:u})}},62367:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Theme=void 0;const s=i(23382),n=i(91622),o=i(96130),a=i(56824),r=i(2543),l=i(54825),c=i(25e3),d=i(10131),h=i(48884);var u=Phaser.Display.Color;const p=a.logger.for("Theme");function g(e,t){const i=e.clone();return i.v*=t,i.color}function m(e,t){const i=e.clone();return i.v=t,i.color}function y(e,t,i){const s=u.IntegerToColor(i.oceanColor??t.oceanColor),n=.299*(o=s).redGL+.587*o.greenGL+.114*o.blueGL;var o;const a=n<.3,r=n>.6,l=s.clone().lighten(3).desaturate(3).color,c=s.clone().lighten(10).desaturate(10).color,d=s.clone().lighten(20).desaturate(10).color,h=a?13684944:m(s,.1+n/5),p=r?m(s,.3+n/5):15921906,y={light1:l,light2:c,light3:d,dark1:g(s,.9),dark2:g(s,.8),dark3:g(s,.7),dark4:g(s,.6),dark5:g(s,.5)};return{...t,presetName:e,oceanContrastLight:p,oceanContrastDark:h,oceanShades:y,white:16382457,...i}}t.Theme=class{constructor(){this.current=(0,o.watchable)(y("<uninitialized>",s.THEMES.default,{})),this.listeners=[],this.debugOverrides={},this.initialize=(0,d.asyncInitializer)((async()=>{await n.inject.userData.initialize(),this.sync("default",!1),(0,h.createThemedStyleElement)(),this.current.watchFuture(((e,t)=>{this.listeners.length,this.listeners=this.listeners.filter((t=>!!t&&(t(e),!0))),n.inject.debugData.set("theme listeners",this.listeners.length.toString())}))}))}setDebugOverride(e){this.debugOverrides={...this.debugOverrides,...e},this.getCurrent().presetName="_outdated",this.sync()}clearDebugOverrides(){this.debugOverrides={},this.getCurrent().presetName="_outdated",this.sync()}use(e,t){e(this.current()),this.listeners.push(e),t&&t.on("destroy",(()=>{this.unsubscribe(e)}))}unsubscribe(e){this.listeners=this.listeners.filter((t=>t!==e))}getCurrent(){return this.current()}get(e){let t=s.THEMES[e]??s.THEMES.default;return y(e,this._withOceanColorOverride(t),this.debugOverrides)}getFactionColor(e,t){return this.current().factionColors[e]}getFactionLightColor(e,t){return u.IntegerToColor(this.current().factionColors[e]).lighten(10).color}getOceanColor(){return this.current().oceanColor}getUserPreferredTheme(){let e=n.inject.userData.recallChoice("preferredTheme")??"default";if("string"==typeof e)return this.isValidKey(e)?e:"default"}customize(e){const t=this.current(),i={oceanColor:t.oceanColor,factionColors:t.factionColors,forestsTexture:t.forestsTexture,...e};n.inject.userData.rememberChoice("preferredTheme",i),this.sync()}set(e){n.inject.userData.rememberChoice("preferredTheme",e),n.inject.userData.rememberChoice("preferredOceanColor",void 0),this.sync()}isAlreadyUsing(e="default"){return"default"!==this.getUserPreferredTheme()||this.current().presetName===e}sync(e="default",t=!0){const i=this.getUserPreferredTheme();if(this.isValidKey(e)||(p.warning(`Ignoring invalid default theme "${e}".`),e="default"),i)"default"===i?this._switchToPreset(e):this._switchToPreset(i);else{let e=n.inject.userData.recallChoice("preferredTheme");const t=y(void 0,this._withOceanColorOverride(e),this.debugOverrides);if((0,r.isEqual)(t,this.current()))return;this.current.set(t)}t&&l.app.scene.worldMap.scene.isActive()&&(l.app.scene.worldMap.applyTheme(),l.app.scene.worldMap.chunkedRenderer.syncState(l.app.getCurrentGameStateModel().state)),l.app.scene.globalUI.setOceanColor(this.current().oceanColor),c.NewsBox.syncWithTheme()}_withOceanColorOverride(e){const t=n.inject.userData.recallChoice("preferredOceanColor");return void 0!==t?{...e,oceanColor:t}:e}_switchToPreset(e){const t=n.inject.userData.recallChoice("preferredOceanColor")??s.THEMES[e].oceanColor;this.getCurrent().presetName===e&&this.getCurrent().oceanColor===t||this.current.set(y(e,this._withOceanColorOverride(s.THEMES[e]),this.debugOverrides))}isValidKey(e){return!!e&&!!s.THEMES[e]}}},62481:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.internalLoadGame=function(e){const t=a.storage.getItem(s.SAVE_GAME_LOCAL_STORAGE_PREFIX+e);if(!t)throw new Error(`no data found for save "${e}"`);let i;try{i=(0,o.decodeGameState)(t)}catch(e){throw new Error("save data corrupted")}if(i.version!==n.CORE_GAMESTATE_SCHEMA_VERSION)throw new Error("save data not compatible with current version of the game");return i};const s=i(91693),n=i(62643),o=i(85026),a=i(56824)},62609:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.simpleListView=function(e,t){const i=t.mapper??(e=>String(e));return new s.ListView(e,{createOrUpdateRow:(t,n)=>(n||(n=new s.ListViewSimpleRow(e)),n.setText(i(t)),n),theme:s.ListView.Themes[t.theme??"white"],width:t.width})},t.dropdownListView=function(e,{theme:t}){const i=s.ListView.Themes[t??"dropdownList"];return new s.ListView(e,{createOrUpdateRow:(t,i)=>{const s={text:{text:t.text,font:a.VectorFont.Roboto,...t.textStyle},icon:t.icon};return i?i.setProps(s):(i=new o.RichListItem(e,s)).setInteractiveAuto(),i},theme:i})},t.buttonsListView=function(e,{theme:t}){const i=s.ListView.Themes[t??"timeline"];return new s.ListView(e,{createOrUpdateRow:(t,i)=>{const s={text:{text:t.text,font:a.VectorFont.Roboto,bbCode:!0,...t.textStyle},icon:t.icon,addons:t.addons};return i?i.content.setProps(s):i=new n.RoundedRectButton(e,{theme:n.RoundedRectButton.Themes.subtle,radius:8,content:new o.RichListItem(e,s)}),i},theme:i})};const s=i(69572),n=i(46973),o=i(73980),a=i(76049)},62643:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CORE_GAMESTATE_SCHEMA_VERSION=void 0,t.CORE_GAMESTATE_SCHEMA_VERSION=7},62732:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BeginButton=t.RandomMapSelectScene=t.DEFAULT_STATE=void 0;const s=i(81700),n=i(897),o=i(30948),a=i(55275),r=i(80959),l=i(76049),c=i(96137),d=i(14739),h=i(20087),u=i(36868),p=i(15316),g=i(64155),m=i(90444),y=i(51986),f=i(71262),w=i(29135),v=i(98963),b=i(51496),S=i(91622),x=i(54825),T=i(25342),P=i(59956),I=i(30484),C=i(35800),M=i(56824),A=i(12605),B=i(85072),E=i(30963),O=i(43878),R=i(36014),k=i(53360);var L=Phaser.GameObjects.Image;function _(e){switch(e){case B.MapDifficulty.Casual:case B.MapDifficulty.Normal:return"normal";default:return"hard"}}t.DEFAULT_STATE={preset:{version:B.MAP_GENERATOR_VERSION,name:"",size:B.MapSize.Medium,shape:B.MapShape.Temperate,difficulty:B.MapDifficulty.Challenging,mode:B.MapMode.Classic}};class D extends o.BaseUIScene{constructor(){super({key:s.Scenes.RandomMapSelectUI}),this.state=(0,a.stateContainer)(t.DEFAULT_STATE,((e,t,i)=>{e.preset&&this.settingsPanel.applyState(e.preset,t.preset,i.preset)})),this.random=(0,C.createRandomGenerator)(),this.mapGenerator=new w.AsyncJobExclusiveRunner(((e,t)=>this._generateMap(e,t))),this.preUpdate=(0,n.whenDirty)((()=>{const e=this.bounds.height;if(this.mainPanelUI.updateLayout(),this.settingsPanel.compressLayout=this._shouldCompressLayout(),this.settingsPanel.updateLayout(),this.backButton.setPosition(this.mainPanelUI.mainPanel.x+30,20),h.Arrange.topToBottom({content:[{object:this.levelNamePanel,size:250,minSize:130},{object:this.settingsPanel},{object:this.beginButton,size:50}],y:e/2,origin:.5,spacing:this._getSpacing(),maxSize:e-60}),h.Arrange.alignX({content:[this.levelNamePanel,this.settingsPanel,this.beginButton],x:this.mainPanelUI.mainPanel.x+this.mainPanelUI.mainPanel.width/2,origin:.5,width:this.mainPanelUI.mainPanel.width-60}),M.config.flags.halloween){this.halloweenToggle.y=this.beginButton.y+2,this.halloweenToggle.x=this.beginButton.x,this.halloweenToggle.setValue((0,k.isHalloweenMode)()?"on":"off");const e=this.halloweenToggle.width+8;this.beginButton.x+=e,this.beginButton.width-=e,this.halloweenLabel.setPosition(this.halloweenToggle.x-this.halloweenLabel.width/3,this.halloweenToggle.y-20)}}))}get contentHeight(){return this.beginButton.y+this.beginButton.height+this._getSpacing()}create(){super.create();const e=r.UiBuilder.for(this);(0,A.makeSceneScrollable)(this),this.mainPanelUI=new O.VerticalStripePanelUI_OLD(this,{stickToRightSide:!0}),this.mainPanelUI.addToScene(),this.levelNamePanel=new m.LevelNamePanel(this),this.settingsPanel=new y.MapSettingsPanel(this),this.beginButton=new H(e),this.halloweenToggle=new R.Toggle(this,{enabled:!0,initialValue:"on",theme:R.ToggleThemes.glass,width:120,onSelected:e=>{S.inject.userData.rememberChoice("disableHalloweenMode","off"==e),this.mapGenerator.run({preset:this.state().preset})},options:[{value:"on",text:"ON",bgColor:7166575,icon:"ui/level-features/zombies"},{value:"off",text:"OFF",bgColor:c.Colors.glassUi.textMain}]}),this.halloweenLabel=e.image("ui/zombify-label"),this.backButton=new p.RibbonButton(this,0,0,{icon:new L(this,0,0,"atlas","ui/mini-icons/back").setTint(c.Colors.woodenUi.primaryText),type:p.RibbonButtonStyle.Small,width:120,content:e.text("MENU",l.BitmapFont.Small,c.Colors.woodenUi.primaryText)}),this.backButton.onClicked((()=>{M.events.trigger(u.UserActions.GoBack())})),this.beginButton.onClicked((()=>{if(this.mapGenerator.isRunning())return void x.app.audio.playEffect(v.SoundEffects.Deny);const e=this.state().preset;S.inject.userData.rememberChoice("randomMapOptions",{...e,name:this.random.townName()});const t=S.inject.gameStateModel.map.levelId;b.track.randomMapSelected({level_id:t,map_name:e.name,map_size:e.size,map_shape:e.shape,map_mode:e.mode,map_difficulty:e.difficulty}),M.events.trigger(u.UserActions.PlayLevel({levelId:t,origin:"conquest/begin",aiDifficulty:_(e.difficulty),startingState:S.inject.gameStateModel.exportState(),restart:!0}))})),this.settingsPanel.onSettingChanged((e=>{this.state.update({preset:{...this.state().preset,...e.update}}),S.inject.userData.rememberChoice("randomMapOptions",this.state().preset),this.startGenerating(e.direction)})),this.observe.event(u.UserActions.GenerateNewIsland,(async e=>{this.random.reset();const t=this.state().preset;this.state.update({preset:{...t,name:e?.name??this.random.townName()}}),S.inject.userData.rememberChoice("randomMapOptions",this.state().preset),b.track.randomMapRerolled({map_mode:t.mode,map_difficulty:t.difficulty,map_size:t.size,map_shape:t.shape,map_name:t.name}),this.startGenerating("down")})),this.mapGenerator.onJobStarted((()=>{this.levelNamePanel.regenerateLevelButton.setEnabled(!1)})),this.mapGenerator.onJobFinished((()=>{this.levelNamePanel.regenerateLevelButton.setEnabled(!0)})),this.components=[this.backButton,this.levelNamePanel,this.settingsPanel,this.beginButton,...M.config.flags.halloween?[this.halloweenToggle,this.halloweenLabel]:[]],this.addAll(this.components)}startGenerating(e){this.mapGenerator.run({preset:this.state().preset,panDirection:e})}async _generateMap(e,t){const i=(0,g.buildGeneratorConfig)(e.preset);await this._maybePanAway(e.panDirection),await(0,f.generateMap)(i,t),P.WorldMap.update(S.inject.currentGameState,{levelId:T.RandomMapHash.generate(e.preset)}),this.levelNamePanel.levelNameText.setText(e.preset.name),this.levelNamePanel.updateLayout(),x.app.scene.worldMap.scene.wake(),x.app.scene.worldMap.syncState(S.inject.currentGameState,I.OverlayModes.disabled),x.app.scene.worldMap.cameraController.zoomController.zoomTo(E.DEFAULT_CAMERA_ZOOM,"instant"),this._maybePanBack(e.panDirection)}async _maybePanAway(e){e&&await x.app.scene.worldMap.cameraController.panAway(e,M.config.screenTransitionDuration)}async _maybePanBack(e){e?await x.app.scene.worldMap.cameraController.panIntoCenter(e,M.config.screenTransitionDuration,this._getMapOffset()):await x.app.scene.worldMap.cameraController.center(0,{offsetX:this._getMapOffset()})}_getMapOffset(){return this.mainPanelUI.isFullScreen()?0:this.mainPanelUI.mainPanel.width/2}_getSpacing(){return this._shouldCompressLayout()?15:30}_shouldCompressLayout(){return this.bounds.height<555}getTooltipFor(e){switch(e){case this.levelNamePanel.regenerateLevelButton:return{title:"Click to find a different island."};case this.backButton:return{title:"Return to main menu."}}return super.getTooltipFor(e)}}t.RandomMapSelectScene=D,D.Layout={};class H extends d.RoundedRectButton_LEGACY{constructor(e){const t=e.text("Begin!",l.BitmapFont.Main,c.Colors.glassUi_old.primaryText),i=e.image("ui/level-icons/in-progress"),s=e.hLayout({originX:.5,originY:.5,content:[i,t],spacing:10});super(e.scene,{raised:4,contentOriginX:.5,content:s}),this.label=t,this.layout=s,this.icon=i}}t.BeginButton=H},62845:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelListUI=t.TabSlider=void 0,t.createFilterButton=b;const s=i(80959),n=i(55275),o=i(83221),a=i(36868),r=i(56824),l=i(20087),c=i(70033),d=i(7782),h=i(54825),u=i(98963),p=i(66143),g=i(54429),m=i(66272),y=i(91622);var f=Phaser.GameObjects.TileSprite,w=Phaser.GameObjects.Image;class v extends f{constructor(e){super(e,0,0,350,16,"atlas","glass-ui/line-with-arrow-up"),this.targetX=new d.TransitionController(this.scene,{duration:150,ease:"Sine.easeInOut",initialValue:184,applyValue:e=>{const t=Math.floor(128-e+o.MenuHeaderUIScene.Layout.backgroundMargin);this.setTilePosition(t)}}),this.setOrigin(0,0),this.setTilePosition(-16),y.inject.theme.use((e=>{this.setTint(e.oceanContrastLight)}))}}function b(e,t){const i=new w(e,0,0,"atlas",t.icon).setScale(.75);return i.setInteractive({cursor:"pointer"}),i.on("pointerdown",(()=>{t.onClick(i),h.app.audio.playEffect(u.SoundEffects.ButtonDown)})),i}t.TabSlider=v,t.LevelListUI=class{constructor(e){this.scene=e,this.filterSlider=new v(this.scene),this.filterButtons=[],this.state=(0,n.stateContainer)({open:!1,levelFilter:g.LevelFilter.Gold,levels:[],sortBy:m.SortBy.LevelNumber},this.applyState.bind(this));const t=s.UiBuilder.for(e);this.showHideButton=t.outlineButton({text:"?",icon:"ui/button-icons/menu",iconPlacement:"left",variant:"small",width:126,onClicked:()=>{r.events.trigger(a.UserActions.ToggleLevelList())}}),this.sortButton=t.outlineButton({icon:"ui/button-icons/sort-numerical",iconPlacement:"left",variant:"small",width:30,tooltip:"Change how the levels are sorted",onClicked:()=>{var e;r.events.trigger(a.UserActions.SetLevelListSortBy((e=this.state().sortBy,S[(S.indexOf(e)+1)%S.length])))}}),this.filterButtons=[b(e,{icon:"ui/level-list-filters/all",value:g.LevelFilter.All,onClick:()=>r.events.trigger(a.UserActions.SetLevelListFilter(g.LevelFilter.All))}),b(e,{icon:c.LevelIcons.Fighting,value:g.LevelFilter.Unlocked,onClick:()=>r.events.trigger(a.UserActions.SetLevelListFilter(g.LevelFilter.Unlocked))}),b(e,{icon:c.LevelIcons.Silver,value:g.LevelFilter.Silver,onClick:()=>r.events.trigger(a.UserActions.SetLevelListFilter(g.LevelFilter.Silver))}),b(e,{icon:c.LevelIcons.Gold,value:g.LevelFilter.Gold,onClick:()=>r.events.trigger(a.UserActions.SetLevelListFilter(g.LevelFilter.Gold))})],this.scene.addAll([this.showHideButton,this.filterSlider,...this.filterButtons,this.sortButton]),this.state.apply()}applyState(e,t,i,s){if(void 0!==e.open||e.levelFilter)if(e.open){this.showHideButton.content.setText("Hide list"),this.showHideButton.content.setIcon("ui/mini-close-button");const e=t.levelFilter!==g.LevelFilter.Disabled;this.filterButtons.forEach((t=>t.setVisible(e))),this.filterButtons[2].setVisible(e&&h.app.screen.overworld.selectedExpedition.levels.some((e=>e.getLevelStatus()===p.LevelStatus.SilverMedal))),this.filterButtons[3].setVisible(e&&h.app.screen.overworld.selectedExpedition.levels.some((e=>e.getLevelStatus()===p.LevelStatus.GoldMedal)));const i=this.filterButtons[2].visible||this.filterButtons[3].visible;this.filterButtons[0].setVisible(e&&i),this.filterButtons[1].setVisible(e&&i),this.filterSlider.setVisible(e&&i),this.sortButton.setVisible(e)}else this.showHideButton.content.setText("Browse islands"),this.showHideButton.content.setIcon("ui/button-icons/menu"),this.filterButtons.forEach((e=>e.setVisible(!1))),this.filterSlider.setVisible(!1),this.sortButton.setVisible(!1);if(e.sortBy){const t=`ui/button-icons/sort-by-${e.sortBy}`;this.sortButton.content.setIcon(t)}this.updateLayout(s)}_getFilterTabTargetX(){const e=[g.LevelFilter.All,g.LevelFilter.Unlocked,g.LevelFilter.Silver,g.LevelFilter.Gold].indexOf(this.state().levelFilter),t=this.filterButtons[e];return t.x+t.width/2}updateLayout(e="instant"){const{attachmentTop:t,backgroundMargin:i,backgroundPadding:s,backgroundMinWidth:n}=o.MenuHeaderUIScene.Layout;l.Arrange.leftToRight({content:[this.showHideButton,...this.filterButtons],x:i+s,spacing:8,origin:0}),l.Arrange.alignY({content:[this.showHideButton,...this.filterButtons,this.sortButton],y:t,origin:.5}),this.sortButton.x=n-i-this.sortButton.width,this.filterSlider.setPosition(i,t+20),this.filterSlider.width=n-i,this.filterSlider.visible&&this.filterSlider.targetX.setTo(this._getFilterTabTargetX(),e)}};const S=[m.SortBy.LevelNumber,m.SortBy.LevelName,m.SortBy.TurnCount,m.SortBy.Mode]},62847:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gameStateReducer=function(e,t){switch(t.name){case s.Plays.EndTurn.eventName:return(0,n.executeEndTurn)(e);case s.Plays.EditMap.eventName:return[s.GameStateEvents.NewGameState({state:t.payload.stateAfter,context:l.NewGameStateContext.ResumingGame})];case s.Plays.BuyPawn.eventName:return(0,a.executeBuyPawn)(e,t.payload);case s.Plays.MovePawn.eventName:return(0,o.executeMovePawn)(e,t.payload);case s.Plays.SpawnUnits.eventName:return(0,h.executeSpawnUnits)(e,t.payload);case s.Plays.BanditsAct.eventName:return e.plugins.zombies?(0,d.executeZombiesAct)(e):(0,r.executeBanditsAct)(e);case s.Plays.AcceptSurrender.eventName:return(0,c.executeAcceptSurrender)(e)}};const s=i(36868),n=i(22881),o=i(14616),a=i(52197),r=i(56582),l=i(71021),c=i(29469),d=i(4586),h=i(44373)},62899:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurrentPhaseModel=void 0;const s=i(24598),n=i(97849),o=i(45084),a=i(19618),r=i(81434),l=i(94399),c=i(29172),d=i(75742);class h extends l.BaseModel{constructor(){super(...arguments),this.tappedUnits=(0,c.lazyAdapter)({source:()=>o.CurrentPhase.getTappedUnits(this.state),transform:e=>e.map((e=>r.Pawns.model(this.state).byId(e)))})}get type(){return o.CurrentPhase.getType(this.state)}get turnNumber(){return o.CurrentPhase.getTurnNumber(this.state)}get faction(){const e=o.CurrentPhase.getFaction(this.state);if(void 0!==e)return a.Factions.model(this.state).byId(e)}isTapped(e){return o.CurrentPhase.isTapped(this.state,e.id)}isMovable(e){return e.region?.isAlive()&&o.CurrentPhase.isMovable(this.state,e.id)}isLocalPlayerTurn(){return this.type===s.PhaseTypes.FactionTurn&&this.faction?.controller===s.FactionController.LocalUser}getMovablePawns(){if(this.type!==s.PhaseTypes.FactionTurn)return[];n.assert.defined(this.faction);const e=r.Pawns.model(this.state);return o.CurrentPhase.getMovableUnits(this.state).map((t=>e.byId(t)))}getNextFaction(){const e=o.CurrentPhase.getFaction(this.state)||0,t=a.Factions.model(this.state);for(let i=(e+1)%(d.MAX_FACTIONS_COUNT+1);i!==e;i=(i+1)%(d.MAX_FACTIONS_COUNT+1)){const e=t.byId(i);if(e&&(e.isNeutral()||e.isAlive()))return i}return e}tapPawn(e){this.state=o.CurrentPhase.tapPawn(this.state,e.id)}unTapPawn(e){this.state=o.CurrentPhase.unTapPawn(this.state,e.id)}set(e){this.state=o.CurrentPhase.set(this.state,e)}is(e){return this.type===e}incrementTurnNumber(){this.set({turnNumber:this.turnNumber+1})}}t.CurrentPhaseModel=h},62992:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionBorderHexesProjection=void 0;const s=i(83874),n=i(56038),o=i(20026),a=i(45664),r=i(20693),l=i(81434),c=i(63521);class d extends s.MultiMapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources)}bootstrap(e){return(0,o.selectFromState)(e,this.sources.regionsEdgeHexes).map(((t,i)=>t.filter((t=>h(e,t,i))))).filter((e=>e.size>0))}update(e,t,i){const o=new s.MultiMapMutationBuilder(this,e);return t.of(this.sources.regionsEdgeHexes)?.updated?.forEach((t=>{const i=t.id;if(t.added){const s=(0,a.getHexes)(t.added);(0,a.getHexes)(o.getCurrent(i).toArray()||[]),o.add(i,...t.added.filter((t=>h(e,t,i)))),s.forEach((t=>{t.neighbours((t=>void 0!==n.Regions.getByHex(e,t.id))).forEach((t=>{const s=n.Regions.getByHex(e,t.id);void 0!==s&&s!==i?o.add(s,t.id):h(e,t.id,i)||o.remove(i,t.id)}))}))}if(t.removed){o.remove(i,...t.removed);const s=(0,a.getHexes)(t.removed),l=r.HexGroup.fromIds(n.Regions.getRegionEdgeHexes(e,i).toArray());s.forEach((t=>{l.neighboursOf(t).forEach((t=>{n.Regions.getByHex(e,t.id)===i&&h(e,t.id,i)&&o.add(i,t.id)}))}))}})),o.createMutation("regionBorderChanged")}entryToString(e){return`[${e.size}]`}}function h(e,t,i){return!!(0,a.getHex)(t).findNeighbour((t=>{const s=n.Regions.getByHex(e,t.id);return void 0!==s&&s!==i&&!l.Pawns.model(e).findOne({hexes:t,traits:[c.PawnTraits.Impenetrable]})}))}t.RegionBorderHexesProjection=d},62993:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LazyIslandPreview=void 0;const s=i(48063),n=i(18957),o=i(66143),a=i(96704),r=i(54429),l=i(56824).logger.for("LazyIslandPreview");t.LazyIslandPreview=class{constructor(e,t,i){this.scene=e,this.engine=t,this.props=i,this.dirty=!1,this.onClicked=(0,n.signal)(),this.updateBoundingBox()}destroy(){this.preview?.destroy(),this.preview=void 0}updateBoundingBox(){const{x:e,y:t,w:i,h:n}=this._getShape();this.boundingBox=new Phaser.Geom.Rectangle(e*s.PREVIEW_HEX_WIDTH,t*s.PREVIEW_HEX_INNER_HEIGHT,i*s.PREVIEW_HEX_WIDTH,n*s.PREVIEW_HEX_INNER_HEIGHT)}_getShape(){return{x:this.props.levelInfo.shape.x,y:this.props.levelInfo.shape.y,w:this.props.manifest.width,h:this.props.manifest.height}}getBoundingBox(){return this.boundingBox}getLinkAnchorPoint(){const{x:e,y:t,w:i,h:s}=this._getShape();return this._toDisplayCoords({x:e+i/2,y:t+s/2})}getDisplayTopLeft(){return this._toDisplayCoords(this.props.levelInfo.shape)}_toDisplayCoords({x:e,y:t}){return{x:e*s.PREVIEW_HEX_WIDTH,y:t*s.PREVIEW_HEX_INNER_HEIGHT}}setProps(e){void 0!==e.selected&&e.selected!==this.props.selected&&this.preview?.setSelected(e.selected),this.props.alwaysShowStartingState!==e.alwaysShowStartingState&&(this.dirty=!0),this.props={...this.props,...e}}async refresh(e=!1){if(!this.preview)return;const t=o.LevelModel.for(this.props.levelInfo.id),i=t.getLevelStatus();if(e||this.dirty||i!==this.preview.props.levelStatus||t.isInProgress()){if(this.engine.deserialize((0,a.decompressGameState)(await t.getCurrentState())),!this.preview)return void l.warning(`Preview of island ${this.props.levelInfo.id} unloaded while refreshing`);this.preview.setProps({levelStatus:i,gameState:this.engine.currentState,showGameState:t.isUnlocked()&&(this.props.alwaysShowStartingState||!t.isCompleted()),selected:this.preview.props.selected},e),this.dirty=!1}}async show(){if(this.preview)return void(this.dirty&&this.refresh());const e=this.props.levelInfo.id,t=o.LevelModel.for(e),i=await t.getCurrentState();this.engine.deserialize((0,a.decompressGameState)(i)),this.preview=new s.OverworldIslandPreview(this.scene,{gameState:this.engine.currentState,levelStatus:t.getLevelStatus(),selected:this.props.selected,showGameState:this.props.alwaysShowStartingState||t.isUnlocked()&&!t.isCompleted()}),this.preview.setDepth(r.OverworldMapLayers.Islands),this.preview.onClicked((e=>{this.onClicked.fire()})),this.scene.add.existing(this.preview),this.preview.visibility.transitionTo(1),this.updatePosition()}updatePosition(){if(!this.preview)return;this.updateBoundingBox();const{x:e,y:t}=this.getDisplayTopLeft();this.preview.setPosition(e,t)}}},63032:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalDialogContentLayout=t.DialogButtonRole=void 0;const s=i(21941),n=i(22640),o=i(86545),a=i(29821),r=i(9292);var l;!function(e){e[e.Regular=0]="Regular",e[e.PrimaryGreen=1]="PrimaryGreen",e[e.PrimaryDanger=2]="PrimaryDanger"}(l||(t.DialogButtonRole=l={}));const c=16;class d extends o.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.contentBox=new s.Box(e,s.BoxTextures.InnerPlate),this.content=t.content,this.buttonGroup=new n.DialogButtonGroup(e,{buttons:t.buttons,onClicked:t.onClicked}),this.add([this.contentBox,this.content,this.buttonGroup])}updateLayout(){this.content.width+32>this.width&&(this.content.width=this.width-32),this.content.setPosition(c,c),this.contentBox.setSize(this.width,this.content.height+32+this.buttonGroup.height/2),this.buttonGroup.updateLayout(),this.buttonGroup.setPosition(this.width/2-this.buttonGroup.width/2,this.contentBox.y+this.contentBox.height-this.buttonGroup.height/2),this.updateSize()}calculateHeight(){return this.contentBox.height+this.buttonGroup.height/2}setMaxWidth(e){this.width=(0,r.pickSmaller)(e,this.content.width+32),this.content instanceof a.Label&&this.content.setMaxWidth(e)}setContent(e){this.content!==e&&(this.content&&(this.remove(this.content),this.content.destroy()),this.content=e,this.add(this.content),this.preUpdate.makeDirty())}}t.ModalDialogContentLayout=d},63077:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexPawnTraitsView=void 0;const s=i(90952),n=i(20754),o=i(76439),a=i(12543),r=i(81434),l=i(19162);class c extends n.LazyView{constructor(){super([s.GameState.pawns.byHex]),this.name="hexPawnTraitsView"}calculate(e,t){const i={};return r.Pawns.getByHex(e,t).forEach((t=>{const s=r.Pawns.getPawnType(e,t),n=l.Rules.getPawnRules(e,s);for(const e of n.traits??[])i[e]=!0})),i}getCacheKey(e){return e}getDebugLayer(){return new o.GameStateDebugLayer((0,a.hexBasedAdapter)({getValue:(e,t)=>Object.keys(this.get(e,t)).sort().map((e=>e[0])).join(""),getDetail:(e,t)=>Object.keys(this.get(e,t)).sort().join("\n")}))}}t.HexPawnTraitsView=c},63277:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OptionsGroupButtonController=void 0;const s=i(39970),n=i(18957),o=i(1326);t.OptionsGroupButtonController=class{constructor(e,t){this.buttons=e,this.onButtonClicked=(0,n.signal)(),this.buttonControllers=(0,o.mapDictionary)(e,((e,t)=>{const i=new s.PassiveButtonStateController;return e.setController(i),i.onClicked((e=>this.onButtonClicked.fire({key:t,pointer:e}))),i}))}selectButton(e){for(let[t,i]of Object.entries(this.buttonControllers))i.setSelected(t===e)}}},63303:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScriptModulesRegistry=void 0;const s=i(29454);t.ScriptModulesRegistry=class{constructor(){this.moduleCache={}}getScript(e){const t=e.split("."),i=this.getModule(t[0]);if(1===t.length)return i.main;{const e=i[t[1]];if(!e)throw Error(`script "${t[1]}" not found in module ${i.name}`);return e}}getModule(e){if(!this.moduleCache[e]){const t=s.ScriptModules[e];if(!t)throw Error(`level scripts module "${e}" not found`);this.moduleCache[e]=t(),this.moduleCache[e].name=e}return this.moduleCache[e]}}},63460:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomMapSelectToTileTransition=async function(){const e=n.app.scene.titleScreenUI,t=o.config.screenTransitionDuration;e.scene.setVisible(!1),await(0,s.titleInTransition)({keepBackgroundPanel:!0,duration:t/2})};const s=i(33226),n=i(54825),o=i(56824)},63521:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.PawnTraits=void 0,function(e){e.ZombieResistant="zombie-resistant",e.NegatesTileIncome="negates-tile-income",e.PreventsBuilding="prevent-building",e.Unit="unit",e.HeavyUnit="heavy-unit",e.Loyal="loyal",e.Impenetrable="impenetrable",e.Building="building",e.Pest="pest",e.Elusive="elusive",e.Treasure="treasure",e.GuardsAdjacentTiles="protects-adjacent",e.OccupiesTile="occupies-tile",e.Terrain="terrain",e.PreventsWalls="prevents-walls",e.PreventsHeavyUnits="prevents-heavy-units",e.AttractsBandits="attracts-bandits",e.Undead="undead"}(i||(t.PawnTraits=i={}))},63579:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TurnNavigationPanel=t.LargeSpectatorPanel=t.ExpandedState=void 0;const s=i(21941),n=i(42067),o=i(27700),a=i(40904),r=i(99134),l=i(7782),c=i(26502),d=i(36868),h=i(22663),u=i(76049),p=i(86545),g=i(91622),m=i(56824),y=i(16007);var f=Phaser.GameObjects.Image,w=Phaser.GameObjects.BitmapText,v=Phaser.GameObjects.Container;const b=n.LARGE_PLAY_UI_LAYOUT;var S;!function(e){e.Hidden="hidden",e.Collapsed="collapsed",e.Expanded="expanded"}(S||(t.ExpandedState=S={}));const x={[S.Expanded]:b.spectatorPanel.expandedOffsetFromBottom,[S.Collapsed]:b.spectatorPanel.collapsedOffsetFromBottom,[S.Hidden]:0};class T extends p.ResponsiveContainer{constructor(e){super(e),this.expandedState=S.Collapsed,this.mode=o.PlayUIMode.Standby,this.smallTurnNavigator=new P(this.scene),this.statusIcon=new f(this.scene,0,0,"atlas","ui/hourglass"),this.sizeController=l.Control.propOf(this,"y",{duration:b.panelTransitionsDuration}),this.spectatingMessage="Waiting for rivals...",this.powerBalanceRibbon=new a.PowerBalanceRibbon(this.scene,{x:b.spectatorPanel.padding,y:b.spectatorPanel.padding,width:b.spectatorPanel.width-2*b.spectatorPanel.padding,minSize:24}),this.box=new s.Box(e,s.BoxTextures.RoundedPlate,0,0,b.spectatorPanel.width,b.spectatorPanel.height),this.statusMessage=new w(this.scene,0,0,u.BitmapFont.Main,"").setTint(5583648),this.playSpeedButtons=new r.MiniButtonsRow(this.scene,["ui/mini-icons/pause","ui/mini-icons/play","ui/mini-icons/fast-forward","ui/mini-icons/super-fast-forward"],3289650),this.downloadButton=new c.ImageButtonWithContent(this.scene,0,0,{frame:"ui/mini-buttons/standalone",content:new f(this.scene,0,0,"atlas","ui/mini-icons/download"),down:!0}),this.playSpeedButtonsGroupController=h.ButtonControllers.options({[y.SpectatingPlaybackSpeed.Paused]:this.playSpeedButtons.buttons[0],[y.SpectatingPlaybackSpeed.Normal]:this.playSpeedButtons.buttons[1],[y.SpectatingPlaybackSpeed.Fast]:this.playSpeedButtons.buttons[2],[y.SpectatingPlaybackSpeed.UltraFast]:this.playSpeedButtons.buttons[3]}),this.playSpeedButtonsGroupController.onButtonClicked((({key:e})=>{const t=Number(e);t!==g.inject.ui.spectatingSpeed()?m.events.trigger(d.UserActions.SetSpectatingPlayBackSpeed(t)):t===y.SpectatingPlaybackSpeed.Paused&&m.events.trigger(d.UserActions.SetSpectatingPlayBackSpeed(y.SpectatingPlaybackSpeed.Normal))})),this.updateButtonsPosition(),this.statusMessage.setPosition(b.spectatorPanel.padding+36,b.spectatorPanel.centerLineOffsetFromTop-2),this.statusIcon.setPosition(b.spectatorPanel.padding+10,b.spectatorPanel.centerLineOffsetFromTop),this.smallTurnNavigator.setPosition(b.spectatorPanel.padding,b.spectatorPanel.centerLineOffsetFromTop),this.downloadButton.onClicked((()=>m.events.trigger(d.UserActions.DownloadReplay()))),this.setDepth(o.PlayUILayers.MainPanel),this.add([this.box,this.powerBalanceRibbon,this.playSpeedButtons,this.downloadButton,this.statusMessage,this.statusIcon,this.smallTurnNavigator])}updateButtonsPosition(){this.downloadButton.visible?(this.downloadButton.setPosition(this.box.width-b.spectatorPanel.padding-this.downloadButton.width,b.spectatorPanel.centerLineOffsetFromTop),this.playSpeedButtons.setPosition(this.downloadButton.x-8-this.playSpeedButtons.width,b.spectatorPanel.centerLineOffsetFromTop)):this.playSpeedButtons.setPosition(this.box.width-b.spectatorPanel.padding-this.playSpeedButtons.width,b.spectatorPanel.centerLineOffsetFromTop)}updateState(e){if(e.layout)if("spectate"===e.layout.name){this.setExpandedState(S.Expanded),this.playSpeedButtons.setVisible(!0),this.playSpeedButtonsGroupController.selectButton(e.layout.spectatingSpeed.toString()),this.statusMessage.setText(e.layout.spectatingSpeed===y.SpectatingPlaybackSpeed.Paused?"< PAUSED >":this.spectatingMessage),this.smallTurnNavigator.setTurnNumber(e.layout.spectatingTurnNumber),this.downloadButton.setVisible(e.layout.enableDownloadReplay),this.updateButtonsPosition();const t=e.layout.spectatingContext===o.SpectatingContext.ReplayOnly||e.layout.spectatingContext===o.SpectatingContext.LiveReplay;this.statusMessage.setVisible(!t),this.statusIcon.setVisible(!t),this.smallTurnNavigator.setVisible(t),this.updateButtonsPosition()}else"rewind"===e.layout.name?this.setExpandedState(S.Hidden):this.setExpandedState(S.Collapsed);e.turnNumber&&this.smallTurnNavigator.setTotalTurns(e.turnNumber),e.powerBalance&&this.powerBalanceRibbon.updateState(e.powerBalance)}setExpandedState(e){this.expandedState=e;const t=this.scene.bounds.height-x[e];this.sizeController.transitionTo(t)}updateLayout(){const e=this.scene.bounds.width,t=this.scene.bounds.height;let i=0;switch(this.expandedState){case S.Hidden:i=t;break;case S.Collapsed:i=t-b.spectatorPanel.collapsedOffsetFromBottom;break;case S.Expanded:i=t-b.spectatorPanel.expandedOffsetFromBottom}this.setPosition(e/2-b.spectatorPanel.width/2,i),this.sizeController.setTo(i)}getTooltipFor(e){if(e===this.downloadButton.buttonSprite)return{title:"Download the replay.",description:"Once you download a replay, you can restore it by simply dragging and dropping the replay file into the game."}}}t.LargeSpectatorPanel=T;class P extends v{constructor(e){super(e),this._turnNumber=0,this._totalTurns=0,this.playSpeedButtons=new r.MiniButtonsRow(this.scene,["ui/mini-icons/skip-to-start","ui/mini-icons/prev-turn","display","ui/mini-icons/next-turn","ui/mini-icons/skip-to-end"]),this.add([this.playSpeedButtons]),this.playSpeedButtons.buttons[0].setController(h.ButtonControllers.triggerEvent((()=>d.UserActions.GoToStart()))),this.playSpeedButtons.buttons[1].setController(h.ButtonControllers.triggerEvent((()=>d.UserActions.GoToPreviousTurn()))),this.playSpeedButtons.buttons[2].setController(h.ButtonControllers.triggerEvent((()=>d.UserActions.GoToNextTurn()))),this.playSpeedButtons.buttons[3].setController(h.ButtonControllers.triggerEvent((()=>d.UserActions.GoToEnd())))}setTurnNumber(e){this._turnNumber=e,this.refreshLabel()}setTotalTurns(e){this._totalTurns=e,this.refreshLabel()}refreshLabel(){this.playSpeedButtons.setText(`turn ${this._turnNumber}/${this._totalTurns}`)}}t.TurnNavigationPanel=P},63586:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayScene=void 0;const s=i(81700),n=i(56824),o=i(20518),a=i(71021),r=i(5833),l=i(91622),c=i(54825),d=i(54330),h=i(76314),u=i(45664),p=i(75131),g=i(36868);n.logger.for("PlayScene");class m extends o.BaseScene{constructor(){super({key:s.Scenes.Play}),this.inputEventsBuffer=new d.AsyncBuffer,this.mode=new r.PassiveMode(this)}setMode(e){this.mode.deactivate(),this.mode=e,l.inject.debugData.set("playScene.mode",this.mode.name),e.activate(),e.handleNewHexUnderCursor(l.inject.ui.hexUnderCursor())}create(){super.create(),this.gameEventQueue=l.inject.gameStateController.getEventQueue(),this.events.on("destroy",(()=>{this.gameEventQueue.unsubscribe()})),this.worldMapScene=this.scene.get(s.Scenes.WorldMap),this.debugScene=this.scene.get(s.Scenes.Debug),this.uiScene=this.scene.get(s.Scenes.PlayUI),this.resetCursor()}async afterEventsProcessed(e){return this.gameEventQueue.hasNext()?await this.inputEventsBuffer.schedule("input",e):e()}resetCursor(){this.cursor=l.inject.gameStateController.history.getCursor()}skipToCurrentState(e=a.NewGameStateContext.ResumingGame){this.gameEventQueue.clear();const t=l.inject.gameStateModel.state;(0,p.handleNewGameState)(c.app.scene.play,t,e),this.resetCursor()}update(e,t){l.inject.debugData.set("EVENT QUEUE",this.gameEventQueue.pendingEvents.map((e=>(0,g.describeEvent)(e))).join("\n"));const i=[];for(;this.gameEventQueue.hasNext()&&this.mode.isReadyForMoreGameEvents();){const e=this.gameEventQueue.next();i.push(e),n.events.trigger(e)}i.length&&(this.mode.handleNewGameEventsAvailable().then((()=>{this.gameEventQueue.hasNext()||this.inputEventsBuffer.flush()})),c.app.scene.worldMap.runIntegrityChecks()),l.inject.debugData.set("playScene.mode",`${this.mode.name} (${this.mode.isReadyForMoreGameEvents()?"ready":"processing event"})`)}async dropHeldPawnAtHex({hexId:e,willBeMovable:t}){const i=this.worldMapScene.getPawnObjectPositionOnScreen(e);return t&&(i.y-=h.PAWN_JUMPING_HEIGHT),new Promise((t=>{this.uiScene.pawnHolder.dropPawn(i.x,i.y,i.scale,(()=>{const i=c.app.scene.worldMap.pawns.getByHex(e);i&&(i.setVisible(!0),i.clearHighlight(),c.app.scene.worldMap.overlays.pawnBacklight.remove((0,u.getHex)(e))),t()}))}))}}t.PlayScene=m},63617:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MEMORY_MARKER=void 0,t.getObjId=function(e){return"function"!=typeof e.getData?"?":e.getData("id")??"?"},t.assignObjId=function(e){return e.setData("id",n++),n-1},t.debugMethodCalls=function(e,t,i){(0,s.assert)("function"==typeof e[t]);const n=e[t].bind(e);e[t]=(...s)=>(i?i(...s):console.warn(`${e.constructor.name}.${String(t)} called with`,...s),n(...s))};const s=i(97849);let n=1;t.MEMORY_MARKER=class{constructor(){this.stuff=Array(200).fill(0).map((()=>Math.random()))}}},63638:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapOverlaysManager=void 0;const s=i(15686),n=i(82407),o=i(69387),a=i(30650),r=i(58131),l=i(77165),c=i(59811),d=i(56824),h=i(61271),u=i(78113),p=i(18051),g=i(77800);d.logger.for("WorldMapOverlays"),t.WorldMapOverlaysManager=class{constructor(e){this.scene=e,this.mode=new h.DisabledOverlayMode,this.selectedRegionHighlight=new s.SelectedRegionHighlight(this.scene.chunkedRenderer),this.conquerableHexesHighlight=new n.ConquerableHexesHighlight(this.scene,this.scene.objectsPool),this.pawnSymbols=new o.PawnSymbolsManager(this.scene.pawns),this.attitudeEmojis=new a.AttitudeEmojiManager(this.scene,this.scene.objectsPool,this.scene.tileObjects),this.hexMarkers=new r.HexDefenseMarkers(this.scene),this.townStatusFlags=new l.TownStatusFlagsManager(this.scene.chunkedRenderer,this.scene.objectsPool,this.scene.tileObjects),this.pawnBacklight=new c.PawnBacklightManager(this.scene.chunkedRenderer,this.scene.tileObjects,this.scene.pawns),this.regionSummaryPopup=new u.RegionSummaryPopup(this.scene),this.newsAlerts=new p.HexAlerts(this.scene),this.budgetLabels=new g.BudgetLabelsManager(this.scene.chunkedRenderer,this.scene.tileObjects),this.scene.add.existing(this.regionSummaryPopup)}set(e,t){this.mode=t,this.mode.update(this,e)}update(e){this.mode.update(this,e)}}},63723:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NearestCampUpdater=t.NearestCampByHexProjection=t.UNREACHABLE=void 0;const n=i(31011),o=i(56824),a=i(4005),r=i(56038),l=i(45664),c=i(77330),d=s(i(65731)),h=i(7334),u=i(20693),p=i(97849),g=i(19506),m=i(88023);o.logger.for("NearestCampByHexProjection"),t.UNREACHABLE=Object.freeze({rootId:0,distance:Number.POSITIVE_INFINITY});class y extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new f(this).update}bootstrap(e){const t=new f(this);return t.initFromState(e),r.Regions.getAll(e).filter((t=>r.Regions.model(e).byId(t)?.faction?.isNeutral())).forEach((e=>{t.addRootsFromRegion(e)})),t.getMap()}entryToString(e){return 0===e.distance?g.GLYPH.whiteFlag:e.rootId}entryToDebugString(e){return(0,h.prettyPrintObject)(e)}}t.NearestCampByHexProjection=y;class f extends a.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.sources=new Set,this}registerHandlers(e){e(this.dataSet.sources.campsByRegion,this.handleCampsByRegionChange)}handleCampsByRegionChange(e){e.updated?.forEach((e=>{e.added?.forEach((e=>{this.addNewRoot((0,l.getHex)(e))})),e.removed?.forEach((e=>{this.invalidateFrom((0,l.getHex)(e))}))}))}addRootsFromRegion(e){const t=r.Regions.model(this.newState).byId(e);t&&t.faction?.isNeutral()&&c.Bandits.getCampsByRegion(this.newState,e).forEach((e=>this.addNewRoot((0,l.getHex)(e))))}updateInvalidated(){this.addSourcesFromInvalidatedHexes();const e=new d.default(((e,t)=>e.distance-t.distance));for(this.sources.forEach((t=>{const i=this.builder.getCurrent(t.id);p.assert.defined(i),e.push({hex:t,rootHex:(0,l.getHex)(i.rootId),distance:i?.distance})}));!e.empty();){const t=e.pop(),i=t.hex;this.getCurrentDistanceFrom(i)<=t.distance||(this.invalidatedHexes.delete(i),this.builder.set(i.id,{distance:t.distance,rootId:t.rootHex.id}),i.neighbours((e=>void 0!==r.Regions.getByHex(this.newState,e.id)&&this.getCurrentDistanceFrom(e)>=t.distance+1)).forEach((i=>{e.push({hex:i,rootHex:t.rootHex,distance:t.distance+1})})))}this.invalidatedHexes.forEach((e=>this.builder.delete(e.id)))}addSourcesFromInvalidatedHexes(){u.HexGroup.from(Array.from(this.invalidatedHexes)).neighbours().filter((e=>this.getCurrentDistanceFrom(e)<Number.POSITIVE_INFINITY)).forEach((e=>{this.sources.add(e),this.invalidatedHexes.add(e)}))}getMap(){return this.updateInvalidated(),(0,m.ImmutableMap)(this.builder.getEntries()).mapKeys((e=>Number(e)))}createMutation(){return this.updateInvalidated(),super.createMutation()}invalidateFrom(e){if(this.invalidatedHexes.has(e))return;this.invalidatedHexes.add(e);const i=this.builder.getCurrent(e.id);i&&e.neighbours((e=>{const s=this.builder.getCurrent(e.id)??t.UNREACHABLE;return i.rootId==s.rootId&&s.distance===i.distance+1})).forEach((e=>this.invalidateFrom(e)))}getCurrentDistanceFrom(e){return this.invalidatedHexes.has(e)?Number.POSITIVE_INFINITY:this.builder.getCurrent(e.id)?.distance??Number.POSITIVE_INFINITY}addNewRoot(e){this.sources.add(e),this.builder.set(e.id,{rootId:e.id,distance:0}),this.invalidatedHexes.add(e)}}t.NearestCampUpdater=f},63853:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.captureHex=function(e,t,i,p,g){const w=new c.WorldUpdateBuilder(e),v=e.state;r.assert.defined(t);const b=e.regions.byHex(t);r.assert.defined(b),r.assert.defined(i);const S=b.faction;let x;const T=p instanceof n.PawnModel?p.hex:void 0,P=b.isAlive(),I=b.isBankrupt();return e.stateEngine.transaction((()=>{const r=function(){const i=e.pawns.findOne({hexes:t,traits:[o.PawnTraits.OccupiesTile]});if(!i)return;const s=e.plugins.has(m.PluginKey.AlwaysRetreat);if(!(i.hasTrait(o.PawnTraits.Elusive)||i.hasTrait(o.PawnTraits.Unit)&&(s||e.warfare.getHexStaticDefense(t)>0)))return{pawnId:i.id};const n=s?y.AlwaysRetreatPlugin.getRetreatDestination(i,T):e.warfare.getRetreatDestination(i,T);return n?{pawnId:i.id,retreatHex:n.id}:{pawnId:i.id}}(),c=r&&!r.retreatHex?[e.pawns.byId(r.pawnId).type]:[];let C;if(p instanceof n.PawnModel)C=w.move({pawnId:p.id,destHex:t,defeatedUnit:r,captureHex:!0,tapUnit:g}).hexCaptured,e.stateEngine.commitTransaction();else{x=e.economy.payForNewPawn(t,i,p),w.addCoinTransaction(x),e.stateEngine.commitTransaction();const s=w.create({type:p,hex:t,defeatedUnit:r,sourceHex:f(w,t,i,p),regionId:i.id,captureHex:!0,tapUnit:g});C=s.hexCaptured,e.stateEngine.commitTransaction(),p=e.pawns.byId(s.pawns[0].pawnId)}!function(i,s,n){b?.faction?.persona.race===u.Race.Undead&&(n.includes(a.PawnType.Town)||n.includes(a.PawnType.DreadKnight)||s.length>0)&&[b.id,...s].map((s=>{!function(e,t,i){if(!t)return;let s=t.getPawns().filter((e=>e.type===a.PawnType.DreadKnight)).length,n=t.getTownHexes().filter((t=>e.model.pawns.getCount(t,a.PawnType.Mana)>6)).length;const o=d.HexGroup.union([t.hexes,i]);for(;n<s;){const t=o.findClosest(i,(t=>e.model.pawns.presentAtHex(t,a.PawnType.DreadKnight)));e.replace(e.model.pawns.byHex(t,a.PawnType.DreadKnight),a.PawnType.Zombie),s--}for(;n>s;){const t=o.findClosest(i,(t=>e.model.pawns.getCount(t,a.PawnType.Mana)>6));e.adjustMana(t,-7),n--}}(i,e.regions.byId(s),t)})),i.model.plugins.has(m.PluginKey.CaptureTowns)&&n.includes(a.PawnType.Town)&&i.spawn(t,a.PawnType.TownRuins)}(w,C.splitOffRegions,c);const M=w.getUpdates(),A=h.inject.ai.dataLayer.onHexCaptured({model:e,hex:t,stateBeforeAttack:v,attackerFaction:i.faction,destroyedPawns:c,victimRegions:[b,...C.splitOffRegions.map((t=>e.regions.byId(t)))],regionWasAlive:P,regionWasBankrupt:I});M.stateAfter=e.state;const B=[...A,s.GameStateEvents.HexCaptured({capturedHexId:t.id,capturingPawnId:p.id,capturingPawnType:p.type,capturingRegionId:i.id,capturingFactionId:i.faction.id,boughtPawnTransactions:x,newRegionId:i.id,victimRegionId:b.id,victimFactionId:S?.id,originatingHexId:T?.id,defeatedUnit:r,worldUpdates:M})];return B.push(...(0,l.checkWinLoseConditions)(e,B)),B}))},t.getBuyPawnSourceHex=f;const s=i(36868),n=i(10326),o=i(63521),a=i(24598),r=i(97849),l=i(46471),c=i(78933),d=i(20693),h=i(91622),u=i(90824),p=i(52307),g=i(1326),m=i(18497),y=i(29191);function f(e,t,i,s){const n=e.model;let o=n.economy.nearestTownHexFrom(t);if(s===a.PawnType.DreadKnight){if(o=(0,p.getClosestTownThatCanBuyDreadKnight)(i,t),!o)throw new Error(`Failed to buy ${s} in region #${i.id} - no suitable town found.`);return e.adjustMana(o,1),o}if(n.regions.byHex(t)?.id===i.id)return n.economy.nearestTownHexFrom(t);{const e=(0,g.findMin)(t.neighbours().filter((e=>n.regions.byHex(e)?.id===i.id)).toArray(),(e=>n.economy.nearestTownDistanceFrom(e)));if(!e)throw new Error(`Failed to buy ${s} in region #${i.id} - no suitable town found.`);return n.economy.nearestTownHexFrom(e)}}},64155:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildGeneratorConfig=function(e){const t=(0,o.stringToHash)(e.name);return{seed:t,land:(0,n.buildLandGenerationConfig)({...e,seed:t}),regions:(0,s.buildRegionsGenerationConfig)({...e,seed:t}),generateRegions:!0,regionsVariation:e.regionsVariation??1,spawnTowns:!0,zombify:e.mode===a.MapMode.Zombies,spawnChristmasTree:e.mode===a.MapMode.Christmas,spawnRuins:e.mode===a.MapMode.Occupation,firstLanding:e.mode===a.MapMode.KingsLanding?{startingCoins:r(e)}:void 0}},t.getFirstLandingStartingCoins=r;const s=i(53597),n=i(22411),o=i(8358),a=i(85072);function r(e){switch(e.difficulty){case a.MapDifficulty.Casual:return 50;case a.MapDifficulty.Normal:case a.MapDifficulty.Challenging:return 30;case a.MapDifficulty.Unfair:return 20}}},64244:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MovingPawnMode=void 0,t.updateHighlightWhileMovingPawn=T;const s=i(10326),n=i(36868),o=i(79694),a=i(41569),r=i(56824),l=i(78635),c=i(63521),d=i(20693),h=i(98963),u=i(97849),p=i(50105),g=i(76314),m=i(96137),y=i(91622),f=i(54825),w=i(12933),v=i(30484),b=i(19693),S=r.logger.for("MovingPawnMode");class x extends a.BaseMode{constructor(e,t,i){super(e),this.movingPawn=t,this.wasTouch=i,this.name="MovingPawn",this.isDraggingPawn=!0,this.isTouchMode=!1}activate(){f.app.scene.worldMap.cameraController.stopDragScroll(),this.originHex=this.movingPawn.hex,this.session=f.app.scene.worldMap.session(),this.wasTouch||this.initPawnHolder(),f.app.scene.worldMap.overlays.set(y.inject.currentGameState,v.OverlayModes.playing({holdingPawnType:this.movingPawn.type,selectedPawnId:this.movingPawn.id,selectedRegionId:this.movingPawn.region.id})),T(this.scene,this.movingPawn.hex,this.movingPawn,this.movingPawn.region),f.app.tooltips.close()}deactivate(){super.deactivate(),f.app.scene.playUI.updateHeldPawnData(null),f.app.scene.worldMap.pawns.getById(this.movingPawn.id)?.clearHighlight(),f.app.scene.worldMap.overlays.hexMarkers.clearHoveredHex(),this.scene.uiScene.pawnHolder.clear()}canDropPawn(e){return!0}handleReturnPawn(){const e=this.movingPawn;u.assert.defined(e),this.dropPawnAt(e.hex.id,!0).then((()=>{this.scene.mode!==this&&this.scene.mode instanceof x&&this.scene.mode.movingPawn.id===e.id||(f.app.scene.worldMap.pawns.show(e.id),f.app.scene.worldMap.pawns.clearHangingPawn())})),this.scene.setMode(new o.PlayMode(this.scene))}isHexInteractive(e){return!0}handleStartInteraction(e){this.isDraggingPawn||f.app.scene.worldMap.cameraController.startDragScroll()}handleCompleteInteraction(e,t){this.isDraggingPawn?t&n.PointerEventFlags.Touch&&(this.isTouchMode=!0,this.highlightMovingPawn()):(f.app.scene.worldMap.cameraController.stopDragScroll(),this.tryMovePawnTo(e)),this.isDraggingPawn=!1}highlightMovingPawn(){f.app.scene.worldMap.pawns.show(this.movingPawn.id),f.app.scene.worldMap.overlays.pawnBacklight.set(this.movingPawn.hex,{color:m.Colors.highlight.ownedRegion,width:20}),f.app.scene.playUI.pawnHolder.heldPawnImage?.setVisible(!1),f.app.scene.worldMap.pawns.getById(this.movingPawn.id)?.setHighlight(g.Highlight.SelectedForMove)}handleEndDrag(e){this.isDraggingPawn?this.tryMovePawnTo(e)||r.events.trigger(n.UserActions.ReturnHeldPawn()):f.app.scene.worldMap.cameraController.stopDragScroll()}handleStartDrag(e){this.isDraggingPawn?this.wasTouch&&this.initPawnHolder():f.app.scene.worldMap.cameraController.startDragScroll()}initPawnHolder(){if(f.app.scene.playUI.activeUI.pawnHolder.heldPawn)return;const e=f.app.scene.worldMap.getPawnObjectPositionOnScreen(this.originHex.id);f.app.scene.playUI.activeUI.pawnHolder.pickUpPawn(this.movingPawn.type,e.x,e.y,e.scale,(0,b.getPawnVariant)(y.inject.currentGameState,this.movingPawn)),f.app.scene.worldMap.pawns.hide(this.movingPawn.id)}tryMovePawnTo(e){const t=this.movingPawn,i=this.movingPawn.region;if(u.assert.defined(t),u.assert.defined(i),!e)return!1;if(t.hex===e)return r.events.trigger(n.UserActions.ReturnHeldPawn()),!0;{const s=y.inject.gameStateModel.warfare.getDropPawnResult(e,this.movingPawn.type,i);switch(s.type){case l.DropPawnResultType.Reposition:case l.DropPawnResultType.EradicatePest:case l.DropPawnResultType.Combine:case l.DropPawnResultType.Conquest:return this.dropPawnAt(e.id,s.type===l.DropPawnResultType.Reposition),y.inject.gameStateController.executePlay(n.Plays.MovePawn({pawnId:t.id,destinationHexId:e.id,tapUnit:!1})),this.scene.setMode(new o.PlayMode(this.scene)),f.app.audio.playEffect(h.SoundEffects.Drop),!0;case l.DropPawnResultType.Invalid:return f.app.audio.playEffect(h.SoundEffects.Deny),s.reason===l.InvalidDropPawnReason.PreventedByPawn&&(f.app.scene.worldMap.pawns.transitions.defendTile(e,s.blockers),f.app.notifications.movePreventedByPawn(this.movingPawn.type,s.blockers),f.app.tooltips.showDefenderTaunt(e,this.movingPawn.type,s.blockers[0])),!1}}}async dropPawnAt(e,t){await this.scene.dropHeldPawnAtHex({hexId:e,willBeMovable:t})}async handleHexCaptured(e){this.movingPawn.id===e.capturingPawnId?(this.dropPawnAt(e.capturedHexId,!1),u.assert.defined(e.originatingHexId),(0,p.handleHexCaptured)(this.scene,e),this.scene.setMode(new o.PlayMode(this.scene))):S.warning(`ignoring hexCaptured as the capturing pawn ${e.capturingPawnId} doesn't match the currently held pawn ${this.movingPawn}`)}handlePawnInShopPointerUp(e){const t=y.inject.gameStateModel,i=t.rules.pawns(this.movingPawn.type).mergeRules[e];let s=this.movingPawn.hex;if(f.app.scene.worldMap.pointersTracker.clear(),i){f.app.scene.worldMap.overlays.set(y.inject.currentGameState,v.OverlayModes.playing({holdingPawnType:i,selectedRegionId:f.app.screen.play.selectedRegion.id}));const o=t.warfare.getNearestSuitableHexAfterMerge(this.movingPawn,t.rules.pawns(i));if(!o)return f.app.audio.playEffect(h.SoundEffects.Deny),void(this.isDraggingPawn&&r.events.trigger(n.UserActions.ReturnHeldPawn()));o!==s&&(s=o,y.inject.gameStateController.executePlay(n.Plays.MovePawn({pawnId:this.movingPawn.id,destinationHexId:s.id,tapUnit:!1}))),f.app.audio.playEffect(h.SoundEffects.Drop),this.scene.uiScene.pawnHolder.setPawnType(i),this.isDraggingPawn=!1,y.inject.gameStateController.executePlay(n.Plays.BuyPawn({pawnType:e,buyerRegionId:this.movingPawn.region.id,destinationHexId:s.id,tapUnit:!1})),this.movingPawn=t.warfare.getOccupyingUnit(s)}else f.app.audio.playEffect(h.SoundEffects.Deny),this.isDraggingPawn&&r.events.trigger(n.UserActions.ReturnHeldPawn())}async handlePawnBought(e){y.inject.ui.withoutTransitions((async()=>{await super.handlePawnBought(e)})),f.app.device.isUsingTouch()?this.highlightMovingPawn():f.app.scene.worldMap.pawns.hide(this.movingPawn.id),f.app.scene.playUI.updateHeldPawnData({context:"moving",cost:0,upkeep:0,name:this.movingPawn.type})}handleNewHexUnderCursor(e){this.session.isActive()&&(T(this.scene,e,this.movingPawn,this.movingPawn.region),this.wasTouch&&this.isDraggingPawn&&e&&e!==this.originHex&&this.initPawnHolder())}handleAbort(){r.events.trigger(n.UserActions.ReturnHeldPawn())}canReturnPawn(){return!0}doHandleEvent(e){return(0,w.doHandleEvent)(this,e)}}function T(e,t,i,n){if(!t)return void e.worldMapScene.overlays.hexMarkers.clearHoveredHex();let o,a;t&&f.app.scene.worldMap.overlays.conquerableHexesHighlight.has(t.id)?(e.worldMapScene.overlays.conquerableHexesHighlight.setHighlightedHex(t,void 0,1),e.worldMapScene.overlays.attitudeEmojis.setFocusedHex(t)):(e.worldMapScene.overlays.conquerableHexesHighlight.clearHighlightedHex(),e.worldMapScene.overlays.attitudeEmojis.setFocusedHex(void 0)),i instanceof s.PawnModel?(o=i,a=o.type):a=i;const r=y.inject.gameStateModel;u.assert.defined(n);const h=r.warfare.getDropPawnResult(t,a,n),p=r.rules.pawns(a).hasTrait(c.PawnTraits.GuardsAdjacentTiles),g=r.rules.pawns(a).hasTrait(c.PawnTraits.Building);let m=d.HexGroup.empty;p&&(m=n.hexes.neighboursOf(t).filter((e=>!r.warfare.isOccupied(e)&&(!g||l.Warfare.canBeProtectedByWalls(n.state,e.id))||e===o?.hex))),t==o?.hex||h.type===l.DropPawnResultType.Reposition||h.type===l.DropPawnResultType.Conquest?e.worldMapScene.overlays.hexMarkers.setHoveredHex(t,r.rules.pawns(a).defenseMight,m):e.worldMapScene.overlays.hexMarkers.clearHoveredHex()}t.MovingPawnMode=x},64589:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createLevelLinkButton=function(e,t="light",i=h){const s=e.outlineButton({icon:"ui/button-icons/link",theme:t,variant:"circle",tooltip:"Copy link to this island to clipboard.",onClicked:()=>{p(i().id),u(s)}});return s},t.createLevelStatsButton=function(e,t=h){return e.outlineButton({icon:"ui/button-icons/chart",theme:"light",variant:"circle",tooltip:"View statistics for this level.",onClicked:()=>{const e=n.LevelModel.for(s.inject.levelSession.levelId),t=e.userVictoryRecord?.turns,i=e.userVictoryRecord?.difficulty,o=i??s.inject.levelSession.aiDifficulty;window.open(`${d.config.levelStatsBaseUrl}?id=${s.inject.levelSession.levelId}&difficulty=${o}&turns=${t??""}`,"_blank")}})},t.showLevelCopiedConfirmationTooltip=u,t.copyLevelLink=p;const s=i(91622),n=i(66143),o=i(78282),a=i(35300),r=i(51496),l=i(54825),c=i(2297),d=i(56824);function h(){return n.LevelModel.for(s.inject.gameStateModel.map.levelId)}function u(e){l.app.tooltips.showOver(e,{title:"Link to the level copied to clipboard!",type:c.TooltipType.Hover,icon:"ui/icons/ok",delayMs:0,expireAfterMs:1500})}function p(e){if(l.app.scene.randomMapSelect.mapGenerator.isRunning())return;const t=n.LevelModel.for(e).createUrlHash(),i=(0,o.createUrl)(t);(0,a.copyTextToClipboard)(i),r.track.interaction("copy_level_link")}},64648:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexStaticDefenseProjection=void 0;const s=i(31011),n=i(45664),o=i(20026),a=i(56038),r=i(78635),l=i(81834),c=i(9292),d=i(88023);class h extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new l.HexDefenseUpdater(this).update}bootstrap(e){return(0,d.ImmutableMap)().withMutations((t=>{(0,n.getHexes)((0,o.selectFromState)(e,this.sources.regionByHex).keySeq().toArray()).map((i=>{const s=this._calculate(e,i);s>0&&t.set(i.id,s)}))}))}_calculate(e,t){const i=r.Warfare.getHexLocalStaticDefense(e,t.id);return r.Warfare.canBeProtectedByWalls(e,t.id)?a.Regions.getSameRegionNeighbours(e,t).map((t=>r.Warfare.getHexProjectedStaticDefense(e,t.id))).reduce(c.pickLarger,i):i}}t.HexStaticDefenseProjection=h},64738:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CUSTOM_WORLD_DEBUG_LAYERS=void 0,t.getDefaultDebugLayers=function(e){for(let[i,s]of Object.entries(t.CUSTOM_WORLD_DEBUG_LAYERS))e(i,s())},t.createHexIdDebugLayer=P,t.createPawnsByHexDebugLayer=I,t.createHexHistoryDebugLayer=C,t.createDistanceTestsDebugLayer=M,t.createDistanceFromCoastDebugLayer=A,t.createIncomeByHexDebugLayer=B;const s=i(76439),n=i(12543),o=i(81434),a=i(70712),r=i(7334),l=i(90952),c=i(75185),d=i(97377),h=i(56038),u=i(71376),p=i(19506),g=i(68790),m=i(78436),y=i(91622),f=i(78635),w=i(45664),v=i(19580),b=i(28104),S=i(1397),x=i(61634),T=i(9292);function P(){return new s.GameStateDebugLayer((0,n.hexBasedAdapter)({getValue:(e,t)=>t.toString(),getDetail:(e,t)=>t.toString()}))}function I(){return new s.GameStateDebugLayer((0,n.hexBasedAdapter)({getValue(e,t){const i=o.Pawns.getByHex(e,t);if(0!==i.length)return i.join(" ")},getDetail:(e,t)=>o.Pawns.model(e).byHex(t).map((e=>e.toString())).join("\n")}))}function C(){return new s.GameStateDebugLayer((0,n.hexBasedAdapter)({getValue(e,t){const i=a.AI.getHexHistory(e,t);if(0!==i.capturedAt)return`${a.AI.getHexAge(e,t)}${function(e){switch(e.spoils){case"deadHex":return"";case"liveHex":return p.GLYPH.whiteFlag;default:return p.GLYPH.redFlag}}(i)}`},getDetail(e,t){const i=a.AI.getHexHistory(e,t);if(0!==i.capturedAt)return(0,r.prettyPrintObject)(i)}}))}function M(){return new s.GameStateDebugLayer((0,n.hexBasedAdapter)({getValue:(e,t)=>(0,w.getHex)(1309).getDistanceTo((0,w.getHex)(t)),getDetail(e,t){const i=(0,w.getHex)(1309),s=(0,w.getHex)(t),n=Math.abs(i.y-s.y),o=Math.abs(i.x-s.x),a=(0,T.pickLarger)(0,Math.ceil(o-n/2));return`rowDelta: ${n}\ncolDelta: ${o}\nremainingColDelta: ${a}\nresult = ${n} + ${a} = ${n+a}`}}))}function A(){return new s.GameStateDebugLayer((0,n.hexBasedAdapter)({getValue:(e,t)=>y.inject.views.distanceFromCoast.get(e).get(t),getDetail(e,t){}}))}function B(){return new s.GameStateDebugLayer((0,n.hexBasedAdapter)({getValue:(e,t)=>`${x.Economy.getCurrentIncomeFromHex(e,t)}/${x.Economy.getPotentialIncomeFromHex(e,t)}`,getDetail(e,t){}}))}t.CUSTOM_WORLD_DEBUG_LAYERS={hexIds:P,[l.GameState.regions.edgeHexes.key]:c.createBorderHexesDebugLayer,[l.GameState.warfare.borderHexes.key]:c.createBorderHexesDebugLayer,[l.GameState.pawns.byHex.key]:I,[l.GameState.regions.byHex.key]:()=>new s.GameStateDebugLayer((0,d.dataSetAdapter)(l.GameState.regions.byHex,{getGroups:e=>h.Regions.model(e).all().map((e=>e.hexes))})),[l.GameState.ai.capitalTown.key]:u.createCapitalTownDebugLayer,[l.GameState.ai.hexImportance.key]:()=>new s.GameStateDebugLayer((0,d.dataSetAdapter)(l.GameState.ai.hexImportance,{getValue(e){const t=0===e.distanceFromTown,i=e.factors.multiplier>=1;return`${t?p.GLYPH.redFlag:i?p.GLYPH.whiteFlag:""}${Math.floor(e.factors.fromConnectedHexes+e.factors.fromHex)}`},getDetail:e=>`from hex: ${e.factors.fromHex}\nfrom connected hexes: ${e.factors.fromConnectedHexes}\nfrom townProximity: ${e.factors.fromTownProximity} (distance ${e.distanceFromTown})\nmultiplier: ${e.factors.multiplier}\nconnectivity: ${e.connectivity}`})),[l.GameState.ai.hexHistory.key]:C,diplomacy:g.createDiplomacyDebugLayer,perceivedThreat:()=>y.inject.views.perceivedThreat.getDebugLayer(),diplomacyScore:()=>y.inject.views.factionDiplomacyScore.getDebugLayer(),regionAssets:function(){return new s.GameStateDebugLayer((0,m.regionBasedAdapter)({getValue:(e,t)=>{const i=y.inject.gameStateModel.regions.byId(t);if(i)return`${i.getAssets().totalUnits.toString()}`},getDetail:(e,t)=>{const i=y.inject.gameStateModel.regions.byId(t);if(!i)return;const s=i.getAssets();return`total units: ${s.remainingUnits.toString()}\nremaining units: ${s.totalUnits.toString()}\nremaining gold: ${s.remainingGold}\nremaining income: ${s.remainingIncome}\ntotal might: ${s.getRemainingAvailableMight()}/${s.getTotalAvailableMight()}\ntotal unit upkeep: ${s.getTotalUnitUpkeep()}\nmax available might: ${s.getMaxRemainingAvailableMight()}/${s.getMaxAvailableMight()}                    \nmax sustainable might: ${s.getMaxRemainingSustainableMight()}\nobtainable unit count: ${s.getObtainableUnitCount()}\nobtainable might levels: ${s.getObtainableMightLevels()}\nbuyable might: ${s.getBuyableMight()}\n`}}))},regionForecast:()=>y.inject.views.regionForecast.getDebugLayer(),regionGeography:()=>y.inject.views.regionGeography.getDebugLayer(),situationScore:()=>y.inject.views.situationScoreByRegion.getDebugLayer(),attritionByFaction:()=>y.inject.views.attritionByFaction.getDebugLayer(),regionPolitics:()=>y.inject.views.regionPoliticsView.getDebugLayer(),expansionOptions:()=>y.inject.views.expansionOptions.getDebugLayer(),defenseWithoutMovable:function(){return new s.GameStateDebugLayer((0,n.hexBasedAdapter)({getValue:(e,t)=>f.Warfare.getHexDefenseWithoutMovableUnits(e,(0,w.getHex)(t)),getDetail:(e,t)=>""}))},estimatedDamage:v.createDamageSimDebugLayer,behaviorSummary:()=>y.inject.views.behaviorSummary.getDebugLayer(),powerByFactionView:()=>y.inject.views.powerByFactionView.getDebugLayer(),chunks:()=>(0,b.chunksDebugLayer)(),stationaryUnits:()=>(0,S.createStationaryUnitsDebugLayer)(),distanceTest:()=>M(),distanceFromCoast:()=>A(),hexTraits:()=>y.inject.views.hexTraits.getDebugLayer(),regionLedger:()=>y.inject.views.regionLedger.getDebugLayer(),"economy.incomeByHex":()=>B()},[l.GameState.pawns.byRegion,l.GameState.regions.hexes,l.GameState.economy.budgetByRegion,l.GameState.economy.treasuryByRegion,l.GameState.economy.townsByRegion,l.GameState.ai.attritionByRegion,l.GameState.ai.regionInfluenceByRegion,l.GameState.currentPhase.movableUnits,l.GameState.bandits.campsByRegion,l.GameState.ai.assetsValueByRegion,l.GameState.ai.powerByRegion,l.GameState.warfare.fortificationByRegion].forEach((e=>{t.CUSTOM_WORLD_DEBUG_LAYERS[e.key]=()=>new s.GameStateDebugLayer((0,d.regionDataSetAdapter)(e))})),[l.GameState.ai.credit,l.GameState.ai.extraAttritionByFaction,l.GameState.units.byFaction].forEach((e=>{t.CUSTOM_WORLD_DEBUG_LAYERS[e.key]=()=>new s.GameStateDebugLayer((0,d.factionDataSetAdapter)(e))}))},64884:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UnitsByMight=t.MAX_UNIT_MIGHT=void 0;const s=i(97849),n=i(76985),o=i(9292),a=i(88023);t.MAX_UNIT_MIGHT=4;const r=(0,a.ImmutableMap)();class l{constructor(e=r){this.data=e}getOneWithMightAtLeast(e){for(let i=e;i<=t.MAX_UNIT_MIGHT;++i)if(this.data.get(i))return i}has(e){return!!this.data.get(e)}withoutUnit(e){const t=this.data.get(e,0);return(0,s.assert)(t>0,`cannot take unit with might ${e} from ${this.toString()}`),new l(t-1>0?this.data.update(e,(e=>e-1)):this.data.delete(e))}hasUnitsWeakerThan(e){for(let t=1;t<e;++t)if(this.data.get(t))return!0;return!1}getTotalMight(){return this.data.map(((e,t)=>t*e)).reduce(o.sum,0)}static fromUnitList(e){return new l((0,a.ImmutableMap)().withMutations((t=>{e.forEach((e=>t.set(e,t.get(e,0)+1)))})))}toString(){let e="[";for(let t=1;t<4;++t)e+=t.toString().repeat(this.data.get(t,0));return e+="]",e}add(e,t=1){return new l(this.data.set(e,this.data.get(e,0)+t))}getStrongest(){for(let e=4;e>0;--e)if(this.data.get(e))return e;return 0}getStrongestLightUnit(){for(let e=4;e>0;--e)if(3!==e&&this.data.get(e))return e;return 0}getAvailableMightLevels(){return Array.from(this.data.keys())}map(e){return this.data.map(e)}count(){return this.data.valueSeq().reduce(o.sum,0)}countOf(e){return this.data.get(e,0)}without(...e){return new l(this.data.withMutations((t=>{e.forEach((i=>{const s=t.get(i,0);if(s<1)throw new Error(`cannot take units ${e} from ${this.toString()}`);1===s?t.remove(i):t.set(i,s-1)}))})))}with(...e){return new l(this.data.withMutations((t=>{e.forEach((e=>{const i=t.get(e,0);t.set(e,i+1)}))})))}setCount(e,t){return new l(this.data.set(e,t))}listIndividualUnits(){const e=[];for(let[t,i]of this.data.entrySeq().sort((([e],[t])=>e-t)))for(let s=0;s<i;++s)e.push(t);return e}getUpkeep(){return this.map(((e,t)=>(0,n.mightToUpkeep)(t)*e)).reduce(o.sum,0)}}t.UnitsByMight=l,l.empty=new l},65059:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UnitsByFactionUpdater=t.UnitsByFactionProjection=void 0;const s=i(83874),n=i(20026),o=i(4005),a=i(19618),r=i(78635),l=i(88023);class c extends s.MultiMapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new d(this).update}bootstrap(e){const t=(0,n.selectFromState)(e,this.sources.factionRegions);return(0,l.ImmutableMap)().withMutations((i=>{t.entrySeq().forEach((([t,s])=>{let n=(0,l.ImmutableSet)(r.Warfare.getUnitsByRegion(e,...s.toArray()));n.isEmpty()||i.set(t,n)}))}))}}t.UnitsByFactionProjection=c;class d extends o.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MultiMapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.factionRegions,this._handleFactionRegionsUpdate),e(this.dataSet.sources.pawnsByRegion,this._handlePawnsByRegionUpdate)}_handleFactionRegionsUpdate(e){e.updated?.forEach((e=>{e.removed&&this.builder.remove(e.id,...r.Warfare.getUnitsByRegion(this.newState,...e.removed)),e.added&&this.builder.add(e.id,...r.Warfare.getUnitsByRegion(this.newState,...e.added))}))}_handlePawnsByRegionUpdate(e){e.updated?.forEach((e=>{let t=a.Factions.getByRegion(this.newState,e.id);t&&e.removed&&this.builder.remove(t,...e.removed.filter((e=>r.Warfare.isUnit(this.oldState,e))))})),e.updated?.forEach((e=>{let t=a.Factions.getByRegion(this.newState,e.id);t&&e.added&&this.builder.add(t,...e.added.filter((e=>r.Warfare.isUnit(this.newState,e))))}))}}t.UnitsByFactionUpdater=d},65062:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AttritionByIdDataSet=void 0;const s=i(31011),n=i(9292);class o extends s.MapDataSet{entryToString(e){return Object.values(e).reduce(n.sum,0).toString()}entryToDebugString(e){return Object.entries(e).filter((([e,t])=>t>0)).map((([e,t])=>`${t} inflicted by faction ${e}`)).join("\n")}}t.AttritionByIdDataSet=o},65260:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FrontlineDefensePlan=void 0;const s=i(7334),n=i(1326),o=i(38746),a=i(45664),r=i(20693),l=i(89764),c=i(24598),d=i(76985);t.FrontlineDefensePlan=class{constructor(e,t){this.front=e,this.focusMismatchPenalty=t,this.endsTurn=!1,this.isConquest=!1,this.score=Math.floor(e.score*t),this.hexes=r.HexGroup.fromIds(Object.keys(this.front.plan).map((e=>Number(e)))),this.hex=this.hexes.first()}execute(e){if(0===this.hexes.length)return!1;const t=this.hexes;for(let i of t){const t=this.front.plan[i.id],s=l.RegionAssets.fromMyRegion(e.region);if(t===c.PawnType.Castle){if(!e.marshal.buildCastle((0,a.getHex)(i.id),2))return!1}else{let t=s.useUnit({requiredMight:this.front.toLevel,allowOverkill:!1,...(0,d.getMaxMightForHex)(e.state,i)});if(t||1!==this.front.toLevel||(t=s.useUnit({requiredMight:this.front.toLevel,allowOverkill:!0,...(0,d.getMaxMightForHex)(e.state,i)})),!t)return!1;if(!e.marshal.moveUnit((0,a.getHex)(i.id),t))return!1}}return!0}hash(){return`${(0,o.describeFrontline)(this.front)}`}toString(){return`[${(0,s.formatNumber)(this.score)} | ${(0,o.describeFrontline)(this.front)}]`}toDebugString(){return(0,s.prettyPrintObject)((0,n.filterDictionary)(this.front,(e=>0!=e)))+`\nfocus mismatch multiplier: ${this.focusMismatchPenalty.toPrecision(2)}\ncovers ${this.front.coveredHexes.size} hexes`}}},65415:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CustomHexGroupValuation=void 0;const s=i(1326),n=i(7334);class o{constructor(e){this.defaultValue=e,this.values={}}generateFrom(e,t){e.forEach((e=>{const i=t(e);void 0!==i&&i!==this.defaultValue&&this.set(e.id,t(e))}))}generateFromIds(e,t){e.forEach((e=>{const i=t(e);void 0!==i&&i!==this.defaultValue&&this.set(e,t(e))}))}set(e,t){this.values[e]=t}unset(e){delete this.values[e]}get(e){return this.values.hasOwnProperty(e)?this.values[e]:this.defaultValue}map(e){const t=new o(e(this.defaultValue,-1));return t.importDictionary(this.exportDictionary(e)),t}exportDictionary(e){return e?(0,s.mapDictionary)(this.values,e):this.values}toString(){return`[HexGroupValuation (default=${this.defaultValue})]`}dump(){return`{\n${Object.entries(this.values).map((([e,t])=>`${e}: ${(0,n.str)(t)}`)).join("\n")}\n}`}getHexIds(){return Object.keys(this.values).map((e=>Number(e)))}importDictionary(e){Object.keys(e).forEach((t=>this.values[t]=e[t]))}clear(){this.values={}}static fromDictionary(e,t){const i=new o(t);return i.importDictionary(e),i}static fromGroupsCollection(e,t){const i=new o(t);return e.forEach(((e,t)=>{e.forEach((e=>i.set(e.id,t)))})),i}}t.CustomHexGroupValuation=o},66002:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorScreen=t.getDefaultState=void 0;const s=i(81700),n=i(95568),o=i(36868),a=i(10809),r=i(71021),l=i(88823),c=i(91622),d=i(54825),h=i(24598),u=i(30484),p=i(56824),g=i(5365),m=i(63032),y=i(35800),f=i(20034),w=i(18144),v=i(45664),b=i(20693),S=(i(87936),i(93868)),x=i(74370),T=i(30963),P=i(39420),I=i(72273),C=i(85711),M=i(71262),A=i(59956),B=i(83282),E=i(96704),O=i(85026),R=i(86148),k=i(30256),L=i(9537),_=i(29172),D=i(45945);p.logger.for("MapEditor"),t.getDefaultState=()=>({jsonEditorShown:!1,mode:"paint",paintMode:{selectedBrush:"single-hex",selectedTool:x.EDITOR_TOOL.paintFaction1},manageMode:{selectedVersion:null},paletteLayout:(0,x.getEditorPaletteDefaultLayout)(),justPaintedHexes:new Set});class H extends n.BaseScreen{constructor(){super("MapEditor",[s.Scenes.WorldMap,s.Scenes.MapEditorSidebar,s.Scenes.MapEditorOverlay]),this.pointerController=new w.MapEditorPointerEventsController({tryStartCameraDrag:()=>!0,endCameraDrag:()=>{d.app.scene.worldMap.cameraController.stopDragScroll()},tryStartPaint:()=>!0,endPaint:()=>{}}),this.state=(0,t.getDefaultState)(),this.getCurrentPaletteLayout=(0,_.lazyAdapter)({source:()=>c.inject.gameStateModel.map.state.plugins.join(","),transform:()=>c.inject.gameStateModel.plugins.mapEditor.adjustToolPalette.apply((0,x.getEditorPaletteDefaultLayout)())}),this.observe.event(o.UserActions.ResumeGame,(()=>{c.inject.editorSession.hasUnsavedChanges()&&(c.inject.editorSession.createSnapshot(c.inject.currentGameState,"autosave-on-play"),this.saveChanges());let e=c.inject.editorSession.getLatestSnapshot();"manage"==this.state.mode&&this.state.manageMode.selectedVersion&&(e=this.state.manageMode.selectedVersion.snapshot);const t=(0,O.decodeGameState)(e.gameState);c.inject.editorSession.beginPlayTest(e);const i=this.finalizeMap(t);i&&(this.levelId=c.inject.gameStateModel.map.levelId,c.inject.levelSession.startNew({aiDifficulty:c.inject.userData.recallChoice("aiDifficulty"),levelId:c.inject.gameStateModel.map.levelId,turnNumber:1,origin:"map-editor",startingState:i}),c.inject.gameStateController.loadState(i,r.NewGameStateContext.StartingNewGame),d.app.scene.worldMap.setMode(new R.InteractiveMode),d.app.scene.worldMap.cameraController.center(0,{zoom:T.DEFAULT_CAMERA_ZOOM}),d.app.navigator.goTo(d.app.screen.play,r.NewGameStateContext.StartingNewGame))})),this.observe.event(o.UserActions.Escape,(async()=>{await d.app.modals.simpleDialog({title:"Leave Map Editor?",message:"Are you sure you want to leave the map editor?\nUnsaved changes will be lost.",buttons:[{text:g.DialogButtons.Cancel,role:m.DialogButtonRole.Regular},{text:g.DialogButtons.Leave,role:m.DialogButtonRole.PrimaryDanger}]})===g.DialogButtons.Leave&&d.app.navigator.goTo(d.app.screen.title)})),this.observe.event(f.MapEditorActions.ResetStartingCoins,(async({base:e,income:t})=>{const i=c.inject.gameStateModel,s=i.pawns.select({type:[h.PawnType.Town]});for(let n of s)1===n.faction?.id?i.pawns.setCount(n.hex,h.PawnType.Coins,e):i.pawns.setCount(n.hex,h.PawnType.Coins,e-t);d.app.scene.worldMap.syncState()})),this.observe.event(o.UserActions.EditMapJSON,(()=>{this.state.jsonEditorShown=!0,this.applyState()})),this.observe.event(o.UserActions.JSONEditorSave,(({json:e})=>{c.inject.gameStateModel.restore(e),this.state.jsonEditorShown=!1,this.applyState(),d.app.scene.worldMap.syncState()})),this.observe.event(o.UserActions.JSONEditorCancel,(()=>{this.state.jsonEditorShown=!1,this.applyState()})),this.observe.event(f.MapEditorActions.SetMode,(e=>{this.state.mode=e,this.applyState()})),this.observe.event(f.MapEditorActions.SelectTool,(e=>{this.state.paintMode.selectedTool=e,this.applyState()})),this.observe.event(f.MapEditorActions.SelectBrush,(e=>{this.state.paintMode.selectedBrush=e,this.applyState()})),this.observe.event(o.UserActions.Undo,(()=>{this.isUndoAvailable()&&(c.inject.gameStateController.undo(),d.app.scene.mapEditorSidebar.currentState.update({undoAvailable:this.isUndoAvailable()}))})),this.observe.event(o.WorldMapEvents.StartDrag,(({hexId:e,flags:t})=>{if(d.app.scene.worldMap.scene.isActive())if(this.state.justPaintedHexes.clear(),t&o.PointerEventFlags.RightButton||"paint"!==this.state.mode)this.pointerController.startCameraDrag();else if("paint"===this.state.mode){if(!e)return;const t=(0,v.getHex)(e);"flood"!==this.getCurrentBrush()&&c.inject.gameStateModel.useProjections(I.ProjectionPresets.onlyNecessaryForPartialSync),this.pointerController.startPaint(),t&&this.applyCurrentTool(t)}})),this.observe.event(o.WorldMapEvents.EndDrag,(e=>{c.inject.gameStateModel.useProjections(I.ProjectionPresets.all),this.pointerController.pointerState===w.EditorPointerState.Paint&&this.state.justPaintedHexes.size>0&&(d.app.scene.mapEditorSidebar.currentState.update({undoAvailable:this.isUndoAvailable()}),d.app.scene.mapEditorSidebar.currentState.update({hasUnsavedChanges:c.inject.editorSession.hasUnsavedChanges()}),this.syncWorldMapWithCurrentState()),this.pointerController.stop()})),this.observe.watch(c.inject.ui.hexUnderCursor,(e=>{e&&this.pointerController.pointerState===w.EditorPointerState.Paint&&this.applyCurrentTool(e)})),this.observe.event(o.UserActions.ExitMapEditor,(()=>{c.inject.editorSession.hasUnsavedChanges()&&this.saveChanges();const e=c.inject.editorSession.getUserContentId();c.inject.editorSession.end(),d.app.navigator.goTo(d.app.screen.myLibrary,{selectedContentId:e})})),this.observe.watch(c.inject.ui.sidebarMode,(e=>{e?d.app.scene.mapEditorSidebar.scene.pause():d.app.scene.mapEditorSidebar.scene.resume()})),this.observe.event(f.MapEditorActions.PreviewSnapshot,(e=>{this.previewSnapshot(e)})),this.observe.event(f.MapEditorActions.CancelSnapshotPreview,(()=>{this.state.manageMode.selectedVersion=null,this.applyState(),this.syncWorldMapWithCurrentState()})),this.observe.event(f.MapEditorActions.RestoreSnapshot,(async()=>{const e=this.state.manageMode.selectedVersion?.snapshot;if(e){if(c.inject.editorSession.hasUnsavedChanges()&&await d.app.modals.confirm(g.DialogButtons.Restore,"Restore Version","Are you sure you want to restore this version?\nThis will discard your currently unsaved changes.")!==g.DialogButtons.Restore)return;c.inject.editorSession.moveSnapshotToTop(e),this.loadSnapshot(e),this.state.manageMode.selectedVersion=null,this.applyState(),this.saveChanges()}else p.errors.handleNonFatalError("Nothing to restore - no snapshot selected","MapEditorScreen.RestoreSnapshot")})),this.observe.event(f.MapEditorActions.DeleteSnapshot,(async()=>{const e=this.state.manageMode.selectedVersion?.snapshot;if(e){const t=c.inject.editorSession.getAllSnapshots();let i=t.indexOf(e);if(-1==i)return void p.errors.handleNonFatalError("Nothing to delete - snapshot not found","MapEditorScreen.DeleteSnapshot");const s=this.isActiveSnapshot(e),n=t[i-1]||t[i+1];if((!s||n)&&await d.app.modals.confirm(g.DialogButtons.Remove,"Delete Version","Are you sure you want to delete this version?\nThis cannot be undone.")!==g.DialogButtons.Remove)return;c.inject.editorSession.deleteSnapshot(e),this.state.manageMode.selectedVersion=null,n?s?this.loadSnapshot(n):p.events.trigger(f.MapEditorActions.PreviewSnapshot(n)):this.applyState()}else{if(!c.inject.editorSession.hasUnsavedChanges())return void p.errors.handleNonFatalError("Nothing to delete - no snapshot selected and no unsaved changes","MapEditorScreen.DeleteSnapshot");if(!c.inject.editorSession.getLatestSnapshot())return void p.errors.handleNonFatalError("Cannot delete unsaved changes - no earlier snapshot available","MapEditorScreen.DeleteSnapshot");if(await d.app.modals.confirm(g.DialogButtons.Remove,"Revert Unsaved Changes","Are you sure you want to discard all changes since last version?\nThis cannot be undone.")!==g.DialogButtons.Remove)return;this.loadSnapshot(c.inject.editorSession.getLatestSnapshot())}this.saveChanges()})),this.observe.event(f.MapEditorActions.RenameSnapshot,(async()=>{const e=this.state.manageMode.selectedVersion?.snapshot;if(!e)return void p.errors.handleNonFatalError("Nothing to rename - no snapshot selected","MapEditorScreen.RenameSnapshot");const t=(0,C.ref)(e.label||"");await d.app.modals.textInput({title:"Rename Version",message:"Enter a new label for this version",buttons:[{text:g.DialogButtons.Cancel,role:m.DialogButtonRole.Regular},{text:g.DialogButtons.OK,role:m.DialogButtonRole.PrimaryGreen}],value:t,maxLength:30})===g.DialogButtons.OK&&(e.label=t.current.trim()||void 0,this.applyState()),this.saveChanges()})),this.observe.event(f.MapEditorActions.SaveSnapshot,(()=>{c.inject.editorSession.createSnapshot(c.inject.currentGameState,"manual"),this.applyState(),this.saveChanges()})),c.inject.gameStateController.onEvent((e=>{this.isActive()&&this.pointerController.pointerState!==w.EditorPointerState.Paint&&(0,P.isEvent)(e,o.GameStateEvents.NewGameState)&&d.app.scene.worldMap.loadNewGameState(e.payload.state)})),this.observe.event(o.UserActions.ToolModifierChanged,(()=>{setTimeout((()=>this.applyState()),10)})),this.observe.event(f.MapEditorActions.DownloadLevel,(()=>{const e=this.state.manageMode.selectedVersion?.gameState??c.inject.currentGameState,t=this.finalizeMap((0,E.compressGameState)(e));if(!t)return;const i=t.map.levelId,s=(t.map.name??i).replaceAll(" ","-").toLowerCase();(0,B.downloadAsTextFile)(`${s}.konkr`,(0,O.encodeGameState)(t))})),this.observe.event(f.MapEditorActions.AddPlugin,(e=>{(0,D.addPlugin)(e),this.state.paintMode.selectedTool=x.EDITOR_TOOL.select,this.syncWorldMapWithCurrentState()})),this.observe.event(f.MapEditorActions.RemovePlugin,(e=>{(0,D.removePlugin)(e),this.state.paintMode.selectedTool=x.EDITOR_TOOL.select,this.syncWorldMapWithCurrentState()})),this.observe.event(o.UserActions.SelectAIDifficulty,(e=>{c.inject.userData.rememberChoice("aiDifficulty",e)}))}syncWorldMapWithCurrentState(){d.app.scene.worldMap.syncState(c.inject.currentGameState,u.OverlayModes.spectating())}isActiveSnapshot(e){return!c.inject.editorSession.hasUnsavedChanges()&&c.inject.editorSession.getLatestSnapshot()===e}previewSnapshot(e){const t=c.inject.editorSession.getSnapshotPreview(e);this.state.manageMode.selectedVersion={gameState:t,snapshot:e},this.applyState(),d.app.scene.worldMap.syncState(t,u.OverlayModes.disabled)}isUndoAvailable(){return"paint"===this.state.mode&&c.inject.gameStateController.undoAvailable()===L.UndoAvailability.Available}applyState(){d.app.scene.worldMap.editorOverlay?.setVisible("paint"===this.state.mode),"manage"!==this.state.mode&&this.state.manageMode.selectedVersion&&(this.state.manageMode.selectedVersion=null,this.syncWorldMapWithCurrentState()),"manage"===this.state.mode&&(this.state.manageMode.selectedVersion||c.inject.editorSession.hasUnsavedChanges()||(this.state.manageMode.selectedVersion={snapshot:c.inject.editorSession.getLatestSnapshot(),gameState:c.inject.gameStateModel.state})),d.app.scene.mapEditorSidebar.currentState.update({mode:this.state.mode,undoAvailable:this.isUndoAvailable(),hasUnsavedChanges:c.inject.editorSession.hasUnsavedChanges(),aiDifficulty:c.inject.userData.recallChoice("aiDifficulty")||"hard",paint:{...this.state.paintMode,paletteLayout:this.getCurrentPaletteLayout()},manage:{...this.state.manageMode,availableSnapshots:c.inject.editorSession.getAllSnapshots()??[],activeSnapshot:c.inject.editorSession.hasUnsavedChanges()?null:c.inject.editorSession.getLatestSnapshot()}}),d.app.scene.worldMap.editorOverlay?.currentState.update({brush:this.getCurrentBrush(),cursorAttachmentImage:this.getCurrentCursorAttachment()}),d.app.scene.mapEditorOverlay.currentState.update({jsonEditorShown:this.state.jsonEditorShown})}getCurrentBrush(){if("paint"!==this.state.mode)return"none";if(!this.state.paintMode.selectedTool?.options?.allowLargeBrushes)return"single-hex";if(this.getActiveModifiers().shift){if("single-hex"===this.state.paintMode.selectedBrush)return"9-hexes";if("9-hexes"===this.state.paintMode.selectedBrush)return"single-hex"}return this.state.paintMode.selectedBrush}getCurrentCursorAttachment(){return"paint"!==this.state.mode?null:this.state.paintMode.selectedTool?.iconRecipe||null}getActiveModifiers(){const e=d.app.scene.mapEditorOverlay.getActiveModifiers();return{ctrl:e.ctrl,shift:e.shift}}applyCurrentTool(e){const{selectedTool:t}=this.state.paintMode,i=this.getCurrentBrush();if(!t)return;if(e.isAtGridBorder(c.inject.gameStateModel.map))return;const s=this.getAffectedHexesBasedOnBrush(e);if(!s.length)return;const n=c.inject.gameStateModel.state,a=this.getActiveModifiers();if("flood"===i&&t.useOnRegion){const i=c.inject.gameStateModel.regions.byHex(e);if(!i)return;const s=i.hexes;t.useOnRegion(c.inject.gameStateModel.regions.byHex(e),a),s.forEach((e=>(0,k.sanitizeTile)(c.inject.gameStateModel,e)))}else for(const e of s)t.useOn(e,a),(0,k.sanitizeTile)(c.inject.gameStateModel,e);const r=c.inject.gameStateModel.state;if(n!==r){for(const e of s)this.state.justPaintedHexes.add(e);d.app.scene.worldMap.partialSync(r,s),c.inject.gameStateController.executePlay(o.Plays.EditMap({stateAfter:r}))}}getAffectedHexesBasedOnBrush(e){const t=c.inject.gameStateModel;switch(this.getCurrentBrush()){case"none":return b.HexGroup.empty;case"single-hex":return e;case"9-hexes":return e.with(e.neighbours().filter((e=>!e.isAtGridBorder(c.inject.gameStateModel.map))));case"flood":const i=t.regions.byHex(e);return i?i.hexes:b.HexGroup.empty}}finalizeMap(e){const t=(0,l.lintLevel)(e,{fix:!0});return t.errors.length>0?(d.app.modals.simpleDialog({title:"Map Unplayable",message:`Detected issues:\n${t.errors.map((e=>`- ${e}`)).join("\n")}`,buttons:[{text:g.DialogButtons.OK,role:m.DialogButtonRole.Regular}]}),null):(c.inject.gameStateModel.map.levelId.startsWith(y.ID_TYPE.CustomLevel.prefix)||(t.fixedState.map.levelId=p.random.id(y.ID_TYPE.CustomLevel)),t.fixedState)}loadSnapshot(e){c.inject.editorSession.loadSnapshot(e),this.state.manageMode.selectedVersion={gameState:c.inject.currentGameState,snapshot:e},this.syncWorldMapWithCurrentState(),this.applyState()}saveChanges(){if(0===c.inject.editorSession.getAllSnapshots().length&&0===c.inject.gameStateModel.regions.all().length)return;const e=c.inject.editorSession.getMyIslandDBRecord();c.inject.userContent.saveMyIsland(e)}async activate(e){const{loadLevel:t,createNewLevel:i,cloneCurrentLevel:s}=e;t?(c.inject.editorSession.begin({snapshots:t.snapshots,userContentId:t.userContentId}),this.resetEditorState()):i?((0,M.createBlankMap)(30,30,y.ID_TYPE.CustomLevel),A.WorldMap.update(c.inject.currentGameState,{author:c.inject.userData.recallChoice("nickname")}),c.inject.gameStateModel.activateAllProjections(),c.inject.editorSession.begin(c.inject.currentGameState),this.resetEditorState()):s?(A.WorldMap.update(c.inject.currentGameState,{levelId:p.random.id(y.ID_TYPE.CustomLevel),name:c.inject.gameStateModel.map.name+" (Copy)",created:Date.now()}),c.inject.editorSession.begin(c.inject.currentGameState),c.inject.editorSession.createSnapshot(c.inject.currentGameState,"manual","Original version"),this.resetEditorState()):(c.inject.editorSession.loadLatestSnapshot(),this.saveChanges()),d.app.scene.worldMap.setMode(new a.EditorMode),d.app.scene.worldMap.cameraController.setViewportMargins({right:S.BOUNDS.MapEditorSidebar.width}),d.app.scene.worldMap.cameraController.center(0,{zoom:T.DEFAULT_CAMERA_ZOOM}),d.app.scene.worldMap.editorOverlay?.currentState.update({worldBounds:{x:0,y:0,width:c.inject.gameStateModel.map.width,height:c.inject.gameStateModel.map.height}}),"manage"===this.state.mode&&this.state.manageMode.selectedVersion?this.previewSnapshot(this.state.manageMode.selectedVersion.snapshot):this.syncWorldMapWithCurrentState(),this.applyState()}resetEditorState(){this.state=(0,t.getDefaultState)()}deactivate(){}}t.MapEditorScreen=H},66143:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelModel=t.LevelTitleStyle=t.LevelStatus=void 0,t.getCurrentLevelManifest=y;const s=i(1326),n=i(91622),o=i(25342),a=i(78282),r=i(56824),l=i(9185),c=i(53360),d=i(28361),h=i(85026),u=Symbol("UNINITIALIZED");var p,g;!function(e){e.Locked="Locked",e.Unlocked="Unlocked",e.InProgress="InProgress",e.SilverMedal="SilverMedal",e.GoldMedal="GoldMedal"}(p||(t.LevelStatus=p={})),function(e){e.Short="short",e.Full="full",e.IncludingModePrefix="with-mode-prefix"}(g||(t.LevelTitleStyle=g={}));class m{static for(e){return(0,s.getOrCreate)(this._instances,e,(()=>new m(e)))}constructor(e){this._expeditionContext=u,this.id=e}get userVictoryRecord(){return n.inject.userData.getLevelVictoryRecordById(this.id)}get author(){return this.manifest?.author}getTitle(e=g.Full){if(e===g.Short)return this.name;switch(this.category){case"expedition":return`${e===g.IncludingModePrefix?this.expeditionContext?.expedition.metadata.name+" > ":""}${this.name}`;case"conquest":return(e===g.IncludingModePrefix?"Conquest > ":"")+this.name;case"custom":return this.name}}get manifest(){return n.inject.levelSession.levelId===this.id?y():n.inject.mapRegistry.getLevelManifestById(this.id)}getFeatures(e={}){const t=this.manifest;if(!t)return[];let i=[...t.features];return e.includeIsNew&&this.expeditionContext?.levelData.isNew&&i.unshift("new"),i.map((e=>({id:e,...l.LEVEL_FEATURES[e]})))}getPreferredTheme(){return(0,c.isHalloweenMode)()&&"conquest"===this.category?"muted":this.expeditionContext?.expedition.config.theme}isInMapRegistry(){return!!n.inject.mapRegistry.getLevelManifestById(this.id)}get name(){return"conquest"===this.category?function(e){try{return o.RandomMapHash.parse(e).name}catch(e){return"Unknown island"}}(this.id):this.manifest?this.manifest.name:(this.category,"Unknown Island")}getName(e){return e.map.name?e.map.name:this.name}getContextTitle(){return this.expeditionContext?this.expeditionContext.expedition.metadata.name:"custom"===this.category?"Custom Map":"conquest"===this.category?"Conquest":""}hasStats(){return Boolean(this.expeditionContext&&!this.expeditionContext.levelData.isNew)}getIcon(){const e=this.expeditionContext?.expedition.id;return e?`expedition-icons/${e}`:"expedition-icons/conquest"}get category(){return this.expeditionContext?"expedition":(0,o.isMapPresetHash)(this.id)?"conquest":"custom"}get expeditionContext(){return this._expeditionContext===u&&(this._expeditionContext=n.inject.mapRegistry.getLevelExpeditionContext(this.id)),this._expeditionContext}getNextUnfinishedLevelInExpedition(e,t=n.inject.userData.recallChoice("aiDifficulty")){if(!this.expeditionContext)return;if(e){const i=this.expeditionContext.expedition.getLevelsAdjacentTo(e).filter((e=>!m.for(e.id).isCompleted(t))).sort(((e,t)=>t.distanceFromEntrypoint-e.distanceFromEntrypoint));if(i.length>0)return i[0].id}const i=this.expeditionContext.expedition.objects.filter((e=>"island"===e.type&&e.id!==this.id));return i.find((e=>!m.for(e.id).isCompleted(t)))?.id}getStartingState(){if(n.inject.levelSession.active&&n.inject.levelSession.levelId===this.id&&n.inject.levelSession.data?.startingState)return(0,h.decodeGameState)(n.inject.levelSession.data.startingState);if(this.isInMapRegistry())return n.inject.mapRegistry.loadLevelById(this.id);if(this.id in d.BUILT_IN_MAPS)return(0,h.decodeGameState)(d.BUILT_IN_MAPS[this.id]);if(this.isInProgress()){const e=n.inject.levelSession.getInProgressLevelRecord().startingGameState;if(e)return(0,h.decodeGameState)(e)}}getCurrentState(){if(!this.isInProgress())return this.getStartingState();try{const e=n.inject.levelSession.getInProgressLevelRecord().currentGameState;if(!e)throw Error("No current game state");return(0,h.decodeGameState)(e)}catch(e){return console.error(`Failed to load level "${this.id}" state from user data, falling back to start`,e),n.inject.levelSession.clearInProgressLevelRecord(),this.getCurrentState()}}getLevelStatus(){const e=this.userVictoryRecord;return e?"normal"!==this.manifest?.fixedAIDifficulty&&"hard"!==e.difficulty&&e.difficulty?p.SilverMedal:p.GoldMedal:this.isInProgress()?p.InProgress:this.isUnlocked()?p.Unlocked:p.Locked}getAdjacentLevels(){const e=this.expeditionContext;return e&&e.levelData.links?e.levelData.links.map((e=>m.for(e))).filter((e=>e)):[]}isUnlocked(){return!!this.userVictoryRecord||!(!n.inject.userData.recallChoice("unlockAllIslands")&&!r.config.flags.portableMode)||!!this.expeditionContext&&(!!this.expeditionContext.levelData.entrypoint||!!this.getAdjacentLevels().some((e=>e.userVictoryRecord))||(this.expeditionContext.levelData.links?.some((e=>{const t=this.expeditionContext.expedition.getObjectById(e);return t&&t.entrypoint&&"island"!==t.type}))??!1))}isCompleted(e){const t=this.getLevelStatus();return("hard"!==e||t!==p.SilverMedal)&&[p.SilverMedal,p.GoldMedal].includes(t)}isInProgress(){const e=n.inject.levelSession.getInProgressLevelRecord();return e?.sessionData.levelId===this.id}get inProgressRecord(){const e=n.inject.levelSession.getInProgressLevelRecord();if(e?.sessionData.levelId===this.id)return e}createUrlHash(){switch(this.category){case"expedition":return a.buildUrlHash.campaign(this.id);case"conquest":return a.buildUrlHash.conquest(this.id);default:throw new Error(`Cannot create link to level with category ${this.category}`)}}}function y(){const e=n.inject.gameStateModel.map;return{name:e.name??"Unknown Island",description:e.description,author:e.author,features:(0,l.getLevelFeatures)(n.inject.gameStateModel),defeatConditions:e.state.defeatConditions,winConditions:e.state.winConditions,fixedAIDifficulty:e.fixedAIDifficulty,height:e.height,width:e.width,script:e.script}}t.LevelModel=m,m._instances={}},66253:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.COMPACT_PLAY_UI_LAYOUT=void 0;const s=i(27700),n=i(11466);t.COMPACT_PLAY_UI_LAYOUT={regionPanel:{offsetFromSides:70,height:50},shoppingTray:{openOffsetFromBottom:106,pawnsVerticalOffset:44,pawnsSpacing:50,narrowPawnsSpacing:40,width:n.MIN_WIDTH_FOR_LARGE_UI,height:35,style:s.ShoppingTrayStyle.Simple,closedOffsetFromBottom:-20,panelTransitionsDuration:500,clothHorizontalPadding:-2,clothOffsetTop:24},rewindControls:{buttonsOffsetFromEdge:4,buttonsSpacing:4,guidePromptOffsetFromBottom:48,labelWidth:140},panelTransitionsDuration:500}},66272:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.SortBy=void 0,function(e){e.LevelNumber="number",e.LevelName="name",e.TurnCount="turns",e.Mode="mode"}(i||(t.SortBy=i={}))},66313:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.victoryTransition=async function(e=1e3){const t=n.app.scene.victory;n.app.scene.playUI.activeUI.transitionOut(),n.app.audio.playEffect(s.SoundEffects.Victory),n.app.scene.globalUI.ambientGlitterVolume.transitionTo(1),await new Promise((i=>{t.preUpdate.makeDirty(),t.preUpdate(),t.ribbon.setAlpha(1),t.tweens.add({targets:t.backgroundOverlay,alpha:{start:0,to:1},duration:e/2}),t.tweens.add({targets:t.ribbonText,alpha:{from:0,to:1},duration:e,onComplete:i}),t.tweens.add({targets:t.ribbon,x:{from:t.ribbon.x+150,to:t.ribbon.x},width:{from:100,to:400},duration:e,ease:Phaser.Math.Easing.Expo.Out}),t.tweens.add({targets:t.trophy,delay:0,scale:{from:10,to:1},duration:e,ease:Phaser.Math.Easing.Bounce.Out}),t.tweens.add({delay:e/3,targets:t.trophy,alpha:{start:0,to:1},duration:e/2}),t.tweens.add({targets:[t.shield],scale:{from:.2,to:1},alpha:{start:0,to:1},duration:e/2,ease:Phaser.Math.Easing.Expo.Out}),t.tweens.add({delay:e/3,targets:[t.shieldOutline,t.victoryHalo,t.victoryRays],alpha:{start:0,to:1},scale:{start:.2,to:1},duration:2*e/3,ease:Phaser.Math.Easing.Back.Out}),t.tweens.add({delay:.5*e,targets:[t.primaryButton].filter((e=>e.visible)),alpha:{start:0,to:1},duration:e/3}),t.tweens.add({delay:e,targets:[t.levelInfoPanel],alpha:{start:0,to:1},duration:e/3});const s=[t.secondaryButton,t.ternaryButton,t.replayButton].map((e=>e.y));t.tweens.add({delay:e,targets:[t.secondaryButton,t.ternaryButton,t.replayButton].filter((e=>e.visible)),y:{getStart:(e,i,s,n)=>t.primaryButton.y+.5*t.primaryButton.height,getEnd:(e,t,i,n)=>s[n]},alpha:{start:0,to:1},duration:e/3,ease:Phaser.Math.Easing.Sine.Out}),t.tweens.add({delay:2*e/3,targets:[t.levelInfoPanel],y:{from:t.levelInfoPanel.y+150,to:t.levelInfoPanel.y},duration:e/3,ease:Phaser.Math.Easing.Back.Out})}))};const s=i(98963),n=i(54825)},66341:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StoredCountersUpdater=void 0;const s=i(56824),n=i(36868),o=i(66143),a=i(25342),r=i(85072),l=i(91622),c=i(18497);s.logger.for("counters"),t.StoredCountersUpdater=class{constructor(e){this.userData=e,this._initialized=!1}initialize(){this._initialized||(this._initialized=!0,s.events.on(n.SystemEvents.LevelCompleted,(({levelId:e,newRecord:t})=>{if("conquest"===o.LevelModel.for(e).category){this.addToCounter("cqlWon");try{switch(a.RandomMapHash.parse(e).difficulty){case r.MapDifficulty.Challenging:this.addToCounter("cqlWonChallenging");break;case r.MapDifficulty.Unfair:this.addToCounter("cqlWonUnfair")}}catch(e){s.errors.handleNonFatalError(e,"CounterService.on(LevelCompleted)/parseRandomMapHash")}l.inject.gameStateModel.plugins.has(c.PluginKey.Zombies)&&this.addToCounter("cqlWonWithZombies")}})),s.events.on(n.UserActions.PlayLevel,(({levelId:e,origin:t})=>{"conquest/begin"===t&&this.addToCounter("cqlPlayed")})))}addToCounter(e,t=1){if(t<0)throw Error(`cannot update counter ${e} negative amount not allowed`);const i=this.userData.current.progress.local.counters[e]??0;this.userData.current.progress.local.counters[e]=i+t}}},66825:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defeatTransition=async function(){const e=s.app.scene.defeat;s.app.scene.playUI.activeUI.transitionOut();const t=n.config.screenTransitionDuration;await new Promise((i=>{e.preUpdate.force(),e.tweens.add({targets:[e.menuButton,e.restartButton,e.rewindButton,e.replayButton],y:{from:"+=160",to:"-=160"},alpha:{from:0,to:1},onComplete:i,duration:t,ease:"Sine.easeInOut"}),e.tweens.add({targets:[e.background,e.ribbonText],alpha:{from:0,to:1},duration:t,ease:"Sine.easeInOut"}),e.tweens.add({targets:e.ribbon,x:{from:e.ribbon.x+150,to:e.ribbon.x},width:{from:100,to:400},alpha:{from:.5,to:1},duration:t,ease:"Sine.easeInOut"}),e.tweens.add({targets:e.gravestone,y:{from:e.gravestone.y+40,to:e.gravestone.y},duration:t,scale:{from:.1,to:1},alpha:{from:0,to:1},ease:"Sine.easeInOut"})}))};const s=i(54825),n=i(56824)},67016:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaletteSlot=t.Palette=void 0;const s=i(76049),n=i(86545),o=i(80959),a=i(46973),r=i(58903),l=i(1187),c=i(20087),d=i(76540),h=i(95070);class u extends n.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.props=t,this.ui=o.UiBuilder.for(this.scene),this.slots=new l.GameObjectList(((e,t,i)=>{if(i)return i.setProps({icon:e.image,hotkey:e.hotkey,onClick:()=>this.handleValueClicked(e.value)}),i;{const t=new p(this.scene,{icon:e.image,hotkey:e.hotkey,onClick:()=>this.handleValueClicked(e.value)});return this.add(t),t}})),this.currentSelection=void 0,this.setProps(this.props)}setProps(e){e.items&&this.slots.set(e.items),e.title&&(this.title||(this.title=this.ui.richText("",(e=>e.oceanShades.light2),s.VectorFont.RobotoMini),this.add(this.title)),this.title.setText(`[b]${e.title}[/b]`)),this.preUpdate.makeDirty()}handleValueClicked(e){this.select(e),this.props.onItemSelected(e)}select(e){if(this.slots.get().forEach((e=>e.setSelected(!1))),e){const t=this.slots.find((t=>t.value===e));t&&t.setSelected(!0)}}updateLayout(){const e=this.title?this.title.height+4:0;c.Arrange.leftToRight({content:this.slots.get(),spacing:this.props.spacing,x:0,origin:0}),c.Arrange.alignY({content:this.slots.get(),y:e,origin:0}),this.updateSize()}calculateHeight(){const e=this.slots.get()[this.slots.get().length-1];return e?e.y+e.height:this.title?this.title.height+4:0}}t.Palette=u;class p extends n.ResponsiveContainer{constructor(e,{icon:t,hotkey:i,onClick:n}){super(e),this._clickHandler=n,this.buttonController=new r.ToggleButtonStateController({onToggled:e=>{e?this.handleClicked():this.setSelected(!0)}}),this.button=new a.RoundedRectButton(this.scene,{radius:4,bevel:"inset",content:new h.IconOnly(this.scene,t),width:d.PALETTE_SLOT_SIZE,height:d.PALETTE_SLOT_SIZE,theme:a.RoundedRectButton.Themes.insetButton,controller:this.buttonController}),this.hotkey=o.UiBuilder.for(e).text(i??"",s.BitmapFont.MiniBold,(e=>e.white)).setAlpha(.5),this.hotkey.setPosition(this.button.width-this.hotkey.width-2,1),this.add([this.button,this.hotkey]),this.width=this.button.width,this.height=this.button.height}handleClicked(){this._clickHandler?.()}setProps(e){this.button.content.setImage(o.UiBuilder.for(this.scene).createIcon(e.icon)),this.hotkey.setText(e.hotkey??""),this.hotkey.setPosition(this.button.width-this.hotkey.width-2,1),this._clickHandler=e.onClick,this.updateLayout()}setSelected(e){this.buttonController.setToggled(e)}updateLayout(){}}t.PaletteSlot=p},67022:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MyLibraryScreen=void 0;const s=i(95568),n=i(81700),o=i(54825),a=i(36868),r=i(91622),l=i(85026),c=i(56824),d=i(61598),h=i(66143),u=i(97113),p=i(1554);class g extends s.BaseScreen{constructor(){super("MyLibrary",[n.Scenes.MyLibraryUI,n.Scenes.MenuHeaderUI]),this.lockOrientation=!0,this.observe.event(a.UserActions.Escape,(async()=>{c.events.trigger(a.UserActions.GoBack())})),this.observe.event(a.UserActions.GoBack,(async()=>{o.app.navigator.goTo(o.app.screen.title)})),this.observe.event(a.UserActions.SelectContent,(async e=>{o.app.scene.myLibraryUI.state.update({selectedContentId:e})})),this.observe.event(a.SystemEvents.FavoriteLevelsChanged,(async()=>{const e=await r.inject.userContent.getFavorites();o.app.scene.myLibraryUI.state.update({favorites:e})})),this.observe.event(a.SystemEvents.MyIslandsChanged,(async()=>{const e=await r.inject.userContent.getMyIslands();o.app.scene.myLibraryUI.state.update({myIslands:e})}))}async activate(e,t){await super.activate(e,t),o.app.scene.menuHeaderUI.currentState.update({header:{icon:"rosetta-light",title:"My Domain",subtitle:"",alignWithContent:!0,overlayIcon:"ui/icons/my-domain"},footer:{backButton:!0}}),await this.refreshContent(e?.selectedContentId)}async transitionOut(e){e!==o.app.screen.mapEditor&&await(0,u.myLibraryTransitionOut)()}async transitionIn(e){e!==o.app.screen.mapEditor&&await(0,p.myLibraryTransitionIn)()}async refreshContent(e){const[t,i,s]=await Promise.all([r.inject.userContent.getLastPlayedList(),r.inject.userContent.getFavorites(),r.inject.userContent.getMyIslands()]);!function(e){const t=function(){const e=r.inject.levelSession.getInProgressLevelRecord();if(e)try{const t=(0,l.decodeGameState)(e.currentGameState);return{id:"inProgressLevelRecord",type:"in-progress-level",title:h.LevelModel.for(t.map.levelId).getName(t),lastInteraction:e.created,...e}}catch(e){return void c.errors.handleNonFatalError(e,"getInProgressLevelAsUserContent")}}();if(!t)return;const i=e.findIndex((e=>e.created<t.created));-1===i?(console.log("Adding in progress level to the end of the list"),e.push(t)):(console.log("Adding in progress level at index ",i),e.splice(i,0,t))}(t),e||(e=o.app.scene.myLibraryUI.state().selectedContentId||void 0),o.app.scene.myLibraryUI.state.update({recentlyPlayed:t.slice(0,d.LAST_PLAYED_HISTORY_SIZE),favorites:i,myIslands:s,selectedContentId:e})}}t.MyLibraryScreen=g},67023:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SocialsPanel=t.TitleScreenFooterUIScene=void 0;const s=i(81700),n=i(897),o=i(20087),a=i(36868),r=i(30948),l=i(55275),c=i(80959),d=i(96137),h=i(76049),u=i(86545),p=i(56824),g=i(54825),m=i(11466),y=i(83221),f=i(79899);class w extends r.BaseUIScene{constructor(){super({key:s.Scenes.TitleScreenFooterUI}),this.state=(0,l.stateContainer)({viewReplayButton:!1},(()=>{this.preUpdate.makeDirty()})),this.preUpdate=(0,n.whenDirty)((()=>{const e=this.bounds.height-y.MenuHeaderUIScene.Layout.wavesHeight/2;this.watchReplayButton.setVisible(g.app.device.uiVariant()===m.UiVariant.Large&&this.state().viewReplayButton),this.socialsPanel.setVisible(!0),this.socialsPanel.setSize(300,32),o.Arrange.leftToRight({content:[this.watchReplayButton,this.socialsPanel],x:this.bounds.width-(g.app.device.uiVariant()===m.UiVariant.Compact?20:40),origin:1,spacing:32}),o.Arrange.alignY({content:[this.watchReplayButton,this.socialsPanel],y:e,origin:.5})}))}create(){super.create();const e=c.UiBuilder.for(this);this.watchReplayButton=e.outlineButton({text:"Watch latest replay",icon:"ui/button-icons/replay",width:160,onClicked:()=>{try{console.error("NOT IMPLEMENTED")}catch(e){g.app.notifications.warning("Could not load the latest replay, sorry!","The replay may be corrupted or incompatible with the current version of the game.")}}}),this.socialsPanel=new b(e),this.addAll([this.socialsPanel,this.watchReplayButton])}transitionOut(e){return new Promise((t=>{this.preUpdate.force(),this.tweens.add({targets:[this.watchReplayButton,this.socialsPanel],props:{y:{getStart:e=>e.y,getEnd:e=>e.y+160}},duration:e,ease:"Sine.easeOut",onComplete:()=>t()})}))}transitionIn(e){return new Promise((t=>{this.preUpdate.force(),this.tweens.add({targets:[this.watchReplayButton,this.socialsPanel],props:{y:{getStart:e=>e.y+160,getEnd:e=>e.y}},duration:e,ease:"Sine.easeOut",onComplete:()=>t()})}))}getTooltipFor(e){switch(e){case this.socialsPanel.twitterButton:return{title:"Tweet at me!"};case this.socialsPanel.discordButton:return{title:"Join konkr.io discord server!"};case this.socialsPanel.feedbackButton:return{title:"Send me an email!"}}}}function v(e,t,i){return new f.ImageButton(e.scene,0,0,{frame:t,tint:{default:d.Colors.white,hover:d.Colors.white},onClicked:()=>{p.events.trigger(i())}})}t.TitleScreenFooterUIScene=w;class b extends u.AutoWidthResponsiveContainer{constructor(e){super(e.scene),this.ui=e,this.callToActionText=this.ui.text("Give me feedback!",h.BitmapFont.Mini,d.Colors.white),this.twitterButton=v(this.ui,"ui/icons/twitter",a.UserActions.SendTweet),this.discordButton=v(this.ui,"ui/icons/discord",a.UserActions.JoinDiscord),this.feedbackButton=v(this.ui,"ui/icons/mail",a.UserActions.SendEmail),this.add([this.callToActionText,this.twitterButton,this.discordButton,this.feedbackButton])}updateLayout(){o.Arrange.leftToRight({content:[this.callToActionText,this.feedbackButton,this.twitterButton,this.discordButton],x:0,origin:0,spacing:16}),o.Arrange.alignY({content:[this.callToActionText,this.feedbackButton,this.twitterButton,this.discordButton],y:this.height/2,origin:.5}),this.updateSize()}calculateWidth(){return this.discordButton.x+this.discordButton.width}}t.SocialsPanel=b},67177:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PickLandingSpotOverlayMode=void 0;const s=i(91622),n=i(58440);t.PickLandingSpotOverlayMode=class{constructor(){this.type="playing"}update(e,t){this.gameState=t,e.selectedRegionHighlight.clear(),e.pawnBacklight.clear(),this.updateConquerableHexes(e),e.townStatusFlags.clear(),e.pawnSymbols.clearAll(),e.newsAlerts.clear(),e.attitudeEmojis.clearChatter(),e.regionSummaryPopup.hide(),e.hexMarkers.clear(),e.hexMarkers.clearHoveredHex(),(0,n.updateBudgetOverlay)(t,e)}updateConquerableHexes(e){const t=s.inject.views.landingSpots.get(this.gameState);e.conquerableHexesHighlight.clearHighlightedHex(),e.conquerableHexesHighlight.set(t)}toString(){return"[PickLandingSpotOverlay]"}}},67273:function(e,t,i){"use strict";var s,n=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(t,i);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,n)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||(s=function(e){return s=Object.getOwnPropertyNames||function(e){var t=[];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[t.length]=i);return t},s(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i=s(e),a=0;a<i.length;a++)"default"!==i[a]&&n(t,e,i[a]);return o(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.generationPresets=void 0,t.setDatGUIVisible=function(e){!0===e&&(e=I),e?(P||function(e){const i={debug:{Storybook:()=>{window.open(window.location.href+"?mode=storybook","_blank")}},mapGen:{preset:t.generationPresets[1].key,players:6,playerAdvantage:1,randomize:async function(){L.seed=b.random.integerBetween(0,1e4),localStorage.setItem("seed",L.seed.toString()),n.updateDisplay(),await j()},breakpoints:!!b.config.debug.breakpoints},debugLayer:"",colors:(0,u.mapDictionary)({ocean:x.OCEAN_COLOR_PRESETS.gentle,1:x.THEMES.default.factionColors[0],2:x.THEMES.default.factionColors[1],3:x.THEMES.default.factionColors[2],4:x.THEMES.default.factionColors[3],5:x.THEMES.default.factionColors[4],6:x.THEMES.default.factionColors[5]},(e=>T.Colors.toCss(e))),palette:{oceanColor:"#000",oceanShades:{dark1:"#000",dark2:"#000",dark3:"#000",dark4:"#000",dark5:"#000",light1:"#000",light2:"#000",light3:"#000"},glass:"#000",glassHighlight:"#000",oceanContrastDark:"#000",oceanContrastLight:"#000",white:"#000"}};P=new r.GUI({width:300});const s=P.addFolder("DEBUG"),n=P.addFolder("MAP GENERATION"),o=P.addFolder("LEVEL"),a=P.addFolder("FACTIONS"),I=P.addFolder("COLORS"),C=P.addFolder("PALETTE");s.add(b.config.debug,"overlay");const B=s.add(i,"debugLayer",["----------------"]).onChange((function(e){y.commands.debug.layer(e)}));H(),g.inject.debugLayers.onActiveLayerUpdated(H),s.add(b.config.debug,"gameObjects"),s.add(b.config.debug,"ai"),s.add(b.config.debug,"objectPools"),s.add(b.config.debug,"chunkBorders").onChange((()=>m.app.scene.worldMap.syncState())),s.add(b.config.debug,"tweenSpeedFactor",.1,2),s.add(b.config,"screenTransitionDuration",0,3e3),s.add(i.debug,"Storybook"),(0,f.createAIControls)(a),I.addColor(i.colors,"ocean").onChange(_),I.addColor(i.colors,"1").onChange(_),I.addColor(i.colors,"2").onChange(_),I.addColor(i.colors,"3").onChange(_),I.addColor(i.colors,"4").onChange(_),I.addColor(i.colors,"5").onChange(_),I.addColor(i.colors,"6").onChange(_);const E=(0,d.throttle)(j,100,{trailing:!0}),O=(0,d.debounce)(j,300,{trailing:!0}),R=async()=>{L.generateRegions?await O():await E()};let k=!1;const L={seed:Number(localStorage.getItem("seed"))||b.random.integerBetween(0,1e4),regionsVariation:1,...(0,d.cloneDeep)(t.generationPresets.find((e=>e.key===i.mapGen.preset)))};function _(){const e=[];for(let t=1;t<=6;++t)e[t-1]=T.Colors.fromCss(i.colors[t.toString()]);g.inject.theme.customize({oceanColor:T.Colors.fromCss(i.colors.ocean),factionColors:e})}function D(e,t){switch(t){case"off":return void e.hide();case"expanded":e.open()}}function H(){const e=g.inject.gameStateModel.stateEngine.getAllDataSets().toArray().map((e=>e.key)),t=g.inject.debugLayers.layers;(0,w.updateDropdownOptions)(B,(0,d.sortedUniq)([...e,...t].sort())),(0,w.setDropdownSelection)(B,g.inject.debugLayers.activeLayerName)}async function j(){try{if(k)return void m.app.audio.playEffect(p.SoundEffects.Deny);k=!0,b.events.trigger(l.UserActions.GoToMapGeneration()),await(0,c.generateMap)(L,(async()=>{await(0,S.sleep)(1)})),m.app.scene.worldMap.syncState(),k=!1,b.events.trigger(l.UserActions.EditMap())}catch(e){console.error(e)}}function F(){L.regions.factions=[{controller:h.FactionController.LocalUser,startingTilesMultiplier:i.mapGen.playerAdvantage},...(0,u.range)(2,i.mapGen.players).map((e=>({controller:h.FactionController.Ai})))],R()}g.inject.theme.use((e=>{M.forEach((t=>{i.palette[t]=T.Colors.toCss(e[t])})),A.forEach((t=>{i.palette.oceanShades[t]=T.Colors.toCss(e.oceanShades[t])}))})),n.add(i.mapGen,"preset",t.generationPresets.map((e=>e.key))).onChange((function(){const e=t.generationPresets.find((e=>e.key===i.mapGen.preset));Object.assign(L.land,(0,d.cloneDeep)(e.land)),Object.assign(L.regions,(0,d.cloneDeep)(e.regions)),n.updateDisplay(),j()})),n.add(L,"seed").onChange(R),n.add(i.mapGen,"randomize"),n.add(L.land,"width",8,40,1).onChange(R),n.add(L.land,"height",8,40,1).onChange(R),n.add(L.land,"smoothness",1,10,.1).onChange(R),n.add(L.land,"water",0,1).onChange(R),n.add(L.land,"inlandForests",0,1).onChange(R),n.add(L.land,"coastalForests",0,1).onChange(R),n.add(L.land,"coastalForestsCohesion",0,1).onChange(R),n.add(L,"generateRegions").onChange(R),n.add(i.mapGen,"players",2,6,1).onChange(F),n.add(i.mapGen,"playerAdvantage",0,3,.1).onChange(F),n.add(L,"regionsVariation",1,9,1).onChange(R),n.add(L.regions,"minCellSize",1,15,1).onChange(R),n.add(L.regions,"maxCellSize",1,15,1).onChange(R),n.add(L.regions,"cellSeparation",0,5,1).onChange(R),n.add(L.regions,"coloration",0,1).onChange(R),n.add(L.regions,"clustering",0,1,.1).onChange(R),n.add(L,"spawnTowns").onChange(R),n.add(L.regions,"startingTiles",1,20,1).onChange(R),n.add(L.regions,"startingCoins",1,20,1).onChange(R),n.add(L.regions,"features",0,5,1).onChange(R),n.add(i.mapGen,"breakpoints").onChange((e=>{b.config.debug.breakpoints=e?["mapgen"]:[]})),M.forEach((e=>{C.addColor(i.palette,e).listen().onChange((t=>g.inject.theme.setDebugOverride({[e]:T.Colors.fromCss(t)})))})),A.forEach((e=>{C.addColor(i.palette.oceanShades,e).name("oceanShades."+e).listen().onChange((e=>g.inject.theme.setDebugOverride({oceanShades:(0,u.mapDictionary)(i.palette.oceanShades,T.Colors.fromCss)})))})),(0,v.createLevelSelectMenu)(o),D(s,e.sections.debug),D(a,e.sections.factions),D(o,e.sections.level),D(n,e.sections.mapgen),D(I,e.sections.colors),D(C,e.sections.palette)}(e),P.show(),e.expand?P.open():P.close()):P?.hide()};const r=a(i(47924)),l=i(36868),c=i(71262),d=i(2543),h=i(24598),u=i(1326),p=i(98963),g=i(91622),m=i(54825),y=i(99545),f=i(94789),w=i(82265),v=i(37485),b=i(56824),S=i(10131),x=i(23382),T=i(96137);let P;const I={expand:!0,sections:{palette:"on",debug:"on",factions:"on",level:"on",mapgen:"on",colors:"on"}},C={minCellSize:3,maxCellSize:6,cellSeparation:2,factions:[{controller:h.FactionController.LocalUser},{controller:h.FactionController.Ai},{controller:h.FactionController.Ai},{controller:h.FactionController.Ai},{controller:h.FactionController.Ai},{controller:h.FactionController.Ai}],cellCohesion:.5,coloration:1,startingTiles:5,startingCoins:10,clustering:0,features:0,featuresPool:[h.PawnType.GoldMine,h.PawnType.Camp]},M=["oceanColor","oceanContrastDark","oceanContrastLight","white"],A=["dark1","dark2","dark3","dark4","dark5","light1","light2","light3"];t.generationPresets=[{key:"small",land:{width:10,height:14,smoothness:4.5,water:.25,inlandForests:.4,coastalForests:.2,coastalForestsCohesion:.6},generateRegions:!0,spawnTowns:!0,regions:{...C,minCellSize:4}},{key:"medium",land:{width:18,height:18,smoothness:7,water:.25,inlandForests:.4,coastalForests:.2,coastalForestsCohesion:.6},generateRegions:!1,spawnTowns:!0,regions:C},{key:"large",land:{width:24,height:24,smoothness:7,water:.25,inlandForests:.5,coastalForests:.2,coastalForestsCohesion:.6},generateRegions:!0,spawnTowns:!0,regions:C}]},67274:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SpecialFaction=void 0,t.createBlankGameState=function(e,t={width:0,height:0}){return{version:o.CORE_GAMESTATE_SCHEMA_VERSION,map:{width:t.width,height:t.height,plugins:[],levelId:e},regions:[],factions:[{id:r.neutral,name:"nature",themeIndex:0,controller:s.FactionController.None,regions:[]},...(0,n.range)(1,a.MAX_FACTIONS_COUNT).map((e=>({id:e,...l(e)})))],pawns:[],currentPhase:{type:s.PhaseTypes.FactionTurn,turnNumber:1,faction:1},hexHistory:{}}},t.getDefaultFactionConfig=l;const s=i(24598),n=i(1326),o=i(62643),a=i(75742);var r;function l(e){return{name:`Player ${e}`,themeIndex:e-1,controller:1===e?s.FactionController.LocalUser:s.FactionController.Ai,regions:[]}}!function(e){e[e.neutral=0]="neutral"}(r||(t.SpecialFaction=r={}))},67410:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MenuButtonPanel=void 0;const s=i(49527),n=i(80959),o=i(76049),a=i(91622),r=i(56824),l=i(36868),c=i(86545),d=i(56622),h=i(11466),u=i(96604),p={width:100,height:42},g={width:42,height:42};class m extends c.BaseResponsiveContainer{constructor(e){super(e),this.width=p.width,this.height=p.height;const t=n.UiBuilder.for(e),i=new u.IconAndText(e,{icon:t.image("ui/button-icons/menu"),tintIcon:!0,layout:u.BUTTON_LAYOUT.iconLeft,text:t.text("Menu",o.BitmapFont.MiniBold,0),spacing:8});this.button=new s.StealthButton_LEGACY(e,{radius:{tl:8,tr:8,bl:0,br:0},content:i,onClicked:()=>{r.events.trigger(l.UserActions.TogglePlayMenu())},colors:e=>({background:{color:e.oceanShades.light1,alpha:.85},highlight:{color:e.oceanShades.light2,alpha:1},content:e.oceanContrastDark}),height:this.height,width:this.width}),a.inject.theme.use((e=>{i.text?.setTint(e.oceanContrastDark),i.icon?.setTint(e.oceanContrastDark),this.updateLayout()})),this.add([this.button])}setRadius(e){this.button.setRadius(e)}updateLayout(){let e;(0,d.getUndoButtonX)(this.scene)-p.width-4<0?(e=g,this.button.content?.setText(void 0)):(e=p,this.button.content?.setText("Menu")),this.button.setSize(e.width,e.height),0===this.scene.bounds.contentLeft?(this.setRadius({tl:0,tr:8,bl:0,br:0}),this.setPosition(0,this.scene.bounds.height-e.height)):(this.setRadius({tl:8,tr:8,bl:0,br:0}),this.setPosition(this.scene.bounds.contentLeft+h.DEFAULT_CONTENT_PADDING,this.scene.bounds.height-this.height))}}t.MenuButtonPanel=m},67630:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvertedMapProjection=void 0;const s=i(1326),n=i(83874),o=i(20026),a=i(88023);class r extends n.MultiMapDataSet{constructor(e,t){super(e),this.key=e,this.source=t,this.parents=[this.source]}bootstrap(e){const t=(0,o.selectFromState)(e,this.source);if(!t)return(0,a.ImmutableMap)();const i=[];if(!a.ImmutableMap.isMap(t))throw console.error(t),new Error(`${this.source.key} is invalid source for InvertedMapProjection: ${t} is not an ImmutableMap instance`);return t.forEach(((e,t)=>{(0,s.pushIntoArrayByKey)(i,e,t)})),n=i,(0,a.ImmutableMap)().withMutations((e=>{for(let[t,i]of Object.entries(n))e.set(Number(t),(0,a.ImmutableSet)(i))}));var n}update(e,t,i){const s=t.require(this.source),a=new n.MultiMapMutationBuilder(this,e);return s.updated?.forEach((([e,t])=>{const s=(0,o.selectFromState)(i,this.source,e);void 0!==s&&a.remove(s,e),void 0!==t&&a.add(t,e)})),a.createMutation(this.source.key+" changed")}entryToString(e){return`[${e.size}]`}}t.InvertedMapProjection=r},67713:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintPawnTool=void 0;const s=i(24598),n=i(63521),o=i(91622),a=i(57189);t.PaintPawnTool=class{constructor(e,t,i={}){this.pawnType=e,this.iconRecipe=t,this.customOptions=i,this._displayName=(0,a.pawnTypeToStr)(this.pawnType),this.options={title:`Place ${this._displayName}`,description:`click = add ${this._displayName}\nctrl-click = remove objects`,...this.customOptions}}useOn(e,t){const i=o.inject.gameStateModel,a=i.pawns.byHex(e).find((e=>e.hasTrait(n.PawnTraits.OccupiesTile)));i.regions.byHex(e)&&(t.ctrl&&a?(a.destroy(),i.pawns.findOne({hexes:e,type:[s.PawnType.Coins]})?.destroy()):a?a.type!==this.pawnType&&a.replaceWith(this.pawnType):i.pawns.create({hex:e,type:this.pawnType}))}}},67862:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapCameraController=void 0,t.inverseDirection=function(e){if(!e)return e;switch(e){case"up":return"down";case"down":return"up";case"left":return"right";case"right":return"left"}};const s=i(95613),n=i(30963),o=i(49796),a=i(91622),r=i(54825),l=i(9292),c=i(86148);var d=Phaser.Geom.Rectangle;t.WorldMapCameraController=class{constructor(e){this.scene=e,this.viewPortMargins={left:0,right:0,top:0,bottom:0},this.camera=this.scene.cameras.main,this.camera.roundPixels=!0,this.zoomController=new n.CameraZoomController({name:"WorldMap.Zoom",camera:this.camera,pointersTracker:e.pointersTracker}),this.scrollController=new s.CameraScrollController(this.camera),this.zoomController.zoomTo(n.DEFAULT_CAMERA_ZOOM/a.inject.ui.scale(),"instant")}setViewportMargins(e){const{x:t,y:i}=this.camera,s={left:0,right:0,bottom:0,top:0,...e},n=(s.left-t)/this.camera.zoom,o=(s.top-i)/this.camera.zoom;this.viewPortMargins=s,this.updateViewPort(),this.updateBounds(),this.scrollController.cameraX.setTo(this.scrollController.cameraX.value+n),this.scrollController.cameraY.setTo(this.scrollController.cameraY.value+o)}isHexVisible(e){const t=e.getDisplayBoundingBox(),i=this.camera.worldView;return d.Overlaps((0,o.rectToPhaser)(t),i)}updateBounds(e){this.worldBounds=this.scene.mode.calculateWorldBounds(),a.inject.debugData.set("worldBounds",`${this.worldBounds.x},${this.worldBounds.y},${this.worldBounds.width},${this.worldBounds.height}`),this.updateCameraBounds()}updateCameraBounds(){if(!this.worldBounds)return;const e=this.camera.width/2,t=this.camera.height/2,i=new d(this.worldBounds.x-e,this.worldBounds.y-t,this.worldBounds.width+2*e,this.worldBounds.height+2*t);return this.scrollController.setBounds(i),a.inject.debugData.set("camBounds",`${i.x},${i.y} -> ${i.width},${i.height}`),i}async centerAboveControlPanel(e=0){this.updateBounds(),this.camera.preRender(),await this.scrollController.panTo(this.worldBounds.centerX,this.worldBounds.height-this.camera.displayHeight/2+c.EXTRA_SPACE_FOR_CONTROL_PANEL/2,e)}async center(e=0,t={}){this.updateBounds(t.zoom),this.camera.preRender(),t.zoom&&this.zoomController.zoomTo(t.zoom,e),await this.scrollController.panTo(this.worldBounds.centerX+(t.offsetX||0),this.worldBounds.centerY+(t.offsetY||0),e,t.zoom)}savePreset(){return{x:this.camera.midPoint.x,y:this.camera.midPoint.y,distance:this.zoomController.currentZoom}}async panTo(e,t=0){const i=1/e.distance;await Promise.all([this.scrollController.panTo(e.x,e.y,t,i),this.zoomController.zoomTo(e.distance,t)])}async panAway(e,t=1e3){this.updateBounds();const[i,s]=[this.camera.midPoint.x,this.camera.midPoint.y],n={up:[i,s+this.camera.worldView.centerY+this.worldBounds.height+100],down:[i,s-this.camera.worldView.centerY-this.worldBounds.height-100],left:[i+this.worldBounds.centerX+this.worldBounds.width+100,s],right:[i-this.worldBounds.centerX-this.worldBounds.width-100,s]};let[o,a]=n[e];await this.scrollController.panTo(o,a,t)}async panIntoCenter(e,t=1e3,i=0){this.updateBounds();const[s,n]=[this.camera.midPoint.x+i,this.camera.midPoint.y],o={down:[s,this.worldBounds.height+r.app.device.screenHeight],up:[s,-this.camera.displayHeight],left:[-this.camera.displayWidth+i,n],right:[this.camera.displayWidth+i,n]};let[a,l]=o[e];await this.scrollController.panTo(a,l),await this.center(t,{offsetX:i})}async ensureRectVisible(e,t={}){const i=t.padding??40,s=t.allowZoom??!0;let a=d.Clone(this.camera.worldView),c=this.zoomController.currentZoom;if(a.bottom-=r.app.scene.playUI.getBottomPanelHeight()+5,0!==a.width){if(r.app.scene.worldMap.debugOverlay.showDebugRectangle(e),!d.ContainsRect(a,e)){for(e=d.Inflate(e,i,i);(e.width>a.width||e.height>a.height)&&s;){const e=n.CAMERA_ZOOM_LEVELS.find((e=>e>c));if(!e)break;console.warn(`increasing distance from ${c} to ${e}`),c=e,d.Inflate(a,a.width/2,a.height/2)}let t=a.centerX,h=a.centerY;const u=a.x-e.x,p=e.right-a.right,g=a.y-e.y,m=e.bottom-a.bottom;e.width>a.width?t=e.left+e.width/2:u>0?t-=u:p>0&&(t+=p),e.height>a.height?h=e.top+e.height/2:g>0?h-=g:m>0&&(h+=m);const y=Math.abs(this.zoomController.currentZoom-c),f=(0,l.pickLarger)((0,o.manhattanDistance)({x:a.centerX,y:a.centerY},{x:t,y:h}),100*y);r.app.scene.worldMap.debugOverlay.showDebugPoint(t,h),await this.panTo({x:t,y:h,distance:c},f)}}else console.warn("viewRect is 0 width")}startDragScroll(){this.scrollController.startDrag()}stopDragScroll(){this.scrollController.stopDragging()}updateViewPort(){const e=this.viewPortMargins,t=this.scene.bounds.width-e.right-e.left,i=this.scene.bounds.height-e.top-e.bottom;this.camera.setSize(t,i)}update(e,t){this.zoomController.update(e,t),this.scrollController.update(e,t)}}},67878:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseToolWidget=t.PaintTabContent=void 0;const s=i(86545),n=i(55275),o=i(98886),a=i(80959),r=i(36014),l=i(20034),c=i(56824),d=i(15956),h=i(25988),u=i(20087),p=i(76540),g=i(36257);class m extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=a.UiBuilder.for(this.scene),this.palette=new o.MapEditorPalette(this.scene),this.widgets=new d.WidgetsContainer(this.scene),this.helpWidget=new y(this.scene),this.currentState=(0,n.stateContainer)({selectedTool:null,paletteLayout:o.EMPTY_PALETTE_LAYOUT},((e,t,i,s)=>{void 0!==e.selectedTool&&(this.palette.select(e.selectedTool??void 0),e.selectedTool?.options?(this.helpWidget.setVisible(!0),this.helpWidget.setProps(e.selectedTool.options),this.helpWidget.setIcon((0,g.createIcon)(this.scene,e.selectedTool.iconRecipe))):this.helpWidget.setVisible(!1)),e.paletteLayout&&this.palette.setContent(e.paletteLayout)})),this.widgets.width=this.width,this.widgets.setWidgets([this.helpWidget]),this.add([this.widgets,this.palette])}calculateHeight(){return this.widgets.y+this.widgets.height}updateLayout(){this.palette.x=p.PALETTE_PADDING,this.palette.updateSize(),this.widgets.width=this.width,u.Arrange.topToBottom({content:[this.palette,this.widgets],spacing:8,y:8}),this.updateSize()}}t.PaintTabContent=m;class y extends h.SideBarWidget{constructor(e){super(e,{title:"?"}),this.brushToggle=new r.Toggle(this.scene,{options:[{value:"single-hex",icon:"editor/single-hex-brush"},{value:"9-hexes",icon:"editor/multi-hex-brush"},{value:"flood",icon:"editor/flood-fill"}],width:100,height:32,enabled:!0,theme:e=>({...r.ToggleThemes.onCard(e)}),onSelected:e=>{c.events.trigger(l.MapEditorActions.SelectBrush(e))}}),this.text=a.UiBuilder.for(e).richText("[b]?[/b]",(e=>e.white)),this.setContent(this.text),this.add(this.brushToggle)}setProps(e){this.setTitle(e.title),this.text.setText(e.description),this.brushToggle.setVisible(!!e.allowLargeBrushes),this.preUpdate.makeDirty()}updateLayout(){super.updateLayout(),u.Arrange.place(this.brushToggle,{right:this.width-8,top:8})}}t.BaseToolWidget=y},68188:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UserContentService=void 0;const s=i(21473),n=i(56824),o=i(35800),a=i(66143),r=i(85026),l=i(61598),c=i(36868),d=n.logger.for("UserContent");t.UserContentService=class{constructor(e){this.storage=e,this.favoriteLevelsCache=new Set}isAvailable(){return this.storage.isAvailable()}async initialize(){await this.storage.initialize();const e=await this.storage.getAllLevelIds("favorite-island");this.favoriteLevelsCache=new Set(e)}async saveReplay(e,t,i){const c=s.ReplayModel.for(e);d.info(`Storing replay for ${c.levelId} (${c.turnCount} turns)`),await this.storage.storeContent({type:"replay",id:n.random.id(o.ID_TYPE.UserContent),levelId:c.levelId,title:a.LevelModel.for(c.levelId).getName(c.initialSnapshot),replay:(0,r.encodeReplay)(e),lastInteraction:i??Date.now(),created:i??Date.now(),outcome:t,origin:"local"}),await this.storage.keepOnlyLatest("replay",l.LAST_PLAYED_HISTORY_SIZE)}async getLastPlayedList(){return this.storage.getLatestByType("replay")}async importReplay(e){const t=(await this.getLastPlayedList()).find((t=>"file-import"===t.origin&&t.replay===e));if(t)this.storage.touchContent(t.id);else{const t=(0,r.decodeReplay)(e),i=s.ReplayModel.for(t);this.storage.storeContent({type:"replay",id:n.random.id(o.ID_TYPE.UserContent),levelId:i.levelId,title:t.meta.title,replay:e,origin:"file-import",lastInteraction:Date.now(),created:Date.now(),outcome:void 0})}}async deleteContent(e){await this.storage.deleteContent(e),n.events.trigger(c.SystemEvents.MyIslandsChanged({removed:[e]}))}getFavorites(){return this.storage.getLatestByType("favorite-island")}isInFavorites(e){return this.favoriteLevelsCache.has(e)}getMyIslands(){return this.storage.getLatestByType("my-island")}async saveMyIsland(e){return this.storage.storeContent(e)}async addToFavorites(e,t){if(this.favoriteLevelsCache.has(e))return void d.warning("Tried to add favorite that already exists",e);const i=a.LevelModel.for(e),s=t??i.getStartingState();if(!s)throw new Error(`Cannot add favorite level ${e} without starting state`);const l=(await this.storage.getAllByLevelId("replay",e)).find((e=>"local"===e.origin));await this.storage.storeContent({type:"favorite-island",id:n.random.id(o.ID_TYPE.UserContent),levelId:e,title:a.LevelModel.for(e).name,created:Date.now(),lastInteraction:Date.now(),startingGameState:(0,r.encodeGameState)(s),bestReplay:l?.replay}),this.favoriteLevelsCache.add(e),n.events.trigger(c.SystemEvents.FavoriteLevelsChanged({added:[e]}))}async removeFromFavorites(e){const t=await this.storage.getByLevelId("favorite-island",e);t?(await this.storage.deleteContent(t.id),this.favoriteLevelsCache.delete(e),n.events.trigger(c.SystemEvents.FavoriteLevelsChanged({removed:[e]}))):d.warning("Tried to remove favorite that does not exist",e)}}},68243:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Firebase=t.FirebaseFacade=void 0;const s=i(55577),n=i(65052),o=i(79815),a=i(40081),r=i(37208),l=i(21992),c=i(56824),d=c.logger.for("Firebase");class h{initialize(e){this.app=(0,s.initializeApp)({apiKey:"AIzaSyBmeS83yP2kyjZ3RZ6hHniLsCQ3V4H6Nq4",authDomain:"konkr-io.firebaseapp.com",projectId:"konkr-io",storageBucket:"konkr-io.appspot.com",messagingSenderId:"892701750301",appId:"1:892701750301:web:87bc46832d0fa3902a42f4",measurementId:"G-4JS2TP1WG6"}),this.auth=(0,n.getAuth)(this.app),this.db=(0,o.initializeFirestore)(this.app,{ignoreUndefinedProperties:!0}),(0,r.isSupported)().then((e=>{try{if(!e)return void d.warning("Analytics not supported");this.analytics=(0,r.initializeAnalytics)(this.app,{config:{allow_ad_personalization_signals:!1}})}catch(e){c.errors.handleNonFatalError(e,"Firebase.initializeAnalytics")}})),(0,a.isSupported)().then((t=>{if(!t)return void d.warning("RemoteConfig not supported");this.remoteConfig=(0,a.getRemoteConfig)(this.app),this.remoteConfig.defaultConfig=e.remoteConfigDefaults;const i=(0,l.minutesToMilliseconds)(15);this.remoteConfig.settings.minimumFetchIntervalMillis=i/2,this.refreshRemoteConfig(),setInterval((()=>this.refreshRemoteConfig()),i)}))}refreshRemoteConfig(){(0,a.fetchAndActivate)(this.remoteConfig).then((()=>{})).catch((e=>{c.errors.handleNonFatalError(e,"refreshRemoteConfig.fetchAndActivate")}))}}t.FirebaseFacade=h,t.Firebase=new h},68299:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScrollableTextDialog=void 0;const s=i(5365),n=i(63032),o=i(2543),a=i(54118),r=i(7297),l=i(9292);t.ScrollableTextDialog=class{constructor(){this.onLoad=o.noop}getTitle(e){return e.title}getContent(e,t,i){const s=(0,l.pickSmaller)(600,i.width),n=(0,l.pickSmaller)(400,i.height);return this.div||(this.div=new r.ScrollableText(e,{text:t.text,height:n}),this.layout=new a.VLayout(e,{content:[this.div],spacing:16,width:s})),this.div.setText(t.text),this.layout.preUpdate.force(),this.layout}getButtons(){return[{text:s.DialogButtons.OK,role:n.DialogButtonRole.Regular}]}}},68415:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.migrateUserData=async function(e){try{await(0,n.migrateFromV1)(),await(0,o.migrateFromV2)(e),s.storage.getItem("konkr.userData.v1.backup")&&s.storage.removeItem("konkr.userData.v1.backup")}catch(e){s.errors.handleNonFatalError(e,"User data migration failed!")}};const s=i(56824),n=i(57246),o=i(52979);s.logger.for("migrate")},68544:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BuyTownsPlugin=void 0;const s=i(18497),n=i(24598),o=i(1326);t.BuyTownsPlugin={name:s.PluginKey.BuyTowns,displayName:"Buy Towns",icon:"ui/level-features/buy-towns",register(e){e.rules.adjustBuyableObjects.register(((e,[t])=>(0,o.stripDuplicatesFrom)([...e,n.PawnType.Town]))),e.rules.adjustRuleset.register((e=>({...e,pawns:{...e.pawns,[n.PawnType.Town]:{...e.pawns[n.PawnType.Town],cost:20}}})))}}},68649:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CreditShiftReason=t.DefaultAIDataLayer=t.DummyAIDataLayer=void 0,t.calculateAttritionImpact=v;const s=i(24598),n=i(97849),o=i(70712),a=i(63521),r=i(56824),l=i(90952),c=i(91622),d=i(36868),h=i(9292),u=i(80268),p=i(20026),g=i(13560),m=i(78635),y=i(90824);var f;function w(e){const{from:t,to:i,mutator:s,reason:n,sourceHex:a}=e,r=t.creditOf(i),l=o.AI.changeFactionCredit(t.state,t.id,i.id,s),c=(0,p.getParentEngine)(l);c.commitTransaction();const h=s(r);return d.GameStateEvents.FactionCreditChanged({fromFactionId:t.id,towardsFactionId:i.id,creditDelta:h-r,reason:n,stateBefore:e.stateBefore,stateAfter:c.currentState,sourceHex:a})}function v({model:e,stateBeforeAttack:t,destroyedPawns:i,victimRegions:s,regionWasAlive:n,hex:o,regionWasBankrupt:a}){if(n){const r=s.filter((e=>!e.isAlive())),l=s.filter((e=>e.isAlive()));let c=g.AssetValue.getTotal(t,o,!0,a);if(0===i.length){const u=m.Warfare.model(t).getOccupyingUnit(o);u&&!a&&(c-=g.AssetValue.total(g.AssetValue.getPawnFactors(u.type,1)))}function d(){let e=0;for(let t of r)e+=b(t);return e}return c+d()+function(e,t){e.sort(((e,t)=>e.size-t.size));const i=e.slice(1).map((e=>e.budget.incomeFromHexes)).reduce(h.sum,0)/10,s=e.filter((e=>e.isBankrupt()));return i+(t?0:s.map(S).reduce(h.sum,0))}(l,a)}return 0}function b(e){let t=0;for(let i of e.hexes)t+=g.AssetValue.getTotal(e.state,i);return t}function S(e){let t=0;for(let i of e.getPawns())i.hasTrait(a.PawnTraits.Unit)&&(t+=g.AssetValue.total(g.AssetValue.getPawnFactors(i.type,1)));return t}function x(e,t){for(let i of e)"GAME_STATE.FACTION_CREDIT_CHANGED"===i.name&&(i.payload.stateAfter=t)}r.logger.for("AiDataLayer"),t.DummyAIDataLayer=class{onHexCaptured(e){}onTurnEnd(e,t){}onTurnStart(e,t){}onReceivedGift(e){}},t.DefaultAIDataLayer=class{onHexCaptured(e){const{model:t,attackerFaction:i,destroyedPawns:l,victimRegions:c,regionWasAlive:d,regionWasBankrupt:p,stateBeforeAttack:g,hex:m}=e,b=[];(0,n.assert)(c.length>0,"victimRegions should never be empty");const S=c[0].faction;return l.some((e=>e===s.PawnType.HauntedTown))?(t.stateEngine.transaction((()=>{const e=t.factions.all().filter((e=>e.controller!==s.FactionController.None&&e!==S&&e!==i&&e.persona.race!==y.Race.Undead&&e.isAlive()));for(let t of e)b.push(w({stateBefore:g,from:t,to:i,mutator:e=>e+.1,reason:f.ObservedAttack,sourceHex:m}))})),x(b,t.state),b):S?.isNeutral()||!d?[]:(t.stateEngine.transaction((()=>{const n=o.AI.getFactionAttrition(t.state,i.id,S.id)-o.AI.getFactionAttrition(t.state,S.id,i.id),p=c.filter((e=>e.isAlive()));let x=v(e);const T=-x/o.AI.getFactionRawPower(g,S.id),P=.75*x/o.AI.getFactionRawPower(g,i.id);if(x<0&&(r.errors.handleNonFatalError(`encountered negative attrition impact (${x}) after ${e.hex.id} captured by faction ${i.id}`,"AIDataLayer.onHexCaptured"),x=0),l.some((e=>t.rules.pawns(e).hasTrait(a.PawnTraits.Undead)))&&(x=(0,h.pickLarger)(0,x-10)),p.length>0){const e=x/p.length;o.AI.inflictRegionAttrition(t.state,p.map((e=>e.id)),i.id,e)}else o.AI.inflictGlobalAttrition(t.state,S.id,i.id,x);if(d&&x>0&&(b.push(w({stateBefore:g,from:S,to:i,mutator:e=>e+T,reason:f.Attacked,sourceHex:m})),b.push(w({stateBefore:g,from:i,to:S,reason:f.Attacking,mutator:e=>e+P,sourceHex:m}))),x>=10){const e=t.factions.all().filter((e=>e.controller!==s.FactionController.None&&e!==S&&e!==i&&e.isAlive()&&e.persona.race!==y.Race.Undead));for(let t of e){const e=u.AIPolitics.getCreditReactionToThirdPartyConquest({stateBeforeAttack:g,attritionImpact:x,casusBeliStrength:n,victimFaction:S,attackerFaction:i,me:t});0!==e&&b.push(w({stateBefore:g,from:t,to:i,mutator:t=>t+e,reason:f.ObservedAttack,sourceHex:m}))}}})),x(b,t.state),b)}onTurnEnd(e,t){if(t.controller===s.FactionController.None)return[];const i=[];return e.stateEngine.activate(...l.EXPENSIVE_AI_PROJECTIONS),e.stateEngine.transaction((()=>{!function(e,t){o.AI.changeFactionAttrition(e.state,t.id,(e=>Math.floor(.5*e)))}(e,t),i.push(...function(e,t){const i=[];return e.factions.all().filter((e=>e.controller!==s.FactionController.None&&e!==t&&e.isAlive())).forEach((s=>{i.push(w({stateBefore:e.state,from:s,to:t,mutator:()=>function(e,t){const i=e.state,s=e.creditOf(t),a=-.1*s,r=c.inject.views.behaviorSummary.get(i,t.id);if(r.mightUsedForConquest[e.id]>0)return s+a;if(0===r.totalMight)return s+a;const l=r.totalMightUsed/r.totalMight/2,d=r.unusedMight/r.totalMight*2,u=(c.inject.views.factionNeighboursView.get(i,t.id)[e.id]??0)/e.scaledPower,p=c.inject.views.fear.get(i,{fromFactionId:e.id,towardsFactionId:t.id}),g=p>0?1-(0,h.cropNumber)(p/100*e.basePersonality.ambitious,0,1):1,m=o.AI.getFactionAttrition(i,e.id,t.id),y=m>0?(0,h.cropNumber)(1/(m-1),0,1):1,f=l+d,w=a+u*f*y*g;return(0,n.assert)(l<=1&&l>=0,`mightUsedElseWhere ${l} out of sane range`),(0,n.assert)(f>=0),(0,n.assert)(y>=0),(0,n.assert)(g>=0),s+w}(s,t),reason:f.EndOfTurnAdjustment}))})),i}(e,t))})),x(i,e.state),i}onTurnStart(e,t){}onReceivedGift(e){if(e.fromFaction===e.toFaction)return[];const t=5*e.giftValue/e.toFaction.powerFactors.economic,i=o.AI.getFactionAttrition(e.model.state,e.toFaction.id,e.fromFaction.id),s=(0,h.cropNumber)(t-i/100,0,.2);return[w({stateBefore:e.model.state,from:e.toFaction,to:e.fromFaction,reason:f.ReceivedGift,mutator:e=>e+s})]}},function(e){e.EndOfTurnAdjustment="end-of-turn-adjustment",e.Attacked="attacked",e.ObservedAttack="observed-attack",e.Attacking="attacking",e.ReceivedGift="received-gift"}(f||(t.CreditShiftReason=f={}))},68778:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseEntityModel=void 0;const s=i(97849);t.BaseEntityModel=class{constructor(e,t){this.parentModel=e,s.assert.defined(t),this.id=t}updateFrom(e){return this.parentModel.state=e,this}get state(){return this.parentModel.state}set state(e){this.parentModel.state=e}}},68785:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ButtonCard=void 0;const s=i(80959),n=i(76049),o=i(46973),a=i(96604);class r extends o.RoundedRectButton{constructor(e,t){const i=s.UiBuilder.for(e);super(e,{content:new a.IconAndText(e,{text:i.text(t.title,n.BitmapFont.Main,(e=>e.white)),spacing:0,tintIcon:!1,layout:a.BUTTON_LAYOUT.iconLeft}),theme:o.RoundedRectButton.Themes.subtle,onClicked:t.onClicked})}}t.ButtonCard=r},68790:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createDiplomacyDebugLayer=function(){function e(e,t){return o.Factions.model(e).all().filter((e=>e.controller!==a.FactionController.None&&e.id!==t&&e.isAlive())).map((i=>{const s=i.id,a=r.inject.views.fear.get(e,{fromFactionId:t,towardsFactionId:s}),l=o.Factions.model(e).byId(s),c=o.Factions.model(e).byId(t);return{id:s,myHostilityTowardsThem:r.inject.views.hostility.calculate(e,{attacker:c,victim:l}),myOpenHostilityTowardsThem:h.AIPolitics.getOpenHostilityTowards(e,l,c.id),myHostilityFactors:h.AIPolitics.getHostilityFactors(e,l,c.id),myCreditOfThem:n.AI.getFactionCredit(e,t,s),theirCredit:c.creditOf(l),myFearOfThem:a,theirTotalAttrition:Object.values(n.AI.getFactionAttrition(e,s)).reduce(y.sum,0),theirAttritionInflictedByMe:n.AI.getFactionAttrition(e,s,t),myAttritionInflictedByThem:n.AI.getFactionAttrition(e,t,s)}})).sort(((e,t)=>t.myCreditOfThem-e.myCreditOfThem))}function t(e,t){const i=u.Regions.model(e).byHex(t),s=i?.faction,n=i?.getTownHexes().members[0]===(0,g.getHex)(t);return m.Pawns.model(e),{myFaction:s,isTownHex:n,myRegion:i}}return new s.GameStateDebugLayer((0,p.hexBasedAdapter)({getValue(i,s){const{myFaction:n,isTownHex:o,myRegion:a}=t(i,s);if(!(a&&n&&n.isAlive()&&o))return;const d=e(i,n.id),h=r.inject.views.powerBalance.get(i),u=h.factionsByPower.indexOf(n)+1,p=1===u?h.dominance:0,g=r.inject.views.factionDiplomacyScore.get(i,n.id);let m=[],y="";1===u&&(y=`${l.GLYPH.redFlag}${p}${h.is1v1situation?" (1V1)":""} `);const f=`DS${(100*g).toFixed()}`,w=`C${(100*n.confidence).toFixed()}`;m.push(`${(0,c.withOrdinalSuffix)(u)} ${y}${w} ${f}`);for(let e of d.sort(((e,t)=>t.id-e.id))){const t=(100*e.myHostilityTowardsThem).toFixed(0),i=(100*e.myOpenHostilityTowardsThem).toFixed(0),s=e.myHostilityFactors;let n=[s.creditBoost?"c"+(0,c.withSign)(s.creditBoost):void 0,s.fearBoost?"f"+(0,c.withSign)(s.fearBoost):void 0,s.combativeBoost?"d"+(0,c.withSign)(s.combativeBoost):void 0,s.fightBackBoost?"fb"+(0,c.withSign)(s.fightBackBoost):void 0,s.rivalryBoost?"r"+(0,c.withSign)(s.rivalryBoost):void 0].filter((e=>e)).join(" ");n&&(n=`(${n})`);const o=[e.myAttritionInflictedByThem?`${l.GLYPH.defense}${e.myAttritionInflictedByThem}`:"",e.theirAttritionInflictedByMe?`${l.GLYPH.sword}${e.theirAttritionInflictedByMe}`:""].filter((e=>e)).join("");m.push(`${l.GLYPH.factions[e.id]} ${i}/${t} ${n} ${o}`)}return m.join("\n")},getDetail(i,s){const{myFaction:n,myRegion:o}=t(i,s);if(!o||!n||!n.isAlive())return;const a=n.basePersonality,h=n.getCurrentPersonality(),u=e(i,n.id),p=`daring: ${a.daring} ----[F ${(100*n.relativeForecast).toFixed()}]-> ${h.daring.toFixed(2)}\ncombative: ${a.combative} -[P ${(100*n.relativeScaledPower).toFixed()}]-> ${h.combative.toFixed(2)}`,g=`${l.GLYPH.factions[0]} Cred Fear    DS`,m=r.inject.views.factionDiplomacyScore.getComponents(i,n.id);return p+"\n"+g+"\n"+u.map((e=>{const t=(0,d.padLeft)((0,c.withSign)(100*e.myCreditOfThem,0),4),i=(0,d.padLeft)((0,c.withSign)(e.myFearOfThem,0),4),s=(0,d.padLeft)((m.find((t=>t.factionId===e.id))?.effect??0).toFixed(),5);return`${l.GLYPH.factions[e.id]} ${t} ${i} ${s}`})).join("\n")}}))};const s=i(76439),n=i(70712),o=i(19618),a=i(24598),r=i(91622),l=i(19506),c=i(7334),d=i(8358),h=i(80268),u=i(56038),p=i(12543),g=i(45664),m=i(81434),y=i(9292)},68871:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SidebarButtons=t.SIDEBAR_BUTTONS=void 0,t.shouldShowFullScreenButton=w,t.shouldShowToggleSoundButton=v,t.shouldShowNoButtons=b,t.shouldShowOnlySettingsButton=S;const s=i(54825),n=i(20087),o=i(52528),a=i(91622),r=i(36868),l=i(51496),c=i(56643),d=i(80959),h=i(11466),u=i(21817),p=i(56824),g=i(80374),m=i(86545),y=i(1187);t.SIDEBAR_BUTTONS={levelMenu:{icon:"ui/button-icons/menu",tooltip:"Open level menu",onClicked:()=>{p.events.trigger(r.UserActions.TogglePlayMenu())}},close:{icon:"ui/button-icons/exit",tooltip:"Close sidebar menu",onClicked:()=>{s.app.screen.play.isPlayMenuOpen&&p.events.trigger(r.UserActions.TogglePlayMenu())}},settings:{icon:"ui/button-icons/settings",tooltip:"Settings",onClicked:()=>{a.inject.ui.sidebarMode.set(u.SideBarMode.Settings)}},bugReport:{icon:"ui/button-icons/bug-report",tooltip:"Open feedback form",onClicked:()=>{a.inject.ui.sidebarMode.set(u.SideBarMode.BugReport)}},help:{icon:"ui/button-icons/help",tooltip:"Open help",onClicked:()=>{l.track.interaction("help"),s.app.navigator.currentScreen===s.app.screen.title?window.open(c.HtmlDocs.about.url,"_blank"):p.events.trigger(r.UserActions.ShowHelp())}},muteSoundEffects:{icon:"ui/button-icons/sound-on",tooltip:"Mutes sound",onClicked:()=>{p.events.trigger(r.UserActions.SetAudioVolume({enabled:!1}))}},unMuteSoundEffects:{icon:"ui/button-icons/sound-off",tooltip:"Enabled sound",onClicked:()=>{p.events.trigger(r.UserActions.SetAudioVolume({enabled:!0}))}},enableFullscreen:{icon:"ui/button-icons/fullscreen-enter",tooltip:"Enable fullscreen mode",onClicked:()=>{p.events.trigger(r.UserActions.SetFullScreenMode(!0))}},disableFullscreen:{icon:"ui/button-icons/fullscreen-exit",tooltip:"Disable fullscreen mode",onClicked:()=>{p.events.trigger(r.UserActions.SetFullScreenMode(!1))}}};class f extends m.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=d.UiBuilder.for(this.scene),this.buttons=new y.GameObjectList(((e,t,i)=>(i?(i.content.setIcon(e.icon),i.onClicked.unsubscribeAll(),i.onClicked(e.onClicked)):(i=this.ui.stealthButton({width:o.SIDEBAR_LAYOUT.buttons.width,height:o.SIDEBAR_LAYOUT.buttons.height,onClicked:e.onClicked,theme:"dark",icon:{image:e.icon,tintWithText:!0},iconPlacement:"left"}),this.add(i)),i.setTooltip(e.tooltip),i))),this.sideButtonsBackground=this.ui.roundedRect(o.SIDEBAR_LAYOUT.buttons.radius,(e=>({color:e.oceanColor,alpha:o.SIDEBAR_LAYOUT.background.alpha}))),a.inject.ui.sidebarMode.watchFuture((()=>this.updateLayout())),this.add(this.sideButtonsBackground),this.scene.sound.on("mute",(()=>this.updateLayout())),this.scene.sound.on("unmute",(()=>this.updateLayout()))}getAvailableButtons(){if(a.inject.ui.sidebarMode())return[];const e=[];return b()?[]:S()?[t.SIDEBAR_BUTTONS.settings]:((0,g.isInMenu)()&&e.push(t.SIDEBAR_BUTTONS.close),e.push(...this.getContextualButtons()),v()&&e.push(s.app.audio.mute?t.SIDEBAR_BUTTONS.unMuteSoundEffects:t.SIDEBAR_BUTTONS.muteSoundEffects),w()&&e.push(s.app.game.scale.isFullscreen?t.SIDEBAR_BUTTONS.disableFullscreen:t.SIDEBAR_BUTTONS.enableFullscreen),e)}hide(){this.buttons.set([])}getContextualButtons(){return s.app.device.uiVariant()!==h.UiVariant.Compact||(0,g.isInMenu)()?[t.SIDEBAR_BUTTONS.settings,t.SIDEBAR_BUTTONS.bugReport,t.SIDEBAR_BUTTONS.help]:s.app.navigator.currentScreen===s.app.screen.play?[t.SIDEBAR_BUTTONS.levelMenu]:[t.SIDEBAR_BUTTONS.settings]}updateLayout(){s.app.device.updateScreenSize();const e=this.getAvailableButtons();this.buttons.set(e);const t=this.buttons.get();n.Arrange.topToBottom({content:t,origin:0,y:o.SIDEBAR_LAYOUT.buttons.padding,spacing:0}),n.Arrange.alignX({content:t,x:this.width/2,origin:.5});const i=t[t.length-1];i?(this.sideButtonsBackground.setVisible(!0),this.sideButtonsBackground.setSize(this.width,i.y+i.height+o.SIDEBAR_LAYOUT.buttons.padding)):this.sideButtonsBackground.setVisible(!1),this.updateSize()}calculateHeight(){return this.sideButtonsBackground.height}}function w(){return!(s.app.device.uiVariant()===h.UiVariant.Compact&&!(0,g.isInMenu)())&&s.app.device.isFullScreenAvailable()}function v(){return!(s.app.device.uiVariant()===h.UiVariant.Compact&&!(0,g.isInMenu)())}function b(){return s.app.navigator.currentScreen===s.app.screen.victory||s.app.navigator.currentScreen===s.app.screen.defeat}function S(){return!(0,g.isInMenu)()&&s.app.navigator.currentScreen===s.app.screen.mapEditor}t.SidebarButtons=f},68878:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isViewingReplay=function(){const e=s.app.scene.play.mode;return e instanceof n.SpectatorMode&&(e.context===o.SpectatingContext.LiveReplay||e.context===o.SpectatingContext.ReplayOnly)},t.isPlayingEditorLevel=function(){return a.inject.editorSession.isActive()};const s=i(54825),n=i(97869),o=i(27700),a=i(91622)},68961:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinPile=t.StackType=void 0;const s=i(56824),n=i(94233),o=i(87936),a=i(14033),r=i(55563),l=i(9292);var c;!function(e){e[e.Regular=0]="Regular",e[e.Virtual=1]="Virtual",e[e.Chest=2]="Chest"}(c||(t.StackType=c={}));const d=[{x:-8,y:10,maxSize:5,type:c.Regular},{x:-12,y:6,maxSize:10,type:c.Regular},{x:-8,y:-2,maxSize:15,type:c.Regular},{x:6,y:-2,maxSize:12,type:c.Regular},{x:0,y:-6,maxSize:20,type:c.Regular},{x:13,y:8,maxSize:Number.POSITIVE_INFINITY,type:c.Chest}],h=s.logger.for("coins");t.CoinPile=class{constructor(e,t,i){this.pools=e,this.tiles=t,this.hex=i,this.stacks=[]}getCurrentAmount(){return this.stacks.map((e=>e.currentAmount)).reduce(l.sum,0)}addCoins(e){let t=e;for(;t>0;){const e=this.getOrCreateStackWithFreeCapacity();if(!e)return;e.remainingCapacity()>t?(e.addCoins(t),t=0):(t-=e.remainingCapacity(),e.addCoins(e.remainingCapacity()))}}setAmount(e){const t=e-this.getCurrentAmount();t>0?this.addCoins(t):t<0&&this.deleteCoins(-t)}deleteCoins(e){let t=e;for(;t>0;){const i=this.getLatestStack();if(!i)return void h.warning(`unable to delete ${e} coins from ${this.hex}, hex is already empty of coins`);i.currentAmount>t?(i.deleteCoins(t),t=0):(t-=i.currentAmount,i.deleteCoins(i.currentAmount,(()=>{this.destroyStack(i)})),this.stacks.pop())}}getLatestStack(){return this.stacks[this.stacks.length-1]}storeCoins(e){let t=[...e];for(;t.length>0;){const e=this.getOrCreateStackWithFreeCapacity();if(!e)return void this.stacks[this.stacks.length-1].consumeCoins(t);{const i=t.splice(0,e.remainingCapacity());e.consumeCoins(i)}}}spawnCoin(){const e=this.getLatestStack();if(e&&0!==e.currentAmount){const t=e.spawnCoin();return 0===e.currentAmount&&(this.destroyStack(e),this.stacks.pop()),t}return h.warning(`Spawning coin from pile at ${this.hex}, but the pile is empty => new coin created from nothing`),this.pools.getCoin((this.hex.x+.5)*o.HEX_WIDTH,this.hex.y*o.HEX_INNER_HEIGHT+o.HEX_HEIGHT/2+s.random.integerBetween(-2,2))}destroy(){this.stacks.forEach((e=>{this.destroyStack(e)})),this.stacks=[]}getOrCreateStackWithFreeCapacity(){const e=this.stacks.find((e=>e.remainingCapacity()>0))||this.addStack();return e||h.warning(`Max displayable coin pile size exceeded at hex ${this.hex}. You have too much money!`),e}destroyStack(e){e.removeFromTile(this.tiles.getByHex(this.hex.id)),e.destroy()}addStack(){const e=d[this.stacks.length];if(!e)return;const t=this.createStackByType(e.type,e.maxSize);return this.stacks.push(t),t.addToTile(this.tiles.getByHex(this.hex.id),e.x,e.y),t}createStackByType(e,t){switch(e){case c.Regular:return new n.CoinStack(this.pools,t);case c.Chest:return new r.Chest(this.pools);case c.Virtual:return new a.VirtualStack(this.pools)}}}},69238:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.victoryToOverworldTransition=async function(){await Promise.all([(0,s.playScreenToOverworldTransition)(),(0,n.victoryBaseTransitionOut)()])};const s=i(99816),n=i(32410)},69302:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SmallPergamen=void 0;const s=i(7782),n=i(86545),o=i(76738),a=i(80959),r=i(9292);var l=Phaser.GameObjects.Image;class c extends n.ResponsiveContainer{constructor(e){super(e),this.pergamen=new o.Ribbon(this.scene,o.RibbonTextures.SmallPergamen),this.shadow=a.UiBuilder.for(this.scene).rectangle(0,1),this.pawn=new l(this.scene,0,0,"atlas","pawns/villager").setScale(.5).setOrigin(.5,.5),this.visibilityController=new s.TransitionController(this.scene,{initialValue:0,ease:"Sine.easeInOut",duration:300,applyValue:e=>{const t=24+(this.targetDimensions.width-24)*e,i=(0,r.pickLarger)(0,2*e-1);this.content?.setScale(1,1),this.content?.setAlpha(i),this.width=t,this.setPosition(this.targetDimensions.x-t/2,this.targetDimensions.y-this.height/2),this.pergamen.width=2*t,this.pergamen.setAlpha(e),this.shadow.width=(0,r.pickLarger)(0,t-8),this.shadow.setAlpha(e/5),this.pawn.setPosition(t-12+2,8*(1-e)),this.pawn.setAlpha(i)}}),this.targetDimensions={x:0,y:0,width:0},this.shadow.setSize(10,5),this.shadow.setPosition(4,0),this.pergamen.setScale(.5),this.add([this.pawn,this.pergamen]),this.visibilityController.applyCurrentValue()}setContent(e){if(this.content){if(this.content===e)return;this.remove(this.content)}this.content=e,this.add(e),this.content.setPosition(12,6),this.targetDimensions.width=this.content.width+24,this.updateTargetSize(),this.visibilityController.applyCurrentValue()}showAt(e,t,i){this.visibilityController.setTo(0),this.targetDimensions.x=e,this.targetDimensions.y=t,i?(this.pawn.setFrame(i).setOrigin(1,.5),this.pawn.setVisible(!0)):this.pawn.setVisible(!1),this.visibilityController.transitionTo(1),this.updateTargetSize()}updateTargetSize(){this.targetDimensions.width=this.content.width+24,this.visibilityController.currentValue>0&&this.visibilityController.setTo(1)}handleChildResize(e){0!==this.visibilityController.currentTarget&&this.updateTargetSize()}destroy(e){super.destroy(e),this.visibilityController.destroy()}hide(){this.visibilityController.transitionTo(0,{duration:300,ease:"Sine.easeOut"})}}t.SmallPergamen=c},69313:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverworldObjectsManager=void 0;const s=i(75136),n=i(90952),o=i(72273),a=i(66143),r=i(18957),l=i(56824),c=i(97849),d=i(35300),h=i(73016),u=i(1326),p=i(62993),g=i(91622),m=i(46021),y=i(61913),f=i(35473),w=l.logger.for("IslandPreviews");t.OverworldObjectsManager=class{constructor(e){this.scene=e,this.selectedIslands=[],this.objectsById={},this.engine=new s.StateEngine,this.lines={},this.streamer=new h.ObjectStreamer,this.alwaysShowStartingState=!1,this.onIslandClicked=(0,r.signal)(),this.engine.add(n.GameState.version,n.GameState.map,n.GameState.ruleSet,n.GameState.economy.townsByRegion,...o.ProjectionPresets.coreEntities).activateAllProjections()}setAlwaysShowStartingState(e){e!==this.alwaysShowStartingState&&(this.alwaysShowStartingState=e,Object.entries(this.objectsById).forEach((([t,i])=>{i instanceof p.LazyIslandPreview&&(i.setProps({alwaysShowStartingState:e}),i.dirty&&this.streamer.add(i))})))}selectIslands(...e){this.selectedIslands=e,Object.entries(this.objectsById).forEach((([t,i])=>{i instanceof p.LazyIslandPreview&&i.setProps({selected:e.includes(t)})})),this.selectedIslands.length>0?g.inject.ui.selectedLevelId.set(this.selectedIslands[0]):g.inject.ui.selectedLevelId.set(void 0)}addToSelection(...e){this.selectIslands(...this.selectedIslands,...e)}loadExpedition(e){if(this.expedition!==e){this.expedition=e,this.streamer.reset(),Object.values(this.objectsById).forEach((e=>e.destroy())),this.objectsById={},this.selectedIslands=[];for(const t of e.objects)switch(t.type){case"island":this._addIslandPreview(t);break;case"expedition-portal":case"entrypoint":this._addPortal(t);break;case"flavor-text":this._addFlavorText(t)}Object.values(this.lines).forEach((e=>e.destroy())),this.lines={};for(const t of e.objects)for(const e of t.links??[])this._createOrUpdateConnection(t.id,e)}else this.refresh()}_addIslandPreview(e){const t=new p.LazyIslandPreview(this.scene,this.engine,{selected:!1,levelInfo:e,alwaysShowStartingState:this.alwaysShowStartingState,manifest:a.LevelModel.for(e.id).manifest});t.onClicked((()=>{this.onIslandClicked.fire(e.id)})),this.objectsById[e.id]=t,this.streamer.add(t)}_addPortal(e){const t=new y.LazyExpeditionPortal(this.scene,{portal:e});this.objectsById[e.id]=t,this.streamer.add(t)}_addFlavorText(e){const t=new f.OverworldFlavorText(this.scene,{...e,text:e.text??this.expedition.metadata.description});this.objectsById[e.id]=t,this.streamer.add(t)}_createOrUpdateConnection(e,t){if(e>t){const i=e;e=t,t=i}const i=`${e}=>${t}`,s=this.lines[i],n=this.objectsById[e],o=this.objectsById[t];if(n&&o)if(s)s.updateGeometry(n.getLinkAnchorPoint(),o.getLinkAnchorPoint());else{const s=new m.LazyIslandConnection(this.scene,{from:n.getLinkAnchorPoint(),to:o.getLinkAnchorPoint(),dashLength:8,unlocked:this._isObjectUnlocked(e)&&this._isObjectUnlocked(t)});this.lines[i]=s,this.streamer.add(s)}else w.warning(`[${i}] Ignoring invalid connection`,n,o)}_isObjectUnlocked(e){if(!this.objectsById[e])return!0;const t=a.LevelModel.for(e);return!t||t.isUnlocked()}destroyConnection(e,t){if(e>t){const i=e;e=t,t=i}const i=`${e}=>${t}`,s=this.lines[i],n=this.objectsById[e],o=this.objectsById[t];n&&o?(this._deleteLink(n,t),this._deleteLink(o,e),s&&(s.destroy(),delete this.lines[i],this.streamer.remove(s))):w.warning(`[${i}] Ignoring invalid connection`,n,o)}_deleteLink(e,t){e instanceof p.LazyIslandPreview?(0,u.removeFromArrayInPlace)(e.props.levelInfo.links,t):e instanceof y.LazyExpeditionPortal&&(0,u.removeFromArrayInPlace)(e.props.portal.links,t)}async export(){c.assert.defined(this.expedition);for(const e of Object.keys(this.lines)){const[t,i]=e.split("=>"),s=this.expedition.objects.find((e=>e.id===t))?.links;-1===s?.indexOf(i)&&s?.push(i);const n=this.expedition.objects.find((e=>e.id===i))?.links;-1===n?.indexOf(t)&&n?.push(t)}const e={id:this.expedition.id,metadata:this.expedition?.metadata,config:this.expedition?.config,objects:await Promise.all(this.expedition?.objects.map((async e=>{if("island"===e.type){const t=await a.LevelModel.for(e.id).getStartingState();return c.assert.defined(t,`Level ${e.id} not found`),{type:"island",id:e.id,isNew:e.isNew,links:e.links,entrypoint:e.entrypoint,shape:{...e.shape}}}return e})))},t=JSON.stringify({expeditions:[e]},null,2);return(0,d.copyTextToClipboard)(t),console.log(t),e}moveSelectedIslands(e){if(this.expedition)for(let t of this.selectedIslands){this.objectsById[t];const i=this.expedition.objects.find((e=>e.id===t));if(!i)return;i.shape.x+=e.x,i.shape.y+=e.y,w.info(`NEW POSITION: ${i.shape.x}:${i.shape.y}`),this.updateLevelPosition(i)}}updateLevelPosition(e){const t=this.objectsById[e.id],{x:i,y:s}=e.shape;if(t){t.updatePosition();for(let t of e.links??[])this._createOrUpdateConnection(e.id,t);for(let t of Object.keys(this.lines)){const i=t.split("=>");i.includes(e.id)&&this._createOrUpdateConnection(...i)}}}async add(e){if(!this.selectedIslands.length)return;if(this.objectsById[e])return void w.warning(`${e} is already in the expedition`);c.assert.defined(this.expedition);const t=this.expedition.objects.find((e=>e.id===this.selectedIslands[0]));if(t.links&&-1!==t.links.indexOf(e))return void w.warning(`${e} is already linked from ${this.selectedIslands}`);t.links||(t.links=[]),t.links.push(e);const i=a.LevelModel.for(e),s=await i.getStartingState();c.assert.defined(s);const n={type:"island",id:e,shape:{x:t.shape.x,y:t.shape.y-s.map.height-1},links:[],ordinalNumber:-1,distanceFromEntrypoint:-1};this.expedition?.objects.push(n),this._addIslandPreview(n),this._createOrUpdateConnection(this.selectedIslands[0],e)}update(){this.streamer.update(Phaser.Geom.Rectangle.Inflate(this.scene.cameras.main.worldView,200,200))}addLinkFromSelected(e){if(this.objectsById[e])for(let t of this.selectedIslands)this._createOrUpdateConnection(t,e)}removeLinkFromSelected(e){if(this.objectsById[e])for(let t of this.selectedIslands)this.destroyConnection(t,e)}refresh(e=!1){for(const t of Object.values(this.objectsById))t instanceof p.LazyIslandPreview&&t.setProps({alwaysShowStartingState:this.alwaysShowStartingState}),t.refresh(e);for(let e of Object.values(this.lines))e.refresh()}}},69387:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PawnSymbolsManager=void 0;const n=i(56824),o=s(i(65731)),a=i(1326),r=i(91622),l=n.logger.for("PawnSymbols"),c=(e,t)=>e.type.localeCompare(t.type);t.PawnSymbolsManager=class{constructor(e){this.pawns=e,this.symbolsByPawn=new Map}clearAll(){const e=this.symbolsByPawn.keys();for(const t of e){const e=this.pawns.getById(t);!e||e.isDestroyed()?l.warning(`Ignoring stale pawnSymbol reference to destroyed pawn #${t}`):e.removeSymbol()}this.symbolsByPawn.clear()}clear(e){const t=[];for(let[i,s]of this.symbolsByPawn.entries()){const s=this.pawns.getById(i);!s||s.isDestroyed()?t.push(i):this.remove(i,e)}for(let e of t)this.symbolsByPawn.delete(e)}add(e,t,i){let s=this.symbolsByPawn.get(e),n=s?.find((e=>e.type===t));s?n?n.message=i:(s.push({type:t,message:i}),s.sort(c)):(new o.default(c),this.symbolsByPawn.set(e,[{type:t,message:i}])),n||this.updateSymbolImage(e)}remove(e,t){const i=this.symbolsByPawn.get(e),s=i?.find((e=>e.type===t));i&&s&&((0,a.removeFromArrayInPlace)(i,s),this.updateSymbolImage(e))}getCurrentSymbol(e){return this.symbolsByPawn.get(e)?.[0]}updateSymbolImage(e){const t=this.getCurrentSymbol(e),i=this.pawns.getById(e);t?i?i.setSymbol(t.type):l.warning(`Failed to update symbol image to ${t.type} for pawn ${e}: no pawn sprite located`):i?.removeSymbol()}has(e,t){const i=this.symbolsByPawn.get(e);return!!i?.find((e=>e.type===t))}byHex(e){const t=r.inject.gameStateModel.pawns.byHex(e).map((e=>e.id));return(0,a.stripDuplicatesFrom)((0,a.mergeArrays)(...t.map((e=>this.symbolsByPawn.get(e)??[]))))}}},69447:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionAIContext=void 0,t.createAiContext=function(e){return new r(e)};const s=i(19748),n=i(56824),o=i(91622),a=i(87310);n.logger.for("ai:context");class r{get faction(){return this.region.faction}get aiPersonality(){return this.faction.getCurrentPersonality()}get state(){return this.game.currentState}constructor(e){this.region=e,this.game=o.inject.gameStateController,this.debug=!1,this.plays=[],this.marshal=new s.Marshal(this),this.abortWatcher=new a.LevelSessionEndWatcher,this.focus=this.faction.getCurrentPersonality(),this.blacklistedPlans=new Set,this.uniqueId=Math.random(),this.expansionTarget=0,this.forceAction=!1,this.initialRegionSize=e.size}isOffensiveActionRequired(){return this.forceAction&&this.initialRegionSize===this.region.size}async breakpoint(e,t=()=>({})){this.debug&&await o.inject.debugBreakpoint(e,(()=>({...t(),region:this.region})))}addPlay(e,t){this.plays.push({play:e,gameCheckpoint:this.game.createCheckpoint()}),this.game.executePlay(e),this.updateAfterStateChange()}updateAfterStateChange(){this.region.updateFrom(this.game.currentState)}}t.RegionAIContext=r},69572:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ListViewSimpleRow=t.ListView=void 0;const s=i(86545),n=i(1187),o=i(2426),a=i(18957),r=i(20087),l=i(80959),c=i(7548);var d=Phaser.GameObjects.Image;const h=e=>({rowSpacing:4,content:{color:e.white},highlightBox:{line:{color:e.oceanShades.light2},radius:4},selectedRow:{box:{fill:{color:e.oceanShades.light2,alpha:.5},radius:4}}});class u extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.selectedIndex=-1,this.onItemSelected=(0,a.signal)(),this.theme=(0,c.themer)(this,h),this.rows=new n.GameObjectList(((e,i,s)=>(s?s=t.createOrUpdateRow(e,s):((s=t.createOrUpdateRow(e)).width=this.width,s.height=32,s.on("pointerdown",(()=>this.setSelectedIndex(i))),s.on("pointerover",(()=>{this._handlePointerOverRow(i)})),s.on("pointerout",(()=>{this._handlePointerOut(i)})),this.add(s)),s))),this.width=t.width??200,t.theme&&this.theme.set(t.theme),this.highlightBox=new o.RoundedRect(e,{radius:0});const i=this.theme.get();i.selectedRow.box&&(this.selectedRowBox=new o.RoundedRect(e,{radius:0})),i.selectedRow.icon&&(this.selectedRowIcon=new d(e,0,0,"atlas",i.selectedRow.icon.frame).setOrigin(.5,.5)),this.selectedRowBox?.setVisible(!1),this.highlightBox?.setVisible(!1),this.theme.use((e=>{this.highlightBox.setStyle(e.highlightBox),e.selectedRow.box&&this.selectedRowBox.setStyle(e.selectedRow.box),e.selectedRow.icon&&this.selectedRowIcon.setTint(e.content.color),this.preUpdate.makeDirty()})),this.add([this.highlightBox,this.selectedRowBox,this.selectedRowIcon].filter(Boolean))}setItems(e){return this.model=e,this.rows.set(e),this.preUpdate.makeDirty(),this}updateLayout(){this.highlightBox?.setSize(this.width,32),this.selectedRowBox?.setSize(this.width,32),this.rows.get().forEach((e=>e.width=this.width)),r.Arrange.topToBottom({content:this.rows.get(),y:0,spacing:this.theme.get().rowSpacing}),this._updateSelectedRowHighlight(),this.updateSize()}calculateHeight(){const e=this.rows.get();return e.length?e[e.length-1].y+e[e.length-1].height:0}setSelectedIndex(e,t=!0){const i=this.model[e];this.selectedIndex=e,this.preUpdate.makeDirty(),t&&this.onItemSelected.fire({item:i,component:this.rows.get()[e],index:e})}_updateSelectedRowHighlight(){if(-1===this.selectedIndex||this.selectedIndex>=this.rows.length)this.selectedRowBox?.setVisible(!1),this.selectedRowIcon?.setVisible(!1);else if(this.selectedRowBox)this.selectedRowBox.setVisible(!0),this.selectedRowBox.y=this.rows.get()[this.selectedIndex].y;else if(this.selectedRowIcon){const e=this.rows.get()[this.selectedIndex];this.selectedRowIcon.setPosition(8+this.selectedRowIcon.width/2+6,e.y+e.height/2),this.selectedRowIcon.setVisible(!0),this.selectedRowIcon.setToTop()}}_handlePointerOverRow(e){this.model[e]&&(this.highlightBox.setVisible(!0),this.highlightBox.y=this.rows.get()[e].y)}_handlePointerOut(e){this.highlightBox.y===this.rows.get()[e].y&&this.highlightBox.setVisible(!1)}setSelection(e,t=!0){if(e){const i=this.model.indexOf(e);this.setSelectedIndex(i,t)}else this.setSelectedIndex(-1,t)}}t.ListView=u,u.Themes={white:h,dropdownList:e=>({rowSpacing:0,content:{color:e.white},highlightBox:{fill:{color:e.oceanShades.dark4}},selectedRow:{icon:{width:20,frame:"ui/button-icons/checkmark"}}}),timeline:e=>({rowSpacing:4,content:{color:e.white},highlightBox:{line:{color:e.oceanShades.light2},radius:8},selectedRow:{box:{fill:{color:e.oceanShades.light1,alpha:.5},radius:8}}}),buttonList:e=>({rowSpacing:4,content:{color:e.white},highlightBox:{line:{color:e.oceanShades.light2},radius:8},selectedRow:{}})};class p extends s.ResponsiveContainer{constructor(e){super(e);const t=l.UiBuilder.for(e);this.text=t.richText("",(e=>e.white)),this.updateLayout(),this.setInteractiveAuto(),this.add(this.text)}setTextColor({color:e,alpha:t}){this.text.setTint(e),this.text.setAlpha(t??1)}setText(e){this.text.setText(e),this.updateLayout()}updateLayout(){r.Arrange.leftToRight({content:[this.text],x:20,origin:0}),r.Arrange.alignY({content:[this.text],y:this.height/2,origin:.5})}}t.ListViewSimpleRow=p},69894:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapGenerationScreen=void 0;const s=i(81700),n=i(95568),o=i(36868),a=i(71021),r=i(42880),l=i(91622),c=i(54825),d=i(56824);class h extends n.BaseScreen{constructor(){super("MapGeneration",[s.Scenes.WorldMap]),this.observe.event(o.UserActions.ResumeGame,(()=>{l.inject.levelSession.saveLevelProgress(),c.app.navigator.goTo(c.app.screen.play,a.NewGameStateContext.ResumingGame)})),this.observe.event(o.UserActions.Escape,(async()=>{d.events.trigger(o.UserActions.ResumeGame())}))}async activate(){c.app.scene.worldMap.setMode(new r.PreviewMode)}deactivate(){}}t.MapGenerationScreen=h},70033:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelIcons=void 0,t.getLevelIcon=function(e){switch(e){case s.LevelStatus.GoldMedal:return o.Gold;case s.LevelStatus.SilverMedal:return o.Silver;case s.LevelStatus.InProgress:return o.Fighting;default:return o.NoTrophy}},t.getCurrentDifficultyIcon=function(){return n.inject.levelSession.isFixedDifficulty||"hard"===n.inject.levelSession.aiDifficulty?o.Gold:o.Silver};const s=i(66143),n=i(91622);var o;!function(e){e.Gold="ui/level-icons/gold",e.Silver="ui/level-icons/silver",e.Bronze="ui/level-icons/bronze",e.Fighting="ui/level-icons/in-progress",e.NoTrophy="ui/level-icons/no-trophy",e.Defeated="ui/level-icons/rip"}(o||(t.LevelIcons=o={}))},70046:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalWindow=void 0;const s=i(21941),n=i(76738),o=i(29821),a=i(20227),r=i(86545),l=i(80959),c=i(49527),d=i(96137),h=i(18957),u=10,p=55,g=10,m=6,y=4,f=6,w=30;class v extends r.BaseResponsiveContainer{constructor(e,t){super(e),this.scene=e,this.ui=l.UiBuilder.for(this.scene),this.chrome=new s.Box(this.scene,s.BoxTextures.WindowFrame),this.headerRibbon=new n.Ribbon(this.scene,n.RibbonTextures.WindowHeader),this.headerLeftStrap=this.ui.image("ui/window-header-strap").setFlipX(!0).setOrigin(1,0),this.headerRightStrap=this.ui.image("ui/window-header-strap"),this.headerText=new o.Label(this.scene,"",{color:16777215,align:"center",shadow:!0}),this.closeButton=new c.StealthButton_LEGACY(this.scene,{content:this.ui.image("ui/button-icons/exit").setTint(d.Colors.glassUi_old.primaryText),width:26,height:26}),this.tweener=new a.BasicTweener,this.onCancel=(0,h.signal)(),this.props={title:""},this.closeButton.onClicked((()=>{this.onCancel.fire()})),this.add([this.headerLeftStrap,this.headerRightStrap,this.chrome,this.headerRibbon,this.headerText,this.closeButton]),this.setProps(t)}animateIn(){this.addToDisplayList(),this.preUpdate.force();const e=[];e.push(this.scene.tweens.add({targets:this,scale:{from:.1,to:1},alpha:{from:.1,to:1},duration:400,ease:"Back.easeOut"}));const t=this.headerLeftStrap.x;this.headerLeftStrap.x=t+24,e.push(this.scene.tweens.add({targets:this.headerLeftStrap,x:t,duration:400,ease:"Sine.easeIn"}));const i=this.headerRightStrap.x;this.headerRightStrap.x=i-24,e.push(this.scene.tweens.add({targets:this.headerRightStrap,x:i,duration:400,ease:"Sine.easeIn"})),this.tweener.setTweens(e)}animateOut(){this.tweener.setTweens([this.scene.tweens.add({targets:this,scale:{from:1,to:.1},alpha:{from:1,to:0},duration:200,ease:"Sine.easeOut"})],(()=>this.removeFromDisplayList()))}setProps(e){this.props=e,this.headerText.setText(e.title),e.content&&this.setContent(e.content),this.preUpdate.makeDirty()}setContent(e){this.content!==e&&(this.content&&(this.remove(this.content),this.scene.children.remove(this.content)),this.content=e,this.add(e),this.preUpdate.makeDirty())}updateLayout(){if(!this.content)return;let e=this.content.width+2*u,t=this.content.height+p+g;e>this.scene.bounds.width&&(this.content.width=this.scene.bounds.width-2*u,e=this.scene.bounds.width),e<360&&(e=360,this.content.width=e-2*u);const i={x:-e/2,y:-t/2};this.headerText.setPosition(-this.headerText.width/2,i.y+y+9),this.closeButton.setPosition(i.x+e-36,i.y+15),this.chrome.setPosition(i.x,i.y),this.chrome.setSize(e,t),this.headerRibbon.setPosition(i.x-m,i.y+y),this.headerRibbon.width=e+2*m,this.headerLeftStrap.setPosition(i.x-m-w,i.y+y+f),this.headerRightStrap.setPosition(i.x+e+m-this.headerRightStrap.width+w,i.y+y+f),this.content.setPosition(i.x+u,i.y+p)}}t.ModalWindow=v},70080:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoginService=t.LoginAction=t.LoginState=void 0;const s=i(68243),n=i(65052),o=i(96130),a=i(51496),r=i(91622),l=i(36868),c=i(54825),d=i(78349),h=i(35800),u=i(5365),p=i(63032),g=i(85711),m=i(56824),y=i(13419),f=i(72427),w=i(10131),v=m.logger.for("LoginService");var b,S;!function(e){e.Disabled="Disabled",e.SigningIn="SigningIn",e.SignInEmailSent="SigningInEmailSent",e.SignedIn="SignedIn",e.SignedOut="SignedOut",e.LoginFailed="LoginFailed",e.Offline="Offline"}(b||(t.LoginState=b={})),function(e){e.None="none",e.SignIn="sign-in",e.SignOut="sign-out"}(S||(t.LoginAction=S={})),t.LoginService=class{getDefaultUserId(){let e=this.localStorage.getItem(d.STORAGE_KEYS.DEFAULT_USER);if(!e){const t=this.localStorage.getItem("konkr.userData");t&&(e=JSON.parse(t).userId)}return e||(e=m.random.id(h.ID_TYPE.User),this.localStorage.setItem(d.STORAGE_KEYS.DEFAULT_USER,e)),e}getUserId(){return this.localStorage.getItem(d.STORAGE_KEYS.CURRENT_USER)??this.getDefaultUserId()}getUsername(){return(0,y.isRunningAt)("kongregate")?f.Kongregate.user()?.username||"-":s.Firebase.auth?.currentUser?.email??void 0}constructor(e){this.localStorage=e,this.state=(0,o.watchable)(b.Disabled),this.googleAuthProvider=new n.GoogleAuthProvider,this.facebookAuthProvider=new n.FacebookAuthProvider,this.latestAction=S.None,this.supportedProviders=[this.googleAuthProvider,this.facebookAuthProvider],this.initialize=(0,w.asyncInitializer)((()=>{(0,y.isRunningAt)("kongregate")?(f.Kongregate.user.watch((()=>{this.updateLoginStateBasedOnKongregateAPI()})),f.Kongregate.apiState.watch((()=>{this.updateLoginStateBasedOnKongregateAPI()}))):s.Firebase.auth?.onAuthStateChanged((e=>{const t=this.getUserId();!e||e?.isAnonymous?this.setState(function(e){switch(e){case S.None:return b.Disabled;case S.SignIn:return b.LoginFailed;case S.SignOut:return b.SignedOut}}(this.latestAction)):(this.localStorage.setItem(d.STORAGE_KEYS.CURRENT_USER,e.uid),this.setState(b.SignedIn),m.events.trigger(l.SystemEvents.UserSignedIn({userId:e.uid,previousUserId:t})))})),m.events.trigger(l.SystemEvents.UserSignedIn({userId:this.getUserId()})),m.events.on(l.UserActions.SignInWithGoogle,(()=>{this.setState(b.SigningIn),this.signInWithGoogle()})),m.events.on(l.UserActions.SignInWithFacebook,(()=>{this.setState(b.SigningIn),this.signInWithFacebook()})),window.addEventListener("online",(()=>{this.state()===b.Offline&&((0,y.isRunningAt)("kongregate")?this.updateLoginStateBasedOnKongregateAPI():this.setState(s.Firebase.auth?.currentUser&&!s.Firebase.auth?.currentUser.isAnonymous?b.SignedIn:b.Disabled))})),window.addEventListener("offline",(()=>{this.setState(b.Offline)})),m.events.on(l.UserActions.SignInWithEmail,(async()=>{this.setState(b.SigningIn);const e=(0,g.ref)(r.inject.userData.recallChoice("feedbackEmail")??""),t=await c.app.modals.textInput({title:"Sign-in with email",inputPlaceholder:"email@example.com",message:"A sign-in link will be sent to the following email address:",value:e,buttons:[{text:u.DialogButtons.Cancel,role:p.DialogButtonRole.Regular},{text:u.DialogButtons.OK,role:p.DialogButtonRole.PrimaryGreen}]}),i=e.current;t===u.DialogButtons.OK&&i?(m.storage.setItem("emailForSignIn",i),await this.signInWithEmail(i.trim())):this.setState(b.Disabled)})),m.events.on(l.UserActions.SignOut,(()=>{this.signOut()})),m.events.on(l.SystemEvents.EngineInitialized,(async()=>{await this.parseUrlParams()}))})),this.googleAuthProvider.setCustomParameters({prompt:"select_account"})}setState(e){this.state.set(e)}updateLoginStateBasedOnKongregateAPI(){const e=f.Kongregate.user(),t=f.Kongregate.apiState();if(v.info(`Updating login state based on info from Kongregate API: ${e?.username} (API state: ${t})`),e)this.state.set(b.SignedIn);else switch(f.Kongregate.apiState()){case f.KongregateAPIState.NotAvailable:this.state.set(b.Disabled);break;case f.KongregateAPIState.Ready:this.state.set(b.SignedOut);break;case f.KongregateAPIState.Loading:this.state.set(b.SigningIn)}}async parseUrlParams(){if((0,n.isSignInWithEmailLink)(s.Firebase.auth,window.location.href)){let e=m.storage.getItem("emailForSignIn");if(!e){const t=(0,g.ref)("");await c.app.modals.textInput({title:"Sign-in with email",message:"Please enter your email for confirmation",inputPlaceholder:"email@example.com",value:t,buttons:[{text:u.DialogButtons.Cancel,role:p.DialogButtonRole.Regular},{text:u.DialogButtons.OK,role:p.DialogButtonRole.PrimaryGreen}]}),e=t.current}(0,n.signInWithEmailLink)(s.Firebase.auth,e,window.location.href).then((t=>{c.app.notifications.success("Sign-in completed!",`Your can now access your progress on any device by signing in as ${e}.`),a.track.loginSuccess({provider:"email"})})).catch((e=>{a.track.loginFailed({provider:"email"}),c.app.notifications.warning("Email sign up failed.","Looks like the sign-in link in the email is expired or invalid, please try again!")})).finally((()=>{m.storage.removeItem("emailForSignIn"),setTimeout((()=>window.history.pushState({},"",window.location.pathname)),1e3)}))}}async signInWithGoogle(){this.latestAction=S.SignIn;const e={provider:"google"};try{a.track.loginStart(e),await(0,n.signInWithPopup)(s.Firebase.auth,this.googleAuthProvider),a.track.loginSuccess(e)}catch(e){await this.handleSignInError(e,"facebook")}}async signInWithFacebook(){this.latestAction=S.SignIn;const e={provider:"facebook"};try{a.track.loginStart(e),await(0,n.signInWithPopup)(s.Firebase.auth,this.facebookAuthProvider),a.track.loginSuccess(e)}catch(e){await this.handleSignInError(e,"facebook")}}async handleSignInError(e,t){switch(e.code){case"auth/popup-closed-by-user":this.setState(b.Disabled);break;case"auth/account-exists-with-different-credential":this.signInErrorMessage=`Email [b]${e.customData?.email??""}[/b] is already used with another sign-in method.\n\nPlease try signing in with a [b]different method[/b] or a [b]different email[/b].`,this.setState(b.LoginFailed),a.track.loginFailed({provider:t});break;default:this.signInErrorMessage="'Oops! Something went wrong during the sign in process.\n\n'[b]Please try again![/b]'",m.errors.handleNonFatalError(e,`signIn/${t}`),this.state()===b.SigningIn&&this.setState(b.LoginFailed),a.track.loginFailed({provider:t})}}getProviderById(e){for(let t of this.supportedProviders)if(t.providerId===e)return t}async signInWithEmail(e){this.latestAction=S.SignIn;const t={provider:"email"};try{a.track.loginStart(t),await(0,n.sendSignInLinkToEmail)(s.Firebase.auth,e,{url:window.location.href,handleCodeInApp:!0}),a.track.loginSuccess(t),this.setState(b.SignInEmailSent)}catch(e){await this.handleSignInError(e,"email")}}cancelSignIn(){this.state()!==b.SigningIn&&this.state()!==b.SignInEmailSent||(this.latestAction=S.SignOut,this.setState(b.Disabled))}getAuth(){return s.Firebase.auth}async signOut(){this.latestAction=S.SignOut,await s.Firebase.auth.signOut()}describeCurrentAuthProvider(){if((0,y.isRunningAt)("kongregate"))return"Kongregate";const e=s.Firebase.auth?.currentUser?.providerData?.[0]?.providerId;switch(e){case this.facebookAuthProvider.providerId:return"Facebook";case this.googleAuthProvider.providerId:return"Google";default:return"email"}}isLoggedIn(){return this.state()===b.SignedIn}}},70224:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InspectingRival=t.Tutorial2=void 0;const s=i(45664),n=i(37971),o=i(36868),a=i(91622),r=i(54825),l=i(34174),c=i(12167),d=i(95428),h=i(24598),u=i(89764),p=i(64244),g=i(1574),m=i(20693),y=i(62277),f=i(85671),w=i(56824);t.Tutorial2=class{constructor(){this.step1_defend=new T(this),this.step2_buyCastle=new I(this),this.step3_castleBuilt=new C(this),this.step4_buyKnight=new M(this),this.step5_useTheKnight=new A(this),this.main=new v(this),this.idle=new f.SimpleStep(this),this.derailed=new B(this),this.defeated=new P(this),this.inspectingRival=new S(this),this.inspectingLedger=new x(this)}};class v extends n.LevelScript{activate(){a.inject.ai.maxAllowedUnitMight=2,a.inject.ai.allowSurrender=!1;const e=a.inject.gameStateModel.currentPhase.turnNumber;1===e?this.goTo("step1_defend"):E(404)&&(E(504)||E(505))?this.goTo("defeated"):2===e&&[(0,s.getHex)(504),(0,s.getHex)(505)].some((e=>a.inject.gameStateModel.warfare.getOccupyingUnit(e)?.type===h.PawnType.Castle))?this.goTo("step3_castleBuilt"):2===e&&(R()?.treasury??0)>=20?this.goTo("step2_buyCastle"):!k()&&O().getMaxRemainingSustainableMight()>=3?this.goTo("step4_buyKnight"):k()?this.goTo("step5_useTheKnight"):this.goTo("idle")}}class b extends f.SimpleStep{onInspectLedger(){this.goTo("inspectingLedger")}onRegionSelected(e){38===e?this.goTo("inspectingRival"):this.goTo("main")}}class S extends b{activate(){const e=a.inject.gameStateModel.regions.byId(a.inject.levelSession.selectedRegionId);if(!e)return this.goTo("idle");const t=e.treasury+e.budget.balance;1===a.inject.gameStateModel.currentPhase.turnNumber&&t>=10?super.activate({worldMapPanel:{type:"tutorial",text:`With [b]${t} coins[/b] on their turn, Godfrey will be able to attack us with [b]two villagers[/b]!`,emojiEmotion:d.EmojiEmotion.DeeplyWorried,buttons:[]}}):this.goTo("idle"),this.onEvent(o.UserActions.WorldMapPanelButtonClicked,(()=>{w.events.trigger(o.UserActions.ShowHelp("how-to-play/economy"))}))}}t.InspectingRival=S;class x extends b{activate(){const e=a.inject.gameStateModel.factions.localPlayer?.getLargestLiveRegion();if(!e)return this.goTo("idle");const t=e.treasury,i=e.budget.balance;i>=0?super.activate({worldMapPanel:{type:"tutorial",text:`This is the breakdown of our province economy. We have [b]${t} coins[/b] in treasury right now and we'll be getting [b]${i} more[/b] at the start of next turn!`,emojiEmotion:d.EmojiEmotion.VeryHappy,buttons:[c.DIALOG_BUTTONS.moreInfo]},tutorialArrowTarget:l.Placement.aroundHideLedgerButton}):super.activate({worldMapPanel:{type:"tutorial",text:`This is the breakdown of our province economy. We're now [b]losing ${-i} coins every turn[/b], which is not good! We need to quickly expand our territory or undo some expensive unit purchases!`,emojiEmotion:d.EmojiEmotion.DeeplyWorried,buttons:[c.DIALOG_BUTTONS.moreInfo]},tutorialArrowTarget:l.Placement.aroundHideLedgerButton}),this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{w.events.trigger(o.UserActions.ShowHelp("how-to-play/economy"))}))}}class T extends b{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.DeeplyWorried,buttons:[c.DIALOG_BUTTONS.moreInfo],text:"Blasted! Here he goes again. This time Godfrey landed quite close to our town!\nWe should [b]focus on defense[/b] this turn!"}}),this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{w.events.trigger(o.UserActions.ShowHelp("how-to-play/combat"))}))}}class P extends b{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.DeeplyWorried,buttons:[c.DIALOG_BUTTONS.moreInfo,c.DIALOG_BUTTONS.restartTutorial],text:"Oh no, what a disaster! Now we are in no position to stop the incursion. Let's try this again."},tutorialArrowTarget:l.Placement.aroundRestartButton,tutorialFrameTarget:l.Placement.aroundRestartButton}),this.onButtonClicked(c.DIALOG_BUTTONS.restartTutorial,(()=>{w.events.trigger(o.UserActions.RestartLevel({}))})),this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{w.events.trigger(o.UserActions.ShowHelp("how-to-play/bandits"))}))}}class I extends b{onPawnBought(e){e.pawnType===h.PawnType.Castle&&[504,505].includes(e.destinationHexId)?this.goTo("main"):this.goTo("derailed")}activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.DeeplyWorried,buttons:[c.DIALOG_BUTTONS.moreInfo],text:"Damn, looks like he learned to use [b]pikemen[/b] too! Remarkable... We could recruit a pikeman of our own for defense, but a [b]castle[/b] is [b]a lot cheaper to maintain[/b]."},tutorialArrowTarget:l.Placement.aroundBuyablePawn(h.PawnType.Castle)}),this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{w.events.trigger(o.UserActions.ShowHelp("how-to-play/units"))})),this.onEvent(o.UiEvents.PawnReturnedToShop,(()=>{r.app.scene.playUI.updateState({tutorialArrow:l.Placement.aroundBuyablePawn(h.PawnType.Castle)})})),this.onEvent(o.UiEvents.PawnPickedUpFromShop,(e=>{const t=[(0,s.getHex)(504),(0,s.getHex)(505)].find((e=>void 0===a.inject.gameStateModel.warfare.getOccupyingUnit(e)));if(!t)return this.goTo("idle");switch(e){case h.PawnType.Castle:r.app.scene.playUI.updateState({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.Happy,buttons:[],text:"A castle costs just [b]2 coins per turn[/b], same as villager. But unlike a villager, it also [b]protects adjacent tiles[/b] from enemy pikemen.\nLet's [b]place this one over here![/b]"},tutorialArrow:l.Placement.atWorldMapHex(t)});break;case h.PawnType.Pikeman:r.app.scene.playUI.updateState({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.DeeplyWorried,buttons:[],text:"Eh, we can buy a [b]Pikeman[/b] but it's upkeep cost of [b]6 coins[/b] each turn will really slow us down! I'm sure building a [b]Castle[/b] is a better idea here!"},tutorialArrow:l.Placement.aroundBuyablePawn(h.PawnType.Castle)});break;case h.PawnType.Villager:r.app.scene.playUI.updateState({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.DeeplyWorried,buttons:[],text:"Another villager will not stop their Pikeman! We should buy [b]build a Castle[/b] instead!"},tutorialArrow:l.Placement.aroundBuyablePawn(h.PawnType.Castle)})}}))}}class C extends b{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.VeryHappy,buttons:[],text:"Great! With our flank secure, we can finally focus on [b]expanding our province[/b]!"}})}}class M extends b{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.Happy,buttons:[c.DIALOG_BUTTONS.moreInfo],text:"I think our income is now strong enough to support a [b]knight[/b], let's merge some units to get one!"},tutorialArrowTarget:_()}),this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{w.events.trigger(o.UserActions.ShowHelp("how-to-play/merging"))})),this.onEvent(o.UiEvents.PawnPickedUpFromShop,(e=>{this.goTo("main")})),this.onEvent(o.UiEvents.PawnPickedUp,(e=>{this.goTo("main")})),this.onEvent(o.UiEvents.PawnReturnedToShop,(()=>{this.goTo("main")}))}}class A extends b{activate(){if(E(404)){if(!L())return this.goTo("idle");super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.Happy,buttons:[],text:"Knights take a whopping [b]18 coins every turn[/b], but pikemen and even castles are no match for them!"},tutorialArrowTarget:l.Placement.atWorldMapHex(H())})}else L()||super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.VeryHappy,buttons:[],text:"Yes! No one can stand in the way of our knight!\n"}})}}class B extends b{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.Embarrassed,buttons:[c.DIALOG_BUTTONS.howToPlay,c.DIALOG_BUTTONS.restartTutorial],text:"Prefer doing things your way, huh? Oh well, let me know if I can help!"}}),this.onButtonClicked(c.DIALOG_BUTTONS.howToPlay,(()=>{w.events.trigger(o.UserActions.ShowHelp())})),this.onButtonClicked(c.DIALOG_BUTTONS.restartTutorial,(()=>{w.events.trigger(o.UserActions.RestartLevel({}))}))}}function E(e){return!a.inject.gameStateModel.factions.byHex((0,s.getHex)(e))?.isLocalPlayer()}function O(){return a.inject.gameStateModel.factions.localPlayer.getLargestLiveRegion()?.getMyAssets()??u.RegionAssets.empty}function R(){return a.inject.gameStateModel.factions.localPlayer.getLargestLiveRegion()}function k(){return O().totalUnits.countOf(3)>0}function L(){return O().remainingUnits.countOf(3)>0}function _(){const e=R();if(!e)return null;const t=e.getMyAssets(),i=t.remainingUnits.countOf(3),s=t.remainingUnits.countOf(2),n=t.remainingUnits.countOf(1),o=function(){const e=r.app.scene.play.mode;return e instanceof p.MovingPawnMode?{hex:e.movingPawn.hex,type:e.movingPawn.type,id:e.movingPawn.id}:e instanceof g.BuyingPawnMode?{hex:void 0,type:e.buyingPawn,id:void 0}:{hex:void 0,type:void 0,id:void 0}}(),a=D(h.PawnType.Villager,o),c=D(h.PawnType.Pikeman,o);switch(o.type){case void 0:return i>=1?l.Placement.atWorldMapHex(D(h.PawnType.Knight,o)?.hex):s>=2?l.Placement.atWorldMapHex(c?.hex):n>=2?l.Placement.atWorldMapHex(a?.hex):s>0&&e.treasury>=20?l.Placement.aroundBuyablePawn(h.PawnType.Pikeman):n>0?l.Placement.aroundBuyablePawn(h.PawnType.Villager):l.Placement.aroundBuyablePawn(h.PawnType.Knight);case h.PawnType.Pikeman:return c?l.Placement.atWorldMapHex(c.hex):s<2&&n<2&&e.treasury>=10?l.Placement.aroundBuyablePawn(h.PawnType.Villager):null;case h.PawnType.Villager:return a?l.Placement.atWorldMapHex(a.hex):s<2&&e.treasury>=20?l.Placement.aroundBuyablePawn(h.PawnType.Pikeman):null;case h.PawnType.Knight:return l.Placement.atWorldMapHex(H());default:return null}}function D(e,t){const i=t.hex??(0,y.getHexUnderCursor)(r.app.scene.worldMap,a.inject.gameStateModel)??(0,s.getHex)(505);return a.inject.gameStateModel.pawns.findClosest(i,R()?.hexes??m.HexGroup.empty,(i=>i.type===e&&i.isMovable()&&i.id!==t.id))}function H(){return[(0,s.getHex)(404),(0,s.getHex)(304),(0,s.getHex)(203)].find((e=>!a.inject.gameStateModel.factions.byHex(e)?.isLocalPlayer()))}},70560:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VerticalStripePanelUI=void 0;const s=i(80959),n=i(91622),o={width:400,padding:10,stripeWidth:1,stickToRightSide:!1};t.VerticalStripePanelUI=class{constructor(e,t={}){this.scene=e;const i=s.UiBuilder.for(this.scene);this.props={...o,...t},this.mainPanel=i.rectangle(n.inject.theme.getOceanColor(),.85).setScrollFactor(0),this.leftBorder=i.image("glass-ui/card-horizontal-glint").setRotation(Math.PI/2).setScrollFactor(0),this.rightBorder=i.image("glass-ui/card-horizontal-glint").setRotation(Math.PI/2).setScrollFactor(0),this.components=[this.mainPanel,this.leftBorder,this.rightBorder],n.inject.theme.use((e=>{this.mainPanel.setFillStyle(e.oceanColor,.85)}))}addToScene(){this.scene.addAll(this.components)}isFullScreen(){return this.scene.bounds.contentWidth<1.5*this.props.width}updateLayout(){const e=this.props,t=(this.scene.bounds.width,this.scene.bounds.height);if(this.isFullScreen())this.mainPanel.setPosition(0,0),this.mainPanel.setSize(this.scene.bounds.contentWidth,t);else{const i=this.props.stickToRightSide?this.scene.bounds.width:this.scene.bounds.contentRight;this.mainPanel.setPosition(i-e.width,0),this.mainPanel.setSize(e.width,t)}this.leftBorder.setPosition(this.mainPanel.x+1,0),this.leftBorder.scaleX=t/this.leftBorder.width,this.leftBorder.scaleY=.5,this.rightBorder.setPosition(this.mainPanel.x+this.mainPanel.width+1,0),this.rightBorder.scaleX=t/this.leftBorder.width,this.rightBorder.scaleY=.5}async transitionIn(e){await new Promise((t=>{this.scene.tweens.add({targets:this.components,props:{alpha:{from:0,to:1}},duration:e,ease:"Sine.easeIn",onComplete:t})}))}async transitionOut(e){await new Promise((t=>{this.scene.tweens.add({targets:this.components,props:{alpha:{from:1,to:0}},duration:e,ease:"Sine.easeIn",onComplete:t})}))}setVisible(e){this.components.forEach((t=>{t.setVisible(e),e&&t.setAlpha(1)}))}}},70582:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProxyHexGroupValuation=void 0,t.ProxyHexGroupValuation=class{constructor(e,t){this.parent=e,this.proxyFunc=t}get(e){return this.proxyFunc(this.parent.get(e),e)}getHexIds(){return this.parent.getHexIds()}}},70589:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConquestPlan=void 0;const s=i(89764),n=i(70712),o=i(56824),a=i(8065),r=i(56038),l=i(78635),c=i(7334),d=i(22973),h=i(76985),u=i(91622),p=i(18497),g=i(19580),m=i(9292),y=o.logger.for("ConquestPlan");t.ConquestPlan=class{constructor(e,t,i){this.hex=e,this.path=t,this.scoreFactors=i,this.endsTurn=!1,this.endsGame=!1,this.isConquest=!0,this.score=(0,a.aggregateScoreFactors)(this.scoreFactors),this.endsGame=this.scoreFactors.conquestValue.factors.damageToEnemy>=g.GAME_ENDING_MOVE_SCORE}doExecute(e,t){const i=(0,m.pickLarger)(this.scoreFactors.conquestValue.factors.damageToEnemy-20,0),n=e.game.model.factions.byHex(this.hex),o=e.game.model.regions.byHex(this.hex),a=n?.rawPower??0;let l=0;for(let t of this.path){const i=e.game.model.warfare.getHexDefense(t);if(r.Regions.getByHex(e.state,t.id)===e.region.id)continue;const n=s.RegionAssets.fromMyRegion(e.region).useUnit({requiredMight:i+1,allowOverkill:!0,...(0,h.getMaxMightForHex)(e.state,t)});if(!n)return!1;if(l+=n.might,!e.marshal.moveUnit(t,n))return!1}const c=a-(n?.rawPower??0),d=this.calculateRealScore(c,l);return!(o?.isAlive()&&i>0&&d<this.score&&!u.inject.gameStateModel.plugins.has(p.PluginKey.AlwaysRetreat))||d>t||this.extendPlanFrom(e,this.hex,o,{damageSoFar:c,investmentSoFar:l,minimalScore:t,latestExpectedDamage:i})}execute(e,t){return this.doExecute(e,t)}calculateRealScore(e,t){if(0===this.scoreFactors.conquestValue.factors.damageToEnemy)return this.score;const i=this.scoreFactors.mightInvestment/t,s=e/this.scoreFactors.conquestValue.factors.damageToEnemy;return this.score*i*s}extendPlanFrom(e,t,i,s){if(!i.faction)return!1;const o=i.faction.rawPower,a=t.neighbours((t=>r.Regions.getByHex(e.state,t.id)===i.id)).members.reduce(((t,i)=>{const s=n.AI.getHexImportance(e.state,i.id).value;if(s>t.importance){const n=l.Warfare.getHexDefense(e.state,i),o=e.region.getMyAssets().useUnit({requiredMight:n+1,allowOverkill:!0,incomeGain:1,...(0,h.getMaxMightForHex)(e.state,i),fortificationGain:d.Fortification.getDeltaAfterConquest(e.state,i.id,e.region.id)});return o?{hex:i,importance:s,plan:o}:t}return t}),{importance:0});if(!a.hex)return y.warning("Conquest plan failed: failed to extend plan"),!1;const c=a.importance,u=s.investmentSoFar+a.plan.might;if(c<s.latestExpectedDamage)return y.warning(`Conquest plan canceled: estimated damage if continued to hex ${a.hex} has downward gradient (${c}<${s.latestExpectedDamage})`),!1;if(!e.marshal.moveUnit(a.hex,a.plan))return!1;const p=o-i.faction.rawPower,g=s.damageSoFar+p;return!(this.calculateRealScore(g,u)<s.minimalScore)||this.extendPlanFrom(e,a.hex,i,{minimalScore:s.minimalScore,damageSoFar:g,investmentSoFar:u,latestExpectedDamage:c})}hash(){const e=this.path.slice(0,this.path.length-1);return`Conquer #${this.hex.id}${e.length>0?` through ${e.map((e=>"#"+e.id)).join(", ")}]`:""}`}toString(){return this.endsGame?`[WIN GAME | ${this.hash()}]`:`[${(0,c.formatNumber)(this.score)} | ${this.hash()}`}toDebugString(){return(0,a.describeScoreFactors)(this.scoreFactors)}}},70614:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventQueue=void 0,t.EventQueue=class{constructor(){this.sources=[],this.pendingEvents=[]}addSource(e){this.sources.push(e((e=>this.push(e))))}push(e){this.pendingEvents.push(e)}hasNext(){return this.pendingEvents.length>0}next(){return this.pendingEvents.shift()}unsubscribe(){this.sources.forEach((e=>e.unsubscribe()))}clear(){this.pendingEvents=[]}}},70712:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AIMutations=t.AI=t.BLANK_HISTORY_RECORD=void 0;const s=i(90952),n=i(35347),o=i(20026),a=i(19618),r=i(1326),l=i(1055),c=i(23867),d=i(91622),h=i(13560),u=i(78635),p=i(56038),g=i(63521),m=i(45084),y=i(27109),f=i(88023),w=i(9292);t.BLANK_HISTORY_RECORD=Object.freeze({capturedAt:0,previousFactionId:0,spoils:"deadHex"});class v{static model(e){return this.models.get(e)}static getHexDepth(e,t){return(0,o.selectFromState)(e,s.GameState.ai.hexDepth,t)??Number.POSITIVE_INFINITY}static getHexImportance(e,t){return(0,o.selectFromState)(e,s.GameState.ai.hexImportance,t)??n.NO_IMPORTANCE}static getRegionAssetsValue(e,t){return(0,o.selectFromState)(e,s.GameState.ai.assetsValueByRegion,t)??h.NO_ASSET_VALUE}static getFactionPower(e,t){return d.inject.views.powerByFactionView.get(e,t)}static getFactionScaledPower(e,t){return this.getFactionPower(e,t).scaledTotal}static getFactionRawPower(e,t){return this.getFactionPower(e,t).rawTotal}static getRegionAttrition(e,t,i){const n=(0,o.selectFromState)(e,s.GameState.ai.attritionByRegion,t)||{};return void 0===i?n:n[i]||0}static getHexInfluence(e,t,i){if(void 0===i)return(0,o.selectFromState)(e,s.GameState.ai.regionInfluenceByHex,t)||(0,f.ImmutableMap)();{const n=(0,o.selectFromState)(e,s.GameState.ai.regionInfluenceByHex,t)||(0,f.ImmutableMap)();return void 0===i?n:n.get(i)}}static inflictRegionAttrition(e,t,i,s){return(0,o.applyMutations)(e,b.inflictRegionAttrition(e,t,i,s))}static inflictGlobalAttrition(e,t,i,s){return(0,o.applyMutations)(e,b.inflictGlobalAttrition(e,t,i,s))}static setHexHistory(e,t,i){return(0,o.applyMutations)(e,b.setHexHistory(e,t,i))}static changeFactionAttrition(e,t,i){const s=b.updateAllRegionAttrition(e,a.Factions.getFactionRegions(e,t),i),n=b.updateExtraFactionAttrition(e,t,i);return(0,o.applyMutations)(e,s,n)}static changeFactionCredit(e,t,i,s){return(0,o.applyMutations)(e,b.changeCredit(e,t,i,s))}static getFactionCredit(e,t,i){const n=(0,o.selectFromState)(e,s.GameState.ai.credit,t);return n?void 0===i?n:n[i]||0:0}static getFactionTotalAttrition(e,t){const i=d.inject.views.attritionByFaction.get(e,t);return Object.values(i).reduce(w.sum,0)}static getFactionAttrition(e,t,i){const s=d.inject.views.attritionByFaction.get(e,t);return s?void 0===i?s:s[i]||0:void 0===i?{}:0}static getFactionExtraAttrition(e,t){return(0,o.selectFromState)(e,s.GameState.ai.extraAttritionByFaction,t)??{}}static getFactionFear(e,t,i){return d.inject.views.fear.get(e,{fromFactionId:t,towardsFactionId:i})}static getRegionInfluence(e,t,i){const n=(0,o.selectFromState)(e,s.GameState.ai.regionInfluenceByRegion,i);if(n)return n.get(t)}static getFactionInfluenceByRegion(e,t,i,s=c.PowerMeasurement.MilitaryMight,n=1/0){return d.inject.views.factionInfluenceByRegion.get(e,{influencingFaction:t,targetRegion:i,maxDistance:n,powerMeasurement:s})}static getFactionAttitude(e,t,i){return d.inject.views.attitude.get(e,{fromFactionId:t,towardsFactionId:i})}static getHexAssetValue(e,t){return s.GameState.ai.hexAssetValue.getEntryById(e,t)??h.NO_ASSET_VALUE}static getTotalHexAssetValue(e,t){return h.AssetValue.total(s.GameState.ai.hexAssetValue.getEntryById(e,t)??h.NO_ASSET_VALUE)}static getRegionCapitalHex(e,t){return s.GameState.ai.capitalTown.getEntryById(e,t)?.townHexId}static isCapitalTown(e,t){const i=p.Regions.getByHex(e,t);return!!i&&v.getRegionCapitalHex(e,i)===t}static canPlaceDefenderAt(e,t,i,s){const n=p.Regions.getByHex(e,t.id);if(!n)return!1;if(n===i.id){const i=u.Warfare.getOccupyingPawn(e,t);return!i||i.isMovable()||i.hasTrait(g.PawnTraits.Pest)}return u.Warfare.getHexDefense(e,t)<s}static isUnderAttackByRegion(e,t,i){return v.getRegionAttrition(e,t,i)>5}static isUnderAttackByFaction(e,t,i){return v.getFactionAttrition(e,t,i)>5}static getHexHistory(e,i){return(0,o.selectFromState)(e,s.GameState.ai.hexHistory,i)??t.BLANK_HISTORY_RECORD}static getHexAge(e,t){const i=a.Factions.getByHex(e,t)??0;if(0===this.getHexHistory(e,t).capturedAt)return Number.POSITIVE_INFINITY;const s=m.CurrentPhase.getFaction(e)??0;return(0===s||i<=s?m.CurrentPhase.getTurnNumber(e):m.CurrentPhase.getTurnNumber(e)-1)-this.getHexHistory(e,t).capturedAt}}t.AI=v,v.models=new y.ModelsCache((e=>new l.AIModel(e)));class b{static inflictRegionAttrition(e,t,i,n){const a={};for(let r of t){const t=(0,o.selectFromState)(e,s.GameState.ai.attritionByRegion,r)||{},l={...t,[i]:(t[i]||0)+n};a[r]=l}return s.GameState.ai.attritionByRegion.createMutation({set:a},"inflictRegionAttrition")}static updateAllRegionAttrition(e,t,i){const n={};return t.forEach((t=>{const a=(0,o.selectFromState)(e,s.GameState.ai.attritionByRegion,t)||{},l=(0,r.mapDictionary)(a,i);n[t]=l})),s.GameState.ai.attritionByRegion.createMutation({set:n},"updateRegionAttrition")}static inflictGlobalAttrition(e,t,i,n){const a=(0,o.selectFromState)(e,s.GameState.ai.extraAttritionByFaction,t)||{},r={...a,[i]:(a[i]??0)+n};return s.GameState.ai.extraAttritionByFaction.createMutation({set:{[t]:r}},"inflictGlobalAttrition")}static updateExtraFactionAttrition(e,t,i){const n=(0,o.selectFromState)(e,s.GameState.ai.extraAttritionByFaction,t)||{},a=(0,r.mapDictionary)(n,i);return s.GameState.ai.extraAttritionByFaction.createMutation({set:{[t]:a}},"updateExtraFactionAttrition")}static setHexHistory(e,t,i){return s.GameState.ai.hexHistory.createMutation({set:{[t]:i}},"updateHexHistory")}static changeCredit(e,t,i,n){const a=(0,o.selectFromState)(e,s.GameState.ai.credit,t)||{},r=n(a[i]||0),l={...a,[i]:r};return s.GameState.ai.credit.createMutation({set:{[t]:l}},"changeCredit")}}t.AIMutations=b},70785:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ControlPanel=void 0;const s=i(86545),n=i(80959),o=i(56824),a=i(36868),r=i(91622),l=i(48379),c=i(54825),d=i(20087),h=i(76049),u=i(55275),p=i(2543),g=i(39648),m=i(80075);class y extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.props=(0,u.stateContainer)({turn:1,firstMove:!0,difficulty:"hard",isPlayerTurn:!0,isFixedDifficulty:!1,rewindsLeft:3},this.applyState.bind(this)),this.ui=n.UiBuilder.for(this.scene),this.mainBg=this.ui.roundedRect(0,0),this.leftBg=this.ui.roundedRect(0,0),this.statusIcon=this.ui.image("ui/level-icons/gold"),this.statusText=this.ui.text("???",h.BitmapFont.Small,0),this.difficultyText=this.ui.text("???",h.BitmapFont.Mini,0),this.previousBestText=this.ui.text("???",h.BitmapFont.Mini,0),this.livesCounter=new g.LivesCounter(this.scene,0),this.rewindButton=this.ui.outlineButton({variant:"small",text:"Rewind",icon:"ui/button-icons/rewind",theme:"white",onClicked:()=>{o.events.trigger(a.UserActions.StartRewind())},iconPlacement:"left"}),this.restartButton=this.ui.outlineButton({variant:"small",text:"Restart / Change difficulty",icon:"ui/button-icons/restart",theme:"white",onClicked:()=>{o.events.trigger(a.UserActions.RestartLevel({}))},iconPlacement:"left"}),this.replayButton=this.ui.outlineButton({variant:"small",text:"View Replay",icon:"ui/button-icons/replay",theme:"white",onClicked:()=>{o.events.trigger(a.UserActions.ViewReplay())},iconPlacement:"left"}),this.backButton=this.ui.wood.primaryButton({text:"LEAVE",icon:"ui/wood-icons/arrow-left",iconPlacement:"left",width:120,onClicked:()=>o.events.trigger(a.UserActions.ExitLevel())}).setScrollFactor(0),this.continueButton=this.ui.wood.primaryButton({text:"CONTINUE",width:200,onClicked:()=>{o.events.trigger(a.UserActions.TogglePlayMenu())}}).setScrollFactor(0),this.secondaryButtons=[this.replayButton,this.rewindButton,this.restartButton],this.livesCounter.setSize(80,20),this.livesCounter.setMode(g.LivesCounterMode.FullColor).setAlpha(1),r.inject.theme.use((e=>{this.mainBg.setFillStyle(e.oceanShades.dark3,1),this.mainBg.setLineStyle(e.oceanShades.dark4,1),this.leftBg.setFillStyle(e.oceanShades.dark4),this.statusText.setTint(e.white),this.difficultyText.setTint(e.white),this.previousBestText.setTint(e.white)})),this.add([this.mainBg,this.leftBg,...this.secondaryButtons,this.backButton,this.continueButton,this.statusIcon,this.statusText,this.difficultyText,this.previousBestText,this.livesCounter])}applyState(e,t){this.statusText.setText(`Turn ${t.turn}`),this.difficultyText.setText(`${(0,p.capitalize)(t.difficulty)} difficulty`),this.difficultyText.setVisible(!t.isFixedDifficulty),t.previousBest?(this.previousBestText.setVisible(!0),this.previousBestText.setText(`Personal best: ${t.previousBest} turns`)):this.previousBestText.setVisible(!1),this.statusIcon.setFrame("hard"===t.difficulty||t.isFixedDifficulty?"ui/level-icons/gold":"ui/level-icons/silver"),this.livesCounter.setCount(t.rewindsLeft),this.rewindButton.setEnabled((0,m.canRewind)()),this.livesCounter.setMode(this.rewindButton.props().disabled?g.LivesCounterMode.Muted:g.LivesCounterMode.FullColor),this.replayButton.setEnabled(t.turn>1&&t.isPlayerTurn),this.updateLayout()}getLayout(){return l.PLAY_MENU_LAYOUT[c.app.device.uiVariant()].controlPanel}updateLayout(){const e=this.getLayout(),t=e.backButtonWidth+2*e.padding,i=this.width-t-2*e.padding,s=[...this.secondaryButtons,this.continueButton];d.Arrange.topToBottom({content:s,spacing:e.buttonSpacing,origin:0,y:e.padding}),d.Arrange.alignX({content:s,x:t+e.padding,origin:0,width:i}),this.restartButton.content.setText(i<185?"Restart":"Restart / Change difficulty"),this.continueButton.updateLayout(),this.backButton.setPosition(e.padding,this.continueButton.y),this.backButton.width=e.backButtonWidth;const n=this.livesCounter.getContentWidth();this.livesCounter.updateLayout(),this.rewindButton.content.setOffset({x:n?-n/2-6:0}),this.rewindButton.updateLayout(),this.livesCounter.setPosition(this.rewindButton.x+this.rewindButton.content.text.x+this.rewindButton.content.text.width+6,this.rewindButton.y+this.rewindButton.height/2-this.livesCounter.height/2),this.updateSize(),this.mainBg.radius={tr:e.cornerRadius,tl:e.cornerRadius,br:0,bl:0},this.leftBg.radius={tr:0,br:0,tl:e.cornerRadius,bl:0},this.mainBg.setSize(this.width,this.height),this.leftBg.setSize(t,this.height),this.statusIcon.setPosition(e.padding,e.padding),d.Arrange.topToBottom({content:[this.statusText,this.difficultyText],spacing:4,origin:.5,y:e.padding+this.statusIcon.height/2}),d.Arrange.alignX({content:[this.statusText,this.difficultyText],x:e.padding+this.statusIcon.width+e.paddingAfterIcon,origin:0}),this.previousBestText.setPosition(e.padding,this.statusIcon.y+this.statusIcon.height+e.padding)}calculateHeight(){return this.backButton.y+this.backButton.height+this.getLayout().paddingBottom}}t.ControlPanel=y},70842:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TutorialArrow=void 0;const s=i(7782),n=i(40951),o=i(9292);var a=Phaser.GameObjects.Image;t.TutorialArrow=class extends a{constructor(e){super(e,0,0,"atlas","ui/tutorial-arrow"),this.position=null,this.cX=s.Control.propOf(this,"x"),this.cY=new s.TransitionController(this.scene,{applyValue:e=>{this.y=e+6*this.jumpClock.getValue()}}),this.visibility=new s.TransitionController(this.scene,{applyValue:(e,t)=>{this.alpha=e,this.scale=t>e?(0,o.pickSmaller)(1/e,3):e},initialValue:0,delay:100,ease:"Sine.easeOut"}),this.jumpClock=this.scene.tweens.addCounter({from:0,to:1,ease:"Sine.easeInOut",repeat:-1,yoyo:!0,duration:n.TIMING.tutorialArrowJumpDuration}),this.visibility.applyValue(0,0)}showAt(e){this.position=e,this.updatePosition(1===this.visibility.currentTarget),this.visibility.transitionTo(1)}updatePosition(e=!1){if(this.position)try{const{x:t,y:i,width:s,height:n}=this.position(),o=t+s/2,a=i-n/2+6;o!==this.cX.targetValue&&(e?this.cX.transitionTo(o):this.cX.setTo(o)),a!==this.cY.currentTarget?e?this.cY.transitionTo(a):this.cY.setTo(a):this.cY.applyValue(this.cY.currentValue,this.cY.currentValue)}catch(e){this.setVisible(!1)}}hide(){this.position=null,this.visibility.transitionTo(0)}}},71021:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NewGameStateContext=void 0;const i={showPlayMenu:!1};t.NewGameStateContext={StartingNewGame:{name:"starting new game",...i,showIntro:!0,startFactionTurn:!0,flushHistory:!0,resetCamera:!1,resetSurrender:!0,unpackRewinds:!1},LoadingGame:{name:"loading game",...i,startFactionTurn:!0,flushHistory:!0,resetCamera:!0,resetSurrender:!0,unpackRewinds:!1,showIntro:!0},ResumingGame:{name:"resuming game",...i,startFactionTurn:!0,flushHistory:!1,resetCamera:!1,resetSurrender:!0,unpackRewinds:!1,showIntro:!0},LoadingGameStateForDebug:{name:"loading game state for debug",...i,startFactionTurn:!1,flushHistory:!1,resetCamera:!1,resetSurrender:!1,unpackRewinds:!1,showIntro:!1},Preview:{name:"loading game state for preview",...i,startFactionTurn:!1,flushHistory:!1,resetCamera:!1,resetSurrender:!1,unpackRewinds:!1,showIntro:!1},Undo:{name:"undo",...i,startFactionTurn:!1,flushHistory:!1,resetCamera:!1,resetSurrender:!1,unpackRewinds:!1,showIntro:!1},Rewind:{name:"rewind",...i,startFactionTurn:!1,flushHistory:!1,resetCamera:!1,resetSurrender:!1,unpackRewinds:!1,showIntro:!1},ViewReplayAfterGameOver:{name:"view replay after gameover",...i,startFactionTurn:!1,flushHistory:!1,resetCamera:!0,resetSurrender:!1,unpackRewinds:!1,showIntro:!1},ContinueSpectatingAfterGameOver:{name:"continue spectating after gameover",...i,startFactionTurn:!1,flushHistory:!1,resetCamera:!0,resetSurrender:!1,unpackRewinds:!1,showIntro:!1},LoadReplay:{name:"load replay",...i,startFactionTurn:!1,flushHistory:!0,resetCamera:!0,resetSurrender:!1,unpackRewinds:!1,showIntro:!1},LevelScript:{name:"level script map modification",...i,startFactionTurn:!1,flushHistory:!1,resetCamera:!1,resetSurrender:!1,unpackRewinds:!1,showIntro:!1}}},71262:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateMap=async function(e,t=async()=>{await(0,l.sleep)(1)}){await P(e.land.width,e.land.height);const i=(0,d.createRandomGenerator)(e.seed);await(0,s.generateLandmass)(r.inject.gameStateModel,i,{...e.land,seed:e.seed});const o=e.regionsVariation-1;e.generateRegions?await(0,n.generateRegions)(r.inject.gameStateModel,i,{...e.regions,seed:e.seed+o,startingTiles:e.spawnTowns?e.regions.startingTiles:0},t):r.inject.gameStateModel.activateAllProjections(),(e.zombify||(0,w.isHalloweenMode)())&&(0,h.zombifyLevelModel)(r.inject.gameStateModel),e.firstLanding&&function(e,t,i){const s=p.WorldMap.get(e.state),n={plugins:(0,u.stripDuplicatesFrom)([...s.plugins,g.PluginKey.PickLandingSpot]),pluginOptions:{...s.pluginOptions,initialTreasury:t}};e.stateEngine.setState(p.WorldMap.update(e.state,n)),function(e,t){const i=r.inject.views.landingSpots.get(e.state);if(i.length<3){S.warning(`Not enough landing spots on the map (${i.length}), adding more`);const n=Array.from((s=e.state,v.Regions.getCoastalHexes(s).filter((e=>b.Pawns.isPresentOnHex(s,e.id,y.PawnType.Forest)))));let o=3-i.length;for(;n.length&&o>0;){const i=t.popFrom(n);i&&(e.pawns.destroy(...e.pawns.byHex(i)),o--)}}var s}(e,i)}(r.inject.gameStateModel,e.firstLanding.startingCoins,i),e.spawnChristmasTree&&function(e){const t=r.inject.views.distanceFromCoast.get(e.state);function i(t){return t.disjointedNeighbourGroups((t=>!e.warfare.isImpassable(t))).getGroups().length>1}const s=(0,u.findMax)(t.getHexIds(),(s=>{const n=(0,m.getHex)(s),o=t.getDistanceTo(n);return console.log("hex",s,"distance",o,"isOccupied",e.warfare.isOccupied(n),"staticDefense",e.warfare.getHexStaticDefense(n),"isPotentialChokePoint",i(n)),e.warfare.isOccupied(n)||e.pawns.traitPresentAtHex(n,f.PawnTraits.Terrain)||e.warfare.getHexStaticDefense(n)>0||i(n)?-1/0:void 0===n.findNeighbour((t=>!!e.regions.byHex(t)?.isAlive()))?o+1:o}));if(s){const t=(0,m.getHex)(s);e.factions.neutral.takeOverHex(t),e.pawns.create({hex:t,type:y.PawnType.Spawner,name:"Christmas Tree"})}const n={plugins:(0,u.stripDuplicatesFrom)([...p.WorldMap.get(e.state).plugins,g.PluginKey.SpawnGifts,g.PluginKey.BuyGifts])};e.stateEngine.setState(p.WorldMap.update(e.state,n))}(r.inject.gameStateModel),e.spawnRuins&&(x(r.inject.gameStateModel),T(r.inject.gameStateModel,i))},t.enableOccupationMode=x,t.spawnRuins=T,t.createBlankMap=P;const s=i(91683),n=i(17301),o=i(72273),a=i(67274),r=i(91622),l=i(10131),c=i(56824),d=i(35800),h=i(32202),u=i(1326),p=i(59956),g=i(18497),m=i(45664),y=i(24598),f=i(63521),w=i(53360),v=i(56038),b=i(81434),S=c.logger.for("generateMap");function x(e){const t={plugins:(0,u.stripDuplicatesFrom)([...p.WorldMap.get(e.state).plugins,g.PluginKey.CaptureTowns])};e.stateEngine.setState(p.WorldMap.update(e.state,t))}function T(e,t){const i=e.regions.all().filter((e=>!e.isAlive()&&!e.faction?.isNeutral()&&!e.getNeighbours().some((e=>e.isAlive())))),s=new Set;for(const n of i){if(n.getNeighbours().some((e=>s.has(e))))continue;s.add(n);const i=n.hexes.getRandomHex(t);i&&e.pawns.create({hex:i,type:y.PawnType.TownRuins})}}function P(e,t,i=d.ID_TYPE.Level){const s=(0,a.createBlankGameState)(c.random.id(i),{width:e,height:t}),n=r.inject.gameStateModel;n.restore(s),n.useProjections(o.ProjectionPresets.coreEntities)}},71276:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexDefenseSourcesProjection=t.NO_DEFENSE=void 0;const s=i(31011),n=i(45664),o=i(63521),a=i(20026),r=i(45084),l=i(81434),c=i(4005),d=i(97849),h=i(19506),u=i(9292),p=i(88023);t.NO_DEFENSE=Object.freeze({unitDefense:0,buildingDefense:0,unitProtection:0,buildingProtection:0,totalDefense:0,totalProtection:0});class g extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.eager=!1,this.update=new m(this).update}bootstrap(e){return(0,p.ImmutableMap)().withMutations((t=>{(0,n.getHexes)((0,a.selectFromState)(e,this.sources.regionByHex).keySeq().toArray()).forEach((i=>{const s=this._calculate(e,i);s.totalDefense>0&&t.set(i.id,s)}))}))}_calculate(e,t){const i=l.Pawns.model(e).byHex(t).filter((t=>!r.CurrentPhase.isMovable(e,t.id))),s=i.find((e=>e.hasTrait(o.PawnTraits.Unit))),n=i.find((e=>e.hasTrait(o.PawnTraits.Building))),a=i.find((e=>e.hasTrait(o.PawnTraits.OccupiesTile))),c=s?.defenseMight||0,d=s?.protection||0,h=n?.defenseMight||0,p=n?.protection||0;return{unitDefense:c,unitProtection:d,buildingDefense:h,buildingProtection:p,totalDefense:Math.max(c,h,a?.defenseMight||0),totalProtection:(0,u.pickLarger)(d,p)}}entryToString(e){return`${e.totalDefense}${e.buildingDefense>0?h.GLYPH.whiteFlag:""}`}}t.HexDefenseSourcesProjection=g;class m extends c.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}initialize(){this.pawns=l.Pawns.model(this.newState),this.dirtyHexes=new Set}registerHandlers(e){e(this.dataSet.sources.pawnsByHex,(e=>this._handlePawnsByHexChange(e))),e(this.dataSet.sources.movableUnits,(e=>this._handleMovableUnitsChange(e)))}createMutation(){return this.dirtyHexes.forEach((e=>{const t=this.dataSet._calculate(this.newState,e);t.unitDefense||t.buildingDefense?this.builder.set(e.id,t):this.builder.delete(e.id)})),super.createMutation()}invalidate(e){d.assert.defined(e,"attempted to add undefined into dirtyHexes"),this.dirtyHexes.add(e)}_handlePawnsByHexChange(e){e.updated?.forEach((e=>{e.removed?this.invalidate((0,n.getHex)(e.id)):e.added&&this._addDefenders(e.added)}))}_handleMovableUnitsChange(e){e.addedEntries?.forEach((e=>{const t=this.pawns.byId(e)?.hex;t&&this.invalidate(t)})),e.deletedEntries&&this._addDefenders(e.deletedEntries)}_addDefenders(e){e.forEach((e=>{const t=this.pawns.byId(e);if(!t||r.CurrentPhase.isMovable(this.newState,e))return;const i=this.pawns.byId(e)?.hex;if(!i)return;const s=this.builder.getCurrent(i.id);let n=s?.unitDefense||0,a=s?.unitProtection||0,l=s?.buildingDefense||0,c=s?.buildingProtection||0;const d=t.hasTrait(o.PawnTraits.OccupiesTile)?t.defenseMight:0;t.hasTrait(o.PawnTraits.Unit)&&(n=t.defenseMight,a=t.protection),t.hasTrait(o.PawnTraits.Building)&&(l=t.defenseMight,c=t.protection),this.builder.set(i.id,{unitDefense:n,unitProtection:a,buildingDefense:l,buildingProtection:c,totalDefense:Math.max(n,l,d),totalProtection:(0,u.pickLarger)(a,c)})}))}}},71376:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CapitalTownUpdater=t.CapitalTownProjection=void 0,t.createCapitalTownDebugLayer=function(){return new l.GameStateDebugLayer((0,c.hexBasedAdapter)({getValue(e,t){const i=o.Regions.getByHex(e,t);if(i)return(0,a.selectFromState)(e,d.GameState.ai.capitalTown,i)?.townHexId===t?h.GLYPH.redFlag:void 0},getDetail(e,t){}}))};const s=i(31011),n=i(56824),o=i(56038),a=i(20026),r=i(4005),l=i(76439),c=i(12543),d=i(90952),h=i(19506),u=i(49568);n.logger.for("CapitalTownProjection");class p extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new g(this).update}bootstrap(e){const t=new g(this);return t.initFromState(e),o.Regions.getAll(e).filter((t=>o.Regions.model(e).byId(t).isAlive())).forEach((e=>t.invalidateRegion(e))),t.getMap()}entryToString(e){return e.townHexId.toString()}entryToDebugString(e){return e.townHexId.toString()}}t.CapitalTownProjection=p;class g extends r.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedRegions=new Set,this}registerHandlers(e){e(this.dataSet.sources.townsByRegion,this.handleTownsByRegionChange),e(this.dataSet.sources.regionInfluenceByHex,this.handleHexInfluenceChange)}handleTownsByRegionChange(e){e.updated?.forEach((e=>{this.invalidateRegion(e.id)}))}handleHexInfluenceChange(e){e.updated?.forEach((([e])=>{const t=o.Regions.getByHex(this.newState,e);t&&this.invalidateRegion(t)}))}createMutation(){return this.updateInvalidated(),super.createMutation()}invalidateRegion(e){const t=o.Regions.model(this.newState).byId(e);t&&!this.invalidatedRegions.has(t.id)&&(t.isAlive()?this.invalidatedRegions.add(e):t.hexes.forEach((e=>this.builder.delete(e.id))))}updateInvalidated(){for(let e of this.invalidatedRegions)this.updateForRegion(e)}updateForRegion(e){const t=o.Regions.model(this.newState).byId(e);if(!t)return;const i=this.dataSet.sources.townsByRegion.getEntryById(this.newState,e)??[];let s,n=0;for(let e of i){const i=this.dataSet.sources.regionInfluenceByHex.getEntryById(this.newState,e)||(0,u.Map)();let a=Number.POSITIVE_INFINITY;for(let[e,s]of i.entries()){const i=o.Regions.model(this.newState).byId(e);i?.isAlive()&&i?.faction!==t.faction&&s.resistance<a&&(a=s.resistance)}(void 0===s||a>n)&&(s=e,n=a)}void 0!==s&&this.builder.get(e)?.townHexId!==s&&this.builder.set(e,{townHexId:s})}getMap(){return this.updateInvalidated(),(0,u.Map)(this.builder.getEntries()).mapKeys((e=>Number(e)))}}t.CapitalTownUpdater=g},72172:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VictoryTurnsRibbon=t.VerticalRibbon=void 0;const s=i(86545),n=i(7782),o=i(76049),a=i(96137),r=i(20087),l=i(66143);var c=Phaser.GameObjects.NineSlice,d=Phaser.GameObjects.BitmapText,h=Phaser.GameObjects.Image;class u extends c{constructor(e){super(e,0,0,"atlas","ui/ribbon/vertical-ribbon-purple",35,void 0,0,0,4,12)}}t.VerticalRibbon=u;class p extends s.BaseResponsiveContainer{constructor(e){super(e),this.ribbon=new u(e).setOrigin(0,0),this.width=this.ribbon.width,this.visibilityController=new n.TransitionController(this.scene,{duration:250,ease:Phaser.Math.Easing.Back.Out,applyValue:e=>{this.ribbon.height=10+(this.targetHeight-10)*e,this.turnCount.setAlpha(e),this.turnsLabel.setAlpha(.5*e);const t=(1-e)*(this.targetHeight-14-26);this.updateTextPosition(-t)},initialValue:0}),this.turnCount=new d(e,0,0,o.BitmapFont.Main,"99").setTint(a.Colors.glassUi_old.shapeLightAccent).setOrigin(.5,0),this.turnsLabel=new h(e,0,0,"atlas","ui/detail-window/turns-mini-label").setOrigin(.5,0),this.turnCount.x=this.width/2,this.turnsLabel.x=this.width/2,this.visibilityController.applyCurrentValue(),this.add([this.ribbon,this.turnCount,this.turnsLabel])}isShown(){return 1===this.visibilityController.currentTarget}show(e,t){const i=e===l.LevelStatus.GoldMedal,s=i?"ui/ribbon/vertical-ribbon-purple":"ui/ribbon/vertical-ribbon-white";this.ribbon.setFrame(s),this.targetHeight=t,this.turnCount.setTint(i?a.Colors.glassUi_old.shapeLightAccent:a.Colors.glassUi_old.primaryText),this.turnsLabel.setTint(i?a.Colors.glassUi_old.shapeLightAccent:a.Colors.glassUi_old.primaryText),this.visibilityController.applyCurrentValue(),this.visibilityController.transitionTo(1)}setCount(e){this.turnCount.setText(e.toString())}hide(){this.visibilityController.transitionTo(0)}updateTextPosition(e=0){const t=26+(this.targetHeight-14-26)/2;r.Arrange.topToBottom({content:[this.turnCount,this.turnsLabel],y:t+e,origin:.5,spacing:0})}updateLayout(){}}t.VictoryTurnsRibbon=p},72273:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameStateModel=t.StaticGameStateModel=t.ProjectionPresets=void 0,t.checkForInvalidReferences=P,t.describeState=function(e){return`[GameState (${e.map.width}x${e.map.height}, ${e.factions.length}, ${e.regions.length},${I(e.currentPhase)})]`},t.describePhase=I,t.readOnlyModelOf=function(e){return new T(e)};const s=i(56824),n=i(18957),o=i(90952),a=i(75136),r=i(78635),l=i(96704),c=i(19162),d=i(56038),h=i(20026),u=i(81434),p=i(19618),g=i(61634),m=i(45084),y=i(59956),f=i(70712),w=i(91622),v=i(45664),b=i(97849),S=i(59255);s.logger.for("GameStateModel");let x=!1;t.ProjectionPresets={coreEntities:[...Object.values(o.GameState.regions),...Object.values(o.GameState.factions),...Object.values(o.GameState.pawns)],onlyNecessaryForPartialSync:[...Object.values(o.GameState.regions),...Object.values(o.GameState.factions),...Object.values(o.GameState.pawns),o.GameState.economy.townsByRegion,o.GameState.warfare.hexStaticDefense],coreEntitiesAndSystems:[...Object.values(o.GameState.regions),...Object.values(o.GameState.factions),...Object.values(o.GameState.pawns),...Object.values(o.GameState.units),...Object.values(o.GameState.warfare),...Object.values(o.GameState.currentPhase),...Object.values(o.GameState.economy)],all:[...Object.values(o.GameState.regions),...Object.values(o.GameState.factions),...Object.values(o.GameState.pawns),...Object.values(o.GameState.units),...Object.values(o.GameState.currentPhase),...Object.values(o.GameState.warfare),...Object.values(o.GameState.economy),...Object.values(o.GameState.ai),...Object.values(o.GameState.bandits)]};class T{constructor(e){this.state=e}get map(){return y.WorldMap.model(this.state)}get rules(){return c.Rules.model(this.state)}get regions(){return d.Regions.model(this.state)}get factions(){return p.Factions.model(this.state)}get pawns(){return u.Pawns.model(this.state)}get currentPhase(){return m.CurrentPhase.model(this.state)}get warfare(){return r.Warfare.model(this.state)}get economy(){return g.Economy.model(this.state)}get ai(){return f.AI.model(this.state)}get plugins(){return this.map.plugins}}function P(e){!function(e,t){const i=t.getEntryIds(e).map((i=>({hexId:i,entry:t.getEntryById(e,i)})));for(let e of i)for(let[t,i]of e.entry.entries())s(t,e.hexId,i);function s(i,s,o){const a=(0,v.getHex)(s);if(n(!o.parent||!o.children.has(o.parent),`Cyclical dependency found between hexes #${a.id} and ${o.parent?.id} for region ${i}`),o.parent){const s=t.getEntryById(e,o.parent.id)?.get(i);n(s?.children.has(a),`Hex #${a.id} has parent #${o.parent.id}, but it's not among this hexes children (${o.children.map((e=>e.id))})`)}for(let s of o.children){const r=t.getEntryById(e,s.id)?.get(i);n(r,`Hex #${a.id} has children [${o.children.map((e=>e.id)).join(",")}] for region #${i}, but child #${s.id} has no entry in the dataset for this region`),n(r.parent===a,`Hex #${a.id} has children [${o.children.map((e=>e.id)).join(",")}] for region #${i}, but child #${s.id} has parent ${r?.parent}`)}}function n(e,i){(0,b.assert)(e,`State integrity check failure in ${t.key}: ${i}`)}}(e,o.GameState.ai.regionInfluenceByHex)}function I(e){return`${e.type}`&&e.faction?`/${e.faction}`:""}t.StaticGameStateModel=T,t.GameStateModel=class{get map(){return y.WorldMap.model(this.state)}get rules(){return c.Rules.model(this.state)}get plugins(){return this.map.plugins}get regions(){return d.Regions.model(this.stateEngine)}get factions(){return p.Factions.model(this.stateEngine)}get pawns(){return u.Pawns.model(this.stateEngine)}get currentPhase(){return m.CurrentPhase.model(this.stateEngine)}get warfare(){return r.Warfare.model(this.stateEngine)}get economy(){return g.Economy.model(this.stateEngine)}get ai(){return f.AI.model(this.stateEngine)}get state(){return this.stateEngine.currentState}constructor(e){this.onNewState=(0,n.signal)(),this.stateEngine=new a.StateEngine,this.loadDataSets(),e&&((0,h.isImmutableState)(e)?this.stateEngine.setState(e):this._importState(e))}suspendAllProjections(){this.stateEngine.suspendAllProjections()}useProjections(e){return this.stateEngine.activateOnly(...e),this}activateAllProjections(){return this.stateEngine.activateAllProjections(),this}loadDataSets(){this.stateEngine.add(o.GameState.version,o.GameState.map,o.GameState.ruleSet,...Object.values(o.GameState.regions),...Object.values(o.GameState.factions),...Object.values(o.GameState.pawns),...Object.values(o.GameState.units),...Object.values(o.GameState.currentPhase),...Object.values(o.GameState.warfare),...Object.values(o.GameState.economy),...Object.values(o.GameState.ai),...Object.values(o.GameState.bandits)),this.stateEngine.watchAll(((e,t)=>this.stateUpdated(t)))}restore(e){return(0,h.isImmutableState)(e)?this.stateEngine.setState(e):this._importState(e),s.config.debug.recordStateChanges&&!x&&w.inject.history.add("restored state"),this}_importState(e){const t=(0,l.decompressGameState)(e),i=new S.PluginsModel(t.map.plugins).rules.adjustRuleset.apply(t.ruleSet);this.stateEngine.deserialize({...t,ruleSet:i})}stateUpdated(e){x||(s.config.debug.integrityChecks?.gameState&&this.protectStateIntegrity(),s.config.debug.recordStateChanges&&w.inject.history.add(function(e){return e&&0!==e.length?e[0].context:"state updated (no mutation)"}(e)),this.onNewState.fire(this.stateEngine.currentState))}protectStateIntegrity(){x=!0,P(this.stateEngine.currentState),x=!1}exportState(){return(0,l.compressGameState)(this.state)}withTemporaryBranch(e){const t=this.state;e(),this.restore(t)}}},72349:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveSizeComponent=void 0;class i{constructor(e){this.parent=e,this._width=0,this._height=0}set height(e){this._height!==e&&(this._height=e,this.parent.preUpdate.makeDirty())}get height(){return this._height}set width(e){this._width!==e&&(this._width=e,this.parent.preUpdate.makeDirty())}get width(){return this._width}set(e,t){return this.width=e,this.height=t,this.parent}static overrideSizeComponent(e){const t=new i(e);Object.defineProperties(e,{width:{set:e=>{t.width=e},get:()=>t.width},height:{set:e=>{t.height=e},get:()=>t.height}}),e.setSize=t.set.bind(t)}}t.ResponsiveSizeComponent=i},72427:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Kongregate=t.KongregateFacade=t.KongregateAPIState=void 0;const s=i(13419),n=i(56824),o=i(96130),a=i(91622),r=i(36868),l=i(16082),c=n.logger.for("Kongregate");var d;!function(e){e.NotAvailable="not-available",e.Loading="loading",e.Ready="ready"}(d||(t.KongregateAPIState=d={}));class h{constructor(){this.initialized=!1,this.user=(0,o.watchable)(void 0),this.apiState=(0,o.watchable)(d.NotAvailable)}initialize(){this.initialized||(this.initialized=!0,(0,s.isRunningAt)("kongregate")&&(c.info("Loading Kongregate API..."),this.apiState.set(d.Loading),this.loadKongregateAPIScript()))}finishInitialization(){window.kongregateAPI?(n.events.on(r.SystemEvents.LocalProgressUpdated,(()=>this.submitStatistics())),n.events.on(r.SystemEvents.UserDataLoaded,(()=>this.submitStatistics())),window.kongregateAPI.loadAPI((()=>{c.info("Kongregate API loaded"),this.kongregateAPI=kongregateAPI.getAPI(),this.apiState.set(d.Ready),this.updateUserDetails(),this.kongregateAPI.services.addEventListener("login",(()=>this.updateUserDetails())),this.submitStatistics()}))):n.errors.handleNonFatalError("Running on kongregate but kongregateAPI object is not found - was the kongregate API script included in the html page?","Kongregate.finishInitialization")}loadKongregateAPIScript(){c.info("Downloading Kongregate API library...");const e=document.createElement("script");e.src="https://www.kongregate.com/javascripts/kongregate_api.js",e.onload=()=>{this.finishInitialization()},document.head.appendChild(e)}updateUserDetails(){this.kongregateAPI.services.isGuest()||!this.getGameAuthToken()?(c.info("Kongregate user logged out"),this.user.set(void 0)):(c.info(`Kongregate user "${this.getUsername()}" logged in`),this.user.set({username:this.getUsername(),gameAuthToken:this.getGameAuthToken()}))}getUsername(){return this.kongregateAPI.services.getUsername()}getGameAuthToken(){return this.kongregateAPI.services.getGameAuthToken()}showSignInBox(){this.kongregateAPI.services.isGuest()&&this.kongregateAPI.services.showSignInBox()}async submitStatistics(){await a.inject.mapRegistry.initialize();let e=l.ExpeditionModel.for("x-dead-islands").levels.filter((e=>e.isCompleted())).length;e>=5&&(e=6);const t=a.inject.userProgressStats,i=[{name:"CompletedCampaignLevels",value:t.completedExpeditionLevels},{name:"CompletedHardCampaignLevels",value:t.completedHardExpeditionLevels},{name:"CompletedTutorial",value:t.completedTutorial?1:0},{name:"CompletedZombieLevels",value:t.completedZombieLevels},{name:"DeadIslandsExpeditionProgress",value:e}];c.info("Player statistics",i);try{for(let e of i)this.kongregateAPI.stats.submit(e.name,e.value)}catch(e){n.errors.handleNonFatalError(e,"Kongregate.submitStatistics")}}}t.KongregateFacade=h,t.Kongregate=new h},72843:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tooltip=t.LAYOUT=t.TOOLTIP_STYLE=void 0;const s=i(96137),n=i(20227),o=i(56824),a=i(53010),r=i(2543),l=i(7782);o.logger.for("Tooltips"),t.TOOLTIP_STYLE={default:{textColor:s.Colors.tooltip.text,backgroundColor:s.Colors.tooltip.background,padding:8},speechBubble:{textColor:s.Colors.speechBubble.text,backgroundColor:s.Colors.speechBubble.background,padding:6}},t.LAYOUT={triangleSize:6,spacing:8,maxWidth:240,expandTransitionDuration:200,typewriterInterval:20,showHideTransitionDuration:100,screenMargin:10};class c extends a.Container{constructor(e){super(e),this.tweener=new n.Tweener(this.scene),this.preferBelow=!1,this.mode=a.TooltipMode.Hidden,this.recentlyShown=!1,this.contentX=new l.TransitionController(this.scene,{duration:t.LAYOUT.expandTransitionDuration,ease:"Sine.easeInOut",applyValue:e=>{this.content.x=e}}),this.contentY=new l.TransitionController(this.scene,{duration:t.LAYOUT.expandTransitionDuration,ease:"Sine.easeInOut",applyValue:e=>{this.content.y=e}}),this.content=new a.TooltipContent(e),this.setVisible(!1);const i=t.LAYOUT.triangleSize;this.backgroundTriangle=new a.Triangle(e,0,0,.69*-i,-i,.69*i,-i,0,0,s.Colors.tooltip.background).setOrigin(0,0).setPosition(0,0),this.add([this.backgroundTriangle,this.content])}showDelayed(e){if(this.shown)return;const t=this.recentlyShown&&!e.enforceDelay?0:e.delayMs??1e3;this.mode=a.TooltipMode.ScheduledToShow,this._queueAction((()=>this.show(e)),t)}skipWaiting(){this.mode===a.TooltipMode.ScheduledToShow&&this.queuedAction&&(this.queuedActionImpl?.(),this._clearQueuedAction())}_queueAction(e,t){this._clearQueuedAction(),this.queuedAction=setTimeout(e,t),this.queuedActionImpl=e}_clearQueuedAction(){this.queuedAction&&(clearTimeout(this.queuedAction),this.queuedAction=void 0,this.queuedActionImpl=void 0)}updatePosition(){if(this.mode===a.TooltipMode.Hidden||this.mode==a.TooltipMode.ScheduledToShow)return;const e=this.placement();if(this.previousPlacement&&(0,r.isEqual)(e,this.previousPlacement))return;this.previousPlacement=e;const i=t.LAYOUT.screenMargin,s=this.scene.cameras.main,{x:n,y:o}=s.getWorldPoint(i,i),{x:l,y:c}=s.getWorldPoint(s.width-i,s.height-i);this.setPosition(e.x+e.width/2,e.y);const d=this.y-this.content.fullSize.height-t.LAYOUT.triangleSize,h=this.y+e.height+this.content.fullSize.height+t.LAYOUT.triangleSize;d<o||this.preferBelow&&h<c?(this.backgroundTriangle.setRotation(Math.PI),this.contentX.setTo(-this.content.width/2),this.contentY.setTo(t.LAYOUT.triangleSize),this.setPosition(e.x+e.width/2,e.y+e.height)):(this.backgroundTriangle.setRotation(0),this.contentX.setTo(-this.content.width/2),this.contentY.setTo(-this.content.height-t.LAYOUT.triangleSize)),this.content.x=this.adjustContentXToFitScreen(this.content.x)}show(e){const i=e.style??t.TOOLTIP_STYLE.default;this.mode===a.TooltipMode.ScheduledToShow&&this._clearQueuedAction(),this.tweener.stop(),this.mode=a.TooltipMode.Shown,this.recentlyShown=!0,this._clearQueuedAction(),this.setVisible(!0),this.content.setProps(e),this.placement=e.placement,this.preferBelow=e.displayBelow||!1,this.backgroundTriangle.fillColor=i.backgroundColor,this.content.backgroundBox.setFillStyle(i.backgroundColor,1),this.content.title.setTint(i.textColor),this.content.description.setTint(i.textColor),this.updatePosition(),this.tweener.add({targets:this,scale:{from:0,to:1},alpha:{from:0,to:1},duration:t.LAYOUT.showHideTransitionDuration}),e.expireAfterMs?this._queueAction((()=>this.hide()),e.expireAfterMs):this.content.description&&this._queueAction((()=>{this.mode=a.TooltipMode.Expanded,this.content.expand(),this.updateContentPosition()}),1500)}updateContentPosition(){this.contentX.transitionTo(-this.content.width/2,{duration:t.LAYOUT.expandTransitionDuration}),this.backgroundTriangle.rotation||this.contentY.transitionTo(-this.content.height-t.LAYOUT.triangleSize,{duration:t.LAYOUT.expandTransitionDuration})}get shown(){return this.mode===a.TooltipMode.Shown||this.mode===a.TooltipMode.Expanded}async hide(e=!1){if(this.mode===a.TooltipMode.ScheduledToShow&&this._clearQueuedAction(),this.mode!==a.TooltipMode.Hidden){if(this.mode=a.TooltipMode.Hidden,this.previousPlacement=void 0,this._queueAction((()=>{this.recentlyShown=!1}),500),!e)return new Promise((e=>{this.tweener.add({targets:this,scale:0,alpha:0,duration:t.LAYOUT.showHideTransitionDuration,onComplete:()=>{this.setVisible(!1),e()}})}));this.setVisible(!1)}}adjustContentXToFitScreen(e){const i=this.scene.cameras.main,{x:s,y:n}=i.getWorldPoint(t.LAYOUT.screenMargin/i.zoom,t.LAYOUT.screenMargin/i.zoom),{x:o,y:a}=i.getWorldPoint(i.width-t.LAYOUT.screenMargin,i.height-t.LAYOUT.screenMargin),r=this.x-this.content.width/2,l=this.x+this.content.width/2;return r<s?e+(s-r):l>o?e-(l-o):e}toString(){return`[Tooltip "${this.content.title}" (${this.mode})]`}}t.Tooltip=c},73016:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ObjectStreamer=void 0;const s=i(91622),n=i(8482),o=i(56824),a=i(58884);o.logger.for("ObjectStreamer"),t.ObjectStreamer=class{constructor(){this.unloadedObjects=new Set,this.loadedObjects=new Set,this._boundingBox=void 0,this.loadQueue=new n.AsyncJobQueue((async e=>{this.loadedObjects.has(e)&&await e.show()}))}add(e){this.unloadedObjects.add(e),this._boundingBox=void 0}getBoundingBox(e=!1,t){if(this._boundingBox&&!e)return this._boundingBox;let i=[...Array.from(this.unloadedObjects),...Array.from(this.loadedObjects)];return t&&(i=i.filter(t)),this._boundingBox=(0,a.unionRects)(...i.map((e=>e.getBoundingBox()))),this._boundingBox}update(e){for(let t of this.unloadedObjects)Phaser.Geom.Rectangle.Overlaps(e,t.getBoundingBox())&&(this.unloadedObjects.delete(t),this.loadedObjects.add(t),this.loadQueue.addJob(t));s.inject.debugData.set("ContentStreamer",`${this.loadedObjects.size}/${this.unloadedObjects.size+this.loadedObjects.size} loaded in rect ${e.x}:${e.y}->${e.width},${e.height}`)}reset(){this.unloadedObjects.clear(),this.loadedObjects.clear(),this._boundingBox=void 0,this.loadQueue.clear()}remove(e){this.unloadedObjects.delete(e),this.loadedObjects.delete(e),this._boundingBox=void 0}}},73054:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelListModel=void 0;const s=i(66143),n=i(54429),o=i(9185),a=i(66272);function r(e){return e.userVictoryRecord?.turns??0}t.LevelListModel=class{constructor(){this.shownLevels=[],this.lockedLevelsCount=0}updateState(e,t,i){this.filterLevels(e,t),this.sortLevels(i)}filterLevels(e,t){switch(t){case n.LevelFilter.All:case n.LevelFilter.Disabled:this.shownLevels=e.filter((e=>e.isInProgress()||e.isUnlocked())),this.lockedLevelsCount=e.length-this.shownLevels.length;break;case n.LevelFilter.Unlocked:this.shownLevels=e.filter((e=>e.isInProgress()||e.getLevelStatus()===s.LevelStatus.Unlocked)),this.lockedLevelsCount=e.filter((e=>!e.isUnlocked()&&!e.isInProgress())).length;break;case n.LevelFilter.Silver:this.shownLevels=e.filter((e=>e.getLevelStatus()===s.LevelStatus.SilverMedal)),this.lockedLevelsCount=0;break;case n.LevelFilter.Gold:this.shownLevels=e.filter((e=>e.getLevelStatus()===s.LevelStatus.GoldMedal)),this.lockedLevelsCount=0}}sortLevels(e){this.shownLevels=function(e,t){switch(t){case a.SortBy.LevelNumber:return e;case a.SortBy.LevelName:return e.sort(((e,t)=>e.getTitle(s.LevelTitleStyle.Short).localeCompare(t.getTitle(s.LevelTitleStyle.Short))));case a.SortBy.TurnCount:return e.sort(((e,t)=>r(t)-r(e)));case a.SortBy.Mode:return e.sort(((e,t)=>c(t)-c(e)))}}(this.shownLevels,e)}};const l=Object.keys(o.LEVEL_FEATURES);function c(e){const t=e.getFeatures({includeIsNew:!0}),i=l.indexOf(t[0]?.id);return-1===i?Number.NEGATIVE_INFINITY:t.some((e=>"new"===e.id))?1e5+t.length:1e3*t.length+i}},73230:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.RenderLayerKey=void 0,t.syncRequest=function(e,t,...i){return{state:e,hexesToSync:t??"all",dirtyCorners:new Set,layers:0===i.length?"all":new Set(i)}},t.describeSyncRequest=function(e){return`Sync ${"all"===e.layers?"All layers":Array.from(e.layers).map((e=>i[e])).join(",")} for ${"all"===e.hexesToSync?"All hexes":`${e.hexesToSync.length} hexes (${e.hexesToSync.toIdsArray().join(",")})`}`},function(e){e[e.All=0]="All",e[e.Landmass=1]="Landmass",e[e.Ground=2]="Ground",e[e.Green=3]="Green",e[e.GrassDecals=4]="GrassDecals",e[e.Palisade=5]="Palisade",e[e.Forest=6]="Forest"}(i||(t.RenderLayerKey=i={}))},73242:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintTerrainTool=void 0;const s=i(91622),n=i(63521),o=i(57189);t.PaintTerrainTool=class{constructor(e,t,i={}){this.pawnType=e,this.iconRecipe=t,this._displayName=(0,o.pawnTypeToStr)(this.pawnType),this.options={title:`Place ${this._displayName}`,allowLargeBrushes:!0,description:`click = add ${this.pawnType}\nctrl-click = remove terrain`},this.options={...this.options,...i}}useOn(e,t){const i=s.inject.gameStateModel;if(!i.regions.byHex(e)){if(t.ctrl)return;i.factions.neutral.takeOverHex(e)}const o=i.rules.pawns(this.pawnType),a=o.hasTrait(n.PawnTraits.Impenetrable),r=o.hasTrait(n.PawnTraits.PreventsBuilding),l=o.hasTrait(n.PawnTraits.OccupiesTile),c=i.pawns.byHex(e).find((e=>e.hasTrait(n.PawnTraits.Terrain))),d=i.pawns.byHex(e).find((e=>e.hasTrait(n.PawnTraits.Building))),h=i.pawns.byHex(e).find((e=>e.hasTrait(n.PawnTraits.OccupiesTile)));t.ctrl?c&&c.destroy():(a&&i.factions.neutral.takeOverHex(e),d?.exists&&r&&d.destroy(),h?.exists&&l&&h.destroy(),c?.exists?c.type!==this.pawnType&&c.replaceWith(this.pawnType):i.pawns.create({hex:e,type:this.pawnType}))}}},73415:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProgressStatsProvider=void 0;const s=i(91622),n=i(16082);t.ProgressStatsProvider=class{constructor(e){this.userData=e}get completedLevels(){return(this.userData.getProgressData().counters.cqlWon??0)+this.completedExpeditionLevels}get completedConquestLevels(){return this.userData.getProgressData().counters.cqlWon??0}get completedConquestLevelsChallenging(){return this.userData.getProgressData().counters.cqlWonChallenging??0}get completedConquestLevelsUnfair(){return this.userData.getProgressData().counters.cqlWonUnfair??0}get playedConquestLevels(){return this.userData.getProgressData().counters.cqlPlayed??0}get completedTutorial(){return n.ExpeditionModel.for("x-first-steps").isCompleted()}get completedExpeditionLevels(){const e=this.userData.getProgressData();return Object.keys(e.completedLevels).length}get completedHardExpeditionLevels(){const e=this.userData.getProgressData();return Object.values(e.completedLevels).filter((e=>"hard"===e.difficulty)).length}get completedExpeditions(){return s.inject.mapRegistry.getExpeditions().map((e=>n.ExpeditionModel.for(e.id))).filter((e=>e.isCompleted())).length}get completedZombieLevels(){const e=this.userData.getProgressData(),t=["l-end-times","l-winter-is-coming","l-mortis"],i=Object.keys(e.completedLevels).filter((e=>t.includes(e))).length;return(e.counters.cqlWonWithZombies??0)+i}all(){return{completedTutorial:this.completedTutorial,completedHardExpeditionLevels:this.completedHardExpeditionLevels,completedLevels:this.completedLevels,completedExpeditions:this.completedExpeditions,completedExpeditionLevels:this.completedExpeditionLevels,completedZombieLevels:this.completedZombieLevels,completedConquestLevelsChallenging:this.completedConquestLevelsChallenging,completedConquestLevelsUnfair:this.completedConquestLevelsUnfair,completedConquestLevels:this.completedConquestLevels,playedConquestLevels:this.playedConquestLevels}}}},73633:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.woodenPrimaryCompactButton=function(e,{icon:t,orientation:i,onClicked:n}){return new s.ImageButtonWithContent(e.scene,0,0,{frame:`ui/compact/btn-${i}`,down:!0,content:e.image(t),onClicked:()=>n?.()})};const s=i(26502)},73664:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PowerByRegionUpdater=t.PowerByRegionProjection=void 0;const s=i(31011),n=i(24598),o=i(4005),a=i(19618),r=i(70712),l=i(56824),c=i(13560),d=i(7334),h=i(45084),u=i(81434),p=i(56038),g=i(9292),m=i(88023);l.logger.for("PowerByRegionProjection");class y extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new f(this).update}bootstrap(e){const t=new f(this);return t.initFromState(e),a.Factions.getAll(e).forEach((e=>t.invalidateFaction(e))),t.getMap()}entryToString(e){return`${e.rawTotal}=>${e.scaledTotal}`}entryToDebugString(e){return(0,d.prettyPrintObject)(e)}}t.PowerByRegionProjection=y;class f extends o.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet),this.invalidatedRegions=new Set}initialize(){this.invalidatedRegions.clear()}registerHandlers(e){e(this.dataSet.sources.factionRegions,this._handleFactionRegionsChanged),e(this.dataSet.sources.assetsValueByRegion,this.handleRegionAssetValueChanged),e(this.dataSet.sources.currentPhaseData,this.handleCurrentPhaseDataChanged),e(this.dataSet.sources.movableUnits,this.handleMovableUnitsChanged)}invalidateFaction(e){for(let t of a.Factions.getFactionRegions(this.newState,e))this.invalidatedRegions.add(t)}invalidateRegion(e){this.invalidatedRegions.add(e)}handleCurrentPhaseDataChanged(e){if(1===e.faction)for(let e of a.Factions.getAll(this.newState))this.invalidateFaction(e)}handleMovableUnitsChanged(){}_handleFactionRegionsChanged(e){e.updated?.forEach((e=>{this.invalidateFaction(e.id)}))}handleRegionAssetValueChanged(e){for(let[t]of e.updated??[])this.invalidateRegion(t)}updateInvalidated(){const e=u.Pawns.model(this.newState);for(let t of this.invalidatedRegions){const i=p.Regions.model(this.newState).byId(t);if(!i||!i.isAlive()){this.builder.delete(t);continue}const s=i.faction.id;let o;if(i.isBankrupt())o=i.hexes.map((e=>c.AssetValue.getFactors(this.newState,e,!0,!0))).reduce(((e,t)=>c.AssetValue.sum(e,t)),c.NO_ASSET_VALUE);else{if(o={...r.AI.getRegionAssetsValue(this.newState,i.id)},h.CurrentPhase.getFaction(this.newState)===s){const t=e.byRegion(i).filter((e=>e.isMovable()));for(let e of t){const{offensive:t,economic:i,defensive:s}=c.AssetValue.getPawnFactors(e.type,e.count);o.offensive+=t,o.economic+=i,o.defensive+=s}}if((h.CurrentPhase.getFaction(this.newState)??0)<s){const e=c.AssetValue.getPawnFactors(n.PawnType.Coins,(0,g.pickLarger)(0,i.budget.balance));o=c.AssetValue.sum(o,e)}}const a=1+(i.size-10)/20,l=c.AssetValue.total(o),d=Math.trunc(l*a);this.builder.set(t,{scaledTotal:d,rawTotal:l,factors:o})}}createMutation(){return this.updateInvalidated(),super.createMutation()}getMap(){return this.updateInvalidated(),(0,m.ImmutableMap)(this.builder.getEntries()).mapKeys((e=>Number(e)))}}t.PowerByRegionUpdater=f},73875:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.downloadReplay=function(e){const t=r.ReplayModel.for(e),i=(0,s.encodeReplay)(e),l=new Date(e.meta.timestamp);var c;(0,n.downloadAsTextFile)(`replay-${l.getFullYear()}-${(0,o.padLeft)((l.getMonth()+1).toString(),2,"0")}-${(0,o.padLeft)(l.getDate().toString(),2,"0")}-${c=e.meta.title,c.toLowerCase().replaceAll(" ","_").replaceAll(":","")}-${t.turnCount}t.konkr`,i),a.app.notifications.success("Replay downloaded!","To view the replay later, simply drag and drop the file into the game window.","ui/icons/ok")};const s=i(85026),n=i(83282),o=i(8358),a=i(54825),r=i(21473)},73980:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RichListItem=void 0;const s=i(86545),n=i(95070),o=i(56824),a=i(20087),r=i(75042),l=i(36257),c=i(7338),d=i(80959),h=i(2543);o.logger.for("RichListItem");class u extends s.BaseResponsiveContainer{constructor(e,t){super(e),this.props={},this.text=void 0,this.icon=void 0,this.addons=[],this.setProps(t)}setTextColor({color:e,alpha:t}){this.text?.setTint(e),this.text?.setAlpha(t??1),this.icon?.setAlpha(t??1),this.icon instanceof n.Image&&((0,l.isTintAllowed)(this.props.icon)?this.icon.setTint(e):this.icon.clearTint())}setProps(e){(0,h.isEqual)(e.text,this.props.text)||(e.text?(this.text=(0,c.createOrUpdateText)(this.scene,this.text,e.text),this.add(this.text)):(this.text?.destroy(),this.text=void 0)),(0,h.isEqual)(e.icon,this.props.icon)||(this.icon?.destroy(),e.icon?(this.icon=(0,l.createIcon)(this.scene,e.icon,20),this.add(this.icon)):this.icon=void 0),(0,h.isEqual)(e.addons,this.props.addons)||(this.addons.forEach((e=>e.destroy())),this.addons=(e.addons??[]).map((e=>e.onClicked?d.UiBuilder.for(this.scene).stealthButton({icon:e.icon,onClicked:e.onClicked,width:26,height:26,radius:6,iconPlacement:"left",theme:"light"}):(0,l.createIcon)(this.scene,e.icon,26))),this.add(this.addons)),this.props=e,this.preUpdate.makeDirty()}setText(e){this.text?this.text.setText(e):o.errors.handleNonFatalError("setText called with a string, but no text object is defined","RichListItem")}updateLayout(){if(this.icon&&this.text)a.Arrange.leftToRight({content:[this.icon,this.text].filter(r.isDefined),origin:0,spacing:8,x:8});else{const e=[this.text??this.icon];a.Arrange.alignX({content:e,origin:.5,x:this.width/2})}a.Arrange.leftToRight({content:this.addons,origin:1,spacing:0,x:this.width-2}),a.Arrange.alignY({content:[this.icon,this.text,...this.addons].filter(r.isDefined),y:this.height/2,origin:.5})}}t.RichListItem=u},74023:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RollbackPanel=void 0;const s=i(86545),n=i(80959),o=i(76049),a=i(20087),r=i(2426),l=i(36868),c=i(96130),d=i(98963),h=i(91622),u=i(54825),p=i(56824);class g extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.hovering=(0,c.watchable)(!1),this.background=new r.RoundedRect(e,{radius:{tl:8,tr:8,bl:0,br:0}}),this.restartButton=new m(this.scene,{icon:"ui/button-icons/restart",text:"Restart Level",onClick:()=>{p.events.trigger(l.UserActions.RestartLevel({})),u.app.audio.playEffect(d.SoundEffects.ButtonUp),t.onActionTaken()},onHover:this.handleButtonHover.bind(this)}),this.replayButton=new m(this.scene,{icon:"ui/button-icons/replay",text:"View Replay",onClick:()=>{p.events.trigger(l.UserActions.ViewReplay()),u.app.audio.playEffect(d.SoundEffects.Rewind),t.onActionTaken()},onHover:this.handleButtonHover.bind(this)}),this.rollbackButton=new m(this.scene,{icon:"ui/button-icons/rewind",text:"Rewind",onClick:()=>{p.events.trigger(l.UserActions.StartRewind()),t.onActionTaken()},onHover:this.handleButtonHover.bind(this)}),this.setInteractiveAuto(),this.input.cursor="default",this.on("pointerover",(()=>{this.hovering.set(!0)})),this.on("pointerout",(()=>{this.hovering.set(!1)})),this.menuItems=[this.restartButton,this.replayButton,this.rollbackButton],this.add([this.background,...this.menuItems]),h.inject.theme.use((e=>{this.background.setFillStyle(e.oceanShades.light1,.85)}))}setRollbackEnabled(e){this.rollbackButton.setEnabled(e)}setReplayEnabled(e){this.replayButton.setEnabled(e)}handleButtonHover(e){this.hovering.set(e)}updateLayout(){for(let e of this.menuItems)e.setSize(this.width,30);a.Arrange.fromTopToBottomOld(this.menuItems,{x:0,y:6,spacing:0}),this.updateSize(),this.background.setSize(this.width,this.height)}calculateHeight(){return 6+30*this.menuItems.length+60}}t.RollbackPanel=g;class m extends s.BaseResponsiveContainer{constructor(e,t){super(e);const i=n.UiBuilder.for(e);this._text=i.text(t.text,o.BitmapFont.Small,0).setOrigin(0,.5),this._icon=i.image(t.icon,0).setOrigin(.5,.5),this._background=i.rectangle(0).setVisible(!1),this.setInteractiveAuto(),h.inject.theme.use((e=>{this.input&&(this.setEnabled(this.input.enabled),this._background.setFillStyle(e.oceanShades.light2,1))})),this.on("pointerdown",(()=>{t.onClick()})),this.on("pointerover",(()=>{t.onHover(!0),this._background.setVisible(!0)})),this.on("pointerout",((e,i,s)=>{console.log(e,i,s),t.onHover(!1),i.stopPropagation(),this._background.setVisible(!1)})),this.add([this._background,this._icon,this._text])}setEnabled(e){const t=h.inject.theme.getCurrent(),i=e?t.oceanContrastDark:t.oceanShades.dark3;this._text.setTint(i),this._icon.setTint(i),this.input&&(this.input.enabled=e)}updateLayout(){this._icon.setPosition(22,15),this._background.setSize(this.width,this.height),this._text.setPosition(38,15)}}},74241:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BUYABLE_BUILDINGS=t.BUYABLE_UNITS=t.PlayUIScene=void 0,t.getBuyablePawnsConfig=L;const s=i(81700),n=i(56824),o=i(24598),a=i(36868),r=i(97849),l=i(98963),c=i(61634),d=i(19162),h=i(56622),u=i(27700),p=i(11466),g=i(44194),m=i(19618),y=i(45084),f=i(30948),w=i(897),v=i(4440),b=i(60959),S=i(56038),x=i(91622),T=i(54825),P=i(99545),I=i(34963),C=i(9537),M=i(84006),A=i(43736),B=i(80959),E=i(80075),O=n.logger.for("PlayUIScene"),R=v.Input.Keyboard.KeyCodes;class k extends f.BaseUIScene{constructor(){super({key:s.Scenes.PlayUI}),this.currentState=u.DEFAULT_PLAY_UI_STATE,this.getCompactUI=(0,M.singletonFactory)((()=>new g.CompactPlayUI(this,this.currentState))),this.getLargeUI=(0,M.singletonFactory)((()=>new h.LargePlayUI(this,this.currentState))),this.preUpdate=(0,w.whenDirty)((()=>{this.activeUI?.updateLayout(),this.worldMapPanel.updateLayout()}))}get pawnHolder(){return this.activeUI.pawnHolder}isInAutoMergeMode(){return this.shiftKey.isDown}create(){super.create(),this.objectsPool=new I.WorldObjectsPool(this),this.worldMapPanel=new A.CompactWorldMapPanel(B.UiBuilder.for(this)),this.add.existing(this.worldMapPanel),this.observe.watch(x.inject.gameStateController.undoAvailable,(e=>{this.updatePlayLayout({undoAvailable:e})})),this.observe.watch(x.inject.ui.spectatingSpeed,(e=>{this.updateSpectatingLayout({spectatingSpeed:e})})),this.observe.watch(T.app.device.uiVariant,this.setControlsBasedOnScreenSize.bind(this)),this.observe.event(a.UserActions.OpenRollbackMenu,(()=>this.activeUI.openRollbackPanel())),this.setControlsBasedOnScreenSize(T.app.device.uiVariant()),this.bindKey(R.TAB,(()=>T.app.scene.play.afterEventsProcessed((()=>a.UserActions.SelectNextRegion())))),this.bindKey(R.ONE,(()=>T.app.scene.play.afterEventsProcessed((()=>a.UserActions.BuyablePawnPointerDown(o.PawnType.Villager))))),this.bindKey(R.TWO,(()=>T.app.scene.play.afterEventsProcessed((()=>a.UserActions.BuyablePawnPointerDown(o.PawnType.Pikeman))))),this.bindKey(R.THREE,(()=>T.app.scene.play.afterEventsProcessed((()=>a.UserActions.BuyablePawnPointerDown(o.PawnType.Knight))))),this.bindKey(R.FOUR,(()=>T.app.scene.play.afterEventsProcessed((()=>a.UserActions.BuyablePawnPointerDown(o.PawnType.Hero))))),this.bindKey(R.C,(()=>T.app.scene.play.afterEventsProcessed((()=>a.UserActions.BuyablePawnPointerDown(o.PawnType.Castle))))),this.bindKey(R.BACKSPACE,(()=>T.app.scene.play.afterEventsProcessed((()=>this.handleUndoHotkey())))),this.bindKey(R.BACKTICK,(()=>T.app.scene.play.afterEventsProcessed((()=>this.handleUndoHotkey())))),this.bindKey(R.R,(()=>a.UserActions.StartRewind())),this.bindKey(R.E,(()=>a.UserActions.EndTurn({force:!0}))),this.bindKey(R.Q,(()=>a.UserActions.SetShowBudgetNumbers(!x.inject.userData.recallChoice("showBudgetOverlay")))),this.bindKey(R.SPACE,(()=>a.UserActions.ResetZoom())),this.arrowKeys=this.input.keyboard.addKeys({up:R.UP,down:R.DOWN,left:R.LEFT,right:R.RIGHT}),this.arrowKeys2=this.input.keyboard.addKeys({up:R.W,down:R.S,left:R.A,right:R.D}),this.shiftKey=this.input.keyboard.addKey(R.SHIFT),this.shiftKey.on("down",(()=>{T.app.scene.worldMap.overlays.update(T.app.getCurrentGameStateModel().state),T.app.scene.play.mode.handleNewHexUnderCursor(x.inject.ui.hexUnderCursor())})),this.shiftKey.on("up",(()=>{T.app.scene.worldMap.overlays.update(T.app.getCurrentGameStateModel().state),T.app.scene.play.mode.handleNewHexUnderCursor(x.inject.ui.hexUnderCursor())})),n.config.debug.overlay&&(this.bindKey(R.G,(()=>{n.config.debug.ai=x.inject.levelSession.selectedRegionId??!1,n.events.trigger(a.UserActions.EndTurn({force:!0}))})),this.bindKey(R.Y,(()=>{P.commands.debug.history()})),this.bindKey(R.SPACE,(()=>T.app.navigator.currentScreen===T.app.screen.mapEditor?a.UserActions.ResumeGame():a.UserActions.EditMap()))),x.inject.theme.use((e=>{this.updatePowerBalanceFromGameState(T.app.getCurrentGameStateModel().state)}))}handleUndoHotkey(){return x.inject.gameStateController.undoAvailable()===C.UndoAvailability.Available?(T.app.audio.playEffect(l.SoundEffects.ButtonUp),a.UserActions.Undo()):"play"===this.currentState.layout.name&&this.currentState.layout.showLevelSummary?(T.app.audio.playEffect(l.SoundEffects.ButtonUp),a.UserActions.OpenRollbackMenu()):void 0}updateState(e){this.currentState={...this.currentState,...e},this.activeUI.updateState(e);const t=this.currentState.visible?this.currentState.worldMapPanel:null;void 0===e.worldMapPanel&&void 0===e.visible||T.app.screen.play.worldMapPanelController.updateState(t)}updatePlayLayout(e){"play"===this.currentState.layout.name&&this.updateState({layout:{...this.currentState.layout,...e}})}updateSpectatingLayout(e){"spectate"===this.currentState.layout.name&&this.updateState({layout:{...this.currentState.layout,...e}})}updateRewindLayout(e){"rewind"===this.currentState.layout.name&&this.updateState({layout:{...this.currentState.layout,...e}})}setControlsBasedOnScreenSize(e){if(this.latestScreenSize!==e){switch(this.latestScreenSize=e,O.warning(`Updating controls to fit screen size "${e}"`),this.activeUI?.deactivate(),e){case p.UiVariant.Compact:this.activeUI=this.getCompactUI();break;case p.UiVariant.Large:this.activeUI=this.getLargeUI()}this.activeUI.activate(this.currentState)}}update(e,t){super.update(e,t),this.activeUI?.update(),T.app.screen.play.worldMapPanelController.update(),this.applyKeyboardScrolling(t)}applyKeyboardScrolling(e){const t=600,i=300*e,s=T.app.scene.worldMap.cameraController.scrollController;(this.arrowKeys.up.isDown||this.arrowKeys2.up.isDown)&&(T.app.tooltips.close(),s.cameraY.accelerateTo(-t,i)),(this.arrowKeys.down.isDown||this.arrowKeys2.down.isDown)&&(T.app.tooltips.close(),s.cameraY.accelerateTo(t,i)),(this.arrowKeys.left.isDown||this.arrowKeys2.left.isDown)&&(T.app.tooltips.close(),s.cameraX.accelerateTo(-t,i)),(this.arrowKeys.right.isDown||this.arrowKeys2.right.isDown)&&(T.app.tooltips.close(),s.cameraX.accelerateTo(t,i))}updateFromGameState(e=x.inject.currentGameState,t=this.currentState.layout.name){const i=c.Economy.model(e),s=(d.Rules.model(e),T.app.screen.play.selectedRegion),n=y.CurrentPhase.model(e),o=n.faction,a=x.inject.ui.regionsLedger.hasPendingRegions(),r=x.inject.ui.regionsLedger.availableRegions.some((t=>S.Regions.model(e).byId(t)?.isActionable())),l=n.turnNumber,h={turnNumber:l,livesLeft:x.inject.levelSession.remainingLives};if("play"===t){const t={name:"play",heldPawnData:null,regionData:null,undoAvailable:x.inject.gameStateController.undoAvailable(),showLevelSummary:l>1||x.inject.gameStateModel.plugins.pickLandingSpot,activeFactionColor:o?.landColor||0,primaryButton:r?a?"nextRegion":"endTurn":"highlightEndTurn",enableNextRegion:x.inject.ui.regionsLedger.availableRegions.length>1,enableRollback:l>1&&(0,E.canRewind)(),enableReplay:x.inject.gameStateController.history.length>1,showRegionBudget:!1};if(s?.exists){const n=i.treasuryOf(s);t.regionData={id:s.id,controllable:s.isControllable(),name:s.name,income:s.budget?.balance||0,treasury:n,buyablePawns:s.isControllable()?L(e,n):[],townLevel:s.getLevel()}}this.updateState({...h,layout:t})}else this.updateState({...h})}grabNewPawnFromShop(e){const t=this.getPawnXY(e);return r.assert.defined(t),this.grabNewPawnFrom(e,t.x,t.y),!0}getPawnXY(e){const t=this.activeUI.shoppingTray.getPawnXY(e);if(t)return{x:t.x+this.activeUI.shoppingTray.x,y:t.y+this.activeUI.shoppingTray.y}}grabNewPawnFromTown(e,t){const{x:i,y:s}=T.app.scene.worldMap.getPawnObjectPositionOnScreen(t.id);this.grabNewPawnFrom(e,i,s)}grabNewPawnFrom(e,t,i){if("play"!==this.currentState.layout.name)return void O.warning(`ignoring PlayUIScene.grabNewPawnFrom in ${this.currentState.layout.name} layout`);this.pawnHolder.pickUpPawn(e,t,i,1);const s=x.inject.gameStateModel.rules.pawns(e);this.updateHeldPawnData({name:e.toString(),cost:s.cost,upkeep:s.upkeep,context:"buying"}),this.activeUI.shoppingTray.setPawnTaken(e,b.TakenMode.Taken),T.app.audio.playEffect(l.SoundEffects.Grab)}updateHeldPawnData(e){"play"===this.currentState.layout.name?this.updateState({layout:{...this.currentState.layout,heldPawnData:e}}):O.warning(`ignoring PlayUIScene.updateHeldPawnData in ${this.currentState.layout.name} layout`)}returnPawnToShop(e,t){const i=this.activeUI.shoppingTray.getPawnXY(e);r.assert.defined(i),this.activeUI.shoppingTray.setPawnTaken(e,b.TakenMode.Returning),this.pawnHolder.dropPawn(this.activeUI.shoppingTray.x+i.x,this.activeUI.shoppingTray.y+i.y,1,(()=>{this.activeUI.shoppingTray.doneReturningPawn(e)})),t?.(),this.updateHeldPawnData(null),n.events.trigger(a.UiEvents.PawnReturnedToShop())}restockPawnInShop(e,t=!1){t?this.activeUI.shoppingTray.setPawnTaken(e,b.TakenMode.NotTaken):this.activeUI.shoppingTray.restockPawn(e),this.updateHeldPawnData(null)}updatePowerBalanceFromGameState(e){const t=m.Factions.model(e).all().filter((e=>e.isAlive())).map((t=>({id:t.id,size:t.size,color:t.landColor,highlight:y.CurrentPhase.getFaction(e)===t.id})));this.updateState({powerBalance:t})}canBuyPawn(e){return"play"===this.currentState.layout.name&&this.currentState.layout.regionData?.buyablePawns.find((t=>t.pawnType===e))?.mode===u.BuyablePawnMode.Available}getTooltipFor(e){return this.activeUI.getTooltipFor(e)||super.getTooltipFor(e)}getBottomPanelHeight(){return this.activeUI.getBottomPanelHeight()}}function L(e,i){const s=d.Rules.model(e);let n=[];for(let e of t.BUYABLE_UNITS.map((e=>s.pawns(e))).filter((e=>e.cost>0))){if(!(e.cost<=i)){n.push({pawnType:e.type,mode:u.BuyablePawnMode.Unaffordable,priceTag:e.cost});break}n.push({pawnType:e.type,mode:u.BuyablePawnMode.Available,priceTag:e.cost})}const o=x.inject.gameStateModel.plugins.rules.adjustBuyableObjects.apply(t.BUYABLE_BUILDINGS,e);for(let e of o.map((e=>s.pawns(e))).filter((e=>e.cost>0)))e.cost<=i?n.push({pawnType:e.type,mode:u.BuyablePawnMode.Available,priceTag:e.cost}):n.push({pawnType:e.type,mode:u.BuyablePawnMode.Unaffordable,priceTag:e.cost});return n}t.PlayUIScene=k,t.BUYABLE_UNITS=[o.PawnType.Villager,o.PawnType.Pikeman,o.PawnType.Knight,o.PawnType.Hero],t.BUYABLE_BUILDINGS=[o.PawnType.Castle]},74370:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getEditorPaletteDefaultLayout=t.EDITOR_TOOL=void 0;const s=i(12686),n=i(84595),o=i(98303),a=i(59113),r=i(16231),l=i(73242),c=i(24598),d=i(67713),h=i(53847),u=i(4440);function p(e,t=.5){return{image:e,scale:t}}t.EDITOR_TOOL={select:new h.SelectTool,bulldozer:new s.BulldozerTool,addCoins:new a.CoinsTool,paintFaction0:new n.PaintFactionTool(0,"editor/neutral-tile-icon"),paintFaction1:new n.PaintFactionTool(1),paintFaction2:new n.PaintFactionTool(2),paintFaction3:new n.PaintFactionTool(3),paintFaction4:new n.PaintFactionTool(4),paintFaction5:new n.PaintFactionTool(5),paintFaction6:new n.PaintFactionTool(6),paintVillager:new d.PaintPawnTool(c.PawnType.Villager,p("pawns/villager")),paintPikeman:new d.PaintPawnTool(c.PawnType.Pikeman,p("pawns/pikeman")),paintKnight:new d.PaintPawnTool(c.PawnType.Knight,p("pawns/knight")),paintHero:new d.PaintPawnTool(c.PawnType.Hero,p("pawns/hero")),paintUniqueHero:new d.PaintPawnTool(c.PawnType.UniqueHero,p("pawns/unique-hero")),paintBandit:new d.PaintPawnTool(c.PawnType.Bandit,p("pawns/bandit")),paintTown:new o.PaintTownTool,paintForest:new l.PaintTerrainTool(c.PawnType.Forest,"editor/forest"),paintCastle:new l.PaintTerrainTool(c.PawnType.Castle,p("pawns/castle"),{allowLargeBrushes:!1}),addChest:new r.AddChestTool,addSpawner:new d.PaintPawnTool(c.PawnType.Spawner,p("pawns/spawner",.5),{allowLargeBrushes:!0}),paintBanditCamp:new l.PaintTerrainTool(c.PawnType.Camp,p("pawns/camp"),{allowLargeBrushes:!1}),paintTownRuins:new l.PaintTerrainTool(c.PawnType.TownRuins,p("pawns/town-ruins"),{allowLargeBrushes:!1}),paintGoldMine:new l.PaintTerrainTool(c.PawnType.GoldMine,p("pawns/gold-mine",.4),{allowLargeBrushes:!1}),paintRefuge:new d.PaintPawnTool(c.PawnType.Refuge,"editor/refuge",{allowLargeBrushes:!0}),paintSwamp:new l.PaintTerrainTool(c.PawnType.Swamp,"editor/swamp"),paintRabbit:new d.PaintPawnTool(c.PawnType.Bunny,p("pawns/rabbit")),paintHauntedTown:new l.PaintTerrainTool(c.PawnType.HauntedTown,p("pawns/haunted-town"),{allowLargeBrushes:!1}),paintZombie:new d.PaintPawnTool(c.PawnType.Zombie,p("pawns/zombie")),paintLadderZombie:new d.PaintPawnTool(c.PawnType.LadderZombie,p("pawns/ladder-zombie")),paintDreadKnight:new d.PaintPawnTool(c.PawnType.DreadKnight,p("pawns/dread-knight"))},t.getEditorPaletteDefaultLayout=()=>({basic:[{tool:t.EDITOR_TOOL.select,hotkey:"Tab",keyCode:u.Input.Keyboard.KeyCodes.TAB},{tool:t.EDITOR_TOOL.bulldozer,hotkey:"X"},{tool:t.EDITOR_TOOL.addCoins,hotkey:"C"}],ownership:[{tool:t.EDITOR_TOOL.paintFaction1,hotkey:"1",keyCode:u.Input.Keyboard.KeyCodes.ONE},{tool:t.EDITOR_TOOL.paintFaction2,hotkey:"2",keyCode:u.Input.Keyboard.KeyCodes.TWO},{tool:t.EDITOR_TOOL.paintFaction3,hotkey:"3",keyCode:u.Input.Keyboard.KeyCodes.THREE},{tool:t.EDITOR_TOOL.paintFaction4,hotkey:"4",keyCode:u.Input.Keyboard.KeyCodes.FOUR},{tool:t.EDITOR_TOOL.paintFaction5,hotkey:"5",keyCode:u.Input.Keyboard.KeyCodes.FIVE},{tool:t.EDITOR_TOOL.paintFaction6,hotkey:"6",keyCode:u.Input.Keyboard.KeyCodes.SIX},{tool:t.EDITOR_TOOL.paintFaction0,hotkey:"7",keyCode:u.Input.Keyboard.KeyCodes.ZERO}],terrain:[{tool:t.EDITOR_TOOL.paintForest,hotkey:"Q"},{tool:t.EDITOR_TOOL.paintSwamp,hotkey:"W"},{tool:t.EDITOR_TOOL.paintTown,hotkey:"E"},{tool:t.EDITOR_TOOL.paintCastle,hotkey:"R"},{tool:t.EDITOR_TOOL.paintBanditCamp,hotkey:"T"},{tool:t.EDITOR_TOOL.paintGoldMine,hotkey:"Y"},{tool:t.EDITOR_TOOL.paintTownRuins,hotkey:"U"}],units:[{tool:t.EDITOR_TOOL.paintBandit,hotkey:"A"},{tool:t.EDITOR_TOOL.paintVillager,hotkey:"S"},{tool:t.EDITOR_TOOL.paintPikeman,hotkey:"D"},{tool:t.EDITOR_TOOL.paintKnight,hotkey:"F"},{tool:t.EDITOR_TOOL.paintHero,hotkey:"G"},{tool:t.EDITOR_TOOL.paintUniqueHero,hotkey:"H"}],other:[{tool:t.EDITOR_TOOL.addChest},{tool:t.EDITOR_TOOL.paintRabbit},{tool:t.EDITOR_TOOL.paintRefuge}]})},74783:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AttitudeView=t.EMOJI_COLORS=t.CREDIT_MAJOR_THRESHOLD=t.CREDIT_MINOR_THRESHOLD=t.FEAR_THRESHOLD=t.ATTITUDE_LABELS=void 0,t.getEmojiIndex=h,t.getEmojiVariant=u,t.getShockedFaceFor=function(e,t,i){const{confidenceIndex:s,hostilityIndex:n}=u(t,i);return e<=0?h(t,i).toString():0===s&&0===n?"0":2===s&&n>=2?"shock-0":e>.25?"shock-2":s>0&&n<=1?"0":"shock-1"},t.getHostilityIndex=g,t.getEmojiColor=function(e,i){return t.EMOJI_COLORS[g(i)]},t.getAttitudeStr=m;const s=i(90952),n=i(20754),o=i(70712),a=i(56824),r=i(7334),l=i(76439),c=i(29322),d=i(19618);function h(e,t){return 10*p(e)+g(t)}function u(e,t){return{hostilityIndex:g(t),confidenceIndex:p(e)}}function p(e){return e<=.4?0:e<=.6?1:2}function g(e){return e>.75?0:e>.6?1:e>.4?2:e>.25?3:4}function m(e,i){const s=h(e,i),n=Math.floor(s/10),o=s%10;return t.ATTITUDE_LABELS[n][o]}a.logger.for("FearView"),t.ATTITUDE_LABELS=[["defiant","cornered","nervous","friendly/nervous","subservient"],["furious","angry","reserved","friendly","grateful"],["merciless","annoyed","confident","friendly/confident","benevolent"]],t.FEAR_THRESHOLD=25,t.CREDIT_MINOR_THRESHOLD=10,t.CREDIT_MAJOR_THRESHOLD=100,t.EMOJI_COLORS=[16719904,16749346,16776960,13041408,60672];class y extends n.LazyView{constructor(){super([s.GameState.ai.powerByRegion,s.GameState.ai.credit]),this.name="attitude"}calculate(e,t){return this.getComponents(e,t)?.attitude||"-"}getComponents(e,{fromFactionId:t,towardsFactionId:i}){if(t===i)return;const s=d.Factions.model(e).byId(t)?.relativeForecast??.5,n=o.AI.getFactionCredit(e,t,i);return{forecast:s,credit:n,attitude:m(s,n)}}getCacheKey(e){return`${e.fromFactionId}->${e.towardsFactionId}`}getDebugLayer(e){return new l.GameStateDebugLayer((0,c.factionBasedAdapter)({getValue:(t,i)=>{if(i!==e)return this.get(t,{towardsFactionId:e,fromFactionId:i})},getDetail:(t,i)=>{if(i!==e)return(0,r.prettyPrintObject)(this.getComponents(t,{towardsFactionId:e,fromFactionId:i}))}}))}}t.AttitudeView=y},74805:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FortificationUpdater=t.FortificationByRegion=void 0;const s=i(31011),n=i(4005),o=i(56038),a=i(22973),r=i(88023);class l extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new c(this),this.update=this.updater.update.bind(this)}bootstrap(e){return(0,r.ImmutableMap)().withMutations((t=>{for(let i of o.Regions.getAll(e)){let s=0;for(let t of o.Regions.getRegionHexes(e,i))s+=a.Fortification.get(e,t);t.set(i,s)}}))}entryToString(e){return e}entryToDebugString(e){return e.toString()}}t.FortificationByRegion=l;class c extends n.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}initialize(){super.initialize(),this.dirtyHexes=new Set}registerHandlers(e){e(this.dataSet.sources.hexStaticDefense,this._handleHexStaticDefenseChange.bind(this)),e(this.dataSet.sources.regionByHex,this._handleRegionByHexChange.bind(this))}_handleHexStaticDefenseChange(e){for(let[t]of e.updated)this.dirtyHexes.add(t)}_handleRegionByHexChange(e){for(let[t]of e.updated)this.dirtyHexes.add(t)}createMutation(){for(let e of this.dirtyHexes){const t=a.Fortification.get(this.oldState,e),i=a.Fortification.get(this.newState,e),s=this.dataSet.sources.regionByHex.getEntryById(this.oldState,e),n=this.dataSet.sources.regionByHex.getEntryById(this.newState,e);t===i&&s===n||(s&&this.builder.set(s,(this.builder.getCurrent(s)??0)-t),n&&this.builder.set(n,(this.builder.getCurrent(n)??0)+i))}return super.createMutation()}}t.FortificationUpdater=c},75042:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDefined=function(e){return void 0!==e}},75131:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleNewGameState=function(e,t,i){const p=a.CurrentPhase.model(t),g=a.CurrentPhase.model(t).faction;if(e.worldMapScene.loadNewGameState(t),i!==c.NewGameStateContext.Undo&&r.app.worldNews.clear(),r.app.scene.worldMap.overlays.attitudeEmojis.clearChatter(),l.inject.ui.regionsLedger.refreshAvailableRegions(t),i.resetCamera&&e.worldMapScene.cameraController.centerAboveControlPanel(),e.uiScene.updateFromGameState(t),e.uiScene.updatePowerBalanceFromGameState(t),l.inject.plugins.pickLandingSpot&&!u.WorldMap.get(t).pluginOptions?.landingSpotPicked&&1===l.inject.gameStateController.history.length)e.setMode(new h.PickLandingSpotMode(e));else{if(i.startFactionTurn)return void(0,d.handleFactionTurnStarted)({state:t,factionId:a.CurrentPhase.getFaction(t)});switch(g?.controller){case s.FactionController.LocalUser:e.time.addEvent({callback:()=>{p.getMovablePawns().filter((e=>e.region?.isAlive())).map((t=>e.worldMapScene.pawns.getById(t.id))).forEach((e=>{e?.startJumping()}))},delay:100}),e.setMode(new n.PlayMode(e));break;case s.FactionController.Ai:case s.FactionController.None:case void 0:if(e.mode instanceof o.SpectatorMode)return;e.setMode(new o.SpectatorMode(e));break;default:throw new Error(`Faction ${g} uses unsupported controller ${g?.controller}`)}}};const s=i(24598),n=i(79694),o=i(97869),a=i(45084),r=i(54825),l=i(91622),c=i(71021),d=i(8570),h=i(25992),u=i(59956)},75136:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Mutator=t.StateEngine=void 0,t.mergeMutations=m;const s=i(1326),n=i(56824),o=i(37659),a=i(84757),r=i(2543),l=i(7334),c=i(97849),d=i(20026),h=i(88023),u=i(80321),p=n.logger.for("StateEngine");t.StateEngine=class{constructor(){this.roots={},this.projections={},this.pendingMutations=[],this.inTransaction=!1,this.children=new Map,this.watchers={},this.globalListeners=new Set,this.currentState=(0,d.createImmutableState)(this,[]),this.idGenerator=new u.IncrementalIdGenerator}_addPrimary(e,t){return(0,c.assert)(!this.roots[t.key],`dataSet ${t.key} already exists in the state engine!`),this.roots[t.key]=t,e.set(t.key,t.defaultValue)}add(...e){let t=[];return e.forEach((e=>{(0,d.isProjectionDataSet)(e)?this._addProjection(e):(t.push(e),this.currentState=this._addPrimary(this.currentState,e))})),this._updateState((e=>(0,d.updateActiveDataSets)(e,(e=>e.union((0,h.ImmutableSet)(t)))))),this.updateSequence=this.getProjectionsBootstrapSequence(),this}suspend(...e){if(!e.length)return;const t=e.filter(d.isProjectionDataSet);this._mutateState((e=>{(0,d.updateActiveDataSets)(e,(e=>e.subtract(t)))}))}activate(...e){if(!e.length)return;const t=this.getProjectionsBootstrapSequence(e.filter((e=>!this.isDataSetActive(e))));this.currentState=this.currentState.deleteAll(t.map((e=>e.key)));const i=this.currentState;t.forEach((e=>{const t=e.bootstrap(this.currentState);this.currentState=this.currentState.set(e.key,t),this.currentState=(0,d.updateActiveDataSets)(this.currentState,(t=>t.add(e)))})),this._notifyWatchersAfterChanges(this.currentState,[],i,t)}activateAllProjections(){this.activate(...Object.values(this.projections))}suspendAllProjections(){this.suspend(...Object.values(this.projections))}activateOnly(...e){const t=new Set,i=[...e].filter(d.isProjectionDataSet);for(;i.length;){const e=i.pop();t.add(e),(0,d.isProjectionDataSet)(e)&&e.parents?.filter(d.isProjectionDataSet).forEach((e=>{e&&i.push(e)}))}const s=this.getActiveProjections().subtract(t);this.suspend(...s.toArray()),this.activate(...Array.from(t))}getActiveDataSets(){return(0,d.getActiveDataSets)(this.currentState)}getActiveProjections(){return this.getActiveDataSets().filter((e=>(0,d.isProjectionDataSet)(e)))}isDataSetActive(e){return this.getActiveDataSets().has(e)}_updateState(e){this.currentState=e(this.currentState)}_mutateState(e){this.currentState=this.currentState.withMutations(e)}_addProjection(e){this.projections[e.key]=e,e.parents.forEach((t=>{const i=this.children.get(t);i?i.push(e):this.children.set(t,[e])}))}beginTransaction(){n.config.flags.mergeMutations&&(this.inTransaction=!0)}commitTransaction(){this.inTransaction=!1,this.pendingMutations.length&&(this.apply(...this.pendingMutations),this.pendingMutations.length=0)}apply(...e){if(this.inTransaction)this.pendingMutations&&(this.pendingMutations=m(this.pendingMutations,e));else{for(let t of e){const e=t.dataSet,i=this.roots[e.key];if(i!==e)throw void 0===i?this.projections[e.key]?new Error(`dataSet "${e.key}" is a projection, it cannot be updated manually!`):new Error(`no such dataSet: ${e.key}`):new Error(`dataSet mismatch for key "${e.key}" - registered instance in state engine is different than the instance passed into update()`)}this._applyMutationsAndNotifyWatchers(...e)}}_applyMutationsAndNotifyWatchers(...e){p.group(`New mutations from "${e[0]?.context}"]\n${e.map((e=>`  ${e.dataSet.key}: ${(0,l.str)(e.changes)}`)).join("\n")}`);const t=new g(this,e);return this.currentState=t.apply(),this._notifyWatchersAfterChanges(this.currentState,e,t.startingState,t.getChangedDataSets()),p.groupEnd(),this.currentState}_notifyWatchersAfterChanges(e,t,i,s){if(s[Symbol.iterator]().next().value){this.globalListeners.forEach((s=>s(e,t,i)));for(let n of s){const s=this.watchers[n.key];s&&s.forEach((s=>{s(e,t,i)}))}}}get(e,t){return this.assertActive(e),(0,d.selectFromState)(this.currentState,e,t)}setState(e){const t=this.currentState;this.currentState=(0,d.setParentEngine)(e,this);const i=this.getAllDataSets().filter((i=>e.get(i.key)!==t.get(i.key)));this._notifyWatchersAfterChanges(e,[],t,i)}getEntryIds(e){return e.getEntryIds(this.currentState)}serialize(){return(0,s.mapDictionary)(this.roots,((e,t)=>e.serialize(this.currentState.get(t))))}clear(){this.currentState=(0,d.createImmutableState)(this,this.getActiveDataSets())}watchAll(e){this.globalListeners.add(e)}watchDataSet(e,t){this.assertHas(e),(0,s.pushIntoArrayByKey)(this.watchers,e.key,t)}stopWatching(e,t){t?(0,s.removeFromArrayInPlace)(this.watchers[t.key]||[],e):this.globalListeners.delete(e)}assertActive(e,t){if(!this.isDataSetActive(e))throw this.assertHas(e,t),new Error(`DataSet ${e} is suspended`+(t?` (${t})`:""))}assertHas(e,t){const i=this.getDataSetByKey(e.key);if(i!==e){throw(e=>new Error(e+(t?` (${t})`:"")))(i?`DataSet with key "${e.key}" already exists, but is not the expected instance`:`DataSet with key "${e.key}" not found in the state engine`)}}getAllDataSets(){return(0,h.ImmutableSet)([...Object.values(this.roots),...Object.values(this.projections)])}deserialize(e){const t=a.timing.start("ImmutableState deserialization");this.clear();for(let[t,i]of Object.entries(this.roots))try{this.currentState=this.currentState.set(t,i.deserialize(e[t]))}catch(i){throw i.message=`Failed to deserialize ${t} from ${JSON.stringify(e)} \n\n${i.message}`,i}this.getProjectionsBootstrapSequence().forEach((e=>{this.isDataSetActive(e)&&(this.currentState=this.currentState.set(e.key,e.bootstrap(this.currentState)))})),this._notifyWatchersAfterChanges(this.currentState,[],this.currentState,this.getAllDataSets()),this.idGenerator.reset(),t.complete()}sortProjections(e){const t=new Set(e);return this.getProjectionsBootstrapSequence(e).filter((e=>t.has(e)))}getProjectionsBootstrapSequence(e=Object.values(this.projections)){let t=Object.values(this.roots),i=[...t];return e.forEach((e=>{i.includes(e)||this._resolveDeps(e,"<root>",i)})),i.slice(t.length)}getDependencyMap(){let e={};return Object.values(this.roots).forEach((t=>{e[t.key]=this._getDepTree(t)})),e}getParentsMap(e){if((0,d.isProjectionDataSet)(e)){const t={};return e.parents.forEach((e=>t[e.key]=this.getParentsMap(e))),t}return"<root>"}_getDepTree(e){let t={};return this.assertHas(e),(this.children.get(e)||[]).forEach((e=>{t[e.key]=this._getDepTree(e)})),t}_resolveDeps(e,t,i,s=new Set){s.add(e),this.assertHas(e,`required by ${t}`);for(let n of e.parents)if(!i.includes(n)){if(!(0,d.isProjectionDataSet)(n))throw new Error(`missing primary dataSet ${n} (required by ${t})`);if(s.has(n))throw new Error(`circular reference detected: ${e} -> ${n}`);this._resolveDeps(n,e,i,s)}i.push(e),s.delete(e)}getDataSetByKey(e){return this.roots[e]||this.projections[e]}childrenOf(e){return this.children.get(e)||[]}transaction(e){this.beginTransaction();const t=e();return this.commitTransaction(),t}getNextId(e){return this.idGenerator.takeNextIdFor(this.currentState,e)}};class g{constructor(e,t){this.stateEngine=e,this.mutations=t,this.dirty=new Set,this.updated=new Set,this.changeSet=new o.ChangeSet,this.startingState=this.stateEngine.currentState,this.currentState=this.startingState}apply(){for(let e of this.mutations)this.applyMutation(e);for(let e of this.stateEngine.updateSequence)this.dirty.has(e)&&this.stateEngine.isDataSetActive(e)&&this.resolve(e);return this.currentState}makeChildrenDirty(e){const t=this.stateEngine.childrenOf(e).filter((e=>this.stateEngine.isDataSetActive(e)));t.length,t.forEach((e=>this.dirty.add(e)))}resolve(e){(0,c.assert)(this.stateEngine.isDataSetActive(e),`Attempt to resolve suspended projection ${e}`);const t=e.update(this.currentState,this.changeSet,this.startingState);!t||void 0===t.changes||"object"==typeof t.changes&&(0,r.isEmpty)(t.changes)||this.applyMutation(t)}applyMutation(e){this.currentState=e.dataSet.apply(this.currentState,e.changes),this.changeSet.add(e),this.updated.add(e.dataSet),this.makeChildrenDirty(e.dataSet)}getChangedDataSets(){return this.updated}}function m(e,t){const i=new Map;for(let t of e)i.set(t.dataSet,t);for(let e of t){const t=i.get(e.dataSet);t?i.set(e.dataSet,{dataSet:e.dataSet,context:t.context+" -> "+e.context,changes:e.dataSet.mergeMutations(t.changes,e.changes)}):i.set(e.dataSet,e)}return Array.from(i.values())}t.Mutator=g},75161:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AI_SITUATION_TAGS=void 0,t.AI_SITUATION_TAGS=["angry reaction","approving attack","approving non-aggression","truce","fighting","invading","invaded","caused crippling damage","caused major damage","caused minor damage","caused no damage","caused damage","did not suffer major damage","suffered crippling damage","suffered major damage","suffered minor damage","suffered no damage","suffered damage","did not cause major damage","ally","friendly","neutral","hostile","furious","not hostile","not friendly","angered by losses","angered by nature","angered by dominance","angered by credit","angered by rivalry","was ally","was friendly","was neutral","was hostile","was furious","was not hostile","was not friendly","was angered by losses","was angered by nature","was angered by dominance","was angered by credit","was angered by rivalry","much stronger","stronger","similar strength","weaker","much weaker","not weaker","not stronger","was much stronger","was stronger","was similar strength","was weaker","was much weaker","was not weaker","was not stronger","surrendering","surrender declined","dominant","player is dominant","common enemy","was dominant","player was dominant","had common enemy"]},75185:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionEdgeHexesProjection=void 0,t.createBorderHexesDebugLayer=function(){return new l.GameStateDebugLayer((0,c.hexBasedAdapter)({getValue(e,t){const i=o.Regions.getByHex(e,t);if(!i)return;const s=(0,r.selectFromState)(e,a.GameState.warfare.borderHexes,i)?.has(t),n=(0,r.selectFromState)(e,a.GameState.regions.edgeHexes,i)?.has(t);return s?d.GLYPH.redFlag:n?d.GLYPH.whiteFlag:""},getDetail(e,t){const i=o.Regions.getByHex(e,t);if(!i)return;const s=(0,r.selectFromState)(e,a.GameState.warfare.borderHexes,i)?.has(t),n=(0,r.selectFromState)(e,a.GameState.regions.edgeHexes,i)?.has(t);return`\nregion: ${i}\nborder: ${n?"YES":"NO"}\nhostile: ${s?"YES":"NO"}`}}))};const s=i(45664),n=i(83874),o=i(56038),a=i(90952),r=i(20026),l=i(76439),c=i(12543),d=i(19506),h=i(88023);class u extends n.MultiMapDataSet{constructor(e,t){super(e),this.regionsHexes=t,this.parents=[this.regionsHexes]}bootstrap(e){return(0,h.ImmutableMap)().withMutations((t=>{o.Regions.model(e).all().forEach((i=>{const s=i.hexes.filter((t=>p(e,t,i.id))).map((e=>e.id));s.length&&t.set(i.id,(0,h.ImmutableSet)(s))}))}))}update(e,t,i){const a=new n.MultiMapMutationBuilder(this,e),r=t.require(this.regionsHexes);for(let t of r.updated??[]){const i=t.id;if(t.added){const n=(0,s.getHexes)(t.added);for(let t of n){const s=o.Regions.model(e).byId(i);p(e,t,i)&&a.add(i,t.id),s.hexes.neighboursOf(t).forEach((t=>{p(e,t,i)||a.remove(i,t.id)}))}}t.removed&&(a.remove(i,...t.removed),t.removed.forEach((t=>{const n=o.Regions.model(e).byId(i);n?n.hexes.neighboursOf((0,s.getHex)(t)).forEach((e=>{a.add(i,e.id)})):a.removeEntry(i)})))}return a.createMutation("regionsByHexChanged")}entryToString(e){return`[${e.size}]`}}function p(e,t,i){return!!t.findNeighbour((t=>o.Regions.getByHex(e,t.id)!==i))}t.RegionEdgeHexesProjection=u},75282:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SelectBox=void 0;const s=i(46973),n=i(54825),o=i(34174),a=i(58903),r=i(18957),l=i(36257),c=i(98963),d=i(95883);class h extends s.RoundedRectButton{constructor(e,t){super(e.scene,{content:new d.SelectBoxContent(e.scene,{icon:void 0!==t.selectedItem?.icon?e.graphicalGameObject(t.selectedItem.icon):void 0,text:e.richText(t.selectedItem?.text??"?"),tintIcon:t.tintIcon??!0}),theme:s.RoundedRectButton.Themes[t.theme??"light"],tooltip:t.tooltip,controller:new a.ToggleButtonStateController({}),width:t.width??180,height:t.height??30,radius:8,bevel:"inset"}),this.onSelected=(0,r.signal)(),this.selectedItem=void 0,this.cancelCallback=void 0,this.onSelected(t.onSelected),this.options=t.options,this.selectedItem=t.selectedItem,this.controller.onToggled((async e=>{if(e){const e=this.options.find((e=>e.key&&e.key===this.selectedItem?.key)),{promise:t,cancel:i}=n.app.dropdowns.dropdownList(o.Placement.aroundUiObject(this),{items:this.options,selectedItem:e});this.props.update({radius:{tl:8,tr:8,bl:0,br:0}}),this.content.updateLayout(),this.cancelCallback=i;const s=await t;if(n.app.audio.playEffect(c.SoundEffects.ButtonUp),this.controller.setToggled(!1),this.props.update({radius:8}),!s)return;this.selectedItem=s,this.setSelection(s),this.content.updateLayout(),this.onSelected.fire(s)}else this.props.update({radius:8}),this.cancelCallback&&(this.cancelCallback(),this.cancelCallback=void 0)}))}setSelection(e){this.content.text?.setText(e.text),this.content.setIcon(e.icon?(0,l.createIcon)(this.scene,e.icon):void 0),this.selectedItem=e,this.content.preUpdate.makeDirty()}}t.SelectBox=h},75429:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EditMapJSONDialog=void 0;const s=i(5365),n=i(29821),o=i(63032),a=i(96704),r=i(98963),l=i(7169),c=i(54118),d=i(2543),h=i(91622),u=i(54825);t.EditMapJSONDialog=class{getTitle(){return"Edit map JSON data"}getContent(e,t,i){this.textArea||(this.textArea=new l.TextArea(e,{onChange:(0,d.debounce)((e=>this.validate(e)),300,{trailing:!0})}),this.statusLabel=new n.Label(e,"Sanity check OK!"),this.layout=new c.VLayout(e,{content:[this.textArea,this.statusLabel],spacing:16,width:i.width})),this.gameState=t.gameState,this.textArea.setSize(i.width,i.height-this.statusLabel.height-16),this.layout.updateLayout();const s=JSON.stringify(this.gameState,null,2);return this.textArea.setText(s),this.validate(s),this.layout}getButtons(){return[{text:s.DialogButtons.Cancel,role:o.DialogButtonRole.Regular},{text:s.DialogButtons.Save,role:o.DialogButtonRole.PrimaryGreen}]}onBeforeClose(e){if(e===s.DialogButtons.Save){if(!this.validate(this.textArea.text))return u.app.audio.playEffect(r.SoundEffects.Deny),!1;try{h.inject.gameStateModel.restore(this.gameState),u.app.scene.worldMap.scene.isActive()&&u.app.scene.worldMap?.syncState(h.inject.currentGameState)}catch(e){return u.app.audio.playEffect(r.SoundEffects.Deny),this.statusLabel.setText(`Cannot load state: ${e.toString()}`),!1}}return!0}validate(e){let t;try{t=JSON.parse(e)}catch(e){return this.statusLabel.setText(`Cannot parse JSON: ${e.message.replaceAll("\n","\\n")}`),!1}try{(0,a.decompressGameState)(t)}catch(e){return this.statusLabel.setText(`Cannot load state: ${e.message.replaceAll("\n","\\n")}`),!1}return this.statusLabel.setText("Sanity check OK!"),this.gameState=t,!0}}},75676:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldDebugLayersManager=void 0;const s=i(2543),n=i(18957),o=i(65415),a=i(56824),r=i(91622);a.logger.for("DebugLayersManager");class l{get layers(){return this.ensureInitialized(),Object.keys(this._layers)}constructor(e){this.initializer=e,this._layers={blank:l.blankLayer},this.activeLayer=l.blankLayer,this.activeLayerName=void 0,this.onActiveLayerUpdated=(0,n.signal)(),this.initialized=!1}ensureInitialized(){this.initialized||(this.initialized=!0,this.initializer(this.register.bind(this)))}register(e,t){this.ensureInitialized(),this._layers[e]&&(this._layers[e].deactivate&&this._layers[e].deactivate(),this._layers[e].onChange.unsubscribeAll()),this._layers[e]=t,t.onChange((()=>this._layerChanged(t)))}registerAndActivate(e,t){this.ensureInitialized(),this.register(e,t),this.activate(e)}_layerChanged(e){e===this.activeLayer&&this.onActiveLayerUpdated.fire(this.activeLayer)}get(e){return this.ensureInitialized(),this._layers[e]}activate(e,t){if(this.ensureInitialized(),this.activeLayer&&this.activeLayer.deactivate&&this.activeLayer.deactivate(),e){if(!this._layers[e]){if(!t)throw new Error(`No debug layer found for name ${e}`);this.register(e,t())}this.activeLayerName=e,this.activeLayer=this._layers[e],this.activeLayer.activate&&this.activeLayer.activate(),r.inject.debugData.set("debugLayer",e)}else this.activeLayer=l.blankLayer,this.activeLayerName=void 0,r.inject.debugData.clear("debugLayer");this.onActiveLayerUpdated.fire(this.activeLayer)}}t.WorldDebugLayersManager=l,l.blankLayer={onChange:(0,n.signal)(),activate:s.noop,deactivate:s.noop,getMap:()=>new o.CustomHexGroupValuation(void 0),getDetail:()=>{}}},75726:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.expeditionsToOverworldTransition=async function(e){const t=n.config.screenTransitionDuration;let i=s.app.scene.expeditions.expeditionButtons.get();const l=i.find((t=>t.expedition.id===e)),c=s.app.scene.menuHeaderUI,d=s.app.scene.overworldUI,h=s.app.scene.levelList.visibility.currentTarget;await new Promise((e=>{s.app.scene.overworld.fadeIn(t),s.app.scene.levelList.visibility.setTo(0,"instant"),h>0&&(s.app.scene.levelList.scene.wake(),s.app.scene.levelList.visibility.setTo(h,"transition")),s.app.scene.expeditions.tweens.add({targets:(0,a.without)(i,l),alpha:0,duration:t/2,ease:"Sine.easeOut"}),r.assert.defined(l),l.takeOverScreen(t).then((()=>{l.alpha=1,l.width=o.ExpeditionButton.Layout.width,e()})),d.levelDetailUI.hide(),d.updateState({footerLayout:{mode:"no-level-selected"},levelDetail:null,primaryButton:null});const n=[c.overlayIcon,c.titleText,c.subtitleText,c.icon],u=[d.levelListUI.showHideButton,...d.levelListUI.filterButtons,d.levelListUI.filterSlider,d.levelListUI.sortButton];for(let e of[...n,...u])e.setAlpha(0);const p={alpha:{from:0,to:1},delay:2*t/3,duration:t/3,ease:"Sine.easeInOut"};c.tweens.add({targets:n,...p}),c.background.setAlpha(0),c.tweens.add({targets:[c.background],...p,alpha:{from:0,to:.87}}),d.levelListUI.showHideButton.setAlpha(0),d.tweens.add({targets:u,...p})}));for(let e of i)e.alpha=1};const s=i(54825),n=i(56824),o=i(35003),a=i(2543),r=i(97849)},75742:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MAX_FEEDBACK_LENGTH=t.DEFAULT_LIVES_PER_LEVEL=t.MAX_FACTIONS_COUNT=void 0,t.MAX_FACTIONS_COUNT=6,t.DEFAULT_LIVES_PER_LEVEL=3,t.MAX_FEEDBACK_LENGTH=2e3},76049:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FontFamily=t.VectorFont=t.DebugTextBox=t.BitmapFont=t.UNICODE_MAP=t.Fonts=void 0,t.loadVectorFonts=async function(){const e=[new FontFace("Roboto","url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu72xKOzY.woff2) format('woff2')",{style:"normal",weight:"400"}),new FontFace("Cinzel","url(https://fonts.gstatic.com/s/cinzel/v23/8vIU7ww63mVu7gtR-kwKxNvkNOjw-tbnfY3lDQ.woff2) format('woff2')",{style:"normal",weight:"400"})];await Promise.all(e)};const n=s(i(4440)),o=i(19506),a=i(54825);var r,l=n.default.GameObjects.Layer,c=n.default.GameObjects.BitmapText,d=n.default.GameObjects.Rectangle;t.Fonts=class{load(e){e.load.bitmapFont(r.Debug,"assets/fonts/debug.png","assets/fonts/debug.xml"),e.load.bitmapFont(r.Main,"assets/fonts/main.png","assets/fonts/main.xml"),e.load.bitmapFont(r.Mini,"assets/fonts/mini.png","assets/fonts/mini.xml"),e.load.bitmapFont(r.Mini2x,"assets/fonts/mini-2x.png","assets/fonts/mini-2x.xml"),e.load.bitmapFont(r.MiniBold,"assets/fonts/mini-bold.png","assets/fonts/mini-bold.xml"),e.load.bitmapFont(r.MiniBold2x,"assets/fonts/mini-bold-2x.png","assets/fonts/mini-bold-2x.xml"),e.load.bitmapFont(r.Small,"assets/fonts/small.png","assets/fonts/small.xml")}},t.UNICODE_MAP={"":o.GLYPH.hex,"":o.GLYPH.whiteFlag,"":o.GLYPH.redFlag,"":o.GLYPH.blackFlag,"":o.GLYPH.pawn,"":o.GLYPH.kingdom,"":o.GLYPH.checkMark,"":o.GLYPH.crossMark,"":o.GLYPH.pawns.milita,"":o.GLYPH.error},function(e){e.Debug="Debug",e.Main="Main",e.Small="Small",e.Mini="Mini",e.Mini2x="Mini-2x",e.MiniBold="MiniBold",e.MiniBold2x="MiniBold-2x"}(r||(t.BitmapFont=r={}));const h={origin:[0,0],backgroundOpacity:.2,padding:2,textAlign:c.ALIGN_LEFT,dropShadow:!0};var u,p;t.DebugTextBox=class extends l{constructor(e,t,i,s,n){super(e),this.opts={...h,...n},e.add.existing(this),this.text=new c(e,t,i,a.app.device.isMobile()?r.Small:r.Debug,s,void 0,this.opts.textAlign).setOrigin(...this.opts.origin),this.background=new d(e,t,i,0,0,0,.25).setOrigin(0,0),this.opts.dropShadow&&this.text.setDropShadow(1,1,0,1),this.opts.backgroundOpacity>0&&this.add(this.background),this.add(this.text),this.updateBackgroundSize()}setPosition(e,t){return this.text.setPosition(e,t),this.background.setPosition(this.text.x-this.text.width*this.text.originX-this.opts.padding,this.text.y-this.text.height*this.text.originY-this.opts.padding),this}setText(e){return this.text.setText(e.replace(/./g,(e=>t.UNICODE_MAP[e]||e))),this.updateBackgroundSize(),this}updateBackgroundSize(){this.background.setPosition(this.text.x-this.text.width*this.text.originX-this.opts.padding,this.text.y-this.text.height*this.text.originY-this.opts.padding),this.background.setSize(this.text.width+2*this.opts.padding,this.text.height+2*this.opts.padding)}},function(e){e.Cinzel32="Cinzel32",e.Cinzel20="Cinzel20",e.Cinzel16="Cinzel16",e.Roboto="Roboto",e.RobotoMini="RobotoMini",e.RobotoLarge="RobotoLarge"}(u||(t.VectorFont=u={})),function(e){e.Cinzel="Cinzel, Georgia, serif",e.Roboto="Roboto, Verdana, Arial"}(p||(t.FontFamily=p={}))},76087:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ViewsManager=void 0;const s=i(47671),n=i(23867),o=i(74783),a=i(40894),r=i(29074),l=i(26942),c=i(34696),d=i(54530),h=i(78645),u=i(10990),p=i(24385),g=i(31055),m=i(11612),y=i(48087),f=i(24239),w=i(51590),v=i(89437),b=i(60729),S=i(30308),x=i(46813),T=i(34445),P=i(4120),I=i(63077),C=i(38632),M=i(25777);t.ViewsManager=class{constructor(){this.attitude=new o.AttitudeView,this.fear=new s.FearView,this.hostility=new u.HostilityView,this.perceivedThreat=new w.PerceivedThreatView,this.conquerableHexes=new f.ConquerableHexesView,this.factionInfluenceByRegion=new n.FactionInfluenceByRegionView,this.behaviorSummary=new p.BehaviorSummaryView,this.factionNeighboursView=new g.FactionNeighboursView,this.powerBalance=new h.PowerBalanceView,this.attritionByFaction=new a.AttritionByFactionView,this.hexProximityToRegion=new r.HexProximityToRegionView,this.situationScoreByRegion=new l.SituationScoreByRegionView,this.expansionOptions=new c.ExpansionOptionsView,this.regionPoliticsView=new d.RegionPoliticsView,this.regionForecast=new m.RegionForecastView,this.regionGeography=new M.RegionGeographyView,this.factionDiplomacyScore=new y.FactionDiplomacyScoreView,this.mapGeometry=new v.MapGeometryView,this.powerByFactionView=new b.PowerByFactionView,this.idleChatter=new S.IdleChatterView,this.landingSpots=new x.LandingSpotsView,this.distanceFromCoast=new P.DistanceFromCoastView,this.regionLedger=new C.RegionLedgerView,this.undeadTowns=new T.UndeadTownsView,this.hexTraits=new I.HexPawnTraitsView}}},76169:(e,t,i)=>{"use strict";i(4440);const s=i(7701),n=i(56824),o=i(99545),a=i(94624),r=i(7966),l=i(11421),c=i(51496),d=i(78282),h=i(54825),u=i(68243),p=i(13419),g=i(35800),m=i(81700),y=i(78349),f=i(41815),w=i(54843),v=i(92656),b=i(80334).configProfiles.production,S=(0,p.getFrameParent)()??window.location.href;function x(e){window.devicePixelRatio;const{width:t,height:i}=T();e.width===t&&e.height===i||(console.warn(`Window size changed. Adjusting viewport size to ${t}x${i}`),h.app.game.scale.setGameSize(t,i))}function T(){return{width:1*window.innerWidth,height:1*window.innerHeight}}console.info(` Konkr.io production build 2.35.24-build-16101088196 (test-userdata-v3) running on ${S}`),(0,n.initPlatform)({events:new w.TypedEventBus,random:(0,g.createRandomGenerator)(),config:(0,v.deepWatchable)(b),errors:new r.SentryErrorHandler(b),storage:(0,f.hasLocalStorage)()?new y.LocalStorage:new y.InMemoryStorage}),u.Firebase.initialize(b),window.launchGame=async()=>{n.logger.addTransport("console",new l.ConsoleLogger),n.logger.for("game").info("starting");const e=new URLSearchParams(window.location.search).get("mode"),t=(0,a.getAppController)(e??b.mode),i={type:Phaser.AUTO,transparent:!0,fps:{limit:60},scale:{parent:"phaser-game",mode:Phaser.Scale.FIT,fullscreenTarget:"phaser-game",...T()},dom:{createContainer:!0},scene:void 0,pixelArt:!n.config.antialiasing,antialias:n.config.antialiasing},r=new Phaser.Game(i);(0,s.setupInjectionContainer)(r,b,t);for(let e of t.getScenes())r.scene.add(e.name,e,!1);n.errors.initializeContext(),h.app.device.updateScreenSize(),n.config.flags.cloudSync&&h.app.cloudSync.initialize(),r.scene.start(m.Scenes.Preload),(0,d.instrumentBrowserHistory)(),(0,o.registerConsoleCommands)(),h.app.analytics.setDefaultEventParams({build_number:"2.35.24-build-16101088196",real_dpr:window.devicePixelRatio||1,logical_dpr:h.app.device.dpr,ui_variant:h.app.device.uiVariant(),os:h.app.device.os(),parent_frame:h.app.device.frameParent}),c.track.pageView(),r.scale.on("resize",x),t.run()}},76314:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnObject=t.Highlight=t.PawnObjectModes=t.PAWN_SHADOW_SCALE_AT_MAX_JUMP=t.PAWN_JUMPING_HEIGHT=t.SYMBOL_VERTICAL_OFFSET=void 0;const s=i(79573),n=i(56824),o=i(19693),a=i(26596),r=i(97849),l=i(96137),c=i(79611),d=i(57189),h=i(63617),u=i(68878);var p,g;n.logger.for("PawnsManager"),t.SYMBOL_VERTICAL_OFFSET=-25,t.PAWN_JUMPING_HEIGHT=8,t.PAWN_SHADOW_SCALE_AT_MAX_JUMP=.2,function(e){e.Detached="detached",e.AttachedToTile="attached",e.Tweening="tweening",e.Destroyed="destroyed"}(p||(t.PawnObjectModes=p={})),function(e){e.Hang="hang",e.SelectedForMove="selected-for-move"}(g||(t.Highlight=g={})),t.PawnObject=class{constructor(e,t,i,s){this.manager=e,this.id=t,this.type=i,this.variant=s,this.visible=!1,this.baseX=0,this.baseY=0,this.tile=void 0,this.jumping=!1,this.jumpingDeSync=0,this.highlight=null,this.mode=p.Detached,this.shadow=e.pools.getPawnShadow(i,s),this.image=e.pools.getPawnImage(i,s)}attachToTile(e){if(this.mode===p.AttachedToTile){if(this.tile===e)return;this.detachFromTile()}this.setMode(p.AttachedToTile),this.assertNotDestroyed(),this.tile=e;const t=(0,c.getPawnRenderRecipe)(this.type).depthAdjustment;e.addObject(this.image,0,3,t),e.addObject(this.shadow,0,3,t),this.attachSymbol(),this.baseX=this.tile.centerX,this.baseY=this.tile.centerY+3,this.baseDepth=this.image.depth,this.shadow.setDepth(this.image.depth-1),this.highlight===g.Hang&&this.startHangingTween()}setMode(e){if(this.mode!==e){switch(this.stopAllTweens(),this.mode){case p.AttachedToTile:this.detachFromTile();break;case p.Destroyed:throw this.illegalModeTransitionError(e);case p.Tweening:const t=(0,c.getPawnRenderRecipe)(this.type);this.image.setRotation(0),this.image.setScale(t.scale),this.image.setAlpha(1),this.shadow.setAlpha(1)}this.mode=e,this.symbol?.setVisible(this.shouldShowSymbol())}}get hanging(){return this.highlight===g.Hang}setHighlight(e){if(this.highlight!==e)if(e)switch(this.highlight=e,e){case g.Hang:this.symbol?.setVisible(!1),this.mode===p.AttachedToTile&&this.startHangingTween();break;case g.SelectedForMove:this.symbol?.setVisible(!1),this.shadow.setFrame("pawn-move-pedestal").setTint(l.Colors.highlight.ownedRegion),this.startPedestalTween(),this.shadow.setScale(1);break;case null:this.clearHighlight()}else this.clearHighlight()}clearHighlight(){null!==this.highlight&&(this.stopAllTweens(),this.symbol?.setVisible(this.shouldShowSymbol()),this.highlight===g.SelectedForMove&&this.shadow.setFrame((0,c.getPawnRenderRecipe)(this.type).getShadowFrame(this.variant)).clearTint(),this.jumping?(this.setJumpPhase(.5),this.jumpingDeSync=this.manager._getCurrentJumpingDeSyncForPawn(this,.5)):this.setJumpPhase(0),this.highlight=null)}shouldShowSymbol(){return this.mode===p.AttachedToTile&&this.visible}shouldShowImage(){return this.mode!==p.Destroyed&&this.visible}shouldShowShadow(){return this.mode===p.AttachedToTile&&this.visible}setSymbol(e){this.assertNotDestroyed(),this.symbol?this.symbol.setFrame((0,d.getFrameForPawnSymbol)(e)):(this.symbol=this.manager.pools.getTileSymbol(e),this.attachSymbol())}attachSymbol(){this.tile&&this.symbol&&(this.tile.addObject(this.symbol,0,t.SYMBOL_VERTICAL_OFFSET),this.symbol.setDepth(s.WorldLayers.UIOverlay),this.symbol.setVisible(this.shouldShowSymbol()))}setJumpPhase(e){const i=-(0,a.jump2)(e)*t.PAWN_JUMPING_HEIGHT;this.image.setX(this.baseX),this.image.setY(this.baseY+i),this.symbol?.setY(this.baseY+i+t.SYMBOL_VERTICAL_OFFSET-3),this.shadow.setScale(.5-(0,a.jump2)(e)*t.PAWN_SHADOW_SCALE_AT_MAX_JUMP)}illegalModeTransitionError(e){return new Error(`Illegal mode transition ${this.mode} => ${e}\`)`)}assertMode(e,t="operation"){if(this.mode!==e)return new Error(`${t} unavialable in ${this.mode} (expected ${e})`)}removeSymbol(){this.symbol&&(this.tile&&this.tile.removeObject(this.symbol),this.manager.pools.free(this.symbol),this.symbol=void 0)}detachFromTile(){this.tile&&(this.tile.removeObject(this.image),this.tile.removeObject(this.shadow),this.symbol&&this.tile.removeObject(this.symbol))}destroy(){this.assertNotDestroyed(),this.detachFromTile(),this.removeSymbol(),this.mode=p.Destroyed,this.stopAllTweens(),this.manager._remove(this),this.manager.pools.free(this.image),this.manager.pools.free(this.shadow)}stopAllTweens(){this.manager.scene.tweens.getTweensOf(this.image).forEach((e=>e.stop()))}setVisible(e){e?this.show():this.hide()}hide(){this.assertNotDestroyed(),this.visible=!1,this.image.setVisible(!1),this.shadow.setVisible(!1),this.symbol?.setVisible(!1)}show(){this.assertNotDestroyed(),this.visible=!0,this.image.setVisible(!0),this.shadow.setVisible(this.hasShadow()),this.symbol?.setVisible(!0)}hasShadow(){return(0,c.getPawnRenderRecipe)(this.type).hasShadow}isDestroyed(){return this.mode===p.Destroyed}assertNotDestroyed(){(0,r.assert)(!this.isDestroyed(),`Attempting to modify ${this.type} at ${this.tile?.hex.id??"(no hex)"}, which is already destroyed`)}setType(e,t){if(this.assertNotDestroyed(),this.type===e&&this.variant===t)return;this.type=e,this.variant=t;const i=(0,c.getPawnRenderRecipe)(this.type);this.image.setFrame(i.getFrame(t)),this.shadow.setFrame(i.getShadowFrame(t)),this.image.setScale(i.scale),this.image.setAlpha(1)}stopJumping(){this.jumping=!1,this.setJumpPhase(0)}startJumping(){(0,u.isViewingReplay)()||this.jumping||(this.jumpingDeSync=this.manager._getCurrentJumpingDeSyncForPawn(this),this.jumping=!0)}setJumping(e){e?this.startJumping():this.stopJumping()}setTweens(e){this.assertNotDestroyed(),this.clearHighlight(),this.setMode(p.Tweening),this.image.setDepth(s.WorldLayers.FlyingObject+this.image.y);for(const t of e)this.manager.scene.tweens.add(t)}startHangingTween(){this.assertNotDestroyed();const e=this.tile.centerY-o.HOVERING_HEIGHT;this.stopAllTweens(),this.manager.scene.tweens.add({targets:[this.image],duration:200,ease:"Sine.easeOut",y:e}),this.manager.scene.tweens.add({targets:this.shadow,duration:100,ease:"Sine.easeOut",scale:.5-t.PAWN_SHADOW_SCALE_AT_MAX_JUMP})}debugContext(){return`[pawnObject ${this.id} (sprite ${(0,h.getObjId)(this.image)})]`}startPedestalTween(){const e=this.baseY-3;this.stopAllTweens(),this.manager.scene.tweens.add({targets:[this.image],duration:200,ease:"Sine.easeOut",y:e}),this.manager.scene.tweens.add({targets:this.shadow,duration:100,ease:"Sine.easeOut",scale:{from:.1,to:1}})}}},76356:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CallToActionForm=void 0;const s=i(86545),n=i(76049),o=i(96137),a=i(56793),r=i(21941),l=i(20087),c=i(54825);var d=Phaser.GameObjects.BitmapText;class h extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.title=new d(this.scene,0,0,n.BitmapFont.Main,"").setTint(o.Colors.glassUi_old.primaryText),this.content=new d(this.scene,0,0,n.BitmapFont.Small,"").setTint(o.Colors.glassUi_old.primaryText),this.submitButtonText=new d(this.scene,0,0,n.BitmapFont.Small,"OK").setTint(o.Colors.glassUi_old.primaryText),this.submitButton=new a.BoxButton_LEGACY(this.scene,0,0,{baseTexture:r.BoxTextures.DialogButton,downTexture:r.BoxTextures.DialogButtonDown,text:this.submitButtonText,width:200,height:36}),this.add([this.title,this.content,this.submitButton]),this.submitButton.onClicked((()=>{this.onSubmit?.()}))}applyProps(e){return this.title.setText(e.title),this.content.setText(e.content),this.submitButtonText.setText(e.action),this.onSubmit=e.onSubmit,this.preUpdate.makeDirty(),this}updateLayout(){this.title.setMaxWidth(this.width),this.content.setMaxWidth(this.width),l.Arrange.fromTopToBottomOld([this.title,this.content,this.submitButton],{x:0,y:0,originX:0,originY:0,spacing:10});const e=c.app.scene.globalUI.notifications.layout;this.submitButton.x=this.width/2-this.submitButton.width/2-(e.padding+e.spaceForIcon)/2,this.updateSize()}calculateHeight(){return this.submitButton.y+this.submitButton.height}}t.CallToActionForm=h},76439:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameStateDebugLayer=void 0;const s=i(18957),n=i(65415),o=i(91622),a=i(2543),r=i(54825);t.GameStateDebugLayer=class{constructor(e){this.adapter=e,this.onChange=(0,s.signal)(),this.listener=(0,a.debounce)((()=>this.onChange.fire()),100,{trailing:!0}).bind(this)}getGroups(){return this.adapter.getGroups?.(r.app.getCurrentGameStateModel().state)||[]}activate(){o.inject.gameStateModel.stateEngine.watchAll(this.listener)}deactivate(){o.inject.gameStateModel.stateEngine.stopWatching(this.listener)}getMap(){const e=r.app.getCurrentGameStateModel().state,t=new n.CustomHexGroupValuation(void 0);for(const i of this.adapter.getHexes(e))t.set(i.id,this.adapter.getValue(e,i.id));return t}getDetail(e){return this.adapter.getDetail(r.app.getCurrentGameStateModel().state,e.id)}getArrows(){if(!this.adapter.getParents&&!this.adapter.getChildren)return[];let e=[];const t=r.app.getCurrentGameStateModel().state,i=this.adapter.getHexes(t);for(const s of i)this.adapter.getParents&&this.adapter.getParents(t,s.id)?.forEach((t=>{e.push([t,s.id])})),this.adapter.getChildren&&this.adapter.getChildren(t,s.id)?.forEach((t=>{e.push([s.id,t])}));return e}}},76540:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PALETTE_PADDING=t.PALETTE_SLOT_SIZE=t.PALETTE_SPACING=t.MAP_EDITOR_TABS_WIDTH=t.MAP_EDITOR_SIDEBAR_WIDTH=void 0,t.MAP_EDITOR_SIDEBAR_WIDTH=336,t.MAP_EDITOR_TABS_WIDTH=t.MAP_EDITOR_SIDEBAR_WIDTH/4,t.PALETTE_SPACING=4,t.PALETTE_SLOT_SIZE=40,t.PALETTE_PADDING=17},76594:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefeatScreen=void 0;const s=i(81700),n=i(95568),o=i(36868),a=i(42880),r=i(80778),l=i(98963),c=i(91622),d=i(54825),h=i(71021),u=i(551),p=i(51496),g=i(45084),m=i(24598),y=i(52724),f=i(43046),w=i(56824),v=i(25430);class b extends n.BaseScreen{constructor(){super("Defeat",[s.Scenes.WorldMap,s.Scenes.Defeat]),this.observe.event(o.UserActions.Escape,(async()=>{const e=c.inject.levelSession.data?.origin;c.inject.levelSession.end({origin:"defeat/return-to-menu",wipeAutoSave:!0}),(0,r.returnToMenuFromGame)(e)})),this.observe.event(o.UserActions.RestartLevel,(()=>{w.events.trigger(o.UiEvents.RestartConfirmed({aiDifficulty:c.inject.levelSession.aiDifficulty})),d.app.audio.playEffect(l.SoundEffects.Rewind)})),this.observe.event(o.UserActions.StartRewind,(()=>{d.app.navigator.goTo(d.app.screen.play,h.NewGameStateContext.Rewind),d.app.scene.play.setMode(new u.RewindMode(d.app.scene.play))})),this.observe.event(o.UserActions.ViewReplay,(()=>{p.track.interaction("view_replay"),d.app.navigator.goTo(d.app.screen.play,h.NewGameStateContext.ViewReplayAfterGameOver)})),this.observe.event(o.UserActions.KeepWatching,(()=>{p.track.interaction("keep_watching"),d.app.navigator.goTo(d.app.screen.play,h.NewGameStateContext.ContinueSpectatingAfterGameOver)}))}async activate(e){if(d.app.scene.worldMap.setMode(new a.PreviewMode),d.app.scene.worldMap.overlays.attitudeEmojis.syncWithModel(c.inject.gameStateModel),d.app.scene.worldMap.cameraController.center(1e3),!e?.returning){d.app.audio.playEffect(l.SoundEffects.Defeat);const e=c.inject.gameStateController.history.getCursor();e.move(f.Move.seekBack((e=>!!e.events?.some((e=>"GAME_STATE.HEX_CAPTURED"===e.name)))));const t=g.CurrentPhase.model(e.currentState).faction;if(t?.controller===m.FactionController.Ai&&t.isAlive()){const e=t.getLargestLiveRegion();if(e){const t=(0,y.generateChatter)(e,c.inject.gameStateModel.factions.localPlayer,{requiredTags:["caused major damage"]}),i=e.getTownHexes().first();t&&i&&await d.app.scene.worldMap.overlays.attitudeEmojis.showChatter(i,t,void 0,300)}}}}async transitionOut(e){e===d.app.screen.overworld&&await(0,v.defeatToOverworldTransition)()}}t.DefeatScreen=b},76639:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExplainRebellion=t.InspectingRival=t.Tutorial3=void 0;const s=i(45664),n=i(37971),o=i(36868),a=i(91622),r=i(54825),l=i(34174),c=i(12167),d=i(95428),h=i(24598),u=i(97849),p=i(52724),g=i(64884),m=i(70712),y=i(19618),f=i(43046),w=i(85671),v=i(56824);var b;!function(e){e[e.DefeatGodfrey=0]="DefeatGodfrey",e[e.CapitalizeOnGodfreysWeakness=1]="CapitalizeOnGodfreysWeakness",e[e.EndGame=2]="EndGame",e[e.MopUp=3]="MopUp"}(b||(b={})),t.Tutorial3=class{constructor(){this.phase1_intro=new P(this),this.phase1_opportunity=new I(this),this.phase1_afterBankruptingMove=new C(this),this.phase1_itsGoTime=new M(this),this.phase2_watchOutForGodfrey=new A(this),this.phase2_watchOutForEveryone=new B(this),this.phase3_afterDefeatingGodfrey=new E(this),this.phase3_endGameIntro=new O(this),this.phase3_turnStartAssessment=new R(this),this.main=new S(this),this.idle=new x(this),this.inspectingRival=new T(this),this.teachRewind=new k(this),this.commentOnRewind=new L(this),this.negativeIncomeAlert=new _(this),this.explainRebellion=new D(this),this.rivalDefeated=new H(this),this.inspectedGodfreysBankruptProvince=!1,this.seenEndGameIntro=!1,this.seenUpperHandWarning=!1,this.startedRewind=!1}};class S extends n.LevelScript{activate(){const e=a.inject.gameStateModel.currentPhase.turnNumber,t=U();if(this.module.startedRewind)return this.module.startedRewind=!1,void this.goTo("commentOnRewind");if(1!==e&&(a.inject.gameStateModel.factions.localPlayer?.getLargestLiveRegion()?.budget.balance??0)<0)return this.goTo("negativeIncomeAlert");if(function(){const e=a.inject.gameStateModel.factions.localPlayer?.getLargestLiveRegion();return 0===e?.getMyAssets().totalUnits.count()&&0===e?.treasury}())return this.goTo("explainRebellion");switch(t){case b.DefeatGodfrey:return void(1===e?this.goTo("phase1_intro"):j()?this.module.inspectedGodfreysBankruptProvince?this.goTo("phase1_itsGoTime"):setTimeout((()=>this.goTo("phase1_afterBankruptingMove")),500):2===e&&a.inject.gameStateModel.currentPhase.isLocalPlayerTurn()?this.goTo("phase1_opportunity"):this.goTo("idle"));case b.CapitalizeOnGodfreysWeakness:return void(function(){const e=F();return 0===e?.treasury&&0===e?.getUnitsByMight().count()}()?this.goTo("phase2_watchOutForGodfrey"):function(){const e=a.inject.gameStateModel.factions.localPlayer,t=a.inject.gameStateModel.factions.byId(2)?.getLargestLiveRegion(),i=a.inject.gameStateModel.factions.byId(3)?.getLargestLiveRegion(),s=t&&(0,p.generateTags)(t,e),n=i&&(0,p.generateTags)(i,e);return!(!s?.has("caused damage")&&!n?.has("caused damage"))}()?this.goTo("phase2_watchOutForEveryone"):this.goTo("idle"));case b.EndGame:return void(a.inject.gameStateModel.currentPhase.faction?.isLocalPlayer()?function(){if(F()?.isAlive())return!1;const e=a.inject.gameStateController.history.getCursor();e.move(f.Move.seekBackTag("turnStart",2));const t=e.currentState;return!!e&&(!!y.Factions.model(t).byId(4)?.isAlive()||void 0)}()?this.goTo("phase3_afterDefeatingGodfrey"):this.module.seenEndGameIntro?this.goTo("phase3_turnStartAssessment"):this.goTo("phase3_endGameIntro"):this.goTo("idle"));case b.MopUp:return void this.goTo("idle")}}}class x extends w.SimpleStep{onConfirmRewind(){this.goTo("commentOnRewind")}onStartRewind(){this.goTo("teachRewind")}onHexCaptured(e){a.inject.gameStateModel.currentPhase.isLocalPlayerTurn()&&(1303===e.capturedHexId||303===e.capturedHexId?this.goTo("rivalDefeated"):this.goTo("main"))}onRegionSelected(e){!e||a.inject.gameStateModel.regions.byId(e)?.faction?.isLocalPlayer()?this.goTo("main"):this.goTo("inspectingRival")}}class T extends x{activate(){const e=a.inject.gameStateModel.regions.byId(a.inject.levelSession.selectedRegionId),t=e?.faction?.id;if(U()===b.DefeatGodfrey&&4===t){if(u.assert.defined(e),j()){this.module.inspectedGodfreysBankruptProvince=!0;const t=1!==e.treasury?"s":"";return this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{v.events.trigger(o.UserActions.ShowHelp("how-to-play/rebellion"))})),super.activate({worldMapPanel:{type:"tutorial",text:`Aha! Only ${e.treasury} coin${t} in his treasury and now he's losing ${-e.budget.balance} coins per turn! Godfrey [b]can't pay his knights[/b] so they will rebel and [b]become harmless bandits[/b]!\nOh Godfrey, you silly Goose, you will regret this!`,emojiEmotion:d.EmojiEmotion.VeryHappy,buttons:[c.DIALOG_BUTTONS.moreInfo]},tutorialFrameTarget:l.Placement.aroundRegionPopup})}if(e?.budget.balance<10){const t=1!==e.budget.balance?"s":"";return this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{v.events.trigger(o.UserActions.ShowHelp("how-to-play/economy"))})),super.activate({worldMapPanel:{type:"tutorial",text:`Hmm, with a net income of measly ${e.budget.balance} coin${t} per turn, his economy is not healthy at all... If we can [b]cut off just a bit more of his territory[/b], he'll be in a very bad shape! Maybe there's a chance!`,emojiEmotion:d.EmojiEmotion.Happy,buttons:[c.DIALOG_BUTTONS.moreInfo]},tutorialFrameTarget:l.Placement.aroundRegionPopup})}}else if(2===t||3===t){u.assert.defined(e);const t=(0,p.generateTags)(e,a.inject.gameStateModel.factions.localPlayer);if(this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{v.events.trigger(o.UserActions.ShowHelp("how-to-play/rivals"))})),t.has("friendly"))return super.activate({worldMapPanel:{type:"tutorial",text:"Hmm, he seems friendly enough for now, but I wouldn't count on it!",emojiEmotion:d.EmojiEmotion.Doubtful,buttons:[c.DIALOG_BUTTONS.moreInfo]}});if(t.has("hostile"))return super.activate({worldMapPanel:{type:"tutorial",text:"He looks quite angry with us, doesn't he! We should make sure he can't hit us where it hurts!",emojiEmotion:d.EmojiEmotion.Doubtful,buttons:[c.DIALOG_BUTTONS.moreInfo]}});if(t.has("angered by dominance"))return super.activate({worldMapPanel:{type:"tutorial",text:"Haha, he looks quite desperate, but be careful. Seems he's not about to give up yet!",emojiEmotion:d.EmojiEmotion.Happy,buttons:[]}})}return super.activate(),this.goTo("idle")}}t.InspectingRival=T;class P extends x{constructor(){super(...arguments),this.firstTime=!0}activate(){const e="Welcome to [b]Godfrey's home island[/b]! Time to put an end to his raids once and for [b]OH MY GOD[/b]! He's [b]WAY[/b] more powerful than I expected. We are doomed! [b]DOOMED![/b]";if(super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:this.firstTime?d.EmojiEmotion.Malicious:d.EmojiEmotion.VeryShocked,buttons:[],text:e}}),this.firstTime){this.firstTime=!1;const t=a.inject.scriptRunner.currentScriptName;setTimeout((()=>{a.inject.scriptRunner.currentScriptName===t&&r.app.scene.playUI.updateState({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.VeryShocked,buttons:[],text:e}})}),1500)}}}class I extends x{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.Happy,buttons:[],text:"Oh look! He's busy fighting two other kings!\nIf you [b]strike now[/b], maybe together we can overwhelm him!"}})}}class C extends x{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.Doubtful,buttons:[],text:"Wow, the other two kings really liked that move! And Godfrey's knights appear confused? Let's [b]select Godfrey's province[/b] to check what's going on in there."},tutorialArrowTarget:l.Placement.atWorldMapHex((0,s.getHex)(808),-10)})}}class M extends x{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.VeryMalicious,buttons:[],text:"No need to worry about defense now! [b]It's go time![/b]"}})}}class A extends x{activate(){this.module.inspectedGodfreysBankruptProvince?super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.VeryHappy,buttons:[],text:"What an upset! I never doubted you can do it! But keep in mind, with Godfrey's knights gone, his economy is going to recover fast and now he [b]really[/b] hates us! Better finish him off quick I say!"}}):(super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.VeryHappy,buttons:[c.DIALOG_BUTTONS.moreInfo],text:"Oh wow! Godfrey lost so much territory that he couldn't pay his knights anymore! [b]They rebelled and turned into harmless bandits[/b]! Quick, [b]ATTACK before his economy can recover![/b]"}}),this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{v.events.trigger(o.UserActions.ShowHelp("how-to-play/rebellion"))})))}}class B extends x{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.Shocked,buttons:[c.DIALOG_BUTTONS.moreInfo],text:"What?! One of the other kings just grabbed some of our land! I knew they couldn't be trusted! Plan your next moves carefully, this is getting quite messy!"}}),this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{v.events.trigger(o.UserActions.ShowHelp("how-to-play/rivals"))}))}}class E extends x{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.Satisfied,buttons:[],text:"[b]We did it![/b] Godfrey the Goose? More like Godfrey the Lose! And we have claimed a beautiful new island too! Hmm... Just need to wait for the other Kings to leave I guess?..."}})}}class O extends x{activate(){this.module.seenEndGameIntro=!0,super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.Worried,buttons:[c.DIALOG_BUTTONS.moreInfo],text:"Oh no, this is far from over, isn't it! The [b]rival kings[/b] want the island too and these are no poultry-nicknamed simpletons. They are [b]cunning[/b] and [b]ruthless[/b]! Use all that you have learned and [b]show them you're not to be trifled with![/b]"}}),this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{v.events.trigger(o.UserActions.ShowHelp("how-to-play/rivals"))}))}onRegionSelected(e){e&&a.inject.gameStateModel.regions.byId(e)?.faction?.isLocalPlayer()||super.onRegionSelected(e)}}class R extends x{activate(){const e=a.inject.views.powerBalance.get(a.inject.currentGameState),t=a.inject.gameStateModel.factions.localPlayer.confidence,i=function(){const e=m.AI.getFactionTotalAttrition(a.inject.currentGameState,1),t=a.inject.gameStateController.history.getCursor();if(t.move(f.Move.seekBackTag("turnStart",1),f.Move.stepBack,f.Move.seekBackTag("turnStart",1))&&t.hasStateInMemory()){const i=t.currentState;return e-m.AI.getFactionTotalAttrition(i,1)}return e}();if(t<.5&&i>=200)a.inject.levelSession.remainingLives>0?(super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.Shocked,buttons:[c.DIALOG_BUTTONS.moreInfo],text:"Damnit, that hurt. It may be time to use our [b]REWIND[/b] superpower!"},tutorialArrowTarget:l.Placement.aroundRewindButton,tutorialFrameTarget:l.Placement.aroundRewindButton}),this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{v.events.trigger(o.UserActions.ShowHelp("how-to-play/rewind"))}))):super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.Shocked,buttons:[],text:"Oh no, another setback and we have no more rewinds left! But don't give up! We can still turn this around!"}});else if(t<.25)a.inject.levelSession.remainingLives>0?(super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.DeeplyWorried,buttons:[c.DIALOG_BUTTONS.moreInfo],text:"Oh boy, what a disaster! This would be a great time to you our secret [b]REWIND[/b] superpower!"},tutorialArrowTarget:l.Placement.aroundRewindButton,tutorialFrameTarget:l.Placement.aroundRewindButton}),this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{v.events.trigger(o.UserActions.ShowHelp("how-to-play/rewind"))}))):super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.DeeplyWorried,buttons:[],text:"Oh boy, I think we lost this one..."},tutorialArrowTarget:l.Placement.aroundRestartButton,tutorialFrameTarget:l.Placement.aroundRestartButton});else if(e.dominantFaction?.isLocalPlayer()&&e.dominance>100){if(this.module.seenUpperHandWarning)return this.goTo("idle");this.module.seenUpperHandWarning=!0,super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.Worried,buttons:[c.DIALOG_BUTTONS.moreInfo],text:"You have the upper hand but be careful! The other kings [b]fear your strength[/b] which makes them likely to [b]conspire against you![/b] Strengthen your lead and [b]don't trust those snakes![/b]"}}),this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{v.events.trigger(o.UserActions.ShowHelp("how-to-play/rivals"))}))}else this.goTo("idle")}onRewind(){this.goTo("teachRewind")}}class k extends x{activate(){this.module.startedRewind=!0,super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.Happy,buttons:[],text:"With the power of [b]REWIND[/b] you can go back in time as far as you need to!"}})}onRegionSelected(e){}}class L extends x{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.Happy,buttons:[],text:"Magical, isn't it? But we can only use this super-power [b]three times per Island[/b], so use it wisely!"}})}}class _ extends x{activate(){super.activate({worldMapPanel:{type:"tutorial",text:"Watch out! [b]We are now losing coins each turn![/b] We need to quickly increase our income, or we'll end up like Godfrey!",emojiEmotion:d.EmojiEmotion.DeeplyWorried,buttons:[c.DIALOG_BUTTONS.moreInfo]},tutorialFrameTarget:l.Placement.aroundIncomeLabel}),this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{v.events.trigger(o.UserActions.ShowHelp("how-to-play/economy"))}))}}class D extends x{activate(){const e=a.inject.levelSession.remainingLives>0;super.activate({worldMapPanel:{type:"tutorial",text:"Disaster! [b]We didn't have enough coins to pay all our units[/b] so our army deserted!"+(e?" This would be a good time to use our [b]REWIND[/b] superpower!":""),emojiEmotion:d.EmojiEmotion.DeeplyWorried,buttons:[c.DIALOG_BUTTONS.moreInfo]},tutorialArrowTarget:e?l.Placement.aroundRewindButton:null,tutorialFrameTarget:e?l.Placement.aroundRewindButton:null}),this.onButtonClicked(c.DIALOG_BUTTONS.moreInfo,(()=>{v.events.trigger(o.UserActions.ShowHelp("how-to-play/rebellion"))}))}}t.ExplainRebellion=D;class H extends x{activate(){super.activate({worldMapPanel:{type:"tutorial",emojiEmotion:d.EmojiEmotion.VeryMalicious,buttons:[],text:"Nicely done! One rival down, one more to go!"}})}}function j(){return!!a.inject.gameStateModel.currentPhase.faction?.isLocalPlayer()&&a.inject.gameStateModel.factions.byId(4)?.getLargestLiveRegion()?.isBankrupt()}function F(){return a.inject.gameStateModel.factions.byId(4)?.getLargestLiveRegion()}function U(){return F()?.isAlive()?(F()?.getUnitsByMight()??g.UnitsByMight.empty).countOf(3)>0?b.DefeatGodfrey:b.CapitalizeOnGodfreysWeakness:new Set(a.inject.gameStateModel.factions.all().filter((e=>e.isAlive()&&e.controller===h.FactionController.Ai))).size>1?b.EndGame:b.MopUp}},76738:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Ribbon=t.RibbonTextures=void 0;var i=Phaser.GameObjects.NineSlice;t.RibbonTextures={WindowHeader:{frame:"ui/ribbon/window-header",borderWidth:4},ButtonGroup:{frame:"ui/ribbon/button-group",borderWidth:16},Slider:{frame:"ui/ribbon/slider",borderWidth:8},ColorBar:{frame:"ui/ribbon/color-bar",borderWidth:4,height:12},SmallButton:{frame:"ui/ribbon/small-button",borderWidth:8},SmallButtonDown:{frame:"ui/ribbon/small-button-down",borderWidth:8},MediumButton:{frame:"ui/ribbon/medium-button",borderWidth:8},MediumButtonDown:{frame:"ui/ribbon/medium-button-down",borderWidth:8},UnitTray:{frame:"ui/ribbon/unit-tray",borderWidth:8},Cloth:{borderWidth:8,frame:"ui/ribbon/cloth"},Pergamen:{frame:"ui/ribbon/pergamen",borderWidth:64},SmallPergamen:{frame:"ui/ribbon/small-pergamen",borderWidth:24},SmallPergamenShadow:{frame:"ui/ribbon/small-pergamen-shadow",borderWidth:12}},t.Ribbon=class extends i{constructor(e,t,i=0,s=0,n=0){super(e,i,s,"atlas",t.frame,n,void 0,t.borderWidth,t.borderWidth),this.setOrigin(0,0)}setFrameFrom(e){this.setFrame(e.frame)}}},76816:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Reporter=t.ReportingEvents=void 0,t.reportingEvent=d;const s=i(39420),n=i(2812),o=i(15052),a=i(94231),r=i(51496),l=i(56824),c=i(7986);function d(){return(0,s.createEventFactory)(s.EventCategory.ReportingEvent)}t.ReportingEvents={SubmitFeedbackForm:d()("SUBMIT_FEEDBACK_FORM")},l.logger.for("Reporter"),t.Reporter=class{constructor(){this.slackClient=new n.SlackClient(l.config.reporting.slack.feedbackHook),this.autoPrompts=new a.AutoPrompts,this.telemetry=new c.Telemetry,l.events.on(t.ReportingEvents.SubmitFeedbackForm,(e=>{if(e.comment&&l.config.reporting.slack.enabled){const t=(0,o.reportFeedback)(e);this.slackClient.sendMessage(t)}r.track.playerFeedback({mood:e.mood,level_id:e.levelId})}))}setupTelemetryReporting(){this.telemetry.initialize()}async sendTelemetryEvents(){await this.telemetry.flushPendingEvents()}}},76872:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ZombiesPlugin=void 0;const s=i(18497),n=i(24598),o=i(78635),a=i(52307),r=i(19618),l=i(63521),c=i(74370),d=i(56824),h=i(32202);function u(e,t,i){for(const s of Object.keys(e)){const n=e[s].find((e=>e.tool===t));if(n)return void(n.tool=i)}d.errors.handleNonFatalError(`Failed to replace tool in palette (${t.options.title}->${i.options.title}) - original tool not found`,"swapTool")}t.ZombiesPlugin={name:s.PluginKey.Zombies,displayName:"Zombies",icon:"ui/level-features/zombies",register(e){e.ai.hexVulnerabilityMultiplier.register(((e,t,i,s)=>o.Warfare.model(t).getOccupyingUnit(s)?.type===n.PawnType.HauntedTown?e:s.findNeighbour((e=>{const c=o.Warfare.model(t).getOccupyingUnit(e);return!(c?.type!==n.PawnType.Zombie&&c?.type!==n.PawnType.LadderZombie||(0,a.crossesWall)(t,s,e)||function(e,t,i){return!!i.findNeighbour((i=>{if(r.Factions.getByHex(e,i.id)!==t)return!1;const s=o.Warfare.model(e).getOccupyingUnit(i);return s?.type===n.PawnType.Town||!(!s?.traits.includes(l.PawnTraits.Unit)||s.isMovable())}))}(t,i,e))}))?.1*e:e)),e.ai.hexConquestBonus.register(((e,t,i)=>o.Warfare.getOccupyingPawn(t,i)?.type===n.PawnType.HauntedTown?e+200:e)),e.mapEditor.adjustToolPalette.register((e=>(u(e,c.EDITOR_TOOL.paintBandit,c.EDITOR_TOOL.paintZombie),u(e,c.EDITOR_TOOL.paintBanditCamp,c.EDITOR_TOOL.paintHauntedTown),e.other.push({tool:c.EDITOR_TOOL.paintLadderZombie},{tool:c.EDITOR_TOOL.paintDreadKnight}),e)))},onAdded:e=>(0,h.zombifyLevel)(e),onRemoved:e=>(0,h.dezombifyLevel)(e)}},76985:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UPKEEP_TABLE=void 0,t.mightToUpkeep=function(e){return(0,s.assert)(e>=0||e<=4,"invalid might "+e),t.UPKEEP_TABLE[e]??0},t.getMaxMightForHex=function(e,t){const i=a.inject.ai.maxAllowedUnitMight??r.MAX_UNIT_MIGHT;return i>2&&o.Pawns.isTraitPresentOnHex(e,t.id,n.PawnTraits.PreventsHeavyUnits)?{maxAllowedMight:i,bannedMightLevels:[3]}:{maxAllowedMight:i}};const s=i(97849),n=i(63521),o=i(81434),a=i(91622),r=i(64884);t.UPKEEP_TABLE={1:2,2:6,3:18,4:54}},77165:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TownStatusFlagsManager=t.FlagObject=void 0;const s=i(56824),n=i(6528),o=s.logger.for("TownStatusFlags");class a{constructor(e,t){this.renderer=e,this.objectPool=t}acquireSprites(){this.flagFace||(this.flagFace=this.objectPool.getFlag(0,0),this.flagPole=this.objectPool.getFlagPole(0,0))}attachToTile(e){this.acquireSprites(),this.tile=e,e.addObject(this.flagFace,10,-8),e.addObject(this.flagPole,10,10),this.flagPole.setDepth(this.flagPole.depth+2),this.flagFace.setDepth(this.flagPole.depth+3).play("wave-flag")}setTint(e){return this.acquireSprites(),this.flagFace.setTint(e),this}destroy(){this.tile&&(this.tile.removeObject(this.flagFace),this.tile.removeObject(this.flagPole),this.objectPool.free(this.flagPole),this.objectPool.free(this.flagFace))}}t.FlagObject=a;class r extends n.TileAttachmentsManager{constructor(e,t,i){super("TownStatusFlags",e,i,o),this.imagePool=t}attachObject(e,t){e.attachToTile(t)}createObject(e,t){return new a(this.renderer,this.imagePool).setTint(t)}removeObject(e,t){e.destroy()}updateObject(e,t,i){e.setTint(i)}}t.TownStatusFlagsManager=r},77328:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HtmlDialog=void 0;const s=i(5365),n=i(63032),o=i(89995);t.HtmlDialog=class{getTitle(){return this.title}getContent(e,t,i){return this.iframe||(this.iframe=new o.IFrame(e,{url:"",customCss:"width: 800px; height: 430px"})),this.title=t.title,this.iframe.node.src=t.url,this.iframe}getButtons(){return[{text:s.DialogButtons.OK,role:n.DialogButtonRole.Regular}]}onBeforeClose(e){return this.iframe?.destroy(),this.iframe=void 0,!0}}},77330:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Bandits=void 0;const s=i(88023),n=i(20026),o=i(90952);t.Bandits=class{static getAllCampHexes(e){const t=[],i=o.GameState.bandits.campsByRegion.getEntryIds(e);for(let s of i){const i=o.GameState.bandits.campsByRegion.getEntryById(e,s);for(let e of i)t.push(e)}return t}static getCampsByRegion(e,t){return(0,n.selectFromState)(e,o.GameState.bandits.campsByRegion,t)||(0,s.ImmutableSet)()}static getNearestCampHex(e,t){return(0,n.selectFromState)(e,o.GameState.bandits.nearestCamp,t)?.rootId}static getNearestCampDistance(e,t){return(0,n.selectFromState)(e,o.GameState.bandits.nearestCamp,t)?.distance??Number.POSITIVE_INFINITY}static getNearestLootDistance(e,t){return(0,n.selectFromState)(e,o.GameState.bandits.nearestLoot,t)?.distance??Number.POSITIVE_INFINITY}}},77563:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapUpdater=void 0;const s=i(58547);t.WorldMapUpdater={setPawnsJumpingInRegion:s.setPawnsJumpingInRegion,setPawnJumpingInRegions:s.setPawnJumpingInRegions}},77800:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BudgetLabelsManager=void 0;const s=i(6528),n=i(56824),o=i(79573),a=i(76049),r=i(7334),l=i(87521);var c=Phaser.GameObjects.BitmapText;const d=n.logger.for("BudgetLabelsManager");class h extends s.TileAttachmentsManager{constructor(e,t){super("BudgetLabelsManager",e,t,d),this.useLargeFont=!1,this.labels=new l.Pool((()=>new c(this.renderer.scene,0,0,a.BitmapFont.MiniBold).setDepth(o.WorldLayers.TileDecals).setOrigin(.5,.5)),{onReturn:e=>{e.setVisible(!1),e.setActive(!1)}})}setLargeFont(e){this.useLargeFont!==e&&(this.useLargeFont=e,this.updateAll(((t,i,s)=>{u(t,s,e)})))}createObject(e,t){const i=this.labels.take();return i.setActive(!0),i.setVisible(!0),u(i,t,this.useLargeFont),i}updateObject(e,t,i){u(e,i,this.useLargeFont)}attachObject(e,t){t.addObject(e,0,0),e.setDepth(o.WorldLayers.TileDecals+t.hex.y)}removeObject(e,t){t.removeObject(e),e.setVisible(!1),e.setActive(!1),this.labels.free(e)}}function u(e,t,i){e.setTint(t.color),e.setFont(i?a.BitmapFont.MiniBold2x:a.BitmapFont.MiniBold);let s=`${t.treasury}${(0,r.withSign)(t.balance)}`;s.length>4&&(s=`${(0,r.withSign)(t.balance)}`),e.setText(s)}t.BudgetLabelsManager=h},77973:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handlePawnBought=async function(e,t){e.uiScene.updateFromGameState(t.worldUpdates.stateAfter),e.uiScene.updatePowerBalanceFromGameState(t.worldUpdates.stateAfter),await e.worldMapScene.play(t.worldUpdates)}},78113:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionSummaryPopup=void 0;const s=i(69302),n=i(76049),o=i(96137),a=i(86545),r=i(91622),l=i(7334),c=i(79573),d=i(80959),h=i(20087);var u=Phaser.GameObjects.BitmapText,p=Phaser.GameObjects.Image;class g extends s.SmallPergamen{constructor(e){super(e),this.summary=new m(this.scene),this.setContent(this.summary),this.setVisible(!1)}showOverRegion(e){const t=r.inject.gameStateModel.regions.byId(e);if(!t)return void this.hide();this.setVisible(!0);const i=r.inject.views.regionGeography.get(r.inject.currentGameState,e).centralTownHex;if(!i)return;this.setDepth(c.WorldLayers.UIOverlay+i.y),this.worldCoords={x:i.display.centerX,y:i.display.centerY},this.summary.updateFromRegion(t);const s=t.getEnemyAssets().getMaxAvailableMight(),n=r.inject.gameStateModel.rules.unitByMight(s);this.showAt(this.worldCoords.x,this.worldCoords.y+6,n&&`pawns/${n.type}`)}}t.RegionSummaryPopup=g;class m extends a.AutoWidthResponsiveContainer{constructor(e){super(e),this.ui=d.UiBuilder.for(this.scene),this.currentGoldText=new u(this.scene,0,0,n.BitmapFont.Mini,"0").setTint(o.Colors.glassUi_old.primaryText),this.balanceText=new u(this.scene,0,0,n.BitmapFont.Mini,"0").setTint(o.Colors.glassUi_old.primaryText),this.rightArrow=new p(this.scene,0,0,"atlas","ui/mini-icons/arrow-right").setTint(o.Colors.glassUi_old.primaryText).setScale(.5),this.predictedGoldText=new u(this.scene,0,0,n.BitmapFont.MiniBold,"0").setTint(o.Colors.glassUi_old.primaryText),this.add([this.currentGoldText,this.balanceText,this.rightArrow,this.predictedGoldText]),this.updateLayout()}setLargeFont(e){const t=e?n.BitmapFont.Mini2x:n.BitmapFont.Mini,i=e?n.BitmapFont.MiniBold2x:n.BitmapFont.MiniBold;this.currentGoldText.setFont(t),this.balanceText.setFont(t),this.predictedGoldText.setFont(i),this.updateLayout()}updateFromRegion(e){const t=e.treasury,{balance:i,upkeep:s}=e.budget,n=i>=0?o.Colors.glassUi_old.primaryText:o.Colors.woodenUi.redText;this.currentGoldText.setText(t.toFixed(0)),this.balanceText.setText((0,l.withSign)(i));const a=t+i;this.rightArrow.setTint(n),this.predictedGoldText.setText(a.toFixed(0)).setTint(n),this.updateLayout()}updateLayout(){h.Arrange.leftToRight({content:[this.currentGoldText,this.balanceText,this.rightArrow,this.predictedGoldText],spacing:2,x:0,origin:0}),this.height=this.currentGoldText.height;const e=this.currentGoldText.font===n.BitmapFont.Mini2x?1:0;h.Arrange.alignY({content:[this.rightArrow],y:this.height/2+e,origin:.5}),this.updateSize()}calculateWidth(){return this.predictedGoldText.x+this.predictedGoldText.width}}},78282:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildUrlHash=void 0,t.updateUrlHash=function(e){window.location.hash!==e&&(h=!0,window.location.hash=e)},t.clearUrlHash=function(){history.pushState(null,""," ")},t.instrumentBrowserHistory=function(){if(window.addEventListener("hashchange",(()=>{window.location.hash&&!h?u():h=!1})),r.app.device.isMobile()){function e(){history.pushState(null,"",window.location.href)}e(),window.addEventListener("popstate",(function(t){if(!r.app.navigator.transitionInProgress)if(r.app.navigator.currentScreen===r.app.screen.title)confirm("Exit the game?")?history.back():e();else{e();try{r.app.audio.playEffect(o.SoundEffects.ButtonDown)}catch{}s.events.trigger(n.UserActions.Escape())}}),!1)}},t.parseUrlHash=u,t.createUrl=function(e){return"https://"+window.location.host+window.location.pathname+"#"+e};const s=i(56824),n=i(36868),o=i(98963),a=i(91622),r=i(54825),l=i(25342),c=i(66143),d=i(97849);s.logger.for("browserHistory");let h=!1;async function u(){const e=window.location.hash?.slice(1),t=e.split("/");switch("portable"===t[0]&&t.shift(),t[0]){case"conquest":const e=t[1];try{if(a.inject.levelSession.active&&a.inject.levelSession.end({origin:"deep-link",wipeAutoSave:!1}),!l.RandomMapHash.isValid(e))throw new Error("invalid hash");const t=l.RandomMapHash.parse(e);return await r.app.navigator.goTo(r.app.screen.randomMapSelect,{preset:t}),a.inject.userData.rememberChoice("randomMapOptions",t),r.app.scene.randomMapSelect.startGenerating("down"),!0}catch(e){return console.error(e),r.app.notifications.warning("Failed to load conquest map","The map link provided in the URL is incorrect or not valid for this version of the game, sorry!"),!1}case"campaign":const i=t[1],o=c.LevelModel.for(i);try{if(a.inject.levelSession.active&&a.inject.levelSession.end({origin:"deep-link",wipeAutoSave:!1}),"expedition"!==o.category)throw new Error("not a campaign level");const e=o.expeditionContext;return d.assert.defined(e),a.inject.ui.selectedLevelId.set(o.id),await r.app.navigator.goTo(r.app.screen.overworld,{expeditionId:e.expedition.id}),!0}catch{return r.app.notifications.warning("Failed to load campaign map","The campaign map link provided in the URL is outdated or invalid, sorry!"),!1}case"quickload":return!!s.config.debug.cheats&&(s.events.trigger(n.UserActions.InternalLoadGame("1")),!0)}return!1}t.buildUrlHash={campaign:e=>"campaign/"+e,conquest:e=>"conquest/"+e}},78349:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LocalStorage=t.InMemoryStorage=t.STORAGE_KEYS=t.USER_DATA_VERSION=void 0,t.getSizeByKey=function(e){return e.entries().map((([e,t])=>[e,(0,n.sizeOf)(t)])).sort((([e,t],[i,s])=>s-t))};const n=i(7334),o=s(i(81401));t.USER_DATA_VERSION=3,t.STORAGE_KEYS={CURRENT_USER:"konkr.userId",DEFAULT_USER:"konkr.defaultUserId",SIGN_IN_EMAIL:"konkr.signInEmail",USER_DATA_PREFIX:`konkr.userData.v${t.USER_DATA_VERSION}.beta.`,LEVEL_SESSION_END_EVENT:"konkr.levelSessionEndEvent.v1",IN_PROGRESS_LEVEL:"konkr.inProgressLevel.v1"},t.InMemoryStorage=class{constructor(){this.data={}}getItem(e){return this.data[e]??null}setItem(e,t){this.data[e]=t}setObject(e,t){this.data[e]=(0,o.default)(t)}getObject(e){return this.data[e]?JSON.parse(this.data[e]):null}removeItem(e){delete this.data[e]}entries(){return Object.entries(this.data)}clear(){this.data={}}getSizeInBytes(){return new Blob(Object.values(this.data)).size}},t.LocalStorage=class{constructor(){this._objectCache={}}getItem(e){return window.localStorage.getItem(e)}setItem(e,t){delete this._objectCache[e],window.localStorage.setItem(e,t)}setObject(e,t){this._objectCache[e]=t,window.localStorage.setItem(e,(0,o.default)(t))}getObject(e){if(this._objectCache[e])return this._objectCache[e];const t=window.localStorage.getItem(e);if(!t)return null;try{const i=JSON.parse(t);return this._objectCache[e]=i,i}catch(t){return console.error(`Failed to parse object from localStorage: ${e}`),null}}removeItem(e){window.localStorage.removeItem(e),delete this._objectCache[e]}entries(){return Object.entries(window.localStorage)}getSizeInBytes(){return(0,n.sizeOf)(Object.values(window.localStorage))}}},78436:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.regionBasedAdapter=function(e){return{getHexes:e=>s.HexGroup.union(n.Regions.model(e).all().map((t=>s.HexGroup.fromIds(o.Economy.getTownHexesByRegion(e,t.id).concat(a.Bandits.getCampsByRegion(e,t.id)).toArray())))),getValue(t,i){const s=n.Regions.getByHex(t,i);if(void 0!==s)return e.getValue(t,s)},getDetail(t,i){const s=n.Regions.getByHex(t,i);if(void 0!==s)return e.getDetail(t,s)}}};const s=i(20693),n=i(56038),o=i(61634),a=i(77330)},78614:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverworldFooterControlsCompact=t.LAYOUT=void 0;const s=i(58609),n=i(80959),o=i(7782),a=i(76049),r=i(20087),l=i(96137),c=i(56824),d=i(85311),h=i(61116),u=i(46973),p=i(36014),g=i(96604);t.LAYOUT={footerHeight:100,transitionDuration:200},t.OverworldFooterControlsCompact=class{constructor(e,i){this.scene=e;const r=n.UiBuilder.for(e);this.primaryButton=r.wood.compactButton({icon:"ui/compact/icon-swords",orientation:"right",onClicked:this.handlePrimaryButtonClicked.bind(this)}),this.primaryButtonVisibility=new o.TransitionController(e,{duration:200,ease:"Sine.easeInOut",applyValue:e=>{this.primaryButton.setPosition(this.scene.bounds.width-this.primaryButton.width,this.scene.bounds.height-this.primaryButton.height*e)}}),this.flatButton=new u.RoundedRectButton(e,{content:new g.IconAndText(e,{text:r.text("?",a.BitmapFont.Main,l.Colors.glassUi_old.shapeLightAccent),icon:r.image("ui/button-icons/search",l.Colors.glassUi_old.shapeLightAccent),tintIcon:!0,spacing:8,layout:g.BUTTON_LAYOUT.iconLeft}),width:180,onClicked:this.handlePrimaryButtonClicked.bind(this),height:46,theme:u.RoundedRectButton.Themes.white}),this.flatButtonVisibilty=o.Control.propOf(this.flatButton,"alpha",{duration:t.LAYOUT.transitionDuration}),this.difficultyToggle=new s.DifficultyToggle(e,{theme:p.ToggleThemes.oceanDark,height:42}),this.difficultyControlsVisibility=new o.TransitionController(e,{duration:100,ease:"Sine.easeInOut",initialValue:0,applyValue:e=>{this.difficultyToggle.setAlpha(e)}}),this.inBattleOverlay=new d.InBattleOverlay(e).setSize(460,68),this.inBattleOverlayVisibility=new o.TransitionController(e,{ease:"Sine.easeInOut",initialValue:0,duration:t.LAYOUT.transitionDuration,applyValue:e=>{this.inBattleOverlay.y=this.scene.bounds.height-(5+this.inBattleOverlay.height)*e}}),this.updateState(i),this.bottomAnchoredObjects=[this.inBattleOverlay,this.difficultyToggle,this.primaryButton,this.flatButton],this.layer=new h.ResponsiveLayer(this.scene,this.bottomAnchoredObjects),this.scene.add.existing(this.layer)}handlePrimaryButtonClicked(){this.onPrimaryButtonClick()}updateLayout(){this.primaryButton.x=this.scene.bounds.contentRight-this.primaryButton.width,r.Arrange.alignY({content:[this.primaryButton],y:this.scene.bounds.height,origin:1});const e=this.scene.bounds.contentWidth-(72+this.primaryButton.width+8);this.inBattleOverlay.setSize(e,60),this.inBattleOverlay.setPosition(76,this.scene.bounds.height-this.inBattleOverlay.height-4+1),this.difficultyToggle.setSize(e,60),this.difficultyToggle.setPosition(76,this.scene.bounds.height-this.difficultyToggle.height-4+1),this.flatButton.setPosition(this.scene.bounds.width/2-this.flatButton.width/2,this.scene.bounds.height-this.primaryButton.height/2-this.flatButton.height/2),this.updateState(this.currentState,"instant")}transitionOut(e=c.config.screenTransitionDuration,t=void 0){this.updateLayout(),this.scene.tweens.add({targets:this.bottomAnchoredObjects,y:"+=160",duration:e,ease:"Sine.easeIn"})}transitionIn(e=c.config.screenTransitionDuration){this.updateLayout(),this.scene.tweens.add({targets:this.bottomAnchoredObjects,props:{y:{getStart:e=>e.y+160,getEnd:e=>e.y}},duration:e,ease:"Sine.easeIn"})}updateState(e,t="transition"){switch(this.currentState=e,this.onPrimaryButtonClick=e.primaryButton?.onClick??(()=>{}),e.footerLayout.mode){case"no-level-selected":this.flatButton.content.setText(e.primaryButton?.title),this.flatButtonVisibilty.setTo(null===e.primaryButton?0:1,t),this.primaryButtonVisibility.setTo(0,t),this.difficultyControlsVisibility.setTo(0,t),this.inBattleOverlayVisibility.setTo(0,t);break;case"unlocked-level-selected":this.flatButtonVisibilty.setTo(0,t),this.primaryButtonVisibility.setTo(1,t),this.difficultyControlsVisibility.setTo(e.footerLayout.canSelectDifficulty?1:0,t),this.inBattleOverlayVisibility.setTo(0,t);break;case"in-battle":this.flatButtonVisibilty.setTo(0,t),this.primaryButtonVisibility.setTo(1,t),this.difficultyControlsVisibility.setTo(0,t),this.inBattleOverlayVisibility.setTo(1,t),this.inBattleOverlay.subTitle.setText(e.footerLayout.subtitle)}}activate(e){this.updateState(e,"instant"),this.updateLayout(),this.layer.setVisible(!0)}deactivate(){this.layer.setVisible(!1)}}},78635:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Warfare=t.InvalidDropPawnReason=t.DropPawnResultType=void 0;const s=i(63521),n=i(90952),o=i(20026),a=i(19162),r=i(56038),l=i(81434),c=i(1326),d=i(30310),h=i(45664),u=i(19618),p=i(61634),g=i(27109),m=i(9292);var y,f;!function(e){e.Invalid="invalid",e.Reposition="reposition",e.Conquest="conquest",e.Combine="combine",e.EradicatePest="eradicate-pest",e.PlaceOnForeignLand="place-on-foreign-land"}(y||(t.DropPawnResultType=y={})),function(e){e.PreventedByPawn="prevented-by-pawn",e.UnsuitableTerrain="unsuitable-terrain",e.OutOfRange="out-of-range",e.InvalidRegion="invalid-region"}(f||(t.InvalidDropPawnReason=f={}));class w{static model(e){return this.models.get(e)}static getConquerableHexes(e,t,i,n){void 0===n&&(n=i);const o=l.Pawns.getByRegion(e,t).filter((t=>l.Pawns.model(e).byId(t)?.hasTrait(s.PawnTraits.Pest))).map((t=>(0,h.getHex)(l.Pawns.getPawnHex(e,t)))).filter((t=>n>0||!l.Pawns.isTraitPresentOnHex(e,t.id,s.PawnTraits.PreventsHeavyUnits)));return r.Regions.getAdjacentForeignHexes(e,t).filter((t=>l.Pawns.isTraitPresentOnHex(e,t.id,s.PawnTraits.PreventsHeavyUnits)?this.getHexDefense(e,t)<n:this.getHexDefense(e,t)<i)).with(o)}static getHexDefense(e,t){return(0,o.selectFromState)(e,n.GameState.warfare.hexDefense,t.id)||0}static getHexDefenseWithoutMovableUnits(e,t){return this.getHexDefense(e,t)}static getHexStaticDefense(e,t){return(0,o.selectFromState)(e,n.GameState.warfare.hexStaticDefense,t)||0}static getHexDefenseAfterCapturedBy(e,t,i,s=0){return t.neighbours((t=>u.Factions.getByHex(e,t.id)===i)).map((t=>this.getHexProjectedDefense(e,t.id))).reduce(m.pickLarger,s)}static getHexLocalDefense(e,t){return(0,o.selectFromState)(e,n.GameState.warfare.hexDefenseSources,t)?.totalDefense||0}static getHexLocalStaticDefense(e,t){return(0,o.selectFromState)(e,n.GameState.warfare.hexDefenseSources,t)?.buildingDefense||0}static canBeProtectedByWalls(e,t){return!l.Pawns.isTraitPresentOnHex(e,t,s.PawnTraits.PreventsWalls)}static getHexProjectedDefense(e,t){const i=(0,o.selectFromState)(e,n.GameState.warfare.hexDefenseSources,t);return i?i.totalProtection:0}static getHexProjectedUnitDefense(e,t){const i=(0,o.selectFromState)(e,n.GameState.warfare.hexDefenseSources,t);return i?i.unitProtection:0}static getHexProjectedStaticDefense(e,t){const i=(0,o.selectFromState)(e,n.GameState.warfare.hexDefenseSources,t);return i?i.buildingProtection:0}static getHexDefenders(e,t,i=1){const n=l.Pawns.model(e),o=r.Regions.getSameRegionNeighbours(e,t);return[...n.byHex(t),...n.select({hexes:o,traits:[s.PawnTraits.GuardsAdjacentTiles]})].filter((e=>e.might>=i))}static canConquerHexWith(e,t,i){const s="number"==typeof i?i:a.Rules.model(e).pawns(i).might;return void 0!==r.Regions.getByHex(e,t.id)&&this.getHexDefense(e,t)<s}static canBuildAt(e,t){return void 0===w.getOccupyingPawn(e,t)&&!l.Pawns.model(e).traitPresentAtHex(t,s.PawnTraits.PreventsBuilding)}static canBuildCastleAt(e,t,i){if(!w.canBuildAt(e,t))return!1;const s=p.Economy.getTreasuryOf(e,i)>=20,n=r.Regions.getByHex(e,t.id)===i;return s&&n}static getRegionFortification(e,t){return(0,o.selectFromState)(e,n.GameState.warfare.fortificationByRegion,t)??0}static getOccupyingPawn(e,t){return l.Pawns.model(e).findOne({hexes:t,traits:[s.PawnTraits.OccupiesTile]})}static getUnitsByRegion(e,...t){return(0,c.mergeArrays)(...t.map((t=>l.Pawns.getByRegion(e,t).filter((t=>w.isUnit(e,t)))||[])))}static getPotentialLoot(e,t,i=!0){const s=w.getOccupyingPawn(e,t);return(s?.rules.loot??0)+(i?p.Economy.model(e).numberOfCoinsAt(t):0)}static isUnit(e,t){return l.Pawns.model(e).byId(t)?.hasTrait(s.PawnTraits.Unit)}}t.Warfare=w,w.models=new g.ModelsCache((e=>new d.WarfareModel(e)))},78645:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PowerBalanceView=void 0;const s=i(20754),n=i(90952),o=i(19618),a=(i(56824).logger.for("PowerBalanceView"),Object.freeze({dominance:0,factionsByPower:[],totalPower:0,dominantFaction:null,is1v1situation:!1}));class r extends s.LazyView{constructor(){super([n.GameState.ai.powerByRegion,n.GameState.ai.credit])}calculate(e){const t=o.Factions.model(e).all().filter((e=>e.isAlive()&&!e.isNeutral())).sort(((e,t)=>t.scaledPower-e.scaledPower)),i=t.reduce(((e,t)=>e+t.scaledPower),0),s=t[0];if(!s)return a;const n=t[0].scaledPower,r=t[1]?.scaledPower??0;return{totalPower:i,dominantFaction:s,dominance:Math.floor(100*(s.scaledPower/r-1)),is1v1situation:(n+r)/i>.75,factionsByPower:t}}getCacheKey(){return""}}t.PowerBalanceView=r},78933:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldUpdateBuilder=t.UpdateType=void 0;const s=i(24598),n=i(81434),o=i(97849),a=i(45664),r=i(48042),l=i(70712),c=i(56038),d=i(61510),h=i(45084),u=i(61634),p=i(91622),g=i(1326),m=i(52307);var y;i(56824).logger.for("WorldUpdateBuilder"),function(e){e.FactionTurnStarted="new-turn-begins",e.FactionTurnOver="faction-turn-over",e.PawnsMoved="pawn-moved",e.PawnsDestroyed="pawns-destroyed",e.PawnReplaced="pawn-replaced",e.PawnSpawned="pawn-spawned",e.ManaCollected="mana-collected",e.ManaChanged="mana-changed",e.HexTakeover="hex-takeover",e.CoinTransaction="coin-transaction"}(y||(t.UpdateType=y={}));class f{constructor(e){this.model=e,this.updateList=[],this.affectedRegions=new Set,this.coinTransaction=void 0,this.stateBefore=e.state,this.nextPawnId=n.Pawns.getNextId(this.stateBefore)}getNextPawnId(){let e=this.nextPawnId;const t=n.Pawns.getNextId(this.model.state);return t>e&&(e=t),this.nextPawnId=e+1,e}create(e){const t=this.getNextPawnId();n.Pawns.create(this.model.state,{...e,id:t});const i=e.regionId??c.Regions.getByHex(this.model.state,e.sourceHex?.id??e.hex.id);return this.affectedRegions.add(i),this.move({pawnId:t,created:{pawnType:e.type,hex:e.sourceHex?.id??e.hex.id,regionId:i},destHex:e.hex,defeatedUnit:e.defeatedUnit,mergeData:e.mergeData,captureHex:e.captureHex,tapUnit:e.tapUnit})}spawn(e,t){const i=this.getNextPawnId();n.Pawns.create(this.model.state,{id:i,type:t,hex:e}),this.updateList.push({type:y.PawnSpawned,hexId:e.id,pawnType:t,pawnId:i})}getUpdates(){return this.model.stateEngine.commitTransaction(),this.coinTransaction&&(this.updateList.push({type:y.CoinTransaction,coinTransaction:this.coinTransaction}),this.coinTransaction=void 0),{stateAfter:this.model.state,stateBefore:this.stateBefore,updates:this.updateList,affectedRegions:Array.from(this.affectedRegions)}}replace(e,t){const i=e.id,s=e.type,o=e.hex.id;this.affectedRegions.add(e.region.id);const a=this.getNextPawnId();n.Pawns.replacePawn(this.model.state,e.id,t,a);const r={type:y.PawnReplaced,hexId:o,oldPawnId:i,newPawnId:a,newType:t,oldType:s};return this.updateList.push(r),r}destroy(...e){e.forEach((e=>{this.affectedRegions.add(e.region.id),this.updateList.push({type:y.PawnsDestroyed,pawnId:e.id})})),n.Pawns.destroy(this.model.state,...e.map((e=>e.id)))}takeOverHex(e,t){const i=this.buildTakeOverHexUpdate(e,t);return this.updateList.push(i),i.affectedRegions.forEach((e=>this.affectedRegions.add(e))),i}buildTakeOverHexUpdate(e,t){let i,s;t instanceof r.RegionModel?(i=t.faction,s=t):(i=t,s=void 0);const n=i.takeOverHex(e,s);return o.assert.defined(n),n}move(e){const{pawnId:t,destHex:i,defeatedUnit:r,mergeData:w,created:v,captureHex:b,tapUnit:S,replace:x}=e;let T=this.model.pawns.byId(t),P=t;const I=new d.CoinTransactionBuilder,C=v?.regionId?this.model.regions.byId(v.regionId):T?.region,M=this.model.regions.byHex(i),A=M?.isAlive(),B=this.model.state,E=T?.type;o.assert.defined(C),this.affectedRegions.add(C.id);let O,R,k=S;b&&C!==this.model.regions.byHex(i)&&(k=!0,O=this.buildTakeOverHexUpdate(i,C));const L=v?(0,a.getHex)(v.hex):T.hex;let _,D=0;if(r){k=!0;let e=this.model.pawns.byId(r.pawnId);if(r.retreatHex)e.moveTo((0,a.getHex)(r.retreatHex));else if(_=e.type,D=e.rules.loot??0,e.destroy(),[s.PawnType.Zombie,s.PawnType.LadderZombie].includes(_)&&(0,m.isUndeadTerritory)(B,i)){const e=p.inject.views.undeadTowns.get(this.model.state).filter((e=>this.model.pawns.getCount(e,s.PawnType.Mana)<6));if(e.length>0){const t=(0,g.findMin)(e.members,(e=>e.getDistanceTo(i)));this.collectMana(i,t)}}}const H=this.model.pawns.byType(i,s.PawnType.Mana)[0];if(H&&this.model.pawns.destroy(H),this.model.pawns.presentAtHex(i,s.PawnType.Mana)&&this.model.pawns.destroy(),w){const e=this.model.pawns.byId(w.mergedWith);o.assert.defined(e),e.hex;const i=!e.isMovable();P=this.getNextPawnId(),n.Pawns.destroy(this.model.state,t),n.Pawns.replacePawn(this.model.state,e.id,w.outputType,P),R={...w,newPawnId:P},i&&(k=!0)}else x?(P=this.getNextPawnId(),n.Pawns.destroy(this.model.state,t),n.Pawns.create(this.model.state,{hex:i,type:x,id:P})):n.Pawns.movePawn(this.model.state,t,i.id);const j=new f(this.model);if(u.Economy.loot({state:this.model.state,looter:E??v?.pawnType,looterRegion:C,fromHex:i,spawn:D,coinTransactionBuilder:I,worldUpdateBuilder:j}),k&&h.CurrentPhase.tapPawn(this.model.state,P),O){O.affectedRegions.forEach((e=>this.affectedRegions.add(e))),l.AI.setHexHistory(this.model.state,i.id,{capturedAt:this.model.currentPhase.turnNumber,spoils:_||(A?"liveHex":"deadHex"),previousFactionId:M?.faction?.id??0});const e=O.connectedHexes.filter((e=>!c.Regions.model(this.model.state).byHex(e)?.isAlive()));for(let t of e)l.AI.setHexHistory(this.model.state,t,{capturedAt:this.model.currentPhase.turnNumber,spoils:"deadHex",previousFactionId:C.faction?.id??0})}const F={type:y.PawnsMoved,pawns:[{pawnId:t,srcHex:L.id,created:v}],destHex:i.id,defeatedUnit:r,hexCaptured:O,merged:R,replaced:x?{oldType:E,newType:x,newPawnId:P}:void 0,loot:I.getTotalLoot()};this.updateList.push(F);const U=j.getUpdates();return U.updates.length&&this.updateList.push(...U.updates),I.isEmpty()||(I.apply(this.model.state),this.updateList.push({type:y.CoinTransaction,coinTransaction:I.getTransactions()})),F}addCoinTransaction(e){this.coinTransaction?this.coinTransaction=(0,d.mergeTransactions)(e,this.coinTransaction):this.coinTransaction=e}collectMana(e,t){this.model.stateEngine.commitTransaction(),6!==this.model.pawns.getCount(t,s.PawnType.Mana)&&(this.model.pawns.adjustCount(t,s.PawnType.Mana,1),this.updateList.push({type:y.ManaCollected,scrHex:e.id,destHex:t.id}))}adjustMana(e,t){this.model.pawns.adjustCount(e,s.PawnType.Mana,t),this.updateList.push({type:y.ManaChanged,hex:e.id,newAmount:this.model.pawns.getCount(e,s.PawnType.Mana)})}}t.WorldUpdateBuilder=f},79090:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bgrSwap=t.TileObjectsManager=void 0;const s=i(56824),n=i(23449),o=s.logger.for("TilesManager");t.TileObjectsManager=class{constructor(e,t){this.scene=e,this.renderer=t,this.tilesByHexId={}}setTile(e,t){this.createOrUpdateTile(e,t)}syncWithModel(e,t,i=!1){i&&Object.entries(this.tilesByHexId).filter((([e,i])=>i.active&&!t.hasId(Number(e)))).forEach((([e,t])=>t.deactivate()));for(const i of t){const t=e.factions.byHex(i);t&&this.setTile(i,t)}}getByHex(e){return this.tilesByHexId[e]}addObjectToTile(e,t,i=0,s=0){const n=this.tilesByHexId[e];n?n.addObject(t,i,s):o.error(`Unable to place ${t} on hex ${e}, hex not present in the current rendering. Ignoring.`)}getAll(){return Object.values(this.tilesByHexId).filter((e=>e.active))}clear(){Object.values(this.tilesByHexId).forEach((e=>e.deactivate()))}createOrUpdateTile(e,t){let i=this.tilesByHexId[e.id];return i?i.activate(t):(i=new n.Tile(this.renderer,e),this.tilesByHexId[e.id]=i),i}},t.bgrSwap=e=>{const[t,i,s]=e.toString(16).padStart(6,"0").match(/[\w]{2}/g);return parseInt([s,i,t].join(""),16)}},79349:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HeaderMenuPanel=void 0;const s=i(36868),n=i(86545),o=i(80959),a=i(85711),r=i(20087),l=i(56824),c=i(87047),d=i(9185),h=i(79899),u=i(55275),p=i(49527),g=i(76049),m=4,y=8,f=8,w=16,v=30,b=8;class S extends n.AutoWidthResponsiveContainer{constructor(e){super(e),this.ui=o.UiBuilder.for(this.scene),this.background=new p.StealthButton_LEGACY(this.scene,{colors:e=>({background:{color:e.oceanColor,alpha:.85},highlight:{color:e.oceanShades.light1,alpha:.85},content:0}),onClicked:()=>l.events.trigger(s.UserActions.TogglePlayMenu()),radius:8}),this.leaveButton=new h.ImageButton(this.scene,0,0,{frame:"expedition-icons/conquest",scale:.75,onClicked(){l.events.trigger(s.UserActions.ExitLevel())}}),this.props=(0,u.stateContainer)({features:[],icon:"expedition-icons/conquest",name:"Unknown Island",difficulty:"hard",isFixedDifficulty:!0},((e,{name:t,difficulty:i,isFixedDifficulty:s,features:n,icon:o})=>{this.levelNameRef.set(t);let a=[...n];s||a.unshift("hard"===i?d.DIFFICULTY_HARD:d.DIFFICULTY_NORMAL),this.featuresGallery.updateState(a),this.leaveButton.setConfig({frame:o}),this.preUpdate.makeDirty()})),this.levelNameRef=(0,a.ref)("Unknown Island"),this.levelNameLabel=this.ui.vectorText(this.levelNameRef,g.VectorFont.Cinzel16),this.featuresGallery=new c.LevelFeaturesGallery(this.scene,{interactive:!1}),this.height=.75*v+m+y,this.add([this.background,this.leaveButton,this.levelNameLabel,this.featuresGallery])}calculateWidth(){return this.background.width}updateLayout(){this.featuresGallery.setVisible(!this.featuresGallery.isEmpty()),r.Arrange.leftToRight({content:[this.leaveButton,this.levelNameLabel,this.featuresGallery],x:w,origin:0,spacing:b}),r.Arrange.alignY({content:[this.leaveButton,this.levelNameLabel],y:m+this.leaveButton.height/2*.75,origin:.5}),this.featuresGallery.y=30;const e=this.featuresGallery.isEmpty()?this.levelNameLabel:this.featuresGallery,t=e.x+e.width+f;this.background.setPosition(0,this.leaveButton.y+4),this.background.setSize(t,.75*this.leaveButton.height-8),this.updateSize()}}t.HeaderMenuPanel=S},79428:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImportMapDialog=void 0;const s=i(5365),n=i(63032),o=i(29821),a=i(2543),r=i(54118),l=i(7169),c=i(9292);t.ImportMapDialog=class{constructor(){this.onLoad=a.noop}getTitle(){return"Load Game"}getContent(e,t,i){const s=(0,c.pickSmaller)(400,i.width),n=(0,c.pickSmaller)(200,i.height);return t.onLoad&&(this.onLoad=t.onLoad),this.textArea||(this.textArea=new l.TextArea(e,{autoSelectAll:!0}),this.layout=new r.VLayout(e,{content:[new o.Label(e,"Paste your map data in the text area below:"),this.textArea],spacing:16,width:s})),this.textArea.setText(""),this.textArea.setSize(s,n),this.layout.preUpdate.force(),this.layout}getButtons(){return[{text:s.DialogButtons.Cancel,role:n.DialogButtonRole.Regular},{text:s.DialogButtons.Load,role:n.DialogButtonRole.PrimaryDanger}]}onBeforeClose(e){return e===s.DialogButtons.Load&&this.onLoad(this.textArea.text.trim()),!0}}},79465:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getTurnDelta=n,t.getLivesAdjustmentAfterRewind=function(e,t){const i=n(e,t);return 1===s.CurrentPhase.getTurnNumber(t)?"refill":i>0?"burn-one":"none"};const s=i(45084);function n(e,t){let i=s.CurrentPhase.getTurnNumber(e);const n=s.CurrentPhase.getTurnNumber(t);return!s.CurrentPhase.model(e).faction?.isLocalPlayer()&&(i+=1),i-n}},79573:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.WorldLayers=void 0,function(e){e[e.Ocean=-1e3]="Ocean",e[e.Landmass=0]="Landmass",e[e.Tiles=1e4]="Tiles",e[e.TileHighlight=2e4]="TileHighlight",e[e.ConquerableHexesHighlight=3e4]="ConquerableHexesHighlight",e[e.TileDecals=4e4]="TileDecals",e[e.TileObjects=5e4]="TileObjects",e[e.FlyingObject=6e4]="FlyingObject",e[e.UIOverlay=7e4]="UIOverlay",e[e.DebugOverlay=8e4]="DebugOverlay"}(i||(t.WorldLayers=i={}))},79589:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelSummaryPanel=void 0;const s=i(80959),n=i(86545),o=i(36868),a=i(91622),r=i(49527),l=i(20087),c=i(2426),d=i(56824);class h extends n.BaseResponsiveContainer{constructor(e){super(e),this.ui=s.UiBuilder.for(this.scene),this.background=new c.RoundedRect(this.scene,{radius:8}),this.rewindButton=function(e){const t=new n.ResponsiveContainer(e.scene).setSize(80,28),i=e.image("ui/button-icons/rewind");t.add(i),i.setPosition(8,t.height/2).setOrigin(0,.5),a.inject.theme.use((e=>{i.setTint(e.oceanContrastDark)}));const s=new r.StealthButton_LEGACY(e.scene,{radius:4,content:t,audio:!1,width:80,height:28});return s.onClicked((()=>{d.events.trigger(o.UserActions.StartRewind())})),s}(this.ui),this.restartButton=u(this.ui,"ui/button-icons/restart",(()=>o.UserActions.RestartLevel({}))),this.replayButton=u(this.ui,"ui/button-icons/replay",(()=>o.UserActions.ViewReplay())),a.inject.theme.use((e=>{this.background.setFillStyle(e.oceanColor,.75)})),this.add([this.background,this.replayButton,this.restartButton,this.rewindButton]),this.updateLayout()}updateLayout(){l.Arrange.leftToRight({content:[this.replayButton,this.restartButton,this.rewindButton],spacing:0,x:4,origin:0}),l.Arrange.alignY({content:[this.restartButton,this.rewindButton,this.replayButton],origin:.5,y:this.height/2}),this.background.setSize(this.width,this.height)}}function u(e,t,i){const s=e.image(t),n=new r.StealthButton_LEGACY(e.scene,{radius:4,content:s,width:28,height:28});return n.onClicked((()=>d.events.trigger(i()))),n}t.LevelSummaryPanel=h},79611:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DUMMY_RENDER_PROPS=void 0,t.getPawnRenderRecipe=function(e){return o[e]??t.DUMMY_RENDER_PROPS};const s=i(24598);function n(e,t={}){return{rendersAsPawnObject:!0,hasShadow:!0,getFrame:()=>e,getShadowFrame:()=>"pawn-shadow",scale:.5,depthAdjustment:0,...t}}t.DUMMY_RENDER_PROPS={rendersAsPawnObject:!1,hasShadow:!1,getFrame:()=>"",scale:0,getShadowFrame:()=>"",depthAdjustment:0};const o={[s.PawnType.Bandit]:n("pawns/bandit"),[s.PawnType.Bunny]:n("pawns/rabbit"),[s.PawnType.Camp]:n("pawns/camp"),[s.PawnType.Castle]:n("pawns/castle"),[s.PawnType.Chest]:n("pawns/chest"),[s.PawnType.Present]:function(e,t={}){return n(e,{getShadowFrame:()=>`${e}-shadow`,...t})}("pawns/present"),[s.PawnType.Town]:n("pawns/town",{getFrame:(e=1)=>`pawns/town-${e}`,getShadowFrame:(e=1)=>`pawns/town-${e}-shadow`}),[s.PawnType.HauntedTown]:{...n("pawns/haunted-town"),getShadowFrame:()=>"pawns/town-2-shadow"},[s.PawnType.TownRuins]:n("pawns/town-ruins",{hasShadow:!1,depthAdjustment:-10,getFrame:e=>"pawns/town-ruins"+(e?`-${e}`:"")}),[s.PawnType.Villager]:n("pawns/villager"),[s.PawnType.GoldMine]:n("pawns/gold-mine",{hasShadow:!1,depthAdjustment:-10}),[s.PawnType.Forest]:n("pawns/forest"),[s.PawnType.Zombie]:n("pawns/zombie"),[s.PawnType.LadderZombie]:n("pawns/ladder-zombie"),[s.PawnType.DreadKnight]:n("pawns/dread-knight"),[s.PawnType.Pikeman]:n("pawns/pikeman"),[s.PawnType.Knight]:n("pawns/knight"),[s.PawnType.Hero]:n("pawns/hero"),[s.PawnType.UniqueHero]:n("pawns/unique-hero",{getFrame:e=>"string"==typeof e&&e.toLowerCase().includes("rosaline")?"pawns/unique-hero-rosaline":"pawns/unique-hero"}),[s.PawnType.Spawner]:n("pawns/spawner"),[s.PawnType.Refuge]:n("pawns/refuge")}},79694:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayMode=void 0;const s=i(64244),n=i(41569),o=i(1574),a=i(98963),r=i(36868),l=i(24598),c=i(97849),d=i(56824),h=i(97869),u=i(50105),p=i(90048),g=i(91622),m=i(54825),y=i(40951),f=i(12933),w=i(30484),v=i(78635),b=i(5116),S=i(19748),x=i(19693),T=i(63521),P=d.logger.for("PlayMode");class I extends n.BaseMode{constructor(){super(...arguments),this.name="Play",this.autoAttackUnit=void 0,this.currentDefaultCursor="default"}activate(){if(!g.inject.gameStateModel.currentPhase.isLocalPlayerTurn())throw d.errors.tamperingDetected=!0,new Error("PlayMode activated while it is not the local player turn");g.inject.ui.transitionsSpeed.set(y.TransitionsSpeed.Fast),m.app.scene.worldMap.overlays.set(g.inject.currentGameState,w.OverlayModes.playing({selectedRegionId:m.app.screen.play.selectedRegion?.id})),m.app.scene.playUI.updateFromGameState(g.inject.currentGameState,"play"),d.config.debug.overlay}canPickupPawn(e){return!!this.getMovablePawnAtHex(e)||!!this.getRichTownAtHex(e)}canEndTurn(){return!0}getRichTownAtHex(e){const t=g.inject.gameStateModel.regions.byHex(e);if(t&&t===m.app.screen.play.selectedRegion&&t.faction===g.inject.gameStateModel.currentPhase.faction&&!((t.treasury||0)<p.CHEAPEST_UNIT_COST))return!!g.inject.gameStateModel.pawns.byHex(e,l.PawnType.Town)}handleStartInteraction(e,t){if(!e)return void m.app.scene.worldMap.cameraController.startDragScroll();const i=this.getMovablePawnAtHex(e),n=this.getRichTownAtHex(e);i?(m.app.audio.playEffect(a.SoundEffects.Grab),this.selectRegionByHex(e),m.app.scene.playUI.updateHeldPawnData({name:i.type.toString(),cost:i.cost,upkeep:i.upkeep,context:"moving"}),this.scene.setMode(new s.MovingPawnMode(this.scene,i,!!(t&r.PointerEventFlags.Touch))),d.events.trigger(r.UiEvents.PawnPickedUp({hexId:e.id,pawnType:i.type}))):n?(m.app.audio.playEffect(a.SoundEffects.Grab),this.scene.setMode(new o.BuyingPawnMode(this.scene,l.PawnType.Villager)),this.scene.uiScene.grabNewPawnFromTown(l.PawnType.Villager,e),this.selectRegionByHex(e)):m.app.scene.worldMap.cameraController.startDragScroll()}isHexInteractive(e){return!0}selectRegionByHex(e){const t=g.inject.gameStateModel,i=t.regions.byHex(e),s=m.app.screen.play.selectedRegion,n=e&&m.app.scene.worldMap.overlays.conquerableHexesHighlight.has(e.id);let o=!1;if(s&&n)if(this.findAutoAttacker(e),this.autoAttackUnit)m.app.audio.playEffect(a.SoundEffects.Drop),t.regions.byHex(e)===this.autoAttackUnit.region?(g.inject.gameStateController.executePlay(r.Plays.MovePawn({pawnId:this.autoAttackUnit.id,destinationHexId:e.id,tapUnit:!1})),this.clearAutoAttacker()):g.inject.gameStateController.executePlay(r.Plays.MovePawn({pawnId:this.autoAttackUnit.id,destinationHexId:e.id,tapUnit:!1})),o=!0;else if(m.app.scene.playUI.isInAutoMergeMode()){const i=this.getAutoMergePlanForConqueringHex(t,e);if(!i)return P.warning(`hex ${e} highlighted as conquerable but could not figure out any plan to conquer it`),!1;const n=new S.Marshal({game:g.inject.gameStateController,region:s,addPlay:e=>{g.inject.gameStateController.executePlay(e)}});m.app.audio.playEffect(a.SoundEffects.Drop),n.moveUnit(e,i)}else P.warning(`hex ${e} highlighted as conquerable but could not find any suitable attacker unit`);else i?.isControllable()?i!==s&&(m.app.screen.play.selectRegion(i?.id),o=!0):i?.isAlive()?m.app.screen.play.selectedRegion!==i&&(m.app.screen.play.selectRegion(i?.id),o=!0):m.app.screen.play.selectedRegion&&m.app.screen.play.selectRegion(void 0);return o}handleCompleteInteraction(e){e&&(m.app.scene.worldMap.cameraController.stopDragScroll(),this.selectRegionByHex(e)?m.app.tooltips.close():m.app.tooltips.toggleHexTooltip(e))}handleStartDrag(e){m.app.scene.worldMap.cameraController.startDragScroll()}handleEndDrag(e){m.app.scene.worldMap.cameraController.stopDragScroll()}async handleHexCaptured(e){this.clearAutoAttacker(),await(0,u.handleHexCaptured)(this.scene,e,!1)}handlePawnInShopPointerDown(e){m.app.screen.play.selectedRegion?(this.scene.uiScene.grabNewPawnFromShop(e),this.scene.setMode(new o.BuyingPawnMode(this.scene,e))):P.warning("ignoring pawnInShopPointerDown event while no region is selected")}getMovablePawnAtHex(e){return g.inject.gameStateModel.pawns.byHex(e).find((e=>g.inject.gameStateModel.currentPhase.isMovable(e)))}getAutoMergePlanForConqueringHex(e,t){const i=m.app.screen.play.selectedRegion;if(!i)return;let s=e.regions.byHex(t)===i?e.warfare.getHexLocalDefense(t)+1:e.warfare.getHexDefense(t)+1;const n=!e.warfare.isSuitableTerrain(t,l.PawnType.Knight);return i.getMyAssets().useUnit({requiredMight:s,allowOverkill:!0,allowNegativeIncome:!0,bannedMightLevels:n?[3]:void 0})}handleNewHexUnderCursor(e){const t=m.app.screen.play.selectedRegion,i=e&&m.app.scene.worldMap.overlays.conquerableHexesHighlight.has(e.id);if(m.app.tooltips.close(),e&&!m.app.game.device.input.touch&&m.app.tooltips.showHexTooltip(e),m.app.game.device.input.touch)this.clearAutoAttacker();else if(e&&this.getMovablePawnAtHex(e)){const t=this.getMovablePawnAtHex(e);this.scene.worldMapScene.pawns.setHangingPawn(t.id),this.scene.input.setDefaultCursor("pointer"),this.clearAutoAttacker()}else if(t&&i){if(this.scene.input.setDefaultCursor("pointer"),this.scene.worldMapScene.pawns.clearHangingPawn(),this.findAutoAttacker(e),!this.autoAttackUnit&&m.app.scene.playUI.isInAutoMergeMode()){const t=this.getAutoMergePlanForConqueringHex(g.inject.gameStateModel,e);t&&this.scene.worldMapScene.overlays.conquerableHexesHighlight.setHighlightedHex(e,g.inject.gameStateModel.rules.unitByMight(t.might)?.type,.25)}}else{this.scene.worldMapScene.pawns.clearHangingPawn();const i=e&&g.inject.gameStateModel.regions.byHex(e);i&&i!==t&&i.isAlive()||e&&m.app.worldNews.hasNewsForHex(e)?this.updateDefaultCursor("pointer"):this.updateDefaultCursor("default"),this.clearAutoAttacker()}}updateDefaultCursor(e){this.currentDefaultCursor!==e&&(this.scene.input.setDefaultCursor(e),this.currentDefaultCursor=e)}getRequiredMightForHex(e){const t=g.inject.gameStateModel;return t.factions.byHex(e)===t.currentPhase.faction?0:t.warfare.getHexDefense(e)+1}findAutoAttacker(e){const t=m.app.screen.play.selectedRegion,i=g.inject.gameStateModel,s=this.getRequiredMightForHex(e);c.assert.defined(t);let n=t.getMovableUnitsByMight().getOneWithMightAtLeast(s);if(i.pawns.traitPresentAtHex(e,T.PawnTraits.PreventsHeavyUnits)&&3===n&&(n=4),!n)return m.app.scene.playUI.isInAutoMergeMode()||P.warning(`incorrectly thought I could conquer hex ${e} - is among conquerable hexes but i cannot gather ${s} might from ${t}`),this.clearAutoAttacker();let o=null,a=null;t.hexes.bfsFrom(e,((e,t,s)=>{if(o)return!1;const r=i.warfare.getOccupyingUnit(e);return!(r&&r.isMovable()&&r.might===n&&(s<=1||!g.inject.ui.stationaryUnits.isStationary(r.id)?(o=r,1):(a||(a=r),0)))}));const r=o||a;if(!r)return P.warning(`failed to locate unit with might ${n} in the region => RegionMight projection appears to contain invalid data! `),this.clearAutoAttacker();const l=i.warfare.getDropPawnResult(e,r.type,t).type;return l===v.DropPawnResultType.Invalid||l===v.DropPawnResultType.Combine?(P.warning(`canceled auto attacker move to hex ${e} due to unexpected drop result ${l}`),this.clearAutoAttacker()):(this.scene.worldMapScene.overlays.conquerableHexesHighlight.setHighlightedHex(e,r.type,o?1:.25,(0,x.getPawnVariant)(r.state,r)),this.scene.worldMapScene.overlays.pawnSymbols.clear(b.PawnSymbolType.Arrow),this.scene.worldMapScene.overlays.pawnSymbols.add(r.id,b.PawnSymbolType.Arrow,""),this.setAutoAttacker(r,e))}setAutoAttacker(e,t){this.autoAttackUnit=e,this.scene.worldMapScene.overlays.attitudeEmojis.setFocusedHex(t)}clearAutoAttacker(){this.autoAttackUnit=void 0,this.scene.worldMapScene.overlays.conquerableHexesHighlight.clearHighlightedHex(),this.scene.worldMapScene.overlays.pawnSymbols.clear(b.PawnSymbolType.Arrow),this.scene.worldMapScene.overlays.attitudeEmojis.setFocusedHex(void 0)}async handlePawnMoved(e){await super.handlePawnMoved(e),e.mergedWith&&m.app.scene.worldMap.overlays.update(e.worldUpdates.stateAfter)}handleEndTurn(e=!1){m.app.worldNews.clear(),m.app.tooltips.close();const t=new h.SpectatorMode(this.scene);this.scene.setMode(t),t.requestedPlays=!0,setTimeout((()=>{t.requestedPlays=!1,g.inject.gameStateController.executePlay(r.Plays.EndTurn())}),d.config.screenTransitionDuration)}doHandleEvent(e){return(0,f.doHandleEvent)(this,e)}}t.PlayMode=I},79705:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playPawnReplaced=async function(e,t,i){let s=e.pawns.getById(t.oldPawnId);s||a.error(`Unexpected state while in playPawnReplaced: old pawn #${t.oldPawnId} does not exist on the board (update: ${(0,o.str)(t)})`),e.pawns.createOrUpdatePawnObject({id:t.newPawnId,type:t.newType,jumping:s?.jumping??!1,hexId:t.hexId,visible:!0}),(0,n.redrawPalisadeIfReplacedByBuilding)(i,t.hexId,t.oldType,t.newType),s?.destroy()};const s=i(56824),n=i(34348),o=i(7334),a=s.logger.for("PawnsManager")},79712:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ToggleFavoriteButton=void 0;const s=i(46973),n=i(80374),o=i(91622),a=i(56824),r=i(36868),l=i(54825),c=i(2297),d=i(95070);class h extends s.RoundedRectButton{constructor(e){super(e.scene,{content:new d.IconOnly(e.scene,(0,n.getFavoriteButtonFrame)(!1)),onClicked:()=>{const e=o.inject.userContent.isInFavorites(this.levelId);e?a.events.trigger(r.UserActions.RemoveLevelFromFavorites(this.levelId)):a.events.trigger(r.UserActions.AddLevelToFavorites({levelId:this.levelId})),l.app.tooltips.close(),l.app.tooltips.showOver(this,{title:e?"Removed from Favorites!":"Added to Favorites!",type:c.TooltipType.Hover,icon:"ui/icons/ok",delayMs:0,expireAfterMs:1500}),this.setMode(!e)},width:30,height:30,radius:15,theme:s.RoundedRectButton.Themes.light}),this.levelId=""}setMode(e){this.content.setFrame((0,n.getFavoriteButtonFrame)(e)),this.setData("tooltip",e?"Remove from favorites":"Add to favorites")}updateContent(e){this.levelId=e,this.setMode(o.inject.userContent.isInFavorites(e))}}t.ToggleFavoriteButton=h},79772:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompletionTapestry=t.Gems=void 0;const s=i(86545),n=i(18486),o=i(66143);var a=Phaser.GameObjects.Image;class r extends n.GameObjectCollection{createGameObject(){return new a(this.scene,0,0,"atlas","ui/completion-tapestry/disabled-gem").setOrigin(.5,.5)}updateGameObject(e,{status:t,baseColor:i}){switch(e.clearTint(),t){case o.LevelStatus.Locked:e.setFrame("ui/completion-tapestry/disabled-gem"),e.setTint(i);break;case o.LevelStatus.Unlocked:e.setFrame("ui/completion-tapestry/empty-gem"),e.setTint(i);break;case o.LevelStatus.GoldMedal:e.setFrame("ui/completion-tapestry/gold-gem");break;case o.LevelStatus.InProgress:e.setFrame("ui/completion-tapestry/shining-gem");break;case o.LevelStatus.SilverMedal:e.setFrame("ui/completion-tapestry/silver-gem")}}}t.Gems=r;class l extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.gems=new r(e),this.gems.onObjectCreated((e=>{this.add(e)}))}updateContent(e,t){this.gems.update(e.map((e=>({status:e,baseColor:t})))),this.updateLayout()}calculateHeight(){const e=this.gems.get();return e.length?e[e.length-1].y+5+1:0}updateLayout(){const e=Math.floor(this.width/10),t=this.gems.get();for(let i=0;i<t.length;i++){const[s,n]=[i%e*10+5,10*Math.floor(i/e)+5];t[i].setPosition(s,n)}this.updateSize()}}t.CompletionTapestry=l},79838:()=>{},79899:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageButton=void 0;const s=i(22663);var n=Phaser.GameObjects.Image;t.ImageButton=class extends n{constructor(e,t,i,n){super(e,t,i,"atlas",n.frame),this.config=n,this.setInteractive({cursor:"pointer"}),void 0===n.controller?this.setController(s.ButtonControllers.simple(n)):null!==n.controller&&this.setController(n.controller),this.setConfig(n)}setConfig(e){this.config={...this.config,...e},"number"==typeof e.tint&&this.setTint(e.tint),e.scale&&this.setScale(e.scale),e.tooltip&&this.setData("tooltip",e.tooltip),this.setButtonState(this.controller.getState())}setController(e){this.controller=e,e.bindTo(this,(e=>this.setButtonState(e)))}setBaseFrame(e){this.config.frame=e,this.setButtonState(this.controller.getState())}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}setButtonState(e){switch(e){case s.ButtonState.Rest:this.updateTint("default"),this.setFrame(this.config.frame);break;case s.ButtonState.Disabled:this.updateTint("disabled"),this.setFrame(this.config.frame+(this.config.disabled?"-disabled":""));break;case s.ButtonState.Hover:this.updateTint("hover"),this.setFrame(this.config.frame+(this.config.hover?"-hover":""));break;case s.ButtonState.Down:this.updateTint("down"),this.setFrame(this.config.frame+(this.config.down?"-down":""))}}updateTint(e){"number"==typeof this.config.tint?this.setTint(this.config.tint):void 0!==this.config.tint?.[e]&&this.setTint(this.config.tint[e])}}},79914:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BreakPointScreen=void 0;const s=i(81700),n=i(95568);class o extends n.BaseScreen{constructor(){super("BreakPoint",[s.Scenes.WorldMap])}async activate(){}deactivate(){}}t.BreakPointScreen=o},80075:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.canRewind=function(){return s.inject.gameStateController.rollbackAvailable&&(s.inject.levelSession.remainingLives>0||n.config.debug.cheats||(0,o.isPlayingEditorLevel)())};const s=i(91622),n=i(56824),o=i(68878)},80218:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaceCastlePlan=void 0;const s=i(91622),n=i(56824),o=i(8065),a=i(7334),r=n.logger.for("ai:PlaceCastlePlan");t.PlaceCastlePlan=class{constructor(e,t,i){this.hex=e,this.might=t,this.scoreFactors=i,this.endsTurn=!1,this.isConquest=!1,this.score=(0,o.aggregateScoreFactors)(i)}execute(e){try{return e.marshal.buildCastle(this.hex,this.might)}catch(e){return r.error(`Failed attempt to place castle at #${this.hex.id}`,e),!1}}hash(){return`Place ${s.inject.gameStateModel.rules.castleByMight(this.might).type} at #${this.hex.id}`}toString(){return`[${(0,a.formatNumber)(this.score)} | ${this.hash()}]`}toDebugString(){return(0,o.describeScoreFactors)(this.scoreFactors)}}},80268:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EMPTY_HOSTILITY_FACTORS=t.AIPolitics=void 0,t.calculatePerceivedThreatFactors=v,t.calculatePerceivedThreat=b,t.getRivalryBetween=x,t.isIn1v1Battle=T;const s=i(48042),n=i(4782),o=i(19618),a=i(70712),r=i(9292),l=i(91622),c=i(97849),d=i(8971),h=i(56038),u=i(56824),p=i(29555);function g(e,i,s){const n=y(e,i,s);return n?w(n):t.EMPTY_HOSTILITY_FACTORS}function m(e,t){if(t instanceof s.RegionModel)return t.isAlive()?o.Factions.model(e).byRegion(t):void 0;if(t instanceof n.FactionModel)return o.Factions.model(e).byId(t.id);{const i=h.Regions.model(e).byHex(t);return i?.isAlive()?i.faction:void 0}}function y(e,i,s){let n=m(e,i);const r=o.Factions.model(e).byId(s);if(!n||!n.isAlive()||!r)return;const c=l.inject.views.powerBalance.get(e),d=c.dominantFaction?.id,h=d===n.id?c.dominance:0,u=void 0!==d&&d!==s&&d!==n.id?c.dominance:0,p={focus:r.getCurrentPersonality(),isUnderAttack:a.AI.isUnderAttackByFaction(e,s,n.id),sufferedAttrition:a.AI.getFactionAttrition(e,s,n.id),theirTotalAttrition:a.AI.getFactionTotalAttrition(e,n.id),credit:a.AI.getFactionCredit(e,s,n.id),theirDominance:h,anotherFactionsDominance:u,rivalry:t.AIPolitics.getRivalryBetween(e,s,n.id)};return l.inject.plugins.ai.hostilityInputAdjustment.apply(p,r,n)}function f(e){const t=e.creditBoost+e.fearBoost+e.fightBackBoost+e.rivalryBoost+e.combativeBoost;return(0,r.cropNumber)(t+50,0,100)/100}function w(e){const t=e.sufferedAttrition>5;let i=2*-e.credit*e.focus.honorable*100;i<0&&(i*=1-e.rivalry);let s=0,n=0,o=100*(e.focus.combative-.5);if(e.theirDominance>0){const t=(0,r.cropNumber)(e.theirDominance,0,100);o*=(0,r.cropNumber)(1-t,0,1),s=Math.floor((0,r.cropNumber)(2*t*e.focus.ambitious,-100,100))}if(e.anotherFactionsDominance>0){const t=(0,r.cropNumber)(e.theirDominance,0,100);s=-Math.floor((0,r.cropNumber)(t*e.focus.ambitious,-50,100))}return t&&(n=(0,r.cropNumber)(e.sufferedAttrition/2,0,100),o=(0,r.pickLarger)(0,o)),{creditBoost:i,rivalryBoost:100*e.rivalry,fearBoost:s,combativeBoost:o,fightBackBoost:n}}function v(e,i){const s=i.state,n=e.faction,o=i.faction;c.assert.defined(o),c.assert.defined(n);const d=2*o.confidence,h=(0,r.cropNumber)(t.AIPolitics.getHostilityTowards(s,o,n.id)-.5,-.5,.5),u=t.AIPolitics.getRivalryBetween(s,n.id,o.id),p=a.AI.getRegionAttrition(s,i.id,n.id),g=a.AI.getRegionAttrition(s,e.id,o.id),m=function(e,t){const i=e.faction;return Object.entries(a.AI.getRegionAttrition(e.state,t.id)).reduce(((e,[t,s])=>Number(t)===i.id?e:e+s),0)}(i,e);let y=0;(p>5||g>5)&&(y=1+(0,r.pickSmaller)(1,(p+g)/50));const f=l.inject.views.expansionOptions.get(s,e.id),w=f.without(i.getHostileBorderHexes()),v=e.getUnitsByMight().count(),b=0===v?0:(0,r.cropNumber)(m/(10*v),0,.5),x=0===f.length?0:(0,r.cropNumber)(Math.pow(w.length/f.length,v),0,.5);let T=S(o);return 0===x&&(T=1),{base:d,hostilityModifier:h,rivalryBoost:u,attritionBoost:y,minimalThreat:T,likelyHoodOfFightingBackElsewhere:b,likelyHoodOfExpandingElsewhere:x}}function b(e){const{base:t,hostilityModifier:i,attritionBoost:s,rivalryBoost:n,minimalThreat:o,likelyHoodOfExpandingElsewhere:a,likelyHoodOfFightingBackElsewhere:l}=e;return(0,r.cropNumber)((t+i+s+n)*(1-a*l),o,3)}function S(e){return 1*(0,d.adjustMultiplierByFocus)(e.confidence,e.getCurrentPersonality().daring)}function x(e,t,i){const s=l.inject.views.powerBalance.get(e),n=s.factionsByPower.slice(0,2).map((e=>e.id));if(!n.includes(t)||!n.includes(i))return 0;const o=s.factionsByPower.slice(2).map((e=>e.scaledPower)).reduce(r.sum,0);return o?(1-(0,r.cropNumber)(o/s.factionsByPower[1].scaledPower,0,1))*(0,r.cropNumber)(1-(0,r.pickLarger)(0,s.dominance-50)/50,0,1):1}function T(e,t){return l.inject.views.powerBalance.get(e).factionsByPower.slice(0,2).some((e=>e.id===t))}u.logger.for("AIPolitics"),t.AIPolitics={getHostilityTowards:function(e,t,i){const s=y(e,t,i);return s?f(w(s)):.5},getHostilityFactors:g,getOpenHostilityTowards:function(e,t,i){const s=m(e,t),n=o.Factions.model(e).byId(i);if(!s||!n)return.5;const a=g(e,t,i),l=f(a),c=n.creditOf(s),d=a.fightBackBoost/100,h=(0,r.pickLarger)(.5-c+d,.5);return(0,r.pickSmaller)(h,l)},perceivedThreat:new p.Calculator(v,b),getRivalryBetween:x,is1v1BattleBetween:function(e,t,i){const s=e.factionsByPower.slice(0,2);return e.is1v1situation&&s.includes(t)&&s.includes(i)},isIn1v1Battle:T,getCreditReactionToThirdPartyConquest:function({casusBeliStrength:e,me:i,victimFaction:s,attackerFaction:n,attritionImpact:o,stateBeforeAttack:a}){const l=t.AIPolitics.getHostilityTowards(a,s,i.id),c=o/i.rawPower,d=(0,r.cropNumber)(e/o*4,0,1);let h=(0,r.cropNumber)(l-.5,-.5,.5);return h<0&&(h*=1-d),(0,r.cropNumber)(c*h,-.25,.25)},getDiplomaticPenalty:function(e,i){const s=2*(t.AIPolitics.getHostilityTowards(e.state,i,e.faction.id)-.5);return s<0?-400*-s*e.focus.honorable*e.focus.honorable:0},getMinimalThreat:S},t.EMPTY_HOSTILITY_FACTORS=Object.freeze({creditBoost:0,fearBoost:0,fightBackBoost:0,rivalryBoost:0,combativeBoost:0})},80321:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IncrementalIdGenerator=void 0,t.IncrementalIdGenerator=class{constructor(){this.nextIds={}}takeNextIdFor(e,t){for(this.nextIds[t.key]||(this.nextIds[t.key]=Math.max(0,...t.getEntryIds(e))+1);t.getEntryById(e,this.nextIds[t.key]);)this.nextIds[t.key]++;const i=this.nextIds[t.key];return this.nextIds[t.key]++,i}reset(){this.nextIds={}}}},80334:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.configProfiles=void 0;const s=i(11255),n=i(17519);t.configProfiles={dev:s.developmentConfig,production:n.productionConfig}},80374:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isInMenu=function(){return Boolean(o.inject.ui.sidebarMode())||s.app.device.uiVariant()===n.UiVariant.Compact&&s.app.navigator.currentScreen===s.app.screen.play&&s.app.screen.play.isPlayMenuOpen},t.getFavoriteButtonFrame=function(e){return e?"ui/button-icons/star-full":"ui/button-icons/star-empty"};const s=i(54825),n=i(11466),o=i(91622)},80477:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WaveSprite=t.WavesFooter=void 0;var s=Phaser.GameObjects.TileSprite;const n=i(86545),o=i(91622);class a extends n.ResponsiveContainer{constructor(e){super(e),this.w1=new r(e,0,.7),this.w2=new r(e,5,.85),this.w3=new r(e,16,1),o.inject.theme.use((e=>{Phaser.Display.Color.IntegerToColor(e.oceanColor),this.w1.setTint(e.oceanShades.dark3),this.w2.setTint(e.oceanShades.dark4),this.w3.setTint(e.oceanShades.dark5)})),this.setInteractiveAuto("default"),this.add([this.w1,this.w2,this.w3])}updateLayout(){this.w1.y=0,this.w2.y=8,this.w3.y=16,this.w1.setSize(this.width,this.height),this.w2.setSize(this.width,this.height),this.w3.setSize(this.width,this.height)}transitionIn(e){return new Promise((t=>{this.scene.preUpdate.force();const i=this.y;this.scene.tweens.add({targets:[this],props:{y:{from:this.y+this.height,to:i}},duration:e,ease:"Sine.easeInOut",onComplete:()=>t()})}))}transitionOut(e){return new Promise((t=>{this.scene.tweens.add({targets:[this],props:{y:`+=${this.height}`},duration:e,ease:"Sine.easeIn",onComplete:()=>{t()}})}))}update(e,t){const i=e/50;this.w1.setPhase(i),this.w2.setPhase(i),this.w3.setPhase(i)}}t.WavesFooter=a;class r extends s{constructor(e,t,i){super(e,0,0,0,0,"atlas","wave"),this.offset=t,this.distanceFactor=i,this.setOrigin(0,0),this.setScale(this.distanceFactor)}setSize(e,t){return super.setSize(e/this.distanceFactor,t/this.distanceFactor)}setPhase(e){this.setTilePosition(this.distanceFactor*e+this.offset,0)}}t.WaveSprite=r},80624:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionBordersRenderer=t.WorldMapDebugOverlay=void 0;const s=i(56824),n=i(87936),o=i(79573),a=i(76049),r=i(45664),l=i(15974),c=i(56038),d=i(82226),h=i(91622);s.logger.for("WorldMapDebugOverlay"),t.WorldMapDebugOverlay=class{constructor(e,t){this.scene=e,this.renderer=t,this.signalSubs=[],this.hexDebugLabels={},this.active=!1,this.arrowsGroup=this.scene.add.group({defaultKey:"atlas",defaultFrame:"debug-arrow"}).setDepth(o.WorldLayers.DebugOverlay),this.chunkRectangles=this.scene.add.group({classType:Phaser.GameObjects.Rectangle,createCallback:e=>{const t=e;t.setStrokeStyle(1,65280,.5),t.setDepth(o.WorldLayers.DebugOverlay)}}),this.regionBorders=new u(this.renderer)}showDebugLayer(e){this.clearDebugLayer(),this.activeDebugLayer=e;const t=this.scene;if(this.regionBorders.clear(),e){const i=e.getMap();i.getHexIds().forEach((e=>{const s=(0,r.getHex)(e),n=i.get(s.id);null!=n&&(this.hexDebugLabels[e]?this.hexDebugLabels[e].setVisible(!0).setText(n.toString()).setPosition(s.display.centerX,s.display.centerY):this.hexDebugLabels[e]=function(e,i){return new a.DebugTextBox(t,e.display.centerX,e.display.centerY,i,{origin:[.5,.5],backgroundOpacity:1}).setDepth(o.WorldLayers.DebugOverlay)}(s,n.toString()))}));const s=e.getArrows&&e.getArrows();s?.forEach((e=>{const[t,i]=(0,r.getHexes)(e).members,s=t.getAngleTowards(i);if(void 0===s)return;const n=(t.display.centerX+i.display.centerX)/2,a=(t.display.centerY+i.display.centerY)/2;this.arrowsGroup.get(n,a).setActive(!0).setVisible(!0).setDepth(o.WorldLayers.DebugOverlay).setRotation(s)})),e.getGroups&&this.regionBorders.setGroups(e.getGroups())}}clearDebugLayer(e){this.activeDebugLayer&&(this.activeDebugLayer=void 0,this.debugLayerSub?.unsubscribe(),e?(Object.values(this.hexDebugLabels).forEach((e=>e.destroy())),this.hexDebugLabels={}):Object.values(this.hexDebugLabels).forEach((e=>e.setVisible(!1))),this.arrowsGroup.getChildren().forEach((e=>this.arrowsGroup.killAndHide(e))))}create(){this.active=!0,this.hexUnderCursor=this.scene.add.polygon(0,0,n.HEX_POLYGON).setStrokeStyle(2,255).setVisible(!1).setDepth(o.WorldLayers.DebugOverlay).setOrigin(0,0),this.registerSignals()}registerSignals(){this.unRegisterSignals(),this.signalSubs.push(h.inject.ui.hexUnderCursor.watch((e=>{e?(this.hexUnderCursor.setPosition(e.x*n.HEX_WIDTH,e.y*n.HEX_INNER_HEIGHT),this.hexUnderCursor.setVisible(!0)):this.hexUnderCursor.setVisible(!1)}))),s.config.watchFuture(this.applyConfig.bind(this))}applyConfig(e){this.worldBoundsRectangle?.setVisible(!!e.debug.overlay)}unRegisterSignals(){this.signalSubs.forEach((e=>e.unsubscribe())),this.signalSubs=[]}redrawWorldBoundsRectangle(e){this.worldBoundsRectangle&&this.worldBoundsRectangle.destroy(),s.config.debug.overlay&&(this.worldBoundsRectangle=this.scene.add.rectangle(e.x,e.y,e.width,e.height).setStrokeStyle(1,255,1).setDepth(o.WorldLayers.DebugOverlay).setOrigin(0,0))}showDebugRectangle(e){this.debugRectangle&&this.debugRectangle.destroy(),s.config.debug.overlay&&(this.debugRectangle=this.scene.add.rectangle(e.x,e.y,e.width,e.height).setStrokeStyle(1,255,1).setDepth(o.WorldLayers.DebugOverlay).setOrigin(0,0))}showDebugPoint(e,t){this.debugPoint&&this.debugPoint.destroy(),s.config.debug.overlay&&(this.debugPoint=this.scene.add.arc(e,t,4).setStrokeStyle(1,255,1).setDepth(o.WorldLayers.DebugOverlay).setOrigin(.5,.5))}redrawChunkRectangles(e){this.chunkRectangles.getChildren().forEach((e=>this.chunkRectangles.killAndHide(e))),s.config.debug.chunkBorders&&e.map((e=>e.boundingBox)).forEach((e=>{const t=this.chunkRectangles.get(e.x,e.y);t.setSize(e.width,e.height),t.setVisible(!0),t.setOrigin(0,0),this.scene.add.existing(t).setDepth(o.WorldLayers.DebugOverlay)}))}destroy(e){this.unRegisterSignals(),this.clearDebugLayer(!0),this.active=!1,[this.worldBoundsRectangle,this.hexUnderCursor].forEach((e=>e?.destroy()))}setVisible(e){this.active!==e&&(e?this.create():this.destroy())}};class u{constructor(e){this.renderer=e,this.groups=[]}syncWithState(e=h.inject.currentGameState){this.clear();const t=c.Regions.model(e).all().map((e=>e.hexes));this.setGroups(t)}setGroups(e){e.filter((e=>e.length>0)).forEach((e=>{const t=new l.IsoTileGroupWithRenderer("RegionBorders",this.renderer,d.IsoTileRecipes.Highlight,(e=>{}));t.setHexes(e),this.groups.push(t)}))}clear(){this.groups.forEach((e=>e.clear())),this.groups=[]}}t.RegionBordersRenderer=u},80750:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompactRegionPanel=t.ExpandedState=void 0;const s=i(21941),n=i(66253),o=i(35758),a=i(7782),r=i(86545);var l;!function(e){e.Hidden="hidden",e.Collapsed="collapsed",e.Expanded="expanded"}(l||(t.ExpandedState=l={}));const c={[l.Expanded]:n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height,[l.Collapsed]:0,[l.Hidden]:0};class d extends r.ResponsiveContainer{constructor(e){super(e),this.expandedState=l.Collapsed,this.regionLabel=new o.CompactRegionLabel(this.scene,0,n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height),this.yController=a.Control.propOf(this,"y",{duration:n.COMPACT_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.box=new s.Box(e,s.BoxTextures.Plate,0,0,0,n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height),this.add([this.box,this.regionLabel])}updateState(e){if(void 0!==e.layout)if("play"===e.layout.name&&e.layout.regionData?.controllable){const t=e.layout.regionData;this.setExpandedState(l.Expanded),this.regionLabel.setRegionInfo(t),this.regionLabel.setBuyingPawnInfo(e.layout.heldPawnData)}else this.setExpandedState(l.Hidden)}setExpandedState(e){const t=this.scene.bounds.height-c[e];this.yController.transitionTo(t),this.expandedState=e}reflow(){const e=this.scene.bounds.height,t=this.scene.bounds.width-2*n.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides;let i=0;switch(this.expandedState){case l.Hidden:case l.Collapsed:i=e;break;case l.Expanded:i=e-n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height}this.setPosition(n.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides,i),this.setSize(t,n.COMPACT_PLAY_UI_LAYOUT.regionPanel.height),this.box.setSize(this.width,this.height),this.yController.setTo(i),this.regionLabel.width=t,this.regionLabel.updateNumbersLayout()}}t.CompactRegionPanel=d},80778:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.returnToMenuFromGame=async function(e){const t=n.inject.gameStateModel.map.levelId;n.inject.ui.selectedLevelId.set(t);const i=s.LevelModel.for(t);if("library/play-again"!==e)switch(i.category){case"expedition":o.app.scene.worldMap.overlays.set(n.inject.currentGameState,a.OverlayModes.disabled),await o.app.navigator.goTo(o.app.screen.overworld,{});break;case"conquest":try{const e=r.RandomMapHash.parse(t);await o.app.navigator.goTo(o.app.screen.randomMapSelect,{preset:e})}catch(e){console.warn(`Failed to parse conquest map hash: ${t}`,e),await o.app.navigator.goTo(o.app.screen.title)}break;default:if((0,l.isPlayingEditorLevel)()){const e=s.LevelModel.for(n.inject.gameStateModel.map.levelId).getStartingState();e&&(n.inject.gameStateModel.restore(e),o.app.scene.worldMap.syncState(n.inject.currentGameState)),await o.app.navigator.goTo(o.app.screen.mapEditor,{})}else await o.app.navigator.goTo(o.app.screen.title)}else o.app.navigator.goTo(o.app.screen.myLibrary,void 0)};const s=i(66143),n=i(91622),o=i(54825),a=i(30484),r=i(25342),l=i(68878)},80829:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimplePaintedLayer=void 0;const s=i(56337),n=i(20693),o=i(56038);t.SimplePaintedLayer=class{constructor(e,t=void 0){this.recipe=e,this.tint=t,this.group=new s.IsoTileGroup(this.recipe.frameIdBase)}addDirtyCorners(e){"all"===e.hexesToSync?this.syncWithState(e):this.syncHexes(e)}getHexes(e){const t=o.Regions.model(e);return n.HexGroup.union(t.all().map((e=>e.hexes)))}shouldIncludeHex(e,t){return void 0!==o.Regions.getByHex(e,t.id)}syncWithState(e){this.group.setHexes(this.getHexes(e.state),e)}syncHexes(e){const t=[],i=[];for(const s of e.hexesToSync){const n=this.shouldIncludeHex(e.state,s);n&&!this.group.hexes.has(s)?t.push(s):!n&&this.group.hexes.has(s)&&i.push(s)}this.group.addHexes(n.HexGroup.from(t),e),this.group.removeHexes(n.HexGroup.from(i),e)}paintCorner(e,t,i,s,n){const o=this.group.getCornerVariant(i);if(!this.recipe.frames[o])return;const a=`${this.recipe.frameIdBase}/${o}`;t.batchDrawFrame("atlas",a,s,n,1,this.tint)}}},80959:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UiBuilder=void 0;const s=i(76049),n=i(96137),o=i(54118),a=i(87544),r=i(21941),l=i(2426),c=i(5003),d=i(76738),h=i(46330),u=i(47545),p=i(73633),g=i(49424),m=i(79899),y=i(91622),f=i(75282),w=i(62609),v=i(91110),b=i(36257),S=i(56824),x=i(36868),T=i(25988),P=i(86815),I=i(7338);class C{static for(e){let t=this._instances.get(e.scene.key);return t||(t=new C(e),this._instances.set(e.scene.key,t)),t}constructor(e){this.scene=e,this.wood={caption:e=>this.text(e,s.BitmapFont.Main,n.Colors.woodenUi.primaryText),primaryButton:e=>(0,h.woodenPrimaryButton)(this,e),secondaryButton:e=>(0,h.woodenSecondaryButton)(this,e),compactButton:e=>(0,p.woodenPrimaryCompactButton)(this,e)},this.glassUi={caption:e=>this.text(e,s.BitmapFont.Main,n.Colors.glassUi_old.primaryText),paragraph:e=>this.text(e,s.BitmapFont.Small,n.Colors.glassUi_old.primaryText)}}rectangle(e,t=1){const i=new Phaser.GameObjects.Rectangle(this.scene,0,0).setOrigin(0,0);return function(e,t,i){"function"==typeof t?y.inject.theme.use((e=>{i(t(e))}),e):i(t)}(i,e,(e=>i.setFillStyle(e,t))),i}graphicalGameObject(e){return(0,b.createIcon)(this.scene,e)}roundedRect(e,t){const i=new l.RoundedRect(this.scene,{radius:e});return"function"==typeof t?y.inject.theme.use((e=>{const{color:s,alpha:n}=t(e);i.setFillStyle(s,n)}),i):"number"==typeof t?i.setFillStyle(t,1):i.setFillStyle(t.color,t.alpha??1),i}image(e,t){const i=new Phaser.GameObjects.Image(this.scene,0,0,"atlas",e);return void 0!==t&&i.setTint(t),i}withAttachments(e){return new P.ComponentWithAttachments(this.scene,e)}vLayout(e){return new o.VLayout(this.scene,e)}hLayout(e){return new a.HLayout(this.scene,e)}text(e,t,i){return(0,I.createText)(this.scene,{text:e,font:t,color:i,bbCode:!0})}textContainer(e,t,i){return new c.ResponsiveTextContainer(this.scene,this.text(e,t,i))}richText(e,t=0,i=s.VectorFont.Roboto){return(0,I.createText)(this.scene,{text:e,font:i,color:t,bbCode:!0})}vectorText(e,t=s.VectorFont.Roboto,i=0){return(0,I.createText)(this.scene,{text:e,font:t,color:i,bbCode:!1})}outlineButton(e){return(0,g.outlineButton)(this,e)}selectBox(e){return new f.SelectBox(this,e)}imageButton(e){return new m.ImageButton(this.scene,0,0,e)}stealthButton(e){return(0,u.stealthButton)(this,e)}helpIcon(e){const t=this.imageButton({frame:"ui/button-icons/help-circle",onClicked:e.onClicked??(()=>{S.events.trigger(x.UserActions.ToggleTooltip({object:t}))}),tooltip:e.tooltip});return t}sidebarWidget(e){return new T.SideBarWidget(this.scene,e)}formItem(e){return new v.FormItem(this.scene,e)}formItemCompact(e){return new v.CompactFormItem(this.scene,e)}simpleListView(e={}){return(0,w.simpleListView)(this.scene,e)}dropdownListView(e={}){return(0,w.dropdownListView)(this.scene,e)}buttonsListView(e={}){return(0,w.buttonsListView)(this.scene,e)}ribbon(e){return new d.Ribbon(this.scene,e)}box(e){return new r.Box(this.scene,e)}createIcon(e){return(0,b.createIcon)(this.scene,e)}}t.UiBuilder=C,C._instances=new Map},80987:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BLANK_PLAY_LOG_ITEM=void 0,t.BLANK_PLAY_LOG_ITEM=Object.freeze({playSeconds:0,aiSeconds:0,balance:[],moves:0,undos:0,seconds:0,turn:0})},81434:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnMutations=t.Pawns=void 0;const s=i(20026),n=i(90952),o=i(97849),a=i(56647),r=i(45664),l=i(27109),c=i(91622);class d{static model(e){return this.models.get(e)}static getPawnData(e,t){return(0,s.selectFromState)(e,n.GameState.pawns.byId,t)}static getPawnType(e,t){return this.getPawnData(e,t)?.type}static getPawnCount(e,t){return(0,s.selectFromState)(e,n.GameState.pawns.count,t)||0}static getByHex(e,t,i){return void 0===i?(0,s.selectFromState)(e,n.GameState.pawns.byHex,t)?.toArray()||[]:(0,s.selectFromState)(e,n.GameState.pawns.byHex,t)?.filter((t=>d.getPawnData(e,t)?.type===i)).first(void 0)}static getPawnHex(e,t){return(0,s.selectFromState)(e,n.GameState.pawns.hex,t)}static getByRegion(e,t){return(0,s.selectFromState)(e,n.GameState.pawns.byRegion,t)?.toArray()||[]}static getNextId(e){return(0,s.getParentEngine)(e).getNextId(n.GameState.pawns.byId)}static getAll(e){return(0,s.selectFromState)(e,n.GameState.pawns.byId).keySeq().toArray()}static destroy(e,...t){return 0===t.length?e:(0,s.applyMutations)(e,...h.destroyPawns(t))}static create(e,t){return(0,s.applyMutations)(e,...h.createPawn(e,t))}static setPawnCount(e,t,i){return(0,o.assert)(i>=0,`attempt to set count of pawn #${t} to negative value (${i})`),(0,s.applyMutations)(e,...h.setPawnCount(t,i))}static isPresentOnHex(e,t,i){return void 0!==d.getByHex(e,t,i)}static isTraitPresentOnHex(e,t,i){return!!c.inject.views.hexTraits.get(e,t)[i]}static replacePawn(e,t,i,n){const a=d.getPawnHex(e,t),l=d.getByHex(e,a,i),c={...d.getPawnData(e,t),type:i};return o.assert.undefined(l,`Cannot replace pawn ${t} with ${i}, pawn ${l} on the same hex already has this type`),(0,s.applyMutations)(e,...h.replacePawn(e,t,{...c,hex:(0,r.getHex)(a),id:n}))}static setPawnName(e,t,i){return d.getPawnData(e,t),(0,s.applyMutations)(e,...h.setPawnName(e,t,i))}static movePawn(e,t,i){return(0,s.applyMutations)(e,n.GameState.pawns.hex.createMutation({set:{[t]:i}},"pawn.moveTo"))}}t.Pawns=d,d.models=new l.ModelsCache((e=>new a.PawnsDataSetModel(e)));class h{static setPawnCount(e,t){return(0,o.assert)(t>=0,`attempt to set count of pawn #${e} to negative value (${t})`),0===t?this.destroyPawns([e]):[n.GameState.pawns.count.createMutation({set:{[e]:t}},"setPawnCount")]}static destroyPawns(e){return[n.GameState.pawns.count.createMutation({delete:e},"pawns.destroy"),n.GameState.pawns.hex.createMutation({delete:e},"pawns.destroy"),n.GameState.pawns.byId.createMutation({delete:e},"pawns.destroy")]}static createPawn(e,t){const i=t.id,s={id:i,type:t.type,name:t.name};return[n.GameState.pawns.byId.createMutation({set:{[i]:s}},"pawns.create"),n.GameState.pawns.hex.createMutation({set:{[i]:t.hex.id}},"pawns.create"),n.GameState.pawns.count.createMutation({set:{[i]:t.count||1}},"pawns.create")]}static replacePawn(e,t,i){const s=i.id,o={id:s,type:i.type,name:i.name};return[n.GameState.pawns.byId.createMutation({set:{[s]:o},delete:[t]},"pawns.replace"),n.GameState.pawns.hex.createMutation({set:{[s]:i.hex.id},delete:[t]},"pawns.replace"),n.GameState.pawns.count.createMutation({set:{[s]:i.count||1},delete:[t]},"pawns.replace")]}static setPawnName(e,t,i){const o=(0,s.selectFromState)(e,n.GameState.pawns.byId,t);return[n.GameState.pawns.byId.createMutation({set:{[t]:{...o,name:i}}},"pawns.setPawnName")]}}t.PawnMutations=h},81697:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultPointerAction=void 0,t.DefaultPointerAction=class{clear(){this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0)}set(e){this.clear(),this.timeout=setTimeout((()=>{this.timeout=void 0,e()}),0)}}},81700:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.Scenes=void 0,function(e){e.Play="Play",e.Debug="Debug",e.DebugHistory="DebugHistory",e.WorldMap="WorldMap",e.Preload="Preload",e.MapEditorSidebar="MapEditorSidebar",e.MapEditorOverlay="MapEditorOverlay",e.PlayUI="PlayUI",e.OverworldMap="OverworldMap",e.ModalWindow="ModalWindow",e.TitleScreenUI="TitleScreenUI",e.TitleScreenFooterUI="TitleScreenFooterUI",e.MenuHeaderUI="MenuHeaderUI",e.Victory="Victory",e.Defeat="Defeat",e.GlobalUI="GlobalUI",e.DropdownUI="DropdownUI",e.BackgroundUI="BackgroundUI",e.RandomMapSelectUI="RandomMapSelectUI",e.SidePanel="SidePanel",e.OverworldUI="OverworldUI",e.LevelList="LevelList",e.PlayMenuUI="PlayMenuUI",e.Expeditions="Expeditions",e.MyLibraryUI="MyLibraryUI",e.Storybook="Storybook",e.StorybookMenu="StorybookMenu"}(i||(t.Scenes=i={}))},81721:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeadIslands1=void 0;const s=i(37971),n=i(91622),o=i(54825),a=i(95428),r=i(36868),l=i(24598);t.DeadIslands1=class{constructor(){this.sawTileCaptured=!1,this.sawManaCollection=!1,this.sawDreadKnight=!1,this.main=new c(this)}};class c extends s.LevelScript{constructor(){super(...arguments),this.reinforcementsTooltip=null}activate(){super.activate(),1===n.inject.gameStateModel.currentPhase.turnNumber&&o.app.scene.playUI.updateState({worldMapPanel:{type:"tutorial",emojiEmotion:a.EmojiEmotion.DeeplyWorried,text:"Another island to clear of the undead menace!\nWait, something seems different about this one...",buttons:[]}}),this.onEvent(r.GameStateEvents.ZombiesActed,(e=>{e.convertedHexes.find((e=>1===e.originalFactionId))&&!this.module.sawTileCaptured?(this.module.sawTileCaptured=!0,setTimeout((()=>{o.app.scene.playUI.updateState({worldMapPanel:{type:"tutorial",emojiEmotion:a.EmojiEmotion.Shocked,text:"Damn, [b]The Necromancer[/b] uses zombies to expand and even [b]capture our territory![/b]",buttons:[]}})}),500)):o.app.scene.playUI.updateState({worldMapPanel:null})})),this.onEvent(r.GameStateEvents.HexCaptured,(e=>{!this.module.sawManaCollection&&1===e.capturingFactionId&&e.defeatedUnit&&6===e.victimFactionId?(this.module.sawManaCollection=!0,setTimeout((()=>{o.app.scene.playUI.updateState({worldMapPanel:{type:"tutorial",emojiEmotion:a.EmojiEmotion.Shocked,text:"Saw that? Every zombie purged on the Necromancers territory gives him some kind of [b]energy[/b]! I suggest we end this before we find out what he can do with it!",buttons:[]}})}),1e3)):this.module.sawDreadKnight||e.capturingPawnType!==l.PawnType.DreadKnight||(this.module.sawDreadKnight=!0,setTimeout((()=>{o.app.scene.playUI.updateState({worldMapPanel:{type:"tutorial",emojiEmotion:a.EmojiEmotion.VeryShocked,text:"Oh no, what IS that thing? Some kind of undead knight?! [b]We can't fight this thing head on![/b]",buttons:[]}})}),1e3))})),this.onEvent(r.GameStateEvents.FactionTurnOver,(e=>{1===e.factionId&&o.app.scene.playUI.updateState({worldMapPanel:null})}))}deactivate(){super.deactivate(),this.reinforcementsTooltip?.hide(!0)}}},81807:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverworldMapEditor=void 0;const s=i(66143),n=i(91622),o=i(56824),a=i(36868),r=i(4440),l=i(99545),c=i(30963),d=r.Input.Keyboard.KeyCodes,h={selectAll:d.A,addLink:d.C,removeLink:d.X,up:d.UP,down:d.DOWN,left:d.LEFT,right:d.RIGHT,addIsland:d.SPACE,ctrl:d.CTRL,shift:d.SHIFT,esc:d.ESC,toggleWin:d.W,play:d.P};t.OverworldMapEditor=class{constructor(e){this.scene=e,this.editMode="select"}setEditMode(e){this.editMode=e,"select"===e||"off"===e?n.inject.debugData.clear("hexInfo"):n.inject.debugData.set("hexInfo",e)}handleIslandClicked(e){switch(this.editMode){case"select":if(this.keys.shift.isDown)this.scene.islands.addToSelection(e);else{this.scene.islands.selectIslands(e);const t=s.LevelModel.for(e);console.log(`${t.getTitle()} (${t.id}): ${t.getLevelStatus()}`);const i=this.scene.getIslandPreviewById(e).getLinkAnchorPoint(),n=this.scene.cameras.main;this.scene.scrollController.cameraX.pushTo(i.x-n.displayWidth*n.zoom/2),this.scene.scrollController.cameraY.pushTo(i.y-n.displayHeight*n.zoom/2),this.scene.zoomController.zoomTo(c.DEFAULT_CAMERA_ZOOM,500)}break;case"add-link":this.scene.islands.addLinkFromSelected(e),this.setEditMode("select");break;case"remove-link":this.scene.islands.removeLinkFromSelected(e),this.setEditMode("select")}}moveKeyHandler(e){this.scene.islands.moveSelectedIslands({x:e.x,y:e.y}),this.scene.updateWorldBounds()}update(e,t){const i=this.keys.shift.isDown?5:1;this.keys.down.isDown&&this.moveKeyHandler({x:0,y:i}),this.keys.up.isDown&&this.moveKeyHandler({x:0,y:-i}),this.keys.left.isDown&&this.moveKeyHandler({x:-i,y:0}),this.keys.right.isDown&&this.moveKeyHandler({x:i,y:0})}enable(){this.scene.islands.onIslandClicked(this.handleIslandClicked.bind(this)),this.keys=this.scene.input.keyboard.addKeys(h,!0,!0),this.keys.addLink.on("down",(()=>this.setEditMode("add-link"))),this.keys.removeLink.on("down",(()=>this.setEditMode("remove-link"))),this.keys.esc.on("down",(()=>this.setEditMode("select"))),this.keys.selectAll.on("down",(()=>{this.scene.islands.selectIslands(...this.scene.islands.expedition.objects.filter((e=>"island"===e.type)).map((e=>e.id)))})),this.keys.addIsland.on("down",(async()=>{if(!this.scene.islands.selectedIslands.length)return;s.LevelModel.for(this.scene.islands.selectedIslands[0]);const e=l.commands.overworld.listOrphanLevels()[0];e&&(await this.scene.islands.add(e),this.scene.updateWorldBounds())})),this.keys.toggleWin.on("down",(async()=>{if(!this.scene.islands.selectedIslands.length)return;const e=s.LevelModel.for(this.scene.islands.selectedIslands[0]);n.inject.userData.current.progress.local.completedLevels[e.id]={turns:1,difficulty:"hard"},this.scene.islands.refresh(),n.inject.userData.writeUserData()})),this.keys.play.on("down",(()=>{if(!this.scene.islands.selectedIslands.length)return;const e=s.LevelModel.for(this.scene.islands.selectedIslands[0]);o.events.trigger(a.UserActions.PlayLevel({levelId:e.id,origin:"campaign/play"}))}))}}},81834:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexDefenseUpdater=t.HexDefenseProjection=void 0;const s=i(31011),n=i(45664),o=i(20026),a=i(81434),r=i(4005),l=i(56038),c=i(78635),d=i(56824),h=i(9292),u=i(88023);d.logger.for("HexDefense");class p extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new g(this).update}bootstrap(e){return(0,u.ImmutableMap)().withMutations((t=>{(0,n.getHexes)((0,o.selectFromState)(e,this.sources.regionByHex).keySeq().toArray()).map((i=>{const s=this._calculate(e,i);s>0&&t.set(i.id,s)}))}))}_calculate(e,t){const i=c.Warfare.getHexLocalDefense(e,t.id);return c.Warfare.canBeProtectedByWalls(e,t.id)?l.Regions.getSameRegionNeighbours(e,t).map((t=>c.Warfare.getHexProjectedDefense(e,t.id))).reduce(h.pickLarger,i):l.Regions.getSameRegionNeighbours(e,t).map((t=>c.Warfare.getHexProjectedUnitDefense(e,t.id))).reduce(h.pickLarger,i)}}t.HexDefenseProjection=p;class g extends r.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}initialize(){this.pawns=a.Pawns.model(this.newState),this.dirtyHexes=new Set}registerHandlers(e){e(this.dataSet.sources.hexDefenseSources,(e=>this._handleHexDefenseSourcesChanged(e))),e(this.dataSet.sources.regionByHex,(e=>this._handleRegionByHexChange(e))),e(this.dataSet.sources.pawnsByHex,(e=>this._handlePawnsByHexChange(e)))}_handleHexDefenseSourcesChanged(e){e.updated?.forEach((([e,t])=>{this._invalidateHexAndRelevantNeighbours((0,n.getHex)(e))}))}_handleRegionByHexChange(e){e.updated?.forEach((([e,t])=>{const i=(0,n.getHex)(e);this.dirtyHexes.add(i),c.Warfare.getHexProjectedDefense(this.oldState,e)>0&&(l.Regions.getSameRegionNeighbours(this.oldState,i).forEach((e=>this.dirtyHexes.add(e))),l.Regions.getSameRegionNeighbours(this.newState,i).forEach((e=>this.dirtyHexes.add(e))))}))}createMutation(){return this.dirtyHexes.forEach((e=>{const t=this.dataSet._calculate(this.newState,e);t>0?this.builder.set(e.id,t):this.builder.delete(e.id)})),super.createMutation()}_invalidateHexAndRelevantNeighbours(e){const t=l.Regions.getSameRegionNeighbours(this.oldState,e).with(l.Regions.getSameRegionNeighbours(this.newState,e));this.dirtyHexes.add(e);for(let e of t)this.dirtyHexes.add(e)}_handlePawnsByHexChange(e){for(let t of e.updated??[])this._invalidateHexAndRelevantNeighbours((0,n.getHex)(t.id))}}t.HexDefenseUpdater=g},82226:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IsoTileRecipes=void 0;const s=i(79573),n={A111:{frame:"full"},V111:{frame:"full"},V001:{frame:"inner",crop:{x:6,y:0,width:6,height:9}},A010:{frame:"inner",crop:{x:12,y:0,width:6,height:9}},V100:{frame:"inner",crop:{x:12,y:9,width:6,height:9}},A100:{frame:"inner",crop:{x:6,y:9,width:6,height:9}},V010:{frame:"inner",crop:{x:0,y:9,width:6,height:9}},A001:{frame:"inner",crop:{x:0,y:0,width:6,height:9}},V110:{frame:"outer",crop:{x:6,y:0,width:6,height:9}},A101:{frame:"outer",crop:{x:12,y:0,width:6,height:9}},V011:{frame:"outer",crop:{x:12,y:9,width:6,height:9}},A011:{frame:"outer",crop:{x:6,y:9,width:6,height:9}},V101:{frame:"outer",crop:{x:0,y:9,width:6,height:9}},A110:{frame:"outer",crop:{x:0,y:0,width:6,height:9}}},o={A111:{frame:"full"},V111:{frame:"full"},V001:{frame:"inner",crop:{x:48,y:0,width:48,height:72}},A010:{frame:"inner",crop:{x:96,y:0,width:48,height:72}},V100:{frame:"inner",crop:{x:96,y:72,width:48,height:72}},A100:{frame:"inner",crop:{x:48,y:72,width:48,height:72}},V010:{frame:"inner",crop:{x:0,y:72,width:48,height:72}},A001:{frame:"inner",crop:{x:0,y:0,width:48,height:72}},V110:{frame:"outer",crop:{x:48,y:0,width:48,height:72}},A101:{frame:"outer",crop:{x:96,y:0,width:48,height:72}},V011:{frame:"outer",crop:{x:96,y:72,width:48,height:72}},A011:{frame:"outer",crop:{x:48,y:72,width:48,height:72}},V101:{frame:"outer",crop:{x:0,y:72,width:48,height:72}},A110:{frame:"outer",crop:{x:0,y:0,width:48,height:72}}},a={A111:{frame:"full"},V111:{frame:"full"},V001:{frame:"inner-top",crop:{x:48,y:0,width:52,height:88}},A010:{frame:"inner-top",crop:{x:96,y:0,width:52,height:88}},V100:{frame:"inner-bottom",crop:{x:96,y:0,width:52,height:88}},A100:{frame:"inner-bottom",crop:{x:48,y:0,width:52,height:88}},V010:{frame:"inner-bottom",crop:{x:0,y:0,width:52,height:88}},A001:{frame:"inner-top",crop:{x:0,y:0,width:52,height:88}},V110:{frame:"outer-top",crop:{x:48,y:0,width:52,height:88}},A101:{frame:"outer-top",crop:{x:96,y:0,width:52,height:88}},V011:{frame:"outer-bottom",crop:{x:96,y:0,width:52,height:88}},A011:{frame:"outer-bottom",crop:{x:48,y:0,width:52,height:88}},V101:{frame:"outer-bottom",crop:{x:0,y:0,width:52,height:88}},A110:{frame:"outer-top",crop:{x:0,y:0,width:52,height:88}}};t.IsoTileRecipes={Palisade:{baseDepth:s.WorldLayers.TileObjects,offsetA:24,offsetV:24,frames:{V001:{frame:"V001"},A010:{frame:"A010"},V100:{frame:"V100"},A100:{frame:"A100"},V010:{frame:"V010"},A001:{frame:"A001"},V110:{frame:"V110"},A101:{frame:"A101"},V011:{frame:"V011"},A011:{frame:"A011"},V101:{frame:"V101"},A110:{frame:"A110"}},frameIdBase:"iso-tiles/palisade",scale:.5},Ground:{baseDepth:s.WorldLayers.Tiles,frameIdBase:"iso-tiles/ground",frames:o,scale:.5,renderToTexture:!0},Forest:{baseDepth:s.WorldLayers.TileObjects,frameIdBase:"iso-tiles/forest",offsetV:19,offsetA:31,frames:a,scale:.5},GloomyForest:{baseDepth:s.WorldLayers.TileObjects,frameIdBase:"iso-tiles/forest-gloomy",offsetV:19,offsetA:31,scale:.5,frames:a},Green:{baseDepth:s.WorldLayers.Tiles+100,frameIdBase:"iso-tiles/green",offsetV:13,offsetA:25,scale:.5,renderToTexture:!0,frames:{...o,V110:{frame:"outer-top-bottom",crop:{x:0,y:0,width:48,height:72}},A011:{frame:"outer-top-bottom",crop:{x:0,y:72,width:48,height:72}},A110:{frame:"outer-sides",crop:{x:0,y:0,width:48,height:72}},A101:{frame:"outer-sides",crop:{x:96,y:0,width:48,height:72}},V011:{frame:"outer-sides",crop:{x:96,y:72,width:48,height:72}},V101:{frame:"outer-sides",crop:{x:0,y:72,width:48,height:72}}}},Landmass:{baseDepth:s.WorldLayers.Landmass,frameIdBase:"iso-tiles/landmass",frames:{...o},scale:.5,renderToTexture:!0},Debug:{frameIdBase:"iso-tiles/debug",baseDepth:s.WorldLayers.DebugOverlay,renderToTexture:!0,frames:{A111:{frame:"a"},V111:{frame:"v"},V001:{frame:"v"},A010:{frame:"a"},V100:{frame:"v"},A100:{frame:"a"},V010:{frame:"v"},A001:{frame:"a"},V110:{frame:"v"},A101:{frame:"a"},V011:{frame:"v"},A011:{frame:"a"},V101:{frame:"v"},A110:{frame:"a"}}},Highlight:{baseDepth:s.WorldLayers.TileHighlight,frameIdBase:"iso-tiles/highlight",offsetV:13,offsetA:25,frames:{A111:{frame:"full"},V111:{frame:"full"},V001:{frame:"inner",crop:{x:48,y:0,width:52,height:76}},A010:{frame:"inner",crop:{x:96,y:0,width:52,height:76}},V100:{frame:"inner",crop:{x:96,y:72,width:52,height:76}},A100:{frame:"inner",crop:{x:48,y:72,width:52,height:76}},V010:{frame:"inner",crop:{x:0,y:72,width:52,height:76}},A001:{frame:"inner",crop:{x:0,y:0,width:52,height:76}},V110:{frame:"outer",crop:{x:48,y:0,width:52,height:76}},A101:{frame:"outer",crop:{x:96,y:0,width:52,height:76}},V011:{frame:"outer",crop:{x:96,y:72,width:52,height:76}},A011:{frame:"outer",crop:{x:48,y:72,width:52,height:76}},V101:{frame:"outer",crop:{x:0,y:72,width:52,height:76}},A110:{frame:"outer",crop:{x:0,y:0,width:52,height:76}},A111:void 0,V111:void 0},scale:.5},MiniLandmass:{frameIdBase:"iso-tiles/mini-landmass",frames:{...n},baseDepth:0,scale:1,renderToTexture:!0},MiniCoast:{frameIdBase:"iso-tiles/mini-coast",frames:{...n},baseDepth:0,scale:1,renderToTexture:!0},MiniCoastHighlight:{frameIdBase:"iso-tiles/mini-coast-highlight",frames:{...n,A111:void 0,V111:void 0},baseDepth:0,scale:1,renderToTexture:!0},MiniGround:{frameIdBase:"iso-tiles/mini-ground",frames:{...n},baseDepth:0,scale:1,renderToTexture:!0},MiniForest:{frameIdBase:"iso-tiles/mini-forest",frames:{...n},baseDepth:0,scale:1,renderToTexture:!0},Swamp:{baseDepth:s.WorldLayers.Tiles+100,frameIdBase:"iso-tiles/swamp",offsetV:13,offsetA:25,scale:.5,renderToTexture:!0,frames:{...o,V110:{frame:"outer-top-bottom",crop:{x:0,y:0,width:48,height:72}},A011:{frame:"outer-top-bottom",crop:{x:0,y:72,width:48,height:72}},A110:{frame:"outer-sides",crop:{x:0,y:0,width:48,height:72}},A101:{frame:"outer-sides",crop:{x:96,y:0,width:48,height:72}},V011:{frame:"outer-sides",crop:{x:96,y:72,width:48,height:72}},V101:{frame:"outer-sides",crop:{x:0,y:72,width:48,height:72}}}}}},82265:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateDropdownOptions=function(e,t){const i=e.domElement.children[0].value;let s="";for(let e=0;e<t.length;e++)s+="<option value='"+t[e]+"'>"+t[e]+"</option>";""!=s&&(e.domElement.children[0].innerHTML=s),e.domElement.children[0].value=i},t.setDropdownSelection=function(e,t){e.domElement.children[0].value=t??"---"}},82407:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConquerableHexesHighlight=t.DEFAULT_TINT=void 0;const s=i(56824),n=i(79573),o=i(24598),a=i(96137),r=i(20227),l=i(91622),c=i(40951),d=i(79611),h=s.logger.for("ConquerableHexesHighlight");t.DEFAULT_TINT=a.Colors.highlight.ownedRegion,t.ConquerableHexesHighlight=class{constructor(e,t){this.scene=e,this.objectPool=t,this.indicatorsByHex={},this.tweener=new r.Tweener(this.scene),this.tint=a.Colors.highlight.ownedRegion,this.alpha=1,this.indicators=this.scene.add.group({defaultKey:"atlas",defaultFrame:"hex-move-indicator",createCallback:e=>{e.setName("indicator"+this.indicators.getLength())}}).setDepth(n.WorldLayers.ConquerableHexesHighlight),this.pawnGhost=this.objectPool.getPawnImage(o.PawnType.Villager).setDepth(n.WorldLayers.FlyingObject).setAlpha(.7).setVisible(!1),this.scene.add.existing(this.pawnGhost)}clear(){this.removeIndicators(Object.keys(this.indicatorsByHex).map((e=>Number(e))))}set(e,i=t.DEFAULT_TINT,s=1){const n=Object.entries(this.indicatorsByHex).filter((([t,i])=>!e.hasId(Number(t)))).map((([e,t])=>Number(e)));this.removeIndicators(n),this.tint==i&&this.alpha===s||(this.tint=i,this.alpha=s,this._updateTintAndAlpha()),this.add(e,i,s)}_updateTintAndAlpha(){for(let e of Object.values(this.indicatorsByHex))e.setTint(this.tint).setAlpha(this.alpha)}add(e,i=t.DEFAULT_TINT,s=1){const o=[];this.tint=i,this.alpha=s,e.map((e=>{const t=this.indicatorsByHex[e.id]||this.indicators.get(e.display.centerX,e.display.centerY,void 0,void 0,!1).setVisible(!0).setActive(!0).setDepth(n.WorldLayers.ConquerableHexesHighlight).setScale(.5);return t.setTint(this.tint).setAlpha(this.alpha),this.indicatorsByHex[e.id]||(this.indicatorsByHex[e.id]=t,o.push(t)),t})),o.length&&this.tweener.add({targets:o,scale:{from:.25,to:.5},alpha:{from:0,to:s},duration:c.TIMING.pawnPickupTransition,ease:"Sine.easeOut",onComplete:()=>{o.forEach((e=>e.setAlpha(this.alpha)))}})}remove(e){this.removeIndicators(e.toIdsArray())}setHighlightedHex(e,t,i=1,s){const n=this.indicatorsByHex[e.id];n?this.highlightedIndicator!==n&&(this.clearHighlightedHex(),this.highlightedIndicator=n,this.highlightedIndicator?.setFrame("hex-move-indicator-hover"),this.highlightedIndicator?.setScale(.375),this.highlightedIndicatorTween=this.tweener.add({targets:n,scale:.5,alpha:i,duration:200,ease:"Sine.easeInOut"}),t?this.pawnGhost.setPosition(e.display.centerX,e.display.centerY-10).setFrame((0,d.getPawnRenderRecipe)(t).getFrame(s)).setVisible(!0):this.pawnGhost.setVisible(!1)):h.warning(`ignoring attempt to highlight conquest indicator on hex ${e.id}, which does not currently display conquest indicator`)}clearHighlightedHex(){if(this.highlightedIndicator){const e=this.highlightedIndicator;this.tweener.add({targets:e,scale:.375,alpha:this.alpha,duration:100,onComplete:()=>{e.setFrame("hex-move-indicator"),e.setScale(.5)},onStop:()=>{e.setFrame("hex-move-indicator")}}),this.highlightedIndicatorTween?.stop(),this.highlightedIndicator=void 0,this.pawnGhost.setVisible(!1)}}show(){this.indicators.children.each((e=>!!e.setVisible(e.active)))}hide(){this.indicators.setVisible(!1)}removeIndicators(e){if(0===e.length)return;const t=e.map((e=>this.indicatorsByHex[e])).filter((e=>e));for(let t of e)delete this.indicatorsByHex[t];this.highlightedIndicator&&t.includes(this.highlightedIndicator)&&this.clearHighlightedHex(),l.inject.ui.skipTransitions()?t.forEach((e=>{this.indicators.killAndHide(e)})):this.tweener.add({targets:t,scale:{from:.5,to:.25},alpha:{from:this.alpha,to:0},duration:c.TIMING.pawnPickupTransition,ease:"Sine.easeIn",onComplete:()=>{t.forEach((e=>{this.indicators.killAndHide(e)}))}}),e.forEach((e=>delete this.indicatorsByHex[e]))}has(e){return void 0!==this.indicatorsByHex[e]}}},83006:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CaptureTownsPlugin=void 0;const s=i(18497);t.CaptureTownsPlugin={name:s.PluginKey.CaptureTowns,displayName:"Capture Towns",icon:"ui/level-features/capture-towns",register(e){}}},83109:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOrCreateNearestCamp=function(e,t,i){const c=l.Bandits.getNearestCampHex(e,t.id),u=l.Bandits.getNearestCampDistance(e,t.id),p=d.Pawns.model(e);if(u>5){const l=function(e,t){const i=t.floodFillOut(((t,i,l)=>l<5&&function(e,t){const i=s.Regions.getByHex(e,t.id);if(!i)return!1;if(n.Factions.getByRegion(e,i)===o.SpecialFaction.neutral)return!0;const l=d.Pawns.model(e).findOne({hexes:t,traits:[a.PawnTraits.OccupiesTile]});return!l||l.type===r.PawnType.Bandit}(e,t))).filter((t=>function(e,t){if(!n.Factions.model(e).byHex(t)?.isNeutral())return!1;if(!h.Warfare.canBuildAt(e,t))return!1;const i=h.Warfare.model(e).getOccupyingUnit(t);return!i||i.type===r.PawnType.Bandit}(e,t)));let l,c=Number.NEGATIVE_INFINITY;return i.forEach((t=>{const i=function(e,t){const i=d.Pawns.model(e),n=t.neighbours().filter((t=>function(e,t){const i=s.Regions.model(e).byHex(t)?.faction;return void 0!==i&&!i.isNeutral()}(e,t))).length;return 2*t.neighbours().filter((e=>!!i.findOne({hexes:e,type:[r.PawnType.Forest]}))).length+t.neighbours().filter((t=>!s.Regions.getByHex(e,t.id))).length-2*n+(i.findOne({hexes:t,type:[r.PawnType.Bandit]})?3:0)}(e,t);i>c&&(l=t,c=i)})),l}(e,t);if(l){const e=p.findOne({hexes:l,type:[r.PawnType.Bandit]});if(e){const{newPawnId:t}=i.replace(e,r.PawnType.Camp);return p.byId(t)}{const e=i.create({hex:l,type:r.PawnType.Camp,captureHex:!1,tapUnit:!1});return p.byId(e.pawns[0].pawnId)}}return c?p.byHex(c,r.PawnType.Camp):void 0}return c?p.byHex(c,r.PawnType.Camp):void 0};const s=i(56038),n=i(19618),o=i(67274),a=i(63521),r=i(24598),l=i(77330),c=i(56824),d=i(81434),h=i(78635);c.logger.for("bandits")},83176:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupController=function(e){if(void 0===e.controller){const t=new s.SimpleButtonStateController({audio:e.audio});return e.onClicked&&t.onClicked((()=>e.onClicked())),t}if(null!==e.controller)return e.controller};const s=i(88389)},83221:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MenuHeaderUIScene=t.BackButtonCompact=t.BackButtonLarge=void 0;const s=i(81700),n=i(897),o=i(11466),a=i(30948),r=i(55275),l=i(20087),c=i(91622),d=i(54825),h=i(56824),u=i(80959),p=i(76049),g=i(2426),m=i(80477),y=i(7782),f=i(39217),w=i(36868),v=i(33020),b=i(9292);var S=Phaser.GameObjects.Image;const x={[o.UiVariant.Compact]:{backgroundMargin:0,backgroundPadding:20,backgroundRadius:0,backgroundMinWidth:380,panelHeight:100,titleSize:32,iconWidth:0,spacing:10,wavesHeight:68,attachmentTop:118},[o.UiVariant.Large]:{backgroundMargin:10,backgroundMinWidth:380,backgroundPadding:10,backgroundRadius:8,iconWidth:110,panelHeight:140,titleSize:32,spacing:10,wavesHeight:80,attachmentTop:138}};class T{constructor(e){this.scene=e,this.button=u.UiBuilder.for(e).wood.primaryButton({text:"BACK",icon:"ui/wood-icons/arrow-left",iconPlacement:"left",width:120,onClicked:()=>h.events.trigger(w.UserActions.GoBack())}),this.scene.add.existing(this.button)}activate(e){this.button.setVisible(!0),this.button.bringToTop(this.button)}updateLayout(){this.button.setPosition(this.scene.bounds.contentLeft+o.DEFAULT_CONTENT_PADDING,this.scene.bounds.height-v.LARGE_LAYOUT.footerHeight/2-this.button.height/2)}deactivate(){this.button.setVisible(!1)}}t.BackButtonLarge=T;class P{constructor(e){this.scene=e,this.button=u.UiBuilder.for(e).wood.compactButton({icon:"ui/compact/icon-back",orientation:"left",onClicked:()=>h.events.trigger(w.UserActions.GoBack())}),this.scene.add.existing(this.button)}activate(e){this.button.setVisible(!0)}updateLayout(){this.button.setPosition(0,this.scene.bounds.height-this.button.height)}deactivate(){this.button.setVisible(!1)}}t.BackButtonCompact=P;class I extends a.BaseUIScene{static get Layout(){return x[d.app.device.uiVariant()]}constructor(){super({key:s.Scenes.MenuHeaderUI}),this.currentState=(0,r.stateContainer)({header:{title:"?",subtitle:"?",icon:null,extraHeight:0,minWidth:0},footer:{backButton:!0}},this.applyState.bind(this)),this.preUpdate=(0,n.whenDirty)((()=>{this.cameras.main.y=0;const e=x[d.app.device.uiVariant()],t=this.currentState().header;if(t){this.titleText.setVisible(!0),this.background.setVisible(!0),this.icon.setVisible(!!t.icon&&d.app.device.uiVariant()!==o.UiVariant.Compact),this.overlayIcon.setVisible(!!t.overlayIcon&&d.app.device.uiVariant()!==o.UiVariant.Compact),this.subtitleText.setVisible(!!this.subtitleText.text);const i=t.alignWithContent?this.bounds.contentLeft:0,s=i+e.backgroundMargin+e.iconWidth/2;l.Arrange.alignX({content:[this.icon,this.overlayIcon],x:s,origin:.5}),l.Arrange.alignY({content:[this.icon,this.overlayIcon],y:e.panelHeight/2,origin:.5}),l.Arrange.topToBottom({content:[this.titleText,this.subtitleText],y:e.panelHeight/2,spacing:e.spacing,origin:.5}),l.Arrange.alignX({content:[this.titleText,this.subtitleText],x:i+e.backgroundMargin+e.iconWidth+e.backgroundPadding,origin:0});const n=Math.max(this.titleText.x+this.titleText.width,this.subtitleText.x+this.subtitleText.width+2*e.backgroundPadding,e.backgroundMinWidth);if(t.fullHeight)this.background.setPosition(i,0),this.background.setSize(e.backgroundMinWidth+e.backgroundPadding,this.bounds.height),this.background.radius=0,this.separator.setOrigin(0,0).setPosition(this.background.width,0),this.separator.scaleX=(this.bounds.height-140)/this.separator.width,this.separator.setVisible(!0),this.separator.scaleY=.5;else{this.separator.setVisible(!1),this.background.setPosition(i+e.backgroundMargin,e.backgroundMargin),this.background.radius=e.backgroundRadius;const s=d.app.device.uiVariant()===o.UiVariant.Compact?this.titleText.y+this.titleText.height+e.backgroundPadding:this.icon.height+2*e.backgroundPadding;this.background.setSize(n,(0,b.pickLarger)(s,this.subtitleText.y-this.background.y+this.subtitleText.height+e.backgroundPadding+(t.extraHeight??0)))}d.app.device.uiVariant()===o.UiVariant.Compact&&(this.background.width=this.bounds.width)}else this.icon.setVisible(!1),this.overlayIcon.setVisible(!1),this.titleText.setVisible(!1),this.subtitleText.setVisible(!1),this.background.setVisible(!1);this.waves.x=0,this.wavesHeight.setTo(e.wavesHeight,"instant"),this.waves.updateLayout(),this.backButton.activeUI.updateLayout()}))}create(){const e=u.UiBuilder.for(this);super.create(),this.scale.on("resize",(()=>this.preUpdate.makeDirty())),this.icon=new S(this,0,0,"atlas").setOrigin(0,0).setAlpha(.5),this.overlayIcon=new S(this,0,0,"atlas").setOrigin(0,0),this.titleText=e.vectorText("?",p.VectorFont.Cinzel32).setOrigin(0,0),this.subtitleText=e.text("?",p.BitmapFont.Small,0),this.background=new g.RoundedRect(this,{radius:20}).setAlpha(.87),this.separator=e.image("glass-ui/card-horizontal-glint").setRotation(Math.PI/2).setVisible(!1),this.waves=new m.WavesFooter(this),this.wavesHeight=new y.TransitionController(this,{initialValue:x[d.app.device.uiVariant()].wavesHeight,applyValue:e=>{this.waves.setSize(this.bounds.width,this.bounds.height-e+18),this.waves.y=this.bounds.height-e-18}}),this.wavesHeight.applyCurrentValue(),this.addAll([this.background,this.separator,this.icon,this.overlayIcon,this.titleText,this.subtitleText,this.waves]),this.backButton=new f.UIVariantSwitcher({scene:this,compactUI:()=>new P(this),largeUI:()=>new T(this)}),c.inject.theme.use((e=>{this.titleText.setTint(e.oceanContrastLight),this.subtitleText.setTint(e.oceanContrastLight),this.background.setFillStyle(e.oceanColor),this.icon.setTint(e.oceanShades.light2)}))}applyState(e,t,i){if(e.header){const{title:t,icon:i,overlayIcon:s,subtitle:n,minWidth:o,extraHeight:a}=e.header;this.titleText.setText(t),this.subtitleText.setText(n),i&&this.icon.setFrame(i).setOrigin(0,0).setAlpha(.5),s&&this.overlayIcon.setFrame(s).setOrigin(0,0)}e.footer&&this.backButton.setVisible(e.footer.backButton),this.preUpdate.makeDirty()}update(e,t){super.update(e,t);const i=this.input.activePointer.position;Math.abs(i.x-this.background.width),this.waves.update(e,t)}getTooltipFor(e){return super.getTooltipFor(e)}}t.MenuHeaderUIScene=I},83234:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BuyGiftsPlugin=void 0;const s=i(18497),n=i(24598),o=i(1326);t.BuyGiftsPlugin={name:s.PluginKey.BuyGifts,displayName:"Buy Presents",icon:"ui/level-features/buy-gifts",register(e){e.rules.adjustBuyableObjects.register(((e,[t])=>(0,o.stripDuplicatesFrom)([...e,n.PawnType.Present])))}}},83240:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isProgressDataEmpty=r,t.mergeProgressData=function(e,t){return r(e)?t:r(t)?e:{counters:l(e.counters,t.counters),completedLevels:d(e.completedLevels,t.completedLevels)}},t.updateProgressData=function(e,t){return r(e)?t:r(t)?e:{counters:c(e.counters,t.counters),completedLevels:d(e.completedLevels,t.completedLevels)}},t.mergeLevelCompletionRecords=h;const s=i(2543),n=i(56824),o=i(43656),a=i(9292);function r(e){return(0,s.isEmpty)(e.counters)&&(0,s.isEmpty)(e.completedLevels)}function l(e,t){const i=(0,s.uniq)([...Object.keys(e),...Object.keys(t)]),o={};for(let s of i){const i=e[s]??t[s];"boolean"==typeof i?o[s]=e[s]||t[s]:"number"==typeof i?o[s]=(t[s]??0)+(e[s]??0):n.errors.handleNonFatalError(new Error(`Unexpected type for progress counter ${s}: ${typeof i}`),"mergeProgressData")}return o}function c(e,t){const i=(0,s.uniq)([...Object.keys(e),...Object.keys(t)]),o={};for(let s of i){const i=e[s]??t[s];"boolean"==typeof i?o[s]=e[s]||t[s]:"number"==typeof i?o[s]=(0,a.pickLarger)(e[s]??0,t[s]??0):n.errors.handleNonFatalError(new Error(`Unexpected type for progress counter ${s}: ${typeof i}`),"mergeProgressData")}return o}function d(e,t){const i=(0,s.uniq)([...Object.keys(e),...Object.keys(t)]),n={};for(let s of i)n[s]=h(e[s],t[s]);return n}function h(e,t){return e?t?(0,o.pickBetterResult)(e,t):e:t}},83282:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.downloadAsTextFile=function(e,t){const i=new Blob([t],{type:"text/plain"}),s=URL.createObjectURL(i),n=document.createElement("a");n.href=s,n.download=e,n.click(),n.remove()}},83544:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PersistentString=t.PersistentNumber=t.PersistentEntry=void 0;const s=i(56824);t.PersistentEntry=class{constructor(e){this.key=e}put(e){s.storage.setObject(this.key,e)}discard(){s.storage.removeItem(this.key)}read(){return s.storage.getObject(this.key)}take(){const e=s.storage.getObject(this.key);return e&&s.storage.removeItem(this.key),e}},t.PersistentNumber=class{constructor(e,t=0){this.key=e,this.defaultValue=t}put(e){s.storage.setItem(this.key,e.toString())}discard(){s.storage.removeItem(this.key)}read(){return parseFloat(s.storage.getItem(this.key)??this.defaultValue.toString())}take(){const e=this.read();return s.storage.getItem(this.key)&&s.storage.removeItem(this.key),e}},t.PersistentString=class{constructor(e,t=""){this.key=e,this.defaultValue=t}put(e){s.storage.setItem(this.key,e)}discard(){s.storage.removeItem(this.key)}read(){return s.storage.getItem(this.key)??this.defaultValue}take(){const e=this.read();return s.storage.getItem(this.key)&&s.storage.removeItem(this.key),e}}},83874:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MultiMapMutationBuilder=t.MultiMapDataSet=void 0;const s=i(2543),n=i(20026),o=i(97849),a=i(1326),r=i(88023);t.MultiMapDataSet=class{constructor(e){this.key=e,this.defaultValue=(0,r.ImmutableMap)()}deserialize(e){let t=(0,r.ImmutableMap)();return Object.entries(e).forEach((([e,i])=>{t=t.set(Number(e),(0,r.ImmutableSet)(i))})),t}serialize(e){return e.toJS()}apply(e,t){return e.withMutations((e=>{t.updated?.forEach((t=>{t.removed&&(e.updateIn([this.key,t.id],n.EMPTY_SET,(e=>e.subtract(t.removed))),e.getIn([this.key,t.id]).isEmpty()&&e.deleteIn([this.key,t.id])),t.added&&e.updateIn([this.key,t.id],n.EMPTY_SET,(e=>e.union(t.added)))}))}))}createMutation(e,t){let i={},n=e.remove&&Object.entries(e.remove).filter((([e,t])=>t.size)),o=e.add&&Object.entries(e.add).filter((([e,t])=>t.size));return(o&&!(0,s.isEmpty)(o)||n&&!(0,s.isEmpty)(n))&&(i.updated=[],o?.forEach((([t,s])=>{const n={id:Number(t),added:Array.from(s)};e.remove&&e.remove[t]?.size&&(n.removed=Array.from(e.remove[t])),i.updated.push(n)})),n?.forEach((([t,s])=>{const n=Number(t);e.add&&e.add[Number(n)]?.size||i.updated.push({id:Number(n),removed:Array.from(s)})}))),{dataSet:this,changes:i,context:`${this.key}/${t}`}}mergeMutations(e,t){const i=(0,a.dictionaryOf)((e.updated??[]).map((e=>({id:e.id,added:e.added&&[...e.added],removed:e.removed&&[...e.removed]}))),"id");for(let e of t.updated??[]){const t=i[e.id];let s=e.removed,n=e.added;t?(t.added&&e.removed&&(s=e.removed.filter((e=>!t.added.includes(e))),t.added=t.added.filter((t=>!e.removed.includes(t)))),t.removed&&e.added&&(n=e.added.filter((e=>!t.removed.includes(e))),t.removed=t.removed.filter((t=>!e.added.includes(t)))),t.added=t.added?(0,a.stripDuplicatesFrom)([...t.added,...n??[]]):e.added,t.removed=t.removed?(0,a.stripDuplicatesFrom)([...t.removed,...s??[]]):e.removed):i[e.id]=e}return{updated:Object.values(i)}}getEntryById(e,t){return e.getIn([this.key,t])}getEntryIds(e){return e.get(this.key).keySeq().toArray()}entryToString(e){return e.map((e=>e.toString())).toArray().join(",")}entryToDebugString(e){return e.map((e=>e.toString())).toArray().join(",")}toString(){return`[MultiMapDataSet "${this.key}"]`}},t.MultiMapMutationBuilder=class{constructor(e,t){this.dataSet=e,this._itemsToAdd={},this._itemsToRemove={},t&&this.init(t)}init(e){this.state=e,this._itemsToAdd={},this._itemsToRemove={}}add(e,...t){return this._itemsToAdd[e]||(this._itemsToAdd[e]=new Set),t.forEach((t=>{o.assert.defined(t),this._itemsToRemove[e]?.has(t)?this._itemsToRemove[e].delete(t):this.getCurrent(e).has(t)||this._itemsToAdd[e].add(t)})),this}has(e,t){return!this._itemsToRemove[e]?.has(t)&&!!this._itemsToAdd[e]?.has(t)}getCurrent(e){let t=this.dataSet.getEntryById(this.state,e)||n.EMPTY_SET;return this._itemsToRemove[e]&&(t=t.subtract(this._itemsToRemove[e])),this._itemsToAdd[e]&&(t=t.union(this._itemsToAdd[e])),t}currentHas(e,t){return!this._itemsToRemove[e]?.has(t)&&(!!this._itemsToAdd[e]?.has(t)||this.dataSet.getEntryById(this.state,e)?.has(t))}hasRemoved(e,t){return!!this._itemsToRemove[e]?.has(t)}remove(e,...t){this._itemsToRemove[e]||(this._itemsToRemove[e]=new Set),t.forEach((t=>{o.assert.defined(t),this._itemsToAdd[e]?.has(t)?this._itemsToAdd[e].delete(t):this.dataSet.getEntryById(this.state,e)?.has(t)&&this._itemsToRemove[e].add(t)}))}removeEntry(e){const t=this.dataSet.getEntryById(this.state,e);t&&t.size&&(delete this._itemsToAdd[e],this._itemsToRemove[e]=new Set(t.toArray()))}clear(){throw new Error("Not implemented")}createMutation(e){return this.dataSet.createMutation({add:this._itemsToAdd,remove:this._itemsToRemove},e)}}},83879:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReplayBrowserAppController=void 0;const s=i(27126),n=i(91954),o=i(63586),a=i(74241),r=i(83221),l=i(2520),c=i(3122),d=i(19048),h=i(23202),u=i(48783),p=i(11651),g=i(81700),m=i(54825),y=i(36868),f=i(91622),w=i(25e3),v=i(56824),b=i(16007),S=i(95709);t.ReplayBrowserAppController=class{getScenes(){return[s.PreloadScene,S.BackgroundUIScene,n.WorldMapScene,o.PlayScene,a.PlayUIScene,r.MenuHeaderUIScene,l.GlobalUIScene,c.ModalWindowScene,d.DebugScene,h.DebugHistoryScene]}run(){this.initialized=!0,v.events.on(y.SystemEvents.EngineInitialized,(async()=>{const{game:e}=m.app;var t;w.NewsBox.hide(),e.scene.run(g.Scenes.GlobalUI),t=e=>{"IFRAME.LOAD_REPLAY"===e.name&&(f.inject.ui.spectatingSpeed.set(b.SpectatingPlaybackSpeed.Paused),(0,p.loadReplay)(e.payload.replayData))},window.addEventListener("message",(e=>{"object"==typeof e&&"object"==typeof e.data&&(0,u.isMessage)(e.data)&&t(e.data)})),parent.postMessage(u.Messages.ReadyToReceiveReplay(),{targetOrigin:"*"})})),v.events.on(y.UserActions.SetSpectatingPlayBackSpeed,(e=>{f.inject.ui.spectatingSpeed.set(e)}))}}},83903:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CenterLayout=t.LayoutChildrenPolicy=void 0;const s=i(86545);var n;!function(e){e.None="none",e.Stretch="stretch"}(n||(t.LayoutChildrenPolicy=n={}));class o extends s.BaseResponsiveContainer{constructor(e,t){super(e),this.content=t,this.add(t)}updateLayout(){this.content.setPosition(this.width/2-(this.content.displayWidth??this.content.width)/2,this.height/2-(this.content.displayHeight??this.content.height)/2)}}t.CenterLayout=o},83958:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultStrategy=void 0,t.adjustPersonalityBasedOnSituation=function(e){const t=e.relativeForecast,i=e.relativeScaledPower,s=e.basePersonality,n=(0,a.pickLarger)(1-t,.5),o=(i+(1-t))/2;return(0,a.pickLarger)(o,.4),{...e.basePersonality,daring:h(s.daring,n,e.basePersonality.ambitious)}},t.applySituationModifierToFocus=h,t.shouldForceAction=u;const s=i(56824),n=i(39409),o=i(91622),a=i(9292),r=i(24649),l=i(84757),c=i(13602),d=i(80268);function h(e,t,i){const s=4*(t-.5)*i;return(0,a.cropNumber)(e+s,(0,a.pickSmaller)(e,.1),(0,a.pickLarger)(e,.9))}function u(e,t){const i=e.faction.getLargestLiveRegion()===e.region,s=o.inject.views.situationScoreByRegion.getComponents({views:t,context:e}).forecast<=.5;return o.inject.views.powerBalance.get(e.state),i&&s&&d.AIPolitics.isIn1v1Battle(e.state,e.faction.id)}s.logger.for("ai:strategy"),t.defaultStrategy=async e=>{const t=new n.SituationExplorer(e);for(;await t.tryBest(1,[r.Planners.ObviousMoves]););const i=t.currentSituation;e.forceAction=u(e,i.views),e.expansionTarget=c.AIMetrics.getExpansionTarget(e),await e.breakpoint(`ai:strategy: start for region ${e.region.id} (force action=${e.forceAction})`);const s=l.timing.start("executing turn");await t.tryBest(1,[r.Planners.Conquest,r.Planners.ObviousMoves]);const o=t.currentSituation;if(s.complete("done with aggressive opening"),await t.explore(1,[r.Planners.Conquest,r.Planners.BasicDefense,r.Planners.FrontlineDefense,r.Planners.ObviousMoves]),await t.considerCurrentSituation(),e.aiPersonality.daring<1){t.goTo(o),await t.explore(e.aiPersonality.daring,[r.Planners.BasicDefense,r.Planners.FrontlineDefense,r.Planners.ObviousMoves]),await t.considerCurrentSituation(),t.goTo(i);const s=(1+e.aiPersonality.daring)/2;await t.explore(s,[r.Planners.LimitedConquest,r.Planners.BasicDefense,r.Planners.FrontlineDefense,r.Planners.ObviousMoves]),await t.considerCurrentSituation(),t.goTo(i),await t.explore(e.aiPersonality.daring,[r.Planners.LimitedConquest,r.Planners.BasicDefense,r.Planners.FrontlineDefense,r.Planners.BlockTownAccessMaxPikeman,r.Planners.ObviousMoves]),await t.considerCurrentSituation(),t.goTo(i),await t.explore(.75*e.aiPersonality.daring,[r.Planners.LimitedConquest,r.Planners.BasicDefense,r.Planners.BlockTownAccess,r.Planners.ObviousMoves]),await t.considerCurrentSituation()}t.goToBestOutcomeSoFar(),s.complete()}},84006:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.singletonFactory=function(e){let t;return()=>t||(t=e(),t)}},84108:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameHistory=void 0;const s=i(20026),n=i(45084),o=i(91622),a=i(97849),r=i(56824),l=i(96704),c=i(66143),d=i(72273),h=i(62847),u=i(36868),p=i(47841),g=i(47150),m=i(71021),y=i(34564),f=i(43046),w=i(18811);function v(e){return!!e.rewindSteps}r.logger.for("GameHistory"),t.GameHistory=class{get length(){return this.data.length}constructor(){this.data=[],this.tempModel=new d.GameStateModel,this.hadErrors=!1}addPlay(e,t,i){let s=new Set,o=n.CurrentPhase.getFaction(i)??0;this.data.length?this.data[this.data.length-1].activeFaction!==o&&s.add("turnStart"):(s.add("gameStart"),s.add("turnStart")),this.data.push({play:e,gameState:i,compressedState:null,activeFaction:o,tags:s,events:t}),this.updateDebugData()}reset(e){this.data=[{tags:new Set(["gameStart","turnStart"]),activeFaction:n.CurrentPhase.getFaction(e)??0,play:void 0,events:[],gameState:e,compressedState:null}],this.metadata=void 0,this.updateDebugData()}rewindTo(e,t){(0,a.assert)(e.history===this,"cursor is not valid for this GameHistory instance");const i=this.data.splice(e.currentIndex+1);t.storeAsRewind&&(e.currentStep.rewinds||(e.currentStep.rewinds=[]),e.currentStep.rewinds.push(i)),this.updateDebugData()}getCursor(){return new f.GameHistoryCursor(this)}latestMoveIndex(){return this.data.length-1}get latestState(){return this.getStateAt(this.data.length-1)}updateDebugData(){r.config.debug.gameHistory&&o.inject.debugData.set("history",this.debugDump(3))}getStateAt(e){const t=this.data[e];if(!t)throw new Error(`index ${e} out of range (0..${this.data.length-1})`);if(t.gameState)return t.gameState;if(t.compressedState)return this.tempModel.restore(t.compressedState),this.tempModel.stateEngine.activateAllProjections(),t.gameState=(0,s.setParentEngine)(this.tempModel.state,o.inject.gameStateModel.stateEngine),t.gameState;if(0===e)throw new Error("Cannot restore state - no state snapshot available at initial state");return this.reconstructStateAndEventsAt(e),t.gameState}reconstructStateAndEventsAt(e){const t=this.getStateAt(e-1),i=this.data[e];if(v(i)){const t=e-i.rewindSteps;return i.gameState=this.getStateAt(t),void(i.events=[u.GameStateEvents.NewGameState({state:i.gameState,context:m.NewGameStateContext.Rewind})])}if(!i.play)return i.gameState=t,void(i.events=[]);this.tempModel.restore(t),this.tempModel.stateEngine.activateAllProjections();try{const e=(0,h.gameStateReducer)(this.tempModel,i.play);i.gameState||i.compressedState||(i.gameState=(0,s.setParentEngine)(this.tempModel.state,o.inject.gameStateModel.stateEngine)),i.events=e}catch(e){r.errors.handleNonFatalError(e,"history.reconstructStateAndEventsAt"),this.hadErrors=!0,i.gameState=(0,s.setParentEngine)(this.tempModel.state,o.inject.gameStateModel.stateEngine)}}resetErrorsFlag(){this.hadErrors=!1}getCompressedStateAt(e){const t=this.data[e];if(!t)throw new Error(`index ${e} out of range (0..${this.data.length-1})`);if(t.compressedState)return t.compressedState;const i=this.getStateAt(e);return t.compressedState=(0,l.compressGameState)(i),t.compressedState}getEventsAt(e){const t=this.data[e];if(!t)throw new Error(`index ${e} out of range (0..${this.data.length-1})`);var i;return(i=t).play||i.rewindSteps||(t.events=[]),t.events?t.events:(this.reconstructStateAndEventsAt(e),t.events??[])}import(e,t){this.data=(0,g.importReplay)(e,t),this.metadata={aiDifficulty:e.meta.aiDifficulty,timestamp:e.meta.timestamp}}export(e){return(0,p.exportReplay)(this.data,{...e,gameStateSerializer:e=>this.getCompressedStateAt(e),victoryTurn:o.inject.levelSession.outcome===w.LevelOutcome.Victory?o.inject.levelSession.getTurnsToVictory():void 0,title:c.LevelModel.for(o.inject.gameStateModel.map.levelId).getTitle(),aiDifficulty:this.metadata?.aiDifficulty??o.inject.levelSession.aiDifficulty,timestamp:this.metadata?.timestamp})}debugDump(e=20){return this.data.map(((e,t)=>`#${t} ${function(e){if(v(e))return`[REWIND] ${e.rewindSteps} steps`;let t=`[${e.activeFaction}:${e.compressedState?"C":"."}${e.gameState?"S":"."}${e.events?"E":"."}] after ${e.play?(0,y.describeEventVerbose)(e.play):"initialization"} ${Array.from(e.tags).join(",")}`;return e.rewinds&&(t+=`\n${e.rewinds.map((e=>`  rewind ${e.length} steps`)).join("\n")}`),t}(e)}`)).slice(-e).join("\n")}}},84595:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintFactionTool=void 0;const s=i(67274),n=i(91622),o=i(63521),a=i(2543);function r(e){const t=n.inject.gameStateModel.pawns.select({hexes:e});n.inject.gameStateModel.pawns.destroy(...t.filter((e=>{return!(!(t=e).hasTrait(o.PawnTraits.OccupiesTile)&&(t.hasTrait(o.PawnTraits.Treasure)||t.hasTrait(o.PawnTraits.Terrain)||t.hasTrait(o.PawnTraits.Pest)));var t})))}t.PaintFactionTool=class{constructor(e,t){this.factionId=e,this._displayName=0===this.factionId?"unclaimed land":`faction ${this.factionId}`,this.options={title:(0,a.capitalize)(this._displayName),allowLargeBrushes:!0,description:`click = assign ${this._displayName}\nshift-click = use larger brush\nctrl-click = assign unclaimed land`},this.iconRecipe=t||function(e){return{image:"editor/tile-icon",tint:t=>t.factionColors[e-1]}}(e)}useOnRegion(e,t){if(!e)return;const i=e.faction?.isNeutral()!==(0===this.factionId||t.ctrl),s=e.hexes;t.ctrl?e.faction?.disownRegions(e):n.inject.gameStateModel.factions.byId(this.factionId).captureRegions(e),i&&r(s)}useOn(e,t){const i=n.inject.gameStateModel;for(;!i.factions.byId(this.factionId);)i.factions.create((0,s.getDefaultFactionConfig)(n.inject.gameStateModel.factions.all().length));const a=i.factions.byId(this.factionId),l=i.factions.byHex(e)?.id,c=0===l!=(0===this.factionId),d=i.pawns.findOne({hexes:e,traits:[o.PawnTraits.Impenetrable]});if(d&&d.destroy(),t.ctrl)n.inject.gameStateModel.factions.byId(s.SpecialFaction.neutral).takeOverHex(e),r(e);else{if(l===this.factionId)return;a.takeOverHex(e),c&&r(e)}}}},84691:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleDialog=void 0;const s=i(80959),n=i(96137),o=i(76049);t.SimpleDialog=class{getTitle(e){return e.title}getContent(e,t,i){return this.label||(this.label=s.UiBuilder.for(e).richText("",n.Colors.woodenUi.primaryText,o.VectorFont.RobotoLarge)),this.label.setText(t.message),this.label.setWordWrapWidth(i.width),this.label}getButtons(e){return e.buttons}}},84757:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timing=t.TimingHandle=t.Timing=void 0,i(56824).logger.for("timing");class s{start(e){return new n(e)}since(e){return Math.floor(performance.now()-e)}}t.Timing=s;class n{constructor(e){this.key=e,this.start=performance.now()}complete(e){return Math.ceil(performance.now()-this.start)}}t.TimingHandle=n,t.timing=new s},84842:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameAppController=void 0,t.getServiceWorkerStatus=se,t.getTotalBytesTransferred=ne,t.shouldShowTutorial=oe;const s=i(81700),n=i(56824),o=i(36868),a=i(62481),r=i(91693),l=i(99545),c=i(3122),d=i(56643),h=i(27126),u=i(91954),p=i(63586),g=i(74241),m=i(19048),y=i(23202),f=i(30330),w=i(83221),v=i(71021),b=i(34476),S=i(2520),x=i(25099),T=i(66143),P=i(97849),I=i(84757),C=i(51496),M=i(54764),A=i(67273),B=i(62732),E=i(25e3),O=i(71262),R=i(91622),k=i(54825),L=i(28937),_=i(78282),D=i(51512),H=i(59956),j=i(45084),F=i(13554),U=i(21817),G=i(16007),N=i(13419),V=i(72427),W=i(15160),z=i(95709),$=i(45145),Y=i(12051),K=i(35728),X=i(67023),q=i(48379),J=i(51186),Z=i(11651),Q=i(23636),ee=i(60190),te=i(15458),ie=n.logger.for("AppController");function se(){try{return navigator.serviceWorker?.controller?.state||"none"}catch(e){return`error: ${e}`}}function ne(){try{return performance.getEntriesByType("resource").reduce(((e,t)=>e+t.transferSize),0)}catch(e){return console.error("Failed to measure total bytes transferred",e),0}}function oe(){return!n.config.flags.portableMode&&!n.config.flags.skipTutorial&&!(R.inject.userProgressStats.completedLevels>0||R.inject.userProgressStats.playedConquestLevels>0)}t.GameAppController=class{constructor(){this.initialized=!1}getScenes(){return[h.PreloadScene,z.BackgroundUIScene,W.OverworldMapScene,u.WorldMapScene,p.PlayScene,ee.MapEditorSidebarScene,q.PlayMenuUIScene,g.PlayUIScene,K.ExpeditionsScene,f.TitleScreenUIScene,b.VictoryScene,M.DefeatScene,B.RandomMapSelectScene,J.MyLibraryUIScene,w.MenuHeaderUIScene,X.TitleScreenFooterUIScene,$.OverworldUIScene,Y.LevelListScene,te.MapEditorOverlayScene,L.SidePanelScene,S.GlobalUIScene,c.ModalWindowScene,Q.DropdownUIScene,m.DebugScene,y.DebugHistoryScene]}run(){const{gameStateController:e}=R.inject,{game:t}=k.app;console.info("GameAppController running"),this.initialized=!0,n.config.watch((e=>{(0,A.setDatGUIVisible)(e.debug.datgui),e.debug.overlay?(t.scene.isSleeping(s.Scenes.Debug)?t.scene.resume(s.Scenes.Debug):t.scene.run(s.Scenes.Debug),"string"==typeof e.debug.overlay&&l.commands.debug.layer(e.debug.overlay)):t.scene.isActive(s.Scenes.Debug)&&t.scene.sleep(s.Scenes.Debug)}));const i=n.logger.for("events");n.events.setDefaultHandler((e=>{i.debug(` ${(0,o.describeEvent)(e)}`),n.errors.logEvent(e)})),n.events.on(o.SystemEvents.EngineInitialized,(async()=>{if(R.inject.login.initialize(),(0,N.isRunningAt)("kongregate")&&V.Kongregate.initialize(),C.track.bootComplete({total_load_time_ms:I.timing.since(window.tStart),local_storage_available:k.app.device.hasLocalStorage,service_worker_status:se(),map_registry_load_time_ms:R.inject.mapRegistry.loadTime,total_transferred_bytes:ne(),max_texture_size:k.app.game.renderer.getMaxTextureSize?.()??0}),x.ActivityWatcher.start(),R.inject.ui.spectatingSpeed.set(R.inject.userData.recallChoice("spectatingSpeed")||G.SpectatingPlaybackSpeed.Normal),(0,D.setupFileDropZone)("phaser-game"),k.app.reporting.setupTelemetryReporting(),R.inject.levelSession.initialize(),t.scene.run(s.Scenes.GlobalUI),t.scene.run(s.Scenes.SidePanel),t.scene.run(s.Scenes.DropdownUI),n.config.debug.overlay&&t.scene.run(s.Scenes.Debug),await(0,_.parseUrlHash)()||(oe()?(E.NewsBox.hide(),n.events.trigger(o.UserActions.PlayLevel({levelId:"intro1",origin:"deep-link"}))):await k.app.navigator.goTo(k.app.screen.title)),!k.app.device.hasLocalStorage){const e="https://www.konkr.io"===k.app.device.url;k.app.notifications.warning("Saving unavailable","Your browser privacy settings don't allow the game to save progress between sessions while playing on this website. If you want to save your progress, review your browser settings"+(e?".":" or try playing at https://www.konkr.io."))}})),n.events.on(o.UserActions.OpenLoadGameDialog,(()=>{k.app.modals.show(d.UI.loadGame,{onLoad:e=>{try{(0,F.parseKonkrData)(e)}catch(e){k.app.modals.message("Looks like the save data is corrupted or incompatible\nwith this version of the game. Sorry!")}}})})),n.events.on(o.UserActions.EditMap,(()=>{try{R.inject.levelSession.saveLevelProgress()}catch(e){ie.error(e)}k.app.navigator.goTo(k.app.screen.mapEditor,{})})),n.events.on(o.UserActions.OpenMapEditor,(({openLevelRecord:e,importGameState:t})=>{t||(e?k.app.navigator.goTo(k.app.screen.mapEditor,{loadLevel:{userContentId:e.id,snapshots:e.snapshots}}):k.app.navigator.goTo(k.app.screen.mapEditor,{createNewLevel:!0}))})),n.events.on(o.UserActions.PlayLevel,(({levelId:e,origin:t,aiDifficulty:i,startingState:s,currentState:n,livesLeft:o,restart:a})=>{const r=T.LevelModel.for(e);let l,c;a||n||!r.isInProgress()?(c=n?.replay?v.NewGameStateContext.LoadingGame:v.NewGameStateContext.StartingNewGame,i=i??r.manifest?.fixedAIDifficulty??R.inject.userData.recallChoice("aiDifficulty"),l=n??s??r.getStartingState(),P.assert.defined(l),R.inject.levelSession.startNew({levelId:r.id,origin:t,turnNumber:l.currentPhase.turnNumber,aiDifficulty:i,startingState:s??r.getStartingState(),livesLeft:o})):(l=s??r.getCurrentState(),P.assert.defined(l),c=R.inject.levelSession.levelId===e?v.NewGameStateContext.ResumingGame:v.NewGameStateContext.LoadingGame,R.inject.levelSession.resumeInProgressLevel(t)),R.inject.gameStateController.loadState(l,c),k.app.navigator.goTo(k.app.screen.play,c)})),n.events.on(o.UserActions.LoadReplay,(e=>{try{(0,Z.loadReplay)(e)}catch(e){k.app.notifications.warning("Failed to load replay","Sorry, this replay appears corrupted, I was unable to load it.")}})),n.events.on(o.UiEvents.RestartConfirmed,(({aiDifficulty:e})=>{const t=R.inject.levelSession.levelId,i=T.LevelModel.for(t),s=i.getStartingState();e&&"expedition"===i.category&&R.inject.userData.rememberChoice("aiDifficulty",e),n.events.trigger(o.UserActions.PlayLevel({levelId:t,origin:"defeat/restart",aiDifficulty:e,startingState:s,restart:!0}))})),n.events.on(o.UserActions.InternalLoadGame,(t=>{const i=(0,a.internalLoadGame)(t);R.inject.gameStateController.loadState(i,v.NewGameStateContext.LoadingGame),R.inject.levelSession.startNew({levelId:H.WorldMap.get(e.currentState).levelId,origin:"debug-tool",turnNumber:j.CurrentPhase.getTurnNumber(e.currentState),aiDifficulty:R.inject.userData.recallChoice("aiDifficulty"),startingState:i}),n.config.autoSaveOnTurnStart&&"auto"!==t&&R.inject.levelSession.saveLevelProgress(),k.app.navigator.goTo(k.app.screen.play,v.NewGameStateContext.LoadingGame),e.loadState(i,v.NewGameStateContext.LoadingGame),k.app.scene.worldMap.cameraController.center()})),n.events.on(o.UserActions.CreateBlankMap,(async e=>{(0,O.createBlankMap)(30,30),R.inject.gameStateModel.activateAllProjections(),k.app.scene.worldMap.syncState()})),n.events.on(o.UserActions.SyncWithModel,(t=>{e.loadState(e.currentState,v.NewGameStateContext.LoadingGameStateForDebug)})),n.events.on(o.UserActions.SaveGame,(e=>{(0,r.saveGame)(e)})),n.events.on(o.UserActions.DebugGameState,(t=>{e.loadState(t,v.NewGameStateContext.LoadingGameStateForDebug)})),n.events.on(o.UserActions.SendTweet,(()=>{C.track.interaction("feedback_twitter"),window.open(n.config.socials.twitterUrl,"_blank")})),n.events.on(o.UserActions.JoinDiscord,(()=>{C.track.interaction("feedback_discord"),window.open(n.config.socials.discordUrl,"_blank")})),n.events.on(o.UserActions.SendEmail,(()=>{C.track.interaction("feedback_email"),window.open("mailto:"+n.config.socials.email,"_blank")})),n.events.on(o.UserActions.SetSpectatingPlayBackSpeed,(e=>{R.inject.ui.spectatingSpeed.set(e),e!==G.SpectatingPlaybackSpeed.Paused&&R.inject.userData.rememberChoice("spectatingSpeed",e)})),n.events.on(o.UserActions.SetShowBudgetNumbers,(e=>{R.inject.userData.rememberChoice("showBudgetOverlay",e)})),n.events.on(o.UserActions.GoToMapGeneration,(()=>{k.app.navigator.goTo(k.app.screen.mapGeneration)})),n.events.on(o.UserActions.GoToRandomMapSelect,(()=>{k.app.navigator.goTo(k.app.screen.randomMapSelect,{})})),n.events.on(o.UserActions.GoToMyLibrary,(()=>{k.app.navigator.goTo(k.app.screen.myLibrary,void 0)})),n.events.on(o.UserActions.GoToExpedition,(({expeditionId:e,focusObjectId:t})=>{k.app.navigator.goTo(k.app.screen.overworld,{expeditionId:e,focusObject:t})})),n.events.on(o.UserActions.ShowHelp,(e=>{C.track.interaction("how_to_play");const t=k.app.scene.sidePanelUI.panels[U.SideBarMode.Help];if(e){const i=n.config.helpPagesBaseUrl+e.replace("/",".html#");R.inject.ui.sidebarMode()===U.SideBarMode.Help&&i===t.frame.url?R.inject.ui.sidebarMode.set(void 0):(R.inject.ui.sidebarMode.set(U.SideBarMode.Help),t.frame.setUrl(i))}else R.inject.ui.sidebarMode()===U.SideBarMode.Help?R.inject.ui.sidebarMode.set(void 0):(R.inject.ui.sidebarMode.set(U.SideBarMode.Help),t.frame.setUrl(n.config.helpPagesBaseUrl))})),n.events.on(o.SystemEvents.UserDataLoaded,(()=>{k.app.audio.mute=!!R.inject.userData.current.rememberedChoices.muteSoundEffects,k.app.audio.setVolume(R.inject.userData.current.rememberedChoices.soundEffectsVolume??1)})),n.events.on(o.UserActions.AddLevelToFavorites,(async({levelId:e,startingState:t})=>{await R.inject.userContent.addToFavorites(e,t)})),n.events.on(o.UserActions.RemoveLevelFromFavorites,(async e=>{await R.inject.userContent.removeFromFavorites(e)})),n.events.on(o.UserActions.DeleteLevel,(async e=>{await R.inject.userContent.deleteContent(e)})),n.events.on(o.UserActions.SetFullScreenMode,(e=>{e?(C.track.interaction("enter_fullscreen"),k.app.game.scale.startFullscreen()):(C.track.interaction("exit_fullscreen"),k.app.game.scale.stopFullscreen())})),n.events.on(o.UserActions.SetAudioVolume,(({volume:e,enabled:t})=>{R.inject.userData.rememberChoice("muteSoundEffects",!t),void 0!==e&&(R.inject.userData.rememberChoice("soundEffectsVolume",e),k.app.audio.setVolume(e)),t?(k.app.audio.mute=!1,C.track.interaction("unmute")):(k.app.audio.mute=!0,C.track.interaction("mute"))}))}}},84954:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExpeditionsScreen=void 0;const s=i(95568),n=i(81700),o=i(54825),a=i(36868),r=i(56824),l=i(45174),c=i(91622),d=i(22006),h=i(98517);class u extends s.BaseScreen{constructor(){super("Overworld",[n.Scenes.Expeditions,n.Scenes.MenuHeaderUI]),this.observe.event(a.UserActions.GoBack,(()=>{o.app.navigator.goTo(o.app.screen.title)})),this.observe.event(a.UserActions.Escape,(async()=>{r.events.trigger(a.UserActions.GoBack())})),this.observe.event(a.SystemEvents.UserDataLoaded,(()=>{o.app.scene.expeditions.refresh()}))}async activate(e,t){c.inject.theme.sync(),o.app.scene.menuHeaderUI.currentState.update({header:{fullHeight:!1,title:"Select expedition...",subtitle:"",icon:"rosetta-light"},footer:{backButton:!0}}),o.app.scene.expeditions.refresh()}async transitionIn(e){e===o.app.screen.overworld?await(0,l.overworldToExpeditionsTransition)(o.app.screen.overworld.selectedExpedition.id):await(0,d.expeditionsTransitionIn)()}async transitionOut(e){e===o.app.screen.title&&await(0,h.expeditionsTransitionOut)()}}t.ExpeditionsScreen=u},85026:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.encodeGameState=function(e){return u(l,e)},t.encodeUserData=function(e){return u(d,e)},t.encodeReplay=function(e){return u(c,e)},t.decodeGameState=function(e){let t;try{t=p(l,e)}catch(e){throw new Error("save data corrupted")}if(t.version!==o.CORE_GAMESTATE_SCHEMA_VERSION)throw new Error(`save data not compatible with current version of the game (found version ${t.version}, expected ${o.CORE_GAMESTATE_SCHEMA_VERSION})`);return t},t.decodeReplay=function(e){return p(c,e)},t.decodeV2UserData=function(e){return p(h,e)},t.decodeUserData=function(e){return p(d,e)},t.isEncodedGameState=function(e){return e.startsWith(l)},t.isEncodedReplay=function(e){return e.startsWith(c)},t.isChatterFile=function(e){return e.startsWith(a.CHATTERFILE_PREFIX)},t.isEncodedV2UserData=function(e){return e.startsWith(h)},t.isEncodedUserData=function(e){return e.startsWith(d)},t.gzipEncode=u,t.gzipDecode=p;const n=s(i(95474)),o=i(62643),a=i(44503),r=i(78349),l=`konkrmap.v${o.CORE_GAMESTATE_SCHEMA_VERSION}.`,c=`konkrreplay.v${o.CORE_GAMESTATE_SCHEMA_VERSION}.`,d=`konkruserdata.v${r.USER_DATA_VERSION}.`,h="konkruserdata.v2.";function u(e,t){const i=JSON.stringify(t);return e+n.default.compress(i,{inputEncoding:"String",outputEncoding:"Base64"})}function p(e,t){if(!t.startsWith(e))throw new Error(`Invalid data: "${t.substring(0,50)}..." does not start with ${e}`);const i=t.substring(e.length),s=n.default.decompress(i,{inputEncoding:"Base64",outputEncoding:"String"}).toString();return JSON.parse(s)}},85066:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TooltipCounters=void 0;const s=i(96137);t.TooltipCounters={coins:e=>({value:e,color:s.Colors.tooltip.coinsCounter,icon:"ui/mini-icons/coins-flat"}),might:e=>({value:e,color:s.Colors.tooltip.mightCounter,icon:"ui/mini-icons/might"}),upkeep:e=>({value:e,color:s.Colors.tooltip.coinsCounter,icon:"ui/mini-icons/upkeep"}),income:e=>({value:e,color:s.Colors.tooltip.coinsCounter,icon:"ui/mini-icons/income"})}},85072:(e,t)=>{"use strict";var i,s,n,o;Object.defineProperty(t,"__esModule",{value:!0}),t.MAP_GENERATOR_VERSION=t.MapDifficulty=t.MapMode=t.MapShape=t.MapSize=void 0,function(e){e.Small="Small",e.Medium="Medium",e.Large="Large"}(i||(t.MapSize=i={})),function(e){e.Temperate="Temperate",e.Marshlands="Marshlands",e.Flat="Flat"}(s||(t.MapShape=s={})),function(e){e.Classic="Classic",e.Colonization="Colonization",e.Crowded="Crowded",e.Zombies="Zombies",e.Christmas="Christmas",e.KingsLanding="King's Landing",e.Occupation="Occupation"}(n||(t.MapMode=n={})),function(e){e.Casual="Casual",e.Normal="Normal",e.Challenging="Challenging",e.Unfair="Unfair"}(o||(t.MapDifficulty=o={})),t.MAP_GENERATOR_VERSION=5},85311:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InBattleOverlay=void 0;const s=i(86545),n=i(2426),o=i(79899),a=i(80959),r=i(76049),l=i(96137),c=i(56824),d=i(36868),h=i(91622),u=i(20087),p=i(54118);class g extends s.BaseResponsiveContainer{constructor(e){super(e),this.layout={padding:16,spaceAfterIcon:8};const t=a.UiBuilder.for(e);this.icon=t.image("ui/icons/battle"),this.title=t.text("In Battle",r.BitmapFont.Main,l.Colors.glassUi_old.shapeLightAccent),this.subTitle=t.text("Turn 2 on hard difficulty",r.BitmapFont.Mini,l.Colors.glassUi_old.shapeLightAccent),this.textBlock=t.vLayout({layoutPolicy:p.LayoutChildrenPolicy.None,content:[this.title,this.subTitle],spacing:4,originX:0,originY:0}),this.textBlock.updateLayout(),this.border=new n.RoundedRect(e,{radius:8}),this.closeButton=new o.ImageButton(e,0,0,{frame:"ui/close-button",onClicked:()=>{c.events.trigger(d.UserActions.AbandonLevelProgress())}}),h.inject.theme.use((e=>{this.border.setLineStyle(e.oceanShades.dark3,1),this.closeButton.setConfig({tint:{default:e.oceanColor,hover:e.white}})})),this.add([this.border,this.icon,this.textBlock,this.closeButton])}updateLayout(){this.border.setSize(this.width,this.height),u.Arrange.alignY({content:[this.icon,this.textBlock,this.closeButton],y:this.height/2,origin:.5}),u.Arrange.leftToRight({content:[this.icon,this.textBlock],x:this.layout.padding,spacing:this.layout.spaceAfterIcon,origin:0}),u.Arrange.leftToRight({content:[this.closeButton],x:this.width-this.layout.padding,origin:1})}}t.InBattleOverlay=g},85610:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FastForwardOverlay=void 0;const s=i(86545),n=i(80959),o=i(76049),a=i(20087),r=i(7782),l=i(52031),c=i(36868),d=i(75742),h=i(91622);class u extends s.ResponsiveContainer{constructor(e){super(e),this.scene=e,this.ui=n.UiBuilder.for(this.scene),this.semiTransparentIcon=this.ui.image("ui/fast-forward").setAlpha(.25),this.filledIcon=this.ui.image("ui/fast-forward"),this.label=this.ui.text("Rivals making moves...",o.BitmapFont.Small,16777215),this.observe=new l.Observer((()=>this.scene.scene.isActive()&&this.visible)),this.filledPercentage=new r.TransitionController(this.scene,{duration:100,applyValue:e=>{this.filledIcon.setCrop(0,0,this.filledIcon.width*e/100,this.height)},ease:"Sine.easeInOut",initialValue:0}),this.totalWaitEstimateMs=0,this.factionIdToProgressEstimate=[],this.add([this.semiTransparentIcon,this.filledIcon,this.label]),this.setVisible(!1),this.observe.event(c.GameStateEvents.FactionTurnStarted,(e=>{if(0===e.factionId)this.filledPercentage.transitionTo(100);else{const t=this.factionIdToProgressEstimate[e.factionId]??50;this.filledPercentage.transitionTo(t)}}))}initializeProgressIndicator(e){const t=[];let i=0;for(let s=1;s<=d.MAX_FACTIONS_COUNT;++s){const n=h.inject.ai.waitEstimator.getEstimateFor(e.factions.byId(s));i+=n,t[s]=i}const s=e.currentPhase.faction?.id;this.factionIdToProgressEstimate=t.map((e=>e/i*100)),s?this.filledPercentage.setTo(this.factionIdToProgressEstimate[s]??0):this.filledPercentage.setTo(0),this.totalWaitEstimateMs=i}getEstimatedTimeLeft(e){const t=e.currentPhase.faction;return t?this.totalWaitEstimateMs*(1-this.factionIdToProgressEstimate[t.id]/100):0}updateLayout(){this.filledPercentage.setTo(50),a.Arrange.alignX({content:[this.semiTransparentIcon,this.filledIcon,this.label],x:this.width/2,origin:.5}),a.Arrange.topToBottom({content:[this.semiTransparentIcon,this.label],spacing:20,origin:.5,y:this.height/2}),this.filledIcon.y=this.semiTransparentIcon.y}}t.FastForwardOverlay=u},85614:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TextSpawner=void 0;const s=i(87521),n=i(76049),o=i(79573);t.TextSpawner=class{constructor(e){this.scene=e,this.pool=new s.Pool((()=>this.scene.add.bitmapText(0,0,n.BitmapFont.Small).setDropShadow(1,1,16777215).setDepth(o.WorldLayers.UIOverlay).setVisible(!1).setOrigin(.5,.5)))}popupText(e,t,i){const s=this.pool.take();s.setText(t),s.setPosition(e.display.centerX,e.display.centerY-25),s.setTint(i),s.setVisible(!0),s.setDepth(o.WorldLayers.UIOverlay+s.y),this.scene.tweens.add({targets:[s],y:{from:e.display.centerY-36,to:e.display.centerY-50},alpha:{from:0,to:1},duration:500,ease:"Sine.easeOut"}),this.scene.tweens.add({targets:[s],alpha:0,duration:300,delay:800,ease:"Sine.easeIn",onComplete:()=>{s.setVisible(!1),this.pool.free(s)}})}}},85647:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClickableArea=void 0;var s=Phaser.GameObjects.Rectangle;const n=i(22663),o=i(83176),a=i(897);t.ClickableArea=class extends s{constructor(e,t){super(e,0,0,0,0),this.props=t,this.preUpdate=(0,a.whenDirty)((()=>this.updateLayout())),this.setInteractive({hitArea:new Phaser.Geom.Rectangle(0,0,this.width,this.height),hitAreaCallback:Phaser.Geom.Rectangle.Contains,cursor:"pointer"}),this.setOrigin(0,0),this.setFillStyle(t.color,0),this.setController((0,o.setupController)(t))}setTheme(e){}setController(e){e&&(this.controller=e,e.bindTo(this,(e=>this.onNewButtonState(e))))}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}onNewButtonState(e){switch(e){case n.ButtonState.Hover:case n.ButtonState.Down:this.setFillStyle(this.props.color,1);break;default:this.setFillStyle(this.props.color,0)}}updateLayout(){this.input.hitArea.setTo(0,0,this.width,this.height)}}},85671:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleStep=void 0;const s=i(37971),n=i(54825),o=i(36868),a=i(71021);class r extends s.LevelScript{constructor(e,t="main"){super(e),this.returnStep=t}activate(e){super.activate(),n.app.scene.playUI.updateState({tutorialArrow:e?.tutorialArrowTarget??null,tutorialFrame:e?.tutorialFrameTarget??null,worldMapPanel:e?.worldMapPanel??null}),this.onEvent(o.UserActions.EndTurn,(()=>{this.onEndTurn()})),this.onEvent(o.UserActions.Undo,(()=>{this.onUndo()})),this.onEvent(o.UserActions.UndoAll,(()=>{this.onUndo()})),this.onEvent(o.UserActions.ConfirmRewind,(()=>{this.onConfirmRewind()})),this.onEvent(o.UserActions.StartRewind,(()=>{this.onStartRewind()})),this.onEvent(o.GameStateEvents.NewGameState,(e=>{e.context!==a.NewGameStateContext.Undo&&this.goTo(this.returnStep)})),this.onEvent(o.GameStateEvents.FactionTurnStarted,(e=>{1===e.factionId&&this.onPlayerTurnStart()})),this.onEvent(o.UiEvents.RegionLedgerOpened,(()=>{this.onInspectLedger()})),this.onEvent(o.UiEvents.RegionLedgerClosed,(()=>{this.goTo(this.returnStep)})),this.onEvent(o.UiEvents.RegionSelected,(e=>{this.onRegionSelected(e)})),this.onEvent(o.GameStateEvents.HexCaptured,(e=>{this.onHexCaptured(e)})),this.onEvent(o.GameStateEvents.PawnMoved,(e=>{this.onPawnMoved(e)})),this.onEvent(o.GameStateEvents.PawnBought,(e=>{this.onPawnBought(e)}))}deactivate(){super.deactivate()}onConfirmRewind(){this.goTo(this.returnStep)}onRegionSelected(e){}onInspectLedger(){this.goTo(this.returnStep)}onEndTurn(){this.goTo(this.returnStep)}onUndo(){this.goTo(this.returnStep)}onStartRewind(){this.goTo(this.returnStep)}onHexCaptured(e){this.goTo(this.returnStep)}onPawnBought(e){this.goTo(this.returnStep)}onPawnMoved(e){this.goTo(this.returnStep)}onPlayerTurnStart(){this.goTo(this.returnStep)}}t.SimpleStep=r},85711:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Ref=void 0,t.ref=function(e){const t=(0,s.signal)(),i={current:e,set:e=>{e!==i.current&&(i.current=e,t.fire(e))},onChanged:t};return i},t.toValueAndRef=function(e){return n(e)?{ref:e,value:e.current}:{ref:void 0,value:e}},t.isRef=n;const s=i(18957);function n(e){return"object"==typeof e}t.Ref=class{constructor(e){this.current=e,this.onChanged=(0,s.signal)()}set(e){this.current!==e&&(this.current=e,this.onChanged.fire(e))}}},86148:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InteractiveMode=t.EXTRA_SPACE_FOR_CONTROL_PANEL=void 0;const s=i(90379),n=i(78933),o=i(7334),a=i(56824),r=i(2008),l=i(51887),c=i(42824),d=i(79705),h=i(54825),u=i(12784),p=i(19618),g=i(73230),m=i(88074),y=i(45933),f=i(91622),w=a.logger.for("WorldMapScene");t.EXTRA_SPACE_FOR_CONTROL_PANEL=100;class v extends s.BaseWorldMapMode{constructor(){super(...arguments),this.handlesPointerEvents=!0,this.zoomWithScrollWheel=!0}activate(){super.activate(),h.app.scene.worldMap.cameraController.setViewportMargins({}),h.app.device.disableContextMenu()}deactivate(){super.deactivate(),h.app.device.enableContextMenu()}isHexInteractive(e){return h.app.scene.play.mode.isHexInteractive(e)}applyWorldUpdates(e){super.applyWorldUpdates(e);const t=e.updates,i=this.scene.session();if(0===t.length)return Promise.resolve();w.group(`Apply world updates: \n${t.map((e=>" - "+e.type)).join("\n")}`);const s=h.app.scene.worldMap,f=t.map((t=>(0,o.withTimeout)(this.scene,async function(e,t,i){switch(t.type){case n.UpdateType.PawnsMoved:return(0,r.playPawnMove)(e,t,i);case n.UpdateType.HexTakeover:return(0,c.playHexCaptured)(e,t,i);case n.UpdateType.PawnsDestroyed:return(0,l.playPawnDestroy)(e,t);case n.UpdateType.PawnReplaced:return(0,d.playPawnReplaced)(e,t,i);case n.UpdateType.PawnSpawned:return(0,y.playPawnCreated)(e,t,i);case n.UpdateType.CoinTransaction:return(0,u.playCoinTransaction)(e,t,i);case n.UpdateType.FactionTurnStarted:return void e.chunkedRenderer.syncFaction(i,t.factionId,g.RenderLayerKey.Green);case n.UpdateType.FactionTurnOver:const s=p.Factions.model(i).byId(t.factionId)?.getRegions();return void(s&&e.syncTownVariantInRegions(i,s));case n.UpdateType.ManaCollected:return(0,m.playManaCollected)(e,t,i);case n.UpdateType.ManaChanged:return(0,m.playManaChanged)(e,t,i);default:throw new Error(`Unable to interpret ${t.type} => aborting smooth update and launching full map sync`)}}(s,t,e.stateAfter),2500).then((e=>{e===o.TIMEOUT&&i.isActive()&&w.error(`TIMED OUT while playing [${t.type}]: \n%s`,(0,o.prettyPrintObject)(t))}))));return Promise.all(f).then((()=>{console.groupEnd()})).catch((t=>{w.error(t.stack),a.errors.handleException(t),w.warning("One or more smooth world map updates failed, resorting to full sync."),s.syncState(e.stateAfter),console.groupEnd()}))}onSyncState(e){super.onSyncState(e),f.inject.ui.hexUnderCursor.update(h.app.scene.worldMap)}calculateWorldBounds(){const e=super.calculateWorldBounds();return e.height+=t.EXTRA_SPACE_FOR_CONTROL_PANEL,e}}t.InteractiveMode=v},86183:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shouldOfferSurrender=function(e){const t=s.Factions.model(e),i=t.all().filter((e=>e.isAlive()&&e.isLocalPlayer()));if(n.inject.gameStateModel.plugins.zombies)return!1;if(a.WorldMap.get(e).winConditions?.some((e=>"ally-everyone"===e.type)))return!1;if(1!==i.length)return!1;const l=i[0],c=n.inject.views.powerBalance.get(e);if(c.dominantFaction!==l)return!1;if(l.scaledPower/c.totalPower<.8)return!1;const d=t.all().map((e=>e.size)).reduce(r.sum);return!(l.size/d<.7||t.all().some((e=>e.persona?.race===o.Race.Undead)))};const s=i(19618),n=i(91622),o=i(90824),a=i(59956),r=i(9292)},86306:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionLedger=void 0;const s=i(86545),n=i(50575),o=i(20087),a=i(96137),r=i(76049);var l=Phaser.GameObjects.Text,c=Phaser.GameObjects.Rectangle;class d extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.labelTexts=[],this.valueTexts=[],this.lines=[],this.finalLine=h(this.scene),this.entries=[],this.xBreakpoints=[0,0,0,0],t&&(this.xBreakpoints=t),this.add(this.finalLine)}setLayout(e){this.xBreakpoints=e,this.width=e[3],this.updateLayout()}updateState(e){this._state=e,this.entries=e.entries,this.setEntryCount(e.entries.length);for(let t=0;t<e.entries.length;t++){const i=e.entries[t],s=this.labelTexts[t],n=this.valueTexts[t];s.setText(`${i.count} x ${i.label}`),n.setText(i.incomeEffect.toFixed()),i.incomeEffect<0?n.setColor(a.Colors.toCss(a.Colors.woodenUi.redText)):n.setColor(a.Colors.toCss(a.Colors.woodenUi.primaryText))}this.preUpdate.makeDirty()}setEntryCount(e){for(let t=this.labelTexts.length;t<e;t++){const e=new n.RichText(this.scene,0,0,"",{color:a.Colors.woodenUi.primaryText,fontFamily:r.FontFamily.Roboto,fontSize:"14px"}),t=new l(this.scene,0,0,"",{fontFamily:"Roboto, Verdana, Arial",fontSize:"14px"}),i=h(this.scene);this.add([e,t,i]),this.labelTexts.push(e),this.valueTexts.push(t),this.lines.push(i)}for(let t=0;t<this.labelTexts.length;t++)this.labelTexts[t].setVisible(t<e),this.valueTexts[t].setVisible(t<e),this.lines[t].setVisible(t<e)}updateLayout(){const[e,t,i,s]=this.xBreakpoints,n=7+(this.labelTexts[0]?.height??0);o.Arrange.topToBottom({content:this.labelTexts,y:7,origin:0,spacing:7}),o.Arrange.topToBottom({content:this.valueTexts,y:7,origin:0,spacing:7}),o.Arrange.topToBottom({content:this.lines,y:2,origin:0,spacing:n-1}),o.Arrange.alignX({content:this.labelTexts,x:t,origin:0}),o.Arrange.alignX({content:this.valueTexts,x:i,origin:1});for(const t of this.lines)t.x=e,t.width=s-e;this.finalLine.setPosition(e,n*this.entries.length+3),this.finalLine.width=s-e,this.updateSize()}calculateHeight(){const e=this.labelTexts[this.entries.length-1];return e?e.y+e.height:0}}function h(e){return new c(e,0,0,0,1).setOrigin(0,0).setFillStyle(a.Colors.woodenUi.darkerPergamen,1)}t.RegionLedger=d},86545:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveContainer=t.AutoSizeResponsiveContainer=t.AutoWidthResponsiveContainer=t.AutoHeightResponsiveContainer=t.BaseResponsiveContainer=void 0;const s=i(897),n=i(72349),o=i(41856),a=i(59019),r=i(46914),l=i(97849);var c=Phaser.GameObjects.Container,d=Phaser.Geom.Rectangle;class h extends c{constructor(e){super(e),this.updateList=[],this.autoInteractive=!1,this.renderedLastFrame=!1,this.preUpdate=(0,s.whenDirty)((()=>{this.updateLayout(),this.autoInteractive&&this.input?.hitArea&&(this.input.hitArea=new d(this.width/2,this.height/2,this.width,this.height))}),(()=>{this.debugRect?.update(),this.willRender()?(this.preUpdateChildren(),this.renderedLastFrame=!0):this.renderedLastFrame&&(this.preUpdateChildren(),this.renderedLastFrame=!1)}))}on(e,t,i){return super.on(e,t,i)}add(e){l.assert.defined(e),super.add(e);let t=Array.isArray(e)?e:[e];for(let e of t)(0,s.hasPreUpdate)(e)&&this.updateList.push(e);return this}preUpdateChildren(){for(let e of this.updateList)e.preUpdate()}setSizeToFrame(e){throw new Error("not implemented")}setInteractiveAuto(e="pointer"){this.autoInteractive=!0,this.setInteractive({cursor:e,hitArea:new d(this.width/2,this.height/2,this.width,this.height),hitAreaCallback:d.Contains})}willRender(e){return super.willRender(e)&&(!this.parentContainer||this.parentContainer.willRender(e))}showDebugOutline(){this.debugRect?this.debugRect.update():this.debugRect=new r.DebugRectangle(this)}}class u extends h{handleChildResize(e){this.preUpdate.makeDirty()}constructor(e){super(e),n.ResponsiveSizeComponent.overrideSizeComponent(this)}}t.BaseResponsiveContainer=u,t.AutoHeightResponsiveContainer=class extends h{constructor(e){super(e),o.AutoHeightComponent.overrideSizeComponent(this)}get height(){return super.height}handleChildResize(e){this.preUpdate.makeDirty()}},t.AutoWidthResponsiveContainer=class extends h{constructor(e){super(e),a.AutoWidthComponent.overrideSizeComponent(this)}get width(){return super.width}handleChildResize(e){this.preUpdate.makeDirty()}},t.AutoSizeResponsiveContainer=class extends h{constructor(e){super(e);const t=new a.AutoWidthComponent(this),i=new o.AutoHeightComponent(this);Object.defineProperties(this,{width:{get:()=>t.width},height:{get:()=>i.height},updateSize:{value:()=>{t.updateSize(!1),i.updateSize()}}})}handleChildResize(e){this.preUpdate.makeDirty()}},t.ResponsiveContainer=class extends u{updateLayout(){}}},86815:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ComponentWithAttachments=void 0;const s=i(86545),n=i(20087);class o extends s.AutoHeightResponsiveContainer{constructor(e,t){super(e),this.props={component:t.component,leftAttachments:t.leftAttachments||[],rightAttachments:t.rightAttachments||[],spacing:t.spacing??4,originY:t.originY??.5},t.width&&(this.width=t.width),this.add([...this.props.leftAttachments,t.component,...this.props.rightAttachments])}handleChildResize(e){this.preUpdate.makeDirty()}updateLayout(){const e=this.width-this.props.leftAttachments.reduce(((e,t)=>e+t.width),0)-this.props.rightAttachments.reduce(((e,t)=>e+t.width),0)-this.props.spacing*(this.props.leftAttachments.length+this.props.rightAttachments.length);this.props.component.width=e,n.Arrange.leftToRight({content:[...this.props.leftAttachments,this.props.component],x:0,origin:0,spacing:this.props.spacing}),n.Arrange.leftToRight({content:this.props.rightAttachments,x:this.width,origin:1}),n.Arrange.alignY({content:[...this.props.leftAttachments,...this.props.rightAttachments],y:this.props.component.height/2,origin:this.props.originY}),this.updateSize()}calculateHeight(){return this.props.component.height}}t.ComponentWithAttachments=o},87047:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelFeaturesGallery=void 0;const s=i(86545),n=i(20087),o=i(54825),a=i(34174),r=i(2297);var l=Phaser.GameObjects.Image;class c extends s.AutoWidthResponsiveContainer{constructor(e,t){super(e),this.options=t,this.images=[],this.shadows=[],this.displayedImagesCount=0}isEmpty(){return 0===this.displayedImagesCount}updateState(e){this.displayedImagesCount=e.length;for(let t=0;t<e.length;t++){const i=e[t];if(this.images.length<=t){const e=new l(this.scene,0,0,"atlas",`ui/level-features/${i.id}`);this.options.interactive&&e.setInteractive({cursor:"pointer"}),e.setOrigin(0,0);const t=new l(this.scene,0,0,"atlas","pawn-shadow").setScale(.5).setAlpha(.75).setOrigin(0,0);this.shadows.push(t),this.images.push(e),this.add(t),this.add(e)}const s=this.images[t];s.setFrame(`ui/level-features/${i.id}`),this.options.interactive&&s.setData("tooltip",i.description).on("pointerdown",(()=>{console.log(o.app.tooltips.currentTooltip),setTimeout((()=>o.app.tooltips.show({type:r.TooltipType.Hover,title:s.getData("tooltip"),placement:a.Placement.aroundUiObject(s),delayMs:0})),10)})).on("pointerout",(()=>{o.app.tooltips.close()})),this.images[t].setVisible(!0),this.shadows[t].setVisible(!0)}for(let t=e.length;t<this.images.length;t++)this.images[t].setVisible(!1),this.shadows[t].setVisible(!1);this.updateLayout()}updateLayout(){n.Arrange.leftToRight({content:this.shadows,spacing:8,origin:0,x:0});for(let e=0;e<this.images.length;++e)this.images[e].setPosition(this.shadows[e].x+this.shadows[e].width/2-this.images[e].width/2,2-this.images[e].height);this.updateSize()}calculateWidth(){if(0===this.displayedImagesCount)return 0;const e=this.images[this.displayedImagesCount-1];return e.x+e.width}}t.LevelFeaturesGallery=c},87310:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelSessionEndWatcher=t.AIEarlyExitException=t.SessionAbortedError=void 0,t.isSessionAbortedError=function(e){return"object"==typeof e&&e.isSessionAbortedError},t.isEarlyExitException=function(e){return"object"==typeof e&&e.isEarlyExitException};const s=i(91622),n=i(54825),o=i(56824);class a extends Error{constructor(){super("Level Session Ended"),this.isSessionAbortedError=!0}}t.SessionAbortedError=a;class r extends Error{constructor(){super("AI turn ended early due to game-winning move"),this.isEarlyExitException=!0}}t.AIEarlyExitException=r,t.LevelSessionEndWatcher=class{constructor(){this.worldMapSessionId=n.app.scene.worldMap.currentSessionId,this.levelSessionId=s.inject.levelSession.id}throwIfAborted(){if(!o.config.debug.ai&&(this.levelSessionId!==s.inject.levelSession.id||this.worldMapSessionId!==n.app.scene.worldMap.currentSessionId))throw new a}isAborted(){return this.levelSessionId!==s.inject.levelSession.id}}},87452:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.spawnPresents=function(e,t){const i=e.factions.all().filter((e=>!e.isNeutral()&&function(e){const t=s.inject.views.behaviorSummary.get(e.state,e.id).mightUsedForConquest;return 0===Object.keys(t).length}(e))),r=e.pawns.select({type:[o.PawnType.Spawner]});if(r.length>0)for(let i of r){const s=i.hex.neighbours((t=>!e.warfare.isImpassable(t)&&!e.warfare.isOccupied(t)));0!==s.length&&d(e,s,i.hex,t)}else{const s=e.factions.neutral.hexes.filter((t=>a.AI.getHexDepth(e.state,t.id)>1&&!e.warfare.isOccupied(t))),o=n.HexGroup.union([s,...i.map((t=>t.hexes.filter((t=>!e.warfare.isOccupied(t)))))]);d(e,o,void 0,t)}};const s=i(91622),n=i(20693),o=i(24598),a=i(70712),r=i(54825),l=i(98963),c=i(35800);function d(e,t,i,s){const n=(0,c.deterministicRandomHexFrom)(e,t);n&&(s.create({hex:n,type:o.PawnType.Present,sourceHex:i,captureHex:!1,tapUnit:!1}),r.app.audio.playEffect(l.SoundEffects.TwinkleChimes))}},87521:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Pool=void 0;const s=i(56824).logger.for("Pool");t.Pool=class{constructor(e,t={}){this.factory=e,this.options=t,this.freeInstances=new Set,this.usedInstances=new Set}preload(e){for(;this.freeInstances.size<e;)this.freeInstances.add(this.factory());return this}take(){let e=this.freeInstances.values().next().value;return e?this.freeInstances.delete(e):e=this.factory(),this.usedInstances.add(e),e}free(e){this.usedInstances.has(e)?(this.options.onReturn&&this.options.onReturn(e),this.usedInstances.delete(e),this.freeInstances.add(e)):s.warning(`redundant attempt to free ${e} - it is not marked as used in the Pool`)}freeAll(){this.usedInstances.forEach((e=>this.freeInstances.add(e))),this.usedInstances.clear()}getUsageStats(){return`${this.usedInstances.size}/${this.usedInstances.size+this.freeInstances.size}`}toString(){this.getUsageStats()}}},87544:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HLayout=void 0;const s=i(86545),n=i(20087),o=i(54118);var a=Phaser.GameObjects.BitmapText;class r extends s.AutoWidthResponsiveContainer{constructor(e,t){super(e),this.props={layoutPolicy:o.LayoutChildrenPolicy.Stretch,originX:0,originY:0,horizontalPadding:0,verticalPadding:0,...t},this.add(t.content),t.height?this.height=t.height:this.height=Math.max(...t.content.map((e=>e.height)))}handleChildResize(e){this.preUpdate.makeDirty(),this.updateSize()}updateLayout(){const e=this.props.content;if(this.props.layoutPolicy===o.LayoutChildrenPolicy.Stretch)for(let t of e)t instanceof a||(t.height=this.height);n.Arrange.leftToRight({content:e,x:this.props.horizontalPadding+this.width*this.props.originX,origin:this.props.originX??0,spacing:this.props.spacing}),n.Arrange.alignY({content:e,y:(this.height-2*this.props.verticalPadding)*this.props.originY,origin:this.props.originY??0}),this.updateSize()}calculateWidth(){const e=this.props.content[0],t=this.props.content[this.props.content.length-1];return e&&t?t.x+t.width-e.x:0}}t.HLayout=r},87790:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showErrorNotification=function(e,t){try{e.notifications.addToast({style:n.NotificationStyle.Alert,category:n.NotificationCategory.Error,icon:new s(a.app.scene.globalUI,0,0,"atlas","ui/icons/dead"),content:new o.CallToActionForm(a.app.scene.globalUI).applyProps({title:"Well... This was not supposed to happen.",content:l(t),action:"RELOAD",async onSubmit(){r.inject.levelSession.end({origin:"error/reload",wipeAutoSave:!1}),await a.app.reporting.sendTelemetryEvents(),window.location.reload()}}),scope:n.NotificationScope.Global})}catch(e){console.warn("Couldn't show error notification",e)}};var s=Phaser.GameObjects.Image;const n=i(1565),o=i(76356),a=i(54825),r=i(91622);function l(e){return window.navigator.onLine?`The game just encountered an unexpected error, sorry about that!\nAn error report was already sent and I will be looking into it!\n\nSince the game is now most likely stuck in a broken state, you should reload the page.\nDon't worry, you won't lose any progress!\n\n(error_id="${e}")`:`The game just encountered an unexpected error, sorry about that!\n\nSince the game is now most likely stuck in a broken state, you should reload the page.\nDon't worry, you won't lose any progress!\n\n(error_id="${e}")`}},87936:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NINE_HEXES_POLYGON=t.NINE_HEXES_POLYGON_RELATIVE=t.HEX_POLYGON=t.HEX_ANGLED_HEIGHT=t.HEX_INNER_HEIGHT=t.HALF_HEX_HEIGHT=t.HEX_HEIGHT=t.HALF_HEX_WIDTH=t.HEX_WIDTH=void 0,t.HEX_WIDTH=48,t.HALF_HEX_WIDTH=t.HEX_WIDTH/2,t.HEX_HEIGHT=48,t.HALF_HEX_HEIGHT=t.HEX_HEIGHT/2,t.HEX_INNER_HEIGHT=36,t.HEX_ANGLED_HEIGHT=t.HEX_HEIGHT-t.HEX_INNER_HEIGHT;const i=[[-.5,-.25],[0,-.5],[.5,-.25],[.5,.25],[0,.5],[-.5,.25]].map((([e,t])=>({x:e,y:t})));function s(e,t,i){return e.map((({x:e,y:s})=>({x:e+t,y:s+i})))}function n(e){return e.map((({x:e,y:i})=>({x:e*t.HEX_WIDTH,y:i*t.HEX_HEIGHT})))}t.HEX_POLYGON=n(s(i,.5,.5)),t.NINE_HEXES_POLYGON_RELATIVE=[[-1,-1],[-.5,-1.25],[0,-1],[.5,-1.25],[1,-1],[1,-.5],[1.5,-.25],[1.5,.25],[1,.5],[1,1],[.5,1.25],[0,1],[-.5,1.25],[-1,1],[-1,.5],[-1.5,.25],[-1.5,-.25],[-1,-.5]].map((([e,t])=>({x:e,y:t}))),t.NINE_HEXES_POLYGON=n(s(t.NINE_HEXES_POLYGON_RELATIVE,.5,.5))},88023:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImmutableSet=t.ImmutableMap=void 0;var s=i(49568);Object.defineProperty(t,"ImmutableMap",{enumerable:!0,get:function(){return s.Map}});var n=i(49568);Object.defineProperty(t,"ImmutableSet",{enumerable:!0,get:function(){return n.Set}})},88074:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playManaCollected=async function(e,t,i){const r=e.objectsPool.getManaGlobe(),l=(0,n.getHex)(t.scrHex),c=(0,n.getHex)(t.destHex),d=e.session(),h=(0,a.euclidDistance)({x:l.display.centerX,y:l.display.centerY},{x:c.display.centerX,y:c.display.centerY});e.tweens.add({targets:r,x:{from:l.display.centerX,to:c.display.centerX},y:{from:l.display.centerY-10,to:c.display.centerY},duration:6*h,ease:"Sine.easeInOut",onComplete:()=>{e.objectsPool.free(r),d.isActive()&&s.app.scene.worldMap.torches.addMana(o.inject.currentGameState,(0,n.getHex)(t.destHex))}})},t.playManaChanged=async function(e,t,i){s.app.scene.worldMap.torches.syncHex(i,(0,n.getHex)(t.hex))};const s=i(54825),n=i(45664),o=i(91622),a=i(49796)},88128:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleConflictBetweenRemoteAndSyncedProgress=async function(e){const t=o.inject.userData.current.progress.synced,i=c(t,e);if(i.levelsProgressMissingOnRemote.length||i.countersLowerOnRemote.length){const t=Object.keys(o.inject.userData.getProgressData().completedLevels).length,i=Object.keys(e.completedLevels).length;return await a.app.modals.simpleDialog({title:"Cloud sync conflict",message:`There is an unexpected mismatch between your progress on this device and your cloud backup. You can:\n- [b]Keep[/b] the additional progress on this device (${t} completed levels, recommended)\n- [b]Reset[/b] your progress back to your cloud backup (${i} complete levels, your local progress wil be lost)`,buttons:[{text:r.DialogButtons.Reset,role:l.DialogButtonRole.PrimaryDanger},{text:r.DialogButtons.Keep,role:l.DialogButtonRole.PrimaryGreen}]})===r.DialogButtons.Reset?"wipe-local":"upload-local"}return(0,s.isEqual)(e,t)?"no-changes":"no-conflict"},t.validateRemoteProgressData=c;const s=i(2543),n=i(83240),o=i(91622),a=i(54825),r=i(5365),l=i(63032);function c(e,t){const i=(0,s.uniq)([...Object.keys(e.counters),...Object.keys(t.counters)]),o=(0,n.mergeProgressData)(e,t);let a=[];for(const i of Object.keys(e.completedLevels))(0,s.isEqual)(o.completedLevels[i],t.completedLevels[i])||a.push(i);let r=[];for(const s of i)(e.counters[s]??0)>(t.counters[s]??0)&&r.push(s);return{countersLowerOnRemote:r,levelsProgressMissingOnRemote:a}}},88389:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleButtonStateController=void 0;const s=i(18957),n=i(98963),o=i(22663),a=i(54825);t.SimpleButtonStateController=class{constructor(e){this.options=e,this.enabled=!0,this.state=o.ButtonState.Rest,this.onClicked=(0,s.signal)(),this.onStateChanged=(0,s.signal)(),this.options.onClicked&&this.onClicked((()=>this.options.onClicked()))}getState(){return this.state}bindTo(e,t){this.applyState=t,e.removeAllListeners(),e.on("pointerover",(()=>{this.state===o.ButtonState.Rest&&this.setState(o.ButtonState.Hover)})).on("pointerout",(()=>{this.enabled?this.setState(o.ButtonState.Rest):this.setState(o.ButtonState.Disabled)})).on("pointerdown",(()=>{this.enabled?(this.setState(o.ButtonState.Down),this.playSoundEffect(n.SoundEffects.ButtonDown)):this.playSoundEffect(n.SoundEffects.Deny)})).on("pointerup",(e=>{this.enabled&&this.state===o.ButtonState.Down&&(this.onClicked.fire(e),this.setState(o.ButtonState.Hover),this.playSoundEffect(n.SoundEffects.ButtonUp))})),t(this.state)}playSoundEffect(e){!1!==this.options.audio&&a.app.audio.playEffect(e)}setState(e){const t=this.state;e!==this.state&&(this.state=e,this.onStateChanged.fire({newState:e,oldState:t}),this.applyState(e))}setEnabled(e){if(this.enabled===e)return!1;this.enabled=e,this.setState(e?o.ButtonState.Rest:o.ButtonState.Disabled)}}},88410:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AITurnDurationEstimator=t.AIController=void 0,t.selectStrategy=function(e){return o.defaultStrategy};const s=i(56824),n=i(69447),o=i(83958),a=i(68649),r=i(91622),l=i(90952),c=i(36868),d=i(87310),h=i(53948),u=i(24598),p=s.logger.for("ai:controller");t.AIController=class{constructor(){this.dataLayer=new a.DefaultAIDataLayer,this.allowSurrender=!0,this.debug=!1,this.waitEstimator=new g}async play(e){s.events.trigger(c.SystemEvents.FactionAiBegin({factionId:e.id})),this.gameController=r.inject.gameStateController,r.inject.gameStateModel.stateEngine.activate(...l.EXPENSIVE_AI_PROJECTIONS),this.gameController.beginTransaction(),this.debug=!0===s.config.debug.ai;const t=e.getRegions().filter((e=>e.isAlive())).sort(((e,t)=>e.hexes.length-t.hexes.length));for(let i of t){i.updateFrom(r.inject.gameStateController.currentState),s.events.trigger(c.SystemEvents.RegionAiBegin({regionId:i.id}));const t=e.persona.aiStrategy;if(!i.exists)continue;r.inject.debugData.set("AI",`faction ${e.id}, region ${i.id}`);const o=new n.RegionAIContext(i);o.maxAllowedUnitMight=this.maxAllowedUnitMight,o.debug=!0===s.config.debug.ai||s.config.debug.ai===i.id,p.info(`> AI playing region #${i.id}`);try{await t(o)}catch(e){if((0,d.isSessionAbortedError)(e))return p.warning("> AI interrupted by new session, aborting."),"session-aborted";if(!(0,d.isEarlyExitException)(e))throw e;p.info("> AI made a game-winning move, short-circuiting.")}}return this.gameController.commitTransaction(),s.events.trigger(c.SystemEvents.FactionAiEnd({factionId:e.id})),"success"}};class g{constructor(){this.estimator=new h.Estimator("ai-turn-duration",50),this.tStart=0,s.events.on(c.SystemEvents.FactionAiBegin,(({factionId:e})=>{const t=r.inject.gameStateModel.factions.byId(e);t&&(this.currentlyPlayingFaction=e,this.currentlyPlayingFactionEstimate=m(t),this.tStart=Date.now())})),s.events.on(c.SystemEvents.FactionAiEnd,(({factionId:e})=>{if(this.currentlyPlayingFaction!==e||!this.tStart||!this.currentlyPlayingFactionEstimate)return;const t=Date.now()-this.tStart;this.estimator.learn(this.currentlyPlayingFactionEstimate,t)}))}getEstimateFor(e){return e&&e.exists&&e.isAlive()&&e.controller===u.FactionController.Ai?this.estimator.estimate(m(e)):0}}function m(e){let t=0;for(let i of e.getLiveRegions()){const e=i.getEnemyAssets();t+=e.getBuyableMight(),t+=e.totalUnits.count()}return t}t.AITurnDurationEstimator=g},88424:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.HexFromGroupSelection=void 0,function(e){e.Random="random",e.Leftmost="leftmost",e.Rightmost="rightmost",e.Topmost="topmost",e.Bottommost="bottommost"}(i||(t.HexFromGroupSelection=i={}))},88744:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StorybookAppController=void 0;const s=i(56824),n=i(36868),o=i(27126),a=i(25e3),r=i(2520),l=i(15350),c=i(54825),d=i(81700),h=i(42383),u=i(23636);s.logger.for("AppController"),t.StorybookAppController=class{constructor(){this.initialized=!1}getScenes(){return[o.PreloadScene,l.StorybookScene,h.StorybookMenuScene,r.GlobalUIScene,u.DropdownUIScene]}run(){s.events.on(n.SystemEvents.EngineInitialized,(()=>{a.NewsBox.hide(),[d.Scenes.Storybook,d.Scenes.StorybookMenu,d.Scenes.GlobalUI,d.Scenes.DropdownUI].forEach((e=>c.app.game.scene.run(e)))})),this.initialized=!0}}},88823:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LINT_RULES=t.SetDefaultWinConditions=t.NoOverlyLongRegionNames=void 0,t.lintLevel=function(e,i){const s=i.rules??Object.values(t.LINT_RULES),n=i.fix??!1,o=i.log??console.log;let a=[];for(const t of s){const s=t(e,i);s&&(n&&s.fix?(o("fixing: "+s.error),e=s.fix()):a.push(s.error??"unknown error"))}return{fixedState:e,errors:a}},t.shiftMap=p;const s=i(72273),n=i(20693),o=i(45664),a=i(24598),r=i(67274),l=i(7334),c=i(2543),d=i(88424),h=i(56824),u=i(18497);function p(e,t,i){const s=!!(i%2);function n(e){let n=Math.trunc(e/o.GRID_MAX_DIMENSION)%2==0&&s?1:0;return e+t+o.GRID_MAX_DIMENSION*i+n}return e.regions=e.regions.map((e=>({...e,hexes:e.hexes.map((e=>n(e)))}))),e.pawns=e.pawns.map((e=>({...e,hex:n(e.hex)}))),e}t.NoOverlyLongRegionNames=e=>{let t=[...e.regions],i=[];for(let e of t)(e.name?.length??0)>12&&(i.push(e.name),e.name=h.random.townName(12));return i.length>0?{error:`Overly long region names: ${i.join(", ")}`,fix:()=>({...e,regions:t})}:null},t.SetDefaultWinConditions=e=>e.map.winConditions?null:e.factions.some((e=>"lich"===e.persona))?{error:"Missing win condition for map with necromancer",fix:()=>({...e,map:{...e.map,winConditions:[{type:"defeat-rival",factionId:6}]},factions:e.factions.map((e=>"lich"===e.persona?{...e,name:"The Necromancers"}:e))})}:e.map.plugins.includes(u.PluginKey.Zombies)?{error:"Missing win condition for map with zombies",fix:()=>({...e,map:{...e.map,winConditions:[{type:"destroy-haunted-towns"},{type:"defeat-all-rivals"}]}})}:null,t.LINT_RULES={CorrectLevelId:(e,t)=>t.assertLevelId?e.map.levelId===t.assertLevelId?null:{error:`CorrectLevelId: expected levelId "${t.assertLevelId}", found "${e.map.levelId}"`,fix:()=>({...e,map:{...e.map,levelId:t.assertLevelId}})}:null,NoEmptyRegions:e=>{const t=e.regions.filter((e=>e.hexes.length>0));return t.length===e.regions.length?null:{error:"NoEmptyRegions: map contains empty regions",fix:()=>({...e,regions:t})}},NoExtraSpace:e=>{const t=new s.GameStateModel(e);t.activateAllProjections();let i=n.HexGroup.union(t.regions.all().map((e=>e.hexes)));if(0===i.length)return null;const o=i.getHex(d.HexFromGroupSelection.Topmost).r-1,a=i.getHex(d.HexFromGroupSelection.Leftmost).c-1,r=i.getHex(d.HexFromGroupSelection.Rightmost).c+1,l=i.getHex(d.HexFromGroupSelection.Bottommost).r+1;return o>0||a>1||r+1<t.map.width||l+1<t.map.height?{error:"NoExtraSpace: map can be cropped",fix:function(){(o>0||a>0)&&(e=p(e,-a,-o)),i=n.HexGroup.union(t.restore(e).regions.all().map((e=>e.hexes)));const s=i.getHex(d.HexFromGroupSelection.Rightmost).c+1+1,r=i.getHex(d.HexFromGroupSelection.Bottommost).r+1+1;return e.map={...e.map,width:s,height:r},e}}:null},InitialPhaseSet:(e,t)=>{const i={...(0,r.createBlankGameState)("").currentPhase,tappedUnits:[]};return(0,c.isEqual)(e.currentPhase,i)?null:{error:`InitialPhaseSet: found unexpected data in currentPhase\n ${(0,l.prettyPrintObject)(e.currentPhase)}"`,fix:()=>({...e,currentPhase:i})}},NoInvalidForests:e=>{const t=e.pawns.filter((e=>e.type===a.PawnType.Forest)),i=[];for(const s of t){const t=e.regions.find((e=>e.hexes.includes(s.hex)));if(!t){i.push(s);continue}const n=e.factions.find((e=>e.regions.includes(t.id)));n&&0===n.id||i.push(s)}return i.length?{error:`NoInvalidForest: found ${i.length} forests outside of neutral regions`,fix:()=>({...e,pawns:e.pawns.filter((e=>!i.includes(e)))})}:null},NoReplayAttached:(e,t)=>e.replay?{error:"Level contains a replay history",fix:()=>{const t={...e};return delete t.replay,t}}:null,NoHexHistory:e=>{const t=Object.keys(e.hexHistory??{}).length;return t>0?{error:`level contains HexHistory data for ${t} hexes`,fix:()=>({...e,hexHistory:{}})}:null},NoAttrition:e=>{if(!e.factions.some((e=>e.attrition))&&!e.regions.some((e=>e.attrition)))return null;const t=e.factions.map((e=>({...e,attrition:void 0}))),i=e.regions.map((e=>({...e,attrition:void 0})));return{error:"NoAttrition: map contains regions or factions with non-zero attrition",fix:()=>({...e,regions:i,factions:t})}},MapOptionsV2:e=>e.map.theme||!e.map.plugins?{error:"MapOptionsV2: map contains old metadata (theme instead of plugins)",fix:()=>{const t=(0,c.cloneDeep)(e.map);return delete t.theme,t.plugins=t.plugins??[],{...e,map:t}}}:null,NoOverlyLongRegionNames:t.NoOverlyLongRegionNames,SetDefaultWinConditions:t.SetDefaultWinConditions,NoDuplicatePawns:e=>{const t=new Set,i=[],s=new Set;for(const n of e.pawns){const e=`${n.type}@${n.hex}`;t.has(e)&&(i.push(n.id),s.add(n.type)),t.add(e)}return 0===i.length?null:{error:`NoDuplicatePawns: found ${i.length} duplicate pawns (${Array.from(s).join(", ")})`,fix:()=>({...e,pawns:e.pawns.filter((e=>!i.includes(e.id)))})}}}},89069:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defeatTransitionOut=async function(){const e=s.app.scene.defeat,t=n.config.screenTransitionDuration;return new Promise((i=>{e.tweens.add({targets:[e.menuButton,e.restartButton,e.rewindButton,e.replayButton],y:{to:"+=160"},alpha:{from:1,to:0},duration:t,onComplete:i}),e.tweens.add({targets:[e.background,e.ribbonText],alpha:{from:1,to:0},duration:t,ease:"Sine.easeInOut"}),e.tweens.add({targets:e.ribbon,x:{from:e.ribbon.x,to:e.ribbon.x+150},width:{from:400,to:100},alpha:{from:1,to:0},duration:t,ease:"Sine.easeInOut"}),e.tweens.add({targets:e.gravestone,y:{from:e.gravestone.y,to:e.gravestone.y+40},duration:t,scale:{from:1,to:.1},alpha:{from:1,to:0},ease:"Sine.easeInOut"})}))};const s=i(54825),n=i(56824)},89262:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BlockTownAccessPlan=void 0;const s=i(91622),n=i(89764),o=i(8065),a=i(17565),r=i(20276),l=i(56824),c=i(78635),d=i(19162),h=i(70712),u=i(7334),p=i(20693),g=i(9292),m=l.logger.for("BlockTownAccessPlan");t.BlockTownAccessPlan=class{constructor(e){this.endsTurn=!1,this.isConquest=!0,this.score=e.isLifeOrDeath?1e3:(0,o.aggregateScoreFactors)(e.utilityFactors),this.hex=e.hex,this.hexes=p.HexGroup.from(e.candidateHexes),this.townHex=e.townHex,this.might=e.might,this.maxMight=e.maxMight,this.townSecurityBaseline=e.townSecurityBaseLine,this.isLifeOrDeath=e.isLifeOrDeath,this.candidateHexes=e.candidateHexes,this.utilityFactors=e.utilityFactors,this.allowCastles=e.allowCastles}execute(e){for(let t=this.might;t<=(0,g.pickSmaller)(this.maxMight,e.maxAllowedUnitMight??99);++t)if(this.tryWithMight(e,t,t===this.maxMight))return this.isLifeOrDeath&&(e.forceAction=!1),!0;return!1}tryWithMight(e,t,i){const o=this.candidateHexes.filter((i=>!(e.region.hexes.has(i)&&c.Warfare.getHexDefenseWithoutMovableUnits(e.state,i)>t)&&c.Warfare.canConquerHexWith(e.state,i,t))),l=e.faction,d=n.RegionAssets.fromMyRegion(e.region).useUnit({requiredMight:t,allowOverkill:!0,maxAllowedMight:s.inject.ai.maxAllowedUnitMight});if(!d)return m.warning(`discarding invalid plan - unable to gather might ${t}`),!1;let h=e.game.createCheckpoint(),u=h,p=this.townSecurityBaseline,g=0,y=!1;for(;o.length&&(g<1||!y);){const s=o.shift();if(y=!1,!(2===t&&c.Warfare.canBuildCastleAt(e.state,s,e.region.id)&&this.allowCastles?e.marshal.buildCastle(s,2):e.marshal.moveUnit(s,d))){e.game.restoreCheckpoint(h);continue}const n=new a.ThreatAssessment(l),m=new r.SecurityView({faction:l,threatAssessment:n,recklessness:e.focus.daring},"block town access helper");g=m.get(this.townHex.id),g<=.99?(g>p&&i&&this.isViableDefense(e,m,s,t)&&(y=!0,u=e.game.createCheckpoint(),p=g),e.game.restoreCheckpoint(h)):this.isViableDefense(e,m,s,t)?y=!0:e.game.restoreCheckpoint(h)}return!(!y||1!==g)||(p>this.townSecurityBaseline?(e.game.restoreCheckpoint(u),!0):(e.game.restoreCheckpoint(h),!1))}isViableDefense(e,t,i,s){if(this.isLifeOrDeath)return!0;const n=h.AI.getHexImportance(e.state,i.id).distanceFromTown;return!(n<=1&&s>=3&&!this.isLifeOrDeath)&&!(e.region.hexes.floodFillFrom(this.townHex,(i=>t.get(i.id)>=.5||h.AI.getHexImportance(e.state,i.id).distanceFromTown<n)).length<(d.Rules.model(e.state).unitByMight(s)?.upkeep??0))}hash(){return`Block town access ${this.candidateHexes.map((e=>e.id)).join("->")} with might range ${this.might}-${this.maxMight} #${this.hex.id} ${this.isLifeOrDeath?"(DESPERATE)":""}`}toString(){return`[${(0,u.formatNumber)(this.score)} | ${this.hash()}]`}toDebugString(){return(0,o.describeScoreFactors)(this.utilityFactors)+`security baseline: ${this.townSecurityBaseline.toFixed(2)}\ncandidates: ${this.candidateHexes.map((e=>e.id)).join("->")}\nmight range: ${this.might}..${this.maxMight}\nis life or death: ${this.isLifeOrDeath}\n`}}},89413:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CloudSyncService=t.Collections=t.CloudSyncState=void 0;const s=i(91622),n=i(54825),o=i(70080),a=i(56824),r=i(96130),l=i(8482),c=i(36868),d=i(5365),h=i(63032),u=i(13419),p=i(11585),g=i(2543),m=i(10131),y=a.logger.for("CloudSync");var f,w;function v(e){return!e.levels&&!!e.progress}!function(e){e.Disabled="disabled",e.NotAvailable="not-available",e.Synchronizing="syncing",e.Synchronized="synced"}(f||(t.CloudSyncState=f={})),function(e){e.userdata="userdata",e.userdataKongregate="userdata_kongregate",e.telemetryEvents="telemetry_events_v2"}(w||(t.Collections=w={})),t.CloudSyncService=class{constructor(){this.status=(0,r.watchable)(f.Synchronizing),this.uploadQueue=(0,l.simpleAsyncJobQueue)(),this.max5perMinute=new p.RateLimiter(5,1),this.max100perDay=new p.RateLimiter(100,1440),this.initialize=(0,m.asyncInitializer)((()=>{s.inject.login.state.watch((e=>{if(e===o.LoginState.SignedIn)if(this.currentUserId=s.inject.login.getUserId(),s.inject.login.state()===o.LoginState.SignedIn){const e=this.currentUserId;this.status.set(f.Synchronized),this.remoteListenerUnsub?.(),this.remoteListenerUnsub=s.inject.userDataCloudStorage.onSnapshot((t=>{this.handleNewDoc(t.data(),e)}))}else this.status.set(f.Disabled)})),a.events.on(c.SystemEvents.LocalProgressUpdated,(e=>{s.inject.login.state()===o.LoginState.SignedIn&&this.uploadLocalProgress()})),a.events.on(c.SystemEvents.LocalProgressWiped,(e=>{s.inject.login.state()===o.LoginState.SignedIn?s.inject.userDataCloudStorage.updateDoc({progress:{completedLevels:{}},levels:null}):s.inject.userData.current.metadata.cloudSyncUserId&&n.app.notifications.info("Progress wiped","Since you are currently not logged into your cloud sync account, the progress wipe will be applied to the local data only and restored if you log in. To propagate the wipe to the cloud, first sign in, then clear your progress again.")}))})),this.uploadQueue.status.watch((e=>{switch(e){case l.QueueStatus.Idle:this.status()===f.Synchronizing&&this.status.set(f.Synchronized);break;case l.QueueStatus.Processing:this.status.set(f.Synchronizing)}}))}uploadLocalProgress(){if(s.inject.userData.hasUnsyncedProgressData()){if(!this.max100perDay.check())return void a.errors.handleNonFatalError("Hit daily limit of max cloud sync updates","CloudSyncService");if(!this.max5perMinute.check())return void a.errors.handleNonFatalError("Hit limit of max cloud sync updates per minute","CloudSyncService");this.status.set(f.Synchronizing);const e=s.inject.userData.flushProgressDataForUpload(),t={progress:{completedLevels:e.completedLevels,counters:s.inject.userData.current.progress.synced.counters},levels:null};(0,g.isEmpty)(t.progress.completedLevels)&&delete t.progress.completedLevels,this.uploadQueue.addJob((()=>s.inject.userDataCloudStorage.updateDoc(t).then((()=>{s.inject.userData.handleProgressUploadSuccess(),s.inject.userData.hasUnsyncedProgressData()&&this.uploadLocalProgress()})).catch((t=>{s.inject.userData.handleProgressUploadFailed(e),this.status.set(f.NotAvailable),a.errors.handleNonFatalError(t,"uploadUserData")}))))}}async handleNewDoc(e,t){if(await s.inject.userData.initialize(),t!==this.currentUserId)y.warning(`ignoring incoming data for user ${t} - user no longer active`);else if(e){if(await this.handleCloudAccountMismatch(t),s.inject.userData.setMetadata({cloudSyncUserId:t}),v(e))await s.inject.userData.importRemoteProgress(e.progress);else{const t=function(e){return v(e)?e:function(e){const t=e.progress?.completedLevels??{};for(const i in e.levels){const s=e.levels[i].won;s&&(t[i]={turns:s.turns,difficulty:s.difficulty||"hard"})}return{progress:{completedLevels:t,counters:e.progress?.counters??{}},levels:null}}(e)}(e);await s.inject.userData.importRemoteProgress(t.progress),s.inject.userData.markAllProgressAsUnsynced()}y.info(`User data arrived for ${t}`),this.status.set(f.Synchronized),this.uploadLocalProgress(),"intro1"===s.inject.levelSession.levelId&&n.app.navigator.currentScreen===n.app.screen.play&&1===s.inject.gameStateModel.currentPhase.turnNumber&&(s.inject.levelSession.end({origin:"abort-tutorial-after-signin",wipeAutoSave:!0}),n.app.navigator.goTo(n.app.screen.title),n.app.screen.title.loadLevel())}else y.warning(`no remote data found for user ${t}, uploading local data`),(0,u.isRunningAt)("kongregate")||s.inject.userData.setMetadata({cloudSyncUserId:t}),s.inject.userData.markAllProgressAsUnsynced(),this.uploadLocalProgress()}async handleCloudAccountMismatch(e){const t=s.inject.userData.current.metadata;t.cloudSyncUserId&&t.cloudSyncUserId!==e&&await n.app.modals.simpleDialog({title:"Import progress?",message:`Do you want to import your current progress into account ${s.inject.login.getUsername()}?`,buttons:[{text:d.DialogButtons.DontImport,role:h.DialogButtonRole.PrimaryDanger},{text:d.DialogButtons.Import,role:h.DialogButtonRole.PrimaryGreen}]})===d.DialogButtons.DontImport&&s.inject.userData.wipeExpeditionProgress()}}},89437:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapGeometryView=void 0;const s=i(20754),n=i(90952),o=i(56038);class a extends s.LazyView{constructor(){super([n.GameState.map]),this.name="MapGeometry"}calculate(e){const t=o.Regions.model(e).allRegionsHexes().getDisplayBoundingBox();return{topCenterPoint:{x:t.x+t.width/2,y:t.y}}}getCacheKey(){return""}}t.MapGeometryView=a},89764:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionAssets=void 0,t.describePlan=function(e){return e.recipe.length?`obtain and use ${e.might} (${e.recipe.map(g).join(", ")})`:`use ${e.might}`};const s=i(64884),n=i(90048),o=i(91622),a=i(7334),r=i(56824),l=i(27654),c=i(78635),d=i(61634),h=i(76985),u=i(9292),p=r.logger.for("RegionAssets");function g(e){switch(e.action){case"buy":return`buy ${e.might}`;case"merge":return`2x${e.might}=>${e.might+1}`}}class m{static fromMyRegion(e){return new m({regionSize:e.size,remainingIncome:e.budget?.balance||0,remainingGold:e.treasury,remainingUnits:e.getMovableUnitsByMight(),totalUnits:e.getUnitsByMight(),fortification:e.fortification})}static safeAssetsFromMyRegion(e,t,i){function s(s){return!(o.inject.plugins.ai.hexVulnerabilityMultiplier.apply(1,e.state,e.faction.id,s.hex,s.might)<=.5)&&(0===c.Warfare.getHexStaticDefense(e.state,s.hex.id)?t.get(s.hex.id)>=i:t.get(s.hex.id)>=.01)}const n=e.getUnitsByMight((e=>!s(e))),a=n.countOf(1)+3*n.countOf(2)+4*n.countOf(3)+8*n.countOf(4),r=e.hexes.filter((i=>t.get(i.id)<=.01&&d.Economy.getCurrentIncomeFromHex(e.state,i.id)>0));return new m({regionSize:e.size-r.length,remainingIncome:(e.budget?.balance??0)+(0,u.pickSmaller)(a/2,4)-r.length,remainingGold:e.treasury,remainingUnits:e.getUnitsByMight((e=>e.isMovable()&&s(e))),totalUnits:e.getUnitsByMight((e=>s(e))),fortification:e.fortification})}toString(){return`[RegionAssets fort/size=${this.fortification}/${this.regionSize} gold=${this.remainingGold}${(0,a.withSign)(this.remainingIncome)} units=${this.remainingUnits.count()}/${this.totalUnits.count()} units]`}static fromEnemyRegion(e){const t=e.treasury+(e.budget?.balance||0);return new m(t<0?{regionSize:e.size,remainingIncome:e.budget.incomeFromHexes-e.getUnitsByMight().count(),remainingGold:0,totalUnits:s.UnitsByMight.empty,remainingUnits:s.UnitsByMight.empty,fortification:e.fortification}:{regionSize:e.size,remainingIncome:e.budget?.balance||0,remainingGold:t,remainingUnits:e.getUnitsByMight(),totalUnits:e.getUnitsByMight(),fortification:e.fortification})}constructor(e){this._remaininingAvailableMight=void 0,this._maxRemainingSustainableMight=void 0,this._maxSustainableMight=void 0,this.fortification=e.fortification,this.totalUnits=e.totalUnits,this.remainingUnits=e.remainingUnits,this.remainingGold=e.remainingGold,this.remainingIncome=e.remainingIncome,this.regionSize=e.regionSize}useUnit(e){return y(this,e)}buildCastle(e){return function(e,t){const i=o.inject.gameStateModel.rules.castleByMight(2),s=e.remainingGold-i.cost,n=e.remainingIncome-i.upkeep;return s<0?void 0:new m({regionSize:e.regionSize,totalUnits:e.totalUnits,remainingUnits:e.remainingUnits,remainingGold:s,remainingIncome:n,fortification:e.fortification+t.fortificationGain})}(this,e)}getRemainingAvailableMight(){return this._remaininingAvailableMight||(this._remaininingAvailableMight=this.remainingUnits.getTotalMight()+this.getBuyableMight()),this._remaininingAvailableMight}getTotalAvailableMight(){return this.totalUnits.getTotalMight()+this.getBuyableMight()}getBuyableMight(){const e=Math.floor(this.remainingGold/n.CHEAPEST_UNIT_COST);return(0,u.pickLarger)(0,e)}getMaxRemainingAvailableMight(e=e=>!0){let t=this.remainingUnits.getStrongest();if(t===s.MAX_UNIT_MIGHT)return s.MAX_UNIT_MIGHT;let i=this,n=!0;do{i=y(this,{requiredMight:t+1})?.assets,n=!!i&&e(i),n&&++t}while(n&&t<s.MAX_UNIT_MIGHT);return t||0}getMaxAvailableMight(e=e=>!0){return new m({regionSize:this.regionSize,remainingIncome:this.remainingIncome,remainingUnits:this.totalUnits,totalUnits:this.totalUnits,remainingGold:this.remainingGold,fortification:this.fortification}).getMaxRemainingAvailableMight(e)}getRawIncome(){return this.regionSize}getTotalUnitUpkeep(){return this.totalUnits.map(((e,t)=>o.inject.gameStateModel.rules.unitByMight(t).upkeep*e)).reduce(u.sum,0)}getMaxRemainingSustainableMight(){return this._maxRemainingSustainableMight||(this._maxRemainingSustainableMight=this.getMaxRemainingAvailableMight((e=>e.remainingIncome>=0))),this._maxRemainingSustainableMight}getMaxSustainableMight(){return this._maxSustainableMight||(this._maxSustainableMight=this.getMaxAvailableMight((e=>e.remainingIncome>=0))),this._maxSustainableMight}getObtainableMightLevels(e){return[1,2,3,4].filter((t=>!!this.remainingUnits.has(t)||!!this.useUnit({...e,allowOverkill:!1,requiredMight:t})))}getObtainableUnitCount(){return this.remainingUnits.count()+Math.floor(this.remainingGold/n.CHEAPEST_UNIT_COST)}override(e){return new m({regionSize:this.regionSize,totalUnits:this.totalUnits,remainingUnits:this.remainingUnits,remainingIncome:this.remainingIncome,remainingGold:this.remainingGold,fortification:this.fortification,...e})}turnsToBankruptcy(e=.5){const t=l.EconomySim.fromRegionAssets(this);if(0!==t.state.unitCount){for(t.simulateTurn(e);t.state.netIncome<=0&&!t.state.bankrupt;)t.simulateTurn(e);return t.state.bankrupt?t.turnsSimulated:void 0}}isHeadedForBankruptcy(e=.5){return void 0!==this.turnsToBankruptcy(e)}spendGold(e){return this.override({remainingGold:this.remainingGold-e})}}function y(e,t){const i=f(e,t);return i&&t.bannedMightLevels&&t.bannedMightLevels.includes(i.might)?y(e,{...t,requiredMight:i.might+1}):i}function f(e,t){if(t.requiredMight>(t.maxAllowedMight??Number.POSITIVE_INFINITY))return;void 0===t.allowOverkill&&(t.allowOverkill=!0);const i=e.remainingUnits.getOneWithMightAtLeast(t.requiredMight);if(i===t.requiredMight)return w(e,t,i);if(t.requiredMight>1){const i=function(e,t){let i=f(e,{requiredMight:t.requiredMight-1,allowOverkill:!1,willSacrifice:!0,loot:0,incomeGain:0});if(!i)return;let s=f(i.assets,{requiredMight:t.requiredMight-1,allowOverkill:!1,willSacrifice:!0,loot:0,incomeGain:0});if(!s)return;const n=[...i.recipe,...s.recipe,{action:"merge",might:t.requiredMight-1}],o=s.assets.remainingIncome+2*h.UPKEEP_TABLE[t.requiredMight-1]-h.UPKEEP_TABLE[t.requiredMight];return 1!==i.recipe.length||"buy"!==i.recipe[0].action||1!==s.recipe.length||"buy"!==s.recipe[0].action?{...s,might:t.requiredMight,recipe:n,assets:v({regionSize:e.regionSize,totalUnits:t.willSacrifice?s.assets.totalUnits:s.assets.totalUnits.with(t.requiredMight),remainingUnits:s.assets.remainingUnits,remainingGold:s.assets.remainingGold,remainingIncome:o,fortification:s.assets.fortification},t)}:void 0}(e,t);if(i)return i}const s=function(e,t){const i=o.inject.gameStateModel.rules.unitByMight(t.requiredMight);if(!i)return void p.warning(`Invalid attempt to buy unit with might ${t.requiredMight}`);const s=e.remainingGold-i.cost,n=e.remainingIncome-i.upkeep;return i.might>(t.maxAllowedMight??Number.POSITIVE_INFINITY)||s<0||n<0&&!1===t.allowNegativeIncome?void 0:{recipe:[{action:"buy",might:t.requiredMight}],assets:v({regionSize:e.regionSize,totalUnits:t.willSacrifice?e.totalUnits:e.totalUnits.add(t.requiredMight),remainingUnits:e.remainingUnits,remainingGold:s,remainingIncome:n,fortification:e.fortification},t),might:t.requiredMight}}(e,t);return s||(i&&t.allowOverkill?w(e,t,i):void 0)}function w(e,t,i){return{recipe:[],might:i,assets:v({regionSize:e.regionSize,totalUnits:t.willSacrifice?e.totalUnits.withoutUnit(i):e.totalUnits,remainingUnits:e.remainingUnits.withoutUnit(i),remainingGold:e.remainingGold,remainingIncome:e.remainingIncome,fortification:e.fortification},t)}}function v(e,t){return new m({regionSize:e.regionSize+(t.incomeGain??0),remainingGold:e.remainingGold+(t.loot??0),remainingIncome:e.remainingIncome+(t.incomeGain??0),remainingUnits:e.remainingUnits,totalUnits:e.totalUnits,fortification:e.fortification})}t.RegionAssets=m,m.empty=Object.freeze(new m({regionSize:0,remainingIncome:0,remainingGold:0,remainingUnits:s.UnitsByMight.empty,totalUnits:s.UnitsByMight.empty,fortification:0}))},89939:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FrontlineDefensePlanner=void 0;const s=i(56824),n=i(38746),o=i(65260),a=i(13602);s.logger.for("ai:FrontlineDefense"),t.FrontlineDefensePlanner=class{constructor(){this.name=this.constructor.name,this.isConquest=!1}async*generatePlans(e,t){if(1===e.focus.daring||e.isOffensiveActionRequired())return;const i=new n.Frontlines(e,t,1),s=new n.Frontlines(e,t,2),r=e.region.getMyAssets();if(0!==r.getRemainingAvailableMight()){for(await i.calculate();!i.bestFronts.empty();)yield new o.FrontlineDefensePlan(i.bestFronts.pop(),a.AIMetrics.focusMismatchPenaltyV2(e,r,"defense"));for(await s.calculate();!s.bestFronts.empty();)yield new o.FrontlineDefensePlan(s.bestFronts.pop(),a.AIMetrics.focusMismatchPenaltyV2(e,r,"defense"))}}}},89995:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFrame=t.SEAMLESS_IFRAME_CSS=void 0;const s=i(54306);t.SEAMLESS_IFRAME_CSS="\n    resize: none;\n    border: none;\n    scroll: auto;\n";class n extends s.ResizableDOMElement{constructor(e,i){super(e,0,0,document.createElement("iframe"),t.SEAMLESS_IFRAME_CSS+(i.customCss??"")),this.props=i;const s=this.node;this.setElement(s),this.setOrigin(0,0),i.url&&this.setUrl(i.url)}setUrl(e){this.node.src=e}get url(){return this.node.src}}t.IFrame=n},90048:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ruleSets=t.CHEAPEST_UNIT_COST=void 0;const s=i(63521),n=i(24598);t.CHEAPEST_UNIT_COST=10,t.ruleSets={default:{id:"default",pawns:{[n.PawnType.Villager]:{might:1,cost:10,upkeep:2,traits:[s.PawnTraits.Unit,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.OccupiesTile],merge:{[n.PawnType.Villager]:n.PawnType.Pikeman}},[n.PawnType.Pikeman]:{might:2,cost:20,upkeep:6,traits:[s.PawnTraits.Unit,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.OccupiesTile],merge:{[n.PawnType.Pikeman]:n.PawnType.Knight}},[n.PawnType.Knight]:{might:3,cost:40,upkeep:18,traits:[s.PawnTraits.Unit,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.OccupiesTile,s.PawnTraits.HeavyUnit],merge:{[n.PawnType.Knight]:n.PawnType.Hero}},[n.PawnType.Hero]:{might:4,defenseMight:3,cost:80,upkeep:54,traits:[s.PawnTraits.Unit,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.OccupiesTile]},[n.PawnType.UniqueHero]:{traits:[s.PawnTraits.Unit,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.OccupiesTile,s.PawnTraits.ZombieResistant,s.PawnTraits.Loyal],might:4,defenseMight:3},[n.PawnType.Town]:{traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Building,s.PawnTraits.GuardsAdjacentTiles],might:1},[n.PawnType.Camp]:{traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Building],might:1},[n.PawnType.Castle]:{traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Building,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.ZombieResistant],might:2,cost:20,upkeep:2},[n.PawnType.Bandit]:{might:0,upkeep:0,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.NegatesTileIncome,s.PawnTraits.Pest]},[n.PawnType.Bunny]:{might:0,upkeep:0,loot:10,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Pest,s.PawnTraits.Elusive]},[n.PawnType.Forest]:{might:99,upkeep:0,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Terrain,s.PawnTraits.Impenetrable,s.PawnTraits.NegatesTileIncome,s.PawnTraits.PreventsBuilding]},[n.PawnType.Chest]:{might:0,upkeep:0,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Pest,s.PawnTraits.Treasure,s.PawnTraits.AttractsBandits]},[n.PawnType.HauntedTown]:{traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Building,s.PawnTraits.ZombieResistant,s.PawnTraits.Undead],might:1},[n.PawnType.Zombie]:{might:0,upkeep:0,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.NegatesTileIncome,s.PawnTraits.Pest,s.PawnTraits.ZombieResistant,s.PawnTraits.Undead]},[n.PawnType.LadderZombie]:{might:0,upkeep:0,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.NegatesTileIncome,s.PawnTraits.Pest,s.PawnTraits.ZombieResistant,s.PawnTraits.Undead]},[n.PawnType.DreadKnight]:{traits:[s.PawnTraits.Unit,s.PawnTraits.Undead,s.PawnTraits.GuardsAdjacentTiles,s.PawnTraits.OccupiesTile,s.PawnTraits.ZombieResistant,s.PawnTraits.HeavyUnit],might:3},[n.PawnType.Present]:{might:0,upkeep:0,cost:10,loot:10,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Pest,s.PawnTraits.Treasure,s.PawnTraits.AttractsBandits]},[n.PawnType.Spawner]:{might:99,upkeep:0,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Impenetrable,s.PawnTraits.NegatesTileIncome]},[n.PawnType.Refuge]:{might:99,upkeep:0,traits:[s.PawnTraits.OccupiesTile,s.PawnTraits.Impenetrable,s.PawnTraits.NegatesTileIncome]},[n.PawnType.TownRuins]:{traits:[s.PawnTraits.Terrain,s.PawnTraits.PreventsBuilding]},[n.PawnType.Swamp]:{traits:[s.PawnTraits.Terrain,s.PawnTraits.NegatesTileIncome,s.PawnTraits.PreventsBuilding,s.PawnTraits.PreventsWalls,s.PawnTraits.PreventsHeavyUnits]},[n.PawnType.Coins]:{},[n.PawnType.GoldMine]:{traits:[s.PawnTraits.Terrain,s.PawnTraits.PreventsBuilding,s.PawnTraits.AttractsBandits],income:8}}}}},90379:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseWorldMapMode=void 0;const s=i(56824),n=i(54825),o=i(8),a=i(20026),r=i(90952);s.logger.for("BaseWorldMapMode"),t.BaseWorldMapMode=class{constructor(){this.name=this.constructor.name,this.rendersEverything=!1,this.handlesPointerEvents=!1,this.zoomWithScrollWheel=!1,this.allowsJumpingPawns=!0,this.scene=n.app.scene.worldMap}activate(){}deactivate(){}onSyncState(e){}onResize(){}applyWorldUpdates(e){}isHexInteractive(e){return!0}calculateWorldBounds(){const e=n.app.getCurrentGameStateModel(),t=(0,a.isDataSetActive)(e.state,r.GameState.regions.boundingBox)?e.regions.boundingBox():null;return t?(0,o.convertHexRectToWorldRect)(t):(0,o.convertHexRectToWorldRect)({x:Math.floor(e.map.width/2),y:Math.floor(e.map.width/2),width:1,height:1})}}},90386:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NormalDifficultyLevel=void 0;const s=i(18497),n=i(19618),o=i(24598),a=i(9292);t.NormalDifficultyLevel={name:s.PluginKey.NormalDifficultyLevel,register(e){e.ai.hostilityInputAdjustment.register(((e,t,i)=>(i.isLocalPlayer()?(e.theirDominance=(0,a.pickSmaller)(e.theirDominance,0),e.rivalry=.5*e.rivalry):e.credit=(0,a.pickSmaller)(e.credit,0),e))),e.ai.maxConquestPlanningRangeAdjustment.register(((e,t,i)=>{const s=n.Factions.getByHex(t,i.id)??-1;return n.Factions.getData(t,s)?.controller===o.FactionController.LocalUser?4:10}))}}},90444:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegenerateLevelButton=t.LevelNamePanel=void 0;const s=i(86545),n=i(80959),o=i(76049),a=i(96137),r=i(14739),l=i(36868),c=i(64589),d=i(54825),h=i(5365),u=i(63032),p=i(85711),g=i(2543),m=i(56824);class y extends s.BaseResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.bgImage=this.ui.image("logos/ship"),this.headerText=this.ui.text("Setting sail for",o.BitmapFont.Small,a.Colors.glassUi_old.primaryText),this.levelNameText=this.ui.text("Unknown Island",o.BitmapFont.Main,a.Colors.glassUi_old.primaryText),this.regenerateLevelButton=new f(this.ui),this.copyLinkButton=(0,c.createLevelLinkButton)(this.ui,"glassUi"),this.editNameResult=(0,p.ref)(""),this.editNameButton=this.ui.outlineButton({icon:"ui/button-icons/edit",tooltip:"Discover new island by name.",variant:"circle",theme:"glassUi",onClicked:this.editLevelName.bind(this)}),this.regenerateLevelButton.onClicked((()=>m.events.trigger(l.UserActions.GenerateNewIsland()))),this.add([this.bgImage,this.headerText,this.levelNameText,this.regenerateLevelButton,this.editNameButton,this.copyLinkButton])}updateLayout(){this.bgImage.setPosition(this.width/2-this.bgImage.width/2,20),this.headerText.setOrigin(.5,.5).setPosition(this.width/2,this.height-y.Layout.spaceForButton-60),this.levelNameText.setOrigin(.5,.5).setPosition(this.width/2,this.height-y.Layout.spaceForButton-30),this.regenerateLevelButton.setSize(150,30),this.regenerateLevelButton.setPosition(this.width/2-this.regenerateLevelButton.width/2,this.height-this.regenerateLevelButton.height/2-y.Layout.spaceForButton/2),this.editNameButton.setPosition(this.levelNameText.x+this.levelNameText.width/2+20,this.levelNameText.y-this.levelNameText.height/2),this.copyLinkButton.setPosition(this.editNameButton.x+this.editNameButton.width+10,this.editNameButton.y)}async editLevelName(){if(this.editNameResult.set(this.levelNameText.text),await d.app.modals.textInput({buttons:[{text:h.DialogButtons.Cancel,role:u.DialogButtonRole.Regular},{text:h.DialogButtons.OK,role:u.DialogButtonRole.PrimaryGreen}],title:"Discover new island",message:"The Shattered Ocean is vast and full of opportunity. Enter the name of a new island you'd like to discover!",value:this.editNameResult,maxLength:16})===h.DialogButtons.OK){const e=(0,g.startCase)(this.editNameResult.current.trim()).replace("_"," ");e&&m.events.trigger(l.UserActions.GenerateNewIsland({name:e}))}}}t.LevelNamePanel=y,y.Layout={spaceForButton:56};class f extends r.RoundedRectButton_LEGACY{constructor(e){const t=e.image("ui/button-icons/restart").setTint(a.Colors.glassUi_old.secondaryText),i=e.text("Next Island",o.BitmapFont.Small,a.Colors.glassUi_old.secondaryText),s=e.hLayout({spacing:10,originY:.5,originX:.5,content:[t,i]});super(e.scene,{raised:2,audio:!0,contentOriginX:.5,content:s}),this.icon=t,this.label=i,this.layout=s}setEnabled(e){this.icon.setFrame(e?"ui/button-icons/restart":"ui/button-icons/search"),this.label.setText(e?"Next Island":"Searching..."),super.setEnabled(e)}}t.RegenerateLevelButton=f},90667:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WinConditionsModel=void 0;const s=i(98648),n=i(56824),o={type:"defeat-all-rivals"};n.logger.for("WinConditions"),t.WinConditionsModel=class{constructor(e=[o]){this.data=e,this.models=e.map(s.getWinConditionModel)}test(e,t){return this.models.every((i=>i.test(e,t)))}list(){return this.models}has(e){return this.data.some((t=>t.type===e))}}},90824:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.Race=void 0,function(e){e.Human="human",e.Undead="undead"}(i||(t.Race=i={}))},90845:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ensureIsoTilesPrerendered=function(e){if(n)return!1;n=!0;const t=e.textures.get("atlas");for(let e of Object.values(s.IsoTileRecipes))if(e.renderToTexture)for(let[i,s]of Object.entries(e.frames)){if(!s)continue;const n=t.get(e.frameIdBase+"/"+s.frame),o={x:n.cutX,y:n.cutY,width:n.cutWidth,height:n.cutHeight};if(s.crop){const e=s.crop;o.x+=e.x,o.y+=e.y,o.width=e.width,o.height=e.height}t.add(e.frameIdBase+"/"+i,n.sourceIndex,o.x,o.y,o.width,o.height)}};const s=i(82226);let n=!1},90952:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EXPENSIVE_AI_PROJECTIONS=t.GameState=void 0,t.createRegionDataSets=Y,t.createFactionDataSets=K,t.createPawnDataSets=X,t.createUnitsDataSets=q,t.createEconomyDataSets=J,t.createWarfareDataSets=Z,t.createAIDataSets=Q;const s=i(67630),n=i(24598),o=i(98721),a=i(90048),r=i(95226),l=i(31011),c=i(35347),d=i(43314),h=i(65059),u=i(20541),p=i(16860),g=i(71276),m=i(91440),y=i(4356),f=i(56728),w=i(75185),v=i(62992),b=i(34102),S=i(98604),x=i(24307),T=i(65062),P=i(39838),I=i(81834),C=i(64648),M=i(63723),A=i(26294),B=i(62643),E=i(37600),O=i(45592),R=i(71376),k=i(74805),L=i(73664),_=i(41655),D=new r.SingletonDataSet("map",{levelId:"",width:10,height:10,plugins:[]}),H=new r.SingletonDataSet("ruleSet",a.ruleSets.default),j=Y(),F=X(),U=K(),G=q(),N=function(){const e={data:new r.SingletonDataSet("currentPhase",{type:n.PhaseTypes.FactionTurn,turnNumber:1,faction:1}),tappedUnits:new u.SetDataSet("currentPhase.tappedUnits")};return{...e,movableUnits:new p.MovableUnitsProjection("currentPhase.movableUnits",{currentPhase:e.data,currentPhaseTappedUnits:e.tappedUnits,unitsByFaction:G.byFaction})}}(),V=J(),W=Z(),z=Q(),$=function(){const e=new d.HexesByPawnTypeAndRegionProjection("bandits.campsByRegion",n.PawnType.Camp,{pawnsByRegion:F.byRegion});return{campsByRegion:e,nearestCamp:new M.NearestCampByHexProjection("bandits.nearestCamp",{campsByRegion:e,regionsByHex:j.byHex,regionsHexes:j.hexes}),nearestLoot:new E.NearestLootProjection("bandits.nearestLoot",{pawnsByHex:F.byHex,regionsByHex:j.byHex,townsByRegion:V.townsByRegion,factions:U.byId})}}();function Y(){const e=new l.MapDataSet("regions"),t=new l.MapDataSet("regions.byHex"),i=new s.InvertedMapProjection("regions.hexes",t);return{byId:e,byHex:t,hexes:i,edgeHexes:new w.RegionEdgeHexesProjection("regions.edgeHexes",i),boundingBox:new _.RegionsBoundingBoxProjection("regions.boundingBox",t)}}function K(){const e={byId:new l.MapDataSet("factions"),byRegion:new l.MapDataSet("factions.byRegion")},t=new s.InvertedMapProjection("factions.regions",e.byRegion);return{...e,regions:t}}function X(){const e={byId:new l.MapDataSet("pawns"),hex:new l.MapDataSet("pawns.hex"),count:new l.MapDataSet("pawns.count")},t=new s.InvertedMapProjection("pawns.byHex",e.hex);return{...e,byHex:t,byRegion:new o.PawnsByRegionProjection("pawns.byRegion",{pawnsByHex:t,regionsByHex:j.byHex,pawnsHex:e.hex})}}function q(){return{byFaction:new h.UnitsByFactionProjection("units.byFaction",{factionRegions:U.regions,pawnsByRegion:F.byRegion,rules:H})}}function J(){const e=new d.HexesByPawnTypeAndRegionProjection("economy.townsByRegion",n.PawnType.Town,{pawnsByRegion:F.byRegion}),t=new A.NearestTownProjection("economy.nearestTown",{townsByRegion:e,regionByHex:j.byHex,regionsHexes:j.hexes}),i=new f.CoinsByHexProjection("economy.coinsByHex",{pawnsByHex:F.byHex,pawns:F.byId,pawnsCount:F.count}),s=new m.BudgetByRegionProjection("economy.budgetByRegion",{regionHexes:j.hexes,townsByRegion:e,pawnsByHex:F.byHex,regions:j.byId});return{coinsByHex:i,townsByRegion:e,nearestTown:t,treasuryByRegion:new y.TreasuryByRegionProjection("economy.treasuryByRegion",{coinsByHex:i,townsByRegion:e,regionsByHex:j.byHex}),budgetByRegion:s}}function Z(){const e=new g.HexDefenseSourcesProjection("warfare.hexDefenseSources",{rules:H,movableUnits:N.movableUnits,pawns:F.byId,pawnsByHex:F.byHex,regionByHex:j.byHex}),t=new v.RegionBorderHexesProjection("warfare.borderHexes",{regionsEdgeHexes:j.edgeHexes,pawnsByHex:F.byHex}),i=new C.HexStaticDefenseProjection("warfare.hexStaticDefense",{hexDefenseSources:e,regionByHex:j.byHex,pawnsByHex:F.byHex});return{borderHexes:t,hexDefenseSources:e,hexDefense:new I.HexDefenseProjection("warfare.hexDefense",{hexDefenseSources:e,regionByHex:j.byHex,pawnsByHex:F.byHex}),hexStaticDefense:i,fortificationByRegion:new k.FortificationByRegion("warfare.fortificationByRegion",{regionByHex:j.byHex,regionHexes:j.hexes,hexStaticDefense:i})}}function Q(){const e=new T.AttritionByIdDataSet("ai.attritionByRegion"),t=new T.AttritionByIdDataSet("ai.extraAttritionByFaction"),i=new l.MapDataSet("ai.credit"),s=new l.MapDataSet("ai.hexHistory"),n=new b.HexDepthProjection("ai.hexDepth",{regionHexes:j.hexes,borderHexes:W.borderHexes}),o=new S.HexAssetValueProjection("ai.hexAssetValue",{pawnsByHex:F.byHex,coinsByHex:V.coinsByHex,regionsByHex:j.byHex,budgetByRegion:V.budgetByRegion,treasuryByRegion:V.treasuryByRegion,movableUnits:N.movableUnits}),a=new x.RegionInfluenceByHexProjection("ai.regionInfluenceByHex",{factionsByRegion:U.byRegion,regionsByHex:j.byHex,borderHexes:W.borderHexes,hexDefense:W.hexDefense,fortificationByRegion:W.fortificationByRegion,budgetByRegion:V.budgetByRegion}),r=new R.CapitalTownProjection("ai.capitalTown",{townsByRegion:V.townsByRegion,regionInfluenceByHex:a}),d=new c.HexImportanceProjection("ai.hexImportance",{regionsHexes:j.hexes,townsByRegion:V.townsByRegion,hexAssetValue:o,capitalTown:r}),h=new O.AssetsValueByRegionProjection("ai.assetsValueByRegion",{hexAssetValue:o,regionHexes:j.hexes});return{attritionByRegion:e,extraAttritionByFaction:t,credit:i,hexHistory:s,hexDepth:n,hexAssetValue:o,hexImportance:d,regionInfluenceByHex:a,capitalTown:r,powerByRegion:new L.PowerByRegionProjection("ai.powerByRegion",{factionRegions:U.regions,factions:U.byId,movableUnits:N.movableUnits,currentPhaseData:N.data,assetsValueByRegion:h}),regionInfluenceByRegion:new P.RegionInfluenceByRegionProjection("ai.regionInfluenceByRegion",{regionInfluenceByHex:a,regionHexes:j.hexes}),assetsValueByRegion:h}}t.GameState={version:new r.SingletonDataSet("version",B.CORE_GAMESTATE_SCHEMA_VERSION),map:D,regions:j,factions:U,pawns:F,ruleSet:H,units:G,currentPhase:N,economy:V,warfare:W,ai:z,bandits:$},t.EXPENSIVE_AI_PROJECTIONS=[t.GameState.ai.hexImportance,t.GameState.ai.regionInfluenceByHex,t.GameState.ai.regionInfluenceByRegion]},90966:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IslandCardInProgressLevelModel=t.IslandCardReplayModel=t.IslandCardMyIslandModel=t.IslandCardFavoriteIslandModel=void 0,t.createUserContentModelFor=function(e){switch(e.type){case"replay":return new y(e);case"in-progress-level":return new f(e);case"favorite-island":return new g(e);case"my-island":return new m(e);default:throw new Error("Not implemented")}};const s=i(85026),n=i(8458),o=i(56824),a=i(36868),r=i(18811),l=i(21473),c=i(73875),d=i(8358),h=i(91622),u=i(54825),p=i(5365);class g{get replay(){try{return!this._replay&&this.content.bestReplay&&(this._replay=(0,s.decodeReplay)(this.content.bestReplay)),this._replay}catch(e){return void o.errors.handleNonFatalError(e,"IslandCardFavoriteIslandModel.getReplay")}}constructor(e){this.content=e}getPreviewGameState(){return(0,s.decodeGameState)(this.content.startingGameState)}getTitle(){return this.content.title}getLevelId(){return this.content.levelId}getActions(){return[{icon:"ui/button-icons/play",label:"PLAY",onClick:()=>{o.events.trigger(a.UserActions.PlayLevel({levelId:this.content.levelId,startingState:(0,s.decodeGameState)(this.content.startingGameState),origin:"library/play-again"}))}},void 0!==this.replay&&{icon:"ui/button-icons/replay",label:"VIEW REPLAY",onClick:()=>{o.events.trigger(a.UserActions.LoadReplay(this.replay))}},{icon:"ui/button-icons/trash",label:"REMOVE",onClick:async()=>{await u.app.modals.confirmRemoveFromFavorites(this.content.title)===p.DialogButtons.Remove&&o.events.trigger(a.UserActions.RemoveLevelFromFavorites(this.content.levelId))}}].filter(Boolean)}toString(){return(0,n.userContentToStr)(this.content)}getSubtitle(){return this.content.bestReplay?`Won in ${l.ReplayModel.for((0,s.decodeReplay)(this.content.bestReplay)).turnCount} turns`:""}isFavorite(){return h.inject.userContent.isInFavorites(this.content.levelId)}}t.IslandCardFavoriteIslandModel=g;class m{get replay(){try{return!this._replay&&this.latestSnapshot?.bestReplay&&(this._replay=(0,s.decodeReplay)(this.latestSnapshot.bestReplay.data)),this._replay}catch(e){return void o.errors.handleNonFatalError(e,"IslandCardMyIslandModel.getReplay")}}get latestSnapshot(){return this.content.snapshots[0]}get currentGameState(){return this.latestSnapshot?.gameState}constructor(e){this.content=e}getPreviewGameState(){try{if(!this.currentGameState)return;return(0,s.decodeGameState)(this.currentGameState)}catch(e){return void o.errors.handleNonFatalError(e,"IslandCardMyIslandModel.getPreviewGameState")}}getTitle(){return this.content.title}getLevelId(){return this.content.levelId}getActions(){return[{icon:"ui/button-icons/edit",label:"EDIT",onClick:()=>{o.events.trigger(a.UserActions.OpenMapEditor({openLevelRecord:this.content}))}},{icon:"ui/button-icons/play",label:"PLAY",onClick:()=>{o.events.trigger(a.UserActions.PlayLevel({levelId:this.content.levelId,startingState:(0,s.decodeGameState)(this.currentGameState),origin:"library/play-again"}))}},void 0!==this.replay&&{icon:"ui/button-icons/replay",label:"VIEW REPLAY",onClick:()=>{o.events.trigger(a.UserActions.LoadReplay(this.replay))}},{icon:"ui/button-icons/trash",label:"REMOVE",onClick:async()=>{await u.app.modals.confirmDeleteMyIsland(this.content.title)===p.DialogButtons.Remove&&o.events.trigger(a.UserActions.DeleteLevel(this.content.id))}}].filter(Boolean)}toString(){return(0,n.userContentToStr)(this.content)}getSubtitle(){return this.latestSnapshot?.bestReplay?`Won in ${(0,d.pluralize)(this.latestSnapshot.bestReplay.turns,"turn","turns")}`:""}isFavorite(){return h.inject.userContent.isInFavorites(this.content.levelId)}}t.IslandCardMyIslandModel=m;class y{constructor(e){this.content=e}getReplayData(){return this._replayData||(this._replayData=(0,s.decodeReplay)(this.content.replay)),this._replayData}getModel(){return this._model||(this._model=new l.ReplayModel(this.getReplayData())),this._model}getPreviewGameState(){const e=this.getReplayData().steps.find((e=>e.snapshot))?.snapshot;if(e)return e}getTitle(){return this.content.title}getLevelId(){return this.content.levelId}getSubtitle(){if("file-import"===this.content.origin)return`Replay by ${this.content.author??"unknown conqueror"}`;const e=(0,d.pluralize)(this.getModel().turnCount,"turn","turns");switch(this.content.outcome){case r.LevelOutcome.Victory:return`Won in ${e}`;case r.LevelOutcome.Defeat:return`Defeated in ${e}`;default:return`Played ${e}`}}getActions(){return[!(void 0!==this.content.outcome)&&{icon:"ui/button-icons/play",label:"RESUME",onClick:()=>{o.events.trigger(a.UserActions.PlayLevel({levelId:this.content.levelId,startingState:this.getModel().initialSnapshot,currentState:this.getModel().toFinalGameState(),origin:"library/continue",aiDifficulty:this.getReplayData().meta.aiDifficulty,livesLeft:this.getReplayData().meta.remainingLives})),h.inject.userContent.deleteContent(this.content.id)}},{icon:"ui/button-icons/replay",label:"VIEW REPLAY",onClick:()=>{o.events.trigger(a.UserActions.LoadReplay(this.content.replay))}},{icon:"ui/button-icons/fight",label:"PLAY AGAIN",onClick:()=>{o.events.trigger(a.UserActions.PlayLevel({levelId:this.content.levelId,startingState:this.getModel().initialSnapshot,origin:"library/play-again",restart:!0}))}},{icon:"ui/button-icons/download",label:"DOWNLOAD",onClick:()=>{(0,c.downloadReplay)(this.getReplayData())}}].filter(Boolean)}isFavorite(){return h.inject.userContent.isInFavorites(this.content.levelId)}toString(){return(0,n.userContentToStr)(this.content)}}t.IslandCardReplayModel=y;class f{constructor(e){this.content=e}getPreviewGameState(){return(0,s.decodeGameState)(this.content.currentGameState)}getTitle(){return this.content.title}getSubtitle(){return`In progress (turn ${this.content.turnNumber})`}getLevelId(){return this.content.sessionData.levelId}getActions(){return[{icon:"ui/button-icons/play",label:"CONTINUE",onClick:()=>{o.events.trigger(a.UserActions.PlayLevel({levelId:this.content.sessionData.levelId,origin:"library/continue"}))}}]}isFavorite(){return h.inject.userContent.isInFavorites(this.getLevelId())}toString(){return(0,n.userContentToStr)(this.content)}}t.IslandCardInProgressLevelModel=f},91110:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompactFormItem=t.FormItem=void 0;const s=i(86545),n=i(80959),o=i(20087),a=i(9292),r=i(76049);class l extends s.AutoHeightResponsiveContainer{constructor(e,{label:t,helpTooltip:i,labelWidth:s=100,component:o}){super(e);const a=n.UiBuilder.for(e);this.label="string"==typeof t?a.richText(t):t,this.labelWidth=s,this.component=o,i&&(this.helpIcon=a.helpIcon({tooltip:i}),this.add(this.helpIcon)),this.add([this.label,this.component])}setLabelWidth(e){this.labelWidth=e,this.preUpdate.makeDirty()}calculateHeight(){return(0,a.pickLarger)(this.component.y+this.component.height,this.label.y+this.label.height)}updateLayout(){o.Arrange.alignY({content:[this.label,this.component,...this.helpIcon?[this.helpIcon]:[]],y:this.height/2,origin:.5}),this.label.x=0,this.helpIcon&&(this.helpIcon.x=this.label.x+this.label.width+4),this.component.x=this.labelWidth,this.updateSize()}}t.FormItem=l;class c extends s.AutoHeightResponsiveContainer{constructor(e,{label:t,helpTooltip:i,labelWidth:s=100,component:o}){super(e);const a=n.UiBuilder.for(e);this.label="string"==typeof t?a.richText(t,(e=>e.oceanShades.light3),r.VectorFont.RobotoMini):t,this.component=o,i&&(this.helpIcon=a.helpIcon({tooltip:i}),this.add(this.helpIcon)),this.add([this.label,this.component])}calculateHeight(){return this.component.y+this.component.height}updateLayout(){this.component.width=this.width,o.Arrange.topToBottom({content:[this.label,this.component],spacing:6,y:0,origin:0}),this.helpIcon&&(this.helpIcon.x=this.label.x+this.label.width+4,this.helpIcon.y=this.label.y+this.label.height/2-this.helpIcon.height/2),this.updateSize()}}t.CompactFormItem=c},91440:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionBudgetUpdater=t.BudgetByRegionProjection=void 0;const s=i(31011),n=i(7334),o=i(56038),a=i(61634),r=i(4005),l=i(88023);class c extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new d(this).update}bootstrap(e){return(0,l.ImmutableMap)().withMutations((t=>{o.Regions.model(e).all().forEach((e=>{t.set(e.id,this.getRegionBudget(e))}))}))}getRegionBudget(e){const t=e.state,i=e.hexes.map((e=>a.Economy.getCurrentIncomeFromHex(t,e.id))).reduce(((e,t)=>e+t),0),s=e.getPawns().map((e=>e.upkeep)).reduce(((e,t)=>e+t),0);return{potentialIncome:i,incomeFromHexes:e.isAlive()?i:0,upkeep:s,balance:i-s}}entryToString(e){return`${(0,n.withSign)(e.balance)}`}entryToDebugString(e){return(0,n.prettyPrintObject)(e)}}t.BudgetByRegionProjection=c;class d extends r.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}initialize(){this.invalidated=new Set}registerHandlers(e){e(this.dataSet.sources.regionHexes,this._invalidateAffectedRegions),e(this.dataSet.sources.pawnsByHex,this._handlePawnsByHexChanged),e(this.dataSet.sources.regions,this._handleRegionsUpdated)}createMutation(){const e=o.Regions.model(this.newState);return this.invalidated.forEach((t=>{const i=e.byId(t);i?this.builder.set(t,this.dataSet.getRegionBudget(i)):this.builder.delete(t)})),super.createMutation()}_invalidateAffectedRegions(e){e.updated?.forEach((({id:e})=>this.invalidated.add(e)))}_handlePawnsByHexChanged(e){e.updated?.forEach((({id:e})=>{const t=o.Regions.getByHex(this.oldState,e),i=o.Regions.getByHex(this.newState,e);t&&this.invalidated.add(t),i&&this.invalidated.add(i)}))}_handleRegionsUpdated(e){e.updated?.forEach((([e,t])=>{t?o.Regions.getRegionData(this.oldState,e)||this.invalidated.add(e):this.builder.delete(e)}))}}t.RegionBudgetUpdater=d},91622:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.inject=t.SPECTATING_SPEED_LABELS=void 0,t.setCoreContext=function(e){t.inject=new Proxy(e,{get(e,t,i){if(e.hasOwnProperty(t))return Reflect.get(e,t,i);throw new Error(`attempted to access unitialized property "${String(t)}"`)}})};const s=i(16007);t.SPECTATING_SPEED_LABELS={[s.SpectatingPlaybackSpeed.Paused]:"Paused",[s.SpectatingPlaybackSpeed.Normal]:"Normal",[s.SpectatingPlaybackSpeed.Fast]:"Fast",[s.SpectatingPlaybackSpeed.UltraFast]:"Very Fast"}},91683:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateLandmass=async function e(t,i,n){const h=n.minSize??t.map.innerWidth*t.map.innerHeight*(1-n.water)*.33,u=n.smoothness,p=n.water,g=p+(1-p)*(1-n.inlandForests),m=(e,i)=>(f.simplex2(e.x/u,e.y/u)+1)/2*d((e.x-.5)/t.map.innerWidth,(e.y-.5)/t.map.innerHeight)>=i;let y,f;c.info("Generating new random map"),y=n.seed??i.integerBetween(0,Number.MAX_SAFE_INTEGER),f=new s.Noise(y),i.reset(y),t.useProjections(o.ProjectionPresets.coreEntities);const w=t.map.getInnerHexes().filter((e=>m(e,p))).components().getLargestGroup()??l.HexGroup.empty;if(c.info(`Base landmass generated (${w?.length} hexes, target is at least ${h})`),w.length<h)return c.warning("Not enough land, decreasing water level and trying again"),await e(t,i,{...n,minSize:h,water:.75*n.water});t.factions.neutral.addNewRegion("land",w);const v=w.border(),b=w.without(v).filter((e=>m(e,g)));b.forEach((e=>{t.pawns.create({hex:e,type:r.PawnType.Forest})}));let S=w.without(b),x=i.shuffle(v.filter(P).toArray()),T=Math.floor(x.length*n.coastalForests);for(console.log(`adding ${T} coastal forest tiles`);T>0&&x.length;){let e=x.shift();if(a.assert.defined(e),P(e)&&(t.pawns.create({hex:e,type:r.PawnType.Forest}),S=S.without(e),T--,T>0&&i.boolean(n.coastalForestsCohesion))){const t=e.neighbours(P);if(t.length){const e=t.getRandomHex(i);x.unshift(e)}}}function P(e){return v.has(e)&&S.has(e)&&1===S.disjointedNeighbourGroupsOf(e).getGroups().length}},t.avoidEdges=d,t.plains=function(e){e.regions.clear(),e.factions.byId(0)?.addNewRegion("land",e.map.getInnerHexes())},t.blank=function(e){e.regions.clear()};const s=i(57986),n=i(56824),o=i(72273),a=i(97849),r=i(24598),l=i(20693),c=n.logger.for("generateLandmass");function d(e,t){return Math.pow(1-2*((.5-e)*(.5-e)+(.5-t)*(.5-t)),2)}},91693:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SAVE_GAME_LOCAL_STORAGE_PREFIX=void 0,t.saveGame=function(e,i){const o=(0,n.compressGameState)(i??a.inject.currentGameState);i||(o.replay=a.inject.gameStateController.history.export({snapshotPolicy:["p1-rewind-checkpoints"],sizeLimit:1e3,includeRewinds:!0,remainingLives:a.inject.levelSession.remainingLives})),s.storage.setItem(t.SAVE_GAME_LOCAL_STORAGE_PREFIX+e,(0,r.encodeGameState)(o)),s.logger.for("saveGame").info(`Current games state saved into local storage as "${e}"`)};const s=i(56824),n=i(96704),o=i(62643),a=i(91622),r=i(85026);t.SAVE_GAME_LOCAL_STORAGE_PREFIX=`konkr.savedGame.v${o.CORE_GAMESTATE_SCHEMA_VERSION}.`},91954:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapScene=void 0;const s=i(56824),n=i(81700),o=i(72273),a=i(80624),r=i(67862),l=i(79090),c=i(52201),d=i(19693),h=i(20693),u=i(20518),p=i(24598),g=i(61595),m=i(34963),y=i(4440),f=i(90379),w=i(40054),v=i(444),b=i(91622),S=i(54825),x=i(93868),T=i(85614),P=i(63638),I=i(90845),C=i(4456),M=i(16222),A=i(20290),B=i(62076),E=i(1409),O=i(59956),R=i(66143),k=i(56038),L=i(73230),_=s.logger.for("WorldMapScene");class D extends u.BaseScene{constructor(){super({key:n.Scenes.WorldMap,bounds:x.BOUNDS.Main}),this.currentSessionId=0}session(){const e=this.currentSessionId,t=this;return{isActive:()=>t.currentSessionId===e}}endSession(){this.currentSessionId++}resetRenderer(){const e=new A.GreenLayer;this.chunkedRenderer=new g.ChunkedHexRenderer(this,{chunkSize:5,paintedLayers:[new A.LandmassLayer,new A.GroundLayer,new A.SwampLayer,e,new B.GrassDecalsLayer(e),...s.config.debug.isoTiles?[new A.DebugLayer]:[]],spriteLayers:e=>(this.forestRenderer=new M.ForestRenderer(e),[new C.PalisadeRenderer(e),this.forestRenderer])})}create(){super.create(),(0,I.ensureIsoTilesPrerendered)(this),this.mode=new f.BaseWorldMapMode,this.objectsPool=new m.WorldObjectsPool(this),this.input.keyboard.addKey(y.Input.Keyboard.KeyCodes.SHIFT),S.app.device.supports.touch&&this.input.addPointer(1),this.input.on("wheel",((e,t,i,s,n)=>{this.mode.zoomWithScrollWheel&&this.cameraController.zoomController.applyScroll(s)}),this),this.resetRenderer(),this.chunksRenderingController=new g.ChunksRenderingController(this,this.chunkedRenderer),this.pointersTracker=new v.WorldMapPointersTracker(this),this.cameraController=new r.WorldMapCameraController(this),this.debugOverlay=new a.WorldMapDebugOverlay(this,this.chunkedRenderer),this.debugOverlay.create(),this.tileObjects=new l.TileObjectsManager(this,this.chunkedRenderer),this.coins=new c.CoinsManager(this,this.objectsPool,this.tileObjects),this.pawns=new d.PawnsManager(this,this.objectsPool,this.tileObjects),this.torches=new E.TorchesManager(this,this.objectsPool,this.tileObjects),this.overlays=new P.WorldMapOverlaysManager(this),this.vfx=new T.TextSpawner(this),this.input.on("pointerup",this.onPointerUp,this),this.input.on("pointermove",this.onPointerMove,this),s.config.watch(this.applyConfig.bind(this)),this.lodManager=(0,w.createWorldMapLODManager)(this.objectsPool),this.observe.signal(b.inject.debugLayers.onActiveLayerUpdated,(e=>{if(s.config.debug.overlay)try{this.debugOverlay.showDebugLayer(e)}catch(t){_.warning(`Failed to render debug layer ${e}`,t,t?.stack)}})),this.anims.create({key:"spin-coin",frames:this.anims.generateFrameNumbers("coin",{frames:[0,1,2,3,4,5,0]}),frameRate:30,repeat:-1}),this.applyTheme()}setMode(e){_.info(` entering ${e.name} (from ${this.mode.name})`),this.mode.deactivate(),this.mode=e,b.inject.debugData.set("worldMap.mode",this.mode.name),e.activate()}applyConfig(e){super.applyConfig(e),this.debugOverlay.setVisible(!!e.debug.overlay)}onPointerMove(){this.mode.handlesPointerEvents&&b.inject.ui.hexUnderCursor.update(this)}update(e,t){this.pawns.update(),this.mode.rendersEverything?this.chunksRenderingController.renderEverything():this.chunksRenderingController.update();const i=this.cameras.main;this.cameraController.update(e,t),this.lodManager.update(),s.config.debug.overlay&&(b.inject.debugData.set("CAM.dimensions",`${i.x},${i.y} -> ${i.width},${i.height}`),b.inject.debugData.set("CAM.worldView",`${i.worldView.x},${i.worldView.y} -> ${Math.round(i.worldView.right)},${Math.round(i.worldView.bottom)}`),b.inject.debugData.set("CAM.scroll",`${Math.round(i.scrollX)}, ${Math.round(i.scrollY)} ph(${this.cameraController.scrollController.cameraX.phase}) z(${i.zoom.toFixed(1)}) d(${(1/i.zoom).toFixed(1)})`),b.inject.debugData.set("CAM.scrollSpeed",`${Math.round(this.cameraController.scrollController.cameraX.speed)}`),b.inject.debugData.set("worldTweens",`${this.tweens.getTweens().length}`),b.inject.debugData.set("CAM.points",this.pointersTracker.pointers.map((e=>`${e.id}: ${!!this.pointersTracker.pointerMoved[e.id]}`)).join(",")),this.objectsPool.updateDebugData()),this.editorOverlay?.update()}loadNewGameState(e){b.inject.ui.withoutTransitions((()=>{this.cameraController.updateBounds(),this.debugOverlay.redrawWorldBoundsRectangle(this.cameraController.worldBounds),this.editorOverlay?.update(),this.syncState(e)}))}syncState(e=S.app.getCurrentGameStateModel().state,t){const i=R.LevelModel.for(O.WorldMap.get(e).levelId).getPreferredTheme();b.inject.theme.sync(i,!1),this.applyTheme();const s=new o.StaticGameStateModel(e);this.cameraController.updateBounds(),this.chunkedRenderer.syncState(e),this.currentSessionId++;const{regions:n}=s,a=h.HexGroup.union(n.all().map((e=>e.hexes)));this.tileObjects.syncWithModel(s,a,!0),this.pawns.syncWithModel(s),b.inject.ui.withoutTransitions((()=>{this.coins.syncWithModel(s)})),this.torches.syncWithModel(s),t?this.overlays.set(e,t):this.overlays.update(e),this.debugOverlay.redrawChunkRectangles(this.chunkedRenderer.getAllChunks()),this.mode.onSyncState(s),S.app.scene.worldMap.runIntegrityChecks()}partialSync(e,t){const i=new o.StaticGameStateModel(e);this.chunkedRenderer.sync((0,L.syncRequest)(e,t)),this.tileObjects.syncWithModel(i,t,!1),this.pawns.partialSync(i,t)}syncTownVariantInRegions(e,t){for(let i of t){const t=h.HexGroup.from(i.getPawns().filter((e=>e.type===p.PawnType.TownRuins||e.type===p.PawnType.Town)).map((e=>e.hex)));S.app.scene.worldMap.pawns.syncPawnVariant(e,t)}}syncTownVariantInAllRegions(e){const t=k.Regions.model(e);this.syncTownVariantInRegions(e,t.all().filter((e=>e.isAlive())))}async play(e){await this.mode.applyWorldUpdates(e)}destroy(e){}resize(e){this.cameraController.zoomController.currentZoom;const t=e.oldWidth-e.newWidth,i=e.oldHeight-e.newHeight,s=this.cameraController.scrollController;s.cameraX.setTo(s.cameraX.value+t/2),s.cameraY.setTo(s.cameraY.value+i/2),this.cameraController.updateBounds(),this.mode.onResize()}getPawnObjectPositionOnScreen(e){return this.pawns.getPawnObjectPositionOnScreen(this.cameras.main,e)}runIntegrityChecks(){this.pawns.integrityCheck()}onPointerUp(e){e.wasTouch&&b.inject.ui.hexUnderCursor.clear()}applyTheme(){const e=b.inject.theme.getCurrent(),t=this.forestRenderer.recipe.frameIdBase,i=e.forestsTexture??"iso-tiles/forest";t!==i&&(this.forestRenderer.clear(),this.forestRenderer.recipe.frameIdBase=i)}}t.WorldMapScene=D},91999:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelDetailsWidgetContent=t.SetupTabContent=void 0;const s=i(86545),n=i(80959),o=i(56824),a=i(36868),r=i(15956),l=i(20087),c=i(6838),d=i(91622),h=i(59956),u=i(7169),p=i(46973),g=i(95070),m=i(18497),y=i(54825),f=i(34174),w=i(76049),v=i(45920),b=i(20034);class S extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.widgets=new r.WidgetsContainer(this.scene),this.levelDetailsWidget=this.ui.sidebarWidget({title:"Island Details",content:new x(this.scene)}),this.rulesWidget=this.ui.sidebarWidget({title:"Rules",content:new P(this.scene)}),this.widgets.setWidgets([this.levelDetailsWidget,this.rulesWidget]),this.add([this.widgets])}calculateHeight(){return 0}updateLayout(){this.widgets.width=this.width,this.updateSize()}updateContent(){this.levelDetailsWidget.content.updateContent(),this.rulesWidget.content.updateContent()}}t.SetupTabContent=S;class x extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.nameInput=new c.TextInput(this.scene,{placeholder:"Unnamed Island",className:"themed",onChange:e=>{h.WorldMap.update(d.inject.currentGameState,{name:e})}}),this.authorInput=new c.TextInput(this.scene,{placeholder:"Sign your creation!",className:"themed",onChange:e=>{h.WorldMap.update(d.inject.currentGameState,{author:e})},onBlur:e=>{d.inject.userData.rememberChoice("nickname",e)}}),this.descriptionInput=new u.TextArea(this.scene,{rows:4,placeholder:"A short description of the island",className:"themed",onChange:e=>{h.WorldMap.update(d.inject.currentGameState,{description:e})}}),this.introductionInput=new u.TextArea(this.scene,{rows:4,placeholder:"A short introduction shown to the player when they start the island",className:"themed",onChange:e=>{h.WorldMap.update(d.inject.currentGameState,{introduction:e})}}),this.randomizeNameButton=new p.RoundedRectButton(this.scene,{width:32,height:32,content:new g.IconOnly(this.scene,"ui/button-icons/dice"),theme:p.RoundedRectButton.Themes.subtle,onClicked:()=>{const e=o.random.townName();this.nameInput.setValue(e),h.WorldMap.update(d.inject.currentGameState,{name:e})}}),this.formItems=[this.ui.formItemCompact({label:"Island Name",component:this.ui.withAttachments({component:this.nameInput,rightAttachments:[this.randomizeNameButton],spacing:4})}),this.ui.formItemCompact({label:"Author",component:this.authorInput}),this.ui.formItemCompact({label:"Description",component:this.descriptionInput}),this.ui.formItemCompact({label:"Introduction prompt",component:this.introductionInput})],this.add(this.formItems)}calculateHeight(){const e=this.formItems[this.formItems.length-1];return e.y+e.height}updateContent(){this.nameInput.setValue(d.inject.gameStateModel.map.name??""),this.authorInput.setValue(d.inject.gameStateModel.map.author??""),this.descriptionInput.setValue(d.inject.gameStateModel.map.description??""),this.introductionInput.setValue(d.inject.gameStateModel.map.introduction??"")}updateLayout(){this.formItems.forEach((e=>{e.width=this.width,e.updateLayout()})),l.Arrange.topToBottom({content:this.formItems,spacing:8,y:0,origin:0}),this.updateSize()}}t.LevelDetailsWidgetContent=x;const T=[m.PluginKey.Zombies,m.PluginKey.BuyGifts,m.PluginKey.BuyTowns,m.PluginKey.PickLandingSpot,m.PluginKey.SpawnGifts,m.PluginKey.AlwaysRetreat,m.PluginKey.CaptureTowns];class P extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.rulesList=this.ui.buttonsListView({theme:"buttonList"}),this.rulesListFormItem=this.ui.formItemCompact({label:"Rules modifiers",component:this.rulesList}),this.jsonEditButton=this.ui.outlineButton({text:"{ }  Edit Raw JSON",theme:"subtle",onClicked:()=>{o.events.trigger(a.UserActions.EditMapJSON())}}),this.rulesList.onItemSelected((async({item:e,component:t})=>{if("_add"===e.key){const{promise:e,cancel:i}=y.app.dropdowns.dropdownList(f.Placement.aroundUiObject(t),{items:T.filter((e=>!d.inject.gameStateModel.map.plugins.has(e))).map((e=>I((0,v.getPlugin)(e)))).sort(((e,t)=>e.text.localeCompare(t.text)))}),s=await e;s&&(o.events.trigger(b.MapEditorActions.AddPlugin(s.key)),this.updateContent())}})),this.add([this.rulesListFormItem,this.jsonEditButton])}updateContent(){const e={key:"_add",text:"+ [i]Add New Modifier[/i]",textStyle:{font:w.VectorFont.RobotoMini,bbCode:!0}},t=d.inject.gameStateModel.map.plugins.getAll().filter((e=>T.includes(e.name))).map((e=>({...I(e),textStyle:{font:w.VectorFont.RobotoMini},addons:[{icon:"ui/button-icons/trash",onClicked:()=>{o.events.trigger(b.MapEditorActions.RemovePlugin(e.name)),this.updateContent()}}]})));this.rulesList.setItems([...t,e]),this.updateLayout()}calculateHeight(){return this.jsonEditButton.y+this.jsonEditButton.height}updateLayout(){this.rulesListFormItem.width=this.width,this.rulesListFormItem.width=this.width,this.rulesList.updateLayout(),this.rulesListFormItem.updateLayout(),l.Arrange.topToBottom({content:[this.rulesListFormItem,this.jsonEditButton],spacing:8,y:0,origin:0}),this.updateSize()}}function I(e){return{key:e.name,text:e.displayName??e.name,icon:e.icon??"ui/button-icons/bullet-point"}}},92111:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.townNameSuffixes=t.townNamePrefixes=void 0,t.townNamePrefixes=["Agate","Al","Amber","Amethyst","Ametrine","Ander","Apple","Arbor","Ard","Arrow","Ash","Ashen","Auburn","Autumn","Back","Bain","Baldur","Bane","Baron","Barron","Barrow","Basalt","Beach","Bear","Beech","Bell","Belle","Beryl","Big","Birch","Bitter","Black","Blade","Blue","Bog","Bone","Border","Boulder","Brass","Break","Breeze","Briar","Bridge","Brier","Bright","Brim","Burn","Castle","Cedar","Chamber","Chill","Cinder","Clay","Cold","Condor","Corner","Crab","Crag","Craw","Crown","Crystal","Dag","Dark","Day","Dead","Deep","Dire","Dragon","Drake","Draken","Dread","Dusk","Eagle","East","Ebon","Eden","Edge","Edin","Elder","Elm","Ember","Emerald","Ever","Fae","Fair","Faire","Fal","Fall","Fel","Fell","Fey","Fir","Fire","Flint","Fog","Fort","Free","Full","Gay","Gem","Glow","Gold","Grand","Granite","Grass","Grave","Gray","Green","Grey","Griffon","Gryphon","Guild","Half","Hallow","Hammer","Hard","Hawk","Heart","Hearth","Heath","Hedge","Hem","High","Hills","Hollow","Home","Hope","Horn","Iron","Jade","Jasper","Kent","Key","King","Kings","Kirk","Kraig","Lady","Lake","Larch","Law","Leaf","Ledge","Ley","Lime","Lion","Little","Liver","Loch","Lone","Love","Low","Lower","Maiden","Main","Man","Mans","Maple","Marble","Marsh","Mason","Mass","May","Mead","Meadow","Mid","Middle","Mine","Mist","Mithril","Moon","Mord","Moss","Mourn","Mud","Murk","Myst","Mythril","Nettle","Never","New","Night","North","Oak","Old","Onyx","Opal","Pale","Peace","Pike","Pine","Plum","Point","Pond","Port","Prince","Pyre","Queen","Queens","Quiet","Rain","Rainbow","Ram","Raven","Red","Redwood","Rex","Rich","Ridge","Ring","River","Rock","Rose","Ruby","Rune","Sage","Sand","Sapphire","Sea","Sedge","Shade","Sharp","Sharpe","Shatter","Shaw","Shell","Shield","Shire","Shore","Silver","Skull","Sky","Slade","Snow","Sound","South","Spine","Spring","Stan","Star","Still","Stock","Stone","Stony","Storm","Stout","Strath","Strom","Summer","Sun","Sunny","Sword","Tangle","Teak","Temple","Timber","Topaz","Torch","Tower","Tree","True","Tumble","Twin","Tyr","Umber","Umbur","Under","Upper","Wake","Wall","War","Water","Way","Wedge","West","Wet","Whet","Whit","White","Wild","Will","Willow","Win","Wind","Winter","Wolf","Wood","Wren","Wyn","Yew"],t.townNameSuffixes=["Back","Bank","Bard","Baron","Barron","Basin","Bay","Beach","Beck","Bell","Ben","Berg","Black","Bluff","Blum","Bog","Border","Borough","Bourg","Bourne","Brad","Brake","Breach","Breeze","Bridge","Brook","Burg","Burn","Bury","By","Call","Camp","Castle","Chester","City","Corner","Cott","Court","Cove","Crag","Creek","Crest","Cross","Crossroad","Crown","Dag","Dale","Dane","Dark","Deep","Del","Dell","Dike","Dorf","Drake","Dune","Edge","End","Fair","Faire","Fal","Fall","Falls","Fast","Fax","Fel","Feldt","Fell","Felt","Field","Fire","Flint","Font","Ford","Forge","Forks","Forth","Full","Gard","Garde","Garden","Gardr","Gate","Gem","Gill","Glen","Glow","Grad","Grade","Grass","Grave","Grove","Guard","Guild","Hall","Hallow","Ham","Hamlet","Hand","Harbour","Haven","Head","Heart","Heed","Heim","Helm","Hill","Hold","Hollow","Holm","Holme","Holt","Home","Hood","Hope","Horse","Ington","Inlet","Island","Isle","Joy","Junction","Keep","Kraig","Lagoon","Lain","Lake","Land","Landing","Lands","Law","Leaf","Leap","Ledge","Letter","Light","Line","Lock","Lodge","Loft","Maiden","Mane","March","Marsh","Mass","Mead","Mere","Mesa","Mile","Mill","Mine","Mond","Mont","Moor","Mora","More","Morra","Mount","Mouth","Murk","Nook","Pad","Park","Pass","Path","Peak","Perch","Pier","Pike","Pine","Pines","Point","Pond","Pool","Poole","Port","Quarry","Quil","Quill","Quin","Quinn","Rain","Rapids","Ray","Reach","Reign","Rest","Ridge","Right","Ring","River","Rock","Roost","Rose","Roth","Rott","Row","Rowe","Run","Rune","Ruun","Sand","Shadow","Sharp","Sharpe","Shaw","Shield","Shine","Ship","Shire","Shore","Side","Sierra","Sigil","Snow","Sol","Son","Sor","Sound","Spear","Spot","Square","Stad","Stain","Stane","Star","Station","Stead","Steppe","Stock","Ston","Stone","Stow","Strand","Strike","Summit","Sword","Sworth","Tarn","Tear","Thorn","Thorne","Thorpe","Throw","Ton","Tower","Town","Township","Trail","Tucket","Vale","Valley","Valt","Vanguard","Vault","Veldt","View","Village","Ville","Wake","Wall","Ward","Wash","Watch","Water","Way","Weald","Well","Wharf","Wheel","Wich","Wick","Wild","Wile","Will","Wind","Wing","Wolf","Wolfe","Wood","Worth","Wright","Wyn"],new Map([["Animals",["Badger","Bat","Boar","Buck","Bull","Calf","Canary","Cat","Cattle","Chick","Chicken","Clam","Cob","Cock","Cockatiel","Cockatoo","Cockerel","Cockle","Colt","Cow","Crab","Crow","Cub","Deer","Doe","Dog","Donkey","Dove","Drake","Dray","Duck","Duckling","Ewe","Eyas","Fawn","Ferret","Foal","Fox","Frog","Gander","Gerbil","Goat","Goose","Gosling","Hamster","Hare","Hawk","Hedgehog","Hen","Heron","Horse","Jack","Jenny","Jill","Kid","Kingfisher","Kit","Kitten","Lamb","Leveret","Lobster","Mare","Mole","Mouse","Mussel","Nanny","Newt","Otter","Owl","Owlet","Oyster","Peachick","Peacock","Peafowl","Peahen","Pheasant","Pig","Pigeon","Piglet","Pike","Prickle","Pup","Puppy","Rabbit","Ram","Rat","Robin","Rook","Salmon","Sheep","Signet","Snail","Snake","Sneak","Sow","Sparrow","Spider","Squab","Squirrel","Stag","Stallion","Starling","Stoat","Swan","Tiercel","Toad","Trout","Vixen","Weasel"]],["Geography",["Basin","Bay","Bluffs","Bush","Canal","Canyon","Cave","Cliff","Crag","Crater","Creek","Dale","Down","Falls","Fern","Flats","Forest","Fork","Glacier","Grotto","Heights","Hill","Hollow","Island","Knoll","Lagoon","Lake","Marsh","Mountain","Narrows","Overlook","Pass","Peak","Plain","Pond","Ravine","Reef","Ridge","River","Sound","Tree","Vale","Valley","Woods"]],["Geology",["Agate","Aluminum","Amber","Amethyst","Basalt","Brass","Bronze","Chalk","Chrome","Clay","Coal","Copper","Coral","Diamond","Emerald","Feldspar","Flint","Gold","Granite","Gypsum","Iron","Jade","Jasper","Lead","Limestone","Marble","Mercury","Mica","Pewter","Platinum","Pyrite","Quartz","Ruby","Sandstone","Shale","Silt","Silver","Slate","Steel","Tin","Topaz"]]])},92656:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.deepWatchable=function(e){let t=(0,n.default)(e,(function(){s.forEach((e=>e(t,i))),i=t})),i=e,s=[];function o(){return t}return o.watch=function(e){s.push(e),e(t,void 0)},o.watchFuture=function(e){s.push(e)},new Proxy(o,{get:(e,i,s)=>o.hasOwnProperty(i)?o[i]:t[i]})};const n=s(i(23366))},92846:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ArrowButton=t.SelectBoxWithArrows=void 0;const s=i(86545),n=i(2426),o=i(80959),a=i(76049),r=i(96137),l=i(22663),c=i(18957);var d=Phaser.GameObjects.Container,h=Phaser.Geom.Rectangle;class u extends s.BaseResponsiveContainer{constructor(e,t){super(e),this.ui=o.UiBuilder.for(this.scene),this.leftButton=new p(this.scene,{direction:"left"}),this.rightButton=new p(this.scene,{direction:"right"}),this.background=new n.RoundedRect(this.scene,{radius:12,fillStyle:{color:r.Colors.glassUi_old.shape,alpha:.3}}),this.titleText=this.ui.text("Title",a.BitmapFont.Mini,r.Colors.glassUi_old.secondaryText),this.selectedText=this.ui.text("Selected",a.BitmapFont.Main,r.Colors.glassUi_old.primaryText),this.components=[this.background,this.leftButton,this.rightButton,this.titleText,this.selectedText],this.items=[],this.selectedItemIndex=-1,this.onSelect=(0,c.signal)(),this.add(this.components),this.height=this.leftButton.height+10,this.setProps(t),this.leftButton.onClicked((()=>{if(0===this.selectedItemIndex){if(!this.infinite)return;this.onSelect.fire({value:this.items[this.items.length-1].value,direction:"left"})}else this.onSelect.fire({value:this.items[this.selectedItemIndex-1].value,direction:"left"})})),this.rightButton.onClicked((()=>{(this.infinite||this.selectedItemIndex!==this.items.length-1)&&this.onSelect.fire({value:this.items[(this.selectedItemIndex+1)%this.items.length].value,direction:"right"})}))}setProps(e){this.titleText.setText(e.title),this.items=e.options,this.infinite=e.infinite??!1,this.setSelection(e.selectedOption)}setSelection(e){let t=this.items.findIndex((t=>t.value===e));-1===t&&(t=0),this.selectedItemIndex=t,this.selectedItem=this.items[t],this.selectedItem?(this.selectedText.setText(this.selectedItem.title),this.leftButton.setEnabled(this.infinite||0!==t),this.rightButton.setEnabled(this.infinite||t!==this.items.length-1)):(this.selectedText.setText(""),this.leftButton.setEnabled(!1),this.rightButton.setEnabled(!1))}updateLayout(){const e=10+this.leftButton.height/2,t=this.width/2;this.leftButton.setPosition(0,e-this.leftButton.height/2),this.rightButton.setPosition(this.width-this.rightButton.width,e-this.leftButton.height/2),this.background.setSize(this.width-89,this.rightButton.height-10),this.background.setPosition(44,15),this.selectedText.setOrigin(.5,.5).setPosition(t,e),this.titleText.setOrigin(.5,.5).setPosition(t,5)}}t.SelectBoxWithArrows=u;class p extends d{constructor(e,t){super(e),this.ui=o.UiBuilder.for(this.scene),this.mainImage=this.ui.image("glass-ui/arrow-button"),this.shadow=this.ui.image("glass-ui/arrow-button-shadow").setTint(r.Colors.glassUi_old.shapeShadow),this.height=this.mainImage.height,this.width=this.mainImage.width,this.mainImage.setFlipX("left"===t.direction).setOrigin("left"===t.direction?1:0,0).setInteractive({cursor:"pointer",hitArea:new h("left"===t.direction?this.mainImage.width:0,0,this.mainImage.width,this.mainImage.height),hitAreaCallback:h.Contains}),this.shadow.setPosition(0,0).setOrigin("left"===t.direction?1:0,0).setFlipX("left"===t.direction),this.add([this.shadow,this.mainImage]),this.updateLayout(l.ButtonState.Rest),void 0===t.controller?this.setController(l.ButtonControllers.simple()):null!==t.controller&&this.setController(t.controller)}setTheme(e){}get onClicked(){return this.controller.onClicked}setController(e){this.controller=e,e.bindTo(this.mainImage,(e=>this.setButtonState(e)))}setEnabled(e){this.controller.setEnabled(e)}updateLayout(e=l.ButtonState.Rest){switch(e===l.ButtonState.Disabled?(this.mainImage.setAlpha(.3),this.shadow.setVisible(!1)):(this.mainImage.setAlpha(1),this.shadow.setVisible(!0)),e){case l.ButtonState.Down:case l.ButtonState.Disabled:this.mainImage.setPosition(0,0);break;default:this.mainImage.setPosition(-2,-2)}}setButtonState(e){this.updateLayout(e)}}t.ArrowButton=p},93102:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FeedbackButton=t.FeedbackButtons=t.FeedbackForm=t.FeedbackFormMode=void 0,t.createTwitterStealthButton=P,t.createDiscordStealthButton=I;const s=i(86545),n=i(76049),o=i(96137),a=i(20087),r=i(22663),l=i(7169),c=i(6838),d=i(11466),h=i(80959),u=i(36868),p=i(54118),g=i(54825),m=i(56793),y=i(21941),f=i(55776),w=i(95428),v=i(56824),b=i(75742);var S,x=Phaser.GameObjects.BitmapText;!function(e){e.Minimal="minimal",e.SingleLine="single-line",e.Full="full",e.Thanks="thanks"}(S||(t.FeedbackFormMode=S={}));class T extends s.AutoHeightResponsiveContainer{constructor(e){super(e),this.title=new x(this.scene,0,0,n.BitmapFont.Main,"").setTint(o.Colors.glassUi_old.primaryText),this.emotionPicker=new C(this.scene),this.chosenEmotion=void 0,this.emailFieldLabel=new x(this.scene,0,0,n.BitmapFont.Mini,"").setTint(o.Colors.glassUi_old.primaryText),this.messageField=new l.TextArea(this.scene,{rows:1,maxLength:b.MAX_FEEDBACK_LENGTH,placeholder:"You can also add a comment, if you wish!",onChange:()=>{this.mode===S.SingleLine&&this.setMode(S.Full)}}),this.emailField=new c.TextInput(this.scene,{width:160,placeholder:"email@example.com"}),this.socials=function(e,t=1){const i=h.UiBuilder.for(e);return i.hLayout({layoutPolicy:p.LayoutChildrenPolicy.None,originX:t,content:[i.text("You can also",n.BitmapFont.Mini,o.Colors.glassUi_old.primaryText),P(i,"glassUi"),i.text("or",n.BitmapFont.Mini,o.Colors.glassUi_old.primaryText),I(i,"glassUi")],originY:.5,spacing:4})}(this.scene),this.ui=h.UiBuilder.for(this.scene),this.submitButton=this.ui.wood.primaryButton({text:"Send",onClicked:()=>{this.setMode(S.Thanks),this.props.onSubmit({email:this.emailField.text.trim()||void 0,comment:this.messageField.text.trim()||void 0,mood:this.chosenEmotion})}}),this.add([this.title,this.emotionPicker,this.messageField,this.emailField,this.emailFieldLabel,this.socials,this.submitButton]),this.emailField.node.type="email",this.messageField.setVisible(!1),this.submitButton.setVisible(!1),this.socials.setVisible(!1),this.emotionPickerCtl=r.ButtonControllers.options({1:this.emotionPicker.buttons[0],2:this.emotionPicker.buttons[1],3:this.emotionPicker.buttons[2],4:this.emotionPicker.buttons[3],5:this.emotionPicker.buttons[4]}),this.emotionPickerCtl.onButtonClicked((({key:e,pointer:t})=>{this.emotionPickerCtl.selectButton(e),this.emotionPicker.buttons[Number(e)-1].animate(),this.chosenEmotion=Number(e),this.messageField.visible||(this.messageField.setVisible(!0),this.preUpdate.makeDirty(),this.mode===S.Minimal&&this.setMode(S.SingleLine))}))}setMode(e){this.mode=e,this.preUpdate.force()}applyProps(e){this.props=e,e.chosenEmotion&&this.emotionPickerCtl.selectButton(e.chosenEmotion.toString()),this.mode=e.mode,this.chosenEmotion=e.chosenEmotion,this.titleText=e.title,this.subtitleText=e.subtitle,this.emailField.setValue(e.email??""),this.messageField.setValue(e.message??""),this.emotionPicker.setLabel(e.subtitle),this.preUpdate.makeDirty(),e.autoFocus&&this.messageField.node.focus()}updateLayout(){switch(this.title.setMaxWidth(this.width),this.emotionPicker.width=this.width,this.mode===S.Thanks?(this.title.setText("Thank you so much!"),this.emotionPicker.setVisible(!1)):(this.title.setText(this.titleText),this.emotionPicker.setVisible(!0)),this.emailFieldLabel.setText((g.app.device.uiVariant()===d.UiVariant.Large?"<- ":"")+"Add email if you'd like to hear back from me!"),this.mode){case S.Thanks:case S.Minimal:this.messageField.setVisible(!1),this.socials.setVisible(!1),this.submitButton.setVisible(!1),this.emailField.setVisible(!1),this.emailFieldLabel.setVisible(!1);break;case S.SingleLine:this.messageField.setVisible(!0),this.socials.setVisible(g.app.device.uiVariant()===d.UiVariant.Large),this.submitButton.setVisible(!0),this.emailField.setVisible(!1),this.emailFieldLabel.setVisible(!1),this.messageField.resizeToRows(1),this.messageField.node.placeholder="You can also add a comment, if you wish!";break;case S.Full:this.messageField.setVisible(!0),this.messageField.node.placeholder="Write your message here",this.socials.setVisible(g.app.device.uiVariant()===d.UiVariant.Large),this.submitButton.setVisible(!0),this.emailField.setVisible(!0),this.emailFieldLabel.setVisible(!0),this.messageField.resizeToRows(3),this.messageField.displayHeight=this.messageField.height}this.messageField.width=this.width;const e=[this.title,this.emotionPicker,this.messageField,...g.app.device.uiVariant()===d.UiVariant.Compact?[this.emailFieldLabel]:[],this.emailField,this.submitButton];a.Arrange.alignX({content:e,x:0,origin:0}),a.Arrange.topToBottom({content:e,y:0,origin:0,spacing:10}),this.socials.setPosition(this.width,this.submitButton.y+this.submitButton.height-this.socials.height),g.app.device.uiVariant()===d.UiVariant.Large&&this.emailFieldLabel.setPosition(this.emailField.x+this.emailField.displayWidth+8,this.emailField.y+this.emailField.displayHeight/2-this.emailFieldLabel.height/2),this.updateSize()}calculateHeight(){let e;switch(this.mode){case S.Thanks:e=this.title;break;case S.Minimal:e=this.emotionPicker;break;case S.SingleLine:case S.Full:e=this.submitButton}return e.y+e.height}}function P(e,t){return e.stealthButton({text:"Tweet at me",theme:t,height:20,icon:{image:"ui/icons/twitter",scale:.5,tintWithText:!0},iconPlacement:"left",onClicked:()=>v.events.trigger(u.UserActions.SendTweet())})}function I(e,t){return e.stealthButton({text:"Join the Discord server",theme:t,height:20,icon:{image:"ui/icons/discord",scale:.5,tintWithText:!0},iconPlacement:"left",onClicked:()=>v.events.trigger(u.UserActions.JoinDiscord())})}t.FeedbackForm=T;class C extends s.ResponsiveContainer{constructor(e){super(e),this.label=new x(this.scene,0,0,n.BitmapFont.Small,"Your feedback matters!").setTint(o.Colors.glassUi_old.primaryText),this.buttons=[new A(e,1),new A(e,2),new A(e,3),new A(e,4),new A(e,5)],this.add([...this.buttons,this.label]),this.height=this.buttons[0].height}updateLayout(){a.Arrange.leftToRight({content:[...this.buttons,{size:2},this.label],x:0,spacing:6,origin:0}),this.label.y=this.buttons[0].height/2-this.label.height/2;const e=this.label.x+this.label.width;this.label.setVisible(e<this.width)}setLabel(e){this.label.setText(e),this.preUpdate.makeDirty()}}t.FeedbackButtons=C;const M={5:0,4:.3,3:.5,2:.7,1:1};class A extends s.ResponsiveContainer{setTheme(e){}constructor(e,t){super(e),this.mood=t,this.button=new m.BoxButton_LEGACY(this.scene,0,0,{text:"",width:40,height:40,baseTexture:y.BoxTextures.DialogButton,downTexture:y.BoxTextures.DialogButtonDown}),this.emoji=new f.EmojiObject(g.app.scene.globalUI.objectsPool),this.onClicked=this.button.onClicked,this.add([this.button,this.emoji.container]),this.width=this.button.width,this.height=this.button.height,this.emoji.container.x=this.width/2,this.emoji.container.y=this.height/2;const i=M[t]??.5;this.emoji.setAttitude(.5,i),this.button.onStateChanged((e=>{const t=e===r.ButtonState.Down?2:0;this.emoji.container.x=this.width/2+t,this.emoji.container.y=this.height/2+t}))}animate(){switch(this.mood){case 1:this.emoji.showEmotion(w.EmojiEmotion.VeryShocked,500),this.emoji.reactWithShock(10);break;case 2:this.emoji.showEmotion(w.EmojiEmotion.Shocked,500),this.emoji.reactWithShock(5);break;case 3:this.emoji.showEmotion(w.EmojiEmotion.Doubtful,500),this.emoji.reactWithShock(3);break;case 4:this.emoji.showEmotion("4",700),this.emoji.reactWithShock(3),this.emoji.reactWithHearts(3);break;case 5:this.emoji.showEmotion("4",700),this.emoji.reactWithShock(3),this.emoji.reactWithHearts(5)}}setController(e){this.button.setController(e)}setEnabled(e){this.button.setEnabled(e)}}t.FeedbackButton=A},93209:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LowUpkeepPlugin=void 0;const s=i(18497),n=i(24598),o=i(1326);t.LowUpkeepPlugin={name:s.PluginKey.LowUpkeep,register(e){e.rules.adjustBuyableObjects.register((e=>(0,o.stripDuplicatesFrom)([...e,n.PawnType.Town]))),e.rules.adjustRuleset.register((e=>({...e,pawns:{...e.pawns,[n.PawnType.Pikeman]:{...e.pawns[n.PawnType.Pikeman],upkeep:4},[n.PawnType.Knight]:{...e.pawns[n.PawnType.Knight],upkeep:8},[n.PawnType.Hero]:{...e.pawns[n.PawnType.Hero],upkeep:16}}})))}}},93413:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TwoPointersTracker=void 0;const s=i(56824),n=i(1326),o=i(49796),a=i(91622);var r;s.logger.for("TwoPointersTracker"),function(e){e.Idle="idle",e.InteractionStarted="interaction-started",e.Drag="drag",e.Pinch="pinch"}(r||(r={})),t.TwoPointersTracker=class{constructor(e){this.scene=e,this.pointers=[],this.pointerMoved={},this.state=r.Idle,this.scene.input.on("pointerdown",this.onPointerDown,this),this.scene.input.on("pointerup",this.onPointerUp,this),this.scene.input.on("gameout",this.dragCancel,this),this.scene.input.on("pointermove",this.onPointerMove,this)}_tryInitiateDrag(e){return!!a.inject.ui.pointerDragLock.acquire()&&(this.onStartDrag(e),this.state=r.Drag,!0)}_endDrag(e){a.inject.ui.pointerDragLock.release(),this.onEndDrag(e)}onPointerDown(e,t){if(2!==this.pointers.length&&-1===this.pointers.indexOf(e))switch(this.pointerMoved[e.id]=!1,this.pointers.push(e),this.state){case r.Idle:this.hasInteraction(e,t)?(this.onStartInteraction(e,t),setTimeout((()=>this.transitionToDrag(e)),200),this.state=r.InteractionStarted):this._tryInitiateDrag(e);break;case r.InteractionStarted:this.state=r.Pinch,this.onAbortInteraction(e),this.onStartPinch(e);break;case r.Drag:this.state=r.Pinch,this._endDrag(e),this.onStartPinch(e)}}onPointerUp(e,t){if(a.inject.ui.pointerDragLock.release(),-1!==this.pointers.indexOf(e))switch((0,n.removeFromArrayInPlace)(this.pointers,e),this.state){case r.InteractionStarted:this.state=r.Idle,this.onCompleteInteraction(e,t);break;case r.Drag:this._endDrag(e),this.state=r.Idle;break;case r.Pinch:this.onEndPinch(e),this._tryInitiateDrag(e)||(this.state=r.Idle)}else this.onCompleteInteraction(e,t)}onPointerMove(e){if(e.isDown&&(this.pointerMoved[e.id]||(this.pointerMoved[e.id]=e.x!==e.downX||e.y!==e.downY),this.pointerMoved[e.id]))switch(this.state){case r.Drag:this.onDrag(e);break;case r.Pinch:this.onPinch(e)}}transitionToDrag(e){this.state===r.InteractionStarted&&this._tryInitiateDrag(e)}dragCancel(){return this.state===r.Pinch&&this.onEndPinch(this.scene.input.activePointer),this.state===r.Drag&&this._endDrag(this.scene.input.activePointer),this.clear(),this}hasInteraction(e,t){return!1}clear(){this.pointers.length=0,this.pointerMoved={},this.state=r.Idle}get distanceBetweenPointers(){if(this.state!==r.Pinch)return 0;const e=this.pointers[0],t=this.pointers[1];return(0,o.euclidDistance)(e,t)}onStartDrag(e){}onStartInteraction(e,t){}onAbortInteraction(e){}onCompleteInteraction(e,t){}onEndDrag(e){}onStartPinch(e){}onEndPinch(e){}onDrag(e){}onPinch(e){}}},93525:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.JSONEditor=void 0;const n=i(9557),o=i(54825),a=i(98963),r=i(56824),l=i(36868),c=s(i(88358));class d extends n.ResponsiveDOMContent{constructor(e){super(e,"json-editor",{suppressEvents:!1}),this.addListener("keydown"),this.on("keydown",(e=>{e.stopPropagation(),"Escape"===e.key&&r.events.trigger(l.UserActions.JSONEditorCancel())})),this.dom={editor:document.getElementById("jsoneditor-editor"),saveButton:document.getElementById("jsoneditor-save"),cancelButton:document.getElementById("jsoneditor-cancel")},this.editor=new c.default(this.dom.editor,{mode:"code",onChange:async()=>{this.dom.saveButton.disabled=!0;const e=await this.editor.validate();this.dom.saveButton.disabled=e.length>0}}),this.dom.saveButton.onclick=()=>{o.app.audio.playEffect(a.SoundEffects.ButtonUp),r.events.trigger(l.UserActions.JSONEditorSave({json:this.editor.get()}))},this.dom.cancelButton.onclick=()=>{o.app.audio.playEffect(a.SoundEffects.ButtonUp),r.events.trigger(l.UserActions.JSONEditorCancel())}}focus(){this.editor.focus()}setJSON(e){this.editor.set(e)}getJSON(){return this.editor.get()}}t.JSONEditor=d},93785:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handlesAutoSizeChildren=function(e){return"function"==typeof e.handleChildResize}},93862:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tabSwitcherStory=void 0;const s=i(80959),n=i(51216),o=i(2543),a=i(76049),r=i(96604),l=i(95070);t.tabSwitcherStory={name:"TabSwitcher",content:e=>{const t=s.UiBuilder.for(e);return[{name:"vertical tab switcher",backgroundColor:e=>e.oceanShades.dark3,component:function(){const t=new n.VerticalTabSwitcher(e,{width:40,tabHeight:40,allowDeselection:!0});return t.setTabs(["ui/button-icons/menu","ui/button-icons/settings","ui/button-icons/bug-report","ui/button-icons/help"].map(((t,i)=>({key:t,content:new l.IconOnly(e,t),tooltip:`Tab ${i+1}: ${t}`})))),t.onTabSelected((e=>{console.log("Selected tab:",e)})),t}()},{name:"horizontal tab switcher",backgroundColor:e=>e.oceanShades.dark3,component:function(){const i=new n.HorizontalTabSwitcher(e,{tabWidth:60,height:60,glintSize:30,allowDeselection:!1});function s(i){return new r.IconAndText(e,{icon:t.image(`ui/button-icons/${i}`),text:t.text((0,o.capitalize)(i),a.BitmapFont.Mini,0),layout:r.BUTTON_LAYOUT.iconAbove,spacing:4,tintIcon:!0})}return i.setTabs([{key:"menu",content:s("menu"),tooltip:"Menu"},{key:"settings",content:s("settings"),tooltip:"Settings"},{key:"bug-report",content:s("bug-report"),tooltip:"Bug Report"},{key:"help",content:s("help"),tooltip:"Help"}]),i}()}]}}},93868:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BOUNDS=t.MenuPanelBounds=t.MapEditorSidebarBounds=t.SidebarPanelBounds=t.MainBoundsProvider=t.FullScreenBoundsProvider=t.BaseBoundsProvider=void 0;const s=i(54825),n=i(11466),o=i(91622),a=i(52528),r=i(9292),l=i(76540);class c{get x(){return 0}get y(){return 0}get contentLeft(){return this.width<=n.MAX_CONTENT_WIDTH?0:Math.trunc((this.width-n.MAX_CONTENT_WIDTH)/2)}get contentWidth(){return(0,r.pickSmaller)(this.width,n.MAX_CONTENT_WIDTH)}get contentRight(){return this.width<=n.MAX_CONTENT_WIDTH?this.width:this.contentLeft+n.MAX_CONTENT_WIDTH}get centerX(){return this.width/2}get centerY(){return this.height/2}}t.BaseBoundsProvider=c;class d extends c{get width(){return s.app.device.screenWidth}get height(){return s.app.device.screenHeight}}t.FullScreenBoundsProvider=d;class h extends c{get width(){return s.app.device.uiVariant()!==n.UiVariant.Compact&&o.inject.ui.sidebarMode()?s.app.device.screenWidth-a.SIDEBAR_LAYOUT.totalWidth:s.app.device.screenWidth}get height(){return s.app.device.screenHeight}}t.MainBoundsProvider=h;class u extends c{get x(){return s.app.device.uiVariant()===n.UiVariant.Compact?0:s.app.device.screenWidth-a.SIDEBAR_LAYOUT.totalWidth}get width(){return s.app.device.uiVariant()===n.UiVariant.Compact?s.app.device.screenWidth:a.SIDEBAR_LAYOUT.totalWidth+a.SIDEBAR_LAYOUT.separatorWidth}get height(){return s.app.device.screenHeight}}t.SidebarPanelBounds=u;class p extends c{constructor(){super(...arguments),this.width=l.MAP_EDITOR_SIDEBAR_WIDTH}get x(){return s.app.device.screenWidth-l.MAP_EDITOR_SIDEBAR_WIDTH}get height(){return s.app.device.screenHeight}}t.MapEditorSidebarBounds=p;class g extends c{get x(){return s.app.device.uiVariant()===n.UiVariant.Compact||s.app.device.contentLeft<100?0:s.app.device.contentLeft}get width(){if(s.app.device.uiVariant()===n.UiVariant.Compact)return s.app.device.screenWidth;{const e=450,t=650,i=o.inject.ui.sidebarMode()?a.SIDEBAR_LAYOUT.totalWidth:0,n=s.app.device.screenWidth-i-this.x;return n<t?n:(0,r.pickSmaller)(e,n)}}get height(){return s.app.device.screenHeight}}t.MenuPanelBounds=g,t.BOUNDS={Main:new h,FullScreen:new d,SidePanel:new u,MenuPanel:new g,MapEditorSidebar:new p}},93938:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelListBounds=void 0;const s=i(93868),n=i(83221),o=i(54825),a=i(9292);class r extends s.BaseBoundsProvider{get x(){return n.MenuHeaderUIScene.Layout.backgroundMargin}get y(){return n.MenuHeaderUIScene.Layout.attachmentTop+34}get width(){return(0,a.pickSmaller)(n.MenuHeaderUIScene.Layout.backgroundMinWidth,o.app.device.screenWidth)}get height(){return o.app.device.screenHeight-this.y-n.MenuHeaderUIScene.Layout.wavesHeight-8}}t.LevelListBounds=r},94223:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelScriptRunner=void 0;const s=i(56824),n=s.logger.for("LevelScriptRunner");t.LevelScriptRunner=class{constructor(e){this.registry=e,this.currentScript=void 0}setScript(e){const t=this.getNewScriptByName(e);if(this.currentScript)try{this.currentScript.deactivate()}catch(e){s.errors.handleNonFatalError(e,`deactivating script ${this.currentScriptName}`)}if(this.currentScript=t,this.currentScriptName=e,t){n.info(`Activating level script ${e}`);try{t.activate()}catch(t){s.errors.handleNonFatalError(t,`activating script ${e}`)}}}getNewScriptByName(e){if(e)try{return e?this.registry.getScript(e):void 0}catch(e){s.errors.handleNonFatalError(e,"invalid level script"),this.setScript(void 0)}}}},94231:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AutoPrompts=void 0;const s=i(36868),n=i(56824),o=i(21992),a=i(66143),r=i(91622),l=i(54825),c=["intro1","l-tutorial2"];n.logger.for("AutoPrompts"),t.AutoPrompts=class{constructor(){n.events.on(s.SystemEvents.FatalError,(({correlationId:e,message:t})=>{l.app.notifications.uncaughtError(e)})),n.events.on(s.SystemEvents.ScreenActivated,(async e=>{const t=[l.app.screen.play,l.app.screen.defeat],i=r.inject.ui.selectedLevelId();if(i&&(e.screen===l.app.screen.overworld||e.screen===l.app.screen.victory)&&e.previousScreen&&t.includes(e.previousScreen)){if(!window.navigator.onLine)return;if(l.app.screen.play.isReplay)return;const e=r.inject.userData.recallChoice("dismissedFeedbackForm")??0;if((0,o.differenceInDays)(Date.now(),e)<1)return;if(r.inject.levelSession.getTotalSeconds()<=60)return;if(r.inject.userData.current.levelFeedbacksSubmitted.includes(i))return;if(c.includes(i))return;const t=a.LevelModel.for(i).expeditionContext?.expedition?.id;if(!t)return;if("all"!==n.config.feedbackPrompts.expeditions&&!n.config.feedbackPrompts.expeditions.includes(t))return;l.app.notifications.askForLevelFeedback(i)}}))}}},94233:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinStack=t.COIN_SPRITE_SCALE=t.COIN_THICKNESS=t.COIN_FACE_SIZE=void 0,t.consumeCoin=h;const s=i(56824),n=i(79573),o=i(63617),a=i(2543),r=i(97849),l=i(91622);var c=Phaser.GameObjects.Container;const d=s.logger.for("coins");async function h(e,t,i,s){if(!l.inject.ui.skipTransitions())return new Promise((n=>{e.scene.tweens.add({targets:t,x:i,y:s,ease:"Sine.easeInOut",duration:300,onComplete:()=>{n(),setTimeout((()=>e.free(t)),10)}})}));e.free(t)}t.COIN_FACE_SIZE=5,t.COIN_THICKNESS=2,t.COIN_SPRITE_SCALE=.5,t.CoinStack=class extends c{constructor(e,t){super(e.scene,0,0),this.pools=e,this.capacity=t,this.currentAmount=0,(0,o.assignObjId)(this)}addToTile(e,t,i){e.addObject(this,t,i)}removeFromTile(e){e.removeObject(this)}remainingCapacity(){return this.capacity-this.currentAmount}acquireSprites(){this.column=this.pools.getCoinStack(0,0),this.topCoin=this.pools.getCoin(0,-t.COIN_THICKNESS),this.cropRect=new Phaser.Geom.Rectangle(0,this.column.height-t.COIN_THICKNESS,this.column.width,t.COIN_THICKNESS),this.column.setCrop(this.cropRect),this.add([this.column,this.topCoin])}acquireSpritesIfNeeded(){this.column||this.acquireSprites()}updateSize(){if(this.stopAllTransitions(),0!==this.currentAmount){const e=this.getTargetSize();this.acquireSpritesIfNeeded(),r.assert.defined(this.topCoin),r.assert.defined(this.column),this.topCoin.y=this.column.y-e,this.topCoin.setAlpha(this.currentAmount>0?1:0),this.cropRect=new Phaser.Geom.Rectangle(0,this.column.height-e/t.COIN_SPRITE_SCALE,this.column.width,e/t.COIN_SPRITE_SCALE),this.column.setCrop(this.cropRect)}else this.freeSpritesIfEmpty()}getTargetSize(){return this.getSizeForAmount(this.currentAmount)}getSizeForAmount(e){return 0===e?t.COIN_THICKNESS:e*t.COIN_THICKNESS+1}freeSpritesIfEmpty(){0===this.currentAmount&&(this.column&&(this.remove(this.column),this.pools.free(this.column),this.column=void 0),this.topCoin&&(this.remove(this.topCoin),this.pools.free(this.topCoin),this.topCoin=void 0))}stopAllTransitions(){this.currentTransition&&(this.currentTransition.forEach((e=>e.stop())),this.currentTransition=void 0)}transitionSize(){return new Promise((e=>{let i=this.getTargetSize();const s=Math.abs(i-(this.cropRect?.height||0));if(0===s)return void e();const n=10*s;this.stopAllTransitions(),this.acquireSpritesIfNeeded(),r.assert.defined(this.column),this.currentTransition=[this.scene.tweens.add({targets:this.cropRect,height:i/t.COIN_SPRITE_SCALE,y:this.column.height-i/t.COIN_SPRITE_SCALE,duration:n,onUpdate:()=>this.column.setCrop(this.cropRect)}).on(Phaser.Tweens.Events.TWEEN_COMPLETE,(()=>{this.freeSpritesIfEmpty(),e()})),this.scene.tweens.add({targets:this.topCoin,props:{y:{duration:n,value:this.column.y-i},alpha:{value:1,duration:0}}})]}))}addCoins(e,t=a.noop){e>this.remainingCapacity()?this.currentAmount=this.capacity:this.currentAmount+=e,l.inject.ui.skipTransitions()?(this.updateSize(),t()):this.transitionSize().then(t)}consumeCoins(e){this.currentAmount<this.capacity&&(this.currentAmount+=e.length),l.inject.ui.skipTransitions()?(e.forEach((e=>this.pools.free(e))),this.updateSize()):e.forEach(((e,t)=>{const i=this.y-this.getSizeForAmount(this.currentAmount-t);e.setDepth(n.WorldLayers.TileObjects+this.y-.01*i),h(this.pools,e,this.x,i).then((()=>this.updateSize()))}))}spawnCoin(){this.acquireSpritesIfNeeded();const e=this.y-this.getTargetSize();this.currentAmount-=1;const t=this.pools.getCoin(this.x,e);return this.updateSize(),t}destroy(){this.stopAllTransitions(),this.currentAmount=0,this.freeSpritesIfEmpty(),super.destroy()}deleteCoins(e,t=a.noop){this.currentAmount<e?(d.warning(`Attempted to delete ${e} coins to a stack that already has only ${this.currentAmount}/${this.capacity} coins. Extra coins not deleted.`),this.currentAmount=0):this.currentAmount-=e,l.inject.ui.skipTransitions()?(this.updateSize(),t()):this.transitionSize().then(t)}}},94330:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.describeScreenPlay=function(e){return`[ScreenPlay]\n- gameEvents:\n${e.gameEvents.map((e=>"  - "+(0,o.describeEvent)(e)+`(regions ${a.GameEventModel.of(e).getFocusRegionIds().join(", ")} factionId ${a.GameEventModel.of(e).getFocusFactionId()})`)).join("\n")}\n- worldUpdates:\n${e.worldUpdates.map((e=>`${e.updates.map((e=>`   - ${e.type}(${(0,n.default)(e)})`)).join("\n")} (affected regions: ${e.affectedRegions.join(",")})`)).join("\n")}\n- affectedRegions: ${e.affectedRegions.join(",")}\n- focusRegions: ${e.focusRegions.join(",")}\n- highlightHexes: ${e.highlightHexes.join(",")}\n- forceFullSync: ${e.forceFullSync}`};const n=s(i(81401)),o=i(36868),a=i(34562)},94382:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AnalyticsReporter=void 0;const s=i(36868),n=i(37208),o=i(68243),a=i(56824);t.AnalyticsReporter=class{constructor(){a.events.on(s.SystemEvents.UserSignedIn,(({userId:e})=>{o.Firebase.analytics&&(0,n.setUserId)(o.Firebase.analytics,e)}))}setUserProperties(e){o.Firebase.analytics&&(0,n.setUserProperties)(o.Firebase.analytics,e)}setDefaultEventParams(e){(0,n.setDefaultEventParameters)(e)}}},94399:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseModel=t.MutableStateProvider=t.ReadonlyStateProvider=void 0;const s=i(75136);class n{constructor(e){this.state=e}get(){return this.state}set(e){throw new Error("Attempt to mutate read-only state model is read only")}}t.ReadonlyStateProvider=n;class o{constructor(e){this.stateEngine=e}get(){return this.stateEngine.currentState}set(e){this.stateEngine.setState(e)}}t.MutableStateProvider=o,t.BaseModel=class{constructor(e){this.stateProvider=e instanceof s.StateEngine?new o(e):new n(e)}get state(){return this.stateProvider.get()}set state(e){this.stateProvider.set(e)}}},94624:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getAppController=function(e){switch(e){case"standard":default:return new s.GameAppController;case"storybook":return new n.StorybookAppController;case"scalingpoc":return new o.ScalingPOC;case"replaybrowser":return new a.ReplayBrowserAppController}};const s=i(84842),n=i(88744),o=i(22913),a=i(83879)},94789:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createAIControls=function(e){const t=[],i={faction:"all",controlledBy:n.FactionController.Ai,preset:"competitive",personality:{...s.DEFAULT_AI_PERSONALITY},credit:g,"What's this?":()=>window.open("https://www.konkr.io/update/2022/12/12/ai-beta-test-guide.html","_blank")?.focus()},m=e.add(i,"faction",["all",1,2,3,4,5,6]).onChange((function(e){let t="all"===e?void 0:a.inject.gameStateModel.factions.byId(e);const s=t?t.liveHexes:h.HexGroup.union(a.inject.gameStateModel.regions.all().filter((e=>e.isAlive())).map((e=>e.hexes)));r.app.scene.worldMap.overlays.selectedRegionHighlight.clear(),r.app.scene.worldMap.overlays.selectedRegionHighlight.setHexes(s,16777215),r.app.scene.worldMap.overlays.conquerableHexesHighlight.clear(),function(e){i.faction=e,I()}(e)})),y=e.add(i,"controlledBy",Object.values(n.FactionController)).onChange((function(){P((e=>{e.setController(i.controlledBy)}))})),f=e.addFolder("playstyle");f.open();const w=f.add(i,"preset",Object.keys(s.AI_PERSONALITY_PRESETS)).onChange((function(){const e=s.AI_PERSONALITY_PRESETS[i.preset];e&&(Object.assign(i.personality,e),T(),I())})),v=e.addFolder("credit"),b=(0,o.debounce)((()=>{T(),I()}),300,{trailing:!0}),S=["daring","combative","ambitious","honorable","attackSkill","defenseSkill"];for(let e of S)f.add(i.personality,e,0,1,.05).onChange(b);function x(){const e=i.faction;let t="all"===e?void 0:a.inject.gameStateModel.factions.byId(e);if(t?.isAlive())return t}function T(){P((e=>{e.controller===n.FactionController.Ai&&e.setAiPersonality({...i.personality})}))}function P(e){const t=x();if(t)e(t);else{const t=a.inject.gameStateModel.factions.all().filter((e=>!e.isNeutral()&&1!==e.id));for(let i of t)e(i)}}function I(){t.forEach((e=>e.remove())),t.length=0;let d=x();if(d){v.show();const e=a.inject.gameStateModel.factions.all().filter((e=>e.isAlive()&&!e.isNeutral()));(0,c.updateDropdownOptions)(m,["all",...e.map((e=>e.id.toString()))]),i.faction=d.id,Object.assign(i.personality,d.basePersonality),Object.assign(i.credit,{...g,...l.AI.getFactionCredit(a.inject.currentGameState,d.id)}),i.controlledBy=d.controller??n.FactionController.None;for(const s of e)t.push(v.add(i.credit,s.id.toString(),-2,2,.05).onChange((e=>{l.AI.changeFactionCredit(a.inject.currentGameState,d.id,s.id,(()=>e)),r.app.scene.worldMap.overlays.attitudeEmojis.syncWithModel(a.inject.gameStateModel)})))}else i.faction="all",v.hide(),d=a.inject.gameStateModel.factions.all().find((e=>e.controller===n.FactionController.Ai)),i.controlledBy=d?.controller??n.FactionController.None,Object.assign(i.personality,d?.basePersonality??s.DEFAULT_AI_PERSONALITY);if(d){const e=Object.entries(s.AI_PERSONALITY_PRESETS).find((([e,t])=>(0,o.isEqual)(t,d.basePersonality)))?.[0]??"(custom)";i.preset=e,(0,c.setDropdownSelection)(w,e)}(0,c.setDropdownSelection)(m,i.faction.toString()),(0,c.setDropdownSelection)(y,i.controlledBy),e.updateDisplay()}a.inject.gameStateController.onEvent((e=>{(0,u.isEvent)(e,d.GameStateEvents.NewGameState)&&I()})),p.events.on(d.GameStateEvents.HexCaptured,I),I()};const s=i(8971),n=i(24598),o=i(2543),a=i(91622),r=i(54825),l=i(70712),c=i(82265),d=i(36868),h=i(20693),u=i(39420),p=i(56824),g={1:0,2:0,3:0,4:0,5:0,6:0}},94917:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CHATTER_DEFS=void 0,t.updateChatterRules=function(e){t.CHATTER_DEFS=e},t.CHATTER_DEFS=[{tags:["suffered major damage","angry reaction","not weaker"],lines:["You think you can challenge the master of death?","Your army marches to its doom.","I am eternal! Your efforts are in vain, mortal.","Your bravery is futile, mortal.","Your victory will be short-lived, for I am death incarnate.","Your attacks are like whispers in a hurricane, insignificant and fleeting.","In the end, it is you who will despair, not I.","You'll see the futility of your efforts soon enough.","I am eternal, unyielding, and I will outlast you in the end.","I am the master of life and death, your resistance is futile.","With each strike, you draw closer to your own demise."]},{tags:["suffered major damage","angry reaction","much weaker"],lines:["The darkness will rise again, and your fleeting resistance will be but a memory in the void!","In the end, you shall all serve me in the afterlife!","Your fleeting triumph is but a speck in the grand tapestry of my undying existence.","Strike me down as many times as you wish, but I'll always rise again.","I will rise again, and the world will kneel before my power!","Your victory is temporary; my determination is eternal."]},{tags:["caused major damage"],lines:["Witness the might of the undead!","Welcome to the end of days.","Your fate is sealed.","You can't withstand the tide of the dead.","Behold the power of the eternal night!","Pathetic mortals.","Your defeat was written in the stars, your lands destined for oblivion.","Death is eternal!","The darkness will consume you. There's no escape!"]},{tags:["not weaker"],lines:["Embrace the void that awaits you.","You can't withstand the tide of the dead.","Your existence is nothing but a fleeting shadow.","Mere mortal, your struggle is in vain.","Your arrival was foretold, as was your demise. Welcome to the abyss.","The living are but fleeting flames, while I am the eternal darkness.","Death's embrace is inevitable.","Face oblivion!","Your hope is futile, for in the end, all things succumb to the embrace of death.","You face a force beyond mortal comprehension.","Death is my ally, and I am its harbinger."]},{tags:["weaker"],lines:["You underestimate the depths of my determination.","I am unyielding, undying. You cannot destroy what cannot be broken.","What is dead may never die.","You'll never escape the shadow I cast upon your world.","You think you can vanquish the master of death? Think again.","I will not yield to the likes of you, even in the face of annihilation.","I am an eternal force, I shall never bow to the likes of you!","You can't change the course of destiny, I am its architect."]}]},94958:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HeaderButton=t.StatusHeaderUI=void 0;const s=i(86545),n=i(80959),o=i(76049),a=i(96137),r=i(20087),l=i(36868),c=i(49527),d=i(54825),h=i(56824);var u=Phaser.GameObjects.Image;class p extends s.BaseResponsiveContainer{constructor(e,t){super(e),this.visibility=t,this.ui=n.UiBuilder.for(this.scene),this.icon=this.ui.image("ui/icons/hand"),this.background=this.ui.rectangle(a.Colors.tooltip.background),this.description=this.ui.text("description",o.BitmapFont.Small,a.Colors.tooltip.text),this.exitButton=new g(this.scene,"ui/button-icons/exit",(()=>{h.events.trigger(l.UserActions.ReturnHeldPawn())})),this.add([this.background,this.icon,this.description,this.exitButton])}updateLayout(){this.width=this.scene.bounds.width,this.height=32,this.background.setSize(this.width,this.height),r.Arrange.leftToRight({content:[{object:this.icon},{object:this.description}],spacing:10,x:10}),r.Arrange.leftToRight({content:[this.exitButton],spacing:6,x:this.width-1,origin:1}),r.Arrange.alignY({content:[this.icon,this.description,this.exitButton],y:16,origin:.5})}updateState(e){e?(d.app.scene.globalUI.sidebarButtons.hide(),this.visibility.transitionTo(1),this.description.setText(`${e.context} ${e.name}`)):(this.visibility.transitionTo(0),d.app.scene.globalUI.updateLayout())}}t.StatusHeaderUI=p;class g extends c.StealthButton_LEGACY{constructor(e,t,i){super(e,{content:new u(e,0,0,"atlas",t),radius:4,height:30,width:34}),this.onClicked(i)}}t.HeaderButton=g},95070:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IconOnly=t.Image=void 0,t.Image=Phaser.GameObjects.Image;const s=i(83903),n=i(36257),o=i(80959);class a extends s.CenterLayout{constructor(e,t){const i=o.UiBuilder.for(e).createIcon(t);super(e,i),this.iconRecipe=t,this.content=i}setFrame(e){if(!(this.content instanceof t.Image))throw Error(`IconOnly can only set frame on Image objects (not ${this.content.constructor?.name}) `);this.content.setFrame(e),this.updateLayout()}setImage(e){this.content.destroy(),this.content=e,this.add(this.content),this.preUpdate.makeDirty()}setTextColor(e){(0,n.isTintAllowed)(this.iconRecipe)&&(this.content.setTint(e.color),this.content.setAlpha(e.alpha??1))}}t.IconOnly=a},95073:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ObjectiveAttackHex=t.ExplainCutOffEnemyVillagers=t.ExplainRebellion=t.InspectingLedger=t.InspectingRival=t.Tutorial1=void 0;const s=i(24598),n=i(97849),o=i(45664),a=i(37971),r=i(36868),l=i(91622),c=i(54825),d=i(12167),h=i(34174),u=i(1565),p=i(71021),g=i(95428),m=i(19618),y=i(56824);t.Tutorial1=class{constructor(){this.step1_selectVillager=new B(this),this.step2_captureHex=new E(this),this.step3_buyAnotherVillager=new O(this),this.step4_mergeVillagers=new R(this),this.step5_undoMerge=new k(this),this.step6_buyAgain=new L(this),this.step7_captureAnotherHex=new _(this),this.step8_endTurn=new D(this),this.objectiveConnectTerritory=new H(this),this.connectTerritorySuccess=new U(this),this.objectiveAttackHex=new j(this),this.objectiveGetPikeman=new F(this),this.reselectRegion=new A(this),this.derailed=new G(this),this.inspectingRival=new P(this),this.inspectingLedger=new I(this),this.negativeIncomeAlert=new T(this),this.explainRebellion=new C(this),this.explainCutOffEnemyVillagers=new M(this),this.warnAboutExpensiveKnight=new S(this),this.warnAboutExpensiveHero=new x(this),this.main=new f(this),this.idle=new b(this)}};class f extends a.LevelScript{activate(){super.activate(),l.inject.ai.maxAllowedUnitMight=1,l.inject.ai.allowSurrender=!1,c.app.scene.globalUI.notifications.clearToastsByCategory(u.NotificationCategory.SurrenderOffer);const e=l.inject.gameStateModel.currentPhase;return 1===e.turnNumber&&1===e.getMovablePawns().length?(c.app.scene.playUI.updateState({layout:{name:"hidden"}}),this.goTo("step1_selectVillager")):N()?this.goTo("explainRebellion"):(l.inject.gameStateModel.factions.localPlayer?.getLargestLiveRegion()?.budget.balance??0)<0?this.goTo("negativeIncomeAlert"):!V()&&l.inject.gameStateModel.currentPhase.faction?.isLocalPlayer()&&l.inject.gameStateModel.currentPhase.getMovablePawns().length>0?this.goTo("objectiveConnectTerritory"):Y()>0?this.goTo("explainCutOffEnemyVillagers"):W()?this.goTo("objectiveAttackHex"):void this.goTo("idle")}deactivate(){super.deactivate()}}class w extends a.LevelScript{activate(e){super.activate(),c.app.scene.playUI.updateState({tutorialArrow:e?.tutorialArrowTarget??null,tutorialFrame:e?.tutorialFrameTarget??null,worldMapPanel:e?.worldMapPanel??null}),this.onEvent(r.UserActions.EndTurn,(()=>{this.onEndTurn()})),this.onEvent(r.UserActions.Undo,(()=>{this.onUndo()})),this.onEvent(r.UserActions.UndoAll,(()=>{this.onUndo()})),this.onEvent(r.UserActions.ConfirmRewind,(()=>{this.goTo("main")})),this.onEvent(r.GameStateEvents.NewGameState,(e=>{e.context!==p.NewGameStateContext.Undo&&this.goTo("main")})),this.onEvent(r.GameStateEvents.FactionTurnStarted,(e=>{1===e.factionId&&this.goTo("main")})),this.onEvent(r.UiEvents.RegionLedgerOpened,(()=>{this.module.storedStep||(this.module.storedStep=l.inject.scriptRunner.currentScriptName),this.goTo("inspectingLedger")})),this.onEvent(r.UiEvents.RegionLedgerClosed,(()=>{this.module.storedStep?(this.setScript(this.module.storedStep),this.module.storedStep=void 0):this.goTo("main")})),this.onEvent(r.UiEvents.RegionSelected,(e=>{const t=e&&m.Factions.getByRegion(l.inject.currentGameState,e);if(e)4===t?(this.module.storedStep||(this.module.storedStep=l.inject.scriptRunner.currentScriptName),this.goTo("inspectingRival")):1===t&&(this.module.storedStep?(this.setScript(this.module.storedStep),this.module.storedStep=void 0):this.goTo("main"));else{if(N())return;this.module.storedStep||(this.module.storedStep=l.inject.scriptRunner.currentScriptName),this.goTo("reselectRegion")}})),this.onEvent(r.UserActions.StartRewind,(()=>{this.onRewind()})),this.onEvent(r.GameStateEvents.PawnBought,(e=>{this.onPawnObtained(e.mergedInto?e.mergedInto:e.pawnType)})),this.onEvent(r.GameStateEvents.PawnMoved,(e=>{e.mergedInto&&this.onPawnObtained(e.mergedInto)}))}deactivate(){super.deactivate()}abortTutorial(){this.goTo("derailed")}onEndTurn(){this.goTo("main")}onUndo(){this.goTo("main")}onRewind(){this.goTo("main")}onPawnObtained(e){e===s.PawnType.Knight?this.goTo("warnAboutExpensiveKnight"):e===s.PawnType.Hero&&this.goTo("warnAboutExpensiveHero")}}class v extends w{activate(e){super.activate(),c.app.scene.playUI.updateState({tutorialArrow:e?.tutorialArrowTarget??null,tutorialFrame:e?.tutorialFrameTarget??null,worldMapPanel:e?.worldMapPanel??null})}}class b extends w{activate(){super.activate(),this.onEvent(r.GameStateEvents.HexCaptured,(()=>{this.goTo("main")})),this.onEvent(r.GameStateEvents.PawnBought,(()=>{this.goTo("main")})),this.onEvent(r.GameStateEvents.FactionTurnStarted,(e=>{1===e.factionId&&this.goTo("main")})),this.onEvent(r.GameStateEvents.PawnMoved,(()=>{this.goTo("main")})),this.onEvent(r.GameStateEvents.PawnBought,(()=>{this.goTo("main")}))}}class S extends v{activate(){super.activate({worldMapPanel:{type:"tutorial",text:"Woah, woah, woah! A [b]knight[/b] will cost us an outrageous [b]18 coins[/b] each turn, look how much that tanked our income! We should probably [b]undo that![/b] Pikemen should be good enough for now!",emojiEmotion:g.EmojiEmotion.DeeplyWorried,buttons:[d.DIALOG_BUTTONS.moreInfo]},tutorialArrowTarget:h.Placement.aroundUndoButton(),tutorialFrameTarget:h.Placement.aroundIncomeLabel}),this.onButtonClicked(d.DIALOG_BUTTONS.moreInfo,(()=>{y.events.trigger(r.UserActions.ShowHelp("how-to-play/units"))}))}}class x extends v{activate(){super.activate({worldMapPanel:{type:"tutorial",text:"Oh my! Did you seriously just recruit A [b]HERO[/b]? Those bastards take so many coins every turn that [b]this will drain our treasury in an instant![/b] We must [b]undo that[/b] before we have a rebellion on our hands!",emojiEmotion:g.EmojiEmotion.DeeplyWorried,buttons:[d.DIALOG_BUTTONS.moreInfo]},tutorialArrowTarget:h.Placement.aroundUndoButton(),tutorialFrameTarget:h.Placement.aroundIncomeLabel}),this.onButtonClicked(d.DIALOG_BUTTONS.moreInfo,(()=>{y.events.trigger(r.UserActions.ShowHelp("how-to-play/units"))}))}}class T extends v{activate(){super.activate({worldMapPanel:{type:"tutorial",text:"Oh no! We're now losing coins every turn. If our treasury reaches zero, [b]our army will rebel![/b] We need to avoid that at all costs!",emojiEmotion:g.EmojiEmotion.DeeplyWorried,buttons:[d.DIALOG_BUTTONS.moreInfo]},tutorialArrowTarget:h.Placement.aroundUndoButton(),tutorialFrameTarget:h.Placement.aroundIncomeLabel}),this.onButtonClicked(d.DIALOG_BUTTONS.moreInfo,(()=>{y.events.trigger(r.UserActions.ShowHelp("how-to-play/economy"))}))}}class P extends v{activate(){const e=l.inject.gameStateModel.regions.byId(l.inject.levelSession.selectedRegionId);if(!e)return this.goTo("derailed");const t=e.treasury+e.budget.balance;1===l.inject.gameStateModel.currentPhase.turnNumber?super.activate({worldMapPanel:{type:"tutorial",text:"It's Godfrey the Goose! Our fearsome if somewhat intellectually challenged adversary!",emojiEmotion:g.EmojiEmotion.Worried,buttons:[]}}):e.size<=3?super.activate({worldMapPanel:{type:"tutorial",text:"We have Godfrey cornered now!",emojiEmotion:g.EmojiEmotion.Malicious,buttons:[]}}):t>=10?(super.activate({worldMapPanel:{type:"tutorial",text:`Hmm, Looks like Godfrey will have [b]${t}[/b] coins next turn, enough to recruit another villager!`,emojiEmotion:g.EmojiEmotion.Worried,buttons:[d.DIALOG_BUTTONS.moreInfo]}}),this.onButtonClicked(d.DIALOG_BUTTONS.moreInfo,(()=>{y.events.trigger(r.UserActions.ShowHelp("how-to-play/economy"))}))):super.activate({worldMapPanel:{type:"tutorial",text:`Hmm, looks like Godfrey will have [b]${t} coins[/b] next turn.`,emojiEmotion:g.EmojiEmotion.Neutral,buttons:[]}}),this.onEvent(r.UserActions.WorldMapPanelButtonClicked,(()=>{y.events.trigger(r.UserActions.ShowHelp("how-to-play/economy"))}))}}t.InspectingRival=P;class I extends w{activate(){const e=l.inject.gameStateModel.factions.localPlayer?.getLargestLiveRegion();if(!e)return this.goTo("derailed");const t=e.treasury,i=e.budget.balance;i>=0?super.activate({worldMapPanel:{type:"tutorial",text:`This is the breakdown of our province economy. We have [b]${t} coins[/b] in treasury right now and we'll be getting [b]${i} more[/b] at the start of next turn!`,emojiEmotion:g.EmojiEmotion.VeryHappy,buttons:[d.DIALOG_BUTTONS.moreInfo]},tutorialArrowTarget:h.Placement.aroundHideLedgerButton}):super.activate({worldMapPanel:{type:"tutorial",text:`This is the breakdown of our province economy. We're now [b]losing ${-i} coins every turn[/b], which is not good! We need to quickly increase our income or undo buying those expensive units!`,emojiEmotion:g.EmojiEmotion.DeeplyWorried,buttons:[d.DIALOG_BUTTONS.moreInfo]},tutorialArrowTarget:h.Placement.aroundHideLedgerButton}),this.onEvent(r.UserActions.WorldMapPanelButtonClicked,(()=>{y.events.trigger(r.UserActions.ShowHelp("how-to-play/economy"))}))}}t.InspectingLedger=I;class C extends v{activate(){super.activate({worldMapPanel:{type:"tutorial",text:"Oh no! [b]Our province ran out of coins[/b] and our army rebelled! We should try this again and pay more attention to our income this time!",emojiEmotion:g.EmojiEmotion.DeeplyWorried,buttons:[d.DIALOG_BUTTONS.moreInfo,d.DIALOG_BUTTONS.restartTutorial]},tutorialArrowTarget:h.Placement.aroundRestartButton,tutorialFrameTarget:h.Placement.aroundRestartButton}),this.onButtonClicked(d.DIALOG_BUTTONS.moreInfo,(()=>{y.events.trigger(r.UserActions.ShowHelp("how-to-play/rebellion"))})),this.onButtonClicked(d.DIALOG_BUTTONS.restartTutorial,(()=>{y.events.trigger(r.UserActions.RestartLevel({}))}))}}t.ExplainRebellion=C;class M extends v{activate(){const e=Y()>1?"s":"";super.activate({worldMapPanel:{type:"tutorial",text:`[b]Ha![/b] Now we've separated Godfreys villager${e} from the town. They will turn into ${e?"useless bandits":"a useless bandit"} next turn!`,emojiEmotion:g.EmojiEmotion.Malicious,buttons:[d.DIALOG_BUTTONS.moreInfo]}}),this.onButtonClicked(d.DIALOG_BUTTONS.moreInfo,(()=>{y.events.trigger(r.UserActions.ShowHelp("how-to-play/bandits"))}))}}t.ExplainCutOffEnemyVillagers=M;class A extends w{activate(){super.activate({worldMapPanel:{type:"tutorial",text:"Let's [b]re-select our province[/b].",emojiEmotion:g.EmojiEmotion.Happy,buttons:[]},tutorialArrowTarget:h.Placement.atWorldMapHex((0,o.getHex)(602))})}}class B extends w{activate(){const e=l.inject.gameStateModel,t=e.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[s.PawnType.Villager]});if(!t)return this.goTo("derailed"),{};const i=t.hex.id;super.activate({worldMapPanel:{type:"tutorial",text:"Oh no, [b]Godfrey the Goose[/b] invaded our island!\n[b]Pick up our villager[/b] so we can drive him back!",emojiEmotion:g.EmojiEmotion.DeeplyWorried,buttons:[d.DIALOG_BUTTONS.leaveTutorial]},tutorialArrowTarget:h.Placement.atWorldMapHex(t.hex,8)}),setTimeout((()=>{c.app.scene.worldMap.cameraController.center(0,{offsetY:-60})}),0),this.onEvent(r.UserActions.WorldMapPanelButtonClicked,(e=>{"leaveTutorial"===e&&(c.app.scene.playUI.updateState({worldMapPanel:null}),l.inject.levelSession.end({origin:"play/leave",wipeAutoSave:!1}),c.app.navigator.goTo(c.app.screen.title))})),this.onEvent(r.WorldMapEvents.StartInteraction,(({hexId:e,flags:t})=>{e===i&&this.goTo("step2_captureHex")})),this.onEvent(r.GameStateEvents.HexCaptured,(()=>{this.goTo("step3_buyAnotherVillager")})),this.onEvent(r.UserActions.BuyablePawnPointerUp,(()=>{this.goTo("step4_mergeVillagers")}))}}class E extends w{activate(){super.activate({worldMapPanel:{type:"tutorial",text:"You can use the villager to\n[b]grow our province[/b]!",emojiEmotion:g.EmojiEmotion.Happy,buttons:[]},tutorialArrowTarget:h.Placement.atWorldMapHex((0,o.getHex)(504),14)}),c.app.scene.playUI.updateFromGameState(l.inject.currentGameState,"play");const e=l.inject.gameStateModel;if(!e.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[s.PawnType.Villager]}))return this.goTo("derailed");this.onEvent(r.GameStateEvents.HexCaptured,(()=>{this.goTo("step3_buyAnotherVillager")})),this.onEvent(r.GameStateEvents.PawnMoved,(()=>{this.goTo("step1_selectVillager")})),this.onEvent(r.UserActions.ReturnHeldPawn,(()=>{this.goTo("step1_selectVillager")}))}}class O extends w{activate(){super.activate({worldMapPanel:{type:"tutorial",text:"Nice! And we still have [b]10 coins[/b] [img=coin-hd] left in treasury,\njust enough to [b]recruit another villager[/b]!",emojiEmotion:g.EmojiEmotion.VeryHappy,buttons:[d.DIALOG_BUTTONS.moreInfo]},tutorialArrowTarget:h.Placement.aroundBuyablePawn(s.PawnType.Villager),tutorialFrameTarget:h.Placement.aroundTreasuryLabel}),c.app.scene.playUI.updateFromGameState(l.inject.currentGameState,"play"),this.onEvent(r.UserActions.WorldMapPanelButtonClicked,(()=>{y.events.trigger(r.UserActions.ShowHelp("how-to-play/economy"))})),this.onEvent(r.UserActions.BuyablePawnPointerDown,(e=>{e===s.PawnType.Villager&&this.goTo("step4_mergeVillagers")}))}onUndo(){this.goTo("step1_selectVillager")}}class R extends w{activate(){const e=l.inject.gameStateModel,t=e.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[s.PawnType.Villager]});if(!t)return this.goTo("derailed");const i=t.hex.id;super.activate({worldMapPanel:{type:"tutorial",text:"Oh, I have an idea! We can [b]combine two villagers[/b] to get a [b]pikeman[/b]!",emojiEmotion:g.EmojiEmotion.VeryHappy,buttons:[]},tutorialArrowTarget:h.Placement.atWorldMapHex(t.hex)}),this.onEvent(r.UiEvents.PawnReturnedToShop,(()=>{this.goTo("step3_buyAnotherVillager")})),this.onEvent(r.GameStateEvents.PawnBought,(e=>{e.destinationHexId===i?this.goTo("step5_undoMerge"):this.goTo("step8_endTurn")})),this.onEvent(r.GameStateEvents.HexCaptured,(e=>{this.goTo("step8_endTurn")}))}onUndo(){this.goTo("step1_selectVillager")}}class k extends w{activate(){super.activate({worldMapPanel:{type:"tutorial",text:"Oh, sorry. I just realized [b]Pikemen[/b] cost [b]6 coins every turn[/b] to maintain and we can't afford that right now! Let's [b]undo that move[/b] before we go bust!",emojiEmotion:g.EmojiEmotion.DeeplyWorried,buttons:[d.DIALOG_BUTTONS.moreInfo]},tutorialArrowTarget:h.Placement.aroundUndoButton(),tutorialFrameTarget:h.Placement.aroundIncomeLabel}),this.onButtonClicked(d.DIALOG_BUTTONS.moreInfo,(()=>{y.events.trigger(r.UserActions.ShowHelp("how-to-play/units"))}));const e=l.inject.gameStateModel;if(!l.inject.gameStateModel.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[s.PawnType.Pikeman]}))return this.abortTutorial();setTimeout((()=>c.app.scene.playUI.updatePlayLayout({primaryButton:"endTurn"})),0)}onUndo(){this.goTo("step6_buyAgain")}}class L extends w{activate(){super.activate({worldMapPanel:{type:"tutorial",text:"Sorry about that, let's [b]recruit that villager again[/b] now.",emojiEmotion:g.EmojiEmotion.Embarrassed,buttons:[]},tutorialArrowTarget:h.Placement.aroundBuyablePawn(s.PawnType.Villager)}),this.onEvent(r.UserActions.BuyablePawnPointerDown,(e=>{e===s.PawnType.Villager&&this.goTo("step7_captureAnotherHex")}))}onUndo(){this.goTo("main")}}class _ extends w{activate(){const e=l.inject.gameStateModel,t=e.pawns.findOne({hexes:e.factions.byId(1).hexes,type:[s.PawnType.Villager]}),i=e.factions.byId(1)?.getRegions()[0];if(!i)return this.abortTutorial();n.assert.defined(i);const o=e.warfare.getConquerableHexes(i,s.PawnType.Villager,1).first();if(!t||!o)return this.abortTutorial();super.activate({worldMapPanel:{type:"tutorial",text:"This time, let's just [b]grab another tile[/b] to [b]increase our income[/b].",emojiEmotion:g.EmojiEmotion.VeryHappy,buttons:[]},tutorialArrowTarget:h.Placement.atWorldMapHex(o)}),this.onEvent(r.GameStateEvents.HexCaptured,(()=>{this.goTo("step8_endTurn")})),this.onEvent(r.UserActions.ReturnHeldPawn,(()=>{this.goTo("step6_buyAgain")}))}onUndo(){this.goTo("main")}}class D extends w{activate(){super.activate({worldMapPanel:{type:"tutorial",text:"That's all we can do for now, let's [b]end the turn[/b] and see what the enemy does.",emojiEmotion:g.EmojiEmotion.VeryHappy,buttons:[]},tutorialArrowTarget:h.Placement.aroundUiObject(c.app.scene.playUI.activeUI.endTurnButton)})}onEndTurn(){this.goTo("main")}onUndo(){this.goTo("step6_buyAgain")}}class H extends v{activate(){const e=[(0,o.getHex)(504),(0,o.getHex)(404),(0,o.getHex)(305)].find((e=>!l.inject.gameStateModel.factions.byHex(e)?.isLocalPlayer()));super.activate({worldMapPanel:{type:"tutorial",text:"Now let's [b]expand north[/b] to really boost our income!",emojiEmotion:g.EmojiEmotion.VeryHappy,buttons:[]},tutorialArrowTarget:e&&h.Placement.atWorldMapHex(e)}),this.onEvent(r.GameStateEvents.HexCaptured,(()=>{V()?this.goTo("connectTerritorySuccess"):this.goTo("main")}))}onUndo(){this.goTo("main")}}class j extends v{activate(){const e=W();if(!e)return this.goTo("idle");const t=l.inject.gameStateModel.warfare.getHexDefense(e);if(0!==t&&!K())return!K()&&z().length>=2?this.goTo("objectiveGetPikeman"):this.goTo("idle");super.activate({worldMapPanel:{type:"tutorial",text:"Time to finish this!",emojiEmotion:g.EmojiEmotion.Malicious,buttons:[]},tutorialArrowTarget:function(){const i=z()[0];return 0===t&&!i&&$().treasury>=10?h.Placement.aroundBuyablePawn(s.PawnType.Villager):0===t||K()?h.Placement.atWorldMapHex(e,16):void 0}()}),this.onEvent(r.UiEvents.PawnPickedUpFromShop,(i=>{if(i===s.PawnType.Castle||0!==t&&i!==s.PawnType.Pikeman)return this.goTo("idle");c.app.scene.playUI.updateState({tutorialArrow:h.Placement.atWorldMapHex(e,16)})})),this.onEvent(r.GameStateEvents.HexCaptured,(()=>{this.goTo("main")}))}}t.ObjectiveAttackHex=j;class F extends w{activate(){const e=W();if(!e)return this.goTo("idle");const t=l.inject.gameStateModel.pawns.findClosest(e,$().hexes,(e=>!(!e.region.faction?.isLocalPlayer()||e.type!==s.PawnType.Villager||!e.isMovable())));if(!t)return this.goTo("idle");super.activate({worldMapPanel:{type:"tutorial",text:"Time to end this charade. Let's [b]get a pikeman[/b] and teach them a lesson!",emojiEmotion:g.EmojiEmotion.Malicious,buttons:[d.DIALOG_BUTTONS.moreInfo]},tutorialArrowTarget:h.Placement.atWorldMapHex(t.hex)}),this.onButtonClicked(d.DIALOG_BUTTONS.moreInfo,(()=>{y.events.trigger(r.UserActions.ShowHelp("how-to-play/merging"))})),this.onEvent(r.UiEvents.PawnPickedUp,(({hexId:t})=>{const i=l.inject.gameStateModel.pawns.findClosest(e,$().hexes,(e=>!!e.region?.faction?.isLocalPlayer()&&e.type===s.PawnType.Villager&&e.isMovable()&&e.hex.id!==t));if(!i)return this.goTo("idle");c.app.scene.playUI.updateState({tutorialArrow:h.Placement.atWorldMapHex(i.hex)})})),this.onEvent(r.GameStateEvents.HexCaptured,(()=>{this.goTo("main")})),this.onEvent(r.GameStateEvents.PawnMoved,(()=>{this.goTo("main")}))}}class U extends w{activate(){const e=l.inject.gameStateModel.factions.byId(1)?.getLargestLiveRegion()?.budget.balance;super.activate({worldMapPanel:{type:"tutorial",text:`Awesome! With all that new land connected to our town, we are now earning [b]${e} coins[/b] every turn!`,emojiEmotion:g.EmojiEmotion.Satisfied,buttons:[d.DIALOG_BUTTONS.moreInfo]},tutorialFrameTarget:h.Placement.aroundIncomeLabel}),this.onButtonClicked(d.DIALOG_BUTTONS.moreInfo,(()=>{y.events.trigger(r.UserActions.ShowHelp("how-to-play/economy"))})),this.onEvent(r.GameStateEvents.HexCaptured,(()=>{this.goTo("main")}))}onUndo(){this.goTo("main")}}class G extends a.LevelScript{activate(){super.activate(),c.app.scene.playUI.updateState({tutorialArrow:null,tutorialFrame:null,worldMapPanel:{type:"tutorial",text:"Eh, i take it you'd rather do things your way...\nWell, let me know if I can help!",emojiEmotion:g.EmojiEmotion.Embarrassed,buttons:[d.DIALOG_BUTTONS.howToPlay,d.DIALOG_BUTTONS.restartTutorial]}}),this.onButtonClicked(d.DIALOG_BUTTONS.howToPlay,(()=>{y.events.trigger(r.UserActions.ShowHelp())})),this.onButtonClicked(d.DIALOG_BUTTONS.restartTutorial,(()=>{y.events.trigger(r.UserActions.RestartLevel({}))}))}}function N(){const e=l.inject.gameStateModel.factions.localPlayer?.getLargestLiveRegion();return 0===e?.getMyAssets().totalUnits.count()&&0===e?.treasury}function V(){return l.inject.gameStateModel.regions.byHex((0,o.getHex)(305))?.isAlive()}function W(){if(!l.inject.gameStateModel.currentPhase.faction?.isLocalPlayer())return;const e=$();if(!e)return;const t=l.inject.gameStateModel.warfare.getConquerableHexes(e,e.getMyAssets().getMaxRemainingAvailableMight(),e.getMyAssets().getMaxRemainingAvailableMight()).filter((e=>4===l.inject.gameStateModel.regions.byHex(e)?.faction?.id));return t.has((0,o.getHex)(507))?(0,o.getHex)(507):t.has((0,o.getHex)(607))?(0,o.getHex)(607):t.find((e=>!!l.inject.gameStateModel.warfare.getOccupyingUnit(e)))}function z(){return l.inject.gameStateModel.currentPhase.getMovablePawns().filter((e=>e.type===s.PawnType.Villager))}function $(){return l.inject.gameStateModel.factions.localPlayer?.getLargestLiveRegion()}function Y(){return l.inject.gameStateModel.factions.byId(4).getPawns({type:[s.PawnType.Villager]}).filter((e=>!e.region.isAlive())).length}function K(){return l.inject.gameStateModel.currentPhase.faction?.isLocalPlayer()&&l.inject.gameStateModel.currentPhase.getMovablePawns().find((e=>e.type===s.PawnType.Pikeman))}},95226:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SingletonDataSet=void 0,t.SingletonDataSet=class{constructor(e,t){this.key=e,this.defaultValue=t}apply(e,t){return e.set(this.key,t)}deserialize(e){return e}serialize(e){return e}createMutation(e,t){return{dataSet:this,changes:e,context:t}}getEntryById(e,t){throw new Error(`Cannot extract entry ${t} from SingletonDataSet ${this.key} (SingletonDataSet has no entries)`)}entryToString(e){return""}entryToDebugString(e){return""}getEntryIds(e){return[]}toString(){return`[SingletonDataSet "${this.key}"]`}mergeMutations(e,t){return t}}},95428:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.EmojiEmotion=void 0,function(e){e[e.DeeplyWorried=1]="DeeplyWorried",e[e.Worried=2]="Worried",e[e.Embarrassed=4]="Embarrassed",e[e.Angry=11]="Angry",e[e.Neutral=12]="Neutral",e[e.Happy=13]="Happy",e[e.VeryHappy=14]="VeryHappy",e[e.Satisfied=24]="Satisfied",e[e.Malicious=21]="Malicious",e[e.VeryMalicious=20]="VeryMalicious",e.Shocked="shock-1",e.VeryShocked="shock-2",e.Doubtful="shock-0"}(i||(t.EmojiEmotion=i={}))},95568:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseScreen=void 0;const s=i(56824),n=i(54825),o=i(52031);s.logger.for("Navigator"),t.BaseScreen=class{constructor(e,t){this.lockOrientation=!1,this.observe=new o.Observer((()=>this.isActive())),this.scenes=t,this.name=e}getScenes(){return this.scenes}async activate(e,t){}async transitionIn(e){}async transitionOut(e){}deactivate(){}isActive(){return n.app.navigator.activeScreen===this&&!n.app.modals.isModalActive()}pause(){this.scenes.forEach((e=>n.app.game.scene.pause(e)))}resume(){this.scenes.forEach((e=>n.app.game.scene.resume(e)))}}},95608:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(20693),n=i(97849);t.default=class{constructor(){this.groups={},this.membership={},this._length=0}get length(){return this._length}addToGroup(e,...t){this.groups[e]?t.forEach((t=>this.groups[e].add(t))):this.groups[e]=new Set(t),t.forEach((t=>{const i=this.membership[t.id];void 0===i?(this.membership[t.id]=e,++this._length):i!==e&&(this.groups[i].delete(t),this.membership[t.id]=e,0===this.groups[i].size&&this.removeGroup(i))}))}getOwnerOf(e){return this.membership[e.id]}removeGroup(e){n.assert.defined(this.groups[e]),this.groups[e].forEach((e=>delete this.membership[e.id])),this._length-=this.groups[e].size,delete this.groups[e]}forEach(e){for(const t in this.groups)e(this.groups[t],t)}find(e){for(const t in this.groups)if(e(this.groups[t],t))return{key:t,hexes:this.groups[t]}}getGroupsAdjacentTo(e){let t={};const i=this.groups[e];if(!i)return[];const n=s.HexGroup.from(i);for(let e of n.neighbours()){const i=this.getOwnerOf(e);i&&(t[i]?t[i]++:t[i]=1)}return Object.entries(t).map((([e,t])=>({key:e,hexes:this.groups[e],borderSize:t})))}map(e){let t=[];return this.forEach(((i,s)=>t.push(e(Array.from(i),s)))),t}getLargestGroup(){const e=this.getLargestGroupKey();if(void 0!==e)return s.HexGroup.from(Array.from(this.groups[e]))}getLargestGroupKey(){let e,t,i=0;return this.forEach(((s,n)=>{s.size>i&&(i=s.size,e=s,t=n)})),t}popLargestGroup(){const e=this.getLargestGroupKey();if(e){const t=this.groups[e];return this.removeGroup(e),s.HexGroup.from(Array.from(t))}throw new Error("Attempt to pop() from empty log groups collection")}getGroups(){return Object.values(this.groups).map((e=>s.HexGroup.from(Array.from(e))))}keys(){return Object.keys(this.groups)}byKey(e){return{key:e,hexes:this.groups[e]||new Set}}toString(){let e=0,t=Object.keys(this.groups).map((t=>{const i=this.groups[t].size;return e+=i,`${t}(${i})`})).join(", ");return`[HexGroupsCollection (${e}): ${t}]`}}},95613:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CameraScrollController=void 0;const s=i(56824),n=i(49796),o=i(41229),a=i(54825);s.logger.for("CameraScrollController"),t.CameraScrollController=class{constructor(e){this.camera=e,this.dragging=!1,this.dragMomentumX=0,this.dragMomentumY=0,this.drag=5e3,this.dragStartPosition={x:0,y:0},this.scene=this.camera.scene;const t=this;this.cameraX=new o.KineticValue(e.scrollX,{scene:this.scene,drag:this.drag,apply:e=>this.camera.scrollX=e,stops:{getNextFrom:e=>e<t.bounds.left?t.bounds.left:void 0,getPreviousFrom:e=>e>t.bounds.right-t.camera.width?t.bounds.right-t.camera.width:void 0}}),this.cameraY=new o.KineticValue(0,{drag:this.drag,scene:this.scene,apply:e=>{this.camera.scrollY=e},stops:{getNextFrom:e=>e<t.bounds.top?t.bounds.top:void 0,getPreviousFrom:e=>e>t.bounds.bottom-t.camera.height?t.bounds.bottom-t.camera.height:void 0}}),this.pointer=this.scene.input.activePointer,this.scene.input.on("pointermove",this.pointerDragHandler,this),this.scene.events.on("update",this.update,this)}detach(){this.scene.input.removeListener("pointermove",this.pointerDragHandler),this.scene.input.removeListener("update",this.update)}update(e,t){this.dragMomentumX*=.8,this.dragMomentumY*=.8,this.cameraX.update(e,t),this.cameraY.update(e,t)}startDrag(){this.dragging=!0,this.dragStartPosition={x:this.cameraX.value,y:this.cameraY.value},this.dragCursorIconOn(),this.cameraX.freeze(),this.cameraY.freeze(),a.app.tooltips.close()}async panTo(e,t,i=0,s=this.camera.zoom){this.camera.width,this.camera.height;const n=e-this.camera.midPoint.x,o=t-this.camera.midPoint.y,a=[];if(Math.abs(n)>=1){const e=this.cameraX.value+n;0===i?this.cameraX.setTo(e):a.push(this.cameraX.tweenTo(e,i,"Sine.easeInOut"))}if(Math.abs(o)>=1){const e=this.cameraY.value+o;0===i?this.cameraY.setTo(e):a.push(this.cameraY.tweenTo(e,i,"Sine.easeInOut"))}a.length>0&&await Promise.all(a)}dragCursorIconOn(){this.scene.game.canvas.style.cursor="grabbing"}dragCursorIconOff(){this.scene.game.canvas.style.cursor="default"}pointerDragHandler(e){if(this.dragging){if(!e.isDown)return this.cameraX.unfreeze(),this.cameraY.unfreeze(),void this.stopDragging();const t=e.position.x-e.prevPosition.x,i=e.position.y-e.prevPosition.y;this.dragMomentumX-=10*t,this.dragMomentumY-=10*i,this.cameraX.setTo(this.cameraX.value-t/this.camera.zoom),this.cameraY.setTo(this.cameraY.value-i/this.camera.zoom)}}stopDragging(){if(this.dragging){this.dragging=!1;const e=(0,n.euclidDistance)(this.dragStartPosition,{x:this.cameraX.value,y:this.cameraY.value});return this.cameraX.unfreeze(),this.cameraY.unfreeze(),this.cameraX.accelerate(this.dragMomentumX),this.cameraY.accelerate(this.dragMomentumY),this.dragCursorIconOff(),e}return 0}setBounds(e){this.bounds=e,this.cameraX.unfreeze(),this.cameraY.unfreeze()}}},95709:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BackgroundUIScene=void 0;const s=i(81700),n=i(30948),o=i(897),a=i(56824),r=i(93868),l=i(12167),c=i(80959),d=i(34963);a.logger.for("BackgroundUIScene");class h extends n.BaseUIScene{constructor(){super({key:s.Scenes.BackgroundUI,bounds:r.BOUNDS.Main}),this.preUpdate=(0,o.whenDirty)((()=>{this.updateLayout()}))}create(){this.objectsPool=new d.WorldObjectsPool(this),this.worldMapPanel=new l.FloatingWorldMapPanel(c.UiBuilder.for(this)),this.add.existing(this.worldMapPanel),super.create()}getTooltipFor(e){}updateLayout(){}update(e,t){super.update(e,t)}}t.BackgroundUIScene=h},95883:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SelectBoxContent=void 0;const s=i(86545),n=i(95070),o=i(56824),a=i(20087),r=i(75042),l=o.logger.for("SelectBoxContent");class c extends s.BaseResponsiveContainer{constructor(e,t){super(e),this.props=t,this.text=void 0,this.icon=void 0,t.text&&this.setText(t.text),t.icon&&this.setIcon(t.icon),this.dropdownIcon=new n.Image(e,0,0,"atlas","ui/button-icons/arrows-up-down"),this.add(this.dropdownIcon)}setTextColor({color:e,alpha:t}){this.text?.setTint(e),this.dropdownIcon.setTint(e),this.text?.setAlpha(t??1),this.icon?.setAlpha(t??1),this.icon instanceof n.Image&&(this.props.tintIcon?this.icon.setTint(e):this.icon.clearTint())}setText(e){if(e!==this.text?.text){if(void 0===e)this.text?.setText("").setVisible(!1);else if("string"==typeof e){if(!this.text)return o.errors.handleNonFatalError("setText called with a string, but no text object is defined","SelectBoxContent"),void l.warning("SelectBoxContent: ");this.text.setText(e).setVisible(!0)}else this.text&&(this.text.destroy(),this.text=void 0),e&&(this.text=e,this.add(e));this.preUpdate.makeDirty()}}setIcon(e){if(e!==this.icon){if("string"==typeof e){if(!(this.icon instanceof n.Image))return;this.icon.setFrame(e)}else this.icon&&(this.icon.destroy(),this.icon=void 0),e&&(this.icon=e,this.add(this.icon));this.preUpdate.makeDirty()}}updateLayout(){if(this.icon&&this.text)a.Arrange.leftToRight({content:[this.icon,this.text].filter(r.isDefined),origin:0,spacing:8,x:8});else{const e=[this.text??this.icon];a.Arrange.alignX({content:e,origin:.5,x:this.width/2})}a.Arrange.alignY({content:[this.icon,this.text].filter(r.isDefined),y:this.height/2,origin:.5}),this.dropdownIcon.setPosition(this.width-this.dropdownIcon.width-8,this.height/2-this.dropdownIcon.height/2)}}t.SelectBoxContent=c},95922:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TempMutex=void 0,t.TempMutex=class{constructor(){this.locked=!1}acquire(){return this.locked?(console.warn("cannot acquire lock"),!1):(this.locked=!0,setTimeout((()=>this.release()),0),!0)}release(){this.locked=!1}}},96130:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.watchable=function(e){let t,i=e,n=[];function o(){return i}return o.set=e=>{i!==e&&(i=e,n.forEach((e=>e(i,t))),t=i)},o.watch=e=>{const t=o.watchFuture(e);return setTimeout((()=>e(i,void 0)),0),t},o.watchFuture=e=>(n.push(e),{unsubscribe:()=>(0,s.removeFromArrayInPlace)(n,e)}),o};const s=i(1326)},96137:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Colors=void 0;const s=i(2543);t.Colors={woodenUi:{primaryText:5781794,redText:8388608,pergamen:16379880,darkerPergamen:14535353},glassUi:{ocean:10213106,card:11525875,textLight:7908033,textMain:3960969,textDark:2442580},glassUi_old:{background:11656690,primaryText:3355442,secondaryText:2710903,disabledText:7972541,backgroundText:5460817,errorText:8388608,shape:12969202,shapeDarkAccent:11590124,shapeShadow:9027030,shapeLightAccent:14412786,alert:{shadow:13118720,main:16749944,lightAccent:16773357},success:{shadow:4496950,main:8376178,lightAccent:12445366}},tooltip:{text:14540253,background:2697512,mightCounter:3648456,coinsCounter:16763904},speechBubble:{text:2697512,background:15723242},highlight:{friendlyRegion:5438464,ownedRegion:16577024,hostileRegion:16721920},ocean:5801886,white:15921906,darker:(e,t=10)=>Phaser.Display.Color.IntegerToColor(e).darken(t).color,brighter:(e,t=10)=>Phaser.Display.Color.IntegerToColor(e).brighten(t).color,lighter:(e,t=10)=>Phaser.Display.Color.IntegerToColor(e).lighten(t).color,toCss:(e,t)=>void 0!==t?`#${e.toString(16).padStart(6,"0")}${(0,s.round)(256*t).toString(16)}`:`#${e.toString(16).padStart(6,"0")}`,fromCss:e=>Phaser.Display.Color.ValueToColor(e).color}},96604:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IconAndText=t.BUTTON_LAYOUT=t.Text=t.BitmapText=void 0;const s=i(86545),n=i(75042),o=i(20087);t.BitmapText=Phaser.GameObjects.BitmapText,t.Text=Phaser.GameObjects.Text;var a=Phaser.GameObjects.Image;t.BUTTON_LAYOUT={iconLeft:({parent:e,icon:t,text:i,spacing:s,offset:a})=>{const r=[t,i].filter(n.isDefined);o.Arrange.leftToRight({content:r,origin:.5,spacing:s,x:e.width/2+(a?.x??0)}),o.Arrange.alignY({content:r,y:e.height/2+(a?.y??0),origin:.5})},listItem:({parent:e,icon:t,text:i,spacing:s,offset:a})=>{const r=[t,i].filter(n.isDefined);if(t){const e=(20-t.width)/2;t.x=8+e+(a?.x??0)}i&&(i.x=28+s+(a?.x??0)),o.Arrange.alignY({content:r,y:e.height/2+(a?.y??0),origin:.5})},iconRight:({parent:e,icon:t,text:i,spacing:s,offset:a})=>{const r=[i,t].filter(n.isDefined);o.Arrange.leftToRight({content:r,origin:.5,spacing:s,x:e.width/2+(a?.x??0)}),o.Arrange.alignY({content:r,y:e.height/2+(a?.y??0),origin:.5})},iconAbove:({parent:e,icon:t,text:i,spacing:s,offset:a})=>{const r=i?.height??0,l=[t,i].filter(n.isDefined);o.Arrange.topToBottom({content:l,origin:.5,spacing:s,y:e.height/2+(a?.y??0)}),o.Arrange.alignX({content:l,x:e.width/2+(a?.x??0),origin:.5}),t&&i?(i.y=e.height-r-s+(a?.y??0),t.y=i.y/2-t.height/2+(a?.y??0)):i?o.Arrange.alignY({content:[i],y:e.height/2+(a?.y??0),origin:.5}):t&&o.Arrange.alignY({content:[t],y:e.height/2+(a?.y??0),origin:.5})}};class r extends s.BaseResponsiveContainer{constructor(e,t){super(e),this.props=t,this.text=void 0,this.icon=void 0,t.text&&this.setText(t.text),t.icon&&this.setIcon(t.icon)}setTextColor({color:e,alpha:t}){this.text?.setTint(e),this.text?.setAlpha(t??1),this.icon?.setAlpha(t??1),this.props.tintIcon?this.icon?.setTint(e):this.icon?.clearTint()}setOffset(e){this.props.offset=e,this.updateLayout()}setText(e){if(e!==this.text?.text){if(void 0===e)this.text&&this.text.setText("").setVisible(!1);else if("string"==typeof e){if(!this.text)return;this.text.setText(e).setVisible(!0)}else this.text&&(this.text.destroy(),this.text=void 0),e&&(this.text=e,this.add(e));this.preUpdate.makeDirty()}}setIcon(e){e!==this.icon&&("string"==typeof e?this.icon instanceof a?this.icon.setFrame(e):(this._destroyIcon(),this.icon=new a(this.scene,0,0,"atlas",e)):(this._destroyIcon(),e&&(this.icon=e,this.add(this.icon))),this.preUpdate.makeDirty())}_destroyIcon(){this.icon&&(this.icon.destroy(),this.icon=void 0)}updateLayout(){this.props.layout({parent:this,icon:this.icon,text:this.text,offset:this.props.offset,spacing:this.props.spacing})}}t.IconAndText=r},96704:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compressGameState=function(e){const t=new r.StateEngine;t.add(n.GameState.version,n.GameState.map,n.GameState.ruleSet,n.GameState.ai.attritionByRegion,n.GameState.ai.hexHistory,...Object.values(n.GameState.regions),...Object.values(n.GameState.factions),...Object.values(n.GameState.pawns),...Object.values(n.GameState.units),...Object.values(n.GameState.currentPhase)),t.setState(e),t.activateAllProjections(),l.Regions.destroyAllEmptyRegions(t.currentState);const i=t.serialize();return{map:i.map,version:i.version,regions:Object.values(i.regions).map((e=>({...e,hexes:u(t,n.GameState.regions.hexes,e.id),attrition:t.get(n.GameState.ai.attritionByRegion,e.id)}))),factions:Object.values(i.factions).map((e=>({...e,aiPersonality:(0,d.isEqual)(e.aiPersonality,h.DEFAULT_AI_PERSONALITY)?void 0:e.aiPersonality,regions:u(t,n.GameState.factions.regions,e.id),credit:t.get(n.GameState.ai.credit,e.id),attrition:t.get(n.GameState.ai.extraAttritionByFaction,e.id)}))),pawns:Object.values(i.pawns).map((e=>{return{...e,hex:t.get(n.GameState.pawns.hex,e.id),count:(i=t.get(n.GameState.pawns.count,e.id),1===i?void 0:i)};var i})),currentPhase:{...i.currentPhase,tappedUnits:t.get(n.GameState.currentPhase.tappedUnits).keySeq().toArray()},hexHistory:i["ai.hexHistory"]}},t.decompressGameState=function(e){let t;const i={},n={},o={},r={};t=(0,s.dictionaryOf)(e.regions.map((e=>(0,s.omit)(e,"hexes","attrition"))),"id");for(let t of e.regions){for(let e of t.hexes)i[e]=t.id;t.attrition&&(n[t.id]=t.attrition)}let l={};const d={};l=(0,s.dictionaryOf)(e.factions.map((e=>({...(0,s.omit)(e,"regions")}))),"id");for(let t of e.factions)t.regions.forEach((e=>d[e]=t.id)),t.credit&&(r[t.id]=t.credit),t.attrition&&(o[t.id]=t.attrition);let h={};const u={},p={};h=(0,s.dictionaryOf)(e.pawns.map((e=>(0,s.omit)(e,"hex","count"))),"id"),e.pawns.forEach((e=>{u[e.id]=e.hex,p[e.id]=e.count||1}));const g=(0,s.omit)(e.currentPhase,"tappedUnits");for(let t of e.pawns)u[t.id]=t.hex,p[t.id]=t.count||1;const m=a.ruleSets.default;return{map:{...e.map,plugins:e.map.plugins??[]},version:c.CORE_GAMESTATE_SCHEMA_VERSION,ruleSet:m,regions:t,"regions.byHex":i,factions:l,"factions.byRegion":d,pawns:h,"pawns.count":p,"pawns.hex":u,currentPhase:g,"currentPhase.tappedUnits":e.currentPhase.tappedUnits||[],"ai.credit":r,"ai.attritionByRegion":n,"ai.extraAttritionByFaction":o,"ai.hexHistory":e.hexHistory??{}}},t.addIds=function(e){return(0,s.mapDictionary)(e,((e,t)=>({...e,id:Number(t)})))};const s=i(1326),n=i(90952),o=i(56824),a=i(90048),r=i(75136),l=i(56038),c=i(62643),d=i(2543),h=i(8971);function u(e,t,i){return e.get(t,i)?.toArray()||[]}o.logger.for("decompressGameState")},97113:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.myLibraryTransitionOut=async function(){const e=s.config.screenTransitionDuration,t=n.app.scene.myLibraryUI;await new Promise((i=>{const s=t.bounds.width;t.tweens.add({targets:t.cameras.main,x:`-=${s}`,alpha:{from:1,to:0},duration:e,ease:"Sine.easeOut",onComplete:()=>i()})}))};const s=i(56824),n=i(54825)},97337:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.moveBandits=function(e,t,i){for(;t.size;)s(t[Symbol.iterator]().next().value);function s(n){if(t.delete(n),!n.exists)return;let a;if(a=n.hasTrait(o.PawnTraits.Elusive)?(0,l.getBunnyDestination)(n):c(e,n.hex,t),a){const r=function(i){const s=e.pawns.findOne({hexes:i,traits:[o.PawnTraits.OccupiesTile]});return s&&t.has(s)?s:void 0}(a);if(r)s(r),s(n);else{const t=e.warfare.getOccupyingUnit(a),s=t?.id;i.move({pawnId:n.id,destHex:a,captureHex:!1,defeatedUnit:s?{pawnId:s}:void 0,tapUnit:!1})}}}},t.pickHexToEnter=c;const s=i(67274),n=i(56038),o=i(63521),a=i(56824),r=i(35800),l=i(57230);function c(e,t,i=new Set){const a=t.neighbours().filter((s=>function(e,t,i,s=new Set){if(!n.Regions.getByHex(e.state,i.id))return!1;if(function(e,t,i){const s=e.regions.byHex(t),n=e.regions.byHex(i),o=s?.faction?.isNeutral(),a=n?.faction?.isNeutral(),r=e.warfare.getHexStaticDefense(t)>0&&!o,l=e.warfare.getHexStaticDefense(i)>0&&!a,c=s!==e.regions.byHex(i);return r!==l||(r||l)&&c}(e,t,i))return!1;const a=e.pawns.findOne({hexes:i,traits:[o.PawnTraits.OccupiesTile]});return!a||s.has(a)||a.hasTrait(o.PawnTraits.Treasure)}(e,t,s,i))),l=a.filter((t=>e.pawns.traitPresentAtHex(t,o.PawnTraits.AttractsBandits))),c=a.filter((t=>e.regions.byHex(t)?.faction?.id!==s.SpecialFaction.neutral));return l.length>0?(0,r.deterministicRandomHexFrom)(e,l):c.length>0?(0,r.deterministicRandomHexFrom)(e,c):a.length>0?(0,r.deterministicRandomHexFrom)(e,a):void 0}a.logger.for("bandits")},97340:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugHistoryScreen=void 0;const s=i(81700),n=i(95568),o=i(91622),a=i(54825),r=i(56824);class l extends n.BaseScreen{constructor(){super("DebugHistory",[s.Scenes.DebugHistory,s.Scenes.WorldMap])}async activate(){a.app.scene.debugHistory.resetCursor(),o.inject.history.suspendRecording(),this.prevIntegrityChecksSetting=r.config.debug.integrityChecks,r.config.debug.integrityChecks=void 0}deactivate(){r.config.debug.integrityChecks=this.prevIntegrityChecksSetting,o.inject.history.resumeRecording()}}t.DebugHistoryScreen=l},97377:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dataSetAdapter=function(e,t={}){const i=t.arrowDataRetriever||((t,i)=>(0,s.selectFromState)(t,e,i));return{getHexes:t=>n.HexGroup.fromIds(e.getEntryIds(t)),getGroups:t.getGroups,...l(e,t),...(0,o.autoArrowsGenerator)(i)}},t.regionDataSetAdapter=function(e,t={}){return(0,a.regionBasedAdapter)(l(e,t))},t.factionDataSetAdapter=function(e,t={}){return(0,r.factionBasedAdapter)(l(e,t))},t.gettersFromDataSet=l;const s=i(20026),n=i(20693),o=i(32402),a=i(78436),r=i(29322);function l(e,t){const i=t.getValue||(t=>e.entryToString(t)),n=t.getDetail||(t=>e.entryToDebugString(t));return{getValue(t,n){const o=(0,s.selectFromState)(t,e,n);return o&&i(o)},getDetail(t,i){const o=(0,s.selectFromState)(t,e,i);return o&&n(o)}}}},97425:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CompositePlanner=void 0;const n=s(i(65731)),o=i(18957),a=i(65415),r=i(70582),l=i(56824),c=i(91622),d=i(8358),h=i(9292);l.logger.for("ai:CompositePlanner"),t.CompositePlanner=class{get isConquest(){return this.options.allowedTactics.some((e=>e.isConquest))}constructor(e){this.options=e,this.name="CompositePlanner",this.candidatePlans=[],this.candidatePlansHeap=new n.default(((e,t)=>t.score-e.score))}async*generatePlans(e,t){this.candidatePlans=[],this.candidatePlansHeap=new n.default(((e,t)=>t.score-e.score));for(const i of this.options.allowedTactics)for await(const s of i.generatePlans(e,t))this.candidatePlans.push(s),this.candidatePlansHeap.push(s);for(l.config.debug.ai&&c.inject.debugData.set("Top candidate plans:","\n"+this.candidatePlans.slice(0,10).map((e=>" - "+e.toString())).join("\n"));!this.candidatePlansHeap.empty();)yield this.candidatePlansHeap.pop()}getDebugLayer(){return{onChange:(0,o.signal)(),getMap:()=>{const e=new a.CustomHexGroupValuation([]);return this.candidatePlans.forEach((t=>{const i=t.hex;i&&e.set(i.id,[...e.get(i.id),t])})),new r.ProxyHexGroupValuation(e,(e=>e.map((e=>e.score)).reduce(h.pickLarger,-1/0).toFixed(0)))},getDetail:e=>this.candidatePlans.filter((t=>t.hex===e)).sort(((e,t)=>t.score-e.score)).map((e=>e.toString()+"\n"+(0,d.prefixEachLineWith)("  ",e.toDebugString()))).join("\n")}}}},97819:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameStateController=void 0;const s=i(39420),n=i(18957),o=i(70614),a=i(36868),r=i(56824),l=i(72273),c=i(71021),d=i(96130),h=i(7230),u=i(84108),p=i(62847),g=i(96704),m=i(43046),y=i(9537),f=r.logger.for("GameStateController");t.GameStateController=class{get rollbackAvailable(){return this.history.getCursor().canRollback()}constructor(){this.onEvent=(0,n.signal)(),this.eventsPaused=!1,this.scheduledPlays=[],this.history=new u.GameHistory,this.undoAvailable=(0,d.watchable)(y.UndoAvailability.RollbackOnly),this.movesCache=new h.MovesCache,this.model=new l.GameStateModel}updateUndoAvailability(){const e=this.history.getCursor();e.canUndo()?this.setUndoAvailable(y.UndoAvailability.Available):e.canRollback()?this.setUndoAvailable(y.UndoAvailability.RollbackOnly):this.setUndoAvailable(y.UndoAvailability.Unavailable)}setUndoAvailable(e){this.undoAvailable.set(e)}getEventQueue(){const e=new o.EventQueue;return e.addSource(this.onEvent),e}loadState(e,t){if(this.model.restore(e),this.abortTransaction(),this.model.activateAllProjections(),this.fireEvent(a.GameStateEvents.NewGameState({state:this.model.state,context:t})),this.scheduledPlays=[],t.startFactionTurn&&this.fireEvent(a.GameStateEvents.FactionTurnStarted({state:this.model.state,factionId:this.model.currentPhase.faction.id})),t.flushHistory){this.clearHistory();const i=e.replay;if(i)try{this.history.import(i,{unpackRewinds:t.unpackRewinds})}catch(e){r.errors.handleNonFatalError(`Failed to parse replay from CompressedState: ${e.message}`,"GameStateController.loadState")}}this.updateUndoAvailability()}exportStateWithHistory(e){const t=(0,g.compressGameState)(this.currentState),i=this.history.export(e);return t.replay=i,t}undo(){const e=this.history.getCursor();e.canUndo()?(e.move(m.Move.stepBack),this.history.rewindTo(e,{storeAsRewind:!1}),this.loadState(this.history.latestState,c.NewGameStateContext.Undo)):f.error("Undo not available in current state")}undoAll(){const e=this.history.getCursor();e.canUndo()?(e.move(m.Move.seekBackTag("turnStart")),this.history.rewindTo(e,{storeAsRewind:!1}),this.loadState(this.history.latestState,c.NewGameStateContext.Undo)):f.warning("Undo not available in current state")}rewindTo(e){this.history.rewindTo(e,{storeAsRewind:!0}),this.loadState(this.history.latestState,c.NewGameStateContext.Rewind)}clearHistory(){this.history.reset(this.currentState),this.updateUndoAvailability()}beginTransaction(){this.eventsPaused=!0}commitTransaction(){this.eventsPaused=!1,this.trimScheduledPlaysAfterPlayerVictory(),this.scheduledPlays.forEach((e=>this.fireEventsAfterPlay(e.play,e.events,e.state))),this.scheduledPlays=[]}trimScheduledPlaysAfterPlayerVictory(){const e=this.scheduledPlays.findIndex((e=>e.events.find((e=>(0,s.isEvent)(e,a.GameStateEvents.GameOver)&&1===e.payload.winningFactionId))));-1!==e&&(this.scheduledPlays=this.scheduledPlays.slice(0,e+1),this.model.restore(this.scheduledPlays[e].state))}abortTransaction(){this.eventsPaused&&(this.eventsPaused=!1,this.scheduledPlays=[])}createCheckpoint(){return{state:this.currentState,cursor:this.history.getCursor(),plays:[...this.scheduledPlays]}}restoreCheckpoint(e){this.model.restore(e.state),this.history.rewindTo(e.cursor,{storeAsRewind:!1}),this.scheduledPlays=[...e.plays]}hasLocalPlayerWon(){const e=this.history.getCursor().latestEvent;return(0,s.isEvent)(e,a.GameStateEvents.GameOver)&&1===e.payload.winningFactionId}get currentState(){return this.model?.stateEngine.currentState}handlePlay(e){const t=this.movesCache.get(this.model.state,e);if(t)this.model.restore(t.state),this.fireEventsAfterPlay(e,t.events);else{const t=this.model.state,i=(0,p.gameStateReducer)(this.model,e);this.movesCache.set(t,e,this.model.state,i),this.fireEventsAfterPlay(e,i)}(0,s.isEvent)(e,a.Plays.EndTurn)&&this.movesCache.flush()}fireEventsAfterPlay(e,t,i=this.currentState){if(this.eventsPaused&&!r.config.debug.ai)this.scheduledPlays.push({play:e,events:t,state:i});else if(this.eventsPaused&&r.config.debug.ai)this.history.addPlay(e,t,i);else{this.history.addPlay(e,t,i);for(let e of t)this.fireEvent(e)}this.updateUndoAvailability()}fireEvent(e){this.onEvent.fire(e)}executePlay(e){if(e.category!=s.EventCategory.Play)throw new Error(`cannot execute ${e.name} - does not appear to be a Play`);this.handlePlay(e)}isOnTurnStart(){return this.history.getCursor().currentStep.tags.has("turnStart")}}},97849:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssertionError=void 0,t.assert=o;const s=i(7334),n=i(2543);function o(e,t=`expected ${e} to be truthy`){if(!e)throw new a(e,t)}o.defined=(e,t=`expected ${e} to be defined`)=>{if(!(0,s.isDefined)(e))throw new a(e,t)},o.undefined=(e,t=`expected ${e} to be undefined`)=>{if((0,s.isDefined)(e))throw new a(e,t)},o.equal=(e,t,i=`expected ${e} to equal ${t}`)=>{if((0,n.isEqual)(e,t))throw new a(e,i)},o.naturalNumber=(e,t=`expected ${e} to be a natural number`)=>{o("number"==typeof e&&e>0&&Math.floor(e)===e,t)};class a extends Error{constructor(e,t){t||(t="failed for value %s"),super(t.replace("%s",e?.toString()))}}t.AssertionError=a},97869:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SpectatorMode=void 0,t.updateTransitionSpeedForSpectatorMode=D;const s=i(41569),n=i(27700),o=i(49796),a=i(20693),r=i(39420),l=i(24598),c=i(91622),d=i(54825),h=i(51496),u=i(36868),p=i(34562),g=i(12933),m=i(56824),y=i(8570),f=i(7334),w=i(94330),v=i(79694),b=i(2543),S=i(45084),x=i(18811),T=i(98963),P=i(30484),I=i(43046),C=i(10131),M=i(16007),A=i(71021),B=i(19618),E=i(53360),O=i(32408),R=i(77563);var k;!function(e){e.Playback="playback",e.Idle="idle",e.Skipping="skipping"}(k||(k={}));const L=m.logger.for("SpectatorMode");class _ extends s.BaseMode{constructor(e,t=n.SpectatingContext.Live){super(e),this.context=t,this.name="Spectator",this.state=k.Idle,this.requestedPlays=!1,this.focusedRegions=[],this.observe.event(u.UserActions.GoToPreviousTurn,(()=>this.moveCursor((e=>{e.move(I.Move.seekBackTag("turnStart",0),I.Move.stepBack,I.Move.seekBackTag("turnStart",0),I.Move.stepForward,I.Move.seekForwardTag("turnStart"))||e.goTo(0)})))),this.observe.event(u.UserActions.GoToNextTurn,(()=>this.moveCursor((e=>{e.move(I.Move.stepForward,I.Move.seekForwardTag("turnStart",0),I.Move.stepForward,I.Move.seekForwardTag("turnStart"))})))),this.observe.event(u.UserActions.GoToStart,(()=>this.moveCursor((e=>{e.goTo(0)})))),this.observe.event(u.UserActions.GoToEnd,(()=>this.moveCursor((e=>{e.goToLastStep()}))))}get paused(){return c.inject.ui.spectatingSpeed()===M.SpectatingPlaybackSpeed.Paused}moveCursor(e){this.canceled()||(m.events.trigger(u.UserActions.SetSpectatingPlayBackSpeed(M.SpectatingPlaybackSpeed.Paused)),e(this.scene.cursor),d.app.scene.worldMap.syncState(this.scene.cursor.currentState,P.OverlayModes.spectating()),this.refreshPlayUI())}activate(){super.activate(),D(c.inject.ui.spectatingSpeed()),this.scene.worldMapScene.pawns.clearAllJumping(),this.scene.uiScene.updateState({layout:{name:"spectate",spectatingContext:this.context,enableSkipSpectating:this.context!==n.SpectatingContext.ReplayOnly,enableDownloadReplay:this.context!==n.SpectatingContext.Live,spectatingSpeed:c.inject.ui.spectatingSpeed(),spectatingTurnNumber:d.app.getCurrentGameStateModel().currentPhase.turnNumber}}),d.app.scene.worldMap.overlays.set(d.app.getCurrentGameStateModel().state,P.OverlayModes.spectating()),this.cameraPreset=d.app.scene.worldMap.cameraController.savePreset(),this.selectedRegionIdPreset=c.inject.levelSession.selectedRegionId,this.spectatingSpeedPreset=c.inject.ui.spectatingSpeed(),this.context===n.SpectatingContext.LiveReplay?m.events.trigger(u.UserActions.SetSpectatingPlayBackSpeed(M.SpectatingPlaybackSpeed.Normal)):this.context===n.SpectatingContext.ReplayOnly?m.events.trigger(u.UserActions.SetSpectatingPlayBackSpeed(M.SpectatingPlaybackSpeed.Paused)):m.events.trigger(u.UserActions.SetSpectatingPlayBackSpeed(c.inject.userData.recallChoice("spectatingSpeed")||M.SpectatingPlaybackSpeed.Normal)),this.refreshPlayUI(),this.eventListener=c.inject.ui.spectatingSpeed.watch(((e,t)=>{t===M.SpectatingPlaybackSpeed.Paused&&e!==M.SpectatingPlaybackSpeed.Paused&&this.state===k.Idle&&this.playNext()}))}deactivate(){super.deactivate(),this.eventListener?.unsubscribe(),h.track.spectatingOver({spectating_speed:this.state===k.Skipping?0:c.inject.ui.spectatingSpeed()}),this.state===k.Skipping&&(d.app.scene.worldMap.overlays.attitudeEmojis.setThinkingFaction(void 0),d.app.scene.worldMap.syncState(c.inject.currentGameState,P.OverlayModes.spectating()),d.app.scene.playUI.updateFromGameState(),d.app.scene.globalUI.hideFastForwardOverlay()),d.app.scene.worldMap.cameraController.panTo(this.cameraPreset,300),this.context===n.SpectatingContext.ReplayOnly&&m.events.trigger(u.UserActions.SetSpectatingPlayBackSpeed(this.spectatingSpeedPreset)),this.context===n.SpectatingContext.LiveReplay&&c.inject.levelSession.active&&(m.events.trigger(u.UserActions.SetSpectatingPlayBackSpeed(this.spectatingSpeedPreset)),this.selectedRegionIdPreset&&d.app.screen.play.selectRegion(this.selectedRegionIdPreset,{clickEffect:!1,panCamera:!0}))}isLive(){return this.context===n.SpectatingContext.Live}async processEvents(e){[k.Idle,k.Skipping].includes(this.state)&&await this.playNext()}async playNext(){const e=this.scene.cursor;if(!this.paused&&this.isActive()){if(this.state===k.Skipping&&(e.hasNext()&&(this.requestedPlays=!1),this.processAllEvents(e)),!e.hasNext()){if(this.requestedPlays)return;const t=e.latestEvent;if(this.isLive()&&(0,r.isEvent)(t,u.GameStateEvents.FactionTurnStarted)){this.requestedPlays=!0;const i=d.app.getCurrentGameStateModel().factions.byId(t.payload.factionId);(0,y.handleFactionTurnStarted)({state:e.currentState,factionId:i.id}),i.controller===l.FactionController.Ai&&c.inject.ai.waitEstimator.getEstimateFor(i)>500&&d.app.scene.worldMap.overlays.attitudeEmojis.setThinkingFaction(i)}return d.app.screen.play.context===A.NewGameStateContext.ViewReplayAfterGameOver?this.context===n.SpectatingContext.Live?void m.events.trigger(u.SystemEvents.ShowGameOverScreen(c.inject.levelSession.outcome)):void m.events.trigger(u.UserActions.ExitSpectatingMode({returnTo:c.inject.levelSession.outcome===x.LevelOutcome.Victory?"victoryScreen":"defeatScreen"})):(this.context===n.SpectatingContext.LiveReplay?(this.scene.setMode(new v.PlayMode(this.scene)),R.WorldMapUpdater.setPawnJumpingInRegions(c.inject.gameStateModel.currentPhase.faction?.getLiveRegions()??[])):this.context===n.SpectatingContext.ReplayOnly&&(c.inject.ui.spectatingSpeed.set(M.SpectatingPlaybackSpeed.Paused),this.setFocus(e.currentState,[],[])),void((0,E.isAISpectatingMode)()&&B.Factions.model(e.currentState).alive().length<=1&&m.events.trigger(u.SystemEvents.ShowGameOverScreen(x.LevelOutcome.Defeat))))}for(this.requestedPlays=!1,this.setState(k.Playback);e.hasNext()&&this.state===k.Playback&&!this.paused;){const t=H(e);if(this.refreshPlayUI(),t){await this.executeScreenPlay(t),c.inject.gameStateController.history.hadErrors&&e.currentStep.compressedState&&(d.app.scene.worldMap.syncState(e.currentState),c.inject.gameStateController.history.resetErrorsFlag()),this.applyEmojiReactions(t.gameEvents);break}}this.setState(k.Idle),await this.processEvents(e)}}refreshPlayUI(){const e=this.scene.cursor.currentState,t=c.inject.gameStateController.history.latestState;d.app.scene.worldMap.overlays.attitudeEmojis.setThinkingFaction(void 0),d.app.scene.playUI.updateState({turnNumber:S.CurrentPhase.getTurnNumber(t)}),d.app.scene.playUI.updateSpectatingLayout({spectatingTurnNumber:S.CurrentPhase.getTurnNumber(e)}),d.app.scene.playUI.updatePowerBalanceFromGameState(e)}setState(e){this.state!==k.Skipping&&(this.state=e)}async executeScreenPlay(e){if(e.forceFullSync)return d.app.scene.worldMap.syncState(e.forceFullSync,P.OverlayModes.spectating()),d.app.audio.playEffect(T.SoundEffects.Rewind),void await this.setFocus(e.forceFullSync,e.focusRegions,e.highlightHexes);const t=d.app.scene.worldMap.session();for(let i of e.worldUpdates){if(!t.isActive())break;if(await this.setFocus(i.stateBefore,e.focusRegions,e.highlightHexes),!t.isActive())break;if(await(0,f.withTimeout)(this.scene,d.app.scene.worldMap.play(i),3e3)===f.TIMEOUT&&this.isProcessingEvents)return L.warning("ScreenPlay execution timeout!"),m.errors.handleNonFatalError(new Error(`event handling timeout while processing ${(0,w.describeScreenPlay)(e)}`),"executeScreenPlay timeout"),this.handleSkipSpectating(),void this.playNext()}this.applyEffectsAfterEventsProcessed(e.gameEvents)}applyEffectsAfterEventsProcessed(e){if(this.isLive())for(let t of e)d.app.worldNews.handle(t),(0,r.isEvent)(t,u.GameStateEvents.GameOver)&&!(0,E.isAISpectatingMode)()&&(0,O.handleGameOver)(t.payload)}canceled(){return!this.isActive()||this.state===k.Skipping}async setFocus(e,t,i){const s=t.length&&!(0,b.isEqual)(t,this.focusedRegions);this.focusedRegions=t;const r=d.app.scene.worldMap,l=a.HexGroup.fromIds(i),h=c.inject.userData.recallChoice("cameraFollow")!==x.CameraFollowPreset.Off;if(r.overlays.set(e,P.OverlayModes.spectating({highlightHexes:l,highlightRegions:t})),h&&l.length>0){const e=this.context===n.SpectatingContext.Live&&c.inject.userData.recallChoice("cameraFollow")===x.CameraFollowPreset.On;await r.cameraController.ensureRectVisible((0,o.rectToPhaser)(l.getDisplayBoundingBox()),{allowZoom:e})}s&&this.state!==k.Skipping&&await(0,C.sleep)(function(e){switch(e){case M.SpectatingPlaybackSpeed.Paused:case M.SpectatingPlaybackSpeed.UltraFast:return 0;case M.SpectatingPlaybackSpeed.Fast:return 250;case M.SpectatingPlaybackSpeed.Normal:return 500}}(c.inject.ui.spectatingSpeed()))}handleSkipSpectating(){d.app.screen.play.isReplay||(d.app.screen.play.context!==A.NewGameStateContext.ContinueSpectatingAfterGameOver?(this.setState(k.Skipping),this.paused&&m.events.trigger(u.UserActions.SetSpectatingPlayBackSpeed(M.SpectatingPlaybackSpeed.Normal)),this.isProcessingEvents=!1,d.app.scene.globalUI.showFastForwardOverlay(300),this.processEvents(this.scene.cursor)):m.events.trigger(u.UserActions.GoBack()))}isReadyForMoreGameEvents(){return c.inject.ui.spectatingSpeed()!==M.SpectatingPlaybackSpeed.Paused&&super.isReadyForMoreGameEvents()}isHexInteractive(e){return!1}handleStartDrag(e){d.app.scene.worldMap.cameraController.startDragScroll()}handleEndDrag(e){d.app.scene.worldMap.cameraController.stopDragScroll()}handleEndTurn(){m.events.trigger(u.UserActions.SkipSpectating())}handleAbort(){this.context===n.SpectatingContext.LiveReplay?m.events.trigger(u.UserActions.SkipSpectating()):super.handleAbort()}canEndTurn(){return!0}doHandleEvent(e){return(0,g.doHandleEvent)(this,e)}processAllEvents(e){if(this.isLive())for(;e.hasNext();){const t=e.consumeNextPlay();this.applyEffectsAfterEventsProcessed(t)}else e.goToLastStep()}applyEmojiReactions(e){for(let t of e)"GAME_STATE.FACTION_CREDIT_CHANGED"===t.name&&d.app.scene.worldMap.overlays.attitudeEmojis.playCreditChange(t.payload)}isSkipping(){return this.state===k.Skipping}}function D(e){c.inject.ui.transitionsSpeed.set(function(e){switch(e){case M.SpectatingPlaybackSpeed.Paused:return 0;case M.SpectatingPlaybackSpeed.UltraFast:return 300;case M.SpectatingPlaybackSpeed.Fast:return 450;case M.SpectatingPlaybackSpeed.Normal:return 600}}(e))}function H(e){if(c.inject.ui.spectatingSpeed()!==M.SpectatingPlaybackSpeed.Paused){if((0,r.isEvent)(e.peekNextEvent(),u.GameStateEvents.NewGameState)){e.move(I.Move.stepForward);const t=e.currentStepEvents[0];return{gameEvents:[t],highlightHexes:[],focusRegions:[],affectedRegions:[],worldUpdates:[],forceFullSync:t.payload.state}}switch(c.inject.ui.spectatingSpeed()){case M.SpectatingPlaybackSpeed.UltraFast:return(0,p.groupByFactionsScreenWriter)(e);case M.SpectatingPlaybackSpeed.Fast:return(0,p.groupByRegionsScreenWriter)(e);case M.SpectatingPlaybackSpeed.Normal:return(0,p.playByPlayScreenwriter)(e)}}}t.SpectatorMode=_},98121:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelSession=void 0,t.getCurrentVictoryDistance=T;const s=i(97849),n=i(91622),o=i(35800),a=i(36868),r=i(39481),l=i(56082),c=i(83544),d=i(9292),h=i(2543),u=i(54825),p=i(38620),g=i(66143),m=i(56824),y=i(75742),f=i(78349),w=i(71021),v=i(85026),b=i(84108),S=i(68878),x=m.logger.for("LevelSession");function T(){if(u.app.navigator.currentScreen===u.app.screen.defeat)return 0;if(u.app.navigator.currentScreen===u.app.screen.victory)return 1;const e=n.inject.views.powerBalance.get(n.inject.currentGameState),t=e.dominantFaction?.isLocalPlayer(),i=n.inject.gameStateModel.factions.byId(1).scaledPower,s=e.factionsByPower[0]?.scaledPower;return t?(0,d.cropNumber)(.5+e.dominance/200,.5,.99):(0,d.cropNumber)(i/s*.5,.01,.5)}t.LevelSession=class{get id(){return this.data?.id??""}get active(){return!!this.data}get outcome(){return this.data?.outcome}constructor(){this.fpsTracker=new l.FpsTracker,this.storedSessionEndEvent=new c.PersistentEntry(f.STORAGE_KEYS.LEVEL_SESSION_END_EVENT),this.storedInProgressRecord=new c.PersistentEntry(f.STORAGE_KEYS.IN_PROGRESS_LEVEL)}setOutcome(e){if(!this.data)return!1;this.data.outcome=e}initialize(){this.logBuilder=new r.PlayLogAutoBuilder;try{const e=this.storedSessionEndEvent.take();e&&m.events.trigger(a.SystemEvents.LevelSessionOver(e))}catch(e){m.errors.handleNonFatalError(e,`reading stored level session from "${f.STORAGE_KEYS.LEVEL_SESSION_END_EVENT}"`)}m.events.on(a.SystemEvents.UserBecameInactive,(()=>{this.persistEndEvent()})),m.events.on(a.UserActions.DismissSurrender,(()=>{n.inject.levelSession.onDismissedSurrender()}))}get selectedRegionId(){return this.data?.selectedRegionId??void 0}get levelId(){return this.data?.levelId??""}get remainingLives(){return this.data?.remainingLives??0}get aiDifficulty(){return this.data?.aiDifficulty??"hard"}get isFixedDifficulty(){return void 0!==g.LevelModel.for(this.levelId)?.manifest?.fixedAIDifficulty}get dismissedSurrender(){return!!this.data?.dismissedSurrenderTurn}onDismissedSurrender(){s.assert.defined(this.data,"onDismissedSurrender called with no active session"),this.data?.dismissedSurrenderTurn||(this.data.dismissedSurrenderTurn=n.inject.gameStateModel.currentPhase.turnNumber,this.saveLevelProgress())}setSelectedRegionId(e){s.assert.defined(this.data,"attempted to set selected region while no session is active"),this.data.selectedRegionId=e}startNew(e){this.active&&this.end({origin:e.origin,wipeAutoSave:!0}),this.fpsTracker.reset();const t="string"==typeof e.startingState?e.startingState:(0,v.encodeGameState)(e.startingState);this.data={origin:e.origin,id:m.random.id(o.ID_TYPE.Session),levelId:e.levelId,remainingLives:e.livesLeft??y.DEFAULT_LIVES_PER_LEVEL,selectedRegionId:void 0,dismissedSurrenderTurn:void 0,aiDifficulty:e.aiDifficulty,outcome:void 0,startingState:t};const i={sessionData:n.inject.levelSession.exportData(),turnNumber:1,currentGameState:t,startingGameState:t,created:Date.now()};(0,S.isPlayingEditorLevel)()||(this.storedInProgressRecord.read()&&this.clearInProgressLevelRecord(),this.storedInProgressRecord.put(i)),this.beginSession(e.origin,e.turnNumber)}resumeInProgressLevel(e){const t=this.getInProgressLevelRecord();t?(this.active&&this.end({origin:e,wipeAutoSave:!0}),this.data={...t.sessionData,selectedRegionId:void 0},this.beginSession(e,t.turnNumber)):m.errors.handleNonFatalError("attempted to resume in-progress level while no in-progress record exists","LevelSession.resumeInProgressLevel")}beginSession(e,t){this.data&&(n.inject.ai.maxAllowedUnitMight=void 0,n.inject.ai.allowSurrender=!0,m.events.trigger(a.SystemEvents.LevelSessionStarted({levelId:this.data.levelId,sessionId:this.data.id,origin:e,turnNumber:t,aiDifficulty:this.aiDifficulty})))}end(e){if(this.data){if(this.logBuilder.commitEntry(),this.shouldSaveReplay()&&(this.data.replay=(0,p.tryToEncodeCurrentReplay)()),m.events.trigger(a.SystemEvents.LevelSessionOver(this.buildEndEventData(e))),e.wipeAutoSave){try{(0,S.isPlayingEditorLevel)()||n.inject.userContent.saveReplay(n.inject.gameStateController.history.export({snapshotPolicy:["initial","p1-start","final"],includeRewinds:!1,sizeLimit:1e3,timestamp:Date.now(),remainingLives:this.remainingLives}),this.outcome)}catch(e){x.warning(`Failed to save replay for in-progress level: ${e}`)}this.storedInProgressRecord.discard()}this.storedSessionEndEvent.discard(),this.data=void 0}else m.errors.handleNonFatalError("attempted to end level session while no session is active","levelSession.end")}shouldSaveReplay(){const e=m.random.numberBetween(0,1);return u.app.remoteConfig.replaysSampleRate>e||!!this.logBuilder.hasErrors}buildEndEventData(e){return s.assert.defined(this.data),{levelId:this.levelId,sessionId:this.data.id,origin:e.origin,playLog:this.logBuilder.getPlayLog(),avgFps:(0,h.round)(this.fpsTracker.avgFps),minFps:(0,h.round)(this.fpsTracker.minFps),victoryDistance:(0,h.round)(T(),2),replay:this.data.replay}}exportData(){return s.assert.defined(this.data,"attempted to export level session while no session is active"),{levelId:this.data.levelId,remainingLives:this.data.remainingLives,dismissedSurrenderTurn:this.data.dismissedSurrenderTurn,aiDifficulty:this.data.aiDifficulty,id:this.data.id,origin:this.data.origin,outcome:this.data.outcome}}saveLevelProgress(){const e=n.inject.gameStateModel;if(this.persistEndEvent(),u.app.screen.play.context===w.NewGameStateContext.ContinueSpectatingAfterGameOver)return;if((0,S.isPlayingEditorLevel)())return;const t=n.inject.gameStateController.exportStateWithHistory({title:"autosave",snapshotPolicy:["initial","p1-rewind-checkpoints","final"],includeRewinds:!0,sizeLimit:1e3,aiDifficulty:this.aiDifficulty,remainingLives:this.remainingLives}),i={sessionData:this.exportData(),turnNumber:e.currentPhase.turnNumber,currentGameState:(0,v.encodeGameState)(t),created:Date.now()};let s=this.getInProgressLevelRecord();s?.sessionData.levelId!==i.sessionData.levelId&&(this.clearInProgressLevelRecord(),s=void 0),this.storedInProgressRecord.put({...s,...i})}clearInProgressLevelRecord(e){const t=this.getInProgressLevelRecord();if(t&&(this.storedInProgressRecord.discard(),!t.sessionData.outcome&&!(0,S.isPlayingEditorLevel)()))try{const i=(0,v.decodeGameState)(t.currentGameState),s=new b.GameHistory;if(i.replay){s.import(i.replay,{unpackRewinds:!1});const o=s.export({snapshotPolicy:["initial","p1-start","final"],includeRewinds:!1,sizeLimit:1e4,remainingLives:t.sessionData.remainingLives});n.inject.userContent.saveReplay(o,e,t.created).catch((e=>{m.errors.handleNonFatalError(e,"clearInProgressLevelRecord.storeContent")}))}}catch(e){m.errors.handleNonFatalError(e,"clearInProgressLevelRecord")}}getInProgressLevelRecord(){return this.storedInProgressRecord.read()??void 0}persistEndEvent(){if(this.data)try{this.storedSessionEndEvent.put({...this.buildEndEventData({origin:"exit-game"}),timestamp:Date.now()})}catch(e){m.errors.handleNonFatalError(e,"persistEndEvent")}}burnLife(){s.assert.defined(this.data,"attempted to burn life while there is no active session"),this.data.remainingLives>0&&this.data.remainingLives--}getTotalSeconds(){return this.logBuilder.getTotalSeconds()}getTurnsToVictory(){return this.data?.dismissedSurrenderTurn?this.data?.dismissedSurrenderTurn:n.inject.gameStateModel.currentPhase.turnNumber}}},98277:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TitleSceneContinueButton=void 0;const s=i(91622),n=i(86545),o=i(80959),a=i(56824),r=i(36868),l=i(2426),c=i(76049),d=i(96137),h=i(20087);class u extends n.BaseResponsiveContainer{constructor(e){super(e),this.stretchRight=!1;const t=o.UiBuilder.for(e);this.frame=new l.RoundedRect(e,{radius:20}),this.button=t.wood.primaryButton({text:"CONTINUE",icon:"ui/wood-icons/arrow-right",iconPlacement:"right",width:190,onClicked:()=>a.events.trigger(r.UserActions.ResumeGame())}),this.icon=t.image("ui/icons/battle"),this.titleText=t.text("In Battle",c.BitmapFont.Main,d.Colors.white),this.subtitleText=t.text("?",c.BitmapFont.Mini,d.Colors.white),this.add([this.frame,this.icon,this.titleText,this.subtitleText,this.button])}updateContent(e){const t=e.difficulty?` - ${e.difficulty}`:"";this.subtitleText.setText(`${e.levelName} - turn ${e.turnNumber}${t}`)}setStretchRight(e){this.stretchRight=e,this.preUpdate.makeDirty()}updateLayout(){const e=s.inject.theme.getCurrent();this.frame.setFillStyle(e.oceanShades.dark3),this.frame.setLineStyle(e.oceanShades.dark4,1),this.frame.setSize(this.width+(this.stretchRight?20:0),this.height),this.button.setPosition(this.width-this.button.width-20,this.height/2-this.button.height/2),this.icon.setPosition(20,this.height/2).setOrigin(0,.5);const t=this.width>370;this.titleText.setVisible(t),this.subtitleText.setVisible(t),this.titleText.setTint(e.white),this.subtitleText.setTint(e.white),h.Arrange.topToBottom({content:[this.titleText,this.subtitleText],y:this.height/2,origin:.5,spacing:6}),h.Arrange.alignX({content:[this.titleText,this.subtitleText],x:this.icon.x+this.icon.width+20,origin:0})}}t.TitleSceneContinueButton=u},98303:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintTownTool=void 0;const s=i(24598),n=i(63521),o=i(91622);t.PaintTownTool=class{constructor(){this.options={title:"Place Town",description:"click = add town\nctrl-click = remove town"},this.iconRecipe={image:"pawns/town-2",postProcess:e=>e.setScale(.5,.5).setOrigin(0,0)}}useOn(e,t){const i=o.inject.gameStateModel;if(!i.regions.byHex(e))return;const a=s.PawnType.Town,r=i.pawns.byHex(e).find((e=>e.hasTrait(n.PawnTraits.OccupiesTile))),l=i.pawns.byHex(e).find((e=>e.hasTrait(n.PawnTraits.Terrain)));t.ctrl?r&&r.destroy():r?r.type!==a?r.replaceWith(a):l&&l.destroy():(l&&l.destroy(),i.pawns.create({hex:e,type:a}))}}},98490:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AIPersonas=void 0;const s=i(13777),n=i(29751),o=i(29815);t.AIPersonas={get:e=>a[e]??a.king};const a={king:new n.King,goose:new s.Goose,lich:new o.LichKing}},98517:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.expeditionsTransitionOut=async function(){const e=n.config.screenTransitionDuration,t=s.app.scene.expeditions;let i=t.expeditionButtons.get();t.preUpdate.force(),t.disableLayoutUpdates=!0,await new Promise((s=>{const n=(t.bounds.height-i[0].y)/2;t.tweens.add({targets:i,y:`+=${n}`,alpha:{from:1,to:0},delay:t.tweens.stagger(30,{from:"last"}),duration:e,ease:"Sine.easeOut",onComplete:()=>s()})}));for(let e of i)e.setAlpha(1);t.disableLayoutUpdates=!1};const s=i(54825),n=i(56824)},98519:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexGroupValuationFromStateEngine=void 0,t.HexGroupValuationFromStateEngine=class{constructor(e,t){this.state=e,this.dataSet=t}get(e){return this.state.get(this.dataSet,e)}getHexIds(){return this.state.getEntryIds(this.dataSet)}}},98604:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexAssetValueUpdater=t.HexAssetValueProjection=void 0;const s=i(31011),n=i(4005),o=i(56038),a=i(13560),r=i(45664),l=i(7334),c=i(61634),d=i(81434),h=i(20693),u=i(88023);class p extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new g(this).update}bootstrap(e){return(0,u.ImmutableMap)().withMutations((t=>{const i=o.Regions.model(e).all();for(let s of i){const i=s.isBankrupt();for(let n of s.hexes)t.set(n.id,a.AssetValue.getFactors(e,n,!1,i))}}))}entryToString(e){return e.defensive+e.offensive+e.economic}entryToDebugString(e){return(0,l.prettyPrintObject)(e)}}t.HexAssetValueProjection=p;class g extends n.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet),this.hexesToUpdate=new Set}initialize(){this.hexesToUpdate.clear()}registerHandlers(e){e(this.dataSet.sources.pawnsByHex,this.handlePawnsByHexChanged),e(this.dataSet.sources.coinsByHex,this.handleCoinsByHexChanged),e(this.dataSet.sources.regionsByHex,this.handleHexRegionChanged),e(this.dataSet.sources.treasuryByRegion,this.handleRegionBudgetChanged),e(this.dataSet.sources.budgetByRegion,this.handleRegionBudgetChanged),e(this.dataSet.sources.movableUnits,this.handleMovableUnitsChanged)}handleMovableUnitsChanged(e){for(let t of e.addedEntries??[]){const e=d.Pawns.getPawnHex(this.newState,t);this.hexesToUpdate.add(e)}for(let t of e.deletedEntries??[]){const e=d.Pawns.getPawnHex(this.oldState,t);this.hexesToUpdate.add(e)}}handleRegionBudgetChanged(e){for(let[t]of e.updated??[]){const e=h.HexGroup.fromIds(d.Pawns.getByRegion(this.newState,t).map((e=>d.Pawns.getPawnHex(this.newState,e))));for(let t of e)this.hexesToUpdate.add(t.id)}}handlePawnsByHexChanged(e){e.updated?.forEach((e=>{this.hexesToUpdate.add(e.id)}))}handleCoinsByHexChanged(e){e.updated?.forEach((([e,t])=>{this.hexesToUpdate.add(e)}))}handleHexRegionChanged(e){e.updated?.forEach((([e,t])=>{this.hexesToUpdate.add(e)}))}createMutation(){for(let e of this.hexesToUpdate){const t=o.Regions.getByHex(this.newState,e),i=c.Economy.getTreasuryOf(this.newState,t)+c.Economy.getRegionBudget(this.newState,t).balance<0;this.builder.set(e,a.AssetValue.getFactors(this.newState,(0,r.getHex)(e),!1,i))}return super.createMutation()}}t.HexAssetValueUpdater=g},98648:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnDestroyedWinConditionModel=t.DefeatUnitWinConditionModel=t.AllyEveryoneWinConditionModel=t.DestroyHauntedTownsWinConditionModel=t.DefeatRivalWinConditionModel=t.DefeatAllRivalsWinConditionModel=void 0,t.getWinConditionModel=function(e){if("object"!=typeof e)return new d(e);switch(e.type){case"defeat-all-rivals":return new d(e);case"defeat-rival":return new h(e);case"destroy-haunted-towns":return new u(e);case"ally-everyone":return new p(e);case"defeat-pawn":return new g(e);case"pawn-destroyed":return new m(e);default:return l.errors.handleException(new Error(`Unknown win condition type: ${e.type}`)),new d(e)}};const s=i(24598),n=i(19618),o=i(81434),a=i(91622),r=i(45084),l=i(56824),c=i(26386);class d{constructor(e){}getDescription(e){return"Destroy all rival towns."}test(e){const t=n.Factions.model(e).all().filter((e=>e.isAlive()));return 1===t.length&&t[0].isLocalPlayer()}}t.DefeatAllRivalsWinConditionModel=d;class h{constructor(e){this.config=e}getDescription(e){return this.config.description??"Defeat "+n.Factions.model(e).byId(this.config.factionId)?.name??"?"}test(e){return!n.Factions.model(e).byId(this.config.factionId)?.isAlive()}}t.DefeatRivalWinConditionModel=h;class u{constructor(e){this.config=e}getDescription(e){return"Destroy all Haunted Towns."}test(e){return!o.Pawns.model(e).findOne({type:[s.PawnType.HauntedTown]})}}t.DestroyHauntedTownsWinConditionModel=u;class p{constructor(e){this.config=e}getDescription(e){return"Become ally with every faction."}test(e){const t=n.Factions.model(e).all().filter((e=>e.controller===s.FactionController.Ai&&e.isAlive())),i=n.Factions.model(e).localPlayer;return!!i&&t.every((t=>a.inject.views.hostility.get(e,{attacker:t,victim:i})<=.25))}}t.AllyEveryoneWinConditionModel=p;class g{constructor(e){this.config=e}getDescription(e){return this.config.description}test(e,t){return!!r.CurrentPhase.model(e).isLocalPlayerTurn()&&(0,c.wasPawnDefeated)(this.config.pawnId,t)}}t.DefeatUnitWinConditionModel=g;class m{constructor(e){this.config=e}getDescription(e){return this.config.description}test(e,t){return!!r.CurrentPhase.model(e).isLocalPlayerTurn()&&(Array.isArray(this.config.pawnId)?this.config.pawnId:[this.config.pawnId]).every((t=>!o.Pawns.model(e).byId(t)))}}t.PawnDestroyedWinConditionModel=m},98721:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsByRegionUpdater=t.PawnsByRegionProjection=void 0;const s=i(1326),n=i(83874),o=i(20026),a=i(4005),r=i(56038),l=i(88023);class c extends n.MultiMapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new d(this),this.update=this.updater.update.bind(this)}bootstrap(e){const t=(0,o.selectFromState)(e,this.sources.pawnsByHex),i=[];for(const[n,o]of t){const t=r.Regions.getByHex(e,n);t&&(0,s.pushIntoArrayByKey)(i,t,...o)}return n=i,(0,l.ImmutableMap)().withMutations((e=>{for(let[t,i]of Object.entries(n))e.set(Number(t),(0,l.ImmutableSet)(i))}));var n}}t.PawnsByRegionProjection=c;class d extends a.BaseUpdater{constructor(){super(...arguments),this.builder=new n.MultiMapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.pawnsHex,this._handlePawnsHexUpdate.bind(this)),e(this.dataSet.sources.regionsByHex,this._handleRegionsByHexUpdate.bind(this))}_handlePawnsHexUpdate(e){e.updated?.forEach((([e,t])=>{const i=(0,o.selectFromState)(this.oldState,this.dataSet.sources.pawnsHex,e),s=void 0!==t&&(0,o.selectFromState)(this.newState,this.dataSet.sources.regionsByHex,t);let n=void 0!==i&&(0,o.selectFromState)(this.oldState,this.dataSet.sources.regionsByHex,i);n!==s&&(n&&this.builder.remove(n,e),s&&this.builder.add(s,e))}))}_handleRegionsByHexUpdate(e){e.updated?.forEach((([e,t])=>{let i=(0,o.selectFromState)(this.oldState,this.dataSet.sources.regionsByHex,e),s=(0,o.selectFromState)(this.newState,this.dataSet.sources.pawnsByHex,e);s&&(i&&this.builder.remove(i,...s.toArray()),t&&this.builder.add(t,...s.toArray()))}))}}t.PawnsByRegionUpdater=d},98760:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Navigator=void 0;const s=i(56824),n=i(36868),o=i(91622),a=i(54825),r=i(25e3),l=s.logger.for("Navigator");t.Navigator=class{constructor(e){this.game=e,this.transitionInProgress=!1,this.history=[],this.lockedOrientation=!1}async goTo(e,t){if(this.transitionInProgress)return void l.warning(`Ignoring transition attempt to ${e.name} while another screen transition is already in progress`);this.transitionInProgress=!0;const i=this.activeScreen;a.app.tooltips.close(),r.NewsBox.hide(),this.updateScreenOrientationLock(e),this.currentScreen=e;let c=[];this.activeScreen&&(this.activeScreen.deactivate(),c=this.activeScreen.getScenes(),this.history.push(this.activeScreen),this.activeScreen=void 0);const d=e.getScenes();d.forEach((e=>{const t=this.game.scene.getScene(e);if(!t)throw new Error(`Scene not found: ${e}`);t.sys.isActive()||this.game.scene.run(e)})),await e.activate(t,i),s.events.trigger(n.SystemEvents.ScreenActivated({screen:e,previousScreen:i})),o.inject.debugData.set("screen",`${i?.name??"-"} => ${e.name}`),e!==i&&await Promise.all([i?.transitionOut(e).then((()=>{})),e.transitionIn(i).then((()=>{}))]),this.activeScreen=e,c.filter((e=>-1===d.indexOf(e))).forEach((e=>{this.game.scene.sleep(e)})),this.transitionInProgress=!1,o.inject.debugData.set("screen",e.name)}async updateScreenOrientationLock(e){if(a.app.device.isMobile())try{e.lockOrientation?(await(window.screen?.orientation?.lock?.("portrait")),this.lockedOrientation=!0):(this.lockedOrientation&&window.screen?.orientation?.unlock?.(),this.lockedOrientation=!1)}catch(e){l.warning("Unable to lock/unlock display orientation",e)}}}},98886:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorPalette=t.EMPTY_PALETTE_LAYOUT=void 0;const s=i(67016),n=i(56824),o=i(20034),a=i(86545),r=i(20087),l=i(76540);t.EMPTY_PALETTE_LAYOUT={other:[],terrain:[],units:[],ownership:[],basic:[]};const c={basic:0,ownership:1,terrain:2,units:3,other:4};class d extends a.AutoHeightResponsiveContainer{constructor(e){super(e),this.categories=[],this.keyMap=new Map,this.keyboardListeners=[];const t=(t,i=[])=>new s.Palette(e,{title:t,items:i,onItemSelected:e=>n.events.trigger(o.MapEditorActions.SelectTool(e)),spacing:l.PALETTE_SPACING});this.categories=[t(void 0,[]),t("Ownership",[]),t("Terrain",[]),t("Units",[]),t("Other",[])],this.add(this.categories)}setContent(e){if(e!==this._currentContent){this._currentContent=e,console.log("UPDATING PALETTE CONTENT",e),this.keyMap.clear(),this.keyboardListeners.forEach((e=>this.scene.input?.keyboard?.removeListener(e)));for(const[t,i]of Object.entries(e))this.categories[c[t]].setProps({items:i.map((e=>this.createItem(e.tool,e.hotkey,e.keyCode)))});for(const[e,t]of this.keyMap.entries()){const i=this.scene.input.keyboard.addKey(e);this.keyboardListeners.push(i),i.on("down",(()=>{this.select(t),n.events.trigger(o.MapEditorActions.SelectTool(t))}))}this.updateLayout()}}select(e){for(const t of this.categories)t.select(e)}updateLayout(){this.categories.forEach((e=>e.updateLayout())),r.Arrange.topToBottom({content:this.categories,spacing:4,y:0,origin:0}),this.updateSize()}calculateHeight(){const e=this.categories[this.categories.length-1];return e?e.y+e.height:0}createItem(e,t,i){return(i||t)&&this.keyMap.set(i||t,e),{image:e.iconRecipe,hotkey:t,value:e}}}t.MapEditorPalette=d},98953:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexGridSectors=void 0;const s=i(45664),n=i(47273);t.HexGridSectors=class{constructor(e){this.sectorSize=e,this.sectorsPerRow=Math.ceil(s.GRID_MAX_DIMENSION/this.sectorSize)}getSectorOf(e){const t=Math.floor(e.r/this.sectorSize),i=Math.floor(e.c/this.sectorSize);return t*this.sectorsPerRow+i}getSectorRect(e){return{x:e%this.sectorsPerRow*this.sectorSize-.5,y:Math.floor(e/this.sectorsPerRow)*this.sectorSize,width:this.sectorSize+.5,height:this.sectorSize}}getSectorCorners(e){const t=e%this.sectorsPerRow*this.sectorSize,i=Math.floor(e/this.sectorsPerRow)*this.sectorSize,n=[];for(let e=i;e<i+this.sectorSize;e++){const i=e*s.CORNERID_ROW_OFFSET+10*t+(e%2==0?0:5);for(let e=0;e<2*this.sectorSize;++e)n.push(i+5*e)}return n}getSectorsForCorner(e){let t=new Set,i=e%s.CORNERID_ROW_OFFSET;(0,n.isCornerOnEvenRow)(e)||(i-=5);const o=Math.floor(e/s.CORNERID_ROW_OFFSET),a=Math.floor(o/this.sectorSize)*this.sectorsPerRow,r=(this.sectorSize,this.sectorSize,Math.floor(i/10/this.sectorSize));return t.add(a+r),Array.from(t)}}},98963:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AudioManager=t.SoundEffects=void 0;const s=i(56824),n=i(54825),o=i(2543);var a;!function(e){e.Grab="grab.wav",e.Drop="drop.wav",e.Deny="deny.wav",e.ButtonDown="button-down.wav",e.ButtonUp="button-up.wav",e.ShutterClick="shutter-click.wav",e.Victory="victory.mp3",e.Glitter="glitter.mp3",e.Rewind="rewind.mp3",e.Defeat="defeat.mp3",e.TwinkleChimes="twinkle-chimes.mp3",e.TypeWriter="typewriter.mp3",e.ConquerBuilding="gentle-click.wav",e.ConquerUnit="gentle-click.wav",e.CoinsFew="coins/handful.wav",e.CoinsHandful="coins/spawn-many.wav",e.CoinPile="coins/pile-grab.wav",e.Dodge="whoosh.wav"}(a||(t.SoundEffects=a={}));const r=s.logger.for("audio");t.AudioManager=class{constructor(e){this.game=e,this.loaded=!1,this.overrides={},this.getDebouncedEffect=e=>(0,o.debounce)((t=>{if(!this.loaded)return;const i=e in this.overrides?this.overrides[e]:e;if(i)try{this.game.sound.play(i,t)}catch(e){r.error(`Error playing sound effect: ${e}`)}}),100),this.debouncedEffects={}}setOverride(e,t){t&&n.app.scene.play.load.audio(t,`assets/audio/${t}`).start(),this.overrides[e]=t}load(e){this.scene=e;for(let t of Object.values(a))e.load.audio(t,`assets/audio/${t}`),this.debouncedEffects[t]=this.getDebouncedEffect(t);e.load.once(Phaser.Loader.Events.COMPLETE,(()=>{this.loaded=!0}))}playEffect(e,t){this.debouncedEffects[e](t)}stopEffect(e){this.game.sound.stopByKey(e)}get mute(){return this._muted??this.game.sound.mute}set mute(e){this._muted=e,this.game.sound.mute=e}setVolume(e){this.game.sound.volume=e}get volume(){return this.game.sound.volume}}},99134:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TextBlock=t.MiniButtonsRow=void 0;var s=Phaser.GameObjects.Container,n=Phaser.GameObjects.Image,o=Phaser.GameObjects.BitmapText;const a=i(26502),r=i(76049),l=i(86545);t.MiniButtonsRow=class extends s{constructor(e,t,i){super(e),this.frames=t,this.buttons=[],this.components=[],this.tint=i,this.createButtons()}createButtons(){if(this.frames.length<2)throw new Error("MiniButtonsRow must have at least 2 buttons");this.addButton("left",this.frames[0]),this.frames.slice(1,this.frames.length-1).forEach((e=>{"display"===e?(this.textBlock=new c(this.scene),this.textBlock.width=80,this.textBlock.height=24,this.textBlock.updateLayout(),this.components.push(this.textBlock)):this.addButton("mid",e)})),this.addButton("right",this.frames[this.frames.length-1]),this.add(this.components),this.updateLayout()}addButton(e,t){const i=new n(this.scene,0,0,"atlas",t),s=new a.ImageButtonWithContent(this.scene,0,0,{down:!0,frame:`ui/mini-buttons/${e}`,content:i});this.tint&&i.setTint(this.tint),this.buttons.push(s),this.components.push(s)}setText(e){this.textBlock&&this.textBlock.setText(e)}updateLayout(){let e=0;for(let t of this.components)t===this.textBlock&&e++,t.x=e,e+=t.width-1;this.width=e+1,this.height=this.buttons[0]?.height??0}};class c extends l.BaseResponsiveContainer{constructor(e){super(e),this.label=new o(this.scene,0,0,r.BitmapFont.Mini,"turn 1/10").setTint(3355443).setOrigin(.5,.5),this.ribbon=new n(this.scene,0,0,"atlas","ui/mini-buttons/ribbon"),this.add([this.ribbon,this.label])}updateLayout(){this.label.setPosition(this.width/2,this.height/2),this.ribbon.setDisplaySize(this.width,this.ribbon.height)}setText(e){this.label.setText(e)}}t.TextBlock=c},99545:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.commands=void 0,t.registerConsoleCommands=function(){const e=t.commands,i=window;i.commands=e,i.game=e.game,i.debug=e.debug,i.rec=e.rec,i.config=e.config,i.edit=e.edit,i.ui=e.ui,i.inject=C.inject,i.app=M.app,i.GameState=o.GameState,i.getHex=G.getHex,V.config.debug.overlay};const n=i(36868),o=i(90952),a=i(24598),r=i(97849),l=s(i(17833)),c=i(20026),d=i(8358),h=i(24307),u=i(70712),p=i(7334),g=i(19618),m=i(76439),y=i(29322),f=i(97377),w=i(17565),v=i(39409),b=i(78436),S=i(85026),x=i(96704),T=i(15052),P=i(56038),I=i(23867),C=i(91622),M=i(54825),A=i(78282),B=i(38746),E=i(69447),O=i(29064),R=i(84757),k=i(71021),L=i(28361),_=i(97869),D=i(83282),H=i(78349),j=i(27700),F=i(64738),U=i(43046),G=i(45664),N=i(72427),V=i(56824),W=i(16007),z=i(32202),$=i(81434),Y=i(59956),K=i(18811),X=i(20034),q=i(88023);var J=Phaser.GameObjects.Image,Z=Phaser.GameObjects.Sprite,Q=Phaser.GameObjects.RenderTexture,ee=Phaser.Display.Color;function te(e){const t=C.inject.gameStateModel.stateEngine;let i=`${(0,c.isProjectionDataSet)(e)?t.isDataSetActive(e)?"":"":""} ${e.key} (${e.constructor.name})`;return(0,c.isProjectionDataSet)(e)&&(i+=`\nbased on:\n${e.parents.map((e=>`  ${ie(e)} ${e.key}`)).join("\n")}`),i+=`\nused by:\n${t.childrenOf(e).map((e=>`  ${ie(e)} ${e.key}`)).join("\n")}`,i}function ie(e){return(0,c.isProjectionDataSet)(e)?C.inject.gameStateModel.stateEngine.isDataSetActive(e)?"":"":""}t.commands={game:{save:(e="auto")=>{V.events.trigger(n.UserActions.SaveGame(e)),(0,A.updateUrlHash)("quickload")},resume:()=>{const e=M.app.getCurrentGameStateModel();C.inject.gameStateController.loadState(e.state,k.NewGameStateContext.ResumingGame),M.app.navigator.goTo(M.app.screen.play,k.NewGameStateContext.LoadingGame),M.app.scene.worldMap.syncState()},load:(e="auto")=>{V.events.trigger(n.UserActions.InternalLoadGame(e))},decode(e){const t=(0,S.decodeGameState)(e);console.log(JSON.stringify(t,null,2))},encode(e){console.log((0,S.encodeGameState)(JSON.parse(e)))},export(){const e=(0,S.encodeGameState)((0,x.compressGameState)(C.inject.gameStateModel.state));console.log(e)},import(e){const t=(0,S.decodeGameState)(e);C.inject.gameStateModel.restore(t),V.events.trigger(n.UserActions.DebugGameState(C.inject.currentGameState))},rewind:()=>{V.events.trigger(n.UserActions.StartRewind())},endTurn:()=>{C.inject.gameStateController.executePlay(n.Plays.EndTurn())},setFaction:(e,t)=>{C.inject.gameStateModel.stateEngine.apply(o.GameState.factions.byId.createMutation({set:{[e]:{...C.inject.gameStateModel.stateEngine.get(o.GameState.factions.byId,e),controller:t}}},"command"))},setTheme(e){C.inject.userData.rememberChoice("preferredTheme","themeId"),V.events.trigger(n.UserActions.SyncWithModel())},takeOver(e){if(void 0===e)for(let e of C.inject.gameStateModel.factions.all().filter((e=>e.controller===a.FactionController.Ai)))t(e.id);else t(e);function t(e){C.inject.gameStateModel.stateEngine.apply(o.GameState.factions.byId.createMutation({set:{[e]:{...C.inject.gameStateModel.stateEngine.get(o.GameState.factions.byId,e),controller:a.FactionController.LocalUser}}},"command"))}},sync:()=>{V.events.trigger(n.UserActions.SyncWithModel())},get state(){return C.inject.gameStateModel.stateEngine.serialize()},get rawState(){return C.inject.gameStateModel.stateEngine.currentState},get stateModel(){return C.inject.gameStateModel},get stateController(){return C.inject.gameStateController},win(){V.config.debug.cheats||console.warn("Cheats are not enabled"),V.events.trigger(n.SystemEvents.ShowGameOverScreen(K.LevelOutcome.Victory))},lose(){V.config.debug.cheats||console.warn("Cheats are not enabled"),V.events.trigger(n.SystemEvents.ShowGameOverScreen(K.LevelOutcome.Defeat))},setRewinds(e){C.inject.levelSession.data&&(C.inject.levelSession.data.remainingLives=e,M.app.scene.playUI.updateFromGameState(C.inject.currentGameState))},toggleDifficulty(){const e=C.inject.levelSession.aiDifficulty;C.inject.levelSession.data.aiDifficulty="hard"===e?"normal":"hard",V.events.trigger(n.UserActions.SyncWithModel())},spawnLich(e=6){(0,z.zombifyLevelModel)(C.inject.gameStateModel),g.Factions.setData(C.inject.currentGameState,e,{persona:"lich",name:"The Necromancers"}),Y.WorldMap.update(C.inject.currentGameState,{winConditions:[{type:"defeat-rival",factionId:e}]}),M.app.scene.worldMap.syncState()},spawnRosaline(){let e=C.inject.gameStateModel.pawns.findOne({hexes:C.inject.gameStateModel.factions.localPlayer?.hexes,type:[a.PawnType.Hero]});e=e.replaceWith(a.PawnType.UniqueHero),$.Pawns.setPawnName(C.inject.currentGameState,e.id,"Rosaline the Righteous"),M.app.scene.worldMap.syncState()}},debug:{off(){const e=V.config.debug;e.tweenSpeedFactor=1,e.overlay=!1,e.recordStateChanges=!1,e.integrityChecks=void 0,e.ai=!1,e.datgui=!1,C.inject.debugLayers.activate(void 0)},on(){V.config.debug.overlay=!0},edit:()=>{M.app.navigator.goTo(M.app.screen.mapEditor,{cloneCurrentLevel:!0})},logs(e){l.default.enable(e)},history(){M.app.navigator.goTo(M.app.screen.debugHistory)},gameHistory(){console.log(C.inject.gameStateController.history.debugDump(1e3))},borders(){C.inject.debugLayers.activate("TileBordersManager")},layer(e){const t=C.inject.gameStateModel.stateEngine.getDataSetByKey(e);if(t&&console.log(te(t)),C.inject.debugLayers.get(e))C.inject.debugLayers.activate(e);else{if(!t)throw new Error(`No dataset found for key "${e}"`);const i=F.CUSTOM_WORLD_DEBUG_LAYERS[e],s=i?i():new m.GameStateDebugLayer((0,f.dataSetAdapter)(t));C.inject.debugLayers.registerAndActivate(e,s)}},dataSets(){const e=C.inject.gameStateModel.stateEngine;console.log(e.getAllDataSets().toArray().sort((function(e,t){let i=e.key.split(".")[0],s=t.key.split(".")[0],n=i+"."+((0,c.isProjectionDataSet)(e)?"Z":"A")+"."+e.key,o=s+"."+((0,c.isProjectionDataSet)(t)?"Z":"A")+"."+t.key;return(0,d.compareStrings)(n,o)})).map((t=>`${(0,c.isProjectionDataSet)(t)?e.isDataSetActive(t)?"":"":""} ${t.key} (${t.constructor.name})`)).join("\n"))},factionDataSet(e){const t=C.inject.gameStateModel.stateEngine,i=C.inject.gameStateModel.stateEngine.getDataSetByKey(e);if(!i)throw new Error(`No dataset found for key "${e}"`);console.log(te(i));const s=(0,c.selectFromState)(t.currentState,i).entrySeq(),n=s.map((([e])=>e)).toJS(),o=s.map((([e,t])=>t)).toJS();console.table({faction:n,value:o})},hexImportance(){C.inject.debugLayers.activate("ai.hexImportance")},threatAssessment(e=C.inject.gameStateModel.currentPhase.faction?.id||1){const t=C.inject.gameStateModel.factions.byId(e),i=new w.ThreatAssessment(t);C.inject.debugLayers.registerAndActivate("threatAssessment",i.getDebugLayer())},benchmarkRegionInfluence(){const e=(0,S.decodeGameState)(L.BUILT_IN_MAPS.benchmark);C.inject.gameStateController.loadState(e,k.NewGameStateContext.LoadingGameStateForDebug);for(let e=0;e<=4;++e){const t=R.timing.start(`REGION INFLUENCE BENCHMARK RUN #${e}`);for(let e=0;e<10;++e)o.GameState.ai.regionInfluenceByHex.bootstrap(C.inject.currentGameState);t.complete()}},benchmarkThreatAssessment(){const e=(0,S.decodeGameState)(L.BUILT_IN_MAPS.benchmark);C.inject.gameStateController.loadState(e,k.NewGameStateContext.LoadingGameStateForDebug);for(let e=0;e<=4;++e){const t=R.timing.start(`THREAT ASSESSMENT BENCHMARK RUN #${e}`);for(let e=0;e<10;++e)for(let e of C.inject.gameStateModel.factions.all()){const t=new w.ThreatAssessment(e);for(let i of e.hexes)t.calculate(i.id)}t.complete()}},conquestValue(e=C.inject.gameStateModel.currentPhase.faction?.id||1){const t=C.inject.gameStateModel.factions.byId(e),i=new E.RegionAIContext(t.getRegions()[0]),s=new O.ConquestValue(i,(0,v.createAiViews)(i));C.inject.debugLayers.registerAndActivate("conquestValue",s.getDebugLayer())},security(e,t){e||(e=C.inject.gameStateModel.regions.byId(C.inject.levelSession.selectedRegionId)?.faction?.id);const i=C.inject.gameStateModel.factions.byId(e);r.assert.defined(i,"invalid faction id");const s=(0,v.createAiViews)((0,E.createAiContext)(i.getLargestLiveRegion()));t&&s.planningSecurity.setRecklessness(t),C.inject.debugLayers.registerAndActivate("security",s.planningSecurity.getDebugLayer())},regionInfluence(e=C.inject.levelSession.selectedRegionId){r.assert.defined(e);const t=C.inject.gameStateModel.regions.byId(e);r.assert.defined(t),C.inject.debugLayers.registerAndActivate("regionInfluence",(0,h.createHexInfluenceDebugLayer)(e))},factionInfluenceByRegion:function(e,t=I.PowerMeasurement.MilitaryMight,i=1/0){C.inject.debugLayers.registerAndActivate(`factionInfluenceByRegion(${e})`,C.inject.views.factionInfluenceByRegion.getDebugLayer(e,t,i))},fear:function(e){C.inject.debugLayers.registerAndActivate(`fear(faction=${e})`,C.inject.views.fear.getDebugLayer(e))},hexIds(){this.layer("hexIds")},regionAssets(){this.layer("regionAssets")},regionForecast(){this.layer("regionForecast")},credit(e=1){const t=C.inject.gameStateModel,i=t.factions.byId(e);r.assert.defined(i);const s=t.factions.all().filter((e=>e.controller!==a.FactionController.None));let n=[["from \\ towards",...s.map((e=>e.id))]],o=1;for(let e of s){n[o]=[e.id];for(let i of s)n[o].push(u.AI.getFactionCredit(t.state,e.id,i.id));++o}console.table(n),C.inject.debugLayers.registerAndActivate("credit",new m.GameStateDebugLayer((0,y.factionBasedAdapter)({getValue:(e,t)=>u.AI.getFactionCredit(e,t,i.id),getDetail:(e,t)=>(0,p.prettyPrintObject)(u.AI.getFactionCredit(e,t))})))},async frontlines(e=2,t=C.inject.levelSession.selectedRegionId){const i=C.inject.gameStateModel.regions.byId(t);r.assert.defined(i);const s=new w.ThreatAssessment(i.faction),n=new B.Frontlines(new E.RegionAIContext(i),{threatAssessment:s},e);await n.calculate()},diplomacy(){this.layer("diplomacy")},hostility(e=C.inject.levelSession.selectedRegionId){r.assert.defined(e),C.inject.debugLayers.registerAndActivate("hostility",C.inject.views.hostility.getDebugLayer(e))},defenderBenefit(e=C.inject.levelSession.selectedRegionId){const t=C.inject.gameStateModel.regions.byId(e),i=new E.RegionAIContext(t),s=(0,v.createAiViews)(i);C.inject.debugLayers.registerAndActivate("defenderBenefit",s.defenderBenefit.getDebugLayer())},safeAssets(e=C.inject.levelSession.selectedRegionId){const t=(0,E.createAiContext)(P.Regions.model(C.inject.currentGameState).byId(e)),i=(0,v.createAiViews)(t),s=new m.GameStateDebugLayer((0,b.regionBasedAdapter)({getValue:(e,s)=>P.Regions.model(e).byId(s).getMySafeAssets(i.planningSecurity,t.focus.daring).toString(),getDetail(e,t){}}));C.inject.debugLayers.registerAndActivate("safeAssets",s)},powerBalance(){const e=C.inject.views.powerBalance.get(C.inject.currentGameState);return{...e,dominantFaction:e.dominantFaction?.id,factionsByPower:e.factionsByPower.map((e=>e.id))}},factionNeighbours(e){void 0===e&&(e=M.app.screen.play.selectedRegion?.faction?.id),r.assert.defined(e),C.inject.debugLayers.registerAndActivate("factionNeighbours",C.inject.views.factionNeighboursView.getDebugLayer(e))},attitude(e=1){const t=C.inject.gameStateModel,i=t.factions.byId(e);r.assert.defined(i);const s=t.factions.all().filter((e=>e.controller!==a.FactionController.None));let n=[["from \\ towards",...s.map((e=>e.id))]],o=1;for(let e of s){n[o]=[e.id];for(let i of s)n[o].push(u.AI.getFactionAttitude(t.state,e.id,i.id));++o}console.table(n),C.inject.debugLayers.registerAndActivate("credit",new m.GameStateDebugLayer((0,y.factionBasedAdapter)({getValue(e,t){if(t===i.id)return"";const{forecast:s,credit:n,attitude:o}=C.inject.views.attitude.getComponents(e,{fromFactionId:t,towardsFactionId:i.id});return`${o}\n(A${n};F${s})`},getDetail:(e,t)=>g.Factions.model(e).all().filter((e=>e.controller!==a.FactionController.None&&e!==i&&e.id!==t)).map((i=>{const s=C.inject.views.attitude.getComponents(e,{fromFactionId:t,towardsFactionId:i.id});return`${s.attitude} towards F${i.id} (A${s.credit};F${s.forecast})`})).join("\n")})))},testVictoryPrompt(){M.app.notifications.claimVictory()},downloadReplay(){const e=C.inject.gameStateController.history.export({snapshotPolicy:["initial","p1-rewind-checkpoints","final"],includeRewinds:!0,sizeLimit:1e3,remainingLives:C.inject.levelSession.remainingLives}),t=(0,S.encodeReplay)(e);(0,D.downloadAsTextFile)("replay.konkr",t)},testReporting(){V.errors.handleException(new Error("Test Error (triggered by commands.testReporting())")),(0,T.reportFeedback)({comment:"Testing Feedback Message",email:"commands.testReporting()",mood:4})},testLevelFeedback(){M.app.notifications.askForLevelFeedback("123")},testError(){setTimeout((()=>myUndefinedFunction2()),0)},testKongStatistics(){try{window.kongregateAPI={},N.Kongregate.finishInitialization()}catch(e){console.warn(e)}N.Kongregate.submitStatistics()},exportReplay(){const e=C.inject.gameStateController.history.export({snapshotPolicy:["initial"],includeRewinds:!0,sizeLimit:2e3,remainingLives:C.inject.levelSession.remainingLives}),t=(0,S.encodeReplay)(e);console.log(e),console.log(`ENCODED (${(t.length/1e3).toFixed()} KB)`,t),console.log("DECODED",(0,S.decodeReplay)(t))},exportUserData(){const e=C.inject.userData.current,t=(0,S.encodeUserData)(e);(0,D.downloadAsTextFile)(`player-profile-export-${(0,p.simpleDateStamp)()}.konkr`,t)},importReplay(e){V.events.trigger(n.UserActions.LoadReplay(e))},goToHistoryState(e){const t=C.inject.gameStateController.history.getCursor();t.goTo(e),C.inject.gameStateController.loadState(t.currentState,k.NewGameStateContext.LoadingGameStateForDebug)},inspectState(){console.log((0,x.compressGameState)(C.inject.currentGameState))},inspectHistory(){const e=C.inject.gameStateController.history;console.log(e.debugDump(Number.POSITIVE_INFINITY))},replay(){const e=M.app.scene.play.cursor;M.app.scene.play.setMode(new _.SpectatorMode(M.app.scene.play,j.SpectatingContext.LiveReplay)),e.move(U.Move.seekBackTag("turnStart",1),U.Move.stepBack,U.Move.seekBackTag("turnStart",2)),M.app.scene.worldMap.syncState(e.currentState),M.app.scene.worldMap.overlays.selectedRegionHighlight.clear(),M.app.scene.worldMap.overlays.conquerableHexesHighlight.clear(),V.events.trigger(n.UserActions.SetSpectatingPlayBackSpeed(W.SpectatingPlaybackSpeed.Paused))},getLocalStorageUsage(){console.log(`${(0,H.getSizeByKey)(V.storage).map((([e,t])=>`${(0,d.padRight)(e,30)} ${(0,p.describeSize)(t)}`)).join("\n")}\n---\n${(0,d.padRight)("TOTAL",30)} ${(0,p.describeSize)(V.storage.getSizeInBytes())}`)},inspectDisplayList(){let e={},t=0;for(let i of M.app.scene.worldMap.sys.displayList.list){const n=s(i);e[n]?e[n]++:e[n]=1,++t}const i=Object.entries(e).sort(((e,t)=>t[1]-e[1]));function s(e){return e instanceof Q?"RenderTexture":e instanceof J||e instanceof Z?`Image ${e.frame.name}`:e.constructor.name}console.log(i.map((([e,t])=>`- ${e}: ${t}`)).join("\n")+"\n---\nTotal: "+t)},async exportOverworld(){await M.app.scene.overworld.islands.export()},setProgress(e){const t=C.inject.mapRegistry.getAllLevelIds();C.inject.userData.current.progress.local.completedLevels={};for(let i=0;i<e;++i){const e=t[i];C.inject.userData.current.progress.local.completedLevels[e]={turns:99,difficulty:"hard"}}},progressStats(){console.log((0,p.prettyPrintObject)(C.inject.userProgressStats.all()))}},get rec(){return C.inject.history},get config(){return V.config},get ui(){return C.inject.ui},overworld:{async export(){await M.app.scene.overworld.islands.export()},async add(e){M.app.scene.overworld.islands.add(e)},listOrphanLevels(){const e=new Set;for(const t of C.inject.mapRegistry.getExpeditions())for(const i of t.objects)e.add(i.id);return C.inject.mapRegistry.getAllLevelIds().filter((t=>!e.has(t)))}},edit:{setFactionColor:(e,t)=>{const i=C.inject.gameStateModel.factions.byId(e);r.assert.defined(i,`Invalid faction id ${e}`),i.setLandColor(t=ee.ValueToColor(t).color),V.events.trigger(n.UserActions.SyncWithModel())},setOceanColor:e=>{e=ee.ValueToColor(e).color,C.inject.theme.customize({oceanColor:e}),M.app.scene.globalUI.setOceanColor(C.inject.theme.getOceanColor())},credit(e,t,i){const s=u.AI.changeFactionCredit(C.inject.currentGameState,e,t,(e=>e+i));console.log(`Credit from ${e} to ${t} now ${u.AI.getFactionCredit(s,e,t)}`)},equalizeCoins(e,t){V.events.trigger(X.MapEditorActions.ResetStartingCoins({base:e,income:t}))},resetPolitics(){C.inject.gameStateController.loadState(C.inject.currentGameState.set(o.GameState.ai.credit.key,(0,q.ImmutableMap)()).set(o.GameState.ai.attritionByRegion.key,(0,q.ImmutableMap)()),k.NewGameStateContext.LoadingGameStateForDebug)}}}},99768:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IsoTilesPainter=void 0,t.IsoTilesPainter=class{constructor(e,t){this.renderer=e,this.layers=t}paint(e){for(const t of this.layers)t.addDirtyCorners(e);const t=this.getDirtyChunks(e);for(const i of t)this.repaintChunk(e,i)}repaintChunk(e,t){t.renderTexture.clear(),t.renderTexture.beginDraw();for(const i of t.corners){const s=i.x-t.boundingBox.x,n=i.y-t.boundingBox.y;for(const o of this.layers)o.paintCorner(e,t.renderTexture,i,2*s,2*n)}t.renderTexture.endDraw()}getDirtyChunks(e){const t=new Set;for(const i of e.dirtyCorners){const e=this.renderer.getByCorner(i);for(let i of e)t.add(i)}return Array.from(t)}getDirtyCornersByChunk(e){const t=new Map;for(const i of e.dirtyCorners){const e=this.renderer.getByCorner(i);for(let s of e)t.has(s)?t.get(s).push(i):t.set(s,[i])}return t}}},99816:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.playScreenToOverworldTransition=async function(){const e=n.app.scene.overworldUI,t=n.app.scene.overworld,i=s.config.screenTransitionDuration,a=n.app.scene.worldMap,r=n.app.scene.playUI,l=n.app.scene.menuHeaderUI,c=t.islands.selectedIslands[0];t.focusIsland(c,"instant");const{preview:d}=t.getIslandPreviewById(c);return d?.setVisible(!1),e.scene.setVisible(!0),r.updateState({worldMapPanel:null}),a.cameraController.center(i,{zoom:2.1*o.DEFAULT_CAMERA_ZOOM,offsetY:-58,offsetX:12}),t.zoomController.zoomTo(o.DEFAULT_CAMERA_ZOOM/4,"instant"),t.zoomController.zoomTo(o.DEFAULT_CAMERA_ZOOM,i),n.app.scene.playUI.updateState({visible:!1}),n.app.scene.playMenuUI.transitionOut(),e.selectedLevelControls.activeUI.transitionIn(),new Promise((e=>{l.waves.transitionIn(i).then(e),t.cameras.main.setAlpha(0),t.tweens.add({targets:[t.cameras.main],props:{alpha:1},delay:i/2,duration:i/2})})).then((async()=>{d?.setVisible(!0),t.scene.setVisible(!0)}))};const s=i(56824),n=i(54825),o=i(30963)},99847:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ToolButtonsPanel=void 0;const s=i(86545),n=i(80959),o=i(64589),a=i(20087),r=i(79712);class l extends s.AutoWidthResponsiveContainer{constructor(e){super(e),this.ui=n.UiBuilder.for(this.scene),this.favoritesButton=new r.ToggleFavoriteButton(this.ui),this.linkButton=(0,o.createLevelLinkButton)(this.ui),this.statsButton=(0,o.createLevelStatsButton)(this.ui),this.add([this.favoritesButton,this.linkButton,this.statsButton])}calculateWidth(){return this.linkButton.x+this.linkButton.width}updateContent(e){this.statsButton.setVisible(e.hasStats()),this.linkButton.setVisible("custom"!==e.category),this.favoritesButton.updateContent(e.id),this.preUpdate.makeDirty()}updateLayout(){a.Arrange.leftToRight({content:[this.favoritesButton,this.statsButton,this.linkButton],spacing:10,origin:0,x:0}),this.updateSize()}}t.ToolButtonsPanel=l}},i={};function s(e){var n=i[e];if(void 0!==n)return n.exports;var o=i[e]={id:e,loaded:!1,exports:{}};return t[e].call(o.exports,o,o.exports,s),o.loaded=!0,o.exports}s.m=t,s.c=i,e=[],s.O=(t,i,n,o)=>{if(!i){var a=1/0;for(d=0;d<e.length;d++){for(var[i,n,o]=e[d],r=!0,l=0;l<i.length;l++)(!1&o||a>=o)&&Object.keys(s.O).every((e=>s.O[e](i[l])))?i.splice(l--,1):(r=!1,o<a&&(a=o));if(r){e.splice(d--,1);var c=n();void 0!==c&&(t=c)}}return t}o=o||0;for(var d=e.length;d>0&&e[d-1][2]>o;d--)e[d]=e[d-1];e[d]=[i,n,o]},s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e={792:0};s.O.j=t=>0===e[t];var t=(t,i)=>{var n,o,[a,r,l]=i,c=0;if(a.some((t=>0!==e[t]))){for(n in r)s.o(r,n)&&(s.m[n]=r[n]);if(l)var d=l(s)}for(t&&t(i);c<a.length;c++)o=a[c],s.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return s.O(d)},i=self.webpackChunkkonkr=self.webpackChunkkonkr||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})(),s.O(void 0,[96],(()=>s(s.s=71106)));var n=s.O(void 0,[96],(()=>s(s.s=76169)));n=s.O(n)})();
//# sourceMappingURL=main.72e7a6ef1c5b846e125e.bundle.js.map
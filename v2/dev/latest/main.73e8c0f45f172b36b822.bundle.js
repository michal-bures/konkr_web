!function(e){function t(t){for(var n,o,r=t[0],c=t[1],l=t[2],h=0,u=[];h<r.length;h++)o=r[h],Object.prototype.hasOwnProperty.call(s,o)&&s[o]&&u.push(s[o][0]),s[o]=0;for(n in c)Object.prototype.hasOwnProperty.call(c,n)&&(e[n]=c[n]);for(d&&d(t);u.length;)u.shift()();return a.push.apply(a,l||[]),i()}function i(){for(var e,t=0;t<a.length;t++){for(var i=a[t],n=!0,r=1;r<i.length;r++){var c=i[r];0!==s[c]&&(n=!1)}n&&(a.splice(t--,1),e=o(o.s=i[0]))}return e}var n={},s={0:0},a=[];function o(t){if(n[t])return n[t].exports;var i=n[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,o),i.l=!0,i.exports}o.m=e,o.c=n,o.d=function(e,t,i){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(i,n,function(t){return e[t]}.bind(null,n));return i},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="";var r=window.webpackJsonp=window.webpackJsonp||[],c=r.push.bind(r);r.push=t,r=r.slice();for(var l=0;l<r.length;l++)t(r[l]);var d=c;a.push([207,1]),i()}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SceneInjector=t.inject=t.setupInjectionContainer=void 0;const n=i(209),s=i(278),a=i(280),o=i(281),r=i(166),c=i(170),l=i(113),d=i(31),h=i(287),u=i(116),g=i(297),p=i(2),m=i(298),f=i(79),y=i(15),v=i(317),w=i(77),b=i(177),S=i(16),x=i(414),P=i(415),T=i(35),M=i(420),C=i(45),I=i(421),O=i(438);function _(e){const i=t.inject.ui.skipTransitions();t.inject.ui.skipTransitions.set(!0),e(),t.inject.ui.skipTransitions.set(i)}function A(){return window.devicePixelRatio&&window.devicePixelRatio>=1.5?2:1}t.setupInjectionContainer=function(e,i,S={}){if(!i)throw new Error('No configuration found for ENVIRONMENT="production", unable to setup injection container!');const B=(0,b.getAppController)(i.mode),H=new c.TypedEventBus,j=new n.GameStateController;t.inject=Object.assign({config:(0,l.deepWatchable)(i),game:e,navigator:new x.Navigator(e),scene:new E(e),screen:void 0,device:new f.DeviceInfo(e),events:H,versionManager:new m.AppVersionManager,ai:new u.AIController,audio:new d.AudioManager(e),fonts:new y.Fonts,modals:new w.ModalsManager(e),appController:B,gameStateController:j,gameStateModel:j.model,views:new P.ViewsManager,get currentGameState(){return j.model.state},set currentGameState(e){j.currentState!==e&&(p.assert.defined(e,"attempt to set current game state to undefined value"),j.model.restore(e))},history:new a.GameStateHistory,random:(0,s.createRandomGenerator)(),debugData:new o.DebugData,debugLayers:new h.WorldDebugLayersManager,debugBreakpoint:g.debugBreakPointProvider,ui:{scale:A(),withoutTransitions:_,spectatingSpeed:(0,l.watchable)(T.SpectatingPlaybackSpeed.Normal),skipTransitions:(0,l.watchable)(!1),hexUnderCursor:(0,r.watchableHexUnderCursor)(),selectedRegion:(0,l.watchable)(void 0),undoAvailable:(0,l.watchable)(!1),regionsLedger:new v.RegionsLedger,selectedCampaign:(0,l.watchable)(void 0),selectedLevelId:(0,l.watchable)(void 0),playedLevelId:(0,l.watchable)(void 0)},mapRegistry:i.mapRegistryUrl?new M.JSONMapRegistry(i.mapRegistryUrl):new O.DummyMapRegistry,userData:new C.LocalStorageUserData},S),t.inject.screen=(0,I.createScreens)()},t.inject={};class E{constructor(e){this.game=e}get worldMap(){return this.game.scene.getScene(S.Scenes.WorldMap)}get debug(){return this.game.scene.getScene(S.Scenes.Debug)}get debugHistory(){return this.game.scene.getScene(S.Scenes.DebugHistory)}get play(){return this.game.scene.getScene(S.Scenes.Play)}get playUI(){return this.game.scene.getScene(S.Scenes.PlayUI)}get titleScreenUI(){return this.game.scene.getScene(S.Scenes.TitleScreenUI)}get levelDetailUI(){return this.game.scene.getScene(S.Scenes.LevelDetailUI)}get mapEditor(){return this.game.scene.getScene(S.Scenes.MapEditor)}get menuHeaderUI(){return this.game.scene.getScene(S.Scenes.MenuHeaderUI)}get levelSelectUI(){return this.game.scene.getScene(S.Scenes.LevelSelectUI)}get gameOver(){return this.game.scene.getScene(S.Scenes.GameOver)}}t.SceneInjector=E},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.logger=t.ConsoleLogger=t.NamedLogger=t.RootLogger=t.LogLevel=void 0;const s=n(i(134));var a;!function(e){e.Error="error",e.Warning="warning",e.Info="info",e.Debug="debug",e.Trace="trace"}(a=t.LogLevel||(t.LogLevel={}));class o{constructor(){this.transportsByName=new Map,this.loggersByModule=new Map}addTransport(e,t){this.transportsByName.set(e,t)}removeTransport(e){this.transportsByName.delete(e)}for(e){const t=this.loggersByModule.get(e)||new r(e,this);return this.loggersByModule.set(e,t),t}log(e,t,i,...n){this.transportsByName.forEach(s=>s.log(e,t,i,...n))}}t.RootLogger=o;class r{constructor(e,t){this.name=e,this.parentLogger=t}trace(e,...t){this.parentLogger.log(a.Trace,this.name,e,...t)}debug(e,...t){this.parentLogger.log(a.Debug,this.name,e,...t)}error(e,...t){this.parentLogger.log(a.Error,this.name,e,...t)}info(e,...t){this.parentLogger.log(a.Info,this.name,e,...t)}warning(e,...t){this.parentLogger.log(a.Warning,this.name,e,...t)}}t.NamedLogger=r;t.ConsoleLogger=class{log(e,t,i,...n){const o=`[${t}] ${i}`;switch(e){case a.Trace:console.trace(o,...n);case a.Debug:(0,s.default)("game:"+t)(i,...n);break;case a.Error:console.error(o,...n);break;case a.Warning:console.warn(o,...n);break;case a.Info:console.info(o,...n)}}},t.logger=new o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssertionError=t.assert=void 0;const n=i(19);function s(e,t=`expected ${e} to be truthy`){if(!e)throw new a(e,t)}t.assert=s,s.defined=(e,t=`expected ${e} to be defined`)=>{if(!(0,n.isDefined)(e))throw new a(e,t)},s.undefined=(e,t=`expected ${e} to be undefined`)=>{if((0,n.isDefined)(e))throw new a(e,t)},s.naturalNumber=(e,t=`expected ${e} to be a natural number`)=>{s("number"==typeof e&&e>0&&Math.floor(e)===e,t)};class a extends Error{constructor(e,t){t||(t="failed for value %s"),super(t.replace("%s",null==e?void 0:e.toString()))}}t.AssertionError=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnType=t.FactionController=t.PhaseTypes=void 0,function(e){e.GameStart="game-start",e.FactionTurn="faction-turn",e.GameOver="game-over"}(t.PhaseTypes||(t.PhaseTypes={})),function(e){e.None="none",e.LocalUser="local-user",e.Ai="ai",e.Remote="remote"}(t.FactionController||(t.FactionController={})),function(e){e.Town="town",e.Palisade="palisade",e.StoneWall="stonewall",e.Castle="castle",e.Camp="camp",e.Forest="forest",e.Villager="villager",e.Pikeman="pikeman",e.Knight="knight",e.Hero="hero",e.Bandit="bandit",e.Coins="coins"}(t.PawnType||(t.PawnType={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getHexes=t.getHex=t.HexGrid=t.GRID_MAX_DIMENSION=void 0;const n=i(19),s=i(235),a=i(147),o=i(12);i(1).logger.for("HexGrid");t.GRID_MAX_DIMENSION=100;class r{constructor(){}static getHex(e){if(this.isWithinBounds(e,{width:t.GRID_MAX_DIMENSION,height:t.GRID_MAX_DIMENSION}))return(0,a.isOrdinal)(e)?(this._hexes[e]||(this._hexes[e]=new s.Hex(e)),this._hexes[e]):this.getHex(this.toOrdinal(e))}static getAllHexes(e){const t=Array(e.width*e.height).fill(void 0);for(let i=0;i<e.height;++i)for(let n=0;n<e.width;++n)t[i*e.width+n]=(0,a.tabularToOrdinal)({r:i,c:n});return o.HexGroup.from(t.map(e=>c(e)))}static getHexes(e){return o.HexGroup.from(e.map(e=>this.getHex(e)))}static filter(e,t){return this.getAllHexes(t).filter(e)}static getInnerHexes(e){return this.getAllHexes(e).filter(t=>!this.isHexOnGridBorder(t,e))}static isWithinBounds(e,t){if((0,a.isTabular)(e))return!(e.c>=t.width||e.c<0)&&!(e.r>=t.height||e.r<0);if((0,a.isOrdinal)(e))return this.isWithinBounds((0,a.ordinalToTabular)(e),t);if((0,a.isSpatial)(e))return this.isWithinBounds((0,a.spatialToTabular)(e),t);throw new Error(`HexGrid.isOutOfBounds called with invalid grid position (${(0,n.str)(e)})`)}static isHexOnGridBorder(e,i){return e.id<t.GRID_MAX_DIMENSION||e.id%t.GRID_MAX_DIMENSION==0||e.id%t.GRID_MAX_DIMENSION==i.width-1||Math.floor(e.id/t.GRID_MAX_DIMENSION)===i.height-1}static toOrdinal(e){if((0,a.isOrdinal)(e))return e;if((0,a.isTabular)(e))return(0,a.tabularToOrdinal)(e);if((0,a.isSpatial)(e))return(0,a.tabularToOrdinal)((0,a.spatialToTabular)(e));throw new Error(`HexGrid.toOrdinal called with invalid grid position (${(0,n.str)(e)})`)}static bfs(e,t=(()=>!0)){let i=[];e.forEach(e=>i.push({hex:e,d:0}));let n=new Set(e.members);const s=({hex:e,d:s,parent:a})=>{n.add(e);if(t(e,a,s)){e.neighbours().filter(e=>!n.has(e)).members.forEach(t=>{n.add(t),i.push({hex:t,d:s+1,parent:e})})}};for(;i.length>0;)s(i.shift())}}function c(e){return r.getHex(e)}t.HexGrid=r,r.upperBound=t.GRID_MAX_DIMENSION*t.GRID_MAX_DIMENSION-1,r._hexes=[],t.getHex=c,t.getHexes=function(e){return r.getHexes(e)}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isImmutableState=t.updateActiveDataSets=t.isProjectionDataSet=t.selectFromSuspendedState=t.selectFromState=t.getActiveProjections=t.getActiveDataSets=t.isDataSetActive=t.assertStateHasDataSet=t.getParentEngine=t.setParentEngine=t.applyMutations=t.createImmutableState=t.PARENT_ENGINE_KEY=t.ACTIVE_DATASETS_KEY=t.EMPTY_SET=void 0;const s=n(i(10)),a=i(2);function o(e){return e.get(t.PARENT_ENGINE_KEY)}function r(e,i){return e.get(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET).has(i)}function c(e){return e.get(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET)}function l(e){return!!e.bootstrap}t.EMPTY_SET=s.default.Set(),t.ACTIVE_DATASETS_KEY="_activeDataSets",t.PARENT_ENGINE_KEY="_parentEngine",t.createImmutableState=function(e,i){return s.default.fromJS({[t.ACTIVE_DATASETS_KEY]:s.default.Set(i),[t.PARENT_ENGINE_KEY]:e})},t.applyMutations=function(e,...t){const i=o(e);if(i.currentState!==e)throw new Error("Attempt to apply mutation to state that is no longer active in the parent engine");return i.apply(...t),i.currentState},t.setParentEngine=function(e,i){return e.set(t.PARENT_ENGINE_KEY,i)},t.getParentEngine=o,t.assertStateHasDataSet=function(e,t){if(!r(e,t))throw new Error(`dataSet ${t} not available in the state (available dataSets: ${c(e).map(e=>`"${e.key}"`).join(",")})`)},t.isDataSetActive=r,t.getActiveDataSets=c,t.getActiveProjections=function(e){return c(e).filter(e=>l(e))},t.selectFromState=function(e,t,i){return(0,a.assert)(r(e,t),`dataSet ${t} not available in the state`),void 0!==i?t.getEntryById(e,i):e.get(t.key)},t.selectFromSuspendedState=function(e,t,i){return t.getEntryById(e,i)},t.isProjectionDataSet=l,t.updateActiveDataSets=function(e,i){return e.update(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET,i)},t.isImmutableState=function(e){return s.default.Map.isMap(e)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SystemEvents=t.UserActions=t.Plays=t.GameEvents=void 0;const n=i(62);t.GameEvents={NewGameState:(0,n.gameStateEvent)("NEW_GAME_STATE"),FailedToLoadGame:(0,n.gameStateEvent)("FAILED_TO_LOAD_GAME"),PawnMoved:(0,n.gameStateEvent)("PAWN_MOVED"),PawnBought:(0,n.gameStateEvent)("PAWN_BOUGHT"),HexCaptured:(0,n.gameStateEvent)("HEX_CAPTURED"),BanditsActed:(0,n.gameStateEvent)("BANDITS_ACTED"),FactionEconomyUpdated:(0,n.gameStateEvent)("FACTION_ECONOMY_UPDATED"),FactionTurnStarted:(0,n.gameStateEvent)("FACTION_TURN_STARTED"),GameOver:(0,n.gameStateEvent)("GAME_OVER")},t.Plays={EndTurn:(0,n.gameplayAction)("END_TURN"),MovePawn:(0,n.gameplayAction)("REPOSITION_PAWN"),BuyPawn:(0,n.gameplayAction)("BUY_PAWN"),AttackHex:(0,n.gameplayAction)("ATTACK_HEX"),BanditsAct:(0,n.gameplayAction)("BANDITS_ACT")},t.UserActions={OpenNewGameDialog:(0,n.userAction)("OPEN_NEW_GAME_DIALOG"),EditMapJSON:(0,n.userAction)("EDIT_MAP_JSON"),OpenExportMapDialog:(0,n.userAction)("OPEN_SAVE_GAME_DIALOG"),OpenLoadGameDialog:(0,n.userAction)("OPEN_LOAD_GAME_DIALOG"),StartNewGame:(0,n.userAction)("START_NEW_GAME"),SaveGame:(0,n.userAction)("SAVE_GAME"),LoadGame:(0,n.userAction)("LOAD_GAME"),ResumeGame:(0,n.userAction)("RESUME_GAME"),RevertTurn:(0,n.userAction)("REVERT_TURN"),DeselectRegion:(0,n.userAction)("DESELECT_REGION"),SelectNextRegion:(0,n.userAction)("SELECT_NEXT_REGION"),SelectPreviousRegion:(0,n.userAction)("SELECT_PREVIOUS_REGION"),SelectNextPendingRegion:(0,n.userAction)("SELECT_NEXT_PENDING_REGION"),EndTurn:(0,n.userAction)("END_TURN"),Undo:(0,n.userAction)("UNDO"),BuyablePawnPointerDown:(0,n.userAction)("BUYABLE_PAWN_POINTER_DOWN"),BuyablePawnPointerUp:(0,n.userAction)("BUYABLE_PAWN_POINTER_UP"),ShopAreaPointerDown:(0,n.userAction)("SHOP_AREA_POINTER_DOWN"),ShopAreaPointerUp:(0,n.userAction)("SHOP_AREA_POINTER_UP"),DebugGameState:(0,n.userAction)("DEBUG_GAME_STATE"),EditMap:(0,n.userAction)("EDIT_MAP"),SyncWithModel:(0,n.userAction)("SYNC_WITH_MODEL"),SetSpectatingPlayBackSpeed:(0,n.userAction)("SET_SPECTATING_PLAYBACK_SPEED"),SkipSpectating:(0,n.userAction)("SKIP_SPECTATING"),GoToCampaigns:(0,n.userAction)("GOTO_CAMPAIGNS"),GoToLevelSelect:(0,n.userAction)("GOTO_LEVEL_SELECT"),GoToLevelDetail:(0,n.userAction)("GOTO_LEVEL_DETAIL"),GoToQuickGame:(0,n.userAction)("GOTO_QUICK_GAME"),PreviewLevel:(0,n.userAction)("FOCUS_LEVEL"),PlayLevel:(0,n.userAction)("PLAY_LEVEL"),RestartLevel:(0,n.userAction)("RESTART_LEVEL"),AbandonLevelProgress:(0,n.userAction)("ABANDON_LEVEL_PROGRESS"),GoBack:(0,n.userAction)("GO_BACK"),EndGame:(0,n.userAction)("GAME_OVER")},t.SystemEvents={EngineInitialized:(0,n.systemEvent)("ENGINE_INITIALIZED"),ScreenActivated:(0,n.systemEvent)("SCREEN_ACTIVATED")}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RegionMutations=t.Regions=void 0;const s=i(8),a=n(i(10)),o=i(14),r=i(5),c=i(242),l=i(0),d=i(2),h=i(21);class u{static model(e){return e===l.inject.currentGameState?this._model:(this._readOnlyModel.lockToState(e),this._readOnlyModel)}static getAll(e){return(0,r.selectFromState)(e,s.GameState.regions.byId).keySeq().toArray()}static getByHex(e,t){return(0,r.selectFromState)(e,s.GameState.regions.byHex,t)}static getRegionData(e,t){return(0,r.selectFromState)(e,s.GameState.regions.byId,t)}static getRegionHexes(e,t){return(0,r.selectFromState)(e,s.GameState.regions.hexes,t)||r.EMPTY_SET}static getRegionBorderHexes(e,t){return(0,r.selectFromState)(e,s.GameState.regions.borderHexes,t)||r.EMPTY_SET}static destroyRegions(e,...t){if(0===t.length)return e;const i=a.default.Set.union(t.map(t=>u.getRegionHexes(e,t))).toArray();return e=o.Factions.disownRegions(e,...t),e=(0,r.applyMutations)(e,s.GameState.regions.byHex.createMutation({delete:i},"destroyRegions"),s.GameState.regions.byId.createMutation({delete:t},"destroyRegions"),s.GameState.ai.attritionByRegion.createMutation({delete:t},"destroyRegions"))}static destroyAllEmptyRegions(e){const t=u.getAll(e).filter(t=>u.getRegionHexes(e,t).isEmpty());return this.destroyRegions(e,...t)}static getSameRegionNeighbours(e,t){const i=this.getByHex(e,t.id);return t.neighbours(t=>this.getByHex(e,t.id)===i)}static getAdjacentForeignHexes(e,t){return this.model(e).byId(t).getHostileBorderHexes().neighbours().filter(i=>{const n=this.getByHex(e,i.id);return void 0!==n&&n!==t})}static getNextId(e){return(0,r.selectFromState)(e,s.GameState.regions.nextId)}static createRegion(e,t,i){const n=u.getNextId(e),s=[g.createRegion(n,t)];return i&&s.push(g.addHexesToRegion(n,i)),(0,r.applyMutations)(e,...s)}static addHexesToRegion(e,t,i){const n=[g.addHexesToRegion(t,i)];return(0,r.applyMutations)(e,...n)}static removeHexesFromRegion(e,t){return(0,r.applyMutations)(e,s.GameState.regions.byHex.createMutation({delete:t},"removeHexesFromRegion"))}static splitRegionIntoComponents(e,t){const i=this.model(e).byId(t),n=o.Factions.getByRegion(e,t);d.assert.defined(i,"no region found for id "+t);const a=i.hexes.components(),c=a.getLargestGroupKey();if(!c)return;a.removeGroup(c);const g=new h.MapMutationBuilder(s.GameState.regions.byId).init(e),p=new h.MapMutationBuilder(s.GameState.regions.byHex).init(e),m=new h.MapMutationBuilder(s.GameState.factions.byRegion).init(e);let f=u.getNextId(e);return a.forEach(e=>{g.set(f,{id:f,name:l.inject.random.townName()}),p.setAll(e.toIdsArray(),f),void 0!==n&&m.set(f,n),f++}),(0,r.applyMutations)(e,p.createMutation("regions.splitRegionIntoComponents"),g.createMutation("regions.splitRegionIntoComponents"),m.createMutation("regions.splitRegionIntoComponents"))}}t.Regions=u,u._model=new c.RegionsDataSetModel,u._readOnlyModel=new c.RegionsDataSetModel;class g{static createRegion(e,t){return s.GameState.regions.byId.createMutation({set:{[e]:{id:e,name:t}}},"createRegion")}static addHexesToRegion(e,t){const i={};return t.forEach(t=>{i[t]=e}),s.GameState.regions.byHex.createMutation({set:i},"addHexesToRegion")}}t.RegionMutations=g},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createAIDataSets=t.createWarfareDataSets=t.createEconomyDataSets=t.createUnitsDataSets=t.createPawnDataSets=t.createFactionDataSets=t.createRegionDataSets=t.GameState=t.CORE_GAMESTATE_SCHEMA_VERSION=void 0;const n=i(228),s=i(229),a=i(3),o=i(230),r=i(73),c=i(146),l=i(21),d=i(247),h=i(248),u=i(250),g=i(153),p=i(251),m=i(252),f=i(253),y=i(254),v=i(255),w=i(154),b=i(256),S=i(257),x=i(258),P=i(259),T=i(157),M=i(260),C=i(261),I=i(150),O=i(160),_=i(263),A=i(264),E=i(265);t.CORE_GAMESTATE_SCHEMA_VERSION=7;const B=new c.SingletonDataSet("map",{levelId:"",width:10,height:10,theme:"default"}),H=new c.SingletonDataSet("ruleSet",r.ruleSets.default),j=W(),R=$(),D=V(),F=z(),L=function(){const e={data:new c.SingletonDataSet("currentPhase",{type:a.PhaseTypes.GameStart,turnNumber:1}),tappedUnits:new g.SetDataSet("currentPhase.tappedUnits")};return Object.assign(Object.assign({},e),{movableUnits:new p.MovableUnitsProjection("currentPhase.movableUnits",{currentPhase:e.data,currentPhaseTappedUnits:e.tappedUnits,unitsByFaction:F.byFaction})})}(),k=Y(),G=X(),U=K(),N=function(){const e=new h.HexesByPawnTypeAndRegionProjection("bandits.campsByRegion",a.PawnType.Camp,{pawnsByRegion:R.byRegion}),t=new A.NearestCampByHexProjection("bandits.nearestCamp",{campsByRegion:e,regionsByHex:j.byHex,regionsHexes:j.hexes});return{campsByRegion:e,nearestCamp:t}}();function W(){const e=new l.MapDataSet("regions"),t=new l.MapDataSet("regions.byHex"),i=new n.InvertedMapProjection("regions.hexes",t);return{byId:e,byHex:t,hexes:i,borderHexes:new w.RegionBorderHexesProjection("regions.borderHexes",i),nextId:new s.NextIdProjection("regions.nextId",e)}}function V(){const e={byId:new l.MapDataSet("factions"),byRegion:new l.MapDataSet("factions.byRegion")},t=new n.InvertedMapProjection("factions.regions",e.byRegion);return Object.assign(Object.assign({},e),{regions:t,nextId:new s.NextIdProjection("factions.nextId",e.byId)})}function $(){const e={byId:new l.MapDataSet("pawns"),hex:new l.MapDataSet("pawns.hex"),count:new l.MapDataSet("pawns.count")},t=new n.InvertedMapProjection("pawns.byHex",e.hex);return Object.assign(Object.assign({},e),{byHex:t,nextId:new s.NextIdProjection("pawns.nextId",e.byId),byRegion:new o.PawnsByRegionProjection("pawns.byRegion",{pawnsByHex:t,regionsByHex:j.byHex,pawnsHex:e.hex})})}function z(){return{byFaction:new u.UnitsByFactionProjection("units.byFaction",{factionRegions:D.regions,pawnsByRegion:R.byRegion,rules:H})}}function Y(){const e=new h.HexesByPawnTypeAndRegionProjection("economy.townsByRegion",a.PawnType.Town,{pawnsByRegion:R.byRegion}),t=new E.NearestTownProjection("economy.nearestTown",{townsByRegion:e,regionByHex:j.byHex,regionsHexes:j.hexes}),i=new v.CoinsByHexProjection("economy.coinsByHex",{pawnsByHex:R.byHex,pawns:R.byId,pawnsCount:R.count}),n=new f.BudgetByRegionProjection("economy.budgetByRegion",{regionHexes:j.hexes,townsByRegion:e,pawnsByRegion:R.byRegion,regions:j.byId});return{coinsByHex:i,townsByRegion:e,nearestTown:t,treasuryByRegion:new y.TreasuryByRegionProjection("economy.treasuryByRegion",{coinsByHex:i,townsByRegion:e,regionsByHex:j.byHex}),budgetByRegion:n}}function X(){const e=new m.HexDefenseSourcesProjection("warfare.hexDefenseSources",{rules:H,movableUnits:L.movableUnits,pawns:R.byId,pawnsByHex:R.byHex,regionByHex:j.byHex});return{hexDefenseSources:e,hexDefense:new O.HexDefenseProjection("warfare.hexDefense",{hexDefenseSources:e,regionByHex:j.byHex}),hexStaticDefense:new _.HexStaticDefenseProjection("warfare.hexStaticDefense",{hexDefenseSources:e,regionByHex:j.byHex})}}function K(){const e=new M.AttritionByRegionDataSet("ai.attritionByRegion"),t=new l.MapDataSet("ai.approval"),i=new b.RegionHostileBorderHexesProjection("ai.hostileBorderHexes",j.borderHexes),n=new S.HexDepthProjection("ai.hexDepth",{regionHexes:j.hexes,hostileBorderHexes:i}),s=new x.PawnsValueByHex("ai.pawnsValueByHex",{pawns:R.byId,pawnsHex:R.hex,movableUnits:L.movableUnits,rules:H}),a=new d.HexImportanceProjection("ai.hexImportance",{regionsByHex:j.byHex,regionsHexes:j.hexes,townsByRegion:k.townsByRegion,coinsByHex:k.coinsByHex,pawnsValueByHex:s}),o=new T.RegionInfluenceByHexProjection("ai.regionInfluenceByHex",{factionsByRegion:D.byRegion,regionsByHex:j.byHex,hostileBorderHexes:i,hexDefense:G.hexDefense}),r=new I.PowerByRegionProjection("ai.powerByRegion",{treasuryByRegion:k.treasuryByRegion,budgetByRegion:k.budgetByRegion,pawnsByRegion:R.byRegion});return{attritionByRegion:e,approval:t,hostileBorderHexes:i,hexDepth:n,hexPawnsCost:s,hexImportance:a,regionInfluenceByHex:o,powerByRegion:r,powerByFaction:new P.PowerByFactionProjection("ai.powerByFaction",{factionRegions:D.regions,factions:D.byId,powerByRegion:r}),regionInfluenceByRegion:new C.RegionInfluenceByRegionProjection("ai.regionInfluenceByRegion",{regionInfluenceByHex:o,regionHexes:j.hexes})}}t.GameState={version:new c.SingletonDataSet("version",t.CORE_GAMESTATE_SCHEMA_VERSION),map:B,regions:j,factions:D,pawns:R,ruleSet:H,units:F,currentPhase:L,economy:k,warfare:G,ai:U,bandits:N},t.createRegionDataSets=W,t.createFactionDataSets=V,t.createPawnDataSets=$,t.createUnitsDataSets=z,t.createEconomyDataSets=Y,t.createWarfareDataSets=X,t.createAIDataSets=K},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isDefined=t.min=t.max=t.sum=void 0;t.sum=(e,t)=>e+t;t.max=(e,t)=>e>=t?e:t;t.min=(e,t)=>e>=t?t:e,t.isDefined=function(e){return void 0!==e}},,function(e,t,i){"use strict";function n(e,t){for(var i=0,n=e.length;i<n;){var s=i+n>>>1;e[s]<t?i=s+1:n=s}return i}Object.defineProperty(t,"__esModule",{value:!0}),t.ascendingSortFn=t.getInsertionIndexInSortedArray=t.insertIntoSortedArray=t.getOrCreate=t.isObject=t.filterDictionaryInPlace=t.filterDictionary=t.mapDictionary=t.pick=t.omit=t.mergeArrays=t.dictionaryOf=t.removeFromArrayInPlace=t.pushIntoArrayByKey=t.cloneArrayWithoutItemAt=t.cloneArrayWithout=t.stripDuplicatesFrom=t.insertBetween=t.replaceArrayItem=void 0,t.replaceArrayItem=function(e,t,i){if(t<0||t>=e.length)throw new Error(`index out of bounds (array length: ${e.length}, index: ${t})`);return[...e.slice(0,t),i,...e.slice(t+1)]},t.insertBetween=function(e,t){return e.reduce((e,i,n,s)=>(e.push(i),n<s.length-1&&e.push(t),e),[])},t.stripDuplicatesFrom=function(e){return Array.from(new Set(e))},t.cloneArrayWithout=function(e,...t){return e.filter(e=>!t.includes(e))},t.cloneArrayWithoutItemAt=function(e,t){return[...e.slice(0,t),...e.slice(t+1)]},t.pushIntoArrayByKey=function(e,t,...i){void 0===e[t]&&(e[t]=[]),e[t].push(...i)},t.removeFromArrayInPlace=function(e,t){return-1===e.indexOf(t)||e.splice(e.indexOf(t),1),e},t.dictionaryOf=function(e,t){const i={};for(const n of e)i[n[t]]=n;return i},t.mergeArrays=function(...e){return[].concat(...e)},t.omit=function(e,...t){return Object.keys(e).reduce((i,n)=>(t.includes(n)||(i[n]=e[n]),i),{})},t.pick=function(e,...t){return Object.keys(e).reduce((i,n)=>(t.includes(n)&&(i[n]=e[n]),i),{})},t.mapDictionary=function(e,t){return Object.assign({},...Object.keys(e).map(i=>({[i]:t(e[i],i)})))},t.filterDictionary=function(e,t){const i={};for(const n in e)t(e[n],n)&&(i[n]=e[n]);return i},t.filterDictionaryInPlace=function(e,t){for(const i in e)t(e[i],i)||delete e[i];return e},t.isObject=function(e){return e&&"object"==typeof e&&!Array.isArray(e)},t.getOrCreate=function(e,t,i){if(void 0!==e[t])return e[t];const n=i();return e[t]=n,n},t.insertIntoSortedArray=function(e,t){const i=n(e,t);return e.splice(i,0,t),e},t.getInsertionIndexInSortedArray=n,t.ascendingSortFn=function(e,t){return e-t}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexGroup=void 0;const s=n(i(233)),a=i(11),o=n(i(57)),r=i(4);var c=Phaser.Math.MIN_SAFE_INTEGER;class l{constructor(e={},t){this.membersByIndex=e,this._membersList=t}get length(){return this.members.length}get members(){return this._membersList||(this._membersList=Object.values(this.membersByIndex),Object.freeze(this._membersList)),this._membersList}static from(e){const t={},i=e.filter(e=>void 0!==e);for(let e of i)t[e.id]=e;return new l(t,i)}static fromIds(e){return l.from(e.map(r.getHex))}static union(e){const t=(0,a.stripDuplicatesFrom)((0,a.mergeArrays)(...e.map(e=>e.members)));return l.from(t)}boundingBox(){var e;if(0===this.length)return{x:0,y:0,height:0,width:0};let t=Number.MAX_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER,n=-Number.MAX_SAFE_INTEGER,s=-Number.MAX_SAFE_INTEGER;for(let a of this.members)(null!==(e=a.display.left<t)&&void 0!==e?e:Number.MAX_SAFE_INTEGER)&&(t=a.display.left),a.display.right>n&&(n=a.display.right),a.display.top<i&&(i=a.display.top),a.display.bottom>s&&(s=a.display.bottom);return{x:t,y:i,width:n-t,height:s-i}}toIdsArray(){return this.members.map(e=>e.id)}toArray(){return[...this.members]}has(e){return!!this.membersByIndex[e.id]}contains(e){return void 0!==e&&this.containsId(e.id)}containsId(e){return!!this.membersByIndex[e]}border(e=!0){return this.filter(t=>{const i=t.neighbours();return!!(e&&i.length<6)||!!i.find(e=>!this.has(e))})}borderIncludingShoreline(){return this.border(!0)}neighbours(){return l.union(this.map(e=>e.neighbours().filter(e=>!this.has(e))))}neighboursOf(e){return e.neighbours(e=>this.has(e))}components(e=(()=>!0)){let t=new s.default,i=1;const n=(t,i)=>!i||e(t,i);return this.forEach(e=>{t.getOwnerOf(e)||(t.addToGroup(i,e),t.addToGroup(i,...this.floodFillFrom(e,n).members),++i)}),t}with(...e){return l.from([...this.members,...e])}without(e){const t=Object.assign({},this.membersByIndex);return e.forEach(e=>delete t[e.id]),new l(t)}filter(e){return l.from(this.members.filter(e))}forEach(e){return this.members.forEach(e)}map(e){return this.members.map(e)}find(e){return this.members.find(e)}sort(e){return this.members.sort(e)}bfsFrom(e,t=(()=>!0)){let i=[];e.forEach(e=>i.push({hex:e,d:0}));let n=new Set(e.members);const s=({hex:e,d:s,parent:a})=>{n.add(e);if(t(e,a,s)){e.neighbours().filter(e=>this.has(e)&&!n.has(e)).members.forEach(t=>{n.add(t),i.push({hex:t,d:s+1,parent:e})})}};for(;i.length>0;)s(i.shift())}floodFillOut(e=(()=>!0)){let t=[];this.forEach(e=>t.push({hex:e,d:0}));let i=new Set(this.members);const n=({hex:n,d:s,parent:a})=>{if(e(n,a,s)){i.add(n);n.neighbours().filter(e=>!i.has(e)).members.forEach(e=>{t.push({hex:e,d:s+1,parent:n})})}};for(;t.length>0;)n(t.shift());return l.from(Array.from(i))}customSearchFrom(e,t,i){let n=new o.default((e,t)=>t.score-e.score);e.forEach(e=>n.push({hex:e,d:0,score:i(e)}));let s=new Set(e.members);const a=({hex:e,d:a,parent:o})=>{s.add(e);if(t(e,o,a)){e.neighbours().filter(e=>this.has(e)&&!s.has(e)).members.forEach(t=>{s.add(t),n.push({hex:t,d:a+1,score:i(t),parent:e})})}};for(;n.size()>0;)a(n.pop())}findClosest(e,t){let i=void 0;return this.bfsFrom(e,e=>!i&&(!t(e)||(i=e,!1))),i}toString(){const e=this.members.slice(0,3).map(e=>e.toString()).join(",")+(this.length>3?",...":"");return`[HexGroup (${this.length}â¬¡): ${e}]`}findInnerMostHex(){let e=this,t=this;for(;t.length>0;)e=t,t=t.without(t.border());return e.findMax(e=>e.neighbours(e=>this.has(e)).length)}findMax(e){return this.members.reduce((t,i)=>{const n=e(i);return n>t.score?{score:n,hex:i}:t},{hex:void 0,score:c}).hex}floodFillFrom(e,t){const i=[...e.members];return this.bfsFrom(e,(e,n,s)=>!n||!!t(e,n,s)&&(i.push(e),!0)),l.from(i)}getCorners(){return(0,a.stripDuplicatesFrom)(this.members.map(e=>e.getCorners()).flat())}hasCorner(e){return!!e.sortedHexes.find(e=>this.has(e))}}t.HexGroup=l,l.empty=new l({})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnTraits=void 0,function(e){e.NegatesTileIncome="negates-tile-income",e.Unit="unit",e.Wall="wall",e.Impenetrable="impenetrable",e.Building="building",e.Pest="pest",e.GuardsAdjacentTiles="protects-adjacent",e.OccupiesTile="occupies-tile"}(t.PawnTraits||(t.PawnTraits={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionMutations=t.Factions=void 0;const n=i(8),s=i(7),a=i(3),o=i(5),r=i(231),c=i(2),l=i(0);class d{static model(e){return e===l.inject.currentGameState?this._model:(this._readOnlyModel.lockToState(e),this._readOnlyModel)}static getAll(e){return(0,o.selectFromState)(e,n.GameState.factions.byId).keySeq().toArray()}static getData(e,t){return(0,o.selectFromState)(e,n.GameState.factions.byId,t)}static getByRegion(e,t){return(0,o.selectFromState)(e,n.GameState.factions.byRegion,t)}static getByHex(e,t){const i=s.Regions.getByHex(e,t);if(i)return d.getByRegion(e,i)}static getNextId(e){return(0,o.selectFromState)(e,n.GameState.factions.nextId)}static getFactionRegions(e,t){var i;return(null===(i=(0,o.selectFromState)(e,n.GameState.factions.regions,t))||void 0===i?void 0:i.toArray())||[]}static setThemeIndex(e,t,i){const s=d.getData(e,t);return c.assert.defined(s),(0,o.applyMutations)(e,n.GameState.factions.byId.createMutation({set:{[t]:Object.assign(Object.assign({},s),{themeIndex:i})}},"faction.setLandColor"))}static createFaction(e,{name:t,regions:i,landColor:s,controller:r}){const c=this.getNextId(e),l={id:c,name:t,controller:null!=r?r:a.FactionController.None,themeIndex:null!=s?s:0};return(0,o.applyMutations)(e,n.GameState.factions.byId.createMutation({set:{[c]:l}},"createFaction"),h.captureRegions(c,i||[]))}static captureRegions(e,t,...i){return 0===i.length?e:(0,o.applyMutations)(e,h.captureRegions(t,i))}static addNewRegion(e,t,i,n){const a=s.Regions.getNextId(e);return(0,o.applyMutations)(e,s.RegionMutations.createRegion(a,i),s.RegionMutations.addHexesToRegion(a,n),h.captureRegions(t,[a]))}static disownRegions(e,...t){const i=t.filter(t=>void 0!==this.getByRegion(e,t));return(0,o.applyMutations)(e,n.GameState.factions.byRegion.createMutation({delete:i},"faction.disownRegions"))}static getSameFactionNeighbours(e,t,i){const n=null!=i?i:this.getByHex(e,t.id);return t.neighbours(t=>this.getByHex(e,t.id)===n)}}t.Factions=d,d._model=new r.FactionsDataSetModel,d._readOnlyModel=new r.FactionsDataSetModel;class h{static captureRegions(e,t){const i={};return t.forEach(t=>i[t]=e),n.GameState.factions.byRegion.createMutation({set:i},"faction.captureRegions")}}t.FactionMutations=h},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugTextBox=t.BitmapFont=t.UNICODE_MAP=t.GLYPH=t.Fonts=void 0;var n,s=Phaser.GameObjects.Layer,a=Phaser.GameObjects.BitmapText,o=Phaser.GameObjects.Rectangle;t.Fonts=class{load(e){e.load.bitmapFont(n.Debug,"assets/fonts/debug.png","assets/fonts/debug.xml"),e.load.bitmapFont(n.Main,"assets/fonts/main.png","assets/fonts/main.xml"),e.load.bitmapFont(n.Mini,"assets/fonts/mini.png","assets/fonts/mini.xml"),e.load.bitmapFont(n.MiniBold,"assets/fonts/mini-bold.png","assets/fonts/mini-bold.xml"),e.load.bitmapFont(n.Small,"assets/fonts/small.png","assets/fonts/small.xml")}},t.GLYPH={defense:String.fromCodePoint(57344),might:String.fromCodePoint(57345),pawn:String.fromCodePoint(57346),kingdom:String.fromCodePoint(57347),coin:String.fromCodePoint(57348),hex:String.fromCodePoint(57349),checkMark:String.fromCodePoint(57350),crossMark:String.fromCodePoint(57351),pawns:{milita:"î€ ",pikeman:"î€¡",knight:"î€¢",hero:"î€£"},whiteFlag:"î„€",redFlag:"î„",blueFlag:"î„‚",blackFlag:"î„ƒ",greenFlag:"î„„",source:"îˆ€",movable:"îˆ",error:"îˆ‚"},t.UNICODE_MAP={"â¬¡":t.GLYPH.hex,"âš":t.GLYPH.whiteFlag,"ðŸš©":t.GLYPH.redFlag,"âš‘":t.GLYPH.blackFlag,"ðŸ‘¤":t.GLYPH.pawn,"â™–":t.GLYPH.kingdom,"âœ“":t.GLYPH.checkMark,"âŒ":t.GLYPH.crossMark,"ðŸ’‚â€":t.GLYPH.pawns.milita,"â›”":t.GLYPH.error},function(e){e.Debug="Debug",e.Main="Main",e.Small="Small",e.Mini="Mini",e.MiniBold="MiniBold"}(n=t.BitmapFont||(t.BitmapFont={}));const r={origin:[0,0],backgroundOpacity:.2,padding:2,textAlign:a.ALIGN_LEFT,dropShadow:!0};t.DebugTextBox=class extends s{constructor(e,t,i,s,c){super(e),this.opts=Object.assign(Object.assign({},r),c),e.add.existing(this),this.text=new a(e,t,i,n.Debug,s,void 0,this.opts.textAlign).setOrigin(...this.opts.origin),this.background=new o(e,t,i,0,0,0,.25),this.opts.dropShadow&&this.text.setDropShadow(1,1,0,1),this.opts.backgroundOpacity>0&&this.add(this.background),this.add(this.text),this.updateBackgroundSize()}setPosition(e,t){return this.text.setPosition(e,t),this.background.setPosition(this.text.x-this.text.width*this.text.originX-this.opts.padding,this.text.y-this.text.height*this.text.originY-this.opts.padding),this}setText(e){return this.text.setText(e.replace(/./g,e=>t.UNICODE_MAP[e]||e)),this.updateBackgroundSize(),this}updateBackgroundSize(){this.background.setPosition(this.text.x-this.text.width*this.text.originX-this.opts.padding,this.text.y-this.text.height*this.text.originY-this.opts.padding),this.background.setSize(this.text.width+2*this.opts.padding,this.text.height+2*this.opts.padding)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Scenes=void 0,function(e){e.Play="Play",e.Debug="Debug",e.DebugHistory="DebugHistory",e.WorldMap="WorldMap",e.Preload="Preload",e.MapEditor="MapEditor",e.PlayUI="PlayUI",e.ModalWindow="ModalWindow",e.TitleScreenUI="TitleScreenUI",e.LevelSelectUI="LevelSelectUI",e.MenuHeaderUI="MenuHeaderUI",e.LevelDetailUI="LevelDetailUI",e.GameOver="GameOver",e.GlobalUI="GlobalUI"}(t.Scenes||(t.Scenes={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnMutations=t.Pawns=void 0;const n=i(5),s=i(8),a=i(2),o=i(237),r=i(0),c=i(4);class l{static model(e){return e===r.inject.currentGameState?this._model:(this._readOnlyModel.lockToState(e),this._readOnlyModel)}static getPawnData(e,t){return(0,n.selectFromState)(e,s.GameState.pawns.byId,t)}static getPawnType(e,t){var i;return null===(i=this.getPawnData(e,t))||void 0===i?void 0:i.type}static getPawnCount(e,t){return(0,n.selectFromState)(e,s.GameState.pawns.count,t)||0}static getByHex(e,t,i){var a,o;return void 0===i?(null===(a=(0,n.selectFromState)(e,s.GameState.pawns.byHex,t))||void 0===a?void 0:a.toArray())||[]:null===(o=(0,n.selectFromState)(e,s.GameState.pawns.byHex,t))||void 0===o?void 0:o.filter(t=>{var n;return(null===(n=l.getPawnData(e,t))||void 0===n?void 0:n.type)===i}).first()}static getPawnHex(e,t){return(0,n.selectFromState)(e,s.GameState.pawns.hex,t)}static getByRegion(e,t){var i;return(null===(i=(0,n.selectFromState)(e,s.GameState.pawns.byRegion,t))||void 0===i?void 0:i.toArray())||[]}static getNextId(e){return(0,n.selectFromState)(e,s.GameState.pawns.nextId)}static getAll(e){return(0,n.selectFromState)(e,s.GameState.pawns.byId).keySeq().toArray()}static destroy(e,...t){return 0===t.length?e:(0,n.applyMutations)(e,...d.destroyPawns(t))}static create(e,t){return(0,n.applyMutations)(e,...d.createPawn(e,t))}static setPawnCount(e,t,i){return(0,a.assert)(i>=0,`attempt to set count of pawn #${t} to negative value (${i})`),(0,n.applyMutations)(e,d.setPawnCount(t,i))}static replacePawn(e,t,i){const s=l.getPawnHex(e,t),o=l.getByHex(e,s,i),r=Object.assign(Object.assign({},l.getPawnData(e,t)),{type:i});return a.assert.undefined(o,`Cannot replace pawn ${t} with ${i}, pawn ${o} on the same hex already has this type`),(0,n.applyMutations)(e,...d.replacePawn(e,t,Object.assign(Object.assign({},r),{hex:(0,c.getHex)(s)})))}static movePawn(e,t,i){const a=this.getPawnData(e,t).type,o=l.getByHex(e,i,a);return o?(0,n.applyMutations)(e,d.setPawnCount(t,this.getPawnCount(e,o)+1),...d.destroyPawns([o])):(0,n.applyMutations)(e,s.GameState.pawns.hex.createMutation({set:{[t]:i}},"pawn.moveTo"))}}t.Pawns=l,l._model=new o.PawnsDataSetModel,l._readOnlyModel=new o.PawnsDataSetModel;class d{static setPawnCount(e,t){return(0,a.assert)(t>=0,`attempt to set count of pawn #${e} to negative value (${t})`),s.GameState.pawns.count.createMutation({set:{[e]:t}},"setPawnCount")}static destroyPawns(e){return[s.GameState.pawns.count.createMutation({delete:e},"pawns.destroy"),s.GameState.pawns.hex.createMutation({delete:e},"pawns.destroy"),s.GameState.pawns.byId.createMutation({delete:e},"pawns.destroy")]}static createPawn(e,t){const i=l.getNextId(e),n={id:i,type:t.type,name:t.name};return[s.GameState.pawns.byId.createMutation({set:{[i]:n}},"pawns.create"),s.GameState.pawns.hex.createMutation({set:{[i]:t.hex.id}},"pawns.create"),s.GameState.pawns.count.createMutation({set:{[i]:t.count||1}},"pawns.create")]}static replacePawn(e,t,i){const n=l.getNextId(e),a={id:n,type:i.type,name:i.name};return[s.GameState.pawns.byId.createMutation({set:{[n]:a},delete:[t]},"pawns.replace"),s.GameState.pawns.hex.createMutation({set:{[n]:i.hex.id},delete:[t]},"pawns.replace"),s.GameState.pawns.count.createMutation({set:{[n]:i.count||1},delete:[t]},"pawns.replace")]}}t.PawnMutations=d},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.AIMutations=t.AI=void 0;const o=i(8),r=i(5),c=a(i(10)),l=i(14),d=i(11),h=i(150),u=i(0),g=i(241);class p{static currentModel(){return this._model.unlock(),this._model}static readOnlyModel(e){return this._model.lockToState(e),this._model}static getHostileBorderHexesByRegion(e,t){return(0,r.selectFromState)(e,o.GameState.ai.hostileBorderHexes,t)||r.EMPTY_SET}static getHexDepth(e,t){return(0,r.selectFromState)(e,o.GameState.ai.hexDepth,t)}static getHexImportance(e,t){return(0,r.selectFromState)(e,o.GameState.ai.hexImportance,t)}static getRegionPower(e,t){return(0,r.selectFromState)(e,o.GameState.ai.powerByRegion,t)||h.NO_REGION_POWER}static getFactionPower(e,t){return(0,r.selectFromState)(e,o.GameState.ai.powerByFaction,t)||0}static getRegionAttrition(e,t,i){const n=(0,r.selectFromState)(e,o.GameState.ai.attritionByRegion,t)||{};return void 0===i?n:n[i]||0}static getHexInfluence(e,t,i){if(void 0===i)return(0,r.selectFromState)(e,o.GameState.ai.regionInfluenceByHex,t)||c.Map();{const n=(0,r.selectFromState)(e,o.GameState.ai.regionInfluenceByHex,t)||c.Map();return void 0===i?n:n.get(i)}}static getAggregateHexInfluence(e,t,i){return this.getHexInfluence(e,t).reduce((e,t,n)=>e+i(n,t.resistance),0)}static inflictRegionAttrition(e,t,i,n){return(0,r.applyMutations)(e,m.inflictRegionAttrition(e,t,i,n))}static changeFactionAttrition(e,t,i){const n=m.updateAllRegionAttrition(e,l.Factions.getFactionRegions(e,t),i);return(0,r.applyMutations)(e,n)}static changeFactionApproval(e,t,i,n){return(0,r.applyMutations)(e,m.changeApproval(e,t,i,n))}static getFactionApproval(e,t,i){const n=(0,r.selectFromState)(e,o.GameState.ai.approval,t);return n?void 0===i?n:n[i]||0:0}static getFactionAttrition(e,t,i){const n=u.inject.views.attritionByFaction.get(e,t);return n?void 0===i?n:n[i]||0:0}static getFactionFear(e,t,i){return u.inject.views.fear.get(e,{fromFactionId:t,towardsFactionId:i})}static getRegionInfluence(e,t,i){const n=(0,r.selectFromState)(e,o.GameState.ai.regionInfluenceByRegion,i);return n&&n.get(t)||0}static getFactionInfluenceByRegion(e,t,i,n=1/0){return u.inject.views.factionInfluenceByRegion.get(e,{influencingFaction:t,targetRegion:i,maxDistance:n})}static getFactionAttitude(e,t,i){return u.inject.views.attitude.get(e,{fromFactionId:t,towardsFactionId:i})}}t.AI=p,p._model=new g.AIModel;class m{static inflictRegionAttrition(e,t,i,n){const s={};return t.forEach(t=>{const a=(0,r.selectFromState)(e,o.GameState.ai.attritionByRegion,t)||{},c=Object.assign(Object.assign({},a),{[i]:(a[i]||0)+n});s[t]=c}),o.GameState.ai.attritionByRegion.createMutation({set:s},"inflictRegionAttrition")}static updateAllRegionAttrition(e,t,i){const n={};return t.forEach(t=>{const s=(0,r.selectFromState)(e,o.GameState.ai.attritionByRegion,t)||{},a=(0,d.mapDictionary)(s,i);n[t]=a}),o.GameState.ai.attritionByRegion.createMutation({set:n},"updateRegionAttrition")}static changeApproval(e,t,i,n){const s=(0,r.selectFromState)(e,o.GameState.ai.approval,t)||{},a=n(s[i]||0),c=Object.assign(Object.assign({},s),{[i]:a});return o.GameState.ai.approval.createMutation({set:{[t]:c}},"changeApproval")}}t.AIMutations=m},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isWholeNumber=t.dec2bin=t.numberToDots=t.prettyPrintObject=t.OBJECT_TO_STRING_WHITELIST=t.withSign=t.sleep=t.deepFreeze=t.isDefined=t.decompressStr=t.compressStr=t.shallowStr=t.replaceClassObjects=t.str=void 0;const s=n(i(213)),a=n(i(135)),o=i(11);function r(e){return"object"!=typeof e||null==e?e:Array.isArray(e)?e.map(r):"Object"!==e.constructor.name?`[${e.constructor.name}]`:(0,o.mapDictionary)(e,e=>r(e))}t.str=function(e,t){e=r(e);const i=(0,s.default)(e);return t&&i.length>t?i.slice(0,t)+"(...)":i},t.replaceClassObjects=r,t.shallowStr=function(e){return(0,s.default)(e,(e,t)=>e&&t&&"number"!=typeof t?Array.isArray(t)?"[object Array]":""+t:t)},t.compressStr=function(e){return a.default.compress(e,{outputEncoding:"StorageBinaryString"})},t.decompressStr=function(e){return a.default.decompress(e,{inputEncoding:"StorageBinaryString"})},t.isDefined=function(e){return null!=e},t.deepFreeze=function e(t){const i=Object.getOwnPropertyNames(t);for(const n of i){const i=t[n];i&&"object"==typeof i&&e(i)}return Object.freeze(t)},t.sleep=function(e){return new Promise(t=>setTimeout(t,e))},t.withSign=function(e){return e>=0?"+"+e:e.toString()},t.OBJECT_TO_STRING_WHITELIST=new Set(["UnitsByMight"]),t.prettyPrintObject=function e(i,n=0){const s=Array(n+1).join(" ");return Object.entries(i).map(([i,a])=>null==a?`${s}${i}: âŠ˜`:Array.isArray(a)?`${s}${i}: ${a.join(",")}`:"object"==typeof a&&null!==a?t.OBJECT_TO_STRING_WHITELIST.has(a.constructor.name)?`${s}${i}: ${a.toString()}`:`${s}${i}:\n${e(a,n+2)}`:`${s}${i}: ${a}`).join("\n")};t.numberToDots=function(e){return e>8?"â£¿":" â â ƒâ ‡â â Ÿâ ¿â¡¿â£¿"[e]},t.dec2bin=function(e){return(e>>>0).toString(2)},t.isWholeNumber=function(e){return Math.floor(e)===e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Colors=void 0,t.Colors={woodenUi:{primaryText:5781794,redText:8388608},glassUi:{primaryText:3355442,backgroundText:5460817,shape:12969202,shapeDarkAccent:11590124,shapeShadow:9027030,shapeLightAccent:14412786},highlight:{ownedRegion:16577024,hostileRegion:16721920},ocean:10213106,oceanLight:11591925}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MapMutationBuilder=t.MapDataSet=void 0;const s=n(i(10)),a=i(23),o=i(5),r=i(2);t.MapDataSet=class{constructor(e){this.key=e,this.defaultValue=s.default.Map()}deserialize(e){let t=s.default.Map();return Object.entries(e).forEach(([e,i])=>{t=t.set(Number(e),i)}),t}serialize(e){return e.toJS()}apply(e,t){return e.withMutations(e=>{var i;null===(i=t.updated)||void 0===i||i.forEach(([t,i])=>{void 0===i?e.deleteIn([this.key,t]):e.setIn([this.key,t],i)})})}createMutation(e,t){let i={};if(e.set&&!(0,a.isEmpty)(e.set)&&(i.updated=Object.entries(e.set).map(([e,t])=>[Number(e),t])),e.delete&&!(0,a.isEmpty)(e.delete)){const t=e.delete.map(e=>[e,void 0]);i.updated?i.updated.push(...t):i.updated=t}return{dataSet:this,changes:i,context:`${this.key}/${t}`}}getEntryById(e,t){return e.getIn([this.key,t])}entryToString(e){return e.toString()}entryToDebugString(e){return JSON.stringify(e)}getEntryIds(e){var t;return(null===(t=e.get(this.key))||void 0===t?void 0:t.keySeq().toArray())||[]}toString(){return`[MapDataSet "${this.key}"]`}};t.MapMutationBuilder=class{constructor(e){this.dataSet=e}init(e){return this.state=e,this._entriesToSet={},this._entriesToDelete=new Set,this}set(e,t){return r.assert.defined(this.state,"builder not initialized!"),this._entriesToDelete.delete(e),this._entriesToSet[e]=t,this}setFromBootstrap(){r.assert.defined(this.state,"builder not initialized!"),(0,r.assert)((0,o.isProjectionDataSet)(this.dataSet),`Cannot call setFromBootstrap on ${this.dataSet} - it's not a projection`),this._entriesToSet=this.dataSet.bootstrap(this.state).toObject()}delete(e){r.assert.defined(this.state,"builder not initialized!"),delete this._entriesToSet[e],this._entriesToDelete.add(e)}getCurrent(e){if(r.assert.defined(this.state,"builder not initialized!"),!this._entriesToDelete.has(e))return this._entriesToSet.hasOwnProperty(e)?this._entriesToSet[e]:this.state.getIn([this.dataSet.key,e])}has(e){return!!this.get(e)}get(e){if(r.assert.defined(this.state,"builder not initialized!"),!this._entriesToDelete.has(e))return this._entriesToSet[e]}getEntries(){return r.assert.defined(this.state,"builder not initialized!"),this._entriesToSet}clear(){throw new Error("Not Implemented")}createMutation(e){return r.assert.defined(this.state,"builder not initialized!"),this.dataSet.createMutation({set:this._entriesToSet,delete:Array.from(this._entriesToDelete).filter(e=>void 0!==this.state.getIn([this.dataSet.key,e]))},e)}setAll(e,t){e.forEach(e=>this.set(e,t))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveContainer=t.BaseResponsiveContainer=void 0;const n=i(32),s=i(175);var a=Phaser.GameObjects.Container,o=Phaser.Geom.Rectangle;class r extends a{constructor(e){super(e),this.updateList=[],this.autoInteractive=!1,this.preUpdate=(0,n.whenDirty)(()=>{var e;this.updateLayout(),this.autoInteractive&&(null===(e=this.input)||void 0===e?void 0:e.hitArea)&&(this.input.hitArea=new o(this.width/2,this.height/2,this.width,this.height))},()=>{for(let e of this.updateList)e.preUpdate()}),s.ResponsiveSizeComponent.overrideSizeComponent(this)}add(e){super.add(e);let t=Array.isArray(e)?e:[e];for(let e of t)(0,n.isResponsive)(e)&&this.updateList.push(e);return this}setSizeToFrame(e){throw new Error("not implemented")}setInteractiveAuto(){this.autoInteractive=!0,this.setInteractive({cursor:"pointer",hitArea:new o(this.width/2,this.height/2,this.width,this.height),hitAreaCallback:o.Contains})}}t.BaseResponsiveContainer=r;t.ResponsiveContainer=class extends r{updateLayout(){}}},,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Warfare=t.InvalidDropPawnReason=t.DropPawnResultType=void 0;const n=i(13),s=i(3),a=i(8),o=i(9),r=i(5),c=i(52),l=i(7),d=i(17),h=i(11),u=i(0),g=i(246),p=i(4);!function(e){e.Invalid="invalid",e.Reposition="reposition",e.Conquest="conquest",e.Combine="combine",e.EradicatePest="eradicate-pest"}(t.DropPawnResultType||(t.DropPawnResultType={})),function(e){e.PreventedByPawn="prevented-by-pawn",e.OutOfRange="out-of-range",e.InvalidRegion="invalid-region"}(t.InvalidDropPawnReason||(t.InvalidDropPawnReason={}));class m{static model(e){return e===u.inject.currentGameState?this._model:(this._readOnlyModel.lockToState(e),this._readOnlyModel)}static getConquerableHexes(e,t,i){const n="number"==typeof i?i:c.Rules.model(e).pawns(i).might,a=d.Pawns.getByRegion(e,t).filter(t=>d.Pawns.getPawnType(e,t)===s.PawnType.Bandit).map(t=>(0,p.getHex)(d.Pawns.getPawnHex(e,t)));return l.Regions.getAdjacentForeignHexes(e,t).filter(t=>this.getHexDefense(e,t)<n).with(...a)}static getHexDefense(e,t){return(0,r.selectFromState)(e,a.GameState.warfare.hexDefense,t.id)||0}static getHexStaticDefense(e,t){return(0,r.selectFromState)(e,a.GameState.warfare.hexStaticDefense,t.id)||0}static getHexDefenseAsIfOwnedBy(e,t,i){const n=this.getHexLocalDefense(e,t.id);return t.neighbours(t=>l.Regions.getByHex(e,t.id)===i).map(t=>this.getHexProjectedDefense(e,t.id)).reduce(o.max,n)}static getHexLocalDefense(e,t){var i;return(null===(i=(0,r.selectFromState)(e,a.GameState.warfare.hexDefenseSources,t))||void 0===i?void 0:i.totalDefense)||0}static getHexLocalStaticDefense(e,t){var i;return(null===(i=(0,r.selectFromState)(e,a.GameState.warfare.hexDefenseSources,t))||void 0===i?void 0:i.buildingDefense)||0}static getHexProjectedDefense(e,t){var i;return(null===(i=(0,r.selectFromState)(e,a.GameState.warfare.hexDefenseSources,t))||void 0===i?void 0:i.totalProtection)||0}static getHexProjectedStaticDefense(e,t){const i=(0,r.selectFromState)(e,a.GameState.warfare.hexDefenseSources,t);return i?i.buildingProtection:0}static getHexDefenders(e,t,i=1){const s=d.Pawns.model(e),a=l.Regions.getSameRegionNeighbours(e,t);return[...s.byHex(t),...s.select({hexes:a,traits:[n.PawnTraits.GuardsAdjacentTiles]})].filter(e=>e.defense>=i)}static canConquerHexWith(e,t,i){const n=c.Rules.model(e).pawns(i).might;return void 0!==l.Regions.getByHex(e,t.id)&&this.getHexDefense(e,t)<n}static getOccupyingUnit(e,t){return d.Pawns.model(e).findOne({hexes:t,traits:[n.PawnTraits.OccupiesTile]})}static getUnitsByRegion(e,...t){return(0,h.mergeArrays)(...t.map(t=>d.Pawns.getByRegion(e,t).filter(t=>m.isUnit(e,t))||[]))}static isUnit(e,t){var i;return null===(i=d.Pawns.model(e).byId(t))||void 0===i?void 0:i.hasTrait(n.PawnTraits.Unit)}}t.Warfare=m,m._model=new g.WarfareModel,m._readOnlyModel=new g.WarfareModel},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurrentPhase=void 0;const n=i(8),s=i(5),a=i(240),o=i(0);class r{static model(e){return e===o.inject.currentGameState?this._model:(this._readOnlyModel.lockToState(e),this._readOnlyModel)}static getFaction(e){var t;return null===(t=(0,s.selectFromState)(e,n.GameState.currentPhase.data))||void 0===t?void 0:t.faction}static getType(e){var t;return null===(t=(0,s.selectFromState)(e,n.GameState.currentPhase.data))||void 0===t?void 0:t.type}static getTurnNumber(e){var t;return null===(t=(0,s.selectFromState)(e,n.GameState.currentPhase.data))||void 0===t?void 0:t.turnNumber}static isMovable(e,t){return(0,s.selectFromState)(e,n.GameState.currentPhase.movableUnits).has(t)}static getMovableUnits(e){return(0,s.selectFromState)(e,n.GameState.currentPhase.movableUnits).toArray()}static isTapped(e,t){return(0,s.selectFromState)(e,n.GameState.currentPhase.tappedUnits).has(t)}static tapPawn(e,t){return(0,s.applyMutations)(e,n.GameState.currentPhase.tappedUnits.createMutation({add:[t]},"currentPhase.tapPawn"))}static unTapPawn(e,t){return(0,s.applyMutations)(e,n.GameState.currentPhase.tappedUnits.createMutation({delete:[t]},"currentPhase.unTapPawn"))}static set(e,t){const i=(0,s.selectFromState)(e,n.GameState.currentPhase.data);return(0,s.applyMutations)(e,n.GameState.currentPhase.data.createMutation(Object.assign(Object.assign({},i),t),"currentPhase.set"),n.GameState.currentPhase.tappedUnits.createMutation({clear:!0},"currentPhase.set"))}}t.CurrentPhase=r,r._model=new a.CurrentPhaseModel,r._readOnlyModel=new a.CurrentPhaseModel},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseUpdater=void 0;i(1).logger.for("BaseUpdater");t.BaseUpdater=class{constructor(e){this.dataSet=e,this.handlers=[],this.initFromState=e=>{this.newState=e,this.oldState=void 0,this.builder.init(e),this.initialize()},this.update=(e,t,i)=>(this.newState=e,this.changeSet=t,this.oldState=i,this.builder.init(e),this.initialize(),this.handlers.forEach(({dataSet:e,handler:t})=>{const i=this.changeSet.of(e);i&&t(i)}),this.createMutation()),this.registerHandlers((e,t)=>this.handlers.push({dataSet:e,handler:t.bind(this)}))}createMutation(){return this.builder.createMutation("parents changed")}initialize(){}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.signal=void 0,t.signal=function(){const e=[],t=function(t){return e.push(t),{unsubscribe(){i(t)}}};return t.fire=t=>e.map(e=>e(t)),t.unsubscribe=i,t.unsubscribeAll=()=>e.length=0,t;function i(t){const i=e.indexOf(t);-1!==i&&e.splice(i,1)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getTileFrameKey=t.createTileSprite=t.createCornerImage=t.Box=t.BoxTexture=void 0;var n=Phaser.GameObjects.Image,s=Phaser.Geom.Rectangle;const a=i(22);!function(e){e.Plate="ui/box/plate",e.RoundedPlate="ui/box/rounded-plate",e.InnerPlate="ui/box/inner-plate",e.WindowFrame="ui/box/window",e.Tooltip="ui/box/tooltip",e.DialogButton="ui/box/dialog-button",e.DialogButtonDown="ui/box/dialog-button-down"}(t.BoxTexture||(t.BoxTexture={}));class o extends a.BaseResponsiveContainer{constructor(e,t,i=0,n=0,s=0,a=0){super(e),this.setPosition(i,n),this.setSize(s,a),this.topLeftCorner=r(e,t,0),this.topEdge=c(e,t,1),this.topRightCorner=r(e,t,2),this.leftEdge=c(e,t,3),this.middle=c(e,t,4),this.rightEdge=c(e,t,5),this.bottomLeftCorner=r(e,t,6),this.bottomEdge=c(e,t,7),this.bottomRightCorner=r(e,t,8),this.add(this.getSprites())}setInteractive(){return super.setInteractive({cursor:"pointer",hitArea:new s(this.width/2,this.height/2,this.width,this.height),hitAreaCallback:s.Contains}),this}updateHitArea(){var e;(null===(e=this.input)||void 0===e?void 0:e.hitArea)&&(this.input.hitArea=new s(this.width/2,this.height/2,this.width,this.height))}updateLayout(){const e=this.height-this.topLeftCorner.height-this.bottomLeftCorner.height,t=this.width-this.topLeftCorner.width-this.topRightCorner.width;this.topRightCorner.setPosition(this.width-this.topRightCorner.width,0),this.bottomLeftCorner.setPosition(0,this.height-this.bottomLeftCorner.height),this.bottomRightCorner.setPosition(this.width-this.bottomRightCorner.width,this.height-this.bottomRightCorner.height),this.topEdge.setPosition(this.topLeftCorner.width,0),this.topEdge.setDisplaySize(t,this.topRightCorner.height),this.bottomEdge.setPosition(this.bottomLeftCorner.width,this.height-this.bottomLeftCorner.height),this.bottomEdge.setDisplaySize(t,this.bottomLeftCorner.height),this.leftEdge.setPosition(0,this.topRightCorner.height),this.leftEdge.setDisplaySize(this.topRightCorner.width,e),this.rightEdge.setPosition(this.width-this.topRightCorner.width,this.topLeftCorner.height),this.rightEdge.setDisplaySize(this.topRightCorner.width,e),this.middle.setPosition(this.topRightCorner.width-1,this.topRightCorner.height-1),this.middle.setDisplaySize(t+2,e+2),this.updateHitArea()}setTint(e){this.getSprites().forEach(t=>t.setTint(e))}setTexture(e){this.getSprites().forEach((t,i)=>t.setFrame(l(e,i)))}getSprites(){return[this.topLeftCorner,this.topEdge,this.topRightCorner,this.leftEdge,this.middle,this.rightEdge,this.bottomLeftCorner,this.bottomEdge,this.bottomRightCorner]}}function r(e,t,i){return new n(e,0,0,"atlas",l(t,i))}function c(e,t,i){const s=new n(e,0,0,"atlas",l(t,i));return s.setOrigin(0,0),s}function l(e,t){return`${e}/tile-${t}`}t.Box=o,t.createCornerImage=r,t.createTileSprite=c,t.getTileFrameKey=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBlankGameState=t.SpecialFaction=void 0;const n=i(8),s=i(3),a=i(73),o=i(0);var r;!function(e){e[e.neutral=0]="neutral"}(r=t.SpecialFaction||(t.SpecialFaction={})),t.getBlankGameState=function(e={mapWidth:0,mapHeight:0,theme:"default"}){return{version:n.CORE_GAMESTATE_SCHEMA_VERSION,map:{width:e.mapWidth,height:e.mapHeight,theme:e.theme,levelId:o.inject.random.id()},regions:[],factions:[{id:r.neutral,name:"nature",themeIndex:0,controller:s.FactionController.None,regions:[]}],pawns:[],currentPhase:{type:s.PhaseTypes.GameStart,turnNumber:1},ruleSet:a.ruleSets.default}}},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Economy=t.EMPTY_BUDGET=void 0;const o=i(8),r=i(5),c=i(13),l=i(60),d=i(12),h=i(52),u=i(17),g=i(7),p=i(1),m=i(244),f=i(0),y=a(i(10)),v=p.logger.for("Economy");t.EMPTY_BUDGET={balance:0,upkeep:0,incomeFromHexes:0};class w{static model(e){return e===f.inject.currentGameState?this._model:(this._readOnlyModel.lockToState(e),this._readOnlyModel)}static getTownHexesByRegion(e,t){return(0,r.selectFromState)(e,o.GameState.economy.townsByRegion,t)||y.Set()}static getBaseIncomePerHex(e){return h.Rules.getEconomyRules(e).baseIncomePerTile}static getIncomeFromHex(e,t){return u.Pawns.model(e).byHex(t).find(e=>e.hasTrait(c.PawnTraits.NegatesTileIncome))?0:this.getBaseIncomePerHex(e)}static getTreasuryOf(e,t){return(0,r.selectFromState)(e,o.GameState.economy.treasuryByRegion,t)||0}static getNumberOfCoinsAt(e,t){return(0,r.selectFromState)(e,o.GameState.economy.coinsByHex,t)||0}static payForNewPawn(e,t,i){var n;return this.payToHex(e,t,(null===(n=h.Rules.getPawnRules(e,i))||void 0===n?void 0:n.cost)||0)}static payToHex(e,t,i,n=new l.CoinTransactionBuilder){const s=g.Regions.model(e).byHex(t);let a=i;n.from(t).consume(i);let o=new Set;for(;a>0;){const r=s.hexes.findClosest(t,t=>!o.has(t)&&w.getNumberOfCoinsAt(e,t.id)>0);if(!r)throw new Error(`Unable to find enough gold to pay ${i}g to hex ${t} in region ${s}`);const c=w.getNumberOfCoinsAt(e,r.id),l=Math.min(c,a);a-=l,o.add(r),n.from(r).send(t,l)}return n}static loot(e,t,i,n=new l.CoinTransactionBuilder){const s=new l.CoinTransactionBuilder,a=w.getTownHexesByRegion(e,i.id),o=d.HexGroup.from([...i.hexes.members,t]).findClosest(t,e=>e!==t&&a.includes(e.id));return o?s.from(t).send(o,this.getNumberOfCoinsAt(e,t.id)):(v.warning(`did not find any town in ${i} that could receive loot from ${t}, the money will just disappear`),s.from(t).consume(this.getNumberOfCoinsAt(e,t.id))),s}static getRegionBudget(e,i){return(0,r.selectFromState)(e,o.GameState.economy.budgetByRegion,i)||t.EMPTY_BUDGET}}t.Economy=w,w._model=new m.EconomyModel,w._readOnlyModel=new m.EconomyModel},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AudioManager=t.SoundEffects=void 0;const n=i(1);var s;!function(e){e.Grab="grab",e.Drop="drop",e.Deny="deny",e.ButtonDown="button-down",e.ButtonUp="button-up",e.ShutterClick="shutter-click"}(s=t.SoundEffects||(t.SoundEffects={}));n.logger.for("audio");t.AudioManager=class{constructor(e){this.game=e}load(e){for(let t of Object.values(s))e.load.audio(t,`assets/audio/${t}.wav`)}playEffect(e){this.game.sound.play(e)}get mute(){return this.game.sound.mute}set mute(e){this.game.sound.mute=e}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isResponsive=t.whenDirty=void 0,t.whenDirty=function(e,t){let i=!0;const n=()=>{i&&(i=!1,e()),t&&t()};return n.makeDirty=()=>{i=!0},n},t.isResponsive=function(e){var t;return null===(t=e.preUpdate)||void 0===t?void 0:t.makeDirty}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Label=void 0;var n=Phaser.GameObjects.BitmapText;const s=i(15),a=i(119);class o extends a.GameObjectUiElement{constructor(e,t,i={}){var a;super(e),this.props=i,this.bitmapText=new n(this.scene,0,0,s.BitmapFont.Main,t).setTint(null!==(a=i.color)&&void 0!==a?a:5583648).setOrigin(0,0),i.shadow&&this.bitmapText.setDropShadow(2,2,0,1)}getGameObject(){return this.bitmapText}setText(e){this.bitmapText.text!==e&&(this.bitmapText.setText(e),this.onResize.fire({width:this.width,height:this.height}))}setTint(e){this.bitmapText.setTint(e)}}t.Label=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldLayers=void 0,function(e){e[e.Landmass=0]="Landmass",e[e.Tiles=1e4]="Tiles",e[e.TileHighlight=2e4]="TileHighlight",e[e.TileBorders=3e4]="TileBorders",e[e.TileDecals=4e4]="TileDecals",e[e.TileObjects=5e4]="TileObjects",e[e.FlyingObject=6e4]="FlyingObject",e[e.UIOverlay=7e4]="UIOverlay",e[e.DebugOverlay=8e4]="DebugOverlay"}(t.WorldLayers||(t.WorldLayers={}))},function(e,t,i){"use strict";var n,s,a;Object.defineProperty(t,"__esModule",{value:!0}),t.PlayUILayers=t.ShoppingTrayStyle=t.MainPanelMode=t.DEFAULT_PLAY_UI_STATE=t.SpectatingState=t.SpectatingPlaybackSpeed=t.PrimaryButton=t.PlayUIMode=void 0,function(e){e.Standby="standby",e.OwnedRegionSelected="owned-region-selected",e.HostileRegionSelected="hostile-region-selected",e.Spectating="spectating",e.Hidden="hidden"}(n=t.PlayUIMode||(t.PlayUIMode={})),function(e){e.None="none",e.EndTurn="end-turn",e.NextRegion="next-region"}(t.PrimaryButton||(t.PrimaryButton={})),function(e){e.Paused="paused",e.Normal="normal",e.Fast="fast",e.UltraFast="ultra-fast"}(s=t.SpectatingPlaybackSpeed||(t.SpectatingPlaybackSpeed={})),function(e){e.EnemyTurn="Enemy turn...",e.BanditsAct="Bandits activity...",e.GatherIncome="Collecting income..."}(a=t.SpectatingState||(t.SpectatingState={})),t.DEFAULT_PLAY_UI_STATE={mode:n.Hidden,activeFactionColor:0,enableNextRegion:!1,enableUndo:!1,enableViewReplay:!1,enableSkipSpectating:!1,hasPendingRegions:!1,highlightEndTurn:!1,heldPawnData:null,regionData:null,powerBalance:[],spectatingSpeed:s.Normal,spectatingState:a.EnemyTurn},function(e){e.Hidden="hidden",e.RegionInfo="region-info",e.SpectatorControls="spectator-controls",e.Overview="overview"}(t.MainPanelMode||(t.MainPanelMode={})),function(e){e.Simple="simple",e.Elaborate="elaborate"}(t.ShoppingTrayStyle||(t.ShoppingTrayStyle={})),function(e){e[e.BackroundButtons=0]="BackroundButtons",e[e.ShoppingTray=1]="ShoppingTray",e[e.ShoppingTrayCloth=2]="ShoppingTrayCloth",e[e.SpectatingPanel=3]="SpectatingPanel",e[e.MainPanel=4]="MainPanel",e[e.Pawns=5]="Pawns",e[e.Label=6]="Label",e[e.Buttons=7]="Buttons"}(t.PlayUILayers||(t.PlayUILayers={}))},,function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.readOnlyModelOf=t.describePhase=t.describeState=t.checkForInvalidReferences=t.GameStateModel=t.StaticGameStateModel=t.ProjectionPresets=void 0;const o=a(i(23)),r=i(1),c=i(27),l=i(8),d=i(0),h=i(266),u=i(269),g=i(24),p=i(75),m=i(11),f=i(52),y=i(7),v=i(5),w=i(271),b=i(17),S=i(14),x=i(30),P=i(25),T=i(85),M=i(15),C=i(18);r.logger.for("GameStateModel");let I=!1;t.ProjectionPresets={coreEntities:[...Object.values(l.GameState.regions),...Object.values(l.GameState.factions),...Object.values(l.GameState.pawns)],coreEntitiesAndSystems:[...Object.values(l.GameState.regions),...Object.values(l.GameState.factions),...Object.values(l.GameState.pawns),...Object.values(l.GameState.units),...Object.values(l.GameState.currentPhase)]};class O{constructor(e){this.state=e}get map(){return T.WorldMap.model(this.state)}get rules(){return f.Rules.model(this.state)}get regions(){return y.Regions.model(this.state)}get factions(){return S.Factions.model(this.state)}get pawns(){return b.Pawns.model(this.state)}get currentPhase(){return P.CurrentPhase.model(this.state)}get warfare(){return g.Warfare.model(this.state)}get economy(){return x.Economy.model(this.state)}get ai(){return C.AI.readOnlyModel(this.state)}}t.StaticGameStateModel=O;function _(e){}function A(e){return""+e.type&&e.faction?"/"+e.faction:""}t.GameStateModel=class{constructor(e){this.onNewState=(0,c.signal)(),this.stateEngine=new u.StateEngine,this.loadDataSets(),e&&((0,v.isImmutableState)(e)?this.stateEngine.setState((0,v.setParentEngine)(e,this.stateEngine)):this.stateEngine.deserialize((0,p.decompressGameState)(e)))}get map(){return T.WorldMap.model(this.state)}get rules(){return f.Rules.model(this.state)}get regions(){return y.Regions.model(this.state)}get factions(){return S.Factions.model(this.state)}get pawns(){return b.Pawns.model(this.state)}get currentPhase(){return P.CurrentPhase.model(this.state)}get warfare(){return g.Warfare.model(this.state)}get economy(){return x.Economy.model(this.state)}get ai(){return C.AI.currentModel()}get state(){return this.stateEngine.currentState}suspendAllProjections(){this.stateEngine.suspendAllProjections()}useProjections(e){return this.stateEngine.activateOnly(...e),this}activateAllProjections(){return this.stateEngine.activateAllProjections(),this}loadDataSets(){this.stateEngine.add(l.GameState.version,l.GameState.map,l.GameState.ruleSet,...Object.values(l.GameState.regions),...Object.values(l.GameState.factions),...Object.values(l.GameState.pawns),...Object.values(l.GameState.units),...Object.values(l.GameState.currentPhase),...Object.values(l.GameState.warfare),...Object.values(l.GameState.economy),...Object.values(l.GameState.ai),...Object.values(l.GameState.bandits)),this.stateEngine.watchAll((e,t)=>this.stateUpdated(t))}restore(e){return(0,v.isImmutableState)(e)?this.stateEngine.setState(e):this.stateEngine.deserialize((0,p.decompressGameState)(e)),d.inject.config.debug.recordStateChanges&&!I&&d.inject.history.add("restored state"),this}stateUpdated(e){var t;I||((null===(t=d.inject.config.debug.integrityChecks)||void 0===t?void 0:t.gameState)&&this.protectStateIntegrity(),d.inject.config.debug.recordStateChanges&&d.inject.history.add(function(e){return e&&0!==e.length?e[0].context:"state updated (no mutation)"}(e)),this.onNewState.fire(this.stateEngine.currentState))}protectStateIntegrity(){I=!0;const e=this.state,t=(0,w.getCanonicalStateSnapshot)(this.state);this.stateEngine.deserialize(this.stateEngine.serialize());const i=(0,w.getCanonicalStateSnapshot)(this.state);if(!o.isEqual(t,i)){const n=(0,h.diff)(t,i),s=Object.keys(n);console.warn(`GameState integrity violation! There's a difference in state after serialization and deserialization!\nDIFFERENCE IN ${s.join(",")}:\n${JSON.stringify(n,null,2)}\nBEFORE:\n${JSON.stringify((0,m.filterDictionary)(t,(e,t)=>s.includes(t)),null,2)}\nAFTER:\n${JSON.stringify((0,m.filterDictionary)(i,(e,t)=>s.includes(t)),null,2)}\n`),d.inject.history.add(`${M.GLYPH.redFlag} INCONSISTENT STATE (error in ${s.join(",")})`,e)}this.stateEngine.currentState,I=!1}exportState(){return(0,p.compressGameState)(this.stateEngine)}withTemporaryBranch(e){const t=this.state;e(),this.restore(t)}},t.checkForInvalidReferences=_,t.describeState=function(e){return`[GameState (${e.map.width}x${e.map.height}â¬¡, ${e.factions.length}ðŸ‘¤, ${e.regions.length}â™–,${A(e.currentPhase)})]`},t.describePhase=A,t.readOnlyModelOf=function(e){return new O(e)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Control=t.TransitionController=void 0;const n=i(0),s=i(364);class a{constructor(e,t){var i,n;this.scene=e,this.currentValue=0,this.currentValue=t.initialValue||0,this.defaultTweenOptions={duration:null!==(i=t.duration)&&void 0!==i?i:500,ease:null!==(n=t.ease)&&void 0!==n?n:"Sine.easeOut"},this.applyValue=t.applyValue}setTo(e){return this.tween&&(this.tween.stop(),this.tween=void 0),this.currentValue=e,this.applyValue(e),this}transitionTo(e,t){if(n.inject.ui.skipTransitions())return void this.setTo(e);this.tween&&this.tween.stop();const i=t?Object.assign(Object.assign({},this.defaultTweenOptions),t):this.defaultTweenOptions;this.tween=this.scene.tweens.addCounter({from:this.currentValue,to:e,duration:i.duration,ease:i.ease,onComplete:()=>{this.setTo(e)}}),this.tween.on("update",()=>this.onTweenUpdated())}onTweenUpdated(){this.currentValue=this.tween.getValue(),this.applyValue(this.currentValue)}}t.TransitionController=a,t.Control={visibilityOf:(e,t)=>new a(e.scene,Object.assign(Object.assign({},t),{initialValue:e.alpha,applyValue:t=>e.setAlpha(t)})),propOf:(e,t,i)=>new s.PropTransitionController(e.scene,e,t,Object.assign({},i))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HEX_POLYGON=t.HEX_COLLAR_HEIGHT=t.HEX_ANGLED_HEIGHT=t.HEX_INNER_HEIGHT=t.HALF_HEX_HEIGHT=t.HEX_HEIGHT=t.HALF_HEX_WIDTH=t.HEX_WIDTH=void 0,t.HEX_WIDTH=48,t.HALF_HEX_WIDTH=t.HEX_WIDTH/2,t.HEX_HEIGHT=48,t.HALF_HEX_HEIGHT=t.HEX_HEIGHT/2,t.HEX_INNER_HEIGHT=36,t.HEX_ANGLED_HEIGHT=t.HEX_HEIGHT-t.HEX_INNER_HEIGHT,t.HEX_COLLAR_HEIGHT=30;t.HEX_POLYGON=[[-.5,-.25],[0,-.5],[.5,-.25],[.5,.25],[0,.5],[-.5,.25]].map(([e,t])=>[e+.5,t+.5]).map(([e,i])=>({x:e*t.HEX_WIDTH,y:i*t.HEX_HEIGHT}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NewGameStateContext=void 0,t.NewGameStateContext={StartingNewGame:{name:"starting new game",startFactionTurn:!0,flushHistory:!0,resetCamera:!0},LoadingGame:{name:"loading game",startFactionTurn:!0,flushHistory:!0,resetCamera:!0},ResumingGame:{name:"resuming game",startFactionTurn:!0,flushHistory:!1,resetCamera:!1},LoadingGameStateForDebug:{name:"loading game state for debug",startFactionTurn:!1,flushHistory:!1,resetCamera:!1},Preview:{name:"loading game state for preview",startFactionTurn:!1,flushHistory:!1,resetCamera:!1},Undo:{name:"undo",startFactionTurn:!1,flushHistory:!1,resetCamera:!1}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DialogButtons=void 0,function(e){e.OK="OK",e.Save="SAVE",e.Cancel="CANCEL",e.NewGame="START",e.Launch="LAUNCH",e.GiveUp="GIVE UP",e.Restart="RESTART",e.Load="LOAD"}(t.DialogButtons||(t.DialogButtons={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlateWithDialogButtons=t.DialogButtonRole=void 0;const n=i(28),s=i(300),a=i(302),o=i(43);!function(e){e[e.Regular=0]="Regular",e[e.PrimaryGreen=1]="PrimaryGreen",e[e.PrimaryDanger=2]="PrimaryDanger"}(t.DialogButtonRole||(t.DialogButtonRole={}));class r extends o.CompositeUiElement{constructor(e,t){super(e),this.props=t,this.buttonGroup=new a.DialogButtonGroup(this.scene,{buttons:this.props.buttons,onClicked:this.props.onClicked}),this.plate=new s.BoxAround(this.scene,{texture:n.BoxTexture.InnerPlate,padding:16,paddingBottom:16+this.buttonGroup.height/2,content:this.props.content,minSize:{width:this.buttonGroup.width+60,height:80}}),this.add(this.plate,this.buttonGroup)}updateLayout(){const e=this.plate.width,t=this.plate.height+this.buttonGroup.height/2;return this.plate.setPosition(0,0),this.buttonGroup.setPosition(e/2-this.buttonGroup.width/2,t-this.buttonGroup.height),{width:e,height:t}}}t.PlateWithDialogButtons=r},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CompositeUiElement=void 0;const s=i(118),a=i(93),o=i(301),r=n(i(23)),c=i(22);class l extends s.BaseUiElement{constructor(e){super(e),this.container=new c.ResponsiveContainer(this.scene),this.members=[],this.size={width:0,height:0},this.debugLayer=new a.UiDebugLayer(this.scene,this.container)}getGameObject(){return this.container}add(...e){e.forEach(e=>{(0,o.isUiElement)(e)?(this.container.add(e.getGameObject()),e.onResize(()=>{const e=this.size;this.reflow(),r.default.isEqual(e,this.size)||this.onResize.fire(this.size)})):this.container.add(e)}),this.members.push(...e),this.reflow()}reflow(){this.size=this.updateLayout()}get height(){return this.size.height}get width(){return this.size.width}get x(){return this.container.x}get y(){return this.container.y}setPosition(e,t){this.container.setPosition(e,t)}destroy(){this.container.getAll().map(e=>e.destroy()),this.container.destroy(),super.destroy()}}t.CompositeUiElement=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ButtonControllers=t.ButtonState=void 0;const n=i(95),s=i(176),a=i(303);!function(e){e.Rest="rest",e.Hover="hover",e.Down="down",e.Disabled="disabled"}(t.ButtonState||(t.ButtonState={})),t.ButtonControllers={simple:()=>new n.SimpleButtonStateController({}),passive:()=>new s.PassiveButtonStateController,options:(e,t)=>new a.OptionsGroupButtonController(e,t)}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.LocalStorageUserData=t.DEFAULT_NEW_GAME_OPTIONS=t.SaveGameTags=t.LevelOutcome=void 0;const s=i(3),a=i(8),o=i(0),r=i(75),c=i(1),l=i(120),d=c.logger.for("UserData");var h,u;!function(e){e.Victory="Victory",e.Defeat="Defeat"}(h=t.LevelOutcome||(t.LevelOutcome={})),function(e){e.Autosave="auto",e.BestResult="best"}(u=t.SaveGameTags||(t.SaveGameTags={})),t.DEFAULT_NEW_GAME_OPTIONS={shape:"island",regions:"balancedChaos",theme:"default",players:[s.FactionController.LocalUser,s.FactionController.Ai,s.FactionController.Ai,s.FactionController.Ai,s.FactionController.Ai,s.FactionController.Ai],mapWidth:18,mapHeight:18};const g={newGameOptions:t.DEFAULT_NEW_GAME_OPTIONS};function p(e,t){return l.SAVE_GAME_LOCAL_STORAGE_PREFIX+e+"."+t}t.LocalStorageUserData=class{constructor(){this.levelProgressById={},this.rememberedChoices=g,this.readMetadata()}getLevelProgressById(e){return this.levelProgressById[e]}loadGame(e,t){return n(this,void 0,void 0,(function*(){const i=p(e,t),n=localStorage.getItem(i);if(!n)throw new Error(`no data found for save "${i}"`);let s;try{s=JSON.parse(n)}catch(e){throw new Error("save data corrupted for "+i)}if(s.version!==a.CORE_GAMESTATE_SCHEMA_VERSION)throw new Error("save data not compatible with current version of the game in "+i);if(s.map.levelId!==e)throw new Error(`Level id mismatch - expected "${e}", found ${s.map.levelId}"`);return s}))}rememberChoice(e,t){this.rememberedChoices[e]=t,this.writeMetadata()}recallChoice(e){return this.rememberedChoices[e]}deleteSavedGame(e,t=u.Autosave){const i=this.levelProgressById[e];switch(t){case u.Autosave:i.inProgress=void 0;break;case u.BestResult:i.bestResult=void 0}localStorage.removeItem(p(e,t)),this.writeMetadata()}writeMetadata(){localStorage.setItem("konkr.userData",JSON.stringify({savedGamesById:this.levelProgressById,rememberedChoices:this.rememberedChoices}))}readMetadata(){const e=localStorage.getItem("konkr.userData");if(!e)return;const t=JSON.parse(e);this.levelProgressById=t.savedGamesById,this.rememberedChoices=t.rememberedChoices,d.info("User data initialized from local storage (key konkr.userData)"),console.debug(t)}saveLevelProgress(){var e;const t=o.inject.gameStateModel;this.levelProgressById[t.map.levelId]={levelId:t.map.levelId,lastPlayed:(new Date).toISOString(),inProgress:{turnNumber:t.currentPhase.turnNumber},bestResult:null===(e=this.levelProgressById[t.map.levelId])||void 0===e?void 0:e.bestResult},this.rememberedChoices.latestLevelId=t.map.levelId,this._saveLevelData(u.Autosave),this.writeMetadata()}saveLevelOutcome(e){const t=o.inject.gameStateModel,i=this.levelProgressById[t.map.levelId].bestResult,n=(null==i?void 0:i.outcome)===h.Victory?i.turnNumber:Number.MAX_VALUE,s=t.currentPhase.turnNumber,a={outcome:e,turnNumber:s};let r=i;((null==i?void 0:i.outcome)!==h.Victory||s<n)&&(r=a,this._saveLevelData(u.BestResult)),this.levelProgressById[t.map.levelId]={levelId:t.map.levelId,lastPlayed:(new Date).toISOString(),inProgress:void 0,bestResult:r},this.rememberedChoices.latestLevelId=void 0,this.deleteSavedGame(t.map.levelId,u.Autosave),this.writeMetadata()}_saveLevelData(e){const t=JSON.stringify((0,r.compressGameState)(o.inject.gameStateModel.stateEngine)),i=p(o.inject.gameStateModel.map.levelId,e);localStorage.setItem(i,t),d.info(`Current game state saved into local storage as "${i}"`)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameStateDebugLayer=void 0;const n=i(27),s=i(0),a=i(66);t.GameStateDebugLayer=class{constructor(e){this.adapter=e,this.onChange=(0,n.signal)(),this.listener=(()=>this.onChange.fire()).bind(this)}activate(){s.inject.gameStateModel.stateEngine.watchAll(this.listener)}deactivate(){s.inject.gameStateModel.stateEngine.stopWatching(this.listener)}getMap(){const e=s.inject.gameStateModel.state,t=new a.CustomHexGroupValuation(void 0);for(const i of this.adapter.getHexes(e).members)t.set(i.id,this.adapter.getValue(e,i.id));return t}getDetail(e){return this.adapter.getDetail(s.inject.gameStateModel.state,e.id)}getArrows(){var e,t;if(!this.adapter.getParents&&!this.adapter.getChildren)return[];let i=[];const n=s.inject.gameStateModel.state,a=this.adapter.getHexes(n);for(const s of a.members)this.adapter.getParents&&(null===(e=this.adapter.getParents(n,s.id))||void 0===e||e.forEach(e=>{i.push([e,s.id])})),this.adapter.getChildren&&(null===(t=this.adapter.getChildren(n,s.id))||void 0===t||t.forEach(e=>{i.push([s.id,e])}));return i}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseUIScene=void 0;const n=i(0),s=i(1),a=i(123);class o extends a.BaseScene{constructor(e){super(e),this.log=s.logger.for(e.key||"BaseScene"),n.inject.config.watchFuture(e=>this.applyConfig(e))}create(){super.create();const e=this.cameras.main;e.setZoom(n.inject.ui.scale).setOrigin(0,0).setRoundPixels(!0),this.bounds={get width(){return n.inject.device.screenWidth/e.zoom},get height(){return n.inject.device.screenHeight/e.zoom},get contentLeft(){return n.inject.device.contentLeft/e.zoom},get contentWidth(){return n.inject.device.contentWidth/e.zoom},get contentRight(){return n.inject.device.contentRight/e.zoom},get centerX(){return n.inject.device.screenWidth/e.zoom/2},get centerY(){return n.inject.device.screenHeight/e.zoom/2}},this.scale.on("resize",()=>{this.preUpdate.makeDirty()})}}t.BaseUIScene=o},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ParallelCinematic=t.BaseCinematic=t.BlankCinematic=void 0,t.BlankCinematic={play(){return n(this,void 0,void 0,(function*(){}))},playAfter:e=>new Promise(t=>setTimeout(t,e))};class s{constructor(e){this.scene=e}play(){return new Promise(e=>{this.execute(e)})}playAfter(e,t){return new Promise(t=>{this.scene.time.addEvent({delay:e,callback:()=>this.execute(t)})})}}t.BaseCinematic=s;t.ParallelCinematic=class extends s{constructor(e){super(e),this.subCinematics=[]}add(e){this.subCinematics.push(e)}execute(e){Promise.all(this.subCinematics.map(e=>e.play())).then(e)}}},,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseModel=void 0;const n=i(0);t.BaseModel=class{constructor(){}get state(){var e;return null!==(e=this._lockedState)&&void 0!==e?e:n.inject.currentGameState}set state(e){if(this._lockedState)throw new Error("This state model is locked");n.inject.currentGameState=e}lockToState(e){this._lockedState=e}unlock(){this._lockedState=void 0}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rules=void 0;const n=i(8),s=i(239),a=i(13),o=i(148),r=i(5),c=i(17);class l{static get(e){return(0,r.selectFromState)(e,n.GameState.ruleSet)}static model(e){const t=this.get(e);return this.modelFactory.getOrCreateFor(t)}static getEconomyRules(e){return l.get(e).economy}static getPawnRules(e,t){return(0,r.selectFromState)(e,n.GameState.ruleSet).pawns[t]}static getPawnCost(e,t){return this.getPawnRules(e,t).cost||0}static getMergeResult(e,t,i){const n=c.Pawns.model(e).select({hexes:t,traits:[a.PawnTraits.OccupiesTile]})[0];if(!n)return i;const s=this.model(e).pawns(n.type).mergeRules;return s&&s[i]}}t.Rules=l,l.modelFactory=new o.FactoryWithCache(e=>new s.RulesModel(e))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Ribbon=t.RibbonTexture=void 0;const n=i(28);var s=Phaser.Geom.Rectangle;const a=i(22);t.RibbonTexture={WindowHeader:{texture:"ui/ribbon/window-header",height:64},ButtonGroup:{texture:"ui/ribbon/button-group",height:54},Slider:{texture:"ui/ribbon/slider",height:7},ColorBar:{texture:"ui/ribbon/color-bar",height:12},DialogButton:{texture:"ui/ribbon/dialog-button",height:46},DialogButtonDown:{texture:"ui/ribbon/dialog-button-down",height:46},SmallButton:{texture:"ui/ribbon/small-button",height:30},SmallButtonDown:{texture:"ui/ribbon/small-button-down",height:30},MediumButton:{texture:"ui/ribbon/medium-button",height:36},MediumButtonDown:{texture:"ui/ribbon/medium-button-down",height:36},UnitTray:{texture:"ui/ribbon/unit-tray",height:64},Cloth:{texture:"ui/ribbon/cloth",height:64},Pergamen:{texture:"ui/ribbon/pergamen",height:48}};class o extends a.BaseResponsiveContainer{constructor(e,t,i=0,s=0,a=0){super(e),this.setPosition(i,s),this.setSize(a,t.height),this.leftEdge=(0,n.createCornerImage)(e,t.texture,0),this.middle=(0,n.createTileSprite)(e,t.texture,1),this.rightEdge=(0,n.createCornerImage)(e,t.texture,2),this.add([this.leftEdge,this.rightEdge,this.middle]),this.preUpdate()}setInteractive(){return super.setInteractive({hitArea:new s(this.width/2,this.height/2,this.width,this.height),hitAreaCallback:s.Contains,useHandCursor:!0}),this}updateHitArea(){var e;(null===(e=this.input)||void 0===e?void 0:e.hitArea)&&(this.input.hitArea=new s(this.width/2,this.height/2,this.width,this.height))}updateLayout(){const e=this.leftEdge.height,t=this.width-this.leftEdge.width-this.rightEdge.width;this.leftEdge.setPosition(0,0),this.rightEdge.setPosition(this.width-this.rightEdge.width,0),t>0?(this.middle.setVisible(!0),this.middle.setPosition(this.leftEdge.width-1,0),this.middle.setDisplaySize(t+2,e)):this.middle.setVisible(!1),this.updateHitArea()}getSprites(){return[this.leftEdge,this.middle,this.rightEdge]}setTint(e){this.getSprites().forEach(t=>t.setTint(e))}setTexture(e){this.getSprites().forEach((t,i)=>t.setFrame((0,n.getTileFrameKey)(e.texture,i)))}}t.Ribbon=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseDialogUIProvider=void 0;const n=i(304),s=i(23),a=i(33),o=i(42);class r extends n.BaseUiProvider{constructor(){super(...arguments),this.onClose=s.noop}createElement(e){let t=this.createContent(e);return"string"==typeof t&&(t=new a.Label(e,t)),this.plate=new o.PlateWithDialogButtons(e,{content:t,buttons:this.getButtons(),onClicked:e=>this.handleClose(e)}),this.plate}handleClose(e){this.onClose(e)}applyProps(e){this.props=e,this.onClose=e.onClose}}t.BaseDialogUIProvider=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TileSymbolsManager=t.TileSymbol=void 0;const n=i(10),s=i(1),a=i(350);!function(e){e.Alert="alert",e.Plus="plus",e.Arrow="arrow"}(t.TileSymbol||(t.TileSymbol={}));const o=s.logger.for("ui:TileSymbols");t.TileSymbolsManager=class{constructor(e){this.pawns=e,this.symbolsByHex=new Map,this.pawnsBySymbolType=new a.MultiMap}clear(e){var t,i;const n=null!==(i=null===(t=this.pawnsBySymbolType.get(e))||void 0===t?void 0:t.filter(e=>{var t;return!e.isDestroyed&&(null===(t=e.tile)||void 0===t?void 0:t.hex)}).map(e=>e.tile.hex))&&void 0!==i?i:[];0!==n.length&&(Array.from(n).forEach(t=>this.remove(t,e)),this.pawnsBySymbolType.deleteKey(e))}add(e,t){let i=this.symbolsByHex.get(e),s=null==i?void 0:i.has(t);i?s||this.symbolsByHex.set(e,i.add(t)):this.symbolsByHex.set(e,(0,n.OrderedSet)([t])),s||this.updateSymbolImage(e)}remove(e,t){const i=this.symbolsByHex.get(e);(null==i?void 0:i.has(t))&&(this.symbolsByHex.set(e,this.symbolsByHex.get(e).remove(t)),this.updateSymbolImage(e))}removeAllFrom(e){this.symbolsByHex.delete(e),this.updateSymbolImage(e)}getCurrentSymbol(e){var t;return null===(t=this.symbolsByHex.get(e))||void 0===t?void 0:t.first(void 0)}updateSymbolImage(e){const t=this.getCurrentSymbol(e),i=this.pawns.getByHex(e.id);t?i?(this.pawnsBySymbolType.add(t,i),i.setSymbol(t)):o.warning(`Failed to update symbol image to ${t} on ${e}: no pawn sprite located on the hex`):null==i||i.removeSymbol()}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.BaseScreen=void 0;const s=i(0);t.BaseScreen=class{constructor(e){this._subs=[],this._deferredHandlers=new Map,this.scenes=e}getScenes(){return this.scenes}activate(e){return n(this,void 0,void 0,(function*(){}))}deactivate(){}isActive(){return s.inject.navigator.currentScreen===this}pause(){this.scenes.forEach(e=>s.inject.game.scene.pause(e))}resume(){this.scenes.forEach(e=>s.inject.game.scene.resume(e))}handleEventWhileActive(e,t){this._subs.push(s.inject.events.on(e,(e,i)=>{this.isActive()&&t.apply(this,[e,i])}))}handleSignalWhileActive(e,t){this._subs.push(e((...e)=>{this.isActive()&&t.apply(this,e)}))}watchWhileActive(e,t){this._subs.push(e.watch((i,n)=>{this.isActive()?t.apply(this,[i,n]):this._deferredHandlers.set(e,()=>t.apply(this,[i,n]))}))}}},,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BalancedGrowthArmyComposition=t.UNRESTRICTED_ARMY_COMPOSITION=void 0;const n=i(0);i(1).logger.for("ai:ArmyComposition");t.UNRESTRICTED_ARMY_COMPOSITION={getWillingnessToDiscardUnit:()=>1,getWillingnessToObtainUnit:()=>1};t.BalancedGrowthArmyComposition=class{constructor(e,t=1){this.region=e,this.strictness=t}getWillingnessToDiscardUnit(e,t){return 1-this.getUnitCountPressure(e.totalUnits,t,-1)*this.strictness}getWillingnessToObtainUnit(e,t){return 1+this.getUnitCountPressure(e.totalUnits,t,1)*this.strictness}getWillingnessToSpend(e,t){return 0}getUnitCountPressure(e,t,i){const s=this.region.size,a=n.inject.gameStateModel.rules.unitByMight(t).upkeep,o=Math.floor(s/(t+2)),r=.75*s-o,c=e.countOf(t);if(1===t&&0===c)return 1;let l=(o-a*(c+i))/r;return l>1?l=1:l<-1&&(l=-1),l}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BALANCED_ECONOMIC_STRATEGY=t.BalancedEconomicAdvisor=t.GrowthEconomicAdvisor=t.UNRESTRICTED_ECONOMIC_ADVISOR=void 0,t.UNRESTRICTED_ECONOMIC_ADVISOR={getWillingnessToSpend:(e,t,i)=>e.remainingGold>=t?1-t/1e3:0,getMinimalAcceptableIncome:e=>-1/0};t.GrowthEconomicAdvisor=class{constructor(e){this.region=e}getWillingnessToSpend(e,t,i){const n=e.willSacrifice?i:0,s=e.remainingIncome+1,a=e.remainingIncome-n,o=this.getIncomeTarget();let r=1;return n>0&&a<o&&(r=1/(o-a)),e.remainingGold<t||s-n<0?0:1-t/1e3*r}getMinimalAcceptableIncome(e){return this.region.size<3?-1:Math.ceil(this.getIncomeTarget()/2)}getIncomeTarget(){return this.region.size<3?0:Math.max(1,this.region.size/3)}};class n{getWillingnessToSpend(e,t,i){const n=e.willSacrifice?i:0,s=e.remainingIncome+1;return e.remainingGold<t||s-n<0?0:1-t/1e3}getMinimalAcceptableIncome(e){return-1}}t.BalancedEconomicAdvisor=n,t.BALANCED_ECONOMIC_STRATEGY=new n},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.mergeTransactions=t.CoinTransactionBuilder=void 0;const s=i(11),a=i(3),o=i(2),r=i(17),c=i(4),l=n(i(23));function d(){return{consume:0,send:{},spawn:0}}t.CoinTransactionBuilder=class{constructor(){this.data={}}from(e){return this.currentHex=e,this}spawn(e){o.assert.defined(this.currentHex,"no hex selected");return(0,s.getOrCreate)(this.data,this.currentHex.id,d).spawn+=e,this.currentAmount=e,this}send(e,t=this.currentAmount){o.assert.defined(this.currentHex,"no hex selected"),o.assert.defined(t,"amount not specified");const i=(0,s.getOrCreate)(this.data,this.currentHex.id,d);return i.send[e.id]=(i.send[e.id]||0)+t,this.currentHex=e,this.currentAmount=t,this}consume(e=this.currentAmount){o.assert.defined(e,"amount not specified"),o.assert.defined(this.currentHex,"no hex selected");return(0,s.getOrCreate)(this.data,this.currentHex.id,d).consume+=e,this}getTransactions(){return this.data}reset(){this.currentHex=void 0,this.currentAmount=void 0,this.data={}}apply(e){return function(e,t){const i={};Object.entries(t).forEach(([e,t])=>{i[e]=i[e]||0,i[e]+=t.spawn,i[e]-=t.consume,Object.entries(t.send).forEach(([t,n])=>{i[e]-=n,i[t]=(i[t]||0)+n})});const n=r.Pawns.model(e);return Object.entries(i).forEach(([e,t])=>{const i=(0,c.getHex)(Number(e));o.assert.defined(i),n.adjustCount(i,a.PawnType.Coins,t)}),n.state}(e,this.getTransactions())}},t.mergeTransactions=function(e,t){const i=l.default.cloneDeep(e);for(const e of Object.keys(t)){const n=Number(e),s=t[n];if(i[n]){i[n].consume+=s.consume;for(const e of Object.keys(s.send)){const t=Number(e);i[n].send[t]=(i[n].send[t]||0)+s.send[t]}i[n].spawn+=s.spawn}else i[n]=s}return i}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBoundingBox=t.getRectMidPoint=t.euclidDistance=t.manhattanDistance=t.multiplyRect=t.enlargeRect=t.rectToPhaser=void 0,t.rectToPhaser=function(e){return new Phaser.Geom.Rectangle(e.x,e.y,e.width,e.height)},t.enlargeRect=function(e,t){return e.x-=t,e.y-=t,e.width+=2*t,e.height+=2*t,e},t.multiplyRect=function(e,t,i){return e.x*=t,e.y*=i,e.width*=t,e.height*=i,e},t.manhattanDistance=function(e,t){return Math.abs(Math.abs(e.x)-Math.abs(t.x))+Math.abs(Math.abs(e.y)-Math.abs(t.y))},t.euclidDistance=function(e,t){const i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)},t.getRectMidPoint=function(e){return{x:e.x+e.width/2,y:e.y+e.height/2}},t.getBoundingBox=function(e){if(0===e.length)return{x:0,y:0,height:0,width:0};let t=Number.MAX_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER,n=-Number.MAX_SAFE_INTEGER,s=-Number.MAX_SAFE_INTEGER;for(let a of e)a.x<t&&(t=a.x),a.x>n&&(n=a.x),a.y<i&&(i=a.y),a.y>s&&(s=a.y);return{x:t,y:i,width:n-t,height:s-i}}},function(e,t,i){"use strict";var n;function s(e,t){const i=e+"."+t,n=function(t){return{name:i,payload:t,category:e,isTypedEvent:!0}};return n.eventName=e+"."+t,n.category=e,n}Object.defineProperty(t,"__esModule",{value:!0}),t.createTypedReducer=t.isEvent=t.createEventFactory=t.gameplayAction=t.userAction=t.systemEvent=t.gameStateEvent=t.EventCategory=void 0,function(e){e.Play="PLAY",e.GameState="GAME_STATE",e.System="SYSTEM",e.UI="UI",e.MapEditor="UI_MAP_EDITOR",e.WorldMap="UI_WORLD_MAP",e.PlayUI="UI_PLAY_UI"}(n=t.EventCategory||(t.EventCategory={})),t.gameStateEvent=function(e){return s(n.GameState,e)},t.systemEvent=function(e){return s(n.System,e)},t.userAction=function(e){return s(n.UI,e)},t.gameplayAction=function(e){return s(n.Play,e)},t.createEventFactory=s,t.isEvent=function(e,t){return!!e.hasOwnProperty("isTypedEvent")&&(!t||e.name===t.eventName)},t.createTypedReducer=function(){const e=new Map;return{on(t,i){e.set(t,i)}}}},,,function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MultiMapMutationBuilder=t.MultiMapDataSet=void 0;const s=i(23),a=n(i(10)),o=i(5),r=i(2);t.MultiMapDataSet=class{constructor(e){this.key=e,this.defaultValue=a.default.Map()}deserialize(e){let t=a.default.Map();return Object.entries(e).forEach(([e,i])=>{t=t.set(Number(e),a.default.Set(i))}),t}serialize(e){return e.toJS()}apply(e,t){return e.withMutations(e=>{var i;null===(i=t.updated)||void 0===i||i.forEach(t=>{t.removed&&(e.updateIn([this.key,t.id],o.EMPTY_SET,e=>e.subtract(t.removed)),e.getIn([this.key,t.id]).isEmpty()&&e.deleteIn([this.key,t.id])),t.added&&e.updateIn([this.key,t.id],o.EMPTY_SET,e=>e.union(t.added))})})}createMutation(e,t){let i={},n=e.remove&&Object.entries(e.remove).filter(([e,t])=>t.size),a=e.add&&Object.entries(e.add).filter(([e,t])=>t.size);return(a&&!(0,s.isEmpty)(a)||n&&!(0,s.isEmpty)(n))&&(i.updated=[],null==a||a.forEach(([t,n])=>{var s;const a={id:Number(t),added:Array.from(n)};e.remove&&(null===(s=e.remove[t])||void 0===s?void 0:s.size)&&(a.removed=Array.from(e.remove[t])),i.updated.push(a)}),null==n||n.forEach(([t,n])=>{var s;const a=Number(t);e.add&&(null===(s=e.add[Number(a)])||void 0===s?void 0:s.size)||i.updated.push({id:Number(a),removed:Array.from(n)})})),{dataSet:this,changes:i,context:`${this.key}/${t}`}}getEntryById(e,t){return e.getIn([this.key,t])}getEntryIds(e){return e.get(this.key).keySeq().toArray()}entryToString(e){return e.map(e=>e.toString()).toArray().join(",")}entryToDebugString(e){return e.map(e=>e.toString()).toArray().join(",")}toString(){return`[MultiMapDataSet "${this.key}"]`}};t.MultiMapMutationBuilder=class{constructor(e,t){this.dataSet=e,this._itemsToAdd={},this._itemsToRemove={},t&&this.init(t)}init(e){this.state=e,this._itemsToAdd={},this._itemsToRemove={}}add(e,...t){return this._itemsToAdd[e]||(this._itemsToAdd[e]=new Set),t.forEach(t=>{var i;r.assert.defined(t),(null===(i=this._itemsToRemove[e])||void 0===i?void 0:i.has(t))?this._itemsToRemove[e].delete(t):this.getCurrent(e).has(t)||this._itemsToAdd[e].add(t)}),this}has(e,t){var i,n;return!(null===(i=this._itemsToRemove[e])||void 0===i?void 0:i.has(t))&&!!(null===(n=this._itemsToAdd[e])||void 0===n?void 0:n.has(t))}getCurrent(e){let t=this.dataSet.getEntryById(this.state,e)||o.EMPTY_SET;return this._itemsToRemove[e]&&(t=t.subtract(this._itemsToRemove[e])),this._itemsToAdd[e]&&(t=t.union(this._itemsToAdd[e])),t}currentHas(e,t){var i,n,s;return!(null===(i=this._itemsToRemove[e])||void 0===i?void 0:i.has(t))&&(!!(null===(n=this._itemsToAdd[e])||void 0===n?void 0:n.has(t))||(null===(s=this.dataSet.getEntryById(this.state,e))||void 0===s?void 0:s.has(t)))}hasRemoved(e,t){var i;return!!(null===(i=this._itemsToRemove[e])||void 0===i?void 0:i.has(t))}remove(e,...t){this._itemsToRemove[e]||(this._itemsToRemove[e]=new Set),t.forEach(t=>{var i,n;r.assert.defined(t),(null===(i=this._itemsToAdd[e])||void 0===i?void 0:i.has(t))?this._itemsToAdd[e].delete(t):(null===(n=this.dataSet.getEntryById(this.state,e))||void 0===n?void 0:n.has(t))&&this._itemsToRemove[e].add(t)})}removeEntry(e){const t=this.dataSet.getEntryById(this.state,e);t&&t.size&&(delete this._itemsToAdd[e],this._itemsToRemove[e]=new Set(t.toArray()))}clear(){throw new Error("Not implemented")}createMutation(e){return this.dataSet.createMutation({add:this._itemsToAdd,remove:this._itemsToRemove},e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CustomHexGroupValuation=void 0;const n=i(11),s=i(19);class a{constructor(e){this.defaultValue=e,this.values={}}generateFrom(e,t){e.forEach(e=>{const i=t(e);void 0!==i&&i!==this.defaultValue&&this.set(e.id,t(e))})}generateFromIds(e,t){e.forEach(e=>{const i=t(e);void 0!==i&&i!==this.defaultValue&&this.set(e,t(e))})}set(e,t){this.values[e]=t}unset(e){delete this.values[e]}get(e){return this.values.hasOwnProperty(e)?this.values[e]:this.defaultValue}map(e){const t=new a(e(this.defaultValue,-1));return t.importDictionary(this.exportDictionary(e)),t}exportDictionary(e){return e?(0,n.mapDictionary)(this.values,e):this.values}toString(){return`[HexGroupValuation (default=${this.defaultValue})]`}dump(){return`{\n${Object.entries(this.values).map(([e,t])=>`${e}: ${(0,s.str)(t)}`).join("\n")}\n}`}getHexIds(){return Object.keys(this.values).map(e=>Number(e))}importDictionary(e){Object.keys(e).forEach(t=>this.values[t]=e[t])}clear(){this.values={}}static fromDictionary(e,t){const i=new a(t);return i.importDictionary(e),i}static fromGroupsCollection(e,t){const i=new a(t);return e.forEach((e,t)=>{e.forEach(e=>i.set(e.id,t))}),i}}t.CustomHexGroupValuation=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.centerVertically=t.center=t.centerHorizontally=t.layoutFromLeftToRight=void 0,t.layoutFromLeftToRight=function(e,t,i,n){let s=e;for(let e of n)e.setPosition(s,t),s=s+e.width+i},t.centerHorizontally=function(e,t,i,n){e.setPosition(t+n/2-e.width/2,i)},t.center=function(e,t,i,n,s){e.setPosition(t+n/2-e.width/2,i+s/2-e.height/2)},t.centerVertically=function(e,t,i,n){e.y=i+n/2-e.height/2}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapScene=t.WorldMapEvents=t.PointerEventFlags=t.worldMapAction=void 0;const n=i(1),s=i(16),a=i(37),o=i(0),r=i(328),c=i(329),l=i(332),d=i(334),h=i(339),u=i(12),g=i(62),p=i(343),m=i(123),f=i(187),y=i(344),v=i(345),w=i(346),b=i(3),S=i(166),x=i(347),P=i(80),T=i(349),M=i(55),C=i(36),I=i(188),O=i(351),_=i(353),A=i(358),E=i(20),B=i(359),H=i(101),j=i(362),R=n.logger.for("ui:WorldMapScene");function D(e){return(0,g.createEventFactory)(g.EventCategory.WorldMap,e)}var F;t.worldMapAction=D,function(e){e[e.MiddleButton=1]="MiddleButton",e[e.RightButton=2]="RightButton",e[e.Shift=4]="Shift",e[e.Alt=8]="Alt",e[e.Ctrl=16]="Ctrl"}(F=t.PointerEventFlags||(t.PointerEventFlags={})),t.WorldMapEvents={PointerDown:D("POINTER_DOWN"),PointerUp:D("POINTER_UP")};class L extends m.BaseScene{constructor(){super({key:s.Scenes.WorldMap}),this.mode=new H.BaseWorldMapMode,this.cinematics={worldCreation:new y.WorldCreationCinematic(this),coinTransaction:e=>this.coins.cinematics.transactions(e),tileDefense:(e,t)=>new w.TileDefenseCinematic(this.pawns,e,t)}}create(){super.create(),this.keys={shift:this.input.keyboard.addKey(C.Input.Keyboard.KeyCodes.SHIFT),alt:this.input.keyboard.addKey(C.Input.Keyboard.KeyCodes.ALT),ctrl:this.input.keyboard.addKey(C.Input.Keyboard.KeyCodes.CTRL)},this.input.keyboard.addKey(C.Input.Keyboard.KeyCodes.SHIFT),this.input.mouse.disableContextMenu(),this.input.on("wheel",(e,t,i,n,s)=>{this.mode.zoomWithScrollWheel&&this.cameraController.zoomController.applyScroll(n)},this),this.cameraController=new c.WorldMapCameraController(this.cameras.main),this.debugOverlay=new r.WorldMapDebugOverlay(this),this.editorOverlay=new I.WorldMapEditorOverlay(this),this.objectPools=new P.WorldObjectsPool(this),this.debugOverlay.create(),this.chunkedRenderer=new x.ChunkedRenderer(this,5),this.chunksRenderingController=new x.ChunksRenderingController(this,this.chunkedRenderer),this.tiles=new l.TilesManager(this,this.chunkedRenderer),this.regions=new _.RegionsRenderer(this.chunkedRenderer),this.landmass=new A.LandmassRenderer(this.chunkedRenderer),this.coins=new d.CoinsManager(this,this.objectPools,this.tiles),this.pawns=new h.PawnsManager(this,this.objectPools,this.tiles),this.townStatusFlags=new T.TownStatusFlagsManager(this.chunkedRenderer,this.objectPools,this.tiles),this.townBacklight=new B.TownBacklightManager(this.chunkedRenderer,this.tiles,this.pawns),this.tileSymbols=new M.TileSymbolsManager(this.pawns),this.attitudeEmojis=new O.AttitudeEmojiManager(this,this.objectPools,this.tiles),this.selectedRegionHighlight=new p.SelectedRegionHighlight(this.chunkedRenderer),this.conquerableHexesHighlight=new f.ConquerableHexesHighlight(this,this.objectPools),this.hexMarkers=new v.HexDefenseMarkers(this),this.input.on("pointerdown",this.onPointerDown,this),this.input.on("pointerup",this.onPointerUp,this),this.input.on("pointermove",this.onPointerMove,this),this.scale.on("resize",this.handleResize,this),o.inject.config.watch(this.applyConfig.bind(this)),this.lodManager=(0,j.createWorldMapLODManager)(this.objectPools),this.handleSignalWhileActive(o.inject.debugLayers.onActiveLayerUpdated,e=>{o.inject.config.debug.overlay&&this.debugOverlay.showDebugLayer(e)}),this.anims.create({key:"spin-coin",frames:this.anims.generateFrameNumbers("coin",{frames:[0,1,2,3,4,5,0]}),frameRate:30,repeat:-1})}setMode(e){R.info(`âš™ entering ${e.name} (from ${this.mode.name})`),this.mode.deactivate(),this.mode=e,o.inject.debugData.set("worldMap.mode",this.mode.name),e.activate()}applyConfig(e){super.applyConfig(e),this.debugOverlay.setVisible(!!e.debug.overlay)}onPointerDown(e){this.mode.handlesPointerEvents&&o.inject.events.trigger(t.WorldMapEvents.PointerDown(this.buildPointerEventContext(e)))}onPointerUp(e){this.mode.handlesPointerEvents&&o.inject.events.trigger(t.WorldMapEvents.PointerUp(this.buildPointerEventContext(e)))}onPointerMove(){this.mode.handlesPointerEvents&&o.inject.ui.hexUnderCursor.update(this)}update(e,t){this.pawns.update(),this.mode.rendersEverything?this.chunksRenderingController.renderEverything():this.chunksRenderingController.update();const i=this.cameras.main;this.cameraController.update(e,t),this.lodManager.update(),o.inject.config.debug.overlay&&(o.inject.debugData.set("CAM.dimensions",`${i.x},${i.y} -> ${i.width},${i.height}`),o.inject.debugData.set("CAM.worldView",`${i.worldView.x},${i.worldView.y} -> ${Math.round(i.worldView.right)},${Math.round(i.worldView.bottom)}`),o.inject.debugData.set("CAM.scroll",`${Math.round(i.scrollX)}, ${Math.round(i.scrollY)} ph(${this.cameraController.scrollController.cameraX.phase}) z(${i.zoom.toFixed(1)}) d(${(1/i.zoom).toFixed(1)})`),o.inject.debugData.set("worldTweens",""+this.tweens.getAllTweens().length),this.objectPools.updateDebugData())}setSelectedRegion(e,t=E.Colors.highlight.ownedRegion){this.selectedRegionHighlight&&(e?this.selectedRegionHighlight.set(e,t):this.selectedRegionHighlight.clear())}loadNewGameState(e){o.inject.ui.withoutTransitions(()=>{var t;this.cameraController.updateBounds(),this.debugOverlay.redrawWorldBoundsRectangle(this.cameraController.worldBounds),null===(t=this.editorOverlay)||void 0===t||t.update(),this.syncState(e)})}syncState(e){const t=new a.StaticGameStateModel(e),{pawns:i,regions:n,factions:s}=t,r=u.HexGroup.union(n.all().map(e=>e.hexes)),c=[b.PawnType.Palisade,b.PawnType.StoneWall,b.PawnType.Coins,b.PawnType.Forest];i.select({hexes:r}).filter(e=>!c.includes(e.type));this.townStatusFlags.clear(),this.townBacklight.clear(),this.attitudeEmojis.clear(),this.tileSymbols.clear(M.TileSymbol.Alert),this.tiles.syncWithModel(t,r,!0),this.pawns.syncWithModel(t,e=>!c.includes(e.type)),this.coins.syncWithModel(t),this.regions.syncWithModel(t),this.landmass.syncWithModel(t),this.debugOverlay.redrawChunkRectangles(this.chunkedRenderer.getAllChunks()),this.mode.onSyncState(t),o.inject.scene.worldMap.runIntegrityChecks()}destroy(e){}getPawnObjectPositionOnScreen(e){return this.pawns.getPawnObjectPositionOnScreen(this.cameras.main,e)}handleResize(){this.cameraController.updateViewPort(),this.cameraController.updateBounds(),this.mode.onResize()}showHexDefenseMarkers(e){const t=o.inject.ui.selectedRegion();if(t){const i=(0,v.deriveDefenseMarkerDataFromModel)(t,e);this.hexMarkers.set(i)}}buildPointerEventContext(e){const t=(0,S.getHexUnderCursor)(this,o.inject.gameStateModel);let i=0;return e.middleButtonDown()&&(i|=F.MiddleButton),e.rightButtonDown()&&(i|=F.RightButton),this.keys.shift.isDown&&(i|=F.Shift),this.keys.alt.isDown&&(i|=F.Alt),this.keys.ctrl.isDown&&(i|=F.Ctrl),{hexId:null==t?void 0:t.id,flags:i}}runIntegrityChecks(){this.pawns.integrityCheck()}}t.WorldMapScene=L},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IsoTileRecipes=void 0;const n=i(34),s={A111:{frame:"full"},V111:{frame:"full"},V001:{frame:"inner",crop:{x:24,y:0,width:26,height:38}},A010:{frame:"inner",crop:{x:48,y:0,width:26,height:38}},V100:{frame:"inner",crop:{x:48,y:36,width:26,height:38}},A100:{frame:"inner",crop:{x:24,y:36,width:26,height:38}},V010:{frame:"inner",crop:{x:0,y:36,width:26,height:38}},A001:{frame:"inner",crop:{x:0,y:0,width:26,height:38}},V110:{frame:"outer",crop:{x:24,y:0,width:26,height:38}},A101:{frame:"outer",crop:{x:48,y:0,width:26,height:38}},V011:{frame:"outer",crop:{x:48,y:36,width:26,height:38}},A011:{frame:"outer",crop:{x:24,y:36,width:26,height:38}},V101:{frame:"outer",crop:{x:0,y:36,width:26,height:38}},A110:{frame:"outer",crop:{x:0,y:0,width:26,height:38}}};t.IsoTileRecipes={Palisade:{baseDepth:n.WorldLayers.TileObjects,offsetA:24,offsetV:24,frames:{V001:{frame:"V001"},A010:{frame:"A010"},V100:{frame:"V100"},A100:{frame:"A100"},V010:{frame:"V010"},A001:{frame:"A001"},V110:{frame:"V110"},A101:{frame:"A101"},V011:{frame:"V011"},A011:{frame:"A011"},V101:{frame:"V101"},A110:{frame:"A110"}},frameIdBase:"iso-tiles/palisade"},Ground:{baseDepth:n.WorldLayers.Tiles,frameIdBase:"iso-tiles/ground",offsetV:13,offsetA:25,frames:s},Forest:{baseDepth:n.WorldLayers.TileObjects,frameIdBase:"iso-tiles/forest",offsetV:13,offsetA:25,frames:s},Green:{baseDepth:n.WorldLayers.Tiles+100,frameIdBase:"iso-tiles/green",offsetV:13,offsetA:25,frames:Object.assign(Object.assign({},s),{A101:{frame:"outer-v"},V110:{frame:"outer-h"},V011:{frame:"outer-v",flipY:!0},A011:{frame:"outer-h",flipY:!0},V101:{frame:"outer-v",flipX:!0,flipY:!0},A110:{frame:"outer-v",flipX:!0}})},Landmass:{baseDepth:n.WorldLayers.Landmass,frameIdBase:"iso-tiles/landmass",offsetV:13,offsetA:25,frames:s},Highlight:{baseDepth:n.WorldLayers.TileHighlight,frameIdBase:"iso-tiles/highlight",offsetV:13,offsetA:25,frames:Object.assign(Object.assign({},s),{A111:void 0,V111:void 0})},Simple2D:{frames:{A111:{frame:"A111"},V111:{frame:"A111",flipY:!0},V001:{frame:"V001"},A010:{frame:"A010"},V100:{frame:"A010",flipY:!0},A100:{frame:"V001",flipY:!0},V010:{frame:"A010",flipX:!0,flipY:!0},A001:{frame:"A010",flipX:!0},V110:{frame:"V110"},A101:{frame:"A101"},V011:{frame:"A101",flipY:!0},A011:{frame:"V110",flipY:!0},V101:{frame:"A101",flipX:!0,flipY:!0},A110:{frame:"A101",flipX:!0}}}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.BaseMode=void 0;const s=i(1),a=i(31),o=i(0),r=i(6),c=i(365),l=i(366),d=i(367),h=i(102),u=i(369),g=i(62);s.logger.for("BaseMode");t.BaseMode=class{constructor(e){this.scene=e,this.name=this.constructor.name}isReadyForMoreGameEvents(){return!this.isHandlingEvent}canPickupPawn(e){return!1}canDropPawn(e){return!1}canSelectHex(e){return!1}canReturnPawn(){return!1}handlePickupPawn(e){throw Error("pickUpPawn not available in "+this.name)}handleReturnPawn(){throw Error("returnPawn not available in "+this.name)}handleSelectHex(e){throw Error("selectHex not available in "+this.name)}handleDropPawn(e){throw Error("dropPawn not available in "+this.name)}handleSkipSpectating(){throw Error("skipSpectating not available in "+this.name)}handlePickupPawnFromShop(e){o.inject.audio.playEffect(a.SoundEffects.Deny)}handleDropPawnOnShop(e,t){return o.inject.audio.playEffect(a.SoundEffects.Deny),!1}activate(){}deactivate(){}handleNewHexUnderCursor(e){}handleEndTurn(){}handleGameEvent(e){return n(this,void 0,void 0,(function*(){this.isHandlingEvent=!0,yield this.doHandleEvent(e),this.isHandlingEvent=!1}))}doHandleEvent(e){return n(this,void 0,void 0,(function*(){return(0,g.isEvent)(e,r.GameEvents.PawnBought)?this.handlePawnBought(e.payload):(0,g.isEvent)(e,r.GameEvents.BanditsActed)?this.handleBanditsActed(e.payload):(0,g.isEvent)(e,r.GameEvents.FactionEconomyUpdated)?this.handleFactionEconomyUpdated(e.payload):(0,g.isEvent)(e,r.GameEvents.HexCaptured)?this.handleHexCaptured(e.payload):(0,g.isEvent)(e,r.GameEvents.PawnMoved)?this.handlePawnMoved(e.payload):void 0}))}handlePawnBought(e){return n(this,void 0,void 0,(function*(){yield(0,c.handlePawnBought)(this.scene,e)}))}handleBanditsActed(e){return n(this,void 0,void 0,(function*(){yield(0,l.handleBanditsActed)(this.scene,e)}))}handleFactionEconomyUpdated(e){return n(this,void 0,void 0,(function*(){yield(0,d.handleFactionEconomyUpdated)(this.scene,e)}))}handleHexCaptured(e){return n(this,void 0,void 0,(function*(){yield(0,h.handleHexCaptured)(this.scene,e)}))}handlePawnMoved(e){return n(this,void 0,void 0,(function*(){yield(0,u.handlePawnMoved)(this.scene,e)}))}}},,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ruleSets=t.CHEAPEST_UNIT_COST=void 0;const n=i(13),s=i(3);t.CHEAPEST_UNIT_COST=10,t.ruleSets={default:{id:"default",economy:{baseIncomePerTile:1,baseIncomePerRegion:0},pawns:{[s.PawnType.Villager]:{might:1,defense:1,cost:10,upkeep:2,traits:[n.PawnTraits.Unit,n.PawnTraits.GuardsAdjacentTiles,n.PawnTraits.OccupiesTile],merge:{[s.PawnType.Villager]:s.PawnType.Pikeman}},[s.PawnType.Pikeman]:{might:2,defense:2,cost:20,upkeep:6,traits:[n.PawnTraits.Unit,n.PawnTraits.GuardsAdjacentTiles,n.PawnTraits.OccupiesTile],merge:{[s.PawnType.Pikeman]:s.PawnType.Knight}},[s.PawnType.Knight]:{might:3,defense:3,cost:40,upkeep:18,traits:[n.PawnTraits.Unit,n.PawnTraits.GuardsAdjacentTiles,n.PawnTraits.OccupiesTile],merge:{[s.PawnType.Knight]:s.PawnType.Hero}},[s.PawnType.Hero]:{might:4,defense:3,cost:80,upkeep:54,traits:[n.PawnTraits.Unit,n.PawnTraits.GuardsAdjacentTiles,n.PawnTraits.OccupiesTile],merge:{}},[s.PawnType.Town]:{traits:[n.PawnTraits.OccupiesTile,n.PawnTraits.Building,n.PawnTraits.GuardsAdjacentTiles],might:1,defense:1},[s.PawnType.Camp]:{traits:[n.PawnTraits.OccupiesTile,n.PawnTraits.Building],might:1,defense:1},[s.PawnType.Castle]:{traits:[n.PawnTraits.OccupiesTile,n.PawnTraits.Building,n.PawnTraits.GuardsAdjacentTiles],might:2,defense:2,cost:20,upkeep:2},[s.PawnType.Bandit]:{might:0,defense:0,upkeep:0,traits:[n.PawnTraits.OccupiesTile,n.PawnTraits.NegatesTileIncome,n.PawnTraits.Pest]},[s.PawnType.Forest]:{might:99,defense:99,upkeep:0,traits:[n.PawnTraits.OccupiesTile,n.PawnTraits.Impenetrable,n.PawnTraits.NegatesTileIncome]}}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.factionBasedAdapter=void 0;const n=i(12),s=i(7),a=i(30),o=i(14);t.factionBasedAdapter=function(e){return{getHexes:e=>n.HexGroup.union(s.Regions.model(e).all().filter(e=>e.isAlive()).map(t=>n.HexGroup.fromIds(a.Economy.getTownHexesByRegion(e,t.id).toArray()))),getValue(t,i){const n=o.Factions.getByHex(t,i);if(void 0!==n)return e.getValue(t,n)},getDetail(t,i){const n=o.Factions.getByHex(t,i);if(void 0!==n)return e.getDetail(t,n)}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compressRuleSet=t.addIds=t.decompressGameState=t.compressGameState=void 0;const n=i(11),s=i(8),a=i(1),o=i(73),r=i(7);a.logger.for("decompressGameState");function c(e,t,i){var n;return(null===(n=e.get(t,i))||void 0===n?void 0:n.toArray())||[]}t.compressGameState=function(e){e.isDataSetActive(s.GameState.regions.hexes)&&r.Regions.destroyAllEmptyRegions(e.currentState);const t=e.serialize();return e.activate(s.GameState.regions.hexes,s.GameState.factions.regions),{map:t.map,version:t.version,regions:Object.values(t.regions).map(t=>Object.assign(Object.assign({},t),{hexes:c(e,s.GameState.regions.hexes,t.id),attrition:e.get(s.GameState.ai.attritionByRegion,t.id)})),factions:Object.values(t.factions).map(t=>Object.assign(Object.assign({},t),{regions:c(e,s.GameState.factions.regions,t.id),approval:e.get(s.GameState.ai.approval,t.id)})),pawns:Object.values(t.pawns).map(t=>{return Object.assign(Object.assign(Object.assign({},t),{hex:e.get(s.GameState.pawns.hex,t.id)}),{count:(i=e.get(s.GameState.pawns.count,t.id),1===i?void 0:i)});var i}),ruleSet:e.get(s.GameState.ruleSet)===o.ruleSets.default?"default":e.get(s.GameState.ruleSet),currentPhase:Object.assign(Object.assign({},t.currentPhase),{tappedUnits:e.get(s.GameState.currentPhase.tappedUnits).keySeq().toArray()})}},t.decompressGameState=function(e){let t;const i={},a={},r={};t=(0,n.dictionaryOf)(e.regions.map(e=>(0,n.omit)(e,"hexes","attrition")),"id"),e.regions.forEach(e=>{e.hexes.forEach(t=>i[t]=e.id),e.attrition&&(a[e.id]=e.attrition)});let c={};const l={};c=(0,n.dictionaryOf)(e.factions.map(e=>(0,n.omit)(e,"regions")),"id"),e.factions.forEach(e=>{e.regions.forEach(t=>l[t]=e.id),e.approval&&(r[e.id]=e.approval)});let d={};const h={},u={};d=(0,n.dictionaryOf)(e.pawns.map(e=>(0,n.omit)(e,"hex","count")),"id"),e.pawns.forEach(e=>{h[e.id]=e.hex,u[e.id]=e.count||1});const g=(0,n.omit)(e.currentPhase,"tappedUnits");e.pawns.forEach(e=>{h[e.id]=e.hex,u[e.id]=e.count||1});const p="string"==typeof e.ruleSet?o.ruleSets[e.ruleSet]:e.ruleSet;return{map:e.map,version:s.CORE_GAMESTATE_SCHEMA_VERSION,ruleSet:p,regions:t,"regions.byHex":i,factions:c,"factions.byRegion":l,pawns:d,"pawns.count":u,"pawns.hex":h,currentPhase:g,"currentPhase.tappedUnits":e.currentPhase.tappedUnits||[],"ai.approval":r,"ai.attritionByRegion":a}},t.addIds=function(e){return(0,n.mapDictionary)(e,(e,t)=>Object.assign(Object.assign({},e),{id:Number(t)}))},t.compressRuleSet=function(e){return o.ruleSets[e.id]?e.id:e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Probability=t.cropNumber=void 0,t.cropNumber=function(e,t,i){return Math.min(i,Math.max(t,e))},t.Probability={ofEither:(e,t)=>1-(1-e)*(1-t)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UI=t.ModalsManager=void 0;const n=i(16),s=i(299),a=i(310),o=i(311),r=i(312),c=i(313),l=i(314),d=i(315),h=i(316);t.ModalsManager=class{constructor(e){this.game=e}getModalWindowScene(){return this.game.scene.getScene(n.Scenes.ModalWindow)}show(e,t,i=(()=>{})){this.game.scene.isActive(n.Scenes.ModalWindow)||this.game.scene.run(n.Scenes.ModalWindow);this.getModalWindowScene().pushModal(e,Object.assign(Object.assign({},t),{onClose:i}))}close(){this.getModalWindowScene().closeModal()}},t.UI={newGameDialog:new s.NewGameDialog,restartGameDialog:new a.RestartGameDialog,abandonLevelDialog:new d.AbandonLevelDialog,newVersionAvailable:new o.NewVersionAvailableDialog,exportMap:new r.ExportMapDialog,loadGame:new c.LoadGameDialog,oopsMessage:new l.OopsDialog,editMapJSONDialog:new h.EditMapJSONDialog}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupController=void 0;const n=i(95);t.setupController=function(e){return void 0===e.controller?new n.SimpleButtonStateController({audio:e.audio}):null!==e.controller?e.controller:void 0}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceInfo=t.DEFAULT_CONTENT_PADDING=t.MAX_CONTENT_WIDTH=t.SMALL_SCREENSIZE_MAXWIDTH=t.ScreenSize=void 0;const n=i(113);var s;!function(e){e.Large="large",e.Small="small"}(s=t.ScreenSize||(t.ScreenSize={})),t.SMALL_SCREENSIZE_MAXWIDTH=700,t.MAX_CONTENT_WIDTH=1200,t.DEFAULT_CONTENT_PADDING=30;t.DeviceInfo=class{constructor(e){this.game=e,this.screenSize=(0,n.watchable)(s.Large),this.dpr=window.devicePixelRatio||1,this.supports={touch:e.device.input.touch},e.scale.on("resize",()=>setTimeout(()=>this.updateScreenSize(),100),this),this.updateScreenSize()}get screenWidth(){return window.innerWidth*this.dpr}get screenHeight(){return window.innerHeight*this.dpr}get contentLeft(){return this.screenWidth<=t.MAX_CONTENT_WIDTH?0:Math.trunc((this.screenWidth-t.MAX_CONTENT_WIDTH)/2)}get contentRight(){return this.screenWidth<=t.MAX_CONTENT_WIDTH?this.screenWidth:this.contentLeft+t.MAX_CONTENT_WIDTH}get contentWidth(){return Math.min(this.screenWidth,t.MAX_CONTENT_WIDTH)}isMobile(){return!this.game.device.os.desktop}updateScreenSize(){this.game.scale.displaySize.width>=t.SMALL_SCREENSIZE_MAXWIDTH?this.screenSize.set(s.Large):this.screenSize.set(s.Small)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getShadowFrameForPawnType=t.getFrameForEmojiFace=t.getFrameForTileSymbol=t.getScaleForPawnType=t.getFrameForPawnType=t.WorldObjectsPool=void 0;var n=Phaser.GameObjects.Group,s=Phaser.GameObjects.Image,a=Phaser.GameObjects.Sprite;const o=i(3),r=i(1),c=i(0),l=i(124);r.logger.for("WorldObjectPools");function d(e,t=1){return e===o.PawnType.Town?"pawns/town-"+t:"pawns/"+e}function h(e){return.5}function u(e){return"tile-symbols/"+e}function g(e){return"attitude-emoji/"+e}function p(e,t=1){return e===o.PawnType.Town?`pawns/town-${t}-shadow`:"pawn-shadow"}t.WorldObjectsPool=class{constructor(e){this.scene=e,this.coins=new n(this.scene,{defaultKey:"coin",classType:a}),this.coinStacks=new n(this.scene,{defaultKey:"atlas",defaultFrame:"coinstack",classType:s}),this.pawnImages=new n(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"pawns/villager",classType:a}),this.pawnShadows=new n(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"pawn-shadow",classType:s}),this.flags=new n(this.scene,void 0,{defaultKey:"flag",classType:a}),this.flagPoles=new n(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"flag-pole",classType:s}),this.tileSymbols=new n(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"tile-symbols/alert",classType:s}),this.emojiFaces=new n(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"attitude-emoji/22",classType:s}),this.emojiCrowns=new n(this.scene,void 0,{defaultKey:"atlas",defaultFrame:"attitude-emoji/crown",classType:s}),this.scene.anims.create({key:"wave-flag",frames:this.scene.anims.generateFrameNumbers("flag",{frames:[0,1,2,3,4,5,6,7]}),frameRate:20,repeat:-1})}updateDebugData(){c.inject.config.debug.objectPools?c.inject.debugData.set("worldObjects",`\n  coins: ${this.printGroupStats(this.coins)}\n  coinStacks: ${this.printGroupStats(this.coinStacks)}\n  pawnImages: ${this.printGroupStats(this.pawnImages)}\n  pawnShadows: ${this.printGroupStats(this.pawnShadows)}`):c.inject.debugData.clear("worldObjects")}printGroupStats(e){return`${e.getTotalUsed()}/${e.getChildren().length}`}getPawnImage(e,t){return this.getAndActivate(this.pawnImages).setFrame(d(e,t)).setScale(.5)}getPawnShadow(e,t){return this.getAndActivate(this.pawnShadows).setFrame(p(e,t)).setScale(.5)}getCoin(e,t){return this.getAndActivate(this.coins).setOrigin(.5,.57143).setPosition(e,t).setFrame(0).setScale(.5)}getCoinStack(e,t){return this.getAndActivate(this.coinStacks).setOrigin(.5,1).setScale(.5).setPosition(e,t)}getFlag(e,t){return this.getAndActivate(this.flags,e,t).setOrigin(0,0)}getFlagPole(e,t){return this.getAndActivate(this.flagPoles,e,t)}getTileSymbol(e){return this.getAndActivate(this.tileSymbols).setFrame(u(e))}getEmojiFace(e){return this.getAndActivate(this.emojiFaces).setFrame(g(e))}getEmojiCrown(){return this.getAndActivate(this.emojiCrowns)}free(e){c.inject.config.debug.objectPools&&e.setActive(!1),e.setVisible(!1)}getAndActivate(e,t,i){e.defaultFrame||e.defaultKey;const n=e.get(t,i).setVisible(!0).setActive(!0).setAlpha(1);if(c.inject.config.debug.objectPools)if("?"!==(0,l.getObjId)(n));else{(0,l.assignObjId)(n)}return n}},t.getFrameForPawnType=d,t.getScaleForPawnType=h,t.getFrameForTileSymbol=u,t.getFrameForEmojiFace=g,t.getShadowFrameForPawnType=p},function(e,t,i){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),t.TIMING=t.PawnTravelSpeed=void 0,function(e){e.Normal="normal",e.Fast="fast"}(n=t.PawnTravelSpeed||(t.PawnTravelSpeed={})),t.TIMING={pawnPickupTransition:100,pawnDropTransition:100,pawnJumpDuration:500,pawnTravelDuration:{[n.Fast]:300,[n.Normal]:600}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LazyView=t.ViewCache=void 0;i(1).logger.for("Selector");class n{constructor(e){this.parentDataSets=e}handleNewState(e){e!==this.lastState&&this.didParentDataSetsChangedInNewState(e)&&this.flush(),this.lastState=e}didParentDataSetsChangedInNewState(e){return this.parentDataSets.find(t=>{var i;return e.get(t.key)!==(null===(i=this.lastState)||void 0===i?void 0:i.get(t.key))})}flush(){this.data={}}set(e,t){this.data[e]=t}get(e){return this.data[e]}has(e){return this.data.hasOwnProperty(e)}getOrCalculate(e,t){return void 0===e?t():(this.has(e)||this.set(e,t()),this.get(e))}}t.ViewCache=n;t.LazyView=class{constructor(e){this.cache=new n(e)}get(e,t){var i;this.cache.handleNewState(e);const n=null===(i=this.getCacheKey(t))||void 0===i?void 0:i.toString();return this.cache.getOrCalculate(n,()=>this.calculate(e,t))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Arrange=t.horizontalAlign=void 0;const n=i(9);!function(e){e[e.Left=0]="Left",e[e.Middle=.5]="Middle",e[e.Right=1]="Right"}(t.horizontalAlign||(t.horizontalAlign={})),t.Arrange={fromTopToBottom(e,t){var i;const s=e.map(e=>e.height).reduce(n.sum,0);e.map(e=>e.width).reduce(n.max,0);let a=t.y-s*(null!==(i=t.originY)&&void 0!==i?i:0);for(let i of e)i.setPosition(t.x,a),a=a+i.height+t.spacing},fromLeftToRight(e,t){var i,s,a,o,r,c;const l=e.map(e=>e.height).reduce(n.max,0),d=Math.min(null!==(i=t.maxWidth)&&void 0!==i?i:Number.MAX_SAFE_INTEGER,e.map(e=>e.width).reduce(n.sum,0))+2*(null!==(s=t.padding)&&void 0!==s?s:0),h=t.x-d*(null!==(a=t.originX)&&void 0!==a?a:0)+(null!==(o=t.padding)&&void 0!==o?o:0);let u=t.y+(null!==(r=t.padding)&&void 0!==r?r:0),g=h;for(let i of e)t.maxWidth&&g-h+i.width>t.maxWidth&&(g=h,u=u+l+t.spacing),i.setPosition(g,u-i.height*(null!==(c=t.originY)&&void 0!==c?c:0)),g=g+i.width+t.spacing}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.filterPawns=t.PawnModel=void 0;const n=i(109),s=i(13),a=i(17),o=i(52),r=i(7),c=i(14),l=i(25),d=i(4);class h extends n.BaseEntityModel{get exists(){return!!a.Pawns.getPawnData(this.state,this.id)}get name(){var e;return(null===(e=a.Pawns.getPawnData(this.state,this.id))||void 0===e?void 0:e.name)||""}get type(){return a.Pawns.getPawnData(this.state,this.id).type}get count(){return a.Pawns.getPawnCount(this.state,this.id)||0}get traits(){var e;return null===(e=this.rules)||void 0===e?void 0:e.traits}get cost(){var e;return null===(e=this.rules)||void 0===e?void 0:e.cost}get upkeep(){var e;return null===(e=this.rules)||void 0===e?void 0:e.upkeep}get might(){return this.rules.might}get defense(){return this.rules.defense}get protection(){return this.hasTrait(s.PawnTraits.GuardsAdjacentTiles)?this.rules.defense:0}get rules(){return o.Rules.model(this.state).pawns(this.type)}get region(){return r.Regions.model(this.state).byHex(this.hex)}get faction(){return c.Factions.model(this.state).byHex(this.hex)}hasTrait(e){return this.traits.includes(e)}get hex(){return(0,d.getHex)(a.Pawns.getPawnHex(this.state,this.id))}replaceWith(e){const t=this.hex;return this.state=a.Pawns.replacePawn(this.state,this.id,e),this.parentModel.byHex(t,e)}isMovable(){return l.CurrentPhase.isMovable(this.state,this.id)}moveTo(e){return this.state=a.Pawns.movePawn(this.state,this.id,e.id),this}setCount(e){return this.state=a.Pawns.setPawnCount(this.state,this.id,e),this}toString(){const e=this.type+(void 0!==this.count&&1!==this.count?"Ã—"+this.count:"");return`[Pawn #${this.id} (${e} at ${this.hex})]`}destroy(){this.parentModel.destroy(this)}}t.PawnModel=h,t.filterPawns=function(e,t,i){return i.type&&(t=t.filter(e=>i.type.includes(e.type))),i.traits&&(t=t.filter(e=>i.traits.every(t=>e.hasTrait(t)))),t}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMap=void 0;const n=i(4),s=i(5),a=i(8),o=i(148),r=i(238);class c{static get(e){return(0,s.selectFromState)(e,a.GameState.map)}static getAllHexes(e){return n.HexGrid.getAllHexes(this.get(e))}static setTheme(e,t){const i=this.get(e);return(0,s.applyMutations)(e,a.GameState.map.createMutation(Object.assign(Object.assign({},i),{theme:t}),"setTheme"))}static model(e){const t=this.get(e);return this.modelFactory.getOrCreateFor(t)}}t.WorldMap=c,c.modelFactory=new o.FactoryWithCache(e=>new r.WorldMapModel(e))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BestPlanPicker=t.describePlan=t.UnitSolver=void 0;const n=i(11),s=i(58),a=i(1),o=i(59),r=i(151),c=i(0),l=i(73);a.logger.for("ai:UnitSolver");t.UnitSolver=class{constructor(e={}){this.rules=e.rules||c.inject.gameStateModel.rules,this.armyComposition=e.armyComposition||s.UNRESTRICTED_ARMY_COMPOSITION,this.economicStrategy=e.economic||o.UNRESTRICTED_ECONOMIC_ADVISOR}gather(e){if(e.requiredMight>r.MAX_UNIT_MIGHT)return;void 0===e.allowOverkill&&(e.allowOverkill=!0);const t=new d,i=e.remainingUnits.getOneWithMightAtLeast(e.requiredMight);if(i===e.requiredMight)return this._useExisting(e,i);if(t.consider(this._useExisting(e,i)),t.consider(this._buy(e)),e.requiredMight>1){let i=this.gather(Object.assign(Object.assign({},e),{requiredMight:e.requiredMight-1,allowOverkill:!1,willSacrifice:!0}));if(!i)return;let s=this.gather(Object.assign(Object.assign({},i),{requiredMight:e.requiredMight-1,allowOverkill:!1,willSacrifice:!0}));if(!s)return;const a=[...i.useUnits,...s.useUnits].sort(n.ascendingSortFn),o=s.remainingIncome+2*this.rules.unitByMight(e.requiredMight-1).upkeep-this.rules.unitByMight(e.requiredMight).upkeep;o>=this.economicStrategy.getMinimalAcceptableIncome(s)&&a.length>0&&t.consider(Object.assign(Object.assign({},s),{useUnits:a,buyUnits:[...i.buyUnits,...s.buyUnits].sort(n.ascendingSortFn),might:e.requiredMight,remainingIncome:o,attractiveness:i.attractiveness*s.attractiveness*(e.willSacrifice?1:this.armyComposition.getWillingnessToObtainUnit(e,e.requiredMight))}))}const s=t.getBestPlan();return!s||void 0!==e.minAttractiveness&&s.attractiveness<e.minAttractiveness?void 0:s}_useExisting(e,t){if(void 0===t)return;if(!e.allowOverkill&&t!==e.requiredMight)return;const i=e.requiredMight/t*(e.willSacrifice?this.armyComposition.getWillingnessToDiscardUnit(e,t):1);return{useUnits:[t],buyUnits:[],totalUnits:e.willSacrifice?e.totalUnits.withoutUnit(t):e.totalUnits,remainingUnits:e.remainingUnits.withoutUnit(t),remainingGold:e.remainingGold,remainingIncome:e.remainingIncome,might:t,attractiveness:i}}_buy(e){const t=this.rules.unitByMight(e.requiredMight),i=e.remainingGold-t.cost,n=e.remainingIncome-t.upkeep;if(!(i<0||n<this.economicStrategy.getMinimalAcceptableIncome(e)))return{useUnits:[],buyUnits:[e.requiredMight],totalUnits:e.willSacrifice?e.totalUnits:e.totalUnits.add(e.requiredMight),remainingUnits:e.remainingUnits,remainingGold:i,remainingIncome:n,might:e.requiredMight,attractiveness:(e.willSacrifice?1:this.armyComposition.getWillingnessToObtainUnit(e,e.requiredMight))*this.economicStrategy.getWillingnessToSpend(e,t.cost,t.upkeep)}}estimateBuyableMight(e){const t=Math.floor(e.remainingGold/l.CHEAPEST_UNIT_COST),i=Math.floor((e.remainingIncome-this.economicStrategy.getMinimalAcceptableIncome(e))/2);return Math.max(0,Math.min(t,i))}estimateTotalMight(e){return e.remainingUnits.getTotalMight()+this.estimateBuyableMight(e)}estimateTopAvailableMight({remainingIncome:e,remainingGold:t,remainingUnits:i,totalUnits:n}){let s=i.getStrongest();if(s===r.MAX_UNIT_MIGHT)return r.MAX_UNIT_MIGHT;let a=void 0;do{a=this.gather({remainingIncome:e,remainingGold:t,remainingUnits:i,totalUnits:n,requiredMight:s+1}),a&&++s}while(a&&s<r.MAX_UNIT_MIGHT);return s||0}getObtainableUnits(e,t=.1){return[1,2,3,4].filter(i=>{var n,s;return!!e.remainingUnits.has(i)||(null!==(s=null===(n=this.gather(Object.assign(Object.assign({},e),{requiredMight:i,allowOverkill:!1})))||void 0===n?void 0:n.attractiveness)&&void 0!==s?s:-1/0)>=t})}getObtainableUnitCount(e){return e.remainingUnits.count()+Math.floor(e.remainingGold/l.CHEAPEST_UNIT_COST)}},t.describePlan=function(e){let t="";return e.useUnits.length&&(t+=`use ${e.useUnits.join(",")}${e.buyUnits.length?" and ":""}`),e.buyUnits.length&&(t+="buy "+e.buyUnits.join(",")),t+` to obtain ${e.might} (attr ${e.attractiveness})`};class d{consider(e){e&&(!this.bestPlanSoFar||this.bestPlanSoFar.attractiveness<e.attractiveness)&&(this.bestPlanSoFar=e)}getBestPlan(){return this.bestPlanSoFar}}t.BestPlanPicker=d},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Bandits=void 0;const s=i(5),a=n(i(10)),o=i(8);t.Bandits=class{static getCampsByRegion(e,t){return(0,s.selectFromState)(e,o.GameState.bandits.campsByRegion,t)||a.default.Set()}static getNearestCampHex(e,t){var i;return null===(i=(0,s.selectFromState)(e,o.GameState.bandits.nearestCamp,t))||void 0===i?void 0:i.rootId}static getNearestCampDistance(e,t){var i;return(null===(i=(0,s.selectFromState)(e,o.GameState.bandits.nearestCamp,t))||void 0===i?void 0:i.distance)||Number.POSITIVE_INFINITY}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.regionBasedAdapter=void 0;const n=i(12),s=i(7),a=i(30),o=i(87);t.regionBasedAdapter=function(e){return{getHexes:e=>n.HexGroup.union(s.Regions.model(e).all().map(t=>n.HexGroup.fromIds(a.Economy.getTownHexesByRegion(e,t.id).concat(o.Bandits.getCampsByRegion(e,t.id)).toArray()))),getValue(t,i){const n=s.Regions.getByHex(t,i);if(void 0!==n)return e.getValue(t,n)},getDetail(t,i){const n=s.Regions.getByHex(t,i);if(void 0!==n)return e.getDetail(t,n)}}}},,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getEnemyRegionAssets=t.getMyRegionAssets=void 0,t.getMyRegionAssets=function(e){var t;return{remainingIncome:(null===(t=e.budget)||void 0===t?void 0:t.balance)||0,remainingGold:e.treasury,remainingUnits:e.getMovableUnitsByMight(),totalUnits:e.getUnitsByMight()}},t.getEnemyRegionAssets=function(e){var t,i;const n=e.treasury-((null===(t=e.budget)||void 0===t?void 0:t.upkeep)||0);return{remainingIncome:(null===(i=e.budget)||void 0===i?void 0:i.balance)||0,remainingGold:Math.max(n,0),remainingUnits:e.getUnitsByMight(),totalUnits:e.getUnitsByMight()}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.createAiViews=t.SituationExplorer=void 0;const s=i(0),a=i(1),o=i(3),r=i(171),c=i(18),l=i(9),d=i(172),h=i(173),u=i(24),g=i(17);a.logger.for("ai:SituationExplorer");function p(e){const t=new d.ThreatAssessment(e.faction,e.advisors);return{threatAssessment:t,exposedHexes:new r.ExposedHexes(e.region,t),tacticalPotential:null}}t.SituationExplorer=class{constructor(e){this.context=e,this.situationStack=[];const t=p(e);this.situationStack=[Object.assign(Object.assign({label:"start"},e.game.createCheckpoint()),{score:-1e3,views:t})],this.bestOutcomeSoFar=this.situationStack[0]}tryBest(e){return n(this,void 0,void 0,(function*(){let t=!1;const i=new h.CompositePlanner({allowedTactics:e}),n=i.generatePlans(this.context,this.currentSituation.views);let s;do{if(s=n.next().value,!s)return!1;yield this.context.breakpoint("ai:next-plan: "+s,()=>({debugLayer:i.getDebugLayer(),hexes:s.hex})),t=s.execute(this.context)}while(!t);return this.addSituation(s.constructor.name),yield this.context.breakpoint("ai:plan-completed score "+this.currentSituation.score,()=>({debugLayer:this.currentSituation.views.exposedHexes.getDebugLayer(50),hexes:s.hex})),!0}))}get currentSituation(){return this.situationStack[this.situationStack.length-1]}backtrack(e=1){const t=this.situationStack[0].score,i=this.situationStack[this.situationStack.length-1].score;if(i<=t)this.goTo(this.situationStack[0]);else{const n=i-(i-t)/e,s=this.situationStack.find(e=>e.score>=n);this.situationStack.splice(this.situationStack.indexOf(s)+1),this.context.game.restoreCheckpoint(s)}}goToBestOutcomeSoFar(){this.goTo(this.bestOutcomeSoFar)}goTo(e){this.context.game.restoreCheckpoint(e),this.updateDebugData();const t=this.situationStack.indexOf(e);-1!==t?this.situationStack=[e]:this.situationStack.splice(t+1)}addSituation(e){const t=p(this.context),i=this.appraiseCurrentSituation(t),n=Object.assign(Object.assign({},this.context.game.createCheckpoint()),{score:i,label:e,views:t});this.situationStack.push(n),this.updateDebugData()}considerCurrentSituation(){this.currentSituation.score>this.bestOutcomeSoFar.score&&(this.bestOutcomeSoFar=this.currentSituation)}updateDebugData(){s.inject.debugData.set("SituationExplorer","\n"+this.situationStack.map(e=>` - ${e.label}(${this.getRelativeScore(e.score)})`).join("\n")+`\nWinner: ${this.bestOutcomeSoFar.label}(${this.getRelativeScore(this.bestOutcomeSoFar.score)})`)}getRelativeScore(e){return e-this.situationStack[0].score}appraiseCurrentSituation(e){const t=this.getEnemyPowerScore(),i=this.getMyPowerScore(),n=this.getSafetyPenalty(e);return Math.floor(i-t-n)}getEnemyPowerScore(){return this.context.game.model.factions.all().filter(e=>e.controller!==o.FactionController.None&&e!==this.context.faction&&this.context.advisors.political.getHostilityTowardsFaction(e)>1).map(e=>({factionId:e.id,score:e.power})).map(e=>e.score).reduce(l.sum,0)}getMyPowerScore(){return 3*this.context.faction.power}getSafetyPenalty(e){return e.exposedHexes.get(50).map(t=>{var i;const n=(null===(i=c.AI.getHexImportance(this.context.game.currentState,t.id))||void 0===i?void 0:i.value)||0,s=u.Warfare.getHexDefense(this.context.state,t);let a=e.threatAssessment.get(t.id).riskByMight[s]||0;return g.Pawns.model(this.context.state).presentAtHex(t,o.PawnType.Town)&&(a*=2),n*a}).reduce(l.max,0)}isSafe(){return 0===this.getSafetyPenalty(this.currentSituation.views)}},t.createAiViews=p},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Planners=void 0;const n=i(292);t.Planners={Default:new n.DefaultPlanner}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UiDebugLayer=t.getDebugRect=t.DebugColors=void 0;var n,s=Phaser.GameObjects.Line,a=Phaser.GameObjects.Rectangle;function o(e,t,i,n,s,o=255){const r=new a(e,t,i,n,s).setStrokeStyle(1,o,1);return r.setOrigin(0,0),r.setPosition(t,i),r}!function(e){e[e.blue=255]="blue",e[e.green=65280]="green",e[e.red=16711680]="red"}(n=t.DebugColors||(t.DebugColors={})),t.getDebugRect=o;t.UiDebugLayer=class{constructor(e,t){this.scene=e,this.objects=[],this.target=t||{add:e=>this.scene.add.existing(e)}}clear(){return this.objects.forEach(e=>e.destroy()),this}addRect(e,t,i,s,a=n.blue){const r=o(this.scene,e,t,i,s,a);return this.target.add(r),this.objects.push(r),this}addRectAround(e,t=n.blue){return this.addRect(e.x,e.y,e.width,e.height,t),this}addHorizontalLine(e,t=n.blue){const i=this.scene.cameras.main,a=new s(this.scene,0,0,i.x,e,i.x+i.width,e,t).setStrokeStyle(1,t).setOrigin(0,0);return this.target.add(a),this}addVerticalLine(e,t=n.blue){const i=this.scene.cameras.main,a=new s(this.scene,0,0,e,i.y,e,i.y+i.height,t).setStrokeStyle(1,t).setOrigin(0,0);return this.target.add(a),this}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoxButton=void 0;const n=i(44),s=i(22),a=i(28),o=i(78);class r extends s.BaseResponsiveContainer{constructor(e,t,i,s){super(e),this.props=s,this._state=n.ButtonState.Rest,this.button=new a.Box(this.scene,s.baseTexture,0,0,s.width,s.height),this.button.setInteractive(),this.setSize(s.width,s.height),s.content.setOrigin(.5,.5),s.buttonTint&&this.button.setTint(s.buttonTint),this.add([this.button,this.props.content]),this.setPosition(t,i),this.setController((0,o.setupController)(s))}set buttonState(e){this._state=e,this.preUpdate.makeDirty()}get buttonState(){return this._state}setEnabled(e){this.controller.setEnabled(e)}get onClicked(){return this.controller.onClicked}setController(e){e&&(this.controller=e,e.bindTo(this.button,e=>this.buttonState=e))}setTint(e,t){return this.button.setTint(t),this.props.content.setTint(e),this}updateLayout(){var e,t,i,s;let a=Math.round(this.button.width/2+(null!==(t=null===(e=this.props.contentOffset)||void 0===e?void 0:e.x)&&void 0!==t?t:0)),o=Math.round(this.button.height/2+(null!==(s=null===(i=this.props.contentOffset)||void 0===i?void 0:i.y)&&void 0!==s?s:0));this.buttonState===n.ButtonState.Down&&(a+=2,o+=2),this.button.setTexture(this.props.downTexture&&this.buttonState===n.ButtonState.Down?this.props.downTexture:this.props.baseTexture),this.props.content.setPosition(a,o)}}t.BoxButton=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleButtonStateController=void 0;const n=i(27),s=i(0),a=i(31),o=i(44);t.SimpleButtonStateController=class{constructor(e){this.options=e,this.enabled=!0,this.state=o.ButtonState.Rest,this.onClicked=(0,n.signal)()}getState(){return this.state}bindTo(e,t){this.applyState=t,e.removeAllListeners(),e.on("pointerover",()=>{this.state===o.ButtonState.Rest&&this.setState(o.ButtonState.Hover)}).on("pointerout",()=>{this.enabled?this.setState(o.ButtonState.Rest):this.setState(o.ButtonState.Disabled)}).on("pointerdown",()=>{this.enabled?(this.setState(o.ButtonState.Down),this.playSoundEffect(a.SoundEffects.ButtonDown)):this.playSoundEffect(a.SoundEffects.Deny)}).on("pointerup",()=>{this.enabled&&(this.setState(o.ButtonState.Hover),this.playSoundEffect(a.SoundEffects.ButtonUp),this.onClicked.fire())})}playSoundEffect(e){!1!==this.options.audio&&s.inject.audio.playEffect(e)}setState(e){e!==this.state&&(this.state=e,this.applyState(e))}setEnabled(e){this.enabled=e,this.setState(e?o.ButtonState.Rest:o.ButtonState.Disabled)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Column=void 0;const n=i(0),s=i(9),a=i(43);class o extends a.CompositeUiElement{constructor(e,t={spacing:0},i=[]){super(e),this.props=t,this.add(...i)}updateLayout(){const e=this.members.reduce((e,t)=>e+t.height,0)+(this.props.spacing*this.members.length-1),t=this.members.map(e=>e.width).reduce(s.max);let i=0;for(let e of this.members)e.setPosition(0,i),i+=e.height+this.props.spacing;return n.inject.config.debug.uiLayout&&(this.debugLayer.clear(),this.members.forEach(e=>this.debugLayer.addRectAround(e))),{width:t,height:e}}}t.Column=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageButton=void 0;const n=i(44);var s=Phaser.GameObjects.Image;t.ImageButton=class extends s{constructor(e,t,i,s){super(e,t,i,"atlas",s.frame),this.config=s,this.setInteractive({cursor:"pointer"}),void 0===s.controller?this.setController(n.ButtonControllers.simple()):null!==s.controller&&this.setController(s.controller)}setController(e){this.controller=e,e.bindTo(this,e=>this.setButtonState(e))}setBaseFrame(e){this.config.frame=e,this.setButtonState(this.controller.getState())}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}setButtonState(e){switch(e){case n.ButtonState.Rest:this.setFrame(this.config.frame);break;case n.ButtonState.Disabled:this.setFrame(this.config.frame+(this.config.disabled?"-disabled":""));break;case n.ButtonState.Hover:this.setFrame(this.config.frame+(this.config.hover?"-hover":""));break;case n.ButtonState.Down:this.setFrame(this.config.frame+(this.config.down?"-down":""))}}}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.assertPrefixValid=t.decodeGameState=t.encodeGameState=void 0;const s=i(8),a=n(i(135)),o=`konkrmap.v${s.CORE_GAMESTATE_SCHEMA_VERSION}.`;function r(e){if(!e.startsWith(o))throw new Error(`Invalid save data: "${e.substring(0,50)}..." does not start with ${o}`)}t.encodeGameState=function(e){const t=JSON.stringify(e),i=a.default.compress(t,{inputEncoding:"String",outputEncoding:"Base64"});return`${o}${i}`},t.decodeGameState=function(e){r(e);const t=e.substring(o.length),i=a.default.decompress(t,{inputEncoding:"Base64",outputEncoding:"String"}).toString();return JSON.parse(i)},t.assertPrefixValid=r},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.KineticValue=t.KineticValuePhase=void 0;const s=i(1),a=i(9);s.logger.for("KineticValue");var o;!function(e){e.Frozen="frozen",e.Sliding="sliding",e.Tweening="tweening",e.Stable="stable"}(o=t.KineticValuePhase||(t.KineticValuePhase={}));t.KineticValue=class{constructor(e,t){this.value=e,this.speed=0,this.phase=o.Stable,this.continueToNextStopThreshold=100,this.min=-99999,this.max=99999,this.drag=t.drag,void 0!==t.min&&(this.min=t.min),void 0!==t.max&&(this.max=t.max),t.continueToNextStopThreshold&&(this.continueToNextStopThreshold=t.continueToNextStopThreshold),this.stops=Array.isArray(t.stops)?new r(t.stops):t.stops,this.apply=t.apply,this.scene=t.scene,this.apply(this.value)}accelerate(e){this.phase!==o.Frozen&&(this.cancelSnap(),this.phase=o.Sliding,this.speed+=e)}cancelSnap(){this.tween&&(this.tween.stop(),this.tween=void 0),this.targetStop=void 0,this.phase===o.Tweening&&(this.phase=o.Sliding)}freeze(){this.phase=o.Frozen,this.targetStop=void 0}unfreeze(){this.phase=o.Sliding,this.speed=0}pushToNextStop(){var e;if(this.cancelSnap(),this.unfreeze(),this.targetStop=null===(e=this.stops)||void 0===e?void 0:e.getNextFrom(this.value+.001),void 0!==this.targetStop){const e=l(this.value,this.targetStop,this.drag);this.accelerate(e)}}pushToPrevStop(){var e;if(this.cancelSnap(),this.unfreeze(),this.targetStop=null===(e=this.stops)||void 0===e?void 0:e.getPreviousFrom(this.value-.001),void 0!==this.targetStop){const e=l(this.value,this.targetStop,this.drag);this.accelerate(e)}}pushTo(e){this.cancelSnap(),this.unfreeze();const t=l(this.value,e,this.drag);this.accelerate(t)}update(e,t){const i=t/1e3,n=this.drag*i;switch(this.phase){case o.Tweening:return this.value=this.tween.getValue(),void this.apply(this.value);case o.Stable:case o.Frozen:return;case o.Sliding:if(this.stops&&(void 0===this.targetStop&&(this.targetStop=function(e,t,i,n,s){const a=s.getPreviousFrom(e-.001),o=s.getNextFrom(e+.001),r=h(s,e),c=d(e,t,n,0);if(Math.abs(t)>i){const e=h(s,c);return t>0?e===r&&o||e:e===r&&a||e}return r}(this.value,this.speed,this.continueToNextStopThreshold,this.drag,this.stops)),void 0!==this.targetStop)){const e=l(this.value,this.targetStop,this.drag);if(this.speed||this.targetStop!==this.value)if(this.speed<e){const t=e-this.speed;this.speed+=Math.min(t,this.drag*i*2)}else if(this.speed>e){const t=this.speed-e;this.speed-=Math.min(t,this.drag*i*2)}}if(this.speed){d(this.value,this.speed,this.drag,n)}this.speed>0?this.speed-=(0,a.min)(this.speed,n):this.speed<0&&(this.speed+=(0,a.min)(-this.speed,n)),Math.abs(this.speed)<.001&&(void 0===this.targetStop||Math.abs(this.value-this.targetStop)<1)?(this.phase=o.Stable,this.speed=0,this.targetStop&&(this.value=this.targetStop)):this.value+=this.speed*i,this.applyHardLimits(),this.apply(this.value)}}tweenTo(e,t,i){return n(this,void 0,void 0,(function*(){return this.cancelSnap(),this.phase=o.Tweening,new Promise(n=>{this.tween=this.scene.tweens.addCounter({from:this.value,to:e,duration:t,ease:i,onComplete:()=>{this.apply(e),this.phase=o.Stable,this.tween=void 0,n()}})})}))}applyHardLimits(){this.value<this.min&&(this.value=this.min),this.value>this.max&&(this.value=this.max)}setTo(e){this.cancelSnap(),this.speed=0,this.value=e,this.applyHardLimits(),this.apply(e)}};class r{constructor(e){this.stops=e}getNextFrom(e){if(0!==this.stops.length)return this.stops.find(t=>t>=e)}getPreviousFrom(e){if(0!==this.stops.length)return this.stops.slice().reverse().find(t=>t<=e)}}let c=0;function l(e,t,i){const n=Math.abs(e-t),s=e>t?-1:1;return Math.sqrt(2*n*i)*s}function d(e,t,i,n){const s=t>0?1:-1,a=Math.abs(t)-n/2,o=e+a*a/(2*i)*s;return o!==c&&(c=o),o}function h(e,t){const i=e.getPreviousFrom(t),n=e.getNextFrom(t);if(void 0===i)return n;if(void 0===n)return i;return Math.abs(t-i)>Math.abs(t-n)?n:i}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionBasedIsoRenderer=void 0;const n=i(126),s=i(14);t.FactionBasedIsoRenderer=class{constructor(e,t,i){this.scene=e,this.renderer=t,this.recipe=i,this.groupByFaction={},this.groupByHex={}}postProcess(e,t){}redrawFaction(e){const t=this.groupByFaction[e.id];t&&(t.clear(),delete this.groupByFaction[e.id]);const i=e.hexes.filter(t=>this.shouldIncludeHex(e,t));if(i.length>0){const t=this.getFactionGroup(e);i.forEach(e=>this.groupByHex[e.id]=t),t.addHexes(i),t.update()}}clear(){Object.values(this.groupByFaction).forEach(e=>e.clear()),this.groupByFaction={},this.groupByHex={}}redrawHexes(e,t){const i=new Set;t.forEach(t=>{const n=this.groupByHex[t.id],a=s.Factions.model(e).byHex(t),o=a&&this.getFactionGroup(a);n&&n!==o&&n.removeHexes(t),o?(this.groupByHex[t.id]=o,this.shouldIncludeHex(a,t)?o.addHexes(t):o.removeHexes(t)):delete this.groupByHex[t.id],o&&i.add(o),n&&i.add(n)}),i.forEach(e=>e.update())}getFactionGroup(e){return void 0===this.groupByFaction[e.id]&&(this.groupByFaction[e.id]=new n.IsoTileGroup(this.renderer,this.recipe,this.postProcess.bind(this,e))),this.groupByFaction[e.id]}syncWithModel(e){this.clear(),e.factions.all().forEach(e=>this.redrawFaction(e))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseWorldMapMode=void 0;const n=i(1),s=i(0);n.logger.for("BaseWorldMapMode");t.BaseWorldMapMode=class{constructor(){this.name=this.constructor.name,this.rendersEverything=!1,this.handlesPointerEvents=!1,this.zoomWithScrollWheel=!1,this.scene=s.inject.scene.worldMap}activate(){}deactivate(){}onSyncState(e){}onResize(){}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.handleHexCaptured=t.updateCapturedHex=t.clearCapturedHex=void 0;const s=i(0),a=i(3),o=i(12),r=i(7),c=i(11),l=i(4),d=i(55),h=i(25),u=i(368),g=i(9);function p(e,t){const i=t.capturedHexId;t.retreat?(e.worldMapScene.tileSymbols.remove((0,l.getHex)(i),d.TileSymbol.Alert),e.worldMapScene.pawns.move(i,t.retreat.destinationHexId)):t.destroyedPawns.length>0&&e.worldMapScene.pawns.destroy(i)}function m(e,t){var i;const n=t.capturedHexId,d=(0,c.stripDuplicatesFrom)([t.newRegionId,t.originalRegionId,...t.additionalConnectedHexes.map(({fromRegionId:e})=>e),...t.additionalConnectedHexes.map(({toRegionId:e})=>e)]),p=r.Regions.model(t.state),m=d.map(e=>p.byId(e)).filter(g.isDefined),f=o.HexGroup.fromIds(t.additionalConnectedHexes.map(e=>e.hexes).flat());h.CurrentPhase.model(t.state).isLocalPlayerTurn();e.worldMapScene.regions.refreshHexes(t.state,(0,l.getHex)(n)),e.worldMapScene.regions.greenRenderer.redrawRegions(t.orphanedRegions.map(e=>r.Regions.model(t.state).byId(e))),e.worldMapScene.regions.greenRenderer.redrawHexes(t.state,f),d.includes(null===(i=s.inject.ui.selectedRegion())||void 0===i?void 0:i.id)&&e.worldMapScene.selectedRegionHighlight.refresh(),e.worldMapScene.tiles.syncWithModel(s.inject.gameStateModel,o.HexGroup.union([(0,l.getHex)(n),f,f.neighbours()])),e.uiScene.updateSelectedRegionFromGameState(t.state),e.uiScene.updatePowerBalanceFromGameState(t.state),s.inject.ui.regionsLedger.refreshAvailableRegions(t.state),u.AlertSymbolsUpdater.afterHexCaptured(e,t),m.forEach(t=>{var i;(null===(i=null==t?void 0:t.faction)||void 0===i?void 0:i.controller)===a.FactionController.LocalUser&&(e.refreshTownFlagsAndBacklightInRegion(t),e.setPawnsJumpingInRegion(t,!0))}),e.refreshTownVariantInRegions(m)}t.clearCapturedHex=p,t.updateCapturedHex=m,t.handleHexCaptured=function(e,t){return n(this,void 0,void 0,(function*(){yield p(e,t),yield m(e,t)}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PlayMode=void 0;const s=i(0),a=i(189),o=i(70),r=i(372),c=i(31),l=i(6),d=i(3),h=i(2),u=i(1),g=i(13),p=i(128),m=i(55),f=i(12),y=i(127),v=i(60),w=i(81),b=i(102),S=i(73),x=u.logger.for("ui:PlayMode");class P extends o.BaseMode{constructor(){super(...arguments),this.autoAttackUnit=void 0}activate(){this.scene.showWorldMapOverlaysBasedOnSelectedRegion()}canPickupPawn(e){return!!this.getMovablePawnAtHex(e)||!!this.getRichTownAtHex(e)}canSelectHex(e){return!0}getRichTownAtHex(e){const t=s.inject.gameStateModel.regions.byHex(e);if(t&&t===s.inject.ui.selectedRegion()&&!((t.treasury||0)<S.CHEAPEST_UNIT_COST))return!!s.inject.gameStateModel.pawns.byHex(e,d.PawnType.Town)}handlePickupPawn(e){const t=this.getMovablePawnAtHex(e),i=this.getRichTownAtHex(e);if(t)s.inject.audio.playEffect(c.SoundEffects.Grab),this.scene.setMode(new a.MovingPawnMode(this.scene,t));else{if(!i)throw Error(`Unable to pickup pawn at ${e}.`);s.inject.audio.playEffect(c.SoundEffects.Grab),this.scene.uiScene.grabPawnFromTown(d.PawnType.Villager,e),this.scene.setMode(new r.BuyingPawnMode(this.scene,d.PawnType.Villager))}}handleSelectHex(e){var t;const i=s.inject.gameStateModel.regions.byHex(e),n=s.inject.ui.selectedRegion();n&&(null===(t=this.scene.conquerableHexes)||void 0===t?void 0:t.contains(e))?(this.findAutoAttacker(e),this.autoAttackUnit?(s.inject.audio.playEffect(c.SoundEffects.Drop),s.inject.gameStateController.executePlay(l.Plays.AttackHex({pawnId:this.autoAttackUnit.id,destinationHexId:e.id}))):x.warning(`hex ${e} highlighted as conquerable but could not find any suitable attacker unit`)):(0,y.isRegionControllable)(i)?i!==n&&this.scene.selectRegion(i):(null==i?void 0:i.isAlive())?this.scene.selectRegion(i):this.scene.selectRegion(void 0)}handleHexCaptured(e){var t,i;return n(this,void 0,void 0,(function*(){if(e.capturingPawnId!==(null===(t=this.autoAttackUnit)||void 0===t?void 0:t.id))return void x.warning(`Ignoring unexpected hexCaptured event during PlayMode (expected capturingPawnId to be ${null===(i=this.autoAttackUnit)||void 0===i?void 0:i.id}, but was ${e.capturingPawnId}`);yield(0,b.clearCapturedHex)(this.scene,e),e.originatingHexId&&(this.clearAutoAttacker(),this.scene.worldMapScene.pawns.move(e.originatingHexId,e.capturedHexId,w.PawnTravelSpeed.Fast),this.scene.worldMapScene.pawns.stopJumping([e.capturedHexId]));const n=(0,v.mergeTransactions)(e.lootTransactions||{},e.boughtPawnTransactions||{});n&&this.scene.worldMapScene.coins.cinematics.transactions(n).play(),yield(0,b.updateCapturedHex)(this.scene,e),this.clearAutoAttacker()}))}handlePickupPawnFromShop(e){this.scene.uiScene.grabPawnFromShop(e),this.scene.setMode(new r.BuyingPawnMode(this.scene,e))}getMovablePawnAtHex(e){return s.inject.gameStateModel.pawns.byHex(e).find(e=>s.inject.gameStateModel.currentPhase.isMovable(e))}handleNewHexUnderCursor(e){var t;const i=s.inject.ui.selectedRegion();if(s.inject.game.device.input.touch)this.clearAutoAttacker();else if(e&&this.getMovablePawnAtHex(e))this.scene.worldMapScene.pawns.setHangingPawn(e.id),this.scene.input.setDefaultCursor("pointer"),this.clearAutoAttacker();else if(i&&e&&(null===(t=this.scene.conquerableHexes)||void 0===t?void 0:t.contains(e)))this.scene.input.setDefaultCursor("pointer"),this.scene.worldMapScene.pawns.clearHangingPawn(),this.findAutoAttacker(e);else{this.scene.worldMapScene.pawns.clearHangingPawn();const t=e&&s.inject.gameStateModel.regions.byHex(e);t&&t!==i&&t.isAlive()?this.scene.input.setDefaultCursor("pointer"):this.scene.input.setDefaultCursor("default"),this.clearAutoAttacker()}}findAutoAttacker(e){const t=s.inject.ui.selectedRegion(),i=s.inject.gameStateModel,n=i.factions.byHex(e)===i.currentPhase.faction?0:i.warfare.getHexDefense(e)+1;h.assert.defined(t);const a=t.getMovableUnitsByMight().getOneWithMightAtLeast(n);if(!a)return x.warning(`incorrectly thought I could conquer hex ${e} - is among conquerable hexes but i cannot gather ${n}  might from ${t}`),this.clearAutoAttacker();const o=i.pawns.findClosest(e,t.hexes,e=>e.hasTrait(g.PawnTraits.Unit)&&e.isMovable()&&e.might===a);return o?(this.scene.worldMapScene.conquerableHexesHighlight.setHighlightedHex(e,o.type),this.scene.worldMapScene.tileSymbols.clear(m.TileSymbol.Arrow),this.scene.worldMapScene.tileSymbols.add(o.hex,m.TileSymbol.Arrow),this.setAutoAttacker(o,e)):(x.warning(`failed to locate unit with might ${a} in the region => RegionMight projection appears to contain invalid data! `),this.clearAutoAttacker())}setAutoAttacker(e,t){this.autoAttackUnit=e}clearAutoAttacker(){this.scene.worldMapScene.conquerableHexesHighlight.clearHighlightedHex(),this.scene.worldMapScene.tileSymbols.clear(m.TileSymbol.Arrow)}resume(){}handlePawnMoved(e){const t=Object.create(null,{handlePawnMoved:{get:()=>super.handlePawnMoved}});return n(this,void 0,void 0,(function*(){yield t.handlePawnMoved.call(this,e),e.mergedWith&&this.scene.showConquerableHexesBasedOnSelectedRegion()}))}handleEndTurn(){this.scene.worldMapScene.tileSymbols.clear(m.TileSymbol.Alert),this.scene.watchedHexes=f.HexGroup.union(s.inject.gameStateModel.currentPhase.faction.getRegions().filter(e=>e.isAlive()).map(e=>e.hexes)),s.inject.gameStateController.executePlay(l.Plays.EndTurn()),this.scene.setMode(new p.SpectatorMode(this.scene))}}t.PlayMode=P},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LARGE_PLAY_UI_LAYOUT=void 0;const n=i(35);t.LARGE_PLAY_UI_LAYOUT={regionPanel:{width:354,height:300,collapsedOffsetFromBottom:52,expandedOffsetFromBottom:96,nextRegionButtonOffsetFromTop:42},spectatorPanel:{width:418,height:300,collapsedOffsetFromBottom:26,expandedOffsetFromBottom:70,padding:10,centerLineOffsetFromTop:34},shoppingTray:{pawnsVerticalOffset:46,pawnsSpacing:60,width:354,style:n.ShoppingTrayStyle.Elaborate,openOffsetFromBottom:154,closedOffsetFromBottom:0,panelTransitionsDuration:500},primaryButtons:{offsetFromMainPanel:12,offsetFromBottom:6},panelTransitionsDuration:500}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RibbonButton=t.RibbonButtonStyle=void 0;const n=i(53),s=i(95),a=i(44),o=i(22),r=i(78);t.RibbonButtonStyle={Small:{base:n.RibbonTexture.SmallButton,down:n.RibbonTexture.SmallButtonDown},Medium:{base:n.RibbonTexture.MediumButton,down:n.RibbonTexture.MediumButtonDown},Dialog:{base:n.RibbonTexture.DialogButton,down:n.RibbonTexture.DialogButtonDown}};class c extends o.BaseResponsiveContainer{constructor(e,t,i,o){super(e),this.props=o,this._state=a.ButtonState.Rest,this.button=new n.Ribbon(this.scene,o.type.base,0,0,o.width),this.button.setInteractive(),this.setSize(this.props.width,o.type.base.height),o.content.setOrigin(.5,.5),o.buttonTint&&this.button.setTint(o.buttonTint),this.add([this.button,this.props.content]),o.icon&&this.add(o.icon),this.setPosition(t,i),this.setController((0,r.setupController)(o)),void 0===o.controller?this.setController(new s.SimpleButtonStateController({audio:this.props.audio})):null!==o.controller&&this.setController(o.controller)}set buttonState(e){this._state=e,this.preUpdate.makeDirty()}get buttonState(){return this._state}setEnabled(e){this.controller.setEnabled(e)}get onClicked(){return this.controller.onClicked}setController(e){e&&(this.controller=e,e.bindTo(this.button,e=>this.buttonState=e))}setTint(e,t){return this.button.setTint(t),this.props.content.setTint(e),this}updateLayout(){var e,t,i,n,s,o;let r=this.button.width/2+(this.props.icon?this.props.icon.width/2:0),c=this.button.height/2;this.buttonState===a.ButtonState.Down&&(r+=2,c+=2),null===(e=this.props.icon)||void 0===e||e.setPosition((null===(t=this.props.icon)||void 0===t?void 0:t.width)/2+16,c),this.button.setTexture(this.props.type.down&&this.buttonState===a.ButtonState.Down?this.props.type.down:this.props.type.base),this.props.content.setPosition(r+(null!==(n=null===(i=this.props.contentOffset)||void 0===i?void 0:i.x)&&void 0!==n?n:0),c+(null!==(o=null===(s=this.props.contentOffset)||void 0===s?void 0:s.y)&&void 0!==o?o:0))}}t.RibbonButton=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StateContainer=void 0;i(1).logger.for("StateContainer");t.StateContainer=function(e,t){let i=t;function n(){return i}return n.update=t=>{const n=Object.assign(Object.assign({},i),t);e.applyState(t,n,i),i=n},n}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PreviewMode=void 0;const n=i(101);class s extends n.BaseWorldMapMode{constructor(){super(...arguments),this.handlesPointerEvents=!1,this.rendersEverything=!0}onSyncState(e){super.onSyncState(e),this.scene.cameraController.center()}onResize(){this.scene.cameraController.center()}}t.PreviewMode=s},,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseEntityModel=void 0;const n=i(51),s=i(2);class a extends n.BaseModel{constructor(e,t){super(),this.parentModel=e,s.assert.defined(t),this.id=t}updateFrom(e){return this.parentModel.state=e,this}get state(){return this.parentModel.state}set state(e){this.parentModel.state=e}}t.BaseEntityModel=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.THEMES=void 0,t.THEMES={default:{colors:[29184,14393427,5939244,14382416,8347466,6052185]},grounded:{colors:[29184,5939244,9019436,8421376,7101779,5066061]},highContrast:{colors:[13385760,28876,29184,14532608,12303291,13582480]}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timing=t.Timing=void 0;i(1).logger.for("timing");class n{start(e){performance.now();return{complete:e=>{performance.now()}}}}t.Timing=n,t.timing=new n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.captureHex=t.executeAttackHex=void 0;const n=i(6),s=i(84),a=i(13),o=i(2),r=i(4),c=i(0),l=i(273);function d(e,t,i){const r=c.inject.gameStateModel;o.assert.defined(e);const d=r.regions.byHex(e);o.assert.defined(d),o.assert.defined(t);let h=void 0;const u=i instanceof s.PawnModel?i.hex:void 0,g=d.isAlive(),p=function(){if(!(r.warfare.getHexStaticDefense(e)>0))return;const t=r.pawns.findOne({hexes:e,traits:[a.PawnTraits.Unit]});if(!t)return;const i=r.warfare.getRetreatDestination(t,u);return i?(t.moveTo(i),{pawnId:t.id,destinationHexId:i.id}):void 0}(),m=r.economy.loot(e,t),f=r.pawns.byHex(e),y=f.map(e=>e.type);r.pawns.destroy(...f),t.addHexes(e),i instanceof s.PawnModel||(h=r.economy.payForNewPawn(e,i));let v=r.factions.byHex(e).absorbOwnRegionsAdjacentTo(e).map(e=>({fromRegionId:e.originalRegionId,toRegionId:t.id,hexes:e.hexes.members.map(e=>e.id)}));const w=d.faction.splitRegionIfDisconnected(d),b=[d,...w].filter(e=>!e.isAlive());return i instanceof s.PawnModel?i.moveTo(e):i=r.pawns.create({type:i,hex:e}),r.currentPhase.tapPawn(i),c.inject.ai.dataLayer.onHexConquered({model:r,attackerFaction:t.faction,destroyedPawns:y,victimRegions:[d,...w],regionWasAlive:g}),[n.GameEvents.HexCaptured({state:r.state,capturedHexId:e.id,additionalConnectedHexes:v,capturingPawnId:i.id,capturingPawnType:i.type,capturingFactionId:t.faction.id,lootTransactions:m,boughtPawnTransactions:h,destroyedPawns:f.map(e=>e.id),orphanedRegions:g?b.map(e=>e.id):[],newRegionId:t.id,originalRegionId:d.id,originatingHexId:null==u?void 0:u.id,retreat:p}),...(0,l.checkWinConditions)(r)]}t.executeAttackHex=function(e,t){const i=(0,r.getHex)(t.destinationHexId),n=e.pawns.byId(t.pawnId);o.assert.defined(i),o.assert.defined(n);const s=e.regions.byHex(n.hex);return o.assert.defined(s),d(i,s,n)},t.captureHex=d},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.deepWatchable=t.watchable=void 0;const s=n(i(282)),a=i(11);t.watchable=function(e){let t=e,i=void 0,n=[];function s(){return t}return s.get=()=>t,s.set=e=>{t!==e&&(t=e,n.forEach(e=>e(t,i)),i=t)},s.watch=e=>{const i=s.watchFuture(e);return setTimeout(()=>e(t,void 0),0),i},s.watchFuture=e=>(n.push(e),{unsubscribe:()=>(0,a.removeFromArrayInPlace)(n,e)}),s},t.deepWatchable=function(e){let t=(0,s.default)(e,a),i=e,n=[];function a(){n.forEach(e=>e(t,i)),i=t}function o(){return t}return o.watch=function(e){n.push(e),e(t,void 0)},o.watchFuture=function(e){n.push(e)},new Proxy(o,{get:(e,i,n)=>o.hasOwnProperty(i)?o[i]:t[i]})}},,,function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.selectStrategy=t.AIController=t.MIN_WAR_SUPPORT_THRESHOLD=void 0;const s=i(0),a=i(1),o=i(288),r=i(290),c=i(295),l=i(18),d=i(14),h=i(3),u=i(174),g=i(296),p=a.logger.for("ai:controller");t.MIN_WAR_SUPPORT_THRESHOLD=15;var m;function f(e){var i;const n=e.parentModel.state,a=e.faction,o=d.Factions.model(n),f=[],y=o.all().filter(e=>e.controller!==h.FactionController.None&&e!==a).filter(t=>l.AI.getFactionInfluenceByRegion(n,t.id,e.id).proximity<=3),v=(0,c.getDominantFaction)(n);y.forEach(t=>{const i=l.AI.getRegionAttrition(n,e.id,t.id),o=-l.AI.getFactionApproval(n,a.id,t.id),r=s.inject.views.fear.getComponents(n,{fromFactionId:a.id,towardsFactionId:t.id}),c=v.faction===t?r.fear.fearOfFactionDomination:0;p.debug(`Eval against ${t.id}? \n fightBack ${i}, punish ${o}, stop ${c}\n fear ${r.fear.totalFear}, 1 from gangUpBonus`),i>0&&f.push({factionId:t.id,reason:m.FightBack,strength:Math.floor(1*i),desperation:r.fear.totalFear}),o>0&&f.push({factionId:t.id,reason:m.Punish,strength:Math.floor(1*o),desperation:r.fear.totalFear/2}),c>=20&&f.push({factionId:t.id,reason:m.StopFromWinning,strength:Math.floor(1*c),desperation:r.fear.totalFear/2})}),f.sort((e,t)=>t.strength-e.strength);const w=Math.max(f.filter(e=>e.strength>=t.MIN_WAR_SUPPORT_THRESHOLD).map(e=>e.desperation).reduce((e,t)=>Math.max(e,t),0)),b=(null===(i=f[0])||void 0===i?void 0:i.strength)||0,S=new Map;return y.forEach(e=>{const t=Math.min(100,Math.max(0,-l.AI.getFactionApproval(n,a.id,e.id))),i=f.filter(t=>t.factionId===e.id).reduce((e,t)=>Math.max(e,t.strength),t);S.set(e.id,i)}),p.debug(`War goals:\n${f.map(e=>`(${e.strength}) ${e.reason} F${e.factionId} with desperation ${e.desperation}`).join("\n")}\nWar support:\n${Array.from(S.entries()).map(([e,t])=>`${t} against F${e}`).join("\n")}\nOverall despair ${w}\n`),b<t.MIN_WAR_SUPPORT_THRESHOLD?r.growthStrategy:w<25?(0,u.warStrategy)({warSupportByFaction:S}):(0,g.assaultStrategy)({warSupportByFaction:S})}t.AIController=class{constructor(){this.dataLayer=new c.DefaultAIDataLayer,this.debug=!1}play(e){return n(this,void 0,void 0,(function*(){this.gameController=s.inject.gameStateController,this.gameController.beginTransaction(),this.debug=!0===s.inject.config.debug.ai;const t=e.getRegions().filter(e=>e.isAlive()).sort((e,t)=>e.hexes.length-t.hexes.length);for(let i of t){const t=f(i);if(i.updateFrom(s.inject.gameStateController.currentState),!i.exists)continue;s.inject.debugData.set("AI",`faction ${e.id}, region ${i.id}`);const n=new o.RegionAIContext(i);n.debug=!0===s.inject.config.debug.ai||s.inject.config.debug.ai===i.id,yield t(n)}const i=this.gameController.scheduledEvents.length;return this.gameController.commitTransaction(),i}))}},function(e){e.FightBack="fight back against",e.Punish="punish",e.StopFromWinning="stop"}(m||(m={})),t.selectStrategy=f},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ApprovalBasedPoliticalAdvisor=t.NEUTRAL_POLITICAL_ADVISOR=t.AGRESSIVE_POLITICAL_ADVISOR=void 0;const n=i(14),s=i(18),a=i(76);t.AGRESSIVE_POLITICAL_ADVISOR={getWillingnessToAttack:e=>2,getPerceivedThreat:e=>0,getHostilityTowardsFaction:e=>2},t.NEUTRAL_POLITICAL_ADVISOR={getWillingnessToAttack:e=>1,getPerceivedThreat:e=>1,getHostilityTowardsFaction:e=>1};t.ApprovalBasedPoliticalAdvisor=class{constructor(e){this.faction=e}getWillingnessToAttack(e){const t=e.parentModel.state,i=n.Factions.model(t).byRegion(e);if(!i)return 0;if(!e.isAlive())return 1;return 1-this.getApprovalModifier(t,this.faction.id,i.id)}getPerceivedThreat(e){const t=e.parentModel.state,i=n.Factions.model(t).byRegion(e);if(!i||!e.isAlive())return 0;return 1-this.getApprovalModifier(t,i.id,this.faction.id)}getHostilityTowardsFaction(e){return 1-this.getApprovalModifier(e.parentModel.state,this.faction.id,e.id)}getApprovalModifier(e,t,i){return(0,a.cropNumber)(s.AI.getFactionApproval(e,t,i)/100,-2,.5)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseUiElement=void 0;const n=i(27),s=i(36);t.BaseUiElement=class{constructor(e){this.scene=e,this.onResize=(0,n.signal)()}addTo(e){e instanceof s.Scene?e.add.existing(this.getGameObject()):e.add(this.getGameObject())}destroy(){this.onResize.unsubscribeAll()}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameObjectUiElement=void 0;const n=i(118);class s extends n.BaseUiElement{constructor(e){super(e)}get height(){return this.getGameObject().height}get width(){return this.getGameObject().width}get x(){const e=this.getGameObject();return e.x-e.width*e.originX/2}get y(){const e=this.getGameObject();return e.y-e.height*e.originY/2}setPosition(e,t){this.getGameObject().setPosition(e,t)}destroy(){super.destroy(),this.getGameObject().destroy()}}t.GameObjectUiElement=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.saveGame=t.SAVE_GAME_LOCAL_STORAGE_PREFIX=void 0;const n=i(1),s=i(75),a=i(0),o=i(8),r=i(37);t.SAVE_GAME_LOCAL_STORAGE_PREFIX=`konkr.savedGame.v${o.CORE_GAMESTATE_SCHEMA_VERSION}.`,t.saveGame=function(e,i){let o=a.inject.gameStateModel.stateEngine;if(i){o=new r.GameStateModel(i).stateEngine}const c=JSON.stringify((0,s.compressGameState)(o));localStorage.setItem(t.SAVE_GAME_LOCAL_STORAGE_PREFIX+e,c),n.logger.for("saveGame").info(`Current games state saved into local storage as "${e}"`)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TextArea=t.HTMLUIElement=void 0;const n=i(118);var s=Phaser.GameObjects.DOMElement;class a extends n.BaseUiElement{constructor(){super(...arguments),this._x=0,this._y=0}getGameObject(){return this.element||(this.element=this.createElement(),this.parentContainer&&this.parentContainer.add(this.element),this.updateElementPosition()),this.element}setPosition(e,t){this._x=e,this._y=t,this.updateElementPosition()}get height(){return this.getGameObject().height}get width(){return this.getGameObject().width}get x(){return this._x}get y(){return this._y}updateElementPosition(){this.element&&this.element.setPosition(this._x,this._y)}destroy(){var e,t;super.destroy(),this.parentContainer=null===(e=this.element)||void 0===e?void 0:e.parentContainer,null===(t=this.element)||void 0===t||t.destroy(),this.element=void 0}}t.HTMLUIElement=a;t.TextArea=class extends a{constructor(e,t){super(e),this.props=t}createElement(){var e,t,i,n,a;const o=document.createElement("textarea");o.readOnly=null!==(e=this.props.readOnly)&&void 0!==e&&e,this.props.autoSelectAll&&(o.onclick=function(){this.focus(),this.select()});const r=this.props;return this.props.onChange&&(o.oninput=()=>{r.onChange(o.value)}),new s(this.scene,0,0,o,`width:${null!==(t=this.props.width)&&void 0!==t?t:500}px;height:${null!==(i=this.props.height)&&void 0!==i?i:100}px;resize:none;background-color:#f9efe8;pointer-events: auto;${null!==(n=this.props.customCss)&&void 0!==n?n:""}`,null!==(a=this.props.text)&&void 0!==a?a:"").setOrigin(0,0)}get text(){return this.getGameObject().node.value}setText(e){this.getGameObject().node.textContent=e}}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CUSTOM_WORLD_DEBUG_LAYERS=t.createHexIdDebugLayer=t.registerConsoleCommands=t.commands=void 0;const s=i(0),a=i(6),o=i(8),r=i(3),c=i(2),l=n(i(134)),d=i(5),h=i(85),u=i(180),g=i(157),p=i(86),m=i(18),f=i(19),y=i(154),v=i(14),w=i(46),b=i(74),S=i(158),x=i(172),P=i(155),T=i(326),M=i(58),C=i(59),I=i(117),O=i(173),_=i(92),A=i(91),E=i(88),B=i(90),H=i(171),j=i(98),R=i(75),D=i(45);function F(){return new w.GameStateDebugLayer((0,P.hexBasedAdapter)({getValue:(e,t)=>t.toString(),getDetail:(e,t)=>t.toString()}))}function L(e){const t=s.inject.gameStateModel.stateEngine;let i=`${(0,d.isProjectionDataSet)(e)?t.isDataSetActive(e)?"â—":"â—‹":"â– "} ${e.key} (${e.constructor.name})`;return(0,d.isProjectionDataSet)(e)&&(i+="\nbased on:\n"+e.parents.map(e=>`  ${k(e)} ${e.key}`).join("\n")),i+="\nused by:\n"+t.childrenOf(e).map(e=>`  ${k(e)} ${e.key}`).join("\n"),i}function k(e){return(0,d.isProjectionDataSet)(e)?s.inject.gameStateModel.stateEngine.isDataSetActive(e)?"â—":"â—‹":"â– "}t.commands={game:{new:(e={})=>{const t=Object.assign(Object.assign({},D.DEFAULT_NEW_GAME_OPTIONS),e);s.inject.events.trigger(a.UserActions.StartNewGame(t))},save:(e="auto")=>{s.inject.events.trigger(a.UserActions.SaveGame(e))},resume:()=>{s.inject.events.trigger(a.UserActions.ResumeGame())},load:(e="auto")=>{s.inject.events.trigger(a.UserActions.LoadGame(e))},decode(e){const t=(0,j.decodeGameState)(e);console.log(JSON.stringify(t,null,2))},export(){const e=JSON.stringify((0,R.compressGameState)(s.inject.gameStateModel.stateEngine));console.log(e)},import(e){const t=JSON.parse(e);s.inject.gameStateModel.restore(t),s.inject.events.trigger(a.UserActions.DebugGameState(s.inject.currentGameState))},revertTurn:()=>{s.inject.events.trigger(a.UserActions.RevertTurn())},endTurn:()=>{s.inject.gameStateController.executePlay(a.Plays.EndTurn())},setFaction:(e,t)=>{s.inject.gameStateModel.stateEngine.apply(o.GameState.factions.byId.createMutation({set:{[e]:Object.assign(Object.assign({},s.inject.gameStateModel.stateEngine.get(o.GameState.factions.byId,e)),{controller:t})}},"command"))},setTheme(e){h.WorldMap.setTheme(s.inject.gameStateModel.stateEngine.currentState,e),s.inject.events.trigger(a.UserActions.SyncWithModel())},takeOver(e){s.inject.gameStateModel.stateEngine.apply(o.GameState.factions.byId.createMutation({set:{[e]:Object.assign(Object.assign({},s.inject.gameStateModel.stateEngine.get(o.GameState.factions.byId,e)),{controller:r.FactionController.LocalUser})}},"command"))},sync:()=>{s.inject.events.trigger(a.UserActions.SyncWithModel())},get state(){return s.inject.gameStateModel.stateEngine.serialize()},get rawState(){return s.inject.gameStateModel.stateEngine.currentState},get stateModel(){return s.inject.gameStateModel}},debug:{off(){const e=s.inject.config.debug;e.tweenSpeedFactor=1,e.overlay=!1,e.recordStateChanges=!1,e.integrityChecks=void 0,e.skipTransitions=!1,e.ai=!1,s.inject.debugLayers.activate(void 0)},on(){s.inject.config.debug.overlay=!0},logs(e){l.default.enable(e)},history(){s.inject.navigator.goTo(s.inject.screen.debugHistory)},borders(){s.inject.debugLayers.activate("TileBordersManager")},layer(e){(0,c.assert)(s.inject.debugLayers.get(e),"unknown debug layer "+e),s.inject.debugLayers.activate(e)},dataSet(e){const i=s.inject.gameStateModel.stateEngine.getDataSetByKey(e);if(!i)throw new Error(`No dataset found for key "${e}"`);if(!s.inject.debugLayers.get(e)){const n=t.CUSTOM_WORLD_DEBUG_LAYERS[e],a=n?n():new w.GameStateDebugLayer((0,S.dataSetAdapter)(i));s.inject.debugLayers.register(e,a)}s.inject.debugLayers.activate(e),console.log(L(i))},dataSets(){const e=s.inject.gameStateModel.stateEngine;console.log(e.getAllDataSets().toArray().sort((function(e,t){let i=e.key.split(".")[0],n=t.key.split(".")[0],s=i+"."+((0,d.isProjectionDataSet)(e)?"Z":"A")+"."+e.key,a=n+"."+((0,d.isProjectionDataSet)(t)?"Z":"A")+"."+t.key;return(0,u.compareStrings)(s,a)})).map(t=>`${!(0,d.isProjectionDataSet)(t)?"â– ":e.isDataSetActive(t)?"â—":"â—‹"} ${t.key} (${t.constructor.name})`).join("\n"))},factionDataSet(e){const t=s.inject.gameStateModel.stateEngine,i=s.inject.gameStateModel.stateEngine.getDataSetByKey(e);if(!i)throw new Error(`No dataset found for key "${e}"`);console.log(L(i));const n=(0,d.selectFromState)(t.currentState,i).entrySeq(),a=n.map(([e])=>e).toJS(),o=n.map(([e,t])=>t).toJS();console.table({faction:a,value:o})},hexImportance(){s.inject.debugLayers.activate("ai.hexImportance")},threatAssessment(e){var t;void 0===e&&(e=(null===(t=s.inject.gameStateModel.currentPhase.faction)||void 0===t?void 0:t.id)||1);const i=s.inject.gameStateModel.factions.byId(e),n=new x.ThreatAssessment(i,{armyComposition:M.UNRESTRICTED_ARMY_COMPOSITION,economic:C.UNRESTRICTED_ECONOMIC_ADVISOR,political:new I.ApprovalBasedPoliticalAdvisor(i)});s.inject.debugLayers.registerAndActivate("threatAssessment",n.getDebugLayer())},exposedHexes(e){const t=s.inject.gameStateModel.regions.byId(e);c.assert.defined(t,"invalid region id");const i=s.inject.gameStateModel.factions.byRegion(t);c.assert.defined(i,"invalid region id (region not controlled by faction)");const n=new x.ThreatAssessment(i,{armyComposition:M.UNRESTRICTED_ARMY_COMPOSITION,economic:C.UNRESTRICTED_ECONOMIC_ADVISOR,political:new I.ApprovalBasedPoliticalAdvisor(i)}),a=new H.ExposedHexes(t,n);s.inject.debugLayers.registerAndActivate("exposedHexes",a.getDebugLayer(0))},regionInfluence(e){const t=s.inject.gameStateModel.regions.byId(e);c.assert.defined(t),s.inject.debugLayers.registerAndActivate("regionInfluence",(0,g.createHexInfluenceDebugLayer)(e))},factionInfluenceByRegion:function(e,t=1/0){s.inject.debugLayers.registerAndActivate(`factionInfluenceByRegion(${e})`,s.inject.views.factionInfluenceByRegion.getDebugLayer(e,t))},fear:function(e){s.inject.debugLayers.registerAndActivate(`fear(faction=${e})`,s.inject.views.fear.getDebugLayer(e))},hexIds(){s.inject.debugLayers.activate("hexIds",t.CUSTOM_WORLD_DEBUG_LAYERS.hexIds)},regionAssets(){s.inject.debugLayers.registerAndActivate("regionAssets",new w.GameStateDebugLayer((0,E.regionBasedAdapter)({getValue:(e,t)=>{const i=s.inject.gameStateModel.regions.byId(t);if(!i)return;return(0,B.getMyRegionAssets)(i).totalUnits.getTotalMight()+")"},getDetail:(e,t)=>{const i=s.inject.gameStateModel.regions.byId(t);if(!i)return;return"units: "+(0,B.getMyRegionAssets)(i).totalUnits.toString()}})))},approval(e=1){const t=s.inject.gameStateModel,i=t.factions.byId(e);c.assert.defined(i);const n=t.factions.all().filter(e=>e.controller!==r.FactionController.None);let a=[["from \\ towards",...n.map(e=>e.id)]],o=1;for(let e of n){a[o]=[e.id];for(let i of n)a[o].push(m.AI.getFactionApproval(t.state,e.id,i.id));++o}console.table(a),s.inject.debugLayers.registerAndActivate("approval",new w.GameStateDebugLayer((0,b.factionBasedAdapter)({getValue:(e,t)=>m.AI.getFactionApproval(e,t,i.id),getDetail:(e,t)=>(0,f.prettyPrintObject)(m.AI.getFactionApproval(e,t))})))},factionAttrition(){s.inject.debugLayers.registerAndActivate("factionAttrition",s.inject.views.attritionByFaction.getDebugLayer())},diplomacy(){s.inject.debugLayers.activate("diplomacy",()=>(0,T.createDiplomacyDebugLayer)())},regionAiPlan(e,t){var i;const n=new O.CompositePlanner({allowedTactics:[_.Planners.Default]}),a=s.inject.gameStateModel.regions.byId(e);c.assert.defined(a);const o=s.inject.gameStateModel.factions.byRegion(a);c.assert.defined(o);const r={economic:new C.BalancedEconomicAdvisor,armyComposition:new M.BalancedGrowthArmyComposition(a),political:new I.ApprovalBasedPoliticalAdvisor(o)},l={unitSolver:new p.UnitSolver(r),focus:t,advisors:r,faction:o,region:a,state:s.inject.currentGameState},d=(0,A.createAiViews)(l),h=n.generatePlans(l,d);for(;null===(i=h.next())||void 0===i?void 0:i.value;);s.inject.debugLayers.registerAndActivate("aiPlans",n.getDebugLayer())},attitude(e=1){const t=s.inject.gameStateModel,i=t.factions.byId(e);c.assert.defined(i);const n=t.factions.all().filter(e=>e.controller!==r.FactionController.None);let a=[["from \\ towards",...n.map(e=>e.id)]],o=1;for(let e of n){a[o]=[e.id];for(let i of n)a[o].push(m.AI.getFactionAttitude(t.state,e.id,i.id));++o}console.table(a),s.inject.debugLayers.registerAndActivate("approval",new w.GameStateDebugLayer((0,b.factionBasedAdapter)({getValue(e,t){if(t===i.id)return"";const{fear:n,approval:a,attitude:o}=s.inject.views.attitude.getComponents(e,{fromFactionId:t,towardsFactionId:i.id});return`${o}\n(A${a};F${n})`},getDetail:(e,t)=>v.Factions.model(e).all().filter(e=>e.controller!==r.FactionController.None&&e!==i&&e.id!==t).map(i=>{const n=s.inject.views.attitude.getComponents(e,{fromFactionId:t,towardsFactionId:i.id});return`${n.attitude} towards F${i.id} (A${n.approval};F${n.fear})`}).join("\n")})))}},get rec(){return s.inject.history},get config(){return s.inject.config},get ui(){return s.inject.ui},edit:{setFactionColor:(e,t)=>{const i=s.inject.gameStateModel.factions.byId(e);c.assert.defined(i,"Invalid faction id "+e),i.setLandColor(t),s.inject.events.trigger(a.UserActions.SyncWithModel())},approval(e,t,i){const n=m.AI.changeFactionApproval(s.inject.currentGameState,e,t,e=>e+i);console.log(`Approval from ${e} to ${t} now ${m.AI.getFactionApproval(n,e,t)}`)}}},t.registerConsoleCommands=function(){const e=t.commands,i=window;i.commands=e,i.game=e.game,i.debug=e.debug,i.rec=e.rec,i.config=e.config,i.edit=e.edit,i.ui=e.ui,i.inject=s.inject,i.GameState=o.GameState},t.createHexIdDebugLayer=F,t.CUSTOM_WORLD_DEBUG_LAYERS={hexIds:F,[o.GameState.regions.borderHexes.key]:y.createBorderHexesDebugLayer,[o.GameState.ai.hostileBorderHexes.key]:y.createBorderHexesDebugLayer};[o.GameState.pawns.byRegion,o.GameState.regions.hexes,o.GameState.economy.budgetByRegion,o.GameState.economy.treasuryByRegion,o.GameState.economy.townsByRegion,o.GameState.ai.attritionByRegion,o.GameState.ai.powerByRegion,o.GameState.ai.regionInfluenceByRegion,o.GameState.currentPhase.movableUnits,o.GameState.bandits.campsByRegion].forEach(e=>{t.CUSTOM_WORLD_DEBUG_LAYERS[e.key]=()=>new w.GameStateDebugLayer((0,S.regionDataSetAdapter)(e))});[o.GameState.ai.approval,o.GameState.ai.powerByFaction,o.GameState.units.byFaction].forEach(e=>{t.CUSTOM_WORLD_DEBUG_LAYERS[e.key]=()=>new w.GameStateDebugLayer((0,S.factionDataSetAdapter)(e))})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseScene=void 0;const n=i(0),s=i(1);class a extends Phaser.Scene{constructor(e){super(e),this._deferredHandlers=new Map,this._subs=[],this.log=s.logger.for(e.key||"BaseScene"),n.inject.config.watchFuture(e=>this.applyConfig(e))}create(){this.events.on(Phaser.Scenes.Events.WAKE,()=>{this.triggerDeferredHandlers()}),this.events.on(Phaser.Scenes.Events.SLEEP,()=>{}),this.events.on(Phaser.Scenes.Events.SHUTDOWN,()=>{}),this.events.on(Phaser.Scenes.Events.DESTROY,()=>{}),this.events.on(Phaser.Scenes.Events.PRE_UPDATE,()=>{this.preUpdate()})}destroy(){this._subs.forEach(e=>e.unsubscribe())}applyConfig(e){this.tweens.timeScale=e.debug.tweenSpeedFactor||1,this.time.timeScale=e.debug.tweenSpeedFactor||1,this.anims.globalTimeScale=e.debug.tweenSpeedFactor||1}addAll(e){for(let t of e)this.add.existing(t)}addImage(e,t="atlas"){return this.add.image(0,0,t,e)}preUpdate(){}triggerDeferredHandlers(){this._deferredHandlers.forEach(e=>e()),this._deferredHandlers.clear()}handleEventWhileActive(e,t){this._subs.push(n.inject.events.on(e,(e,i)=>{this.scene.isActive()&&t.apply(this,[e,i])}))}handleSignalWhileActive(e,t){this._subs.push(e((...e)=>{this.scene.isActive()&&t.apply(this,e)}))}watchWhileActive(e,t){this._subs.push(e.watch((i,n)=>{this.scene.isActive()?t.apply(this,[i,n]):this._deferredHandlers.set(e,()=>t.apply(this,[i,n]))}))}handleKeyPressWhileActive(e,t){this.input.keyboard.addKey(e).on("down",t)}bindKey(e,t){this.input.keyboard.addKey(e).on("down",()=>n.inject.events.trigger(t()))}}t.BaseScene=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.debugMethodCalls=t.assignObjId=t.getObjId=void 0;const n=i(2);let s=1;t.getObjId=function(e){return e.getData("id")||"?"},t.assignObjId=function(e){return e.setData("id",s++),s-1},t.debugMethodCalls=function(e,t,i){(0,n.assert)("function"==typeof e[t]);const s=e[t].bind(e);e[t]=(...n)=>(i?i(...n):console.warn(`${e.constructor.name}.${t} called with`,...n),s(...n))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createStaggeredDelay2Dfn=void 0;const n=i(61),s=i(0);t.createStaggeredDelay2Dfn=function(e,t=0,i=1e3,a=0){const o=(0,n.getBoundingBox)(e),r=o.width+o.height,c=i-t;return e=>t+(e.x-o.x+(e.y-o.y))/r*c+s.inject.random.integer(0,a)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IsoTileGroup=t.Image=void 0,t.Image=Phaser.GameObjects.Image;const n=i(12);i(1).logger.for("IsoTileGroup");t.IsoTileGroup=class{constructor(e,t,i){this.renderer=e,this.recipe=t,this.postProcessor=i,this.triangles={},this.hexes=n.HexGroup.empty,this.dirtyCorners=[]}addHexes(e){const t=e.filter(e=>!this.hexes.has(e));this.hexes=this.hexes.with(...t.members);const i=t.getCorners();this.dirtyCorners.push(...i)}setHexes(e){const t=this.hexes.without(e),i=e.without(this.hexes);this.addHexes(i),this.removeHexes(t),this.update()}removeHexes(e){this.hexes=this.hexes.without(e);const t=e.getCorners();this.dirtyCorners.push(...t)}update(){this.dirtyCorners.forEach(e=>this.updateCorner(e)),this.dirtyCorners=[]}updateCorner(e){var t;null===(t=this.triangles[e.id])||void 0===t||t.destroy();if(this.hexes.hasCorner(e)){const t=this.renderTriangle(e.display,e.sortedHexes);t&&(this.triangles[e.id]=t)}else delete this.triangles[e.id]}renderTriangle(e,i){const n=i.sort((e,t)=>e.id-t.id),s=n[0].y===n[1].y,a=(s?"V":"A")+n.map(e=>this.hexes.has(e)?"1":"0").join(""),o=this.recipe.frames[a];if(!o)return;const r=new t.Image(this.renderer.scene,e.x,e.y,"atlas",`${this.recipe.frameIdBase}/${o.frame}`);if(r.setDepth(this.recipe.baseDepth+r.y),r.setOrigin(.5,0),o.flipY&&(r.flipY=!0,r.y+=r.height),o.flipX&&(r.flipX=!0),o.crop){const{x:e,y:t,width:i,height:n}=o.crop;r.setOrigin(0,0),r.setCrop(e,t,i,n),r.x=r.x-e-i/2,r.y=r.y-t}return r.y-=(s?this.recipe.offsetV:this.recipe.offsetA)||0,this.postProcessor(r),this.renderer.add(n[0],r),r}clear(){Object.values(this.triangles).forEach(e=>e.destroy()),this.triangles={},this.hexes=n.HexGroup.empty}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.isRegionControllable=t.Cheats=t.PlayScene=void 0;const s=i(0),a=i(16),o=i(6),r=i(68),c=i(1),l=i(123),d=i(12),h=i(70),u=i(170),g=i(370),p=i(373),m=i(31),f=i(3),y=i(375),v=i(4),w=i(30),b=i(61),S=i(25),x=i(190),P=i(2),T=i(62),M=i(20),C=i(17),I=i(13),O=i(40),_=i(45),A=i(187),E=i(37),B=c.logger.for("ui:PlayScene");class H extends l.BaseScene{constructor(){super({key:a.Scenes.Play}),this.gameEventsBus=new u.TypedEventBus,this.mode=new h.BaseMode(this),this.latestSelectedRegionByFaction={},this.cheats=new j(this),this.pointerEventsController=new y.PointerEventsController}setMode(e){B.info(`âš™ entering ${e.name} (from ${this.mode.name})`),this.mode.deactivate(),this.mode=e,s.inject.debugData.set("playScene.mode",this.mode.name),e.activate(),e.handleNewHexUnderCursor(s.inject.ui.hexUnderCursor())}create(){super.create(),this.load.multiatlas("gameOverAtlas","assets/gameOverAtlas.json","assets"),this.load.start(),this.gameEventQueue=s.inject.gameStateController.getEventQueue(),this.events.on("destroy",()=>{this.gameEventQueue.unsubscribe()}),this.worldMapScene=this.scene.get(a.Scenes.WorldMap),this.debugScene=this.scene.get(a.Scenes.Debug),this.uiScene=this.scene.get(a.Scenes.PlayUI),this.handleEventWhileActive(r.WorldMapEvents.PointerDown,e=>{const t=e.hexId&&(0,v.getHex)(e.hexId);if(t&&s.inject.config.debug.cheats&&e.flags&r.PointerEventFlags.MiddleButton)this.cheats.toggleTapped(t);else if(e.flags&r.PointerEventFlags.RightButton){const t=this.getAvailableActionsForHex(e).returnPawn;t&&t()}else this.pointerEventsController.handlePointerDown(this.getAvailableActionsForHex(e))}),this.handleEventWhileActive(r.WorldMapEvents.PointerUp,e=>{this.pointerEventsController.handlePointerUp(this.getAvailableActionsForHex(e))}),this.handleEventWhileActive(o.UserActions.BuyablePawnPointerDown,e=>{s.inject.scene.playUI.canBuyPawn(e)&&this.pointerEventsController.handlePointerDown(this.getAvailableActionsForShop(e))}),this.handleEventWhileActive(o.UserActions.BuyablePawnPointerUp,e=>{this.pointerEventsController.handlePointerUp(this.getAvailableActionsForShop(e))}),this.handleEventWhileActive(o.UserActions.ShopAreaPointerDown,()=>{this.pointerEventsController.handlePointerDown({dropPawn:()=>(this.mode.handleReturnPawn(),!0),returnPawn:()=>this.mode.handleReturnPawn()})}),this.handleEventWhileActive(o.UserActions.DeselectRegion,()=>{this.selectRegion(void 0,{panCamera:!1,clickEffect:!1})}),this.handleEventWhileActive(o.UserActions.SelectNextRegion,()=>{const e=s.inject.ui.regionsLedger.getNext(s.inject.ui.selectedRegion());this.selectRegion(e,{panCamera:!0,clickEffect:!0})}),this.handleEventWhileActive(o.UserActions.SelectPreviousRegion,()=>{const e=s.inject.ui.regionsLedger.getPrevious(s.inject.ui.selectedRegion());this.selectRegion(e,{panCamera:!0,clickEffect:!0})}),this.handleEventWhileActive(o.UserActions.ShopAreaPointerUp,()=>{this.pointerEventsController.handlePointerUp({dropPawn:()=>(this.mode.handleReturnPawn(),!0),returnPawn:()=>this.mode.handleReturnPawn()})}),this.handleEventWhileActive(o.UserActions.Undo,()=>{s.inject.gameStateController.undo()}),this.handleEventWhileActive(o.UserActions.EndTurn,()=>{this.mode.handleEndTurn()}),this.watchWhileActive(s.inject.ui.hexUnderCursor,e=>{this.mode.handleNewHexUnderCursor(e)}),this.watchWhileActive(s.inject.ui.selectedRegion,(e,t)=>{const i=R(e);this.worldMapScene.setSelectedRegion(e,i?M.Colors.highlight.ownedRegion:M.Colors.highlight.hostileRegion),t&&this.refreshTownFlagsAndBacklightInRegion(t),e&&e.faction&&e.faction===s.inject.gameStateModel.currentPhase.faction&&(this.latestSelectedRegionByFaction[e.faction.id]=e,s.inject.ui.regionsLedger.regionVisited(e),this.refreshTownFlagsAndBacklightInRegion(e),this.setPawnsJumpingInRegion(e,!0)),this.showWorldMapOverlaysBasedOnSelectedRegion(),this.uiScene.updateSelectedRegionFromGameState(s.inject.gameStateModel.state)}),this.handleEventWhileActive(o.UserActions.SelectNextPendingRegion,()=>{const e=s.inject.ui.regionsLedger.getNextPendingRegion();this.selectRegion(e,{clickEffect:!1,panCamera:!0}),e&&s.inject.ui.regionsLedger.regionVisited(e),this.uiScene.updateSelectedRegionFromGameState(s.inject.gameStateModel.state)}),this.handleEventWhileActive(o.UserActions.SetSpectatingPlayBackSpeed,e=>{s.inject.ui.spectatingSpeed.set(e)}),this.handleEventWhileActive(o.UserActions.SkipSpectating,()=>{this.mode.handleSkipSpectating(),this.uiScene.updateState({enableSkipSpectating:!1})}),this.gameEventsBus.setDefaultHandler((e,t)=>n(this,void 0,void 0,(function*(){return(0,T.isEvent)(e,o.GameEvents.NewGameState)?(0,g.handleNewGameState)(this,e.payload):(0,T.isEvent)(e,o.GameEvents.FactionTurnStarted)?(0,p.handleFactionTurnStarted)(this,e.payload):(0,T.isEvent)(e,o.GameEvents.GameOver)?this.handleGameOver(e.payload):void(yield this.mode.handleGameEvent(e))})))}getAvailableActionsForHex(e){const t=void 0===e.hexId?void 0:(0,v.getHex)(e.hexId),i={endCameraDrag:()=>this.worldMapScene.cameraController.scrollController.stopDragging(),startCameraDrag:()=>this.worldMapScene.cameraController.startDragScroll(),returnPawn:()=>this.mode.handleReturnPawn()};return t?(this.mode.canDropPawn(t)&&(i.dropPawn=()=>this.mode.handleDropPawn(t)),this.mode.canSelectHex(t)&&(i.selectHex=()=>this.mode.handleSelectHex(t)),this.mode.canPickupPawn(t)&&(i.pickupPawn=()=>this.mode.handlePickupPawn(t))):i.selectHex=()=>this.selectRegion(void 0,{clickEffect:!1,panCamera:!1}),i}getAvailableActionsForShop(e){return{pickupPawn:()=>this.mode.handlePickupPawnFromShop(e),dropPawn:t=>this.mode.handleDropPawnOnShop(e,t),returnPawn:()=>this.mode.handleReturnPawn()}}skipToCurrentState(e=O.NewGameStateContext.ResumingGame){this.gameEventQueue.clear();const t=s.inject.gameStateModel.state;(0,g.handleNewGameState)(this,{state:t,context:e}),(0,p.handleFactionTurnStarted)(this,{state:t,factionId:S.CurrentPhase.getFaction(t)})}update(){for(;this.gameEventQueue.hasNext()&&this.mode.isReadyForMoreGameEvents();){const e=this.gameEventQueue.next();this.gameEventsBus.trigger(e),s.inject.scene.worldMap.runIntegrityChecks()}s.inject.debugData.set("playScene.mode",`${this.mode.name} (${this.mode.isReadyForMoreGameEvents()?"ready":"processing event"})`)}clearConquerableHexes(){this.conquerableHexes=d.HexGroup.empty,this.worldMapScene.conquerableHexesHighlight.set(this.conquerableHexes)}dropHeldPawnAtHex(e){return new Promise(t=>{const i=this.worldMapScene.getPawnObjectPositionOnScreen(e);this.uiScene.pawnHolder.dropPawn(i.x,i.y,i.scale,t)})}selectRegion(e,t={panCamera:!1,clickEffect:!0}){if(e||s.inject.ui.selectedRegion.set(void 0),t.clickEffect&&e&&s.inject.audio.playEffect(m.SoundEffects.ShutterClick),t.panCamera&&e){const t=(0,b.rectToPhaser)(e.hexes.boundingBox());this.worldMapScene.cameraController.ensureRectVisible(t)}s.inject.ui.selectedRegion.set(e)}showConquerableHexesBasedOn(e){const t=s.inject.ui.selectedRegion();t?(this.conquerableHexes=s.inject.gameStateModel.warfare.getConquerableHexes(t,e),this.worldMapScene.conquerableHexesHighlight.set(this.conquerableHexes)):this.worldMapScene.conquerableHexesHighlight.clear()}showWorldMapOverlaysBasedOnSelectedRegion(){const e=s.inject.ui.selectedRegion();e&&R(e)?this.showConquerableHexesBasedOnSelectedRegion():(this.worldMapScene.conquerableHexesHighlight.clear(),(null==e?void 0:e.faction)&&s.inject.config.flags.seeEnemyAttitudes?this.showAttitudeEmojis(e.faction):e&&s.inject.config.flags.seeEnemyAttitudes?this.hideAttitudeAttitudeEmojis():s.inject.gameStateModel.currentPhase.isLocalPlayerTurn()?this.showAttitudeEmojis(s.inject.gameStateModel.currentPhase.faction):this.hideAttitudeAttitudeEmojis())}showConquerableHexesBasedOnSelectedRegion(){const e=s.inject.ui.selectedRegion();if(!e)return this.clearConquerableHexes();const t=e.getMovableUnitsByMight().getStrongest();this.conquerableHexes=s.inject.gameStateModel.warfare.getConquerableHexes(e,t),this.worldMapScene.conquerableHexesHighlight.set(this.conquerableHexes,A.DEFAULT_TINT,.5),this.showAttitudeEmojis(s.inject.gameStateModel.currentPhase.faction)}showAttitudeEmojis(e){var t;const i=s.inject.gameStateModel;P.assert.defined(e);for(const n of i.regions.all())if(n.isAlive()&&(null===(t=n.faction)||void 0===t?void 0:t.controller)!==f.FactionController.LocalUser&&n.faction!==e){const t=(0,x.getAttitudeIndex)(n.faction.fearOf(e),n.faction.approvalOf(e)),s=e===i.currentPhase.faction?1:.75;i.economy.townHexesOf(n).forEach(e=>this.worldMapScene.attitudeEmojis.set(e,t,s))}else i.economy.townHexesOf(n).forEach(e=>this.worldMapScene.attitudeEmojis.remove(e))}hideAttitudeAttitudeEmojis(){this.worldMapScene.attitudeEmojis.clear()}refreshAllTownFlagsAndBacklight(e){var t;this.worldMapScene.townStatusFlags.clear(),this.worldMapScene.townBacklight.clear(),null===(t=S.CurrentPhase.model(e).faction)||void 0===t||t.getRegions().forEach(e=>this.refreshTownFlagsAndBacklightInRegion(e))}refreshTownFlagsAndBacklightInRegion(e){var t,i;const n=w.Economy.model(e.state).townHexesOf(e),a=(null===(t=e.faction)||void 0===t?void 0:t.controller)===f.FactionController.LocalUser&&e.faction.id===S.CurrentPhase.getFaction(e.state),o=e.treasury>=10,r=C.Pawns.model(e.state).findOne({hexes:e.hexes,traits:[I.PawnTraits.Unit],movable:!0});S.CurrentPhase.model(e.state).getMovablePawns().find(t=>e.hexes.has(t.hex));const c=((null===(i=e.budget)||void 0===i?void 0:i.balance)||0)<0;if(a&&(o||r||c)){const t=c?16711680:65280;for(let i of n.members)this.worldMapScene.townStatusFlags.setFlag(i,t),s.inject.ui.selectedRegion()!==e?this.worldMapScene.townBacklight.add(i,t):this.worldMapScene.townBacklight.remove(i)}else n.forEach(e=>{this.worldMapScene.townStatusFlags.removeFlag(e),this.worldMapScene.townBacklight.remove(e)})}refreshTownVariantInRegions(e){for(let t of e){const e=t.getTownHexes();s.inject.scene.worldMap.pawns.syncPawnVariant(new E.StaticGameStateModel(t.state),e)}}setPawnsJumpingInRegion(e,t){const i=s.inject.gameStateModel.currentPhase.getMovablePawns().filter(t=>t.region===e).map(e=>e.hex.id);t?this.worldMapScene.pawns.beginJumping(i):this.worldMapScene.pawns.stopJumping(i)}setPawnJumpingInRegions(e){e.forEach(e=>this.setPawnsJumpingInRegion(e,!0))}handleGameOver(e){const t=1===e.winningFactionId?_.LevelOutcome.Victory:_.LevelOutcome.Defeat;s.inject.events.trigger(o.UserActions.EndGame(t))}}t.PlayScene=H;class j{constructor(e){this.scene=e}toggleTapped(e){const t=s.inject.gameStateModel;let i=t.warfare.getOccupyingUnit(e);i&&(t.currentPhase.isTapped(i)?(t.currentPhase.unTapPawn(i),this.scene.worldMapScene.pawns.beginJumping([e.id])):(t.currentPhase.tapPawn(i),this.scene.worldMapScene.pawns.stopJumping([e.id])))}}function R(e){if(!e)return!1;const t=s.inject.gameStateModel;return t.factions.byRegion(e)===t.currentPhase.faction&&t.economy.townHexesOf(e).length>0}t.Cheats=j,t.isRegionControllable=R},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SpectatorMode=void 0;const s=i(70),a=i(0),o=i(4),r=i(37),c=i(60),l=i(7),d=i(102),h=i(35),u=i(61),g=i(19),p=i(12),m=i(2),f=i(23),y=i(55),v=i(20),w=i(3);class b extends s.BaseMode{constructor(e){super(e),this.pendingEvents=[],this.ongoingMoves=[],this.skipping=!1,this.hexesCaptureWhileSkipping=new Set,this.active=!0,this.scheduleSelectedRegionUpdate=(0,f.debounce)(()=>{this.active&&this.scene.worldMapScene.setSelectedRegion(this.focusedRegion,v.Colors.highlight.hostileRegion)},500)}activate(){this.scene.worldMapScene.pawns.clearAllJumping(),this.scene.uiScene.updateState({mode:h.PlayUIMode.Spectating,enableSkipSpectating:!0,spectatingState:h.SpectatingState.EnemyTurn}),this.scene.worldMapScene.townStatusFlags.clear(),this.scene.worldMapScene.townBacklight.clear(),this.scene.hideAttitudeAttitudeEmojis(),a.inject.ui.selectedRegion.set(void 0)}deactivate(){var e;if(super.deactivate(),this.scene.worldMapScene.selectedRegionHighlight.clear(),this.scene.worldMapScene.townBacklight.clear(),this.active=!1,this.skipping){this.scene.worldMapScene.syncState(a.inject.currentGameState);for(let t of this.hexesCaptureWhileSkipping)(null===(e=this.scene.watchedHexes)||void 0===e?void 0:e.has((0,o.getHex)(t)))&&this.scene.worldMapScene.tileSymbols.add((0,o.getHex)(t),y.TileSymbol.Alert)}}handleGameEvent(e){const t=Object.create(null,{handleGameEvent:{get:()=>super.handleGameEvent}});return n(this,void 0,void 0,(function*(){yield t.handleGameEvent.call(this,e)}))}handleFactionEconomyUpdated(e){const t=Object.create(null,{handleFactionEconomyUpdated:{get:()=>super.handleFactionEconomyUpdated}});var i;return n(this,void 0,void 0,(function*(){this.skipping||((null===(i=a.inject.gameStateModel.factions.byId(e.factionId))||void 0===i?void 0:i.controller)===w.FactionController.LocalUser&&a.inject.scene.playUI.updateState({spectatingState:h.SpectatingState.GatherIncome}),yield this.waitForAllTweensToFinish(),this.scene.worldMapScene.conquerableHexesHighlight.clear(),yield t.handleFactionEconomyUpdated.call(this,e))}))}waitForAllTweensToFinish(){return n(this,void 0,void 0,(function*(){yield Promise.race([Promise.all(this.ongoingMoves),(0,g.sleep)(5e3)]),this.ongoingMoves=[]}))}handleHexCaptured(e){var t,i;return n(this,void 0,void 0,(function*(){if(this.skipping)return void this.hexesCaptureWhileSkipping.add(e.capturedHexId);yield(0,d.clearCapturedHex)(this.scene,e);const n=l.Regions.model(e.state).byId(e.newRegionId);if(m.assert.defined(n),n!==this.focusedRegion)if(a.inject.ui.spectatingSpeed()!==h.SpectatingPlaybackSpeed.UltraFast)yield this.waitForAllTweensToFinish(),this.scene.worldMapScene.conquerableHexesHighlight.clear(),yield this.focusRegion(n,e.capturedHexId),yield(0,g.sleep)(500);else if(n.faction!==(null===(t=this.focusedRegion)||void 0===t?void 0:t.faction)){const e=n.faction.getRegions().filter(e=>e.isAlive()),t=p.HexGroup.union(e.map(e=>e.hexes)),i=p.HexGroup.union(e.map(e=>e.getTownHexes()));this.scene.worldMapScene.selectedRegionHighlight.setHexes(t,v.Colors.highlight.hostileRegion),this.scene.worldMapScene.townBacklight.set(i,v.Colors.highlight.hostileRegion)}let s;if(this.scene.worldMapScene.conquerableHexesHighlight.add((0,o.getHex)(e.capturedHexId),v.Colors.highlight.hostileRegion),this.scheduleSelectedRegionUpdate(),e.originatingHexId)s=this.scene.worldMapScene.pawns.move(e.originatingHexId,e.capturedHexId);else{const t=(0,r.readOnlyModelOf)(e.state),n=null===(i=t.economy.nearestTownHexFrom((0,o.getHex)(e.capturedHexId)))||void 0===i?void 0:i.id;s=this.scene.worldMapScene.pawns.add(e.capturedHexId,e.capturingPawnType,void 0,n).play()}[h.SpectatingPlaybackSpeed.Normal,h.SpectatingPlaybackSpeed.Paused].includes(a.inject.ui.spectatingSpeed())?(yield s,this.scene.worldMapScene.conquerableHexesHighlight.clear()):this.ongoingMoves.push(s);const u=(0,c.mergeTransactions)(e.boughtPawnTransactions||{},e.lootTransactions||{});u&&this.scene.worldMapScene.coins.applyTransactions(u),yield(0,d.updateCapturedHex)(this.scene,e)}))}handlePawnMoved(e){const t=Object.create(null,{handlePawnMoved:{get:()=>super.handlePawnMoved}});return n(this,void 0,void 0,(function*(){this.skipping||t.handlePawnMoved.call(this,e)}))}handlePawnBought(e){const t=Object.create(null,{handlePawnBought:{get:()=>super.handlePawnBought}});return n(this,void 0,void 0,(function*(){this.skipping||t.handlePawnBought.call(this,e)}))}handleBanditsActed(e){const t=Object.create(null,{handleBanditsActed:{get:()=>super.handleBanditsActed}});return n(this,void 0,void 0,(function*(){this.skipping||(a.inject.scene.playUI.updateState({spectatingState:h.SpectatingState.BanditsAct}),this.scene.worldMapScene.selectedRegionHighlight.clear(),this.scene.worldMapScene.townBacklight.clear(),yield t.handleBanditsActed.call(this,e))}))}focusRegion(e,t){return n(this,void 0,void 0,(function*(){this.focusedRegion=e;const i=void 0!==t?p.HexGroup.fromIds([t]):p.HexGroup.empty,n=(0,u.rectToPhaser)(e.hexes.boundingBox());this.scene.worldMapScene.selectedRegionHighlight.setHexes(e.hexes.without(i),v.Colors.highlight.hostileRegion),e.getTownHexes().forEach(e=>{this.scene.worldMapScene.townBacklight.set(e,v.Colors.highlight.hostileRegion)}),yield this.scene.worldMapScene.cameraController.ensureRectVisible(n)}))}handleSkipSpectating(){this.skipping=!0}isReadyForMoreGameEvents(){return a.inject.ui.spectatingSpeed()!==h.SpectatingPlaybackSpeed.Paused&&super.isReadyForMoreGameEvents()}}t.SpectatorMode=b},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.COMPACT_PLAY_UI_LAYOUT=void 0;const n=i(35),s=i(79);t.COMPACT_PLAY_UI_LAYOUT={regionPanel:{offsetFromSides:70,height:50},shoppingTray:{openOffsetFromBottom:106,pawnsVerticalOffset:44,pawnsSpacing:50,width:s.SMALL_SCREENSIZE_MAXWIDTH,style:n.ShoppingTrayStyle.Simple,closedOffsetFromBottom:-20,panelTransitionsDuration:500},panelTransitionsDuration:500}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoundedRect=void 0;var n=Phaser.GameObjects.Graphics;const s=i(32),a=i(175);t.RoundedRect=class extends n{constructor(e,t){super(e,{x:t.x,y:t.y,fillStyle:t.fillStyle,lineStyle:t.lineStyle}),this.preUpdate=(0,s.whenDirty)(()=>{var e;this.clear(),this.fillStyle(null!==(e=this._fillStyle.color)&&void 0!==e?e:0,this._fillStyle.alpha),this.fillRoundedRect(0,0,this.width,this.height,this.radius)}),this.radius=t.radius,this._fillStyle=t.fillStyle||{color:4095,alpha:1},a.ResponsiveSizeComponent.overrideSizeComponent(this)}setFillStyle(e,t=1){this._fillStyle={color:e,alpha:t},this.preUpdate.makeDirty()}set radius(e){this._radius=e,this.preUpdate.makeDirty()}get radius(){return this._radius}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Card=t.CardPointerInputMode=void 0;const n=i(22),s=i(130),a=i(20),o=i(95),r=i(44);var c,l=Phaser.Geom.Rectangle;!function(e){e.Whole="whole",e.WithoutFooter="without-footer",e.NotClickable="not-clickable"}(c=t.CardPointerInputMode||(t.CardPointerInputMode={}));class d extends n.BaseResponsiveContainer{constructor(e,t={}){var i,n;if(super(e),this._footerSize=0,this._clickable=c.NotClickable,this._buttonState=r.ButtonState.Rest,this.background=new s.RoundedRect(e,{x:0,y:0,fillStyle:{color:a.Colors.glassUi.shape,alpha:1},radius:0}),this.shadow=new s.RoundedRect(e,{x:d.Layout.shadowDepth,y:d.Layout.shadowDepth,fillStyle:{color:a.Colors.glassUi.shapeShadow,alpha:1},radius:0}),this.footerBackground=new s.RoundedRect(e,{x:d.Layout.shadowDepth,y:d.Layout.shadowDepth,fillStyle:{color:a.Colors.glassUi.shapeDarkAccent,alpha:1},radius:0}),t.radius&&(this.radius=t.radius),t.onClick){this._onClick=t.onClick,this._clickable=null!==(i=t.clickable)&&void 0!==i?i:c.Whole;const e=new o.SimpleButtonStateController({audio:t.clickable===c.Whole});e.bindTo(this,e=>{this._buttonState=e,this.preUpdate.makeDirty()}),e.onClicked(t.onClick)}else this._clickable=null!==(n=t.clickable)&&void 0!==n?n:c.NotClickable;this.add([this.shadow,this.background,this.footerBackground]),t.content&&(this._content=t.content,this.add([this._content])),t.footerSize&&(this._footerSize=t.footerSize)}set footerSize(e){this._footerSize=e,this.preUpdate.makeDirty()}get footerSize(){return this._footerSize}set radius(e){this.background.radius=e,this.preUpdate.makeDirty()}get radius(){return this.background.radius}set content(e){this._content!==e&&(this._content&&this.remove(this._content),this._content=e,this.add([this._content]),this.preUpdate.makeDirty())}get content(){return this._content}getHitAreaHeight(){return this.height-(this._clickable===c.Whole?0:this._footerSize)}setClickable(e){this._clickable=e,this.preUpdate.makeDirty()}updateLayout(){var e,t,i;const n=this._buttonState===r.ButtonState.Down&&this._clickable===c.Whole?2:0;this._clickable!==c.NotClickable?((null===(e=this.input)||void 0===e?void 0:e.hitArea)?this.input.hitArea.setTo(this.width/2,this.height/2,this.width,this.getHitAreaHeight()):this.setInteractive({hitArea:new l(this.width/2,this.height/2,this.width,this.getHitAreaHeight()),hitAreaCallback:l.Contains,cursor:"pointer"}),this.input.enabled=!0):this.input&&(this.input.enabled=!1),this.shadow.setSize(this.width,this.height),this.shadow.radius=this.radius,this.background.setPosition(n,n),this.background.setSize(this.width,this.height),null===(t=this._content)||void 0===t||t.setPosition(n,n),null===(i=this._content)||void 0===i||i.setSize(this.width,this.height),this._buttonState===r.ButtonState.Down||this._buttonState==r.ButtonState.Hover?(this.background.setFillStyle(a.Colors.glassUi.shapeLightAccent),this._clickable===c.Whole&&this.footerBackground.setFillStyle(a.Colors.glassUi.shape)):(this.background.setFillStyle(a.Colors.glassUi.shape),this.footerBackground.setFillStyle(a.Colors.glassUi.shapeDarkAccent)),this.footerBackground.radius={tl:0,tr:0,bl:"object"==typeof this.radius?this.radius.bl:this.radius,br:"object"==typeof this.radius?this.radius.br:this.radius},this.footerBackground.setVisible(this.footerSize>0),this.footerBackground.setPosition(0+n,this.height-this.footerSize+n),this.footerBackground.setSize(this.width,this.footerSize)}}t.Card=d,d.Layout={shadowDepth:4,defaultRadius:20}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getLevelIcon=t.LevelIcons=void 0;const n=i(0),s=i(45);var a;!function(e){e.Gold="ui/level-icons/gold",e.Silver="ui/level-icons/silver",e.Bronze="ui/level-icons/bronze",e.Fighting="ui/level-icons/in-progress",e.NotStarted="ui/level-icons/no-trophy",e.Defeated="ui/level-icons/rip"}(a=t.LevelIcons||(t.LevelIcons={})),t.getLevelIcon=function(e){var t;const i=n.inject.userData.getLevelProgressById(e);return i?(null===(t=i.bestResult)||void 0===t?void 0:t.outcome)===s.LevelOutcome.Victory?a.Gold:i.inProgress?a.Fighting:a.NotStarted:a.NotStarted}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.LevelModel=t.getUnlockedLevels=t.LevelStatus=void 0;const s=i(0),a=i(98),o=i(45),r=i(11);var c;function l(e){let t=0,i=!0;return e.levels.filter(e=>{const n=function(e){var n;switch(null===(n=e.unlockCondition)||void 0===n?void 0:n.type){case void 0:return!0;case"completed-previous":return i;case"max-incomplete":return t<=e.unlockCondition.maxIncomplete}}(e);return n?(t++,i=!0):i=!1,n}).map(e=>e.id)}!function(e){e.Locked="Locked",e.NotStarted="NotStarted",e.InProgress="InProgress",e.Replaying="Replaying",e.Completed="Completed",e.Defeated="Defeated"}(c=t.LevelStatus||(t.LevelStatus={})),t.getUnlockedLevels=l;class d{constructor(e){this.id=e}get userData(){return s.inject.userData.getLevelProgressById(this.id)}get campaignContext(){return s.inject.mapRegistry.getLevelLocationInCampaign(this.id)}get parentCampaign(){var e;return null===(e=this.campaignContext)||void 0===e?void 0:e.campaign}getNextUnfinishedLevelId(){var e;if(!this.parentCampaign)return;return null===(e=[...this.parentCampaign.levels.slice(this.campaignContext.indexInCampaign+1),...this.parentCampaign.levels.slice(0,this.campaignContext.indexInCampaign)].find(e=>{const t=d.get(e.id).getLevelStatus();return t===c.NotStarted||t===c.InProgress}))||void 0===e?void 0:e.id}getStartingState(){return n(this,void 0,void 0,(function*(){const e=yield s.inject.mapRegistry.getLevelById(this.id);if(e)return(0,a.decodeGameState)(e.data)}))}getCurrentState(){var e,t;return n(this,void 0,void 0,(function*(){if(null===(e=this.userData)||void 0===e?void 0:e.inProgress)try{return yield s.inject.userData.loadGame(this.id,o.SaveGameTags.Autosave)}catch(e){return console.error(`Failed to load level "${this.id}" state from user data, falling back to start`,e),s.inject.userData.deleteSavedGame(this.id,o.SaveGameTags.Autosave),this.getCurrentState()}else{if(!(null===(t=this.userData)||void 0===t?void 0:t.bestResult))return this.getStartingState();try{return yield s.inject.userData.loadGame(this.id,o.SaveGameTags.BestResult)}catch(e){return console.error(`Failed to load level "${this.id}" bets result state from user data, falling back to start`,e),this.getStartingState()}}}))}getVictoryState(){return n(this,void 0,void 0,(function*(){if(this.userData)try{return s.inject.userData.loadGame(this.id,o.SaveGameTags.BestResult)}catch(e){return void console.error(`Failed to load victory state for level "${this.id}"`,e)}}))}getLevelStatus(){var e,t,i,n;const s=this.campaignContext;null==s||s.campaign;return this.isUnlocked()?(null===(e=this.userData)||void 0===e?void 0:e.bestResult)&&this.userData.bestResult.outcome===o.LevelOutcome.Victory&&(null===(t=this.userData)||void 0===t?void 0:t.inProgress)?c.Replaying:(null===(i=this.userData)||void 0===i?void 0:i.inProgress)?c.InProgress:(null===(n=this.userData)||void 0===n?void 0:n.bestResult)?this.userData.bestResult.outcome===o.LevelOutcome.Victory?c.Completed:c.Defeated:c.NotStarted:c.Locked}isUnlocked(){const e=this.campaignContext;if(!(null==e?void 0:e.levelData.unlockCondition)||!e)return!0;return l(e.campaign).includes(this.id)}static get(e){return(0,r.getOrCreate)(this._instances,e,()=>new d(e))}}t.LevelModel=d,d._instances={}},,,,,,,,,,,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SingletonDataSet=void 0;t.SingletonDataSet=class{constructor(e,t){this.key=e,this.defaultValue=t}apply(e,t){return e.set(this.key,t)}deserialize(e){return e}serialize(e){return e}createMutation(e,t){return{dataSet:this,changes:e,context:t}}getEntryById(e,t){throw new Error(`Cannot extract entry ${t} from SingletonDataSet ${this.key} (SingletonDataSet has no entries)`)}entryToString(e){return""}entryToDebugString(e){return""}getEntryIds(e){return[]}toString(){return`[SingletonDataSet "${this.key}"]`}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.spatialToTabular=t.tabularToOrdinal=t.tabularToSpatial=t.ordinalToTabular=t.isOrdinal=t.isTabular=t.isSpatial=void 0;const n=i(4);t.isSpatial=function(e){return e.hasOwnProperty("x")},t.isTabular=function(e){return e.hasOwnProperty("r")},t.isOrdinal=function(e){return"number"==typeof e},t.ordinalToTabular=function(e){return{r:Math.floor(e/n.GRID_MAX_DIMENSION),c:Math.floor(e%n.GRID_MAX_DIMENSION)}},t.tabularToSpatial=function({r:e,c:t}){return{x:t-e%2/2,y:e}},t.tabularToOrdinal=function({r:e,c:t}){return e*n.GRID_MAX_DIMENSION+t},t.spatialToTabular=function({x:e,y:t}){return{r:t,c:Math.ceil(e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryWithCache=void 0;t.FactoryWithCache=class{constructor(e){this.maker=e,this.instances=new WeakMap}getOrCreateFor(e){let t=this.instances.get(e);return t||(t=this.maker(e),this.instances.set(e,t)),t}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazyAdapter=void 0,t.lazyAdapter=function(e){let t=void 0,i=void 0;return()=>{const n=e.source();return void 0!==n&&n===i||(t=e.transform(n),i=n),t}}},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.PowerByRegionUpdater=t.PowerByRegionProjection=t.NO_REGION_POWER=void 0;const o=i(21),r=a(i(10)),c=i(19),l=i(7),d=i(86),h=i(26),u=i(1),g=i(2),p=i(59),m=i(25);u.logger.for("MightByRegionProjection");t.NO_REGION_POWER={total:0,militaryPower:0,economicPower:0,totalMight:0,maxObtainableUnitMight:0,maxObtainableUnitCount:0,maxSustainableUnitMight:0};class f extends o.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new y(this).update}bootstrap(e){const t=new d.UnitSolver,i=l.Regions.model(e);return r.Map().withMutations(e=>{i.all().filter(e=>e.isAlive()).forEach(i=>{const n=this.calculateRegionPower(i,t);n.total>0&&e.set(i.id,n)})})}calculateRegionPower(e,i){var n,s;if(!(null==e?void 0:e.isAlive()))return t.NO_REGION_POWER;const a=e.getUnitsByMight(),o=e.budget,r=m.CurrentPhase.model(e.state).faction!==e.faction;g.assert.defined(o);const c={totalUnits:a,remainingUnits:a,remainingIncome:(null===(n=e.budget)||void 0===n?void 0:n.balance)||0,remainingGold:e.treasury+(r&&(null===(s=e.budget)||void 0===s?void 0:s.balance)||0)},l=i.estimateTotalMight(c),d=Math.floor(Math.pow(5*i.estimateTotalMight(c),1.1)),h=Math.floor(Math.pow(Math.max(0,o.incomeFromHexes),1.1)),u=d+h;i.economicStrategy=p.BALANCED_ECONOMIC_STRATEGY;const f=i.estimateTopAvailableMight(c);i.economicStrategy=p.UNRESTRICTED_ECONOMIC_ADVISOR;return{total:u,totalMight:l,militaryPower:d,economicPower:h,maxSustainableUnitMight:f,maxObtainableUnitMight:i.estimateTopAvailableMight(c),maxObtainableUnitCount:i.getObtainableUnitCount(c)}}entryToString(e){return`${e.militaryPower}+${e.economicPower}`}entryToDebugString(e){return(0,c.prettyPrintObject)(Object.assign({},e))}}t.PowerByRegionProjection=f;class y extends h.BaseUpdater{constructor(){super(...arguments),this.builder=new o.MapMutationBuilder(this.dataSet)}initialize(){this.invalidated=new Set}registerHandlers(e){e(this.dataSet.sources.budgetByRegion,this.handleRegionBudgetChange.bind(this)),e(this.dataSet.sources.pawnsByRegion,this.handlePawnsByRegionChange.bind(this)),e(this.dataSet.sources.treasuryByRegion,this.handleTreasuryByRegionChange.bind(this))}handleRegionBudgetChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{this.invalidated.add(e)})}handlePawnsByRegionChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>this.invalidated.add(e.id))}handleTreasuryByRegionChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>this.invalidated.add(e))}createMutation(){const e=l.Regions.model(this.newState),t=new d.UnitSolver;return this.invalidated.forEach(i=>{const n=this.dataSet.calculateRegionPower(e.byId(i),t);n.total>0?this.builder.set(i,n):this.builder.delete(i)}),super.createMutation()}}t.PowerByRegionUpdater=y},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.UnitsByMight=t.MAX_UNIT_MIGHT=void 0;const s=n(i(10)),a=i(2),o=i(9);t.MAX_UNIT_MIGHT=4;const r=s.default.Map();class c{constructor(e=r){this.data=e}getOneWithMightAtLeast(e){for(let i=e;i<=t.MAX_UNIT_MIGHT;++i)if(this.data.get(i))return i}has(e){return!!this.data.get(e)}withoutUnit(e){const t=this.data.get(e,0);return(0,a.assert)(t>0,`cannot take unit with might ${e} from ${this.toString()}`),new c(t-1>0?this.data.update(e,e=>e-1):this.data.delete(e))}hasUnitsWeakerThan(e){for(let t=1;t<e;++t)if(this.data.get(t))return!0;return!1}getTotalMight(){return this.data.map((e,t)=>t*e).reduce(o.sum,0)}static fromUnitList(e){return new c(s.default.Map().withMutations(t=>{e.forEach(e=>t.set(e,t.get(e,0)+1))}))}toString(){let e="[";for(let t=1;t<4;++t)e+=t.toString().repeat(this.data.get(t,0));return e+="]",e}add(e,t=1){return new c(this.data.set(e,this.data.get(e,0)+t))}getStrongest(){for(let e=4;e>0;--e)if(this.data.get(e))return e;return 0}getAvailableMightLevels(){return Array.from(this.data.keys())}map(e){return this.data.map(e)}count(){return this.data.valueSeq().reduce(o.sum,0)}countOf(e){return this.data.get(e,0)}without(...e){return new c(this.data.withMutations(t=>{e.forEach(i=>{const n=t.get(i,0);if(n<1)throw new Error(`cannot take units ${e} from ${this.toString()}`);1===n?t.remove(i):t.set(i,n-1)})}))}with(...e){return new c(this.data.withMutations(t=>{e.forEach(e=>{const i=t.get(e,0);t.set(e,i+1)})}))}}t.UnitsByMight=c,c.empty=new c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getOrCreateNearestCamp=void 0;const n=i(7),s=i(14),a=i(29),o=i(13),r=i(3),c=i(87),l=i(4);i(1).logger.for("bandits");function d(e,t){const i=t.floodFillOut((t,i,c)=>c<5&&function(e,t){const i=n.Regions.getByHex(e.state,t.id);if(!i)return!1;if(s.Factions.getByRegion(e.state,i)===a.SpecialFaction.neutral)return!0;const c=e.pawns.findOne({hexes:t,traits:[o.PawnTraits.OccupiesTile]});return!c||c.type===r.PawnType.Bandit}(e,t)).filter(t=>function(e,t){var i;if(!(null===(i=e.factions.byHex(t))||void 0===i?void 0:i.isNeutral()))return!1;const n=e.warfare.getOccupyingUnit(t);return!n||n.type===r.PawnType.Bandit}(e,t));let c=void 0,l=Number.NEGATIVE_INFINITY;return i.forEach(t=>{const i=function(e,t){const i=t.neighbours().filter(t=>function(e,t){var i;const n=null===(i=e.regions.byHex(t))||void 0===i?void 0:i.faction;return void 0!==n&&!n.isNeutral()}(e,t)).length,n=t.neighbours().filter(t=>!!e.pawns.findOne({hexes:t,type:[r.PawnType.Forest]})).length,s=t.neighbours().filter(t=>!e.regions.byHex(t)).length,a=e.pawns.findOne({hexes:t,type:[r.PawnType.Bandit]})?3:0;return 2*n+s-2*i+a}(e,t);i>l&&(c=t,l=i)}),c}t.getOrCreateNearestCamp=function(e,t,i){const n=c.Bandits.getNearestCampHex(e.state,t.id);if(c.Bandits.getNearestCampDistance(e.state,t.id)>5){const s=d(e,t);if(s){const t=e.pawns.findOne({hexes:s,type:[r.PawnType.Bandit]});return t&&t.destroy(),e.pawns.create({hex:s,type:r.PawnType.Camp}),i(s.id),s}return n?(0,l.getHex)(n):void 0}return n?(0,l.getHex)(n):void 0}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SetDataSetMutationBuilder=t.SetDataSet=void 0;const s=n(i(10)),a=i(5),o=i(2);t.SetDataSet=class{constructor(e){this.key=e,this.defaultValue=s.default.Set()}deserialize(e){return s.default.Set(e)}serialize(e){return e.toArray()}apply(e,t){t.cleared&&(e=e.set(this.key,s.default.Set()));let i=e.get(this.key);return t.addedEntries&&(i=i.union(t.addedEntries)),t.deletedEntries&&(i=i.subtract(t.deletedEntries)),e.set(this.key,i)}getEntryById(e,t){return e.get(this.key).has(t)}getEntryIds(e){return[]}entryToString(e){return e.toString()}entryToDebugString(e){return e.toString()}createMutation(e,t){let i={};return e.clear&&(i.cleared=!0),e.add&&e.add.length&&(i.addedEntries=e.add),e.delete&&e.delete.length&&(i.deletedEntries=e.delete),{dataSet:this,changes:i,context:`${this.key}/${t}`}}toString(){return`[SetDataSet "${this.key}"]`}};t.SetDataSetMutationBuilder=class{constructor(e){this.dataSet=e}init(e){this.state=e,this._itemsToDelete=new Set,this._itemsToAdd=new Set,this._clear=!1}add(...e){o.assert.defined(this.state,"builder not initialized!"),e.forEach(e=>{this._itemsToDelete.has(e)?this._itemsToDelete.delete(e):this._itemsToAdd.add(e)})}delete(...e){o.assert.defined(this.state,"builder not initialized!"),e.forEach(e=>{this._itemsToAdd.has(e)?this._itemsToAdd.delete(e):this._itemsToDelete.add(e)})}createMutation(e){const t=(0,a.selectFromState)(this.state,this.dataSet);return this.dataSet.createMutation({clear:this._clear,add:Array.from(this._itemsToAdd).filter(e=>!t.has(e)),delete:Array.from(this._itemsToDelete).filter(e=>t.has(e))},e)}clear(){this._clear=!0}}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createBorderHexesDebugLayer=t.RegionBorderHexesProjection=void 0;const s=n(i(10)),a=i(4),o=i(65),r=i(7),c=i(8),l=i(5),d=i(15),h=i(46),u=i(155);class g extends o.MultiMapDataSet{constructor(e,t){super(e),this.regionsHexes=t,this.parents=[this.regionsHexes]}bootstrap(e){return s.default.Map().withMutations(t=>{r.Regions.model(e).all().forEach(i=>{const n=i.hexes.filter(t=>p(e,t,i.id)).map(e=>e.id);n.length&&t.set(i.id,s.default.Set(n))})})}update(e,t,i){var n;const s=new o.MultiMapMutationBuilder(this,e);return null===(n=t.require(this.regionsHexes).updated)||void 0===n||n.forEach(t=>{const i=t.id;if(t.added){(0,a.getHexes)(t.added).forEach(t=>{const n=r.Regions.model(e).byId(i);p(e,t,i)&&s.add(i,t.id),n.hexes.neighboursOf(t).forEach(t=>{p(e,t,i)||s.remove(i,t.id)})})}t.removed&&(s.remove(i,...t.removed),t.removed.forEach(t=>{const n=r.Regions.model(e).byId(i);n?n.hexes.neighboursOf((0,a.getHex)(t)).forEach(e=>{s.add(i,e.id)}):s.removeEntry(i)}))}),s.createMutation("regionsByHexChanged")}entryToString(e){return`[${e.size}]`}}function p(e,t,i){return!!t.findNeighbour(t=>r.Regions.getByHex(e,t.id)!==i)}t.RegionBorderHexesProjection=g,t.createBorderHexesDebugLayer=function(){return new h.GameStateDebugLayer((0,u.hexBasedAdapter)({getValue(e,t){var i,n;const s=r.Regions.getByHex(e,t);if(!s)return;const a=null===(i=(0,l.selectFromState)(e,c.GameState.ai.hostileBorderHexes,s))||void 0===i?void 0:i.has(t),o=null===(n=(0,l.selectFromState)(e,c.GameState.regions.borderHexes,s))||void 0===n?void 0:n.has(t);return a?d.GLYPH.redFlag:o?d.GLYPH.whiteFlag:""},getDetail(e,t){var i,n;const s=r.Regions.getByHex(e,t);if(!s)return;const a=null===(i=(0,l.selectFromState)(e,c.GameState.ai.hostileBorderHexes,s))||void 0===i?void 0:i.has(t);return`\nregion: ${s}\nborder: ${(null===(n=(0,l.selectFromState)(e,c.GameState.regions.borderHexes,s))||void 0===n?void 0:n.has(t))?"YES":"NO"}\nhostile: ${a?"YES":"NO"}`}}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hexBasedAdapter=void 0;const n=i(12),s=i(7),a=i(156);t.hexBasedAdapter=function(e){return Object.assign({getHexes:e=>n.HexGroup.union(s.Regions.model(e).all().map(e=>e.hexes)),getValue:(t,i)=>e.getValue(t,i),getDetail:(t,i)=>e.getDetail(t,i)},(0,a.autoArrowsGenerator)((t,i)=>e.getDetail(t,i)))}},function(e,t,i){"use strict";function n(e){return"object"==typeof e?e.id:e}Object.defineProperty(t,"__esModule",{value:!0}),t.autoArrowsGenerator=void 0,t.autoArrowsGenerator=function(e){return{getParents(t,i){const s=e(t,i);if("object"==typeof s)return s.parent?[n(s.parent)]:s.parents?s.parents.map(n):void 0},getChildren(t,i){const s=e(t,i);if("object"==typeof s)return s.child?[n(s.parent)]:s.children?s.children.map(n):void 0}}}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createHexInfluenceDebugLayer=t.HexRegionInfluenceUpdater=t.InfluenceSpreadHeap=t.RegionInfluenceByHexProjection=void 0;const s=i(21),a=n(i(10)),o=n(i(57)),r=i(7),c=i(5),l=i(26),d=i(1),h=i(18),u=i(14),g=i(4),p=i(24),m=i(15),f=i(8),y=i(2),v=i(46),w=i(158),b=d.logger.for("RegionInfluenceByHexProjection");function S(e){switch(e){case 0:case 1:return 0;case 2:return 1;case 3:return 2;case 4:case 5:return 3;case 6:case 7:case 8:case 9:return 5;default:return 5*Math.floor(e/10)}}class x extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new T(this),this.update=this.updater.update}bootstrap(e){return this.updater.initFromState(e),r.Regions.getAll(e).forEach(t=>{r.Regions.getRegionHexes(e,t).size>=1&&this.updater.addSourcesFromRegion(t)}),this.updater.getMap()}entryToString(e){return e.size?`[${e.size}]`:""}entryToDebugString(e){return e.entrySeq().sort((e,t)=>t[1].resistance-e[1].resistance).map(([e,t])=>`from ${m.GLYPH.whiteFlag}${e} dist ${t.distance} resist ${t.resistance}`).join("\n")}}t.RegionInfluenceByHexProjection=x;class P extends o.default{constructor(){super((e,t)=>e.resistance-t.resistance)}}t.InfluenceSpreadHeap=P;class T extends l.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet),this.invalidation=new Map}createMutation(){return this.updateInvalidated(),super.createMutation()}addSourcesFromRegion(e){const t=h.AI.getHostileBorderHexesByRegion(this.newState,e);for(const i of t)this.addRoot(e,(0,g.getHex)(i))}updateInvalidated(){for(const e of this.invalidation.keys())this.updateInvalidatedForRegion(e)}updateInvalidatedForRegion(e){var t,i,n;const{roots:s,dirtyHexes:a}=this.getOrCreateInvalidationData(e),o=S(r.Regions.getRegionHexes(this.newState,e).size);this.updateInfluenceRange(e);const c=u.Factions.getByRegion(this.newState,e);if(void 0===c)return b.warning(`ignoring request to generate influence from region ${e}, it has no faction assigned`),void this.invalidation.delete(e);const l=new Set;for(const t of s.toArray())0===t.resistance&&this.updateInfluence(e,t.hex,null,0,0);for(const t of a)t.neighbours(e=>!a.has(e)).forEach(t=>{var i;const n=null===(i=this.builder.getCurrent(t.id))||void 0===i?void 0:i.get(e);void 0!==(null==n?void 0:n.resistance)&&this.addRoot(e,t,n.resistance,n.distance)});for(;!s.empty();){const{hex:a,resistance:d,distance:h}=s.pop();l.add(a);const u=a.neighbours(t=>{if(l.has(t))return!1;const i=r.Regions.getByHex(this.newState,t.id);return void 0!==i&&i!==e});for(let r of u.members){const u=d+this.getInfluenceSpreadResistance(c,r),g=null!==(n=null===(i=null===(t=this.builder.getCurrent(r.id))||void 0===t?void 0:t.get(e))||void 0===i?void 0:i.resistance)&&void 0!==n?n:1/0;u<=o&&u<g&&(this.updateInfluence(e,r,a,u,h+1),l.add(r),s.push({hex:r,resistance:u,distance:h+1}))}}this.invalidation.delete(e)}getMap(){return this.updateInvalidated(),a.default.Map(this.builder.getEntries()).mapKeys(e=>Number(e))}registerHandlers(e){e(this.dataSet.sources.hostileBorderHexes,this.handleRegionBorderChange),e(this.dataSet.sources.regionsByHex,this.handleHexRegionChanged),e(this.dataSet.sources.hexDefense,this.handleHexDefenseChanged)}handleRegionBorderChange(e){for(let t of e.updated||[]){const e=t.id;for(let i of t.added||[])this.addRoot(e,(0,g.getHex)(i));for(let i of t.removed||[])this.invalidateSource(e,(0,g.getHex)(i))}}invalidateSource(e,t){var i;r.Regions.getByHex(this.newState,t.id)!==e&&this.markDirty(e,t);const n=null===(i=this.builder.getCurrent(t.id))||void 0===i?void 0:i.get(e);if(n){this.removeInfluence(t,e);for(const t of n.children)this.invalidateSource(e,t)}}getOrCreateInvalidationData(e){let t=this.invalidation.get(e);return t||(t={dirtyHexes:new Set,roots:new P},this.invalidation.set(e,t)),t}addRoot(e,t,i=0,n=0){this.getOrCreateInvalidationData(e).roots.push({hex:t,resistance:i,distance:n})}markDirty(e,t){this.getOrCreateInvalidationData(e).dirtyHexes.add(t)}getParentOf(e,t){return t.findNeighbour(i=>{var n,s;return!!(null===(s=null===(n=this.builder.getCurrent(i.id))||void 0===n?void 0:n.get(e))||void 0===s?void 0:s.children.includes(t))})}clearParent(e,t){var i;const n=this.getParentOf(e,t);if(!n)return;const s=this.builder.getCurrent(n.id),o=(null===(i=null==s?void 0:s.get(e))||void 0===i?void 0:i.children)||a.default.Set();this.builder.set(n.id,s.setIn([e,"children"],o.delete(t)))}updateInfluence(e,t,i,n,s){var o;const r=this.builder.getCurrent(t.id)||a.default.Map();if(r.get(e)&&this.clearParent(e,t),this.builder.set(t.id,r.set(e,{children:a.default.Set(),resistance:n,distance:s})),i){const n=this.builder.getCurrent(i.id);y.assert.defined(n);const s=(null===(o=n.get(e))||void 0===o?void 0:o.children)||a.default.Set();this.builder.set(i.id,n.setIn([e,"children"],s.add(t)))}}removeInfluence(e,t){const i=this.builder.getCurrent(e.id);if(!i)return;this.clearParent(t,e);const n=i.delete(t);0===n.size?this.builder.delete(e.id):this.builder.set(e.id,n)}getInfluenceSpreadResistance(e,t){return u.Factions.getByHex(this.newState,t.id)===e?0:1+p.Warfare.getHexDefense(this.newState,t)}handleHexRegionChanged(e){var t;for(let[i,n]of e.updated||[]){const e=(0,g.getHex)(i),s=r.Regions.getByHex(this.oldState,i),o=u.Factions.getByHex(this.oldState,i),c=u.Factions.getByHex(this.newState,i);if(s===n)return;let l;s?(this.getOrCreateInvalidationData(s),this.invalidateSource(s,e),l=null===(t=this.builder.getCurrent(i))||void 0===t?void 0:t.keySeq().filter(e=>{const t=u.Factions.getByRegion(this.newState,e);return t===c||t===o||void 0===c}).toArray()):l=e.neighbours().map(e=>{var t;return(null===(t=this.builder.getCurrent(e.id))||void 0===t?void 0:t.keySeq().toSet())||a.default.Set()}).reduce((e,t)=>null==t?void 0:t.union(e)).toArray(),n&&this.getOrCreateInvalidationData(n),null==l||l.forEach(t=>{this.invalidateSource(t,e)})}}updateInfluenceRange(e){if(!this.oldState)return;const t=S(r.Regions.getRegionHexes(this.oldState,e).size),i=S(r.Regions.getRegionHexes(this.newState,e).size);i>t?this.addLeafsAsRoots(e):i<t&&this.cullInfluenceRange(e,i)}addLeafsAsRoots(e){var t;let i=h.AI.getHostileBorderHexesByRegion(this.oldState,e).toArray();for(;i.length>0;){const n=i.pop(),s=null===(t=this.builder.getCurrent(n))||void 0===t?void 0:t.get(e);s&&(this.addRoot(e,(0,g.getHex)(n),s.resistance,s.distance),s.children.size>0&&i.push(...s.children.toArray().map(e=>e.id)))}}cullInfluenceRange(e,t){var i;let n=h.AI.getHostileBorderHexesByRegion(this.oldState,e).toArray();for(;n.length>0;){const s=n.pop(),a=null===(i=this.builder.getCurrent(s))||void 0===i?void 0:i.get(e);a&&(a.resistance>t?this.removeSubTree(e,(0,g.getHex)(s)):n.push(...a.children.toArray().map(e=>e.id)))}}removeSubTree(e,t){var i,n;const s=(null===(n=null===(i=this.builder.getCurrent(t.id))||void 0===i?void 0:i.get(e))||void 0===n?void 0:n.children.toArray())||[];this.removeInfluence(t,e),s.forEach(t=>this.removeSubTree(e,t))}handleHexDefenseChanged(e){for(let[t,i]of e.updated||[])this.invalidateForAllRegionsExceptOwner((0,g.getHex)(t))}invalidateForAllRegionsExceptOwner(e){var t,i;const n=r.Regions.getByHex(this.newState,e.id),s=new Set(null===(t=this.builder.getCurrent(e.id))||void 0===t?void 0:t.keySeq().filter(e=>e!==n));for(const t of e.neighbours().members)null===(i=this.builder.getCurrent(t.id))||void 0===i||i.keySeq().filter(e=>e!==n).forEach(e=>s.add(e));null==s||s.forEach(t=>this.invalidateSource(t,e))}}t.HexRegionInfluenceUpdater=T,t.createHexInfluenceDebugLayer=function(e){return new v.GameStateDebugLayer((0,w.dataSetAdapter)(f.GameState.ai.regionInfluenceByHex,{getValue:t=>{var i;return null===(i=t.get(e))||void 0===i?void 0:i.resistance.toString()},arrowDataRetriever:(t,i)=>{var n;return null===(n=(0,c.selectFromState)(t,f.GameState.ai.regionInfluenceByHex,i))||void 0===n?void 0:n.get(e)}}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gettersFromDataSet=t.factionDataSetAdapter=t.regionDataSetAdapter=t.dataSetAdapter=void 0;const n=i(5),s=i(12),a=i(156),o=i(88),r=i(74);function c(e,t){const i=t.getValue||(t=>e.entryToString(t)),s=t.getDetail||(t=>e.entryToDebugString(t));return{getValue(t,s){const a=(0,n.selectFromState)(t,e,s);return a&&i(a)},getDetail(t,i){const a=(0,n.selectFromState)(t,e,i);return a&&s(a)}}}t.dataSetAdapter=function(e,t={}){const i=t.arrowDataRetriever||((t,i)=>(0,n.selectFromState)(t,e,i));return Object.assign(Object.assign({getHexes:t=>s.HexGroup.fromIds(e.getEntryIds(t))},c(e,t)),(0,a.autoArrowsGenerator)(i))},t.regionDataSetAdapter=function(e,t={}){return(0,o.regionBasedAdapter)(c(e,t))},t.factionDataSetAdapter=function(e,t={}){return(0,r.factionBasedAdapter)(c(e,t))},t.gettersFromDataSet=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProxyHexGroupValuation=void 0;t.ProxyHexGroupValuation=class{constructor(e,t){this.parent=e,this.proxyFunc=t}get(e){return this.proxyFunc(this.parent.get(e),e)}getHexIds(){return this.parent.getHexIds()}}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexDefenseUpdater=t.HexDefenseProjection=void 0;const s=i(21),a=n(i(10)),o=i(4),r=i(5),c=i(17),l=i(9),d=i(26),h=i(7),u=i(24);class g extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new p(this).update}bootstrap(e){return a.default.Map().withMutations(t=>{(0,o.getHexes)((0,r.selectFromState)(e,this.sources.regionByHex).keySeq().toArray()).map(i=>{const n=this._calculate(e,i);n>0&&t.set(i.id,n)})})}_calculate(e,t){const i=u.Warfare.getHexLocalDefense(e,t.id);return h.Regions.getSameRegionNeighbours(e,t).map(t=>u.Warfare.getHexProjectedDefense(e,t.id)).reduce(l.max,i)}}t.HexDefenseProjection=g;class p extends d.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}initialize(){this.pawns=c.Pawns.model(this.newState),this.dirtyHexes=new Set}registerHandlers(e){e(this.dataSet.sources.hexDefenseSources,e=>this._handleHexDefenseSourcesChanged(e)),e(this.dataSet.sources.regionByHex,e=>this._handleRegionByHexChange(e))}_handleHexDefenseSourcesChanged(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{const i=(0,o.getHex)(e);this.dirtyHexes.add(i),h.Regions.getSameRegionNeighbours(this.oldState,i).forEach(e=>this.dirtyHexes.add(e))})}_handleRegionByHexChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{const i=(0,o.getHex)(e);this.dirtyHexes.add(i),u.Warfare.getHexProjectedDefense(this.oldState,e)>0&&(h.Regions.getSameRegionNeighbours(this.oldState,i).forEach(e=>this.dirtyHexes.add(e)),h.Regions.getSameRegionNeighbours(this.newState,i).forEach(e=>this.dirtyHexes.add(e)))})}createMutation(){return this.dirtyHexes.forEach(e=>{const t=this.dataSet._calculate(this.newState,e);t>0?this.builder.set(e.id,t):this.builder.delete(e.id)}),super.createMutation()}}t.HexDefenseUpdater=p},,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gatherIncome=t.startPhase=void 0;const n=i(6),s=i(3),a=i(2);t.startPhase=function e(t){switch(t.currentPhase.type){case s.PhaseTypes.GameStart:return t.currentPhase.set({type:s.PhaseTypes.FactionTurn,faction:1,turnNumber:1}),e(t);case s.PhaseTypes.FactionTurn:const i=t.currentPhase.faction;return a.assert.defined(i),function(e,t){const i=[];return t.getRegions().forEach(t=>{a.assert.defined(t);const n=e.economy.gatherIncomeAndPayUpkeep(t);(n.unitsTurnedBandits.length>0||n.newBanditCamps.length>0||Object.keys(n.coinTransfers).length>0)&&i.push(n)}),[n.GameEvents.FactionEconomyUpdated({state:e.state,factionId:t.id,regionReports:i})]}(t,i);default:return[]}},t.gatherIncome=function(e){if(e.currentPhase.type!==s.PhaseTypes.FactionTurn)return[];const t=e.currentPhase.faction;return a.assert.defined(t),function(e,t){const i=[];return t.getRegions().forEach(t=>{a.assert.defined(t);const n=e.economy.gatherRegionIncome(t);(n.unitsTurnedBandits.length>0||n.newBanditCamps.length>0||Object.keys(n.coinTransfers).length>0)&&i.push(n)}),[n.GameEvents.FactionEconomyUpdated({state:e.state,factionId:t.id,regionReports:i})]}(e,t)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FixedCapacityArray=void 0;t.FixedCapacityArray=class{constructor(e){this.cursor=0,this.data=[],this.size=0,Array.isArray(e)?(this.data=e,this.size=this.data.length):this.size=e}get length(){return this.data.length}push(e){this.data[this.cursor]=e,this.cursor=(this.cursor+1)%this.size}getItems(){return this.data.slice(this.cursor,this.size).concat(...this.data.slice(0,this.cursor))}get(e){return this.data[(this.cursor+e)%this.data.length]}pop(){const e=this.getItems(),t=e[e.length-1];return this.data=this.getItems().slice(0,this.data.length-1),this.cursor=this.data.length,t}clear(){this.data=[],this.cursor=0}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getHexUnderCursor=t.watchableHexUnderCursor=void 0;const n=i(0),s=i(39),a=i(113),o=i(4);function r(e,t){let i,a,r=(e.input.activePointer.worldX+s.HEX_WIDTH/2)/s.HEX_WIDTH,c=e.input.activePointer.worldY/s.HEX_INNER_HEIGHT,l=r%1,d=c%1;n.inject.debugData;Math.floor(c)%2?l<.5?d<(1-2*l)/3?(i=Math.floor(r),a=Math.floor(c)-1/3):(i=Math.floor(r)+.5,a=Math.floor(c)+2/3):d<1/3-2*(1-l)/3?(i=Math.floor(r)+1,a=Math.floor(c)-1/3):(i=Math.floor(r)+.5,a=Math.floor(c)+2/3):l<.5?d<2*l/3?(i=Math.floor(r)+.5,a=Math.floor(c)-1/3):(i=Math.floor(r),a=Math.floor(c)+2/3):d<2/3-2*l/3?(i=Math.floor(r)+.5,a=Math.floor(c)-1/3):(i=Math.floor(r)+1,a=Math.floor(c)+2/3),i-=1,a-=2/3;let h=Math.round(a),u=Math.round(i+h%2/2);if(t.map.isWithinBounds({r:h,c:u}))return(0,o.getHex)({r:h,c:u})}t.watchableHexUnderCursor=function(){const e=(0,a.watchable)(void 0);return e.update=t=>{const i=n.inject.gameStateModel;t.input.activePointer.updateWorldPoint(t.cameras.main);const s=r(t,i);e.set(s)},e},t.getHexUnderCursor=r},,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TypedEventBus=void 0;const n=i(11),s=i(1).logger.for("events");class a{constructor(e){this.parent=e,this.handlers={}}on(e,t){(0,n.pushIntoArrayByKey)(this.handlers,e.eventName,t);const i=this.on.bind(this),s=this.handlers;return{unsubscribe(){(0,n.removeFromArrayInPlace)(s[e.eventName],t)},on:i}}trigger(e){let t=!1,i=!1;for(let n of this.handlers[e.name]||[])if(i=!0,n(e.payload,()=>t=!0),t)return;t=!1,this.defaultHandler&&(this.defaultHandler(e,()=>t=!0),i=!0),t||(this.parent?this.parent.trigger(e):i||s.warning(`No handler currently registered for event ${e.name} - ignoring.`))}setDefaultHandler(e){this.defaultHandler=e}createChild(){return new a(this)}}t.TypedEventBus=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createExposedHexesDebugLayer=t.ExposedHexes=void 0;const n=i(24),s=i(27),a=i(0),o=i(8),r=i(66),c=i(18),l=i(15),d=i(17),h=i(3);function u(e,t){let i=(0,s.signal)();const n=a.inject.gameStateModel;return n.stateEngine.watchDataSet(o.GameState.ai.regionInfluenceByHex,()=>{i.fire()}),n.stateEngine.watchDataSet(o.GameState.ai.hexImportance,()=>{i.fire()}),{name:"ai.exposedHexes",onChange:i,getMap(){let i=new r.CustomHexGroupValuation("");const s=e.get(t);return e.region.hexes.forEach(a=>{s.has(a)?i.set(a.id,l.GLYPH.redFlag+n.ai.getHexImportance(a)):e.isImportantEnough(a,t)?i.set(a.id,l.GLYPH.defense):i.set(a.id,n.ai.getHexImportance(a).toString())}),i},getDetail(i){const s=e.threatAssessment.get(i.id).strongestUnit,a=n.warfare.getHexDefense(i),o=e.threatAssessment.get(i.id).riskByMight[a]||0;return`importance: ${n.ai.getHexImportance(i)} / ${t} ${e.isImportantEnough(i,t)?l.GLYPH.redFlag:""}\nthreat ${s} / ${n.warfare.getHexDefense(i)} ${e.isThreatened(i)?l.GLYPH.redFlag:""}\ncredibility ${Math.round(100*o)}% for might ${a+1}`}}}t.ExposedHexes=class{constructor(e,t){this.region=e,this.threatAssessment=t}get(e){return this.threatenedHexes||(this.threatenedHexes=this.region.hexes.filter(e=>this.isThreatened(e))),this.threatenedHexes.filter(t=>this.isImportantEnough(t,e))}isImportantEnough(e,t){var i;return((null===(i=c.AI.getHexImportance(this.region.state,e.id))||void 0===i?void 0:i.value)||0)>=t}isThreatened(e){const t=this.threatAssessment.get(e.id),i=n.Warfare.getHexDefense(this.region.parentModel.state,e),s=d.Pawns.model(this.region.parentModel.state).presentAtHex(e,h.PawnType.Town);return t.strongestUnit>i&&(s||t.riskByMight[i]>=.25)}getDebugLayer(e=0){return u(this,e)}invalidateCache(){this.threatenedHexes=void 0}},t.createExposedHexesDebugLayer=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.estimateStrongestUnitAtRange=t.ThreatAssessmentDebugLayer=t.ThreatAssessment=void 0;const n=i(18),s=i(14),a=i(86),o=i(0),r=i(4),c=i(24),l=i(46),d=i(291),h=i(58),u=i(59),g=i(7),p=i(76),m=i(9);i(1).logger.for("ai:ThreatAssessment");class f extends d.CalculatedHexGroupValuationWithCache{constructor(e,t){super(),this.faction=e,this.advisors=t,this.unitSolver=new a.UnitSolver({economic:u.UNRESTRICTED_ECONOMIC_ADVISOR,armyComposition:h.UNRESTRICTED_ARMY_COMPOSITION})}calculate(e){const t=this.getComponents(e),i=[0,0,0,0];for(const e of t)e.riskByMight.forEach((e,t)=>{i[t]=p.Probability.ofEither(i[t],e)});return{riskByMight:i,strongestUnit:t.map(e=>e.riskByMight.length).reduce(m.max,0)}}getComponents(e){return function(e,t,i){const a=e.parentModel.state;return n.AI.getHexInfluence(a,t).filter((t,i)=>s.Factions.getByRegion(a,i)!==e.id).map((e,n)=>{const s=g.Regions.model(a).byId(n);if(!s)return{regionId:n,riskByMight:[]};const o=s.power.totalMight,l=c.Warfare.getHexDefense(a,(0,r.getHex)(t)),d=v({totalMight:o,maxUnitMight:s.power.maxObtainableUnitMight,maxUnitCount:s.power.maxObtainableUnitCount,resistance:e.resistance-l-1,distance:e.distance});return d<=l?{regionId:n,riskByMight:[]}:{regionId:n,riskByMight:[1,2,3,4].filter(e=>e<=d).map(t=>{const n=t>s.power.maxSustainableUnitMight?.1:1;return i.political.getPerceivedThreat(s)*n/e.resistance}).filter(e=>e>0)}}).valueSeq().toArray().filter(({regionId:e,riskByMight:t})=>t.length>0)}(this.faction,e,this.advisors)}getDebugLayer(){return new y(this)}}t.ThreatAssessment=f;class y extends l.GameStateDebugLayer{constructor(e){super({getValue(t,i){const n=e.get(i);if(n&&0!==n.strongestUnit)return`${n.strongestUnit}\n${Math.round(100*n.riskByMight[n.strongestUnit-1])}%`},getDetail(t,i){if(o.inject.gameStateModel.factions.byHex((0,r.getHex)(i))!==e.faction)return"";return e.getComponents(i).map(e=>e.riskByMight.map((t,i)=>`  ${i+1} (${(100*t).toFixed(0)}%) from ${e.regionId}`).join("\n")).join("\n")},getHexes:t=>e.faction.hexes}),this.assessment=e}}function v(e){const t=e.maxUnitCount-(e.distance-1),i=e.totalMight-e.resistance;return t<=0?0:1===t?i:Math.min(i,e.maxUnitMight)}t.ThreatAssessmentDebugLayer=y,t.estimateStrongestUnitAtRange=v},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CompositePlanner=void 0;const s=n(i(57)),a=i(27),o=i(66),r=i(159),c=i(9);i(1).logger.for("ai:CompositePlanner");t.CompositePlanner=class{constructor(e){this.options=e,this.name="CompositePlanner",this.candidatePlans=[],this.candidatePlansHeap=new s.default((e,t)=>t.utility-e.utility)}*generatePlans(e,t){for(const i of this.options.allowedTactics)for(const n of i.generatePlans(e,t))this.candidatePlans.push(n),this.candidatePlansHeap.push(n);for(;!this.candidatePlansHeap.empty();)yield this.candidatePlansHeap.pop()}getDebugLayer(){return{onChange:(0,a.signal)(),getMap:()=>{const e=new o.CustomHexGroupValuation([]);this.candidatePlans.forEach(t=>{const i=t.hex;i&&e.set(i.id,[...e.get(i.id),t])});return new r.ProxyHexGroupValuation(e,e=>e.map(e=>e.utility).reduce(c.max,-1/0))},getDetail:e=>this.candidatePlans.filter(t=>t.hex===e).sort((e,t)=>t.utility-e.utility).map(e=>e.toString()+"\n"+e.toDebugString()).join("\n")}}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.WartimeEconomicAdvisor=t.AssaultPoliticalStrategy=t.WartimePoliticalStrategy=t.warStrategy=t.Tactic=void 0;const s=i(3),a=i(18),o=i(9),r=i(58),c=i(91),l=i(92),d=i(116);!function(e){e.Expedition="expedition",e.Defend="defend",e.Expand="expand",e.HoardGold="hoardGold"}(t.Tactic||(t.Tactic={}));t.warStrategy=({warSupportByFaction:e})=>t=>n(void 0,void 0,void 0,(function*(){const i=t.game.currentState;t.setAdvisors({political:new h(i,t.region,e),economic:new u,armyComposition:new r.BalancedGrowthArmyComposition(t.region,.5)});const n=Array.from(e.values()).reduce(o.max,2*d.MIN_WAR_SUPPORT_THRESHOLD),s=Array.from(e.entries()).filter(([e,t])=>t>=.75*n).map(([e,t])=>`${e}(${t})`).join(", ");yield t.breakpoint("ai:strategy: WAR against "+s);const a=[l.Planners.Default],g=new c.SituationExplorer(t);for(t.focus={offense:2,defense:0,growth:.5};yield g.tryBest(a););for(t.focus={offense:2,defense:1,growth:.5};yield g.tryBest(a););if(!g.isSafe()){for(g.considerCurrentSituation(),g.backtrack(.5),t.focus={offense:1,defense:1,growth:.5};yield g.tryBest(a););if(g.isSafe())return g.considerCurrentSituation(),void g.goToBestOutcomeSoFar();for(g.backtrack(1),t.focus={offense:.5,defense:2,growth:.5},yield g.tryBest(a),t.focus={offense:1,defense:1,growth:.5};yield g.tryBest(a););g.considerCurrentSituation(),g.goToBestOutcomeSoFar()}}));class h{constructor(e,t,i){this.state=e,this.region=t,this.warSupportByFaction=i}getPerceivedThreat(e){const t=e.faction;if(!e.isAlive()||!t)return 0;const i=(100+(this.warSupportByFaction.get(t.id)||0))/100,n=Math.min(100,a.AI.getRegionAttrition(this.state,this.region.id,t.id)),s=n>0?(120+n)/100:1;return i<=1?i*s*.5:i*s}getWillingnessToAttack(e){const t=e.faction;if(!t||t.controller===s.FactionController.None)return 1;const i=e.isAlive()?1:.1;return this.getHostilityTowardsFaction(t)*((100+Object.values(a.AI.getFactionAttrition(this.state,t.id)).reduce(o.sum,0)*i)/100)}getHostilityTowardsFaction(e){if(!e||e.controller===s.FactionController.None)return 1;const t=this.warSupportByFaction.get(e.id)||0,i=a.AI.getFactionApproval(this.state,this.region.faction.id,e.id);if(t>0)return(100+t)/100;return(100-(i>0?Math.max(i,90):0))/100}}t.WartimePoliticalStrategy=h;t.AssaultPoliticalStrategy=class{constructor(e,t,i){this.state=e,this.region=t,this.warSupportByFaction=i}getPerceivedThreat(e){return 0}getWillingnessToAttack(e){const t=e.faction;if(!t||t.controller===s.FactionController.None)return 1;return(this.warSupportByFaction.get(t.id)||0)>0?.5:2}getHostilityTowardsFaction(e){return 0}};class u{getWillingnessToSpend(e,t,i){const n=e.willSacrifice?i:0,s=e.remainingGold-t,a=e.remainingIncome+1+Math.floor(s/2);return e.remainingGold<t||a-n<0?0:.98-t/1e3}getMinimalAcceptableIncome(e){return Math.min(-Math.floor(e.remainingGold/10),-1)}}t.WartimeEconomicAdvisor=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveSizeComponent=void 0;class n{constructor(e){this.parent=e,this._width=0,this._height=0}set height(e){this._height!==e&&(this._height=e,this.parent.preUpdate.makeDirty())}get height(){return this._height}set width(e){this._width!==e&&(this._width=e,this.parent.preUpdate.makeDirty())}get width(){return this._width}set(e,t){return this.width=e,this.height=t,this.parent}static overrideSizeComponent(e){const t=new n(e);Object.defineProperties(e,{width:{set:e=>{t.width=e},get:()=>t.width},height:{set:e=>{t.height=e},get:()=>t.height}}),e.setSize=t.set.bind(t)}}t.ResponsiveSizeComponent=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PassiveButtonStateController=void 0;const n=i(27),s=i(0),a=i(31),o=i(44);t.PassiveButtonStateController=class{constructor(){this.enabled=!0,this.state=o.ButtonState.Rest,this.onClicked=(0,n.signal)(),this.selected=!1}getState(){return this.state}bindTo(e,t){this.applyState=t,e.removeAllListeners(),e.setInteractive({useHandCursor:!0}).on("pointerdown",()=>{this.enabled?(this.onClicked.fire(),s.inject.audio.playEffect(a.SoundEffects.ButtonDown)):s.inject.audio.playEffect(a.SoundEffects.Deny)})}setSelected(e){this.selected=e,this.state!==o.ButtonState.Hover&&this.enabled&&this.setState(e?o.ButtonState.Down:o.ButtonState.Rest)}setEnabled(e){this.enabled=e,this.setState(e?this.getIdleState():o.ButtonState.Disabled)}setState(e){e!==this.state&&(this.state=e,this.applyState(e))}getIdleState(){return this.selected?o.ButtonState.Down:o.ButtonState.Rest}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getAppController=void 0;const n=i(178),s=i(318),a=i(413);t.getAppController=function(e){switch(e){case n.LaunchMode.Standard:return new s.GameAppController;case n.LaunchMode.Storybook:return new a.StorybookAppController}}},function(e,t,i){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),t.configProfiles=t.LaunchMode=void 0,function(e){e[e.Standard=0]="Standard",e[e.Storybook=1]="Storybook"}(n=t.LaunchMode||(t.LaunchMode={})),t.configProfiles={dev:{mode:n.Standard,mapRegistryUrl:"assets/maps.json",debug:{overlay:!0,ai:!1,breakpoints:["ai"],cheats:!0,chunkBorders:!1,gameObjects:!1,objectPools:!0,recordStateChanges:!1,uiLayout:!1,integrityChecks:{pawns:!0,gameState:!1},checkWorldMapIntegrity:!1,tweenSpeedFactor:1,skipTransitions:!1,tileTextureAtlas:!1},allowEditing:!0,autoSaveOnTurnStart:!0,autoSaveOnTurnEnd:!0,useServiceWorker:!1,antialiasing:!0,screenTransitionDuration:300,flags:{seeEnemyAttitudes:!1}},production:{mode:n.Standard,mapRegistryUrl:"assets/maps.json",debug:{overlay:!1,ai:!1,breakpoints:!1,cheats:!1,gameObjects:!1,objectPools:!1,chunkBorders:!1,recordStateChanges:!1,integrityChecks:void 0,checkWorldMapIntegrity:!1,tweenSpeedFactor:1,skipTransitions:!1},allowEditing:!0,autoSaveOnTurnStart:!0,autoSaveOnTurnEnd:!0,useServiceWorker:!0,antialiasing:!0,screenTransitionDuration:300,flags:{seeEnemyAttitudes:!1}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DistanceMap=void 0;const n=i(66),s=i(2);class a extends n.CustomHexGroupValuation{constructor(e){super(1/0),this.hexes=e}addSources(e){(0,s.assert)(e.members.every(e=>this.hexes.has(e))),this.hexes.bfsFrom(e,(e,t,i)=>(this.get(e.id)>i||0===i)&&(this.set(e.id,i),!0))}getDistanceTo(e){return this.get(e.id)}getMostDistantHex(){return this.hexes.findMax(e=>this.getDistanceTo(e))}dump(){return this.hexes.map(e=>`${e} = ${this.getDistanceTo(e)}`).join("\n")}}t.DistanceMap=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compareStrings=t.padLeft=t.padRight=void 0,t.padRight=function(e,t){return e.length===t?e:e.length>t?e.slice(0,t):e+" ".repeat(t-e.length)},t.padLeft=function(e,t){return e.length===t?e:e.length>t?e.slice(0,t):" ".repeat(t-e.length)+e},t.compareStrings=function(e,t){return e>t?1:e<t?-1:0}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalWindowScene=void 0;const n=i(16),s=i(327),a=i(0),o=i(93),r=i(47),c=i(32);var l=Phaser.GameObjects.Rectangle;class d extends r.BaseUIScene{constructor(){super({key:n.Scenes.ModalWindow}),this.debugLayer=new o.UiDebugLayer(this),this.modalsStack=[],this.preUpdate=(0,c.whenDirty)(()=>{this.window.setPosition(this.cameras.main.width/2,this.cameras.main.height/2),this.backgroundOverlay.setSize(this.cameras.main.width,this.cameras.main.height),this.debugLayer.clear(),a.inject.config.debug.uiLayout&&(this.debugLayer.addHorizontalLine(this.cameras.main.height/2),this.debugLayer.addVerticalLine(this.cameras.main.width/2))})}pushModal(e,t){var i;const n={content:e,props:t};null===(i=a.inject.navigator.currentScreen)||void 0===i||i.pause(),this.modalsStack.push(n),this.doShowModal(n),this.updateDebugData()}updateDebugData(){this.modalsStack.length?a.inject.debugData.set("modalWindow",this.modalsStack.map(e=>e.content.constructor.name).join(" > ")):a.inject.debugData.clear("modalWindow")}doShowModal({content:e,props:t}){this.window.setProps({title:e.getTitle(t),content:e.getUiElement(this,Object.assign(Object.assign({},t),{onClose:e=>{this.closeModal(),t.onClose(e)}}))}),this.preUpdate(),this.fadeIn()}fadeIn(){this.window.animateIn(),this.add.tween({targets:this.backgroundOverlay,alpha:1,ease:"Sine.easeOut",duration:400})}fadeOut(e){this.window.animateOut(),this.add.tween({targets:this.backgroundOverlay,alpha:{from:1,to:0},ease:"Sine.easeOut",duration:400,onComplete:e})}closeModal(){var e;this.modalsStack.pop();const t=this.modalsStack[this.modalsStack.length-1];t?this.doShowModal(t):(null===(e=a.inject.navigator.currentScreen)||void 0===e||e.resume(),this.fadeOut(()=>{0===this.modalsStack.length&&this.scene.sleep()})),this.updateDebugData()}create(){if(this.cameras.main.roundPixels=!0,this.window)throw new Error("Attempt to create ModalWindowScene for a second time");this.window=new s.Window(this,{title:""}),this.backgroundOverlay=new l(this,0,0,0,0,0,.5),this.add.existing(this.backgroundOverlay),this.window.addTo(this)}}t.ModalWindowScene=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tweener=t.BasicTweener=t.Tween=void 0,t.Tween=Phaser.Tweens.Tween;const n=i(23),s=i(1),a=i(11);s.logger.for("Tweener");t.BasicTweener=class{constructor(){this.currentTweens=new Set,this.currentCallback=n.noop}setTweens(e,t){this.currentTweens.forEach(e=>e.stop()),this.currentTweens=new Set(e),this.currentCallback=t||n.noop,e.forEach(e=>e.on("complete",e=>this.handleCompleted(e)))}handleCompleted(e){0!==this.currentTweens.size&&(this.currentTweens.delete(e),0===this.currentTweens.size&&(this.currentCallback(),this.currentCallback=n.noop))}};t.Tweener=class{constructor(e){this.scene=e,this.tweensByTarget=new Map}add(e){const t=e.onComplete,i=Array.isArray(e.targets)?e.targets:[e.targets];e.onComplete=(...e)=>{for(let e of i)this.tweensByTarget.delete(e);null==t||t(...e)};const n=this.scene.tweens.add(e);if(e.targets)for(let e of i){const t=this.tweensByTarget.get(e);t&&(1===t.targets.length&&t.targets[0]===e?t.stop():(0,a.removeFromArrayInPlace)(t.targets,e)),this.tweensByTarget.set(e,n)}return n}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PreloadScene=void 0;const n=i(16),s=i(0),a=i(6),o=i(36);class r extends o.Scene{constructor(){super({key:n.Scenes.Preload})}preload(){}update(){}create(){var e,t;this.load.spritesheet("coin","assets/img/coin-animated.png",{frameWidth:20,frameHeight:18}),this.load.spritesheet("coin-hd","assets/img/coin-animated-hd.png",{frameWidth:20,frameHeight:18}),this.load.spritesheet("flag","assets/img/flag-animated.png",{frameWidth:12,frameHeight:11}),this.load.multiatlas("atlas","assets/atlas.json","assets"),this.load.bitmapFont("debug","assets/fonts/debug.png","assets/fonts/debug.xml"),s.inject.audio.load(this),s.inject.fonts.load(this),this.game.renderer.type!==Phaser.CANVAS?(this.load.once(Phaser.Loader.Events.COMPLETE,()=>{s.inject.events.trigger(a.SystemEvents.EngineInitialized()),this.scene.stop()}),null===(t=null===(e=window.document.getElementById("phaser-game"))||void 0===e?void 0:e.classList)||void 0===t||t.remove("hidden"),this.load.start()):document.getElementById("status").innerText="Your browser/device does not seem to support WebGL, which is required to run this game. Sorry!"}}t.PreloadScene=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getWorldBounds=t.EXTRA_SPACE_FOR_CONTROL_PANEL=void 0;var n=Phaser.Geom.Rectangle;const s=i(39);t.EXTRA_SPACE_FOR_CONTROL_PANEL=100,t.getWorldBounds=function(e,i){let a=e*s.HEX_WIDTH,o=(i-1)*s.HEX_INNER_HEIGHT+s.HEX_HEIGHT+t.EXTRA_SPACE_FOR_CONTROL_PANEL;return new n(-s.HEX_WIDTH/2,0,a+s.HEX_WIDTH/2,o)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jump2=t.jump=void 0,t.jump=function(e,t){return e-Math.sin(e*Math.PI)*-t},t.jump2=function(e){return Math.sin(e*Math.PI)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.convertWorldXYToCameraXY=void 0;const n=i(0);t.convertWorldXYToCameraXY=function(e,t,i){const s=e.getWorldPoint(0,0);return{x:(t-s.x)*e.zoom/n.inject.device.dpr,y:(i-s.y)*e.zoom/n.inject.device.dpr}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConquerableHexesHighlight=t.DEFAULT_TINT=void 0;const n=i(12),s=i(1),a=i(81),o=i(34),r=i(3),c=i(80),l=i(20),d=i(0),h=i(182),u=s.logger.for("ConquerableHexesHighlight");t.DEFAULT_TINT=l.Colors.highlight.ownedRegion;t.ConquerableHexesHighlight=class{constructor(e,t){this.scene=e,this.objectPool=t,this.indicatorsByHex={},this.tweener=new h.Tweener(this.scene),this.activeHexes=n.HexGroup.empty,this.tint=l.Colors.highlight.ownedRegion,this.alpha=1,this.indicators=this.scene.add.group({defaultKey:"atlas",defaultFrame:"hex-move-indicator",createCallback:e=>{e.setName("indicator"+this.indicators.getLength())}}).setDepth(o.WorldLayers.TileHighlight),this.pawnGhost=this.objectPool.getPawnImage(r.PawnType.Villager).setDepth(o.WorldLayers.FlyingObject).setAlpha(.7).setVisible(!1),this.scene.add.existing(this.pawnGhost)}clear(){this.removeIndicators(Object.keys(this.indicatorsByHex).map(e=>Number(e))),this.activeHexes=n.HexGroup.empty}set(e,i=t.DEFAULT_TINT,n=1){const s=Object.entries(this.indicatorsByHex).filter(([t,i])=>!e.containsId(Number(t))).map(([e,t])=>Number(e));this.removeIndicators(s),this.tint==i&&this.alpha===n||(this.tint=i,this.alpha=n,this._updateTintAndAlpha()),this.add(e,i,n)}_updateTintAndAlpha(){for(let e of Object.values(this.indicatorsByHex))e.setTint(this.tint).setAlpha(this.alpha)}add(e,i=t.DEFAULT_TINT,n=1){const s=[];this.tint=i,this.alpha=n,e.map(e=>{const t=this.indicatorsByHex[e.id]||this.indicators.get(e.display.centerX,e.display.centerY,void 0,void 0,!1).setVisible(!0).setActive(!0).setDepth(o.WorldLayers.TileHighlight);return t.setTint(this.tint).setAlpha(this.alpha),this.indicatorsByHex[e.id]||(this.indicatorsByHex[e.id]=t,s.push(t)),t}),this.tweener.add({targets:s,scale:{from:.5,to:1},alpha:{from:0,to:n},duration:a.TIMING.pawnPickupTransition,ease:"Sine.easeOut"})}setHighlightedHex(e,t){var i,n;const s=this.indicatorsByHex[e.id];s?this.highlightedIndicator!==s&&(this.clearHighlightedHex(),this.highlightedIndicator=s,null===(i=this.highlightedIndicator)||void 0===i||i.setFrame("hex-move-indicator-hover"),null===(n=this.highlightedIndicator)||void 0===n||n.setScale(.75),this.highlightedIndicatorTween=this.tweener.add({targets:s,scale:1,duration:200,ease:"Sine.easeInOut"}),t?this.pawnGhost.setPosition(e.display.centerX,e.display.centerY-10).setFrame((0,c.getFrameForPawnType)(t)).setVisible(!0):this.pawnGhost.setVisible(!1)):u.warning(`ignoring attempt to highlight conquest indicator on hex ${e.id}, which does not currently display conquest indicator`)}clearHighlightedHex(){var e;if(this.highlightedIndicator){const t=this.highlightedIndicator;this.tweener.add({targets:t,scale:.75,duration:100,onComplete:()=>{t.setFrame("hex-move-indicator"),t.setScale(1)},onStop:()=>{t.setFrame("hex-move-indicator")}}),null===(e=this.highlightedIndicatorTween)||void 0===e||e.stop(),this.highlightedIndicator=void 0,this.pawnGhost.setVisible(!1)}}show(){this.indicators.children.each(e=>e.setVisible(e.active))}hide(){this.indicators.setVisible(!1)}removeIndicators(e){const t=e.map(e=>this.indicatorsByHex[e]);this.highlightedIndicator&&t.includes(this.highlightedIndicator)&&this.clearHighlightedHex(),this.tweener.add({targets:t,scale:{from:1,to:.5},alpha:{from:this.alpha,to:0},duration:d.inject.ui.skipTransitions()?0:a.TIMING.pawnPickupTransition,ease:"Sine.easeIn",onComplete:()=>{t.forEach(e=>{this.indicators.killAndHide(e)})}}),e.forEach(e=>delete this.indicatorsByHex[e])}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapEditorOverlay=void 0;const n=i(1),s=i(0),a=i(39),o=i(34),r=i(184);n.logger.for("WorldMapEditorOverlay");t.WorldMapEditorOverlay=class{constructor(e){this.scene=e,this.signalSubs=[],this.active=!1}create(){this.active=!0,this.worldBoundsRectangle=this.scene.add.rectangle(0,0,0,0).setStrokeStyle(1,16777215,.5).setDepth(o.WorldLayers.UIOverlay).setOrigin(0,0),this.hexUnderCursor=this.scene.add.polygon(0,0,a.HEX_POLYGON).setStrokeStyle(1,16777215,.5).setFillStyle(16777215,.2).setVisible(!1).setDepth(o.WorldLayers.UIOverlay).setOrigin(0,0),this.scene.add.existing(this.worldBoundsRectangle),this.scene.add.existing(this.hexUnderCursor),this.registerSignals()}setVisible(e){this.worldBoundsRectangle||this.create(),this.worldBoundsRectangle.setVisible(e),this.hexUnderCursor.setVisible(e),this.active=e,e?this.registerSignals():this.unRegisterSignals()}registerSignals(){this.unRegisterSignals(),this.signalSubs.push(s.inject.ui.hexUnderCursor.watch(e=>{e&&!e.isAtGridBorder(s.inject.gameStateModel.map)?(this.hexUnderCursor.setPosition(e.x*a.HEX_WIDTH,e.y*a.HEX_INNER_HEIGHT),this.hexUnderCursor.setVisible(!0)):this.hexUnderCursor.setVisible(!1)}))}unRegisterSignals(){this.signalSubs.forEach(e=>e.unsubscribe()),this.signalSubs=[]}update(){if(this.active){const e=(0,r.getWorldBounds)(s.inject.gameStateModel.map.width-2,s.inject.gameStateModel.map.height-2);this.worldBoundsRectangle.setPosition(a.HEX_WIDTH/2,a.HEX_INNER_HEIGHT),this.worldBoundsRectangle.setSize(e.width,e.height)}}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.updateHighlightWhileMovingPawn=t.MovingPawnMode=void 0;const s=i(84),a=i(0),o=i(6),r=i(103),c=i(70),l=i(1),d=i(24),h=i(13),u=i(12),g=i(31),p=i(2),m=i(55),f=i(60),y=i(102),v=l.logger.for("MovingPawnMode");class w extends c.BaseMode{constructor(e,t){super(e),this.movingPawn=t}activate(){const e=this.movingPawn.hex,t=this.scene.worldMapScene.getPawnObjectPositionOnScreen(e.id);this.scene.uiScene.pawnHolder.pickUpPawn(this.movingPawn.type,t.x,t.y,t.scale),this.scene.worldMapScene.pawns.hide(e.id),this.scene.worldMapScene.showHexDefenseMarkers(this.movingPawn);const i=a.inject.ui.selectedRegion();p.assert.defined(i),this.scene.showConquerableHexesBasedOn(this.movingPawn.type),i.getPawns().filter(e=>e.type===this.movingPawn.type&&e!==this.movingPawn).forEach(e=>{this.scene.worldMapScene.tileSymbols.add(e.hex,m.TileSymbol.Plus)})}deactivate(){super.deactivate(),this.scene.worldMapScene.tileSymbols.clear(m.TileSymbol.Plus),this.scene.pointerEventsController.abortPawnDrag(),this.scene.worldMapScene.hexMarkers.clear(),this.scene.uiScene.pawnHolder.clear()}canDropPawn(e){const t=this.movingPawn.region,i=a.inject.gameStateModel.warfare.getDropPawnResult(e,this.movingPawn.type,t);return i.type!==d.DropPawnResultType.Invalid||i.reason===d.InvalidDropPawnReason.PreventedByPawn}handleReturnPawn(){const e=this.movingPawn;p.assert.defined(e),this.scene.dropHeldPawnAtHex(e.hex.id).then(()=>{this.scene.worldMapScene.pawns.show(e.hex.id)}),this.scene.setMode(new r.PlayMode(this.scene))}handleDropPawn(e){const t=this.movingPawn,i=this.movingPawn.region;if(p.assert.defined(t),p.assert.defined(i),t.hex===e)return this.handleReturnPawn(),!0;{const n=a.inject.gameStateModel.warfare.getDropPawnResult(e,this.movingPawn.type,i);switch(n.type){case d.DropPawnResultType.Reposition:case d.DropPawnResultType.EradicatePest:case d.DropPawnResultType.Combine:return this.scene.dropHeldPawnAtHex(e.id).then(()=>{a.inject.gameStateController.executePlay(o.Plays.MovePawn({pawnId:t.id,destinationHexId:e.id}))}),this.scene.setMode(new r.PlayMode(this.scene)),a.inject.audio.playEffect(g.SoundEffects.Drop),!0;case d.DropPawnResultType.Conquest:return a.inject.audio.playEffect(g.SoundEffects.Drop),a.inject.gameStateController.executePlay(o.Plays.AttackHex({pawnId:t.id,destinationHexId:e.id})),!0;case d.DropPawnResultType.Invalid:return a.inject.audio.playEffect(g.SoundEffects.Deny),n.reason===d.InvalidDropPawnReason.PreventedByPawn&&this.scene.worldMapScene.cinematics.tileDefense(e,n.blockers).play(),!1}}}handleHexCaptured(e){return n(this,void 0,void 0,(function*(){if(this.movingPawn.id!==e.capturingPawnId)return void v.warning(`ignoring hexCaptured as the capturing pawn ${e.capturingPawnId} doesn't match the currently held pawn ${this.movingPawn}`);yield this.scene.dropHeldPawnAtHex(e.capturedHexId),yield(0,y.clearCapturedHex)(this.scene,e),p.assert.defined(e.originatingHexId);const t=(0,f.mergeTransactions)(e.lootTransactions||{},e.boughtPawnTransactions||{});t&&this.scene.worldMapScene.cinematics.coinTransaction(t).play(),this.scene.worldMapScene.pawns.move(e.originatingHexId,e.capturedHexId),this.scene.worldMapScene.pawns.stopJumping([e.capturedHexId]),this.scene.worldMapScene.pawns.show(e.capturedHexId),yield(0,y.updateCapturedHex)(this.scene,e),this.scene.setMode(new r.PlayMode(this.scene))}))}shouldHighlightHoveredHex(e){return!1}handleDropPawnOnShop(e){const t=a.inject.gameStateModel,i=t.rules.pawns(this.movingPawn.type).mergeRules[e],n=this.movingPawn.hex;return i?(this.scene.uiScene.pawnHolder.setPawnType(i),this.scene.showConquerableHexesBasedOn(i),a.inject.audio.playEffect(g.SoundEffects.Drop),a.inject.gameStateController.executePlay(o.Plays.BuyPawn({pawnType:e,buyerRegionId:this.movingPawn.region.id,destinationHexId:this.movingPawn.hex.id})),this.movingPawn=t.warfare.getOccupyingUnit(n),!1):(a.inject.audio.playEffect(g.SoundEffects.Deny),!1)}handleNewHexUnderCursor(e){b(this.scene,e,this.movingPawn,this.movingPawn.region)}}function b(e,t,i,n){var o;if(t&&(null===(o=e.conquerableHexes)||void 0===o?void 0:o.contains(t))?e.worldMapScene.conquerableHexesHighlight.setHighlightedHex(t):e.worldMapScene.conquerableHexesHighlight.clearHighlightedHex(),t){let o,r;i instanceof s.PawnModel?(o=i,r=o.type):r=i;const c=a.inject.gameStateModel;p.assert.defined(n);const l=c.warfare.getDropPawnResult(t,r,n),g=c.rules.pawns(r).hasTrait(h.PawnTraits.GuardsAdjacentTiles);let m=u.HexGroup.empty;g&&(m=n.hexes.neighboursOf(t).filter(e=>!c.warfare.isOccupied(e)||e===(null==o?void 0:o.hex))),t==(null==o?void 0:o.hex)||l.type===d.DropPawnResultType.Reposition||l.type===d.DropPawnResultType.Conquest?e.worldMapScene.hexMarkers.setHoveredHex(t,c.rules.pawns(r).defense,m):e.worldMapScene.hexMarkers.clearHoveredHex()}else e.worldMapScene.hexMarkers.clearHoveredHex()}t.MovingPawnMode=w,t.updateHighlightWhileMovingPawn=b},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateFear=t.AttitudeView=t.getAttitudeStr=t.getAttitudeIndex=t.ATTITUDE_LABELS=void 0;const n=i(8),s=i(82),a=i(18),o=(i(9),i(1)),r=i(19),c=i(0),l=i(46),d=i(74);o.logger.for("FearView");function h(e,t){let i=0;i=e>=25?0:e>-25?1:2;let n=0;return n=t<=-100?0:t<=-10?1:t<10?2:t<100?3:4,10*i+n}function u(e,i){const n=h(e,i),s=Math.floor(n/10),a=n%10;return t.ATTITUDE_LABELS[s][a]}t.ATTITUDE_LABELS=[["defiant","cornered","nervous","friendly/nervous","subservient"],["furious","angry","reserved","friendly","grateful"],["merciless","annoyed","confident","friendly/confident","benevolent"]],t.getAttitudeIndex=h,t.getAttitudeStr=u;class g extends s.LazyView{constructor(){super([n.GameState.ai.powerByFaction,n.GameState.ai.approval]),this.name="attitude"}calculate(e,t){var i;return(null===(i=this.getComponents(e,t))||void 0===i?void 0:i.attitude)||"-"}getComponents(e,{fromFactionId:t,towardsFactionId:i}){if(t===i)return;const n=c.inject.views.fear.calculate(e,{towardsFactionId:i,fromFactionId:t}),s=a.AI.getFactionApproval(e,t,i);return{fear:n,approval:s,attitude:u(n,s)}}getCacheKey(e){return`${e.fromFactionId}->${e.towardsFactionId}`}getDebugLayer(e){return new l.GameStateDebugLayer((0,d.factionBasedAdapter)({getValue:(t,i)=>{if(i!==e)return this.get(t,{towardsFactionId:e,fromFactionId:i})},getDetail:(t,i)=>{if(i!==e)return(0,r.prettyPrintObject)(this.getComponents(t,{towardsFactionId:e,fromFactionId:i}))}}))}}t.AttitudeView=g,t.calculateFear=function({enemyAlliancePower:e,myAlliancePower:t,myPower:i,totalPower:n,enemyPower:s}){const a=Math.floor(i/n*100),o=Math.floor(s/n*100)-a,r=Math.floor(e/(e+t)*200-100);return{fearOfFactionDomination:o,fearOfGettingCrushed:r,totalFear:Math.max(o,r)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorScene=t.MapEditorInputMode=t.MapEditorActions=t.editorAction=void 0;const n=i(68),s=i(16),a=i(0),o=i(1),r=i(62),c=i(4),l=i(6),d=i(28),h=i(376),u=i(384),g=i(192),p=i(385),m=i(33),f=i(36),y=i(67),v=i(94),w=i(15);var b=Phaser.GameObjects.BitmapText;const S=i(20),x=i(47),P=i(32),T=20,M=360;function C(e){return(0,r.createEventFactory)(r.EventCategory.MapEditor,e)}t.editorAction=C,t.MapEditorActions={SetTool:C("SET_TOOL")},function(e){e.PaintFaction="pain-faction",e.PaintPawns="paint-pawns",e.DeletePawns="delete-objects",e.DeleteTiles="delete-tiles",e.AddCoins="add-coins",e.RemoveCoins="remove-coins"}(t.MapEditorInputMode||(t.MapEditorInputMode={}));o.logger.for(s.Scenes.MapEditor);class I extends x.BaseUIScene{constructor(){super({key:s.Scenes.MapEditor}),this.preUpdate=(0,P.whenDirty)(()=>{}),this.currentTool=g.EDITOR_TOOL.paintRegion[0],this.cursorAttachment=new u.CursorAttachment(this),this.pointerController=new p.MapEditorPointerEventsController({tryStartCameraDrag:()=>(this.worldMapScene.cameraController.startDragScroll(),!0),endCameraDrag:()=>{this.worldMapScene.cameraController.stopDragScroll()},tryStartPaint:()=>!0,endPaint:()=>{}}),this.handleEventWhileActive(n.WorldMapEvents.PointerDown,({hexId:e,flags:t})=>{if(!this.scene.isActive()||!e)return;const i=(0,c.getHex)(e);i&&this.handleHexClicked(i,t)}),this.handleEventWhileActive(n.WorldMapEvents.PointerUp,e=>{this.pointerController.handlePointerUp()}),this.watchWhileActive(a.inject.ui.hexUnderCursor,e=>{e&&this.pointerController.pointerState===p.EditorPointerState.Paint&&this.applyCurrentTool(e)}),this.handleEventWhileActive(l.GameEvents.NewGameState,({state:e})=>{this.worldMapScene.loadNewGameState(e)}),a.inject.events.on(t.MapEditorActions.SetTool,e=>{this.handleToolSelected(e)})}createButton(e,t){const i=new v.BoxButton(this,0,T,{content:new b(this,0,0,w.BitmapFont.Small,e).setTint(S.Colors.woodenUi.primaryText),baseTexture:d.BoxTexture.DialogButton,downTexture:d.BoxTexture.DialogButtonDown,width:102,height:36});return i.onClicked(t),i}create(){super.create(),this.worldMapScene=this.scene.get(s.Scenes.WorldMap),this.resumeButton=this.createButton("PLAY",()=>{a.inject.events.trigger(l.UserActions.ResumeGame())}),this.newGameButton=this.createButton("NEW",()=>{a.inject.events.trigger(l.UserActions.OpenNewGameDialog())}).setTint(4461331,16750968),this.exportButton=this.createButton("EXPORT",()=>{a.inject.events.trigger(l.UserActions.OpenExportMapDialog())}).setTint(2376723,10026855),this.importButton=this.createButton("IMPORT",()=>{a.inject.events.trigger(l.UserActions.OpenLoadGameDialog())}).setTint(4461331,16750968),this.jsonEditButton=this.createButton("EDIT JSON",()=>{a.inject.events.trigger(l.UserActions.EditMapJSON())}),this.backgroundPlate=new d.Box(this,d.BoxTexture.Plate),this.backgroundPlate.setInteractive(),this.palette=new h.MapEditorPalette(this,this.currentTool),this.currentToolDescription=new m.Label(this,""),this.handleToolSelected(this.currentTool),this.add.existing(this.backgroundPlate);[this.palette,this.currentToolDescription].map(e=>e.addTo(this)),this.addAll([this.jsonEditButton,this.resumeButton,this.importButton,this.newGameButton,this.exportButton]),this.scale.on("resize",()=>this.reflow()),this.reflow(),this.input.keyboard.addKey(f.Input.Keyboard.KeyCodes.BACKTICK).on("down",()=>{a.inject.gameStateController.undo()}),a.inject.gameStateController.onEvent(e=>{this.scene.isActive()&&(0,r.isEvent)(e,l.GameEvents.NewGameState)&&this.worldMapScene.loadNewGameState(e.payload.state)})}update(){this.cursorAttachment.update()}updateToolDescription(){var e;this.currentToolDescription.setText(((null===(e=this.currentTool)||void 0===e?void 0:e.description)||"")+"\nalt = drag view\n~ = undo")}handleToolSelected(e){this.currentTool=e,this.cursorAttachment.setImage(this.createCursorAttachmentImage(e)),this.updateToolDescription()}createCursorAttachmentImage(e){const t=e.createIcon(this);return t.setScale(.5*t.scaleX,.5*t.scaleY),t}handleHexClicked(e,t){this.pointerController.handlePointerDown(t),this.pointerController.pointerState===p.EditorPointerState.Paint&&this.applyCurrentTool(e)}applyCurrentTool(e){if(!this.currentTool)return;if(e.isAtGridBorder(a.inject.gameStateModel.map))return;const t=a.inject.gameStateModel.state,{shift:i,ctrl:n}=this.worldMapScene.keys;this.currentTool.useOn(e,{shift:i.isDown,ctrl:n.isDown});t!==a.inject.gameStateModel.state&&(a.inject.gameStateController.addStateToUndoHistory(t),this.updateWorld())}updateWorld(){a.inject.ui.withoutTransitions(()=>{this.worldMapScene.loadNewGameState(a.inject.gameStateModel.state)})}reflow(){const e=this.cameras.main.displayWidth,t=this.cameras.main.displayHeight;this.resumeButton.setPosition(e-this.resumeButton.width-T,T),this.jsonEditButton.setPosition(this.resumeButton.x-8-this.jsonEditButton.width,this.resumeButton.y),this.backgroundPlate.setPosition(e-M,0),this.backgroundPlate.setSize(M,t),this.palette.setPosition(e-M+T,100),this.currentToolDescription.setPosition(e-M+T,this.palette.y+this.palette.height+20),(0,y.layoutFromLeftToRight)(e-M+T,t-T-this.newGameButton.height,8,[this.newGameButton,this.importButton,this.exportButton])}}t.MapEditorScene=I},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EDITOR_TOOL=void 0;const n=i(193),s=i(378),a=i(379),o=i(380),r=i(381),c=i(382),l=i(383);t.EDITOR_TOOL={deleteTile:new n.DeleteTileTool,paintRegion:[1,2,3,4,5,6].map(e=>new s.PaintRegionTool(e)),paintSoldier:new a.PaintSoldierTool,paintTown:new o.PaintTownTool,paintForest:new l.PaintForestTool,paintCastle:new c.PaintCastleTool,addCoins:new r.CoinsTool}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deleteTile=t.DeleteTileTool=void 0;const n=i(0);var s=Phaser.GameObjects.Image;function a(e){const t=n.inject.gameStateModel,i=t.regions.byHex(e),s=t.factions.byHex(e);i&&s&&(t.pawns.destroy(...t.pawns.byHex(e)),t.regions.byHex(e).removeHexes(e),s.splitRegionIfDisconnected(i))}t.DeleteTileTool=class{constructor(){this.description="click = delete tile\nshift-click = delete objects"}createIcon(e){return new s(e,0,0,"atlas","editor/delete-tile-icon")}useOn(e,t){t.shift?function(e){const t=n.inject.gameStateModel;t.pawns.destroy(...t.pawns.byHex(e))}(e):a(e)}},t.deleteTile=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBudgetIcon=t.layoutFromCenter=t.layoutFromRight=t.RegionLabelText=t.LargeRegionLabel=void 0;var n=Phaser.GameObjects.Image,s=Phaser.GameObjects.BitmapText;const a=i(9),o=i(15),r=i(19),c=i(38),l=i(80),d=i(3),h=i(76),u=i(83),g=30,p=200,m=400,f=16;class y extends Phaser.GameObjects.Container{constructor(e,t,i){super(e),this.width=t,this.height=i,this.regionInfo={buyablePawns:[],name:"",treasury:0,income:0,id:-1,townLevel:1},this.treasuryTextController=new c.TransitionController(this.scene,{duration:m,initialValue:0,applyValue:e=>{this.treasuryText.setText(e.toFixed(0)),this.updateNumbersLayout()}}),this.incomeTextController=new c.TransitionController(this.scene,{duration:m,initialValue:0,applyValue:e=>{this.incomeText.setText((0,r.withSign)(Math.trunc(e))),this.updateTrendIcon(e),this.updateNumbersLayout()}}),this.line1center=g+f/2,this.line2center=this.line1center+1.5*f;const s=this.width,a=this.line1center,l=this.line2center;this.regionIcon=new n(e,0+g+10,a,"atlas","pawns/town-1").setScale(.5,.5).setOrigin(.5,.5),this.regionNameText=new v(e,0+g+36,a,"Kingdom"),this.treasuryText=new v(e,s-g-54,a,"0").setOrigin(0,0),this.treasuryIcon=new n(e,this.treasuryText.x-34-16,a,"atlas","ui/budget-icons/treasury").setOrigin(0,0),this.incomeText=new v(e,s-g-16,a,"+8").setOrigin(0,0),this.trendIcon=new n(e,s-g-6,a,"atlas","ui/budget-icons/surplus"),this.selectedPawnArrow=new n(e,0+g+48,l-2,"atlas","ui/arrow-icon"),this.selectedPawnText=new v(e,0+g+60,l,"",o.BitmapFont.Mini),this.selectedPawnCostText=new v(e,this.treasuryText.x,l,"",o.BitmapFont.Mini).setOrigin(1,.5),this.selectedPawnUpkeepText=new v(e,this.incomeText.x,l,"",o.BitmapFont.Mini).setOrigin(1,.5),this.add([this.regionIcon,this.regionNameText,this.treasuryText,this.treasuryIcon,this.incomeText,this.trendIcon,this.selectedPawnText,this.selectedPawnCostText,this.selectedPawnArrow,this.selectedPawnUpkeepText])}setRegionInfo(e){this.regionNameText.setText(e.name);this.regionInfo.id===e.id?(this.treasuryTextController.transitionTo(e.treasury),this.incomeTextController.transitionTo(e.income)):(this.treasuryTextController.setTo(e.treasury),this.incomeTextController.setTo(e.income)),this.regionInfo=e,this.regionIcon.setFrame((0,l.getFrameForPawnType)(d.PawnType.Town,(0,h.cropNumber)(e.townLevel,1,4))).setOrigin(.5,.5)}updateNumbersLayout(){u.Arrange.fromLeftToRight([this.treasuryIcon,this.treasuryText,this.incomeText],{x:this.width-g-34,y:this.line1center,originY:.5,originX:1,spacing:8}),this.selectedPawnCostText.x=this.treasuryText.x+this.treasuryText.width,this.selectedPawnUpkeepText.x=this.incomeText.x+this.incomeText.width}updateTrendIcon(e){this.trendIcon.setFrame(w(e))}setBuyingPawnInfo(e){if(e){const{name:t,cost:i,upkeep:n}=e;this.selectedPawnText.setText(t),this.selectedPawnCostText.setText("-"+i.toString()),this.selectedPawnUpkeepText.setText("-"+n.toString()),[this.selectedPawnArrow,this.selectedPawnText,this.selectedPawnCostText].forEach(e=>e.setVisible(!0)),this.selectedPawnUpkeepText.setVisible(!!n),this.treasuryTextController.transitionTo(this.regionInfo.treasury-i),this.incomeTextController.transitionTo(this.regionInfo.income-n),this.goToVerticalOffset(-11)}else this.clearSelectedPawnData(),this.treasuryTextController.transitionTo(this.regionInfo.treasury),this.incomeTextController.transitionTo(this.regionInfo.income),this.goToVerticalOffset(0)}clearSelectedPawnData(){[this.selectedPawnArrow,this.selectedPawnText,this.selectedPawnCostText,this.selectedPawnUpkeepText].forEach(e=>e.setVisible(!1))}goToVerticalOffset(e){this.scene.tweens.add({targets:this,y:e,scale:1,ease:"Sine.easeOut",duration:p})}}t.LargeRegionLabel=y;class v extends s{constructor(e,t,i,n,s=o.BitmapFont.Main){super(e,t,i,s,n),this.setTint(5583648),this.setOrigin(0,.5)}}function w(e){return 0===e?"ui/budget-icons/neutral":e>0?"ui/budget-icons/surplus":"ui/budget-icons/deficit"}t.RegionLabelText=v,t.layoutFromRight=function(e,t,i){let n=e;for(let e of i.reverse())e.x=n-(1-e.originX)*e.width,n=n-e.width-t},t.layoutFromCenter=function(e,t,i){let n=e-(i.map(e=>e.width).reduce(a.sum)+t*(i.length-1))/2;for(let e of i)e.x=n+e.originX*e.width,n=n+e.width+t},t.getBudgetIcon=w},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnHolder=void 0;var n=Phaser.GameObjects.Image;const s=i(81),a=i(0);t.PawnHolder=class{constructor(e){this.scene=e}pickUpPawn(e,t,i,a=1){this.heldPawn=e,this.heldPawnImage=new n(this.scene,0,0,"atlas","pawns/"+e),this.scene.add.existing(this.heldPawnImage),this.pickupTween=this.scene.tweens.add({targets:this.heldPawnImage,x:{from:t,to:this.scene.input.activePointer.x},y:{from:i,to:this.scene.input.activePointer.y},scale:{from:a,to:1},duration:s.TIMING.pawnPickupTransition,ease:"Sine.easeInOut",onComplete:()=>{this.pickupTween=void 0}})}update(){!this.heldPawnImage||this.pickupTween||this.dropTween?this.pickupTween&&(this.pickupTween.updateTo("x",this.scene.input.activePointer.x/a.inject.ui.scale,!0),this.pickupTween.updateTo("y",this.scene.input.activePointer.y/a.inject.ui.scale,!0)):this.heldPawnImage.setPosition(this.scene.input.activePointer.x/a.inject.ui.scale,this.scene.input.activePointer.y/a.inject.ui.scale)}dropPawn(e,t,i,n){var a,o;const r=this.heldPawnImage;this.heldPawnImage=void 0,this.heldPawn=void 0,r&&(null===(a=this.pickupTween)||void 0===a||a.stop(),null===(o=this.dropTween)||void 0===o||o.stop(),this.dropTween=this.scene.tweens.add({targets:r,x:e,y:t,scale:i,duration:s.TIMING.pawnDropTransition,ease:"Sine.easeInOut",onComplete:()=>{r.destroy(),this.dropTween=void 0,n()}}))}clear(){var e;null===(e=this.heldPawnImage)||void 0===e||e.destroy(),this.heldPawnImage=void 0,this.heldPawn=void 0}setPawnType(e){var t;null===(t=this.heldPawnImage)||void 0===t||t.setFrame("pawns/"+e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CloseButton=t.ShoppingTray=void 0;const n=i(11),s=i(1),a=i(0),o=i(53),r=i(35),c=i(97),l=i(6),d=i(38),h=i(104);var u=Phaser.GameObjects.Image;const g=i(22);s.logger.for("ShoppingDesk");class p extends g.ResponsiveContainer{constructor(e,t){super(e),this.config=t,this.pawnSprites={},this.shadows=[],this.displayedPawns=[],this.isOpen=!1,this.yController=d.Control.propOf(this,"y",{duration:h.LARGE_PLAY_UI_LAYOUT.shoppingTray.panelTransitionsDuration}),this.cloth=new o.Ribbon(e,o.RibbonTexture.Cloth,-this.config.width/2,0,this.config.width),this.setSize(this.config.width,this.cloth.height),this.cloth.setInteractive(),this.cloth.on("pointerdown",()=>a.inject.events.trigger(l.UserActions.ShopAreaPointerDown())),this.cloth.on("pointerup",()=>a.inject.events.trigger(l.UserActions.ShopAreaPointerUp())),this.config.style===r.ShoppingTrayStyle.Elaborate&&(this.tray=new o.Ribbon(e,o.RibbonTexture.UnitTray,-this.config.width/2,0,this.config.width),this.closeButton=new m(e,this.config.width/2-21,6),this.closeButton.onClicked(()=>a.inject.events.trigger(l.UserActions.DeselectRegion()))),this.add([this.tray,this.cloth,this.closeButton].filter(e=>e))}setColor(e){this.cloth.setTint(e)}setOpen(e){if(e===this.isOpen)return;this.isOpen=e;const t=this.scene.cameras.main.displayHeight-(e?this.config.openOffsetFromBottom:this.config.closedOffsetFromBottom);this.yController.transitionTo(t)}updateLayout(){const e=this.scene.cameras.main.displayHeight,t=this.scene.cameras.main.displayWidth;this.cloth.setPosition(Math.round(-this.width/2),0),this.isOpen?this.setPosition(Math.round(t/2),e-this.config.openOffsetFromBottom):this.setPosition(Math.round(t/2),e),this.yController.setTo(this.y)}setDisplayedPawns(e){this.displayedPawns=e,Object.values(this.pawnSprites).forEach(e=>e.setVisible(!1)),e.forEach((e,t)=>{this.getOrCreatePawnImage(e,t).setVisible(!0)}),this.updatePawnSprites()}updatePawnSprites(){const e=this.config.pawnsSpacing,t=Math.round(-e*(this.displayedPawns.length-1)/2);Object.values(this.pawnSprites).forEach(e=>e.setVisible(!1)),this.updateShadows(),this.displayedPawns.forEach((i,n)=>{this.getOrCreatePawnImage(i,n).setVisible(!0).setPosition(t+n*e,this.config.pawnsVerticalOffset)})}destroy(){Object.values(this.pawnSprites).forEach(e=>e.destroy()),this.pawnSprites={}}updateShadows(){const e=Math.round(-this.config.pawnsSpacing*(this.displayedPawns.length-1)/2);for(let t=0;t<this.displayedPawns.length;++t)(0,n.getOrCreate)(this.shadows,t,()=>{const e=new u(this.scene,0,0,"atlas","pawn-shadow");return this.addAt(e,2),e}).setVisible(!0).setPosition(e+t*this.config.pawnsSpacing,this.config.pawnsVerticalOffset);for(let e=this.displayedPawns.length;e<this.shadows.length;++e)this.shadows[e].setVisible(!1)}getOrCreatePawnImage(e,t){return(0,n.getOrCreate)(this.pawnSprites,e,()=>{const t=new u(this.scene,0,0,"atlas","pawns/"+e).setInteractive({cursor:"pointer"});return t.input.enabled=!0,t.on("pointerdown",()=>{this.isOpen&&a.inject.events.trigger(l.UserActions.BuyablePawnPointerDown(e))}),t.on("pointerup",()=>{this.isOpen&&a.inject.events.trigger(l.UserActions.BuyablePawnPointerUp(e))}),this.add(t),t})}getPawnSpriteByType(e){return this.pawnSprites[e]}}t.ShoppingTray=p;class m extends c.ImageButton{constructor(e,t,i){super(e,t,i,{frame:"ui/mini-close-button",hover:!0})}}t.CloseButton=m},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PowerBalanceRibbon=void 0;const n=i(390),s=i(9),a=i(1),o=i(53),r=i(0),c=i(22);a.logger.for("ui:PowerBalanceRibbon");class l extends c.ResponsiveContainer{constructor(e,t){super(e),this.props=t,this.currentState=[],this.colorBars=[],this.setPosition(t.x,t.y),this.height=o.RibbonTexture.ColorBar.height,this.backgroundBar=new n.ColorBar(this.scene,{x:0,y:0,width:t.width,color:9474192}),this.setSize(t.width,this.backgroundBar.height),this.add([this.backgroundBar])}setDimensions(e,t,i){return this.setPosition(e,t),this.backgroundBar.width=i,this.width=i,r.inject.ui.withoutTransitions(()=>{this.updateState(this.currentState)}),this}updateState(e){this.currentState=e;const t=function(e,t,i){if(0===e.length)return e;const n=e.reduce((e,t)=>e+t.size,0),a=t/n;let o=e.map(e=>Object.assign(Object.assign({},e),{size:Math.floor(e.size*a)}));const r=o.filter(e=>e.size<i),c=o.filter(e=>e.size>i);if(r.length&&c.length){const e=r.map(e=>i-e.size).reduce(s.sum,0)/c.length;r.forEach(e=>e.size=i),c.forEach(t=>t.size=Math.ceil(t.size-e))}const l=o.reduce((e,t)=>e+t.size,0);let d=t-l;for(let e=0;d>0&&c.length>0;d--,e++)c[e%c.length].size+=1;return o}(e,this.width,this.props.minSize);let i=0;for(let e=0;e<t.length;++e){const s=t[e].size+(e===t.length-1?0:2);this.colorBars[e]?(this.colorBars[e].adjustSize.transitionTo(s),this.colorBars[e].adjustX.transitionTo(i),this.colorBars[e].adjustY.transitionTo(t[e].highlight?-2:0)):(this.colorBars[e]=new n.ColorBar(this.scene,{x:i,y:0,width:s}),this.colorBars[e].adjustY.setTo(t[e].highlight?-2:0),this.colorBars[e].adjustX.setTo(i),this.colorBars[e].adjustSize.setTo(s),this.add(this.colorBars[e]),this.colorBars[e].setVisible(!0)),this.colorBars[e].setTint(t[e].color),i+=t[e].size}this.colorBars.slice(t.length).map(e=>{e.destroy()}),this.colorBars.splice(t.length),this.preUpdate.makeDirty()}}t.PowerBalanceRibbon=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageButtonWithContent=void 0;const n=i(44);var s=Phaser.GameObjects.Container,a=Phaser.GameObjects.Sprite;const o=i(78);t.ImageButtonWithContent=class extends s{constructor(e,t,i,n){super(e,t,i),this.config=n,this.buttonSprite=new a(this.scene,0,0,"atlas",n.frame),this.buttonSprite.setInteractive({cursor:"pointer"}),this.setController((0,o.setupController)(n)),this.config.content.setOrigin(.5,.5).setPosition(this.buttonSprite.width/2,this.buttonSprite.height/2-1),this.add([this.buttonSprite,this.config.content]),this.width=this.buttonSprite.width}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}setController(e){e&&(this.controller=e,e.bindTo(this.buttonSprite,e=>this.setButtonState(e)))}setButtonState(e){const t=this.buttonSprite.width/2,i=this.buttonSprite.height/2-1;switch(e){case n.ButtonState.Rest:this.buttonSprite.setFrame(this.config.frame),this.config.content.setPosition(t,i);break;case n.ButtonState.Disabled:this.buttonSprite.setFrame(this.config.frame+(this.config.disabled?"-disabled":"")),this.config.content.setPosition(t,i);break;case n.ButtonState.Hover:this.buttonSprite.setFrame(this.config.frame+(this.config.hover?"-hover":"")),this.config.content.setPosition(t,i);break;case n.ButtonState.Down:this.buttonSprite.setFrame(this.config.frame+(this.config.down?"-down":"")),this.config.content.setPosition(t+1,i+1)}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionSummaryPopup=void 0;const n=i(392),s=i(0),a=i(2),o=i(186),r=i(15),c=i(20),l=i(67);var d=Phaser.GameObjects.BitmapText,h=Phaser.GameObjects.Image;const u=i(22);class g extends n.ToolTipBox{constructor(e){super(e),this.summary=new p(this.scene),this.setContent(this.summary)}showOverRegion(e){const t=s.inject.gameStateModel.regions.byId(e);a.assert.defined(t);const i=s.inject.gameStateModel.economy.townHexesOf(t).members[0];if(!i)return;this.worldCoords={x:i.display.centerX,y:i.display.centerY+20},this.summary.updateFromRegion(t);const{x:n,y:r}=(0,o.convertWorldXYToCameraXY)(s.inject.scene.worldMap.cameras.main,i.display.centerX,i.display.centerY);this.showAt(n,r+20)}updatePosition(){if(!this.worldCoords)return;const{x:e,y:t}=(0,o.convertWorldXYToCameraXY)(s.inject.scene.worldMap.cameras.main,this.worldCoords.x,this.worldCoords.y);this.repositionTo(e,t)}}t.RegionSummaryPopup=g;class p extends u.ResponsiveContainer{constructor(e){super(e),this.currentGoldText=new d(this.scene,0,0,r.BitmapFont.MiniBold,"0").setTint(c.Colors.woodenUi.primaryText),this.rightArrow=new h(this.scene,0,0,"atlas","ui/mini-icons/arrow-right").setTint(c.Colors.woodenUi.primaryText),this.predictedGoldText=new d(this.scene,0,0,r.BitmapFont.Mini,"0").setTint(c.Colors.woodenUi.primaryText),this.goldIcon=new h(this.scene,0,0,"atlas","ui/mini-icons/coins").setOrigin(0,0),this.add([this.goldIcon,this.currentGoldText,this.rightArrow,this.predictedGoldText]),this.updateLayout()}updateFromRegion(e){const t=e.treasury,{balance:i,upkeep:n}=e.budget,s=i>=0?c.Colors.woodenUi.primaryText:c.Colors.woodenUi.redText;this.currentGoldText.setText(t.toFixed(0));const a=t+i;this.rightArrow.setTint(s),this.predictedGoldText.setText(a.toFixed(0)).setTint(s),this.updateLayout()}updateLayout(){(0,l.layoutFromLeftToRight)(0,0,2,[this.goldIcon,this.currentGoldText,this.rightArrow,this.predictedGoldText]),this.width=this.predictedGoldText.x+this.predictedGoldText.width,this.height=this.currentGoldText.height,(0,l.centerVertically)(this.rightArrow,0,0,this.height),(0,l.centerVertically)(this.goldIcon,0,0,this.height)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResponsiveLayer=void 0;const n=i(32);var s=Phaser.GameObjects.Layer;t.ResponsiveLayer=class extends s{constructor(e,t){super(e,t),this.updateList=[];for(let e of t)(0,n.isResponsive)(e)&&this.updateList.push(e)}add(e,t){return(0,n.isResponsive)(e)&&this.updateList.push(e),super.add(e,t)}remove(e,t){const i=this.updateList.indexOf(e);return-1!==i&&this.updateList.splice(i,1),super.remove(e,t)}preUpdate(){for(let e of this.updateList)e.preUpdate()}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.TitleScreen=void 0;const s=i(56),a=i(16),o=i(6),r=i(0),c=i(400),l=i(98),d=i(401),h=i(2),u=i(107),g=i(40),p=i(45),m=i(402),f=i(13);class y extends s.BaseScreen{constructor(){super([a.Scenes.WorldMap,a.Scenes.TitleScreenUI]),this.handleEventWhileActive(o.UserActions.GoToLevelSelect,({campaignId:e})=>n(this,void 0,void 0,(function*(){const t=yield r.inject.mapRegistry.getCampaignById(e);h.assert.defined(t),r.inject.ui.selectedCampaign.set(t),r.inject.navigator.goTo(r.inject.screen.levelSelect,()=>(0,d.transitionToLevelSelect)(0))}))),this.handleEventWhileActive(o.UserActions.ResumeGame,()=>{r.inject.navigator.goTo(r.inject.screen.play,m.transitionToPlayScene)})}activate(e){return n(this,void 0,void 0,(function*(){let t,i=void 0;e===r.inject.screen.levelSelect&&(i=0);const n=r.inject.userData.recallChoice("latestLevelId");if(n)try{t=yield r.inject.userData.loadGame(n,p.SaveGameTags.Autosave),r.inject.scene.titleScreenUI.state.update({resumeButton:{enable:!0,levelName:"?",turnNumber:t.currentPhase.turnNumber}})}catch(e){console.error("failed to load level "+n,e)}t||(t=(0,l.decodeGameState)(c.BUILT_IN_MAPS.titleScreenLevel)),r.inject.gameStateController.loadState(t,g.NewGameStateContext.LoadingGameStateForDebug),r.inject.scene.worldMap.setMode(new u.PreviewMode),r.inject.scene.worldMap.syncState(r.inject.currentGameState),r.inject.scene.worldMap.pawns.beginJumping(r.inject.gameStateModel.pawns.select({traits:[f.PawnTraits.Unit]}).map(e=>e.hex.id))}))}}t.TitleScreen=y,y.Layout={mainMenuPanel:{width:400,padding:10,stripeWidth:6,buttons:{height:57,spacing:10}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MenuHeaderUIScene=void 0;const n=i(16),s=i(20),a=i(32),o=i(0),r=i(15),c=i(6),l=i(79),d=i(47),h=i(106);var u=Phaser.GameObjects.Rectangle,g=Phaser.GameObjects.BitmapText;const p=i(105);var m=Phaser.GameObjects.Image;const f=i(83);class y extends d.BaseUIScene{constructor(){super({key:n.Scenes.MenuHeaderUI}),this.state=(0,h.StateContainer)(this,{title:""}),this.preUpdate=(0,a.whenDirty)(()=>{this.cameras.main.y=0;const e=this.bounds.width;this.bounds.height;this.cameras.main.setSize(o.inject.device.screenWidth,o.inject.device.screenHeight),this.background.setPosition(0,0),this.background.setSize(e,y.Layout.panelHeight),f.Arrange.fromTopToBottom([this.titleText,this.backButton],{x:this.bounds.contentLeft+l.DEFAULT_CONTENT_PADDING,y:this.background.height/2+14,spacing:0,originY:.5})})}create(){super.create(),this.scale.on("resize",()=>this.preUpdate.makeDirty()),this.background=new u(this,0,0,0,0,s.Colors.glassUi.shape),this.backButtonText=new g(this,0,0,r.BitmapFont.Small,"BACK").setTint(s.Colors.woodenUi.primaryText),this.backButton=new p.RibbonButton(this,0,0,{icon:new m(this,0,0,"atlas","ui/mini-icons/back").setTint(s.Colors.woodenUi.primaryText),type:p.RibbonButtonStyle.Small,width:180,content:this.backButtonText}),this.titleText=new g(this,0,0,r.BitmapFont.Main,"?").setOrigin(0,.5).setTint(s.Colors.glassUi.primaryText),this.backButton.onClicked(()=>o.inject.events.trigger(c.UserActions.GoBack())),this.addAll([this.background,this.titleText,this.backButton])}applyState(e,t,i){e.title&&this.titleText.setText(e.title),e.backButtonTitle&&this.backButtonText.setText(e.backButtonTitle)}slideOut(){this.tweens.add({targets:this.cameras.main,props:{y:-this.background.height},duration:o.inject.config.screenTransitionDuration,ease:"Sine.easeOut"})}slideIn(){this.tweens.add({targets:this.cameras.main,props:{y:0},duration:o.inject.config.screenTransitionDuration,ease:"Sine.easeOut"})}}t.MenuHeaderUIScene=y,y.Layout={panelHeight:128}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LargeLevelCardContent=t.LargeLevelCard=void 0;const n=i(131),s=i(22),a=i(94),o=i(15),r=i(20),c=i(28),l=i(132),d=i(106),h=i(38),u=i(1);var g=Phaser.GameObjects.BitmapText,p=Phaser.GameObjects.Image,m=Phaser.Geom.Rectangle;const f=i(0),y=i(105),v=(u.logger.for("LargeLevelCard"),{icon:l.LevelIcons.NotStarted,title:"",subTitle:""});class w extends n.Card{constructor(e,t){super(e,Object.assign(Object.assign({},t),{content:void 0})),this.content=new b(e,this)}}t.LargeLevelCard=w;class b extends s.ResponsiveContainer{constructor(e,t,i){super(e),this.card=t,this.mapPreviewLoaded=!1,this.props=(0,d.StateContainer)(this,v),this._icon=new p(e,0,0,"atlas",l.LevelIcons.NotStarted).setOrigin(.5,.5),this._title=new g(e,0,0,o.BitmapFont.Main,"").setOrigin(0,0).setTint(r.Colors.glassUi.primaryText),this._subTitle=new g(e,0,0,o.BitmapFont.Mini,"").setOrigin(0,0).setTint(r.Colors.glassUi.primaryText),this._mainButtonText=new g(e,0,0,o.BitmapFont.Main,"?").setTint(r.Colors.woodenUi.primaryText).setLetterSpacing(1),this._mainButton=new a.BoxButton(e,0,0,{baseTexture:c.BoxTexture.DialogButton,downTexture:c.BoxTexture.DialogButtonDown,height:60,width:b.Layout.buttonsWidth,content:this._mainButtonText}),this._secondaryButtonText=new g(e,0,0,o.BitmapFont.Small,"?").setTint(r.Colors.woodenUi.primaryText),this._secondaryButton=new y.RibbonButton(e,0,0,{type:y.RibbonButtonStyle.Small,width:b.Layout.buttonsWidth,content:this._secondaryButtonText}),this.add([this._icon,this._title,this._subTitle,this._mainButton,this._secondaryButton]),this._mainButtonVisible=h.Control.visibilityOf(this._mainButton,{duration:300}).setTo(0),this._secondaryButtonVisible=h.Control.visibilityOf(this._secondaryButton,{duration:300}).setTo(0),i&&this.props.update(i)}applyState(e,t,i){void 0!==e.title&&e.title!==i.title&&this.setTitle(e.title),void 0!==e.icon&&e.icon!==i.icon&&this.setIcon(e.icon),void 0!==e.subTitle&&e.subTitle!==i.subTitle&&this.setSubtitle(e.subTitle),void 0!==e.primaryButton&&e.primaryButton!==i.primaryButton&&(e.primaryButton?this.setMainButton(e.primaryButton.title,e.primaryButton.onClick,e.primaryButton.visible):this.hideMainButton()),void 0!==e.secondaryButton&&e.secondaryButton!==i.secondaryButton&&(e.secondaryButton?this.setSecondaryButton(e.secondaryButton.title,e.secondaryButton.onClick,e.secondaryButton.visible):this.hideSecondaryButton())}setIcon(e){this._icon.setFrame(e).setOrigin(.5,.5),this.preUpdate.makeDirty()}setTitle(e){this._title.setText(e)}setSubtitle(e){this._subTitle.setText(e)}setMainButton(e,t,i){this._mainButtonText.setText(e),this._mainButton.onClicked.unsubscribeAll(),this._mainButton.onClicked(t),this._mainButtonVisible.transitionTo(i?1:0)}setSecondaryButton(e,t,i){this._secondaryButtonText.setText(e),this._secondaryButton.onClicked.unsubscribeAll(),this._secondaryButton.onClicked(t),this._secondaryButtonVisible.transitionTo(i?1:0)}hideMainButton(){this._mainButtonVisible.transitionTo(0)}hideSecondaryButton(){this._secondaryButtonVisible.transitionTo(0)}loadMapPreviewFromWorldMap(){this.mapPreview||(this.mapPreview=f.inject.scene.levelDetailUI.mapPreviewPool.take(),this.add(this.mapPreview)),this.mapPreview.updateFromWorldMap(),this.mapPreviewLoaded=!0,this.preUpdate.makeDirty()}clearMapPreview(){var e;this.mapPreviewLoaded=!1,null===(e=this.mapPreview)||void 0===e||e.setVisible(!1)}updateLayout(){super.updateLayout();const e=b.Layout,t=e.padding,i=this.height-this.card.footerSize+e.padding,n=this._title.height+(this._subTitle.text?this._subTitle.height+e.textSpacing:0),s=(this.props().primaryButton?this._mainButton.height:0)+(this.props().secondaryButton?this._secondaryButton.height:0)+(this.props().primaryButton&&this.props().secondaryButton?e.buttonSpacing:0);this._icon.setPosition(t+e.iconOffsetFromLeft,this.height-this.card.footerSize/2),this._title.setPosition(t+e.titleOffsetFromLeft,i+(this.card.footerSize-n-2*e.padding)/2),this._subTitle.setPosition(this._title.x,this._title.y+this._title.height+e.textSpacing);let a=i+(this.card.footerSize-s-2*e.padding)/2;this._mainButton.setPosition(this.width-this._mainButton.width-e.padding-e.buttonsOffsetFromRight,a),this._secondaryButton.setPosition(this._mainButton.x,this._mainButton.y+this._mainButton.height+e.buttonSpacing);const o=new m(0,0,this.card.width,this.card.height-this.card.footerSize);if(this.mapPreviewLoaded&&this.mapPreview){const e=m.FromXY(o.x,o.y,o.x+this.mapPreview.width,o.y+this.mapPreview.height);m.FitInside(e,o),this.mapPreview.visible?(this.mapPreview.setVisible(!0),this.mapPreview.setAlpha(1)):(this.mapPreview.setVisible(!0),this.mapPreview.setAlpha(0),this.scene.tweens.add({targets:this.mapPreview,props:{alpha:{start:0,to:1}},duration:300}));let t=e.width/this.mapPreview.width;t>1?(this.mapPreview.setScale(1),this.mapPreview.setPosition(o.centerX-this.mapPreview.width/2,o.centerY-this.mapPreview.height/2)):(this.mapPreview.setScale(t),this.mapPreview.setPosition(e.x,e.y))}}}t.LargeLevelCardContent=b,b.Layout={padding:10,buttonsOffsetFromRight:20,buttonsWidth:200,titleOffsetFromLeft:80,iconOffsetFromLeft:40,buttonSpacing:4,textSpacing:8}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.returnToMenuFromGame=void 0;const s=i(0),a=i(133);t.returnToMenuFromGame=function(e,t){return n(this,void 0,void 0,(function*(){const i=s.inject.gameStateModel.map.levelId;s.inject.ui.selectedLevelId.set(i);a.LevelModel.get(i).campaignContext?(s.inject.scene.levelDetailUI.refreshLevelCard(s.inject.ui.playedLevelId()),yield s.inject.navigator.goTo(s.inject.screen.levelDetail,e)):s.inject.navigator.goTo(s.inject.screen.title,t)}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.transitionFromPlayScene=void 0;const n=i(0);var s=Phaser.Geom.Rectangle;t.transitionFromPlayScene=function(){var e;n.inject.scene.playUI.activeUI.transitionOut();const t=n.inject.scene.levelDetailUI,i=n.inject.scene.menuHeaderUI,a=n.inject.config.screenTransitionDuration,o=n.inject.scene.worldMap;return o.scene.setVisible(!0),t.mapPreviewLoader.pause(),t.updateCardsInView(),null===(e=t.centralCard.content.mapPreview)||void 0===e||e.setVisible(!1),new Promise(e=>{t.preUpdate.makeDirty(),t.preUpdate();const r=function(){const e=n.inject.scene.levelDetailUI.layout.mapPreview,t=n.inject.scene.worldMap.cameraController.worldBounds,i=new s(0,0,e.width,e.height),a=new s(0,0,t.width,t.height);return s.FitInside(a,i),Math.min(1,a.width/t.width)}();o.cameraController.center(a),o.cameraController.zoomController.cameraDistance.tweenTo(1/r,a,"Sine.easeOut"),t.tweens.add({targets:[t.centralCard],props:{alpha:{from:0,to:1}},duration:a,onComplete:e}),t.leftCard&&t.tweens.add({targets:t.leftCard,props:{x:{from:t.scrollController.cameraX.value-t.layout.cardWidth-10,to:t.leftCard.x}},duration:a,ease:"Sine.easeOut"}),t.rightCard&&t.tweens.add({targets:t.rightCard,props:{x:{from:t.scrollController.cameraX.value+t.bounds.width+10,to:t.rightCard.x}},duration:a,ease:"Sine.easeOut"}),i.slideIn()}).then(()=>{var e;o.chunksRenderingController.renderEverything(),t.centralCard.content.loadMapPreviewFromWorldMap(),o.scene.setVisible(!1),null===(e=t.centralCard.content.mapPreview)||void 0===e||e.setVisible(!0)})}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.transitionFromPlayScene=void 0;const s=i(0),a=i(23);t.transitionFromPlayScene=function(e){return n(this,void 0,void 0,(function*(){const t=s.inject.scene.titleScreenUI,i=s.inject.config.screenTransitionDuration;return t.preUpdate(),s.inject.scene.playUI.activeUI.transitionOut(),new Promise(n=>{let o=t.buttons;if(void 0!==e){const n=t.buttons[e];o=(0,a.without)(t.buttons,n);const r={x:n.x,y:n.y,width:n.width,height:n.height,rounded:1};n.x=0,n.y=0,n.setSize(s.inject.device.screenWidth,200),n.rounded=0,t.tweens.add({targets:n,props:r,duration:i,onComplete:()=>{t.preUpdate.makeDirty()}})}s.inject.scene.worldMap.cameraController.center(i),s.inject.scene.worldMap.cameraController.zoomController.cameraDistance.tweenTo(1,i,"Sine.easeOut"),t.tweens.add({targets:[t.mainMenuPanel,t.decorativeStripe,...o,t.resumeButton,t.gameLogo],props:{x:{getStart:e=>e.x+400,getEnd:e=>e.x}},duration:i,onComplete:n,ease:"Sine.easeOut"})})}))}},function(e,t,i){e.exports=i(208)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i(36);const n=i(0),s=i(1),a=i(122),o=i(178),r=i(177),c=i(20),l=o.configProfiles.production;function d(e){const t=window.devicePixelRatio||1,i=window.innerWidth*t,s=window.innerHeight*t;e.width===i&&e.height===s||(console.warn(`Window size changed. Adjusting viewport size to ${window.innerWidth*t}x${window.innerHeight*t}`),n.inject.game.scale.setGameSize(window.innerWidth*t,window.innerHeight*t))}console.info("âš” Konkr.io production build 1 (master)"),window.addEventListener("load",()=>{s.logger.addTransport("console",new s.ConsoleLogger),s.logger.for("game").info("starting");const e=(0,r.getAppController)(l.mode),t=function(e){const t=window.devicePixelRatio||1,i=window.innerWidth*t,n=window.innerHeight*t;return{type:Phaser.WEBGL,backgroundColor:c.Colors.ocean,scale:{parent:"phaser-game",mode:Phaser.Scale.FIT,width:i,height:n},dom:{createContainer:!0},scene:e,pixelArt:!l.antialiasing,antialias:l.antialiasing}}(e.getScenes()),i=new Phaser.Game(t);(0,n.setupInjectionContainer)(i,l),(0,a.registerConsoleCommands)(),i.scale.on("resize",d),n.inject.versionManager.start(),e.run()})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameStateController=void 0;const n=i(62),s=i(27),a=i(210),o=i(6),r=i(1),c=i(19),l=i(37),d=i(164),h=i(272),u=i(274),g=i(165),p=i(0),m=i(112),f=i(275),y=i(3),v=i(2),w=i(111),b=i(276),S=i(40),x=r.logger.for("GameStateController");t.GameStateController=class{constructor(){this.actionHandlers={},this.onEvent=(0,s.signal)(),this.history=new g.FixedCapacityArray(20),this.eventsPaused=!1,this.scheduledEvents=[],this.model=new l.GameStateModel,this.on(o.Plays.EndTurn,e=>(this.lastTurnState=e.stateEngine.currentState,(0,f.executeEndTurn)(e))).on(o.Plays.MovePawn,h.executeMovePawn).on(o.Plays.BuyPawn,u.executeBuyPawn).on(o.Plays.AttackHex,m.executeAttackHex).on(o.Plays.BanditsAct,b.executeBanditsAct)}on(e,t){return(0,v.assert)(void 0===this.actionHandlers[e.eventName],`a handler is already assigned to event type ${e.eventName}!`),this.actionHandlers[e.eventName]=t,this}getEventQueue(){const e=new a.EventQueue;return e.addSource(this.onEvent),e}loadState(e,t){this.model.restore(e),this.model.activateAllProjections(),this.fireEvent(o.GameEvents.NewGameState({state:this.model.state,context:t})),this.scheduledEvents=[],this.model.currentPhase.is(y.PhaseTypes.GameStart)&&(0,d.startPhase)(this.model).forEach(e=>this.fireEvent(e)),t.startFactionTurn&&this.fireEvent(o.GameEvents.FactionTurnStarted({state:this.model.state,factionId:this.model.currentPhase.faction.id})),t.flushHistory&&this.clearUndoHistory()}undo(){0!==this.history.length?(this.loadState(this.history.pop(),S.NewGameStateContext.Undo),0===this.history.length&&p.inject.ui.undoAvailable.set(!1)):x.error("Unable to undo - history is empty")}clearUndoHistory(){this.history.clear(),p.inject.ui.undoAvailable.set(!1)}beginTransaction(){this.eventsPaused=!0}commitTransaction(){this.eventsPaused=!1,this.scheduledEvents.forEach(e=>this.fireEvent(e)),this.scheduledEvents=[]}createCheckpoint(){return{state:this.currentState,events:[...this.scheduledEvents]}}restoreCheckpoint(e){this.model.restore(e.state),this.scheduledEvents=[...e.events],p.inject.config.debug.ai&&this.onEvent.fire(o.GameEvents.NewGameState({state:this.currentState,context:S.NewGameStateContext.LoadingGameStateForDebug}))}saveCurrentStateForUndo(){this.currentState&&this.addStateToUndoHistory(this.currentState)}addStateToUndoHistory(e){this.history.push(e),1===this.history.length&&p.inject.ui.undoAvailable.set(!0)}get currentState(){var e;return null===(e=this.model)||void 0===e?void 0:e.stateEngine.currentState}handleAction(e){const t=w.timing.start(`handleAction(${e.name})`);this.model.currentPhase.isLocalPlayerTurn()&&this.saveCurrentStateForUndo();const i=this.actionHandlers[e.name];if(i){i(this.model,e.payload).forEach(e=>this.fireEvent(e))}else x.warning(`No handler assigned for event ${e.name} - ignoring it.`);t.complete()}fireEvent(e){this.eventsPaused&&!p.inject.config.debug.ai?(x.info(`[SCHEDULED] ${e.name} (${(0,c.str)(e.payload,100)})`),this.scheduledEvents.push(e)):(x.info(`ðŸš€ ${e.name} (${(0,c.str)(e.payload,100)})`),this.onEvent.fire(e))}executePlay(e){if(e.category!=n.EventCategory.Play)throw new Error(`cannot execute ${e.name} - does not appear to be a Play`);x.info(`ðŸ‘¤â®• ${e.name}(${(0,c.str)(e.payload)})`),this.handleAction(e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventQueue=void 0;t.EventQueue=class{constructor(){this.sources=[],this.pendingEvents=[]}addSource(e){this.sources.push(e(e=>this.push(e)))}push(e){this.pendingEvents.push(e)}hasNext(){return this.pendingEvents.length>0}next(){return this.pendingEvents.shift()}unsubscribe(){this.sources.forEach(e=>e.unsubscribe())}clear(){this.pendingEvents=[]}}},,,,,,,,,function(e,t){},,function(e,t){},,,,,,,function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.InvertedMapProjection=void 0;const s=i(11),a=n(i(10)),o=i(65),r=i(5);class c extends o.MultiMapDataSet{constructor(e,t){super(e),this.key=e,this.source=t,this.parents=[this.source]}bootstrap(e){const t=(0,r.selectFromState)(e,this.source);if(!t)return a.default.Map();const i=[];if(!a.default.Map.isMap(t))throw console.error(t),new Error(`${this.source.key} is invalid source for InvertedMapProjection: ${t} is not an Immutable.Map instance`);return t.forEach((e,t)=>{(0,s.pushIntoArrayByKey)(i,e,t)}),n=i,a.default.Map().withMutations(e=>{for(let[t,i]of Object.entries(n))e.set(Number(t),a.default.Set(i))});var n}update(e,t,i){var n;const s=t.require(this.source),a=new o.MultiMapMutationBuilder(this,e);return null===(n=s.updated)||void 0===n||n.forEach(([e,t])=>{const n=(0,r.selectFromState)(i,this.source,e);void 0!==n&&a.remove(n,e),void 0!==t&&a.add(t,e)}),a.createMutation(this.source.key+" changed")}entryToString(e){return`[${e.size}]`}}t.InvertedMapProjection=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NextIdProjection=void 0;const n=i(9),s=i(146),a=i(5);class o extends s.SingletonDataSet{constructor(e,t){super(e,1),this.source=t,this.parents=[this.source]}bootstrap(e){const t=(0,a.selectFromState)(e,this.source);return t?t.keySeq().reduce(n.max,0)+1:1}update(e,t,i){var n;let s=(0,a.selectFromState)(i,this)||0,o=s;const r=t.require(this.source);let c=!1;if(null===(n=r.updated)||void 0===n||n.forEach(e=>{if(Array.isArray(e)){const[t,i]=e;void 0!==i?t>=o&&(o=t+1):c=!0}else{const t=e;t.added&&t.id>=o&&(o=t.id+1),t.removed&&(c=!0)}}),c)for(;o>1&&!(0,a.selectFromState)(e,this.source,o-1);)o-=1;return o!==s?this.createMutation(o,this.source.key):void 0}}t.NextIdProjection=o},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsByRegionUpdater=t.PawnsByRegionProjection=void 0;const s=i(11),a=n(i(10)),o=i(65),r=i(2),c=i(5),l=i(26),d=i(7);class h extends o.MultiMapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new u(this),this.update=this.updater.update.bind(this)}bootstrap(e){const t=(0,c.selectFromState)(e,this.sources.pawnsByHex),i=[];(0,r.assert)(a.default.Map.isMap(t),`Invalid source ${this.sources.pawnsByHex.key} for ${this.key}`),(0,c.selectFromState)(e,this.sources.pawnsByHex);for(const[n,a]of t){const t=d.Regions.getByHex(e,n);t&&(0,s.pushIntoArrayByKey)(i,t,...a)}return n=i,a.default.Map().withMutations(e=>{for(let[t,i]of Object.entries(n))e.set(Number(t),a.default.Set(i))});var n}}t.PawnsByRegionProjection=h;class u extends l.BaseUpdater{constructor(){super(...arguments),this.builder=new o.MultiMapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.pawnsHex,this._handlePawnsHexUpdate.bind(this)),e(this.dataSet.sources.regionsByHex,this._handleRegionsByHexUpdate.bind(this))}_handlePawnsHexUpdate(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{const i=(0,c.selectFromState)(this.oldState,this.dataSet.sources.pawnsHex,e),n=void 0!==t&&(0,c.selectFromState)(this.newState,this.dataSet.sources.regionsByHex,t);let s=void 0!==i&&(0,c.selectFromState)(this.oldState,this.dataSet.sources.regionsByHex,i);s!==n&&(s&&this.builder.remove(s,e),n&&this.builder.add(n,e))})}_handleRegionsByHexUpdate(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{let i=(0,c.selectFromState)(this.oldState,this.dataSet.sources.regionsByHex,e),n=(0,c.selectFromState)(this.newState,this.dataSet.sources.pawnsByHex,e);n&&(i&&this.builder.remove(i,...n.toArray()),t&&this.builder.add(t,...n.toArray()))})}}t.PawnsByRegionUpdater=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionsDataSetModel=void 0;const n=i(232),s=i(14),a=i(7),o=i(51);class r extends o.BaseModel{constructor(){super(...arguments),this.factionModels={}}byId(e){let t=this.factionModels[e];if(t||(t=new n.FactionModel(this,e),this.factionModels[t.id]=t),t.exists)return t}byRegion(e){const t=s.Factions.getByRegion(this.state,e.id);if(void 0!==t)return this.byId(t)}byHex(e){const t=a.Regions.getByHex(this.state,e.id);if(!t)return;const i=s.Factions.getByRegion(this.state,t);return void 0!==i?this.byId(i):void 0}nextId(){return s.Factions.getNextId(this.state)}all(){return s.Factions.getAll(this.state).map(e=>this.byId(e))}create(e){var t;const i=this.nextId();return this.state=s.Factions.createFaction(this.state,Object.assign(Object.assign({},e),{regions:null===(t=e.regions)||void 0===t?void 0:t.map(e=>e.id)})),this.byId(i)}}t.FactionsDataSetModel=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionModel=void 0;const n=i(12),s=i(109),a=i(1),o=i(84),r=i(3),c=i(2),l=i(14),d=i(7),h=i(149),u=i(11),g=i(85),p=i(110),m=i(18),f=i(29),y=i(0);a.logger.for("FactionsModel");class v extends s.BaseEntityModel{constructor(){super(...arguments),this.getRegions=(0,h.lazyAdapter)({source:()=>l.Factions.getFactionRegions(this.state,this.id),transform:e=>e.map(e=>d.Regions.model(this.state).byId(e))})}data(){return l.Factions.getData(this.state,this.id)}get exists(){return!!this.data()}get name(){var e;return(null===(e=this.data())||void 0===e?void 0:e.name)||""}get themeIndex(){var e;return(null===(e=this.data())||void 0===e?void 0:e.themeIndex)||0}get landColorLight(){return Phaser.Display.Color.IntegerToColor(this.landColor).lighten(10).color}get landColor(){return(p.THEMES[g.WorldMap.get(this.state).theme]||p.THEMES.default).colors[this.themeIndex]||13421772}get landColorDark(){return Phaser.Display.Color.IntegerToColor(this.landColor).darken(20).color}get controller(){var e;return null===(e=this.data())||void 0===e?void 0:e.controller}get power(){return m.AI.getFactionPower(this.state,this.id)}get hexes(){return n.HexGroup.union(this.getRegions().map(e=>e.hexes))}isAlive(){return this.controller!==r.FactionController.None&&this.getRegions().find(e=>e.isAlive())}isNeutral(){return this.id==f.SpecialFaction.neutral}getPawns(e){const t=(0,u.mergeArrays)(...this.getRegions().map(e=>e.getPawns()));return e?(0,o.filterPawns)(this.state,t,e):t}addNewRegion(e,t){const i=d.Regions.getNextId(this.state);return this.state=l.Factions.addNewRegion(this.state,this.id,e,t.toIdsArray()),d.Regions.model(this.state).byId(i)}disownRegions(...e){return this.state=l.Factions.disownRegions(this.state,...e.map(e=>e.id)),this}captureRegions(...e){return this.state=l.Factions.captureRegions(this.state,this.id,...e.map(e=>e.id)),this}captureHex(e){var t;const i=d.Regions.model(this.state),n=this.parentModel,s=i.byHex(e);if((null==s?void 0:s.faction)===this)return;let a=e.neighbours().map(e=>({region:i.byHex(e),faction:n.byHex(e)})).filter(({region:e,faction:t})=>t===this).map(({region:e,faction:t})=>e);a=(0,u.stripDuplicatesFrom)(a);let o=a.pop();o||(o=this.addNewRegion(y.inject.random.townName(),e)),o.addHexes(e),a.length>0&&o.absorbRegions(a),s&&(null===(t=s.faction)||void 0===t||t.splitRegionIfDisconnected(s))}ownsHex(e){return l.Factions.getByHex(this.state,e.id)===this.id}absorbOwnRegionsAdjacentTo(e){(0,c.assert)(this.ownsHex(e),`${e} is not owned by ${this}!`);const t=d.Regions.model(this.state),i=t.byHex(e);c.assert.defined(i);const n=Array.from(new Set(e.neighbours().map(e=>t.byHex(e)).filter(e=>e&&e!==i&&e.faction===this)));if(0===n.length)return[];const s=n.map(e=>({originalRegionId:e.id,hexes:e.hexes}));return i.absorbRegions(n),s}splitRegionIfDisconnected(e){const t=e.hexes.components(),i=[];if(t.length>1)for(t.popLargestGroup();t.length>0;){let n=t.popLargestGroup();i.push(this.addNewRegion(e.name||"",n))}return i}toString(){return`[Faction #${this.id} "${this.name}"]`}getLargestRegion(){const e=this.getRegions();if(0!==e.length)return e.reduce((e,t)=>t.hexes.length>e.hexes.length?t:e)}setLandColor(e){p.THEMES[g.WorldMap.get(this.state).theme].colors[this.themeIndex]=e}fearOf(e){return m.AI.getFactionFear(this.state,this.id,e.id)}approvalOf(e){return m.AI.getFactionApproval(this.state,this.id,e.id)}attitudeTowards(e){return m.AI.getFactionAttitude(this.state,this.id,e.id)}}t.FactionModel=v},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(12),s=i(2);t.default=class{constructor(){this.groups={},this.membership={},this._length=0}get length(){return this._length}addToGroup(e,...t){this.groups[e]?t.forEach(t=>this.groups[e].add(t)):this.groups[e]=new Set(t),t.forEach(t=>{const i=this.membership[t.id];void 0===i?(this.membership[t.id]=e,++this._length):i!==e&&(this.groups[i].delete(t),this.membership[t.id]=e)})}getOwnerOf(e){return this.membership[e.id]}removeGroup(e){s.assert.defined(this.groups[e]),this.groups[e].forEach(e=>delete this.membership[e.id]),this._length-=this.groups[e].size,delete this.groups[e]}forEach(e){for(const t in this.groups)e(n.HexGroup.from(Array.from(this.groups[t])),t)}map(e){let t=[];return this.forEach((i,n)=>t.push(e(i,n))),t}getLargestGroup(){const e=this.getLargestGroupKey();if(void 0!==e)return n.HexGroup.from(Array.from(this.groups[e]))}getLargestGroupKey(){let e=0,t=void 0,i=void 0;return this.forEach((n,s)=>{n.length>e&&(e=n.length,t=n,i=s)}),i}popLargestGroup(){const e=this.getLargestGroupKey();if(e){const t=this.groups[e];return this.removeGroup(e),n.HexGroup.from(Array.from(t))}throw new Error("Attempt to pop() from empty log groups collection")}getGroups(){return Object.values(this.groups).map(e=>n.HexGroup.from(Array.from(e)))}toString(){let e=0,t=Object.keys(this.groups).map(t=>{const i=this.groups[t].size;return e+=i,`${t}(${i})`}).join(", ");return`[HexGroupSet (${e}): ${t}]`}}},,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.neighbourBitmapHasDirection=t.HexDisplayDelegate=t.Hex=t.HEX_CORNER_NEIGHBOURS=t.HEX_CORNER_DIRECTIONS=t.HEX_DIRECTIONS=t.HexCornerDirection=t.HexDirection=void 0;const n=i(4),s=i(147),a=i(12),o=i(39),r=i(236);var c=Phaser.Math.PI2;!function(e){e[e.UP_LEFT=0]="UP_LEFT",e[e.UP_RIGHT=1]="UP_RIGHT",e[e.RIGHT=2]="RIGHT",e[e.DOWN_RIGHT=3]="DOWN_RIGHT",e[e.DOWN_LEFT=4]="DOWN_LEFT",e[e.LEFT=5]="LEFT"}(t.HexDirection||(t.HexDirection={})),function(e){e[e.UP_LEFT=0]="UP_LEFT",e[e.TOP=1]="TOP",e[e.UP_RIGHT=2]="UP_RIGHT",e[e.DOWN_RIGHT=3]="DOWN_RIGHT",e[e.DOWN=4]="DOWN",e[e.DOWN_LEFT=5]="DOWN_LEFT"}(t.HexCornerDirection||(t.HexCornerDirection={})),t.HEX_DIRECTIONS=[0,1,2,3,4,5],t.HEX_CORNER_DIRECTIONS=[0,1,2,3,4,5],t.HEX_CORNER_NEIGHBOURS=[[5,0],[0,1],[1,2],[2,3],[3,4],[4,5]];const l=[-c/3,-c/6,0,c/6,c/3,c/2],d=[[-.5,-1],[.5,-1],[1,0],[.5,1],[-.5,1],[-1,0]],h=[[-.5,-.25],[0,-.5],[.5,-.25],[.5,.25],[0,.5],[-.5,.25]];t.Hex=class{constructor(e){this.id=e}get tabular(){return void 0===this._tabular&&(this._tabular=(0,s.ordinalToTabular)(this.id)),this._tabular}get display(){return this._display||(this._display=new u(this)),this._display}get r(){return this.tabular.r}get c(){return this.tabular.c}get x(){return(0,s.tabularToSpatial)(this.tabular).x}get y(){return this.r}get length(){return 1}get members(){return[this]}isAtGridBorder(e){return n.HexGrid.isHexOnGridBorder(this,e)}neighbours(e=(e=>!0)){return a.HexGroup.from(d.map(e=>n.HexGrid.getHex({x:this.x+e[0],y:this.y+e[1]})).filter(t=>t&&e(t)))}neighboursByCornerDirection(e){const[i,n]=t.HEX_CORNER_NEIGHBOURS[e];return[this.neighbour(i),this.neighbour(n)].filter(e=>e)}neighbour(e){const t=d[e];return n.HexGrid.getHex({x:this.x+t[0],y:this.y+t[1]})}getDirectionTowards(e){const t=e.x-this.x,i=e.y-this.y;return d.findIndex(([e,n])=>e===t&&n===i)}getCorner(e){return r.HexCorner.fromHexAndDirection(this,e)}getCorners(){return t.HEX_CORNER_DIRECTIONS.map(e=>this.getCorner(e))}hasCorner(e){return e.sortedHexes.includes(this)}getAngleTowards(e){return l[this.getDirectionTowards(e)]}bfsFrom(e,t){t(e,void 0,0)}floodFillOut(e=(()=>!0)){return a.HexGroup.from([this]).floodFillOut(e)}findClosest(e,t){return a.HexGroup.from([this]).findClosest(e,t)}neighboursOf(e){return a.HexGroup.from([this]).neighboursOf(e)}toString(){return`[Hex #${this.id} (${this.x},${this.y})]`}asGroup(){return a.HexGroup.from([this])}toIdsArray(){return this.asGroup().toIdsArray()}toArray(){return this.asGroup().toArray()}has(e){return this.asGroup().has(e)}contains(e){return this.id===(null==e?void 0:e.id)}containsId(e){return this.id===e}border(e=!1){return this.asGroup().border(e)}boundingBox(){return{x:this.display.left,y:this.display.top,width:this.display.width,height:this.display.height}}components(e=(()=>!0)){return this.asGroup().components(e)}with(...e){return a.HexGroup.from([this,...e])}without(e){return this.asGroup().without(e)}filter(e){return this.asGroup().filter(e)}forEach(e){return this.asGroup().forEach(e)}map(e){return this.asGroup().map(e)}find(e){return this.asGroup().find(e)}sort(e){return this.asGroup().sort(e)}findInnerMostHex(){return this}findMax(e){return this}floodFillFrom(e,t){return a.HexGroup.from(e.members)}customSearchFrom(e,t,i){return a.HexGroup.from([this]).customSearchFrom(e,t,i)}findNeighbour(e){for(let t of d){const i=n.HexGrid.getHex({x:this.x+t[0],y:this.y+t[1]});if(i&&e(i))return i}}neighboursBitmap(e){let i=0;for(let n of t.HEX_DIRECTIONS){const t=this.neighbour(n);i<<=1,t&&e(t,n)&&++i}return i}};class u{constructor(e){this.hex=e,this.width=o.HEX_WIDTH,this.height=o.HEX_HEIGHT}get left(){return this.hex.x*o.HEX_WIDTH}get right(){return(this.hex.x+1)*o.HEX_WIDTH}get top(){return this.hex.y*o.HEX_INNER_HEIGHT}get bottom(){return this.hex.y*o.HEX_INNER_HEIGHT+o.HEX_HEIGHT}get centerX(){return this.hex.x*o.HEX_WIDTH+o.HALF_HEX_WIDTH}get centerY(){return this.hex.y*o.HEX_INNER_HEIGHT+o.HALF_HEX_HEIGHT}getCornerPoint(e){return{x:this.centerX+h[e][0]*o.HEX_WIDTH,y:this.centerY+h[e][1]*o.HEX_HEIGHT}}}t.HexDisplayDelegate=u,t.neighbourBitmapHasDirection=function(e,t){return!!(e&1<<5-t)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexCorner=void 0;const n=i(4),s=i(2),a=i(39);class o{constructor(e){this.sortedHexes=e.sort((e,t)=>e.id-t.id),this.id=r(...e),this.variant=this.sortedHexes[0].y===this.sortedHexes[1].y?"V":"A","A"===this.variant?this.display={x:this.sortedHexes[0].display.centerX,y:this.sortedHexes[0].display.centerY+a.HEX_HEIGHT/2}:this.display={x:this.sortedHexes[0].display.centerX+a.HEX_WIDTH/2,y:this.sortedHexes[0].display.centerY+.25*a.HEX_HEIGHT}}static byId(e){if(!this.cache[e]){const t=e.split(".").map(e=>(0,n.getHex)(Number(e)));(0,s.assert)(3===t.length,"invalid cornerId "+e),this.cache[e]=new o(t)}return this.cache[e]}static fromHexes(...e){const t=r(...e.sort((e,t)=>e.id-t.id));return this.byId(t)}static fromHexAndDirection(e,t){return o.fromHexes(e,...e.neighboursByCornerDirection(t))}}function r(e,t,i){return i?[e,t,i].map(e=>e.id).sort((e,t)=>e-t).join("."):e.id>t.id?`${t.id}.${e.id}`:`${e.id}.${t.id}`}t.HexCorner=o,o.cache={}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsDataSetModel=void 0;const n=i(11),s=i(2),a=i(84),o=i(17),r=i(51),c=i(4),l=i(85);class d extends r.BaseModel{constructor(){super(...arguments),this.pawnModels={}}byId(e){let t=this.pawnModels[e];if(t||(t=new a.PawnModel(this,e),this.pawnModels[e]=t),t.exists)return t}byType(e,t){return this.select({hexes:e,type:[t]})}select(e){const t=e.hexes||l.WorldMap.getAllHexes(this.state);let i=(0,n.mergeArrays)(...t.map(e=>o.Pawns.getByHex(this.state,e.id))).map(e=>this.byId(e));return e.type&&(i=i.filter(t=>e.type.includes(t.type))),e.traits&&(i=i.filter(t=>e.traits.every(e=>t.hasTrait(e)))),void 0!==e.movable&&(i=i.filter(t=>t.isMovable()===e.movable)),i}findOne(e){return this.select(e)[0]}findClosest(e,t,i){let n=void 0;return t.bfsFrom(e,e=>!n&&(n=this.byHex(e).filter(i)[0],!n)),n}byHex(e,t){return"number"==typeof e&&(e=(0,c.getHex)(e)),t?this.select({hexes:e,type:[t]})[0]:this.select({hexes:e})}byRegion(e){return o.Pawns.getByRegion(this.state,e.id).map(e=>this.byId(e))}adjustCount(e,t,i){if(0===i)return;const n=this.byHex(e,t);n?n.setCount(n.count+i):((0,s.assert)(i>=0,`attempt to reduce ${t} count at ${e} below 0 (0-${-i}=${i})`),this.create({hex:e,type:t,count:i}))}setCount(e,t,i){const n=this.byHex(e,t);if(n)n.setCount(i);else{if(0===i)return;this.create({hex:e,type:t,count:i})}}presentAtHex(e,...t){return this.select({hexes:e,type:t.length>0?t:void 0}).length>0}nextId(){return o.Pawns.getNextId(this.state)}all(){return o.Pawns.getAll(this.state).map(e=>this.byId(e))}create(e){const t=this.nextId();return this.state=o.Pawns.create(this.state,e),this.byId(t)}destroy(...e){this.state=o.Pawns.destroy(this.state,...e.map(e=>e.id))}clear(){this.destroy(...this.all())}getCount(e,t){const i=this.byHex(e,t);return i?i.count:0}}t.PawnsDataSetModel=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapModel=void 0;const n=i(4);t.WorldMapModel=class{constructor(e){this.state=e,this.innerWidth=this.state.width-2,this.innerHeight=this.state.height-2,this.width=this.state.width,this.height=this.state.height}get theme(){return this.state.theme}get levelId(){return this.state.levelId}getAllHexes(){return n.HexGrid.getAllHexes(this.state)}getInnerHexes(){return n.HexGrid.getInnerHexes(this.state)}filter(e){return n.HexGrid.filter(e,this.state)}isWithinBounds(e){return n.HexGrid.isWithinBounds(e,this.state)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RulesModel=t.PawnTypeRulesModel=void 0;const n=i(13);class s{constructor(e,t){this.pawnRules=e,this.type=t}get state(){return this.pawnRules}get cost(){var e;return(null===(e=this.state)||void 0===e?void 0:e.cost)||0}get upkeep(){var e;return(null===(e=this.state)||void 0===e?void 0:e.upkeep)||0}get defense(){var e;return(null===(e=this.state)||void 0===e?void 0:e.defense)||0}get might(){var e;return(null===(e=this.state)||void 0===e?void 0:e.might)||0}get traits(){var e;return(null===(e=this.state)||void 0===e?void 0:e.traits)||[]}get mergeRules(){var e;return(null===(e=this.state)||void 0===e?void 0:e.merge)||{}}hasTrait(e){return this.traits.includes(e)}toString(){return`[PawnType ${this.type}]`}}t.PawnTypeRulesModel=s;t.RulesModel=class{constructor(e){this.rules=e,this.pawnModels={},this.unitsByMight={},this.castlesByMight={},this.getAllPawnTypes().forEach(e=>{e.hasTrait(n.PawnTraits.Unit)&&e.might&&(this.unitsByMight[e.might]=e),e.hasTrait(n.PawnTraits.Building)&&e.cost&&e.defense&&(this.castlesByMight[e.defense]=e)})}get economy(){return this.state.economy}get state(){return this.rules}pawns(e){let t=this.pawnModels[e];return t||(t=new s(this.state.pawns[e],e),this.pawnModels[e]=t),t}unitByMight(e){return this.unitsByMight[e]}castleByMight(e){return this.castlesByMight[e]}getAllPawnTypes(){return Object.keys(this.state.pawns).map(e=>this.pawns(e))}getPawnTypesByTrait(e){this.getAllPawnTypes().filter(t=>t.hasTrait(e))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurrentPhaseModel=void 0;const n=i(3),s=i(2),a=i(25),o=i(14),r=i(17),c=i(51);class l extends c.BaseModel{get type(){return a.CurrentPhase.getType(this.state)}get turnNumber(){return a.CurrentPhase.getTurnNumber(this.state)}get faction(){const e=a.CurrentPhase.getFaction(this.state);if(void 0!==e)return o.Factions.model(this.state).byId(e)}isTapped(e){return a.CurrentPhase.isTapped(this.state,e.id)}isMovable(e){return a.CurrentPhase.isMovable(this.state,e.id)}isLocalPlayerTurn(){var e;return this.type===n.PhaseTypes.FactionTurn&&(null===(e=this.faction)||void 0===e?void 0:e.controller)===n.FactionController.LocalUser}getMovablePawns(){if(this.type!==n.PhaseTypes.FactionTurn)return[];s.assert.defined(this.faction);const e=r.Pawns.model(this.state);return a.CurrentPhase.getMovableUnits(this.state).map(t=>e.byId(t))}getNextFaction(){const e=a.CurrentPhase.getFaction(this.state),t=o.Factions.getAll(this.state);return void 0===e?t[0]:t[(t.indexOf(e)+1)%t.length]}tapPawn(e){this.state=a.CurrentPhase.tapPawn(this.state,e.id)}unTapPawn(e){this.state=a.CurrentPhase.unTapPawn(this.state,e.id)}set(e){this.state=a.CurrentPhase.set(this.state,e)}is(e){return this.type===e}incrementTurnNumber(){this.set({turnNumber:this.turnNumber+1})}}t.CurrentPhaseModel=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AIModel=void 0;const n=i(8),s=i(51),a=i(5);class o extends s.BaseModel{getHexDepth(e){return(0,a.selectFromState)(this.state,n.GameState.ai.hexDepth,e.id)||0}getHexImportance(e){var t;return(null===(t=(0,a.selectFromState)(this.state,n.GameState.ai.hexImportance,e.id))||void 0===t?void 0:t.value)||0}}t.AIModel=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionsDataSetModel=void 0;const n=i(5),s=i(243),a=i(8),o=i(11),r=i(12),c=i(7),l=i(51);class d extends l.BaseModel{constructor(){super(...arguments),this.regionModels={}}all(){return(0,n.selectFromState)(this.state,a.GameState.regions.byId).keySeq().toArray().map(e=>this.byId(e))}byHex(e){let t="number"==typeof e?e:e.id;const i=c.Regions.getByHex(this.state,t);return i?this.byId(i):void 0}byId(e){if(c.Regions.getRegionData(this.state,e))return(0,o.getOrCreate)(this.regionModels,e,()=>new s.RegionModel(this,e))}nextId(){return(0,n.selectFromState)(this.state,a.GameState.regions.nextId)}create(e,t=r.HexGroup.empty){const i=this.nextId();return this.state=c.Regions.createRegion(this.state,e,t.toIdsArray()),this.byId(i)}destroy(...e){this.state=c.Regions.destroyRegions(this.state,...e.map(e=>e.id))}clear(){this.destroy(...this.all())}}t.RegionsDataSetModel=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionModel=void 0;const n=i(12),s=i(149),a=i(3),o=i(7),r=i(14),c=i(30),l=i(18),d=i(109),h=i(17),u=i(4),g=i(24),p=i(25),m=i(11),f=i(151);class y extends d.BaseEntityModel{constructor(){super(...arguments),this._hexes=(0,s.lazyAdapter)({source:()=>o.Regions.getRegionHexes(this.state,this.id),transform:e=>(0,u.getHexes)(e.toArray())}),this.getTownHexes=(0,s.lazyAdapter)({source:()=>c.Economy.getTownHexesByRegion(this.state,this.id),transform:e=>(0,u.getHexes)(e.toArray())}),this.getBorderHexes=(0,s.lazyAdapter)({source:()=>o.Regions.getRegionBorderHexes(this.state,this.id),transform:e=>(0,u.getHexes)(e.toArray())}),this.getHostileBorderHexes=(0,s.lazyAdapter)({source:()=>l.AI.getHostileBorderHexesByRegion(this.state,this.id),transform:e=>(0,u.getHexes)(e.toArray())}),this.getPawns=(0,s.lazyAdapter)({source:()=>h.Pawns.getByRegion(this.state,this.id),transform:e=>e.map(e=>h.Pawns.model(this.state).byId(e))})}get name(){var e;return(null===(e=o.Regions.getRegionData(this.state,this.id))||void 0===e?void 0:e.name)||""}get exists(){return!!o.Regions.getRegionData(this.state,this.id)}get hexes(){return this._hexes()}get faction(){const e=r.Factions.getByRegion(this.state,this.id);if(void 0!==e)return r.Factions.model(this.state).byId(e)}get budget(){return c.Economy.getRegionBudget(this.state,this.id)}get treasury(){return c.Economy.getTreasuryOf(this.state,this.id)}get size(){var e;return(null===(e=o.Regions.getRegionHexes(this.state,this.id))||void 0===e?void 0:e.size)||0}getUnitsByMight(e=!1){var t;return this.faction&&(null===(t=this.faction)||void 0===t?void 0:t.controller)!==a.FactionController.None&&this.isAlive()?f.UnitsByMight.fromUnitList(g.Warfare.model(this.state).getUnitsByRegion(this).filter(t=>!e||p.CurrentPhase.isMovable(this.state,t.id)).map(e=>e.might).sort(m.ascendingSortFn)):new f.UnitsByMight}getMovableUnitsByMight(){return this.getUnitsByMight(!0)}get power(){return l.AI.getRegionPower(this.state,this.id)}isAlive(){const e=r.Factions.getByRegion(this.state,this.id);if(!e)return!1;const t=r.Factions.getData(this.state,e);return!(!t.controller||t.controller===a.FactionController.None)&&0!==c.Economy.getTownHexesByRegion(this.state,this.id).size}isActionable(){return this.isAlive()&&(this.treasury>=10||p.CurrentPhase.model(this.state).getMovablePawns().find(e=>e.region===this))}addHexes(e){return this.state=o.Regions.addHexesToRegion(this.state,this.id,e.toIdsArray()),this}removeHexes(e){return this.state=o.Regions.removeHexesFromRegion(this.state,e.toIdsArray()),this}absorbRegions(e){if(e.includes(this))throw new Error(`Invalid absorbRegion arguments - region ${this} cannot absorb itself`);return this.addHexes(n.HexGroup.union(e.map(e=>e.hexes))),this.parentModel.destroy(...e),this}splitIntoComponents(){return o.Regions.splitRegionIntoComponents(this.state,this.id),this}toString(){return`[Region #${this.id} (${this.hexes.length}â¬¡)]`}}t.RegionModel=y},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EconomyModel=void 0;const n=i(5),s=i(245),a=i(13),o=i(52),r=i(17),c=i(1),l=i(30),d=i(51),h=i(4),u=i(8);c.logger.for("EconomyModel");class g extends d.BaseModel{townHexesOf(e){const t=l.Economy.getTownHexesByRegion(this.state,e.id);return(0,h.getHexes)(t.toArray())}nearestTownHexFrom(e){var t;const i=null===(t=(0,n.selectFromState)(this.state,u.GameState.economy.nearestTown,e.id))||void 0===t?void 0:t.rootId;if(i)return(0,h.getHex)(i)}baseIncomePerHex(){return o.Rules.getEconomyRules(this.state).baseIncomePerTile}incomeFromHex(e){return r.Pawns.model(this.state).byHex(e).find(e=>e.hasTrait(a.PawnTraits.NegatesTileIncome))?0:l.Economy.getBaseIncomePerHex(this.state)}gatherRegionIncome(e){return new s.RegionEconomyCalculator(e).run({gatherIncome:!0,payUpkeep:!1})}payUnitUpkeep(e){return new s.RegionEconomyCalculator(e).run({gatherIncome:!1,payUpkeep:!0})}gatherIncomeAndPayUpkeep(e){return new s.RegionEconomyCalculator(e).run({gatherIncome:!0,payUpkeep:!0})}treasuryOf(e){return l.Economy.getTreasuryOf(this.state,e.id)}numberOfCoinsAt(e){return l.Economy.getNumberOfCoinsAt(this.state,e.id)}payForNewPawn(e,t){var i;const n=l.Economy.payToHex(this.state,e,(null===(i=o.Rules.getPawnRules(this.state,t))||void 0===i?void 0:i.cost)||0);return n.apply(this.state),n.getTransactions()}payToHex(e,t,i){const n=l.Economy.payToHex(this.state,t,i);return n.apply(this.state),n.getTransactions()}loot(e,t){const i=l.Economy.loot(this.state,e,t);return i.apply(this.state),i.getTransactions()}budgetOf(e){return l.Economy.getRegionBudget(this.state,e.id)}}t.EconomyModel=g},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionEconomyCalculator=void 0;const n=i(1),s=i(60),a=i(3),o=i(2),r=i(30),c=i(4),l=i(13),d=i(29),h=i(152),u=i(0);n.logger.for("RegionEconomyCalculator");t.RegionEconomyCalculator=class{constructor(e){this.region=e,this.sinks=[],this.builder=new s.CoinTransactionBuilder,this.newBanditCampHexIds=[],this.model=u.inject.gameStateModel}run({gatherIncome:e,payUpkeep:t}){this.allRegionHexes=this.region.hexes,this.builder.reset();const i=r.Economy.getTownHexesByRegion(this.model.state,this.region.id).toArray();if(this.townHexes=(0,c.getHexes)(i).members,this.goldByHex={},this.spawnGoldInTreasury(),e&&this.spawnIncome(),t)for(this.assembleSinks();this.sinks.length;){const e=this.sinks[0],t=this.allRegionHexes.findClosest(e.pawn.hex,e=>(this.goldByHex[e.id]||0)>0);if(!t)break;{const i=this.goldByHex[t.id];i>e.demand?this.sendMoneyToSink(t,0,e.demand):this.sendMoneyToSink(t,0,i)}}Object.entries(this.goldByHex).map(([e,t])=>({hexId:Number(e),remainingIncome:t})).filter(({hexId:e})=>!i.includes(e)).forEach(({hexId:e,remainingIncome:t})=>{const i=(0,c.getHex)(e),n=this.model.economy.nearestTownHexFrom(i);n&&this.sendMoneyToTown(i,n,t)});let n=[];if(this.sinks.length>0){const e=this.model.pawns.select({hexes:this.region.hexes,traits:[l.PawnTraits.Unit]});if(n=e.map(e=>e.hex.id),e.forEach(e=>{e.replaceWith(a.PawnType.Bandit)}),0===this.townHexes.length){const e=this.model.pawns.select({hexes:this.region.hexes,type:[a.PawnType.Castle]});this.newBanditCampHexIds.push(...e.map(e=>e.hex.id)),e.forEach(e=>{var t;const i=e.hex;e.replaceWith(a.PawnType.Camp),null===(t=this.model.factions.byId(d.SpecialFaction.neutral))||void 0===t||t.captureHex(i)})}}this.builder.apply(this.model.state);return{regionId:this.region.id,coinTransfers:this.builder.getTransactions(),unitsTurnedBandits:n,newBanditCamps:this.newBanditCampHexIds}}assembleSinks(){this.model.pawns.select({hexes:this.region.hexes}).filter(e=>e.upkeep&&e.upkeep>0).forEach(e=>{this.sinks.push({pawn:e,demand:e.upkeep})})}sendMoneyToSink(e,t,i){const n=this.sinks[t];this.builder.from(e).send(n.pawn.hex,i).consume(),n.demand-=i,this.removeGoldFromHex(e,i),0===n.demand&&this.sinks.splice(t,1)}sendMoneyToTown(e,t,i){this.builder.from(e).send(t,i),this.removeGoldFromHex(e,i),this.addGoldToHex(t,i)}spawnIncome(){0!==this.townHexes.length&&(this.allRegionHexes.forEach(e=>{const t=this.model.economy.incomeFromHex(e.id);t>0&&(this.addGoldToHex(e,t),this.builder.from(e).spawn(t))}),this.evalBanditLooting())}spawnGoldInTreasury(){for(const e of this.townHexes)this.addGoldToHex(e,this.model.economy.numberOfCoinsAt(e)||0)}addGoldToHex(e,t){this.goldByHex[e.id]=(this.goldByHex[e.id]||0)+t}removeGoldFromHex(e,t){(0,o.assert)(this.goldByHex[e.id]>0),this.goldByHex[e.id]=this.goldByHex[e.id]-t,this.goldByHex[e.id]<=0&&delete this.goldByHex[e.id]}evalBanditLooting(){this.model.pawns.select({hexes:this.allRegionHexes,type:[a.PawnType.Bandit]}).map(e=>e.hex).forEach(e=>{const t=(0,h.getOrCreateNearestCamp)(this.model,e,e=>{this.newBanditCampHexIds.push(e)});t&&this.builder.from(e).spawn(1).send(t)})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WarfareModel=void 0;const n=i(51),s=i(52),a=i(13),o=i(7),r=i(17),c=i(24),l=i(12);class d extends n.BaseModel{getUnitsByRegion(e){const t=r.Pawns.model(this.state);return c.Warfare.getUnitsByRegion(this.state,e.id).map(e=>t.byId(e))}getConquerableHexes(e,t){return 0===t?l.HexGroup.empty:c.Warfare.getConquerableHexes(this.state,e.id,t)}getHexLocalDefense(e){return c.Warfare.getHexLocalDefense(this.state,e.id)}getHexDefenders(e,t=1){return c.Warfare.getHexDefenders(this.state,e,t)}getHexDefense(e){return c.Warfare.getHexDefense(this.state,e)}getHexStaticDefense(e){return c.Warfare.getHexStaticDefense(this.state,e)}canConquerHexWith(e,t){return c.Warfare.canConquerHexWith(this.state,e,t)}getMergeResult(e,t){return s.Rules.getMergeResult(this.state,e,t)}isOccupied(e){return!!this.getOccupyingUnit(e)}getOccupyingUnit(e){return c.Warfare.getOccupyingUnit(this.state,e)}getMightOf(e){return s.Rules.model(this.state).pawns(e).might}isWall(e){return s.Rules.model(this.state).pawns(e).hasTrait(a.PawnTraits.Wall)}getDropPawnResult(e,t,i){const n=o.Regions.model(this.state),r=s.Rules.model(this.state),l=n.byHex(e);if(l===i){const i=this.getOccupyingUnit(e);if(!i)return{type:c.DropPawnResultType.Reposition};if(i.hasTrait(a.PawnTraits.Pest))return r.pawns(t).hasTrait(a.PawnTraits.Unit)&&i.defense<this.getMightOf(t)?{type:c.DropPawnResultType.EradicatePest,pest:i}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:[i]};const n=r.pawns(i.type).mergeRules[t];return n?{type:c.DropPawnResultType.Combine,combineWith:i,combineInto:n}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:[i]}}return(null==l?void 0:l.faction)===i.faction?{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.InvalidRegion}:r.pawns(t).hasTrait(a.PawnTraits.Unit)?e.neighbours().find(e=>n.byHex(e)===i)?this.canConquerHexWith(e,t)?{type:c.DropPawnResultType.Conquest}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:this.getHexDefenders(e,r.pawns(t).might)}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.OutOfRange}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.InvalidRegion}}getRetreatDestination(e,t){const i=e.region;return i.hexes.neighboursOf(e.hex).filter(e=>!this.isOccupied(e)).findMax(e=>100*this.getHexStaticDefense(e)+i.hexes.neighboursOf(e).length)}getWallLevelAt(e){const t=r.Pawns.model(this.state).findOne({hexes:e,traits:[a.PawnTraits.Wall]});return t?t.defense:0}}t.WarfareModel=d},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexImportanceUpdater=t.HexImportanceProjection=t.TOWN_HEX_BASE_IMPORTANCE=t.NO_IMPORTANCE=void 0;const s=i(21),a=n(i(10)),o=n(i(57)),r=i(19),c=i(1),l=i(9),d=i(3),h=i(7),u=i(25),g=i(30),p=i(2),m=i(17),f=i(26),y=i(4);t.NO_IMPORTANCE=Object.freeze({distanceFromTown:1/0,value:0,factors:{fromConnectedHexes:0,fromTownProximity:0,fromHex:0},parents:[],connectivity:0});c.logger.for("HexImportanceProjection");t.TOWN_HEX_BASE_IMPORTANCE=40;class v extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new w(this).update}bootstrap(e){const t=new w(this);return t.initFromState(e),h.Regions.getAll(e).filter(t=>h.Regions.model(e).byId(t).isAlive()).forEach(e=>t.invalidateRegion(e)),t.getMap()}entryToString(e){return e.value.toString()}entryToDebugString(e){return(0,r.prettyPrintObject)(e)}}t.HexImportanceProjection=v;class w extends f.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.invalidatedRegions=new Set,this.roots=new Map,this.regionId=-1,this}registerHandlers(e){e(this.dataSet.sources.townsByRegion,this.handleTownsByRegionChange),e(this.dataSet.sources.regionsHexes,this.handleRegionsHexesChange),e(this.dataSet.sources.pawnsValueByHex,this.handleHexValueChanged),e(this.dataSet.sources.coinsByHex,this.handleHexValueChanged)}handleTownsByRegionChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>{this.invalidateRegion(e.id)})}handleRegionsHexesChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>{var t,i;const n=e.id;null===(t=e.added)||void 0===t||t.forEach(e=>{const t=(0,y.getHex)(e);this.invalidateAfterCapturedHex(t,n)}),null===(i=e.removed)||void 0===i||i.forEach(e=>{const t=(0,y.getHex)(e);this.invalidateAfterCapturedHex(t,n)})})}handleHexValueChanged(e){var t;const i=new Set;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{i.add(e)});for(let e of i){const t=h.Regions.getByHex(this.newState,e);t&&!this.invalidatedRegions.has(t)&&(this.setRegion(t),this.region.isAlive()&&this.invalidateHexAndParents((0,y.getHex)(e)))}}createMutation(){return this.updateInvalidated(),super.createMutation()}setRegion(e){e!==this.regionId&&(this.regionId=e,this.region=h.Regions.model(this.newState).byId(this.regionId),p.assert.defined(this.region,"no region matched for id "+this.regionId))}invalidateAfterCapturedHex(e,t){if(this.setRegion(t),!this.region.isAlive())return;this.invalidateHex(e);let i=this.region.hexes.neighboursOf(e);i.forEach(e=>{this.invalidateHex(e),this.findNewParents(e).parents.forEach(e=>{this.invalidateHexAndParents(e)})}),i.forEach(e=>{this.invalidatePotentialChildren(e)})}invalidateHex(e){this.invalidatedHexes.has(e)||(this.invalidatedHexes.add(e),m.Pawns.getByHex(this.newState,e.id,d.PawnType.Town)&&this.addRoot(e))}findNewParents(e){p.assert.defined(this.region,`must first set region before calling findParents (called with ${e})`);let t=1/0,i=[];return this.region.hexes.neighboursOf(e).filter(e=>this.builder.has(e.id)||!this.isInvalidated(e)).forEach(e=>{var n,s,a,o;const r=(null!==(s=null===(n=this.builder.getCurrent(e.id))||void 0===n?void 0:n.distanceFromTown)&&void 0!==s?s:1/0)+(7-(null!==(o=null===(a=this.builder.getCurrent(e.id))||void 0===a?void 0:a.connectivity)&&void 0!==o?o:0));r===t?i.push(e):r<t&&(t=r,i=[e])}),{parents:i,distance:t}}addRoot(e){const t=h.Regions.getByHex(this.newState,e.id),i=this.roots.get(t)||new Set;i.add(e),this.roots.set(t,i)}invalidateParents(e){var t;let i=(null===(t=this.dataSet.getEntryById(this.newState,e.id))||void 0===t?void 0:t.parents)||[];0===i.length&&m.Pawns.getByHex(this.newState,e.id,d.PawnType.Town)&&this.addRoot(e),i.filter(e=>!this.isInvalidated(e)).forEach(e=>{this.invalidateHexAndParents(e)})}invalidatePotentialParents(e){this.region.hexes.neighboursOf(e).filter(e=>!this.isInvalidated(e)).forEach(e=>{this.invalidateHexAndParents(e)})}invalidateHexAndParents(e){this.invalidatedHexes.has(e)||(this.invalidateHex(e),this.invalidateParents(e))}invalidatePotentialChildren(e){var t;if(this.invalidatedRegions.has(this.regionId))return;const i=(null===(t=this.dataSet.getEntryById(this.newState,e.id))||void 0===t?void 0:t.distanceFromTown)||0;this.region.hexes.neighboursOf(e).filter(e=>{var t;return(null===(t=this.dataSet.getEntryById(this.newState,e.id))||void 0===t?void 0:t.distanceFromTown)>i}).forEach(e=>{this.invalidateHex(e),this.invalidatePotentialParents(e),this.invalidatePotentialChildren(e)})}invalidateRegion(e){const i=h.Regions.model(this.newState).byId(e);if(i&&!this.invalidatedRegions.has(i.id))if(i.isAlive()){const t=g.Economy.getTownHexesByRegion(this.newState,e);this.invalidatedRegions.add(e),t.forEach(e=>this.addRoot((0,y.getHex)(e)))}else i.hexes.forEach(e=>this.builder.set(e.id,t.NO_IMPORTANCE))}updateInvalidated(){for(let[e,t]of this.roots.entries())this.updateForRegion(e,t);this.invalidatedHexes.forEach(e=>this.builder.delete(e.id))}updateForRegion(e,i){this.setRegion(e);const n=new Set,s=new Map,a=new Set,r=new o.default((e,t)=>e.distance-t.distance);for(i.forEach(e=>r.push({hex:e,distance:0}));!r.empty();){const e=r.pop(),i=e.hex;if(a.has(i))continue;const o=this.getHexConnectivity(i);if(a.add(i),n.add(i),this.invalidatedHexes.delete(i),0===e.distance)this.builder.set(i.id,{connectivity:o,parents:[],value:0,distanceFromTown:0,factors:{fromHex:this.getHexBaseImportance(i),fromConnectedHexes:0,fromTownProximity:t.TOWN_HEX_BASE_IMPORTANCE}});else{let{parents:e,distance:a}=this.findNewParents(i);const r={connectivity:o,parents:e,distanceFromTown:a,value:0,factors:{fromHex:this.getHexBaseImportance(i),fromConnectedHexes:0,fromTownProximity:Math.floor(t.TOWN_HEX_BASE_IMPORTANCE/(a+1))}};this.builder.set(i.id,r),e.forEach(e=>{const t=(s.get(e)||0)+1;n.delete(e),s.set(e,t)})}this.region.hexes.neighboursOf(i).filter(e=>(!this.builder.getCurrent(e.id)||this.isInvalidated(e))&&!a.has(e)).forEach(e=>{const t=this.builder.get(i.id);r.push({hex:e,distance:t.distanceFromTown+(7-t.connectivity)})})}const c=Array.from(n);for(;c.length;){const e=c.pop(),t=this.builder.getCurrent(e.id),i=t.factors;this.addValueFromUnchangedChildren(e),i.fromConnectedHexes=Math.floor(i.fromConnectedHexes),t.value=i.fromHex+i.fromConnectedHexes+i.fromTownProximity,t.parents.forEach(t=>{var i;const n=null!==(i=s.get(t))&&void 0!==i?i:0;0===n&&console.error(`${t} considered parent of ${e.id}, but his children count is ${n}`),n<=1&&c.push(t),s.set(t,(0,l.max)(0,n-1)),this.addValueToParent(e,t)})}this.invalidatedRegions.delete(this.regionId)}isInvalidated(e){return!!this.invalidatedRegions.has(this.regionId)||this.invalidatedHexes.has(e)}addValueToParent(e,t){const i=this.builder.getCurrent(e.id),n=this.builder.getCurrent(t.id);p.assert.defined(n),p.assert.defined(i);const s=i.parents.length,a=(i.factors.fromHex+i.factors.fromConnectedHexes)/s;n.factors.fromConnectedHexes+=a}getHexConnectivity(e){return 6-e.neighbours(e=>{const t=h.Regions.getByHex(this.newState,e.id);return void 0!==t&&t!==this.regionId}).length}getHexBaseImportance(e){return Math.floor(m.Pawns.model(this.newState).byHex(e).filter(e=>!u.CurrentPhase.isMovable(this.newState,e.id)).map(e=>this.getValueOfPawn(e)).reduce(l.sum,1))}getValueOfPawn(e){return e.type===d.PawnType.Coins?e.count:e.rules.cost}getMap(){return this.updateInvalidated(),a.default.Map(this.builder.getEntries()).mapKeys(e=>Number(e))}addValueFromUnchangedChildren(e){this.region.hexes.neighboursOf(e).filter(t=>{var i;return!this.builder.get(t.id)&&!!(null===(i=this.dataSet.getEntryById(this.newState,t.id))||void 0===i?void 0:i.parents.includes(e))}).forEach(t=>this.addValueToParent(t,e))}}t.HexImportanceUpdater=w},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexesByPawnTypeAndRegionProjection=void 0;const n=i(249),s=i(17);class a extends n.FilteredMultiMapProjection{constructor(e,t,i){super(e,i.pawnsByRegion),this.filteredPawnType=t,this.sources=i}constraint(e,t){return s.Pawns.getPawnType(e,t)===this.filteredPawnType}transform(e,t){return s.Pawns.getPawnHex(e,t)}}t.HexesByPawnTypeAndRegionProjection=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FilteredMultiMapProjection=void 0;const n=i(65),s=i(5);class a extends n.MultiMapDataSet{constructor(e,t,i=[]){super(e),this.key=e,this.filteredDataSet=t,this.parents=[t,...i]}bootstrap(e){return(0,s.selectFromState)(e,this.filteredDataSet).map(t=>t.filter(t=>this.constraint(e,t))).filter(e=>!e.isEmpty()).map(t=>t.map(t=>this.transform(e,t)))}update(e,t,i){var s;const a=t.of(this.filteredDataSet);if(!a)return;const o=new n.MultiMapMutationBuilder(this,e);return null===(s=a.updated)||void 0===s||s.forEach(t=>{let n=t.id;if(t.added&&o.add(n,...t.added.filter(t=>this.constraint(e,t)).map(t=>this.transform(e,t))),t.removed){const s=this.getEntryById(e,n);if(!s)return;o.remove(n,...t.removed.filter(e=>this.constraint(i,e)).map(e=>this.transform(i,e)).filter(e=>s.has(e)))}}),o.createMutation(this.filteredDataSet.key)}}t.FilteredMultiMapProjection=a},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.UnitsByFactionUpdater=t.UnitsByFactionProjection=void 0;const s=n(i(10)),a=i(65),o=i(5),r=i(26),c=i(14),l=i(24);class d extends a.MultiMapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new h(this).update}bootstrap(e){const t=(0,o.selectFromState)(e,this.sources.factionRegions);return s.default.Map().withMutations(i=>{t.entrySeq().forEach(([t,n])=>{let a=s.default.Set(l.Warfare.getUnitsByRegion(e,...n.toArray()));a.isEmpty()||i.set(t,a)})})}}t.UnitsByFactionProjection=d;class h extends r.BaseUpdater{constructor(){super(...arguments),this.builder=new a.MultiMapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.factionRegions,this._handleFactionRegionsUpdate),e(this.dataSet.sources.pawnsByRegion,this._handlePawnsByRegionUpdate)}_handleFactionRegionsUpdate(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>{e.removed&&this.builder.remove(e.id,...l.Warfare.getUnitsByRegion(this.newState,...e.removed)),e.added&&this.builder.add(e.id,...l.Warfare.getUnitsByRegion(this.newState,...e.added))})}_handlePawnsByRegionUpdate(e){var t,i;null===(t=e.updated)||void 0===t||t.forEach(e=>{let t=c.Factions.getByRegion(this.newState,e.id);t&&e.removed&&this.builder.remove(t,...e.removed.filter(e=>l.Warfare.isUnit(this.oldState,e)))}),null===(i=e.updated)||void 0===i||i.forEach(e=>{let t=c.Factions.getByRegion(this.newState,e.id);t&&e.added&&this.builder.add(t,...e.added.filter(e=>l.Warfare.isUnit(this.newState,e)))})}}t.UnitsByFactionUpdater=h},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MovableUnitsProjection=void 0;const s=n(i(10)),a=i(3),o=i(153),r=i(5);class c extends o.SetDataSet{constructor(e,t){super(e),this.key=e,this.sources=t,this.parents=Object.values(this.sources),this.builder=new o.SetDataSetMutationBuilder(this)}bootstrap(e){const t=(0,r.selectFromState)(e,this.sources.currentPhase);if(t.type!==a.PhaseTypes.FactionTurn)return s.default.Set();const i=(0,r.selectFromState)(e,this.sources.unitsByFaction,t.faction);return i&&0!==i.size?i.filter(t=>!this._isTapped(e,t)):s.default.Set()}update(e,t,i){this.builder.init(e);const n=t.of(this.sources.currentPhase);return n?(this._handleCurrentPhaseChange(e,n,i),this.builder.createMutation("phase changed")):(this._handleTappedUnitsChange(e,t.of(this.sources.currentPhaseTappedUnits),i),this._handleFactionUnitsChange(e,t.of(this.sources.unitsByFaction),i),this.builder.createMutation("units changed"))}_isTapped(e,t){return(0,r.selectFromState)(e,this.sources.currentPhaseTappedUnits).has(t)}_handleFactionUnitsChange(e,t,i){var n;if(!t)return;const s=(0,r.selectFromState)(e,this.sources.currentPhase).faction;void 0!==s&&(null===(n=t.updated)||void 0===n||n.forEach(t=>{t.id===s&&(t.added&&this.builder.add(...t.added.filter(t=>!this._isTapped(e,t))),t.removed&&this.builder.delete(...t.removed.filter(t=>!this._isTapped(e,t))))}))}_handleTappedUnitsChange(e,t,i){var n,s;if(t){if(t.cleared){this.builder.clear();const t=(0,r.selectFromState)(e,this.sources.currentPhase).faction;if(t){const i=(0,r.selectFromState)(e,this.sources.unitsByFaction,t);i&&this.builder.add(...i.toArray())}}null===(n=t.addedEntries)||void 0===n||n.forEach(e=>this.builder.delete(e)),null===(s=t.deletedEntries)||void 0===s||s.forEach(e=>{this.builder.add(e)})}}_handleCurrentPhaseChange(e,t,i){if(t.type!==a.PhaseTypes.FactionTurn)this.builder.clear();else{this.builder.clear();const i=(0,r.selectFromState)(e,this.sources.unitsByFaction,t.faction);i&&this.builder.add(...i.toArray())}return this.builder.createMutation("currentPhaseChanged")}}t.MovableUnitsProjection=c},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexDefenseSourcesProjection=t.NO_DEFENSE=void 0;const s=i(21),a=n(i(10)),o=i(4),r=i(13),c=i(5),l=i(25),d=i(17),h=i(9),u=i(26),g=i(2),p=i(15);t.NO_DEFENSE=Object.freeze({unitDefense:0,buildingDefense:0,unitProtection:0,buildingProtection:0,totalDefense:0,totalProtection:0});class m extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.eager=!1,this.update=new f(this).update}bootstrap(e){return a.default.Map().withMutations(t=>{(0,o.getHexes)((0,c.selectFromState)(e,this.sources.regionByHex).keySeq().toArray()).forEach(i=>{const n=this._calculate(e,i);n.totalDefense>0&&t.set(i.id,n)})})}_calculate(e,t){const i=d.Pawns.model(e).byHex(t).filter(t=>!l.CurrentPhase.isMovable(e,t.id)),n=i.find(e=>e.hasTrait(r.PawnTraits.Unit)),s=i.find(e=>e.hasTrait(r.PawnTraits.Building)),a=i.find(e=>e.hasTrait(r.PawnTraits.OccupiesTile)),o=(null==n?void 0:n.defense)||0,c=(null==n?void 0:n.protection)||0,u=(null==s?void 0:s.defense)||0,g=(null==s?void 0:s.protection)||0;return{unitDefense:o,unitProtection:c,buildingDefense:u,buildingProtection:g,totalDefense:Math.max(o,u,(null==a?void 0:a.defense)||0),totalProtection:(0,h.max)(c,g)}}entryToString(e){return`${e.totalDefense}${e.buildingDefense>0?p.GLYPH.whiteFlag:""}`}}t.HexDefenseSourcesProjection=m;class f extends u.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}initialize(){this.pawns=d.Pawns.model(this.newState),this.dirtyHexes=new Set}registerHandlers(e){e(this.dataSet.sources.pawnsByHex,e=>this._handlePawnsByHexChange(e)),e(this.dataSet.sources.movableUnits,e=>this._handleMovableUnitsChange(e))}createMutation(){return this.dirtyHexes.forEach(e=>{const t=this.dataSet._calculate(this.newState,e);t.unitDefense||t.buildingDefense?this.builder.set(e.id,t):this.builder.delete(e.id)}),super.createMutation()}invalidate(e){g.assert.defined(e,"attempted to add undefined into dirtyHexes"),this.dirtyHexes.add(e)}_handlePawnsByHexChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>{e.removed?this.invalidate((0,o.getHex)(e.id)):e.added&&this._addDefenders(e.added)})}_handleMovableUnitsChange(e){var t;if(e.cleared){const e=l.CurrentPhase.getMovableUnits(this.oldState);this._addDefenders(e)}null===(t=e.addedEntries)||void 0===t||t.forEach(e=>{var t;const i=null===(t=this.pawns.byId(e))||void 0===t?void 0:t.hex;this.invalidate(i)}),e.deletedEntries&&this._addDefenders(e.deletedEntries)}_addDefenders(e){e.forEach(e=>{var t;const i=this.pawns.byId(e);if(!i||l.CurrentPhase.isMovable(this.newState,e))return;const n=null===(t=this.pawns.byId(e))||void 0===t?void 0:t.hex;if(!n)return;const s=this.builder.getCurrent(n.id);let a=(null==s?void 0:s.unitDefense)||0,o=(null==s?void 0:s.unitProtection)||0,c=(null==s?void 0:s.buildingDefense)||0,d=(null==s?void 0:s.buildingProtection)||0;const u=i.hasTrait(r.PawnTraits.OccupiesTile)?i.defense:0;i.hasTrait(r.PawnTraits.Unit)&&(a=i.defense,o=i.protection),i.hasTrait(r.PawnTraits.Building)&&(c=i.defense,d=i.protection),this.builder.set(n.id,{unitDefense:a,unitProtection:o,buildingDefense:c,buildingProtection:d,totalDefense:Math.max(a,c,u),totalProtection:(0,h.max)(o,d)})})}}},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.RegionBudgetUpdater=t.BudgetByRegionProjection=void 0;const o=i(21),r=a(i(10)),c=i(19),l=i(7),d=i(30),h=i(26);class u extends o.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new g(this).update}bootstrap(e){return r.Map().withMutations(t=>{l.Regions.model(e).all().forEach(e=>{t.set(e.id,this.getRegionBudget(e))})})}getRegionBudget(e){const t=e.state,i=e.isAlive()?e.hexes.map(e=>d.Economy.getIncomeFromHex(t,e.id)).reduce((e,t)=>e+t,0):0,n=e.getPawns().map(e=>e.upkeep).reduce((e,t)=>e+t,0);return{incomeFromHexes:i,upkeep:n,balance:i-n}}entryToString(e){return""+(0,c.withSign)(e.balance)}entryToDebugString(e){return(0,c.prettyPrintObject)(e)}}t.BudgetByRegionProjection=u;class g extends h.BaseUpdater{constructor(){super(...arguments),this.builder=new o.MapMutationBuilder(this.dataSet)}initialize(){this.invalidated=new Set}registerHandlers(e){e(this.dataSet.sources.regionHexes,this._invalidateAffectedRegions),e(this.dataSet.sources.pawnsByRegion,this._invalidateAffectedRegions),e(this.dataSet.sources.regions,this._handleRegionsUpdated)}createMutation(){const e=l.Regions.model(this.newState);return this.invalidated.forEach(t=>{const i=e.byId(t);i?this.builder.set(t,this.dataSet.getRegionBudget(i)):this.builder.delete(t)}),super.createMutation()}_invalidateAffectedRegions(e){var t;null===(t=e.updated)||void 0===t||t.forEach(({id:e})=>this.invalidated.add(e))}_handleRegionsUpdated(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{t?l.Regions.getRegionData(this.oldState,e)||this.invalidated.add(e):this.builder.delete(e)})}}t.RegionBudgetUpdater=g},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.TreasuryByRegionProjection=void 0;const o=i(21),r=a(i(10)),c=i(7),l=i(9),d=i(5),h=i(29),u=i(14);class g extends o.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.builder=new o.MapMutationBuilder(this)}bootstrap(e){return r.Map().withMutations(t=>{(0,d.selectFromState)(e,this.sources.townsByRegion).forEach((i,n)=>{const s=i.toArray().map(t=>(0,d.selectFromState)(e,this.sources.coinsByHex,t)||0).reduce(l.sum,0);s>0&&t.set(n,s)})})}update(e,t,i){return this.builder.init(e),this._handleCoinsByHexChange(e,t.of(this.sources.coinsByHex),i),this._handleTownsByRegionChange(e,t.of(this.sources.townsByRegion),i),this.builder.createMutation("parent changed")}_handleCoinsByHexChange(e,t,i){var n;null===(n=null==t?void 0:t.updated)||void 0===n||n.forEach(([t,n])=>{const s=c.Regions.getByHex(e,t);if(!s||u.Factions.getByRegion(e,s)===h.SpecialFaction.neutral)return;void 0===n&&(n=0);const a=(0,d.selectFromState)(i,this.sources.coinsByHex,t)||0,o=(this.builder.getCurrent(s)||0)+n-a;o?this.builder.set(s,o):this.builder.delete(s)})}_handleTownsByRegionChange(e,t,i){var n;null===(n=null==t?void 0:t.updated)||void 0===n||n.forEach(e=>{const t=e.id;let n=this.builder.getCurrent(t)||0;e.added&&(n+=e.added.map(e=>(0,d.selectFromState)(i,this.sources.coinsByHex,e)||0).reduce(l.sum,0)),e.removed&&(n-=e.removed.map(e=>(0,d.selectFromState)(i,this.sources.coinsByHex,e)||0).reduce(l.sum,0)),n>0?this.builder.set(t,n):this.builder.delete(t)})}}t.TreasuryByRegionProjection=g},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinsByHexProjection=void 0;const n=i(21),s=i(3),a=i(5),o=i(17);class r extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.builder=new n.MapMutationBuilder(this)}bootstrap(e){return(0,a.selectFromState)(e,this.sources.pawnsByHex).map(t=>t.find(t=>o.Pawns.getPawnType(e,t)===s.PawnType.Coins)).filter(t=>t&&0!==o.Pawns.getPawnCount(e,t)).map(t=>o.Pawns.getPawnCount(e,t)||0)}update(e,t,i){return this.builder.init(e),this._handlePawnByHexChange(e,t.of(this.sources.pawnsByHex),i),this._handlePawnsCountChange(e,t.of(this.sources.pawnsCount),i),this.builder.createMutation("parent changed")}_handlePawnByHexChange(e,t,i){var n;null===(n=null==t?void 0:t.updated)||void 0===n||n.forEach(t=>{var i,n;const a=t.id;null===(i=t.added)||void 0===i||i.forEach(t=>{o.Pawns.getPawnType(e,t)===s.PawnType.Coins&&this.builder.set(a,o.Pawns.getPawnCount(e,t)||1)}),null===(n=t.removed)||void 0===n||n.forEach(t=>{o.Pawns.getPawnType(e,t)===s.PawnType.Coins&&this.builder.delete(a)})})}_handlePawnsCountChange(e,t,i){var n;null===(n=null==t?void 0:t.updated)||void 0===n||n.forEach(([t,i])=>{if(o.Pawns.getPawnType(e,t)===s.PawnType.Coins){const n=o.Pawns.getPawnHex(e,t);if(!n)return;i?this.builder.set(n,i):this.builder.delete(n)}})}}t.CoinsByHexProjection=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionHostileBorderHexesProjection=void 0;const n=i(65),s=i(7),a=i(5),o=i(4),r=i(12),c=i(17),l=i(13);class d extends n.MultiMapDataSet{constructor(e,t){super(e),this.regionsBorderHexes=t,this.parents=[this.regionsBorderHexes]}bootstrap(e){return(0,a.selectFromState)(e,this.regionsBorderHexes).map((t,i)=>t.filter(t=>h(e,t,i))).filter(e=>e.size>0)}update(e,t,i){var a;const c=new n.MultiMapMutationBuilder(this,e);return null===(a=t.require(this.regionsBorderHexes).updated)||void 0===a||a.forEach(t=>{const i=t.id;if(t.added){const n=(0,o.getHexes)(t.added);(0,o.getHexes)(c.getCurrent(i).toArray()||[]);c.add(i,...t.added.filter(t=>h(e,t,i))),n.forEach(t=>{t.neighbours(t=>void 0!==s.Regions.getByHex(e,t.id)).forEach(t=>{const n=s.Regions.getByHex(e,t.id);void 0!==n&&n!==i?c.add(n,t.id):h(e,t.id,i)||c.remove(i,t.id)})})}if(t.removed){c.remove(i,...t.removed);const n=(0,o.getHexes)(t.removed),a=r.HexGroup.fromIds(s.Regions.getRegionBorderHexes(e,i).toArray());n.forEach(t=>{a.neighboursOf(t).forEach(t=>{s.Regions.getByHex(e,t.id)===i&&h(e,t.id,i)&&c.add(i,t.id)})})}}),c.createMutation("regionBorderChanged")}entryToString(e){return`[${e.size}]`}}function h(e,t,i){return!!(0,o.getHex)(t).findNeighbour(t=>{const n=s.Regions.getByHex(e,t.id);return void 0!==n&&n!==i&&!c.Pawns.model(e).findOne({hexes:t,traits:[l.PawnTraits.Impenetrable]})})}t.RegionHostileBorderHexesProjection=d},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexDepthUpdater=t.HexDepthProjection=void 0;const s=i(21),a=n(i(10)),o=n(i(57)),r=i(7),c=i(18),l=i(5),d=i(26),h=i(4);class u extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new g(this).update.bind(this)}bootstrap(e){return a.default.Map().withMutations(t=>{(0,l.selectFromState)(e,this.sources.regionHexes).forEach((i,n)=>{const s=r.Regions.model(e).byId(n);s.getHostileBorderHexes().length?s.hexes.bfsFrom(s.getHostileBorderHexes(),(e,i,n)=>(t.set(e.id,n+1),!0)):s.hexes.forEach(e=>t.set(e.id,1/0))})})}}t.HexDepthProjection=u;class g extends d.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.hostileBorderHexes,this.handleHostileBorderHexesChanged.bind(this)),e(this.dataSet.sources.regionHexes,this.handleRegionHexesChanged.bind(this))}handleHostileBorderHexesChanged(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>{const t=e.id,i=r.Regions.model(this.newState).byId(e.id);if(e.removed){const t=(0,h.getHexes)(e.removed),n=t.filter(e=>r.Regions.getByHex(this.newState,e.id)===i.id);this.updateDueToNewlyInternalHexes(i,n);const s=t.without(n);this.updateAfterHexesLost(i,s)}e.added&&c.AI.getHostileBorderHexesByRegion(this.oldState,t).isEmpty()&&i.hexes.bfsFrom(i.getBorderHexes(),(e,t,i)=>(this.builder.set(e.id,i+1),!0))})}handleRegionHexesChanged(e){var t;return null===(t=e.updated)||void 0===t||t.forEach(e=>{const t=r.Regions.model(this.newState).byId(e.id);e.added,e.removed&&this.updateAfterHexesLost(t,(0,h.getHexes)(e.removed))}),this.builder.createMutation("regionHexes changed")}updateDueToNewlyInternalHexes(e,t){let i=new Set(t.members),n=new o.default((e,t)=>e.candidateDepth-t.candidateDepth),s=[...t.members];const a=c.AI.getHostileBorderHexesByRegion(this.newState,e.id);for(;s.length;){let t=s.shift();for(let o of e.hexes.neighboursOf(t).members)if(!i.has(o))if(a.has(o.id))n.push({hex:t,candidateDepth:2});else{const a=this.dataSet.getEntryById(this.newState,o.id);this.hexCanJustifyDepth(this.newState,e,o,a,i)?n.push({hex:t,candidateDepth:a+1}):(s.push(o),i.add(o))}}for(i.forEach(e=>this.builder.delete(e.id));!n.empty()&&i.size;){let t=n.pop();if(i.has(t.hex)){i.delete(t.hex),this.builder.set(t.hex.id,t.candidateDepth);for(let s of e.hexes.neighboursOf(t.hex).members)i.has(s)&&n.push({hex:s,candidateDepth:t.candidateDepth+1})}}i.forEach(e=>this.builder.set(e.id,1/0))}updateAfterHexesLost(e,t){e.hexes.bfsFrom(t,(e,t,i)=>!t||(this.dataSet.getEntryById(this.newState,e.id)||1/0)>i&&(this.builder.set(e.id,i),!0))}isHostileRegion(e,t,i){const n=r.Regions.getByHex(e,t);return void 0!==n&&n!==i}hexCanJustifyDepth(e,t,i,n,s){return 1===n?!!i.findNeighbour(i=>!s.has(i)&&this.isHostileRegion(e,i.id,t.id)):!!t.hexes.neighboursOf(i).find(t=>!s.has(t)&&this.dataSet.getEntryById(e,t.id)===n-1)}}t.HexDepthUpdater=g},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexPawnsCostUpdater=t.PawnsValueByHex=void 0;const s=i(21),a=n(i(10)),o=i(17),r=i(26),c=i(25);class l extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new d(this).update}bootstrap(e){return a.default.Map().withMutations(t=>{o.Pawns.model(e).all().filter(e=>!e.isMovable()).forEach(e=>{t.update(e.hex.id,0,t=>t+e.cost)})})}}t.PawnsValueByHex=l;class d extends r.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.pawnsHex,this.handlePawnsHexChanged),e(this.dataSet.sources.movableUnits,this.handleMovableUnitsChanged)}updateCost(e,t){if(0===t)return;const i=(this.builder.getCurrent(e)||0)+t;0===i?this.builder.delete(e):this.builder.set(e,i)}handlePawnsHexChanged(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{void 0!==o.Pawns.getPawnHex(this.oldState,e)&&this.subtractPawnCost(this.oldState,e),void 0!==t&&this.addPawnCost(this.newState,e)})}handleMovableUnitsChanged(e){var t,i;if(e.cleared){c.CurrentPhase.getMovableUnits(this.oldState).forEach(e=>this.addPawnCost(this.newState,e))}null===(t=e.addedEntries)||void 0===t||t.forEach(e=>{this.subtractPawnCost(this.oldState,e)}),null===(i=e.deletedEntries)||void 0===i||i.forEach(e=>{this.addPawnCost(this.newState,e)})}addPawnCost(e,t){const i=o.Pawns.getPawnHex(e,t),n=o.Pawns.model(e).byId(t);if(!n||n.isMovable())return;const s=n.cost||0;this.updateCost(i,s)}subtractPawnCost(e,t){const i=o.Pawns.getPawnHex(e,t),n=o.Pawns.model(e).byId(t);if(!n||n.isMovable())return;const s=n.cost||0;this.updateCost(i,-s)}}t.HexPawnsCostUpdater=d},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.PowerByFactionUpdater=t.PowerByFactionProjection=void 0;const o=i(21),r=a(i(10)),c=i(26),l=i(14),d=i(9),h=i(18);i(1).logger.for("PowerByFactionProjection");class u extends o.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new g(this).update}bootstrap(e){return r.Map().withMutations(t=>{l.Factions.model(e).all().forEach(i=>{const n=i.getRegions().map(t=>h.AI.getRegionPower(e,t.id).total).reduce(d.sum,0);t.set(i.id,n)})})}}t.PowerByFactionProjection=u;class g extends c.BaseUpdater{constructor(){super(...arguments),this.builder=new o.MapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.factionRegions,this._handleFactionRegionsChanged),e(this.dataSet.sources.powerByRegion,this._handleRegionPowerChanged)}_handleFactionRegionsChanged(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>{var t,i;const n=e.id,s=((null===(t=e.added)||void 0===t?void 0:t.map(e=>h.AI.getRegionPower(this.newState,e).total).reduce(d.sum,0))||0)-((null===(i=e.removed)||void 0===i?void 0:i.map(e=>h.AI.getRegionPower(this.oldState,e).total).reduce(d.sum,0))||0);s&&this.builder.set(n,(this.builder.getCurrent(n)||0)+s)})}_handleRegionPowerChanged(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{const i=l.Factions.getByRegion(this.oldState,e),n=h.AI.getRegionPower(this.oldState,e).total,s=(null==t?void 0:t.total)||0,a=s-n;if(!i||!a||s===n)return;const o=this.builder.getCurrent(i)||0;this.builder.set(i,o+a)})}}t.PowerByFactionUpdater=g},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AttritionByRegionDataSet=void 0;const n=i(21),s=i(9);class a extends n.MapDataSet{entryToString(e){return Object.values(e).reduce(s.sum,0).toString()}entryToDebugString(e){return Object.entries(e).filter(([e,t])=>t>0).map(([e,t])=>`${t} inflicted by faction ${e}`).join("\n")}}t.AttritionByRegionDataSet=a},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createFactionInfluenceDebugLayer=t.FactionInfluenceByRegionUpdater=t.RegionInfluenceByRegionProjection=void 0;const s=i(21),a=n(i(10)),o=i(7),r=i(5),c=i(26),l=i(1),d=i(18),h=(i(4),i(15)),u=i(0),g=i(27),p=i(8),m=i(159),f=i(262);l.logger.for("FactionInfluenceByRegionProjection");class y extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new w(this),this.update=this.updater.update}bootstrap(e){return this.updater.initFromState(e),a.default.Map().withMutations(t=>{for(const i of o.Regions.getAll(e)){v(e,i).size>0&&t.set(i,v(e,i))}})}entryToString(e){return e.size?`[${e.size}]`:""}entryToDebugString(e){return e.entrySeq().sort(([e],[t])=>e-t).map(([e,t])=>`${h.GLYPH.whiteFlag}${e}: ${t.total} (proximity ${t.proximity})`).join("\n")}}function v(e,t){const i=o.Regions.getRegionHexes(e,t);return a.default.Map().withMutations(n=>{for(const s of i)for(const[i,a]of d.AI.getHexInfluence(e,s))i!==t&&n.update(i,{proximity:1/0,total:0},e=>({proximity:Math.min(e.proximity,a.resistance),total:e.total+Math.floor(10/a.resistance)}));n.map(e=>Object.assign(Object.assign({},e),{total:Math.floor(e.total)})).filter(e=>e.total>0)})}t.RegionInfluenceByRegionProjection=y;class w extends c.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet),this.dirtyRegions=new Set}registerHandlers(e){e(this.dataSet.sources.regionHexes,this.handleRegionBorderChange),e(this.dataSet.sources.regionInfluenceByHex,this.handleHexRegionInfluenceChange)}initialize(){super.initialize(),this.dirtyRegions.clear()}createMutation(){return this.dirtyRegions.forEach(e=>{const t=v(this.newState,e);t.size>0?this.builder.set(e,t):this.builder.delete(e)}),super.createMutation()}handleRegionBorderChange(e){for(let t of e.updated||[]){const e=t.id;this.dirtyRegions.add(e)}}handleHexRegionInfluenceChange(e){for(let[t,i]of e.updated||[]){const e=o.Regions.getByHex(this.newState,t);e&&this.dirtyRegions.add(e)}}}t.FactionInfluenceByRegionUpdater=w,t.createFactionInfluenceDebugLayer=function(e){const t=u.inject.gameStateModel.stateEngine;let i=(0,g.signal)();return t.watchDataSet(p.GameState.ai.regionInfluenceByHex,()=>{i.fire()}),{onChange:i,getMap:()=>new m.ProxyHexGroupValuation(new f.HexGroupValuationFromStateEngine(t,p.GameState.ai.regionInfluenceByHex),(t,i)=>{if(!t)return;const n=t.get(e);return n?0===n.resistance?h.GLYPH.whiteFlag:n.resistance:void 0}),getArrows(){let i=[];return t.get(p.GameState.ai.regionInfluenceByHex).forEach((t,n)=>{const s=t.get(e);(null==s?void 0:s.children)&&s.children.forEach(e=>{i.push([n,e.id])})}),i},getDetail(i){const n=(0,r.selectFromState)(t.currentState,p.GameState.ai.regionInfluenceByHex,i.id);if(!n)return"";const s=n.get(e);return s?`${s.resistance.toString()} -> ${s.children.map(e=>e.id).join(",")}`:""}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexGroupValuationFromStateEngine=void 0;t.HexGroupValuationFromStateEngine=class{constructor(e,t){this.state=e,this.dataSet=t}get(e){return this.state.get(this.dataSet,e)}getHexIds(){return this.state.getEntryIds(this.dataSet)}}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexStaticDefenseProjection=void 0;const s=i(21),a=n(i(10)),o=i(4),r=i(5),c=i(9),l=i(7),d=i(24),h=i(160);class u extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new h.HexDefenseUpdater(this).update}bootstrap(e){return a.default.Map().withMutations(t=>{(0,o.getHexes)((0,r.selectFromState)(e,this.sources.regionByHex).keySeq().toArray()).map(i=>{const n=this._calculate(e,i);n>0&&t.set(i.id,n)})})}_calculate(e,t){const i=d.Warfare.getHexLocalStaticDefense(e,t.id);return l.Regions.getSameRegionNeighbours(e,t).map(t=>d.Warfare.getHexProjectedStaticDefense(e,t.id)).reduce(c.max,i)}}t.HexStaticDefenseProjection=u},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NearestCampUpdater=t.NearestCampByHexProjection=t.UNREACHABLE=void 0;const r=i(21),c=a(i(10)),l=i(1),d=i(26),h=i(7),u=i(4),g=i(87),p=o(i(57)),m=i(15),f=i(19),y=i(12),v=i(2);l.logger.for("NearestCampByHexProjection");t.UNREACHABLE=Object.freeze({rootId:0,distance:Number.POSITIVE_INFINITY});class w extends r.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new b(this).update}bootstrap(e){const t=new b(this);return t.initFromState(e),h.Regions.getAll(e).filter(t=>{var i,n;return null===(n=null===(i=h.Regions.model(e).byId(t))||void 0===i?void 0:i.faction)||void 0===n?void 0:n.isNeutral()}).forEach(e=>{t.addRootsFromRegion(e)}),t.getMap()}entryToString(e){return 0===e.distance?m.GLYPH.whiteFlag:e.rootId}entryToDebugString(e){return(0,f.prettyPrintObject)(e)}}t.NearestCampByHexProjection=w;class b extends d.BaseUpdater{constructor(){super(...arguments),this.builder=new r.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.sources=new Set,this}registerHandlers(e){e(this.dataSet.sources.campsByRegion,this.handleCampsByRegionChange)}handleCampsByRegionChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>{var t,i;null===(t=e.added)||void 0===t||t.forEach(e=>{this.addNewRoot((0,u.getHex)(e))}),null===(i=e.removed)||void 0===i||i.forEach(e=>{this.invalidateFrom((0,u.getHex)(e))})})}addRootsFromRegion(e){var t;const i=h.Regions.model(this.newState).byId(e);if(!i||!(null===(t=i.faction)||void 0===t?void 0:t.isNeutral()))return;g.Bandits.getCampsByRegion(this.newState,e).forEach(e=>this.addNewRoot((0,u.getHex)(e)))}updateInvalidated(){this.addSourcesFromInvalidatedHexes();const e=new p.default((e,t)=>e.distance-t.distance);for(this.sources.forEach(t=>{const i=this.builder.getCurrent(t.id);v.assert.defined(i),e.push({hex:t,rootHex:(0,u.getHex)(i.rootId),distance:null==i?void 0:i.distance})});!e.empty();){const t=e.pop(),i=t.hex;this.getCurrentDistanceFrom(i)<=t.distance||(this.invalidatedHexes.delete(i),this.builder.set(i.id,{distance:t.distance,rootId:t.rootHex.id}),i.neighbours(e=>void 0!==h.Regions.getByHex(this.newState,e.id)&&this.getCurrentDistanceFrom(e)>=t.distance+1).forEach(i=>{e.push({hex:i,rootHex:t.rootHex,distance:t.distance+1})}))}this.invalidatedHexes.forEach(e=>this.builder.delete(e.id))}addSourcesFromInvalidatedHexes(){y.HexGroup.from(Array.from(this.invalidatedHexes)).neighbours().filter(e=>this.getCurrentDistanceFrom(e)<Number.POSITIVE_INFINITY).forEach(e=>{this.sources.add(e),this.invalidatedHexes.add(e)})}getMap(){return this.updateInvalidated(),c.Map(this.builder.getEntries()).mapKeys(e=>Number(e))}createMutation(){return this.updateInvalidated(),super.createMutation()}invalidateFrom(e){if(this.invalidatedHexes.has(e))return;this.invalidatedHexes.add(e);const i=this.builder.getCurrent(e.id);i&&e.neighbours(e=>{var n;const s=null!==(n=this.builder.getCurrent(e.id))&&void 0!==n?n:t.UNREACHABLE;return i.rootId==s.rootId&&s.distance===i.distance+1}).forEach(e=>this.invalidateFrom(e))}getCurrentDistanceFrom(e){var t,i;return this.invalidatedHexes.has(e)?Number.POSITIVE_INFINITY:null!==(i=null===(t=this.builder.getCurrent(e.id))||void 0===t?void 0:t.distance)&&void 0!==i?i:Number.POSITIVE_INFINITY}addNewRoot(e){this.sources.add(e),this.builder.set(e.id,{rootId:e.id,distance:0}),this.invalidatedHexes.add(e)}}t.NearestCampUpdater=b},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,s)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NearestTownUpdater=t.NearestTownProjection=t.UNREACHABLE=void 0;const r=i(21),c=a(i(10)),l=i(1),d=i(26),h=i(7),u=i(4),g=o(i(57)),p=i(15),m=i(19),f=i(12),y=i(2),v=i(30);l.logger.for("NearestTownProjection");t.UNREACHABLE=Object.freeze({rootId:0,distance:Number.POSITIVE_INFINITY});class w extends r.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new b(this).update}bootstrap(e){const t=new b(this);return t.initFromState(e),h.Regions.getAll(e).forEach(e=>{t.addRootsFromRegion(e)}),t.getMap()}entryToString(e){return 0===e.distance?p.GLYPH.whiteFlag:e.rootId}entryToDebugString(e){return(0,m.prettyPrintObject)(e)}}t.NearestTownProjection=w;class b extends d.BaseUpdater{constructor(){super(...arguments),this.builder=new r.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.sources=new Set,this}registerHandlers(e){e(this.dataSet.sources.townsByRegion,this.handleTownsByRegionChange),e(this.dataSet.sources.regionByHex,this.handleRegionByHexChange)}handleTownsByRegionChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>{var t,i;null===(t=e.added)||void 0===t||t.forEach(e=>{this.addNewRoot((0,u.getHex)(e))}),null===(i=e.removed)||void 0===i||i.forEach(e=>{this.invalidateFrom((0,u.getHex)(e))})})}handleRegionByHexChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{this.invalidateFrom((0,u.getHex)(e))})}addRootsFromRegion(e){if(!h.Regions.model(this.newState).byId(e))return;v.Economy.getTownHexesByRegion(this.newState,e).forEach(e=>this.addNewRoot((0,u.getHex)(e)))}updateInvalidated(){this.addSourcesFromInvalidatedHexes();const e=new g.default((e,t)=>e.distance-t.distance);for(this.sources.forEach(t=>{const i=this.builder.getCurrent(t.id);y.assert.defined(i),e.push({hex:t,rootHex:(0,u.getHex)(i.rootId),distance:null==i?void 0:i.distance})});!e.empty();){const t=e.pop(),i=t.hex;this.getCurrentDistanceFrom(i)<=t.distance||(this.invalidatedHexes.delete(i),this.builder.set(i.id,{distance:t.distance,rootId:t.rootHex.id}),i.neighbours(e=>h.Regions.getByHex(this.newState,e.id)===h.Regions.getByHex(this.newState,i.id)&&this.getCurrentDistanceFrom(e)>=t.distance+1).forEach(i=>{e.push({hex:i,rootHex:t.rootHex,distance:t.distance+1})}))}this.invalidatedHexes.forEach(e=>this.builder.delete(e.id))}addSourcesFromInvalidatedHexes(){f.HexGroup.from(Array.from(this.invalidatedHexes)).neighbours().filter(e=>this.getCurrentDistanceFrom(e)<Number.POSITIVE_INFINITY).forEach(e=>{this.sources.add(e),this.invalidatedHexes.add(e)})}getMap(){return this.updateInvalidated(),c.Map(this.builder.getEntries()).mapKeys(e=>Number(e))}createMutation(){return this.updateInvalidated(),super.createMutation()}invalidateFrom(e){if(this.invalidatedHexes.has(e))return;this.invalidatedHexes.add(e);const i=this.builder.getCurrent(e.id);i&&e.neighbours(e=>{var n;const s=null!==(n=this.builder.getCurrent(e.id))&&void 0!==n?n:t.UNREACHABLE;return i.rootId==s.rootId&&s.distance===i.distance+1}).forEach(e=>this.invalidateFrom(e))}getCurrentDistanceFrom(e){var t,i;return this.invalidatedHexes.has(e)?Number.POSITIVE_INFINITY:null!==(i=null===(t=this.builder.getCurrent(e.id))||void 0===t?void 0:t.distance)&&void 0!==i?i:Number.POSITIVE_INFINITY}addNewRoot(e){this.sources.add(e),this.builder.set(e.id,{rootId:e.id,distance:0}),this.invalidatedHexes.add(e)}}t.NearestTownUpdater=b},,,,function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Mutator=t.StateEngine=void 0;const s=n(i(10)),a=i(11),o=i(1),r=i(270),c=i(111),l=i(23),d=i(2),h=i(5);o.logger.for("StateEngine");t.StateEngine=class{constructor(){this.roots={},this.projections={},this.children=new Map,this.watchers={},this.globalListeners=new Set,this.currentState=(0,h.createImmutableState)(this,[])}_addPrimary(e,t){return(0,d.assert)(!this.roots[t.key],`dataSet ${t.key} already exists in the state engine!`),this.roots[t.key]=t,e.set(t.key,t.defaultValue)}add(...e){let t=[];return e.forEach(e=>{(0,h.isProjectionDataSet)(e)?this._addProjection(e):(t.push(e),this.currentState=this._addPrimary(this.currentState,e))}),this._updateState(e=>(0,h.updateActiveDataSets)(e,e=>e.union(s.default.Set(t)))),this.updateSequence=this.getProjectionsBootstrapSequence(),this}suspend(...e){if(!e.length)return;const t=e.filter(h.isProjectionDataSet);this._mutateState(e=>{(0,h.updateActiveDataSets)(e,e=>e.subtract(t))})}activate(...e){if(!e.length)return;const t=this.getProjectionsBootstrapSequence(e.filter(e=>!this.isDataSetActive(e)));this.currentState=this.currentState.deleteAll(t.map(e=>e.key));const i=this.currentState;t.forEach(e=>{const t=e.bootstrap(this.currentState);this.currentState=this.currentState.set(e.key,t),this.currentState=(0,h.updateActiveDataSets)(this.currentState,t=>t.add(e))}),this._notifyWatchersAfterChanges(this.currentState,[],i,t)}activateAllProjections(){this.activate(...Object.values(this.projections))}suspendAllProjections(){this.suspend(...Object.values(this.projections))}activateOnly(...e){var t;const i=new Set,n=[...e].filter(h.isProjectionDataSet);for(;n.length;){const e=n.pop();i.add(e),(0,h.isProjectionDataSet)(e)&&(null===(t=e.parents)||void 0===t||t.filter(h.isProjectionDataSet).forEach(e=>{e&&n.push(e)}))}const s=this.getActiveProjections().subtract(i);this.suspend(...s.toArray()),this.activate(...Array.from(i))}getActiveDataSets(){return(0,h.getActiveDataSets)(this.currentState)}getActiveProjections(){return this.getActiveDataSets().filter(e=>(0,h.isProjectionDataSet)(e))}isDataSetActive(e){return this.getActiveDataSets().has(e)}_updateState(e){this.currentState=e(this.currentState)}_mutateState(e){this.currentState=this.currentState.withMutations(e)}_addProjection(e){this.projections[e.key]=e,e.parents.forEach(t=>{const i=this.children.get(t);i?i.push(e):this.children.set(t,[e])})}apply(...e){e.forEach(e=>{const t=e.dataSet,i=this.roots[t.key];if(i!==t)throw void 0===i?this.projections[t.key]?new Error(`dataSet "${t.key}" is a projection, it cannot be updated manually!`):new Error("no such dataSet: "+t.key):new Error(`dataSet mismatch for key "${t.key}" - registered instance in state engine is different than the instance passed into update()`)}),this._applyMutationsAndNotifyWatchers(...e)}_applyMutationsAndNotifyWatchers(...e){const t=c.timing.start("StateEngine update"),i=new u(this,e);return this.currentState=i.apply(),this._notifyWatchersAfterChanges(this.currentState,e,i.startingState,i.getChangedDataSets()),t.complete("updated "+Array.from(i.getChangedDataSets()).map(e=>`"${e.key}"`).join(", ")),this.currentState}_notifyWatchersAfterChanges(e,t,i,n){if(n[Symbol.iterator]().next().value){this.globalListeners.forEach(n=>n(e,t,i));for(let s of n){const n=this.watchers[s.key];n&&n.forEach(n=>{n(e,t,i)})}}}get(e,t){return this.assertActive(e),(0,h.selectFromState)(this.currentState,e,t)}setState(e){const t=this.currentState;this.currentState=e,(0,h.setParentEngine)(e,this);const i=this.getAllDataSets().filter(i=>e.get(i.key)!==t.get(i.key));this._notifyWatchersAfterChanges(e,[],t,i)}getEntryIds(e){return e.getEntryIds(this.currentState)}serialize(){return(0,a.mapDictionary)(this.roots,(e,t)=>e.serialize(this.currentState.get(t)))}clear(){this.currentState=(0,h.createImmutableState)(this,this.getActiveDataSets())}watchAll(e){this.globalListeners.add(e)}watchDataSet(e,t){this.assertHas(e),(0,a.pushIntoArrayByKey)(this.watchers,e.key,t)}stopWatching(e,t){t?(0,a.removeFromArrayInPlace)(this.watchers[t.key]||[],e):this.globalListeners.delete(e)}assertActive(e,t){if(this.isDataSetActive(e))return;this.assertHas(e,t);throw new Error(`DataSet ${e} is suspended`+(t?` (${t})`:""))}assertHas(e,t){const i=this.getDataSetByKey(e.key);if(i!==e){const n=e=>new Error(e+(t?` (${t})`:""));throw n(i?`DataSet with key "${e.key}" already exists, but is not the expected instance`:`DataSet with key "${e.key}" not found in the state engine`)}}getAllDataSets(){return s.default.Set([...Object.values(this.roots),...Object.values(this.projections)])}deserialize(e){const t=c.timing.start("ImmutableState deserialization");this.clear();for(let[t,i]of Object.entries(this.roots))try{this.currentState=this.currentState.set(t,i.deserialize(e[t]))}catch(i){throw i.message=`Failed to deserialize ${t} from ${JSON.stringify(e)} \n\n${i.message}`,i}this.getProjectionsBootstrapSequence().forEach(e=>{this.isDataSetActive(e)&&(this.currentState=this.currentState.set(e.key,e.bootstrap(this.currentState)))}),this._notifyWatchersAfterChanges(this.currentState,[],this.currentState,this.getAllDataSets()),t.complete()}sortProjections(e){const t=new Set(e);return this.getProjectionsBootstrapSequence(e).filter(e=>t.has(e))}getProjectionsBootstrapSequence(e=Object.values(this.projections)){let t=Object.values(this.roots),i=[...t];return e.forEach(e=>{i.includes(e)||this._resolveDeps(e,"<root>",i)}),i.slice(t.length)}getDependencyMap(){let e={};return Object.values(this.roots).forEach(t=>{e[t.key]=this._getDepTree(t)}),e}getParentsMap(e){if((0,h.isProjectionDataSet)(e)){const t={};return e.parents.forEach(e=>t[e.key]=this.getParentsMap(e)),t}return"<root>"}_getDepTree(e){let t={};this.assertHas(e);return(this.children.get(e)||[]).forEach(e=>{t[e.key]=this._getDepTree(e)}),t}_resolveDeps(e,t,i,n=new Set){n.add(e),this.assertHas(e,"required by "+t);for(let s of e.parents)if(!i.includes(s)){if(!(0,h.isProjectionDataSet)(s))throw new Error(`missing primary dataSet ${s} (required by ${t})`);if(n.has(s))throw new Error(`circular reference detected: ${e} -> ${s}`);this._resolveDeps(s,e,i,n)}i.push(e),n.delete(e)}getDataSetByKey(e){return this.roots[e]||this.projections[e]}childrenOf(e){return this.children.get(e)||[]}};class u{constructor(e,t){this.stateEngine=e,this.mutations=t,this.dirty=new Set,this.updated=new Set,this.changeSet=new r.ChangeSet,this.startingState=this.stateEngine.currentState,this.currentState=this.startingState}apply(){this.mutations.forEach(e=>{this.applyMutation(e)});for(let e of this.stateEngine.updateSequence)this.dirty.has(e)&&this.stateEngine.isDataSetActive(e)&&this.resolve(e);return this.currentState}makeChildrenDirty(e){const t=this.stateEngine.childrenOf(e).filter(e=>this.stateEngine.isDataSetActive(e));t.length,t.forEach(e=>this.dirty.add(e))}resolve(e){(0,d.assert)(this.stateEngine.isDataSetActive(e),"Attempt to resolve suspended projection "+e);const t=e.update(this.currentState,this.changeSet,this.startingState);!t||void 0===t.changes||"object"==typeof t.changes&&(0,l.isEmpty)(t.changes)||this.applyMutation(t)}applyMutation(e){this.currentState=e.dataSet.apply(this.currentState,e.changes),this.changeSet.add(e),this.updated.add(e.dataSet),this.makeChildrenDirty(e.dataSet)}getChangedDataSets(){return this.updated}}t.Mutator=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChangeSet=void 0;const n=i(2),s=i(19);t.ChangeSet=class{constructor(e){this.mutations=new Map,this.title="empty",null==e||e.forEach(e=>this.add(e))}add(e){n.assert.undefined(this.mutations.get(e.dataSet),`changeSet already contains mutation for "${e.dataSet.key}" (${(0,s.str)(e)})`),this.title=e.dataSet.key,this.mutations.set(e.dataSet,e)}all(){return Array.from(this.mutations.values())}of(e){var t;return null===(t=this.mutations.get(e))||void 0===t?void 0:t.changes}require(e){const t=this.of(e);return n.assert.defined(t,`DataSet "${e.key}" not found in ${this}`),t}toString(){return`[ChangeSet<${Array.from(this.mutations.values()).map(e=>e.dataSet.key).join(",")}>]`}}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BLACKLISTED_KEYS=t.getCanonicalStateSnapshot=void 0;const s=i(5),a=n(i(23));t.getCanonicalStateSnapshot=function(e){const i=new Set,n=(0,s.getActiveDataSets)(e).map(e=>e.key).asImmutable().filter(e=>!i.has(e)),o=e.filter((e,t)=>n.has(t)).map((e,t)=>e).toJS();return function e(i,n){for(let s in i)n&&!n.has(s)||t.BLACKLISTED_KEYS.has(s)?delete i[s]:(Array.isArray(i[s])&&(i[s]=i[s].sort()),0===i[s]&&delete i[s],"object"==typeof i[s]&&null!==i[s]&&("Hex"==i[s].constructor.name&&(i[s]=i[s].id),a.default.isEqual(i[s],{})&&delete i[s],e(i[s])))}(o,n),o},t.BLACKLISTED_KEYS=new Set(["child","children","parent","parents"])},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeMovePawn=void 0;const n=i(6),s=i(24),a=i(112),o=i(2),r=i(4);t.executeMovePawn=function(e,t){const i=e.pawns.byId(t.pawnId);o.assert.defined(i);const c=i.region,l=i.hex,d=(0,r.getHex)(t.destinationHexId);if(o.assert.defined(c),o.assert.defined(d),l===d)return[];const h=e.warfare.getDropPawnResult(d,i.type,c);switch(h.type){case s.DropPawnResultType.Conquest:return(0,a.captureHex)(d,c,i);case s.DropPawnResultType.Reposition:return i.moveTo(d),[n.GameEvents.PawnMoved(Object.assign(Object.assign({},t),{state:e.state,sourceHexId:l.id}))];case s.DropPawnResultType.EradicatePest:return i.moveTo(d),h.pest.destroy(),e.currentPhase.tapPawn(i),[n.GameEvents.PawnMoved(Object.assign(Object.assign({},t),{state:e.state,sourceHexId:l.id,eradicatedPest:!0}))];case s.DropPawnResultType.Combine:i.destroy();const o=h.combineWith.type,r=!h.combineWith.isMovable(),u=h.combineWith.replaceWith(h.combineInto);return r&&e.currentPhase.tapPawn(u),[n.GameEvents.PawnMoved(Object.assign(Object.assign({},t),{state:e.state,sourceHexId:l.id,mergedWith:o,mergedInto:h.combineInto}))];case s.DropPawnResultType.Invalid:default:throw new Error(`Invalid move (${h.reason})`)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.checkWinConditions=void 0;const n=i(6);t.checkWinConditions=function(e){const t=e.factions.all().filter(e=>e.isAlive());return 1===t.length?[n.GameEvents.GameOver({winningFactionId:t[0].id,state:e.state})]:[]}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeBuyPawn=void 0;const n=i(6),s=i(112),a=i(24),o=i(2),r=i(4);t.executeBuyPawn=function(e,t){const i=(0,r.getHex)(t.destinationHexId),c=e.regions.byId(t.buyerRegionId);o.assert.defined(i),o.assert.defined(c);const l=e.warfare.getDropPawnResult(i,t.pawnType,c);switch(l.type){case a.DropPawnResultType.Conquest:return(0,s.captureHex)(i,c,t.pawnType);case a.DropPawnResultType.Reposition:case a.DropPawnResultType.EradicatePest:const o=e.economy.payForNewPawn(i,t.pawnType),r=e.pawns.create({type:t.pawnType,hex:i});l.type===a.DropPawnResultType.EradicatePest&&(l.pest.destroy(),e.currentPhase.tapPawn(r));const d=Object.assign(Object.assign({},t),{state:e.state,payment:o,eradicatedPest:l.type===a.DropPawnResultType.EradicatePest});return[n.GameEvents.PawnBought(d)];case a.DropPawnResultType.Combine:const h=e.economy.payForNewPawn(i,t.pawnType),u=l.combineWith.type,g=!l.combineWith.isMovable(),p=l.combineWith.replaceWith(l.combineInto);return g&&e.currentPhase.tapPawn(p),[n.GameEvents.PawnBought(Object.assign(Object.assign({},t),{state:e.state,mergedWith:u,mergedInto:l.combineInto,payment:h}))];case a.DropPawnResultType.Invalid:default:throw new Error(`Invalid buy attempt (${l.reason})`)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeEndTurn=void 0;const n=i(164),s=i(6),a=i(3),o=i(2),r=i(0);t.executeEndTurn=function(e){(0,o.assert)(e.currentPhase.type===a.PhaseTypes.FactionTurn,"Cannot end turn in phase "+e.currentPhase.type);const t=[],i=e.currentPhase.faction;return o.assert.defined(i),r.inject.ai.dataLayer.onTurnEnd(e,i),function(e){const t=e.currentPhase.getNextFaction();0===t&&e.currentPhase.incrementTurnNumber();e.currentPhase.set({type:a.PhaseTypes.FactionTurn,faction:t})}(e),t.push(...(0,n.startPhase)(e),s.GameEvents.FactionTurnStarted({state:e.state,factionId:e.currentPhase.faction.id})),t}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.executeBanditsAct=void 0;const n=i(60),s=i(29),a=i(3),o=i(6),r=i(87),c=i(1),l=i(2),d=i(4),h=i(11),u=i(152),g=i(277);c.logger.for("bandits");t.executeBanditsAct=function(e){var t,i;const c=e.pawns.select({type:[a.PawnType.Bandit]}),p=new Set(c),m=[],f=[],y=[],v={baseIncome:new n.CoinTransactionBuilder,buyUnits:new n.CoinTransactionBuilder,pillage:new n.CoinTransactionBuilder};for(let n of c){if(!n.exists)continue;const a=e.regions.byHex(n.hex);l.assert.defined(a);const o=null==a?void 0:a.id;if(!(null==a?void 0:a.isAlive())&&!(null===(t=null==a?void 0:a.faction)||void 0===t?void 0:t.isNeutral())){const t=n.hex;null===(i=e.factions.byId(s.SpecialFaction.neutral))||void 0===i||i.captureHex(n.hex),y.push({hexId:n.hex.id,originalRegionId:o});const a=(0,u.getOrCreateNearestCamp)(e,n.hex,e=>f.push(e));a===t?v.pillage.from(t).spawn(1):void 0!==a&&v.pillage.from(t).spawn(1).send(a),p.delete(n)}}e.restore(v.pillage.apply(e.state));const w=(0,g.moveBandits)(e,p),b=e.factions.byId(s.SpecialFaction.neutral).getRegions().map(t=>Array.from(r.Bandits.getCampsByRegion(e.state,t.id))).flat().map(d.getHex);return b.forEach(t=>{if(e.economy.numberOfCoinsAt(t)>=3){const i=(0,g.pickHexToEnter)(e,t);i&&(e.pawns.create({hex:i,type:a.PawnType.Bandit}),m.push({fromHex:t.id,toHex:i.id}),v.buyUnits.from(t).consume(3))}}),e.restore(v.buyUnits.apply(e.state)),b.forEach(e=>{v.baseIncome.from(e).spawn(1)}),e.restore(v.baseIncome.apply(e.state)),[o.GameEvents.BanditsActed({state:e.state,pillagedHexes:y,coinTransactions:(0,h.mapDictionary)(v,e=>e.getTransactions()),banditsMoved:w,banditsCreated:m,campsCreated:f})]}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pickHexToEnter=t.moveBandits=void 0;const n=i(29),s=i(0),a=i(7),o=i(13);i(1).logger.for("bandits");function r(e,t,i=new Set){if(!a.Regions.getByHex(e.state,t.id))return!1;const n=e.pawns.findOne({hexes:t,traits:[o.PawnTraits.OccupiesTile]});return!n||i.has(n)}t.moveBandits=function(e,t){const i=[];for(;t.size;){a(t[Symbol.iterator]().next().value)}function a(c){if(t.delete(c),!c.exists)return;const l=c.hex.neighbours().filter(i=>r(e,i,t)),d=l.filter(t=>{var i,s;return(null===(s=null===(i=e.regions.byHex(t))||void 0===i?void 0:i.faction)||void 0===s?void 0:s.id)!==n.SpecialFaction.neutral});if(l.length){const n=d.length?s.inject.random.hex(d):s.inject.random.hex(l),r=function(i){const n=e.pawns.findOne({hexes:i,traits:[o.PawnTraits.OccupiesTile]});return n&&t.has(n)?n:void 0}(n);r?(a(r),a(c)):(i.push({fromHex:c.hex.id,toHex:n.id}),c.moveTo(n))}else;}return i},t.pickHexToEnter=function(e,t,i=new Set){const a=t.neighbours().filter(t=>r(e,t,i)),o=a.filter(t=>{var i,s;return(null===(s=null===(i=e.regions.byHex(t))||void 0===i?void 0:i.faction)||void 0===s?void 0:s.id)!==n.SpecialFaction.neutral});return o.length>0?s.inject.random.hex(o):a.length>0?s.inject.random.hex(a):void 0}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createRandomGenerator=void 0;const n=i(279),s=i(0);var a=Phaser.Math.PI2;const o=i(439);t.createRandomGenerator=function(e){let t;function i(i=Math.floor(1e5*Math.random())){e=i,t=i}function r(){var t=1e4*Math.sin(e++);return t-Math.floor(t)}function c(e,t){return Math.floor(r()*(t-e+1))+e}return i(e),{reset:i,number:r,oneOf:function(e){return e[c(0,e.length-1)]},popFrom:function(e){return e.splice(c(0,e.length-1),1)[0]},hex:function(e){return e.members[c(0,e.length-1)]},property:function(e){var t,i=0;for(var n in e)r()<1/++i&&(t=n);return t},integer:c,shuffle:function(e){let t,i,n=[...e],s=n.length;for(;0!==s;)i=Math.floor(Math.random()*s),s-=1,t=n[s],n[s]=n[i],n[i]=t;return n},boolean:function(e=.5){return r()<e},point:function(e){const t=e*Math.sqrt(r()),i=r()*a;return{x:t*Math.cos(i),y:t*Math.sin(i)}},townName:function(){return s.inject.random.oneOf(n.townNamePrefixes)+s.inject.random.oneOf(n.townNameSuffixes).toLowerCase()},id:function(e=8){return(0,o.nanoid)(e)}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.townNameSuffixes=t.townNamePrefixes=void 0,t.townNamePrefixes=["Agate","Al","Amber","Amethyst","Ametrine","Ander","Apple","Arbor","Ard","Arrow","Ash","Ashen","Auburn","Autumn","Back","Bain","Baldur","Bane","Baron","Barron","Barrow","Basalt","Beach","Bear","Beech","Bell","Belle","Beryl","Big","Birch","Bitter","Black","Blade","Blue","Bog","Bone","Border","Boulder","Brass","Break","Breeze","Briar","Bridge","Brier","Bright","Brim","Burn","Castle","Cedar","Chamber","Chill","Cinder","Clay","Cold","Condor","Corner","Crab","Crag","Craw","Crown","Crystal","Dag","Dark","Day","Dead","Deep","Dire","Dragon","Drake","Draken","Dread","Dusk","Eagle","East","Ebon","Eden","Edge","Edin","Elder","Elm","Ember","Emerald","Ever","Fae","Fair","Faire","Fal","Fall","Fel","Fell","Fey","Fir","Fire","Flint","Fog","Fort","Free","Full","Gay","Gem","Glow","Gold","Grand","Granite","Grass","Grave","Gray","Green","Grey","Griffon","Gryphon","Guild","Half","Hallow","Hammer","Hard","Hawk","Heart","Hearth","Heath","Hedge","Hem","High","Hills","Hollow","Home","Hope","Horn","Iron","Jade","Jasper","Kent","Key","King","Kings","Kirk","Kraig","Lady","Lake","Larch","Law","Leaf","Ledge","Ley","Lime","Lion","Little","Liver","Loch","Lone","Love","Low","Lower","Maiden","Main","Man","Mans","Maple","Marble","Marsh","Mason","Mass","May","Mead","Meadow","Mid","Middle","Mine","Mist","Mithril","Moon","Mord","Moss","Mourn","Mud","Murk","Myst","Mythril","Nettle","Never","New","Night","North","Oak","Old","Onyx","Opal","Pale","Peace","Pike","Pine","Plum","Point","Pond","Port","Prince","Pyre","Queen","Queens","Quiet","Rain","Rainbow","Ram","Raven","Red","Redwood","Rex","Rich","Ridge","Ring","River","Rock","Rose","Ruby","Rune","Sage","Sand","Sapphire","Sea","Sedge","Shade","Sharp","Sharpe","Shatter","Shaw","Shell","Shield","Shire","Shore","Silver","Skull","Sky","Slade","Snow","Sound","South","Spine","Spring","Stan","Star","Still","Stock","Stone","Stony","Storm","Stout","Strath","Strom","Summer","Sun","Sunny","Sword","Tangle","Teak","Temple","Timber","Topaz","Torch","Tower","Tree","True","Tumble","Twin","Tyr","Umber","Umbur","Under","Upper","Wake","Wall","War","Water","Way","Wedge","West","Wet","Whet","Whit","White","Wild","Will","Willow","Win","Wind","Winter","Wolf","Wood","Wren","Wyn","Yew"],t.townNameSuffixes=["Back","Bank","Bard","Baron","Barron","Basin","Bay","Beach","Beck","Bell","Ben","Berg","Black","Bluff","Blum","Bog","Border","Borough","Bourg","Bourne","Brad","Brake","Breach","Breeze","Bridge","Brook","Burg","Burn","Bury","By","Call","Camp","Castle","Chester","City","Corner","Cott","Court","Cove","Crag","Creek","Crest","Cross","Crossroad","Crown","Dag","Dale","Dane","Dark","Deep","Del","Dell","Dike","Dorf","Drake","Dune","Edge","Encampment","End","Fair","Faire","Fal","Fall","Falls","Fast","Fax","Fel","Feldt","Fell","Felt","Field","Fire","Flint","Font","Ford","Forge","Forks","Forth","Full","Gard","Garde","Garden","Gardr","Gate","Gem","Gill","Glen","Glow","Grad","Grade","Grass","Grave","Grove","Guard","Guild","Hall","Hallow","Ham","Hamlet","Hand","Harbour","Haven","Head","Heart","Heed","Heim","Helm","Hill","Hold","Hollow","Holm","Holme","Holt","Home","Hood","Hope","Horse","Ington","Inlet","Island","Isle","Joy","Junction","Keep","Kraig","Lagoon","Lain","Lake","Land","Landing","Lands","Law","Leaf","Leap","Ledge","Letter","Light","Line","Lock","Lodge","Loft","Maiden","Mane","March","Marsh","Mass","Mead","Mere","Mesa","Mile","Mill","Mine","Mond","Mont","Moor","Mora","More","Morra","Mount","Mouth","Murk","Nook","Pad","Park","Pass","Path","Peak","Perch","Pier","Pike","Pine","Pines","Point","Pond","Pool","Poole","Port","Quarry","Quil","Quill","Quin","Quinn","Rain","Rapids","Ray","Reach","Reign","Rest","Ridge","Right","Ring","River","Rock","Roost","Rose","Roth","Rott","Row","Rowe","Run","Rune","Ruun","Sand","Settlement","Shadow","Sharp","Sharpe","Shaw","Shield","Shine","Ship","Shire","Shore","Side","Sierra","Sigil","Snow","Sol","Son","Sor","Sound","Spear","Spot","Square","Stad","Stain","Stane","Star","Station","Stead","Steppe","Stock","Ston","Stone","Stow","Strand","Strike","Summit","Sword","Sworth","Tarn","Tear","Thorn","Thorne","Thorpe","Throw","Ton","Tower","Town","Township","Trail","Tucket","Vale","Valley","Valt","Vanguard","Vault","Veldt","View","Village","Ville","Wake","Wall","Ward","Wash","Watch","Water","Way","Weald","Well","Wharf","Wheel","Wich","Wick","Wild","Wile","Will","Wind","Wing","Wolf","Wolfe","Wood","Worth","Wright","Wyn"];new Map([["Animals",["Badger","Bat","Boar","Buck","Bull","Calf","Canary","Cat","Cattle","Chick","Chicken","Clam","Cob","Cock","Cockatiel","Cockatoo","Cockerel","Cockle","Colt","Cow","Crab","Crow","Cub","Deer","Doe","Dog","Donkey","Dove","Drake","Dray","Duck","Duckling","Ewe","Eyas","Fawn","Ferret","Foal","Fox","Frog","Gander","Gerbil","Goat","Goose","Gosling","Hamster","Hare","Hawk","Hedgehog","Hen","Heron","Horse","Jack","Jenny","Jill","Kid","Kingfisher","Kit","Kitten","Lamb","Leveret","Lobster","Mare","Mole","Mouse","Mussel","Nanny","Newt","Otter","Owl","Owlet","Oyster","Peachick","Peacock","Peafowl","Peahen","Pheasant","Pig","Pigeon","Piglet","Pike","Prickle","Pup","Puppy","Rabbit","Ram","Rat","Robin","Rook","Salmon","Sheep","Signet","Snail","Snake","Sneak","Sow","Sparrow","Spider","Squab","Squirrel","Stag","Stallion","Starling","Stoat","Swan","Tiercel","Toad","Trout","Vixen","Weasel"]],["Geography",["Basin","Bay","Bluffs","Bush","Canal","Canyon","Cave","Cliff","Crag","Crater","Creek","Dale","Down","Falls","Fern","Flats","Forest","Fork","Glacier","Grotto","Heights","Hill","Hollow","Island","Knoll","Lagoon","Lake","Marsh","Mountain","Narrows","Overlook","Pass","Peak","Plain","Pond","Ravine","Reef","Ridge","River","Sound","Tree","Vale","Valley","Woods"]],["Geology",["Agate","Aluminum","Amber","Amethyst","Basalt","Brass","Bronze","Chalk","Chrome","Clay","Coal","Copper","Coral","Diamond","Emerald","Feldspar","Flint","Gold","Granite","Gypsum","Iron","Jade","Jasper","Lead","Limestone","Marble","Mercury","Mica","Pewter","Platinum","Pyrite","Quartz","Ruby","Sandstone","Shale","Silt","Silver","Slate","Steel","Tin","Topaz"]]])},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameStateHistory=void 0;const n=i(165),s=i(0),a=i(1);a.logger.for("StateRecorder");t.GameStateHistory=class{constructor(){this.capacity=20,this.data=new n.FixedCapacityArray(20),this.currentFrame=0,this.paused=!1}add(e,t=s.inject.gameStateModel.state){this.paused||this.data.push({state:t,label:e})}suspendRecording(){this.paused=!0}resumeRecording(){this.paused=!1}getAll(){return this.data.getItems()}get(e){return this.data.get(e)}length(){return this.data.length}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugData=void 0;t.DebugData=class{constructor(){this.items={}}set(e,t){this.items[e]=t}get(e){return this.items[e]}clear(e){delete this.items[e]}getText(){return Object.entries(this.items).map(([e,t])=>`${e}: ${t}`).join("\n")}}},,,,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldDebugLayersManager=void 0;const n=i(23),s=i(0),a=i(27),o=i(66);i(1).logger.for("DebugLayersManager");class r{constructor(){this.layers={blank:r.blankLayer},this.activeLayer=r.blankLayer,this.activeLayerName=void 0,this.onActiveLayerUpdated=(0,a.signal)()}register(e,t){this.layers[e]&&(this.layers[e].deactivate&&this.layers[e].deactivate(),this.layers[e].onChange.unsubscribeAll()),this.layers[e]=t,t.onChange(()=>this._layerChanged(t))}registerAndActivate(e,t){this.register(e,t),this.activate(e)}_layerChanged(e){e===this.activeLayer&&this.onActiveLayerUpdated.fire(this.activeLayer)}get(e){return this.layers[e]}activate(e,t){if(this.activeLayer&&this.activeLayer.deactivate&&this.activeLayer.deactivate(),e){if(!this.layers[e]){if(!t)throw new Error("No debug layer found for name "+e);this.register(e,t())}this.activeLayerName=e,this.activeLayer=this.layers[e],this.activeLayer.activate&&this.activeLayer.activate(),s.inject.debugData.set("debugLayer",e)}else this.activeLayer=r.blankLayer,this.activeLayerName=void 0,s.inject.debugData.clear("debugLayer");this.onActiveLayerUpdated.fire(this.activeLayer)}}t.WorldDebugLayersManager=r,r.blankLayer={onChange:(0,a.signal)(),activate:n.noop,deactivate:n.noop,getMap:()=>new o.CustomHexGroupValuation(void 0),getDetail:()=>{}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RegionAIContext=void 0;const a=i(289),o=s(i(10)),r=i(86),c=i(0),l=i(1),d=i(58),h=i(59),u=i(90),g=i(117);l.logger.for("ai:context"),o.default.Map([[1,1],[2,1],[3,1],[4,1]]);t.RegionAIContext=class{constructor(e){this.region=e,this.game=c.inject.gameStateController,this.currentScore=0,this.debug=!1,this.plays=[],this.marshal=new a.Marshal(this),this.advisors={political:g.NEUTRAL_POLITICAL_ADVISOR,armyComposition:d.UNRESTRICTED_ARMY_COMPOSITION,economic:h.UNRESTRICTED_ECONOMIC_ADVISOR},this.focus={growth:1,defense:1,offense:1}}get faction(){return this.region.faction}get state(){return this.game.currentState}setAdvisors(e){this.advisors=e,this.unitSolver=new r.UnitSolver(e)}breakpoint(e,t=(()=>({}))){return n(this,void 0,void 0,(function*(){this.debug&&(yield c.inject.debugBreakpoint(e,()=>Object.assign(Object.assign({},t()),{region:this.region})))}))}addPlay(e,t){if(this.plays.push({play:e,gameCheckpoint:this.game.createCheckpoint()}),this.game.executePlay(e),t){const e=this.game.model.warfare.getOccupyingUnit(t);e&&this.game.model.currentPhase.tapPawn(e)}this.updateAfterStateChange()}requestUnit(e){let t=0,i=void 0;return e.forEach((e,n)=>{const s=this.unitSolver.gather(Object.assign(Object.assign({},(0,u.getMyRegionAssets)(this.region)),{requiredMight:n,allowOverkill:!1}));if(!s)return;const a=e*(s.attractiveness+1);a>t&&(t=a,i=s)}),i}updateAfterStateChange(){this.region.updateFrom(this.game.currentState)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getCostPerUnitOfMight=t.Marshal=t.RosterUnitRecipeType=void 0;const n=i(13),s=i(6),a=i(1),o=i(3),r=i(2),c=a.logger.for("ai:Marshal");!function(e){e.PickExisting="pick-existing",e.CombineUnits="combine-units",e.Buy="buy"}(t.RosterUnitRecipeType||(t.RosterUnitRecipeType={}));t.Marshal=class{constructor(e){this.ctx=e,this.model=this.ctx.game.model}moveUnit(e,t){const i=[...t.useUnits],n=[...t.buyUnits];if(0===i.length){(0,r.assert)(1===n.length,`Unexpected plan - given there are no existing units to use, expected one unit to buy, instead got [${n}]`);const t=this.model.rules.unitByMight(n[0]).type;return!!this.freeUpHexIfFriendly(e)&&(this.ctx.addPlay(s.Plays.BuyPawn({pawnType:t,buyerRegionId:this.ctx.region.id,destinationHexId:e.id}),e),!0)}const a=i.shift();let o=this.getClosestMovableUnitByMight(e,a);for(r.assert.defined(o,"Marshal was unable to find unit with might "+a);i.length>0||n.length>0;){const e=o.hex;if(i[0]===o.might){const t=this.getClosestMovableUnitByMight(o.hex,i.shift(),[o]);r.assert.defined(t,`Failed to find a unit with might ${a} to merge into ${o}`),this.ctx.addPlay(s.Plays.MovePawn({pawnId:t.id,destinationHexId:e.id}))}else{if(n[0]!==o.might)return c.error(`Marshal failed to execute plan, unclear what to do next: current unit ${o}, unitsToUse [${i}], unitsToBuy [${n}]`),!1;{const t=this.model.rules.unitByMight(n.shift()).type;this.ctx.addPlay(s.Plays.BuyPawn({pawnType:t,buyerRegionId:this.ctx.region.id,destinationHexId:e.id}))}}o=this.model.warfare.getOccupyingUnit(e),r.assert.defined(o,"lost track of the current unit after move to "+e)}return!(e!==o.hex&&!this.freeUpHexIfFriendly(e))&&(this.ctx.addPlay(s.Plays.MovePawn({pawnId:o.id,destinationHexId:e.id}),e),!0)}getClosestMovableUnitByMight(e,t,i=[]){return this.model.pawns.findClosest(e,this.ctx.region.hexes,e=>!i.includes(e)&&this.model.currentPhase.isMovable(e)&&e.might===t)}freeUpHexIfFriendly(e){if(this.model.regions.byHex(e)!==this.ctx.region)return!0;const t=this.model.pawns.findOne({hexes:e,traits:[n.PawnTraits.Unit]});if(t){const i=this.ctx.region.hexes.findClosest(e,e=>!this.model.warfare.isOccupied(e));return i?(this.ctx.addPlay(s.Plays.MovePawn({pawnId:t.id,destinationHexId:i.id})),!0):(c.warning(`Unable to free up space for defender on hex ${e} - there's nowhere to move obstructing unit ${t}`),!1)}return!0}buildCastle(e,t){const i=this.model.rules.castleByMight(t).type;return this.ctx.addPlay(s.Plays.BuyPawn({pawnType:i,buyerRegionId:this.ctx.region.id,destinationHexId:e.id})),!0}},t.getCostPerUnitOfMight=function(e){return e.rules.pawns(o.PawnType.Villager).cost}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.growthStrategy=void 0;const s=i(1),a=i(91),o=i(92),r=i(58),c=i(117),l=i(59);s.logger.for("ai:strategy");t.growthStrategy=e=>n(void 0,void 0,void 0,(function*(){const t=new a.SituationExplorer(e);for(e.setAdvisors({political:new c.ApprovalBasedPoliticalAdvisor(e.faction),armyComposition:new r.BalancedGrowthArmyComposition(e.region),economic:new l.GrowthEconomicAdvisor(e.region)}),yield e.breakpoint("ai:strategy: GROWTH"),e.focus={offense:.5,defense:0,growth:1};yield t.tryBest([o.Planners.Default]););if(!t.isSafe()){for(t.considerCurrentSituation(),t.backtrack(.5),e.focus={offense:.5,defense:2,growth:1};yield t.tryBest([o.Planners.Default]););if(t.isSafe())return t.considerCurrentSituation(),void t.goToBestOutcomeSoFar();for(t.backtrack(1);yield t.tryBest([o.Planners.Default]););t.considerCurrentSituation(),t.goToBestOutcomeSoFar()}}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CalculatedHexGroupValuationWithCache=void 0;t.CalculatedHexGroupValuationWithCache=class{constructor(){this.values={}}get(e){return this.values[e]||(this.values[e]=this.calculate(e)),this.values[e]}getHexIds(){return Object.keys(this.values).map(e=>Number(e))}flush(){this.values={}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultPlanner=void 0;const n=i(90),s=i(24),a=i(18),o=i(7),r=i(52),c=i(9),l=i(30),d=i(17),h=i(3),u=i(2),g=i(14),p=i(293),m=i(294);i(1).logger.for("ai:DefaultPlanner");t.DefaultPlanner=class{constructor(){this.name=this.constructor.name}*generatePlans(e,t){this.context=e,this.views=t,this.focus=e.focus,this.state=e.state,this.investmentPenaltyByMight={};const i=(0,n.getMyRegionAssets)(e.region),r=e.unitSolver,c=[1,2,3,4].filter(t=>{if(e.region.power.maxObtainableUnitMight<t)return!1;if(i.remainingUnits.has(t))return this.investmentPenaltyByMight[t]=0,!0;const n=r.gather(Object.assign(Object.assign({},i),{requiredMight:t,allowOverkill:!1}));return!!(n&&n.attractiveness>=.1)&&(this.investmentPenaltyByMight[t]=Math.floor(Math.min(0,100*(n.attractiveness-1))),!0)}),l=this.getObtainableCastles(i),d=c[c.length-1];if(d>0)for(const t of s.Warfare.getConquerableHexes(this.state,e.region.id,d).members){for(let e=s.Warfare.getHexDefense(this.state,t)+1;e<=d;++e){if(!c.includes(e))continue;const i=this.calculateFactorsForAttack(t,e);yield new p.PlaceUnitPlan(t,e,i)}}if(this.focus.defense>0){const t=this.views.exposedHexes.get(20/e.focus.defense);if(t.length){const e=t.members.reduce((e,t)=>a.AI.getHexImportance(this.state,t.id).value>a.AI.getHexImportance(this.state,e.id).value?t:e),i=[e,...o.Regions.getSameRegionNeighbours(this.state,e).members].filter(e=>!s.Warfare.model(this.state).isOccupied(e));for(const e of i){for(let t=1;t<=d;++t){if(!c.includes(t))continue;const i=this.calculateFactorsForPlacingDefender(e,t);yield new p.PlaceUnitPlan(e,t,i)}for(const t of l){const i=this.calculateFactorsForBuildingCastle(e,t);yield new m.PlaceCastlePlan(e,t,i)}}}}}getObtainableCastles(e){return[2].filter(t=>this.context.advisors.economic.getWillingnessToSpend(e,r.Rules.model(this.state).castleByMight(t).cost,0)>0)}calculateFactorsForPlacingDefender(e,t){r.Rules.model(this.state);const i=[e,...o.Regions.getSameRegionNeighbours(this.state,e).members].map(e=>this.calculateDefenseBenefit(e,t)).reduce(c.sum,0);return{capturedHexEnemyImportance:0,capturedHexImportanceForMe:0,joinRegionsBonus:0,loot:0,investmentPenalty:this.investmentPenaltyByMight[t],threatReduction:Math.floor(i),baseSafetyRating:0,exposedUnitPenalty:0}}calculateFactorsForBuildingCastle(e,t){const i=r.Rules.model(this.state).castleByMight(t),n=[e,...o.Regions.getSameRegionNeighbours(this.state,e).members],s=n.map(e=>this.calculateDefenseBenefit(e,t)).reduce(c.sum,0),a=n.map(e=>this.calculateStaticDefenseBenefit(e,t)).reduce(c.sum,0);return{capturedHexEnemyImportance:0,capturedHexImportanceForMe:0,joinRegionsBonus:0,loot:0,investmentPenalty:-i.cost*this.focus.growth,threatReduction:Math.floor(s),baseSafetyRating:Math.floor(a),exposedUnitPenalty:0}}calculateFactorsForAttack(e,t){return Object.assign(Object.assign({capturedHexEnemyImportance:this.calculateEnemyHexImportanceFactor(e),capturedHexImportanceForMe:this.calculateMyHexImportanceFactor(e),joinRegionsBonus:this.calculateJoinRegionBonus(e),loot:10*l.Economy.model(this.state).numberOfCoinsAt(e)*this.focus.growth},this.calculateSafetyRating(e,t)),{investmentPenalty:this.investmentPenaltyByMight[t],threatReduction:this.calculateThreatReductionAfterHexCaptured(e,t)})}calculateThreatReductionAfterHexCaptured(e,t){if(0===this.focus.defense)return 0;let i=0;return this.context.region.hexes.neighboursOf(e).forEach(e=>{i+=this.calculateDefenseBenefit(e,t)}),Math.floor(i)}calculateDefenseBenefit(e,t){var i;const n=s.Warfare.getHexDefense(this.state,e);if(n>t)return 0;const o=this.views.threatAssessment.get(e.id),r=Math.min(n,o.strongestUnit),c=Math.min(t,o.strongestUnit),l=(null===(i=a.AI.getHexImportance(this.state,e.id))||void 0===i?void 0:i.value)||0,u=d.Pawns.model(this.state).presentAtHex(e,h.PawnType.Town);let g=0;for(let e=r+1;e<=c;e++){g+=l*(u?1:o.riskByMight[e]||0)*this.focus.defense}return Math.floor(g)}calculateStaticDefenseBenefit(e,t){var i;const n=s.Warfare.getHexStaticDefense(this.state,e);if(n>t)return 0;const o=this.views.threatAssessment.get(e.id),r=Math.min(n,o.strongestUnit),c=Math.min(t,o.strongestUnit),l=(null===(i=a.AI.getHexImportance(this.state,e.id))||void 0===i?void 0:i.value)||0,u=d.Pawns.model(this.state).presentAtHex(e,h.PawnType.Town);let g=0;for(let e=r+1;e<=c;e++){g+=l*(u?1:o.riskByMight[e]||0)*this.focus.defense}return Math.floor(g)}calculateSafetyRating(e,t){const i=this.context.faction;u.assert.defined(i);const n=o.Regions.model(this.context.state).byHex(e);u.assert.defined(n);const a=n.power.maxSustainableUnitMight,r=s.Warfare.getHexDefenseAsIfOwnedBy(this.state,e,this.context.region.id);let c,l=0;if(a){c=50/(Math.max(0,t-(a>r?a:1))+1);const e=Math.max(0,a-Math.max(t,r));l=-1*this.context.focus.defense*e*5}else c=50/t;return{baseSafetyRating:Math.floor(c),exposedUnitPenalty:l}}calculateEnemyHexImportanceFactor(e){var t;if(0===this.focus.offense)return 0;const i=o.Regions.model(this.state).byHex(e);if(!i)return 0;const n=this.context.advisors.political.getWillingnessToAttack(i);if(0===n)return-1e3;const s=n-1,r=i.isAlive()?25:0,c=Math.max(r,(null===(t=a.AI.getHexImportance(this.state,e.id))||void 0===t?void 0:t.value)||0);return s>0?Math.round(c*s*this.focus.offense):Math.round(c*s/this.focus.offense)}calculateMyHexImportanceFactor(e){return Math.max(this.focus.defense,this.focus.growth/2)?e.neighbours(e=>g.Factions.getByHex(this.state,e.id)===this.context.faction.id).map(e=>{var t;return(null===(t=a.AI.getHexImportance(this.state,e.id))||void 0===t?void 0:t.value)||0}).reduce(c.sum,0):0}calculateJoinRegionBonus(e){if(!this.focus.growth)return 0;let t=0;return new Set(e.neighbours().map(e=>o.Regions.model(this.state).byHex(e)).filter(e=>e&&e!==this.context.region&&e.faction===this.context.faction)).forEach(e=>{var i;e.isAlive()?t+=5*(e.treasury+Math.abs((null===(i=e.budget)||void 0===i?void 0:i.balance)||0)):t+=50*e.hexes.length}),Math.min(t*this.focus.growth,500)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaceUnitPlan=void 0;const n=i(90),s=i(9),a=i(0),o=i(19),r=i(11);t.PlaceUnitPlan=class{constructor(e,t,i){this.hex=e,this.might=t,this.utilityFactors=i,this.utility=Object.values(this.utilityFactors).reduce(s.sum,0)}execute(e){const t=e.unitSolver.gather(Object.assign(Object.assign({},(0,n.getMyRegionAssets)(e.region)),{requiredMight:this.might,allowOverkill:!0}));return!!t&&(e.marshal.moveUnit(this.hex,t),!0)}toString(){return`[${this.utility} | Place ${a.inject.gameStateModel.rules.unitByMight(this.might).type} at #${this.hex.id}]`}toDebugString(){return(0,o.prettyPrintObject)((0,r.filterDictionary)(this.utilityFactors,e=>0!=e),2)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaceCastlePlan=void 0;const n=i(9),s=i(0),a=i(19),o=i(11);t.PlaceCastlePlan=class{constructor(e,t,i){this.hex=e,this.might=t,this.utilityFactors=i,this.utility=Object.values(this.utilityFactors).reduce(n.sum,0)}execute(e){return e.marshal.buildCastle(this.hex,this.might),!0}toString(){return`[${this.utility} | Place ${s.inject.gameStateModel.rules.castleByMight(this.might).type} at #${this.hex.id}]`}toDebugString(){return(0,a.prettyPrintObject)((0,o.filterDictionary)(this.utilityFactors,e=>0!=e),2)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateAttritionImpact=t.getDominantFaction=t.DefaultAIDataLayer=t.DummyAIDataLayer=void 0;const n=i(3),s=i(2),a=i(9),o=i(18),r=i(0),c=i(13),l=i(1),d=i(5),h=i(8),u=i(14);l.logger.for("ai:DataLayer");t.DummyAIDataLayer=class{onHexConquered(e){}onTurnEnd(e,t){}onTurnStart(e,t){}};function g(e){const t=(0,d.selectFromState)(e,h.GameState.ai.powerByFaction).valueSeq().reduce(a.sum,0),i=u.Factions.model(e).all().filter(e=>e.controller!==n.FactionController.None).reduce((e,t)=>e.power<t.power?t:e);return{faction:i,dominance:i.power/t}}function p({model:e,destroyedPawns:t,victimRegions:i,regionWasAlive:n}){if(n){const n=i.filter(e=>!e.isAlive()),s=i.filter(e=>e.isAlive()),o=t.map(f).reduce(a.sum,0),r=1+n.map(e=>e.size).reduce(a.sum,0),c=n.map(t=>e.warfare.getUnitsByRegion(t).map(m).reduce(a.sum,0)).reduce(a.sum,0),l=function(e){e.sort((e,t)=>e.size-t.size);const t=e.slice(1).map(e=>e.budget.incomeFromHexes).reduce(a.sum,0)/10,i=e.filter(e=>e.budget.balance<0).map(e=>-1*e.budget.balance).reduce(a.sum,0);return t+i}(s);return Math.floor(10*(r+o+c+l))}return Math.ceil(i.map(e=>e.size).reduce(a.sum)/5)}function m(e){return f(e.type)}function f(e){const t=r.inject.gameStateModel.rules.pawns(e);return t.hasTrait(c.PawnTraits.Unit)?t.upkeep:t.type===n.PawnType.Town?10:0}function y(e,t){return Math.ceil(e/Math.min(10,Math.max(1,t))*10)}t.DefaultAIDataLayer=class{onHexConquered({model:e,attackerFaction:t,destroyedPawns:i,victimRegions:a,regionWasAlive:r}){(0,s.assert)(a.length>0,"victimRegions should never be empty");const c=a[0].faction,l=a.filter(e=>e.isAlive()),d=p({model:e,attackerFaction:t,destroyedPawns:i,victimRegions:a,regionWasAlive:r}),h=y(d,c.power);l.length>0&&o.AI.inflictRegionAttrition(e.stateEngine.currentState,l.map(e=>e.id),t.id,d),o.AI.changeFactionApproval(e.state,c.id,t.id,e=>function(e,t,i){let n=t;t>0&&i>=10&&(n=Math.floor(t/(i/10+1)));return n-=i,n}(0,e,h));const u=o.AI.getFactionApproval(e.state,t.id,c.id);if(u>0){const i=Math.max(0,u-h/2);o.AI.changeFactionApproval(e.state,t.id,c.id,()=>i)}if(d>=10){const i=e.factions.all().filter(t=>t.controller!==n.FactionController.None&&t!==c&&o.AI.getFactionApproval(e.state,t.id,c.id)>=100),s=e.factions.all().filter(t=>t.controller!==n.FactionController.None&&o.AI.getFactionApproval(e.state,t.id,c.id)<=-100);for(const n of i){const i=Math.floor(y(d,Math.max(n.power,c.power))/3);o.AI.changeFactionApproval(e.state,n.id,t.id,e=>e-i)}for(const i of s){const n=Math.floor(y(d,Math.max(i.power,c.power))/3);o.AI.changeFactionApproval(e.state,i.id,t.id,e=>e+n)}}}onTurnEnd(e,t){t.controller!==n.FactionController.None&&(function(e,t){o.AI.changeFactionAttrition(e.state,e.currentPhase.faction.id,e=>Math.floor(.5*e))}(e),function(e,t){const i=g(e.state),s=i.dominance>.25?2*(i.dominance-.25):0;e.factions.all().filter(e=>e.controller!==n.FactionController.None&&e!==t).forEach(n=>{o.AI.changeFactionApproval(e.state,n.id,t.id,a=>{let r=a;const c=-o.AI.getFactionFear(e.state,n.id,t.id),l=a>c&&t===i.faction||a<c&&![t,i].includes(i.faction)?s+.1:.1;r+=Math.floor((c-a)*l);for(const i of n.getRegions().filter(e=>e.isAlive())){const n=o.AI.getFactionInfluenceByRegion(e.state,t.id,i.id);if(n.proximity>1)continue;const s=n.total;if(0===o.AI.getRegionAttrition(e.state,i.id,t.id)&&s>0){const e=Math.floor(Math.sqrt(s)/3);r+=Math.min(e,10)}}return r})})}(e,t))}onTurnStart(e,t){}},t.getDominantFaction=g,t.calculateAttritionImpact=p},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.assaultStrategy=void 0;const s=i(59),a=i(58),o=i(91),r=i(92),c=i(174),l=i(116),d=i(9);t.assaultStrategy=({warSupportByFaction:e})=>t=>n(void 0,void 0,void 0,(function*(){const i=t.game.currentState;t.setAdvisors({political:new c.WartimePoliticalStrategy(i,t.region,e),economic:s.UNRESTRICTED_ECONOMIC_ADVISOR,armyComposition:a.UNRESTRICTED_ARMY_COMPOSITION});const n=Array.from(e.values()).reduce(d.max,2*l.MIN_WAR_SUPPORT_THRESHOLD),h=Array.from(e.entries()).filter(([e,t])=>t>=.75*n).map(([e,t])=>`${e}(${t})`).join(", ");yield t.breakpoint("ai:strategy: ASSAULT against "+h);const u=[r.Planners.Default],g=new o.SituationExplorer(t);for(t.focus={offense:1,defense:0,growth:.1};yield g.tryBest(u););for(t.focus={offense:2,defense:1,growth:.5};yield g.tryBest(u););}))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.debugBreakPointProvider=void 0;const s=i(0);t.debugBreakPointProvider=function(e,t){return n(this,void 0,void 0,(function*(){if(!s.inject.config.debug.overlay||!s.inject.config.debug.breakpoints)return;const i=s.inject.config.debug.breakpoints;if(Array.isArray(i)&&!i.find(t=>e.startsWith(t)))return;const n=s.inject.scene.debug,a=s.inject.scene.worldMap,o=s.inject.navigator.currentScreen;s.inject.navigator.goTo(s.inject.screen.breakpoint),a.syncState(s.inject.gameStateModel.state),console.warn("HANDLING BREAKPOINT"),yield n.handleBreakpoint(e,t?t():{}),console.log("BREAKPOINT HANDLED, WILL RETURN TO",o.constructor.name),s.inject.navigator.goTo(o)}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AppVersionManager=void 0;const n=i(1),s=i(0),a=i(27),o=i(77),r=i(41),c=n.logger.for("registerServiceWorker");t.AppVersionManager=class{constructor(){this.isNewVersionAvailable=!1,this.onNewVersionDetected=(0,a.signal)(),this.swRegistration=void 0}start(){if("serviceWorker"in navigator)if(s.inject.config.useServiceWorker){c.info("Registering service worker");let e=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{e||(e=!0,window.location.reload())}),navigator.serviceWorker.register("./sw.js").then(e=>{this.swRegistration=e,e.active&&this.showUpdatePromptAfterNewWorkerActivated()})}else navigator.serviceWorker.getRegistrations().then(e=>{for(let t of e)t.unregister()})}updateNow(){var e,t;if(!this.swRegistration)throw new Error("cannot update: no service worker registration available");this.swRegistration.waiting||c.warning("Ignoring app update request, no new version detected (no waiting service worker)"),null===(t=null===(e=this.swRegistration)||void 0===e?void 0:e.waiting)||void 0===t||t.postMessage("skipWaiting")}showUpdatePromptAfterNewWorkerActivated(){this.swRegistration&&function(e,t){if(!e)return;if(e.waiting)return t(e);e.installing&&i();function i(){e.installing.addEventListener("statechange",(function(){"installed"===this.state&&t(e)}))}e.addEventListener("updatefound",i)}(this.swRegistration,()=>this.promptUserToRefresh())}promptUserToRefresh(){this.isNewVersionAvailable=!0,this.onNewVersionDetected.fire();try{s.inject.modals.show(o.UI.newVersionAvailable,{},e=>{e===r.DialogButtons.Launch&&this.updateNow()})}catch(e){console.error(e),this.updateNow()}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NewGameDialog=void 0;const n=i(41),s=i(42),a=i(54),o=i(96),r=i(305),c=i(306),l=i(307),d=i(3),h=i(110),u=i(309),g=i(0),p=i(45);class m extends a.BaseDialogUIProvider{constructor(){super(),this.data={width:new c.Ref(18),height:new c.Ref(18),numPlayers:new c.Ref(6),factions:new c.Ref([]),regionSize:new c.Ref(3),towns:new c.Ref(4),shape:new c.Ref("island")},this.data.numPlayers.onChanged(e=>this.updateFactionList(e)),this.updateFactionList(this.data.numPlayers.current)}applyProps(e){var t,i;super.applyProps(e);const n=e.defaultValues;this.data.width.set(n.mapWidth),this.data.height.set(n.mapHeight),this.data.numPlayers.set(n.players.length),this.data.factions.set(n.players.map((e,t)=>({controller:e,color:h.THEMES.default.colors[t],onClick:()=>this.toggleFaction(t)}))),this.data.regionSize.set(null!==(t=n.regionSize)&&void 0!==t?t:3),this.data.towns.set(null!==(i=n.townsPerFaction)&&void 0!==i?i:4),this.data.shape.set(n.shape)}updateFactionList(e){const t=this.data.factions.current.slice(0,e);for(;t.length<e;){const e=t.length;t.push({controller:0===e?d.FactionController.LocalUser:d.FactionController.Ai,color:h.THEMES.default.colors[t.length],onClick:()=>this.toggleFaction(e)})}this.data.factions.set(t)}toggleFaction(e){const t=[...this.data.factions.current],i=t[e].controller===d.FactionController.LocalUser?d.FactionController.Ai:d.FactionController.LocalUser;t[e]=Object.assign(Object.assign({},t[e]),{controller:i}),this.data.factions.set(t)}getTitle(){return"New Game"}createContent(e){return new o.Column(e,{spacing:8},[new r.FormItem(e,{label:"width",spacing:4,labelWidth:80},new c.SliderWithLabel(e,{min:8,max:30,labelWidth:26,trackWidth:200,value:this.data.width})),new r.FormItem(e,{label:"height",spacing:4,labelWidth:80},new c.SliderWithLabel(e,{min:8,max:30,labelWidth:26,trackWidth:200,value:this.data.height})),new r.FormItem(e,{label:"players",spacing:4,labelWidth:80},new c.SliderWithLabel(e,{min:2,max:6,labelWidth:26,trackWidth:200,value:this.data.numPlayers})),new r.FormItem(e,{label:"",spacing:4,labelWidth:80},new l.FactionButtons(e,{spacing:4,data:this.data.factions,maxFactions:6})),new r.FormItem(e,{label:"shape",spacing:4,labelWidth:80},new u.MultipleChoice(e,{width:140,availableValues:["island","blank","plains"],value:this.data.shape})),new r.FormItem(e,{label:"regions",spacing:4,labelWidth:80},new c.SliderWithLabel(e,{min:2,max:7,labelWidth:66,trackWidth:160,value:this.data.regionSize,labelFormatter:f})),new r.FormItem(e,{label:"towns",spacing:4,labelWidth:80},new c.SliderWithLabel(e,{min:1,max:6,labelWidth:26,trackWidth:200,value:this.data.towns}))])}handleClose(e){if(super.handleClose(e),e===n.DialogButtons.NewGame){const e=Object.assign(Object.assign({},p.DEFAULT_NEW_GAME_OPTIONS),{shape:this.data.shape.current,mapWidth:this.data.width.current,mapHeight:this.data.height.current,players:this.data.factions.current.map(e=>e.controller),townsPerFaction:this.data.towns.current,regionSize:this.data.regionSize.current});this.props.onNewGame(Object.assign(Object.assign({},e),{mapWidth:e.mapWidth+2,mapHeight:e.mapHeight+2})),g.inject.userData.rememberChoice("newGameOptions",e)}}getButtons(){return[{text:n.DialogButtons.Cancel,role:s.DialogButtonRole.Regular},{text:n.DialogButtons.NewGame,role:s.DialogButtonRole.PrimaryGreen}]}}function f(e){switch(e){case 1:case 2:return"tiny";case 3:return"small";case 4:return"medium";default:return"large"}}t.NewGameDialog=m},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoxAround=void 0;const n=i(28),s=i(0),a=i(67),o=i(43);class r extends o.CompositeUiElement{constructor(e,t){super(e),this.props=t,this.box=new n.Box(this.scene,t.texture),this.add(this.box,this.props.content),this.updateLayout()}updateLayout(){var e,t,i;const n=Math.max((null===(e=this.props.minSize)||void 0===e?void 0:e.width)||0,this.props.content.width+2*this.props.padding),o=Math.max((null===(t=this.props.minSize)||void 0===t?void 0:t.height)||0,this.props.content.height+this.props.padding+(null!==(i=this.props.paddingBottom)&&void 0!==i?i:this.props.padding));return this.box.setSize(n,o),(0,a.centerHorizontally)(this.props.content,0,this.props.padding,n),this.debugLayer.clear(),s.inject.config.debug.uiLayout&&this.debugLayer.addRectAround(this.props.content),{width:n,height:o}}destroy(){this.box.destroy(),this.container.destroy(),super.destroy()}}t.BoxAround=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isUiElement=void 0,t.isUiElement=function(e){return"object"==typeof e&&e&&e.getGameObject}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DialogButtonGroup=void 0;const n=i(53),s=i(42),a=i(67),o=i(43),r=i(94),c=i(28);var l=Phaser.GameObjects.BitmapText;const d=i(15),h=i(20),u={horizontal:16,vertical:4},g=4;class p extends o.CompositeUiElement{constructor(e,t){super(e),this.props=t,this.buttonRibbon=new n.Ribbon(this.scene,n.RibbonTexture.ButtonGroup),this.buttons=[],this.buttons=this.props.buttons.map(e=>this.createButton(e)),this.add(this.buttonRibbon,...this.buttons)}getButtonWidth(){return this.buttons[0].width||0}updateLayout(){const e=2*u.horizontal+this.getButtonWidth()*this.buttons.length+g*(this.buttons.length-1),t=this.buttonRibbon.height;return this.buttonRibbon.width=e,(0,a.layoutFromLeftToRight)(u.horizontal,u.vertical,g,this.buttons),{width:e,height:t}}doCreateButton(e,t,i=h.Colors.woodenUi.primaryText,n){const s=new r.BoxButton(this.scene,0,0,{baseTexture:c.BoxTexture.DialogButton,downTexture:c.BoxTexture.DialogButtonDown,content:new l(this.scene,0,0,d.BitmapFont.Small,e).setTint(i),buttonTint:n,width:142,height:46});return s.onClicked(t),s}createButton(e){switch(e.role){case s.DialogButtonRole.Regular:return this.doCreateButton(e.text,()=>this.props.onClicked(e.text));case s.DialogButtonRole.PrimaryGreen:return this.doCreateButton(e.text,()=>this.props.onClicked(e.text),2376723,10026855);case s.DialogButtonRole.PrimaryDanger:return this.doCreateButton(e.text,()=>this.props.onClicked(e.text),4461331,16750968)}}}t.DialogButtonGroup=p},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OptionsGroupButtonController=void 0;const n=i(176),s=i(27),a=i(11);t.OptionsGroupButtonController=class{constructor(e,t){this.buttons=e,this.onButtonClicked=(0,s.signal)(),this.buttonControllers=(0,a.mapDictionary)(e,(e,t)=>{const i=new n.PassiveButtonStateController;return e.setController(i),i.onClicked(()=>this.onButtonClicked.fire(t)),i})}selectButton(e){for(let[t,i]of Object.entries(this.buttonControllers))i.setSelected(t===e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseUiProvider=void 0;t.BaseUiProvider=class{getUiElement(e,t){return this.element||(this.element=this.createElement(e)),this.applyProps(t),this.element}dispose(){}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FormItem=void 0;const n=i(43),s=i(9),a=i(0),o=i(33);class r extends n.CompositeUiElement{constructor(e,t={spacing:8,labelWidth:200,label:""},i){super(e),this.props=t,this.content=i,this.label=new o.Label(this.scene,this.props.label),this.add(this.label,i)}add(...e){super.add(...e),this.updateLayout()}updateLayout(){const e=this.members.map(e=>e.height).reduce(s.max),t=Math.max(this.props.labelWidth,this.label.width)+this.props.spacing,i=t+this.content.width;return this.label.setPosition(0,0),this.content.setPosition(t,0),a.inject.config.debug.uiLayout&&(this.debugLayer.clear(),this.members.forEach(e=>this.debugLayer.addRectAround(e))),{width:i,height:e}}}t.FormItem=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Slider=t.SliderWithLabel=t.Ref=void 0;const n=i(43),s=i(0),a=i(33),o=i(53),r=i(93),c=i(27);var l=Phaser.GameObjects.Image,d=Phaser.Geom.Rectangle;t.Ref=class{constructor(e){this.current=e,this.onChanged=(0,c.signal)()}set(e){this.current!==e&&(this.current=e,this.onChanged.fire(e))}};const h=20,u=12;class g extends n.CompositeUiElement{constructor(e,t){super(e),this.props=t,this.label=new a.Label(this.scene,"0"),this.slider=new p(this.scene,function(e){return{min:e.min,max:e.max,width:e.trackWidth,value:e.value}}(this.props)),this.add(this.label,this.slider),this.props.value.onChanged(e=>{this.label.setText(this.getLabelText(e))})}getLabelText(e){return this.props.labelFormatter?this.props.labelFormatter(e):e.toString()}updateLayout(){this.label.setPosition(0,0),this.label.setText(this.getLabelText(this.props.value.current));const e=this.label.height/2-this.slider.height/2;return this.slider.setPosition(this.props.labelWidth,e),s.inject.config.debug.uiLayout&&(this.debugLayer.clear(),this.debugLayer.addRectAround(this.label,r.DebugColors.green),this.debugLayer.addRectAround(this.slider,r.DebugColors.green)),{width:this.props.labelWidth+this.props.trackWidth,height:this.label.height}}}t.SliderWithLabel=g;class p extends n.CompositeUiElement{constructor(e,t){super(e),this.props=t,this.track=new o.Ribbon(this.scene,o.RibbonTexture.Slider),this.rider=new l(this.scene,0,0,"atlas","ui/slider/rider"),this.add(this.track,this.rider),this.rider.setInteractive({useHandCursor:!0}),this.scene.input.setDraggable(this.rider,!0),this.props.value.onChanged(()=>{this.updateLayout()}),this.rider.on("drag",this.handleDrag,this),this.rider.on("dragend",this.handleDragEnd,this),this.track.on("pointerdown",this.handleTrackPointerDown,this)}getTrackY(){return Math.floor(this.rider.height/2-2)}updateLayout(){return this.track.setPosition(u,this.getTrackY()),this.track.width=this.props.width-2*u,this.rider.setPosition(this.valueToRiderOffset(this.props.value.current),this.rider.height/2),this.track.setInteractive(),{width:this.props.width,height:this.rider.height}}getTrackHitArea(){return new d(0,-this.getTrackY(),this.props.width-2*u,this.rider.height)}getDraggableWidth(){return this.track.width-h}valueToRiderOffset(e){const t=this.props.max,i=this.props.min;return e<i&&(e=i),e>t&&(e=t),(e-i)*(this.getDraggableWidth()/(t-i))+h}riderOffsetToValue(e){const t=(e-h)/this.getDraggableWidth();return Math.round((this.props.max-this.props.min)*t+this.props.min)}restrictDragX(e){const t=h+this.getDraggableWidth();return e<h?h:e>t?t:e}handleDrag(e,t,i){const n=this.restrictDragX(t);this.rider.setPosition(n,this.rider.y);const s=this.riderOffsetToValue(n);this.props.value.set(s)}handleDragEnd(e,t,i){this.snapToCurrentValue()}snapToCurrentValue(){const e=this.props.value.current,t=this.valueToRiderOffset(e),i=Math.sqrt(400*Math.abs(this.rider.x-t));this.scene.tweens.add({targets:this.rider,x:t,duration:i,ease:"Sine.easeOut"})}handleTrackPointerDown(e,t,i){const n=this.props.value.current,s=this.riderOffsetToValue(t-this.width/2);s>n?this.props.value.set(n+1):s<n&&this.props.value.set(n-1),this.snapToCurrentValue()}}t.Slider=p},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionButton=t.FactionButtons=void 0;const n=i(3),s=i(119),a=i(308),o=i(0),r=i(31);var c=Phaser.GameObjects.Image;class l extends a.Row{constructor(e,t){const i=function(e,t){const i=[];for(let s=0;s<t.maxFactions;++s){const a=new d(e,t.data.current[s]||{onClick:()=>{},color:0,controller:n.FactionController.LocalUser});i.push(a)}return i}(e,t);super(e,{spacing:t.spacing},i),this.buttons=i,t.data.onChanged(e=>this.updateFactions(e)),this.maxFactions=t.maxFactions,this.updateFactions(t.data.current)}updateFactions(e){for(let t=0;t<this.maxFactions;++t)e[t]?(this.buttons[t].getGameObject().setVisible(!0),this.buttons[t].setProps(e[t])):this.buttons[t].getGameObject().setVisible(!1)}}t.FactionButtons=l;class d extends s.GameObjectUiElement{constructor(e,t){super(e),this.image=new c(this.scene,0,0,"atlas","ui/faction-btn-local"),this.image.setInteractive({useHandCursor:!0}),this.image.on("pointerdown",()=>{t.onClick(),o.inject.audio.playEffect(r.SoundEffects.ButtonDown)}),this.setProps(t)}setProps(e){this.image.setFrame(function(e){switch(e){case n.FactionController.LocalUser:return"ui/faction-btn-local";case n.FactionController.Ai:return"ui/faction-btn-ai";default:return""}}(e.controller)),this.image.setTint(e.color)}getGameObject(){return this.image}}t.FactionButton=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Row=void 0;const n=i(0),s=i(9),a=i(43);class o extends a.CompositeUiElement{constructor(e,t={spacing:0},i=[]){super(e),this.props=t,this.add(...i)}updateLayout(){const e=this.members.reduce((e,t)=>e+t.width,0)+(this.props.spacing*this.members.length-1),t=this.members.map(e=>e.height).reduce(s.max);let i=0;for(let e of this.members)e.setPosition(i,0),i+=e.width+this.props.spacing;return n.inject.config.debug.uiLayout&&(this.debugLayer.clear(),this.members.forEach(e=>this.debugLayer.addRectAround(e))),{width:e,height:t}}}t.Row=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MultipleChoice=void 0;const n=i(43),s=i(33),a=i(97),o=i(67);class r extends n.CompositeUiElement{constructor(e,t){super(e),this.props=t,this.label=new s.Label(this.scene,""),this.leftButton=new a.ImageButton(this.scene,0,0,{frame:"ui/arrow-btn-left",down:!0}),this.rightButton=new a.ImageButton(this.scene,0,0,{frame:"ui/arrow-btn-right",down:!0}),this.leftButton.onClicked(()=>this.handleLeftClick()),this.rightButton.onClicked(()=>this.handleRightClick()),this.add(this.leftButton,this.rightButton,this.label),this.props.value.onChanged(e=>this.handleValueChanged(e)),this.handleValueChanged(this.props.value.current)}updateLayout(){return this.leftButton.setPosition(0,2),this.rightButton.setPosition(this.props.width-this.rightButton.width,2),this.udpateLabelPosition(),{width:this.props.width,height:this.label.height}}handleLeftClick(){const e=this.getCurrentIndex();0===e?this.selectValue(this.props.availableValues.length-1):this.selectValue(e-1)}handleRightClick(){this.selectValue((this.getCurrentIndex()+1)%this.props.availableValues.length)}selectValue(e){this.props.value.set(this.props.availableValues[e])}getCurrentIndex(){const e=this.props.availableValues.indexOf(this.props.value.current);return-1===e?0:e}handleValueChanged(e){this.label.setText(e),this.udpateLabelPosition()}udpateLabelPosition(){(0,o.centerHorizontally)(this.label,0,0,this.props.width)}}t.MultipleChoice=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RestartGameDialog=void 0;const n=i(41),s=i(42),a=i(54),o=i(33);class r extends a.BaseDialogUIProvider{getTitle(){return"Restart Game"}createContent(e){return this.label=new o.Label(e,"Are you sure? All progress will be lost!"),this.label}getButtons(){return[{text:n.DialogButtons.Cancel,role:s.DialogButtonRole.Regular},{text:n.DialogButtons.Restart,role:s.DialogButtonRole.PrimaryDanger}]}applyProps(e){super.applyProps(e),e.message&&this.label.setText(e.message)}}t.RestartGameDialog=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NewVersionAvailableDialog=void 0;const n=i(41),s=i(42),a=i(54);class o extends a.BaseDialogUIProvider{getTitle(){return"There's been an update!"}createContent(e){return"Wow! A shiny new version of the game is ready for you!"}getButtons(){return[{text:n.DialogButtons.Launch,role:s.DialogButtonRole.PrimaryGreen}]}}t.NewVersionAvailableDialog=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExportMapDialog=void 0;const n=i(41),s=i(42),a=i(33),o=i(54),r=i(96),c=i(121);class l extends o.BaseDialogUIProvider{getTitle(){return"Export Map"}applyProps(e){super.applyProps(e),this.textArea.setText(e.saveData)}createContent(e){return this.textArea=new c.TextArea(e,{readOnly:!0,autoSelectAll:!0}),new r.Column(e,{spacing:16},[new a.Label(e,"This is your map. Keep it somewhere safe!"),this.textArea])}getButtons(){return[{text:n.DialogButtons.OK,role:s.DialogButtonRole.Regular}]}handleClose(e){super.handleClose(e),this.textArea.destroy()}}t.ExportMapDialog=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoadGameDialog=void 0;const n=i(41),s=i(42),a=i(33),o=i(54),r=i(96),c=i(121),l=i(23);class d extends o.BaseDialogUIProvider{constructor(){super(...arguments),this.onLoad=l.noop}getTitle(){return"Load Game"}applyProps(e){super.applyProps(e),this.onLoad=e.onLoad,this.textArea.setText("")}createContent(e){return this.textArea=new c.TextArea(e,{readOnly:!1}),new r.Column(e,{spacing:16},[new a.Label(e,"Paste your map data in the text area below:"),this.textArea])}getButtons(){return[{text:n.DialogButtons.Cancel,role:s.DialogButtonRole.Regular},{text:n.DialogButtons.Load,role:s.DialogButtonRole.PrimaryDanger}]}handleClose(e){super.handleClose(e),e===n.DialogButtons.Load&&this.onLoad(this.textArea.text.trim()),this.textArea.destroy()}}t.LoadGameDialog=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OopsDialog=void 0;const n=i(41),s=i(42),a=i(33),o=i(54);class r extends o.BaseDialogUIProvider{getTitle(){return"Oops!"}applyProps(e){super.applyProps(e),this.label.setText(e.message)}createContent(e){return this.label=new a.Label(e,"Something went wrong :("),this.label}getButtons(){return[{text:n.DialogButtons.OK,role:s.DialogButtonRole.Regular}]}}t.OopsDialog=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AbandonLevelDialog=void 0;const n=i(41),s=i(42),a=i(54),o=i(33);class r extends a.BaseDialogUIProvider{getTitle(){return"Abandon game"}createContent(e){return this.label=new o.Label(e,"Are you sure you want to give up your progress on this island?"),this.label}getButtons(){return[{text:n.DialogButtons.Cancel,role:s.DialogButtonRole.Regular},{text:n.DialogButtons.GiveUp,role:s.DialogButtonRole.PrimaryDanger}]}applyProps(e){super.applyProps(e),e.message&&this.label.setText(e.message)}}t.AbandonLevelDialog=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EditMapJSONDialog=void 0;const n=i(54),s=i(121),a=i(41),o=i(96),r=i(33),c=i(42),l=i(75),d=i(0),h=i(31);class u extends n.BaseDialogUIProvider{getTitle(){return"Edit map JSON data"}applyProps(e){super.applyProps(e),this.gameState=e.gameState;const t=JSON.stringify(this.gameState,null,2);this.textArea.setText(t),this.validate(t)}createContent(e){return this.textArea=new s.TextArea(e,{width:d.inject.device.screenWidth-200,height:d.inject.device.screenHeight-300,autoSelectAll:!1,onChange:this.validate.bind(this),customCss:"font-family: monospace, monospace;font-size:8pt"}),this.statusLabel=new r.Label(e,"Sanity check OK!"),new o.Column(e,{spacing:16},[this.textArea,this.statusLabel])}getButtons(){return[{text:a.DialogButtons.Cancel,role:c.DialogButtonRole.Regular},{text:a.DialogButtons.Save,role:c.DialogButtonRole.PrimaryGreen}]}handleClose(e){var t;super.handleClose(e),e===a.DialogButtons.Save&&(this.validate(this.textArea.text)?(d.inject.gameStateModel.restore(this.gameState),d.inject.scene.worldMap.scene.isActive()&&(null===(t=d.inject.scene.worldMap)||void 0===t||t.syncState(d.inject.currentGameState))):d.inject.audio.playEffect(h.SoundEffects.Deny)),this.textArea.destroy()}validate(e){let t;try{t=JSON.parse(e)}catch(e){return this.statusLabel.setText("Invalid JSON: "+e.message.replaceAll("\n","\\n")),!1}try{(0,l.decompressGameState)(t)}catch(e){return this.statusLabel.setText("Invalid GameState: "+e.message.replaceAll("\n","\\n")),!1}return this.statusLabel.setText("Sanity check OK!"),this.gameState=t,!0}}t.EditMapJSONDialog=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionsLedger=void 0;const n=i(25),s=i(2),a=i(0);i(1).logger.for("RegionsLedger");t.RegionsLedger=class{constructor(){this.ledger=[],this.visited=new Set}get availableRegions(){return this.ledger}refreshAvailableRegions(e){const t=n.CurrentPhase.model(e).faction;s.assert.defined(t),this.ledger=t.getRegions().filter(e=>e.exists&&e.isAlive()).sort((e,t)=>t.size-e.size),this.ledger.filter(e=>!e.isActionable()).forEach(e=>this.visited.add(e)),this.updateDebugData()}regionVisited(e){this.visited.add(e),this.updateDebugData()}reset(e){this.visited.clear(),this.refreshAvailableRegions(e)}updateDebugData(){a.inject.debugData.set("regionsLedger",a.inject.ui.regionsLedger.toDebugString())}getNextPendingRegion(){return this.getPendingRegions()[0]}getPendingRegions(){return this.ledger.filter(e=>!this.visited.has(e))}getNext(e){if(!e)return this.ledger[0];const t=this.ledger.indexOf(e);return this.ledger[(t+1)%this.ledger.length]}getPrevious(e){if(!e)return this.ledger[this.ledger.length-1];const t=this.ledger.indexOf(e);return 0===t?this.ledger[this.ledger.length-1]:this.ledger[t-1]}isVisited(e){return this.visited.has(e)}isPending(e){return!this.visited.has(e)}hasPendingRegions(){return this.getPendingRegions().length>0}toDebugString(){return Array.from(this.ledger).map(e=>e.id+(this.visited.has(e)?"":"*")).join(",")}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.GameAppController=void 0;const s=i(0),a=i(16),o=i(1),r=i(6),c=i(319),l=i(325),d=i(120),h=i(3),u=i(122),g=i(181),p=i(77),m=i(183),f=i(68),y=i(127),v=i(191),w=i(386),b=i(397),S=i(98),x=i(398),P=i(399),T=i(404),M=i(202),C=i(405),I=i(40),O=i(410),_=i(411);o.logger.for("AppController");t.GameAppController=class{getScenes(){return[m.PreloadScene,T.LevelSelectUIScene,C.LevelDetailUIScene,f.WorldMapScene,y.PlayScene,v.MapEditorScene,w.PlayUIScene,M.MenuHeaderUIScene,P.TitleScreenUIScene,O.GameOverScene,_.GlobalUIScene,g.ModalWindowScene,b.DebugScene,x.DebugHistoryScene]}run(){const{game:e,events:t,gameStateController:i}=s.inject;s.inject.config.watchFuture(t=>{t.debug.overlay?(e.scene.run(a.Scenes.Debug),"string"==typeof t.debug.overlay&&u.commands.debug.dataSet(t.debug.overlay)):e.scene.isActive(a.Scenes.Debug)&&e.scene.sleep(a.Scenes.Debug)}),t.on(r.SystemEvents.EngineInitialized,()=>n(this,void 0,void 0,(function*(){const t=yield s.inject.mapRegistry.getCampaignById("intro");s.inject.ui.selectedCampaign.set(t);s.inject.userData.recallChoice("latestLevelId");e.scene.run(a.Scenes.GlobalUI),s.inject.navigator.goTo(s.inject.screen.title),s.inject.config.debug.overlay&&e.scene.run(a.Scenes.Debug)}))),t.on(r.UserActions.OpenExportMapDialog,()=>{const e=s.inject.gameStateModel.exportState();e.currentPhase={turnNumber:1,faction:1,type:h.PhaseTypes.FactionTurn,tappedUnits:[]};const t=(0,S.encodeGameState)(e);s.inject.modals.show(p.UI.exportMap,{saveData:t},()=>{})}),t.on(r.UserActions.EditMapJSON,()=>{var e;const t=s.inject.gameStateModel.exportState();null===(e=s.inject.scene.mapEditor.input)||void 0===e||e.keyboard.disableGlobalCapture(),s.inject.modals.show(p.UI.editMapJSONDialog,{gameState:t},e=>{var t;null===(t=s.inject.scene.mapEditor.input)||void 0===t||t.keyboard.enableGlobalCapture()})}),t.on(r.UserActions.OpenLoadGameDialog,()=>{s.inject.modals.show(p.UI.loadGame,{onLoad:e=>{try{if(!e)return void s.inject.modals.show(p.UI.oopsMessage,{message:"Looks like you didn't enter any map data. Try again!"});const t=(0,S.decodeGameState)(e);i.loadState(t,I.NewGameStateContext.LoadingGame),(0,d.saveGame)("restart"),s.inject.userData.saveLevelProgress()}catch(e){console.error(e),s.inject.modals.show(p.UI.oopsMessage,{message:"Looks like the save data is corrupted or incompatible\nwith this version of the game. Sorry!"})}}})}),t.on(r.UserActions.OpenNewGameDialog,()=>{s.inject.modals.show(p.UI.newGameDialog,{defaultValues:s.inject.userData.recallChoice("newGameOptions"),onNewGame:e=>{s.inject.events.trigger(r.UserActions.StartNewGame(e))}})}),t.on(r.UserActions.EditMap,()=>{s.inject.userData.saveLevelProgress(),s.inject.navigator.goTo(s.inject.screen.mapEditor)}),t.on(r.UserActions.StartNewGame,e=>n(this,void 0,void 0,(function*(){yield(0,c.generateMap)(e),i.loadState(s.inject.gameStateModel.state,I.NewGameStateContext.StartingNewGame),(0,d.saveGame)("restart"),s.inject.screen.play.activationContext=I.NewGameStateContext.StartingNewGame,s.inject.navigator.goTo(s.inject.screen.play)}))),t.on(r.UserActions.RevertTurn,e=>{const t=i.lastTurnState;i.loadState(t,I.NewGameStateContext.LoadingGameStateForDebug)}),t.on(r.UserActions.LoadGame,e=>{const t=(0,l.loadGame)(e);i.loadState(t,I.NewGameStateContext.LoadingGame),s.inject.config.autoSaveOnTurnStart&&"auto"!==e&&s.inject.userData.saveLevelProgress(),s.inject.navigator.goTo(s.inject.screen.play)}),t.on(r.UserActions.SyncWithModel,e=>{i.loadState(i.currentState,I.NewGameStateContext.LoadingGameStateForDebug)}),t.on(r.UserActions.SaveGame,e=>{(0,d.saveGame)(e)}),t.on(r.UserActions.DebugGameState,e=>{i.loadState(e,I.NewGameStateContext.LoadingGameStateForDebug)})}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.generateMap=void 0;const s=i(320),a=i(322),o=i(0),r=i(29),c=i(37);t.generateMap=function(e){return n(this,void 0,void 0,(function*(){const t=(0,r.getBlankGameState)(e),i=o.inject.gameStateModel;i.restore(t),i.useProjections(c.ProjectionPresets.coreEntities);for(let t=0;t<e.players.length;++t)i.factions.create({name:"Player "+(t+1),landColor:t,controller:e.players[t]});(0,s.generateLandmass)(i,e.shape,e),i.regions.all().length>0&&(yield(0,a.generateRegions)(i,e.regions,e)),i.activateAllProjections()}))}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.island=t.blank=t.plains=t.generateLandmass=t.landGenerators=void 0;const s=n(i(321)),a=i(0),o=i(1),r=i(37),c=i(2),l=o.logger.for("generateLandmass");function d(e){var t;e.regions.clear(),null===(t=e.factions.byId(0))||void 0===t||t.addNewRegion("land",e.map.getInnerHexes())}function h(e){e.regions.clear()}function u(e){var t;const i=e.map.innerWidth*e.map.innerHeight*.3,n=a.inject.random,o=t=>{return(d.simplex2(t.x/10,t.y/10)+1)*(i=t.x/e.map.innerWidth,n=t.y/e.map.innerHeight,1-2*((.5-i)*(.5-i)+(.5-n)*(.5-n)))>=.5;var i,n};let r,c,d,h=0;do{l.info(`Generating new random map (attempt #${h+1})`),c=n.integer(0,65535),d=new s.default.Noise(c);if(r=e.map.getInnerHexes().filter(o).components().getLargestGroup(),++h,l.info(`Map generated (${null==r?void 0:r.length} hexes, target is at least ${i})`),h>49)throw Error("Failed to generate suitable world after 50 iterations")}while(!r||r.length<i);null===(t=e.factions.byId(0))||void 0===t||t.addNewRegion("land",r)}t.landGenerators={blank:h,plains:d,island:u},t.generateLandmass=function(e,i,n){const s=t.landGenerators[i];(0,c.assert)(s,`unrecognized land generation strategy "${i}", expected one of ${Object.keys(t.landGenerators)}`);const a=performance.now();e.useProjections(r.ProjectionPresets.coreEntities),s(e),l.info(`World shape generated in ${performance.now()-a} ms`)},t.plains=d,t.blank=h,t.island=u},,function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.splitAndCleanupRegions=t.generateRegions=t.regionGenerators=void 0;const s=i(1),a=i(37),o=i(323),r=i(2),c=i(324),l=s.logger.for("mapgen:regions");function d(e){const t=e.regions.all().filter(e=>0===e.size);e.regions.destroy(...t),e.regions.all().forEach(t=>t.updateFrom(e.state).splitIntoComponents())}t.regionGenerators={balancedChaos:c.balancedChaos,duel:o.duel},t.generateRegions=function(e,i,s={}){return n(this,void 0,void 0,(function*(){const n=t.regionGenerators[i];(0,r.assert)(n,`unrecognized regions generation strategy "${i}", expected one of ${Object.keys(t.regionGenerators)}`);const o=performance.now();e.useProjections(a.ProjectionPresets.coreEntities),yield n(e,s),d(e),l.info(`Regions assigned in ${performance.now()-o} ms`)}))},t.splitAndCleanupRegions=d},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.duel=void 0;const s=i(179),a=i(12),o=i(3),r=i(2),c=i(0);t.duel=function(e,t){return n(this,void 0,void 0,(function*(){const i=e.regions.all()[0];r.assert.defined(i,"map generator expects the first region in regions.all() to represent available landmass, but no regions were found");const n=i.hexes;(0,r.assert)(n.length);const l=e.factions.all().filter(e=>e.controller!=o.FactionController.None),d=n.findInnerMostHex();r.assert.defined(d);let h=new s.DistanceMap(n);h.addSources(d);let u=h.getMostDistantHex();h=new s.DistanceMap(n);let g={};for(let e of l.reverse()){let i=u;r.assert.defined(i),p(i,t.homeRegionSize||12,e),g[e.id]=i,u=h.getMostDistantHex()}if(!1!==t.secondaryTowns){let e=[];for(let t of l.reverse()){const t=h.getMostDistantHex();r.assert.defined(t),h.addSources(t),e.push(t)}let t=a.HexGroup.from(e);for(let e of l.reverse()){const i=new s.DistanceMap(n);i.addSources(g[e.id]);const a=t.findMax(e=>i.getDistanceTo(e));r.assert.defined(a),t=t.without(a),p(a,6,e)}}function p(t,i,s){let a=i,r=n.floodFillFrom(t,(t,i,n)=>{var s;return(null===(s=e.factions.byHex(t))||void 0===s?void 0:s.controller)===o.FactionController.None&&(a--,a>0)});var l;h.addSources(t),s.addNewRegion(c.inject.random.townName(),r),l=t,e.pawns.create({hex:l,type:o.PawnType.Town}),e.pawns.create({hex:l,type:o.PawnType.Palisade})}}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.balancedChaos=t.DEFAULT_OPTIONS=void 0;const s=i(179),a=i(12),o=i(3),r=i(2),c=i(1),l=i(0);t.DEFAULT_OPTIONS={regionSize:3,townSpacing:2,humanPlayerHandicap:0,townsPerFaction:99};c.logger.for("mapgen:regions");t.balancedChaos=function(e,i){return n(this,void 0,void 0,(function*(){const n=Object.assign(Object.assign({},t.DEFAULT_OPTIONS),i),c=e.regions.all()[0];r.assert.defined(c,"map generator expects the first region in regions.all() to represent available landmass, but no regions were found");const d=c.hexes;(0,r.assert)(d.length);d.length;const h=d.findInnerMostHex();r.assert.defined(h);let u=new s.DistanceMap(d);u.addSources(h);const g=e.factions.all().filter(e=>e.controller!=o.FactionController.None),p=g.map(e=>e.addNewRegion(l.inject.random.townName(),a.HexGroup.empty));let m=a.HexGroup.empty,f=0,y=u.getMostDistantHex();for(u=new s.DistanceMap(d);u.getDistanceTo(y)>n.townSpacing||n.townSpacing>1&&0!==f;)r.assert.defined(y),u.addSources(y),f=(f+1)%g.length,m=m.with(y),y=u.getMostDistantHex();for(f=0;f<6;++f)u.addSources(y),m=m.with(y),y=u.getMostDistantHex();const v=Array.from({length:g.length},()=>new s.DistanceMap(d));f=l.inject.random.integer(0,g.length-1);let w=n.townsPerFaction*g.length,b=0;for(;m.length>6;){let e;e=b<g.length?l.inject.random.hex(m):m.findMax(e=>v[f].getDistanceTo(e));x(e,l.inject.random.integer(n.regionSize-1,n.regionSize+1)-(g[f].controller===o.FactionController.LocalUser?n.humanPlayerHandicap:0),f),v[f].addSources(e),m=m.without(e),f=(f+1)%g.length,++b,--w}let S=l.inject.random.shuffle(c.hexes.members);for(let t of S){const i=new Set(p);t.neighbours().forEach(t=>{const n=e.regions.byHex(t);n&&i.size>1&&i.delete(n)});Array.from(i).reduce((e,t)=>t.size*(0===f?.8:1)<e.size?t:e).addHexes(t)}function x(t,i,n){let s=i,a=t;for(;s>0;){let t=a.neighbours().filter(t=>e.regions.byHex(t)===c&&!m.contains(t));if(0===t.length)break;a=a.with(l.inject.random.hex(t)),s--}var r,d;p[n].addHexes(a),w>0&&(r=t,d=a.length,e.pawns.create({hex:r,type:o.PawnType.Town}),e.pawns.create({hex:r,type:o.PawnType.Coins,count:7+d}))}}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.savedGameExists=t.loadGame=void 0;const n=i(8),s=i(120);t.loadGame=function(e){const t=localStorage.getItem(s.SAVE_GAME_LOCAL_STORAGE_PREFIX+e);if(!t)throw new Error(`no data found for save "${e}"`);let i;try{i=JSON.parse(t)}catch(e){throw new Error("save data corrupted")}if(i.version!==n.CORE_GAMESTATE_SCHEMA_VERSION)throw new Error("save data not compatible with current version of the game");return i},t.savedGameExists=function(e){return!!localStorage.getItem(e)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createDiplomacyDebugLayer=void 0;const n=i(46),s=i(88),a=i(18),o=i(14),r=i(0),c=i(3);t.createDiplomacyDebugLayer=function(){return new n.GameStateDebugLayer((0,s.regionBasedAdapter)({getDetail(e,t){const i=o.Factions.getByRegion(e,t);if(!i)return;a.AI.getFactionAttrition(e,i);const n=o.Factions.model(e).all().filter(e=>e.controller!==c.FactionController.None&&e.id!==i).map(t=>{const n=t.id,s=r.inject.views.fear.getComponents(e,{fromFactionId:i,towardsFactionId:n});return{id:n,theirApprovalOfMe:a.AI.getFactionApproval(e,n,i),myApprovalOfThem:a.AI.getFactionApproval(e,i,n),theirAttitudeToMe:a.AI.getFactionAttitude(e,n,i),myAttitudeToThem:a.AI.getFactionAttitude(e,i,n),theirFearOfMe:r.inject.views.fear.getComponents(e,{fromFactionId:i,towardsFactionId:n}),myFearOfThem:s,theirTotalAttrition:a.AI.getFactionAttrition(e,n),theirAttritionInflictedByMe:a.AI.getFactionAttrition(e,n,i),myAttritionInflictedByThem:a.AI.getFactionAttrition(e,i,n)}});return`[Faction ${i}]\nWho I like:\n${n.sort((e,t)=>t.myApprovalOfThem-e.myApprovalOfThem).map(e=>` - ${e.myAttitudeToThem} (${e.myApprovalOfThem}) towards F${e.id} (they are ${e.theirAttitudeToMe} (${e.theirApprovalOfMe}))`).join("\n")}\nWho I fear:\n${n.sort((e,t)=>t.myFearOfThem.fear.totalFear-e.myFearOfThem.fear.totalFear).map(e=>` - F${e.id}: ${e.myFearOfThem.fear.totalFear} (power ${e.myFearOfThem.rivalFactionPower} vs my ${e.myFearOfThem.myPower})\n     their alliance (${e.myFearOfThem.rivalAllianceMembers.join(",")}) domination ${e.myFearOfThem.rivalAlliancePower}/${e.myFearOfThem.totalPower} (compared to my ${e.myFearOfThem.myAlliancePower})`).join("\n")}\nWho has been fighting me:\n${n.sort((e,t)=>t.myAttritionInflictedByThem-e.myAttritionInflictedByThem).filter(e=>e.myAttritionInflictedByThem>0).map(e=>` - F${e.id} inflicted ${e.myAttritionInflictedByThem} attrition`).join("\n")}\nWho have I been fighting:\n${n.sort((e,t)=>t.theirAttritionInflictedByMe-e.theirAttritionInflictedByMe).filter(e=>e.myAttritionInflictedByThem>0).map(e=>` - F${e.id} received ${e.theirAttritionInflictedByMe} attrition`).join("\n")}`},getValue(e,t){const i=o.Factions.getByRegion(e,t);if(i)return i}}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Window=void 0;var n=Phaser.GameObjects.Image;const s=i(0),a=i(28),o=i(53),r=i(33),c=i(93),l=i(119),d=i(182),h=i(22),u={horizontal:10,top:55,bottom:10},g={horizontalOverlap:6,verticalOffset:4,strapsVerticalOffset:6,strapsVisibleWidth:30};class p extends l.GameObjectUiElement{constructor(e,t){super(e),this.scene=e,this.container=new h.ResponsiveContainer(this.scene),this.debugLayer=new c.UiDebugLayer(this.scene,this.container),this.headerLeftStrap=new n(this.scene,0,0,"atlas","ui/ribbon/window-header/straps").setFlipX(!0).setOrigin(1,0),this.headerRightStrap=new n(this.scene,0,0,"atlas","ui/ribbon/window-header/straps"),this.headerText=new r.Label(this.scene,"",{color:16777215,align:"center",shadow:!0}),this.tweener=new d.BasicTweener,this.props={title:""},this.chrome=new a.Box(e,a.BoxTexture.WindowFrame),this.headerRibbon=new o.Ribbon(e,o.RibbonTexture.WindowHeader),this.container.add([this.headerLeftStrap,this.headerRightStrap,this.chrome,this.headerRibbon,this.headerText.getGameObject()]),this.setProps(t)}animateIn(){this.container.addToDisplayList();const e=[];e.push(this.scene.tweens.add({targets:this.getGameObject(),scale:{from:.1,to:1},duration:400,ease:"Back.easeOut"}));const t=this.headerLeftStrap.x;this.headerLeftStrap.x=t+24,e.push(this.scene.tweens.add({targets:this.headerLeftStrap,x:t,duration:400,ease:"Sine.easeIn"}));const i=this.headerRightStrap.x;this.headerRightStrap.x=i-24,e.push(this.scene.tweens.add({targets:this.headerRightStrap,x:i,duration:400,ease:"Sine.easeIn"})),this.tweener.setTweens(e)}animateOut(){this.tweener.setTweens([this.scene.tweens.add({targets:this.getGameObject(),scale:{from:1,to:.1},duration:200,ease:"Sine.easeOut"})],()=>this.container.removeFromDisplayList())}getGameObject(){return this.container}destroy(){this.container.destroy(),this.chrome.destroy()}setProps(e){this.props=e,this.headerText.setText(e.title),e.content&&this.setContent(e.content),this.reflow()}setContent(e){this.contentElement!==e&&(this.contentElement&&(this.container.remove(this.contentElement.getGameObject()),this.contentElement.getGameObject().removeFromDisplayList()),this.contentElement=e,this.contentElement.addTo(this.container),this.contentElement.onResize(()=>{this.reflow()})),this.reflow()}reflow(){if(!this.contentElement)return;const e={x:-this.contentElement.width/2-u.horizontal,y:-this.contentElement.height/2-u.top},t=this.contentElement.width+2*u.horizontal,i=this.contentElement.height+u.top+u.bottom;this.headerText.setPosition(-this.headerText.width/2,e.y+g.verticalOffset+9),this.chrome.setPosition(e.x,e.y),this.chrome.setSize(t,i),this.headerRibbon.setPosition(e.x-g.horizontalOverlap,e.y+g.verticalOffset),this.headerRibbon.width=t+2*g.horizontalOverlap,this.headerLeftStrap.setPosition(e.x-g.horizontalOverlap-g.strapsVisibleWidth,e.y+g.verticalOffset+g.strapsVerticalOffset),this.headerRightStrap.setPosition(e.x+t+g.horizontalOverlap-this.headerRightStrap.width+g.strapsVisibleWidth,e.y+g.verticalOffset+g.strapsVerticalOffset),this.contentElement.setPosition(e.x+u.horizontal,e.y+u.top),this.debugLayer.clear(),s.inject.config.debug.uiLayout&&this.debugLayer.addRect(e.x,e.y,t,i).addRectAround(this.contentElement,c.DebugColors.green).addRectAround(this.headerText,c.DebugColors.red)}}t.Window=p},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapDebugOverlay=void 0;const n=i(1),s=i(0),a=i(39),o=i(34),r=i(15),c=i(4);n.logger.for("WorldMapDebugOverlay");t.WorldMapDebugOverlay=class{constructor(e){this.scene=e,this.signalSubs=[],this.hexDebugLabels={},this.active=!1,this.arrowsGroup=this.scene.add.group({defaultKey:"atlas",defaultFrame:"debug-arrow"}).setDepth(o.WorldLayers.DebugOverlay),this.chunkRectangles=this.scene.add.group({classType:Phaser.GameObjects.Rectangle,createCallback:e=>{const t=e;t.setStrokeStyle(1,65280,.5),t.setDepth(o.WorldLayers.DebugOverlay)}})}showDebugLayer(e){this.clearDebugLayer(),this.activeDebugLayer=e;const t=this.scene;if(e){s.inject.gameStateModel.map;const i=e.getMap();i.getHexIds().forEach(e=>{const n=(0,c.getHex)(e),s=i.get(n.id);null!=s&&(this.hexDebugLabels[e]?this.hexDebugLabels[e].setVisible(!0).setText(s.toString()):this.hexDebugLabels[e]=function(e,i){return new r.DebugTextBox(t,e.display.centerX,e.display.centerY,i,{origin:[.5,.5],backgroundOpacity:1}).setDepth(o.WorldLayers.DebugOverlay)}(n,s.toString()))});const n=e.getArrows&&e.getArrows();null==n||n.forEach(e=>{const[t,i]=(0,c.getHexes)(e).members,n=t.getAngleTowards(i);if(void 0===n)return;const s=(t.display.centerX+i.display.centerX)/2,a=(t.display.centerY+i.display.centerY)/2;this.arrowsGroup.get(s,a).setActive(!0).setVisible(!0).setDepth(o.WorldLayers.DebugOverlay).setRotation(n)})}}clearDebugLayer(e){var t;this.activeDebugLayer&&(this.activeDebugLayer=void 0,null===(t=this.debugLayerSub)||void 0===t||t.unsubscribe(),e?(Object.values(this.hexDebugLabels).forEach(e=>e.destroy()),this.hexDebugLabels={}):Object.values(this.hexDebugLabels).forEach(e=>e.setVisible(!1)),this.arrowsGroup.getChildren().forEach(e=>this.arrowsGroup.killAndHide(e)))}create(){this.active=!0,this.hexUnderCursor=this.scene.add.polygon(0,0,a.HEX_POLYGON).setStrokeStyle(2,255).setVisible(!1).setDepth(o.WorldLayers.DebugOverlay).setOrigin(0,0),this.registerSignals()}registerSignals(){this.unRegisterSignals(),this.signalSubs.push(s.inject.ui.hexUnderCursor.watch(e=>{e?(this.hexUnderCursor.setPosition(e.x*a.HEX_WIDTH,e.y*a.HEX_INNER_HEIGHT),this.hexUnderCursor.setVisible(!0)):this.hexUnderCursor.setVisible(!1)})),s.inject.config.watchFuture(this.applyConfig.bind(this))}applyConfig(e){var t;null===(t=this.worldBoundsRectangle)||void 0===t||t.setVisible(!!e.debug.overlay)}unRegisterSignals(){this.signalSubs.forEach(e=>e.unsubscribe()),this.signalSubs=[]}redrawWorldBoundsRectangle(e){this.worldBoundsRectangle&&this.worldBoundsRectangle.destroy(),s.inject.config.debug.overlay&&(this.worldBoundsRectangle=this.scene.add.rectangle(e.x,e.y,e.width,e.height).setStrokeStyle(1,255,1).setDepth(o.WorldLayers.DebugOverlay).setOrigin(0,0))}redrawChunkRectangles(e){this.chunkRectangles.getChildren().forEach(e=>this.chunkRectangles.killAndHide(e)),s.inject.config.debug.chunkBorders&&e.map(e=>e.boundingBox).forEach(e=>{const t=this.chunkRectangles.get(e.x,e.y);t.setSize(e.width,e.height),this.scene.add.existing(t)})}destroy(e){this.unRegisterSignals(),this.clearDebugLayer(!0),this.active=!1,[this.worldBoundsRectangle,this.hexUnderCursor].forEach(e=>null==e?void 0:e.destroy())}setVisible(e){this.active!==e&&(e?this.create():this.destroy())}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapCameraController=void 0;const s=i(330),a=i(331),o=i(184),r=i(0),c=i(61);var l=Phaser.Geom.Rectangle;t.WorldMapCameraController=class{constructor(e){this.camera=e,this.scrollController=new s.CameraScrollController(this.camera),this.zoomController=new a.CameraZoomController({defaultZoomLevelIndex:r.inject.ui.scale,camera:this.camera}),this.viewPortMargins={left:0,right:0,top:0,bottom:0},this.camera.roundPixels=!0}setViewportMargins(e){const{x:t,y:i}=this.camera,n=Object.assign({left:0,right:0,bottom:0,top:0},e),s=(n.left-t)/this.camera.zoom,a=(n.top-i)/this.camera.zoom;this.viewPortMargins=n,this.updateViewPort(),this.updateBounds(),this.scrollController.cameraX.setTo(this.scrollController.cameraX.value+s),this.scrollController.cameraY.setTo(this.scrollController.cameraY.value+a)}updateBounds(){const e=r.inject.gameStateModel;this.worldBounds=(0,o.getWorldBounds)(e.map.width,e.map.height),r.inject.debugData.set("worldBounds",`${this.worldBounds.x},${this.worldBounds.y},${this.worldBounds.width},${this.worldBounds.height}`),this.updateCameraBounds()}updateCameraBounds(e=this.camera.zoom){if(!this.worldBounds)return;const t=this.camera.width/2*r.inject.device.dpr,i=this.camera.height/2*r.inject.device.dpr,n=new l(this.worldBounds.x-t,this.worldBounds.y-i,this.worldBounds.width+2*t,this.worldBounds.height+2*i);return this.scrollController.setBounds(n),r.inject.debugData.set("camBounds",`${n.x},${n.y} -> ${n.width},${n.height}`),n}centerAboveControlPanel(e=0){return n(this,void 0,void 0,(function*(){this.updateBounds(),this.camera.preRender(),yield this.scrollController.panTo(this.worldBounds.centerX,this.worldBounds.height-this.camera.displayHeight/2+o.EXTRA_SPACE_FOR_CONTROL_PANEL/2,e)}))}center(e=0){return n(this,void 0,void 0,(function*(){this.updateBounds(),this.camera.preRender(),yield this.scrollController.panTo(this.worldBounds.centerX,this.worldBounds.centerY,e)}))}ensureRectVisible(e,t=40){return n(this,void 0,void 0,(function*(){let i=l.Clone(this.camera.worldView);const n=this.camera.zoom;i.bottom-=o.EXTRA_SPACE_FOR_CONTROL_PANEL/n,i=l.Inflate(i,-t,-t);if(!l.ContainsRect(i,e)){e=l.Inflate(e,t,t);const n=i.x-e.x,s=e.right-i.right,a=i.y-e.y,o=e.bottom-i.bottom;let r=i.centerX,d=i.centerY;e.width>i.width?r=e.left+e.width/2-i.width/2:n>0?r-=n:s>0&&(r+=s),e.height>i.height?d=e.top+e.height/2-i.height/2:a>0?d-=a:o>0&&(d+=o);const h=(0,c.manhattanDistance)({x:i.centerX,y:i.centerY},{x:r,y:d});yield this.scrollController.panTo(r,d,h)}}))}startDragScroll(){this.scrollController.startDrag()}stopDragScroll(){this.scrollController.stopDragging()}updateViewPort(){const e=this.viewPortMargins,t=(window.innerWidth-e.right-e.left)*r.inject.device.dpr,i=(window.innerHeight-e.top-e.bottom)*r.inject.device.dpr;this.camera.setViewport(e.left*r.inject.device.dpr,e.top*r.inject.device.dpr,t,i)}update(e,t){this.zoomController.update(e,t),this.scrollController.update(e,t)}fitMapIntoDEPRECATED(e,t=0){this.camera.setViewport(e.x,e.y,e.width,e.height),this.updateBounds(),this.scrollController.panTo(this.worldBounds.centerX,this.worldBounds.centerY,t)}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.CameraScrollController=void 0;const s=i(1),a=i(0),o=i(68),r=i(61),c=i(99);s.logger.for("ui:camera");t.CameraScrollController=class{constructor(e){this.camera=e,this.dragging=!1,this.dragMomentumX=0,this.dragMomentumY=0,this.drag=3e3,this.dragStartPosition={x:0,y:0},this.scene=this.camera.scene;const t=this;this.cameraX=new c.KineticValue(e.scrollX,{scene:this.scene,drag:this.drag,apply:e=>this.camera.scrollX=e,stops:{getNextFrom:e=>e<t.bounds.left?t.bounds.left:void 0,getPreviousFrom:e=>e>t.bounds.right-t.camera.width?t.bounds.right-t.camera.width:void 0}}),this.cameraY=new c.KineticValue(0,{drag:this.drag,scene:this.scene,apply:e=>{this.camera.scrollY=e},stops:{getNextFrom:e=>e<t.bounds.top?t.bounds.top:void 0,getPreviousFrom:e=>e>t.bounds.bottom-t.camera.height?t.bounds.bottom-t.camera.height:void 0}}),this.pointer=this.scene.input.activePointer,this.scene.input.on("pointermove",this.pointerDragHandler,this),this.scene.events.on("update",this.update,this)}detach(){this.scene.input.removeListener("pointermove",this.pointerDragHandler),this.scene.input.removeListener("update",this.update)}update(e,t){this.dragMomentumX*=.8,this.dragMomentumY*=.8,this.cameraX.update(e,t),this.cameraY.update(e,t)}startDrag(){this.dragging=!0,this.dragStartPosition={x:this.cameraX.value,y:this.cameraY.value},this.dragCursorIconOn(),this.cameraX.freeze(),this.cameraY.freeze()}panTo(e,t,i=0){return n(this,void 0,void 0,(function*(){const n=e-this.camera.width/2,s=t-this.camera.height/2;0===i?(this.cameraX.setTo(n),this.cameraY.setTo(s)):yield Promise.all([this.cameraX.tweenTo(n,i,"Sine.easeInOut"),this.cameraY.tweenTo(s,i,"Sine.easeInOut")])}))}dragCursorIconOn(){this.scene.game.canvas.style.cursor="grabbing"}dragCursorIconOff(){this.scene.game.canvas.style.cursor="default"}pointerDragHandler(e){if(this.dragging){if(!e.isDown)return a.inject.events.trigger(o.WorldMapEvents.PointerUp({flags:0})),this.cameraX.unfreeze(),void this.cameraY.unfreeze();const t=e.position.x-e.prevPosition.x,i=e.position.y-e.prevPosition.y;this.dragMomentumX-=10*t,this.dragMomentumY-=10*i,this.cameraX.setTo(this.cameraX.value-t/this.camera.zoom),this.cameraY.setTo(this.cameraY.value-i/this.camera.zoom)}}stopDragging(){if(this.dragging){this.dragging=!1;const e=(0,r.euclidDistance)(this.dragStartPosition,{x:this.cameraX.value,y:this.cameraY.value});return this.cameraX.unfreeze(),this.cameraY.unfreeze(),this.cameraX.accelerate(this.dragMomentumX),this.cameraY.accelerate(this.dragMomentumY),this.dragCursorIconOff(),e}return 0}setBounds(e){this.bounds=e,this.cameraX.unfreeze(),this.cameraY.unfreeze()}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CameraZoomController=void 0;const n=i(1),s=i(99);n.logger.for("ui:camera");t.CameraZoomController=class{constructor(e){this.camera=e.camera,this.scene=e.camera.scene,this.cameraDistance=new s.KineticValue(1/this.camera.zoom,{scene:this.scene,drag:20,min:.2,continueToNextStopThreshold:.1,stops:[.25,.5,1,1.5,2,3],apply:e=>this.camera.setZoom(1/e)})}applyScroll(e){0!==e&&this.cameraDistance.accelerate(.02*e)}update(e,t){this.cameraDistance.update(e,t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bgrSwap=t.TilesManager=void 0;const n=i(1),s=i(333),a=i(0);var o=Phaser.GameObjects.Image;const r=n.logger.for("TilesManager");t.TilesManager=class{constructor(e,t){this.scene=e,this.renderer=t,this.cinematics={},this.tilesByHexId={}}setTile(e,t){this.createOrUpdateTile(e,t)}syncWithModel(e,t,i=!1){if(i){Object.entries(this.tilesByHexId).filter(([e,i])=>i.active&&!t.containsId(Number(e))).forEach(([e,t])=>t.deactivate())}for(const i of t.members){const t=e.factions.byHex(i);t&&this.setTile(i,t)}}getByHex(e){return this.tilesByHexId[e]}addObjectToTile(e,t,i=0,n=0){const s=this.tilesByHexId[e];s?s.addObject(t,i,n):r.error(`Unable to place ${t} on hex ${e}, hex not present in the current rendering. Ignoring.`)}getAll(){return Object.values(this.tilesByHexId).filter(e=>e.active)}clear(){Object.values(this.tilesByHexId).forEach(e=>e.deactivate())}createOrUpdateTile(e,t){let i=this.tilesByHexId[e.id];if(i)i.activate(t);else{if(i=new s.Tile(this.renderer,e),a.inject.random.boolean(.75)){const e=a.inject.random.point(6);t.isNeutral()||i.addDecal(new o(this.renderer.scene,0,0,"atlas","hex-decals/grass").setTint(t.landColor).setFlipX(a.inject.random.boolean()),e.x,e.y)}this.tilesByHexId[e.id]=i}return i}};t.bgrSwap=e=>{const[t,i,n]=e.toString(16).padStart(6,"0").match(/[\w]{2}/g);return parseInt([n,i,t].join(""),16)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tile=void 0;var n=Phaser.GameObjects.Container;const s=i(39),a=i(34),o=i(124);function r(e){let t="(unknown)";return t=e instanceof n?e.constructor.name:e.frame.name,`\n- ${t}(#${(0,o.getObjId)(e)}  V:${e.visible?1:0} A:${e.alpha.toFixed(1)})`}t.Tile=class{constructor(e,t,i=0){this.renderer=e,this.hex=t,this.frame=i,this.attachedObjects=new Set,this.decals=new Set,this.active=!0}get baseDepth(){return a.WorldLayers.Tiles+this.bottom}get bottom(){return this.hex.y*s.HEX_INNER_HEIGHT+s.HEX_HEIGHT}get centerX(){return(this.hex.x+.5)*s.HEX_WIDTH}get centerY(){return this.hex.y*s.HEX_INNER_HEIGHT+.5*s.HEX_HEIGHT}addObject(e,t,i){this.attachedObjects.add(e),this.renderer.add(this.hex,e),e.setPosition(this.centerX+t,this.centerY+i).setDepth(a.WorldLayers.TileObjects+this.bottom-s.HEX_HEIGHT/2+i)}addDecal(e,t,i){e.setOrigin(.5,.5),this.decals.add(e),this.renderer.add(this.hex,e).setDepth(a.WorldLayers.TileDecals),e.setPosition(this.centerX+t,this.centerY+i)}removeObject(e){this.attachedObjects.delete(e),this.renderer.remove(this.hex,e)}activate(e){this.active||[...this.decals,...this.attachedObjects].forEach(e=>this.renderer.add(this.hex,e)),this.active=!0,e.isNeutral()?this.decals.forEach(e=>e.setVisible(!1)):this.decals.forEach(t=>{t.setVisible(!0),t.setTint(e.landColor)})}deactivate(){this.active=!1,this.attachedObjects.forEach(e=>e.setVisible(!1)),[...this.decals,...this.attachedObjects].forEach(e=>this.renderer.remove(this.hex,e))}toString(){return`[Tile #${this.hex.id}]`}getDebugData(){return`[Tile #${this.hex.id}]\nactive: ${this.active}\nattachedObjects:${Array.from(this.attachedObjects).map(r).join("")}\ndecals:${Array.from(this.decals).map(r)}\n`}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinsManager=void 0;const n=i(1),s=i(11),a=i(335),o=i(4),r=i(337),c=i(9),l=i(3),d=i(338);n.logger.for("CoinsManager");t.CoinsManager=class{constructor(e,t,i){this.scene=e,this.pools=t,this.tiles=i,this.cinematics={transactions:e=>new r.CoinTransactionCinematic(this,e),growStacks:e=>new d.GrowCoinStacksCinematic(this,e)},this.piles={}}spawnOnHex(e,t){this.getOrCreatePile(e).addCoins(t)}setAmount(e,t){if(0===t)this.destroyPileAt(e.id);else{this.getOrCreatePile(e).setAmount(t)}}syncWithModel(e){const t=e.pawns.select({type:[l.PawnType.Coins]}),i=new Set;for(const e of t)this.setAmount(e.hex,e.count),i.add(e.hex.id);for(const e in this.piles)i.has(Number(e))||this.destroyPileAt(Number(e))}applyTransactions(e){var t;const i={};for(let t of Object.keys(e).map(e=>Number(e))){const n=e[t];Object.entries(n.send).forEach(([e,t])=>{const n=Number(e);i[n]?i[n]+=t:i[n]=t})}const n=(0,s.stripDuplicatesFrom)(Object.keys(e).concat(Object.keys(i)).map(e=>Number(e)));for(let s of n){const n=e[s]||{spawn:0,send:[],consume:0},a=Object.values(n.send).reduce(c.sum,0),r=(null==n?void 0:n.spawn)+(null!==(t=i[s])&&void 0!==t?t:0)-a-n.consume;r>0?this.spawnOnHex((0,o.getHex)(s),r):r<0&&this.removeFromHex((0,o.getHex)(s),-r)}}removeFromHex(e,t){this.getOrCreatePile(e).deleteCoins(t)}getOrCreatePile(e){return(0,s.getOrCreate)(this.piles,e.id,()=>new a.CoinPile(this.pools,this.tiles,e))}getAllPiles(){return Object.values(this.piles)}destroyPileAt(e){const t=this.piles[e];t&&(t.destroy(),delete this.piles[e])}destroyCoins(){Object.values(this.piles).forEach(e=>{e.destroy()}),this.piles={}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinPile=void 0;const n=i(1),s=i(336),a=i(39),o=i(0),r=i(9),c=[{x:-8,y:10,maxSize:5},{x:-12,y:6,maxSize:10},{x:-8,y:-2,maxSize:15},{x:6,y:-2,maxSize:12},{x:0,y:-6,maxSize:20}],l=n.logger.for("CoinPile");t.CoinPile=class{constructor(e,t,i){this.pools=e,this.tiles=t,this.hex=i,this.stacks=[],this.overflowStack=new s.VirtualStack(this.pools)}getCurrentAmount(){return this.stacks.map(e=>e.currentAmount).reduce(r.sum,0)}addCoins(e){let t=e;for(;t>0;){const e=this.getOrCreateStackWithFreeCapacity();if(!e)return;e.remainingCapacity()>t?(e.addCoins(t),t=0):(t-=e.remainingCapacity(),e.addCoins(e.remainingCapacity()))}}setAmount(e){const t=e-this.getCurrentAmount();t>0?this.addCoins(t):t<0&&this.deleteCoins(-t)}deleteCoins(e){let t=e;for(;t>0;){const i=this.getLatestStack();if(!i)return void l.warning(`unable to delete ${e} coins from ${this.hex}, hex is already empty of coins`);i.currentAmount>t?(i.deleteCoins(t),t=0):(t-=i.currentAmount,i.deleteCoins(i.currentAmount,()=>{this.destroyStack(i)}),this.stacks.pop())}}getLatestStack(){return this.stacks[this.stacks.length-1]}storeCoins(e){let t=[...e];for(;t.length>0;){const e=this.getOrCreateStackWithFreeCapacity();if(!e)return void this.stacks[this.stacks.length-1].consumeCoins(t);{const i=t.splice(0,e.remainingCapacity());e.consumeCoins(i)}}}spawnCoin(){const e=this.getLatestStack();if(e&&0!==e.currentAmount){const t=e.spawnCoin();return 0===e.currentAmount&&(this.destroyStack(e),this.stacks.pop()),t}return l.warning(`Spawning coin from pile at ${this.hex}, but the pile is empty => new coin created from nothing`),this.pools.getCoin((this.hex.x+.5)*a.HEX_WIDTH,this.hex.y*a.HEX_INNER_HEIGHT+a.HEX_HEIGHT/2+o.inject.random.integer(-2,2))}destroy(){this.stacks.forEach(e=>{this.destroyStack(e)}),this.stacks=[]}getOrCreateStackWithFreeCapacity(){const e=this.stacks.find(e=>e.remainingCapacity()>0)||this.addStack();return e||l.warning(`Max displayable coin pile size exceeded at hex ${this.hex}. You have too much money!`),e}destroyStack(e){e.removeFromTile(this.tiles.getByHex(this.hex.id)),e.destroy()}addStack(){const e=c[this.stacks.length];if(!e){this.stacks.push(this.overflowStack),console.log("STACKS NOW",this.stacks);const e=this.tiles.getByHex(this.hex.id);return this.overflowStack.setPosition(e.centerX,e.centerY),this.overflowStack}const t=new s.CoinStack(this.pools,e.maxSize);return this.stacks.push(t),this.tiles.addObjectToTile(this.hex.id,t,e.x,e.y),t}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinStack=t.VirtualStack=t.COIN_SPRITE_SCALE=t.COIN_THICKNESS=t.COIN_FACE_SIZE=void 0;const n=i(0),s=i(1),a=i(34),o=i(124),r=i(23),c=i(2);var l=Phaser.GameObjects.Container;const d=s.logger.for("CoinStack");t.COIN_FACE_SIZE=5,t.COIN_THICKNESS=2,t.COIN_SPRITE_SCALE=.5;t.VirtualStack=class{constructor(e){this.pools=e,this.scene=this.pools.scene,this.currentAmount=0,this.x=0,this.y=0}setPosition(e,t){this.x=e,this.y=t}addCoins(e){this.currentAmount+=e}consumeCoins(e){this.currentAmount+=e.length,n.inject.ui.skipTransitions()?e.forEach(e=>this.pools.free(e)):e.forEach((e,t)=>{const i=this.y;e.setDepth(a.WorldLayers.FlyingObject+this.y-i),this.scene.tweens.add({targets:e,x:this.x,y:i,ease:"Sine.easeOut",duration:400,onComplete:()=>{this.pools.free(e)}})})}deleteCoins(e,t){this.currentAmount<e?(d.warning(`Attempted to delete ${e} coins from a virtual stack that already has only ${this.currentAmount} coins. Extra coins not deleted.`),this.currentAmount=0):this.currentAmount-=e}destroy(){}remainingCapacity(){return Number.POSITIVE_INFINITY}removeFromTile(e){}spawnCoin(){this.y;this.currentAmount-=1;return this.pools.getCoin(this.x,this.y)}};t.CoinStack=class extends l{constructor(e,t){super(e.scene,0,0),this.pools=e,this.capacity=t,this.currentAmount=0,(0,o.assignObjId)(this)}removeFromTile(e){e.removeObject(this)}remainingCapacity(){return this.capacity-this.currentAmount}acquireSprites(){this.column=this.pools.getCoinStack(0,0),this.topCoin=this.pools.getCoin(0,-t.COIN_THICKNESS),this.cropRect=new Phaser.Geom.Rectangle(0,this.column.height-t.COIN_THICKNESS,this.column.width,t.COIN_THICKNESS),this.column.setCrop(this.cropRect),this.add([this.column,this.topCoin])}acquireSpritesIfNeeded(){this.column||this.acquireSprites()}updateSize(){if(this.stopAllTransitions(),0!==this.currentAmount){const e=this.getTargetSize();this.acquireSpritesIfNeeded(),c.assert.defined(this.topCoin),c.assert.defined(this.column),this.topCoin.y=this.column.y-e,this.topCoin.setAlpha(this.currentAmount>0?1:0),this.cropRect=new Phaser.Geom.Rectangle(0,this.column.height-e/t.COIN_SPRITE_SCALE,this.column.width,e/t.COIN_SPRITE_SCALE),this.column.setCrop(this.cropRect)}else this.freeSpritesIfEmpty()}getTargetSize(){return this.getSizeForAmount(this.currentAmount)}getSizeForAmount(e){return 0===e?t.COIN_THICKNESS:e*t.COIN_THICKNESS+1}freeSpritesIfEmpty(){0===this.currentAmount&&(this.column&&(this.remove(this.column),this.pools.free(this.column),this.column=void 0),this.topCoin&&(this.remove(this.topCoin),this.pools.free(this.topCoin),this.topCoin=void 0))}stopAllTransitions(){this.currentTransition&&(this.currentTransition.forEach(e=>e.stop()),this.currentTransition=void 0)}transitionSize(){return new Promise(e=>{var i;let n=this.getTargetSize();const s=Math.abs(n-((null===(i=this.cropRect)||void 0===i?void 0:i.height)||0));if(0===s)return void e();const a=10*s;this.stopAllTransitions(),this.acquireSpritesIfNeeded(),c.assert.defined(this.column),this.currentTransition=[this.scene.tweens.add({targets:this.cropRect,height:n/t.COIN_SPRITE_SCALE,y:this.column.height-n/t.COIN_SPRITE_SCALE,duration:a,onUpdate:()=>this.column.setCrop(this.cropRect)}).on(Phaser.Tweens.Events.TWEEN_COMPLETE,()=>{this.freeSpritesIfEmpty(),e()}),this.scene.tweens.add({targets:this.topCoin,props:{y:{duration:a,value:this.column.y-n},alpha:{value:1,duration:0}}})]})}addCoins(e,t=r.noop){e>this.remainingCapacity()?(d.warning(`Attempted to add ${e} coins to a stack that already has ${this.currentAmount}/${this.capacity} coins. Extra coins not displayed.`),this.currentAmount=this.capacity):this.currentAmount+=e,n.inject.ui.skipTransitions()?(this.updateSize(),t()):this.transitionSize().then(t)}consumeCoins(e){this.currentAmount<this.capacity&&(this.currentAmount+=e.length),n.inject.ui.skipTransitions()?(e.forEach(e=>this.pools.free(e)),this.updateSize()):e.forEach((e,t)=>{const i=this.y-this.getSizeForAmount(this.currentAmount-t);e.setDepth(a.WorldLayers.FlyingObject+this.y-i),this.scene.tweens.add({targets:e,x:this.x,y:i,ease:"Sine.easeOut",duration:400,onComplete:()=>{this.pools.free(e),this.updateSize()}})})}spawnCoin(){this.acquireSpritesIfNeeded();const e=this.y-this.getTargetSize();this.currentAmount-=1;const t=this.pools.getCoin(this.x,e);return this.updateSize(),t}destroy(){this.stopAllTransitions(),this.currentAmount=0,this.freeSpritesIfEmpty(),super.destroy()}deleteCoins(e,t=r.noop){this.currentAmount<e?(d.warning(`Attempted to delete ${e} coins to a stack that already has only ${this.currentAmount}/${this.capacity} coins. Extra coins not deleted.`),this.currentAmount=0):this.currentAmount-=e,n.inject.ui.skipTransitions()?(this.updateSize(),t()):this.transitionSize().then(t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinTransactionCinematic=void 0;const n=i(48),s=i(4),a=i(39),o=i(0),r=i(34),c=i(185),l=i(2);i(1).logger.for("CoinTransactionCinematic");class d extends n.BaseCinematic{constructor(e,t){super(e.scene),this.coins=e,this.transactions=t}execute(e){const t=this.scene,i={},n={};let c=0;const d=this.transactions,h=this.coins;for(let e in d){const t=(0,s.getHex)(Number(e));l.assert.defined(t);const h=d[e],u=[];for(let e=0;e<h.spawn;++e){const e=this.coins.pools.getCoin((t.x+.5)*a.HEX_WIDTH,t.y*a.HEX_INNER_HEIGHT+a.HEX_HEIGHT/2+o.inject.random.integer(-2,2));e.setDepth(r.WorldLayers.FlyingObject+e.y),u.push(e),this.scene.add.existing(e),e.setAlpha(0)}o.inject.ui.skipTransitions()||this.animateCoinSpawn(u),c+=u.length,i[e]=u,n[e]=h.consume||0}if(o.inject.ui.skipTransitions())u(),g(),e&&e();else{const e=c>0?1e3:0;this.scene.time.addEvent({delay:e,callback:u})}function u(){let n=!1;for(let e in d){const t=(0,s.getHex)(Number(e));l.assert.defined(t);const a=d[e],o=Object.values(a.send).reduce((e,t)=>e+t,0);for(let n=a.spawn;n<o;++n){const n=h.getOrCreatePile(t).spawnCoin();n.setDepth(r.WorldLayers.FlyingObject-n.y),i[e].push(n),h.scene.add.existing(n)}for(let t in a.send){const o=(0,s.getHex)(Number(t)),r=a.send[t];l.assert.defined(o);const c=i[e];if(r>0){n=!0;h.getOrCreatePile(o).storeCoins(c.slice(0,r))}i[e]=i[e].slice(r)}if(i[e].length>0){h.getOrCreatePile(t).storeCoins(i[e])}}if(!o.inject.ui.skipTransitions()){const i=n?600:0;t.time.addEvent({delay:i,callback:g}),t.time.addEvent({delay:i+600,callback:e})}}function g(){for(let e in d){const t=(0,s.getHex)(Number(e));l.assert.defined(t);const i=d[e].consume;if(0===i)continue;h.getOrCreatePile(t).deleteCoins(i)}}}animateCoinSpawn(e){const t=e.map(()=>o.inject.random.integer(-100,100));e.forEach((e,i)=>{this.scene.time.addEvent({delay:t[i],callback:()=>{e.play("spin-coin")}})}),this.scene.tweens.add({targets:e,duration:500,y:"-=1",ease:c.jump,easeParams:[80],delay:(e,i,n,s)=>t[s],onComplete:()=>e.forEach(e=>{e.anims.stop(),e.setFrame(0)})}),this.scene.tweens.add({targets:e,duration:500,x:e=>e.x+o.inject.random.integer(-4,4),alpha:{from:0,to:1},delay:(e,i,n,s)=>t[s]})}}t.CoinTransactionCinematic=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GrowCoinStacksCinematic=void 0;const n=i(48),s=i(0),a=i(125),o=i(4);class r extends n.BaseCinematic{constructor(e,t){super(e.scene),this.coins=e,this.map=t,this.coinsByHex={},this.pilesHidden=!1}playAfter(e,t){return this.hidePiles(),super.playAfter(e,t)}execute(e=(()=>{})){this.hidePiles(),this.growPiles(e)}hidePiles(){this.pilesHidden||(this.pilesHidden=!0,s.inject.ui.withoutTransitions(()=>{for(let e of this.coins.getAllPiles()){const t=e.getCurrentAmount();this.coinsByHex[e.hex.id]=t,e.setAmount(0)}}))}growPiles(e){this.pilesHidden=!1;const t=1/s.inject.config.debug.tweenSpeedFactor,i=1e3*t,n=(0,a.createStaggeredDelay2Dfn)([{x:0,y:0},{x:this.map.width,y:this.map.height}],0,1e3*t,100*t);for(let e in this.coinsByHex){const t=(0,o.getHex)(Number(e)),i=this.coins.getOrCreatePile(t);setTimeout(()=>i.setAmount(this.coinsByHex[e]),n(t))}setTimeout(e,i)}}t.GrowCoinStacksCinematic=r},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsManager=t.PawnEffects=void 0;const s=i(1),a=i(340),o=i(341),r=i(186),c=i(81),l=i(342),d=i(0),h=i(3),u=i(2),g=i(48),p=i(76),m=i(13);!function(e){e.Jump="jump",e.SpawnFromAbove="spawn-from-above"}(t.PawnEffects||(t.PawnEffects={}));const f=s.logger.for("ui:PawnsManager");t.PawnsManager=class{constructor(e,t,i){this.scene=e,this.pools=t,this.tiles=i,this.cinematics={spawnFromAbove:new o.PawnSpawnFromAboveCinematic(this,{delay:0,maxDelay:1e3,height:40,delayNoise:100,duration:200}),defendTile:(e,t)=>new l.PawnTileDefenseCinematic(this,this.tiles,t,e)},this.pawnsByHex={},this.jumpingPawns=new Set,this.jumpClock=this.scene.tweens.addCounter({from:0,to:1,ease:"Linear",repeat:-1,duration:c.TIMING.pawnJumpDuration})}update(){this.jumpingPawns.forEach(e=>{if(this.hangingPawn===e||!e.image.visible)return;const t=(this.getJumpPhaseForPawn(e)+e.jumpingDeSync)%1;e.setJumpPhase(t),e.jumpingDeSync>0&&e.jumpingDeSync<=.5?e.jumpingDeSync-=.002:e.jumpingDeSync>=.998?e.jumpingDeSync=0:e.jumpingDeSync>.5&&(e.jumpingDeSync+=.002)})}getJumpPhaseForPawn(e,t=0){const i=e.baseY%c.TIMING.pawnJumpDuration/c.TIMING.pawnJumpDuration;return(this.jumpClock.getValue()+t/c.TIMING.pawnJumpDuration+i)%1}add(e,t,i,n){if(this.pawnsByHex[e]){const n=this.pawnsByHex[e];return n.setType(t,i),this.jumpingPawns.delete(n),f.warning(`Hex ${e} already contains a pawn sprite, replacing with ${t}`),g.BlankCinematic}{const s=new a.PawnObject(this,t,i),o=this.tiles.getByHex(e);return o?(s.attachToTile(o),this.pawnsByHex[e]=s,n&&!d.inject.ui.skipTransitions()?new y(this.scene,this.tiles,s,n,e):g.BlankCinematic):(f.error(`ignoring illegal request to attach pawn to hex #${e} - no tile available for this hex!`),g.BlankCinematic)}}syncWithModel(e,t){const i=e.pawns.all().filter(t),n={};this.clearAllJumping();for(const e of i)n[e.hex.id]=e;for(const t in this.pawnsByHex)if(n[t]){w(e,n[t]);this.pawnsByHex[t].setType(n[t].type,w(e,n[t]))}else this.destroy(Number(t));e.economy;for(const t of i)this.pawnsByHex[t.hex.id]||this.add(t.hex.id,t.type,w(e,t))}clear(){Object.keys(this.pawnsByHex).forEach(e=>{this.destroy(Number(e))}),this.pawnsByHex={}}getAll(){return Object.values(this.pawnsByHex)}destroy(e){const t=this.pawnsByHex[e];t?(t.destroy(),this.jumpingPawns.delete(t),this.hangingPawn===t&&(this.hangingPawn=void 0),delete this.pawnsByHex[e]):f.warning(`ignoring request to destroy pawn on hex ${e} - there's nothing there`)}move(e,t,i=c.PawnTravelSpeed.Normal){return n(this,void 0,void 0,(function*(){const n=this.pawnsByHex[e];if(n)return this.scene.tweens.killTweensOf([n.image]),n===this.hangingPawn&&this.clearHangingPawn(),this.pawnsByHex[t]&&(f.warning(`Hex ${t} already contains a pawn sprite, replacing with pawn from ${e})`),this.destroy(t)),n.image.visible&&!d.inject.ui.skipTransitions()?(this.stopJumping([e]),delete this.pawnsByHex[e],new v(this.scene,this.tiles,n,t,i).play().then(()=>{this.pawnsByHex[t]=n})):(this.pawnsByHex[t]=n,delete this.pawnsByHex[e],n.detachFromTile(),void n.attachToTile(this.tiles.getByHex(t)));f.warning(`No pawn attached to hex ${e}, ignoring move to ${e}->${t}`)}))}show(e){const t=this.pawnsByHex[e];t?(t.show(),this.jumpingPawns.has(t)&&(t.jumpingDeSync=this.getCurrentJumpingDeSyncForPawn(t))):f.warning(`Ignoring request to show pawn at hex ${e}, no such pawn exists`)}hide(e){const t=this.pawnsByHex[e];t?t.hide():f.warning(`Ignoring request to hide pawn at hex ${e}, no such pawn exists`)}getCurrentJumpingDeSyncForPawn(e,t=1){return(1+t-this.getJumpPhaseForPawn(e))%1}getPawnObjectPositionOnScreen(e,t){const i=this.pawnsByHex[t];if(i)return Object.assign(Object.assign({},(0,r.convertWorldXYToCameraXY)(e,i.image.x,i.image.y)),{scale:e.zoom*i.image.scale});{const i=this.tiles.getByHex(t);return u.assert.defined(i,`hex ${t} not found`),Object.assign(Object.assign({},(0,r.convertWorldXYToCameraXY)(e,i.centerX,i.centerY+3)),{scale:.5*e.zoom})}}setHangingPawn(e){const t=this.pawnsByHex[e];if(t!==this.hangingPawn&&(this.hangingPawn&&this.clearHangingPawn(),this.hangingPawn=t),!this.hangingPawn)return;const i=this.tiles.getByHex(e).centerY-10;this.hangingPawn.hideSymbol(),this.scene.tweens.add({targets:[t.image],duration:200,ease:"Sine.easeOut",y:i,onComplete:()=>{this.hangingPawn!==t&&this.resetJumpingState(t)}}),this.scene.tweens.add({targets:this.hangingPawn.shadow,duration:100,ease:"Sine.easeOut",scale:.5-a.PAWN_SHADOW_SCALE_AT_MAX_JUMP})}clearHangingPawn(){if(this.hangingPawn){this.hangingPawn.jumpingDeSync=this.getCurrentJumpingDeSyncForPawn(this.hangingPawn,.5),this.jumpingPawns.has(this.hangingPawn)||this.resetJumpingState(this.hangingPawn),this.hangingPawn.showSymbol(),this.hangingPawn=void 0}}beginJumping(e){e.map(e=>this.pawnsByHex[e]).forEach((t,i)=>{t?this.jumpingPawns.has(t)||(t.jumpingDeSync=this.getCurrentJumpingDeSyncForPawn(t),this.jumpingPawns.add(t)):f.warning(`Ignoring jump animation request for hex ${e[i]} - no pawn rendered on this hex`)})}clearAllJumping(){this.jumpingPawns.forEach(e=>this.resetJumpingState(e)),this.jumpingPawns.clear()}stopJumping(e){e.map(e=>this.pawnsByHex[e]).forEach((t,i)=>{t?(this.jumpingPawns.delete(t),this.resetJumpingState(t)):f.warning(`Ignoring stop jump animation request for hex ${e[i]} - no pawn rendered on this hex`)})}resetJumpingState(e){e.setJumpPhase(0)}replace(e,t,i){let n=this.pawnsByHex[e];n?n.setType(t,i):(f.warning(`Request to replace pawn at ${e} with ${t} but there is no existing pawn there => creating it`),this.add(e,t,i))}jumpOnce(e){let t=this.pawnsByHex[e];t?(this.scene.tweens.add({targets:t.image,y:{from:t.baseY,to:t.baseY-a.PAWN_JUMPING_HEIGHT},ease:"Sine.easeOut",duration:200,yoyo:!0}),this.scene.tweens.add({targets:t.shadow,scale:{from:.5,to:.2},ease:"Sine.easeOut",duration:200,yoyo:!0})):f.warning(`Request to play jump animation on ${e} ignored as there is no pawn there`)}getByHex(e){return this.pawnsByHex[e]}syncPawnVariant(e,t){const i=e.pawns.select({hexes:t,traits:[m.PawnTraits.OccupiesTile]});for(let t of i)this.replace(t.hex.id,t.type,w(e,t))}integrityCheck(){var e,t;if(null===(e=d.inject.config.debug.integrityChecks)||void 0===e?void 0:e.pawns)for(let e in this.pawnsByHex){const i=this.pawnsByHex[e];(0,u.assert)(!i.isDestroyed,`found destroyed ${i.type} at hex ${e} (v${null!==(t=i.variant)&&void 0!==t?t:"-"}) still in pawnsByHex collection`)}}};class y extends g.BaseCinematic{constructor(e,t,i,n,s){super(e),this.tiles=t,this.pawn=i,this.srcHex=n,this.destHex=s}execute(e){const t=this.tiles.getByHex(this.srcHex).centerX,i=this.tiles.getByHex(this.srcHex).centerY+3,n=this.tiles.getByHex(this.destHex).centerX,s=this.tiles.getByHex(this.destHex).centerY+3;this.scene.tweens.add({targets:[this.pawn.image,this.pawn.shadow],x:{from:t,to:n},y:{from:i,to:s},alpha:{from:0,to:1},duration:c.TIMING.pawnTravelDuration[c.PawnTravelSpeed.Normal],ease:"Sine.easeIn",onComplete:()=>e()})}}class v extends g.BaseCinematic{constructor(e,t,i,n,s=c.PawnTravelSpeed.Normal){super(e),this.tiles=t,this.pawn=i,this.destHex=n,this.travelSpeed=s}execute(e){const t=this.tiles.getByHex(this.destHex).centerX,i=this.tiles.getByHex(this.destHex).centerY+3;if(this.scene.tweens.add({targets:[this.pawn.image,this.pawn.shadow],x:{from:this.pawn.image.x,to:t},y:{from:this.pawn.image.y,to:i},duration:c.TIMING.pawnTravelDuration[this.travelSpeed],ease:"Sine.easeIn",onComplete:()=>{this.pawn.detachFromTile(),this.pawn.isDestroyed||this.pawn.attachToTile(this.tiles.getByHex(this.destHex)),e()}}),this.pawn.symbol){const e=i-3+a.SYMBOL_VERTICAL_OFFSET;this.scene.tweens.add({targets:this.pawn.symbol,x:t,y:e,duration:c.TIMING.pawnTravelDuration[this.travelSpeed],ease:"Sine.easeIn"})}}}function w(e,t){var i,n;if(t.type==h.PawnType.Town){const s=null!==(n=null===(i=e.regions.byHex(t.hex))||void 0===i?void 0:i.power.maxSustainableUnitMight)&&void 0!==n?n:1;return(0,p.cropNumber)(s,1,4)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnObject=t.PAWN_SHADOW_SCALE_AT_MAX_JUMP=t.PAWN_JUMPING_HEIGHT=t.SYMBOL_VERTICAL_OFFSET=void 0;const n=i(34),s=i(1),a=i(80),o=i(185),r=i(2);s.logger.for("ui:PawnsManager");t.SYMBOL_VERTICAL_OFFSET=-25,t.PAWN_JUMPING_HEIGHT=8,t.PAWN_SHADOW_SCALE_AT_MAX_JUMP=.2;t.PawnObject=class{constructor(e,t,i){this.manager=e,this.type=t,this.variant=i,this.isDestroyed=!1,this.isFloating=!1,this.symbolVisible=!0,this.baseX=0,this.baseY=0,this.tile=void 0,this.jumpingDeSync=0,this.shadow=e.pools.getPawnShadow(t,i),this.image=e.pools.getPawnImage(t,i)}attachToTile(e){this.assertNotDestroyed(),this.tile=e,e.addObject(this.image,0,3),e.addObject(this.shadow,0,3),this.attachSymbol(),this.baseX=this.tile.centerX,this.baseY=this.tile.centerY+3,this.baseDepth=this.image.depth,this.shadow.setDepth(this.image.depth-1)}setSymbol(e){this.assertNotDestroyed(),this.symbol?this.symbol.setFrame((0,a.getFrameForTileSymbol)(e)):(this.symbol=this.manager.pools.getTileSymbol(e),this.attachSymbol())}attachSymbol(){this.tile&&this.symbol&&(this.tile.addObject(this.symbol,0,t.SYMBOL_VERTICAL_OFFSET),this.symbol.setDepth(n.WorldLayers.UIOverlay),this.symbol.setVisible(this.symbolVisible))}setJumpPhase(e){var i;this.assertNotDestroyed();const n=-(0,o.jump2)(e)*t.PAWN_JUMPING_HEIGHT;this.image.setX(this.baseX),this.image.setY(this.baseY+n),null===(i=this.symbol)||void 0===i||i.setY(this.baseY+n+t.SYMBOL_VERTICAL_OFFSET-3),this.shadow.setScale(.5-(0,o.jump2)(e)*t.PAWN_SHADOW_SCALE_AT_MAX_JUMP)}hideSymbol(){var e;this.symbolVisible=!1,null===(e=this.symbol)||void 0===e||e.setVisible(!1)}showSymbol(){var e;this.assertNotDestroyed(),this.symbolVisible=!0,null===(e=this.symbol)||void 0===e||e.setVisible(!0)}removeSymbol(){this.symbol&&(this.tile&&this.tile.removeObject(this.symbol),this.manager.pools.free(this.symbol),this.symbol=void 0)}detachFromTile(){this.tile&&(this.tile.removeObject(this.image),this.tile.removeObject(this.shadow),this.symbol&&this.tile.removeObject(this.symbol))}destroy(){this.assertNotDestroyed(),this.detachFromTile(),this.removeSymbol(),this.manager.pools.free(this.image),this.manager.pools.free(this.shadow),this.isDestroyed=!0}hide(){this.image.setVisible(!1),this.shadow.setVisible(!1),this.hideSymbol()}show(){this.assertNotDestroyed(),this.image.setVisible(!0),this.shadow.setVisible(!0),this.showSymbol()}assertNotDestroyed(){var e,t;(0,r.assert)(!this.isDestroyed,`Attempting to modify ${this.type} at ${null!==(t=null===(e=this.tile)||void 0===e?void 0:e.hex.id)&&void 0!==t?t:"(no hex)"}, which is already destroyed`)}setType(e,t){this.assertNotDestroyed(),this.type===e&&this.variant===t||(this.type=e,this.variant=t,this.image.setFrame((0,a.getFrameForPawnType)(this.type,t)),this.shadow.setFrame((0,a.getShadowFrameForPawnType)(this.type,t)),this.image.setScale((0,a.getScaleForPawnType)(this.type)),this.image.setAlpha(1))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnSpawnFromAboveCinematic=void 0;const n=i(125),s=i(48);class a extends s.BaseCinematic{constructor(e,t){super(e.scene),this.pawnsManager=e,this.config=Object.assign({height:200,duration:500,delay:0,delayNoise:0,maxDelay:0},t)}execute(e){const t=this.pawnsManager.getAll(),i=(0,n.createStaggeredDelay2Dfn)(t.map(e=>e.image),this.config.delay,this.config.maxDelay,this.config.delayNoise),s=new Map;t.forEach(e=>{const t=e.image.y;e.image.setY(t-this.config.height),e.image.setAlpha(0),e.shadow.setScale(.01);const n=i(e.image);s.set(e.image,n),s.set(e.shadow,n)}),this.pawnTween=this.pawnsManager.scene.tweens.add({duration:this.config.duration,targets:t.map(e=>e.image),y:"+="+this.config.height,ease:"Sine.easeIn",alpha:1,delay:e=>s.get(e)}),this.shadowTween=this.pawnsManager.scene.tweens.add({targets:t.map(e=>e.shadow),ease:"Sine.easeIn",scale:.5,duration:this.config.duration,delay:e=>s.get(e)}),e&&this.pawnTween.once(Phaser.Tweens.Events.TWEEN_COMPLETE,()=>{e()})}playAfter(e,t){return this.pawnsManager.getAll().forEach(e=>{e.image.setAlpha(0),e.shadow.setScale(0)}),super.playAfter(e,t)}stop(){var e,t,i;this.pawnTween&&(null===(e=this.pawnTween)||void 0===e||e.stop(),null===(t=this.shadowTween)||void 0===t||t.stop(),null===(i=this.pawns)||void 0===i||i.forEach(e=>{e.image.setY(e.baseY),e.image.setAlpha(1),e.shadow.setScale(.5)}),this.pawnTween=void 0,this.shadowTween=void 0,this.pawns=void 0)}toString(){return`[Effect: PawnSpawnFromTheAboveEffect (${this.pawnTween?"playing":"stopped"})]`}}t.PawnSpawnFromAboveCinematic=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnTileDefenseCinematic=void 0;const n=i(48),s=i(1),a=i(0),o=i(13),r=s.logger.for("PawnTileDefenseCinematic");class c extends n.BaseCinematic{constructor(e,t,i,n){super(e.scene),this.pawns=e,this.tiles=t,this.attackedHex=i,this.defenderHex=n}execute(e){let t=this.pawns.getByHex(this.defenderHex);if(t)if(this.defenderHex==this.attackedHex)this.pawns.jumpOnce(this.defenderHex);else if(a.inject.gameStateModel.rules.pawns(t.type).hasTrait(o.PawnTraits.Building))this.pawns.jumpOnce(this.defenderHex);else{const e=this.tiles.getByHex(this.defenderHex).centerX,i=this.tiles.getByHex(this.attackedHex).centerX,n=t.baseY,s=(i-e)/2,a=(this.tiles.getByHex(this.attackedHex).centerY+3-n)/2;this.scene.tweens.add({targets:[t.image,t.shadow],y:{from:n,to:n+a},x:{from:e,to:e+s},ease:"Sine.easeInOut",duration:200,yoyo:!0})}else r.warning(`Request to play jump animation from ${this.defenderHex} ignored as there is no pawn there`)}}t.PawnTileDefenseCinematic=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SelectedRegionHighlight=t.HighlightStyle=void 0;const n=i(1),s=i(69),a=i(126),o=i(20);n.logger.for("SelectedRegionHighlight");var r;!function(e){e.Gold="gold",e.Muted="muted"}(r=t.HighlightStyle||(t.HighlightStyle={}));r.Gold,r.Muted;t.SelectedRegionHighlight=class{constructor(e){this.renderer=e,this.tileGroup=new a.IsoTileGroup(this.renderer,s.IsoTileRecipes.Highlight,e=>{e.setTint(this.color)}),this.color=o.Colors.highlight.ownedRegion}getHexes(e){return e.hexes}clear(){this.tileGroup.clear(),this.selectedRegion=void 0}setColor(e){e!==this.color&&(this.clear(),this.color=e)}set(e,t){t&&this.setColor(t),this.selectedRegion=e,this.tileGroup.setHexes(this.selectedRegion.hexes)}setHexes(e,t){t&&this.setColor(t),this.selectedRegion=void 0,this.tileGroup.setHexes(e)}refresh(){this.selectedRegion?this.tileGroup.setHexes(this.selectedRegion.hexes):this.tileGroup.clear()}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldCreationCinematic=void 0;const n=i(48),s=i(0);class a extends n.BaseCinematic{constructor(e){super(e)}execute(e){return Promise.all([this.scene.pawns.cinematics.spawnFromAbove.playAfter(200),this.scene.attitudeEmojis.cinematics.appear.playAfter(500),this.scene.coins.cinematics.growStacks(s.inject.gameStateModel.map).playAfter(500,e)])}}t.WorldCreationCinematic=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deriveDefenseMarkerDataFromModel=t.HexDefenseMarkers=t.HexMarker=void 0;const n=i(12),s=i(1),a=i(81),o=i(34),r=i(0),c=i(13),l=i(66),d=i(2),h=i(4);s.logger.for("HexDefenseHighlight");!function(e){e.Circle="circle",e.Defense1="defense-1",e.Defense2="defense-2",e.Defense3="defense-3",e.Defense4="defense-4"}(t.HexMarker||(t.HexMarker={}));t.HexDefenseMarkers=class{constructor(e){this.scene=e,this.shapesByHex={},this.hovered={hex:void 0,defenseAuraStrength:0,defenseAuraHexes:n.HexGroup.empty},this.shapes=this.scene.add.group({defaultKey:"atlas",defaultFrame:"hex-markers/defense-1"}).setDepth(o.WorldLayers.TileHighlight)}clear(){this.removeShapes(Object.keys(this.shapesByHex).map(e=>Number(e)))}set(e){this.config=e;const t=Object.entries(this.shapesByHex).filter(([t,i])=>0===e.get(Number(t)).defense).map(([e,t])=>Number(e));(0,h.getHexes)(e.getHexIds()).without(this.hovered.hex||n.HexGroup.empty).without(this.hovered.defenseAuraHexes).map(e=>{d.assert.defined(e);const t=this.config.get(e.id),i=this.setShapeOnHex(e,"defense-"+t.defense);return this.shapesByHex[e.id]||(this.shapesByHex[e.id]=i,this.scene.tweens.add({targets:i,x:{from:t.origin.display.centerX,to:e.display.centerX},y:{from:t.origin.display.centerY,to:e.display.centerY},scale:{from:.5,to:1},alpha:{from:0,to:1},duration:a.TIMING.pawnPickupTransition,ease:"Sine.easeOut"})),i}).filter(e=>!!e),this.removeShapes(t)}setShapeOnHex(e,t){const i=this.shapesByHex[e.id]||this.shapes.get(e.display.centerX,e.display.centerY,void 0,void 0,!1).setVisible(!0).setActive(!0).setDepth(o.WorldLayers.TileHighlight);return i.setFrame("hex-markers/"+t).setAlpha(1).setScale(1),i}setHoveredHex(e,t,i){this.clearHoveredHex(),this.hovered.hex=e,this.hovered.defenseAuraHexes=i,this.hovered.defenseAuraStrength=t,this.shapesByHex[e.id]=this.setShapeOnHex(e,"circle"),this.hovered.defenseAuraHexes.forEach(e=>{const i=this.config.get(e.id).defense;t>i&&(this.shapesByHex[e.id]=this.setShapeOnHex(e,"defense-"+t))})}clearHoveredHex(){this.hovered.hex&&(n.HexGroup.union([this.hovered.hex,this.hovered.defenseAuraHexes]).forEach(e=>{const t=this.config.get(e.id).defense;t>0?this.shapesByHex[e.id]=this.setShapeOnHex(e,"defense-"+t):(this.shapes.killAndHide(this.shapesByHex[e.id]),delete this.shapesByHex[e.id])}),this.hovered.hex=void 0,this.hovered.defenseAuraStrength=0,this.hovered.defenseAuraHexes=n.HexGroup.empty)}removeShapes(e){const t=e.map(e=>this.shapesByHex[e]);this.scene.tweens.add({targets:t,scale:{from:1,to:.5},alpha:{from:1,to:0},duration:a.TIMING.pawnPickupTransition,ease:"Sine.easeIn",onComplete:()=>{t.forEach(e=>{this.shapes.killAndHide(e)})}}),e.forEach(e=>delete this.shapesByHex[e])}},t.deriveDefenseMarkerDataFromModel=function(e,t){const i=r.inject.gameStateModel,n=e.hexes,s=new l.CustomHexGroupValuation({defense:0});return i.pawns.select({hexes:n,traits:[c.PawnTraits.GuardsAdjacentTiles]}).filter(e=>e!==t).forEach(e=>{n.neighboursOf(e.hex).filter(e=>!i.warfare.isOccupied(e)).forEach(t=>{const i=s.get(t.id);e.defense>i.defense&&s.set(t.id,{defense:e.defense,origin:e.hex})})}),i.pawns.select({hexes:n,traits:[c.PawnTraits.Wall]}).filter(e=>e!==t).forEach(e=>{const t=s.get(e.hex.id);!i.warfare.isOccupied(e.hex)&&e.defense>t.defense&&s.set(e.hex.id,{defense:e.defense,origin:e.hex})}),s}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TileDefenseCinematic=void 0;const n=i(48),s=i(12);class a extends n.ParallelCinematic{constructor(e,t,i){super(e.scene),this.pawns=e,this.attackedHex=t,this.defenders=i;const n=s.HexGroup.from(this.defenders.map(e=>e.hex));n.contains(this.attackedHex)?this.add(this.pawns.cinematics.defendTile(this.attackedHex.id,this.attackedHex.id)):n.forEach(e=>this.add(this.pawns.cinematics.defendTile(e.id,this.attackedHex.id)))}}t.TileDefenseCinematic=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Chunk=t.ChunkedRenderer=t.ChunksRenderingController=void 0;const n=i(11),s=i(348),a=i(61),o=i(39),r=i(1),c=i(0);r.logger.for("ChunkedRenderer");t.ChunksRenderingController=class{constructor(e,t,i=o.HEX_WIDTH){this.scene=e,this.renderer=t,this.margin=i,this.camera=this.scene.cameras.main}update(){const e=Phaser.Geom.Rectangle.Inflate(this.camera.worldView,this.margin,this.margin);for(const t of this.renderer.getVisibleChunks())Phaser.Geom.Intersects.RectangleToRectangle(e,t.boundingBox)||t.setVisible(!1);for(const t of this.renderer.getChunksInRect(e))t.setVisible(!0);c.inject.debugData.set("visibleChunks",this.renderer.getVisibleChunks().size.toString())}renderEverything(){this.renderer.getAllChunks().forEach(e=>e.setVisible(!0))}};t.ChunkedRenderer=class{constructor(e,t=5){this.scene=e,this.chunkSize=t,this.chunks={},this.visibleChunks=new Set,this.sectorMap=new s.HexGridSectors(t)}getVisibleChunks(){return this.visibleChunks}getAllChunks(){return Object.values(this.chunks)}getByHex(e){return this.getById(this.sectorMap.getSectorOf(e))}getById(e){return(0,n.getOrCreate)(this.chunks,e,()=>new l(this,e))}add(e,t){const i=this.sectorMap.getSectorOf(e);return this.getById(i).add(t),t}remove(e,t){const i=this.sectorMap.getSectorOf(e);return this.getById(i).remove(t),t}getChunksInRect(e){return this.getAllChunks().filter(t=>Phaser.Geom.Intersects.RectangleToRectangle(e,t.boundingBox))}};class l{constructor(e,t){this.parent=e,this.visible=!1,this.id=t,this.group=new Phaser.GameObjects.Group(e.scene),this.visible=!1,this.boundingBox=(0,a.rectToPhaser)((0,a.multiplyRect)(e.sectorMap.getSectorRect(t),o.HEX_WIDTH,o.HEX_INNER_HEIGHT))}add(e){return this.parent.scene.add.existing(e),this.group.add(e),this.visible?e.addToDisplayList():(e.addToDisplayList(),e.removeFromDisplayList()),e}remove(e){return this.group.remove(e,!0),e}setVisible(e){if(e===this.visible)return;const t=this.group.getChildren();e?(this.visible=!0,this.parent.visibleChunks.add(this),t.forEach(e=>e.addToDisplayList())):(this.visible=!1,this.parent.visibleChunks.delete(this),t.forEach(e=>e.removeFromDisplayList()))}}t.Chunk=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexGridSectors=void 0;const n=i(4);t.HexGridSectors=class{constructor(e){this.sectorSize=e,this.sectorsPerRow=Math.ceil(n.GRID_MAX_DIMENSION/this.sectorSize)}getSectorOf(e){const t=Math.floor(e.r/this.sectorSize),i=Math.floor(e.c/this.sectorSize);return t*this.sectorsPerRow+i}getSectorRect(e){return{x:e%this.sectorsPerRow*this.sectorSize-.5,y:Math.floor(e/this.sectorsPerRow)*this.sectorSize,width:this.sectorSize+.5,height:this.sectorSize+.5}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TownStatusFlagsManager=t.FlagObject=t.FlagType=void 0;const n=i(4),s=i(1),a=i(34),o=s.logger.for("TownStatusFlags");!function(e){e.Ready="ready"}(t.FlagType||(t.FlagType={}));class r{constructor(e,t){this.renderer=e,this.objectPool=t}acquireSprites(){this.flagFace||(this.flagFace=this.objectPool.getFlag(0,0),this.flagPole=this.objectPool.getFlagPole(0,0))}attachToTile(e,t){this.acquireSprites(),this.tile=e;e.addObject(this.flagFace,10,-12),e.addObject(this.flagPole,10,6),this.flagPole.setDepth(a.WorldLayers.FlyingObject),this.flagFace.setDepth(a.WorldLayers.FlyingObject+1).setTint(t).play("wave-flag")}setTint(e){this.acquireSprites(),this.flagFace.setTint(e)}destroy(){this.tile&&(this.tile.removeObject(this.flagFace),this.tile.removeObject(this.flagPole),this.objectPool.free(this.flagPole),this.objectPool.free(this.flagFace))}}t.FlagObject=r;t.TownStatusFlagsManager=class{constructor(e,t,i){this.renderer=e,this.imagePool=t,this.tiles=i,this.flagsByHex={},this.backlightByHex={}}setFlag(e,t){if(this.flagsByHex[e.id])this.flagsByHex[e.id].setTint(t);else{if(!this.tiles.getByHex(e.id))return void o.warning(`cannot attach flag to hex ${e} - no such tile found`);const i=new r(this.renderer,this.imagePool);this.flagsByHex[e.id]=i,i.attachToTile(this.tiles.getByHex(e.id),t)}}removeFlag(e){this.flagsByHex[e.id]&&this.doRemoveFlag(e,this.flagsByHex[e.id])}clear(){Object.entries(this.flagsByHex).forEach(([e,t])=>{this.doRemoveFlag((0,n.getHex)(Number(e)),t)}),this.flagsByHex={}}doRemoveFlag(e,t){t.destroy(),delete this.flagsByHex[e.id]}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MultiMap=void 0;const n=i(11);t.MultiMap=class{constructor(){this._map=new Map}add(e,t){const i=this._map.get(e);i?i.push(t):this._map.set(e,[t])}get(e){return this._map.get(e)}delete(e,t){const i=this._map.get(e);i&&(1===(null==i?void 0:i.length)&&i[0]===t?this._map.delete(e):(0,n.removeFromArrayInPlace)(i,t))}deleteKey(e){this._map.delete(e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AttitudeEmojiManager=t.EmojiObject=void 0;const n=i(1),s=i(2),a=i(80),o=i(34),r=i(352);n.logger.for("ui:AttitudeEmoji");class c{constructor(e){this.pools=e,this.isDestroyed=!1,this.tile=void 0,this.tween=void 0,this.face=this.pools.getEmojiFace(12),this.crown=this.pools.getEmojiCrown()}attachToTile(e){(0,s.assert)(!this.isDestroyed),this.tile=e,e.addObject(this.face,0,-28),e.addObject(this.crown,0,-32),this.face.setDepth(o.WorldLayers.UIOverlay),this.crown.setDepth(o.WorldLayers.UIOverlay+1)}setAttitude(e){this.face.setFrame((0,a.getFrameForEmojiFace)(e))}setAlpha(e){this.face.setAlpha(e),this.crown.setAlpha(e)}detachFromTile(){this.tile&&(this.tile.removeObject(this.face),this.tile.removeObject(this.crown))}destroy(){(0,s.assert)(!this.isDestroyed),this.detachFromTile(),this.pools.free(this.face),this.pools.free(this.crown),this.isDestroyed=!0}}t.EmojiObject=c;t.AttitudeEmojiManager=class{constructor(e,t,i){this.scene=e,this.pool=t,this.tiles=i,this.emojis=new Map,this.animating=!1,this.cinematics={appear:new r.EmojisAppearCinematic(this,{delay:0,delayNoise:100,maxDelay:1e3,duration:200}),hide:new r.EmojisHideCinematic(this,{delay:0,delayNoise:50,maxDelay:100,duration:200})}}clear(){Array.from(this.emojis.keys()).forEach(e=>this.remove(e))}set(e,t,i=1){const n=this.emojis.get(e);if(n&&!n.isDestroyed)n.setAttitude(t),this.animating||n.setAlpha(i);else{const n=new c(this.pool);n.attachToTile(this.tiles.getByHex(e.id)),this.emojis.set(e,n),n.setAttitude(t),this.animating||n.setAlpha(i)}}remove(e){const t=this.emojis.get(e);t&&(t.destroy(),this.emojis.delete(e))}getAll(){return Array.from(this.emojis.values())}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EmojisHideCinematic=t.EmojisAppearCinematic=void 0;const n=i(125),s=i(48);class a extends s.BaseCinematic{constructor(e,t){super(e.scene),this.emojiManager=e,this.config=Object.assign({duration:500,delay:0,delayNoise:0,maxDelay:0},t)}execute(e){this.emojiManager.animating=!0;const t=this.emojiManager.getAll();this.emojis=t;const i=(0,n.createStaggeredDelay2Dfn)(t.map(e=>e.face),this.config.delay,this.config.maxDelay,this.config.delayNoise),s=new Map;t.forEach(e=>{const t=e.face.y;e.face.setY(t+10),e.face.setAlpha(0),e.crown.setAlpha(0),e.crown.setY(e.crown.y+10);const n=i(e.face);s.set(e.face,n),s.set(e.crown,n)}),this.mainTween=this.scene.tweens.add({duration:this.config.duration,targets:[...t.map(e=>e.face),...t.map(e=>e.crown)],y:"-=10",ease:"Sine.easeIn",alpha:1,delay:e=>s.get(e)}),this.mainTween.once(Phaser.Tweens.Events.TWEEN_COMPLETE,()=>{this.emojiManager.animating=!1,e&&e()})}playAfter(e,t){this.emojiManager.animating=!0;return this.emojiManager.getAll().forEach(e=>{e.face.setAlpha(0),e.crown.setAlpha(0)}),super.playAfter(e,t)}stop(){this.mainTween&&this.mainTween.stop(1)}toString(){return`[Effect: EmojiAppearCinematic (${this.mainTween?"playing":"stopped"})]`}}t.EmojisAppearCinematic=a;class o extends s.BaseCinematic{constructor(e,t){super(e.scene),this.emojiManager=e,this.config=Object.assign({duration:500,delay:0,delayNoise:0,maxDelay:0},t)}execute(e){const t=this.emojiManager.getAll();this.emojis=t;const i=(0,n.createStaggeredDelay2Dfn)(t.map(e=>e.face),this.config.delay,this.config.maxDelay,this.config.delayNoise),s=new Map;t.forEach(e=>{const t=i(e.face);s.set(e.face,t),s.set(e.crown,t)}),this.faceTween=this.scene.tweens.add({duration:this.config.duration,targets:[...t.map(e=>e.face),...t.map(e=>e.crown)],y:"+=10",ease:"Sine.easeIn",alpha:0,delay:e=>s.get(e)}),e&&this.faceTween.once(Phaser.Tweens.Events.TWEEN_COMPLETE,()=>{e()})}stop(){this.faceTween&&this.faceTween.stop(1)}toString(){return`[Effect: EmojiAppearCinematic (${this.faceTween?"playing":"stopped"})]`}}t.EmojisHideCinematic=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionsRenderer=void 0;const n=i(7),s=i(354),a=i(355),o=i(356),r=i(357);t.RegionsRenderer=class{constructor(e){this.renderer=e,this.greenRenderer=new o.GreenRenderer(this.renderer),this.subRenderers=[new a.GroundRenderer(this.renderer),new s.PalisadeRenderer(this.renderer),this.greenRenderer,new r.ForestRenderer(this.renderer)]}syncWithModel(e){this.subRenderers.forEach(t=>t.syncWithModel(e))}redrawRegions(e,t){for(let i of t){const t=n.Regions.model(e).byId(i);t&&this.redrawRegion(t)}}redrawRegion(e){this.subRenderers.forEach(t=>t.redrawFaction(e.faction))}refreshHexes(e,t){this.subRenderers.forEach(i=>i.redrawHexes(e,t))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PalisadeRenderer=void 0;const n=i(100),s=i(24),a=i(69);class o extends n.FactionBasedIsoRenderer{constructor(e){super(e.scene,e,a.IsoTileRecipes.Palisade)}shouldIncludeHex(e,t){return s.Warfare.getHexStaticDefense(e.state,t)>0}redrawHexes(e,t){const i=t.with(...t.neighbours().members);super.redrawHexes(e,i)}}t.PalisadeRenderer=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GroundRenderer=void 0;const n=i(100),s=i(69);class a extends n.FactionBasedIsoRenderer{constructor(e){super(e.scene,e,s.IsoTileRecipes.Ground)}redrawFaction(e){e.id>0&&super.redrawFaction(e)}shouldIncludeHex(e,t){return!e.isNeutral()}postProcess(e,t){t.setTint(null==e?void 0:e.landColor)}}t.GroundRenderer=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GreenRenderer=void 0;const n=i(100),s=i(69),a=i(7),o=i(12);class r extends n.FactionBasedIsoRenderer{constructor(e){super(e.scene,e,s.IsoTileRecipes.Green)}shouldIncludeHex(e,t){var i;return!!(null===(i=a.Regions.model(e.state).byHex(t))||void 0===i?void 0:i.isAlive())}postProcess(e,t){const i=(null==e?void 0:e.landColorLight)||0;t.setTint(i)}redrawRegions(e){if(0===e.length)return;const t=o.HexGroup.union(e.map(e=>e.hexes));this.redrawHexes(e[0].state,t)}}t.GreenRenderer=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ForestRenderer=void 0;const n=i(100),s=i(69),a=i(29),o=i(3),r=i(17);class c extends n.FactionBasedIsoRenderer{constructor(e){super(e.scene,e,s.IsoTileRecipes.Forest)}redrawFaction(e){(null==e?void 0:e.id)===a.SpecialFaction.neutral&&super.redrawFaction(e)}shouldIncludeHex(e,t){return e.id===a.SpecialFaction.neutral&&!!r.Pawns.model(e.state).findOne({hexes:t,type:[o.PawnType.Forest]})}}t.ForestRenderer=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LandmassRenderer=void 0;const n=i(126),s=i(12),a=i(69);t.LandmassRenderer=class{constructor(e){this.renderer=e,this.landmass=new n.IsoTileGroup(this.renderer,a.IsoTileRecipes.Landmass,this.postProcess)}syncWithModel(e,t){this.clear();const i=s.HexGroup.union(e.regions.all().map(e=>e.hexes));this.landmass.addHexes(i),this.landmass.update()}postProcess(e){}clear(){this.landmass.clear()}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TownBacklightManager=void 0;const n=i(360),s=i(361);class a extends n.TileAttachmentsManager{constructor(e,t,i){super("TownBacklightManager",e,t),this.pawns=i}createObject(e,t){var i;const n=null!==(i=this.pawns.getByHex(e.id).image.displayWidth)&&void 0!==i?i:18;return new s.PawnBacklight(this.scene,n).setTint(t)}updateObject(e,t,i){var n;const s=this.pawns.getByHex(t.id);e.setBaseWidth(null!==(n=s.image.displayWidth)&&void 0!==n?n:18),e.setTint(i)}}t.TownBacklightManager=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TileAttachmentsManager=void 0;const n=i(4),s=i(1).logger.for("TileAttachmentsManager");t.TileAttachmentsManager=class{constructor(e,t,i){this.name=e,this.renderer=t,this.tiles=i,this.objectsByHex={},this.scene=this.renderer.scene}add(e,t){if(this.objectsByHex[e.id])this.updateObject(this.objectsByHex[e.id],e,t);else{const i=this.tiles.getByHex(e.id);if(!i)return void s.warning(`[${this.name}] cannot attach flag to hex ${e} - no such tile found`);const n=this.createObject(e,t);this.objectsByHex[e.id]=n,this.attachToTile(n,i)}}set(e,t){this.clear();for(let i of e.members)this.add(i,t)}attachToTile(e,t){t.addObject(e,0,0)}remove(e){this.objectsByHex[e.id]&&this.doRemoveObject(e,this.objectsByHex[e.id])}clear(){Object.entries(this.objectsByHex).forEach(([e,t])=>{this.doRemoveObject((0,n.getHex)(Number(e)),t)}),this.objectsByHex={}}destroyObject(e,t){t.destroy()}doRemoveObject(e,t){this.tiles.getByHex(e.id).removeObject(t),delete this.objectsByHex[e.id],this.destroyObject(e,t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnBacklight=void 0;const n=i(34),s=i(1);var a=Phaser.GameObjects.Sprite;s.logger.for("PawnBacklight");t.PawnBacklight=class extends a{constructor(e,t){super(e,0,0,"atlas","pawn-backlight"),this.baseWidth=t,this.setOrigin(.5,1),this.setTint(65280),this.setDepth(n.WorldLayers.UIOverlay),this.setDisplaySize(t,128),this.baseScaleX=this.scaleX,this.baseScaleY=this.scaleY,this.pulseTween=this.scene.add.tween({targets:this,scaleY:{from:.9*this.baseScaleY,to:this.baseScaleY},alpha:{from:.7,to:1},duration:1e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut",paused:!0}),this.animateIn()}setBaseWidth(e){this.baseWidth=e,this.setDisplaySize(this.baseWidth,128)}animateIn(){this.scene.tweens.add({targets:this,scaleX:{from:0,to:this.baseScaleX},scaleY:{from:.5,to:this.baseScaleY},alpha:{from:0,to:.7},ease:"Sine.easeOut",duration:300,onComplete:()=>this.pulseTween.play()})}destroy(){this.scene.tweens.add({targets:this,width:0,height:this.height/2,alpha:0,duration:300,onComplete:()=>{this.pulseTween.stop(),super.destroy()}})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createWorldMapLODManager=void 0;const n=i(363),s=i(38);t.createWorldMapLODManager=function(e){const t=new s.TransitionController(e.scene,{applyValue:t=>{e.coins.setAlpha(t),e.coinStacks.setAlpha(t)},ease:"ease.sineInOut",duration:100,initialValue:1});return new n.LODManager(e.scene.cameras.main,[{when:e=>e<.9,activate:()=>{t.transitionTo(0)}},{when:e=>e>=.9,activate:()=>{t.transitionTo(1)}},{when:e=>e>=1.5,activate:()=>{e.coinStacks.defaultFrame="coinstack-hd",e.coins.defaultKey="coin-hd";for(let t of e.coinStacks.getChildren())t.setFrame("coinstack-hd");for(let t of e.coins.getChildren())t.setTexture("coin-hd")}},{when:e=>e<1.5,activate:()=>{e.coinStacks.defaultFrame="coinstack",e.coins.defaultKey="coin";for(let t of e.coinStacks.getChildren())t.setFrame("coinstack");for(let t of e.coins.getChildren())t.setTexture("coin")}}])}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LODManager=void 0;t.LODManager=class{constructor(e,t=[]){this.camera=e,this.latestZoom=void 0,this.handlers=t}registerLODlevel(e){this.handlers.push(e)}update(){if(this.camera.zoom!==this.latestZoom){const e=this.camera.zoom;for(let t of this.handlers)(void 0===this.latestZoom||!t.when(this.latestZoom)&&t.when(e))&&t.activate(e);this.latestZoom=this.camera.zoom}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PropTransitionController=void 0;const n=i(0);t.PropTransitionController=class{constructor(e,t,i,n){var s,a;this.scene=e,this.target=t,this.propName=i,this.currentValue=0,this.defaultTweenOptions={duration:null!==(s=n.duration)&&void 0!==s?s:500,ease:null!==(a=n.ease)&&void 0!==a?a:"Sine.easeOut"}}applyValue(e){this.target[this.propName]=e}setTo(e){this.tween&&(this.tween.stop(),this.tween=void 0),this.currentValue=e,this.applyValue(e)}transitionTo(e,t){if(n.inject.ui.skipTransitions())return void this.setTo(e);this.tween&&this.tween.stop();const i=t?Object.assign(Object.assign({},this.defaultTweenOptions),t):this.defaultTweenOptions;this.tween=this.scene.tweens.add({targets:this.target,to:e,props:{[this.propName]:e},duration:i.duration,ease:i.ease,onComplete:()=>{this.setTo(e)}})}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.handlePawnBought=void 0;const s=i(13),a=i(4),o=i(37);t.handlePawnBought=function(e,t){var i;return n(this,void 0,void 0,(function*(){const n=(0,o.readOnlyModelOf)(t.state),r=n.currentPhase.isLocalPlayerTurn(),c=n.rules.pawns(t.pawnType),l=n.regions.byHex(t.destinationHexId),d=n.rules.pawns(t.pawnType).hasTrait(s.PawnTraits.Unit)?null===(i=n.economy.nearestTownHexFrom((0,a.getHex)(t.destinationHexId)))||void 0===i?void 0:i.id:void 0;r?(e.worldMapScene.cinematics.coinTransaction(t.payment).play(),e.refreshTownFlagsAndBacklightInRegion(l)):e.worldMapScene.coins.applyTransactions(t.payment),c.hasTrait(s.PawnTraits.Building)&&c.defense>0&&e.worldMapScene.regions.refreshHexes(t.state,(0,a.getHex)(t.destinationHexId)),t.eradicatedPest&&e.worldMapScene.pawns.destroy(t.destinationHexId),t.mergedInto?e.worldMapScene.pawns.replace(t.destinationHexId,t.mergedInto):(e.worldMapScene.pawns.add(t.destinationHexId,t.pawnType,void 0,r?void 0:d).play(),r&&!t.eradicatedPest&&c.hasTrait(s.PawnTraits.Unit)&&e.worldMapScene.pawns.beginJumping([t.destinationHexId])),e.uiScene.updateSelectedRegionFromGameState(t.state),e.uiScene.updatePowerBalanceFromGameState(t.state)}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.handleBanditsActed=void 0;const s=i(12),a=i(0),o=i(3),r=i(4);t.handleBanditsActed=function(e,t){return n(this,void 0,void 0,(function*(){const i=s.HexGroup.fromIds(t.pillagedHexes.map(e=>e.hexId));e.worldMapScene.regions.refreshHexes(t.state,i),e.worldMapScene.tiles.syncWithModel(a.inject.gameStateModel,i),t.campsCreated.forEach(i=>{e.worldMapScene.pawns.replace(i,o.PawnType.Camp),e.worldMapScene.regions.refreshHexes(t.state,(0,r.getHex)(i))}),Object.keys(t.coinTransactions.pillage).length>0&&(yield e.worldMapScene.coins.cinematics.transactions(t.coinTransactions.pillage).play()),t.banditsMoved.forEach(({fromHex:t,toHex:i})=>{e.worldMapScene.pawns.move(t,i)}),t.banditsCreated.forEach(({fromHex:t,toHex:i})=>{e.worldMapScene.pawns.add(i,o.PawnType.Bandit,void 0,t).play()}),Object.keys(t.coinTransactions.buyUnits)&&(yield e.worldMapScene.coins.cinematics.transactions(t.coinTransactions.buyUnits).play()),e.worldMapScene.coins.applyTransactions(t.coinTransactions.baseIncome)}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.handleFactionEconomyUpdated=void 0;const s=i(48),a=i(0),o=i(3),r=i(4),c=i(55),l=i(37);t.handleFactionEconomyUpdated=function(e,t){return n(this,void 0,void 0,(function*(){const i=new s.ParallelCinematic(e),n=a.inject.gameStateModel.factions.byId(t.factionId);(null==n?void 0:n.controller)===o.FactionController.LocalUser?(t.regionReports.forEach(t=>{i.add(e.worldMapScene.cinematics.coinTransaction(t.coinTransfers))}),yield i.play(),u()):(t.regionReports.forEach(t=>{e.worldMapScene.coins.applyTransactions(t.coinTransfers)}),u());const d=new l.StaticGameStateModel(t.state),h=t.regionReports.map(e=>d.regions.byId(e.regionId));function u(){t.regionReports.forEach(i=>{i.unitsTurnedBandits.map(t=>{e.worldMapScene.pawns.replace(t,o.PawnType.Bandit),(null==n?void 0:n.controller)===o.FactionController.LocalUser&&e.worldMapScene.tileSymbols.add((0,r.getHex)(t),c.TileSymbol.Alert)}),i.newBanditCamps.forEach(i=>{e.worldMapScene.pawns.replace(i,o.PawnType.Camp),e.worldMapScene.regions.refreshHexes(t.state,(0,r.getHex)(i)),(null==n?void 0:n.controller)===o.FactionController.LocalUser&&e.worldMapScene.tileSymbols.add((0,r.getHex)(i),c.TileSymbol.Alert)})})}e.refreshTownVariantInRegions(h),e.uiScene.updateSelectedRegionFromGameState(t.state)}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AlertSymbolsUpdater=void 0;const n=i(4),s=i(55),a=i(25);t.AlertSymbolsUpdater={afterHexCaptured(e,t){var i;const o=a.CurrentPhase.model(t.state).isLocalPlayerTurn();!o&&(null===(i=e.watchedHexes)||void 0===i?void 0:i.has((0,n.getHex)(t.capturedHexId)))?e.worldMapScene.tileSymbols.add((0,n.getHex)(t.capturedHexId),s.TileSymbol.Alert):o&&(e.worldMapScene.tileSymbols.remove((0,n.getHex)(t.capturedHexId),s.TileSymbol.Alert),e.worldMapScene.attitudeEmojis.remove((0,n.getHex)(t.capturedHexId)),e.showWorldMapOverlaysBasedOnSelectedRegion())}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handlePawnMoved=void 0;const n=i(25);t.handlePawnMoved=function(e,t){t.eradicatedPest&&(e.worldMapScene.pawns.destroy(t.destinationHexId),e.uiScene.updateSelectedRegionFromGameState(t.state),e.uiScene.updatePowerBalanceFromGameState(t.state)),t.mergedInto?(e.worldMapScene.pawns.destroy(t.sourceHexId),e.worldMapScene.pawns.replace(t.destinationHexId,t.mergedInto),e.uiScene.updateSelectedRegionFromGameState(t.state),e.uiScene.updatePowerBalanceFromGameState(t.state)):(e.worldMapScene.pawns.move(t.sourceHexId,t.destinationHexId),e.worldMapScene.pawns.show(t.destinationHexId),t.eradicatedPest?(e.worldMapScene.pawns.stopJumping([t.destinationHexId]),e.showWorldMapOverlaysBasedOnSelectedRegion()):n.CurrentPhase.model(t.state).isLocalPlayerTurn()&&e.worldMapScene.pawns.beginJumping([t.destinationHexId]))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleNewGameState=void 0;const n=i(0),s=i(371);t.handleNewGameState=function(e,t){n.inject.ui.withoutTransitions(()=>{(0,s.syncPlayUiWithNewState)(e,t.state,{resetCamera:t.context.resetCamera})})}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.syncPlayUiWithNewState=void 0;const n=i(3),s=i(103),a=i(128),o=i(0),r=i(25);t.syncPlayUiWithNewState=function(e,t,i={resetCamera:!1}){const c=r.CurrentPhase.model(t),l=r.CurrentPhase.model(t).faction;switch(e.worldMapScene.loadNewGameState(t),i.resetCamera&&e.worldMapScene.cameraController.centerAboveControlPanel(),e.uiScene.updateSelectedRegionFromGameState(t),e.uiScene.updatePowerBalanceFromGameState(t),e.worldMapScene.setSelectedRegion(o.inject.ui.selectedRegion.get()),e.refreshAllTownFlagsAndBacklight(t),null==l?void 0:l.controller){case n.FactionController.LocalUser:e.uiScene.setFactionColor(l.landColor||16777215),e.time.addEvent({callback:()=>e.worldMapScene.pawns.beginJumping(c.getMovablePawns().map(e=>e.hex.id)),delay:100}),e.setMode(new s.PlayMode(e));break;case n.FactionController.Ai:case n.FactionController.None:case void 0:e.setMode(new a.SpectatorMode(e));break;default:throw new Error(`Faction ${l} uses unsupported controller ${null==l?void 0:l.controller}`)}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.BuyingPawnMode=void 0;const s=i(0),a=i(6),o=i(103),r=i(70),c=i(1),l=i(24),d=i(189),h=i(31),u=i(3),g=i(2),p=i(55),m=i(13),f=i(60),y=c.logger.for("BuyingPawnMode");class v extends r.BaseMode{constructor(e,t){super(e),this.buyingPawn=t,this.bought=!1}activate(){this.scene.worldMapScene.showHexDefenseMarkers(),s.inject.gameStateModel.rules.pawns(this.buyingPawn).hasTrait(m.PawnTraits.Unit)?(this.scene.showConquerableHexesBasedOn(this.buyingPawn),s.inject.ui.selectedRegion().getPawns().filter(e=>e.type===this.buyingPawn).forEach(e=>{this.scene.worldMapScene.tileSymbols.add(e.hex,p.TileSymbol.Plus)})):this.scene.worldMapScene.conquerableHexesHighlight.clear()}deactivate(){this.bought||(this.scene.uiScene.returnPawnToShop(this.buyingPawn,()=>{}),this.scene.pointerEventsController.abortPawnDrag()),this.scene.worldMapScene.tileSymbols.clear(p.TileSymbol.Plus),this.scene.worldMapScene.hexMarkers.clear()}canDropPawn(e){const t=s.inject.ui.selectedRegion();if(!t)return!1;if(this.canReturnPawnAtHex(e))return!0;const i=s.inject.gameStateModel.warfare.getDropPawnResult(e,this.buyingPawn,t);return i.type!==l.DropPawnResultType.Invalid||i.reason===l.InvalidDropPawnReason.PreventedByPawn}canReturnPawnAtHex(e){const t=s.inject.ui.selectedRegion();return s.inject.gameStateModel.regions.byHex(e)===t&&!!s.inject.gameStateModel.pawns.byHex(e,u.PawnType.Town)}handleDropPawn(e){const t=this.buyingPawn,i=s.inject.ui.selectedRegion();if(g.assert.defined(t),g.assert.defined(i),this.canReturnPawnAtHex(e))return this.scene.uiScene.restockPawnInShop(this.buyingPawn),this.scene.dropHeldPawnAtHex(e.id),this.bought=!1,this.scene.setMode(new o.PlayMode(this.scene)),!1;const n=()=>{this.scene.uiScene.restockPawnInShop(this.buyingPawn),this.scene.dropHeldPawnAtHex(e.id).then(()=>{}),s.inject.gameStateController.executePlay(a.Plays.BuyPawn({pawnType:t,destinationHexId:e.id,buyerRegionId:s.inject.ui.selectedRegion().id})),s.inject.audio.playEffect(h.SoundEffects.Drop)},r=s.inject.gameStateModel.warfare.getDropPawnResult(e,this.buyingPawn,i);switch(r.type){case l.DropPawnResultType.Reposition:case l.DropPawnResultType.EradicatePest:case l.DropPawnResultType.Combine:return n(),this.bought=!0,this.scene.setMode(new o.PlayMode(this.scene)),!0;case l.DropPawnResultType.Conquest:return this.bought=!0,this.scene.uiScene.restockPawnInShop(this.buyingPawn),s.inject.gameStateController.executePlay(a.Plays.BuyPawn({pawnType:t,destinationHexId:e.id,buyerRegionId:s.inject.ui.selectedRegion().id})),!0;case l.DropPawnResultType.Invalid:return s.inject.audio.playEffect(h.SoundEffects.Deny),r.reason===l.InvalidDropPawnReason.PreventedByPawn&&this.scene.worldMapScene.cinematics.tileDefense(e,r.blockers).play(),!1}}handleDropPawnOnShop(e,t){return g.assert.defined(this.buyingPawn),this.scene.uiScene.returnPawnToShop(this.buyingPawn,()=>{}),e!==this.buyingPawn&&t?(this.scene.uiScene.grabPawnFromShop(e),this.buyingPawn=e,this.scene.showConquerableHexesBasedOn(this.buyingPawn),!1):(this.scene.setMode(new o.PlayMode(this.scene)),!0)}handleReturnPawn(){g.assert.defined(this.buyingPawn),this.scene.uiScene.returnPawnToShop(this.buyingPawn,()=>{this.scene.setMode(new o.PlayMode(this.scene))})}handleHexCaptured(e){const t=Object.create(null,{handleHexCaptured:{get:()=>super.handleHexCaptured}});return n(this,void 0,void 0,(function*(){e.originatingHexId?y.warning(`ignoring hexCaptured as the capture originated from pawn at hex ${e.originatingHexId}, rather than freshly bought pawn`):(this.scene.dropHeldPawnAtHex(e.capturedHexId).then(()=>{const t=(0,f.mergeTransactions)(e.lootTransactions||{},e.boughtPawnTransactions||{});t&&(this.scene.worldMapScene.cinematics.coinTransaction(t).play(),this.scene.worldMapScene.pawns.add(e.capturedHexId,this.buyingPawn).play()),s.inject.audio.playEffect(h.SoundEffects.Drop)}),yield t.handleHexCaptured.call(this,e),this.scene.setMode(new o.PlayMode(this.scene)))}))}handleNewHexUnderCursor(e){(0,d.updateHighlightWhileMovingPawn)(this.scene,e,this.buyingPawn,s.inject.ui.selectedRegion())}}t.BuyingPawnMode=v},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.handleFactionTurnStarted=void 0;const s=i(0),a=i(103),o=i(6),r=i(128),c=i(3),l=i(2),d=i(374),h=i(29),u=i(35);t.handleFactionTurnStarted=function(e,{state:t,factionId:i}){const g=s.inject.gameStateModel.factions.byId(i);switch(l.assert.defined(g),g.controller){case c.FactionController.LocalUser:s.inject.config.autoSaveOnTurnStart&&s.inject.userData.saveLevelProgress(),g.isAlive()||s.inject.gameStateModel.factions.all().filter(e=>e.isAlive()&&e.controller===c.FactionController.LocalUser).length||e.handleGameOver({winningFactionId:void 0,state:s.inject.currentGameState}),e.setMode(new a.PlayMode(e)),s.inject.ui.regionsLedger.reset(t),e.setPawnJumpingInRegions(g.getRegions()),e.selectRegion(s.inject.ui.regionsLedger.getNextPendingRegion(),{clickEffect:!1,panCamera:!1}),e.refreshAllTownFlagsAndBacklight(t),e.uiScene.updateState({mode:u.PlayUIMode.Standby}),e.uiScene.updateSelectedRegionFromGameState(s.inject.currentGameState);break;case c.FactionController.Ai:e.mode instanceof r.SpectatorMode||e.setMode(new r.SpectatorMode(e)),s.inject.ai.play(g).then(()=>n(this,void 0,void 0,(function*(){s.inject.gameStateController.executePlay(o.Plays.EndTurn())})));break;case c.FactionController.None:g.id===h.SpecialFaction.neutral&&(e.mode instanceof r.SpectatorMode||e.setMode(new r.SpectatorMode(e)),s.inject.gameStateController.executePlay(o.Plays.BanditsAct())),s.inject.gameStateController.executePlay(o.Plays.EndTurn());break;default:throw new Error(`Faction ${g} uses unsupported controller ${g.controller}`)}e.uiScene.updatePowerBalanceFromGameState(s.inject.currentGameState),s.inject.config.debug.checkWorldMapIntegrity&&(0,d.verifyWorldMapInSync)(e.worldMapScene,t)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.verifyWorldMapInSync=void 0;const n=i(37),s=i(3),a=i(1).logger.for("integrity");t.verifyWorldMapInSync=function(e,t){const i=new n.StaticGameStateModel(t),o=i.map.getAllHexes();for(const e of o.members)r(e);function r(t){const n=i.pawns.getCount(t,s.PawnType.Coins),o=e.coins.getOrCreatePile(t);var r,c,l,d;r=t,c=o.getCurrentAmount(),d="coins",c!==(l=n)&&a.error(`Integrity check failed on ${r}! Expected ${d}x${c}, found ${l}`)}a.info("WorldMapScene integrity check completed.")}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PointerEventsController=t.PointerState=void 0;const n=i(1),s=i(0);var a;!function(e){e.Idle="idle",e.CameraHoldDrag="camera-drag",e.PawnJustPickedUp="pawn-just-picked-up",e.PawnHoldDrag="pawn-hold-drag",e.PawnClickDrag="pawn-click-drag"}(a=t.PointerState||(t.PointerState={}));n.logger.for("PointerEventsController");t.PointerEventsController=class{constructor(){this.pointerState=a.Idle}handlePointerDown(e){switch(this.pointerState){case a.Idle:e.pickupPawn?(this.setState(a.PawnJustPickedUp),e.selectHex&&e.selectHex(),e.pickupPawn(),this.triggerDragHoldTimeout=setTimeout(this.transitionToPawnHoldDrag.bind(this),200)):(this.setState(a.CameraHoldDrag),e.startCameraDrag&&e.startCameraDrag());break;case a.PawnClickDrag:e.dropPawn&&e.dropPawn(!0)&&this.setState(a.Idle)}}handlePointerUp(e){switch(this.pointerState){case a.PawnJustPickedUp:this.triggerDragHoldTimeout&&(clearTimeout(this.triggerDragHoldTimeout),this.triggerDragHoldTimeout=null),this.setState(a.PawnClickDrag);break;case a.PawnHoldDrag:e.dropPawn&&e.dropPawn(!1)||e.returnPawn&&e.returnPawn(),this.setState(a.Idle);break;case a.CameraHoldDrag:let t=0;e.endCameraDrag&&(t=e.endCameraDrag()),t<20&&e.selectHex&&e.selectHex(),this.setState(a.Idle)}}setState(e){this.pointerState=e,e!==a.Idle?s.inject.debugData.set("playScene.pointerState",e):s.inject.debugData.clear("playScene.pointerState")}transitionToPawnHoldDrag(){this.pointerState===a.PawnJustPickedUp&&this.setState(a.PawnHoldDrag)}abortPawnDrag(){[a.PawnClickDrag,a.PawnHoldDrag,a.PawnJustPickedUp].includes(this.pointerState)&&this.setState(a.Idle)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorPalette=void 0;const n=i(43),s=i(36),a=i(377),o=i(192),r=i(191),c=i(0);class l extends n.CompositeUiElement{constructor(e,t){super(e),this.palette=new a.Palette(e,{spacing:4,items:[[...o.EDITOR_TOOL.paintRegion.map((e,t)=>this.createItem(e,(t+1).toString(),s.Input.Keyboard.KeyCodes.ONE+t))],[this.createItem(o.EDITOR_TOOL.deleteTile,"Q"),this.createItem(o.EDITOR_TOOL.paintSoldier,"W"),this.createItem(o.EDITOR_TOOL.paintTown,"E"),this.createItem(o.EDITOR_TOOL.paintForest,"R"),this.createItem(o.EDITOR_TOOL.addCoins,"T"),this.createItem(o.EDITOR_TOOL.paintCastle,"A")]],onItemSelected:e=>c.inject.events.trigger(r.MapEditorActions.SetTool(e))}),this.palette.select(t),this.add(this.palette)}updateLayout(){return this.palette.updateLayout()}createItem(e,t,i){return this.scene.input.keyboard.addKey(i||t).on("down",()=>{this.palette.select(e),c.inject.events.trigger(r.MapEditorActions.SetTool(e))}),{image:e.createIcon(this.scene),hotkey:t,value:e}}}t.MapEditorPalette=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaletteSlot=t.Palette=void 0;var n=Phaser.GameObjects.Image,s=Phaser.GameObjects.BitmapText;const a=i(43),o=i(67),r=i(0),c=i(31),l=i(15);class d extends a.CompositeUiElement{constructor(e,t){super(e),this.props=t,this.slots=[],this.slotByValue=new Map,this.currentSelection=void 0,this.setProps(this.props)}setProps(e){this.destroySlots(),this.slotByValue.clear();for(let t of e.items){const e=t.map(e=>{const t=new h(this.scene,{icon:e.image,hotkey:e.hotkey,onClick:()=>this.handleValueClicked(e.value)});return this.slotByValue.set(e.value,t),t});this.slots.push(e),this.add(...e)}}handleValueClicked(e){r.inject.audio.playEffect(c.SoundEffects.ButtonDown),this.select(e),this.props.onItemSelected(e)}select(e){if(this.currentSelection){const e=this.slotByValue.get(this.currentSelection);e&&e.setSelected(!1)}if(this.currentSelection=e,e){const t=this.slotByValue.get(e);t&&t.setSelected(!0)}}forEachSlot(e){for(let t of this.slots)for(let i of t)e(i)}destroySlots(){for(let e of this.slots)for(let t of e)t.destroy();this.slots=[]}updateLayout(){let e=0,t=0;for(let i of this.slots)if((0,o.layoutFromLeftToRight)(0,t,this.props.spacing,i),i.length>0){const n=i[i.length-1].x+i[i.length-1].width;n>e&&(e=n),t+=i[0].height+this.props.spacing}return{width:e,height:Math.max(0,t-this.props.spacing)}}}t.Palette=d;class h extends a.CompositeUiElement{constructor(e,{icon:t,hotkey:i,onClick:a}){super(e),this.background=new n(e,0,0,"atlas","ui/palette-slot"),this.icon=t,this.background.setInteractive({useHandCursor:!0}),this.background.on("pointerdown",()=>a()),this.hotkey=new s(e,0,0,l.BitmapFont.Debug,i).setTint(986895),this.hotkey.setPosition(this.background.width-this.hotkey.width-2,2),this.add(this.background,this.icon,this.hotkey)}setSelected(e){this.background.setFrame(e?"ui/palette-slot-selected":"ui/palette-slot")}updateLayout(){return this.icon.setOrigin(.5,.5).setPosition(this.background.width/2,this.background.height/2),{height:this.background.height,width:this.background.width}}}t.PaletteSlot=h},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintRegionTool=void 0;const n=i(0),s=i(29);var a=Phaser.GameObjects.Image;t.PaintRegionTool=class{constructor(e){this.factionId=e,this.description=`click = assign faction ${this.factionId}\nctrl-click = delete`}createIcon(e){var t,i;return new a(e,0,0,"atlas","editor/tile-icon").setTint(null!==(i=null===(t=n.inject.gameStateModel.factions.byId(this.factionId))||void 0===t?void 0:t.landColor)&&void 0!==i?i:16777215)}useOn(e,t){var i;t.ctrl?n.inject.gameStateModel.factions.byId(s.SpecialFaction.neutral).captureHex(e):null===(i=n.inject.gameStateModel.factions.byId(this.factionId))||void 0===i||i.captureHex(e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintSoldierTool=void 0;const n=i(0),s=i(3),a=i(13);var o=Phaser.GameObjects.Image;t.PaintSoldierTool=class{constructor(){this.description="click = add/upgrade unit\nctrl-click = downgrade/remove unit"}createIcon(e){return new o(e,0,0,"atlas","pawns/villager").setScale(.5,.5)}useOn(e,t){const i=n.inject.gameStateModel,s=i.pawns.byHex(e).find(e=>e.hasTrait(a.PawnTraits.OccupiesTile)),o=t.ctrl?this.getDownGradedUnitType(null==s?void 0:s.type):this.getUpgradedUnitType(null==s?void 0:s.type);i.regions.byHex(e)&&(o?s?s.type!==o&&s.replaceWith(o):i.pawns.create({hex:e,type:o}):s&&s.destroy())}getUpgradedUnitType(e){switch(e){case s.PawnType.Villager:return s.PawnType.Pikeman;case s.PawnType.Pikeman:return s.PawnType.Knight;case s.PawnType.Knight:case s.PawnType.Hero:return s.PawnType.Hero;default:return s.PawnType.Villager}}getDownGradedUnitType(e){switch(e){case s.PawnType.Bandit:return;case s.PawnType.Villager:return s.PawnType.Bandit;case s.PawnType.Pikeman:return s.PawnType.Villager;case s.PawnType.Knight:return s.PawnType.Pikeman;case s.PawnType.Hero:return s.PawnType.Knight;default:return s.PawnType.Bandit}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintTownTool=void 0;const n=i(0),s=i(3),a=i(13),o=i(29);var r=Phaser.GameObjects.Image;t.PaintTownTool=class{constructor(){this.description="click = add town\nctrl-click = remove town"}createIcon(e){return new r(e,0,0,"atlas","pawns/town-1").setScale(.5,.5)}useOn(e,t){var i,r;const c=n.inject.gameStateModel;if(!c.regions.byHex(e))return;const l=(null===(i=c.factions.byHex(e))||void 0===i?void 0:i.id)===o.SpecialFaction.neutral?s.PawnType.Camp:s.PawnType.Town,d=c.pawns.byHex(e).find(e=>e.hasTrait(a.PawnTraits.OccupiesTile));t.ctrl?(d&&d.destroy(),null===(r=c.pawns.findOne({hexes:e,type:[s.PawnType.Coins]}))||void 0===r||r.destroy()):d?d.type!==s.PawnType.Town&&d.replaceWith(l):c.pawns.create({hex:e,type:l})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinsTool=void 0;const n=i(0),s=i(3);var a=Phaser.GameObjects.Image;t.CoinsTool=class{constructor(){this.description="click = add coin\nctrl-click = remove coin\nshift-click = add 5 coins"}createIcon(e){return new a(e,0,0,"atlas","ui/budget-icons/neutral")}useOn(e,t){const i=n.inject.gameStateModel,a=i.regions.byHex(e);if(!a)return;const o=i.pawns.findClosest(e,a.hexes,e=>e.type===s.PawnType.Town||e.type===s.PawnType.Camp);if(!o)return;const r=function(e,t){const i=t.shift?5:1,n=t.ctrl?-1:1;return Math.max(0,e+i*n)}(i.pawns.getCount(o.hex,s.PawnType.Coins),t);i.pawns.setCount(o.hex,s.PawnType.Coins,r)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintCastleTool=void 0;const n=i(0),s=i(3),a=i(13);var o=Phaser.GameObjects.Image;t.PaintCastleTool=class{constructor(){this.description="click = add castle\nctrl-click = remove castle"}createIcon(e){return new o(e,0,0,"atlas","pawns/castle").setScale(.5,.5)}useOn(e,t){const i=n.inject.gameStateModel,o=i.pawns.byHex(e).find(e=>e.hasTrait(a.PawnTraits.OccupiesTile));i.regions.byHex(e)&&(t.ctrl?o&&o.destroy():o?o.type!==s.PawnType.Castle&&o.replaceWith(s.PawnType.Castle):i.pawns.create({hex:e,type:s.PawnType.Castle}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaintForestTool=void 0;const n=i(193),s=i(29),a=i(13),o=i(3),r=i(0);var c=Phaser.GameObjects.Image;t.PaintForestTool=class{constructor(){this.description="click = add forest tile\nctrl-click = delete tile"}createIcon(e){return new c(e,0,0,"atlas","editor/tree")}useOn(e,t){var i;(0,n.deleteTile)(e);const c=r.inject.gameStateModel,l=c.pawns.byHex(e).find(e=>e.hasTrait(a.PawnTraits.OccupiesTile));t.ctrl?(l&&l.destroy(),null===(i=c.pawns.findOne({hexes:e,type:[o.PawnType.Coins]}))||void 0===i||i.destroy()):l?(c.factions.byId(s.SpecialFaction.neutral).captureHex(e),l.type!==o.PawnType.Forest&&l.replaceWith(o.PawnType.Forest)):(c.factions.byId(s.SpecialFaction.neutral).captureHex(e),c.pawns.create({hex:e,type:o.PawnType.Forest}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CursorAttachment=void 0;t.CursorAttachment=class{constructor(e){this.scene=e}setImage(e){if(this.image){if(this.image===e)return;this.image.destroy()}this.image=e,e&&(this.scene.add.existing(e),e.setOrigin(0,0))}update(){this.image&&this.image.setPosition(this.scene.input.activePointer.x+8,this.scene.input.activePointer.y+8)}clear(){this.setImage(void 0)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorPointerEventsController=t.EditorPointerState=void 0;const n=i(1),s=i(0),a=i(68);var o;!function(e){e.Idle="idle",e.CameraHoldDrag="camera-drag",e.Paint="paint"}(o=t.EditorPointerState||(t.EditorPointerState={}));n.logger.for("ui:MapEditorPointerEventsController");t.MapEditorPointerEventsController=class{constructor(e){this.actionImpls=e,this.pointerState=o.Idle}handlePointerDown(e){switch(this.pointerState){case o.Idle:e&a.PointerEventFlags.Alt?this.actionImpls.tryStartCameraDrag()&&this.setState(o.CameraHoldDrag):this.actionImpls.tryStartPaint()&&this.setState(o.Paint)}return this.pointerState}handlePointerUp(){switch(this.pointerState){case o.CameraHoldDrag:this.actionImpls.endCameraDrag(),this.setState(o.Idle);break;case o.Paint:this.actionImpls.endPaint(),this.setState(o.Idle)}}setState(e){e!==this.pointerState&&(this.pointerState=e,e!==o.Idle?s.inject.debugData.set("editorScene.pointerState",e):s.inject.debugData.clear("editorScene.pointerState"))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayUIScene=void 0;const n=i(16),s=i(0),a=i(1),o=i(3),r=i(6),c=i(2),l=i(31),d=i(30),h=i(52),u=i(127),g=i(13),p=i(387),m=i(35),f=i(79),y=i(394),v=i(14),w=i(25),b=i(47),S=i(32),x=i(36),P=a.logger.for("PlayUIScene");class T extends b.BaseUIScene{constructor(){super({key:n.Scenes.PlayUI}),this.currentState=m.DEFAULT_PLAY_UI_STATE,this.preUpdate=(0,S.whenDirty)(()=>{var e;null===(e=this.activeUI)||void 0===e||e.updateLayout()}),this.alreadyShaking=!1}get pawnHolder(){return this.activeUI.pawnHolder}create(){super.create(),this.watchWhileActive(s.inject.ui.selectedRegion,()=>this.updateSelectedRegionFromGameState(s.inject.gameStateModel.state)),this.watchWhileActive(s.inject.ui.undoAvailable,e=>this.updateState({enableUndo:e})),this.watchWhileActive(s.inject.ui.spectatingSpeed,e=>this.updateState({spectatingSpeed:e})),this.watchWhileActive(s.inject.device.screenSize,this.setControlsBasedOnScreenSize.bind(this)),this.setControlsBasedOnScreenSize(s.inject.device.screenSize.get()),this.bindKey(x.Input.Keyboard.KeyCodes.ESC,r.UserActions.GoBack),this.bindKey(x.Input.Keyboard.KeyCodes.TAB,r.UserActions.SelectNextRegion),this.bindKey(x.Input.Keyboard.KeyCodes.ONE,()=>r.UserActions.BuyablePawnPointerDown(o.PawnType.Villager)),this.bindKey(x.Input.Keyboard.KeyCodes.TWO,()=>r.UserActions.BuyablePawnPointerDown(o.PawnType.Pikeman)),this.bindKey(x.Input.Keyboard.KeyCodes.THREE,()=>r.UserActions.BuyablePawnPointerDown(o.PawnType.Knight)),this.bindKey(x.Input.Keyboard.KeyCodes.FOUR,()=>r.UserActions.BuyablePawnPointerDown(o.PawnType.Hero)),this.bindKey(x.Input.Keyboard.KeyCodes.BACKSPACE,r.UserActions.Undo),this.bindKey(x.Input.Keyboard.KeyCodes.BACKTICK,r.UserActions.Undo);this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.ESC)}updateState(e){this.currentState=Object.assign(Object.assign({},this.currentState),e),this.activeUI.updateState(e)}setControlsBasedOnScreenSize(e){var t;if(this.latestScreenSize!==e)switch(this.latestScreenSize=e,P.warning(`Updating controls to fit screen size "${e}"`),null===(t=this.activeUI)||void 0===t||t.destroy(),e){case f.ScreenSize.Small:this.activeUI=new y.CompactPlayUI(this,this.currentState);break;case f.ScreenSize.Large:this.activeUI=new p.LargePlayUI(this,this.currentState)}}setFactionColor(e){this.updateState({activeFactionColor:e})}update(e,t){var i;super.update(e,t),null===(i=this.activeUI)||void 0===i||i.update()}updateSelectedRegionFromGameState(e){var t,i;const n=d.Economy.model(e),a=h.Rules.model(e),o=s.inject.ui.selectedRegion(),r=s.inject.ui.regionsLedger.hasPendingRegions(),c=s.inject.ui.regionsLedger.availableRegions.some(e=>e.isActionable());if([m.PlayUIMode.Standby,m.PlayUIMode.OwnedRegionSelected,m.PlayUIMode.HostileRegionSelected].includes(this.currentState.mode))if(null==o?void 0:o.exists){const e=(0,u.isRegionControllable)(o),l=n.treasuryOf(o),d=e?a.getAllPawnTypes().filter(e=>e.cost>0&&e.cost<=l).filter(e=>!e.hasTrait(g.PawnTraits.Wall)).map(e=>e.type):[];this.updateState({regionData:{id:o.id,name:o.name,income:(null===(t=o.budget)||void 0===t?void 0:t.balance)||0,treasury:l,buyablePawns:d,townLevel:o.power.maxObtainableUnitMight},mode:e?m.PlayUIMode.OwnedRegionSelected:m.PlayUIMode.HostileRegionSelected,activeFactionColor:(null===(i=o.faction)||void 0===i?void 0:i.landColor)||0,hasPendingRegions:r,enableNextRegion:s.inject.ui.regionsLedger.availableRegions.length>1,highlightEndTurn:!c})}else this.updateState({regionData:null,hasPendingRegions:r,mode:m.PlayUIMode.Standby,highlightEndTurn:!c})}grabPawnFromShop(e){const t=this.activeUI.shoppingTray.getPawnSpriteByType(e);return(0,c.assert)(t),this.grabPawnFrom(e,this.activeUI.shoppingTray.x+t.x,this.activeUI.shoppingTray.y+t.y),!0}grabPawnFromTown(e,t){const{x:i,y:n}=s.inject.scene.worldMap.getPawnObjectPositionOnScreen(t.id);this.grabPawnFrom(e,i,n)}grabPawnFrom(e,t,i){const n=this.activeUI.shoppingTray.getPawnSpriteByType(e);(0,c.assert)(n),this.pawnHolder.pickUpPawn(e,t,i,1);const a=s.inject.gameStateModel.rules.pawns(e);this.updateState({heldPawnData:{name:e.toString(),cost:a.cost,upkeep:a.upkeep}}),n.setAlpha(.1),s.inject.audio.playEffect(l.SoundEffects.Grab)}returnPawnToShop(e,t){const i=this.activeUI.shoppingTray.getPawnSpriteByType(e);(0,c.assert)(i),this.pawnHolder.dropPawn(this.activeUI.shoppingTray.x+i.x,this.activeUI.shoppingTray.y+i.y,1,()=>{i.setAlpha(1),t()}),this.updateState({heldPawnData:null})}restockPawnInShop(e,t=!1){const i=this.activeUI.shoppingTray.getPawnSpriteByType(e);t?i.setAlpha(1):this.tweens.add({targets:i,alpha:1,duration:300}),this.updateState({heldPawnData:null})}shakeRegionControls(){this.alreadyShaking||(this.alreadyShaking=!0,this.tweens.add({targets:[this.activeUI.shoppingTray],y:e=>e.y+10,tween:"Sine.easeInOut",duration:100,yoyo:!0,onComplete:()=>{this.alreadyShaking=!1}}))}updatePowerBalanceFromGameState(e){const t=v.Factions.model(e).all().filter(e=>e.isAlive()).map(t=>({id:t.id,size:t.power,color:t.landColor,highlight:w.CurrentPhase.getFaction(e)===t.id}));this.updateState({powerBalance:t})}canBuyPawn(e){var t;return null===(t=this.currentState.regionData)||void 0===t?void 0:t.buyablePawns.includes(e)}}t.PlayUIScene=T},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LargePlayUI=void 0;const n=i(0),s=i(6),a=i(97),o=i(35),r=i(388),c=i(195),l=i(1),d=i(196),h=i(104),u=i(389),g=i(199),p=i(393),m=i(200),f=i(94),y=i(15),v=i(28);var w=Phaser.GameObjects.BitmapText;const b=i(20),S=i(110),x=i(122);var P=Phaser.GameObjects.Image;l.logger.for("ui:PlayUI");t.LargePlayUI=class{constructor(e,t){this.scene=e,this.state=t,this.pawnHolder=new c.PawnHolder(this.scene),this.regionSummaryPopup=new g.RegionSummaryPopup(this.scene),this.headerPanel=new p.MenuPanel(this.scene),this.shoppingTray=new d.ShoppingTray(this.scene,h.LARGE_PLAY_UI_LAYOUT.shoppingTray),this.regionPanel=new r.LargeRegionPanel(this.scene),this.spectatorPanel=new u.LargeSpectatorPanel(this.scene),this.editorButton=new f.BoxButton(this.scene,0,50,{baseTexture:v.BoxTexture.DialogButton,downTexture:v.BoxTexture.DialogButtonDown,content:new w(this.scene,0,0,y.BitmapFont.Small,"EDIT").setTint(b.Colors.woodenUi.primaryText),width:102,height:36}),this.changeThemeButton=new f.BoxButton(this.scene,0,100,{baseTexture:v.BoxTexture.DialogButton,downTexture:v.BoxTexture.DialogButtonDown,content:new w(this.scene,0,0,y.BitmapFont.Small,"THEME").setTint(b.Colors.woodenUi.primaryText),width:102,height:36}),this.endTurnButton=new T(this.scene),this.undoButton=new C(this.scene),this.buttonGlow=new M(this.scene),this.skipSpectatingButton=new O(this.scene),this.nextPendingRegionButton=new I(this.scene),this.bottomAnchoredComponents=[this.shoppingTray,this.regionPanel,this.spectatorPanel,this.endTurnButton,this.skipSpectatingButton,this.nextPendingRegionButton,this.undoButton,this.buttonGlow.overlayGlow,this.buttonGlow.staticGlow],this.endTurnButton.onClicked(()=>n.inject.events.trigger(s.UserActions.EndTurn())),this.undoButton.onClicked(()=>n.inject.events.trigger(s.UserActions.Undo())),this.nextPendingRegionButton.onClicked(()=>n.inject.events.trigger(s.UserActions.SelectNextPendingRegion())),this.skipSpectatingButton.onClicked(()=>n.inject.events.trigger(s.UserActions.SkipSpectating())),this.layer=new m.ResponsiveLayer(this.scene,[this.regionPanel,this.spectatorPanel,this.buttonGlow.staticGlow,this.endTurnButton,this.buttonGlow.overlayGlow,this.skipSpectatingButton,this.nextPendingRegionButton,this.undoButton,this.shoppingTray,this.editorButton,this.changeThemeButton,this.regionSummaryPopup,this.headerPanel]),this.scene.add.existing(this.layer),this.updateLayout(),n.inject.ui.withoutTransitions(()=>{this.updateState(this.state)}),this.editorButton.onClicked(()=>n.inject.events.trigger(s.UserActions.EditMap())),this.changeThemeButton.onClicked(()=>{const e=n.inject.gameStateModel.map.theme,t=Object.keys(S.THEMES);let i=t.indexOf(e);-1===i&&(i=0);const s=t[(i+1)%t.length];x.commands.game.setTheme(s)})}setVisible(e){this.layer.setVisible(e)}updateLayout(){const e=this.scene.cameras.main.displayWidth,t=this.scene.cameras.main.displayHeight;this.regionPanel.updateLayout(),this.shoppingTray.updateLayout(),this.spectatorPanel.updateLayout(),this.editorButton.setPosition(e-this.editorButton.width-20,120),this.changeThemeButton.setPosition(this.editorButton.x,this.editorButton.y+this.editorButton.height+8),this.endTurnButton.setPosition(e/2+h.LARGE_PLAY_UI_LAYOUT.spectatorPanel.width/2+h.LARGE_PLAY_UI_LAYOUT.primaryButtons.offsetFromMainPanel,t-h.LARGE_PLAY_UI_LAYOUT.primaryButtons.offsetFromBottom-this.endTurnButton.height),this.nextPendingRegionButton.copyPosition(this.endTurnButton),this.skipSpectatingButton.copyPosition(this.endTurnButton),this.undoButton.setPosition(e/2-h.LARGE_PLAY_UI_LAYOUT.spectatorPanel.width/2-h.LARGE_PLAY_UI_LAYOUT.primaryButtons.offsetFromMainPanel-this.undoButton.width,t-h.LARGE_PLAY_UI_LAYOUT.primaryButtons.offsetFromBottom-this.undoButton.height),this.buttonGlow.setPosition(this.endTurnButton.x+this.endTurnButton.width/2,this.endTurnButton.y+this.endTurnButton.height/2);this.headerPanel.setPosition(e/2,0)}updateState(e,t=!1){this.state;if(this.state=Object.assign(Object.assign({},this.state),e),this.spectatorPanel.updateState(e),this.regionPanel.updateState(e),void 0!==e.mode)switch(e.mode){case o.PlayUIMode.Hidden:this.endTurnButton.setVisible(!1),this.buttonGlow.setVisible(!1),this.nextPendingRegionButton.setVisible(!1),this.undoButton.setVisible(!1),this.shoppingTray.setOpen(!1),this.skipSpectatingButton.setVisible(!1),this.regionSummaryPopup.hide();break;case o.PlayUIMode.Spectating:this.endTurnButton.setVisible(!1),this.buttonGlow.setVisible(!1),this.nextPendingRegionButton.setVisible(!1),this.undoButton.setVisible(!1),this.shoppingTray.setOpen(!1),this.regionSummaryPopup.hide();break;case o.PlayUIMode.OwnedRegionSelected:case o.PlayUIMode.HostileRegionSelected:case o.PlayUIMode.Standby:e.mode===o.PlayUIMode.OwnedRegionSelected?this.shoppingTray.setOpen(!0):this.shoppingTray.setOpen(!1),this.endTurnButton.setVisible(!this.state.hasPendingRegions),this.nextPendingRegionButton.setVisible(this.state.hasPendingRegions),this.skipSpectatingButton.setVisible(!1),this.undoButton.setVisible(!0),this.undoButton.setEnabled(this.state.enableUndo),e.mode!==o.PlayUIMode.HostileRegionSelected&&this.regionSummaryPopup.hide()}e.regionData&&(e.mode===o.PlayUIMode.HostileRegionSelected?this.regionSummaryPopup.showOverRegion(e.regionData.id):e.mode===o.PlayUIMode.OwnedRegionSelected&&this.shoppingTray.setDisplayedPawns(e.regionData.buyablePawns)),void 0!==e.activeFactionColor&&e.mode===o.PlayUIMode.OwnedRegionSelected&&this.shoppingTray.setColor(e.activeFactionColor),void 0!==e.enableSkipSpectating&&this.skipSpectatingButton.setVisible(this.state.enableSkipSpectating),void 0!==e.highlightEndTurn&&(this.buttonGlow.setVisible(e.highlightEndTurn),this.endTurnButton.setHighlighted(e.highlightEndTurn))}update(){this.pawnHolder.update(),this.regionSummaryPopup.updatePosition()}destroy(){this.layer.destroy()}transitionIn(e=n.inject.config.screenTransitionDuration){this.updateLayout(),this.scene.tweens.add({targets:this.bottomAnchoredComponents,y:{from:"+=160",to:"-=160"},duration:e,ease:"Sine.easeOut"})}transitionOut(e=n.inject.config.screenTransitionDuration){this.updateLayout(),this.scene.tweens.add({targets:this.bottomAnchoredComponents,y:"+=160",duration:e,ease:"Sine.easeIn"})}};class T extends a.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/end-turn",down:!0})}setHighlighted(e){this.setBaseFrame(e?"ui/primary-buttons/end-turn-glow":"ui/primary-buttons/end-turn")}}class M{constructor(e){this.scene=e,this.staticGlow=new P(this.scene,0,0,"atlas","ui/primary-buttons/static-glow").setTint(16777088),this.overlayGlow=new P(this.scene,0,0,"atlas","ui/primary-buttons/overlay-glow").setTint(16777088),this.scene.tweens.add({targets:this.staticGlow,scaleX:{from:.95,to:1.05},scaleY:{from:.9,to:1.1},yoyo:!0,repeat:-1,duration:350,ease:"Sine.easeInOut"}),this.scene.tweens.add({targets:this.overlayGlow,alpha:{from:0,to:1},duration:350,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}setVisible(e){this.staticGlow.setVisible(e),this.overlayGlow.setVisible(e)}setPosition(e,t){this.staticGlow.setPosition(e,t),this.overlayGlow.setPosition(e,t)}}class C extends a.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/undo",down:!0,disabled:!0})}}class I extends a.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/next",down:!0})}}class O extends a.ImageButton{constructor(e){super(e,0,0,{frame:"ui/primary-buttons/skip",down:!0})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LargeRegionPanel=t.ExpandedState=void 0;const n=i(28),s=i(194),a=i(104),o=i(35),r=i(0),c=i(105),l=i(6),d=i(38);var h=Phaser.GameObjects.Image;const u=i(22);var g;!function(e){e.Hidden="hidden",e.Collapsed="collapsed",e.Expanded="expanded"}(g=t.ExpandedState||(t.ExpandedState={}));const p={[g.Expanded]:a.LARGE_PLAY_UI_LAYOUT.regionPanel.expandedOffsetFromBottom,[g.Collapsed]:a.LARGE_PLAY_UI_LAYOUT.regionPanel.collapsedOffsetFromBottom,[g.Hidden]:0};class m extends u.BaseResponsiveContainer{constructor(e){super(e),this.expandedState=g.Collapsed,this.browseRegionButtonsEnabled=!1,this.mode=o.PlayUIMode.Standby,this.regionLabel=new s.LargeRegionLabel(this.scene,a.LARGE_PLAY_UI_LAYOUT.regionPanel.width,a.LARGE_PLAY_UI_LAYOUT.regionPanel.height),this.nextRegionButton=new f(this.scene,!1),this.prevRegionButton=new f(this.scene,!0),this.sizeController=d.Control.propOf(this,"y",{duration:a.LARGE_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.box=new n.Box(e,n.BoxTexture.RoundedPlate,0,0,a.LARGE_PLAY_UI_LAYOUT.regionPanel.width,a.LARGE_PLAY_UI_LAYOUT.regionPanel.height),this.setDepth(o.PlayUILayers.MainPanel),this.add([this.nextRegionButton,this.prevRegionButton,this.box,this.regionLabel]),this.box.setInteractiveAuto(),this.box.input.cursor="default",this.box.on("pointerdown",()=>console.log("BOX CLICKED")),this.nextRegionButton.onClicked(()=>r.inject.events.trigger(l.UserActions.SelectNextRegion())),this.prevRegionButton.onClicked(()=>r.inject.events.trigger(l.UserActions.SelectPreviousRegion()))}updateState(e){void 0!==e.mode&&this.setMode(e.mode),e.regionData&&this.mode===o.PlayUIMode.OwnedRegionSelected&&this.regionLabel.setRegionInfo(e.regionData),void 0!==e.enableNextRegion&&this.setBrowseRegionsButtonsEnabled(e.enableNextRegion),void 0!==e.heldPawnData&&this.regionLabel.setBuyingPawnInfo(e.heldPawnData)}setMode(e){if(e!==this.mode)switch(this.mode=e,e){case o.PlayUIMode.OwnedRegionSelected:this.setExpandedState(g.Expanded);break;default:this.setExpandedState(g.Hidden),this.setBrowseRegionsButtonsEnabled(!1)}}setExpandedState(e){const t=this.scene.cameras.main.displayHeight-p[e];this.sizeController.transitionTo(t),this.expandedState=e}setBrowseRegionsButtonsEnabled(e){this.browseRegionButtonsEnabled=e;const t=this.prevRegionButton.props.width,i=e?4-t:0,n=e?a.LARGE_PLAY_UI_LAYOUT.regionPanel.width-4:a.LARGE_PLAY_UI_LAYOUT.regionPanel.width-t;if(r.inject.ui.skipTransitions())return this.nextRegionButton.x=n,void(this.prevRegionButton.x=i);this.scene.tweens.add({targets:this.prevRegionButton,x:i,scale:1,ease:"Sine.easeOut",duration:a.LARGE_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.scene.tweens.add({targets:this.nextRegionButton,x:n,scale:1,ease:"Sine.easeOut",duration:a.LARGE_PLAY_UI_LAYOUT.panelTransitionsDuration})}updateLayout(){const e=this.scene.cameras.main.displayHeight;let t=0;switch(this.expandedState){case g.Hidden:t=e;break;case g.Collapsed:t=e-a.LARGE_PLAY_UI_LAYOUT.regionPanel.collapsedOffsetFromBottom;break;case g.Expanded:t=e-a.LARGE_PLAY_UI_LAYOUT.regionPanel.expandedOffsetFromBottom}r.inject.ui.withoutTransitions(()=>{this.setBrowseRegionsButtonsEnabled(this.browseRegionButtonsEnabled)}),this.setPosition(this.scene.cameras.main.displayWidth/2-a.LARGE_PLAY_UI_LAYOUT.regionPanel.width/2,t),this.sizeController.setTo(t)}}t.LargeRegionPanel=m;class f extends c.RibbonButton{constructor(e,t){super(e,0,a.LARGE_PLAY_UI_LAYOUT.regionPanel.nextRegionButtonOffsetFromTop,{audio:!1,type:c.RibbonButtonStyle.Medium,width:36,content:y(e,t),contentOffset:{y:-3}})}}function y(e,t){const i=new h(e,0,0,"atlas","ui/button-icons/play");return i.flipX=t,i}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LargeSpectatorPanel=t.ExpandedState=void 0;const n=i(28),s=i(104),a=i(35),o=i(0),r=i(197),c=i(391),l=i(38),d=i(198),h=i(6),u=i(44),g=i(15);var p=Phaser.GameObjects.Image,m=Phaser.GameObjects.BitmapText;const f=i(22),y=s.LARGE_PLAY_UI_LAYOUT;var v;!function(e){e.Hidden="hidden",e.Collapsed="collapsed",e.Expanded="expanded"}(v=t.ExpandedState||(t.ExpandedState={}));const w={[v.Expanded]:y.spectatorPanel.expandedOffsetFromBottom,[v.Collapsed]:y.spectatorPanel.collapsedOffsetFromBottom,[v.Hidden]:0};class b extends f.ResponsiveContainer{constructor(e){super(e),this.expandedState=v.Collapsed,this.mode=a.PlayUIMode.Standby,this.statusIcon=new p(this.scene,0,0,"atlas","ui/hourglass"),this.sizeController=l.Control.propOf(this,"y",{duration:y.panelTransitionsDuration}),this.spectatingMessage="",this.powerBalanceRibbon=new r.PowerBalanceRibbon(this.scene,{x:y.spectatorPanel.padding,y:y.spectatorPanel.padding,width:y.spectatorPanel.width-2*y.spectatorPanel.padding,minSize:36}),this.box=new n.Box(e,n.BoxTexture.RoundedPlate,0,0,y.spectatorPanel.width,y.spectatorPanel.height),this.statusMessage=new m(this.scene,0,0,g.BitmapFont.Main,"").setTint(5583648),this.playSpeedButtons=new c.MiniButtonsRow(this.scene,["ui/mini-icons/play","ui/mini-icons/fast-forward","ui/mini-icons/super-fast-forward"]),this.pauseButton=new d.ImageButtonWithContent(this.scene,0,0,{frame:"ui/mini-buttons/wide",content:new p(this.scene,0,0,"atlas","ui/mini-icons/pause"),down:!0,controller:null}),this.playSpeedButtonsGroupController=u.ButtonControllers.options({[a.SpectatingPlaybackSpeed.Paused]:this.pauseButton,[a.SpectatingPlaybackSpeed.Normal]:this.playSpeedButtons.buttons[0],[a.SpectatingPlaybackSpeed.Fast]:this.playSpeedButtons.buttons[1],[a.SpectatingPlaybackSpeed.UltraFast]:this.playSpeedButtons.buttons[2]}),this.playSpeedButtonsGroupController.onButtonClicked(e=>{e!==o.inject.ui.spectatingSpeed()?o.inject.events.trigger(h.UserActions.SetSpectatingPlayBackSpeed(e)):e===a.SpectatingPlaybackSpeed.Paused&&o.inject.events.trigger(h.UserActions.SetSpectatingPlayBackSpeed(a.SpectatingPlaybackSpeed.Normal))}),this.playSpeedButtons.setPosition(this.box.width-y.spectatorPanel.padding-this.playSpeedButtons.width,y.spectatorPanel.centerLineOffsetFromTop),this.pauseButton.setPosition(this.playSpeedButtons.x-this.pauseButton.width-8,this.playSpeedButtons.y),this.statusMessage.setPosition(y.spectatorPanel.padding+36,y.spectatorPanel.centerLineOffsetFromTop-2),this.statusIcon.setPosition(y.spectatorPanel.padding+10,y.spectatorPanel.centerLineOffsetFromTop),this.setDepth(a.PlayUILayers.MainPanel),this.add([this.box,this.powerBalanceRibbon,this.playSpeedButtons,this.pauseButton,this.statusMessage,this.statusIcon])}updateState(e){void 0!==e.mode&&this.setMode(e.mode),e.powerBalance&&this.powerBalanceRibbon.updateState(e.powerBalance),e.spectatingSpeed&&(this.playSpeedButtonsGroupController.selectButton(e.spectatingSpeed),this.statusMessage.setText(e.spectatingSpeed===a.SpectatingPlaybackSpeed.Paused?"< PAUSED >":this.spectatingMessage)),e.spectatingState&&(this.spectatingMessage=e.spectatingState,this.statusMessage.setText(e.spectatingState))}setMode(e){if(e!==this.mode)switch(this.mode=e,e){case a.PlayUIMode.Spectating:this.setExpandedState(v.Expanded);break;case a.PlayUIMode.Standby:default:this.setExpandedState(v.Collapsed)}}setExpandedState(e){const t=this.scene.cameras.main.displayHeight-w[e];this.sizeController.transitionTo(t)}updateLayout(){const e=this.scene.cameras.main.displayWidth,t=this.scene.cameras.main.displayHeight;let i=0;switch(this.expandedState){case v.Hidden:i=t;break;case v.Collapsed:i=t-y.spectatorPanel.collapsedOffsetFromBottom;break;case v.Expanded:i=t-y.spectatorPanel.expandedOffsetFromBottom}this.setPosition(e/2-y.spectatorPanel.width/2,i),this.sizeController.setTo(i)}}t.LargeSpectatorPanel=b},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ColorBar=void 0;const n=i(53),s=i(38);class a extends n.Ribbon{constructor(e,t){super(e,n.RibbonTexture.ColorBar,t.x,t.y,t.width),this.props=t,this.adjustX=s.Control.propOf(this,"x",{duration:500}),this.adjustY=s.Control.propOf(this,"y",{duration:500}),this.adjustSize=new s.TransitionController(this.scene,{duration:500,applyValue:e=>this.width=e,initialValue:this.width}),void 0!==t.color&&this.setTint(t.color)}}t.ColorBar=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MiniButtonsRow=void 0;var n=Phaser.GameObjects.Container,s=Phaser.GameObjects.Image;const a=i(198);t.MiniButtonsRow=class extends n{constructor(e,t){super(e),this.frames=t,this.buttons=[],this.createButtons()}createButtons(){if(this.frames.length<2)throw new Error("MiniButtonsRow must have at least 2 buttons");this.createButton("left",this.frames[0]),this.frames.slice(1,this.frames.length-1).forEach(e=>{this.createButton("mid",e)}),this.createButton("right",this.frames[this.frames.length-1]),this.add(this.buttons),this.updateLayout()}createButton(e,t){this.buttons.push(new a.ImageButtonWithContent(this.scene,0,0,{down:!0,frame:"ui/mini-buttons/"+e,content:new s(this.scene,0,0,"atlas",t)}))}updateLayout(){let e=0;for(let t of this.buttons)t.x=e,e+=t.width-1;this.width=e+1}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ToolTipBox=void 0;const n=i(28),s=i(38);class a extends n.Box{constructor(e,t={padding:6}){super(e,n.BoxTexture.Tooltip),this.config=t,this.visibilityController=new s.TransitionController(this.scene,{initialValue:0,applyValue:e=>{var t;const i=this.targetDimensions.width*e,n=this.targetDimensions.height;null===(t=this.content)||void 0===t||t.setScale(e),this.content.y=this.config.padding+(1-e)*this.content.height/2,this.setPosition(this.targetDimensions.x-i/2,this.targetDimensions.y-n/2),this.setSize(i,n),this.setAlpha(e)}}),this.targetDimensions={x:0,y:0,width:0,height:0}}setContent(e){if(this.content){if(this.content===e)return;this.remove(this.content)}this.content=e,this.add(e),this.content.setPosition(this.config.padding,this.config.padding),this.targetDimensions.width=this.content.width+2*this.config.padding,this.targetDimensions.height=this.content.height+2*this.config.padding,this.updateTargetSize()}showAt(e,t){this.visibilityController.setTo(0),this.targetDimensions.x=e,this.targetDimensions.y=t,this.visibilityController.transitionTo(1,{duration:300,ease:"Sine.easeOut"}),this.updateTargetSize()}repositionTo(e,t){this.targetDimensions.x=e,this.targetDimensions.y=t,this.visibilityController.applyValue(this.visibilityController.currentValue)}updateTargetSize(){this.targetDimensions.width=this.content.width+2*this.config.padding,this.targetDimensions.height=this.content.height+2*this.config.padding,this.visibilityController.currentValue>0&&this.visibilityController.setTo(1)}hide(){this.visibilityController.transitionTo(0,{duration:300,ease:"Sine.easeOut"})}}t.ToolTipBox=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MenuPanel=void 0;var n=Phaser.GameObjects.Graphics,s=Phaser.GameObjects.Image;const a=i(0),o=i(6),r=i(22);var c=Phaser.GameObjects.BitmapText;const l=i(15),d=i(20),h=i(105),u=16,g=4,p={width:100,height:30};class m extends r.ResponsiveContainer{constructor(e){super(e),this.background=new n(this.scene),this.menuButton=new h.RibbonButton(this.scene,0,0,{type:h.RibbonButtonStyle.Small,icon:new s(this.scene,0,0,"atlas","ui/mini-icons/up").setTint(d.Colors.woodenUi.primaryText),content:new c(this.scene,0,0,l.BitmapFont.Small,"MENU").setTint(d.Colors.woodenUi.primaryText),width:p.width}),this.width=p.width+2*g,this.height=p.height+2*g,this.menuButton.onClicked(()=>{a.inject.events.trigger(o.UserActions.GoBack())}),this.add([this.background,this.menuButton])}updateLayout(){this.background.clear(),this.background.fillStyle(16777215,.5),this.background.fillRoundedRect(0,0,this.width,this.height,{tl:0,tr:0,bl:u,br:u}),this.menuButton.setPosition(g,g)}}t.MenuPanel=m},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompactPlayUI=void 0;const n=i(35),s=i(195),a=i(196),o=i(97),r=i(1),c=i(395),l=i(129),d=i(0),h=i(6),u=i(197),g=i(199),p=i(200);r.logger.for("ui:PlayUI");t.CompactPlayUI=class{constructor(e,t){this.scene=e,this.state=t,this.pawnHolder=new s.PawnHolder(this.scene),this.regionSummaryPopup=new g.RegionSummaryPopup(this.scene),this.regionPanel=new c.CompactRegionPanel(this.scene),this.shoppingTray=new a.ShoppingTray(this.scene,l.COMPACT_PLAY_UI_LAYOUT.shoppingTray),this.powerBalanceRibbon=new u.PowerBalanceRibbon(this.scene,{x:0,y:0,width:100,minSize:24}),this.endTurnButton=new m(this.scene),this.undoButton=new f(this.scene),this.nextPendingRegionButton=new y(this.scene),this.skipSpectatingButton=new v(this.scene),this.endTurnButton.onClicked(()=>d.inject.events.trigger(h.UserActions.EndTurn())),this.undoButton.onClicked(()=>d.inject.events.trigger(h.UserActions.Undo())),this.nextPendingRegionButton.onClicked(()=>d.inject.events.trigger(h.UserActions.SelectNextPendingRegion())),this.skipSpectatingButton.onClicked(()=>d.inject.events.trigger(h.UserActions.SkipSpectating())),this.layer=new p.ResponsiveLayer(this.scene,[this.powerBalanceRibbon,this.regionPanel,this.shoppingTray,this.endTurnButton,this.skipSpectatingButton,this.nextPendingRegionButton,this.undoButton,this.regionSummaryPopup]),this.scene.add.existing(this.layer),this.updateLayout(),d.inject.ui.withoutTransitions(()=>{this.updateState(this.state)})}transitionIn(e){}transitionOut(e){}destroy(){this.layer.destroy()}update(){this.pawnHolder.update()}updateLayout(){const e=this.scene.cameras.main.displayWidth,t=this.scene.cameras.main.displayHeight;this.regionPanel.reflow(),this.shoppingTray.updateLayout(),this.undoButton.setPosition(0,t-this.undoButton.height),this.endTurnButton.setPosition(e-this.endTurnButton.width,t-this.endTurnButton.height),this.nextPendingRegionButton.copyPosition(this.endTurnButton),this.skipSpectatingButton.copyPosition(this.endTurnButton),this.powerBalanceRibbon.setDimensions(l.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides,t-this.powerBalanceRibbon.height,e-2*l.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides)}updateState(e){var t;this.state;if(this.state=Object.assign(Object.assign({},this.state),e),this.regionPanel.updateState(e),void 0!==e.mode)switch(e.mode){case n.PlayUIMode.Hidden:this.endTurnButton.setVisible(!1),this.nextPendingRegionButton.setVisible(!1),this.undoButton.setVisible(!1),this.shoppingTray.setOpen(!1),this.skipSpectatingButton.setVisible(!1);break;case n.PlayUIMode.Spectating:this.endTurnButton.setVisible(!1),this.nextPendingRegionButton.setVisible(!1),this.undoButton.setVisible(!1),this.shoppingTray.setOpen(!1),this.skipSpectatingButton.setVisible(this.state.enableSkipSpectating);break;case n.PlayUIMode.OwnedRegionSelected:case n.PlayUIMode.HostileRegionSelected:case n.PlayUIMode.Standby:e.mode!==n.PlayUIMode.OwnedRegionSelected?this.shoppingTray.setOpen(!1):this.shoppingTray.setOpen(!0),this.endTurnButton.setVisible(!this.state.hasPendingRegions),this.nextPendingRegionButton.setVisible(this.state.hasPendingRegions),this.undoButton.setVisible(!0),this.undoButton.setEnabled(this.state.enableUndo),e.mode!==n.PlayUIMode.HostileRegionSelected&&this.regionSummaryPopup.hide()}e.regionData&&(e.mode===n.PlayUIMode.HostileRegionSelected?this.regionSummaryPopup.showOverRegion(e.regionData.id):e.mode===n.PlayUIMode.OwnedRegionSelected&&this.shoppingTray.setDisplayedPawns(null===(t=e.regionData)||void 0===t?void 0:t.buyablePawns)),void 0!==e.activeFactionColor&&e.mode===n.PlayUIMode.OwnedRegionSelected&&this.shoppingTray.setColor(e.activeFactionColor),void 0!==e.powerBalance&&this.powerBalanceRibbon.updateState(e.powerBalance),void 0!==e.enableSkipSpectating&&this.skipSpectatingButton.setVisible(e.enableSkipSpectating)}setVisible(e){this.layer.setVisible(e)}};class m extends o.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-turn",down:!0})}}class f extends o.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-undo",down:!0,disabled:!0})}}class y extends o.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-next",down:!0})}}class v extends o.ImageButton{constructor(e){super(e,0,0,{frame:"ui/compact/btn-skip",down:!0})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompactRegionPanel=t.ExpandedState=void 0;const n=i(28),s=i(129),a=i(35),o=i(396),r=i(38);var c;!function(e){e.Hidden="hidden",e.Collapsed="collapsed",e.Expanded="expanded"}(c=t.ExpandedState||(t.ExpandedState={}));const l={[c.Expanded]:s.COMPACT_PLAY_UI_LAYOUT.regionPanel.height,[c.Collapsed]:0,[c.Hidden]:0};class d extends n.Box{constructor(e){super(e,n.BoxTexture.Plate,0,0,0,s.COMPACT_PLAY_UI_LAYOUT.regionPanel.height),this.expandedState=c.Collapsed,this.mode=a.PlayUIMode.Standby,this.regionLabel=new o.CompactRegionLabel(this.scene,0,s.COMPACT_PLAY_UI_LAYOUT.regionPanel.height),this.yController=r.Control.propOf(this,"y",{duration:s.COMPACT_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.setDepth(a.PlayUILayers.MainPanel),this.add(this.regionLabel)}updateState(e){void 0!==e.mode&&this.setMode(e.mode),e.regionData&&this.mode===a.PlayUIMode.OwnedRegionSelected&&this.regionLabel.setRegionInfo(e.regionData),void 0!==e.heldPawnData&&this.regionLabel.setBuyingPawnInfo(e.heldPawnData)}setMode(e){if(e!==this.mode)switch(this.mode=e,e){case a.PlayUIMode.OwnedRegionSelected:this.setExpandedState(c.Expanded);break;default:this.setExpandedState(c.Hidden)}}setExpandedState(e){const t=this.scene.cameras.main.displayHeight-l[e];this.yController.transitionTo(t),this.expandedState=e}reflow(){const e=this.scene.cameras.main.displayHeight,t=this.scene.cameras.main.displayWidth-2*s.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides;let i=0;switch(this.expandedState){case c.Hidden:case c.Collapsed:i=e;break;case c.Expanded:i=e-s.COMPACT_PLAY_UI_LAYOUT.regionPanel.height}this.setPosition(s.COMPACT_PLAY_UI_LAYOUT.regionPanel.offsetFromSides,i),this.setSize(t,s.COMPACT_PLAY_UI_LAYOUT.regionPanel.height),this.yController.setTo(i),this.regionLabel.width=t,this.regionLabel.updateNumbersLayout()}}t.CompactRegionPanel=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompactRegionLabel=void 0;const n=i(194),s=i(38),a=i(19),o=i(129);var r=Phaser.GameObjects.Image;const c=16,l=16,d=400;class h extends Phaser.GameObjects.Container{constructor(e,t,i){super(e),this.width=t,this.height=i,this.treasuryTextController=new s.TransitionController(this.scene,{duration:d,initialValue:0,applyValue:e=>{this.treasuryText.setText(e.toFixed(0))}}),this.incomeTextController=new s.TransitionController(this.scene,{duration:d,initialValue:0,applyValue:e=>{this.incomeText.setText((0,a.withSign)(Math.trunc(e))),this.updateTrendIcon(e),this.updateNumbersLayout()}}),this.visibilityController=s.Control.visibilityOf(this,{duration:o.COMPACT_PLAY_UI_LAYOUT.panelTransitionsDuration}),this.regionInfo={buyablePawns:[],name:"",treasury:0,income:0,id:-1,townLevel:1};const h=this.width,u=c+l/2;this.treasuryText=new n.RegionLabelText(e,h-c-64,u,"0").setOrigin(1,.5),this.goldIcon=new r(e,h-c-60,u,"atlas","ui/budget-icons/treasury").setOrigin(0,.5),this.incomeText=new n.RegionLabelText(e,h-c-16,u,"+8").setOrigin(1,.5),this.trendIcon=new r(e,h-c-6,u,"atlas","ui/budget-icons/surplus"),this.add([this.treasuryText,this.goldIcon,this.incomeText,this.trendIcon])}setBuyingPawnInfo(e){if(e){const{cost:t,upkeep:i}=e;this.treasuryTextController.transitionTo(this.regionInfo.treasury-t),this.incomeTextController.transitionTo(this.regionInfo.income-i)}else this.treasuryTextController.transitionTo(this.regionInfo.treasury),this.incomeTextController.transitionTo(this.regionInfo.income)}updateTrendIcon(e){this.trendIcon.setFrame((0,n.getBudgetIcon)(e))}show(){this.visibilityController.transitionTo(1)}hide(){this.visibilityController.transitionTo(0)}setRegionInfo(e){const t=this.regionInfo.id===e.id;this.regionInfo=e,t?(this.treasuryTextController.transitionTo(e.treasury),this.incomeTextController.transitionTo(e.income)):(this.treasuryTextController.setTo(e.treasury),this.incomeTextController.setTo(e.income)),this.updateNumbersLayout()}updateNumbersLayout(){const e=this.width/2;(0,n.layoutFromCenter)(e,6,[this.goldIcon,this.treasuryText,this.incomeText,this.trendIcon])}}t.CompactRegionLabel=h},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DebugScene=void 0;const s=i(36),a=i(16),o=i(0),r=i(19),c=i(5),l=i(8),d=i(15),h=i(3),u=i(180);class g extends s.Scene{constructor(){super({key:a.Scenes.Debug,pixelArt:!1}),this.debugData=o.inject.debugData,this.suppressBreakPoints=!1}create(){this.cameras.main.setOrigin(0,0).setZoom(o.inject.ui.scale),this.controller=o.inject.gameStateController,this.cursorPosLabel=new d.DebugTextBox(this,100,100,"(left, top)"),this.topLeftLabel=new d.DebugTextBox(this,10,10,"[left, top] - [left,top]",{dropShadow:!1}),this.pointer=this.input.activePointer,this.horizontalGuideLine=this.add.line(0,0,1,1).setOrigin(0,0).setStrokeStyle(1,255,.25),this.verticalGuideLine=this.add.line(0,0,1,1).setOrigin(0,0).setStrokeStyle(1,255,.25),this.breakpointLabel=this.add.text(0,0,"",{fontFamily:'"Monospace"',color:"#0000ff",fontSize:"24px"}).setVisible(!1).setOrigin(.5);const e=this.input.keyboard.addKey("N"),t=this.input.keyboard.addKey("C");e.on("down",e=>{this.resumeFromBreakpoint()}),t.on("down",e=>{this.suppressBreakPoints=!0,this.resumeFromBreakpoint(),setTimeout(()=>this.suppressBreakPoints=!1,3e3)}),o.inject.ui.hexUnderCursor.watch(e=>{if(e){const t=this.scene.get(a.Scenes.WorldMap).chunkedRenderer.getByHex(e);this.debugData.set("hexInfo",function(e,t){var i,n;try{const s=o.inject.gameStateModel,u=o.inject.game.scene.getScene(a.Scenes.WorldMap),g=s.regions.byHex(e),p=s.factions.byHex(e),m=s.currentPhase.faction,f=g?`\nâš ${g.name||"region"} #${g.id} ${function(e){const t=o.inject.gameStateModel;if(!(0,c.isDataSetActive)(t.state,l.GameState.economy.budgetByRegion))return"";const i=t.economy.budgetOf(e);return`(${e.hexes.length}${d.GLYPH.hex} ${t.economy.treasuryOf(e)}${(0,r.withSign)(i.balance)}=${t.economy.treasuryOf(e)+t.economy.budgetOf(e).balance}${d.GLYPH.coin})`}(g)}`:"",y=p?"\n owned by "+p:"",v=s.pawns.byHex(e).map(e=>`${e.type}${1!==e.count?" Ã—"+e.count:""} #${e.id} ${s.currentPhase.isMovable(e)?"(M)":""}`).join("\nâ™– "),w=v.length?"\nâ™– "+v:"";let b=o.inject.config.debug.gameObjects&&(null===(i=u.tiles.getByHex(e.id))||void 0===i?void 0:i.getDebugData())||"";b&&(b="\n"+b);let S="";return o.inject.debugLayers.activeLayerName&&(S=`\n${o.inject.debugLayers.activeLayerName}:\n  ${null===(n=o.inject.debugLayers.activeLayer.getDetail(e))||void 0===n?void 0:n.replace(/\n/g,"\n  ")}`),s.pawns.presentAtHex(e,h.PawnType.Town)&&p&&m&&(S+=`\nFaction ${p.id}:\n  Attitude: ${p.attitudeTowards(m)} (F: ${p.fearOf(m)} A: ${p.approvalOf(m)})`),`${e}[chunk #${t}]${f}${y}${w}${S}${b}`}catch(e){return"â›” "+e.toString()}}(e,t.id))}else this.debugData.clear("hexInfo")})}resumeFromBreakpoint(){this.resumeFromBreakpointCallback&&(this.resumeFromBreakpointCallback(),this.resumeFromBreakpointCallback=void 0,this.breakpointLabel.setVisible(!1))}update(){var e;const t=this.scene.get(a.Scenes.WorldMap);this.pointer.updateWorldPoint(t.cameras.main),this.cursorPosLabel.setText(`C(${Math.round(this.pointer.x)},${Math.round(this.pointer.y)}) W(${Math.round(this.pointer.worldX)},${Math.round(this.pointer.worldY)})\n${this.debugData.get("hexInfo")||""}`);const i=this.cameras.main;this.topLeftLabel.setText(`v1 ${i.width}x${i.height} (DPR=${window.devicePixelRatio||1}, ui scale=${o.inject.ui.scale}) ${Math.floor(this.game.loop.actualFps)} FPS\ncontentLeft:${o.inject.device.contentLeft} contentRight:${o.inject.device.contentRight}\nscreen: ${null===(e=o.inject.navigator.currentScreen)||void 0===e?void 0:e.constructor.name}\n${function(e){const t="scenes:          state    DL  UL  TW A V",i=e.map(e=>(0,u.padRight)("-"+e.scene.key,16)+" "+(0,u.padRight)(p[e.sys.settings.status],8)+(0,u.padLeft)(e.sys.displayList.length.toString(),3)+" "+(0,u.padLeft)(e.sys.updateList.length.toString(),3)+" "+(0,u.padLeft)(e.tweens.getAllTweens().length.toString(),3)+" "+(e.sys.isActive()?"* ":"  ")+(e.sys.isVisible()?"* ":"  "));return[t,...i].join("\n")}(this.game.scene.getScenes(!0))}\n${function(){var e,t;if(!o.inject.currentGameState)return"Map: N/A";const i=o.inject.gameStateModel.map,n=o.inject.gameStateModel.currentPhase;return`level: ${i.levelId} ${i.width}x${i.height} turn ${n.turnNumber} (${n.type} ${null!==(t=null===(e=n.faction)||void 0===e?void 0:e.id)&&void 0!==t?t:""})`}()}\n${o.inject.debugData.getText()}`),this.cursorPosLabel.setPosition((this.pointer.x+20)/o.inject.ui.scale,(this.pointer.y+20)/o.inject.ui.scale),this.horizontalGuideLine.setTo(0,this.pointer.y,this.cameras.main.width,this.pointer.y),this.verticalGuideLine.setTo(this.pointer.x,0,this.pointer.x,this.cameras.main.height)}handleBreakpoint(e,t){return n(this,void 0,void 0,(function*(){const i=o.inject.scene.worldMap;if(!this.suppressBreakPoints)return new Promise(n=>{i.setSelectedRegion(t.region),t.hexes?i.conquerableHexesHighlight.set(t.hexes):i.conquerableHexesHighlight.clear();let s=o.inject.debugLayers.activeLayerName;t.debugLayer&&("string"==typeof t.debugLayer?o.inject.debugLayers.activate(t.debugLayer):o.inject.debugLayers.registerAndActivate("breakpointDebugLayer",t.debugLayer)),this.resumeFromBreakpointCallback=()=>{i.setSelectedRegion(void 0),i.conquerableHexesHighlight.clear(),t.debugLayer&&o.inject.debugLayers.activate(s),n()},this.breakpointLabel.setVisible(!0),this.breakpointLabel.setText("â¸ï¸ "+e+"\n [N] step [C] continue"),this.breakpointLabel.setPosition(this.cameras.main.centerX,this.cameras.main.height-100)})}))}}t.DebugScene=g;const p={0:"pending",1:"init",2:"start",3:"loading",4:"creating",5:"running",6:"paused",7:"sleeping",8:"shutdown",9:"destroyed"}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugHistoryScene=void 0;const n=i(36),s=i(16),a=i(0),o=i(15);class r extends n.Scene{constructor(){super({key:s.Scenes.DebugHistory,pixelArt:!1}),this.currentIndex=0}create(){this.controller=a.inject.gameStateController,this.historyLabel=new o.DebugTextBox(this,10,40,"Frames:",{dropShadow:!1,origin:[0,1]});const e=this.input.keyboard.addKey(n.Input.Keyboard.KeyCodes.ESC),t=this.input.keyboard.createCursorKeys();e.on("down",e=>{a.inject.navigator.goTo(a.inject.screen.play)}),t.down.on("down",e=>{this.goToNextFrame()}),t.up.on("down",()=>{this.goToPreviousFrame()})}goToNextFrame(){this.currentIndex!==a.inject.history.length()&&(this.currentIndex++,this.currentIndex===a.inject.history.length()?this.loadState(this.suspendedCurrentState):this.loadState(a.inject.history.get(this.currentIndex).state))}goToPreviousFrame(){0!==this.currentIndex&&(this.currentIndex===a.inject.history.length()&&(this.suspendedCurrentState=a.inject.gameStateModel.state),this.currentIndex--,this.loadState(a.inject.history.get(this.currentIndex).state))}loadState(e){a.inject.gameStateModel.restore(e),a.inject.scene.worldMap.setSelectedRegion(void 0),a.inject.scene.worldMap.conquerableHexesHighlight.clear(),a.inject.scene.worldMap.syncState(e)}resetCursor(){this.currentIndex=a.inject.history.length()}update(){const e=[...a.inject.history.getAll(),{label:"(CURRENT STATE)",state:a.inject.gameStateModel.state}];this.currentIndex>e.length&&(this.currentIndex=e.length-1);const t=e.map((e,t)=>(this.currentIndex===t?"->":"  ")+e.label).join("\n");this.historyLabel.setText(t),this.historyLabel.setPosition(10,this.cameras.main.displayHeight-10)}}t.DebugHistoryScene=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TitleScreenUIScene=void 0;const n=i(16),s=i(0),a=i(201),o=i(403),r=i(32),c=i(83),l=i(6),d=i(47);var h=Phaser.GameObjects.Rectangle;const u=i(106);var g=Phaser.GameObjects.Image;class p extends d.BaseUIScene{constructor(){super({key:n.Scenes.TitleScreenUI}),this.state=(0,u.StateContainer)(this,{resumeButton:{enable:!1}}),this.preUpdate=(0,r.whenDirty)(()=>{const e=a.TitleScreen.Layout.mainMenuPanel,t=(this.bounds.width,this.bounds.height);this.bounds.contentWidth<1.5*e.width?(this.mainMenuPanel.setPosition(0,0),this.mainMenuPanel.setSize(this.bounds.contentWidth,t)):(this.mainMenuPanel.setPosition(this.bounds.contentRight-e.width,0),this.mainMenuPanel.setSize(e.width,t)),this.decorativeStripe.setPosition(this.mainMenuPanel.x-2*e.stripeWidth,0),this.decorativeStripe.setSize(e.stripeWidth,t),this.decorativeStripeRight.setPosition(this.mainMenuPanel.x+this.mainMenuPanel.width+e.stripeWidth,0),this.decorativeStripeRight.setSize(e.stripeWidth,t),this.buttons.forEach(t=>{t.setSize(this.mainMenuPanel.width-80,e.buttons.height),t.rounded=1}),c.Arrange.fromTopToBottom(this.buttons,{x:this.mainMenuPanel.x+40,y:t/2,originY:.5,spacing:e.buttons.spacing});const i=this.buttons[0].y;if(this.gameLogo.setPosition(this.mainMenuPanel.x+this.mainMenuPanel.width/2,i/2),this.state().resumeButton.enable){const t=this.buttons[this.buttons.length-1];this.resumeButton.setPosition(this.mainMenuPanel.x-60,t.y+t.height+2*e.buttons.spacing),this.resumeButton.setSize(this.mainMenuPanel.width+20,e.buttons.height+10),this.resumeButton.setVisible(!0)}else this.resumeButton.setVisible(!1)})}applyState(e,t,i){this.preUpdate.makeDirty()}create(){super.create(),console.log("PLUGINS",this.plugins.plugins,this.plugins.scenePlugins),this.scale.on("resize",()=>{s.inject.scene.worldMap.cameraController.center()}),this.gameLogo=new g(this,0,0,"atlas","logos/game-title"),this.mainMenuPanel=new h(this,0,0,0,0,11656690,.77),this.decorativeStripe=new h(this,0,0,0,0,11656690,.77),this.decorativeStripeRight=new h(this,0,0,0,0,11656690,.77);const e=(e,t)=>{const i=new o.RoundedRectButton(this,{text:e,audio:!0});return i.onClicked(t),i};this.buttons=[e("Campaign",()=>{s.inject.events.trigger(l.UserActions.GoToLevelSelect({campaignId:"intro"}))}),e("Quick play",()=>{s.inject.events.trigger(l.UserActions.OpenNewGameDialog())}),e("Custom maps",()=>{}),e("How to play",()=>{})],this.resumeButton=new o.RoundedRectButton(this,{text:"Continue game"}),this.resumeButton.onClicked(()=>s.inject.events.trigger(l.UserActions.ResumeGame())),this.addAll([this.mainMenuPanel,this.gameLogo,this.decorativeStripe,this.decorativeStripeRight,...this.buttons,this.resumeButton])}}t.TitleScreenUIScene=p},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BUILT_IN_MAPS=void 0,t.BUILT_IN_MAPS={titleScreenLevel:"konkrmap.v7.eyJtYXAiOnsid2lkdGgiOjIwLCJoZWlnaHTGDHRoZW1lIjoiZGVmYXVsdCJ9LCJ2ZXJzaW9uIjo3LCJyZWdpb25zIjpbeyJpZCI6MSwibmHFMWtpbmdkb20ixE94ZcQiNjEwLDYxMSw2MTIsNjEzXX0sxjQy2zQxNTA0LDE1MDXEBTfEBTgsMTbGFDnECjXEBTfEBTgsMTLEDzPGBTYsMTTEKDTEDzTEDzUwynQ03HQzMTIsMTMxMywxNMQKNTEwxAUxxAUyLDEyxA8yxA8yxigxyVY121Y3MDUsNzA2LOQAzDUwNizkAMXkAL82MDbJQDfcQDEyLDcxMyw4MTIsODEzLDnFDDEsODEwLDfrAIQ420Q5MDYsOTA3LDkwOCw55AFAMOQBGDDkAUAw5AFAMeQBLDDEGTHEGTHEGTHGGTnkAV42xAU3yWsx/AG6NTE2LDUxNyw2MeoA4DH8AOE4MDQsOcUE5QCFM8QFNMk7MvwCWjExxC8x5AHvMsYF6wJeM9w5M8Q5M8xo/QIaMeQB9zExMMov/ADSMTfkAUE35AFBOMQKODA4yjn8Aag4MDgsODA5LDnMajndMTUsOOsCSTT8AS43y1Y0/AEeNzE0LDcxNcot/AEc5ADs5ADrNzA5LDjrAiU0/AMVMTAwy1822yo07AO9/AF1OeYCOjLKLvwBajE17AE2/AFjMTTrANU1MNwqMuQDLjPrAWY1/QK9M8RZXSwiZmFjdO0FTcplbmF0dXJlIucFj0luZGV4xR9jb250cm9sbGVyxCVvbsQj6gWT5ASjLDQ0LDQ1LDQ2LDQ3LDQ4LDQ5LDUwLDLqAU3qAJtQbGF5ZXIgMSLPWGxvY2FsLXVzZXLyAIHKbTIsNDMsMeoBI+oEHMdYMtBYYWnPUDHMUDQsNDEsNeoE2OoCqcdQM99Q5QCDylAyNywy6gN/6gLKx040307lAIHKTjUsMjEsMuoEN+oC5cdQNd9Q5QCDylA3LDI5yU3qAwjHTTbfTeUAgMpN6gDnLeoB3v8CQ/cCQ+UCmXBhd+4H43R5cMRTdG93buYCySI65AepyHYy1SI2MDXIITPWQzMxMsgiNNYiMjA3yCI11SI5MTPIITbJIWNhc3Rs5ADYxkU1MMkkN9gkNOoAizjLJG1wyCI2MTDIITHkCSfSIuQGXMkj6gE1Y29pbnPJJOQI3yJjb3VudMRIyS/qAULOLzIwN9Qv6gFQzi/kCMnTL+oBXc0v5AhS0y7qAWnNLuQIvMgu6QEsMeoBdWZvcmVzdMku6gGY5AgF1yTKSOoBddAkMckkOdckNTE2yCTlCsLUJDcwOckk6gGc0CQ4ySTqAZHQJOkCkeQIadUkOMsk6gF7ziTkBwnJJeoBcs4lNOoCUTL4AWnkBvvJJfgBajnLSfgBauQJFskl+AFr5Ac/yCUz+AFs5Ac6ySX4AW3kBzDJJfgBbuQHWskl6gFLcGlrZW1h6gQmNOsEauoBA2tu5QzWyCUx6wCV6gEEdmlsbGFn5QbqxSc46gJwM+oBBdAm5AwPyCc06gEH0Cc36gCY5Amh1yY5MDnkBXVydWxlU2V06w17LCJjdXJyZW50UGhhc2XkDbR0dXJuTnVtYuQFvDHpCEHsBaPHEy3EKuQF/GFwcGVkVW5pdOYF3X0="}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.transitionToLevelSelect=void 0;const s=i(0),a=i(23),o=i(202);t.transitionToLevelSelect=function(e){return n(this,void 0,void 0,(function*(){const t=s.inject.scene.titleScreenUI,i=s.inject.scene.levelSelectUI,n=s.inject.scene.menuHeaderUI;return new Promise(r=>{const c=s.inject.config.screenTransitionDuration;t.tweens.add({targets:t.buttons[e],props:{x:0,y:0,width:s.inject.device.screenWidth,height:o.MenuHeaderUIScene.Layout.panelHeight,rounded:0},duration:c,onComplete:()=>{t.preUpdate.makeDirty(),r()}}),t.tweens.add({targets:[s.inject.scene.worldMap.cameras.main],scrollY:1e3,duration:c,ease:"Sine.easeIn"}),t.tweens.add({targets:[t.mainMenuPanel,t.decorativeStripe,t.decorativeStripeRight,...(0,a.without)(t.buttons,t.buttons[e]),t.resumeButton,t.gameLogo],props:{x:"+="+(s.inject.device.screenWidth-t.decorativeStripe.x)},duration:c,ease:"Sine.easeIn"}),i.preUpdate(),n.preUpdate(),n.scene.setVisible(!1),i.tweens.add({targets:i.levelCards,y:{start:(e,t,i,n)=>e.y+s.inject.device.screenHeight,to:"-="+s.inject.device.screenHeight},delay:(e,t,i,n)=>n*(c/100),duration:c,ease:"Sine.easeOut"})}).then(()=>{n.scene.setVisible(!0)})}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.transitionToPlayScene=void 0;const s=i(0);t.transitionToPlayScene=function(){return n(this,void 0,void 0,(function*(){s.inject.scene.playUI.activeUI.transitionIn()}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoundedRectButton=void 0;var n=Phaser.GameObjects.BitmapText,s=Phaser.Geom.Rectangle;const a=i(22),o=i(15),r=i(20),c=i(130),l=i(44),d=i(78);class h extends a.BaseResponsiveContainer{constructor(e,t){super(e),this._rounded=1,this.background=new c.RoundedRect(this.scene,{x:0,y:0,fillStyle:{color:12969202,alpha:1},radius:0}),this.icon=t.icon,this.label=new n(this.scene,4,4,o.BitmapFont.Main,t.text).setTint(r.Colors.glassUi.primaryText),this.add([this.background,this.label]),this.icon&&this.add([this.icon]),this.setInteractive({hitArea:new s(this.width/2,this.height/2,this.width,this.height),hitAreaCallback:s.Contains,cursor:"pointer"}),this.setController((0,d.setupController)(t))}setController(e){e&&(this.controller=e,e.bindTo(this,e=>this.onNewButtonState(e)))}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}set text(e){this.label.setText(e),this.preUpdate.makeDirty()}get text(){return this.label.text}set rounded(e){this._rounded=e}get rounded(){return this._rounded}onNewButtonState(e){switch(e){case l.ButtonState.Hover:case l.ButtonState.Down:this.background.setFillStyle(r.Colors.glassUi.shapeLightAccent);break;default:this.background.setFillStyle(r.Colors.glassUi.shape)}}updateLayout(){this.input.hitArea.setTo(this.width/2,this.height/2,this.width,this.height),this.background.radius=this.height/2*this._rounded,this.background.setSize(this.width,this.height),this.label.setPosition(60,Math.round(this.height/2-this.label.height/2))}}t.RoundedRectButton=h},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SmallLevelCardContent=t.SmallLevelCard=t.LevelSelectUIScene=void 0;const s=i(16),a=i(0),o=i(32),r=i(83),c=i(6),l=i(20),d=i(131),h=i(36),u=i(15),g=i(79),p=i(47),m=i(22),f=i(132);var y=Phaser.GameObjects.BitmapText,v=Phaser.GameObjects.Image;class w extends p.BaseUIScene{constructor(){super({key:s.Scenes.LevelSelectUI}),this.levelCards=[],this.preUpdate=(0,o.whenDirty)(()=>{a.inject.device.screenWidth,a.inject.device.screenHeight;r.Arrange.fromLeftToRight(this.levelCards,{x:this.bounds.contentLeft+g.DEFAULT_CONTENT_PADDING,y:200+g.DEFAULT_CONTENT_PADDING,originX:0,spacing:w.Layout.cardSpacing,maxWidth:this.bounds.contentWidth-2*g.DEFAULT_CONTENT_PADDING})})}create(){super.create(),this.bindKey(h.Input.Keyboard.KeyCodes.ESC,c.UserActions.GoBack)}loadCampaign(e){for(let e of this.levelCards)e.destroy();this.levelCards.forEach(e=>e.destroy(!0)),this.levelCards=e.levels.map((e,t)=>new b(this,(0,f.getLevelIcon)(e.id),(t+1).toString(),()=>n(this,void 0,void 0,(function*(){a.inject.events.trigger(c.UserActions.GoToLevelDetail({levelId:e.id}))})))),this.addAll(this.levelCards),this.preUpdate.makeDirty()}}t.LevelSelectUIScene=w,w.Layout={cardSpacing:30};class b extends d.Card{constructor(e,t,i,n){super(e,{onClick:n,radius:20,clickable:d.CardPointerInputMode.Whole}),this.content=new S(e,this,t,i),this.setSize(100,100),this.footerSize=32}}t.SmallLevelCard=b;class S extends m.ResponsiveContainer{constructor(e,t,i,n){super(e),this.card=t,this._icon=new v(e,0,0,"atlas",i).setOrigin(.5,.5),this._text=new y(e,0,0,u.BitmapFont.Main,n).setOrigin(.5,0).setTint(l.Colors.glassUi.primaryText),this.add([this._icon,this._text])}setIcon(e){this._icon.setFrame(e),this.preUpdate.makeDirty()}setText(e){this._text.setText(e),this.preUpdate.makeDirty()}updateLayout(){super.updateLayout(),this._icon.setPosition(this.width/2,(this.height-this.card.footerSize)/2),this._text.setPosition(this.width/2,this.height-this._text.height-4)}}t.SmallLevelCardContent=S},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getLevelCardProps=t.LevelDetailUIScene=void 0;const s=i(16),a=i(0),o=i(32),r=i(6),c=i(47),l=i(132),d=i(1),h=i(106),u=i(406),g=i(76),p=i(133),m=i(203),f=i(407),y=i(2),v=i(111),w=i(408),b=i(409),S=i(99),x=i(107),P=i(40),T=i(131);var M=Phaser.Geom.Rectangle;const C=i(36),I=d.logger.for("LevelDetailUIScene"),O={campaignId:"",levels:[]};class _ extends c.BaseUIScene{constructor(){super({key:s.Scenes.LevelDetailUI}),this.cards=[],this.mapPreviewLoader=new f.AsyncJobQueue(this._loadMapPreview.bind(this)),this.state=(0,h.StateContainer)(this,O),this.currentLevelIndex=-1,this.mapPreviewPool=new b.Pool(()=>new w.MapPreview(this,this.layout.tileWidth,this.layout.tileHeight)),this.preUpdate=(0,o.whenDirty)(()=>{const{tileWidth:e,tileHeight:t,tileLeft:i,cardWidth:n,cardHeight:s,cardTop:a,cardLeft:o}=this.layout;this.updateCardsInView();for(let e=0;e<this.state().levels.length;++e)this.cards[e]&&(this.cards[e].setPosition(o(e),a),this.cards[e].setSize(n,s),this.cards[e].setAlpha(1));this.scrollController.cameraX.setTo(this.getCameraXByCardIndex(this.currentLevelIndex))})}calculateLayout(){const e={cardSpacing:30,tiles:{padding:40,offsetFromTop:140,offsetFromBottom:20},cards:{radius:40,minVisibleSizeTODO:40,footerSize:120}},t=Object.assign(Object.assign({},e),{tileTop:e.tiles.offsetFromTop,tileWidth:this.bounds.contentWidth,tileHeight:this.bounds.height-e.tiles.offsetFromBottom-e.tiles.offsetFromTop}),i=Object.assign(Object.assign({},t),{tileLeft:e=>e*t.tileWidth,cardWidth:t.tileWidth-2*t.tiles.padding,cardHeight:t.tileHeight-2*t.tiles.padding,cardTop:t.tiles.offsetFromTop+t.tiles.padding,cardLeft:e=>e*t.tileWidth+t.tiles.padding});this.layout=Object.assign(Object.assign({},i),{mapPreview:{top:i.cardTop,left:e=>i.cardLeft(e),width:i.cardWidth,height:i.cardHeight-i.cards.footerSize}})}create(){super.create();const e=this;this.scrollController=new u.ScrollableViewController(this.cameras.main,{horizontal:!0,vertical:!1,continueToNextStopThreshold:1e3,horizontalStops:{getNextFrom(t){let i=e.getCardIndexByCameraX(t);return t>e.getCameraXByCardIndex(i)&&i<e.state().levels.length-1&&(i+=1),e.getCameraXByCardIndex(i)},getPreviousFrom(t){let i=e.getCardIndexByCameraX(t);return t<e.getCameraXByCardIndex(i)&&i>0&&(i-=1),e.getCameraXByCardIndex(i)}}}),this.calculateLayout(),this.scale.on("resize",()=>this.calculateLayout()),this.bindKey(C.Input.Keyboard.KeyCodes.ESC,r.UserActions.GoBack)}refreshLevelCard(e){const t=this.state().levels.indexOf(e);if(-1===t)return void I.warning(`level ${e} does not exist in the current state, ignoring request to refresh map preview`);const i=this.cards[t];i&&(i.content.clearMapPreview(),this.mapPreviewLoader.addJob(e))}goToLevelIndex(e){this.currentLevelIndex=e,this.scrollController.cameraX.setTo(this.getCameraXByCardIndex(this.currentLevelIndex)),this.preUpdate.makeDirty()}get centralCard(){return this.cards[this.currentLevelIndex]}get leftCard(){const e=this.currentLevelIndex-1;if(-1!==e)return this.cards[e]}get rightCard(){const e=this.currentLevelIndex+1;if(!(e>=this.state().levels.length))return this.cards[e]}getCardIndexByCameraX(e,t=0){const i=Math.floor((e+this.bounds.contentLeft)/this.layout.tileWidth+t+.5),n=this.state().levels.length-1;return(0,g.cropNumber)(i,0,n)}getCameraXByCardIndex(e){return e*this.layout.tileWidth-this.bounds.contentLeft}getCardRectForIndex(e){const{tileWidth:t,tileHeight:i,cardWidth:n,cardHeight:s}=this.layout,a=this.layout,o=e*t+a.tiles.padding,r=a.tiles.offsetFromTop+a.tiles.padding;return M.FromXY(o,r,o+n,r+s)}applyState(e,t,i){e.campaignId&&e.campaignId!==i.campaignId&&(this.cards.forEach(e=>e.destroy()),this.cards=[],this.mapPreviewPool.freeAll(),this.mapPreviewLoader.clear()),e.levels&&this.updateCardsInView()}updateCardsInView(){this.createOrUpdateCard(this.currentLevelIndex-1),this.createOrUpdateCard(this.currentLevelIndex),this.createOrUpdateCard(this.currentLevelIndex+1)}createOrUpdateCard(e){var t;if(e<0||e>=this.state().levels.length)return;const i=this.state().levels[e];if(!this.cards[e]){const t=new m.LargeLevelCard(this,{radius:this.layout.cards.radius,footerSize:this.layout.cards.footerSize,clickable:T.CardPointerInputMode.WithoutFooter,onClick:()=>{this.currentLevelIndex===e?this.scrollController.dragging||a.inject.events.trigger(r.UserActions.PlayLevel({levelId:i})):this.scrollToLevel(i)}});this.cards[e]=t,t.setPosition(this.layout.cardLeft(e),this.layout.cardTop),t.setSize(this.layout.cardWidth,this.layout.cardHeight),this.add.existing(t),this.mapPreviewLoader.addJob(i)}const n=this.currentLevelIndex===e,s=A(this,"Island "+(e+1),i,n);null===(t=this.cards[e].content)||void 0===t||t.props.update(s),this.cards[e].setClickable(this.getCardInputMode(p.LevelModel.get(i).getLevelStatus(),e))}update(){const e=this.getCardIndexByCameraX(this.scrollController.cameraX.value);a.inject.debugData.set("HOVERING INDEX",e.toString()),e!==this.currentLevelIndex&&this.scrollController.cameraX.phase!==S.KineticValuePhase.Stable&&(this.currentLevelIndex=e,this.updateCardsInView()),this.scrollController.cameraX.phase!==S.KineticValuePhase.Stable||a.inject.scene.worldMap.scene.isVisible()?this.mapPreviewLoader.pause():this.mapPreviewLoader.resume()}_loadMapPreview(e){var t,i;return n(this,void 0,void 0,(function*(){const n=v.timing.start("loadMapPreview "+e),s=p.LevelModel.get(e);if((null===(t=s.parentCampaign)||void 0===t?void 0:t.id)!==this.state().campaignId)return;const o=null===(i=s.campaignContext)||void 0===i?void 0:i.indexInCampaign;y.assert.defined(o);const r=this.cards[o];if(r.content.mapPreviewLoaded)return;const c=yield s.getCurrentState();y.assert.defined(c,"Failed to load level "+s.id),y.assert.defined(r),a.inject.gameStateController.loadState(c,P.NewGameStateContext.Preview),a.inject.scene.worldMap.setMode(new x.PreviewMode),a.inject.scene.worldMap.syncState(a.inject.currentGameState),a.inject.scene.worldMap.chunksRenderingController.renderEverything(),r.content.loadMapPreviewFromWorldMap(),n.complete()}))}scrollToLevel(e){const t=this.state().levels.indexOf(e);if(-1===t)throw new Error(`Unable to scroll to level "${e}" - no such level found in the current state`);const i=this.getCameraXByCardIndex(t);this.scrollController.cameraX.pushTo(i)}getCardInputMode(e,t){return t!==this.currentLevelIndex||e===p.LevelStatus.InProgress||e===p.LevelStatus.NotStarted||e===p.LevelStatus.Replaying?T.CardPointerInputMode.WithoutFooter:T.CardPointerInputMode.NotClickable}}function A(e,t,i,n){var s,o,c,d,h,u,g,m,f,y;const v=p.LevelModel.get(i);function w(t,i){return{title:t,onClick:()=>{e.scrollController.dragging||a.inject.events.trigger(i)},visible:n}}const b={title:t};switch(v.getLevelStatus()){case p.LevelStatus.InProgress:return Object.assign(Object.assign({},b),{icon:l.LevelIcons.Fighting,primaryButton:w("CONTINUE",r.UserActions.PlayLevel({levelId:i})),secondaryButton:w("GIVE UP",r.UserActions.AbandonLevelProgress({levelId:i})),subTitle:"Turn "+(null!==(c=null===(o=null===(s=null==v?void 0:v.userData)||void 0===s?void 0:s.inProgress)||void 0===o?void 0:o.turnNumber)&&void 0!==c?c:"?")});case p.LevelStatus.Completed:const e=v.getNextUnfinishedLevelId();return Object.assign(Object.assign({},b),{icon:l.LevelIcons.Gold,primaryButton:e?w("NEXT",r.UserActions.PreviewLevel({levelId:e})):void 0,secondaryButton:w("PLAY AGAIN",r.UserActions.PlayLevel({levelId:i})),subTitle:`You won in ${null!==(u=null===(h=null===(d=null==v?void 0:v.userData)||void 0===d?void 0:d.bestResult)||void 0===h?void 0:h.turnNumber)&&void 0!==u?u:"unknown number of"} turns!`});case p.LevelStatus.Defeated:return Object.assign(Object.assign({},b),{icon:l.LevelIcons.Defeated,primaryButton:w("TRY AGAIN",r.UserActions.PlayLevel({levelId:i})),secondaryButton:null,subTitle:"They will pay for this!"});case p.LevelStatus.NotStarted:return Object.assign(Object.assign({},b),{icon:l.LevelIcons.NotStarted,primaryButton:w("PLAY",r.UserActions.PlayLevel({levelId:i})),secondaryButton:null,subTitle:""});case p.LevelStatus.Replaying:return Object.assign(Object.assign({},b),{icon:l.LevelIcons.Gold,primaryButton:w("CONTINUE",r.UserActions.PlayLevel({levelId:i})),secondaryButton:w("ABANDON",r.UserActions.AbandonLevelProgress({levelId:i})),subTitle:`Turn ${null===(m=null===(g=v.userData)||void 0===g?void 0:g.inProgress)||void 0===m?void 0:m.turnNumber}. (Previously won in ${null===(y=null===(f=v.userData)||void 0===f?void 0:f.bestResult)||void 0===y?void 0:y.turnNumber} turns)`});default:throw new Error(`requested level card props for locked level ${i} which has status ${v.getLevelStatus()} - this is not supported!`)}}t.LevelDetailUIScene=_,t.getLevelCardProps=A},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ScrollableViewController=void 0;const s=i(61),a=i(0),o=i(68),r=i(1),c=i(99);r.logger.for("ScrollableViewController");t.ScrollableViewController=class{constructor(e,t={}){this.camera=e,this.dragging=!1,this.deadzone=20,this.dragMomentumX=0,this.dragMomentumY=0,this.drag=3e3,this.dragStartPosition=void 0,this.enableX=!0,this.enableY=!0,this.scene=this.camera.scene,this.cameraY=new c.KineticValue(e.scrollX,{drag:this.drag,scene:this.scene,apply:e=>this.camera.scrollY=e,continueToNextStopThreshold:t.continueToNextStopThreshold}),this.cameraX=new c.KineticValue(0,{drag:this.drag,scene:this.scene,apply:e=>{this.camera.scrollX=e},continueToNextStopThreshold:t.continueToNextStopThreshold,stops:t.horizontalStops}),t.drag&&(this.drag=t.drag),!1===t.vertical&&(this.enableY=!1),!1===t.horizontal&&(this.enableX=!1),this.pointer=this.scene.input.activePointer,this.scene.input.on("pointerdown",this.handlePointerDown,this),this.scene.input.on("pointermove",this.handlePointerMove,this),this.scene.input.on("pointerup",this.handlePointerUp,this),this.scene.events.on("update",this.update,this)}detach(){this.scene.input.removeListener("pointermove",this.handlePointerMove),this.scene.input.removeListener("update",this.update)}update(e,t){this.dragMomentumX*=.8,this.dragMomentumY*=.8,this.enableX&&this.cameraX.update(e,t),this.enableY&&this.cameraY.update(e,t),a.inject.debugData.set("SCROLL",this.cameraX.value.toFixed(0))}startDrag(){this.dragging=!0,this.dragCursorIconOn(),this.cameraX.freeze(),this.cameraY.freeze()}stopDrag(){if(!this.dragging)return 0;this.dragging=!1,this.cameraX.unfreeze(),this.cameraY.unfreeze(),this.cameraX.accelerate(this.dragMomentumX),this.cameraY.accelerate(this.dragMomentumY),this.dragCursorIconOff()}panTo(e,t,i=0){return n(this,void 0,void 0,(function*(){const n=e-this.camera.width/2,s=t-this.camera.height/2;0===i?(this.enableX&&this.cameraX.setTo(n),this.enableY&&this.cameraY.setTo(s)):yield Promise.all([this.enableX&&this.cameraX.tweenTo(n,i,"Sine.easeInOut"),this.enableY&&this.cameraY.tweenTo(s,i,"Sine.easeInOut")])}))}dragCursorIconOn(){this.scene.game.canvas.style.cursor="grabbing"}dragCursorIconOff(){this.scene.game.canvas.style.cursor="default"}handlePointerMove(e){if(this.dragging){if(!e.isDown)return a.inject.events.trigger(o.WorldMapEvents.PointerUp({flags:0})),this.cameraX.unfreeze(),void this.cameraY.unfreeze();const t=e.position.x-e.prevPosition.x,i=e.position.y-e.prevPosition.y;this.dragMomentumX-=10*t,this.dragMomentumY-=10*i,this.enableX&&this.cameraX.setTo(this.cameraX.value-t/this.camera.zoom),this.enableY&&this.cameraY.setTo(this.cameraY.value-i/this.camera.zoom)}else if(this.dragStartPosition&&e.isDown){(0,s.euclidDistance)(this.dragStartPosition,{x:this.pointer.x,y:this.pointer.y})>this.deadzone&&this.startDrag()}}handlePointerDown(e){this.dragStartPosition=Object.assign({},e.position)}handlePointerUp(){this.dragStartPosition=void 0,this.stopDrag()}setBounds(e){this.camera.width,this.camera.height}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncJobQueue=void 0;i(1).logger.for("AsyncJobQueue");t.AsyncJobQueue=class{constructor(e){this.jobRunner=e,this.pendingJobs=[],this.paused=!1,this.currentPromise=void 0}addJob(e){this.pendingJobs.push(()=>this.jobRunner(e)),this.startNextJobIfIdle()}startNextJobIfIdle(){if(this.currentPromise||this.paused)return;const e=this.pendingJobs.shift();e&&(this.currentPromise=e().then(()=>{this.currentPromise=void 0,this.startNextJobIfIdle()}))}pause(){this.paused||(this.paused=!0)}resume(){this.paused&&(this.paused=!1,this.startNextJobIfIdle())}clear(){this.pendingJobs=[]}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapPreview=void 0;const n=i(0);var s=Phaser.GameObjects.RenderTexture;i(1).logger.for("MapPreview");t.MapPreview=class extends s{constructor(e,t=200,i=200){super(e,0,0,t,i)}updateFromWorldMap(){const e=n.inject.scene.worldMap.cameraController.worldBounds,t=e.width,i=e.height;n.inject.scene.worldMap.children.depthSort(),this.resize(t,i),this.clear(),this.camera.setScroll(e.x,e.y);const s=n.inject.scene.worldMap.children;this.draw(s),n.inject.config.debug.overlay}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Pool=void 0;const n=i(1).logger.for("Pool");t.Pool=class{constructor(e){this.factory=e,this.freeInstances=new Set,this.usedInstances=new Set}preload(e){for(;this.freeInstances.size<e;)this.freeInstances.add(this.factory())}take(){let e=this.freeInstances.values().next().value;return e?this.freeInstances.delete(e):e=this.factory(),this.usedInstances.add(e),e}free(e){this.usedInstances.has(e)?(this.usedInstances.delete(e),this.freeInstances.add(e)):n.warning(`redundant attempt to free ${e} - it is not marked as used in the Pool`)}freeAll(){this.usedInstances.forEach(e=>this.freeInstances.add(e)),this.usedInstances.clear()}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameOverScene=void 0;const n=i(32),s=i(47),a=i(16),o=i(53),r=i(15);var c=Phaser.GameObjects.Image,l=Phaser.GameObjects.BitmapText;const d=i(20),h=i(0),u=i(6);var g=Phaser.GameObjects.Rectangle;class p extends s.BaseUIScene{constructor(){super({key:a.Scenes.GameOver}),this.preUpdate=(0,n.whenDirty)(()=>{this.shield.setPosition(this.bounds.centerX,this.bounds.centerY+20),this.shieldOutline.setPosition(this.bounds.centerX,this.bounds.centerY+26),this.victoryHalo.setPosition(this.bounds.centerX,this.bounds.centerY),this.victoryRays.setPosition(this.bounds.centerX,this.bounds.centerY),this.ribbon.width=400,this.ribbon.setPosition(this.bounds.centerX-this.ribbon.width/2,this.bounds.centerY+60),this.ribbonText.setPosition(this.bounds.centerX,this.bounds.centerY+66),this.ribbonText.setText("You are victorious!"),this.trophy.setPosition(this.bounds.centerX,this.bounds.centerY),this.backgroundOverlay.setSize(this.bounds.width,this.bounds.height)})}create(){super.create(),this.shield=this.createImage("shield"),this.shieldOutline=this.createImage("shieldOutline"),this.victoryHalo=this.createImage("victoryHalo"),this.victoryRays=this.createImage("victoryRays"),this.ribbon=new o.Ribbon(this,o.RibbonTexture.Pergamen,0,0,200),this.ribbonText=new l(this,0,0,r.BitmapFont.Main).setTint(d.Colors.woodenUi.primaryText).setOrigin(.5,0),this.trophy=this.createImage("trophy"),this.backgroundOverlay=new g(this,0,0,0,0,16777215,.5),this.addAll([this.backgroundOverlay,this.shieldOutline,this.victoryHalo,this.victoryRays,this.shield,this.trophy,this.ribbon,this.ribbonText]),this.tweens.add({targets:this.victoryRays,props:{angle:{from:0,to:360}},repeat:-1,duration:1e4}),this.input.on("pointerdown",()=>{this.continue()})}continueAutomaticallyAfter(e=5e3){setTimeout(()=>this.continue(),e)}continue(){this.scene.isActive()&&h.inject.events.trigger(u.UserActions.GoToLevelDetail({levelId:h.inject.ui.playedLevelId()}))}createImage(e){return new c(this,0,0,"gameOverAtlas",e)}}t.GameOverScene=p},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GlobalUIScene=void 0;const n=i(16),s=i(0),a=i(47),o=i(32),r=i(412),c=i(20),l=i(83),d=i(38),h=i(6);class u extends a.BaseUIScene{constructor(){super({key:n.Scenes.GlobalUI}),this.topOffset=20,this.topOffsetController=new d.TransitionController(this,{duration:200,ease:"Sine.easeInOut",initialValue:this.topOffset,applyValue:e=>{this.topOffset=e,this.preUpdate.makeDirty()}}),this.preUpdate=(0,o.whenDirty)(()=>{const{toggleFullScreenButton:e,toggleSoundButton:t,helpButton:i}=this.comps;e.setVisible(this.scale.fullscreen.available),t.setVisible(!s.inject.device.isMobile());const n=[t,e,i].filter(e=>e.visible);l.Arrange.fromLeftToRight(n,{x:this.bounds.contentLeft+this.bounds.contentWidth-20,originX:1,y:this.topOffset,padding:0,spacing:2})})}create(){super.create(),this.comps=this.createComponents(),this.addAll(Object.values(this.comps)),this.handleEventWhileActive(h.SystemEvents.ScreenActivated,this.adjustLayoutBasedOnScreen.bind(this))}adjustLayoutBasedOnScreen(e){switch(e){case s.inject.screen.play:this.topOffsetController.transitionTo(4);break;case s.inject.screen.mapEditor:this.topOffsetController.transitionTo(-30);break;default:this.topOffsetController.transitionTo(20)}}createComponents(){return{toggleSoundButton:new f(this),toggleFullScreenButton:new p(this),helpButton:new m(this)}}updateLayout(){}}t.GlobalUIScene=u;class g extends r.StealthButton{constructor(e,t){super(e,{content:y(e,t).setTint(c.Colors.glassUi.backgroundText),audio:!0,radius:6}),this.setSize(36,32),this.onClicked(()=>this.handleClick())}}class p extends g{constructor(e){super(e,p.ENTER),this.scene.scale.on(Phaser.Scale.Events.ENTER_FULLSCREEN,()=>{this.content.setFrame(p.LEAVE)}),this.scene.scale.on(Phaser.Scale.Events.LEAVE_FULLSCREEN,()=>{this.content.setFrame(p.ENTER)})}handleClick(){this.scene.scale.isFullscreen?this.scene.scale.stopFullscreen():this.scene.scale.startFullscreen()}updateFrame(){}}p.ENTER="ui/button-icons/fullscreen-enter",p.LEAVE="ui/button-icons/fullscreen-exit";class m extends g{constructor(e){super(e,"ui/button-icons/help")}handleClick(){}}class f extends g{constructor(e){super(e,f.ON)}handleClick(){s.inject.audio.mute=!s.inject.audio.mute,this.content.setFrame(s.inject.audio.mute?f.ON:f.OFF)}}function y(e,t,i="atlas"){return new Phaser.GameObjects.Image(e,0,0,i,t)}f.ON="ui/button-icons/sound-on",f.OFF="ui/button-icons/sound-off"},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StealthButton=void 0;var n=Phaser.Geom.Rectangle;const s=i(22),a=i(20),o=i(130),r=i(44),c=i(78);class l extends s.BaseResponsiveContainer{constructor(e,t){var i;super(e),this._radius=10,this._radius=null!==(i=t.radius)&&void 0!==i?i:this._radius,this._background=new o.RoundedRect(this.scene,{x:0,y:0,fillStyle:{color:a.Colors.glassUi.shapeLightAccent,alpha:.5},radius:this._radius}).setAlpha(0),this.content=t.content,this.add([this._background,t.content]),console.log("SETTING INTERACTIVE",this.width,this.height),this.setInteractive({hitArea:new n(this.width/2,this.height/2,this.width,this.height),hitAreaCallback:n.Contains,cursor:"pointer"}),this.setController((0,c.setupController)(t))}setController(e){e&&(this.controller=e,e.bindTo(this,e=>this.onNewButtonState(e)))}get onClicked(){return this.controller.onClicked}setEnabled(e){this.controller.setEnabled(e)}onNewButtonState(e){switch(e){case r.ButtonState.Hover:case r.ButtonState.Down:this._background.setAlpha(1);break;default:this._background.setAlpha(0)}}updateLayout(){this.input.hitArea.setTo(this.width/2,this.height/2,this.width,this.height),this._background.radius=this._radius,this._background.setSize(this.width,this.height),this.content.setPosition(this.width/2,this.height/2)}}t.StealthButton=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StorybookAppController=void 0;const n=i(0),s=i(1),a=i(6),o=i(181),r=i(77),c=i(183);s.logger.for("AppController");t.StorybookAppController=class{getScenes(){return[c.PreloadScene,o.ModalWindowScene]}run(){n.inject.events.on(a.SystemEvents.EngineInitialized,()=>{n.inject.modals.show(r.UI.exportMap,{saveData:"asjdlfkaj slkdfja lsfhjaksdf lkashdfkjsadfjkshdfash fkahs lfk kjf aksdfh kas hfdlkhasfjlksah flkh lsjdfh"},e=>console.log("RESULT",e))})}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Navigator=void 0;const s=i(0),a=i(1),o=i(6);a.logger.for("Navigator");t.Navigator=class{constructor(e){this.game=e}goTo(e,t){return n(this,void 0,void 0,(function*(){const i=this.currentScreen;let n=[];this.currentScreen&&(this.currentScreen.deactivate(),n=this.currentScreen.getScenes(),this.currentScreen=void 0);const a=e.getScenes();a.forEach(e=>{const t=this.game.scene.getScene(e);if(!t)throw new Error("Scene not found: "+e);t.sys.isActive()||this.game.scene.run(e)}),yield e.activate(i),s.inject.events.trigger(o.SystemEvents.ScreenActivated(e)),t&&(yield t()),n.filter(e=>-1===a.indexOf(e)).forEach(e=>{this.game.scene.sleep(e)}),this.currentScreen=e}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ViewsManager=void 0;const n=i(416),s=i(417),a=i(418),o=i(190),r=i(419);t.ViewsManager=class{constructor(){this.allies=new n.AlliesView,this.attitude=new o.AttitudeView,this.fear=new s.FearView,this.factionInfluenceByRegion=new a.FactionInfluenceByRegionView,this.attritionByFaction=new r.AttritionByFactionView}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AlliesView=void 0;const n=i(3),s=i(8),a=i(14),o=i(82),r=i(18);class c extends o.LazyView{constructor(){super([s.GameState.ai.approval]),this.name="ai.allies"}calculate(e,t){return a.Factions.getAll(e).filter(i=>{var s;return i!==t&&(null===(s=a.Factions.getData(e,i))||void 0===s?void 0:s.controller)!==n.FactionController.None&&r.AI.getFactionApproval(e,i,t)>=100})}getCacheKey(e){return e}}t.AlliesView=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateFear=t.FearView=void 0;const n=i(8),s=i(5),a=i(82),o=i(18),r=i(9),c=i(1),l=i(19),d=i(46),h=i(74);c.logger.for("FearView");class u extends a.LazyView{constructor(){super([n.GameState.ai.powerByFaction,n.GameState.ai.approval]),this.name="fear"}calculate(e,t){return this.getComponents(e,t).fear.totalFear}getComponents(e,{fromFactionId:t,towardsFactionId:i}){const a=(0,s.selectFromState)(e,n.GameState.ai.powerByFaction),c=a.valueSeq().reduce(r.sum,0),l=a.get(t),d=[t],h=g(e,d.filter(e=>e!==i)),u=o.AI.getFactionPower(e,i),m=[i],f=g(e,m);return{totalPower:c,myPower:l,rivalFactionPower:u,rivalAllianceMembers:m,rivalAlliancePower:f,myAlliance:d,myAlliancePower:h,fear:p({myPower:l,enemyPower:u,totalPower:c,myAlliancePower:h,enemyAlliancePower:f})}}getCacheKey(e){return`${e.fromFactionId}->${e.towardsFactionId}`}getDebugLayer(e){return new d.GameStateDebugLayer((0,h.factionBasedAdapter)({getValue:(t,i)=>{if(i!==e)return this.get(t,{towardsFactionId:e,fromFactionId:i})},getDetail:(t,i)=>{if(i!==e)return(0,l.prettyPrintObject)(this.getComponents(t,{towardsFactionId:e,fromFactionId:i}))}}))}}function g(e,t){return t.map(t=>o.AI.getFactionPower(e,t)).reduce(r.sum,0)}function p({enemyAlliancePower:e,myAlliancePower:t,myPower:i,totalPower:n,enemyPower:s}){const a=Math.floor(i/n*100),o=2*(Math.floor(s/n*100)-a),r=Math.floor(e/(e+t)*200-100);return{fearOfFactionDomination:o,fearOfGettingCrushed:r,totalFear:Math.max(o,r)}}t.FearView=u,t.calculateFear=p},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionInfluenceByRegionView=void 0;const n=i(8),s=i(5),a=i(14),o=i(82),r=i(18),c=i(46),l=i(88);class d extends o.LazyView{constructor(){super([n.GameState.ai.regionInfluenceByRegion,n.GameState.factions.byRegion]),this.name="factionInfluenceByRegion"}calculate(e,t){const i=this.getComponents(e,t);return{total:i.reduce((e,t)=>e+t.influence,0),proximity:i.reduce((e,t)=>Math.min(e,t.proximity),1/0)}}getComponents(e,{influencingFaction:t,targetRegion:i,maxDistance:o}){const c=(0,s.selectFromState)(e,n.GameState.ai.regionInfluenceByRegion,i);return c?c.entrySeq().filter(([i,n])=>a.Factions.getByRegion(e,i)===t&&n.proximity<=o).map(([t,i])=>({regionId:t,influence:i.total*r.AI.getRegionPower(e,t).militaryPower,proximity:i.proximity})).filter(({influence:e})=>e>0).toArray():[]}getCacheKey({influencingFaction:e,targetRegion:t}){return`${e}.${t}`}getDebugLayer(e,t=99){return new c.GameStateDebugLayer((0,l.regionBasedAdapter)({getValue:(i,n)=>{const s=this.get(i,{influencingFaction:e,targetRegion:n,maxDistance:t});return`${s.total}\n(${s.proximity})`},getDetail:(i,n)=>this.getComponents(i,{influencingFaction:e,targetRegion:n,maxDistance:t}).map(e=>`${e.influence} from region ${e.regionId} (proximity ${e.proximity})`).join("\n")}))}}t.FactionInfluenceByRegionView=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AttritionByFactionView=void 0;const n=i(8),s=i(82),a=i(18),o=i(9),r=i(1),c=i(46),l=i(74),d=i(14);r.logger.for("AttritionByFactionView");class h extends s.LazyView{constructor(){super([n.GameState.ai.attritionByRegion]),this.name="attritionByFaction"}calculate(e,t){const i={};return d.Factions.getFactionRegions(e,t).map(t=>{const n=a.AI.getRegionAttrition(e,t);for(const[e,t]of Object.entries(n))i[Number(e)]=(i[Number(e)]||0)+t}),i}getCacheKey(e){return e}getDebugLayer(){return new c.GameStateDebugLayer((0,l.factionBasedAdapter)({getValue:(e,t)=>Object.values(this.get(e,t)).reduce(o.sum,0),getDetail:(e,t)=>Object.entries(this.get(e,t)).map(([e,t])=>`${t} inflicted by faction ${e}`).join("\n")}))}}t.AttritionByFactionView=h},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.JSONMapRegistry=void 0;const s=i(1),a=i(11),o=s.logger.for("MapRegistry");t.JSONMapRegistry=class{constructor(e){this.campaigns=[],this.levelsById={},this.initialized=fetch(e).then(e=>e.json()).then(t=>{o.info(`${t.campaigns.length} campaigns and ${t.levels.length} maps loaded from "${e}"`),this.campaigns=t.campaigns,this.levelsById=(0,a.dictionaryOf)(t.levels,"id")}).catch(t=>{o.error(`Failed to load maps from "${e}"`,t)})}getCampaigns(){return n(this,void 0,void 0,(function*(){return yield this.initialized,this.campaigns}))}getCampaignById(e){return n(this,void 0,void 0,(function*(){return yield this.initialized,this.campaigns.find(t=>t.id===e)}))}getLevelById(e){return n(this,void 0,void 0,(function*(){return yield this.initialized,this.levelsById[e]}))}getLevelLocationInCampaign(e){for(let t of this.campaigns){const i=t.levels.findIndex(t=>t.id===e);if(-1!==i)return{campaign:t,indexInCampaign:i,levelData:t.levels[i]}}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createScreens=void 0;const n=i(422),s=i(426),a=i(428),o=i(429),r=i(201),c=i(430),l=i(434),d=i(436);t.createScreens=function(){return{play:new n.PlayScreen,mapEditor:new s.MapEditorScreen,breakpoint:new a.BreakPointScreen,debugHistory:new o.DebugHistoryScreen,title:new r.TitleScreen,levelSelect:new c.LevelSelectScreen,levelDetail:new l.LevelDetailScreen,gameOver:new d.GameOverScreen}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PlayScreen=void 0;const s=i(16),a=i(56),o=i(0),r=i(6),c=i(423),l=i(424),d=i(40),h=i(204),u=i(205),g=i(206),p=i(45),m=i(425);class f extends a.BaseScreen{constructor(){super([s.Scenes.Play,s.Scenes.PlayUI,s.Scenes.WorldMap]),this.activationContext=d.NewGameStateContext.ResumingGame,this.handleEventWhileActive(r.UserActions.GoBack,()=>n(this,void 0,void 0,(function*(){o.inject.userData.saveLevelProgress(),yield(0,h.returnToMenuFromGame)(u.transitionFromPlayScene,g.transitionFromPlayScene)}))),this.handleEventWhileActive(r.UserActions.EndTurn,()=>{o.inject.config.autoSaveOnTurnEnd&&o.inject.userData.saveLevelProgress()}),this.handleEventWhileActive(r.UserActions.EndGame,e=>n(this,void 0,void 0,(function*(){o.inject.userData.saveLevelOutcome(e),e==p.LevelOutcome.Victory?(o.inject.screen.gameOver.outcome=e,o.inject.navigator.goTo(o.inject.screen.gameOver,m.victoryTransition)):(yield(0,h.returnToMenuFromGame)(u.transitionFromPlayScene,g.transitionFromPlayScene),o.inject.ui.playedLevelId.set(void 0))})))}activate(){return n(this,void 0,void 0,(function*(){const e=o.inject.scene.play;o.inject.scene.worldMap.setMode(new c.InteractiveMode),e.skipToCurrentState(this.activationContext),o.inject.ui.playedLevelId.set(o.inject.gameStateModel.map.levelId),o.inject.ui.regionsLedger.reset(o.inject.gameStateModel.state),o.inject.ui.selectedRegion.set(o.inject.ui.regionsLedger.getNextPendingRegion())}))}deactivate(){o.inject.scene.play.setMode(new l.PassiveMode(o.inject.scene.play))}}t.PlayScreen=f},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InteractiveMode=void 0;const n=i(101),s=i(0);class a extends n.BaseWorldMapMode{constructor(){super(...arguments),this.handlesPointerEvents=!0,this.zoomWithScrollWheel=!0}activate(){super.activate(),s.inject.scene.worldMap.cameraController.setViewportMargins({})}deactivate(){super.deactivate(),this.scene.selectedRegionHighlight.clear(),this.scene.conquerableHexesHighlight.clear(),this.scene.townStatusFlags.clear(),this.scene.attitudeEmojis.clear(),this.scene.townBacklight.clear(),this.scene.pawns.clearAllJumping(),this.scene.pawns.clearHangingPawn()}}t.InteractiveMode=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PassiveMode=void 0;const n=i(70);class s extends n.BaseMode{constructor(e){super(e)}isReadyForMoreGameEvents(){return!1}}t.PassiveMode=s},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.victoryTransition=void 0;const s=i(0);t.victoryTransition=function(e=1e3){return n(this,void 0,void 0,(function*(){const t=s.inject.scene.gameOver;return s.inject.scene.playUI.activeUI.transitionOut(),new Promise(i=>{t.preUpdate.makeDirty(),t.preUpdate(),t.ribbon.setAlpha(1),t.tweens.add({targets:t.backgroundOverlay,alpha:{start:0,to:1},duration:e/2}),t.tweens.add({targets:t.ribbonText,alpha:{from:0,to:1},duration:e,onComplete:i}),t.tweens.add({targets:t.ribbon,x:{from:t.ribbon.x+150,to:t.ribbon.x},width:{from:100,to:400},duration:e,ease:Phaser.Math.Easing.Expo.Out}),t.tweens.add({targets:t.trophy,delay:0,scale:{from:10,to:1},duration:e,ease:Phaser.Math.Easing.Bounce.Out}),t.tweens.add({delay:e/3,targets:t.trophy,alpha:{start:0,to:1},duration:e/2}),t.tweens.add({targets:[t.shield],scale:{from:.2,to:1},alpha:{start:0,to:1},duration:e/2,ease:Phaser.Math.Easing.Expo.Out}),t.tweens.add({delay:e/3,targets:[t.shieldOutline,t.victoryHalo,t.victoryRays],alpha:{start:0,to:1},scale:{start:.2,to:1},duration:2*e/3,ease:Phaser.Math.Easing.Back.Out})})}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorScreen=void 0;const s=i(16),a=i(56),o=i(0),r=i(6),c=i(427),l=i(40);class d extends a.BaseScreen{constructor(){super([s.Scenes.WorldMap,s.Scenes.MapEditor]),this.handleEventWhileActive(r.UserActions.ResumeGame,()=>{o.inject.userData.saveLevelProgress(),o.inject.screen.play.activationContext=l.NewGameStateContext.ResumingGame,o.inject.navigator.goTo(o.inject.screen.play)})}activate(){return n(this,void 0,void 0,(function*(){o.inject.scene.worldMap.setMode(new c.EditorMode),o.inject.scene.worldMap.cameraController.setViewportMargins({right:300})}))}deactivate(){}}t.MapEditorScreen=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EditorMode=void 0;const n=i(101),s=i(188);class a extends n.BaseWorldMapMode{constructor(){super(...arguments),this.handlesPointerEvents=!0}activate(){super.activate(),this.scene.editorOverlay||(this.scene.editorOverlay=new s.WorldMapEditorOverlay(this.scene),this.scene.editorOverlay.create()),this.scene.editorOverlay.setVisible(!0)}deactivate(){var e;null===(e=this.scene.editorOverlay)||void 0===e||e.setVisible(!1)}}t.EditorMode=a},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.BreakPointScreen=void 0;const s=i(16),a=i(56),o=i(0),r=i(40);class c extends a.BaseScreen{constructor(){super([s.Scenes.WorldMap])}activate(){return n(this,void 0,void 0,(function*(){}))}deactivate(){o.inject.screen.play.activationContext=r.NewGameStateContext.ResumingGame}}t.BreakPointScreen=c},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DebugHistoryScreen=void 0;const s=i(16),a=i(56),o=i(0),r=i(40);class c extends a.BaseScreen{constructor(){super([s.Scenes.DebugHistory,s.Scenes.WorldMap])}activate(){return n(this,void 0,void 0,(function*(){o.inject.scene.debugHistory.resetCursor(),o.inject.history.suspendRecording(),this.prevIntegrityChecksSetting=o.inject.config.debug.integrityChecks,o.inject.config.debug.integrityChecks=void 0}))}deactivate(){o.inject.config.debug.integrityChecks=this.prevIntegrityChecksSetting,o.inject.history.resumeRecording(),o.inject.screen.play.activationContext=r.NewGameStateContext.ResumingGame}}t.DebugHistoryScreen=c},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.LevelSelectScreen=void 0;const s=i(56),a=i(16),o=i(0),r=i(6),c=i(431),l=i(432),d=i(433);class h extends s.BaseScreen{constructor(){super([a.Scenes.LevelSelectUI,a.Scenes.MenuHeaderUI]),this.handleEventWhileActive(r.UserActions.GoBack,()=>{o.inject.navigator.goTo(o.inject.screen.title,()=>n(this,void 0,void 0,(function*(){yield Promise.all([(0,l.transitionIn)(),(0,c.transitionOut)()])})))}),this.handleEventWhileActive(r.UserActions.GoToLevelDetail,({levelId:e})=>n(this,void 0,void 0,(function*(){var t;const i=null===(t=o.inject.ui.selectedCampaign())||void 0===t?void 0:t.levels.findIndex(t=>t.id===e);o.inject.ui.selectedLevelId.set(e),o.inject.navigator.goTo(o.inject.screen.levelDetail,()=>(0,d.transitionToLevelDetail)(i))})))}activate(){return n(this,void 0,void 0,(function*(){const e=o.inject.ui.selectedCampaign();e&&(o.inject.scene.menuHeaderUI.state.update({title:e.name,backButtonTitle:"MAIN MENU"}),o.inject.scene.levelSelectUI.loadCampaign(e))}))}}t.LevelSelectScreen=h},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.transitionOut=void 0;const n=i(0);t.transitionOut=function(){const e=n.inject.scene.levelSelectUI,t=n.inject.config.screenTransitionDuration;return new Promise(i=>{e.tweens.add({targets:e.levelCards,y:"+="+n.inject.device.screenHeight,delay:(i,n,s,a)=>(e.levelCards.length-a)*(t/100),duration:t,ease:"Sine.easeIn",onComplete:i})})}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.transitionIn=void 0;const s=i(0),a=i(23);t.transitionIn=function(e){return n(this,void 0,void 0,(function*(){const t=s.inject.scene.titleScreenUI,i=s.inject.config.screenTransitionDuration;t.preUpdate();let n=t.buttons;if(void 0!==e){const o=t.buttons[e];n=(0,a.without)(t.buttons,o);const r={x:o.x,y:o.y,width:o.width,height:o.height,rounded:1};o.x=0,o.y=0,o.setSize(s.inject.device.screenWidth,200),o.rounded=0,t.tweens.add({targets:o,props:r,duration:i,onComplete:()=>{t.preUpdate.makeDirty()}})}s.inject.scene.worldMap.cameraController.scrollController.cameraY.setTo(1e3),s.inject.scene.worldMap.cameraController.center(i),s.inject.scene.worldMap.cameraController.zoomController.cameraDistance.tweenTo(1,i,"Sine.easeOut"),t.tweens.add({targets:[t.mainMenuPanel,t.decorativeStripe,...n,t.resumeButton,t.gameLogo],props:{x:{getStart:e=>e.x+400,getEnd:e=>e.x}},duration:i,ease:"Sine.easeOut"})}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.transitionToLevelDetail=void 0;const n=i(0),s=i(2);t.transitionToLevelDetail=function(e=0){e<0&&(console.warn(`invalid cardIndex ${e}, replacing with 0`),e=0);const t=n.inject.scene.levelSelectUI,i=n.inject.scene.levelDetailUI,a=n.inject.scene.worldMap,o=n.inject.config.screenTransitionDuration;return a.scene.setVisible(!1),i.preUpdate(),new Promise(a=>{var r,c;const l=t.levelCards[e];(0,s.assert)(l,"targetCard not found for index "+e);let d=[],h=[],u=[],g=[];for(let i=0;i<t.levelCards.length;++i){const n=t.levelCards[i];n.y<l.y?d.push(n):n.y>l.y?h.push(n):i<e?u.push(n):i>e&&g.push(n)}t.tweens.add({targets:[...u,l,...g],props:{x:(e,t,n,s)=>i.layout.cardLeft(d.length+s)-i.scrollController.cameraX.value,y:i.layout.cardTop,width:i.layout.cardWidth,height:i.layout.cardHeight,footerSize:i.layout.cards.footerSize,radius:i.layout.cards.radius},duration:o,ease:"Sine.easeOut",onComplete:a});const p=t.levelCards[e];i.tweens.add({targets:i.centralCard,props:{x:{from:p.x+i.scrollController.cameraX.value,to:i.layout.cardLeft(e)},y:{from:p.y,to:i.layout.cardTop},width:{from:p.width,to:i.layout.cardWidth},height:{from:p.height,to:i.layout.cardHeight},footerSize:{from:p.footerSize,to:i.layout.cards.footerSize},radius:{from:p.radius,to:i.layout.cards.radius},alpha:{from:0,to:1}},duration:o,ease:"Sine.easeOut"}),null===(r=i.leftCard)||void 0===r||r.setVisible(!1),null===(c=i.rightCard)||void 0===c||c.setVisible(!1),t.tweens.add({targets:d,y:"-="+l.y,duration:o,ease:"Sine.easeOut"}),t.tweens.add({targets:h,y:"+="+(n.inject.device.screenHeight-l.y),duration:o,ease:"Sine.easeOut"})}).then(()=>{var e,t;null===(e=i.leftCard)||void 0===e||e.setVisible(!0),null===(t=i.rightCard)||void 0===t||t.setVisible(!0)})}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.LevelDetailScreen=void 0;const s=i(56),a=i(16),o=i(0),r=i(6),c=i(435),l=i(107),d=i(133),h=i(2),u=i(40),g=i(77),p=i(41),m=i(45);class f extends s.BaseScreen{constructor(){super([a.Scenes.WorldMap,a.Scenes.LevelDetailUI,a.Scenes.MenuHeaderUI]),this.handleEventWhileActive(r.UserActions.GoBack,()=>{o.inject.navigator.goTo(o.inject.screen.levelSelect)}),this.handleEventWhileActive(r.UserActions.PlayLevel,({levelId:e})=>n(this,void 0,void 0,(function*(){const t=d.LevelModel.get(e);let i,n;const s=t.getLevelStatus();s===d.LevelStatus.InProgress||s==d.LevelStatus.Replaying?(i=yield t.getCurrentState(),n=o.inject.ui.playedLevelId()===e?u.NewGameStateContext.ResumingGame:u.NewGameStateContext.LoadingGame):(n=u.NewGameStateContext.StartingNewGame,i=yield t.getStartingState()),h.assert.defined(i),o.inject.gameStateController.loadState(i,n),o.inject.scene.worldMap.syncState(o.inject.currentGameState),o.inject.navigator.goTo(o.inject.screen.play,c.transitionToPlayScene)}))),this.handleEventWhileActive(r.UserActions.PreviewLevel,({levelId:e})=>{o.inject.scene.levelDetailUI.scrollToLevel(e)}),this.handleEventWhileActive(r.UserActions.AbandonLevelProgress,({levelId:e})=>{const t=function(e){switch(e){case d.LevelStatus.InProgress:return"Are you sure? Your progress in this level will be lost!";case d.LevelStatus.Replaying:return"Are you sure? Your progress since the most recent victory will be lost.";default:return}}(d.LevelModel.get(e).getLevelStatus());o.inject.modals.show(g.UI.abandonLevelDialog,{message:t},t=>n(this,void 0,void 0,(function*(){t===p.DialogButtons.GiveUp&&(o.inject.userData.deleteSavedGame(e,m.SaveGameTags.Autosave),this.loadLevel(e),o.inject.scene.levelDetailUI.refreshLevelCard(e),o.inject.ui.playedLevelId.set(void 0))})))})}activate(e){return n(this,void 0,void 0,(function*(){o.inject.ui.withoutTransitions(()=>{o.inject.scene.worldMap.setMode(new l.PreviewMode)}),o.inject.scene.worldMap.scene.setVisible(!1),yield this.loadLevel(o.inject.ui.selectedLevelId())}))}deactivate(){o.inject.scene.worldMap.scene.setVisible(!0)}loadLevel(e){var t,i,s,a,r,c;return n(this,void 0,void 0,(function*(){const n=d.LevelModel.get(e);o.inject.scene.menuHeaderUI.state.update({title:null!==(i=null===(t=n.parentCampaign)||void 0===t?void 0:t.name)&&void 0!==i?i:"Custom map",backButtonTitle:"OVERVIEW"}),o.inject.scene.levelDetailUI.state.update({campaignId:null===(s=n.parentCampaign)||void 0===s?void 0:s.id,levels:null===(a=n.parentCampaign)||void 0===a?void 0:a.levels.map(e=>e.id)}),o.inject.scene.levelDetailUI.goToLevelIndex(null!==(c=null===(r=n.campaignContext)||void 0===r?void 0:r.indexInCampaign)&&void 0!==c?c:0)}))}}t.LevelDetailScreen=f},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.transitionToPlayScene=void 0;const n=i(0);t.transitionToPlayScene=function(){var e;const t=n.inject.scene.levelDetailUI,i=n.inject.scene.menuHeaderUI,s=n.inject.config.screenTransitionDuration,a=n.inject.scene.worldMap,o=t.centralCard.content.mapPreview;return null==o||o.setVisible(!1),a.cameraController.updateBounds(),a.cameraController.zoomController.cameraDistance.setTo(1/(null!==(e=null==o?void 0:o.scale)&&void 0!==e?e:1)),a.cameraController.center(),a.cameraController.zoomController.cameraDistance.tweenTo(1,s,"Sine.easeOut"),n.inject.scene.playUI.activeUI.transitionIn(),new Promise(e=>{t.tweens.add({targets:[t.centralCard],props:{alpha:0},duration:s,onComplete:e}),t.leftCard&&t.tweens.add({targets:t.leftCard,props:{x:t.cameras.main.worldView.x-t.layout.cardWidth-10},duration:s,ease:"Sine.easeOut"}),t.rightCard&&t.tweens.add({targets:t.rightCard,props:{x:t.cameras.main.worldView.right+10},duration:s,ease:"Sine.easeOut"}),i.slideOut()}).then(()=>{null==o||o.setVisible(!0)})}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.GameOverScreen=void 0;const s=i(16),a=i(56),o=i(0),r=i(6),c=i(206),l=i(107),d=i(45),h=i(204),u=i(437);class g extends a.BaseScreen{constructor(){super([s.Scenes.WorldMap,s.Scenes.GameOver]),this.outcome=d.LevelOutcome.Victory,this.handleEventWhileActive(r.UserActions.GoToLevelDetail,({levelId:e})=>{(0,h.returnToMenuFromGame)(u.transitionToLevelDetail,c.transitionFromPlayScene)})}activate(){return n(this,void 0,void 0,(function*(){o.inject.scene.play;o.inject.scene.worldMap.setMode(new l.PreviewMode),o.inject.scene.worldMap.cameraController.center(1e3),o.inject.scene.gameOver.continueAutomaticallyAfter()}))}deactivate(){o.inject.scene.worldMap.cameras.main.setTint(0)}}t.GameOverScreen=g},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.transitionToLevelDetail=void 0;const s=i(0),a=i(205),o=i(203);t.transitionToLevelDetail=function(){return n(this,void 0,void 0,(function*(){const e=s.inject.config.screenTransitionDuration,t=s.inject.scene.gameOver,i=s.inject.scene.levelDetailUI;return(0,a.transitionFromPlayScene)(),new Promise(n=>{var s;t.preUpdate(),i.preUpdate(),t.tweens.add({targets:t.backgroundOverlay,alpha:{start:1,to:0},duration:e}),t.tweens.add({targets:t.ribbonText,alpha:{from:1,to:0},duration:e/2}),t.tweens.add({targets:t.ribbon,x:{from:t.ribbon.x,to:t.ribbon.x+150},width:{from:400,to:100},alpha:{from:1,to:0},duration:e,ease:Phaser.Math.Easing.Expo.Out,onComplete:n}),t.tweens.add({targets:t.trophy,delay:0,props:{x:i.layout.cardLeft(0)+i.bounds.contentLeft+o.LargeLevelCardContent.Layout.iconOffsetFromLeft+20,y:i.layout.cardTop+i.layout.cardHeight-i.layout.cards.footerSize/2,scale:{from:1,to:.5}},duration:e,ease:Phaser.Math.Easing.Sine.InOut}),t.tweens.add({delay:2*e/3,targets:t.trophy,alpha:{start:1,to:0},duration:e/3}),i.tweens.add({delay:2*e/3,targets:[null===(s=i.centralCard.content)||void 0===s?void 0:s._icon],alpha:{start:0,to:1},duration:e/3}),t.tweens.add({delay:e/2,targets:[t.shield],scale:{from:1,to:0},alpha:{start:1,to:0},duration:e/2}),t.tweens.add({targets:[t.shieldOutline,t.victoryHalo,t.victoryRays],alpha:{start:1,to:0},scale:{start:1,to:.2},duration:2*e/3,ease:Phaser.Math.Easing.Sine.In})})}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function r(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DummyMapRegistry=void 0;t.DummyMapRegistry=class{getCampaignById(e){return Promise.resolve(void 0)}getCampaigns(){return n(this,void 0,void 0,(function*(){return[]}))}getLevelById(e){return Promise.resolve(void 0)}getLevelLocationInCampaign(e){}}}]);
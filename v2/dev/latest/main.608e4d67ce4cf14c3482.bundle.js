!function(e){function t(t){for(var n,r,o=t[0],d=t[1],c=t[2],l=0,u=[];l<o.length;l++)r=o[l],Object.prototype.hasOwnProperty.call(s,r)&&s[r]&&u.push(s[r][0]),s[r]=0;for(n in d)Object.prototype.hasOwnProperty.call(d,n)&&(e[n]=d[n]);for(h&&h(t);u.length;)u.shift()();return a.push.apply(a,c||[]),i()}function i(){for(var e,t=0;t<a.length;t++){for(var i=a[t],n=!0,o=1;o<i.length;o++){var d=i[o];0!==s[d]&&(n=!1)}n&&(a.splice(t--,1),e=r(r.s=i[0]))}return e}var n={},s={0:0},a=[];function r(t){if(n[t])return n[t].exports;var i=n[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=n,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(i,n,function(t){return e[t]}.bind(null,n));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="";var o=window.webpackJsonp=window.webpackJsonp||[],d=o.push.bind(o);o.push=t,o=o.slice();for(var c=0;c<o.length;c++)t(o[c]);var h=d;a.push([124,1]),i()}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.inject=t.setupInjectionContainer=void 0;const n=i(126),s=i(127),a=i(128),r=i(145),o=i(87),d=i(92),c=i(226),h=i(61),l=i(29),u=i(227),g=i(228),p=i(233),f=i(2),m=i(234),y=i(73),w=i(33);t.setupInjectionContainer=function(e,i={}){const v=s.configProfiles.production;if(!v)throw new Error('No configuration found for ENVIRONMENT="production", unable to setup injection container!');const b=new d.RootController(e),x=b.gameStateController;let S=x.model.state;t.inject=Object.assign({game:e,device:new y.DeviceInfo(e),versionManager:new m.AppVersionManager,ai:new g.AIController,audio:new l.AudioManager(e),fonts:new w.Fonts,uiState:new c.UiStateManager,rootController:b,gameStateController:x,gameStateModel:x.model,get currentGameState(){return S},set currentGameState(e){f.assert.defined(e,"attempt to set current game state to undefined value"),S=e},gameStateRecorder:new a.GameStateRecorder,random:n.createRandomGenerator(),config:h.deepWatchable(v),debugData:new r.DebugData,debugLayers:new u.GridDebugLayersManager,debugBreakpoint:p.debugBreakPointProvider,worldUi:{hexUnderCursor:o.watchableHexUnderCursor(),selectedRegion:h.watchable(void 0),undoAvailable:h.watchable(!1)},events:b.events},i)},t.inject={}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.logger=t.ConsoleLogger=t.NamedLogger=t.RootLogger=t.LogLevel=void 0;const s=n(i(77));var a;!function(e){e.Error="error",e.Warning="warning",e.Info="info",e.Debug="debug"}(a=t.LogLevel||(t.LogLevel={}));class r{constructor(){this.transportsByName=new Map,this.loggersByModule=new Map}addTransport(e,t){this.transportsByName.set(e,t)}removeTransport(e){this.transportsByName.delete(e)}for(e){const t=this.loggersByModule.get(e)||new o(e,this);return this.loggersByModule.set(e,t),t}log(e,t,i,...n){this.transportsByName.forEach(s=>s.log(e,t,i,...n))}}t.RootLogger=r;class o{constructor(e,t){this.name=e,this.parentLogger=t}debug(e,...t){this.parentLogger.log(a.Debug,this.name,e,...t)}error(e,...t){this.parentLogger.log(a.Error,this.name,e,...t)}info(e,...t){this.parentLogger.log(a.Info,this.name,e,...t)}warning(e,...t){this.parentLogger.log(a.Warning,this.name,e,...t)}}t.NamedLogger=o;t.ConsoleLogger=class{log(e,t,i,...n){const r=`[${t}] ${i}`;switch(e){case a.Debug:s.default("game:"+t)(i,...n);break;case a.Error:console.error(r,...n);break;case a.Warning:console.warn(r,...n);break;case a.Info:console.info(r,...n)}}},t.logger=new r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssertionError=t.assert=void 0;const n=i(14);function s(e,t=`expected ${e} to be truthy`){if(!e)throw new a(e,t)}t.assert=s,s.defined=(e,t=`expected ${e} to be defined`)=>{if(!n.isDefined(e))throw new a(e,t)},s.undefined=(e,t=`expected ${e} to be undefined`)=>{if(n.isDefined(e))throw new a(e,t)},s.naturalNumber=(e,t=`expected ${e} to be a natural number`)=>{s("number"==typeof e&&e>0&&Math.floor(e)===e,t)};class a extends Error{constructor(e,t){t||(t="failed for value %s"),super(t.replace("%s",null==e?void 0:e.toString()))}}t.AssertionError=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getHexes=t.getHex=t.HexGrid=t.GRID_MAX_DIMENSION=void 0;const n=i(14),s=i(37),a=i(91),r=i(12),o=i(1).logger.for("HexGrid");t.GRID_MAX_DIMENSION=100;class d{constructor(){}static getHex(e){if(this.isWithinBounds(e,{width:t.GRID_MAX_DIMENSION,height:t.GRID_MAX_DIMENSION}))return a.isOrdinal(e)?(this._hexes[e]||(this._hexes[e]=new s.Hex(e)),this._hexes[e]):this.getHex(this.toOrdinal(e));o.warning(`hex position ${n.str(e)} out of grid bounds\` (GRID_MAX_DIMENSION=${t.GRID_MAX_DIMENSION})`)}static getAllHexes(e){const t=Array(e.width*e.height).fill(void 0);for(let i=0;i<e.height;++i)for(let n=0;n<e.width;++n)t[i*e.width+n]=a.tabularToOrdinal({r:i,c:n});return r.HexGroup.from(t.map(e=>c(e)))}static getHexes(e){return r.HexGroup.from(e.map(e=>this.getHex(e)))}static filter(e,t){return this.getAllHexes(t).filter(e)}static getInnerHexes(e){return this.getAllHexes(e).filter(t=>!this.isHexOnGridBorder(t,e))}static isWithinBounds(e,t){if(a.isTabular(e))return!(e.c>=t.width||e.c<0)&&!(e.r>=t.height||e.r<0);if(a.isOrdinal(e))return this.isWithinBounds(a.ordinalToTabular(e),t);if(a.isSpatial(e))return this.isWithinBounds(a.spatialToTabular(e),t);throw new Error(`HexGrid.isOutOfBounds called with invalid grid position (${n.str(e)})`)}static isHexOnGridBorder(e,i){return e.id<t.GRID_MAX_DIMENSION||e.id%t.GRID_MAX_DIMENSION==0||e.id%t.GRID_MAX_DIMENSION==i.width-1||Math.floor(e.id/t.GRID_MAX_DIMENSION)===i.height-1}static toOrdinal(e){if(a.isOrdinal(e))return e;if(a.isTabular(e))return a.tabularToOrdinal(e);if(a.isSpatial(e))return a.tabularToOrdinal(a.spatialToTabular(e));throw new Error(`HexGrid.toOrdinal called with invalid grid position (${n.str(e)})`)}static bfs(e,t=(()=>!0)){let i=[];e.forEach(e=>i.push({hex:e,d:0}));let n=new Set(e.members);const s=({hex:e,d:s,parent:a})=>{n.add(e);if(t(e,a,s)){e.neighbours().filter(e=>!n.has(e)).members.forEach(t=>{n.add(t),i.push({hex:t,d:s+1,parent:e})})}};for(;i.length>0;)s(i.shift())}}function c(e){return d.getHex(e)}t.HexGrid=d,d.upperBound=t.GRID_MAX_DIMENSION*t.GRID_MAX_DIMENSION-1,d._hexes=[],t.getHex=c,t.getHexes=function(e){return d.getHexes(e)}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isImmutableState=t.updateActiveDataSets=t.isProjectionDataSet=t.selectFromSuspendedState=t.selectFromState=t.getActiveProjections=t.getActiveDataSets=t.isDataSetActive=t.assertStateHasDataSet=t.getParentEngine=t.setParentEngine=t.applyMutations=t.createImmutableState=t.PARENT_ENGINE_KEY=t.ACTIVE_DATASETS_KEY=t.EMPTY_SET=void 0;const s=n(i(7)),a=i(2);function r(e){return e.get(t.PARENT_ENGINE_KEY)}function o(e,i){return e.get(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET).has(i)}function d(e){return e.get(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET)}function c(e){return!!e.bootstrap}t.EMPTY_SET=s.default.Set(),t.ACTIVE_DATASETS_KEY="_activeDataSets",t.PARENT_ENGINE_KEY="_parentEngine",t.createImmutableState=function(e,i){return s.default.fromJS({[t.ACTIVE_DATASETS_KEY]:s.default.Set(i),[t.PARENT_ENGINE_KEY]:e})},t.applyMutations=function(e,...t){const i=r(e);if(i.currentState!==e)throw new Error("Attempt to apply mutation to state that is no longer active in the parent engine");return i.apply(...t),i.currentState},t.setParentEngine=function(e,i){return e.set(t.PARENT_ENGINE_KEY,i)},t.getParentEngine=r,t.assertStateHasDataSet=function(e,t){if(!o(e,t))throw new Error(`dataSet ${t} not available in the state (available dataSets: ${d(e).map(e=>`"${e.key}"`).join(",")})`)},t.isDataSetActive=o,t.getActiveDataSets=d,t.getActiveProjections=function(e){return d(e).filter(e=>c(e))},t.selectFromState=function(e,t,i){return a.assert(o(e,t),`dataSet ${t} not available in the state`),void 0!==i?t.getEntryById(e,i):e.get(t.key)},t.selectFromSuspendedState=function(e,t,i){return t.getEntryById(e,i)},t.isProjectionDataSet=c,t.updateActiveDataSets=function(e,i){return e.update(t.ACTIVE_DATASETS_KEY,t.EMPTY_SET,i)},t.isImmutableState=function(e){return s.default.Map.isMap(e)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnType=t.FactionController=t.PhaseTypes=void 0,function(e){e.GameStart="game-start",e.FactionTurn="faction-turn",e.GameOver="game-over"}(t.PhaseTypes||(t.PhaseTypes={})),function(e){e.None="none",e.LocalUser="local-user",e.Ai="ai",e.Remote="remote"}(t.FactionController||(t.FactionController={})),function(e){e.Town="town",e.Palisade="palisade",e.StoneWall="stonewall",e.Militia="militia",e.Pikeman="pikeman",e.Knight="knight",e.Hero="hero",e.Bandit="bandit",e.Coins="coins"}(t.PawnType||(t.PawnType={}))},function(e,t,i){"use strict";function n(e,t){for(var i=0,n=e.length;i<n;){var s=i+n>>>1;e[s]<t?i=s+1:n=s}return i}Object.defineProperty(t,"__esModule",{value:!0}),t.ascendingSortFn=t.getInsertionIndexInSortedArray=t.insertIntoSortedArray=t.getOrCreate=t.isObject=t.filterDictionaryInPlace=t.filterDictionary=t.mapDictionary=t.pick=t.omit=t.mergeArrays=t.dictionaryOf=t.removeFromArrayInPlace=t.pushIntoArrayByKey=t.cloneArrayWithoutItemAt=t.cloneArrayWithout=t.stripDuplicatesFrom=t.insertBetween=t.replaceArrayItem=void 0,t.replaceArrayItem=function(e,t,i){if(t<0||t>=e.length)throw new Error(`index out of bounds (array length: ${e.length}, index: ${t})`);return[...e.slice(0,t),i,...e.slice(t+1)]},t.insertBetween=function(e,t){return e.reduce((e,i,n,s)=>(e.push(i),n<s.length-1&&e.push(t),e),[])},t.stripDuplicatesFrom=function(e){const t={};return e.filter((function(e){return!t.hasOwnProperty(e)&&(t[e]=!0)}))},t.cloneArrayWithout=function(e,...t){return e.filter(e=>!t.includes(e))},t.cloneArrayWithoutItemAt=function(e,t){return[...e.slice(0,t),...e.slice(t+1)]},t.pushIntoArrayByKey=function(e,t,...i){void 0===e[t]&&(e[t]=[]),e[t].push(...i)},t.removeFromArrayInPlace=function(e,t){return-1===e.indexOf(t)||e.splice(e.indexOf(t),1),e},t.dictionaryOf=function(e,t){const i={};for(const n of e)i[n[t]]=n;return i},t.mergeArrays=function(...e){return[].concat(...e)},t.omit=function(e,...t){return Object.keys(e).reduce((i,n)=>(t.includes(n)||(i[n]=e[n]),i),{})},t.pick=function(e,...t){return Object.keys(e).reduce((i,n)=>(t.includes(n)&&(i[n]=e[n]),i),{})},t.mapDictionary=function(e,t){return Object.assign({},...Object.keys(e).map(i=>({[i]:t(e[i],i)})))},t.filterDictionary=function(e,t){const i={};for(const n in e)t(e[n],n)&&(i[n]=e[n]);return i},t.filterDictionaryInPlace=function(e,t){for(const i in e)t(e[i],i)||delete e[i];return e},t.isObject=function(e){return e&&"object"==typeof e&&!Array.isArray(e)},t.getOrCreate=function(e,t,i){if(void 0!==e[t])return e[t];const n=i();return e[t]=n,n},t.insertIntoSortedArray=function(e,t){const i=n(e,t);return e.splice(i,0,t),e},t.getInsertionIndexInSortedArray=n,t.ascendingSortFn=function(e,t){return e-t}},,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SystemEvents=t.UserActions=t.Plays=t.GameEvents=t.UnitsBecameBanditsContext=t.CoinsTransferContext=t.NewGameStateContext=void 0;const n=i(35);!function(e){e.StartingNewGame="starting new game",e.RestoredSavedGame="restored saved game",e.LoadedGameStateForDebug="loaded gamestate for debug",e.Undo="undo"}(t.NewGameStateContext||(t.NewGameStateContext={})),function(e){e.RegionEconomyTick="region economy tick",e.PawnBought="pawn bought"}(t.CoinsTransferContext||(t.CoinsTransferContext={})),function(e){e.NotPaid="not-paid"}(t.UnitsBecameBanditsContext||(t.UnitsBecameBanditsContext={})),t.GameEvents={NewGameState:n.gameStateEvent("NEW_GAME_STATE"),FailedToLoadGame:n.gameStateEvent("FAILED_TO_LOAD_GAME"),PawnMoved:n.gameStateEvent("PAWN_MOVED"),PawnBought:n.gameStateEvent("PAWN_BOUGHT"),HexCaptured:n.gameStateEvent("HEX_CAPTURED"),FactionEconomyUpdated:n.gameStateEvent("FACTION_ECONOMY_UPDATED"),FactionTurnStarted:n.gameStateEvent("FACTION_TURN_STARTED")},t.Plays={EndTurn:n.gameplayAction("END_TURN"),MovePawn:n.gameplayAction("REPOSITION_PAWN"),BuyPawn:n.gameplayAction("BUY_PAWN"),AttackHex:n.gameplayAction("ATTACK_HEX")},t.UserActions={StartNewGame:n.userAction("START_NEW_GAME"),SaveGame:n.userAction("SAVE_GAME"),LoadGame:n.userAction("LOAD_GAME"),ResumeGame:n.userAction("RESUME_GAME"),RevertTurn:n.userAction("REVERT_TURN"),EndTurn:n.userAction("END_TURN"),DebugGameState:n.userAction("DEBUG_GAME_STATE"),EditMap:n.userAction("EDIT_MAP"),SyncWithModel:n.userAction("SYNC_WITH_MODEL")},t.SystemEvents={EngineInitialized:n.systemEvent("ENGINE_INITIALIZED")}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createAIDataSets=t.createEconomyDataSets=t.createUnitsDataSets=t.createPawnDataSets=t.createFactionDataSets=t.createRegionDataSets=t.GameState=t.CORE_GAMESTATE_SCHEMA_VERSION=void 0;const n=i(155),s=i(156),a=i(5),r=i(157),o=i(64),d=i(93),c=i(18),h=i(158),l=i(168),u=i(170),g=i(99),p=i(172),f=i(66),m=i(101),y=i(173),w=i(174),v=i(175),b=i(102),x=i(103),S=i(176),P=i(177),M=i(178);t.CORE_GAMESTATE_SCHEMA_VERSION=3;const H=new d.SingletonDataSet("grid",{width:10,height:10}),T=new d.SingletonDataSet("ruleSet",o.ruleSets.default),E=j(),_=A(),I=B(),D=G(),O=function(){const e={data:new d.SingletonDataSet("currentPhase",{type:a.PhaseTypes.GameStart}),tappedUnits:new g.SetDataSet("currentPhase.tappedUnits")};return Object.assign(Object.assign({},e),{movableUnits:new p.MovableUnitsProjection("currentPhase.movableUnits",{currentPhase:e.data,currentPhaseTappedUnits:e.tappedUnits,unitsByFaction:D.byFaction})})}(),C=F(),R={hexBaseDefense:new m.HexBaseDefenseProjection("warfare.hexBaseDefense",{grid:H,rules:T,movableUnits:O.movableUnits,pawns:_.byId,pawnsByHex:_.byHex,regionsByHex:E.byHex})};function j(){const e=new c.MapDataSet("regions"),t=new c.MapDataSet("regions.byHex"),i=new n.InvertedMapProjection("regions.hexes",t);return{byId:e,byHex:t,hexes:i,borderHexes:new x.RegionBorderHexesProjection("regions.borderHexes",i),nextId:new s.NextIdProjection("regions.nextId",e)}}function B(){const e={byId:new c.MapDataSet("factions"),byRegion:new c.MapDataSet("factions.byRegion")},t=new n.InvertedMapProjection("factions.regions",e.byRegion);return Object.assign(Object.assign({},e),{regions:t,nextId:new s.NextIdProjection("factions.nextId",e.byId)})}function A(){const e={byId:new c.MapDataSet("pawns"),hex:new c.MapDataSet("pawns.hex"),count:new c.MapDataSet("pawns.count")},t=new n.InvertedMapProjection("pawns.byHex",e.hex);return Object.assign(Object.assign({},e),{byHex:t,nextId:new s.NextIdProjection("pawns.nextId",e.byId),byRegion:new r.PawnsByRegionProjection("pawns.byRegion",{pawnsByHex:t,regionsByHex:E.byHex,pawnsHex:e.hex})})}function G(){return{byFaction:new u.UnitsByFactionProjection("units.byFaction",{factionRegions:I.regions,pawnsByRegion:_.byRegion,factionByRegion:I.byRegion,rules:T})}}function F(){const e=new l.HexesByPawnTypeAndRegionProjection("economy.townsByRegion",a.PawnType.Town,{pawnsByRegion:_.byRegion}),t=new v.CoinsByHexProjection("economy.coinsByHex",{pawnsByHex:_.byHex,pawns:_.byId,pawnsCount:_.count});return{coinsByHex:t,townsByRegion:e,treasuryByRegion:new w.TreasuryByRegionProjection("economy.treasuryByRegion",{coinsByHex:t,townsByRegion:e,regionsByHex:E.byHex}),budgetByRegion:new y.BudgetByRegionProjection("economy.budgetByRegion",{regions:E.byId,regionHexes:E.hexes,townsByRegion:e,pawnsByRegion:_.byRegion})}}function k(){const e=new S.RegionHostileBorderHexesProjection("ai.hostileBorderHexes",E.borderHexes),t=new P.HexDepthProjection("ai.hexDepth",{regionHexes:E.hexes,hostileBorderHexes:e}),i=new M.PawnsValueByHex("ai.pawnsValueByHex",{pawns:_.byId,pawnsHex:_.hex,movableUnits:O.movableUnits,rules:T}),n=new h.HexImportanceProjection("ai.hexImportance",{grid:H,regionsByHex:E.byHex,regionsHexes:E.hexes,townsByRegion:C.townsByRegion,pawnsValueByHex:i}),s=new b.MightByRegionProjection("ai.mightByRegion",{regionsByHex:E.byHex,coinsByHex:C.coinsByHex,budgetByRegion:C.budgetByRegion,pawnsByRegion:_.byRegion,movableUnits:O.movableUnits});return{hostileBorderHexes:e,hexDepth:t,hexPawnsCost:i,hexImportance:n,mightByRegion:s,hexVulnerability:new f.HexVulnerabilityProjection("ai.hexVulnerability",{factionsByRegion:I.byRegion,regionHostileBorder:e,mightByRegion:s,hexBaseDefense:R.hexBaseDefense,regionsByHex:E.byHex,currentPhase:O.data})}}t.GameState={version:new d.SingletonDataSet("version",t.CORE_GAMESTATE_SCHEMA_VERSION),grid:H,regions:E,factions:I,pawns:_,ruleSet:T,units:D,currentPhase:O,economy:C,warfare:R,ai:k()},t.createRegionDataSets=j,t.createFactionDataSets=B,t.createPawnDataSets=A,t.createUnitsDataSets=G,t.createEconomyDataSets=F,t.createAIDataSets=k},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RegionMutations=t.Regions=void 0;const s=i(9),a=n(i(7)),r=i(20),o=i(4),d=i(165),c=i(0),h=i(2),l=i(18);class u{static model(e){return c.inject.currentGameState=e,this._model}static getAll(e){return o.selectFromState(e,s.GameState.regions.byId).keySeq().toArray()}static getByHex(e,t){return o.selectFromState(e,s.GameState.regions.byHex,t)}static getRegionData(e,t){return o.selectFromState(e,s.GameState.regions.byId,t)}static getRegionHexes(e,t){return o.selectFromState(e,s.GameState.regions.hexes,t)||o.EMPTY_SET}static getRegionBorderHexes(e,t){return o.selectFromState(e,s.GameState.regions.borderHexes,t)||o.EMPTY_SET}static destroyRegions(e,...t){if(0===t.length)return e;const i=a.default.Set.union(t.map(t=>u.getRegionHexes(e,t))).toArray();return e=r.Factions.disownRegions(e,...t),e=o.applyMutations(e,s.GameState.regions.byHex.createMutation({delete:i},"destroyRegions"),s.GameState.regions.byId.createMutation({delete:t},"destroyRegions"))}static getSameRegionNeighbours(e,t){const i=this.getByHex(e,t.id);return t.neighbours(t=>this.getByHex(e,t.id)===i)}static getAdjacentForeignHexes(e,t){return this.model(e).byId(t).getHostileBorderHexes().neighbours().filter(i=>{const n=this.getByHex(e,i.id);return void 0!==n&&n!==t})}static getNextId(e){return o.selectFromState(e,s.GameState.regions.nextId)}static createRegion(e,t,i){const n=u.getNextId(e),s=[g.createRegion(n,t)];return i&&s.push(g.addHexesToRegion(n,i)),o.applyMutations(e,...s)}static addHexesToRegion(e,t,i){return o.applyMutations(e,g.addHexesToRegion(t,i))}static removeHexesFromRegion(e,t){return o.applyMutations(e,s.GameState.regions.byHex.createMutation({delete:t},"removeHexesFromRegion"))}static splitRegionIntoComponents(e,t){const i=this.model(e).byId(t),n=r.Factions.getByRegion(e,t);h.assert.defined(i,"no region found for id "+t);const a=i.hexes.components(),d=a.getLargestGroupKey();if(!d)return;a.removeGroup(d);const c=new l.MapMutationBuilder(s.GameState.regions.byId).init(e),g=new l.MapMutationBuilder(s.GameState.regions.byHex).init(e),p=new l.MapMutationBuilder(s.GameState.factions.byRegion).init(e);let f=u.getNextId(e);return a.forEach(e=>{c.set(f,{id:f,name:i.name}),g.setAll(e.toIdsArray(),f),void 0!==n&&p.set(f,n),f++}),o.applyMutations(e,g.createMutation("regions.splitRegionIntoComponents"),c.createMutation("regions.splitRegionIntoComponents"),p.createMutation("regions.splitRegionIntoComponents"))}}t.Regions=u,u._model=new d.RegionsDataSetModel;class g{static createRegion(e,t){return s.GameState.regions.byId.createMutation({set:{[e]:{id:e,name:t}}},"createRegion")}static addHexesToRegion(e,t){const i={};return t.forEach(t=>{i[t]=e}),s.GameState.regions.byHex.createMutation({set:i},"addHexesToRegion")}}t.RegionMutations=g},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnMutations=t.Pawns=void 0;const n=i(4),s=i(9),a=i(2),r=i(161),o=i(0),d=i(3);class c{static model(e){return o.inject.currentGameState=e,this._model}static getPawnData(e,t){return n.selectFromState(e,s.GameState.pawns.byId,t)}static getPawnType(e,t){var i;return null===(i=this.getPawnData(e,t))||void 0===i?void 0:i.type}static getPawnCount(e,t){return n.selectFromState(e,s.GameState.pawns.count,t)||0}static getByHex(e,t,i){var a,r;return void 0===i?(null===(a=n.selectFromState(e,s.GameState.pawns.byHex,t))||void 0===a?void 0:a.toArray())||[]:null===(r=n.selectFromState(e,s.GameState.pawns.byHex,t))||void 0===r?void 0:r.filter(t=>{var n;return(null===(n=c.getPawnData(e,t))||void 0===n?void 0:n.type)===i}).first()}static getPawnHex(e,t){return n.selectFromState(e,s.GameState.pawns.hex,t)}static getByRegion(e,t){var i;return(null===(i=n.selectFromState(e,s.GameState.pawns.byRegion,t))||void 0===i?void 0:i.toArray())||[]}static getNextId(e){return n.selectFromState(e,s.GameState.pawns.nextId)}static getAll(e){return n.selectFromState(e,s.GameState.pawns.byId).keySeq().toArray()}static destroy(e,...t){return 0===t.length?e:n.applyMutations(e,...h.destroyPawns(t))}static create(e,t){return n.applyMutations(e,...h.createPawn(e,t))}static setPawnCount(e,t,i){return a.assert(i>=0,`attempt to set count of pawn #${t} to negative value (${i})`),n.applyMutations(e,h.setPawnCount(t,i))}static replacePawn(e,t,i){const s=c.getPawnHex(e,t),r=c.getByHex(e,s,i),o=Object.assign(Object.assign({},c.getPawnData(e,t)),{type:i});return a.assert.undefined(r,`Cannot replace pawn ${t} with ${i}, pawn ${r} on the same hex already has this type`),n.applyMutations(e,...h.replacePawn(e,t,Object.assign(Object.assign({},o),{hex:d.getHex(s)})))}static movePawn(e,t,i){const a=this.getPawnData(e,t).type,r=c.getByHex(e,i,a);return r?n.applyMutations(e,h.setPawnCount(t,this.getPawnCount(e,r)+1),...h.destroyPawns([r])):n.applyMutations(e,s.GameState.pawns.hex.createMutation({set:{[t]:i}},"pawn.moveTo"))}}t.Pawns=c,c._model=new r.PawnsDataSetModel;class h{static setPawnCount(e,t){return a.assert(t>=0,`attempt to set count of pawn #${e} to negative value (${t})`),s.GameState.pawns.count.createMutation({set:{[e]:t}},"setPawnCount")}static destroyPawns(e){return[s.GameState.pawns.count.createMutation({delete:e},"pawns.destroy"),s.GameState.pawns.hex.createMutation({delete:e},"pawns.destroy"),s.GameState.pawns.byId.createMutation({delete:e},"pawns.destroy")]}static createPawn(e,t){const i=c.getNextId(e),n={id:i,type:t.type,name:t.name};return[s.GameState.pawns.byId.createMutation({set:{[i]:n}},"pawns.create"),s.GameState.pawns.hex.createMutation({set:{[i]:t.hex.id}},"pawns.create"),s.GameState.pawns.count.createMutation({set:{[i]:t.count||1}},"pawns.create")]}static replacePawn(e,t,i){const n=c.getNextId(e),a={id:n,type:i.type,name:i.name};return[s.GameState.pawns.byId.createMutation({set:{[n]:a},delete:[t]},"pawns.replace"),s.GameState.pawns.hex.createMutation({set:{[n]:i.hex.id},delete:[t]},"pawns.replace"),s.GameState.pawns.count.createMutation({set:{[n]:i.count||1},delete:[t]},"pawns.replace")]}}t.PawnMutations=h},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexGroup=void 0;const s=n(i(151)),a=i(6),r=n(i(43));var o=Phaser.Math.MIN_SAFE_INTEGER;class d{constructor(e={},t){this.membersByIndex=e,this._membersList=t}get length(){return this.members.length}get members(){return this._membersList||(this._membersList=Object.values(this.membersByIndex),Object.freeze(this._membersList)),this._membersList}static from(e){const t={},i=e.filter(e=>void 0!==e);for(let e of i)t[e.id]=e;return new d(t,i)}static union(e){const t=a.stripDuplicatesFrom(a.mergeArrays(...e.map(e=>e.members)));return d.from(t)}boundingBox(){var e;if(0===this.length)return{x:0,y:0,height:0,width:0};let t=Number.MAX_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER,n=-Number.MAX_SAFE_INTEGER,s=-Number.MAX_SAFE_INTEGER;for(let a of this.members)(null!==(e=a.display.left<t)&&void 0!==e?e:Number.MAX_SAFE_INTEGER)&&(t=a.display.left),a.display.right>n&&(n=a.display.right),a.display.top<i&&(i=a.display.top),a.display.bottom>s&&(s=a.display.bottom);return{x:t,y:i,width:n-t,height:s-i}}toIdsArray(){return this.members.map(e=>e.id)}toArray(){return[...this.members]}has(e){return!!this.membersByIndex[e.id]}contains(e){return void 0!==e&&this.containsId(e.id)}containsId(e){return!!this.membersByIndex[e]}border(e=!0){return this.filter(t=>{const i=t.neighbours();return!!(e&&i.length<6)||!!i.find(e=>!this.has(e))})}borderIncludingShoreline(){return this.border(!0)}neighbours(){return d.union(this.map(e=>e.neighbours().filter(e=>!this.has(e))))}neighboursOf(e){return e.neighbours(e=>this.has(e))}components(e=(()=>!0)){let t=new s.default,i=1;const n=(t,i)=>!i||e(t,i);return this.forEach(e=>{t.getOwnerOf(e)||(t.addToGroup(i,e),t.addToGroup(i,...this.floodFillFrom(e,n).members),++i)}),t}with(...e){return d.from([...this.members,...e])}without(e){const t=Object.assign({},this.membersByIndex);return e.forEach(e=>delete t[e.id]),new d(t)}filter(e){return d.from(this.members.filter(e))}forEach(e){return this.members.forEach(e)}map(e){return this.members.map(e)}find(e){return this.members.find(e)}sort(e){return this.members.sort(e)}bfsFrom(e,t=(()=>!0)){let i=[];e.forEach(e=>i.push({hex:e,d:0}));let n=new Set(e.members);const s=({hex:e,d:s,parent:a})=>{n.add(e);if(t(e,a,s)){e.neighbours().filter(e=>this.has(e)&&!n.has(e)).members.forEach(t=>{n.add(t),i.push({hex:t,d:s+1,parent:e})})}};for(;i.length>0;)s(i.shift())}floodFillOut(e=(()=>!0)){let t=[];this.forEach(e=>t.push({hex:e,d:0}));let i=new Set(this.members);const n=({hex:n,d:s,parent:a})=>{i.add(n);if(e(n,a,s)){n.neighbours().filter(e=>!i.has(e)).members.forEach(e=>{i.add(e),t.push({hex:e,d:s+1,parent:n})})}};for(;t.length>0;)n(t.shift())}customSearchFrom(e,t,i){let n=new r.default((e,t)=>t.score-e.score);e.forEach(e=>n.push({hex:e,d:0,score:i(e)}));let s=new Set(e.members);const a=({hex:e,d:a,parent:r})=>{s.add(e);if(t(e,r,a)){e.neighbours().filter(e=>this.has(e)&&!s.has(e)).members.forEach(t=>{s.add(t),n.push({hex:t,d:a+1,score:i(t),parent:e})})}};for(;n.size()>0;)a(n.pop())}findClosest(e,t){let i=void 0;return this.bfsFrom(e,e=>!i&&(!t(e)||(i=e,!1))),i}toString(){const e=this.members.slice(0,3).map(e=>e.toString()).join(",")+(this.length>3?",...":"");return`[HexGroup (${this.length}⬡): ${e}]`}findInnerMostHex(){let e=this,t=this;for(;t.length>0;)e=t,t=t.without(t.border());return e.findMax(e=>e.neighbours(e=>this.has(e)).length)}findMax(e){return this.members.reduce((t,i)=>{const n=e(i);return n>t.score?{score:n,hex:i}:t},{hex:void 0,score:o}).hex}floodFillFrom(e,t){const i=[...e.members];return this.bfsFrom(e,(e,n,s)=>!n||!!t(e,n,s)&&(i.push(e),!0)),d.from(i)}}t.HexGroup=d,d.empty=new d({})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnTraits=void 0,function(e){e.NegatesTileIncome="negates-tile-income",e.Unit="unit",e.Wall="structure",e.EnablesRetreat="enables-retreat",e.Pest="pest",e.Roams="roams",e.Grows="grows",e.GuardsAdjacentTiles="protects-adjacent",e.OccupiesTile="occupies-tile"}(t.PawnTraits||(t.PawnTraits={}))},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.numberToDots=t.prettyPrintObject=t.OBJECT_TO_STRING_WHITELIST=t.withSign=t.sleep=t.deepFreeze=t.isDefined=t.decompressStr=t.compressStr=t.shallowStr=t.replaceClassObjects=t.str=void 0;const s=n(i(131)),a=n(i(132)),r=i(6);function o(e){return"object"!=typeof e||null==e?e:Array.isArray(e)?e.map(o):"Object"!==e.constructor.name?`[${e.constructor.name}]`:r.mapDictionary(e,e=>o(e))}t.str=function(e,t){e=o(e);const i=s.default(e);return t&&i.length>t?i.slice(0,t)+"(...)":i},t.replaceClassObjects=o,t.shallowStr=function(e){return s.default(e,(e,t)=>e&&t&&"number"!=typeof t?Array.isArray(t)?"[object Array]":""+t:t)},t.compressStr=function(e){return a.default.compress(e,{outputEncoding:"StorageBinaryString"})},t.decompressStr=function(e){return a.default.decompress(e,{inputEncoding:"StorageBinaryString"})},t.isDefined=function(e){return null!=e},t.deepFreeze=function e(t){const i=Object.getOwnPropertyNames(t);for(const n of i){const i=t[n];i&&"object"==typeof i&&e(i)}return Object.freeze(t)},t.sleep=function(e){return new Promise(t=>setTimeout(t,e))},t.withSign=function(e){return e>=0?"+"+e:e.toString()},t.OBJECT_TO_STRING_WHITELIST=new Set(["UnitsByMight"]),t.prettyPrintObject=function e(i,n=0){const s=Array(n+1).join(" ");return Object.entries(i).map(([i,a])=>null==a?`${s}${i}: ⊘`:Array.isArray(a)?`${s}${i}: ${a.join(",")}`:"object"==typeof a&&null!==a?t.OBJECT_TO_STRING_WHITELIST.has(a.constructor.name)?`${s}${i}: ${a.toString()}`:`${s}${i}:\n${e(a,n+2)}`:`${s}${i}: ${a}`).join("\n")};t.numberToDots=function(e){return e>8?"⣿":" ⠁⠃⠇⠏⠟⠿⡿⣿"[e]}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HEX_POLYGON=t.HEX_COLLAR_HEIGHT=t.HEX_ANGLED_HEIGHT=t.HEX_INNER_HEIGHT=t.HALF_HEX_HEIGHT=t.HEX_HEIGHT=t.HALF_HEX_WIDTH=t.HEX_WIDTH=void 0,t.HEX_WIDTH=48,t.HALF_HEX_WIDTH=t.HEX_WIDTH/2,t.HEX_HEIGHT=48,t.HALF_HEX_HEIGHT=t.HEX_HEIGHT/2,t.HEX_INNER_HEIGHT=36,t.HEX_ANGLED_HEIGHT=t.HEX_HEIGHT-t.HEX_INNER_HEIGHT,t.HEX_COLLAR_HEIGHT=30;t.HEX_POLYGON=[[-.5,-.25],[0,-.5],[.5,-.25],[.5,.25],[0,.5],[-.5,.25]].map(([e,t])=>[e+.5,t+.5]).map(([e,i])=>({x:e*t.HEX_WIDTH,y:i*t.HEX_HEIGHT}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.signal=void 0,t.signal=function(){const e=[],t=function(t){return e.push(t),{unsubscribe(){const i=e.indexOf(t);-1!==i&&e.splice(i,1)}}};return t.fire=t=>e.map(e=>e(t)),t}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.max=t.sum=void 0;t.sum=(e,t)=>e+t;t.max=(e,t)=>e>=t?e:t},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MapMutationBuilder=t.MapDataSet=void 0;const s=n(i(7)),a=i(49),r=i(4),o=i(2);t.MapDataSet=class{constructor(e){this.key=e,this.defaultValue=s.default.Map()}deserialize(e){let t=s.default.Map();return Object.entries(e).forEach(([e,i])=>{t=t.set(Number(e),i)}),t}serialize(e){return e.toJS()}apply(e,t){return e.withMutations(e=>{var i;null===(i=t.updated)||void 0===i||i.forEach(([t,i])=>{void 0===i?e.deleteIn([this.key,t]):e.setIn([this.key,t],i)})})}createMutation(e,t){let i={};if(e.set&&!a.isEmpty(e.set)&&(i.updated=Object.entries(e.set).map(([e,t])=>[Number(e),t])),e.delete&&!a.isEmpty(e.delete)){const t=e.delete.map(e=>[e,void 0]);i.updated?i.updated.push(...t):i.updated=t}return{dataSet:this,changes:i,context:`${this.key}/${t}`}}getEntryById(e,t){return e.getIn([this.key,t])}entryToString(e){return e.toString()}entryToDebugString(e){return JSON.stringify(e)}getEntryIds(e){var t;return(null===(t=e.get(this.key))||void 0===t?void 0:t.keySeq().toArray())||[]}toString(){return`[MapDataSet "${this.key}"]`}};t.MapMutationBuilder=class{constructor(e){this.dataSet=e}init(e){return this.state=e,this._entriesToSet={},this._entriesToDelete=new Set,this}set(e,t){return o.assert.defined(this.state,"builder not initialized!"),this._entriesToDelete.delete(e),this._entriesToSet[e]=t,this}setFromBootstrap(){o.assert.defined(this.state,"builder not initialized!"),o.assert(r.isProjectionDataSet(this.dataSet),`Cannot call setFromBootstrap on ${this.dataSet} - it's not a projection`),this._entriesToSet=this.dataSet.bootstrap(this.state).toObject()}delete(e){o.assert.defined(this.state,"builder not initialized!"),delete this._entriesToSet[e],this._entriesToDelete.add(e)}getCurrent(e){if(o.assert.defined(this.state,"builder not initialized!"),!this._entriesToDelete.has(e))return this._entriesToSet.hasOwnProperty(e)?this._entriesToSet[e]:this.state.getIn([this.dataSet.key,e])}has(e){return!!this.get(e)}get(e){if(o.assert.defined(this.state,"builder not initialized!"),!this._entriesToDelete.has(e))return this._entriesToSet[e]}getEntries(){return o.assert.defined(this.state,"builder not initialized!"),this._entriesToSet}clear(){throw new Error("Not Implemented")}createMutation(e){return o.assert.defined(this.state,"builder not initialized!"),this.dataSet.createMutation({set:this._entriesToSet,delete:Array.from(this._entriesToDelete).filter(e=>void 0!==this.state.getIn([this.dataSet.key,e]))},e)}setAll(e,t){e.forEach(e=>this.set(e,t))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TransitionsMode=void 0,function(e){e[e.Disabled=0]="Disabled",e[e.Pretty=1]="Pretty",e[e.Fast=2]="Fast"}(t.TransitionsMode||(t.TransitionsMode={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionMutations=t.Factions=void 0;const n=i(9),s=i(10),a=i(5),r=i(4),o=i(159),d=i(2),c=i(0);class h{static model(e){return c.inject.currentGameState=e,this._model}static getAll(e){return r.selectFromState(e,n.GameState.factions.byId).keySeq().toArray()}static getData(e,t){return r.selectFromState(e,n.GameState.factions.byId,t)}static getByRegion(e,t){return r.selectFromState(e,n.GameState.factions.byRegion,t)}static getByHex(e,t){const i=s.Regions.getByHex(e,t);if(i)return h.getByRegion(e,i)}static getNextId(e){return r.selectFromState(e,n.GameState.factions.nextId)}static getFactionRegions(e,t){var i;return(null===(i=r.selectFromState(e,n.GameState.factions.regions,t))||void 0===i?void 0:i.toArray())||[]}static setLandColor(e,t,i){const s=h.getData(e,t);return d.assert.defined(s),r.applyMutations(e,n.GameState.factions.byId.createMutation({set:{[t]:Object.assign(Object.assign({},s),{landColor:i})}},"faction.setLandColor"))}static createFaction(e,{name:t,regions:i,landColor:s,controller:o}){const d=this.getNextId(e),c={id:d,name:t,controller:null!=o?o:a.FactionController.None,landColor:null!=s?s:0};return r.applyMutations(e,n.GameState.factions.byId.createMutation({set:{[d]:c}},"createFaction"),l.captureRegions(d,i||[]))}static captureRegions(e,t,...i){return 0===i.length?e:r.applyMutations(e,l.captureRegions(t,i))}static addNewRegion(e,t,i,n){const a=s.Regions.getNextId(e);return r.applyMutations(e,s.RegionMutations.createRegion(a,i),s.RegionMutations.addHexesToRegion(a,n),l.captureRegions(t,[a]))}static disownRegions(e,...t){const i=t.filter(t=>void 0!==this.getByRegion(e,t));return r.applyMutations(e,n.GameState.factions.byRegion.createMutation({delete:i},"faction.disownRegions"))}static getSameFactionNeighbours(e,t,i){const n=null!=i?i:this.getByHex(e,t.id);return t.neighbours(t=>this.getByHex(e,t.id)===n)}}t.Factions=h,h._model=new o.FactionsDataSetModel;class l{static captureRegions(e,t){const i={};return t.forEach(t=>i[t]=e),n.GameState.factions.byRegion.createMutation({set:i},"faction.captureRegions")}}t.FactionMutations=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Units=t.InvalidDropPawnReason=t.DropPawnResultType=void 0;const n=i(13),s=i(9),a=i(17),r=i(4),o=i(32),d=i(10),c=i(11),h=i(6),l=i(0),u=i(171);!function(e){e.Invalid="invalid",e.Reposition="reposition",e.Conquest="conquest",e.Combine="combine",e.EradicatePest="eradicate-pest"}(t.DropPawnResultType||(t.DropPawnResultType={})),function(e){e.PreventedByPawn="prevented-by-pawn",e.OutOfRange="out-of-range",e.InvalidRegion="invalid-region"}(t.InvalidDropPawnReason||(t.InvalidDropPawnReason={}));class g{static model(e){return l.inject.currentGameState=e,this._model}static getConquerableHexes(e,t,i){const n="number"==typeof i?i:o.Rules.model(e).pawns(i).might;return d.Regions.getAdjacentForeignHexes(e,t).filter(t=>this.getHexDefense(e,t)<n)}static getHexDefense(e,t){const i=this.getHexLocalDefense(e,t.id);return d.Regions.getSameRegionNeighbours(e,t).map(t=>this.getHexProjectedDefense(e,t.id)).reduce(a.max,i)}static getHexDefenseAsIfOwnedBy(e,t,i){const n=this.getHexLocalDefense(e,t.id);return t.neighbours(t=>d.Regions.getByHex(e,t.id)===i).map(t=>this.getHexProjectedDefense(e,t.id)).reduce(a.max,n)}static getHexDefenseIncludingMovableUnits(e,t){const i=this.getHexLocalDefenseIncludingMovableUnits(e,t);return d.Regions.getSameRegionNeighbours(e,t).map(t=>this.getHexProjectedDefenseIncludingMovableUnits(e,t.id)).reduce(a.max,i)}static getHexLocalDefenseIncludingMovableUnits(e,t){return c.Pawns.model(e).byHex(t).map(e=>e.defense).reduce(a.max)}static getHexLocalDefense(e,t){var i;return(null===(i=r.selectFromState(e,s.GameState.warfare.hexBaseDefense,t))||void 0===i?void 0:i.local)||0}static getHexProjectedDefense(e,t){var i;return(null===(i=r.selectFromState(e,s.GameState.warfare.hexBaseDefense,t))||void 0===i?void 0:i.projected)||0}static getHexProjectedDefenseIncludingMovableUnits(e,t){var i;return(null===(i=r.selectFromState(e,s.GameState.warfare.hexBaseDefense,t))||void 0===i?void 0:i.projected)||0}static getHexDefenders(e,t,i=1){const s=c.Pawns.model(e),a=d.Regions.getSameRegionNeighbours(e,t);return[...s.byHex(t),...s.select({hexes:a,traits:[n.PawnTraits.GuardsAdjacentTiles]})].filter(e=>e.defense>=i)}static canConquerHexWith(e,t,i){const n=o.Rules.model(e).pawns(i).might;return!!d.Regions.getByHex(e,t.id)&&this.getHexDefense(e,t)<n}static getOccupyingUnit(e,t){return c.Pawns.model(e).select({hexes:t,traits:[n.PawnTraits.OccupiesTile]})[0]}static getByRegion(e,...t){return h.mergeArrays(...t.map(t=>c.Pawns.getByRegion(e,t).filter(t=>g.isUnit(e,t))||[]))}static isUnit(e,t){var i;return null===(i=c.Pawns.model(e).byId(t))||void 0===i?void 0:i.hasTrait(n.PawnTraits.Unit)}}t.Units=g,g._model=new u.UnitsModel},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseUpdater=void 0;i(1).logger.for("BaseUpdater");t.BaseUpdater=class{constructor(e){this.dataSet=e,this.handlers=[],this.initFromState=e=>{this.newState=e,this.oldState=void 0,this.builder.init(e),this.initialize()},this.update=(e,t,i)=>(this.newState=e,this.changeSet=t,this.oldState=i,this.builder.init(e),this.initialize(),this.handlers.forEach(({dataSet:e,handler:t})=>{const i=this.changeSet.of(e);i&&t(i)}),this.createMutation()),this.registerHandlers((e,t)=>this.handlers.push({dataSet:e,handler:t.bind(this)}))}createMutation(){return this.builder.createMutation("parents changed")}initialize(){}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurrentPhase=void 0;const n=i(9),s=i(4),a=i(164),r=i(0);class o{static model(e){return r.inject.currentGameState=e,this._model}static getFaction(e){var t;return null===(t=s.selectFromState(e,n.GameState.currentPhase.data))||void 0===t?void 0:t.faction}static getType(e){var t;return null===(t=s.selectFromState(e,n.GameState.currentPhase.data))||void 0===t?void 0:t.type}static isMovable(e,t){return s.selectFromState(e,n.GameState.currentPhase.movableUnits).has(t)}static getMovableUnits(e){return s.selectFromState(e,n.GameState.currentPhase.movableUnits).toArray()}static isTapped(e,t){return s.selectFromState(e,n.GameState.currentPhase.tappedUnits).has(t)}static tapPawn(e,t){return s.applyMutations(e,n.GameState.currentPhase.tappedUnits.createMutation({add:[t]},"currentPhase.tapPawn"))}static unTapPawn(e,t){return s.applyMutations(e,n.GameState.currentPhase.tappedUnits.createMutation({delete:[t]},"currentPhase.unTapPawn"))}static set(e,t,i){return s.applyMutations(e,n.GameState.currentPhase.data.createMutation({type:t,faction:i},"currentPhase.set"),n.GameState.currentPhase.tappedUnits.createMutation({clear:!0},"currentPhase.set"))}}t.CurrentPhase=o,o._model=new a.CurrentPhaseModel},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldLayers=void 0,function(e){e[e.Tiles=0]="Tiles",e[e.TileBorders=1e4]="TileBorders",e[e.TileHighlight=2e4]="TileHighlight",e[e.TileObjects=3e4]="TileObjects",e[e.FlyingObject=4e4]="FlyingObject",e[e.DebugOverlay=5e4]="DebugOverlay"}(t.WorldLayers||(t.WorldLayers={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ParallelCinematic=t.BaseCinematic=void 0;class n{constructor(e){this.scene=e}playAfter(e,t){this.scene.time.addEvent({delay:e,callback:()=>this.play(t)})}}t.BaseCinematic=n;t.ParallelCinematic=class extends n{constructor(e){super(e),this.subCinematics=[],this.completed=0}add(e){this.subCinematics.push(e)}play(e){0!==this.subCinematics.length?this.subCinematics.forEach(t=>{t.play(()=>{++this.completed,this.completed>=this.subCinematics.length&&e&&e()})}):e&&e()}}},,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Scenes=void 0,function(e){e.Play="PlayScene",e.Debug="DebugScene",e.WorldMap="WorldMapScene",e.Preload="PreloadScene",e.MapEditor="MapEditorScene",e.PlayUI="PlayUI",e.DesktopControlPanel="DesktopControlPanel",e.CompactControlPanel="CompactControlPanel"}(t.Scenes||(t.Scenes={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Economy=t.EMPTY_BUDGET=void 0;const n=i(9),s=i(4),a=i(97),r=i(13),o=i(98),d=i(12),c=i(32),h=i(11),l=i(10),u=i(1),g=i(167),p=i(0),f=u.logger.for("Economy");t.EMPTY_BUDGET={balance:0,upkeep:0,incomeFromHexes:0};class m{static model(e){return p.inject.currentGameState=e,this._model}static getTownHexesByRegion(e,t){var i;return(null===(i=s.selectFromState(e,n.GameState.economy.townsByRegion,t))||void 0===i?void 0:i.toArray())||[]}static getBaseIncomePerHex(e){return c.Rules.getEconomyRules(e).baseIncomePerTile}static getIncomeFromHex(e,t){return h.Pawns.model(e).byHex(t).find(e=>e.hasTrait(r.PawnTraits.NegatesTileIncome))?0:this.getBaseIncomePerHex(e)}static advanceRegionEconomy(e,t){return new a.RegionEconomyCalculator(e,t).run()}static getTreasuryOf(e,t){return s.selectFromState(e,n.GameState.economy.treasuryByRegion,t)||0}static getNumberOfCoinsAt(e,t){return s.selectFromState(e,n.GameState.economy.coinsByHex,t)||0}static payForNewPawn(e,t,i){var n;return this.payToHex(e,t,(null===(n=c.Rules.getPawnRules(e,i))||void 0===n?void 0:n.cost)||0)}static payToHex(e,t,i,n=new o.CoinTransactionBuilder){const s=l.Regions.model(e).byHex(t);let a=i;n.from(t).consume(i);let r=new Set;for(;a>0;){const o=s.hexes.findClosest(t,t=>!r.has(t)&&m.getNumberOfCoinsAt(e,t.id)>0);if(!o)throw new Error(`Unable to find enough gold to pay ${i}g to hex ${t} in region ${s}`);const d=m.getNumberOfCoinsAt(e,o.id),c=Math.min(d,a);a-=c,r.add(o),n.from(o).send(t,c)}return n}static loot(e,t,i,n=new o.CoinTransactionBuilder){const s=new o.CoinTransactionBuilder,a=m.getTownHexesByRegion(e,i.id),r=d.HexGroup.from([...i.hexes.members,t]).findClosest(t,e=>e!==t&&a.includes(e.id));return r?s.from(t).send(r,this.getNumberOfCoinsAt(e,t.id)):(f.warning(`did not find any town in ${i} that could receive loot from ${t}, the money will just disappear`),s.from(t).consume(this.getNumberOfCoinsAt(e,t.id))),s}static getRegionBudget(e,i){return s.selectFromState(e,n.GameState.economy.budgetByRegion,i)||t.EMPTY_BUDGET}}t.Economy=m,m._model=new g.EconomyModel},function(e,t,i){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),t.AudioManager=t.SoundEffects=void 0,function(e){e.Grab="grab",e.Drop="drop",e.Deny="deny",e.Click="click"}(n=t.SoundEffects||(t.SoundEffects={}));t.AudioManager=class{constructor(e){this.game=e}preload(e){for(let t of Object.values(n))e.load.audio(t,`assets/audio/${t}.wav`)}playEffect(e){this.game.sound.play(e)}}},,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseModel=void 0;const n=i(0);t.BaseModel=class{get state(){return n.inject.currentGameState}set state(e){n.inject.currentGameState=e}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rules=void 0;const n=i(9),s=i(163),a=i(13),r=i(95),o=i(4),d=i(11);class c{static get(e){return o.selectFromState(e,n.GameState.ruleSet)}static model(e){const t=this.get(e);return this.modelFactory.getOrCreateFor(t)}static getEconomyRules(e){return c.get(e).economy}static getPawnRules(e,t){return o.selectFromState(e,n.GameState.ruleSet).pawns[t]}static getPawnCost(e,t){return this.getPawnRules(e,t).cost||0}static getMergeResult(e,t,i){const n=d.Pawns.model(e).select({hexes:t,traits:[a.PawnTraits.OccupiesTile]})[0];if(!n)return i;const s=this.model(e).pawns(n.type).mergeRules;return s&&s[i]}}t.Rules=c,c.modelFactory=new r.FactoryWithCache(e=>new s.RulesModel(e))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugTextBox=t.BitmapFont=t.UNICODE_MAP=t.GLYPH=t.Fonts=void 0;var n,s=Phaser.GameObjects.Layer,a=Phaser.GameObjects.BitmapText,r=Phaser.GameObjects.Rectangle;t.Fonts=class{preload(e){e.load.bitmapFont(n.Debug,"assets/fonts/debug.png","assets/fonts/debug.xml"),e.load.bitmapFont(n.Main,"assets/fonts/main.png","assets/fonts/main.xml")}},t.GLYPH={defense:"",might:"",pawn:"",kingdom:"",coin:"",hex:"",checkMark:"",crossMark:"",pawns:{milita:"",pikeman:"",knight:"",hero:""},whiteFlag:"",redFlag:"",blueFlag:"",blackFlag:"",greenFlag:"",source:"",movable:"",error:""},t.UNICODE_MAP={"⬡":t.GLYPH.hex,"⚐":t.GLYPH.whiteFlag,"🚩":t.GLYPH.redFlag,"⚑":t.GLYPH.blackFlag,"👤":t.GLYPH.pawn,"♖":t.GLYPH.kingdom,"✓":t.GLYPH.checkMark,"❌":t.GLYPH.crossMark,"💂‍":t.GLYPH.pawns.milita,"⛔":t.GLYPH.error},function(e){e.Debug="Debug",e.Main="Main"}(n=t.BitmapFont||(t.BitmapFont={}));const o={origin:[0,0],backgroundOpacity:.2,padding:2,textAlign:a.ALIGN_LEFT,dropShadow:!0};t.DebugTextBox=class extends s{constructor(e,t,i,s,d){super(e),this.opts=Object.assign(Object.assign({},o),d),e.add.existing(this),this.text=new a(e,t,i,n.Debug,s,void 0,this.opts.textAlign).setOrigin(...this.opts.origin),this.background=new r(e,t,i,0,0,0,.25),this.opts.dropShadow&&this.text.setDropShadow(1,1,0,1),this.opts.backgroundOpacity>0&&this.add(this.background),this.add(this.text),this.updateBackgroundSize()}setPosition(e,t){return this.text.setPosition(e,t),this.background.setPosition(this.text.x-this.text.width*this.text.originX-this.opts.padding,this.text.y-this.text.height*this.text.originY-this.opts.padding),this}setText(e){return this.text.setText(e.replace(/./g,e=>t.UNICODE_MAP[e]||e)),this.updateBackgroundSize(),this}updateBackgroundSize(){this.background.setPosition(this.text.x-this.text.width*this.text.originX-this.opts.padding,this.text.y-this.text.height*this.text.originY-this.opts.padding),this.background.setSize(this.text.width+2*this.opts.padding,this.text.height+2*this.opts.padding)}}},,function(e,t,i){"use strict";var n;function s(e,t){const i=e+"."+t,n=function(t){return{name:i,payload:t,category:e,isTypedEvent:!0}};return n.eventName=e+"."+t,n.category=e,n}Object.defineProperty(t,"__esModule",{value:!0}),t.createTypedReducer=t.isEvent=t.createEventFactory=t.gameplayAction=t.userAction=t.systemEvent=t.gameStateEvent=t.EventCategory=void 0,function(e){e.Play="PLAY",e.GameState="GAME_STATE",e.System="SYSTEM",e.UI="UI",e.MapEditor="UI_MAP_EDITOR",e.WorldMap="UI_WORLD_MAP",e.PlayUI="UI_PLAY_UI"}(n=t.EventCategory||(t.EventCategory={})),t.gameStateEvent=function(e){return s(n.GameState,e)},t.systemEvent=function(e){return s(n.System,e)},t.userAction=function(e){return s(n.UI,e)},t.gameplayAction=function(e){return s(n.Play,e)},t.createEventFactory=s,t.isEvent=function(e,t){return!!e.hasOwnProperty("isTypedEvent")&&(!t||e.name===t.eventName)},t.createTypedReducer=function(){const e=new Map;return{on(t,i){e.set(t,i)}}}},,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexDisplayDelegate=t.Hex=t.HEX_CORNER_NEIGHBOURS=t.HEX_CORNER_DIRECTIONS=t.HEX_DIRECTIONS=t.HexCornerDirection=t.HexDirection=void 0;const n=i(3),s=i(91),a=i(12),r=i(15);var o=Phaser.Math.PI2;!function(e){e[e.UP_LEFT=0]="UP_LEFT",e[e.UP_RIGHT=1]="UP_RIGHT",e[e.RIGHT=2]="RIGHT",e[e.DOWN_RIGHT=3]="DOWN_RIGHT",e[e.DOWN_LEFT=4]="DOWN_LEFT",e[e.LEFT=5]="LEFT"}(t.HexDirection||(t.HexDirection={})),function(e){e[e.UP_LEFT=0]="UP_LEFT",e[e.TOP=1]="TOP",e[e.UP_RIGHT=2]="UP_RIGHT",e[e.DOWN_RIGHT=3]="DOWN_RIGHT",e[e.DOWN=4]="DOWN",e[e.DOWN_LEFT=5]="DOWN_LEFT"}(t.HexCornerDirection||(t.HexCornerDirection={})),t.HEX_DIRECTIONS=[0,1,2,3,4,5],t.HEX_CORNER_DIRECTIONS=[0,1,2,3,4,5],t.HEX_CORNER_NEIGHBOURS=[[5,0],[0,1],[1,2],[2,3],[3,4],[4,5]];const d=[-o/3,-o/6,0,o/6,o/3,o/2],c=[[-.5,-1],[.5,-1],[1,0],[.5,1],[-.5,1],[-1,0]],h=[[-.5,-.25],[0,-.5],[.5,-.25],[.5,.25],[0,.5],[-.5,.25]];t.Hex=class{constructor(e){this.id=e}get tabular(){return void 0===this._tabular&&(this._tabular=s.ordinalToTabular(this.id)),this._tabular}get display(){return this._display||(this._display=new l(this)),this._display}get r(){return this.tabular.r}get c(){return this.tabular.c}get x(){return s.tabularToSpatial(this.tabular).x}get y(){return this.r}get length(){return 1}get members(){return[this]}isAtGridBorder(e){return n.HexGrid.isHexOnGridBorder(this,e)}neighbours(e=(e=>!0)){return a.HexGroup.from(c.map(e=>n.HexGrid.getHex({x:this.x+e[0],y:this.y+e[1]})).filter(t=>t&&e(t)))}neighboursByCorner(e){const[i,n]=t.HEX_CORNER_NEIGHBOURS[e];return[this.neighbour(i),this.neighbour(n)].filter(e=>e)}neighbour(e){const t=c[e];return n.HexGrid.getHex({x:this.x+t[0],y:this.y+t[1]})}getDirectionTowards(e){const t=e.x-this.x,i=e.y-this.y;return c.findIndex(([e,n])=>e===t&&n===i)}getAngleTowards(e){return d[this.getDirectionTowards(e)]}bfsFrom(e,t){t(e,void 0,0)}floodFillOut(e=(()=>!0)){return a.HexGroup.from([this]).floodFillOut(e)}findClosest(e,t){return a.HexGroup.from([this]).findClosest(e,t)}neighboursOf(e){return a.HexGroup.from([this]).neighboursOf(e)}toString(){return`[Hex #${this.id} (${this.x},${this.y})]`}asGroup(){return a.HexGroup.from([this])}toIdsArray(){return this.asGroup().toIdsArray()}toArray(){return this.asGroup().toArray()}has(e){return this.asGroup().has(e)}contains(e){return this.id===(null==e?void 0:e.id)}containsId(e){return this.id===e}border(e=!1){return this.asGroup().border(e)}boundingBox(){return{x:this.display.left,y:this.display.top,width:this.display.width,height:this.display.height}}components(e=(()=>!0)){return this.asGroup().components(e)}with(...e){return a.HexGroup.from([this,...e])}without(e){return this.asGroup().without(e)}filter(e){return this.asGroup().filter(e)}forEach(e){return this.asGroup().forEach(e)}map(e){return this.asGroup().map(e)}find(e){return this.asGroup().find(e)}sort(e){return this.asGroup().sort(e)}findInnerMostHex(){return this}findMax(e){return this}floodFillFrom(e,t){return a.HexGroup.from(e.members)}customSearchFrom(e,t,i){return a.HexGroup.from([this]).customSearchFrom(e,t,i)}findNeighbour(e){for(let t of c){const i=n.HexGrid.getHex({x:this.x+t[0],y:this.y+t[1]});if(i&&e(i))return i}}};class l{constructor(e){this.hex=e,this.width=r.HEX_WIDTH,this.height=r.HEX_HEIGHT}get left(){return this.hex.x*r.HEX_WIDTH}get right(){return(this.hex.x+1)*r.HEX_WIDTH}get top(){return this.hex.y*r.HEX_INNER_HEIGHT}get bottom(){return this.hex.y*r.HEX_INNER_HEIGHT+r.HEX_HEIGHT}get centerX(){return this.hex.x*r.HEX_WIDTH+r.HALF_HEX_WIDTH}get centerY(){return this.hex.y*r.HEX_INNER_HEIGHT+r.HALF_HEX_HEIGHT}getCornerPoint(e){return{x:this.centerX+h[e][0]*r.HEX_WIDTH,y:this.centerY+h[e][1]*r.HEX_HEIGHT}}}t.HexDisplayDelegate=l},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.describePhase=t.describeState=t.checkForInvalidReferences=t.GameStateModel=t.ProjectionPresets=void 0;const r=a(i(49)),o=i(1),d=i(16),c=i(9),h=i(0),l=i(179),u=i(182),g=i(21),p=i(109),f=i(184),m=i(6),y=i(32),w=i(10),v=i(4),b=i(185),x=i(11),S=i(20),P=i(28),M=i(23),H=i(94);o.logger.for("GameStateModel");t.ProjectionPresets={coreEntities:[...Object.values(c.GameState.regions),...Object.values(c.GameState.factions),...Object.values(c.GameState.pawns)],coreEntitiesAndSystems:[...Object.values(c.GameState.regions),...Object.values(c.GameState.factions),...Object.values(c.GameState.pawns),...Object.values(c.GameState.units),...Object.values(c.GameState.currentPhase)]};function T(e){}function E(e){return""+e.type&&e.faction?"/"+e.faction:""}t.GameStateModel=class{constructor(e){this.onNewState=d.signal(),this.stateEngine=new u.StateEngine,this.ai=new f.AIModel(this),this.loadDataSets(),e&&(v.isImmutableState(e)?this.stateEngine.currentState=v.setParentEngine(e,this.stateEngine):this.stateEngine.deserialize(p.decompressGameState(e)))}get grid(){return H.Grid.model(this.state)}get rules(){return y.Rules.model(this.state)}get regions(){return w.Regions.model(this.state)}get factions(){return S.Factions.model(this.state)}get pawns(){return x.Pawns.model(this.state)}get currentPhase(){return M.CurrentPhase.model(this.state)}get units(){return g.Units.model(this.state)}get economy(){return P.Economy.model(this.state)}get state(){return this.stateEngine.currentState}suspendAllProjections(){this.stateEngine.suspendAllProjections()}useProjections(e){return this.stateEngine.activateOnly(...e),this}activateAllProjections(){return this.stateEngine.activateAllProjections(),this}loadDataSets(){this.stateEngine.add(c.GameState.version,c.GameState.grid,c.GameState.ruleSet,...Object.values(c.GameState.regions),...Object.values(c.GameState.factions),...Object.values(c.GameState.pawns),...Object.values(c.GameState.units),...Object.values(c.GameState.currentPhase),...Object.values(c.GameState.warfare),...Object.values(c.GameState.economy),...Object.values(c.GameState.ai)),this.stateEngine.watchAll(()=>this.stateUpdated())}restore(e){return v.isImmutableState(e)?this.stateEngine.currentState=v.setParentEngine(e,this.stateEngine):this.stateEngine.deserialize(p.decompressGameState(e)),this.stateUpdated(),this}stateUpdated(){h.inject.config.debug.protectStateIntegrity&&this.protectStateIntegrity(),this.onNewState.fire(this.stateEngine.currentState)}protectStateIntegrity(){const e=b.getCanonicalStateSnapshot(this.state);this.stateEngine.deserialize(this.stateEngine.serialize());const t=b.getCanonicalStateSnapshot(this.state);if(!r.isEqual(e,t)){const i=l.diff(e,t),n=Object.keys(i);throw new Error(`GameState integrity violation! There's a difference in state after serialization and deserialization!\nDIFFERENCE:\n${JSON.stringify(i,null,2)}\nBEFORE:\n${JSON.stringify(m.filterDictionary(e,(e,t)=>n.includes(t)),null,2)}\nAFTER:\n${JSON.stringify(m.filterDictionary(t,(e,t)=>n.includes(t)),null,2)}\n`)}this.stateEngine.currentState}exportState(){return p.compressGameState(this.stateEngine)}withTemporaryBranch(e){const t=this.state;e(),this.restore(t)}},t.checkForInvalidReferences=T,t.describeState=function(e){return`[GameState (${e.grid.width}x${e.grid.height}⬡, ${e.factions.length}👤, ${e.regions.length}♖,${E(e.currentPhase)})]`},t.describePhase=E},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MultiMapMutationBuilder=t.MultiMapDataSet=void 0;const s=i(49),a=n(i(7)),r=i(4),o=i(2);t.MultiMapDataSet=class{constructor(e){this.key=e,this.defaultValue=a.default.Map()}deserialize(e){let t=a.default.Map();return Object.entries(e).forEach(([e,i])=>{t=t.set(Number(e),a.default.Set(i))}),t}serialize(e){return e.toJS()}apply(e,t){return e.withMutations(e=>{var i;null===(i=t.updated)||void 0===i||i.forEach(t=>{t.removed&&(e.updateIn([this.key,t.id],r.EMPTY_SET,e=>e.subtract(t.removed)),e.getIn([this.key,t.id]).isEmpty()&&e.deleteIn([this.key,t.id])),t.added&&e.updateIn([this.key,t.id],r.EMPTY_SET,e=>e.union(t.added))})})}createMutation(e,t){let i={},n=e.remove&&Object.entries(e.remove).filter(([e,t])=>t.size),a=e.add&&Object.entries(e.add).filter(([e,t])=>t.size);return(a&&!s.isEmpty(a)||n&&!s.isEmpty(n))&&(i.updated=[],null==a||a.forEach(([t,n])=>{var s;const a={id:Number(t),added:Array.from(n)};e.remove&&(null===(s=e.remove[t])||void 0===s?void 0:s.size)&&(a.removed=Array.from(e.remove[t])),i.updated.push(a)}),null==n||n.forEach(([t,n])=>{var s;const a=Number(t);e.add&&(null===(s=e.add[Number(a)])||void 0===s?void 0:s.size)||i.updated.push({id:Number(a),removed:Array.from(n)})})),{dataSet:this,changes:i,context:`${this.key}/${t}`}}getEntryById(e,t){return e.getIn([this.key,t])}getEntryIds(e){return e.get(this.key).keySeq().toArray()}entryToString(e){return e.map(e=>e.toString()).toArray().join(",")}entryToDebugString(e){return e.map(e=>e.toString()).toArray().join(",")}toString(){return`[MultiMapDataSet "${this.key}"]`}};t.MultiMapMutationBuilder=class{constructor(e,t){this.dataSet=e,this._itemsToAdd={},this._itemsToRemove={},t&&this.init(t)}init(e){this.state=e,this._itemsToAdd={},this._itemsToRemove={}}add(e,...t){return this._itemsToAdd[e]||(this._itemsToAdd[e]=new Set),t.forEach(t=>{var i;o.assert.defined(t),(null===(i=this._itemsToRemove[e])||void 0===i?void 0:i.has(t))?this._itemsToRemove[e].delete(t):this._itemsToAdd[e].add(t)}),this}has(e,t){var i,n;return!(null===(i=this._itemsToRemove[e])||void 0===i?void 0:i.has(t))&&!!(null===(n=this._itemsToAdd[e])||void 0===n?void 0:n.has(t))}getCurrent(e){let t=this.dataSet.getEntryById(this.state,e)||r.EMPTY_SET;return this._itemsToRemove[e]&&(t=t.subtract(this._itemsToRemove[e])),this._itemsToAdd[e]&&(t=t.union(this._itemsToAdd[e])),t}currentHas(e,t){var i,n,s;return!(null===(i=this._itemsToRemove[e])||void 0===i?void 0:i.has(t))&&(!!(null===(n=this._itemsToAdd[e])||void 0===n?void 0:n.has(t))||(null===(s=this.dataSet.getEntryById(this.state,e))||void 0===s?void 0:s.has(t)))}hasRemoved(e,t){var i;return!!(null===(i=this._itemsToRemove[e])||void 0===i?void 0:i.has(t))}remove(e,...t){this._itemsToRemove[e]||(this._itemsToRemove[e]=new Set),t.forEach(t=>{var i,n;o.assert.defined(t),(null===(i=this._itemsToAdd[e])||void 0===i?void 0:i.has(t))?this._itemsToAdd[e].delete(t):(null===(n=this.dataSet.getEntryById(this.state,e))||void 0===n?void 0:n.has(t))&&this._itemsToRemove[e].add(t)})}removeEntry(e){const t=this.dataSet.getEntryById(this.state,e);t&&t.size&&(delete this._itemsToAdd[e],this._itemsToRemove[e]=new Set(t.toArray()))}clear(){throw new Error("Not implemented")}createMutation(e){return this.dataSet.createMutation({add:this._itemsToAdd,remove:this._itemsToRemove},e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CustomHexGroupValuation=void 0;const n=i(6),s=i(14);class a{constructor(e){this.defaultValue=e,this.values={}}generateFrom(e,t){e.forEach(e=>{const i=t(e);void 0!==i&&i!==this.defaultValue&&this.set(e.id,t(e))})}generateFromIds(e,t){e.forEach(e=>{const i=t(e);void 0!==i&&i!==this.defaultValue&&this.set(e,t(e))})}set(e,t){this.values[e]=t}unset(e){delete this.values[e]}get(e){return this.values.hasOwnProperty(e)?this.values[e]:this.defaultValue}map(e){const t=new a(e(this.defaultValue,-1));return t.importDictionary(this.exportDictionary(e)),t}exportDictionary(e){return e?n.mapDictionary(this.values,e):this.values}toString(){return`[HexGroupValuation (default=${this.defaultValue})]`}dump(){return`{\n${Object.entries(this.values).map(([e,t])=>`${e}: ${s.str(t)}`).join("\n")}\n}`}getHexIds(){return Object.keys(this.values).map(e=>Number(e))}importDictionary(e){Object.keys(e).forEach(t=>this.values[t]=e[t])}clear(){this.values={}}static fromDictionary(e,t){const i=new a(t);return i.importDictionary(e),i}static fromGroupsCollection(e,t){const i=new a(t);return e.forEach((e,t)=>{e.forEach(e=>i.set(e.id,t))}),i}}t.CustomHexGroupValuation=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseMode=void 0;const n=i(1),s=i(29),a=i(0);n.logger.for("BaseMode");t.BaseMode=class{constructor(e){this.scene=e,this.name=this.constructor.name}isReadyForMoreGameEvents(){return!0}canPickupPawn(e){return!1}canDropPawn(e){return!1}canSelectHex(e){return!1}canReturnPawn(){return!1}handlePickupPawn(e){throw Error("pickUpPawn not available in "+this.name)}handleReturnPawn(){throw Error("returnPawn not available in "+this.name)}handleSelectHex(e){throw Error("selectHex not available in "+this.name)}handleDropPawn(e){throw Error("dropPawn not available in "+this.name)}handlePickupPawnFromShop(e){a.inject.audio.playEffect(s.SoundEffects.Deny)}handleDropPawnOnShop(e,t){return a.inject.audio.playEffect(s.SoundEffects.Deny),!1}shouldHighlightHoveredHex(e){return!1}activate(){}deactivate(){}handleHexCaptured(e){}handleNewHexUnderCursor(e){}handleEndTurn(){}}},,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AI=void 0;const n=i(9),s=i(4);t.AI=class{static getHostileBorderHexesByRegion(e,t){return s.selectFromState(e,n.GameState.ai.hostileBorderHexes,t)||s.EMPTY_SET}static getHexDepth(e,t){return s.selectFromState(e,n.GameState.ai.hexDepth,t)}static getHexImportance(e,t){return s.selectFromState(e,n.GameState.ai.hexImportance,t)}static getHexVulnerability(e,t){return s.selectFromState(e,n.GameState.ai.hexVulnerability,t)}static getRegionMight(e,t){return s.selectFromState(e,n.GameState.ai.mightByRegion,t)}}},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.BestPlanPicker=t.describePlan=t.UnitsByMight=t.UnitSolver=void 0;const r=i(6),o=i(17),d=i(5),c=i(23),h=i(28),l=i(2),u=i(21),g=a(i(7)),p=i(100),f=i(1);f.logger.for("ai:UnitSolver");t.UnitSolver=class{constructor(e,t=p.UNRESTRICTED_ARMY_COMPOSITION){this.rules=e,this.armyComposition=t}gather(e){if(e.requiredMight>4)return;void 0===e.allowOverkill&&(e.allowOverkill=!0);const t=new w,i=e.remainingUnits.getOneWithMightAtLeast(e.requiredMight);if(i===e.requiredMight)return this._useExisting(e,i);if(t.consider(this._useExisting(e,i)),t.consider(this._buy(e)),e.requiredMight>1){let i=this.gather(Object.assign(Object.assign({},e),{requiredMight:e.requiredMight-1,allowOverkill:!1,willSacrifice:!0}));if(!i)return;let n=this.gather(Object.assign(Object.assign({},i),{requiredMight:e.requiredMight-1,allowOverkill:!1,willSacrifice:!0}));if(!n)return;const s=[...i.useUnits,...n.useUnits].sort(r.ascendingSortFn),a=n.remainingIncome+2*this.rules.unitByMight(e.requiredMight-1).upkeep-this.rules.unitByMight(e.requiredMight).upkeep;a>=0&&t.consider(Object.assign(Object.assign({},n),{useUnits:s,buyUnits:[...i.buyUnits,...n.buyUnits].sort(r.ascendingSortFn),might:e.requiredMight,remainingIncome:a,attractiveness:i.attractiveness+n.attractiveness+(e.willSacrifice?0:this.armyComposition.getWillingnessToObtainUnit(e,e.requiredMight))}))}const n=t.getBestPlan();return!n||void 0!==e.minAttractiveness&&n.attractiveness<e.minAttractiveness?void 0:n}_useExisting(e,t){if(void 0===t)return;if(!e.allowOverkill&&t!==e.requiredMight)return;const i=(e.requiredMight-t)/4+(e.willSacrifice?this.armyComposition.getWillingnessToDiscardUnit(e,t):0);return{useUnits:[t],buyUnits:[],totalUnits:e.willSacrifice?e.totalUnits.withoutUnit(t):e.totalUnits,remainingUnits:e.remainingUnits.withoutUnit(t),remainingGold:e.remainingGold,remainingIncome:e.remainingIncome,might:t,attractiveness:i}}_buy(e){const t=this.rules.unitByMight(e.requiredMight),i=e.remainingGold-t.cost,n=e.remainingIncome-t.upkeep;if(!(i<0||n<0))return{useUnits:[],buyUnits:[e.requiredMight],totalUnits:e.willSacrifice?e.totalUnits:e.totalUnits.add(e.requiredMight),remainingUnits:e.remainingUnits,remainingGold:i,remainingIncome:n,might:e.requiredMight,attractiveness:(e.willSacrifice?0:this.armyComposition.getWillingnessToObtainUnit(e,e.requiredMight))+this.armyComposition.getWillingnessToSpend(e,t.cost)}}estimateBuyableMight(e){return Math.max(0,Math.min(Math.floor(e.remainingGold/10),Math.floor(e.remainingIncome/2)))}estimateTotalMight(e){return e.remainingUnits.getTotalMight()+this.estimateBuyableMight(e)}getUnitsInRegion(e,t=!1){var i;return e.faction&&(null===(i=e.faction)||void 0===i?void 0:i.controller)!==d.FactionController.None&&e.isAlive()?y.fromUnitList(u.Units.model(e.state).byRegion(e).filter(i=>!t||c.CurrentPhase.isMovable(e.state,i.id)).map(e=>e.might).sort(r.ascendingSortFn)):new y}getRegionState(e,t=0){let i=this.getUnitsInRegion(e),n=this.getUnitsInRegion(e,!0);const s=Math.ceil(n.getTotalMight()*t);return n=n.add(1,s),i=i.add(1,s),{totalUnits:i,remainingUnits:n,remainingGold:h.Economy.getTreasuryOf(e.state,e.id),remainingIncome:h.Economy.getRegionBudget(e.state,e.id).balance}}estimateTopAvailableMight({remainingIncome:e,remainingGold:t,remainingUnits:i,totalUnits:n}){let s=i.getStrongest();if(4===s)return 4;let a=void 0;do{a=this.gather({remainingIncome:e,remainingGold:t,remainingUnits:i,totalUnits:n,requiredMight:s+1}),a&&++s}while(a&&s<4);return s||0}getObtainableUnits(e,t=-1){return[1,2,3,4].filter(i=>{var n,s;return!!e.remainingUnits.has(i)||(null!==(s=null===(n=this.gather(Object.assign(Object.assign({},e),{requiredMight:i,allowOverkill:!1})))||void 0===n?void 0:n.attractiveness)&&void 0!==s?s:-1/0)>=t})}};const m=g.Map();class y{constructor(e=m){this.data=e}getOneWithMightAtLeast(e){for(let t=e;t<=4;++t)if(this.data.get(t))return t}has(e){return!!this.data.get(e)}withoutUnit(e){const t=this.data.get(e,0);return l.assert(t>0,`cannot take unit with might ${e} from ${this.toString()}`),new y(t-1>0?this.data.update(e,e=>e-1):this.data.delete(e))}hasUnitsWeakerThan(e){for(let t=1;t<e;++t)if(this.data.get(t))return!0;return!1}getTotalMight(){return this.data.map((e,t)=>t*e).reduce(o.sum,0)}static fromUnitList(e){return new y(g.Map().withMutations(t=>{e.forEach(e=>t.set(e,t.get(e,0)+1))}))}toString(){let e="[";for(let t=1;t<4;++t)e+=t.toString().repeat(this.data.get(t,0));return e+="]",e}add(e,t=1){return new y(this.data.set(e,this.data.get(e,0)+t))}getStrongest(){for(let e=4;e>0;--e)if(this.data.get(e))return e;return 0}getAvailableMightLevels(){return Array.from(this.data.keys())}map(e){return this.data.map(e)}countOf(e){return this.data.get(e,0)}without(...e){return new y(this.data.withMutations(t=>{e.forEach(i=>{const n=t.get(i,0);if(n<1)throw new Error(`cannot take units ${e} from ${this.toString()}`);1===n?t.remove(i):t.set(i,n-1)})}))}with(...e){return new y(this.data.withMutations(t=>{e.forEach(e=>{const i=t.get(e,0);t.set(e,i+1)})}))}}t.UnitsByMight=y,y.empty=new y,t.describePlan=function(e){let t="";return e.useUnits.length&&(t+=`use ${e.useUnits.join(",")}${e.buyUnits.length?" and ":""}`),e.buyUnits.length&&(t+="buy "+e.buyUnits.join(",")),t+` to obtain ${e.might} (attr ${e.attractiveness})`};class w{consider(e){e&&(!this.bestPlanSoFar||this.bestPlanSoFar.attractiveness<e.attractiveness)&&(this.bestPlanSoFar=e)}getBestPlan(){return this.bestPlanSoFar}}t.BestPlanPicker=w},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayUIScene=t.MyLayer=t.PlayUILayers=t.PLAY_UI_LAYOUT=t.PlayUIActions=t.playUiEvent=void 0;const n=i(55),s=i(27),a=i(0),r=i(1),o=i(35),d=i(237),c=i(238),h=i(121),l=i(8),u=i(73),g=i(239),p=i(2),f=i(29),m=i(122),y=i(241);function w(e){return o.createEventFactory(o.EventCategory.PlayUI,e)}t.playUiEvent=w,t.PlayUIActions={ShopPawnPointerDown:w("SHOP_PAWN_POINTER_DOWN"),ShopPawnPointerUp:w("SHOP_PAWN_POINTER_UP"),StoreDeskPointerDown:w("STORE_DESK_POINTER_DOWN"),StoreDeskPointerUp:w("STORE_DESK_POINTER_UP")},t.PLAY_UI_LAYOUT={desktop:{deskWidth:636,offsetFromBottom:54,regionLabelOffsetFromBottom:84,shoppingDeskOffsetFromBottom:110},compact:{labelOffsetFromSides:68,labelHeight:50,shoppingDeskOffsetFromBottom:90},toggleBoardTweenDuration:300},function(e){e[e.Desk=0]="Desk",e[e.TableCloth=1]="TableCloth",e[e.Shadows=2]="Shadows",e[e.Pawns=3]="Pawns",e[e.Label=4]="Label",e[e.Buttons=5]="Buttons"}(t.PlayUILayers||(t.PlayUILayers={}));const v=r.logger.for("PlayUIScene");class b extends Phaser.GameObjects.Layer{}t.MyLayer=b;class x extends n.BaseScene{constructor(){super({key:s.Scenes.PlayUI}),this.state={undoEnabled:!0,selectedRegion:null,buyingPawn:null,factionColor:0,visible:!1},this.alreadyShaking=!1}create(){this.turnControls=new y.AdaptiveGameObject(this,{commonInitializer:this.wireUpTurnControls.bind(this)}).addVariant(u.ScreenSize.Large,()=>new h.DesktopTurnControls(this)).addVariant(u.ScreenSize.Small,()=>new h.CompactTurnControls(this)),this.regionLabel=new y.AdaptiveGameObject(this).addVariant(u.ScreenSize.Large,()=>new g.DesktopRegionLabel(this)).addVariant(u.ScreenSize.Small,()=>new g.CompactRegionLabel(this)),this.pawnHolder=new d.PawnHolder(this),this.shoppingDesk=new c.ShoppingDesk(this),this.setControlsBasedOnScreenSize(a.inject.device.screenSize.get()),this.add.existing(this.shoppingDesk),this.add.existing(this.turnControls),this.add.existing(this.regionLabel),this.regionLabel.setDepth(1),this.watchWhileActive(a.inject.worldUi.selectedRegion,()=>this.refreshRegionPanel()),this.watchWhileActive(a.inject.worldUi.undoAvailable,e=>this.updateState({undoEnabled:e})),this.watchWhileActive(a.inject.device.screenSize,this.setControlsBasedOnScreenSize.bind(this));const e=new m.Button(this,10,10,{frame:"ui/btn-new"},()=>{window.confirm("Start new game?")&&window.game.new()}),t=new m.Button(this,100,10,{frame:"ui/btn-restart"},()=>{window.confirm("Restart game?")&&window.game.load("restart")});this.add.existing(e),this.add.existing(t)}wireUpTurnControls(e){e.onUndoClicked(()=>{a.inject.gameStateController.undo()}),e.onTurnClicked(()=>{a.inject.events.trigger(l.UserActions.EndTurn())})}updateState(e){if(this.state=Object.assign(Object.assign({},this.state),e),void 0!==e.undoEnabled&&this.turnControls.current().setUndoEnabled(e.undoEnabled),void 0!==e.selectedRegion){null===e.selectedRegion?(this.regionLabel.current().hide(),this.shoppingDesk.hide()):(this.regionLabel.current().setRegionInfo(this.state.selectedRegion),this.regionLabel.current().show(),this.shoppingDesk.setDisplayedPawns(e.selectedRegion.buyablePawns),this.shoppingDesk.show())}void 0!==e.buyingPawn&&this.regionLabel.current().setBuyingPawnInfo(e.buyingPawn),void 0!==e.factionColor&&this.shoppingDesk.setColor(e.factionColor),e.visible?(this.turnControls.current().show(),this.state.selectedRegion&&(this.shoppingDesk.show(),this.regionLabel.current().show())):!1===e.visible&&(this.shoppingDesk.hide(),this.turnControls.current().hide(),this.regionLabel.current().hide())}setControlsBasedOnScreenSize(e){v.info(`Updating controls to fit screen size "${e}"`),this.turnControls.setVariant(e);const t=this.turnControls.current();t.setUndoEnabled(this.state.undoEnabled),t.targetVisibility=this.state.visible,t.reflow(),this.regionLabel.setVariant(e);const i=this.regionLabel.current();i.targetVisibility=this.state.visible&&!!this.state.selectedRegion,i.setBuyingPawnInfo(this.state.buyingPawn),this.state.selectedRegion&&i.setRegionInfo(this.state.selectedRegion),i.reflow(),this.shoppingDesk.reflow()}setFactionColor(e){this.updateState({factionColor:e})}show(){this.updateState({visible:!0})}hide(){this.updateState({visible:!1})}update(){this.pawnHolder.update()}refreshRegionPanel(){var e,t;const i=a.inject.worldUi.selectedRegion(),n=a.inject.gameStateModel;if(i){const s=n.economy.treasuryOf(i),a=n.rules.getAllPawnTypes().filter(e=>e.cost>0&&e.cost<=s).map(e=>e.type);this.updateState({selectedRegion:{name:i.name,income:(null===(e=i.budget)||void 0===e?void 0:e.balance)||0,treasury:s,buyablePawns:a},factionColor:(null===(t=i.faction)||void 0===t?void 0:t.landColor)||0})}else this.updateState({selectedRegion:null})}grabPawnFromShop(e){const t=this.shoppingDesk.getPawnSpriteByType(e);p.assert(t),this.pawnHolder.pickUpPawn(e,this.shoppingDesk.x+t.x,this.shoppingDesk.y+t.y,1);const i=a.inject.gameStateModel.rules.pawns(e);this.updateState({buyingPawn:{name:e.toString(),cost:i.cost,upkeep:i.upkeep}}),t.setAlpha(.1),a.inject.audio.playEffect(f.SoundEffects.Grab)}returnPawnToShop(e,t){const i=this.shoppingDesk.getPawnSpriteByType(e);p.assert(i),this.pawnHolder.dropPawn(this.shoppingDesk.x+i.x,this.shoppingDesk.y+i.y,1,()=>{i.setAlpha(1),t()}),this.updateState({buyingPawn:null})}restockPawnInShop(e,t=!1){const i=this.shoppingDesk.getPawnSpriteByType(e);t?i.setAlpha(1):this.tweens.add({targets:i,alpha:1,duration:300}),this.updateState({buyingPawn:null})}shakeRegionControls(){this.alreadyShaking||(this.alreadyShaking=!0,this.tweens.add({targets:[this.shoppingDesk,this.regionLabel.current()],y:e=>e.y-10,tween:"Sine.easeInOut",duration:100,yoyo:!0,onComplete:()=>{this.alreadyShaking=!1}}))}}t.PlayUIScene=x},,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.filterPawns=t.PawnModel=void 0;const n=i(65),s=i(11),a=i(32),r=i(10),o=i(20),d=i(23),c=i(3);class h extends n.BaseEntityModel{get exists(){return!!s.Pawns.getPawnData(this.state,this.id)}get name(){var e;return(null===(e=s.Pawns.getPawnData(this.state,this.id))||void 0===e?void 0:e.name)||""}get type(){return s.Pawns.getPawnData(this.state,this.id).type}get count(){return s.Pawns.getPawnCount(this.state,this.id)||0}get traits(){var e;return null===(e=this.rules)||void 0===e?void 0:e.traits}get cost(){var e;return null===(e=this.rules)||void 0===e?void 0:e.cost}get upkeep(){var e;return null===(e=this.rules)||void 0===e?void 0:e.upkeep}get might(){return this.rules.might}get defense(){return this.rules.defense}get rules(){return a.Rules.model(this.state).pawns(this.type)}get region(){return r.Regions.model(this.state).byHex(this.hex)}get faction(){return o.Factions.model(this.state).byHex(this.hex)}hasTrait(e){return this.traits.includes(e)}get hex(){return c.getHex(s.Pawns.getPawnHex(this.state,this.id))}replaceWith(e){const t=this.hex;return this.state=s.Pawns.replacePawn(this.state,this.id,e),this.parentModel.byHex(t,e)}isMovable(){return d.CurrentPhase.isMovable(this.state,this.id)}moveTo(e){return this.state=s.Pawns.movePawn(this.state,this.id,e.id),this}setCount(e){return this.state=s.Pawns.setPawnCount(this.state,this.id,e),this}toString(){const e=this.type+(void 0!==this.count&&1!==this.count?"×"+this.count:"");return`[Pawn #${this.id} (${e} at ${this.hex})]`}destroy(){this.parentModel.destroy(this)}}t.PawnModel=h,t.filterPawns=function(e,t,i){return i.type&&(t=t.filter(e=>i.type.includes(e.type))),i.traits&&(t=t.filter(e=>i.traits.every(t=>e.hasTrait(t)))),t}},,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapScene=t.WorldMapEvents=t.WorldDragMode=t.PointerEventFlags=t.worldMapAction=void 0;const n=i(1),s=i(27),a=i(38),r=i(0),o=i(197),d=i(198),c=i(202),h=i(205),l=i(210),u=i(12),g=i(35),p=i(215),f=i(55),m=i(220),y=i(72),w=i(221),v=i(222),b=i(223),x=i(5),S=i(87),P=i(19),M=i(224);n.logger.for("ui:WorldMapScene");function H(e){return g.createEventFactory(g.EventCategory.WorldMap,e)}var T;t.worldMapAction=H,function(e){e[e.AltClick=1]="AltClick"}(T=t.PointerEventFlags||(t.PointerEventFlags={})),function(e){e.None="none",e.Pawn="pawn",e.Camera="camera"}(t.WorldDragMode||(t.WorldDragMode={})),t.WorldMapEvents={PointerDown:H("POINTER_DOWN"),PointerUp:H("POINTER_UP")};class E extends f.BaseScene{constructor(){super({key:s.Scenes.WorldMap}),this.cinematics={worldCreation:new w.WorldCreationCinematic(this),coinTransaction:e=>this.coins.cinematics.transactions(e),tileDefense:(e,t)=>new b.TileDefenseCinematic(this.pawns,e,t)}}create(){super.create(),this.cameraController=new d.WorldMapCameraController(this.cameras.main),this.debugOverlay=new o.WorldMapDebugOverlay(this),this.cameras.main.setBackgroundColor("#9bd6f2"),this.debugOverlay.create(),this.chunkedRenderer=new M.ChunkedRenderer(this,5),this.chunksRenderingController=new M.ChunksRenderingController(this,this.chunkedRenderer),this.tiles=new c.TilesManager(this,this.chunkedRenderer),this.coins=new h.CoinsManager(this,this.tiles),this.tileBorders=new y.TileBordersManager(this,this.chunkedRenderer),this.pawns=new l.PawnsManager(this,this.tiles),this.selectedRegionHighlight=new p.SelectedRegionHighlight(this),this.conquerableHexesHighlight=new m.ConquerableHexesHighlight(this),this.hexMarkers=new v.HexDefenseMarkers(this),this.input.on("pointerdown",this.onPointerDown,this),this.input.on("pointerup",this.onPointerUp,this),this.input.on("pointermove",this.onPointerMove,this),this.scale.on("resize",this.handleResize,this),this.watchWhileActive(r.inject.worldUi.selectedRegion,this.setSelectedRegion),r.inject.config.watch(this.applyConfig.bind(this)),this.handleSignalWhileActive(r.inject.debugLayers.onActiveLayerUpdated,e=>{r.inject.config.debug.overlay&&this.debugOverlay.showDebugLayer(e)}),this.anims.create({key:"spin-coin",frames:this.anims.generateFrameNumbers("coin",{frames:[0,1,2,3,4,5,0]}),frameRate:30,repeat:-1})}applyConfig(e){super.applyConfig(e),this.debugOverlay.setVisible(!!e.debug.overlay)}onPointerDown(e){r.inject.events.trigger(t.WorldMapEvents.PointerDown(this.buildPointerEventContext(e)))}onPointerUp(e){r.inject.events.trigger(t.WorldMapEvents.PointerUp(this.buildPointerEventContext(e)))}onPointerMove(){this.game.device.input.touch||r.inject.worldUi.hexUnderCursor.update(this)}loadNewGameState(e){r.inject.uiState.with({transitionsMode:P.TransitionsMode.Disabled},()=>{this.destroyWorld(),this.cameraController.updateBounds(),this.debugOverlay.redrawWorldBoundsRectangle(this.cameraController.worldBounds),this.debugOverlay.update(),this.createNewWorld(e)})}update(e,t){this.pawns.update(),this.chunksRenderingController.update();const i=this.cameras.main;r.inject.config.debug.overlay&&(r.inject.debugData.set("worldCamera view",`${i.worldView.x},${i.worldView.y} -> ${Math.round(i.worldView.right)},${Math.round(i.worldView.bottom)}`),r.inject.debugData.set("worldCamera scroll",`${Math.round(i.scrollX)}, ${Math.round(i.scrollY)} zoom(${Math.round(10*i.zoom)/10})`),r.inject.debugData.set("worldTweens",""+this.tweens.getAllTweens().length))}setSelectedRegion(e){this.selectedRegionHighlight&&(e?this.selectedRegionHighlight.set(e):this.selectedRegionHighlight.unset())}createNewWorld(e){const t=new a.GameStateModel;t.restore(e);const{pawns:i,regions:n,factions:s}=t;this.tiles.bakeTileTextures(s.all().map(e=>e.landColor||0));const r=u.HexGroup.union(n.all().map(e=>e.hexes));r.forEach(e=>{const t=s.byHex(e);this.tiles.addTile(e,(null==t?void 0:t.id)||0),i.byHex(e).forEach(t=>{t.type===x.PawnType.Coins?this.coins.spawnOnHex(e,t.count):t.type===x.PawnType.Palisade||t.type===x.PawnType.StoneWall||this.pawns.add(e.id,t.type)})}),this.debugOverlay.redrawChunkRectangles(this.chunkedRenderer.getAllChunks()),this.tileBorders.initializeFromModel(t,r)}destroyWorld(){this.tiles.destroyTiles(),this.tileBorders.clear(),this.pawns.destroyAll(),this.coins.destroyCoins()}updateTileColor(){}destroy(e){}showHexHighlights(){this.selectedRegionHighlight.show(),this.conquerableHexesHighlight.show()}hideHexHighlights(){this.selectedRegionHighlight.hide(),this.conquerableHexesHighlight.hide()}getPawnObjectPositionOnScreen(e){return this.pawns.getPawnObjectPositionOnScreen(this.cameras.main,e)}handleResize(){this.cameraController.updateBounds()}showHexDefenseMarkers(e){const t=r.inject.worldUi.selectedRegion();if(t){const i=v.deriveDefenseMarkerDataFromModel(t,e);this.hexMarkers.set(i)}}hideHexDefenseMarkers(){this.hexMarkers.clear()}animateDefense(e,t){}buildPointerEventContext(e){const t=S.getHexUnderCursor(this,r.inject.gameStateModel);let i=0;return e.middleButtonDown()&&(i|=T.AltClick),{hexId:null==t?void 0:t.id,flags:i}}}t.WorldMapScene=E},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createStaggeredDelay2Dfn=void 0;const n=i(70),s=i(0);t.createStaggeredDelay2Dfn=function(e,t=0,i=1e3,a=0){const r=n.getBoundingBox(e),o=r.width+r.height,d=i-t;return e=>t+(e.x-r.x+(e.y-r.y))/o*d+s.inject.random.integer(0,a)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TIMING=void 0,t.TIMING={pawnPickupTransition:100,pawnDropTransition:100,pawnJumpDuration:500,pawnTravelDuration:200}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseScene=void 0;const n=i(0),s=i(1);class a extends Phaser.Scene{constructor(e){super(e),this._deferredHandlers=new Map,this._subs=[],this._subScenes=e.subScenes||[],this.log=s.logger.for(e.key||"BaseScene"),n.inject.config.watchFuture(e=>this.applyConfig(e))}create(){this.runSubScenes(),this.events.on(Phaser.Scenes.Events.WAKE,()=>{this.runSubScenes(),this.triggerDeferredHandlers()}),this.events.on(Phaser.Scenes.Events.SLEEP,()=>{this._subScenes.forEach(e=>this.scene.sleep(e))}),this.events.on(Phaser.Scenes.Events.SHUTDOWN,()=>{this._subScenes.forEach(e=>this.scene.sleep(e))})}destroy(){this._subs.forEach(e=>e.unsubscribe())}applyConfig(e){this.tweens.timeScale=e.debug.tweenSpeedFactor||1,this.time.timeScale=e.debug.tweenSpeedFactor||1,this.anims.globalTimeScale=e.debug.tweenSpeedFactor||1}runSubScenes(){this._subScenes.forEach(e=>this.scene.run(e))}triggerDeferredHandlers(){this._deferredHandlers.forEach(e=>e()),this._deferredHandlers.clear()}handleEventWhileActive(e,t){this._subs.push(n.inject.events.on(e,(e,i)=>{this.scene.isActive()&&t.apply(this,[e,i])}))}handleSignalWhileActive(e,t){this._subs.push(e((...e)=>{this.scene.isActive()&&t.apply(this,e)}))}watchWhileActive(e,t){this._subs.push(e.watch((i,n)=>{this.scene.isActive()||this._deferredHandlers.set(e,()=>t.apply(this,[i,n])),t.apply(this,[i,n])}))}}t.BaseScene=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayMode=void 0;const n=i(0),s=i(123),a=i(41),r=i(243),o=i(29),d=i(8),c=i(5),h=i(2),l=i(1),u=i(13),g=l.logger.for("ui:PlayMode");class p extends a.BaseMode{constructor(){super(...arguments),this.autoAttackUnit=void 0}activate(){this.scene.uiScene.show(),this.scene.showConquerableHexesBasedOnSelectedRegion()}canPickupPawn(e){return!!this.getMovablePawnAtHex(e)}canSelectHex(e){return!0}handlePickupPawn(e){const t=this.getMovablePawnAtHex(e);if(!t)throw Error(`Unable to pickup pawn at ${e}.`);n.inject.audio.playEffect(o.SoundEffects.Grab),this.scene.setMode(new s.MovingPawnMode(this.scene,t))}handleSelectHex(e){var t;const i=n.inject.gameStateModel,s=i.regions.byHex(e);s===n.inject.worldUi.selectedRegion()?i.pawns.byHex(e,c.PawnType.Town)&&this.scene.uiScene.shakeRegionControls():this.scene.isRegionControllable(s)?this.scene.selectRegion(s):((null===(t=this.scene.conquerableHexes)||void 0===t?void 0:t.contains(e))?(this.findAutoAttacker(e),this.autoAttackUnit?(n.inject.audio.playEffect(o.SoundEffects.Drop),n.inject.gameStateController.executePlay(d.Plays.AttackHex({pawnId:this.autoAttackUnit.id,destinationHexId:e.id}))):g.warning(`hex ${e} highlighted as conquerable but could not find any suitable attacker unit`)):n.inject.worldUi.selectedRegion.set(void 0),this.scene.showConquerableHexesBasedOnSelectedRegion())}handleHexCaptured(e){var t,i;if(e.capturingPawnId===(null===(t=this.autoAttackUnit)||void 0===t?void 0:t.id))return e.sourceHexId&&(this.scene.worldMapScene.pawns.move(e.sourceHexId,e.capturedHexId),this.scene.worldMapScene.pawns.stopJumping([e.capturedHexId])),e.coinTransactions&&this.scene.worldMapScene.coins.applyTransactions(e.coinTransactions),this.clearAutoAttacker();g.warning(`Ignoring unexpected hexCaptured event during PlayMode (expected capturingPawnId to be ${null===(i=this.autoAttackUnit)||void 0===i?void 0:i.id}, but was ${e.capturingPawnId}`)}handlePickupPawnFromShop(e){this.scene.uiScene.grabPawnFromShop(e),this.scene.setMode(new r.BuyingPawnMode(this.scene,e))}getMovablePawnAtHex(e){return n.inject.gameStateModel.pawns.byHex(e).find(e=>n.inject.gameStateModel.currentPhase.isMovable(e))}handleNewHexUnderCursor(e){var t;const i=n.inject.worldUi.selectedRegion();e&&this.getMovablePawnAtHex(e)?(this.scene.worldMapScene.pawns.setHangingPawn(e.id),this.scene.input.setDefaultCursor("pointer"),this.clearAutoAttacker()):i&&e&&(null===(t=this.scene.conquerableHexes)||void 0===t?void 0:t.contains(e))?this.findAutoAttacker(e):(this.clearAutoAttacker(),this.scene.input.setDefaultCursor("default"))}findAutoAttacker(e){const t=n.inject.worldUi.selectedRegion(),i=n.inject.gameStateModel,s=i.units.getHexDefense(e)+1;h.assert.defined(t);const a=t.might.remainingUnits.getOneWithMightAtLeast(s);if(!a)return g.warning(`incorrectly thought I could conquer hex ${e} - is among conquerable hexes but i cannot gather ${s}  might from ${t}`),this.clearAutoAttacker();const r=i.pawns.findClosest(e,t.hexes,e=>e.hasTrait(u.PawnTraits.Unit)&&e.isMovable()&&e.might===a);return r?(this.scene.worldMapScene.conquerableHexesHighlight.setHighlightedHex(e),this.setAutoAttacker(r,e)):(g.warning(`failed to locate unit with might ${a} in the region => RegionMight projection appears to contain invalid data! `),this.clearAutoAttacker())}setAutoAttacker(e,t){this.autoAttackUnit=e,this.scene.worldMapScene.pawns.setHangingPawn(e.hex.id,t.id)}clearAutoAttacker(){this.scene.worldMapScene.pawns.clearHangingPawn(),this.scene.worldMapScene.conquerableHexesHighlight.clearHighlightedHex()}handleEndTurn(){n.inject.gameStateController.executePlay(d.Plays.EndTurn())}}t.PlayMode=p},,,,,function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.deepWatchable=t.watchable=void 0;const s=n(i(146)),a=i(6);t.watchable=function(e){let t=e,i=void 0,n=[];function s(){return t}return s.get=()=>t,s.set=e=>{t!==e&&(t=e,n.forEach(e=>e(t,i)),i=t)},s.watch=e=>{const i=s.watchFuture(e);return setTimeout(()=>e(t,void 0),0),i},s.watchFuture=e=>(n.push(e),{unsubscribe:()=>a.removeFromArrayInPlace(n,e)}),s},t.deepWatchable=function(e){let t=s.default(e,a),i=e,n=[];function a(){n.forEach(e=>e(t,i)),i=t}function r(){return t}return r.watch=function(e){n.push(e),e(t,void 0)},r.watchFuture=function(e){n.push(e)},new Proxy(r,{get:(e,i,n)=>r.hasOwnProperty(i)?r[i]:t[i]})}},,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ruleSets=void 0;const n=i(13),s=i(5);t.ruleSets={default:{id:"default",economy:{baseIncomePerTile:1,baseIncomePerRegion:0},pawns:{[s.PawnType.Palisade]:{defense:1,cost:5,upkeep:0,traits:[n.PawnTraits.Wall,n.PawnTraits.EnablesRetreat],merge:{[s.PawnType.StoneWall]:s.PawnType.StoneWall}},[s.PawnType.StoneWall]:{defense:2,cost:10,upkeep:0,traits:[n.PawnTraits.Wall,n.PawnTraits.EnablesRetreat]},[s.PawnType.Militia]:{might:1,defense:1,cost:10,upkeep:2,traits:[n.PawnTraits.Unit,n.PawnTraits.GuardsAdjacentTiles,n.PawnTraits.OccupiesTile],merge:{[s.PawnType.Militia]:s.PawnType.Pikeman}},[s.PawnType.Pikeman]:{might:2,defense:2,cost:20,upkeep:6,traits:[n.PawnTraits.Unit,n.PawnTraits.GuardsAdjacentTiles,n.PawnTraits.OccupiesTile],merge:{[s.PawnType.Pikeman]:s.PawnType.Knight}},[s.PawnType.Knight]:{might:3,defense:3,cost:40,upkeep:18,traits:[n.PawnTraits.Unit,n.PawnTraits.GuardsAdjacentTiles,n.PawnTraits.OccupiesTile],merge:{[s.PawnType.Knight]:s.PawnType.Hero}},[s.PawnType.Hero]:{might:4,defense:3,cost:80,upkeep:54,traits:[n.PawnTraits.Unit,n.PawnTraits.GuardsAdjacentTiles,n.PawnTraits.OccupiesTile],merge:{}},[s.PawnType.Town]:{traits:[n.PawnTraits.OccupiesTile]},[s.PawnType.Bandit]:{might:0,defense:0,upkeep:0,traits:[n.PawnTraits.OccupiesTile,n.PawnTraits.NegatesTileIncome,n.PawnTraits.Pest]}}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseEntityModel=void 0;const n=i(31),s=i(2);class a extends n.BaseModel{constructor(e,t){super(),this.parentModel=e,s.assert.defined(t),this.id=t}updateFrom(e){return this.parentModel.state=e,this}}t.BaseEntityModel=a},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexVulnerabilityUpdater=t.ThreatGeneratorsHeap=t.HexVulnerabilityProjection=t.NO_VULNERABILITY=t.DEFAULT_PARANOIA_FACTOR=void 0;const s=i(18),a=n(i(7)),r=i(38),o=i(45),d=i(14),c=n(i(43)),h=i(13),l=i(101),u=i(10),g=i(4),p=i(22),f=i(2),m=i(1),y=i(44),w=i(23),v=i(20),b=i(12),x=i(0),S=i(33),P=i(3);m.logger.for("HexVulnerabilityProjection");t.DEFAULT_PARANOIA_FACTOR=.2,t.NO_VULNERABILITY={depth:0,state:void 0,remainingGold:0,remainingMightTotal:0,remainingIncome:0,totalUnits:o.UnitsByMight.empty,remainingUnits:o.UnitsByMight.empty,topThreatMight:0};class M extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new T(this),this.update=this.updater.update}bootstrap(e){return this.updater.initFromState(e),u.Regions.getAll(e).forEach(e=>this.updater.invalidateRegion(e)),this.updater.getMap()}entryToString(e){return-1===e.remainingMightTotal?"🛡":`${t=e,-1===t.remainingMightTotal||t.parent?"":S.GLYPH.redFlag}${e.remainingMightTotal}${d.numberToDots(e.topThreatMight)||""}`;var t}entryToDebugString(e){var t;return d.prettyPrintObject({region:e.regionId,faction:e.factionId,remainingMightTotal:e.remainingMightTotal,depth:e.depth,remainingUnits:e.remainingUnits.toString(),remainingGold:e.remainingGold,remainingIncome:e.remainingIncome,topThreatMight:e.topThreatMight,parent:null===(t=e.parent)||void 0===t?void 0:t.id})}}t.HexVulnerabilityProjection=M;class H extends c.default{constructor(){super((e,t)=>t.data.remainingMightTotal-e.data.remainingMightTotal)}}t.ThreatGeneratorsHeap=H;class T extends p.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}initialize(){this.dirtyRegions=new Set,this.directlyInvalidated=new Set,this.dirtyHexes=new Set,this.roots=new H,this.model||(this.model=new r.GameStateModel),this.model.restore(this.newState).useProjections([...r.ProjectionPresets.coreEntitiesAndSystems,this.dataSet.sources.regionHostileBorder,this.dataSet.sources.hexBaseDefense]),this.mightSolver=new o.UnitSolver(this.model.rules)}registerHandlers(e){e(this.dataSet.sources.currentPhase,this.handlePhaseChanged),e(this.dataSet.sources.hexBaseDefense,this.handleHexDefenseChanged),e(this.dataSet.sources.mightByRegion,this.handleRegionMightChanged)}handleHexDefenseChanged(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{this.handleHexDefenseDelta(e,t||l.NO_DEFENSE)})}handleRegionMightChanged(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{v.Factions.getByRegion(this.newState,e)!==w.CurrentPhase.getFaction(this.newState)&&this.invalidateRegion(e)})}handlePhaseChanged(e){const t=w.CurrentPhase.getFaction(this.oldState),i=e.faction;t!==i&&(void 0!==t&&v.Factions.getFactionRegions(this.newState,t).forEach(e=>this.invalidateRegion(e)),void 0!==i&&v.Factions.getFactionRegions(this.newState,i).forEach(e=>this.invalidateRegion(e)))}createMutation(){return this.updateInvalidated(),super.createMutation()}handleHexDefenseDelta(e,t){if(this.dirtyRegions.has(u.Regions.getByHex(this.newState,e)))return;const i=P.getHex(e),n=g.selectFromState(this.oldState,this.dataSet.sources.hexBaseDefense,e)||l.NO_DEFENSE,s=n.projected!==t.projected||t.retreatEnabled!==n.retreatEnabled;let a=t.local-n.local||t.projected-n.projected;0===a&&(t.retreatEnabled&&!n.retreatEnabled?a=1:n.retreatEnabled&&!t.retreatEnabled&&(a=-1)),this.invalidateOnHexDefenseDelta(i,a,s)}invalidateOnHexDefenseDelta(e,t,i){if(0===t)return;const n=t>0?this.getDirectlyInvalidatedHexesAfterDefenseAdjustment(e,i):this.getDirectlyInvalidatedAfterHexDefenseReduction(e,i);this.invalidateHexAndChildren(n),this.invalidateHexWithParents(n)}invalidateHexAndChildren(e){e.forEach(e=>this.dirtyHexes.add(e)),this.invalidateChildren(e)}invalidateChildren(e){let t=Array.from(e);for(;t.length;){const e=t.pop();e.neighbours(e=>!this.dirtyHexes.has(e)).forEach(i=>{const n=this.builder.get(i.id)||this.oldState&&this.dataSet.getEntryById(this.oldState,i.id);(null==n?void 0:n.parent)===e&&(this.dirtyHexes.add(i),t.push(i))})}}invalidateHexWithParents(e){let t=Array.from(e);const i=t.length&&u.Regions.getByHex(this.newState,t[0].id);for(;t.length;){const e=t.pop();if(this.dirtyHexes.has(e))continue;const n=u.Regions.getByHex(this.newState,e.id),s=this.getParentOf(e);n===i&&(this.dirtyHexes.add(e),s&&(this.dirtyHexes.has(s)||t.push(s)))}}getChildrenOf(e){return e.neighbours(t=>{var i;return(null===(i=this.dataSet.getEntryById(this.newState,t.id))||void 0===i?void 0:i.parent)===e})}getParentOf(e){var t;return null===(t=this.dataSet.getEntryById(this.newState,e.id))||void 0===t?void 0:t.parent}getDirectlyInvalidatedHexesAfterDefenseAdjustment(e,t){const i=t?1:0,n=new Set;return u.Regions.model(this.newState).byHex(e).hexes.bfsFrom(e,(e,t,s)=>(n.add(e),s<i)),n}getDirectlyInvalidatedAfterHexDefenseReduction(e,t){var i;const n=this.getDirectlyInvalidatedHexesAfterDefenseAdjustment(e,t),s=Array.from(n).reduce((e,t)=>{var i;const n=(null===(i=this.dataSet.getEntryById(this.newState,t.id))||void 0===i?void 0:i.remainingMightTotal)||0;return Math.max(n,e)},0);let a=Array.from(n).map(e=>({hex:e,maxThreat:s})),r=new Set;for(;a.length;){const{hex:e,maxThreat:t}=a.pop();if(!r.has(e)){r.add(e),n.add(e);for(let s of e.neighbours(e=>this.isLand(e)).members){const e=this.builder.getCurrent(s.id);if(((null==e?void 0:e.remainingMightTotal)||0)<t){n.add(s);const e=(null===(i=g.selectFromState(this.newState,this.dataSet.sources.hexBaseDefense,s.id))||void 0===i?void 0:i.local)||0;a.push({hex:s,maxThreat:t-e-1})}}}}return n}isLand(e){return!!g.selectFromState(this.newState,this.dataSet.sources.regionsByHex,e.id)}getMap(){return this.updateInvalidated(),a.default.Map(this.builder.getEntries()).mapKeys(e=>Number(e))}invalidateRegion(e){this.dirtyRegions.add(e)}getVulnerabilityGeneratedByRegion(e){const t=g.selectFromSuspendedState(this.newState,this.dataSet.sources.mightByRegion,e),i=g.selectFromState(this.newState,this.dataSet.sources.factionsByRegion,e);f.assert.defined(t,"missing for region "+e);const n=Object.assign(Object.assign({regionId:e,factionId:i,depth:0,state:this.model.state},t),{remainingUnits:t.totalUnits,remainingMightTotal:t.totalUnits.getTotalMight()+this.mightSolver.estimateBuyableMight(t)});return n.topThreatMight=this.mightSolver.estimateTopAvailableMight(n),n}getCurrentVulnerabilityOf(e){return this.dirtyHexes.has(e)?void 0:this.builder.getCurrent(e.id)}updateInvalidated(){var e,t;const i=this.model,n=new Set,s=w.CurrentPhase.getFaction(this.newState),a=new Set;for(let e of this.dirtyRegions){const t=g.selectFromSuspendedState(this.newState,this.dataSet.sources.mightByRegion,e),i=g.selectFromState(this.newState,this.dataSet.sources.factionsByRegion,e),n=i===s;if(f.assert.defined(t,"missing for region "+e),n&&(!this.oldState||i===w.CurrentPhase.getFaction(this.oldState))){u.Regions.model(this.newState).byId(e).getHostileBorderHexes().forEach(e=>this.dirtyHexes.add(e));continue}const r=this.oldState&&y.AI.getHostileBorderHexesByRegion(this.oldState,e).toArray(),o=y.AI.getHostileBorderHexesByRegion(this.newState,e).toArray(),d=this.oldState&&P.getHexes(r)||b.HexGroup.empty,c=P.getHexes(o);for(let e of d.members)a.add(e);for(let e of c.members)a.add(e)}for(this.invalidateHexAndChildren(a),this.roots=new H,this.dirtyHexes.forEach(e=>{var t;const i=u.Regions.model(this.newState).byHex(e.id);if(i){if((null===(t=i.faction)||void 0===t?void 0:t.id)!==s&&i.getHostileBorderHexes().has(e)){const t=this.getVulnerabilityGeneratedByRegion(i.id);t.remainingMightTotal>0&&this.addRoot(e,t)}e.neighbours(e=>!this.dirtyHexes.has(e)).forEach(e=>{const t=this.builder.getCurrent(e.id);t&&this.addRoot(e,t)})}else console.warn("INVALID DIRTY HEX "+e.id)});!this.roots.empty();){const s=this.roots.pop(),a=s.data,r=s.hex;if(n.has(r))continue;n.add(r),this.dirtyHexes.delete(r);const o=r.neighbours(e=>{if(n.has(e))return!1;const t=i.regions.byHex(e);return t&&t.id!==a.regionId});for(let n of o.members){i.restore(a.state);const s=this.getCurrentVulnerabilityOf(n);if(f.assert(!g.getActiveDataSets(a.state).has(this.dataSet),`VulnerabilityData for hex ${n.id} contain invalid state (HexVulnerabilityProjection not disabled)`),(null===(e=i.regions.byHex(n).faction)||void 0===e?void 0:e.id)===a.factionId){((null==s?void 0:s.remainingMightTotal)||0)<a.remainingMightTotal&&this.addRoot(n,Object.assign(Object.assign({},a),{parent:r}));continue}const o=this.getMightNeededToCapture(n),d=null!==(t=null==s?void 0:s.remainingMightTotal)&&void 0!==t?t:-1;if(d>=a.remainingMightTotal-o)continue;const c=this.mightSolver.gather({requiredMight:o,totalUnits:a.totalUnits,remainingUnits:a.remainingUnits,remainingGold:a.remainingGold,remainingIncome:a.remainingIncome});if(c){const e=this.mightSolver.estimateTotalMight(c);if(e<=d)continue;const t=i.units.getOccupyingUnit(n);if(t){const e=i.pawns.findOne({hexes:n,traits:[h.PawnTraits.EnablesRetreat]})&&i.units.getRetreatDestination(t,n);e?t.moveTo(e):t.destroy()}this.addRoot(n,{remainingIncome:c.remainingIncome,remainingGold:c.remainingGold,totalUnits:c.totalUnits,remainingUnits:c.remainingUnits,regionId:a.regionId,depth:a.depth+1,remainingMightTotal:e,topThreatMight:this.mightSolver.estimateTopAvailableMight(a),state:i.state,parent:r})}}}for(let e of this.dirtyHexes)this.builder.delete(e.id)}addRoot(e,t){const i=x.inject.random.integer(0,1e4);t.state=this.model.state,this.builder.set(e.id,t),this.roots.push({hex:e,data:t,nonce:i}),this.dirtyHexes.delete(e)}getMightNeededToCapture(e){return this.model.units.getHexDefense(e)+1}}t.HexVulnerabilityUpdater=T},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timing=t.Timing=void 0;i(1).logger.for("timing");class n{constructor(){this.checkpoints={}}start(e){performance.now();return{complete:e=>{performance.now()}}}}t.Timing=n,t.timing=new n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OpportunistAttackPriority=void 0;const n=i(111),s=i(16),a=i(17),r=i(21),o=i(1),d=i(66),c=i(10);o.logger.for("OpportunistAttackPriorityFactors");class h extends n.HexGroupValuationWithHeap{constructor(e){super(0,e=>-e),this.rootModel=e,this.onChange=s.signal()}calculateFor(e,t){const i=this.rootModel.units.getConquerableHexes(e,t);return this.attackerRegion=e,this.attackerMight=t,i.forEach(e=>{this.updateForHex(e)}),this.onChange.fire(),this}updateForHex(e){const t=this.getFactors(e);this.set(e.id,Math.floor(Object.values(t).reduce(a.sum)))}updateAfterHexCaptured(e){this.unset(e.id),e.neighbours(e=>this.rootModel.regions.byHex(e)!==this.attackerRegion).forEach(e=>this.updateForHex(e)),this.onChange.fire()}getFactors(e){return Object.assign(Object.assign(Object.assign({},this.getHexImportanceBonus(e)),this.getSafetyRating(e)),{joinRegionsBonus:this.getJoinRegionBonus(e),loot:10*this.rootModel.economy.numberOfCoinsAt(e)})}getHexImportanceBonus(e){let t=0,i=0;for(let n of[e,...e.neighbours().members]){const e=c.Regions.getByHex(this.rootModel.state,n.id);void 0!==e&&(e===this.attackerRegion.id?t+=this.rootModel.ai.getHexImportance(n):i=Math.max(i,this.rootModel.ai.getHexImportance(n)))}return{hexImportanceForMe:t,enemyHexImportanceBonus:i}}getJoinRegionBonus(e){let t=0;return new Set(e.neighbours().map(e=>this.rootModel.regions.byHex(e)).filter(e=>e&&e!==this.attackerRegion&&e.faction===this.attackerRegion.faction)).forEach(e=>{var i;e.isAlive()?t+=5*(e.treasury+Math.abs((null===(i=e.budget)||void 0===i?void 0:i.balance)||0)):t=50*e.hexes.length}),Math.min(t,100)}getSafetyRating(e){const t=this.rootModel.ai.getHexVulnerability(e)||d.NO_VULNERABILITY,i=r.Units.getHexDefenseAsIfOwnedBy(this.rootModel.state,e,this.attackerRegion.id),n=0===t.topThreatMight?0:Math.max(0,t.remainingMightTotal+t.topThreatMight)/Math.max(t.depth,1);let s,a=0;if(n){const e=n?t.topThreatMight:0;s=50/(Math.max(0,this.attackerMight-(e>i?e:1))+1);a=-1*Math.max(0,e-Math.max(this.attackerMight,i))*5*n}else s=50/this.attackerMight;return{baseSafetyRating:s,threatPenalty:a}}getDebugLayer(){const e=this;return{name:"ai.opportunistAttackPriority",onChange:e.onChange,getDetail:t=>{if(!e.get(t.id))return"";const i=e.getFactors(t);return Object.entries(i).map(([e,t])=>`${t.toFixed()} from ${e}`).join("\n")},getMap:t=>e}}}t.OpportunistAttackPriority=h},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.captureHex=t.handleAttackHex=void 0;const n=i(8),s=i(50),a=i(13),r=i(2),o=i(3);function d(e,t,i,o){r.assert.defined(t);const d=e.regions.byHex(t);r.assert.defined(d),r.assert.defined(i);let c=void 0;const h=o instanceof s.PawnModel?o.hex:void 0,l=function(){if(!e.pawns.findOne({hexes:t,traits:[a.PawnTraits.EnablesRetreat]}))return;const i=e.pawns.findOne({hexes:t,traits:[a.PawnTraits.Unit]});if(!i)return;const n=e.units.getRetreatDestination(i,h);return n?(i.moveTo(n),{pawnId:i.id,destinationHexId:n.id}):void 0}(),u=e.economy.loot(t,i),g=e.pawns.byHex(t);e.pawns.destroy(...g),i.addHexes(t),o instanceof s.PawnModel||(c=e.economy.payForNewPawn(t,o));let p=[{regionId:i.id,hexes:e.factions.byHex(t).absorbOwnRegionsAdjacentTo(t).map(e=>e.id)}];return d.faction.splitRegionIfDisconnected(d).forEach(e=>{p.push({regionId:e.id,hexes:e.hexes.members.map(e=>e.id)})}),o instanceof s.PawnModel?o.moveTo(t):o=e.pawns.create({type:o,hex:t}),e.currentPhase.tapPawn(o),[n.GameEvents.HexCaptured({capturedHexId:t.id,additionalConvertedHexes:p,capturingPawnId:o.id,capturingPawnType:o.type,capturingFactionId:i.faction.id,lootTransactions:u,boughtPawnTransactions:c,destroyedPawns:g.map(e=>e.id),newRegionId:i.id,originalRegionId:d.id,originatingHexId:null==h?void 0:h.id,retreat:l})]}t.handleAttackHex=function(e,t){const i=o.getHex(t.destinationHexId),n=e.pawns.byId(t.pawnId);r.assert.defined(i),r.assert.defined(n);const s=e.regions.byHex(n.hex);return r.assert.defined(s),d(e,i,s,n)},t.captureHex=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBoundingBox=t.manhattanDistance=t.multiplyRect=t.enlargeRect=t.rectToPhaser=void 0,t.rectToPhaser=function(e){return new Phaser.Geom.Rectangle(e.x,e.y,e.width,e.height)},t.enlargeRect=function(e,t){return e.x-=t,e.y-=t,e.width+=2*t,e.height+=2*t,e},t.multiplyRect=function(e,t,i){return e.x*=t,e.y*=i,e.width*=t,e.height*=i,e},t.manhattanDistance=function(e,t){return Math.abs(Math.abs(e.x)-Math.abs(t.x))+Math.abs(Math.abs(e.y)-Math.abs(t.y))},t.getBoundingBox=function(e){if(0===e.length)return{x:0,y:0,height:0,width:0};let t=Number.MAX_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER,n=-Number.MAX_SAFE_INTEGER,s=-Number.MAX_SAFE_INTEGER;for(let a of e)a.x<t&&(t=a.x),a.x>n&&(n=a.x),a.y<i&&(i=a.y),a.y>s&&(s=a.y);return{x:t,y:i,width:n-t,height:s-i}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Coin=void 0;var n=Phaser.GameObjects.Sprite;t.Coin=class extends n{constructor(e,t,i){super(e,t,i,"coin"),this.setOrigin(.5,1)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getFortificationLevelByPawnType=t.TileBordersFadeInCinematic=t.BLANK_TILE_DATA=t.TileBordersManager=t.FortificationLevel=void 0;const n=i(3),s=i(37),a=i(1),r=i(119),o=i(6),d=i(25),c=i(53),h=i(0),l=i(16),u=i(40),g=i(13),p=i(5),f=i(2);var m;!function(e){e[e.Ocean=0]="Ocean",e[e.Plains=1]="Plains",e[e.Palisade=2]="Palisade",e[e.StoneWall=3]="StoneWall"}(m=t.FortificationLevel||(t.FortificationLevel={}));const y=a.logger.for("TileBordersManager");function w(e,t,i){return i?[e,t,i].map(e=>e.id).sort((e,t)=>e-t).join("."):e.id>t.id?`${t.id}.${e.id}`:`${e.id}.${t.id}`}t.TileBordersManager=class{constructor(e,t){this.scene=e,this.renderer=t,this.imagesById={},this.tileData={},this.cinematics={fadeIn:new v(this)},this.debugLayer={name:"TileBordersManager",getMap:()=>{const e=o.mapDictionary(this.tileData,e=>`${e.regionId}(${e.fortificationLevel})`);return u.CustomHexGroupValuation.fromDictionary(e,void 0)},getDetail:e=>{const t=this.tileData[e.id];return`region: ${t.regionId}\nfortification: ${t.fortificationLevel}`},onChange:l.signal()},h.inject.debugLayers.register(this.debugLayer)}getAllObjects(){return Object.values(this.imagesById)}initializeFromModel(e,t){const i=o.dictionaryOf(t.map(t=>{var i,n,s;return{hexId:t.id,regionId:null!==(n=null===(i=e.regions.byHex(t))||void 0===i?void 0:i.id)&&void 0!==n?n:-1,fortificationLevel:b(null===(s=e.pawns.select({hexes:t,traits:[g.PawnTraits.Wall]}).filter(e=>e.defense>0)[0])||void 0===s?void 0:s.type)}}),"hexId");this.setGrid(e.grid,i)}setGrid(e,t){this.clear(),this.grid=e,this.doUpdateHexes(t)}updateTileData(e){const i=o.mapDictionary(e,(i,n)=>Object.assign(Object.assign(Object.assign({},t.BLANK_TILE_DATA),this.tileData[n]),e[n]));this.doUpdateHexes(i)}setTileData(e,i){this.doUpdateHexes({[e]:Object.assign(Object.assign(Object.assign({},t.BLANK_TILE_DATA),this.tileData[e]),i)})}setTileFortificationType(e,t){const i=this.tileData[e];f.assert.defined(i,"no tileData loaded for hex #"+e),this.updateTileData({[e]:Object.assign(Object.assign({},i),{fortificationLevel:t})})}updateCorner(e,t,i=this.tileData){let[n,a]=e.neighboursByCorner(t);if(!n||!a)return void y.warning(`Ignoring ${s.HexCornerDirection[t]} corner of ${e}, adjacent hexes incomplete`);const r=w(e,n,a),o=this.resolveCornerBetween(e,n,a),d=this.resolveCornerBetween(e,n,a,i);if(o!==d){const i=this.imagesById[r];if(i&&i.destroy(),d){const i=d.createCorner(this.scene,e,t);this.renderer.add(e,i),this.imagesById[r]=i}else delete this.imagesById[r]}}clear(){Object.values(this.imagesById).forEach(e=>e.destroy()),this.imagesById={},this.tileData={}}doUpdateHexes(e){n.getHexes(Object.keys(e).map(e=>Number(e))).forEach(t=>this.updateHex(t,e)),Object.assign(this.tileData,e),this.debugLayer.onChange.fire()}updateHex(e,t){for(let i of s.HEX_DIRECTIONS){e.neighbour(i)&&this.updateBorder(e,i,t)}for(let i of s.HEX_CORNER_DIRECTIONS)this.updateCorner(e,i,t)}updateBorder(e,t,i){let n=e.neighbour(t);const s=w(e,n),a=this.resolveBorderTypeBetween(e,n),r=this.resolveBorderTypeBetween(e,n,i);if(a!==r){const i=this.imagesById[s];if(i&&i.destroy(),r){const i=r.createBorder(this.scene,e,t);this.renderer.add(e,i),this.imagesById[s]=i}else delete this.imagesById[s]}}resolveBorderTypeBetween(e,i,n={}){const s=n[e.id]||this.tileData[e.id]||t.BLANK_TILE_DATA,a=n[i.id]||this.tileData[i.id]||t.BLANK_TILE_DATA;if(s.fortificationLevel+a.fortificationLevel===1)return null;if(s.regionId===a.regionId){if(s.fortificationLevel===a.fortificationLevel)return null;{const t=Math.max(s.fortificationLevel,a.fortificationLevel);switch(t){case 0:case 1:return null;case 2:return r.TileBorders.palisade;case 3:return r.TileBorders.stoneWall;default:throw new Error(`don't know how to render fortification type ${t} between ${e} and ${i}`)}}}else{const t=Math.max(s.fortificationLevel,a.fortificationLevel);switch(t){case 0:return null;case 1:return r.TileBorders.plain;case 2:return r.TileBorders.palisade;case 3:return r.TileBorders.stoneWall;default:throw new Error(`don't know how to render fortification type ${t} between ${e} and ${i}`)}}}resolveCornerBetween(e,i,n,s={}){const a=s[e.id]||this.tileData[e.id]||t.BLANK_TILE_DATA,o=s[i.id]||this.tileData[i.id]||t.BLANK_TILE_DATA,d=s[n.id]||this.tileData[n.id]||t.BLANK_TILE_DATA;if(a.regionId===o.regionId&&o.regionId===d.regionId&&a.fortificationLevel===o.fortificationLevel&&o.fortificationLevel===d.fortificationLevel)return null;{const t=Math.max(a.fortificationLevel,o.fortificationLevel,d.fortificationLevel);switch(t){case 0:case 1:return null;case 2:return r.TileBorders.palisade;case 3:return r.TileBorders.stoneWall;default:throw new Error(`don't know how to render corner fortification type ${t} between ${e}, ${i} and ${n}`)}}}},t.BLANK_TILE_DATA={hexId:-1,regionId:-1,fortificationLevel:0};class v extends d.BaseCinematic{constructor(e){super(e.scene),this.tileBorders=e}playAfter(e,t){this.tileBorders.getAllObjects().forEach(e=>e.setAlpha(0)),super.playAfter(e,t)}play(){const e=this.tileBorders.getAllObjects();e.forEach(e=>e.setAlpha(0));const t=c.createStaggeredDelay2Dfn(e,0,1e3,100);this.scene.tweens.add({duration:250,targets:e,ease:"Sine.easeIn",alpha:1,delay:t})}}function b(e){switch(e){case p.PawnType.StoneWall:return m.StoneWall;case p.PawnType.Palisade:return m.Palisade;default:return m.Plains}}t.TileBordersFadeInCinematic=v,t.getFortificationLevelByPawnType=b},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceInfo=t.ScreenSize=void 0;const n=i(61);var s;!function(e){e.Large="large",e.Small="small"}(s=t.ScreenSize||(t.ScreenSize={}));t.DeviceInfo=class{constructor(e){this.game=e,this.screenSize=n.watchable(s.Large),this.supports={touch:e.device.input.touch},e.scale.on("resize",()=>setTimeout(()=>this.updateScreenSize(),100),this),this.updateScreenSize()}updateScreenSize(){this.game.scale.displaySize.width>=654&&this.game.scale.displaySize.height>=370?this.screenSize.set(s.Large):this.screenSize.set(s.Small)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SpectatorMode=void 0;const n=i(41);class s extends n.BaseMode{constructor(e){super(e)}activate(){this.scene.uiScene.hide()}handleHexCaptured(e){e.sourceHexId?this.scene.worldMapScene.pawns.move(e.sourceHexId,e.capturedHexId):this.scene.worldMapScene.pawns.add(e.capturedHexId,e.capturingPawnType),e.coinTransactions&&this.scene.worldMapScene.coins.applyTransactions(e.coinTransactions)}}t.SpectatorMode=s},,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FixedCapacityArray=void 0;t.FixedCapacityArray=class{constructor(e){this.cursor=0,this.data=[],this.size=0,Array.isArray(e)?(this.data=e,this.size=this.data.length):this.size=e}get length(){return this.data.length}push(e){this.data[this.cursor]=e,this.cursor=(this.cursor+1)%this.size}getItems(){return this.data.slice(this.cursor,this.size).concat(...this.data.slice(0,this.cursor))}get(e){return this.data[(this.cursor+e)%this.data.length]}pop(){const e=this.getItems(),t=e[e.length-1];return this.data=this.getItems().slice(0,this.data.length-1),this.cursor=this.data.length,t}}},,,,,,,,,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getHexUnderCursor=t.watchableHexUnderCursor=void 0;const n=i(0),s=i(15),a=i(61),r=i(3);function o(e,t){let i,a,o=(e.input.activePointer.worldX+s.HEX_WIDTH/2)/s.HEX_WIDTH,d=e.input.activePointer.worldY/s.HEX_INNER_HEIGHT,c=o%1,h=d%1;n.inject.debugData;Math.floor(d)%2?c<.5?h<(1-2*c)/3?(i=Math.floor(o),a=Math.floor(d)-1/3):(i=Math.floor(o)+.5,a=Math.floor(d)+2/3):h<1/3-2*(1-c)/3?(i=Math.floor(o)+1,a=Math.floor(d)-1/3):(i=Math.floor(o)+.5,a=Math.floor(d)+2/3):c<.5?h<2*c/3?(i=Math.floor(o)+.5,a=Math.floor(d)-1/3):(i=Math.floor(o),a=Math.floor(d)+2/3):h<2/3-2*c/3?(i=Math.floor(o)+.5,a=Math.floor(d)-1/3):(i=Math.floor(o)+1,a=Math.floor(d)+2/3),i-=1,a-=2/3;let l=Math.round(a),u=Math.round(i+l%2/2);if(t.grid.isWithinBounds({r:l,c:u}))return r.getHex({r:l,c:u})}t.watchableHexUnderCursor=function(){const e=a.watchable(void 0);return e.update=t=>{const i=n.inject.gameStateModel;t.input.activePointer.updateWorldPoint(t.cameras.main);const s=o(t,i);e.set(s)},e},t.getHexUnderCursor=o},,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.spatialToTabular=t.tabularToOrdinal=t.tabularToSpatial=t.ordinalToTabular=t.isOrdinal=t.isTabular=t.isSpatial=void 0;const n=i(3);t.isSpatial=function(e){return e.hasOwnProperty("x")},t.isTabular=function(e){return e.hasOwnProperty("r")},t.isOrdinal=function(e){return"number"==typeof e},t.ordinalToTabular=function(e){return{r:Math.floor(e/n.GRID_MAX_DIMENSION),c:Math.floor(e%n.GRID_MAX_DIMENSION)}},t.tabularToSpatial=function({r:e,c:t}){return{x:t-e%2/2,y:e}},t.tabularToOrdinal=function({r:e,c:t}){return e*n.GRID_MAX_DIMENSION+t},t.spatialToTabular=function({x:e,y:t}){return{r:t,c:Math.ceil(e)}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RootController=t.DEFAULT_NEW_GAME_OPTIONS=void 0;const s=i(0),a=i(27),r=i(1),o=i(8),d=i(153),c=i(113),h=i(189),l=i(196),u=i(115),g=i(35),p=i(5),f=i(103),m=i(116);r.logger.for("RootController");t.DEFAULT_NEW_GAME_OPTIONS={map:"perlin",regions:"balancedChaos",players:6,mapWidth:23,mapHeight:23,localPlayers:1};t.RootController=class{constructor(e){this.game=e,this.events=new c.TypedEventBus,this.gameStateController=new d.GameStateController}run(){s.inject.config.watchFuture(e=>{e.debug.overlay?(this.game.scene.run(a.Scenes.Debug),"string"==typeof e.debug.overlay&&m.commands.debug.dataSet(e.debug.overlay)):this.game.scene.isActive(a.Scenes.Debug)&&this.game.scene.sleep(a.Scenes.Debug)}),s.inject.config.watch(e=>{e.debug.recordGame?s.inject.gameStateRecorder.isRecording()||s.inject.gameStateRecorder.start():s.inject.gameStateRecorder.isRecording()&&s.inject.gameStateRecorder.stop()}),this.events.on(o.SystemEvents.EngineInitialized,()=>{this.game.scene.run(a.Scenes.Play),s.inject.config.debug.overlay&&this.game.scene.run(a.Scenes.Debug),s.inject.debugLayers.register(f.createBorderHexesDebugLayer()),s.inject.debugLayers.register(m.createHexIdDebugLayer()),s.inject.debugLayers.register(m.createExposedHexesDebugLayer());try{this.events.trigger(o.UserActions.LoadGame("auto"))}catch(e){console.error(e),s.inject.config.debug.overlay||this.events.trigger(o.UserActions.StartNewGame(t.DEFAULT_NEW_GAME_OPTIONS))}}),this.events.on(o.UserActions.EditMap,(e,t)=>{this.game.scene.sleep(a.Scenes.Play),this.game.scene.run(a.Scenes.MapEditor)}),this.events.on(o.UserActions.ResumeGame,()=>{this.game.scene.sleep(a.Scenes.MapEditor),this.game.scene.run(a.Scenes.Play)}),this.events.on(o.UserActions.StartNewGame,e=>n(this,void 0,void 0,(function*(){yield h.createRandomMap(e),this.gameStateController.loadState(s.inject.gameStateModel.state,o.NewGameStateContext.StartingNewGame),u.saveGame("restart")}))),this.events.on(o.UserActions.RevertTurn,e=>{const t=this.gameStateController.lastTurnState;this.gameStateController.loadState(t,o.NewGameStateContext.LoadedGameStateForDebug)}),this.events.on(o.UserActions.LoadGame,e=>{const t=l.loadGame(e);this.gameStateController.loadState(t,o.NewGameStateContext.RestoredSavedGame),s.inject.config.autoSaveOnTurnStart&&"auto"!==e&&u.saveGame("auto")}),this.events.on(o.UserActions.SyncWithModel,e=>{this.gameStateController.loadState(this.gameStateController.currentState,o.NewGameStateContext.LoadedGameStateForDebug)}),this.events.on(o.UserActions.SaveGame,e=>{u.saveGame(e)}),this.events.on(o.UserActions.DebugGameState,e=>{this.gameStateController.loadState(e,o.NewGameStateContext.LoadedGameStateForDebug)}),this.events.on(o.UserActions.EndTurn,()=>{s.inject.config.autoSaveOnTurnEnd&&u.saveGame("auto")}),this.gameStateController.onEvent(e=>{var t;if(g.isEvent(e,o.GameEvents.FactionTurnStarted)&&s.inject.config.autoSaveOnTurnStart&&(null===(t=s.inject.gameStateModel.factions.byId(e.payload))||void 0===t?void 0:t.controller)===p.FactionController.LocalUser){const e=localStorage.getItem(u.SAVE_GAME_LOCAL_STORAGE_PREFIX+"turnStart")||"";localStorage.setItem(u.SAVE_GAME_LOCAL_STORAGE_PREFIX+"last",e),u.saveGame("auto"),u.saveGame("turnStart")}})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SingletonDataSet=void 0;t.SingletonDataSet=class{constructor(e,t){this.key=e,this.defaultValue=t}apply(e,t){return e.set(this.key,t)}deserialize(e){return e}serialize(e){return e}createMutation(e,t){return{dataSet:this,changes:e,context:t}}getEntryById(e,t){throw new Error(`Cannot extract entry ${t} from SingletonDataSet ${this.key} (SingletonDataSet has no entries)`)}entryToString(e){return""}entryToDebugString(e){return""}getEntryIds(e){return[]}toString(){return`[SingletonDataSet "${this.key}"]`}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Grid=void 0;const n=i(3),s=i(4),a=i(9),r=i(95),o=i(162);class d{static get(e){return s.selectFromState(e,a.GameState.grid)}static getAllHexes(e){return n.HexGrid.getAllHexes(this.get(e))}static model(e){const t=this.get(e);return this.modelFactory.getOrCreateFor(t)}}t.Grid=d,d.modelFactory=new r.FactoryWithCache(e=>new o.GridModel(e))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryWithCache=void 0;t.FactoryWithCache=class{constructor(e){this.maker=e,this.instances=new WeakMap}getOrCreateFor(e){let t=this.instances.get(e);return t||(t=this.maker(e),this.instances.set(e,t)),t}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.lazyAdapter=void 0,t.lazyAdapter=function(e){let t=void 0,i=void 0;return()=>{const n=e.source();return void 0!==n&&n===i||(t=e.transform(n),i=n),t}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionEconomyCalculator=void 0;const n=i(1),s=i(98),a=i(5),r=i(2),o=i(28),d=i(11),c=i(3);n.logger.for("RegionEconomyCalculator");t.RegionEconomyCalculator=class{constructor(e,t){this.state=e,this.region=t,this.sinks=[],this.builder=new s.CoinTransactionBuilder}run(){this.allRegionHexes=this.region.hexes,this.builder.reset();const e=o.Economy.getTownHexesByRegion(this.state,this.region.id);for(this.townHexes=c.getHexes(e).members,this.assembleSinks(),this.spawnIncome();this.sinks.length;){const e=this.sinks[0],t=this.allRegionHexes.findClosest(e.pawn.hex,e=>(this.goldByHex[e.id]||0)>0);if(!t)break;{const i=this.goldByHex[t.id];i>e.demand?this.sendMoneyToSink(t,0,e.demand):this.sendMoneyToSink(t,0,i)}}Object.entries(this.goldByHex).map(([e,t])=>({hexId:Number(e),remainingIncome:t})).filter(({hexId:t})=>!e.includes(t)).forEach(({hexId:e,remainingIncome:t})=>{const i=c.getHex(e),n=this.allRegionHexes.findClosest(i,e=>this.townHexes.includes(e));n&&this.sendMoneyToTown(i,n,t)});const t=d.Pawns.model(this.state);this.townHexes.forEach(e=>{t.setCount(e,a.PawnType.Coins,this.goldByHex[e.id]||0)}),this.state=t.state;const i=this.sinks.map(e=>e.pawn),n=i.map(e=>e.hex.id);i.forEach(e=>e.replaceWith(a.PawnType.Bandit));return{coinTransfers:this.builder.getTransactions(),unitsTurnedBandits:n}}assembleSinks(){d.Pawns.model(this.state).select({hexes:this.region.hexes}).filter(e=>e.upkeep&&e.upkeep>0).forEach(e=>{this.sinks.push({pawn:e,demand:e.upkeep})})}sendMoneyToSink(e,t,i){const n=this.sinks[t];this.builder.from(e).send(n.pawn.hex,i).consume(),n.demand-=i,this.removeGoldFromHex(e,i),0===n.demand&&this.sinks.splice(t,1)}sendMoneyToTown(e,t,i){this.builder.from(e).send(t,i),this.removeGoldFromHex(e,i),this.addGoldToHex(t,i)}spawnIncome(){this.goldByHex={},0!==this.townHexes.length&&this.allRegionHexes.forEach(e=>{const t=o.Economy.getIncomeFromHex(this.state,e.id);t>0&&(this.addGoldToHex(e,t),this.builder.from(e).spawn(t)),this.townHexes.includes(e)&&this.addGoldToHex(e,o.Economy.getNumberOfCoinsAt(this.state,e.id)||0)})}addGoldToHex(e,t){this.goldByHex[e.id]=(this.goldByHex[e.id]||0)+t}removeGoldFromHex(e,t){r.assert(this.goldByHex[e.id]>0),this.goldByHex[e.id]=this.goldByHex[e.id]-t,this.goldByHex[e.id]<=0&&delete this.goldByHex[e.id]}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinTransactionBuilder=void 0;const n=i(6),s=i(5),a=i(2),r=i(11),o=i(3);function d(){return{consume:0,send:{},spawn:0}}t.CoinTransactionBuilder=class{constructor(){this.data={}}from(e){return this.currentHex=e,this}spawn(e){a.assert.defined(this.currentHex,"no hex selected");return n.getOrCreate(this.data,this.currentHex.id,d).spawn+=e,this.currentAmount=e,this}send(e,t=this.currentAmount){a.assert.defined(this.currentHex,"no hex selected"),a.assert.defined(t,"amount not specified");const i=n.getOrCreate(this.data,this.currentHex.id,d);return i.send[e.id]=(i.send[e.id]||0)+t,this.currentHex=e,this.currentAmount=t,this}consume(e=this.currentAmount){a.assert.defined(e,"amount not specified"),a.assert.defined(this.currentHex,"no hex selected");return n.getOrCreate(this.data,this.currentHex.id,d).consume+=e,this}getTransactions(){return this.data}reset(){this.currentHex=void 0,this.currentAmount=void 0,this.data={}}apply(e){return function(e,t){const i={};Object.entries(t).forEach(([e,t])=>{i[e]=i[e]||0,i[e]+=t.spawn,i[e]-=t.consume,Object.entries(t.send).forEach(([t,n])=>{i[e]-=n,i[t]=(i[t]||0)+n})});const n=r.Pawns.model(e);return Object.entries(i).forEach(([e,t])=>{const i=o.getHex(Number(e));a.assert.defined(i),n.adjustCount(i,s.PawnType.Coins,t)}),n.state}(e,this.getTransactions())}}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SetDataSetMutationBuilder=t.SetDataSet=void 0;const s=n(i(7)),a=i(4),r=i(2);t.SetDataSet=class{constructor(e){this.key=e,this.defaultValue=s.default.Set()}deserialize(e){return s.default.Set(e)}serialize(e){return e.toArray()}apply(e,t){t.cleared&&(e=e.set(this.key,s.default.Set()));let i=e.get(this.key);return t.addedEntries&&(i=i.union(t.addedEntries)),t.deletedEntries&&(i=i.subtract(t.deletedEntries)),e.set(this.key,i)}getEntryById(e,t){return e.get(this.key).has(t)}getEntryIds(e){return[]}entryToString(e){return e.toString()}entryToDebugString(e){return e.toString()}createMutation(e,t){let i={};return e.clear&&(i.cleared=!0),e.add&&e.add.length&&(i.addedEntries=e.add),e.delete&&e.delete.length&&(i.deletedEntries=e.delete),{dataSet:this,changes:i,context:`${this.key}/${t}`}}toString(){return`[SetDataSet "${this.key}"]`}};t.SetDataSetMutationBuilder=class{constructor(e){this.dataSet=e}init(e){this.state=e,this._itemsToDelete=new Set,this._itemsToAdd=new Set,this._clear=!1}add(...e){r.assert.defined(this.state,"builder not initialized!"),e.forEach(e=>{this._itemsToDelete.has(e)?this._itemsToDelete.delete(e):this._itemsToAdd.add(e)})}delete(...e){r.assert.defined(this.state,"builder not initialized!"),e.forEach(e=>{this._itemsToAdd.has(e)?this._itemsToAdd.delete(e):this._itemsToDelete.add(e)})}createMutation(e){const t=a.selectFromState(this.state,this.dataSet);return this.dataSet.createMutation({clear:this._clear,add:Array.from(this._itemsToAdd).filter(e=>!t.has(e)),delete:Array.from(this._itemsToDelete).filter(e=>t.has(e))},e)}clear(){this._clear=!0}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BalancedGrowthArmyComposition=t.UNRESTRICTED_ARMY_COMPOSITION=void 0;const n=i(0);i(1).logger.for("ai:ArmyComposition");t.UNRESTRICTED_ARMY_COMPOSITION={getWillingnessToDiscardUnit:()=>0,getWillingnessToObtainUnit:()=>0,getWillingnessToSpend:(e,t)=>-t/1e3};t.BalancedGrowthArmyComposition=class{constructor(e){this.region=e}getWillingnessToDiscardUnit(e,t){return-this.getUnitCountPressure(e.totalUnits,t,-1)}getWillingnessToObtainUnit(e,t){return this.getUnitCountPressure(e.totalUnits,t,1)}getWillingnessToSpend(e,t){return 0}getUnitCountPressure(e,t,i){const s=this.region.size,a=n.inject.gameStateModel.rules.unitByMight(t).upkeep,r=Math.floor(s/(t+2)),o=.75*s-r;let d=(r-a*(e.countOf(t)+i))/o;return d>1?d=1:d<-1&&(d=-1),d}}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexBaseDefenseProjection=t.NO_DEFENSE=void 0;const s=i(18),a=n(i(7)),r=i(3),o=i(13),d=i(4),c=i(23),h=i(11),l=i(17),u=i(22),g=i(2),p=i(33);t.NO_DEFENSE=Object.freeze({local:0,projected:0,retreatEnabled:!1});class f extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.eager=!1,this.update=new m(this).update}bootstrap(e){return a.default.Map().withMutations(t=>{r.getHexes(d.selectFromState(e,this.sources.regionsByHex).keySeq().toArray()).forEach(i=>{t.set(i.id,this._calculate(e,i))})})}_calculate(e,t){const i=h.Pawns.model(e).byHex(t).filter(t=>!c.CurrentPhase.isMovable(e,t.id));return{local:i.map(e=>e.defense).reduce(l.max,0),projected:i.filter(e=>e.hasTrait(o.PawnTraits.GuardsAdjacentTiles)).map(e=>e.defense).reduce(l.max,0),retreatEnabled:i.some(e=>e.hasTrait(o.PawnTraits.EnablesRetreat))}}entryToString(e){return`${e.local}${e.projected?p.GLYPH.defense:""}`}}t.HexBaseDefenseProjection=f;class m extends u.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}initialize(){this.pawns=h.Pawns.model(this.newState),this.dirtyHexes=new Set}registerHandlers(e){e(this.dataSet.sources.pawnsByHex,e=>this._handlePawnsByHexChange(e)),e(this.dataSet.sources.movableUnits,e=>this._handleMovableUnitsChange(e))}createMutation(){return this.dirtyHexes.forEach(e=>this.builder.set(e.id,this.dataSet._calculate(this.newState,e))),super.createMutation()}invalidate(e){g.assert.defined(e,"attempted to add undefined into dirtyHexes"),this.dirtyHexes.add(e)}_handlePawnsByHexChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>{e.removed?this.invalidate(r.getHex(e.id)):e.added&&this._addDefenders(e.added)})}_handleMovableUnitsChange(e){var t;if(e.cleared){const e=c.CurrentPhase.getMovableUnits(this.oldState);this._addDefenders(e)}null===(t=e.addedEntries)||void 0===t||t.forEach(e=>{var t;const i=null===(t=this.pawns.byId(e))||void 0===t?void 0:t.hex;this.invalidate(i)}),e.deletedEntries&&this._addDefenders(e.deletedEntries)}_addDefenders(e){e.forEach(e=>{var t;const i=this.pawns.byId(e);if(!i||c.CurrentPhase.isMovable(this.newState,e))return;const n=null===(t=this.pawns.byId(e))||void 0===t?void 0:t.hex;if(!n)return;const s=this.builder.getCurrent(n.id),a=i.hasTrait(o.PawnTraits.GuardsAdjacentTiles)?i.defense:0,r=i.hasTrait(o.PawnTraits.EnablesRetreat);this.builder.set(n.id,{local:Math.max((null==s?void 0:s.local)||0,i.defense),projected:Math.max((null==s?void 0:s.projected)||0,a),retreatEnabled:(null==s?void 0:s.retreatEnabled)||r})})}}},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.MightByRegionUpdater=t.MightByRegionProjection=t.NO_MIGHT=void 0;const r=i(18),o=a(i(7)),d=i(14),c=i(10),h=i(45),l=i(32),u=i(4),g=i(22),p=i(1),f=i(23),m=i(11);p.logger.for("MightByRegionProjection");t.NO_MIGHT={remainingMightTotal:0,remainingIncome:0,remainingGold:0,remainingUnits:h.UnitsByMight.empty,totalUnits:h.UnitsByMight.empty,topThreatMight:0};class y extends r.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new w(this).update}bootstrap(e){const t=new h.UnitSolver(l.Rules.model(e)),i=c.Regions.model(e);return o.Map().withMutations(e=>{i.all().forEach(i=>{const n=t.getRegionState(i),s=Object.assign(Object.assign({},n),{remainingMightTotal:t.estimateTotalMight(n),topThreatMight:t.estimateTopAvailableMight(n)});e.set(i.id,s)})})}calculateRegionMight(e,t){t||(t=new h.UnitSolver(l.Rules.model(e.state)));const i=t.getRegionState(e);return Object.assign(Object.assign({},i),{remainingMightTotal:t.estimateTotalMight(i),topThreatMight:t.estimateTopAvailableMight(i)})}entryToString(e){return""+e.remainingMightTotal}entryToDebugString(e){return d.prettyPrintObject(e)}}t.MightByRegionProjection=y;class w extends g.BaseUpdater{constructor(){super(...arguments),this.builder=new r.MapMutationBuilder(this.dataSet)}initialize(){this.invalidated=new Set}registerHandlers(e){e(this.dataSet.sources.budgetByRegion,this.handleRegionBudgetChange.bind(this)),e(this.dataSet.sources.pawnsByRegion,this.handlePawnsByRegionChange.bind(this)),e(this.dataSet.sources.coinsByHex,this.handleCoinsByHexChange),e(this.dataSet.sources.movableUnits,this.handleMovableUnitsChange)}handleRegionBudgetChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{this.invalidated.add(e)})}handlePawnsByRegionChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>this.invalidated.add(e.id))}handleCoinsByHexChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{var i,n,s;const a=u.selectFromState(this.newState,this.dataSet.sources.regionsByHex,e);if(void 0===a)return;const r=(t=null!=t?t:0)-(null!==(i=u.selectFromState(this.oldState,this.dataSet.sources.coinsByHex,e))&&void 0!==i?i:0);this.updateRegionPower(a,{remainingGold:(null!==(s=null===(n=this.builder.getCurrent(a))||void 0===n?void 0:n.remainingGold)&&void 0!==s?s:0)+r})})}updateRegionPower(e,t){const i=this.builder.getCurrent(e);i&&!this.invalidated.has(e)?this.builder.set(e,Object.assign(Object.assign({},i),t)):this.invalidated.add(e)}createMutation(){const e=c.Regions.model(this.newState);return this.invalidated.forEach(t=>{this.builder.set(t,this.dataSet.calculateRegionMight(e.byId(t)))}),super.createMutation()}handleMovableUnitsChange(e){var t,i;e.cleared&&f.CurrentPhase.model(this.oldState).getMovablePawns().forEach(e=>this.invalidated.add(e.region.id)),null===(t=e.deletedEntries)||void 0===t||t.forEach(e=>{const{might:t,region:i}=m.Pawns.model(this.oldState).byId(e),n=this.builder.getCurrent(i.id);n.remainingUnits.has(t)&&this.updateRegionPower(i.id,{remainingUnits:n.remainingUnits.withoutUnit(t),remainingMightTotal:n.remainingMightTotal-t})}),null===(i=e.addedEntries)||void 0===i||i.forEach(e=>{const{might:t,region:i}=m.Pawns.model(this.newState).byId(e),n=this.builder.getCurrent(i.id);this.updateRegionPower(i.id,{remainingUnits:n.remainingUnits.with(t),remainingMightTotal:n.remainingMightTotal+t})})}}t.MightByRegionUpdater=w},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createBorderHexesDebugLayer=t.RegionBorderHexesProjection=void 0;const s=n(i(7)),a=i(3),r=i(39),o=i(0),d=i(10),c=i(16),h=i(104),l=i(105),u=i(9),g=i(4),p=i(33);class f extends r.MultiMapDataSet{constructor(e,t){super(e),this.regionsHexes=t,this.parents=[this.regionsHexes]}bootstrap(e){return s.default.Map().withMutations(t=>{d.Regions.model(e).all().forEach(i=>{const n=i.hexes.filter(t=>m(e,t,i.id)).map(e=>e.id);n.length&&t.set(i.id,s.default.Set(n))})})}update(e,t,i){var n;const s=new r.MultiMapMutationBuilder(this,e);return null===(n=t.require(this.regionsHexes).updated)||void 0===n||n.forEach(t=>{const i=t.id;if(t.added){a.getHexes(t.added).forEach(t=>{const n=d.Regions.model(e).byId(i);m(e,t,i)&&s.add(i,t.id),n.hexes.neighboursOf(t).forEach(t=>{m(e,t,i)||s.remove(i,t.id)})})}t.removed&&(s.remove(i,...t.removed),t.removed.forEach(t=>{const n=d.Regions.model(e).byId(i);n?n.hexes.neighboursOf(a.getHex(t)).forEach(e=>{s.add(i,e.id)}):s.removeEntry(i)}))}),s.createMutation("regionsByHexChanged")}entryToString(e){return`[${e.size}]`}}function m(e,t,i){return!!t.findNeighbour(t=>d.Regions.getByHex(e,t.id)!==i)}t.RegionBorderHexesProjection=f,t.createBorderHexesDebugLayer=function(){const e=o.inject.gameStateModel.stateEngine;let t=c.signal();return e.watchDataSet(u.GameState.regions.borderHexes,()=>{t.fire()}),{name:"regions.borderHexes",onChange:t,getMap:t=>new h.ProxyHexGroupValuation(new l.HexGroupValuationFromStateEngine(e,u.GameState.regions.byHex),(t,i)=>{var n,s;const a=null===(n=g.selectFromState(e.currentState,u.GameState.ai.hostileBorderHexes,t))||void 0===n?void 0:n.has(i),r=null===(s=g.selectFromState(e.currentState,u.GameState.regions.borderHexes,t))||void 0===s?void 0:s.has(i);return a?p.GLYPH.redFlag:r?p.GLYPH.whiteFlag:""}),getDetail(t){var i,n;const s=d.Regions.getByHex(e.currentState,t.id),a=null===(i=g.selectFromState(e.currentState,u.GameState.ai.hostileBorderHexes,s))||void 0===i?void 0:i.has(t.id);return`\nregion: ${s}\nborder: ${(null===(n=g.selectFromState(e.currentState,u.GameState.regions.borderHexes,s))||void 0===n?void 0:n.has(t.id))?"YES":"NO"}\nhostile: ${a?"YES":"NO"}`}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ProxyHexGroupValuation=void 0;t.ProxyHexGroupValuation=class{constructor(e,t){this.parent=e,this.proxyFunc=t}get(e){return this.proxyFunc(this.parent.get(e),e)}getHexIds(){return this.parent.getHexIds()}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexGroupValuationFromStateEngine=void 0;t.HexGroupValuationFromStateEngine=class{constructor(e,t){this.state=e,this.dataSet=t}get(e){return this.state.get(this.dataSet,e)}getHexIds(){return this.state.getEntryIds(this.dataSet)}}},,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compressRuleSet=t.addIds=t.decompressGameState=t.compressGameState=void 0;const n=i(6),s=i(9),a=i(1),r=i(64);a.logger.for("decompressGameState");function o(e,t,i){var n;return(null===(n=e.get(t,i))||void 0===n?void 0:n.toArray())||[]}t.compressGameState=function(e){const t=e.serialize();return e.activate(s.GameState.regions.hexes,s.GameState.factions.regions),{grid:t.grid,version:t.version,regions:Object.values(t.regions).map(t=>Object.assign(Object.assign({},t),{hexes:o(e,s.GameState.regions.hexes,t.id)})),factions:Object.values(t.factions).map(t=>Object.assign(Object.assign({},t),{regions:o(e,s.GameState.factions.regions,t.id)})),pawns:Object.values(t.pawns).map(t=>{return Object.assign(Object.assign(Object.assign({},t),{hex:e.get(s.GameState.pawns.hex,t.id)}),{count:(i=e.get(s.GameState.pawns.count,t.id),1===i?void 0:i)});var i}),ruleSet:e.get(s.GameState.ruleSet)===r.ruleSets.default?"default":e.get(s.GameState.ruleSet),currentPhase:Object.assign(Object.assign({},t.currentPhase),{tappedUnits:e.get(s.GameState.currentPhase.tappedUnits).keySeq().toArray()})}},t.decompressGameState=function(e){let t={};const i={};t=n.dictionaryOf(e.regions.map(e=>n.omit(e,"hexes")),"id"),e.regions.forEach(e=>{e.hexes.forEach(t=>i[t]=e.id)});let a={};const o={};a=n.dictionaryOf(e.factions.map(e=>n.omit(e,"regions")),"id"),e.factions.forEach(e=>{e.regions.forEach(t=>o[t]=e.id)});let d={};const c={},h={};d=n.dictionaryOf(e.pawns.map(e=>n.omit(e,"hex","count")),"id"),e.pawns.forEach(e=>{c[e.id]=e.hex,h[e.id]=e.count||1});const l=n.omit(e.currentPhase,"tappedUnits");e.pawns.forEach(e=>{c[e.id]=e.hex,h[e.id]=e.count||1});const u="string"==typeof e.ruleSet?r.ruleSets[e.ruleSet]:e.ruleSet;return{grid:e.grid||{width:10,height:10},version:s.CORE_GAMESTATE_SCHEMA_VERSION,ruleSet:u,regions:t,"regions.byHex":i,factions:a,"factions.byRegion":o,pawns:d,"pawns.count":h,"pawns.hex":c,currentPhase:l,"currentPhase.tappedUnits":e.currentPhase.tappedUnits||[]}},t.addIds=function(e){return n.mapDictionary(e,(e,t)=>Object.assign(Object.assign({},e),{id:Number(t)}))},t.compressRuleSet=function(e){return r.ruleSets[e.id]?e.id:e}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefensePriority=void 0;const n=i(111),s=i(16),a=i(3),r=i(45),o=i(13),d=i(17),c=i(12),h=i(21),l=i(14),u=i(2),g=i(67),p=i(68);class f extends n.HexGroupValuationWithHeap{constructor(e,t=new r.UnitSolver(e.rules)){super({bestPlan:void 0,plans:[]},e=>{var t;return-((null===(t=e.bestPlan)||void 0===t?void 0:t.score)||0)}),this.rootModel=e,this.solver=t,this.onChange=s.signal(),this.availableDefenders=[],this.availableWalls=[],this.defenderCost={}}calculateFor(e,t,i=e.hexes){const n=g.timing.start("DefensePriority calculation for region "+e.id);return this.clear(),this.wallPawnTypes=this.rootModel.rules.getAllPawnTypes().filter(e=>e.hasTrait(o.PawnTraits.Wall)&&e.cost>0),this.region=e,this.regionState=t,this.availableDefenders=this.solver.getObtainableUnits(t,0),this.availableWalls=this.wallPawnTypes.filter(e=>e.cost<=t.remainingGold),this.defenderCost={},this.availableDefenders.forEach(e=>{const i=this.solver.gather(Object.assign(Object.assign({},this.regionState),{requiredMight:e,allowOverkill:!1}));u.assert.defined(i,`defender with might ${e} should be available, but I cannot gather it`),this.defenderCost[e]=t.remainingGold-i.remainingGold}),this.attackPriority=new p.OpportunistAttackPriority(this.rootModel).calculateFor(this.region,t.topThreatMight),this.attackPriority.getHexIds(),i.with(...a.getHexes(this.attackPriority.getHexIds()).members).forEach(e=>{this.set(e.id,this._calculateForHex(e))}),n.complete(),this.onChange.fire(),this}_calculateForHex(e){var t;const i=(null===(t=this.rootModel.ai.getHexVulnerability(e))||void 0===t?void 0:t.topThreatMight)||0,n=c.HexGroup.union([e,this.region.hexes.neighboursOf(e)]).map(e=>{var t;const i=(null===(t=this.rootModel.ai.getHexVulnerability(e))||void 0===t?void 0:t.topThreatMight)||0;return i>this.rootModel.units.getHexDefense(e)?i:0}).reduce(d.max,0),s=this.rootModel.regions.byHex(e)===this.region,a={bestPlan:void 0,plans:[]};if(0===n)return a;let r;if(s){const t=this.rootModel.units.getOccupyingUnit(e);r=t&&!this.rootModel.currentPhase.isMovable(t)?[]:this.availableDefenders.filter(e=>e<=n)}else{const t=this.rootModel.units.getHexDefense(e);r=this.availableDefenders.filter(e=>e>t)}const o=this.availableWalls.filter(t=>this.rootModel.units.getDropPawnResult(e,t.type,this.region).type!==h.DropPawnResultType.Invalid);for(let t of r)for(let n of[void 0,...o]){if(n&&this.defenderCost[t]+n.cost>this.regionState.remainingGold)continue;const s=(null==n?void 0:n.defense)||0;let a=this._getHexDefenseFactors(e,t,i,s);l({defenderMight:t,buildWallLevel:s,score:this._getScoreFromFactors(a),factors:a})}if(s)for(let t of o){const n=this._getHexDefenseFactors(e,0,i,t.defense);l({defenderMight:0,buildWallLevel:t.defense,score:this._getScoreFromFactors(n),factors:n})}function l(e){(!a.bestPlan||e.score>a.bestPlan.score)&&(a.bestPlan=e),a.plans.push(e)}return a}_getScoreFromFactors(e){return(e.threatReduction+e.conquestBonus+e.unitProtectionModifier)*e.depthFactor-e.investment}_getHexDefenseFactors(e,t,i,n){var s,a;const r=this.rootModel.regions.byHex(e)!==this.region;let d=this._getDefenseBenefit(e,Math.max(t,n),r);this.region.hexes.neighboursOf(e).forEach(e=>{d+=this._getDefenseBenefit(e,t)});let c=0,h=0,l=t>0?this.rootModel.rules.unitByMight(t):void 0,g=n>0?this.rootModel.rules.wallByMight(n):void 0,p=this.rootModel.pawns.findOne({hexes:e,traits:[o.PawnTraits.Unit]});(null==p?void 0:p.isMovable())&&(p=void 0),l&&(h+=l.cost),g&&(h+=g.cost);const f=this.rootModel.pawns.findOne({hexes:e,traits:[o.PawnTraits.Wall]});if(l&&!f&&!n&&t<i)c-=l.cost;else if(!l&&n&&!f){u.assert.defined(g);let t=0;p&&(t=p.rules.cost),c+=t*((null===(s=this.rootModel.ai.getHexVulnerability(e))||void 0===s?void 0:s.remainingMightTotal)||0)}const m=(11-Math.min((null===(a=this.rootModel.ai.getHexVulnerability(e))||void 0===a?void 0:a.depth)||1,8))/10;return{threatReduction:d,unitProtectionModifier:c,investment:h,conquestBonus:this.attackPriority.get(e.id),depthFactor:m}}_isUnitProtected(e,t,i){return Math.max(e,t)>=i}_getDefenseBenefit(e,t,i=!1){const n=i?0:this.rootModel.units.getHexDefense(e);if(n>t)return 0;const s=this.rootModel.ai.getHexVulnerability(e),a=(null==s?void 0:s.topThreatMight)||0,r=Math.min(n,a),o=Math.min(t,a),d=i?0:this.rootModel.ai.getHexImportance(e);return Math.max(0,o-r)*d}_estimateFutureHexImportance(e){const t=this.region.hexes.neighboursOf(e).members;return t.reduce((e,t)=>e+this.rootModel.ai.getHexImportance(t),0)/t.length}getDebugLayer(){const e=this;return{name:"ai.defensePriority",onChange:e.onChange,getDetail:t=>{const i=e.get(t.id);return i?"plans: (threatRed.+conquest+-protection-investment)\n  "+i.plans.map(m).join("\n  "):""},getMap:t=>e.map(e=>{var t,i;return null!==(i=null===(t=e.bestPlan)||void 0===t?void 0:t.score.toFixed(0))&&void 0!==i?i:""})}}getDepthModifierFor(e){const t=this.rootModel.ai.getHexDepth(e);return t<=2?0:1e3*t}}function m(e){return`${e.defenderMight}🛡${e.buildWallLevel?" +"+e.buildWallLevel+"♖":""}: ${e.factors.threatReduction}+${e.factors.conquestBonus}${l.withSign(e.factors.unitProtectionModifier)}-${e.factors.investment} = ${e.score.toFixed()}`}t.DefensePriority=f},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexGroupValuationWithHeap=void 0;const s=i(40),a=n(i(43));class r extends s.CustomHexGroupValuation{constructor(e,t){super(e),this.rankFn=t,this.clear()}set(e,t){super.set(e,t),this.heap.push({id:e,value:t})}pop(){return this.heap.pop()}peek(){return this.heap.peek()}clear(){super.clear(),this.heap=new a.default((e,t)=>this.rankFn(e.value)-this.rankFn(t.value))}}t.HexGroupValuationWithHeap=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.processPhase=void 0;const n=i(8),s=i(5),a=i(2);t.processPhase=function e(t){switch(t.currentPhase.type){case s.PhaseTypes.GameStart:return t.currentPhase.set(s.PhaseTypes.FactionTurn,1),e(t);case s.PhaseTypes.FactionTurn:const i=t.currentPhase.faction;return a.assert.defined(i),function(e,t){const i=[];return t.getRegions().forEach(t=>{a.assert.defined(t);const n=function(e,t){return e.economy.advanceEconomyOf(t)}(e,t);(n.unitsTurnedBandits.length>0||Object.keys(n.coinTransfers).length>0)&&i.push(n)}),[n.GameEvents.FactionEconomyUpdated({factionId:t.id,regionReports:i})]}(t,i);default:return[]}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TypedEventBus=void 0;const n=i(6),s=i(1).logger.for("TypedEventBus");class a{constructor(e){this.parent=e,this.handlers={}}on(e,t){n.pushIntoArrayByKey(this.handlers,e.eventName,t);const i=this.on.bind(this),s=this.handlers;return{unsubscribe(){n.removeFromArrayInPlace(s[e.eventName],t)},on:i}}trigger(e){let t=!1,i=!1;for(let n of this.handlers[e.name]||[])if(i=!0,n(e.payload,()=>t=!0),t)return;t=!1,this.defaultHandler&&(this.defaultHandler(e,()=>t=!0),i=!0),t||(this.parent?this.parent.trigger(e):i||s.warning(`No handler currently registered for event ${e.name} - ignoring.`))}setDefaultHandler(e){this.defaultHandler=e}createChild(){return new a(this)}}t.TypedEventBus=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DistanceMap=void 0;const n=i(40),s=i(2);class a extends n.CustomHexGroupValuation{constructor(e){super(1/0),this.hexes=e}addSources(e){s.assert(e.members.every(e=>this.hexes.has(e))),this.hexes.bfsFrom(e,(e,t,i)=>(this.get(e.id)>i||0===i)&&(this.set(e.id,i),!0))}getDistanceTo(e){return this.get(e.id)}getMostDistantHex(){return this.hexes.findMax(e=>this.getDistanceTo(e))}dump(){return this.hexes.map(e=>`${e} = ${this.getDistanceTo(e)}`).join("\n")}}t.DistanceMap=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.saveGame=t.SAVE_GAME_LOCAL_STORAGE_PREFIX=void 0;const n=i(1),s=i(109),a=i(0),r=i(9);t.SAVE_GAME_LOCAL_STORAGE_PREFIX=`konkr.savedGame.v${r.CORE_GAMESTATE_SCHEMA_VERSION}.`,t.saveGame=function(e,i=JSON.stringify(s.compressGameState(a.inject.gameStateModel.stateEngine))){localStorage.setItem(t.SAVE_GAME_LOCAL_STORAGE_PREFIX+e,i),n.logger.for("saveGame").info(`Current games state saved into local storage as "${e}"`)}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createExposedHexesDebugLayer=t.createHexIdDebugLayer=t.registerConsoleCommands=t.commands=void 0;const s=i(0),a=i(8),r=i(9),o=i(117),d=i(92),c=i(5),h=i(16),l=i(105),u=i(104),g=i(40),p=i(2),f=i(28),m=n(i(77)),y=i(4),w=i(120),v=i(66);function b(e,t){return["object"==typeof e?e.id:e,"object"==typeof t?t.id:t]}t.commands={game:{new:(e={})=>{const t=Object.assign(Object.assign({},d.DEFAULT_NEW_GAME_OPTIONS),e);s.inject.rootController.events.trigger(a.UserActions.StartNewGame(t))},save:(e="auto")=>{s.inject.rootController.events.trigger(a.UserActions.SaveGame(e))},resume:()=>{s.inject.events.trigger(a.UserActions.ResumeGame())},load:(e="auto")=>{s.inject.rootController.events.trigger(a.UserActions.LoadGame(e))},revertTurn:()=>{s.inject.events.trigger(a.UserActions.RevertTurn())},endTurn:()=>{s.inject.gameStateController.executePlay(a.Plays.EndTurn())},setFaction:(e,t)=>{s.inject.gameStateModel.stateEngine.apply(r.GameState.factions.byId.createMutation({set:{[e]:Object.assign(Object.assign({},s.inject.gameStateModel.stateEngine.get(r.GameState.factions.byId,e)),{controller:t})}},"command"))},takeOver(e){s.inject.gameStateModel.stateEngine.apply(r.GameState.factions.byId.createMutation({set:{[e]:Object.assign(Object.assign({},s.inject.gameStateModel.stateEngine.get(r.GameState.factions.byId,e)),{controller:c.FactionController.LocalUser})}},"command"))},sync:()=>{s.inject.events.trigger(a.UserActions.SyncWithModel())},get state(){return s.inject.gameStateModel.stateEngine.serialize()},get rawState(){return s.inject.gameStateModel.stateEngine.currentState},get stateModel(){return s.inject.gameStateModel}},debug:{off(){const e=s.inject.config.debug;e.tweenSpeedFactor=1,e.overlay=!1,e.recordGame=!1,e.protectStateIntegrity=!1,e.skipTransitions=!1,e.ai=!1,s.inject.gameStateRecorder.stop(),s.inject.debugLayers.activate(void 0)},on(){s.inject.config.debug.overlay=!0},logs(e){m.default.enable(e)},borders(){s.inject.debugLayers.activate("TileBordersManager")},layer(e){p.assert(s.inject.debugLayers.get(e),"unknown debug layer "+e),s.inject.debugLayers.activate(e)},dataSet(e){const t=s.inject.gameStateModel.stateEngine.getDataSetByKey(e);if(!t)throw new Error(`No dataset found for key "${e}"`);if(!s.inject.debugLayers.get(e)){let e=function(e,t){let i=h.signal();return e.watchDataSet(t,()=>{i.fire()}),{name:t.key,onChange:i,getMap:i=>new u.ProxyHexGroupValuation(new l.HexGroupValuationFromStateEngine(e,t),e=>t.entryToString(e)),getArrows(){let i=[];return e.get(t).forEach((e,t)=>{e.parent?i.push(b(e.parent,t)):e.parents?e.parents.forEach(e=>{i.push(b(e,t))}):e.children&&e.children.forEach(e=>{i.push(b(t,e))})}),i},getDetail(i){const n=e.get(t,i.id);return n?t.entryToDebugString(n):"undefined"}}}(s.inject.gameStateModel.stateEngine,t);s.inject.debugLayers.register(e)}s.inject.debugLayers.activate(e)},regionDataSet(e){const t=s.inject.gameStateModel.stateEngine.getDataSetByKey(e);if(!t)throw new Error(`No dataset found for key "${e}"`);if(!s.inject.debugLayers.get(e)){let e=function(e,t){let i=h.signal();return e.watchDataSet(t,()=>{i.fire()}),{name:t.key,onChange:i,getMap(i){let n=new g.CustomHexGroupValuation("");return s.inject.gameStateModel.regions.all().filter(e=>e.isAlive()).forEach(i=>{f.Economy.getTownHexesByRegion(e.currentState,i.id).forEach(s=>{const a=e.get(t,i.id);a&&n.set(s,t.entryToString(a))})}),n},getDetail(i){const n=s.inject.gameStateModel.regions.byHex(i);if(!n)return"";const a=e.get(t,n.id);return a?`[region ${n.id}]\n${t.entryToDebugString(a)}`:`[region ${n.id}] undefined`}}}(s.inject.gameStateModel.stateEngine,t);s.inject.debugLayers.register(e)}s.inject.debugLayers.activate(e)},opportunistAttackPriority(e,t=4){const i=s.inject.gameStateModel.regions.byId(e);p.assert.defined(i);const n=s.inject.gameStateModel.ai.calculateOpportunistAttackPriority(i,t);s.inject.debugLayers.registerAndActivate(n.getDebugLayer())},hexImportance(e=!1){s.inject.debugLayers.activate("ai.hexImportance")},exposedHexes(){s.inject.debugLayers.activate("ai.exposedHexes")},defensePriority(e){const t=s.inject.gameStateModel.regions.byId(e);p.assert.defined(t);const i=s.inject.gameStateModel.ai.calculateDefensePriority(t);s.inject.debugLayers.registerAndActivate(i.getDebugLayer())},hexDepth(){s.inject.debugLayers.activate("ai.hexDepth")},hexIds(){s.inject.debugLayers.activate("hexIds")},borderHexes(){s.inject.debugLayers.activate("ai.borderHexes")}},get rec(){return s.inject.gameStateRecorder},get config(){return s.inject.config},get ui(){return s.inject.uiState},edit:{factions(e){s.inject.events.trigger(a.UserActions.EditMap()),s.inject.events.trigger(o.MapEditorActions.SetInputMode(o.MapEditorInputMode.PaintFaction)),e&&s.inject.events.trigger(o.MapEditorActions.SetPaintedFactionId(e))},pawn(e){s.inject.events.trigger(a.UserActions.EditMap()),s.inject.events.trigger(o.MapEditorActions.SetInputMode(o.MapEditorInputMode.PaintPawns)),e&&s.inject.events.trigger(o.MapEditorActions.SetPaintedPawnType(e))},deletePawns(){s.inject.events.trigger(a.UserActions.EditMap()),s.inject.events.trigger(o.MapEditorActions.SetInputMode(o.MapEditorInputMode.DeletePawns))},setFactionColor:(e,t)=>{const i=s.inject.gameStateModel.factions.byId(e);p.assert.defined(i,"Invalid faction id "+e),i.setLandColor(t),s.inject.events.trigger(a.UserActions.SyncWithModel())}}},t.registerConsoleCommands=function(){const e=t.commands,i=window;i.commands=e,i.game=e.game,i.debug=e.debug,i.rec=e.rec,i.config=e.config,i.edit=e.edit,i.ui=e.ui,i.inject=s.inject,i.GameState=r.GameState},t.createHexIdDebugLayer=function(){let e=h.signal();const t=s.inject.gameStateModel;return t.stateEngine.watchDataSet(r.GameState.grid,()=>{e.fire()}),{name:"hexIds",onChange:e,getMap(e){let i=new g.CustomHexGroupValuation("");const n=y.selectFromState(t.stateEngine.currentState,r.GameState.regions.byHex).map((e,t)=>t).toJS();return i.importDictionary(n),i},getDetail:e=>e.id.toString()}},t.createExposedHexesDebugLayer=function(){let e=h.signal();const t=s.inject.gameStateModel;return t.stateEngine.watchDataSet(r.GameState.ai.hexVulnerability,()=>{e.fire()}),t.stateEngine.watchDataSet(r.GameState.ai.hexImportance,()=>{e.fire()}),{name:"ai.exposedHexes",onChange:e,getMap(e){let i=new g.CustomHexGroupValuation("");return t.regions.all().forEach(e=>{t.ai.getExposedHexes(e,w.KEY_HEX_IMPORTANCE_TRESHOLD).forEach(e=>i.set(e.id,"🚩"+t.ai.getHexImportance(e)))}),i},getDetail(e){const i=t.ai.getHexVulnerability(e)||v.NO_VULNERABILITY;return`importance: ${t.ai.getHexImportance(e)}\nvulnerability: \n${r.GameState.ai.hexVulnerability.entryToDebugString(i)}`}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapEditorScene=t.MapEditorInputMode=t.MapEditorActions=t.editorAction=void 0;const n=i(52),s=i(27),a=i(0),r=i(1),o=i(19),d=i(6),c=i(55),h=i(35),l=i(5),u=i(3);function g(e){return h.createEventFactory(h.EventCategory.MapEditor,e)}var p;t.editorAction=g,t.MapEditorActions={SetInputMode:g("SET_INPUT_MODE"),SetPaintedFactionId:g("SET_PAINTED_FACTION_ID"),SetPaintedPawnType:g("SET_PAINTED_PAWN_TYPE")},function(e){e.PaintFaction="pain-faction",e.PaintPawns="paint-pawns",e.DeletePawns="delete-objects",e.DeleteTiles="delete-tiles",e.AddCoins="add-coins",e.RemoveCoins="remove-coins"}(p=t.MapEditorInputMode||(t.MapEditorInputMode={}));const f=r.logger.for(s.Scenes.MapEditor);class m extends c.BaseScene{constructor(){super({key:s.Scenes.MapEditor,subScenes:[s.Scenes.WorldMap]}),this.inputMode=p.PaintFaction,this.paintFactionId=1,this.paintPawnType=l.PawnType.Town,this.handleEventWhileActive(n.WorldMapEvents.PointerDown,({hexId:e})=>{if(!this.scene.isActive()||!e)return;const t=u.getHex(e);t&&this.handleHexClicked(t)}),a.inject.events.on(t.MapEditorActions.SetInputMode,e=>{this.inputMode=e}),a.inject.events.on(t.MapEditorActions.SetPaintedFactionId,e=>{this.paintFactionId=e}),a.inject.events.on(t.MapEditorActions.SetPaintedPawnType,e=>{this.paintPawnType=e})}handleHexClicked(e){switch(this.inputMode){case p.PaintFaction:return this.paintFaction(e);case p.PaintPawns:return this.paintPawns(e);case p.DeleteTiles:return this.deleteTile(e);case p.DeletePawns:return this.deletePawns(e);default:f.warning(`Ignoring hex click event in mode "${this.inputMode}"`)}}setMode(e){this.inputMode=e,a.inject.debugData.set("UI",`[${e}${this.getInputModeDetails(e)}]`)}create(){this.worldMapScene=this.scene.get(s.Scenes.WorldMap),super.create()}getInputModeDetails(e){switch(e){case p.PaintPawns:return`(${this.paintPawnType})`;case p.PaintFaction:return`(${this.paintFactionId})`;default:return""}}paintFaction(e){var t;const i=a.inject.gameStateModel;let n=e.neighbours().map(e=>({region:i.regions.byHex(e),faction:i.factions.byHex(e)})).filter(({region:e,faction:t})=>(null==t?void 0:t.id)===this.paintFactionId).map(({region:e,faction:t})=>e);n=d.stripDuplicatesFrom(n);let s=n.pop();s||(s=i.regions.create("kingdom",e),null===(t=i.factions.byId(this.paintFactionId))||void 0===t||t.captureRegions(s)),s.addHexes(e),n.length>0&&s.absorbRegions(n),this.updateWorld()}deleteTile(e){a.inject.gameStateModel.regions.byHex(e).removeHexes(e),this.updateWorld()}paintPawns(e){a.inject.gameStateModel.pawns.adjustCount(e,this.paintPawnType,1),this.updateWorld()}deletePawns(e){const t=a.inject.gameStateModel;t.pawns.destroy(...t.pawns.byHex(e)),this.updateWorld()}updateWorld(){a.inject.uiState.with({transitionsMode:o.TransitionsMode.Disabled},()=>{this.worldMapScene.loadNewGameState(a.inject.gameStateModel.state)})}}t.MapEditorScene=m},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jump2=t.jump=void 0,t.jump=function(e,t){return e-Math.sin(e*Math.PI)*-t},t.jump2=function(e){return Math.sin(e*Math.PI)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TileBorders=void 0;const n=i(216),s=i(217),a=i(218),r=i(24),o=i(219);t.TileBorders={plain:new a.TileBorderFactory({name:"plain",recipe:n.build2dInnerBorderRecipe(1),textures:{horizontal:"borders/plain-h",vertical:"borders/plain-v"},baseDepth:r.WorldLayers.TileBorders}),highlight:new a.TileBorderFactory({name:"highlight",recipe:n.build2dInnerBorderRecipe(4),textures:{horizontal:"hex-inner-border-h",vertical:"hex-inner-border-v"},baseDepth:r.WorldLayers.TileHighlight}),palisade:new a.TileBorderFactory({name:"palisade",recipe:s.palisadeRecipe,textures:{horizontal:"borders/wall-1-solid-h",vertical:"borders/wall-1-solid-v",corner:"borders/wall-1-tower"},baseDepth:r.WorldLayers.TileObjects}),palisadeGate:new a.TileBorderFactory({name:"palisadeGate",recipe:s.palisadeRecipe,textures:{horizontal:"borders/wall-1-gate-h",vertical:"borders/wall-1-gate-v",corner:"borders/wall-1-tower"},baseDepth:r.WorldLayers.TileObjects}),stoneWall:new a.TileBorderFactory({name:"stoneWall",recipe:o.stoneWallRecipe,textures:{horizontal:"borders/wall-2-solid-h",vertical:"borders/wall-2-solid-v",corner:"borders/wall-2-tower"},baseDepth:r.WorldLayers.TileObjects})}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.printSummary=t.protectHexes=t.KEY_HEX_IMPORTANCE_TRESHOLD=void 0;const s=i(1),a=i(110),r=i(3);s.logger.for("ai:tactics");t.KEY_HEX_IMPORTANCE_TRESHOLD=50;t.protectHexes=e=>n(void 0,void 0,void 0,(function*(){const i=e.game.model.ai.getExposedHexes(e.region,t.KEY_HEX_IMPORTANCE_TRESHOLD/2),n=new a.DefensePriority(e.game.model,e.unitSolver),s=i.with(...i.neighbours().filter(t=>e.game.model.regions.byHex(t)===e.region).members);n.calculateFor(e.region,e.region.might,s);const o=n.pop(),d=null==o?void 0:o.value.bestPlan;return!(!o||!d)&&(e.marshal.executeDefensePlan(r.getHex(o.id),d,d.score),!0)})),t.printSummary=function(e,t,i){return`[protectHexes (region ${e.region.id})]\n  Exposed hexes: [${t}] Available defenders: ${e.region.might.remainingUnits}\n  Defense plan: ${function(e){const t=null==e?void 0:e.value.bestPlan;if(!e||!t)return"N/A";const i=t.defenderMight?t.defenderMight+"💂":"",n=t.buildWallLevel?t.buildWallLevel+"🏰":"";return`${i}${n} -> ⬡${e.id}`}(i)}`}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.slideOut=t.slideIn=t.DesktopTurnControls=t.CompactTurnControls=void 0;const n=i(16),s=i(122),a=i(0),r=i(19);var o=Phaser.GameObjects.Layer;const d=i(46);t.CompactTurnControls=class extends o{constructor(e){super(e),this.onTurnClicked=n.signal(),this.onUndoClicked=n.signal(),this.targetVisibility=!0,this.undoButton=new s.Button(this.scene,0,0,{frame:"ui/compact/btn-undo",down:!0,disabled:!0},()=>{this.onUndoClicked.fire()}),this.nextTurnButton=new s.Button(this.scene,0,0,{frame:"ui/compact/btn-turn",down:!0},()=>{this.onTurnClicked.fire()}),this.add(this.undoButton),this.add(this.nextTurnButton),this.scene.scale.on("resize",this.reflow,this),this.reflow()}setUndoEnabled(e){this.undoButton.setEnabled(e)}reflow(){this.setVisible(this.targetVisibility);const e=this.scene.cameras.main.displayHeight,t=this.scene.cameras.main.displayWidth-this.nextTurnButton.width+2;this.visible?(this.undoButton.setPosition(-2,e-this.undoButton.height),this.nextTurnButton.setPosition(t,e-this.nextTurnButton.height)):(this.undoButton.setPosition(-2,e),this.nextTurnButton.setPosition(t,e))}show(){this.targetVisibility||(this.targetVisibility=!0,this.setVisible(!0),a.inject.uiState.transitionsMode===r.TransitionsMode.Disabled?(this.setVisible(!0),this.reflow()):this.slideButtonsIn())}hide(){this.targetVisibility&&(this.targetVisibility=!1,a.inject.uiState.transitionsMode===r.TransitionsMode.Disabled?(this.setVisible(!1),this.reflow()):this.slideButtonsOut())}slideButtonsIn(){c(this.scene,[this.nextTurnButton,this.undoButton],this.nextTurnButton.height).then(()=>this.setVisible(this.targetVisibility))}slideButtonsOut(){h(this.scene,[this.nextTurnButton,this.undoButton]).then(()=>this.setVisible(this.targetVisibility))}};function c(e,t,i=0){return new Promise(n=>{t.map(e=>e.setVisible(!0)),e.tweens.add({targets:t,y:e.cameras.main.displayHeight-i,ease:"Sine.easeOut",duration:d.PLAY_UI_LAYOUT.toggleBoardTweenDuration,onComplete:n})})}function h(e,t){return new Promise(i=>{e.tweens.add({targets:t,y:e.cameras.main.displayHeight+40,ease:"Sine.easeOut",duration:d.PLAY_UI_LAYOUT.toggleBoardTweenDuration,onComplete:i})})}t.DesktopTurnControls=class extends o{constructor(e){super(e),this.onTurnClicked=n.signal(),this.onUndoClicked=n.signal(),this.targetVisibility=!0,this.undoButton=new s.Button(this.scene,0,0,{frame:"ui/btn-undo",down:!0,disabled:!0},()=>{this.onUndoClicked.fire()}),this.nextTurnButton=new s.Button(this.scene,0,0,{frame:"ui/btn-turn",down:!0},()=>{this.onTurnClicked.fire()}),this.add(this.undoButton),this.add(this.nextTurnButton),this.scene.scale.on("resize",this.reflow,this),this.reflow()}setUndoEnabled(e){this.undoButton.setEnabled(e)}reflow(){const e=this.scene.cameras.main.displayHeight,t=this.scene.cameras.main.displayWidth,i=t/2-d.PLAY_UI_LAYOUT.desktop.deskWidth/2,n=t/2+d.PLAY_UI_LAYOUT.desktop.deskWidth/2-this.nextTurnButton.width;this.visible?(this.undoButton.setPosition(i,e-d.PLAY_UI_LAYOUT.desktop.offsetFromBottom),this.nextTurnButton.setPosition(n,e-d.PLAY_UI_LAYOUT.desktop.offsetFromBottom)):(this.undoButton.setPosition(i,e),this.nextTurnButton.setPosition(n,e))}show(){this.targetVisibility||(this.targetVisibility=!0,this.setVisible(!0),a.inject.uiState.transitionsMode===r.TransitionsMode.Disabled?(this.setVisible(!0),this.reflow()):this.slideButtonsIn())}hide(){this.targetVisibility&&(this.targetVisibility=!1,a.inject.uiState.transitionsMode===r.TransitionsMode.Disabled?(this.setVisible(!1),this.reflow()):this.slideButtonsOut())}slideButtonsIn(){c(this.scene,[this.nextTurnButton,this.undoButton],d.PLAY_UI_LAYOUT.desktop.offsetFromBottom).then(()=>this.setVisible(this.targetVisibility))}slideButtonsOut(){h(this.scene,[this.nextTurnButton,this.undoButton]).then(()=>this.setVisible(this.targetVisibility))}},t.slideIn=c,t.slideOut=h},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Button=t.ButtonState=void 0;const n=i(0);var s=Phaser.GameObjects.Sprite;const a=i(29);var r;!function(e){e[e.Rest=0]="Rest",e[e.Hover=1]="Hover",e[e.Down=2]="Down"}(r=t.ButtonState||(t.ButtonState={}));t.Button=class extends s{constructor(e,t,i,s,o){super(e,t,i,"atlas",s.frame),this.config=s,this.enabled=!0,this.state=r.Rest,this.setInteractive({useHandCursor:!0}).on("pointerover",()=>this.setButtonState(r.Hover)).on("pointerout",()=>this.setButtonState(r.Rest)).on("pointerdown",()=>this.setButtonState(r.Down)).on("pointerup",()=>{this.setButtonState(r.Hover),this.enabled?o():n.inject.audio.playEffect(a.SoundEffects.Deny)})}setButtonState(e){this.state=e,this.updateFrame()}updateFrame(){if(this.enabled)switch(this.state){case r.Rest:this.setFrame(this.config.frame);break;case r.Hover:this.setFrame(this.config.frame+(this.config.hover?"-hover":""));break;case r.Down:this.setFrame(this.config.frame+(this.config.down?"-down":"")),n.inject.audio.playEffect(a.SoundEffects.Click)}else this.setFrame(this.config.frame+(this.config.disabled?"-disabled":""))}setEnabled(e){this.enabled=e,this.updateFrame()}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateHighlightWhileMovingPawn=t.MovingPawnMode=void 0;const n=i(50),s=i(0),a=i(8),r=i(56),o=i(41),d=i(1),c=i(21),h=i(13),l=i(12),u=i(29),g=i(2),p=d.logger.for("MovingPawnMode");class f extends o.BaseMode{constructor(e,t){super(e),this.movingPawn=t}activate(){const e=this.movingPawn.hex,t=this.scene.worldMapScene.getPawnObjectPositionOnScreen(e.id);this.scene.uiScene.pawnHolder.pickUpPawn(this.movingPawn.type,t.x,t.y,t.scale),this.scene.worldMapScene.pawns.hide(e.id),this.scene.worldMapScene.showHexDefenseMarkers(this.movingPawn);const i=s.inject.worldUi.selectedRegion();g.assert.defined(i),this.scene.showConquerableHexesBasedOn(this.movingPawn.type),s.inject.config.debug.ai&&s.inject.worldUi.selectedRegion()&&window.debug.opportunistAttackPriority(s.inject.worldUi.selectedRegion().id,this.movingPawn.might)}deactivate(){super.deactivate(),this.scene.pointerEventsController.abortPawnDrag(),this.scene.worldMapScene.hideHexDefenseMarkers(),this.scene.uiScene.pawnHolder.clear()}canDropPawn(e){const t=this.movingPawn.region,i=s.inject.gameStateModel.units.getDropPawnResult(e,this.movingPawn.type,t);return i.type!==c.DropPawnResultType.Invalid||i.reason===c.InvalidDropPawnReason.PreventedByPawn}handleReturnPawn(){const e=this.movingPawn;g.assert.defined(e),this.scene.dropHeldPawnAtHex(e.hex.id).then(()=>{this.scene.worldMapScene.pawns.show(e.hex.id)}),this.scene.setMode(new r.PlayMode(this.scene))}handleDropPawn(e){const t=this.movingPawn,i=this.movingPawn.region;if(g.assert.defined(t),g.assert.defined(i),t.hex===e)return this.handleReturnPawn(),!0;{const n=s.inject.gameStateModel.units.getDropPawnResult(e,this.movingPawn.type,i);switch(n.type){case c.DropPawnResultType.Reposition:case c.DropPawnResultType.EradicatePest:case c.DropPawnResultType.Combine:return this.scene.dropHeldPawnAtHex(e.id).then(()=>{s.inject.gameStateController.executePlay(a.Plays.MovePawn({pawnId:t.id,destinationHexId:e.id}))}),this.scene.setMode(new r.PlayMode(this.scene)),s.inject.audio.playEffect(u.SoundEffects.Drop),!0;case c.DropPawnResultType.Conquest:return s.inject.audio.playEffect(u.SoundEffects.Drop),s.inject.gameStateController.executePlay(a.Plays.AttackHex({pawnId:t.id,destinationHexId:e.id})),!0;case c.DropPawnResultType.Invalid:return s.inject.audio.playEffect(u.SoundEffects.Deny),n.reason===c.InvalidDropPawnReason.PreventedByPawn&&this.scene.worldMapScene.cinematics.tileDefense(e,n.blockers).play(),!1}}}handleHexCaptured(e){this.movingPawn.id===e.capturingPawnId?(this.scene.dropHeldPawnAtHex(e.capturedHexId).then(()=>{g.assert.defined(e.sourceHexId),this.scene.worldMapScene.pawns.move(e.sourceHexId,e.capturedHexId),this.scene.worldMapScene.pawns.stopJumping([e.capturedHexId]),this.scene.worldMapScene.pawns.show(e.capturedHexId)}),this.scene.setMode(new r.PlayMode(this.scene))):p.warning(`ignoring hexCaptured as the capturing pawn ${e.capturingPawnId} doesn't match the currently held pawn ${this.movingPawn}`)}shouldHighlightHoveredHex(e){return!1}handleDropPawnOnShop(e){const t=s.inject.gameStateModel,i=t.rules.pawns(this.movingPawn.type).mergeRules[e],n=this.movingPawn.hex;return i?(this.scene.uiScene.pawnHolder.setPawnType(i),this.scene.showConquerableHexesBasedOn(i),s.inject.audio.playEffect(u.SoundEffects.Drop),s.inject.gameStateController.executePlay(a.Plays.BuyPawn({pawnType:e,buyerRegionId:this.movingPawn.region.id,destinationHexId:this.movingPawn.hex.id})),this.movingPawn=t.units.getOccupyingUnit(n),!1):(s.inject.audio.playEffect(u.SoundEffects.Deny),!1)}handleNewHexUnderCursor(e){m(this.scene,e,this.movingPawn,this.movingPawn.region)}}function m(e,t,i,a){var r;if(t&&(null===(r=e.conquerableHexes)||void 0===r?void 0:r.contains(t))?e.worldMapScene.conquerableHexesHighlight.setHighlightedHex(t):e.worldMapScene.conquerableHexesHighlight.clearHighlightedHex(),t){let r,o;i instanceof n.PawnModel?(r=i,o=r.type):o=i;const d=s.inject.gameStateModel;g.assert.defined(a);const u=d.units.getDropPawnResult(t,o,a),p=d.rules.pawns(o).hasTrait(h.PawnTraits.GuardsAdjacentTiles);let f=l.HexGroup.empty;p&&(f=a.hexes.neighboursOf(t).filter(e=>!d.units.isOccupied(e)||e===(null==r?void 0:r.hex))),t==(null==r?void 0:r.hex)||u.type===c.DropPawnResultType.Reposition||u.type===c.DropPawnResultType.Conquest?e.worldMapScene.hexMarkers.setHoveredHex(t,d.rules.pawns(o).defense,f):e.worldMapScene.hexMarkers.clearHoveredHex()}else e.worldMapScene.hexMarkers.clearHoveredHex()}t.MovingPawnMode=f,t.updateHighlightWhileMovingPawn=m},function(e,t,i){e.exports=i(125)},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),i(75);const s=i(0),a=n(i(235)),r=i(1),o=i(52),d=i(236),c=i(251),h=i(116),l=i(117),u=i(46),g={type:Phaser.WEBGL,backgroundColor:"#9bd6f2",debug:!0,scale:{parent:"phaser-game",mode:Phaser.Scale.RESIZE,autoCenter:Phaser.Scale.CENTER_BOTH},scene:[a.default,o.WorldMapScene,d.PlayScene,l.MapEditorScene,u.PlayUIScene,c.DebugScene],pixelArt:(p=window.devicePixelRatio||1,Math.floor(p)===p)};var p;console.info("⚔ Konkr.io  TEST production build 1 (master)"),window.addEventListener("load",()=>{r.logger.addTransport("console",new r.ConsoleLogger),r.logger.for("game").info("starting");const e=new Phaser.Game(g);s.setupInjectionContainer(e),h.registerConsoleCommands(),s.inject.versionManager.start(),s.inject.rootController.run()})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createRandomGenerator=void 0,t.createRandomGenerator=function(e){let t;function i(i=Math.floor(1e5*Math.random())){e=i,t=i}function n(){var t=1e4*Math.sin(e++);return t-Math.floor(t)}function s(e,t){return Math.floor(n()*(t-e+1))+e}return i(e),{reset:i,number:n,oneOf:function(e){return e[s(0,e.length-1)]},popFrom:function(e){return e.splice(s(0,e.length-1),1)[0]},hex:function(e){return e.members[s(0,e.length-1)]},property:function(e){var t,i=0;for(var s in e)n()<1/++i&&(t=s);return t},integer:s,shuffle:function(e){let t,i,n=[...e],s=n.length;for(;0!==s;)i=Math.floor(Math.random()*s),s-=1,t=n[s],n[s]=n[i],n[i]=t;return n}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.configProfiles=void 0,t.configProfiles={dev:{debug:{ai:!1,cheats:!0,overlay:!0,chunkBorders:!1,recordGame:!1,protectStateIntegrity:!1,tweenSpeedFactor:1,skipTransitions:!1},autoSaveOnTurnStart:!0,autoSaveOnTurnEnd:!0,useServiceWorker:!1,flags:{}},production:{debug:{ai:!1,cheats:!1,overlay:!1,chunkBorders:!1,recordGame:!1,protectStateIntegrity:!1,tweenSpeedFactor:1,skipTransitions:!1},autoSaveOnTurnStart:!0,autoSaveOnTurnEnd:!0,useServiceWorker:!0,flags:{}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameStateRecorder=void 0;const n=i(76),s=i(0),a=i(1),r=i(8),o=i(14),d=a.logger.for("StateRecorder");t.GameStateRecorder=class{constructor(){this.capacity=1e3,this.data=new n.FixedCapacityArray(1e3),this.currentFrame=0}isRecording(){return!!this.sub}start(){this.stop(),this.sub=s.inject.gameStateModel.onNewState(e=>this.data.push(e)),this.data=new n.FixedCapacityArray(this.capacity),d.info(`⏺️ GameState recording started! (will capture up to ${this.capacity} frames)`)}stop(){this.sub&&(this.sub.unsubscribe(),d.info(`⏹️ Stopped Recording. ${this.data.getItems().length} frames captured.`)),this.replayTimer&&(clearInterval(this.replayTimer),d.info(`⏹ Stopped replay at frame ${this.currentFrame}/${this.length()}`))}goto(e){if(e<0||e>this.length()-1)throw new Error("Frame out of range - available frames are 0 - "+(this.length()-1));this.currentFrame=e,s.inject.events.trigger(r.UserActions.DebugGameState(this.data.get(this.currentFrame))),d.info(`now at frame ${e}/${this.length()-1}`)}step(e=1){this.goto(this.currentFrame+e)}replay(e=0,t=500,i=1){this.stop(),this.goto(e),this.replayTimer=setInterval(()=>{this.step(i),this.currentFrame>=this.length()-1&&this.stop()},t)}last(){this.goto(this.length()-1)}save(e="default"){localStorage.setItem("recording-"+e,o.compressStr(JSON.stringify(this.data.getItems()))),d.info(`Saved recording to local storage as "${e}"`)}load(e="default"){this.stop();const t=o.decompressStr(localStorage.getItem("recording-"+e)),i=JSON.parse(t);if(!Array.isArray(i))throw new Error("recording invalid (not an array)");this.data=new n.FixedCapacityArray(i),d.info(`Loaded recording from "${e}"`),this.rewind()}length(){return this.data.length}rewind(){this.stop(),this.goto(0)}}},,,,,,,,function(e,t){},,function(e,t){},,,,,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugData=void 0;t.DebugData=class{constructor(){this.items={}}set(e,t){this.items[e]=t}get(e){return this.items[e]}clear(e){delete this.items[e]}getText(){return Object.entries(this.items).map(([e,t])=>`${e}: ${t}`).join("\n")}}},,,,,,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(12),s=i(2);t.default=class{constructor(){this.groups={},this.membership={},this._length=0}get length(){return this._length}addToGroup(e,...t){this.groups[e]?t.forEach(t=>this.groups[e].add(t)):this.groups[e]=new Set(t),t.forEach(t=>{const i=this.membership[t.id];void 0===i?(this.membership[t.id]=e,++this._length):i!==e&&(this.groups[i].delete(t),this.membership[t.id]=e)})}getOwnerOf(e){return this.membership[e.id]}removeGroup(e){s.assert.defined(this.groups[e]),this.groups[e].forEach(e=>delete this.membership[e.id]),this._length-=this.groups[e].size,delete this.groups[e]}forEach(e){for(const t in this.groups)e(n.HexGroup.from(Array.from(this.groups[t])),t)}map(e){let t=[];return this.forEach((i,n)=>t.push(e(i,n))),t}getLargestGroup(){const e=this.getLargestGroupKey();if(void 0!==e)return n.HexGroup.from(Array.from(this.groups[e]))}getLargestGroupKey(){let e=0,t=void 0,i=void 0;return this.forEach((n,s)=>{n.length>e&&(e=n.length,t=n,i=s)}),i}popLargestGroup(){const e=this.getLargestGroupKey();if(e){const t=this.groups[e];return this.removeGroup(e),n.HexGroup.from(Array.from(t))}throw new Error("Attempt to pop() from empty log groups collection")}getGroups(){return Object.values(this.groups).map(e=>n.HexGroup.from(Array.from(e)))}toString(){let e=0,t=Object.keys(this.groups).map(t=>{const i=this.groups[t].size;return e+=i,`${t}(${i})`}).join(", ");return`[HexGroupSet (${e}): ${t}]`}}},,function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameStateController=void 0;const n=i(35),s=i(16),a=i(154),r=i(8),o=i(1),d=i(14),c=i(38),h=i(112),l=i(186),u=i(187),g=i(76),p=i(0),f=i(69),m=i(188),y=i(5),w=i(2),v=i(67),b=o.logger.for("GameStateController");t.GameStateController=class{constructor(){this.actionHandlers={},this.onEvent=s.signal(),this.history=new g.FixedCapacityArray(20),this.eventsPaused=!1,this.scheduledEvents=[],this.model=new c.GameStateModel,this.on(r.Plays.EndTurn,e=>(this.lastTurnState=e.stateEngine.currentState,m.handleEndTurn(e))).on(r.Plays.MovePawn,l.handleMovePawn).on(r.Plays.BuyPawn,u.handleBuyPawn).on(r.Plays.AttackHex,f.handleAttackHex)}on(e,t){return w.assert(void 0===this.actionHandlers[e.eventName],`a handler is already assigned to event type ${e.eventName}!`),this.actionHandlers[e.eventName]=t,this}getEventQueue(){const e=new a.EventQueue;return e.addSource(this.onEvent),e}loadState(e,t){this.model.restore(e),this.model.activateAllProjections(),this.fireEvent(r.GameEvents.NewGameState({state:this.model.state,context:t})),this.scheduledEvents=[],this.model.currentPhase.is(y.PhaseTypes.GameStart)&&h.processPhase(this.model).forEach(e=>this.fireEvent(e))}undo(){0!==this.history.length?(this.loadState(this.history.pop(),r.NewGameStateContext.Undo),0===this.history.length&&p.inject.worldUi.undoAvailable.set(!1)):b.error("Unable to undo - history is empty")}beginTransaction(){this.eventsPaused=!0}commitTransaction(){this.eventsPaused=!1,this.scheduledEvents.forEach(e=>this.fireEvent(e)),this.scheduledEvents=[]}createCheckpoint(){return{state:this.currentState,events:[...this.scheduledEvents]}}restoreCheckpoint(e){this.model.restore(e.state),this.scheduledEvents=e.events,p.inject.config.debug.ai&&this.onEvent.fire(r.GameEvents.NewGameState({state:this.currentState,context:r.NewGameStateContext.LoadedGameStateForDebug}))}saveCurrentStateForUndo(){this.currentState&&(this.history.push(this.currentState),1===this.history.length&&p.inject.worldUi.undoAvailable.set(!0))}get currentState(){var e;return null===(e=this.model)||void 0===e?void 0:e.stateEngine.currentState}handleAction(e){const t=v.timing.start(`handleAction(${e.name})`);this.model.currentPhase.isLocalPlayerTurn()&&this.saveCurrentStateForUndo();const i=this.actionHandlers[e.name];if(i){i(this.model,e.payload).forEach(e=>this.fireEvent(e))}else b.warning(`No handler assigned for event ${e.name} - ignoring it.`);t.complete()}fireEvent(e){this.eventsPaused&&!p.inject.config.debug.ai?(b.info(`[SCHEDULED] ${e.name} (${d.str(e.payload,100)})`),this.scheduledEvents.push(e)):(b.info(`📣 ${e.name} (${d.str(e.payload,100)})`),this.onEvent.fire(e))}executePlay(e){if(e.category!=n.EventCategory.Play)throw new Error(`cannot execute ${e.name} - does not appear to be a Play`);b.info(`👤⮕ ${e.name}(${d.str(e.payload)})`),this.handleAction(e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventQueue=void 0;t.EventQueue=class{constructor(){this.sources=[],this.pendingEvents=[]}addSource(e){this.sources.push(e(e=>this.push(e)))}push(e){this.pendingEvents.push(e)}hasNext(){return this.pendingEvents.length>0}next(){return this.pendingEvents.shift()}unsubscribe(){this.sources.forEach(e=>e.unsubscribe())}}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.InvertedMapProjection=void 0;const s=i(6),a=n(i(7)),r=i(39),o=i(4);class d extends r.MultiMapDataSet{constructor(e,t){super(e),this.key=e,this.source=t,this.parents=[this.source]}bootstrap(e){const t=o.selectFromState(e,this.source);if(!t)return a.default.Map();const i=[];if(!a.default.Map.isMap(t))throw console.error(t),new Error(`${this.source.key} is invalid source for InvertedMapProjection: ${t} is not an Immutable.Map instance`);return t.forEach((e,t)=>{s.pushIntoArrayByKey(i,e,t)}),n=i,a.default.Map().withMutations(e=>{for(let[t,i]of Object.entries(n))e.set(Number(t),a.default.Set(i))});var n}update(e,t,i){var n;const s=t.require(this.source),a=new r.MultiMapMutationBuilder(this,e);return null===(n=s.updated)||void 0===n||n.forEach(([e,t])=>{const n=o.selectFromState(i,this.source,e);void 0!==t&&a.add(t,e),void 0!==n&&a.remove(n,e)}),a.createMutation(this.source.key+" changed")}entryToString(e){return`[${e.size}]`}}t.InvertedMapProjection=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NextIdProjection=void 0;const n=i(17),s=i(93),a=i(4);class r extends s.SingletonDataSet{constructor(e,t){super(e,1),this.source=t,this.parents=[this.source]}bootstrap(e){const t=a.selectFromState(e,this.source);return t?t.keySeq().reduce(n.max,0)+1:1}update(e,t,i){var n;let s=a.selectFromState(i,this)||0,r=s;const o=t.require(this.source);let d=!1;if(null===(n=o.updated)||void 0===n||n.forEach(e=>{if(Array.isArray(e)){const[t,i]=e;void 0!==i?t>=r&&(r=t+1):d=!0}else{const t=e;t.added&&t.id>=r&&(r=t.id+1),t.removed&&(d=!0)}}),d)for(;r>1&&!a.selectFromState(e,this.source,r-1);)r-=1;return r!==s?this.createMutation(r,this.source.key):void 0}}t.NextIdProjection=r},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsByRegionUpdater=t.PawnsByRegionProjection=void 0;const s=i(6),a=n(i(7)),r=i(39),o=i(2),d=i(4),c=i(22);class h extends r.MultiMapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.updater=new l(this),this.update=this.updater.update.bind(this)}bootstrap(e){const t=d.selectFromState(e,this.sources.regionsByHex),i=d.selectFromState(e,this.sources.pawnsHex);if(!t||!i)return a.default.Map();const n=[];return o.assert(a.default.Map.isMap(t),`Invalid source ${this.sources.regionsByHex.key} for ${this.key}`),o.assert(a.default.Map.isMap(i),`Invalid source ${this.sources.pawnsHex.key} for ${this.key}`),i.forEach((e,i)=>{const a=t.get(e);a&&s.pushIntoArrayByKey(n,a,i)}),r=n,a.default.Map().withMutations(e=>{for(let[t,i]of Object.entries(r))e.set(Number(t),a.default.Set(i))});var r}}t.PawnsByRegionProjection=h;class l extends c.BaseUpdater{constructor(){super(...arguments),this.builder=new r.MultiMapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.pawnsHex,this._handlePawnsHexUpdate.bind(this)),e(this.dataSet.sources.regionsByHex,this._handleRegionsByHexUpdate.bind(this))}_handlePawnsHexUpdate(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{const i=d.selectFromState(this.oldState,this.dataSet.sources.pawnsHex,e),n=void 0!==t&&d.selectFromState(this.newState,this.dataSet.sources.regionsByHex,t);let s=void 0!==i&&d.selectFromState(this.oldState,this.dataSet.sources.regionsByHex,i);s!==n&&(s&&this.builder.remove(s,e),n&&this.builder.add(n,e))})}_handleRegionsByHexUpdate(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{let i=d.selectFromState(this.oldState,this.dataSet.sources.regionsByHex,e),n=d.selectFromState(this.newState,this.dataSet.sources.pawnsByHex,e);n&&(i&&this.builder.remove(i,...n.toArray()),t&&this.builder.add(t,...n.toArray()))})}}t.PawnsByRegionUpdater=l},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexImportanceUpdater=t.HexImportanceProjection=t.TOWN_HEX_BASE_IMPORTANCE=t.NO_IMPORTANCE=void 0;const s=i(18),a=n(i(7)),r=n(i(43)),o=i(14),d=i(1),c=i(17),h=i(5),l=i(10),u=i(23),g=i(28),p=i(2),f=i(11),m=i(22),y=i(3);t.NO_IMPORTANCE=Object.freeze({distanceFromTown:1/0,value:0,factors:{fromConnectedHexes:0,fromTownProximity:0,fromHex:0},parents:[],connectivity:0});d.logger.for("HexImportanceProjection");t.TOWN_HEX_BASE_IMPORTANCE=40;class w extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new v(this).update}bootstrap(e){const t=new v(this);return t.initFromState(e),l.Regions.getAll(e).forEach(e=>t.invalidateRegion(e)),t.getMap()}entryToString(e){return e.value.toString()}entryToDebugString(e){return o.prettyPrintObject(e)}}t.HexImportanceProjection=w;class v extends m.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}initialize(){return this.invalidatedHexes=new Set,this.invalidatedRegions=new Set,this.roots=new Map,this.regionId=-1,this}registerHandlers(e){e(this.dataSet.sources.townsByRegion,this.handleTownsByRegionChange),e(this.dataSet.sources.regionsHexes,this.handleRegionsHexesChange),e(this.dataSet.sources.pawnsValueByHex,this.handlePawnsCostByHexChange)}handleTownsByRegionChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>{this.invalidateRegion(e.id)})}handleRegionsHexesChange(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>{var t,i;const n=e.id;null===(t=e.added)||void 0===t||t.forEach(e=>{const t=y.getHex(e);this.invalidateAfterCapturedHex(t,n)}),null===(i=e.removed)||void 0===i||i.forEach(e=>{const t=y.getHex(e);this.invalidateAfterCapturedHex(t,n)})})}handlePawnsCostByHexChange(e){var t;const i=new Set;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{i.add(e)});for(let e of i){const t=l.Regions.getByHex(this.newState,e);t&&!this.invalidatedRegions.has(t)&&(this.setRegion(t),this.region.isAlive()&&this.invalidateHexAndParents(y.getHex(e)))}}createMutation(){return this.updateInvalidated(),super.createMutation()}setRegion(e){e!==this.regionId&&(this.regionId=e,this.region=l.Regions.model(this.newState).byId(this.regionId),p.assert.defined(this.region,"no region matched for id "+this.regionId))}invalidateAfterCapturedHex(e,t){if(this.setRegion(t),!this.region.isAlive())return;this.invalidateHex(e);let i=this.region.hexes.neighboursOf(e);i.forEach(e=>{this.invalidateHex(e),this.findNewParents(e).parents.forEach(e=>{this.invalidateHexAndParents(e)})}),i.forEach(e=>{this.invalidatePotentialChildren(e)})}invalidateHex(e){this.invalidatedHexes.has(e)||(this.invalidatedHexes.add(e),f.Pawns.getByHex(this.newState,e.id,h.PawnType.Town)&&this.addRoot(e))}findNewParents(e){p.assert.defined(this.region,`must first set region before calling findParents (called with ${e})`);let t=1/0,i=[];return this.region.hexes.neighboursOf(e).filter(e=>this.builder.has(e.id)||!this.isInvalidated(e)).forEach(e=>{var n,s,a,r;const o=(null!==(s=null===(n=this.builder.getCurrent(e.id))||void 0===n?void 0:n.distanceFromTown)&&void 0!==s?s:1/0)+(7-(null!==(r=null===(a=this.builder.getCurrent(e.id))||void 0===a?void 0:a.connectivity)&&void 0!==r?r:0));o===t?i.push(e):o<t&&(t=o,i=[e])}),{parents:i,distance:t}}addRoot(e){const t=l.Regions.getByHex(this.newState,e.id),i=this.roots.get(t)||new Set;i.add(e),this.roots.set(t,i)}invalidateParents(e){var t;let i=(null===(t=this.dataSet.getEntryById(this.newState,e.id))||void 0===t?void 0:t.parents)||[];0===i.length&&f.Pawns.getByHex(this.newState,e.id,h.PawnType.Town)&&this.addRoot(e),i.filter(e=>!this.isInvalidated(e)).forEach(e=>{this.invalidateHexAndParents(e)})}invalidatePotentialParents(e){this.region.hexes.neighboursOf(e).filter(e=>!this.isInvalidated(e)).forEach(e=>{this.invalidateHexAndParents(e)})}invalidateHexAndParents(e){this.invalidatedHexes.has(e)||(this.invalidateHex(e),this.invalidateParents(e))}invalidatePotentialChildren(e){var t;if(this.invalidatedRegions.has(this.regionId))return;const i=(null===(t=this.dataSet.getEntryById(this.newState,e.id))||void 0===t?void 0:t.distanceFromTown)||0;this.region.hexes.neighboursOf(e).filter(e=>{var t;return(null===(t=this.dataSet.getEntryById(this.newState,e.id))||void 0===t?void 0:t.distanceFromTown)>i}).forEach(e=>{this.invalidateHex(e),this.invalidatePotentialParents(e),this.invalidatePotentialChildren(e)})}invalidateRegion(e){const i=l.Regions.model(this.newState).byId(e);if(i&&!this.invalidatedRegions.has(i.id))if(i.isAlive()){const t=g.Economy.getTownHexesByRegion(this.newState,e);this.invalidatedRegions.add(e),t.forEach(e=>this.addRoot(y.getHex(e)))}else i.hexes.forEach(e=>this.builder.set(e.id,t.NO_IMPORTANCE))}updateInvalidated(){for(let[e,t]of this.roots.entries())this.updateForRegion(e,t);this.invalidatedHexes.forEach(e=>this.builder.set(e.id,t.NO_IMPORTANCE))}updateForRegion(e,i){this.setRegion(e);const n=new Set,s=new Map,a=new Set,o=new r.default((e,t)=>e.distance-t.distance);for(i.forEach(e=>o.push({hex:e,distance:0}));!o.empty();){const e=o.pop(),i=e.hex;if(a.has(i))continue;const r=this.getHexConnectivity(i);if(a.add(i),n.add(i),this.invalidatedHexes.delete(i),0===e.distance)this.builder.set(i.id,{connectivity:r,parents:[],value:0,distanceFromTown:0,factors:{fromHex:this.getHexBaseImportance(i),fromConnectedHexes:0,fromTownProximity:t.TOWN_HEX_BASE_IMPORTANCE}});else{let{parents:e,distance:a}=this.findNewParents(i);const o={connectivity:r,parents:e,distanceFromTown:a,value:0,factors:{fromHex:this.getHexBaseImportance(i),fromConnectedHexes:0,fromTownProximity:Math.floor(t.TOWN_HEX_BASE_IMPORTANCE/(a+1))}};this.builder.set(i.id,o),e.forEach(e=>{n.delete(e),s.set(e,(s.get(e)||0)+1)})}this.region.hexes.neighboursOf(i).filter(e=>(!this.builder.getCurrent(e.id)||this.isInvalidated(e))&&!a.has(e)).forEach(e=>{const t=this.builder.get(i.id);o.push({hex:e,distance:t.distanceFromTown+(7-t.connectivity)})})}const d=Array.from(n);for(;d.length;){const e=d.pop(),t=this.builder.getCurrent(e.id),i=t.factors;this.addValueFromUnchangedChildren(e),i.fromConnectedHexes=Math.floor(i.fromConnectedHexes),t.value=i.fromHex+i.fromConnectedHexes+i.fromTownProximity,t.parents.forEach(t=>{const i=s.get(t);p.assert.naturalNumber(i,`${t} considered parent of ${e.id}, but his children count is ${i}`),1===i&&d.push(t),s.set(t,i-1),this.addValueToParent(e,t)})}this.invalidatedRegions.delete(this.regionId)}isInvalidated(e){return!!this.invalidatedRegions.has(this.regionId)||this.invalidatedHexes.has(e)}addValueToParent(e,t){const i=this.builder.getCurrent(e.id),n=this.builder.getCurrent(t.id);p.assert.defined(n),p.assert.defined(i);const s=i.parents.length,a=(i.factors.fromHex+i.factors.fromConnectedHexes)/s;n.factors.fromConnectedHexes+=a}getHexConnectivity(e){return 6-e.neighbours(e=>{const t=l.Regions.getByHex(this.newState,e.id);return void 0!==t&&t!==this.regionId}).length}getHexBaseImportance(e){return Math.floor(f.Pawns.model(this.newState).byHex(e).filter(e=>!u.CurrentPhase.isMovable(this.newState,e.id)).map(e=>this.getValueOfPawn(e)).reduce(c.sum,1))}getValueOfPawn(e){return e.type===h.PawnType.Coins?e.count:e.rules.cost}getMap(){return this.updateInvalidated(),a.default.Map(this.builder.getEntries()).mapKeys(e=>Number(e))}addValueFromUnchangedChildren(e){this.region.hexes.neighboursOf(e).filter(t=>{var i;return!this.builder.get(t.id)&&!!(null===(i=this.dataSet.getEntryById(this.newState,t.id))||void 0===i?void 0:i.parents.includes(e))}).forEach(t=>this.addValueToParent(t,e))}}t.HexImportanceUpdater=v},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionsDataSetModel=void 0;const n=i(160),s=i(20),a=i(10),r=i(31);class o extends r.BaseModel{constructor(){super(...arguments),this.factionModels={}}byId(e){let t=this.factionModels[e];if(t||(t=new n.FactionModel(this,e),this.factionModels[t.id]=t),t.exists)return t}byRegion(e){const t=s.Factions.getByRegion(this.state,e.id);if(void 0!==t)return this.byId(t)}byHex(e){const t=a.Regions.getByHex(this.state,e.id);if(!t)return;const i=s.Factions.getByRegion(this.state,t);return void 0!==i?this.byId(i):void 0}nextId(){return s.Factions.getNextId(this.state)}all(){return s.Factions.getAll(this.state).map(e=>this.byId(e))}create(e){var t;const i=this.nextId();return this.state=s.Factions.createFaction(this.state,Object.assign(Object.assign({},e),{regions:null===(t=e.regions)||void 0===t?void 0:t.map(e=>e.id)})),this.byId(i)}}t.FactionsDataSetModel=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FactionModel=void 0;const n=i(12),s=i(65),a=i(1),r=i(50),o=i(5),d=i(2),c=i(20),h=i(10),l=i(96),u=i(6);a.logger.for("FactionsModel");class g extends s.BaseEntityModel{constructor(){super(...arguments),this.getRegions=l.lazyAdapter({source:()=>c.Factions.getFactionRegions(this.state,this.id),transform:e=>e.map(e=>h.Regions.model(this.state).byId(e))})}data(){return c.Factions.getData(this.state,this.id)}get exists(){return!!this.data()}get name(){var e;return(null===(e=this.data())||void 0===e?void 0:e.name)||""}get landColor(){var e;return null===(e=this.data())||void 0===e?void 0:e.landColor}get controller(){var e;return null===(e=this.data())||void 0===e?void 0:e.controller}get hexes(){return n.HexGroup.union(this.getRegions().map(e=>e.hexes))}isAlive(){return this.controller!==o.FactionController.None&&this.getPawns({type:[o.PawnType.Town]}).length>0}getPawns(e){const t=u.mergeArrays(...this.getRegions().map(e=>e.getPawns()));return e?r.filterPawns(this.state,t,e):t}addNewRegion(e,t){const i=h.Regions.getNextId(this.state);return this.state=c.Factions.addNewRegion(this.state,this.id,e,t.toIdsArray()),h.Regions.model(this.state).byId(i)}disownRegions(...e){return this.state=c.Factions.disownRegions(this.state,...e.map(e=>e.id)),this}captureRegions(...e){return this.state=c.Factions.captureRegions(this.state,this.id,...e.map(e=>e.id)),this}ownsHex(e){return c.Factions.getByHex(this.state,e.id)===this.id}absorbOwnRegionsAdjacentTo(e){d.assert(this.ownsHex(e),`${e} is not owned by ${this}!`);const t=h.Regions.model(this.state),i=t.byHex(e);d.assert.defined(i);const s=Array.from(new Set(e.neighbours().map(e=>t.byHex(e)).filter(e=>e&&e!==i&&e.faction===this)));if(0===s.length)return n.HexGroup.empty;const a=n.HexGroup.union(s.map(e=>e.hexes));return i.absorbRegions(s),a}splitRegionIfDisconnected(e){const t=e.hexes.components(),i=[];if(t.length>1)for(t.popLargestGroup();t.length>0;){let n=t.popLargestGroup();i.push(this.addNewRegion(e.name||"",n))}return i}toString(){return`[Faction #${this.id} "${this.name}"]`}getLargestRegion(){const e=this.getRegions();if(0!==e.length)return e.reduce((e,t)=>t.hexes.length>e.hexes.length?t:e)}setLandColor(e){this.state=c.Factions.setLandColor(this.state,this.id,e)}}t.FactionModel=g},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsDataSetModel=void 0;const n=i(6),s=i(2),a=i(50),r=i(11),o=i(31),d=i(3),c=i(94);class h extends o.BaseModel{constructor(){super(...arguments),this.pawnModels={}}byId(e){let t=this.pawnModels[e];if(t||(t=new a.PawnModel(this,e),this.pawnModels[e]=t),t.exists)return t}byType(e,t){return this.select({hexes:e,type:[t]})}select(e){const t=e.hexes||c.Grid.getAllHexes(this.state);let i=n.mergeArrays(...t.map(e=>r.Pawns.getByHex(this.state,e.id))).map(e=>this.byId(e));return e.type&&(i=i.filter(t=>e.type.includes(t.type))),e.traits&&(i=i.filter(t=>e.traits.every(e=>t.hasTrait(e)))),i}findOne(e){return this.select(e)[0]}findClosest(e,t,i){let n=void 0;return t.bfsFrom(e,e=>!n&&(n=this.byHex(e).filter(i)[0],!n)),n}byHex(e,t){return"number"==typeof e&&(e=d.getHex(e)),t?this.select({hexes:e,type:[t]})[0]:this.select({hexes:e})}byRegion(e){return r.Pawns.getByRegion(this.state,e.id).map(e=>this.byId(e))}adjustCount(e,t,i){if(0===i)return;const n=this.byHex(e,t);n?n.setCount(n.count+i):(s.assert(i>=0,`attempt to reduce ${t} count at ${e} below 0 (0-${-i}=${i})`),this.create({hex:e,type:t,count:i}))}setCount(e,t,i){const n=this.byHex(e,t);if(n)n.setCount(i);else{if(0===i)return;this.create({hex:e,type:t,count:i})}}presentAtHex(e,...t){return this.select({hexes:e,type:t.length>0?t:void 0}).length>0}nextId(){return r.Pawns.getNextId(this.state)}all(){return r.Pawns.getAll(this.state).map(e=>this.byId(e))}create(e){const t=this.nextId();return this.state=r.Pawns.create(this.state,e),this.byId(t)}destroy(...e){this.state=r.Pawns.destroy(this.state,...e.map(e=>e.id))}clear(){this.destroy(...this.all())}getCount(e,t){const i=this.byHex(e,t);return i?i.count:0}}t.PawnsDataSetModel=h},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GridModel=void 0;const n=i(3);t.GridModel=class{constructor(e){this.size=e,this.innerWidth=this.size.width-2,this.innerHeight=this.size.height-2,this.width=this.size.width,this.height=this.size.height}getAllHexes(){return n.HexGrid.getAllHexes(this.size)}getInnerHexes(){return n.HexGrid.getInnerHexes(this.size)}filter(e){return n.HexGrid.filter(e,this.size)}isWithinBounds(e){return n.HexGrid.isWithinBounds(e,this.size)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RulesModel=t.PawnTypeRulesModel=void 0;const n=i(13);class s{constructor(e,t){this.pawnRules=e,this.type=t}get state(){return this.pawnRules}get cost(){var e;return(null===(e=this.state)||void 0===e?void 0:e.cost)||0}get upkeep(){var e;return(null===(e=this.state)||void 0===e?void 0:e.upkeep)||0}get defense(){var e;return(null===(e=this.state)||void 0===e?void 0:e.defense)||0}get might(){var e;return(null===(e=this.state)||void 0===e?void 0:e.might)||0}get traits(){var e;return(null===(e=this.state)||void 0===e?void 0:e.traits)||[]}get mergeRules(){var e;return(null===(e=this.state)||void 0===e?void 0:e.merge)||{}}hasTrait(e){return this.traits.includes(e)}toString(){return`[PawnType ${this.type}]`}}t.PawnTypeRulesModel=s;t.RulesModel=class{constructor(e){this.rules=e,this.pawnModels={},this.unitsByMight={},this.wallsByMight={},this.getAllPawnTypes().forEach(e=>{e.hasTrait(n.PawnTraits.Unit)&&e.might&&(this.unitsByMight[e.might]=e),e.hasTrait(n.PawnTraits.Wall)&&e.defense&&(this.wallsByMight[e.defense]=e)})}get economy(){return this.state.economy}get state(){return this.rules}pawns(e){let t=this.pawnModels[e];return t||(t=new s(this.state.pawns[e],e),this.pawnModels[e]=t),t}unitByMight(e){return this.unitsByMight[e]}wallByMight(e){return this.wallsByMight[e]}getAllPawnTypes(){return Object.keys(this.state.pawns).map(e=>this.pawns(e))}getPawnTypesByTrait(e){this.getAllPawnTypes().filter(t=>t.hasTrait(e))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurrentPhaseModel=void 0;const n=i(5),s=i(2),a=i(23),r=i(20),o=i(11),d=i(31);class c extends d.BaseModel{get type(){return a.CurrentPhase.getType(this.state)}get faction(){const e=a.CurrentPhase.getFaction(this.state);if(void 0!==e)return r.Factions.model(this.state).byId(e)}isTapped(e){return a.CurrentPhase.isTapped(this.state,e.id)}isMovable(e){return a.CurrentPhase.isMovable(this.state,e.id)}isLocalPlayerTurn(){var e;return this.type===n.PhaseTypes.FactionTurn&&(null===(e=this.faction)||void 0===e?void 0:e.controller)===n.FactionController.LocalUser}getMovablePawns(){if(this.type!==n.PhaseTypes.FactionTurn)return[];s.assert.defined(this.faction);const e=o.Pawns.model(this.state);return a.CurrentPhase.getMovableUnits(this.state).map(t=>e.byId(t))}getNextFaction(){const e=a.CurrentPhase.getFaction(this.state),t=r.Factions.getAll(this.state);return void 0===e?t[0]:t[(t.indexOf(e)+1)%t.length]}tapPawn(e){this.state=a.CurrentPhase.tapPawn(this.state,e.id)}unTapPawn(e){this.state=a.CurrentPhase.unTapPawn(this.state,e.id)}set(e,t){this.state=a.CurrentPhase.set(this.state,e,t)}is(e){return this.type===e}}t.CurrentPhaseModel=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionsDataSetModel=void 0;const n=i(4),s=i(166),a=i(9),r=i(6),o=i(12),d=i(10),c=i(31);class h extends c.BaseModel{constructor(){super(...arguments),this.regionModels={}}all(){return n.selectFromState(this.state,a.GameState.regions.byId).keySeq().toArray().map(e=>this.byId(e))}byHex(e){let t="number"==typeof e?e:e.id;const i=d.Regions.getByHex(this.state,t);return i?this.byId(i):void 0}byId(e){if(d.Regions.getRegionData(this.state,e))return r.getOrCreate(this.regionModels,e,()=>new s.RegionModel(this,e))}nextId(){return n.selectFromState(this.state,a.GameState.regions.nextId)}create(e,t=o.HexGroup.empty){const i=this.nextId();this.state=d.Regions.createRegion(this.state,e,t.toIdsArray());const n=this.byId(i);return n.addHexes(t),n}destroy(...e){this.state=d.Regions.destroyRegions(this.state,...e.map(e=>e.id))}clear(){this.destroy(...this.all())}}t.RegionsDataSetModel=h},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionModel=void 0;const n=i(12),s=i(96),a=i(5),r=i(10),o=i(20),d=i(28),c=i(44),h=i(65),l=i(11),u=i(3);class g extends h.BaseEntityModel{constructor(){super(...arguments),this._hexes=s.lazyAdapter({source:()=>r.Regions.getRegionHexes(this.state,this.id),transform:e=>u.getHexes(e.toArray())}),this.getBorderHexes=s.lazyAdapter({source:()=>r.Regions.getRegionBorderHexes(this.state,this.id),transform:e=>u.getHexes(e.toArray())}),this.getHostileBorderHexes=s.lazyAdapter({source:()=>c.AI.getHostileBorderHexesByRegion(this.state,this.id),transform:e=>u.getHexes(e.toArray())}),this.getPawns=s.lazyAdapter({source:()=>l.Pawns.getByRegion(this.state,this.id),transform:e=>e.map(e=>l.Pawns.model(this.state).byId(e))})}get name(){var e;return(null===(e=r.Regions.getRegionData(this.state,this.id))||void 0===e?void 0:e.name)||""}get exists(){return!!r.Regions.getRegionData(this.state,this.id)}get hexes(){return this._hexes()}get faction(){const e=o.Factions.getByRegion(this.state,this.id);if(void 0!==e)return o.Factions.model(this.state).byId(e)}get budget(){return d.Economy.getRegionBudget(this.state,this.id)}get treasury(){return d.Economy.getTreasuryOf(this.state,this.id)}get might(){return c.AI.getRegionMight(this.state,this.id)}get size(){var e;return(null===(e=r.Regions.getRegionHexes(this.state,this.id))||void 0===e?void 0:e.size)||0}isAlive(){const e=o.Factions.getByRegion(this.state,this.id);if(!e)return!1;const t=o.Factions.getData(this.state,e);return!(!t.controller||t.controller===a.FactionController.None)&&0!==d.Economy.getTownHexesByRegion(this.state,this.id).length}addHexes(e){return this.state=r.Regions.addHexesToRegion(this.state,this.id,e.toIdsArray()),this}removeHexes(e){return this.state=r.Regions.removeHexesFromRegion(this.state,e.toIdsArray()),this}absorbRegions(e){if(e.includes(this))throw new Error(`Invalid absorbRegion arguments - region ${this} cannot absorb itself`);return this.addHexes(n.HexGroup.union(e.map(e=>e.hexes))),this.parentModel.destroy(...e),this}splitIntoComponents(){return r.Regions.splitRegionIntoComponents(this.state,this.id),this}toString(){return`[Region #${this.id} (${this.hexes.length}⬡)]`}}t.RegionModel=g},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EconomyModel=void 0;const n=i(97),s=i(13),a=i(32),r=i(11),o=i(1),d=i(28),c=i(31),h=i(3);o.logger.for("EconomyModel");class l extends c.BaseModel{townHexesOf(e){const t=d.Economy.getTownHexesByRegion(this.state,e.id);return h.getHexes(t)}baseIncomePerHex(){return a.Rules.getEconomyRules(this.state).baseIncomePerTile}incomeFromHex(e){return r.Pawns.model(this.state).byHex(e).find(e=>e.hasTrait(s.PawnTraits.NegatesTileIncome))?0:d.Economy.getBaseIncomePerHex(this.state)}advanceEconomyOf(e){return new n.RegionEconomyCalculator(this.state,e).run()}treasuryOf(e){return d.Economy.getTreasuryOf(this.state,e.id)}numberOfCoinsAt(e){return d.Economy.getNumberOfCoinsAt(this.state,e.id)}payForNewPawn(e,t){var i;const n=d.Economy.payToHex(this.state,e,(null===(i=a.Rules.getPawnRules(this.state,t))||void 0===i?void 0:i.cost)||0);return n.apply(this.state),n.getTransactions()}payToHex(e,t,i){const n=d.Economy.payToHex(this.state,t,i);return n.apply(this.state),n.getTransactions()}loot(e,t){const i=d.Economy.loot(this.state,e,t);return i.apply(this.state),i.getTransactions()}budgetOf(e){return d.Economy.getRegionBudget(this.state,e.id)}}t.EconomyModel=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexesByPawnTypeAndRegionProjection=void 0;const n=i(169),s=i(11);class a extends n.FilteredMultiMapProjection{constructor(e,t,i){super(e,i.pawnsByRegion),this.filteredPawnType=t,this.sources=i}constraint(e,t){return s.Pawns.getPawnType(e,t)===this.filteredPawnType}transform(e,t){return s.Pawns.getPawnHex(e,t)}}t.HexesByPawnTypeAndRegionProjection=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FilteredMultiMapProjection=void 0;const n=i(39),s=i(4);class a extends n.MultiMapDataSet{constructor(e,t,i=[]){super(e),this.key=e,this.filteredDataSet=t,this.parents=[t,...i]}bootstrap(e){return s.selectFromState(e,this.filteredDataSet).map(t=>t.filter(t=>this.constraint(e,t))).filter(e=>!e.isEmpty()).map(t=>t.map(t=>this.transform(e,t)))}update(e,t,i){var s;const a=t.of(this.filteredDataSet);if(!a)return;const r=new n.MultiMapMutationBuilder(this,e);return null===(s=a.updated)||void 0===s||s.forEach(t=>{let n=t.id;if(t.added&&r.add(n,...t.added.filter(t=>this.constraint(e,t)).map(t=>this.transform(e,t))),t.removed){const s=this.getEntryById(e,n);if(!s)return;r.remove(n,...t.removed.filter(e=>this.constraint(i,e)).map(e=>this.transform(i,e)).filter(e=>s.has(e)))}}),r.createMutation(this.filteredDataSet.key)}}t.FilteredMultiMapProjection=a},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.UnitsByFactionUpdater=t.UnitsByFactionProjection=void 0;const s=n(i(7)),a=i(39),r=i(4),o=i(22),d=i(20),c=i(21);class h extends a.MultiMapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new l(this).update}bootstrap(e){const t=r.selectFromState(e,this.sources.factionRegions);return s.default.Map().withMutations(i=>{t.entrySeq().forEach(([t,n])=>{let a=s.default.Set(c.Units.getByRegion(e,...n.toArray()));a.isEmpty()||i.set(t,a)})})}}t.UnitsByFactionProjection=h;class l extends o.BaseUpdater{constructor(){super(...arguments),this.builder=new a.MultiMapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.factionRegions,this._handleFactionRegionsUpdate),e(this.dataSet.sources.pawnsByRegion,this._handlePawnsByRegionUpdate)}_handleFactionRegionsUpdate(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>{e.added&&this.builder.add(e.id,...c.Units.getByRegion(this.newState,...e.added)),e.removed&&this.builder.remove(e.id,...c.Units.getByRegion(this.newState,...e.removed))})}_handlePawnsByRegionUpdate(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>{let t=d.Factions.getByRegion(this.newState,e.id);t&&(e.added&&this.builder.add(t,...e.added.filter(e=>c.Units.isUnit(this.newState,e))),e.removed&&this.builder.remove(t,...e.removed.filter(e=>c.Units.isUnit(this.oldState,e))))})}}t.UnitsByFactionUpdater=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UnitsModel=void 0;const n=i(31),s=i(32),a=i(13),r=i(10),o=i(11),d=i(20),c=i(21);class h extends n.BaseModel{byRegion(e){const t=o.Pawns.model(this.state);return c.Units.getByRegion(this.state,e.id).map(e=>t.byId(e))}getConquerableHexes(e,t){return c.Units.getConquerableHexes(this.state,e.id,t)}getHexLocalDefense(e){return c.Units.getHexLocalDefense(this.state,e.id)}getHexDefenders(e,t=1){return c.Units.getHexDefenders(this.state,e,t)}getHexDefense(e){return c.Units.getHexDefense(this.state,e)}getHexDefenseIncludingMovableUnits(e){return c.Units.getHexDefenseIncludingMovableUnits(this.state,e)}canConquerHexWith(e,t){return c.Units.canConquerHexWith(this.state,e,t)}getMergeResult(e,t){return s.Rules.getMergeResult(this.state,e,t)}isOccupied(e){return!!this.getOccupyingUnit(e)}getOccupyingUnit(e){return c.Units.getOccupyingUnit(this.state,e)}getMightOf(e){return s.Rules.model(this.state).pawns(e).might}isWall(e){return s.Rules.model(this.state).pawns(e).hasTrait(a.PawnTraits.Wall)}getDropPawnResult(e,t,i){const n=r.Regions.model(this.state),h=o.Pawns.model(this.state),l=s.Rules.model(this.state),u=n.byHex(e);if(u===i){if(this.isWall(t)){const n=h.select({hexes:e,traits:[a.PawnTraits.Pest]});if(n.length>0)return{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:n};const s=e.neighbours().filter(e=>d.Factions.model(this.state).byHex(e)!==i.faction),r=h.select({hexes:s,traits:[a.PawnTraits.Wall]});if(r.length>0)return{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:r};const o=h.findOne({hexes:e,traits:[a.PawnTraits.Wall]});if(o){const e=l.pawns(o.type).mergeRules[t];return e?{type:c.DropPawnResultType.Combine,combineWith:o,combineInto:e}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:[o]}}return{type:c.DropPawnResultType.Reposition}}{const i=this.getOccupyingUnit(e);if(!i)return{type:c.DropPawnResultType.Reposition};if(i.hasTrait(a.PawnTraits.Pest))return i.defense<this.getMightOf(t)?{type:c.DropPawnResultType.EradicatePest,pest:i}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:[i]};const n=l.pawns(i.type).mergeRules[t];return n?{type:c.DropPawnResultType.Combine,combineWith:i,combineInto:n}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:[i]}}}return(null==u?void 0:u.faction)===i.faction||this.isWall(t)?{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.InvalidRegion}:e.neighbours().find(e=>n.byHex(e)===i)?this.canConquerHexWith(e,t)?{type:c.DropPawnResultType.Conquest}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.PreventedByPawn,blockers:this.getHexDefenders(e,l.pawns(t).might)}:{type:c.DropPawnResultType.Invalid,reason:c.InvalidDropPawnReason.OutOfRange}}getRetreatDestination(e,t){const i=e.region;return i.hexes.neighboursOf(e.hex).filter(e=>!this.isOccupied(e)).findMax(e=>(o.Pawns.model(this.state).findOne({hexes:e,traits:[a.PawnTraits.EnablesRetreat]})?100:0)+i.hexes.neighboursOf(e).length)}}t.UnitsModel=h},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MovableUnitsProjection=void 0;const s=n(i(7)),a=i(5),r=i(99),o=i(4);class d extends r.SetDataSet{constructor(e,t){super(e),this.key=e,this.sources=t,this.parents=Object.values(this.sources),this.builder=new r.SetDataSetMutationBuilder(this)}bootstrap(e){const t=o.selectFromState(e,this.sources.currentPhase);if(t.type!==a.PhaseTypes.FactionTurn)return s.default.Set();const i=o.selectFromState(e,this.sources.unitsByFaction,t.faction);return i&&0!==i.size?i.filter(t=>!this._isTapped(e,t)):s.default.Set()}update(e,t,i){this.builder.init(e);const n=t.of(this.sources.currentPhase);return n?(this._handleCurrentPhaseChange(e,n,i),this.builder.createMutation("phase changed")):(this._handleTappedUnitsChange(e,t.of(this.sources.currentPhaseTappedUnits),i),this._handleFactionUnitsChange(e,t.of(this.sources.unitsByFaction),i),this.builder.createMutation("units changed"))}_isTapped(e,t){return o.selectFromState(e,this.sources.currentPhaseTappedUnits).has(t)}_handleFactionUnitsChange(e,t,i){var n;if(!t)return;const s=o.selectFromState(e,this.sources.currentPhase).faction;void 0!==s&&(null===(n=t.updated)||void 0===n||n.forEach(t=>{t.id===s&&(t.added&&this.builder.add(...t.added.filter(t=>!this._isTapped(e,t))),t.removed&&this.builder.delete(...t.removed.filter(t=>!this._isTapped(e,t))))}))}_handleTappedUnitsChange(e,t,i){var n,s;if(t){if(t.cleared){this.builder.clear();const t=o.selectFromState(e,this.sources.currentPhase).faction;if(t){const i=o.selectFromState(e,this.sources.unitsByFaction,t);i&&this.builder.add(...i.toArray())}}null===(n=t.addedEntries)||void 0===n||n.forEach(e=>this.builder.delete(e)),null===(s=t.deletedEntries)||void 0===s||s.forEach(e=>{this.builder.add(e)})}}_handleCurrentPhaseChange(e,t,i){if(t.type!==a.PhaseTypes.FactionTurn)this.builder.clear();else{this.builder.clear();const i=o.selectFromState(e,this.sources.unitsByFaction,t.faction);i&&this.builder.add(...i.toArray())}return this.builder.createMutation("currentPhaseChanged")}}t.MovableUnitsProjection=d},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.RegionBudgetUpdater=t.BudgetByRegionProjection=void 0;const r=i(18),o=a(i(7)),d=i(14),c=i(10),h=i(28),l=i(22);class u extends r.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new g(this).update}bootstrap(e){return o.Map().withMutations(t=>{c.Regions.model(e).all().forEach(e=>{t.set(e.id,this.getRegionBudget(e))})})}getRegionBudget(e){const t=e.state,i=e.isAlive()?e.hexes.map(e=>h.Economy.getIncomeFromHex(t,e.id)).reduce((e,t)=>e+t,0):0,n=e.getPawns().map(e=>e.upkeep).reduce((e,t)=>e+t,0);return{incomeFromHexes:i,upkeep:n,balance:i-n}}entryToString(e){return""+d.withSign(e.balance)}entryToDebugString(e){return d.prettyPrintObject(e)}}t.BudgetByRegionProjection=u;class g extends l.BaseUpdater{constructor(){super(...arguments),this.builder=new r.MapMutationBuilder(this.dataSet)}initialize(){this.invalidated=new Set}registerHandlers(e){e(this.dataSet.sources.regionHexes,this._invalidateAffectedRegions),e(this.dataSet.sources.pawnsByRegion,this._invalidateAffectedRegions)}createMutation(){const e=c.Regions.model(this.newState);return this.invalidated.forEach(t=>{this.builder.set(t,this.dataSet.getRegionBudget(e.byId(t)))}),super.createMutation()}_invalidateAffectedRegions(e){var t;null===(t=e.updated)||void 0===t||t.forEach(({id:e})=>this.invalidated.add(e))}}t.RegionBudgetUpdater=g},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&n(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.TreasuryByRegionProjection=void 0;const r=i(18),o=a(i(7)),d=i(10),c=i(17),h=i(4);class l extends r.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.builder=new r.MapMutationBuilder(this)}bootstrap(e){return o.Map().withMutations(t=>{h.selectFromState(e,this.sources.townsByRegion).forEach((i,n)=>{t.set(n,i.map(t=>h.selectFromState(e,this.sources.coinsByHex,t)||0).reduce(c.sum,0))})})}update(e,t,i){return this.builder.init(e),this._handleCoinsByHexChange(e,t.of(this.sources.coinsByHex),i),this._handleTownsByRegionChange(e,t.of(this.sources.townsByRegion),i),this.builder.createMutation("parent changed")}_handleCoinsByHexChange(e,t,i){var n;null===(n=null==t?void 0:t.updated)||void 0===n||n.forEach(([t,n])=>{const s=d.Regions.getByHex(e,t);if(!s)return;void 0===n&&(n=0);const a=h.selectFromState(i,this.sources.coinsByHex,t)||0,r=this.builder.getCurrent(s)||0;this.builder.set(s,r+n-a)})}_handleTownsByRegionChange(e,t,i){var n;null===(n=null==t?void 0:t.updated)||void 0===n||n.forEach(e=>{const t=e.id;let n=this.builder.getCurrent(t)||0;e.added&&(n+=e.added.map(e=>h.selectFromState(i,this.sources.coinsByHex,e)||0).reduce(c.sum,0)),e.removed&&(n-=e.removed.map(e=>h.selectFromState(i,this.sources.coinsByHex,e)||0).reduce(c.sum,0)),this.builder.set(t,n)})}}t.TreasuryByRegionProjection=l},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinsByHexProjection=void 0;const n=i(18),s=i(5),a=i(4),r=i(11);class o extends n.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.builder=new n.MapMutationBuilder(this)}bootstrap(e){return a.selectFromState(e,this.sources.pawnsByHex).map(t=>t.find(t=>r.Pawns.getPawnType(e,t)===s.PawnType.Coins)).filter(e=>e).map(t=>r.Pawns.getPawnCount(e,t)||0)}update(e,t,i){return this.builder.init(e),this._handlePawnByHexChange(e,t.of(this.sources.pawnsByHex),i),this._handlePawnsCountChange(e,t.of(this.sources.pawnsCount),i),this.builder.createMutation("parent changed")}_handlePawnByHexChange(e,t,i){var n;null===(n=null==t?void 0:t.updated)||void 0===n||n.forEach(t=>{var i,n;const a=t.id;null===(i=t.added)||void 0===i||i.forEach(t=>{r.Pawns.getPawnType(e,t)===s.PawnType.Coins&&this.builder.set(a,r.Pawns.getPawnCount(e,t)||1)}),null===(n=t.removed)||void 0===n||n.forEach(t=>{r.Pawns.getPawnType(e,t)===s.PawnType.Coins&&this.builder.delete(a)})})}_handlePawnsCountChange(e,t,i){var n;null===(n=null==t?void 0:t.updated)||void 0===n||n.forEach(([t,i])=>{if(r.Pawns.getPawnType(e,t)===s.PawnType.Coins){const n=r.Pawns.getPawnHex(e,t);if(!n)return;i?this.builder.set(n,i):this.builder.delete(n)}})}}t.CoinsByHexProjection=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RegionHostileBorderHexesProjection=void 0;const n=i(39),s=i(10),a=i(4),r=i(3);class o extends n.MultiMapDataSet{constructor(e,t){super(e),this.regionsBorderHexes=t,this.parents=[this.regionsBorderHexes]}bootstrap(e){return a.selectFromState(e,this.regionsBorderHexes).map((t,i)=>t.filter(t=>d(e,t,i))).filter(e=>e.size>0)}update(e,t,i){var a;const o=new n.MultiMapMutationBuilder(this,e);return null===(a=t.require(this.regionsBorderHexes).updated)||void 0===a||a.forEach(t=>{const i=t.id;if(t.added){const n=r.getHexes(t.added),s=r.getHexes(o.getCurrent(i).toArray()||[]);o.add(i,...t.added.filter(t=>d(e,t,i))),n.forEach(t=>{s.neighboursOf(t).forEach(t=>{d(e,t.id,i)||o.remove(i,t.id)})})}if(t.removed){o.remove(i,...t.removed);const n=r.getHexes(t.removed),a=r.getHexes(o.getCurrent(i).toArray());n.forEach(t=>{a.neighboursOf(t).forEach(t=>{s.Regions.getByHex(e,t.id)===i&&d(e,t.id,i)&&o.add(i,t.id)})})}}),o.createMutation("regionBorderChanged")}entryToString(e){return`[${e.size}]`}}function d(e,t,i){return!!r.getHex(t).findNeighbour(t=>{const n=s.Regions.getByHex(e,t.id);return void 0!==n&&n!==i})}t.RegionHostileBorderHexesProjection=o},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexDepthUpdater=t.HexDepthProjection=void 0;const s=i(18),a=n(i(7)),r=n(i(43)),o=i(10),d=i(44),c=i(4),h=i(22),l=i(3);class u extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new g(this).update.bind(this)}bootstrap(e){return a.default.Map().withMutations(t=>{c.selectFromState(e,this.sources.regionHexes).forEach((i,n)=>{const s=o.Regions.model(e).byId(n);s.getHostileBorderHexes().length?s.hexes.bfsFrom(s.getHostileBorderHexes(),(e,i,n)=>(t.set(e.id,n+1),!0)):s.hexes.forEach(e=>t.set(e.id,1/0))})})}}t.HexDepthProjection=u;class g extends h.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.hostileBorderHexes,this.handleHostileBorderHexesChanged.bind(this)),e(this.dataSet.sources.regionHexes,this.handleRegionHexesChanged.bind(this))}handleHostileBorderHexesChanged(e){var t;null===(t=e.updated)||void 0===t||t.forEach(e=>{const t=e.id,i=o.Regions.model(this.newState).byId(e.id);if(e.removed){const t=l.getHexes(e.removed),n=t.filter(e=>o.Regions.getByHex(this.newState,e.id)===i.id);this.updateDueToNewlyInternalHexes(i,n);const s=t.without(n);this.updateAfterHexesLost(i,s)}e.added&&d.AI.getHostileBorderHexesByRegion(this.oldState,t).isEmpty()&&i.hexes.bfsFrom(i.getBorderHexes(),(e,t,i)=>(this.builder.set(e.id,i+1),!0))})}handleRegionHexesChanged(e){var t;return null===(t=e.updated)||void 0===t||t.forEach(e=>{const t=o.Regions.model(this.newState).byId(e.id);e.added,e.removed&&this.updateAfterHexesLost(t,l.getHexes(e.removed))}),this.builder.createMutation("regionHexes changed")}updateDueToNewlyInternalHexes(e,t){let i=new Set(t.members),n=new r.default((e,t)=>e.candidateDepth-t.candidateDepth),s=[...t.members];const a=d.AI.getHostileBorderHexesByRegion(this.newState,e.id);for(;s.length;){let t=s.shift();for(let r of e.hexes.neighboursOf(t).members)if(!i.has(r))if(a.has(r.id))n.push({hex:t,candidateDepth:2});else{const a=this.dataSet.getEntryById(this.newState,r.id);this.hexCanJustifyDepth(this.newState,e,r,a,i)?n.push({hex:t,candidateDepth:a+1}):(s.push(r),i.add(r))}}for(i.forEach(e=>this.builder.delete(e.id));!n.empty()&&i.size;){let t=n.pop();if(i.has(t.hex)){i.delete(t.hex),this.builder.set(t.hex.id,t.candidateDepth);for(let s of e.hexes.neighboursOf(t.hex).members)i.has(s)&&n.push({hex:s,candidateDepth:t.candidateDepth+1})}}i.forEach(e=>this.builder.set(e.id,1/0))}updateAfterHexesLost(e,t){e.hexes.bfsFrom(t,(e,t,i)=>!t||(this.dataSet.getEntryById(this.newState,e.id)||1/0)>i&&(this.builder.set(e.id,i),!0))}isHostileRegion(e,t,i){const n=o.Regions.getByHex(e,t);return void 0!==n&&n!==i}hexCanJustifyDepth(e,t,i,n,s){return 1===n?!!i.findNeighbour(i=>!s.has(i)&&this.isHostileRegion(e,i.id,t.id)):!!t.hexes.neighboursOf(i).find(t=>!s.has(t)&&this.dataSet.getEntryById(e,t.id)===n-1)}}t.HexDepthUpdater=g},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HexPawnsCostUpdater=t.PawnsValueByHex=void 0;const s=i(18),a=n(i(7)),r=i(11),o=i(22),d=i(23);class c extends s.MapDataSet{constructor(e,t){super(e),this.sources=t,this.parents=Object.values(this.sources),this.update=new h(this).update}bootstrap(e){return a.default.Map().withMutations(t=>{r.Pawns.model(e).all().filter(e=>!e.isMovable()).forEach(e=>{t.update(e.hex.id,0,t=>t+e.cost)})})}}t.PawnsValueByHex=c;class h extends o.BaseUpdater{constructor(){super(...arguments),this.builder=new s.MapMutationBuilder(this.dataSet)}registerHandlers(e){e(this.dataSet.sources.pawnsHex,this.handlePawnsHexChanged),e(this.dataSet.sources.movableUnits,this.handleMovableUnitsChanged)}updateCost(e,t){0!==t&&this.builder.set(e,(this.builder.getCurrent(e)||0)+t)}handlePawnsHexChanged(e){var t;null===(t=e.updated)||void 0===t||t.forEach(([e,t])=>{void 0!==r.Pawns.getPawnHex(this.oldState,e)&&this.subtractPawnCost(this.oldState,e),void 0!==t&&this.addPawnCost(this.newState,e)})}handleMovableUnitsChanged(e){var t,i;if(e.cleared){d.CurrentPhase.getMovableUnits(this.oldState).forEach(e=>this.addPawnCost(this.newState,e))}null===(t=e.addedEntries)||void 0===t||t.forEach(e=>{this.subtractPawnCost(this.oldState,e)}),null===(i=e.deletedEntries)||void 0===i||i.forEach(e=>{this.addPawnCost(this.newState,e)})}addPawnCost(e,t){const i=r.Pawns.getPawnHex(e,t),n=r.Pawns.model(e).byId(t);if(!n||n.isMovable())return;const s=n.cost||0;this.updateCost(i,s)}subtractPawnCost(e,t){const i=r.Pawns.getPawnHex(e,t),n=r.Pawns.model(e).byId(t);if(!n||n.isMovable())return;const s=n.cost||0;this.updateCost(i,-s)}}t.HexPawnsCostUpdater=h},,,,function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Mutator=t.StateEngine=void 0;const s=n(i(7)),a=i(6),r=i(1),o=i(183),d=i(67),c=i(49),h=i(2),l=i(4);r.logger.for("StateEngine");t.StateEngine=class{constructor(){this.roots={},this.projections={},this.children=new Map,this.watchers={},this.globalListeners=new Set,this.currentState=l.createImmutableState(this,[])}_addPrimary(e,t){return h.assert(!this.roots[t.key],`dataSet ${t.key} already exists in the state engine!`),this.roots[t.key]=t,e.set(t.key,t.defaultValue)}add(...e){let t=[];return e.forEach(e=>{l.isProjectionDataSet(e)?this._addProjection(e):(t.push(e),this.currentState=this._addPrimary(this.currentState,e))}),this._updateState(e=>l.updateActiveDataSets(e,e=>e.union(s.default.Set(t)))),this.updateSequence=this.getProjectionsBootstrapSequence(),this}suspend(...e){if(!e.length)return;const t=e.filter(l.isProjectionDataSet);this._mutateState(e=>{l.updateActiveDataSets(e,e=>e.subtract(t))})}activate(...e){if(!e.length)return;const t=this.getProjectionsBootstrapSequence(e.filter(e=>!this.isDataSetActive(e)));this.currentState=this.currentState.deleteAll(t.map(e=>e.key));const i=this.currentState;t.forEach(e=>{const t=e.bootstrap(this.currentState);this.currentState=this.currentState.set(e.key,t),this.currentState=l.updateActiveDataSets(this.currentState,t=>t.add(e))}),this._notifyWatchersAfterMutations(this.currentState,[],i,t)}activateAllProjections(){this.activate(...Object.values(this.projections))}suspendAllProjections(){this.suspend(...Object.values(this.projections))}activateOnly(...e){var t;const i=new Set,n=[...e].filter(l.isProjectionDataSet);for(;n.length;){const e=n.pop();i.add(e),l.isProjectionDataSet(e)&&(null===(t=e.parents)||void 0===t||t.filter(l.isProjectionDataSet).forEach(e=>{e&&n.push(e)}))}const s=this.getActiveProjections().subtract(i);this.suspend(...s.toArray()),this.activate(...Array.from(i))}getActiveDataSets(){return l.getActiveDataSets(this.currentState)}getActiveProjections(){return this.getActiveDataSets().filter(e=>l.isProjectionDataSet(e))}isDataSetActive(e){return this.getActiveDataSets().has(e)}_updateState(e){this.currentState=e(this.currentState)}_mutateState(e){this.currentState=this.currentState.withMutations(e)}_addProjection(e){this.projections[e.key]=e,e.parents.forEach(t=>{const i=this.children.get(t);i?i.push(e):this.children.set(t,[e])})}apply(...e){e.forEach(e=>{const t=e.dataSet,i=this.roots[t.key];if(i!==t)throw void 0===i?this.projections[t.key]?new Error(`dataSet "${t.key}" is a projection, it cannot be updated manually!`):new Error("no such dataSet: "+t.key):new Error(`dataSet mismatch for key "${t.key}" - registered instance in state engine is different than the instance passed into update()`)}),this._applyMutationsAndNotifyWatchers(...e)}_applyMutationsAndNotifyWatchers(...e){const t=new u(this,e);return this.currentState=t.apply(),this._notifyWatchersAfterMutations(this.currentState,e,t.startingState,t.getChangedDataSets()),this.currentState}_notifyWatchersAfterMutations(e,t,i,n){if(n[Symbol.iterator]().next().value){this.globalListeners.forEach(n=>n(e,t,i));for(let s of n){const n=this.watchers[s.key];n&&n.forEach(n=>{n(e,t,i)})}}}get(e,t){return this.assertActive(e),l.selectFromState(this.currentState,e,t)}getEntryIds(e){return e.getEntryIds(this.currentState)}serialize(){return a.mapDictionary(this.roots,(e,t)=>e.serialize(this.currentState.get(t)))}clear(){this.currentState=l.createImmutableState(this,this.getActiveDataSets())}watchAll(e){this.globalListeners.add(e)}watchDataSet(e,t){this.assertHas(e),a.pushIntoArrayByKey(this.watchers,e.key,t)}assertActive(e,t){if(this.isDataSetActive(e))return;this.assertHas(e,t);throw new Error(`DataSet ${e} is suspended`+(t?` (${t})`:""))}assertHas(e,t){const i=this.getDataSetByKey(e.key);if(i!==e){const n=e=>new Error(e+(t?` (${t})`:""));throw n(i?`DataSet with key "${e.key}" already exists, but is not the expected instance`:`DataSet with key "${e.key}" not found in the state engine`)}}getAllDataSets(){return s.default.Set([...Object.values(this.roots),...Object.values(this.projections)])}deserialize(e){const t=d.timing.start("ImmutableState deserialization");this.clear();for(let[t,i]of Object.entries(this.roots))try{this.currentState=this.currentState.set(t,i.deserialize(e[t]))}catch(i){throw i.message=`Failed to deserialize ${t} from ${JSON.stringify(e)} \n\n${i.message}`,i}this.getProjectionsBootstrapSequence().forEach(e=>{this.isDataSetActive(e)&&(this.currentState=this.currentState.set(e.key,e.bootstrap(this.currentState)))}),t.complete()}sortProjections(e){const t=new Set(e);return this.getProjectionsBootstrapSequence(e).filter(e=>t.has(e))}getProjectionsBootstrapSequence(e=Object.values(this.projections)){let t=Object.values(this.roots),i=[...t];return e.forEach(e=>{i.includes(e)||this._resolveDeps(e,"<root>",i)}),i.slice(t.length)}getDependencyMap(){let e={};return Object.values(this.roots).forEach(t=>{e[t.key]=this._getDepTree(t)}),e}getParentsMap(e){if(l.isProjectionDataSet(e)){const t={};return e.parents.forEach(e=>t[e.key]=this.getParentsMap(e)),t}return"<root>"}_getDepTree(e){let t={};this.assertHas(e);return(this.children.get(e)||[]).forEach(e=>{t[e.key]=this._getDepTree(e)}),t}_resolveDeps(e,t,i,n=new Set){n.add(e),this.assertHas(e,"required by "+t);for(let s of e.parents)if(!i.includes(s)){if(!l.isProjectionDataSet(s))throw new Error(`missing primary dataSet ${s} (required by ${t})`);if(n.has(s))throw new Error(`circular reference detected: ${e} -> ${s}`);this._resolveDeps(s,e,i,n)}i.push(e),n.delete(e)}getDataSetByKey(e){return this.roots[e]||this.projections[e]}childrenOf(e){return this.children.get(e)||[]}};class u{constructor(e,t){this.stateEngine=e,this.mutations=t,this.dirty=new Set,this.updated=new Set,this.changeSet=new o.ChangeSet,this.startingState=this.stateEngine.currentState,this.currentState=this.startingState}apply(){this.mutations.forEach(e=>{this.applyMutation(e)});for(let e of this.stateEngine.updateSequence)this.dirty.has(e)&&this.stateEngine.isDataSetActive(e)&&this.resolve(e);return this.currentState}makeChildrenDirty(e){const t=this.stateEngine.childrenOf(e).filter(e=>this.stateEngine.isDataSetActive(e));t.length,t.forEach(e=>this.dirty.add(e))}resolve(e){h.assert(this.stateEngine.isDataSetActive(e),"Attempt to resolve suspended projection "+e);const t=e.update(this.currentState,this.changeSet,this.startingState);!t||void 0===t.changes||"object"==typeof t.changes&&c.isEmpty(t.changes)||this.applyMutation(t)}applyMutation(e){this.currentState=e.dataSet.apply(this.currentState,e.changes),this.changeSet.add(e),this.updated.add(e.dataSet),this.makeChildrenDirty(e.dataSet)}getChangedDataSets(){return this.updated}}t.Mutator=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChangeSet=void 0;const n=i(2),s=i(14);t.ChangeSet=class{constructor(e){this.mutations=new Map,this.title="empty",null==e||e.forEach(e=>this.add(e))}add(e){n.assert.undefined(this.mutations.get(e.dataSet),`changeSet already contains mutation for "${e.dataSet.key}" (${s.str(e)})`),this.title=e.dataSet.key,this.mutations.set(e.dataSet,e)}all(){return Array.from(this.mutations.values())}of(e){var t;return null===(t=this.mutations.get(e))||void 0===t?void 0:t.changes}require(e){const t=this.of(e);return n.assert.defined(t,`DataSet "${e.key}" not found in ${this}`),t}toString(){return`[ChangeSet<${Array.from(this.mutations.values()).map(e=>e.dataSet.key).join(",")}>]`}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AIModel=void 0;const n=i(9),s=i(110),a=i(68),r=i(102),o=i(44);t.AIModel=class{constructor(e){this.rootModel=e}getHexDepth(e){return this.rootModel.stateEngine.get(n.GameState.ai.hexDepth,e.id)||0}getHexImportance(e){var t;return(null===(t=this.rootModel.stateEngine.get(n.GameState.ai.hexImportance,e.id))||void 0===t?void 0:t.value)||0}getHexVulnerability(e){return this.rootModel.stateEngine.get(n.GameState.ai.hexVulnerability,e.id)}getRegionMight(e){return o.AI.getRegionMight(this.rootModel.state,e.id)||r.NO_MIGHT}calculateOpportunistAttackPriority(e,t){return new a.OpportunistAttackPriority(this.rootModel).calculateFor(e,t)}calculateDefensePriority(e){return new s.DefensePriority(this.rootModel).calculateFor(e,e.might)}getExposedHexes(e,t){return e.hexes.filter(e=>this.getHexImportance(e)>=t&&!!this.getHexVulnerability(e))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getCanonicalStateSnapshot=void 0;const n=i(4);t.getCanonicalStateSnapshot=function(e){const t=new Set(["economy.budgetByRegion","ai.mightByRegion","ai.hexImportance","ai.hexVulnerability"]),i=n.getActiveDataSets(e).map(e=>e.key).filter(e=>!t.has(e)),s=e.filter((e,t)=>i.has(t)).toJS();return function e(t,i){for(let n in t)!i||i.has(n)?(Array.isArray(t[n])&&(t[n]=t[n].sort()),"object"==typeof t[n]&&null!==t[n]&&e(t[n])):delete t[n]}(s,i),s}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleMovePawn=void 0;const n=i(8),s=i(21),a=i(69),r=i(2),o=i(3);t.handleMovePawn=function(e,t){const i=e.pawns.byId(t.pawnId);r.assert.defined(i);const d=i.region,c=i.hex,h=o.getHex(t.destinationHexId);if(r.assert.defined(d),r.assert.defined(h),c===h)return[];const l=e.units.getDropPawnResult(h,i.type,d);switch(l.type){case s.DropPawnResultType.Conquest:return a.captureHex(e,h,d,i);case s.DropPawnResultType.Reposition:return i.moveTo(h),[n.GameEvents.PawnMoved(Object.assign(Object.assign({},t),{sourceHexId:c.id}))];case s.DropPawnResultType.EradicatePest:return i.moveTo(h),l.pest.destroy(),e.currentPhase.tapPawn(i),[n.GameEvents.PawnMoved(Object.assign(Object.assign({},t),{sourceHexId:c.id,eradicatedPest:!0}))];case s.DropPawnResultType.Combine:i.destroy();const r=l.combineWith.type,o=!l.combineWith.isMovable(),u=l.combineWith.replaceWith(l.combineInto);return o&&e.currentPhase.tapPawn(u),[n.GameEvents.PawnMoved(Object.assign(Object.assign({},t),{sourceHexId:c.id,mergedWith:r,mergedInto:l.combineInto}))];case s.DropPawnResultType.Invalid:default:throw new Error(`Invalid move (${l.reason})`)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleBuyPawn=void 0;const n=i(8),s=i(69),a=i(21),r=i(2),o=i(3);t.handleBuyPawn=function(e,t){const i=o.getHex(t.destinationHexId),d=e.regions.byId(t.buyerRegionId);r.assert.defined(i),r.assert.defined(d);const c=e.units.getDropPawnResult(i,t.pawnType,d);switch(c.type){case a.DropPawnResultType.Conquest:return s.captureHex(e,i,d,t.pawnType);case a.DropPawnResultType.Reposition:case a.DropPawnResultType.EradicatePest:const r=e.economy.payForNewPawn(i,t.pawnType),o=e.pawns.create({type:t.pawnType,hex:i}),h=Object.assign(Object.assign({},t),{payment:r,eradicatedPest:c.type===a.DropPawnResultType.EradicatePest});return c.type===a.DropPawnResultType.EradicatePest&&(e.currentPhase.tapPawn(o),c.pest.destroy()),[n.GameEvents.PawnBought(h)];case a.DropPawnResultType.Combine:const l=e.economy.payForNewPawn(i,t.pawnType),u=c.combineWith.type,g=!c.combineWith.isMovable(),p=c.combineWith.replaceWith(c.combineInto);return g&&e.currentPhase.tapPawn(p),[n.GameEvents.PawnBought(Object.assign(Object.assign({},t),{mergedWith:u,mergedInto:c.combineInto,payment:l}))];case a.DropPawnResultType.Invalid:default:throw new Error(`Invalid buy attempt (${c.reason})`)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleEndTurn=void 0;const n=i(112),s=i(8),a=i(5),r=i(2);t.handleEndTurn=function(e){r.assert(e.currentPhase.type===a.PhaseTypes.FactionTurn,"Cannot end turn in phase "+e.currentPhase.type);const t=[];return function(e){const t=e.currentPhase.getNextFaction();e.currentPhase.set(a.PhaseTypes.FactionTurn,t)}(e),t.push(...n.processPhase(e),s.GameEvents.FactionTurnStarted(e.currentPhase.faction.id)),t}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.createRandomMap=t.PLAYER_COLORS=void 0;const s=i(190),a=i(192),r=i(0),o=i(195),d=i(5),c=i(38);t.PLAYER_COLORS=[29184,5939244,9019436,8421376,7101779,5066061],t.createRandomMap=function(e){return n(this,void 0,void 0,(function*(){const i=o.getBlankGameState(e),n=r.inject.gameStateModel;n.restore(i),n.useProjections(c.ProjectionPresets.coreEntities);for(let i=0;i<e.players;++i)n.factions.create({name:"Player "+(i+1),landColor:t.PLAYER_COLORS[i],controller:i>=e.localPlayers?d.FactionController.Ai:d.FactionController.LocalUser});s.generateLandmass(n,e.map,e),yield a.generateRegions(n,e.regions,e),n.activateAllProjections()}))}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.perlin=t.flat=t.generateLandmass=t.landGenerators=void 0;const s=n(i(191)),a=i(0),r=i(1),o=i(38),d=i(2),c=r.logger.for("generateLandmass");function h(e){var t;e.regions.clear(),null===(t=e.factions.byId(0))||void 0===t||t.addNewRegion("land",e.grid.getInnerHexes())}function l(e){var t;const i=e.grid.innerWidth*e.grid.innerHeight*.3,n=a.inject.random,r=t=>{return(h.simplex2(t.x/10,t.y/10)+1)*(i=t.x/e.grid.innerWidth,n=t.y/e.grid.innerHeight,1-2*((.5-i)*(.5-i)+(.5-n)*(.5-n)))>=.5;var i,n};let o,d,h,l=0;do{c.info(`Generating new random map (attempt #${l+1})`),d=n.integer(0,65535),h=new s.default.Noise(d);if(o=e.grid.getInnerHexes().filter(r).components().getLargestGroup(),++l,c.info(`Map generated (${null==o?void 0:o.length} hexes, target is at least ${i})`),l>49)throw Error("Failed to generate suitable world after 50 iterations")}while(!o||o.length<i);null===(t=e.factions.byId(0))||void 0===t||t.addNewRegion("land",o)}t.landGenerators={flat:h,perlin:l},t.generateLandmass=function(e,i,n){const s=t.landGenerators[i];d.assert(s,`unrecognized land generation strategy "${i}", expected one of ${Object.keys(t.landGenerators)}`);const a=performance.now();e.useProjections(o.ProjectionPresets.coreEntities),s(e),c.info(`World shape generated in ${performance.now()-a} ms`)},t.flat=h,t.perlin=l},,function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.splitAndCleanupRegions=t.generateRegions=t.regionGenerators=void 0;const s=i(1),a=i(38),r=i(193),o=i(2),d=i(194),c=s.logger.for("mapgen:regions");function h(e){const t=e.regions.all().filter(e=>0===e.size);e.regions.destroy(...t),e.regions.all().forEach(t=>t.updateFrom(e.state).splitIntoComponents())}t.regionGenerators={balancedChaos:d.balancedChaos,duel:r.duel},t.generateRegions=function(e,i,s={}){return n(this,void 0,void 0,(function*(){const n=t.regionGenerators[i];o.assert(n,`unrecognized regions generation strategy "${i}", expected one of ${Object.keys(t.regionGenerators)}`);const r=performance.now();e.useProjections(a.ProjectionPresets.coreEntities),yield n(e,s),h(e),c.info(`Regions assigned in ${performance.now()-r} ms`)}))},t.splitAndCleanupRegions=h},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.duel=void 0;const s=i(114),a=i(12),r=i(5),o=i(2);t.duel=function(e,t){return n(this,void 0,void 0,(function*(){const i=e.regions.all()[0];o.assert.defined(i,"map generator expects the first region in regions.all() to represent available landmass, but no regions were found");const n=i.hexes;o.assert(n.length);const d=e.factions.all().filter(e=>e.controller!=r.FactionController.None),c=n.findInnerMostHex();o.assert.defined(c);let h=new s.DistanceMap(n);h.addSources(c);let l=h.getMostDistantHex();h=new s.DistanceMap(n);let u={};for(let e of d.reverse()){let i=l;o.assert.defined(i),g(i,t.homeRegionSize||12,e),u[e.id]=i,l=h.getMostDistantHex()}if(!1!==t.secondaryTowns){let e=[];for(let t of d.reverse()){const t=h.getMostDistantHex();o.assert.defined(t),h.addSources(t),e.push(t)}let t=a.HexGroup.from(e);for(let e of d.reverse()){const i=new s.DistanceMap(n);i.addSources(u[e.id]);const a=t.findMax(e=>i.getDistanceTo(e));o.assert.defined(a),t=t.without(a),g(a,6,e)}}function g(t,i,s){let a=i,o=n.floodFillFrom(t,(t,i,n)=>{var s;return(null===(s=e.factions.byHex(t))||void 0===s?void 0:s.controller)===r.FactionController.None&&(a--,a>0)});var d;h.addSources(t),s.addNewRegion("Kingdom",o),d=t,e.pawns.create({hex:d,type:r.PawnType.Town}),e.pawns.create({hex:d,type:r.PawnType.Palisade})}}))}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.balancedChaos=t.DEFAULT_OPTIONS=void 0;const s=i(114),a=i(12),r=i(5),o=i(2),d=i(1),c=i(0);t.DEFAULT_OPTIONS={minRegionSize:2,maxRegionSize:4,townSpacing:2,humanPlayerHandicap:1};d.logger.for("mapgen:regions");t.balancedChaos=function(e,i){return n(this,void 0,void 0,(function*(){const n=Object.assign(Object.assign({},t.DEFAULT_OPTIONS),i),d=e.regions.all()[0];o.assert.defined(d,"map generator expects the first region in regions.all() to represent available landmass, but no regions were found");const h=d.hexes;o.assert(h.length);const l=h.findInnerMostHex();o.assert.defined(l);let u=new s.DistanceMap(h);u.addSources(l);const g=e.factions.all().filter(e=>e.controller!=r.FactionController.None),p=g.map(e=>e.addNewRegion("Kingdom",a.HexGroup.empty));let f=a.HexGroup.empty,m=(new Set,0),y=u.getMostDistantHex();for(u=new s.DistanceMap(h);u.getDistanceTo(y)>n.townSpacing||n.townSpacing>1&&0!==m;)o.assert.defined(y),u.addSources(y),m=(m+1)%g.length,f=f.with(y),y=u.getMostDistantHex();for(m=0;m<6;++m)u.addSources(y),f=f.with(y),y=u.getMostDistantHex();const w=Array.from({length:g.length},()=>new s.DistanceMap(h));for(m=c.inject.random.integer(0,g.length-1);f.length>6;){const e=f.findMax(e=>w[m].getDistanceTo(e));b(e,c.inject.random.integer(n.minRegionSize,n.maxRegionSize)-(g[m].controller===r.FactionController.LocalUser?n.humanPlayerHandicap:0),m),w[m].addSources(e),f=f.without(e),m=(m+1)%g.length}let v=c.inject.random.shuffle(d.hexes.members);for(let t of v){const i=new Set(p);t.neighbours().forEach(t=>{const n=e.regions.byHex(t);n&&i.size>1&&i.delete(n)});Array.from(i).reduce((e,t)=>t.size*(0===m?.8:1)<e.size?t:e).addHexes(t)}function b(t,i,n){let s=i,a=t;for(;s>0;){let t=a.neighbours().filter(t=>e.regions.byHex(t)===d&&!f.contains(t));if(0===t.length)break;a=a.with(c.inject.random.hex(t)),s--}var o;p[n].addHexes(a),o=t,e.pawns.create({hex:o,type:r.PawnType.Town}),e.pawns.create({hex:o,type:r.PawnType.Palisade}),e.pawns.create({hex:o,type:r.PawnType.Coins,count:7})}}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBlankGameState=void 0;const n=i(9),s=i(5),a=i(64);t.getBlankGameState=function(e={mapWidth:0,mapHeight:0}){return{version:n.CORE_GAMESTATE_SCHEMA_VERSION,grid:{width:e.mapWidth,height:e.mapHeight},regions:[],factions:[{id:0,name:"nature",landColor:6318176,controller:s.FactionController.None,regions:[]}],pawns:[],currentPhase:{type:s.PhaseTypes.GameStart},ruleSet:a.ruleSets.default}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.savedGameExists=t.loadGame=void 0;const n=i(9),s=i(115);t.loadGame=function(e){const t=localStorage.getItem(s.SAVE_GAME_LOCAL_STORAGE_PREFIX+e);if(!t)throw new Error(`no data found for save "${e}"`);try{const e=JSON.parse(t);if(e.version!==n.CORE_GAMESTATE_SCHEMA_VERSION)throw new Error("save data not compatible with current version of the game");return e}catch(e){throw new Error("save data corrupted")}},t.savedGameExists=function(e){return!!localStorage.getItem(e)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapDebugOverlay=void 0;const n=i(1),s=i(0),a=i(15),r=i(24),o=i(33),d=i(3);n.logger.for("WorldMapDebugOverlay");t.WorldMapDebugOverlay=class{constructor(e){this.scene=e,this.signalSubs=[],this.hexDebugLabels={},this.active=!1,this.arrowsGroup=this.scene.add.group({defaultKey:"atlas",defaultFrame:"debug-arrow"}).setDepth(r.WorldLayers.DebugOverlay),this.chunkRectangles=this.scene.add.group({classType:Phaser.GameObjects.Rectangle,createCallback:e=>{const t=e;t.setStrokeStyle(1,65280,.5),t.setDepth(r.WorldLayers.DebugOverlay)}})}showDebugLayer(e){this.clearDebugLayer(),this.activeDebugLayer=e;const t=this.scene;if(e){const i=s.inject.gameStateModel.grid,n=e.getMap(i);n.getHexIds().forEach(e=>{const i=d.getHex(e),s=n.get(i.id);this.hexDebugLabels[e]?this.hexDebugLabels[e].setVisible(!0).setText(s.toString()):this.hexDebugLabels[e]=function(e,i){return new o.DebugTextBox(t,e.display.centerX,e.display.centerY,i,{origin:[.5,.5],backgroundOpacity:0}).setDepth(r.WorldLayers.DebugOverlay)}(i,s.toString())});const a=e.getArrows&&e.getArrows();null==a||a.forEach(e=>{const[t,i]=d.getHexes(e).members,n=t.getAngleTowards(i);if(void 0===n)return;const s=(t.display.centerX+i.display.centerX)/2,a=(t.display.centerY+i.display.centerY)/2;this.arrowsGroup.get(s,a).setActive(!0).setVisible(!0).setDepth(r.WorldLayers.DebugOverlay).setRotation(n)}),this.debugLayerSub=e.onChange(()=>{this.showDebugLayer(e)})}}clearDebugLayer(e){var t;this.activeDebugLayer&&(this.activeDebugLayer=void 0,null===(t=this.debugLayerSub)||void 0===t||t.unsubscribe(),e?(Object.values(this.hexDebugLabels).forEach(e=>e.destroy()),this.hexDebugLabels={}):Object.values(this.hexDebugLabels).forEach(e=>e.setVisible(!1)),this.arrowsGroup.getChildren().forEach(e=>this.arrowsGroup.killAndHide(e)))}create(){this.active=!0,this.hexUnderCursor=this.scene.add.polygon(0,0,a.HEX_POLYGON).setStrokeStyle(2,255).setVisible(!1).setDepth(r.WorldLayers.DebugOverlay).setOrigin(0,0),this.registerSignals()}registerSignals(){this.unRegisterSignals(),this.signalSubs.push(s.inject.worldUi.hexUnderCursor.watch(e=>{e?(this.hexUnderCursor.setPosition(e.x*a.HEX_WIDTH,e.y*a.HEX_INNER_HEIGHT),this.hexUnderCursor.setVisible(!0)):this.hexUnderCursor.setVisible(!1)})),s.inject.config.watchFuture(this.applyConfig.bind(this))}applyConfig(e){var t;null===(t=this.worldBoundsRectangle)||void 0===t||t.setVisible(!!e.debug.overlay)}unRegisterSignals(){this.signalSubs.forEach(e=>e.unsubscribe()),this.signalSubs=[]}redrawWorldBoundsRectangle(e){this.worldBoundsRectangle&&this.worldBoundsRectangle.destroy(),s.inject.config.debug.overlay&&(this.worldBoundsRectangle=this.scene.add.rectangle(e.x,e.y,e.width,e.height).setStrokeStyle(1,255,1).setDepth(r.WorldLayers.DebugOverlay).setOrigin(0,0))}redrawChunkRectangles(e){this.chunkRectangles.getChildren().forEach(e=>this.chunkRectangles.killAndHide(e)),s.inject.config.debug.chunkBorders&&e.map(e=>e.boundingBox).forEach(e=>{const t=this.chunkRectangles.get(e.x,e.y);t.setSize(e.width,e.height),this.scene.add.existing(t)})}update(){this.activeDebugLayer&&this.showDebugLayer(this.activeDebugLayer)}destroy(e){this.unRegisterSignals(),this.clearDebugLayer(!0),this.active=!1,[this.worldBoundsRectangle,this.hexUnderCursor].forEach(e=>null==e?void 0:e.destroy())}setVisible(e){this.active!==e&&(e?this.create():this.destroy())}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldMapCameraController=void 0;const n=i(199),s=i(200),a=i(201),r=i(0);var o=Phaser.Geom.Rectangle;t.WorldMapCameraController=class{constructor(e){this.camera=e,this.cameraDragManager=new n.CameraDragScrollManager({drag:.8}),this.cameraZoomManager=new s.CameraZoomManager,this.cameraDragManager.attachTo(this.camera),this.cameraZoomManager.attachTo(this.camera),this.camera.on("camerazoomstart",this.handleZoomStart,this),this.camera.on("camerazoomcomplete",this.handleZoomComplete,this)}updateBounds(){const e=r.inject.gameStateModel;this.worldBounds=a.getWorldBounds(e.grid.width,e.grid.height),r.inject.debugData.set("worldBounds",`${this.worldBounds.x},${this.worldBounds.y},${this.worldBounds.width},${this.worldBounds.height}`),this.updateCameraBounds()}handleZoomStart(){this.camera.useBounds=!1}handleZoomComplete(){this.updateCameraBounds()}updateCameraBounds(e=this.camera.zoom){if(!this.worldBounds)return;const t=new o(this.worldBounds.x-200,this.worldBounds.y-200,this.worldBounds.width+400,this.worldBounds.height+400),i=this.camera.width/e-t.width;i>0&&(t.x-=i/2,t.width+=i/2);const n=this.camera.height/e-t.height;return n>0&&(t.y-=n/2,t.height+=n/2),this.camera.setBounds(t.x,t.y,t.width,t.height),r.inject.debugData.set("camBounds",`${t.x},${t.y} -> ${t.right},${t.bottom}`),t}isCameraOutOfBounds(e){return this.camera.scrollX<e.x*this.camera.zoom||this.camera.scrollY<e.y*this.camera.zoom}center(){this.camera.centerToBounds()}getCameraBounds(e){}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CameraDragScrollManager=void 0;const n=i(1),s=i(0),a=i(52);n.logger.for("ui:camera");t.CameraDragScrollManager=class{constructor({drag:e}={}){this.dragging=!1,this.wasDragging=!1,this.startPoint={x:0,y:0},this.startTime=0,this.endPoint={x:0,y:0},this.endTime=0,this.speedX=0,this.speedY=0,this.drag=.8,this.maxSpeed=1e3,e&&(this.drag=e)}attachTo(e){this.scene&&this.detach(),this.scene=e.scene,this.targetCamera=e,this.pointer=this.scene.input.activePointer,this.scene.input.on("pointermove",this.pointerDragHandler,this),this.scene.events.on("update",this.update,this)}detach(){this.scene.input.removeListener("pointermove",this.pointerDragHandler),this.scene.input.removeListener("update",this.update)}update(e,t){if(!this.dragging&&(this.speedX||this.speedY)){const e=this.speedX*(t/1e3),i=this.speedY*(t/1e3);this.targetCamera.scrollX+=e,this.targetCamera.scrollY+=i,this.speedX*=this.drag,this.speedY*=this.drag,Math.abs(this.speedX)<4&&Math.abs(this.speedY)<4&&(this.speedX=0,this.speedY=0)}}startDrag(){const e=this.scene.input.activePointer;this.speedX=0,this.speedY=0,this.dragging=!0,this.dragCursorIconOn(),this.startPoint={x:e.position.x,y:e.position.y},this.startTime=performance.now()}dragCursorIconOn(){this.scene.game.canvas.style.cursor="move"}dragCursorIconOff(){this.scene.game.canvas.style.cursor="default"}pointerDragHandler(e){if(this.dragging){if(!e.isDown)return void s.inject.events.trigger(a.WorldMapEvents.PointerUp({flags:0}));this.targetCamera.scrollX-=(e.position.x-e.prevPosition.x)/this.targetCamera.zoom,this.targetCamera.scrollY-=(e.position.y-e.prevPosition.y)/this.targetCamera.zoom}}stopDragging(){const e=this.scene.input.activePointer;this.endPoint=e.position,this.endTime=performance.now(),this.dragging&&(this.dragging=!1,this.wasDragging=!0,setTimeout(()=>this.wasDragging=!1,100),this.setSpeed()),this.dragCursorIconOff()}setSpeed(){const e=this.startPoint.x-this.endPoint.x,t=this.startPoint.y-this.endPoint.y,i=(this.endTime-this.startTime)/1e3;this.speedX=e/i,this.speedY=t/i,this.speedX>this.maxSpeed&&(this.speedX=this.maxSpeed),this.speedX<-this.maxSpeed&&(this.speedX=-this.maxSpeed),this.speedY>this.maxSpeed&&(this.speedY=this.maxSpeed),this.speedY<-this.maxSpeed&&(this.speedY=-this.maxSpeed)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CameraZoomManager=void 0;const n=[.5,1,2,4,8];t.CameraZoomManager=class{constructor(e={}){this.latestChange=0,this.zoomLevels=e.zoomLevels||n,this.zoomDelay=e.zoomDelay||300,this.currentZoomLevelIndex=e.defaultZoomLevelIndex||1}attachTo(e){this.scene=e.scene,this.targetCamera=e,this.scene.input.on("wheel",this.wheelHandler,this),this.updateZoom()}updateZoom(){const e=this.zoomLevels[this.currentZoomLevelIndex];this.targetCamera.zoomTo(e,this.zoomDelay,"Sine.easeInOut"),this.latestChange=performance.now()}wheelHandler(e,t,i,n,s){performance.now()-this.latestChange<300&&0!=n&&(this.latestChange=performance.now()),n<-10?(this.currentZoomLevelIndex=Math.min(this.zoomLevels.length-1,this.currentZoomLevelIndex+1),this.updateZoom()):n>10&&(this.currentZoomLevelIndex=Math.max(0,this.currentZoomLevelIndex-1),this.updateZoom())}zoomOutHandler(){}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getWorldBounds=void 0;var n=Phaser.Geom.Rectangle;const s=i(15);t.getWorldBounds=function(e,t){let i=e*s.HEX_WIDTH,a=(t-1)*s.HEX_INNER_HEIGHT+s.HEX_HEIGHT;return new n(-s.HEX_WIDTH/2,0,i+s.HEX_WIDTH/2,a)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bgrSwap=t.TilesManager=void 0;const n=i(1),s=i(203),a=i(15),r=i(204);var o=Phaser.GameObjects.RenderTexture;const d=n.logger.for("TilesManager");t.TilesManager=class{constructor(e,t){this.scene=e,this.renderer=t,this.cinematics={riseFromTheOcean:new r.TileRiseFromTheOceanCinematic(this,{delay:0,maxDelay:1e3,duration:1e3,riseSpeed:3,delayNoise:100})},this.tilesByHexId={}}bakeTileTextures(e){for(let i=0;i<e.length;++i){const n=new Phaser.GameObjects.RenderTexture(this.scene,0,0,a.HEX_WIDTH,a.HEX_HEIGHT+a.HEX_COLLAR_HEIGHT+2);n.draw(this.scene.textures.getFrame("atlas","hex"),0,0,1,t.bgrSwap(e[i])),n.draw(this.scene.textures.getFrame("atlas","hex-collar"),0,37),n.saveTexture("tile-"+i)}}addTile(e,t){this.createOrUpdateTile(e,t)}getByHex(e){return this.tilesByHexId[e]}addObjectToTile(e,t,i=0,n=0){const s=this.tilesByHexId[e];s?s.addObject(t,i,n):d.error(`Unable to place ${t} on hex ${e}, hex not present in the current rendering. Ignoring.`)}removeObjectFromTile(e,t){this.tilesByHexId[e.id]||d.warning(`Ignoring invalid removeObject call (no pawns present on hex ${e.id})`)}getAll(){return Object.values(this.tilesByHexId)}destroyTiles(){Object.values(this.tilesByHexId).forEach(e=>e.destroy()),this.tilesByHexId={}}setTileVisible(e,t){this.getByHex(e.id).setVisible(t)}createOrUpdateTile(e,t){let i=this.tilesByHexId[e.id];return i||(i=new s.Tile(this.renderer,e,t),i.create(),this.tilesByHexId[e.id]=i),i}renderTextureTest(){const e=new o(this.scene,300,300,500,500);this.getAll().forEach(t=>{e.draw([t.tileSprite,t.underwaterCollar])}),this.scene.add.existing(e)}};t.bgrSwap=e=>{const[t,i,n]=e.toString(16).padStart(6,"0").match(/[\w]{2}/g);return parseInt([n,i,t].join(""),16)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tile=void 0;var n=Phaser.GameObjects.Image;const s=i(15),a=i(24);t.Tile=class{constructor(e,t,i=0){this.renderer=e,this.hex=t,this.factionId=i,this.attachedObjects=new Set}get baseDepth(){return a.WorldLayers.Tiles+this.bottom}get bottom(){return this.hex.y*s.HEX_INNER_HEIGHT+s.HEX_HEIGHT}get centerX(){return(this.hex.x+.5)*s.HEX_WIDTH}get centerY(){return this.hex.y*s.HEX_INNER_HEIGHT+.5*s.HEX_HEIGHT}create(){const e=this.hex.x*s.HEX_WIDTH,t=this.hex.y*s.HEX_INNER_HEIGHT;this.tileSprite=this.renderer.add(this.hex,new n(this.renderer.scene,e,t,"tile-"+this.factionId).setOrigin(0,0).setDepth(a.WorldLayers.Tiles+t)),this.underwaterCollar=this.renderer.add(this.hex,new n(this.renderer.scene,e,t+42,"atlas","hex-underwater").setOrigin(0,0).setDepth(a.WorldLayers.Tiles+t+s.HEX_INNER_HEIGHT-1))}addObject(e,t,i){this.attachedObjects.add(e),this.renderer.add(this.hex,e),e.setPosition(this.centerX+t,this.centerY+i).setDepth(a.WorldLayers.TileObjects+this.baseDepth-s.HEX_HEIGHT/2+i)}removeObject(e){this.attachedObjects.delete(e),this.renderer.remove(this.hex,e)}setFaction(e){this.factionId=e,this.tileSprite.setTexture("tile-"+this.factionId)}setVisible(e){e?(this.attachedObjects.forEach(e=>e.addToDisplayList()),this.tileSprite.addToDisplayList(),this.underwaterCollar.addToDisplayList()):(this.attachedObjects.forEach(e=>e.removeFromDisplayList()),this.tileSprite.removeFromDisplayList(),this.underwaterCollar.removeFromDisplayList())}destroy(){[this.tileSprite,this.underwaterCollar].forEach(e=>e.destroy())}toString(){return`[Tile #${this.hex.id}]`}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TileRiseFromTheOceanCinematic=void 0;const n=i(6),s=i(53),a=i(25);class r extends a.BaseCinematic{constructor(e,t){super(e.scene),this.tiles=e,this.config=Object.assign({duration:2e3,delay:0,maxDelay:1e3,riseIntensity:20,riseSpeed:1,delayNoise:0},t)}play(e){const t=this.tiles.scene,i=this.tiles.getAll();i.forEach(e=>(e.tileSprite.setAlpha(0),e.tileSprite.setY(e.tileSprite.y+6),e.underwaterCollar.setAlpha(0),e));const a=s.createStaggeredDelay2Dfn(i.map(e=>({x:e.hex.x,y:e.hex.y})),this.config.delay,this.config.maxDelay,this.config.delayNoise),r=new Map;if(i.forEach(e=>{const t=a(e.hex);r.set(e.tileSprite,t),r.set(e.underwaterCollar,t)}),0===i.length&&e)return e();this.appear=t.tweens.add({duration:0,targets:n.mergeArrays(...i.map(e=>[e.tileSprite,e.underwaterCollar])),alpha:1,delay:e=>r.get(e)}),this.rise=t.tweens.add({targets:i.map(e=>e.tileSprite),y:"-=6",duration:this.config.duration/(2*this.config.riseSpeed),ease:"Back.easeOut",easeParams:[this.config.riseIntensity],delay:e=>r.get(e),onStart:()=>{i.forEach(e=>{e.tileSprite.setVisible(!0),e.underwaterCollar.setVisible(!0)})}}),e&&this.rise.on(Phaser.Tweens.Events.TWEEN_COMPLETE,()=>{e()})}toString(){return`[Effect: TileRiseFromTheOceanEffect (${this.rise?"playing":"stopped"})]`}stop(){var e,t;null===(e=this.rise)||void 0===e||e.stop(),null===(t=this.appear)||void 0===t||t.stop(),this.rise=void 0,this.appear=void 0}}t.TileRiseFromTheOceanCinematic=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinsManager=void 0;const n=i(1),s=i(6),a=i(206),r=i(3),o=i(208),d=i(17),c=i(209);n.logger.for("CoinsManager");t.CoinsManager=class{constructor(e,t){this.scene=e,this.tiles=t,this.cinematics={transactions:e=>new o.CoinTransactionCinematic(this,e),growStacks:e=>new c.GrowCoinStacksCinematic(this,e)},this.piles={}}spawnOnHex(e,t){this.getOrCreatePile(e).addCoins(t)}applyTransactions(e){for(let t of Object.keys(e).map(e=>Number(e))){const i=e[t];i.spawn&&this.spawnOnHex(r.getHex(t),i.spawn);for(let e in i.send)this.spawnOnHex(r.getHex(Number(e)),i.send[e])}for(let t of Object.keys(e).map(e=>Number(e))){const i=e[t],n=Object.values(i.send).reduce(d.sum,0)+i.consume;n>0&&this.removeFromHex(r.getHex(t),n)}}removeFromHex(e,t){this.getOrCreatePile(e).deleteCoins(t)}getOrCreatePile(e){return s.getOrCreate(this.piles,e.id,()=>new a.CoinPile(this.scene,this.tiles,e))}getAllPiles(){return Object.entries(this.piles)}destroyCoins(){Object.values(this.piles).forEach(e=>{e.destroy()}),this.piles={}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinPile=void 0;const n=i(1),s=i(207),a=i(71),r=i(15),o=i(0),d=i(17),c=[{x:9,y:-4,maxSize:15},{x:4,y:-8,maxSize:25},{x:-3,y:-5,maxSize:15},{x:14,y:0,maxSize:12},{x:-10,y:-4,maxSize:12},{x:-15,y:0,maxSize:12},{x:16,y:4,maxSize:12},{x:-13,y:8,maxSize:12},{x:12,y:8,maxSize:15},{x:8,y:10,maxSize:12},{x:-9,y:12,maxSize:12},{x:4,y:14,maxSize:10}],h=n.logger.for("CoinPile");t.CoinPile=class{constructor(e,t,i){this.scene=e,this.tiles=t,this.hex=i,this.stacks=[]}getCurrentAmmount(){return this.stacks.map(e=>e.currentAmount).reduce(d.sum,0)}addCoins(e){let t=e;for(;t>0;){const e=this.getOrCreateStackWithFreeCapacity();if(!e)return;e.remainingCapacity()>t?(e.addCoins(t),t=0):(t-=e.remainingCapacity(),e.addCoins(e.remainingCapacity()))}}deleteCoins(e){let t=e;for(;t>0;){const i=this.getLatestStack();if(!i)return void h.warning(`unable delete ${e} coins from ${this.hex}, hex is already empty of coins`);i.currentAmount>t?(i.deleteCoins(t),t=0):(t-=i.currentAmount,i.deleteCoins(i.currentAmount),this.stacks.pop())}}getLatestStack(){return this.stacks[this.stacks.length-1]}storeCoins(e){let t=[...e];for(;t.length>0;){const e=this.getOrCreateStackWithFreeCapacity();if(!e)return void this.stacks[this.stacks.length-1].consumeCoins(t);{const i=t.splice(0,e.remainingCapacity());e.consumeCoins(i)}}}spawnCoin(){const e=this.stacks[this.stacks.length-1];if(e&&0!==e.currentAmount){const t=e.spawnCoin();return 0===e.currentAmount&&this.stacks.pop(),t}return h.warning(`Spawning coin from pile at ${this.hex}, but the pile is empty => new coin created from nothing`),new a.Coin(this.scene,(this.hex.x+.5)*r.HEX_WIDTH,this.hex.y*r.HEX_INNER_HEIGHT+r.HEX_HEIGHT/2+o.inject.random.integer(-2,2))}destroy(){this.stacks.forEach(e=>e.destroy()),this.stacks=[]}getOrCreateStackWithFreeCapacity(){const e=this.stacks.find(e=>e.remainingCapacity()>0)||this.addStack();return e||h.warning(`Max displayable coin pile size exceeded at hex ${this.hex}. You have too much money!`),e}addStack(){const e=c[this.stacks.length];if(!e)return;const t=new s.CoinStack(this.scene,e.maxSize);return this.stacks.push(t),this.tiles.addObjectToTile(this.hex.id,t,e.x,e.y),t}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinStack=void 0;const n=i(0),s=i(19),a=i(1),r=i(71),o=i(24);var d=Phaser.GameObjects.Container,c=Phaser.GameObjects.Image;const h=a.logger.for("CoinStack");t.CoinStack=class extends d{constructor(e,t){super(e,0,0),this.capacity=t,this.currentAmount=0,this.column=new c(e,0,0,"atlas","coinstack").setOrigin(.5,1),this.topCoin=new r.Coin(e,0,0),this.add([this.column,this.topCoin]),this.updateSize()}remainingCapacity(){return this.capacity-this.currentAmount}updateSize(){const e=2*this.currentAmount;this.cropRect=new Phaser.Geom.Rectangle(0,this.column.height-e,this.column.width,e),this.topCoin.y=this.column.y-e+3,this.topCoin.setAlpha(this.currentAmount>0?1:0),this.column.setCrop(this.cropRect)}transitionSize(){const e=2*this.currentAmount,t=20*Math.abs(e-this.cropRect.height);this.currentTransition&&this.currentTransition.forEach(e=>e.stop()),this.currentTransition=[this.scene.tweens.add({targets:this.cropRect,height:e,y:this.column.height-e,duration:t,onUpdate:()=>this.column.setCrop(this.cropRect)}).on(Phaser.Tweens.Events.TWEEN_COMPLETE,()=>{this.currentAmount||this.destroy()}),this.scene.tweens.add({targets:this.topCoin,props:{y:{duration:t,value:this.column.y-e+3},alpha:{value:1,duration:0}}})]}addCoins(e){e>this.remainingCapacity()?(h.warning(`Attempted to add ${e} coins to a stack that already has ${this.currentAmount}/${this.capacity} coins. Extra coins not displayed.`),this.currentAmount=this.capacity):this.currentAmount+=e,n.inject.uiState.transitionsMode!==s.TransitionsMode.Disabled?this.transitionSize():this.updateSize()}consumeCoins(e){this.currentAmount<this.capacity&&(this.currentAmount+=e.length),n.inject.uiState.transitionsMode===s.TransitionsMode.Disabled?(e.forEach(e=>e.destroy()),this.updateSize()):e.forEach((e,t)=>{const i=this.y-2*(this.currentAmount-t)+3;e.setDepth(o.WorldLayers.FlyingObject+this.y-i),this.scene.tweens.add({targets:e,x:this.x,y:i,ease:"Sine.easeOut",duration:400,onComplete:()=>{e.destroy(),this.updateSize()}})})}spawnCoin(){const e=this.y-2*this.currentAmount+3;this.currentAmount-=1;const t=new r.Coin(this.scene,this.x,e);return this.updateSize(),t}deleteCoins(e){this.currentAmount<e?(h.warning(`Attempted to delete ${e} coins to a stack that already has only ${this.currentAmount}/${this.capacity} coins. Extra coins not deleted.`),this.currentAmount=0):this.currentAmount-=e,n.inject.uiState.transitionsMode!==s.TransitionsMode.Disabled?this.transitionSize():this.updateSize()}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoinTransactionCinematic=void 0;const n=i(25),s=i(3),a=i(71),r=i(15),o=i(0),d=i(24),c=i(19),h=i(118),l=i(2);class u extends n.BaseCinematic{constructor(e,t){super(e.scene),this.coins=e,this.transactions=t}play(e){const t={},i={};let n=0;const h=this.transactions,u=this.coins;for(let e in h){const u=s.getHex(Number(e));l.assert.defined(u);const g=h[e],p=[];for(let e=0;e<g.spawn;++e){const e=new a.Coin(this.scene,(u.x+.5)*r.HEX_WIDTH,u.y*r.HEX_INNER_HEIGHT+r.HEX_HEIGHT/2+o.inject.random.integer(-2,2));e.setDepth(d.WorldLayers.FlyingObject+e.y),p.push(e),this.scene.add.existing(e),e.setAlpha(0)}o.inject.uiState.transitionsMode!==c.TransitionsMode.Disabled&&this.animateCoinSpawn(p),n+=p.length,t[e]=p,i[e]=g.consume||0}if(o.inject.uiState.transitionsMode!==c.TransitionsMode.Disabled){const t=n>0?1e3:0;this.scene.time.addEvent({delay:t,callback:g}),this.scene.time.addEvent({delay:t+600,callback:p}),this.scene.time.addEvent({delay:t+1200,callback:e})}else g(),p(),e&&e();function g(){for(let e in h){const i=s.getHex(Number(e));l.assert.defined(i);const n=h[e],a=Object.values(n.send).reduce((e,t)=>e+t,0);for(let s=n.spawn;s<a;++s){const n=u.getOrCreatePile(i).spawnCoin();n.setDepth(d.WorldLayers.FlyingObject-n.y),t[e].push(n),u.scene.add.existing(n)}for(let i in n.send){const a=s.getHex(Number(i)),r=n.send[i];l.assert.defined(a);const o=t[e];if(r>0){u.getOrCreatePile(a).storeCoins(o.slice(0,r))}t[e]=t[e].slice(r)}if(t[e].length>0){u.getOrCreatePile(i).storeCoins(t[e])}}}function p(){for(let e in h){const t=s.getHex(Number(e));l.assert.defined(t);const i=h[e].consume;if(0===i)continue;u.getOrCreatePile(t).deleteCoins(i)}}}animateCoinSpawn(e){const t=e.map(()=>o.inject.random.integer(-100,100));e.forEach((e,i)=>{this.scene.time.addEvent({delay:t[i],callback:()=>{e.play("spin-coin")}})}),this.scene.tweens.add({targets:e,duration:500,y:"-=1",ease:h.jump,easeParams:[80],delay:(e,i,n,s)=>t[s],onComplete:()=>e.forEach(e=>{e.anims.stop(),e.setFrame(0)})}),this.scene.tweens.add({targets:e,duration:500,x:e=>e.x+o.inject.random.integer(-4,4),alpha:{from:0,to:1},delay:(e,i,n,s)=>t[s]})}}t.CoinTransactionCinematic=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GrowCoinStacksCinematic=void 0;const n=i(25),s=i(0),a=i(19),r=i(53),o=i(3);class d extends n.BaseCinematic{constructor(e,t){super(e.scene),this.coins=e,this.grid=t,this.coinsByHex={},this.pilesHidden=!1}playAfter(e,t){this.hidePiles(),super.playAfter(e,t)}play(e){this.hidePiles(),this.growPiles()}hidePiles(){this.pilesHidden||(this.pilesHidden=!0,s.inject.uiState.with({transitionsMode:a.TransitionsMode.Disabled},()=>{for(let[e,t]of this.coins.getAllPiles()){const i=t.getCurrentAmmount();this.coinsByHex[e]=i,t.deleteCoins(i)}}))}growPiles(){this.pilesHidden=!1;const e=1/s.inject.config.debug.tweenSpeedFactor,t=r.createStaggeredDelay2Dfn([{x:0,y:0},{x:this.grid.width,y:this.grid.height}],0,1e3*e,100*e);for(let e in this.coinsByHex){const i=o.getHex(Number(e)),n=this.coins.getOrCreatePile(i);setTimeout(()=>n.addCoins(this.coinsByHex[e]),t(i))}}}t.GrowCoinStacksCinematic=d},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnsManager=t.PawnEffects=void 0;const n=i(1),s=i(211),a=i(212),r=i(213),o=i(118),d=i(54),c=i(214),h=i(19),l=i(0),u=i(2);!function(e){e.Jump="jump",e.SpawnFromAbove="spawn-from-above"}(t.PawnEffects||(t.PawnEffects={}));const g=n.logger.for("ui:PawnsManager");t.PawnsManager=class{constructor(e,t){this.scene=e,this.tiles=t,this.cinematics={spawnFromAbove:new a.PawnSpawnFromAboveCinematic(this,{delay:0,maxDelay:1e3,height:40,delayNoise:100,duration:200}),defendTile:(e,t)=>new c.PawnTileDefenseCinematic(this,this.tiles,t,e)},this.pawnsByHex={},this.jumpingPawns=new Set,this.returningPawns=new Set,this.jumpClock=this.scene.tweens.addCounter({from:0,to:1,ease:"Linear",repeat:-1,duration:d.TIMING.pawnJumpDuration})}update(){const e=o.jump2;this.jumpingPawns.forEach(t=>{if(this.hangingPawn===t||this.returningPawns.has(t)||!t.image.visible)return;const i=(this.getJumpPhaseForPawn(t)+t.jumpingDeSync)%1;t.image.setY(this.getPawnY(t,i)),t.shadow.setScale(.5-.2*e(i)),t.jumpingDeSync>0&&t.jumpingDeSync<=.5?t.jumpingDeSync-=.002:t.jumpingDeSync>=.998?t.jumpingDeSync=0:t.jumpingDeSync>.5&&(t.jumpingDeSync+=.002)})}getJumpPhaseForPawn(e,t=0){const i=e.baseY%d.TIMING.pawnJumpDuration/d.TIMING.pawnJumpDuration;return(this.jumpClock.getValue()+t/d.TIMING.pawnJumpDuration+i)%1}getPawnY(e,t){return e.baseY-8*o.jump2(t)}add(e,t){if(this.pawnsByHex[e]){const i=this.pawnsByHex[e];g.warning(`Hex ${e} already contains a pawn sprite, replacing with ${t}`),i.destroy()}const i=new s.PawnObject(this.scene,t);return i.attachToTile(this.tiles.getByHex(e)),this.pawnsByHex[e]=i,i}destroyAll(){this.getAll().forEach(e=>{e.destroy()}),this.pawnsByHex={}}getAll(){return Object.values(this.pawnsByHex)}destroy(e){this.pawnsByHex[e]&&(this.pawnsByHex[e].destroy(),delete this.pawnsByHex[e])}move(e,t){const i=this.pawnsByHex[e];if(i)if(this.scene.tweens.killTweensOf([i.image]),i===this.hangingPawn&&this.clearHangingPawn(!0),i.detachFromTile(),this.pawnsByHex[t]&&g.warning(`Hex ${t} already contains a pawn sprite, replacing with pawn from ${e})`),this.pawnsByHex[t]=i,delete this.pawnsByHex[e],i.image.visible&&l.inject.uiState.transitionsMode!==h.TransitionsMode.Disabled){const e=this.tiles.getByHex(t).centerX,n=this.tiles.getByHex(t).centerY+3;this.returningPawns.add(i),this.scene.tweens.add({targets:[i.image,i.shadow],x:{from:i.image.x,to:e},y:{from:i.image.y,to:n},duration:d.TIMING.pawnTravelDuration,ease:"Sine.easeIn",onComplete:()=>{i.isDestroyed||(i.attachToTile(this.tiles.getByHex(t)),this.returningPawns.delete(i))}})}else i.attachToTile(this.tiles.getByHex(t));else g.warning(`No pawn attached to hex ${e}, ignoring move to ${e}->${t}`)}show(e){const t=this.pawnsByHex[e];t?(t.show(),this.jumpingPawns.has(t)&&(t.jumpingDeSync=this.getCurrentJumpingDeSyncForPawn(t))):g.warning(`Ignoring request to show pawn at hex ${e}, no such pawn exists`)}hide(e){const t=this.pawnsByHex[e];t?t.hide():g.warning(`Ignoring request to hide pawn at hex ${e}, no such pawn exists`)}getCurrentJumpingDeSyncForPawn(e,t=1){return(1+t-this.getJumpPhaseForPawn(e))%1}getPawnObjectPositionOnScreen(e,t){const i=this.pawnsByHex[t];if(i)return Object.assign(Object.assign({},r.convertWorldXYToCameraXY(e,i.image.x,i.image.y)),{scale:e.zoom*i.image.scale});{const i=this.tiles.getByHex(t);return u.assert.defined(i,`hex ${t} not found`),Object.assign(Object.assign({},r.convertWorldXYToCameraXY(e,i.centerX,i.centerY+3)),{scale:.5*e.zoom})}}setHangingPawn(e,t=e){const i=this.pawnsByHex[e];if(i!==this.hangingPawn&&(this.hangingPawn&&this.clearHangingPawn(),this.hangingPawn=i),this.hangingPawnHex=t,!this.hangingPawn)return;const n=t!==e&&this.pawnsByHex[t]?6:0,s=this.tiles.getByHex(t).centerX-n,a=this.tiles.getByHex(t).centerY-10-n;this.scene.tweens.add({targets:this.hangingPawn.image,duration:200,ease:"Sine.easeOut",x:s,y:a,onComplete:()=>{}}),t===e?this.scene.tweens.add({targets:this.hangingPawn.shadow,duration:100,ease:"Sine.easeOut",scale:.3}):this.hangingPawn.startFloating()}clearHangingPawn(e=!1){if(this.hangingPawn){const t=this.hangingPawn;this.hangingPawn=void 0,this.hangingPawnHex=void 0,e||(this.returningPawns.add(t),this.scene.tweens.killTweensOf(t.image),this.scene.tweens.add({targets:t.image,duration:100,ease:"Sine.easeOut",x:t.baseX,y:t.baseY-10,onComplete:()=>{this.returningPawns.delete(t),this.hangingPawn!==t&&(t.stopFloating(),t.jumpingDeSync=this.getCurrentJumpingDeSyncForPawn(t,.5))}}))}}beginJumping(e){e.map(e=>this.pawnsByHex[e]).forEach((t,i)=>{t?(t.jumpingDeSync=this.getCurrentJumpingDeSyncForPawn(t),this.jumpingPawns.add(t)):g.warning(`Ignoring jump animation request for hex ${e[i]} - no pawn rendered on this hex`)})}clearAllJumping(){this.jumpingPawns.forEach(e=>this.resetJumpingState(e)),this.jumpingPawns.clear()}stopJumping(e){e.map(e=>this.pawnsByHex[e]).forEach((t,i)=>{t?(this.jumpingPawns.delete(t),this.resetJumpingState(t)):g.warning(`Ignoring stop jump animation request for hex ${e[i]} - no pawn rendered on this hex`)})}resetJumpingState(e){e.image.y=e.baseY,e.shadow.setScale(.5)}replace(e,t){let i=this.pawnsByHex[e];i?i.setType(t):(g.warning(`Request to replace pawn at ${e} with ${t} but there is no existing pawn there => creating it`),this.add(e,t))}jumpOnce(e){let t=this.pawnsByHex[e];t?(this.scene.tweens.add({targets:t.image,y:{from:t.baseY,to:t.baseY-8},ease:"Sine.easeOut",duration:200,yoyo:!0}),this.scene.tweens.add({targets:t.shadow,scale:{from:.5,to:.2},ease:"Sine.easeOut",duration:200,yoyo:!0})):g.warning(`Request to play jump animation on ${e} ignored as there is no pawn there`)}getByHex(e){return this.pawnsByHex[e]}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnObject=void 0;var n=Phaser.GameObjects.Image;const s=i(5),a=i(24);i(1).logger.for("ui:PawnsManager");function r(e){return"pawns/"+e}t.PawnObject=class{constructor(e,t){this.scene=e,this.type=t,this.shadow=new n(this.scene,0,0,"atlas","pawn-shadow").setScale(.5),this.image=new n(this.scene,0,0,"atlas",r(this.type)).setScale(function(e){switch(e){case s.PawnType.Town:return 1;default:return.5}}(this.type)),this.isDestroyed=!1,this.isFloating=!1,this.baseX=0,this.baseY=0,this.tile=void 0,this.jumpingDeSync=0}attachToTile(e){this.tile=e,e.addObject(this.image,0,3),e.addObject(this.shadow,0,3),this.baseX=this.image.x,this.baseY=this.image.y,this.baseDepth=this.image.depth}detachFromTile(){this.tile&&(this.tile.removeObject(this.image),this.tile.removeObject(this.shadow))}destroy(){this.detachFromTile(),this.image.destroy(),this.shadow.destroy(),this.isDestroyed=!0}hide(){this.image.setVisible(!1),this.shadow.setVisible(!1)}show(){this.image.setVisible(!0),this.shadow.setVisible(!0)}hideShadow(){this.shadow.setVisible(!1)}showShadow(){this.shadow.setVisible(!0)}startFloating(){this.isDestroyed||(this.baseDepth=this.image.depth,this.image.setDepth(a.WorldLayers.FlyingObject),this.hideShadow())}stopFloating(){this.isDestroyed||(this.showShadow(),this.baseDepth&&this.image.setDepth(this.baseDepth))}setType(e){this.type=e,this.image.setFrame(r(this.type))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnSpawnFromAboveCinematic=void 0;const n=i(53),s=i(25);class a extends s.BaseCinematic{constructor(e,t){super(e.scene),this.pawnsManager=e,this.config=Object.assign({height:200,duration:500,delay:0,delayNoise:0,maxDelay:0},t)}play(e){const t=this.pawnsManager.getAll(),i=n.createStaggeredDelay2Dfn(t.map(e=>e.image),this.config.delay,this.config.maxDelay,this.config.delayNoise),s=new Map;t.forEach(e=>{const t=e.image.y;e.image.setY(t-this.config.height),e.image.setAlpha(0),e.shadow.setScale(.01);const n=i(e.image);s.set(e.image,n),s.set(e.shadow,n)}),this.pawnTween=this.pawnsManager.scene.tweens.add({duration:this.config.duration,targets:t.map(e=>e.image),y:"+="+this.config.height,ease:"Sine.easeIn",alpha:1,delay:e=>s.get(e)}),this.shadowTween=this.pawnsManager.scene.tweens.add({targets:t.map(e=>e.shadow),ease:"Sine.easeIn",scale:.5,duration:this.config.duration,delay:e=>s.get(e)}),e&&this.pawnTween.once(Phaser.Tweens.Events.TWEEN_COMPLETE,()=>{e()})}playAfter(e,t){this.pawnsManager.getAll().forEach(e=>{e.image.setAlpha(0),e.shadow.setScale(0)}),super.playAfter(e,t)}stop(){var e,t,i;this.pawnTween&&(null===(e=this.pawnTween)||void 0===e||e.stop(),null===(t=this.shadowTween)||void 0===t||t.stop(),null===(i=this.pawns)||void 0===i||i.forEach(e=>{e.image.setY(e.baseY),e.image.setAlpha(1),e.shadow.setScale(.5)}),this.pawnTween=void 0,this.shadowTween=void 0,this.pawns=void 0)}toString(){return`[Effect: PawnSpawnFromTheAboveEffect (${this.pawnTween?"playing":"stopped"})]`}}t.PawnSpawnFromAboveCinematic=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.convertWorldXYToCameraXY=void 0,t.convertWorldXYToCameraXY=function(e,t,i){const n=e.getWorldPoint(0,0);return{x:(t-n.x)*e.zoom,y:(i-n.y)*e.zoom}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnTileDefenseCinematic=void 0;const n=i(25),s=i(1).logger.for("PawnTileDefenseCinematic");class a extends n.BaseCinematic{constructor(e,t,i,n){super(e.scene),this.pawns=e,this.tiles=t,this.attackedHex=i,this.defenderHex=n}play(e){let t=this.pawns.getByHex(this.defenderHex);if(t)if(this.defenderHex==this.attackedHex)this.pawns.jumpOnce(this.defenderHex);else{const e=this.tiles.getByHex(this.defenderHex).centerX,i=this.tiles.getByHex(this.attackedHex).centerX,n=t.baseY,s=(i-e)/2,a=(this.tiles.getByHex(this.attackedHex).centerY+3-n)/2;this.scene.tweens.add({targets:[t.image,t.shadow],y:{from:n,to:n+a},x:{from:e,to:e+s},ease:"Sine.easeInOut",duration:200,yoyo:!0})}else s.warning(`Request to play jump animation from ${this.defenderHex} ignored as there is no pawn there`)}}t.PawnTileDefenseCinematic=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SelectedRegionHighlight=void 0;const n=i(37),s=i(70),a=i(119),r=i(24);var o=Phaser.GameObjects.RenderTexture;t.SelectedRegionHighlight=class{constructor(e){this.scene=e,this.renderTexture=new o(this.scene,0,0,100,100)}set(e){this.unset();const t=e.hexes,i=t.border(),o=s.enlargeRect(i.boundingBox(),4);this.renderTexture.setSize(o.width,o.height),this.renderTexture.clear(),i.forEach(e=>{n.HEX_DIRECTIONS.forEach(i=>{const n=e.neighbour(i);if(!t.contains(n)){const t=a.TileBorders.highlight.createBorder(this.scene,e,i).setDepth(r.WorldLayers.TileHighlight);t.setPosition(t.x-o.x,t.y-o.y),this.renderTexture.draw(t),t.destroy()}})}),this.renderTexture.saveTexture("generated_selected_regions");this.shadow=this.scene.add.image(o.x,o.y+2,"generated_selected_regions").setOrigin(0,0).setDepth(r.WorldLayers.TileHighlight).setTint(8414720),this.border=this.scene.add.image(o.x,o.y,"generated_selected_regions").setOrigin(0,0).setDepth(r.WorldLayers.TileHighlight).setTint(13937152,13937152,16776960,16776960)}show(){var e,t;null===(e=this.border)||void 0===e||e.setVisible(!0),null===(t=this.shadow)||void 0===t||t.setVisible(!0)}hide(){var e,t;null===(e=this.border)||void 0===e||e.setVisible(!1),null===(t=this.shadow)||void 0===t||t.setVisible(!1)}unset(){[this.border,this.shadow].filter(e=>e).forEach(e=>e.destroy())}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.build2dInnerBorderRecipe=void 0;const n=i(37),s=i(15);t.build2dInnerBorderRecipe=e=>({[n.HexDirection.UP_LEFT]:{x:0,y:0,orientation:"horizontal",flipX:!0},[n.HexDirection.UP_RIGHT]:{x:s.HEX_WIDTH/2-e,y:0,orientation:"horizontal"},[n.HexDirection.RIGHT]:{x:s.HEX_WIDTH-e,y:s.HEX_ANGLED_HEIGHT-e/2,orientation:"vertical"},[n.HexDirection.DOWN_RIGHT]:{x:s.HEX_WIDTH/2-e,y:s.HEX_INNER_HEIGHT-e,orientation:"horizontal",flipY:!0},[n.HexDirection.DOWN_LEFT]:{x:0,y:s.HEX_INNER_HEIGHT-e,orientation:"horizontal",flipX:!0,flipY:!0},[n.HexDirection.LEFT]:{x:0,y:s.HEX_ANGLED_HEIGHT-e/2,orientation:"vertical",flipX:!0}})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.palisadeRecipe=void 0;const n=i(37),s=i(15);t.palisadeRecipe={[n.HexDirection.UP_LEFT]:{x:2,y:-5,orientation:"horizontal",flipX:!0},[n.HexDirection.UP_RIGHT]:{x:s.HEX_WIDTH/2+1,y:-5,orientation:"horizontal"},[n.HexDirection.RIGHT]:{x:s.HEX_WIDTH-2,y:s.HEX_ANGLED_HEIGHT-4,orientation:"vertical"},[n.HexDirection.DOWN_RIGHT]:{x:s.HEX_WIDTH/2+2,y:s.HEX_INNER_HEIGHT-5,orientation:"horizontal",flipX:!0},[n.HexDirection.DOWN_LEFT]:{x:2,y:s.HEX_INNER_HEIGHT-5,orientation:"horizontal"},[n.HexDirection.LEFT]:{x:-2,y:s.HEX_ANGLED_HEIGHT-4,orientation:"vertical",flipX:!0}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TileBorderFactory=void 0;var n=Phaser.GameObjects.Image;const s=i(15),a=i(2);t.TileBorderFactory=class{constructor(e){this.config=e}createBorder(e,t,i){const a=this.config.recipe[i],r=this.config.textures[a.orientation],o=new n(e,t.x*s.HEX_WIDTH+a.x,t.y*s.HEX_INNER_HEIGHT+a.y,"atlas",r).setOrigin(0,0);return a.flipX&&(o.flipX=!0,o.setX(o.x+o.width)),a.flipY&&(o.flipY=!0,o.setY(o.y+o.height)),o.setDepth(this.config.baseDepth+o.y),o}createCorner(e,t,i){const s=this.config.textures.corner;a.assert.defined(s,this.constructor.name+" has no corner texture");const{x:r,y:o}=t.display.getCornerPoint(i),d=new n(e,r,o,"atlas",s);return d.setDepth(this.config.baseDepth+d.y-d.displayOriginY),d}toString(){return`[TileBorderFactory:${this.config.name}]`}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stoneWallRecipe=void 0;const n=i(37),s=i(15);t.stoneWallRecipe={[n.HexDirection.UP_LEFT]:{x:3,y:-7,orientation:"horizontal",flipX:!0},[n.HexDirection.UP_RIGHT]:{x:s.HEX_WIDTH/2+3,y:-7,orientation:"horizontal"},[n.HexDirection.RIGHT]:{x:s.HEX_WIDTH-2,y:s.HEX_ANGLED_HEIGHT-4,orientation:"vertical"},[n.HexDirection.DOWN_RIGHT]:{x:s.HEX_WIDTH/2+3,y:s.HEX_INNER_HEIGHT-7,orientation:"horizontal",flipX:!0},[n.HexDirection.DOWN_LEFT]:{x:3,y:s.HEX_INNER_HEIGHT-7,orientation:"horizontal"},[n.HexDirection.LEFT]:{x:-2,y:s.HEX_ANGLED_HEIGHT-4,orientation:"vertical",flipX:!0}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConquerableHexesHighlight=void 0;const n=i(12),s=i(1),a=i(54),r=i(24),o=s.logger.for("ConquerableHexesHighlight");t.ConquerableHexesHighlight=class{constructor(e){this.scene=e,this.indicatorsByHex={},this.activeHexes=n.HexGroup.empty,this.indicators=this.scene.add.group({defaultKey:"atlas",defaultFrame:"hex-move-indicator",createCallback:e=>{e.setName("indicator"+this.indicators.getLength())}}).setDepth(r.WorldLayers.TileHighlight)}clear(){this.removeIndicators(Object.keys(this.indicatorsByHex).map(e=>Number(e))),this.activeHexes=n.HexGroup.empty}set(e){const t=Object.entries(this.indicatorsByHex).filter(([t,i])=>!e.containsId(Number(t))).map(([e,t])=>Number(e)),i=[];e.map(e=>{const t=this.indicatorsByHex[e.id]||this.indicators.get(e.display.centerX,e.display.centerY,void 0,void 0,!1).setVisible(!0).setActive(!0).setDepth(r.WorldLayers.TileHighlight);return this.indicatorsByHex[e.id]||(this.indicatorsByHex[e.id]=t,i.push(t)),t}),this.scene.tweens.add({targets:i,scale:{from:.5,to:1},alpha:{from:0,to:1},duration:a.TIMING.pawnPickupTransition,ease:"Sine.easeOut"}),this.removeIndicators(t)}setHighlightedHex(e){var t,i;const n=this.indicatorsByHex[e.id];n?this.highlightedIndicator!==n&&(this.clearHighlightedHex(),this.highlightedIndicator=n,null===(t=this.highlightedIndicator)||void 0===t||t.setFrame("hex-move-indicator-hover"),null===(i=this.highlightedIndicator)||void 0===i||i.setScale(.75),this.highlightedIndicatorTween=this.scene.tweens.add({targets:n,scale:1,duration:200,ease:"Sine.easeInOut"})):o.warning(`ignoring attempt to highlight conquest indicator on hex ${e.id}, which does not currently display conquest indicator`)}clearHighlightedHex(){var e;if(this.highlightedIndicator){const t=this.highlightedIndicator;this.scene.tweens.add({targets:t,scale:.75,duration:100,onComplete:()=>{t.setFrame("hex-move-indicator"),t.setScale(1)}}),null===(e=this.highlightedIndicatorTween)||void 0===e||e.stop(),this.highlightedIndicator=void 0}}show(){this.indicators.children.each(e=>e.setVisible(e.active))}hide(){this.indicators.setVisible(!1)}removeIndicators(e){const t=e.map(e=>this.indicatorsByHex[e]);this.highlightedIndicator&&t.includes(this.highlightedIndicator)&&this.clearHighlightedHex(),this.scene.tweens.add({targets:t,scale:{from:1,to:.5},alpha:{from:1,to:0},duration:a.TIMING.pawnPickupTransition,ease:"Sine.easeIn",onComplete:()=>{t.forEach(e=>{this.indicators.killAndHide(e)})}}),e.forEach(e=>delete this.indicatorsByHex[e])}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldCreationCinematic=void 0;const n=i(25),s=i(0);class a extends n.BaseCinematic{constructor(e){super(e)}play(e){this.scene.tiles.cinematics.riseFromTheOcean.play(),this.scene.pawns.cinematics.spawnFromAbove.playAfter(200,e),this.scene.tileBorders.cinematics.fadeIn.playAfter(200),this.scene.coins.cinematics.growStacks(s.inject.gameStateModel.grid).playAfter(500)}}t.WorldCreationCinematic=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.deriveDefenseMarkerDataFromModel=t.HexDefenseMarkers=t.HexMarker=void 0;const n=i(12),s=i(1),a=i(54),r=i(24),o=i(0),d=i(13),c=i(40),h=i(2),l=i(3);s.logger.for("HexDefenseHighlight");!function(e){e.Circle="circle",e.Defense1="defense-1",e.Defense2="defense-2",e.Defense3="defense-3",e.Defense4="defense-4"}(t.HexMarker||(t.HexMarker={}));t.HexDefenseMarkers=class{constructor(e){this.scene=e,this.shapesByHex={},this.hovered={hex:void 0,defenseAuraStrength:0,defenseAuraHexes:n.HexGroup.empty},this.shapes=this.scene.add.group({defaultKey:"atlas",defaultFrame:"hex-markers/defense-1"}).setDepth(r.WorldLayers.TileHighlight)}clear(){this.removeShapes(Object.keys(this.shapesByHex).map(e=>Number(e)))}set(e){this.config=e;const t=Object.entries(this.shapesByHex).filter(([t,i])=>0===e.get(Number(t)).defense).map(([e,t])=>Number(e)),i=[];l.getHexes(e.getHexIds()).without(this.hovered.hex||n.HexGroup.empty).without(this.hovered.defenseAuraHexes).map(e=>{h.assert.defined(e);const t=this.config.get(e.id),n=this.setShapeOnHex(e,"defense-"+t.defense);return this.shapesByHex[e.id]||(this.shapesByHex[e.id]=n,i.push(n),this.scene.tweens.add({targets:n,x:{from:t.origin.display.centerX,to:e.display.centerX},y:{from:t.origin.display.centerY,to:e.display.centerY},scale:{from:.5,to:1},alpha:{from:0,to:1},duration:a.TIMING.pawnPickupTransition,ease:"Sine.easeOut"})),n}).filter(e=>!!e),this.removeShapes(t)}setShapeOnHex(e,t){const i=this.shapesByHex[e.id]||this.shapes.get(e.display.centerX,e.display.centerY,void 0,void 0,!1).setVisible(!0).setActive(!0).setDepth(r.WorldLayers.TileHighlight);return i.setFrame("hex-markers/"+t).setAlpha(1).setScale(1),i}setHoveredHex(e,t,i){this.clearHoveredHex(),this.hovered.hex=e,this.hovered.defenseAuraHexes=i,this.hovered.defenseAuraStrength=t,this.shapesByHex[e.id]=this.setShapeOnHex(e,"circle"),this.hovered.defenseAuraHexes.forEach(e=>{const i=this.config.get(e.id).defense;t>i&&(this.shapesByHex[e.id]=this.setShapeOnHex(e,"defense-"+t))})}clearHoveredHex(){this.hovered.hex&&(n.HexGroup.union([this.hovered.hex,this.hovered.defenseAuraHexes]).forEach(e=>{const t=this.config.get(e.id).defense;t>0?this.shapesByHex[e.id]=this.setShapeOnHex(e,"defense-"+t):(this.shapes.killAndHide(this.shapesByHex[e.id]),delete this.shapesByHex[e.id])}),this.hovered.hex=void 0,this.hovered.defenseAuraStrength=0,this.hovered.defenseAuraHexes=n.HexGroup.empty)}removeShapes(e){const t=e.map(e=>this.shapesByHex[e]);this.scene.tweens.add({targets:t,scale:{from:1,to:.5},alpha:{from:1,to:0},duration:a.TIMING.pawnPickupTransition,ease:"Sine.easeIn",onComplete:()=>{t.forEach(e=>{this.shapes.killAndHide(e)})}}),e.forEach(e=>delete this.shapesByHex[e])}},t.deriveDefenseMarkerDataFromModel=function(e,t){const i=o.inject.gameStateModel,n=e.hexes,s=new c.CustomHexGroupValuation({defense:0});return i.pawns.select({hexes:n,traits:[d.PawnTraits.GuardsAdjacentTiles]}).filter(e=>e!==t).forEach(e=>{n.neighboursOf(e.hex).filter(e=>!i.units.isOccupied(e)).forEach(t=>{const i=s.get(t.id);e.defense>i.defense&&s.set(t.id,{defense:e.defense,origin:e.hex})})}),i.pawns.select({hexes:n,traits:[d.PawnTraits.Wall]}).filter(e=>e!==t).forEach(e=>{const t=s.get(e.hex.id);!i.units.isOccupied(e.hex)&&e.defense>t.defense&&s.set(e.hex.id,{defense:e.defense,origin:e.hex})}),s}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TileDefenseCinematic=void 0;const n=i(25),s=i(12);class a extends n.ParallelCinematic{constructor(e,t,i){super(e.scene),this.pawns=e,this.attackedHex=t,this.defenders=i;const n=s.HexGroup.from(this.defenders.map(e=>e.hex));n.contains(this.attackedHex)?this.add(this.pawns.cinematics.defendTile(this.attackedHex.id,this.attackedHex.id)):n.forEach(e=>this.add(this.pawns.cinematics.defendTile(e.id,this.attackedHex.id)))}}t.TileDefenseCinematic=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Chunk=t.ChunkedRenderer=t.ChunksRenderingController=void 0;const n=i(6),s=i(225),a=i(70),r=i(15),o=i(1),d=i(0);o.logger.for("ChunkedRenderer");t.ChunksRenderingController=class{constructor(e,t,i=r.HEX_WIDTH){this.scene=e,this.renderer=t,this.margin=i,this.camera=this.scene.cameras.main}update(){const e=Phaser.Geom.Rectangle.Inflate(this.camera.worldView,this.margin,this.margin);for(const t of this.renderer.getVisibleChunks())Phaser.Geom.Intersects.RectangleToRectangle(e,t.boundingBox)||t.setVisible(!1);for(const t of this.renderer.getChunksInRect(e))t.setVisible(!0);d.inject.debugData.set("visibleChunks",this.renderer.getVisibleChunks().size.toString())}};t.ChunkedRenderer=class{constructor(e,t=5){this.scene=e,this.chunkSize=t,this.chunks={},this.visibleChunks=new Set,this.sectorMap=new s.HexGridSectors(t)}getVisibleChunks(){return this.visibleChunks}getAllChunks(){return Object.values(this.chunks)}getByHex(e){return this.getById(this.sectorMap.getSectorOf(e))}getById(e){return n.getOrCreate(this.chunks,e,()=>new c(this,e))}add(e,t){const i=this.sectorMap.getSectorOf(e);return this.getById(i).add(t),t}remove(e,t){const i=this.sectorMap.getSectorOf(e);return this.getById(i).remove(t),t}getChunksInRect(e){return this.getAllChunks().filter(t=>Phaser.Geom.Intersects.RectangleToRectangle(e,t.boundingBox))}};class c{constructor(e,t){this.parent=e,this.visible=!1,this.id=t,this.group=new Phaser.GameObjects.Group(e.scene),this.visible=!1,this.boundingBox=a.rectToPhaser(a.multiplyRect(e.sectorMap.getSectorRect(t),r.HEX_WIDTH,r.HEX_INNER_HEIGHT))}add(e){return this.parent.scene.add.existing(e),this.group.add(e),this.visible?e.addToDisplayList():e.removeFromDisplayList(),e}remove(e){return this.group.remove(e),e}setVisible(e){if(e===this.visible)return;const t=this.group.getChildren();e?(this.visible=!0,this.parent.visibleChunks.add(this),t.forEach(e=>e.addToDisplayList())):(this.visible=!1,this.parent.visibleChunks.delete(this),t.forEach(e=>e.removeFromDisplayList()))}}t.Chunk=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HexGridSectors=void 0;const n=i(3);t.HexGridSectors=class{constructor(e){this.sectorSize=e,this.sectorsPerRow=Math.ceil(n.GRID_MAX_DIMENSION/this.sectorSize)}getSectorOf(e){const t=Math.floor(e.r/this.sectorSize),i=Math.floor(e.c/this.sectorSize);return t*this.sectorsPerRow+i}getSectorRect(e){return{x:e%this.sectorsPerRow*this.sectorSize-.5,y:Math.floor(e/this.sectorsPerRow)*this.sectorSize,width:this.sectorSize+.5,height:this.sectorSize+.5}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UiStateManager=void 0;const n=i(19),s=i(16),a=i(0);t.UiStateManager=class{constructor(){this.onChange=s.signal(),this.state={transitionsMode:n.TransitionsMode.Pretty}}get transitionsMode(){return a.inject.config.debug.skipTransitions?n.TransitionsMode.Disabled:this.state.transitionsMode}set transitionsMode(e){this.set({transitionsMode:e})}with(e,t){const i=this.state;this.set(Object.assign(Object.assign({},this.state),e)),t(),this.set(i)}set(e){this.state=e,this.onChange.fire(e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GridDebugLayersManager=void 0;const n=i(0),s=i(16),a=i(40);i(1).logger.for("DebugLayersManager");class r{constructor(){this.layers={},this.activeLayer=r.blankLayer,this.onActiveLayerUpdated=s.signal()}register(e){this.layers[e.name]=e,e.onChange(()=>this._layerChanged(e))}registerAndActivate(e){this.register(e),this.activate(e.name)}_layerChanged(e){e===this.activeLayer&&this.onActiveLayerUpdated.fire(this.activeLayer)}get(e){return this.layers[e]}activate(e){if(e){if(!this.layers[e])throw new Error("No debug layer found for name "+e);this.activeLayer=this.layers[e],n.inject.debugData.set("debugLayer",e)}else this.activeLayer=r.blankLayer,n.inject.debugData.clear("debugLayer");this.onActiveLayerUpdated.fire(this.activeLayer)}}t.GridDebugLayersManager=r,r.blankLayer={onChange:s.signal(),getMap:()=>new a.CustomHexGroupValuation(void 0),getDetail:()=>{},name:"blank"}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AIController=void 0;const s=i(0),a=i(14),r=i(1),o=i(229),d=i(231);r.logger.for("ai:controller");t.AIController=class{constructor(){this.checkpoints=[],this.debug=!1}play(e){return n(this,void 0,void 0,(function*(){this.gameController=s.inject.gameStateController,this.gameController.beginTransaction(),this.debug=!0===s.inject.config.debug.ai;const t=e.getRegions().filter(e=>e.isAlive()).sort((e,t)=>e.hexes.length-t.hexes.length),i=d.growthStrategy;for(let r of t){if(r.updateFrom(s.inject.gameStateController.currentState),!r.exists)continue;s.inject.debugData.set("AI",`faction ${e.id}, region ${r.id}`);const t=new o.RegionAIContext(r);t.debug=!0===s.inject.config.debug.ai||s.inject.config.debug.ai===r.id,yield i(t,e=>n(this,void 0,void 0,(function*(){return t.debug?yield s.inject.debugBreakpoint("AI: Before "+e.name):yield a.sleep(1),e(t)})))}this.gameController.commitTransaction()}))}}},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RegionAIContext=void 0;const s=i(230),a=n(i(7)),r=i(45),o=i(0),d=i(1),c=i(100);d.logger.for("ai:context"),a.default.Map([[1,1],[2,1],[3,1],[4,1]]);t.RegionAIContext=class{constructor(e){this.region=e,this.game=o.inject.gameStateController,this.currentScore=0,this.debug=!1,this.plays=[],this.unitSolver=new r.UnitSolver(o.inject.gameStateModel.rules,new c.BalancedGrowthArmyComposition(this.region)),this.marshal=new s.Marshal(this)}addPlay(e,t,i){if(this.plays.push({play:e,score:t,gameCheckpoint:this.game.createCheckpoint()}),this.game.executePlay(e),this.currentScore+=t,i){const e=this.game.model.units.getOccupyingUnit(i);e&&this.game.model.currentPhase.tapPawn(e)}this.updateAfterStateChange()}requestRollback(e){let t=e,i=void 0;for(;this.plays.length&&this.plays[this.plays.length-1].score<t;)i=this.plays.pop(),t-=i.score;return i&&this.game.restoreCheckpoint(i.gameCheckpoint),this.updateAfterStateChange(),t!==e}requestUnit(e){let t=0,i=void 0;return e.forEach((e,n)=>{const s=this.unitSolver.gather(Object.assign(Object.assign({},this.region.might),{requiredMight:n,allowOverkill:!1}));if(!s)return;const a=e*(s.attractiveness+1);a>t&&(t=a,i=s)}),i}updateAfterStateChange(){this.region.updateFrom(this.game.currentState)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getCostPerUnitOfMight=t.Marshal=t.RosterUnitRecipeType=void 0;const n=i(13),s=i(8),a=i(1),r=i(5),o=i(2),d=a.logger.for("ai:Marshal");!function(e){e.PickExisting="pick-existing",e.CombineUnits="combine-units",e.Buy="buy"}(t.RosterUnitRecipeType||(t.RosterUnitRecipeType={}));t.Marshal=class{constructor(e){this.ctx=e,this.model=this.ctx.game.model}executeUnitMovePlan(e,t,i){const n=[...t.useUnits],a=[...t.buyUnits];if(0===n.length){o.assert(1===a.length,`Unexpected plan - given there are no existing units to use, expected one unit to buy, instead got [${a}]`);const t=this.model.rules.unitByMight(a[0]).type;return!!this.freeUpHexIfFriendly(e)&&(this.ctx.addPlay(s.Plays.BuyPawn({pawnType:t,buyerRegionId:this.ctx.region.id,destinationHexId:e.id}),i,e),!0)}const r=n.shift();let c=this.getClosestMovableUnitByMight(e,r);for(o.assert.defined(c,"Marshal was unable to find unit with might "+r);n.length>0||a.length>0;){const e=c.hex;if(n[0]===c.might){const t=this.getClosestMovableUnitByMight(c.hex,n.shift(),[c]);o.assert.defined(t,`Failed to find a unit with might ${r} to merge into ${c}`),this.ctx.addPlay(s.Plays.MovePawn({pawnId:t.id,destinationHexId:e.id}),0)}else{if(a[0]!==c.might)return d.error(`Marshal failed to execute plan, unclear what to do next: current unit ${c}, unitsToUse [${n}], unitsToBuy [${a}]`),!1;{const t=this.model.rules.unitByMight(a.shift()).type;this.ctx.addPlay(s.Plays.BuyPawn({pawnType:t,buyerRegionId:this.ctx.region.id,destinationHexId:e.id}),0)}}c=this.model.units.getOccupyingUnit(e),o.assert.defined(c,"lost track of the current unit after move to "+e)}return!(e!==c.hex&&!this.freeUpHexIfFriendly(e))&&(this.ctx.addPlay(s.Plays.MovePawn({pawnId:c.id,destinationHexId:e.id}),i,e),!0)}getClosestMovableUnitByMight(e,t,i=[]){return this.model.pawns.findClosest(e,this.ctx.region.hexes,e=>!i.includes(e)&&this.model.currentPhase.isMovable(e)&&e.might===t)}executeDefensePlan(e,t,i){return t.defenderMight>0&&!this.placeDefender(e,t.defenderMight,i)?(d.warning("Marshal was unable execute planned hex defense."),!1):!(t.buildWallLevel>0&&!this.buildWall(e,t.buildWallLevel))||(d.warning(`Marshal was unable build level ${t.buildWallLevel} wall at ${e}.`),!1)}freeUpHexIfFriendly(e){if(this.model.regions.byHex(e)!==this.ctx.region)return!0;const t=this.model.pawns.findOne({hexes:e,traits:[n.PawnTraits.Unit]});if(t){const i=this.ctx.region.hexes.findClosest(e,e=>!this.model.units.isOccupied(e));return i?(this.ctx.addPlay(s.Plays.MovePawn({pawnId:t.id,destinationHexId:i.id}),0),!0):(d.warning(`Unable to free up space for defender on hex ${e} - there's nowhere to move obstructing unit ${t}`),!1)}return!0}placeDefender(e,t,i){const n=this.ctx.unitSolver.gather(Object.assign(Object.assign({},this.ctx.region.might),{requiredMight:t}));return n?this.executeUnitMovePlan(e,n,i):(d.error(`Marshal failed to execute defense - cannot gather unit with might at least ${t} to defend ${e}`),!1)}buildWall(e,t){const i=this.model.rules.wallByMight(t).type;return this.ctx.addPlay(s.Plays.BuyPawn({pawnType:i,buyerRegionId:this.ctx.region.id,destinationHexId:e.id}),0),!0}},t.getCostPerUnitOfMight=function(e){return e.rules.pawns(r.PawnType.Militia).cost}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.growthStrategy=void 0;const s=i(232),a=i(1),r=i(120);a.logger.for("ai:strategy");t.growthStrategy=(e,t)=>n(void 0,void 0,void 0,(function*(){for(;yield t(s.opportunistAttack););if(e.game.model.ai.getExposedHexes(e.region,50).length)for(e.requestRollback(1/0),yield t(r.protectHexes),e.requestRollback(50);yield t(s.opportunistAttack););for(;yield t(r.protectHexes););}))},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((n=n.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.printSummary=t.opportunistAttack=void 0;const a=i(68),r=i(0),o=i(14),d=s(i(7)),c=i(1),h=i(45),l=i(3);c.logger.for("ai:tactics");t.opportunistAttack=e=>n(void 0,void 0,void 0,(function*(){const t=d.default.Map(e.unitSolver.getObtainableUnits(e.region.might).map(t=>[t,new a.OpportunistAttackPriority(r.inject.gameStateModel).calculateFor(e.region,t)])).map(e=>e.peek()).filter(o.isDefined),i=e.requestUnit(t.map(e=>e.value));if(i){const n=t.get(i.might).value;return e.marshal.executeUnitMovePlan(l.getHex(t.get(i.might).id),i,n),!0}return!1})),t.printSummary=function(e,t,i){return`[opportunisticAttack (region ${e.region.id})]\n  I have ${e.region.might.remainingUnits} units and ${e.region.might.remainingGold}/${o.withSign(e.region.might.remainingIncome)}g left \n  Best moves:\n    ${t.map(({id:e,value:t},n)=>`${n===(null==i?void 0:i.might)?"✔":"×"} ${n}💂️ -> ⬡${e} (${t})`).join("\n    ")}   \n  Final plan: ${i?h.describePlan(i):"N/A"}\n`}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.debugBreakPointProvider=void 0;const s=i(0),a=i(27),r=i(8);t.debugBreakPointProvider=function(e){return n(this,void 0,void 0,(function*(){const t=s.inject.game.scene.getScene(a.Scenes.Debug);if(s.inject.config.debug.overlay)return s.inject.events.trigger(r.UserActions.SyncWithModel()),t.handleBreakpoint(e)}))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AppVersionManager=void 0;const n=i(1),s=i(0),a=i(16),r=n.logger.for("registerServiceWorker");t.AppVersionManager=class{constructor(){this.isNewVersionAvailable=!1,this.onNewVersionDetected=a.signal(),this.swRegistration=void 0}start(){if("serviceWorker"in navigator)if(s.inject.config.useServiceWorker){r.info("Registering service worker");let e=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{e||(e=!0,window.location.reload())}),navigator.serviceWorker.register("./sw.js").then(e=>{this.swRegistration=e,e.active&&this.showUpdatePromptAfterNewWorkerActivated()})}else navigator.serviceWorker.getRegistrations().then(e=>{for(let t of e)t.unregister()})}updateNow(){var e,t;if(!this.swRegistration)throw new Error("cannot update: no service worker registration available");this.swRegistration.waiting||r.warning("Ignoring app update request, no new version detected (no waiting service worker)"),null===(t=null===(e=this.swRegistration)||void 0===e?void 0:e.waiting)||void 0===t||t.postMessage("skipWaiting")}showUpdatePromptAfterNewWorkerActivated(){this.swRegistration&&function(e,t){if(!e)return;if(e.waiting)return t(e);e.installing&&i();function i(){e.installing.addEventListener("statechange",(function(){"installed"===this.state&&t(e)}))}e.addEventListener("updatefound",i)}(this.swRegistration,()=>this.promptUserToRefresh())}promptUserToRefresh(){this.isNewVersionAvailable=!0,this.onNewVersionDetected.fire(),window.confirm("New version available! OK to refresh?")&&this.updateNow()}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(27),s=i(0),a=i(8);class r extends Phaser.Scene{constructor(){super({key:n.Scenes.Preload})}preload(){this.load.spritesheet("coin","assets/img/coin-animated.png",{frameWidth:10,frameHeight:9}),this.load.multiatlas("atlas","assets/atlas.json","assets"),this.load.bitmapFont("debug","assets/fonts/debug.png","assets/fonts/debug.xml"),s.inject.audio.preload(this),s.inject.fonts.preload(this)}create(){var e,t;this.game.renderer.type!==Phaser.CANVAS?(this.cameras.main.setBackgroundColor("#9bd6f2"),s.inject.events.trigger(a.SystemEvents.EngineInitialized()),null===(t=null===(e=window.document.getElementById("phaser-game"))||void 0===e?void 0:e.classList)||void 0===t||t.remove("hidden")):document.getElementById("status").innerText="Your browser/device does not seem to support WebGL, which is required to run this game. Sorry!"}}t.default=r},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Cheats=t.PlayScene=void 0;const n=i(0),s=i(27),a=i(8),r=i(52),o=i(1),d=i(55),c=i(46),h=i(12),l=i(41),u=i(113),g=i(242),p=i(245),f=i(246),m=i(247),y=i(248),w=i(249),v=i(29),b=i(44),x=i(250),S=i(3),P=o.logger.for("ui:PlayScene");class M extends d.BaseScene{constructor(){super({key:s.Scenes.Play,subScenes:[s.Scenes.WorldMap,s.Scenes.PlayUI]}),this.gameStateController=n.inject.gameStateController,this.gameEventsBus=new u.TypedEventBus,this.mode=new l.BaseMode(this),this.latestSelectedRegionByFaction={},this.cheats=new H(this),this.pointerEventsController=new x.PointerEventsController}setMode(e){P.info(`⚙ entering ${e.name} (from ${this.mode.name})`),this.mode.deactivate(),this.mode=e,n.inject.debugData.set("playScene.mode",this.mode.name),e.activate(),e.handleNewHexUnderCursor(n.inject.worldUi.hexUnderCursor())}create(){super.create(),this.gameEventQueue=this.gameStateController.getEventQueue(),this.events.on("destroy",()=>{this.gameEventQueue.unsubscribe()}),this.worldMapScene=this.scene.get(s.Scenes.WorldMap),this.debugScene=this.scene.get(s.Scenes.Debug),this.uiScene=this.scene.get(s.Scenes.PlayUI),this.handleEventWhileActive(r.WorldMapEvents.PointerDown,e=>{const t=e.hexId&&S.getHex(e.hexId);t&&n.inject.config.debug.cheats&&e.flags&r.PointerEventFlags.AltClick?this.cheats.toggleTapped(t):this.pointerEventsController.handlePointerDown(this.getAvailableActionsForHex(e))}),this.handleEventWhileActive(r.WorldMapEvents.PointerUp,e=>{this.pointerEventsController.handlePointerUp(this.getAvailableActionsForHex(e))}),this.handleEventWhileActive(c.PlayUIActions.ShopPawnPointerDown,e=>{this.pointerEventsController.handlePointerDown(this.getAvailableActionsForShop(e))}),this.handleEventWhileActive(c.PlayUIActions.ShopPawnPointerUp,e=>{this.pointerEventsController.handlePointerUp(this.getAvailableActionsForShop(e))}),this.handleEventWhileActive(c.PlayUIActions.StoreDeskPointerDown,()=>{this.pointerEventsController.handlePointerDown({dropPawn:()=>(this.mode.handleReturnPawn(),!0),returnPawn:()=>this.mode.handleReturnPawn()})}),this.handleEventWhileActive(c.PlayUIActions.StoreDeskPointerUp,()=>{this.pointerEventsController.handlePointerUp({dropPawn:()=>(this.mode.handleReturnPawn(),!0),returnPawn:()=>this.mode.handleReturnPawn()})}),this.handleEventWhileActive(a.UserActions.EndTurn,()=>{this.mode.handleEndTurn()}),this.watchWhileActive(n.inject.worldUi.hexUnderCursor,e=>{this.mode.handleNewHexUnderCursor(e)}),this.watchWhileActive(n.inject.worldUi.selectedRegion,e=>{this.worldMapScene.setSelectedRegion(e),this.uiScene.refreshRegionPanel(),e&&e.faction&&(this.latestSelectedRegionByFaction[e.faction.id]=e)}),this.gameEventsBus.on(a.GameEvents.NewGameState,e=>g.handleNewGameState(this,e)).on(a.GameEvents.PawnMoved,e=>f.handlePawnMoved(this,e)).on(a.GameEvents.PawnBought,e=>m.handlePawnBought(this,e)).on(a.GameEvents.HexCaptured,e=>y.handleHexCaptured(this,e)).on(a.GameEvents.FactionTurnStarted,e=>w.handleFactionTurnStarted(this,e)).on(a.GameEvents.FactionEconomyUpdated,e=>p.handleFactionEconomyUpdated(this,e))}getAvailableActionsForHex(e){const t=void 0===e.hexId?void 0:S.getHex(e.hexId),i={endCameraDrag:()=>this.worldMapScene.cameraController.cameraDragManager.stopDragging(),startCameraDrag:()=>this.worldMapScene.cameraController.cameraDragManager.startDrag(),returnPawn:()=>this.mode.handleReturnPawn()};return t&&(this.mode.canDropPawn(t)&&(i.dropPawn=()=>this.mode.handleDropPawn(t)),this.mode.canSelectHex(t)&&(i.selectHex=()=>this.mode.handleSelectHex(t)),this.mode.canPickupPawn(t)&&(i.pickupPawn=()=>this.mode.handlePickupPawn(t))),i}getAvailableActionsForShop(e){return{pickupPawn:()=>this.mode.handlePickupPawnFromShop(e),dropPawn:t=>this.mode.handleDropPawnOnShop(e,t),returnPawn:()=>this.mode.handleReturnPawn()}}update(){for(;this.gameEventQueue.hasNext()&&this.mode.isReadyForMoreGameEvents();)this.gameEventsBus.trigger(this.gameEventQueue.next())}clearConquerableHexes(){this.conquerableHexes=h.HexGroup.empty,this.worldMapScene.conquerableHexesHighlight.set(this.conquerableHexes)}dropHeldPawnAtHex(e){return new Promise(t=>{const i=this.worldMapScene.getPawnObjectPositionOnScreen(e);this.uiScene.pawnHolder.dropPawn(i.x,i.y,i.scale,t)})}selectRegion(e){this.isRegionControllable(e)?(n.inject.audio.playEffect(v.SoundEffects.Click),n.inject.worldUi.selectedRegion.set(e)):n.inject.worldUi.selectedRegion.set(void 0),this.showConquerableHexesBasedOnSelectedRegion()}showConquerableHexesBasedOn(e){const t=n.inject.worldUi.selectedRegion();t?(this.conquerableHexes=n.inject.gameStateModel.units.getConquerableHexes(t,e),this.worldMapScene.conquerableHexesHighlight.set(this.conquerableHexes)):this.worldMapScene.conquerableHexesHighlight.clear()}showConquerableHexesBasedOnSelectedRegion(){var e;const t=n.inject.worldUi.selectedRegion();if(!t)return void this.worldMapScene.conquerableHexesHighlight.clear();const i=(null===(e=b.AI.getRegionMight(n.inject.gameStateModel.state,t.id))||void 0===e?void 0:e.remainingUnits.getStrongest())||0;this.conquerableHexes=n.inject.gameStateModel.units.getConquerableHexes(t,i),this.worldMapScene.conquerableHexesHighlight.set(this.conquerableHexes)}isRegionControllable(e){if(!e)return!1;const t=n.inject.gameStateModel;return t.factions.byRegion(e)===t.currentPhase.faction&&t.economy.townHexesOf(e).length>0}}t.PlayScene=M;class H{constructor(e){this.scene=e}toggleTapped(e){const t=n.inject.gameStateModel;let i=t.units.getOccupyingUnit(e);i&&(t.currentPhase.isTapped(i)?(t.currentPhase.unTapPawn(i),this.scene.worldMapScene.pawns.beginJumping([e.id])):(t.currentPhase.tapPawn(i),this.scene.worldMapScene.pawns.stopJumping([e.id])))}}t.Cheats=H},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PawnHolder=void 0;var n=Phaser.GameObjects.Image;const s=i(54);t.PawnHolder=class{constructor(e){this.scene=e}pickUpPawn(e,t,i,a=1){this.heldPawn=e,this.heldPawnImage=new n(this.scene,0,0,"atlas","pawns/"+e),this.scene.add.existing(this.heldPawnImage),this.pickupTween=this.scene.tweens.add({targets:this.heldPawnImage,x:{from:t,to:this.scene.input.activePointer.x},y:{from:i,to:this.scene.input.activePointer.y},scale:{from:a,to:1},duration:s.TIMING.pawnPickupTransition,ease:"Sine.easeInOut",onComplete:()=>{this.pickupTween=void 0}})}update(){!this.heldPawnImage||this.pickupTween||this.dropTween?this.pickupTween&&(this.pickupTween.updateTo("x",this.scene.input.activePointer.x,!0),this.pickupTween.updateTo("y",this.scene.input.activePointer.y,!0)):this.heldPawnImage.setPosition(this.scene.input.activePointer.x,this.scene.input.activePointer.y)}dropPawn(e,t,i,n){var a,r;const o=this.heldPawnImage;this.heldPawnImage=void 0,this.heldPawn=void 0,o&&(null===(a=this.pickupTween)||void 0===a||a.stop(),null===(r=this.dropTween)||void 0===r||r.stop(),this.dropTween=this.scene.tweens.add({targets:o,x:e,y:t,scale:i,duration:s.TIMING.pawnDropTransition,ease:"Sine.easeInOut",onComplete:()=>{o.destroy(),this.dropTween=void 0,n()}}))}clear(){var e;null===(e=this.heldPawnImage)||void 0===e||e.destroy(),this.heldPawnImage=void 0,this.heldPawn=void 0}setPawnType(e){var t;null===(t=this.heldPawnImage)||void 0===t||t.setFrame("pawns/"+e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ShoppingDesk=void 0;const n=i(6),s=i(1),a=i(46),r=i(0),o=i(19),d=i(73);var c=Phaser.GameObjects.Image,h=Phaser.GameObjects.Container;s.logger.for("ShoppingDesk");const l=16,u=60;t.ShoppingDesk=class extends h{constructor(e){super(e),this.pawnSprites={},this.shadows=[],this.displayedPawns=[],this.targetVisibility=!1,this.desk=new c(e,0,0,"atlas","ui/desk"),this.tablecloth=new c(e,0,2,"atlas","ui/desk-tablecloth"),this.tablecloth.setInteractive(),this.tablecloth.on("pointerdown",()=>r.inject.events.trigger(a.PlayUIActions.StoreDeskPointerDown())),this.tablecloth.on("pointerup",()=>r.inject.events.trigger(a.PlayUIActions.StoreDeskPointerUp())),this.add(this.desk),this.add(this.tablecloth),this.desk.setDepth(a.PlayUILayers.Desk),this.tablecloth.setDepth(a.PlayUILayers.TableCloth),this.scene.scale.on("resize",this.reflow,this),this.reflow()}get width(){return this.desk.width}setColor(e){this.tablecloth.setTint(e)}show(){this.targetVisibility||(this.targetVisibility=!0,r.inject.uiState.transitionsMode===o.TransitionsMode.Disabled?this.reflow():this.slideIn().then(()=>this.setVisible(this.targetVisibility)))}hide(){this.targetVisibility&&(this.targetVisibility=!1,r.inject.uiState.transitionsMode===o.TransitionsMode.Disabled?this.reflow():this.slideOut().then(()=>this.setVisible(this.targetVisibility)))}setDisplayedPawns(e){this.displayedPawns=e,Object.values(this.pawnSprites).forEach(e=>e.setVisible(!1)),e.forEach((e,t)=>{this.getOrCreatePawnImage(e,t).setVisible(!0)}),this.updatePawnSprites()}reflow(){const e=this.scene.cameras.main.displayHeight,t=this.scene.cameras.main.displayWidth;this.setVisible(this.targetVisibility),this.targetVisibility?this.setPosition(Math.round(t/2),e-this.getOffsetFromBottom()):this.setPosition(Math.round(t/2),e)}getOffsetFromBottom(){switch(r.inject.device.screenSize.get()){case d.ScreenSize.Large:return a.PLAY_UI_LAYOUT.desktop.shoppingDeskOffsetFromBottom;case d.ScreenSize.Small:return a.PLAY_UI_LAYOUT.compact.shoppingDeskOffsetFromBottom}}updatePawnSprites(){const e=u,t=Math.round(-e*(this.displayedPawns.length-1)/2);Object.values(this.pawnSprites).forEach(e=>e.setVisible(!1)),this.updateShadows(),this.displayedPawns.forEach((i,n)=>{this.getOrCreatePawnImage(i,n).setVisible(!0).setPosition(t+n*e,l)})}destroy(){Object.values(this.pawnSprites).forEach(e=>e.destroy()),this.pawnSprites={}}updateShadows(){const e=Math.round(-u*(this.displayedPawns.length-1)/2);for(let t=0;t<this.displayedPawns.length;++t)n.getOrCreate(this.shadows,t,()=>{const e=new c(this.scene,0,0,"atlas","pawn-shadow");return this.addAt(e,2),e}).setVisible(!0).setPosition(e+t*u,l);for(let e=this.displayedPawns.length;e<this.shadows.length;++e)this.shadows[e].setVisible(!1)}getOrCreatePawnImage(e,t){return n.getOrCreate(this.pawnSprites,e,()=>{const t=new c(this.scene,0,0,"atlas","pawns/"+e).setInteractive({cursor:"pointer"});return t.input.enabled=!0,t.on("pointerdown",()=>{this.targetVisibility&&r.inject.events.trigger(a.PlayUIActions.ShopPawnPointerDown(e))}),t.on("pointerup",()=>{this.targetVisibility&&r.inject.events.trigger(a.PlayUIActions.ShopPawnPointerUp(e))}),this.add(t),t})}getPawnSpriteByType(e){return this.pawnSprites[e]}slideIn(){return this.setVisible(!0),new Promise(e=>{this.scene.tweens.add({targets:this,y:this.scene.cameras.main.displayHeight-this.getOffsetFromBottom(),scale:1,ease:"Sine.easeOut",duration:a.PLAY_UI_LAYOUT.toggleBoardTweenDuration,onComplete:e})})}slideOut(){return new Promise(e=>{this.scene.tweens.add({targets:this,y:this.scene.cameras.main.displayHeight+40,scale:.5,ease:"Sine.easeOut",duration:a.PLAY_UI_LAYOUT.toggleBoardTweenDuration,onComplete:e})})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.layoutFromCenter=t.layoutFromRight=t.RegionLabelText=t.DesktopRegionLabel=t.CompactRegionLabel=void 0;var n=Phaser.GameObjects.Image,s=Phaser.GameObjects.BitmapText;const a=i(240),r=i(46),o=i(0),d=i(19),c=i(121),h=i(17),l=i(33),u=16,g=16;class p extends a.Plate{constructor(e){super(e,{x:0,y:0,width:100,height:r.PLAY_UI_LAYOUT.compact.labelHeight}),this.targetVisibility=!1;const t=this.size.width,i=u+g/2;this.totalGoldText=new m(e,t-u-64,i,"0").setOrigin(1,.5),this.goldIcon=new n(e,t-u-60,i,"atlas","ui/coin-icon").setOrigin(0,.5),this.goldBalanceText=new m(e,t-u-16,i,"+8").setOrigin(1,.5),this.trendIcon=new n(e,t-u-6,i,"atlas","ui/surplus-icon"),this.add(this.totalGoldText),this.add(this.goldIcon),this.add(this.goldBalanceText),this.add(this.trendIcon),this.scene.scale.on("resize",()=>this.reflow()),this.reflow()}reflow(){this.setVisible(this.targetVisibility);const e=this.scene.cameras.main.displayWidth,t=this.scene.cameras.main.displayHeight;this.targetVisibility?this.setPosition(r.PLAY_UI_LAYOUT.compact.labelOffsetFromSides,t-this.size.height):this.setPosition(r.PLAY_UI_LAYOUT.compact.labelOffsetFromSides,t-20),this.size.width=e-2*r.PLAY_UI_LAYOUT.compact.labelOffsetFromSides,this.updateSize(),this.updateLayout()}hide(){this.targetVisibility&&(this.targetVisibility=!1,o.inject.uiState.transitionsMode===d.TransitionsMode.Disabled?(this.setVisible(!1),this.reflow()):c.slideOut(this.scene,[this]).then(()=>this.setVisible(this.targetVisibility)))}show(){this.targetVisibility||(this.targetVisibility=!0,this.setVisible(!0),o.inject.uiState.transitionsMode===d.TransitionsMode.Disabled?(this.setVisible(!0),this.reflow()):c.slideIn(this.scene,[this],this.size.height).then(()=>this.setVisible(this.targetVisibility)))}setBuyingPawnInfo(e){}setRegionInfo({treasury:e,income:t,name:i}){this.totalGoldText.setText(e.toString()),this.goldBalanceText.setText((t>=0?"+":"")+t),this.trendIcon.setFrame(t>=0?"ui/surplus-icon":"ui/deficit-icon"),this.trendIcon.setVisible(0!==t),this.updateLayout()}updateLayout(){w(this.size.width/2,6,[this.totalGoldText,this.goldIcon,this.goldBalanceText,this.trendIcon])}}t.CompactRegionLabel=p;class f extends a.RoundedPlate{constructor(e){super(e,{x:0,y:0,width:330,height:71}),this.targetVisibility=!1;const t=this.size.width,i=u+g/2,s=i+1.5*g;this.regionIcon=new n(e,0+u,i,"atlas","pawns/town").setOrigin(0,.5),this.regionNameText=new m(e,0+u+24,i,"Kingdom"),this.totalGoldText=new m(e,t-u-64,i,"0").setOrigin(1,.5),this.goldIcon=new n(e,t-u-60,i,"atlas","ui/coin-icon").setOrigin(0,.5),this.goldBalanceText=new m(e,t-u-16,i,"+8").setOrigin(1,.5),this.trendIcon=new n(e,t-u-6,i,"atlas","ui/surplus-icon"),this.selectedPawnArrow=new n(e,0+u+12,s-2,"atlas","ui/arrow-icon"),this.selectedPawnText=new m(e,0+u+24,s,"").setFontSize(16),this.selectedPawnCostText=new m(e,0,s,"").setOrigin(1,.5).setFontSize(16),this.selectedPawnUpkeepText=new m(e,0,s,"").setOrigin(1,.5).setFontSize(16),this.add(this.regionIcon),this.add(this.regionNameText),this.add(this.totalGoldText),this.add(this.goldIcon),this.add(this.goldBalanceText),this.add(this.trendIcon),this.add(this.selectedPawnText),this.add(this.selectedPawnCostText),this.add(this.selectedPawnArrow),this.add(this.selectedPawnUpkeepText),this.clearSelectedPawnData(),this.scene.scale.on("resize",this.reflow,this),this.reflow()}show(){this.targetVisibility||(this.targetVisibility=!0,o.inject.uiState.transitionsMode===d.TransitionsMode.Disabled?(this.setVisible(!0),this.reflow()):this.slideIn().then(()=>this.setVisible(this.targetVisibility)))}hide(){this.targetVisibility&&(this.targetVisibility=!1,o.inject.uiState.transitionsMode===d.TransitionsMode.Disabled?(this.setVisible(!1),this.reflow()):this.slideOut().then(()=>this.setVisible(this.targetVisibility)))}setRegionInfo({name:e,income:t,treasury:i}){this.regionNameText.setText(e),this.totalGoldText.setText(i.toString()),this.goldBalanceText.setText((t>=0?"+":"")+t),this.trendIcon.setFrame(t>=0?"ui/surplus-icon":"ui/deficit-icon"),this.trendIcon.setVisible(0!==t),this.updateLayout()}setBuyingPawnInfo(e){if(e){const{name:t,cost:i,upkeep:n}=e;this.selectedPawnText.setText(t),this.selectedPawnCostText.setText("-"+i.toString()),this.selectedPawnUpkeepText.setText("-"+n.toString()),[this.selectedPawnArrow,this.selectedPawnText,this.selectedPawnCostText].forEach(e=>e.setVisible(!0)),this.selectedPawnUpkeepText.setVisible(!!n)}else this.clearSelectedPawnData()}clearSelectedPawnData(){[this.selectedPawnArrow,this.selectedPawnText,this.selectedPawnCostText,this.selectedPawnUpkeepText].forEach(e=>e.setVisible(!1))}reflow(){this.setVisible(this.targetVisibility),this.targetVisibility?(this.setPosition(this.scene.cameras.main.displayWidth/2-this.size.width/2,this.scene.cameras.main.displayHeight-r.PLAY_UI_LAYOUT.desktop.regionLabelOffsetFromBottom),this.setScale(1)):(this.setPosition(this.scene.cameras.main.displayWidth/2-this.size.width/4,this.scene.cameras.main.displayHeight),this.setScale(.5))}updateLayout(){y(this.size.width-u,6,[this.totalGoldText,this.goldIcon,this.goldBalanceText,this.trendIcon]),this.selectedPawnCostText.x=this.totalGoldText.x,this.selectedPawnUpkeepText.x=this.goldBalanceText.x}slideIn(){return this.setVisible(!0),new Promise(e=>{this.scene.tweens.add({targets:this,x:this.scene.cameras.main.displayWidth/2-this.size.width/2,y:this.scene.cameras.main.displayHeight-r.PLAY_UI_LAYOUT.desktop.regionLabelOffsetFromBottom,scale:1,ease:"Sine.easeOut",duration:r.PLAY_UI_LAYOUT.toggleBoardTweenDuration,onComplete:e})})}slideOut(){return new Promise(e=>{this.scene.tweens.add({targets:this,x:this.scene.cameras.main.displayWidth/2-this.size.width/4,y:this.scene.cameras.main.displayHeight+40,scale:.5,ease:"Sine.easeOut",duration:r.PLAY_UI_LAYOUT.toggleBoardTweenDuration,onComplete:e})})}}t.DesktopRegionLabel=f;class m extends s{constructor(e,t,i,n){super(e,t,i,l.BitmapFont.Main,n),this.setTint(5583648),this.setOrigin(0,.5)}}function y(e,t,i){let n=e;for(let e of i.reverse())e.x=n-(1-e.originX)*e.width,n=n-e.width-t}function w(e,t,i){let n=e-(i.map(e=>e.width).reduce(h.sum)+t*(i.length-1))/2;for(let e of i)e.x=n+e.originX*e.width,n=n+e.width+t}t.RegionLabelText=m,t.layoutFromRight=y,t.layoutFromCenter=w},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoundedPlate=t.Plate=t.ResizableFrame=void 0;var n=Phaser.GameObjects.Image,s=Phaser.GameObjects.TileSprite;class a extends Phaser.GameObjects.Container{constructor(e,t,i){super(e,i.x,i.y),this.size={width:i.width,height:i.height},e.add.existing(this),this.topLeftCorner=r(e,t,0),this.topEdge=o(e,t,1),this.topRightCorner=r(e,t,2),this.leftEdge=o(e,t,3),this.middle=o(e,t,4),this.rightEdge=o(e,t,5),this.bottomLeftCorner=r(e,t,6),this.bottomEdge=o(e,t,7),this.bottomRightCorner=r(e,t,8),this.add(this.topLeftCorner),this.add(this.topRightCorner),this.add(this.bottomLeftCorner),this.add(this.bottomRightCorner),this.add(this.topEdge),this.add(this.bottomEdge),this.add(this.leftEdge),this.add(this.rightEdge),this.add(this.middle),this.updateSize()}updateSize(){const e=this.size.height-this.topLeftCorner.height-this.bottomLeftCorner.height,t=this.size.width-this.topLeftCorner.width-this.topRightCorner.width;this.topRightCorner.setPosition(this.size.width-this.topRightCorner.width,0),this.bottomLeftCorner.setPosition(0,this.size.height-this.bottomLeftCorner.height),this.bottomRightCorner.setPosition(this.size.width-this.bottomRightCorner.width,this.size.height-this.bottomRightCorner.height),this.topEdge.setPosition(this.topLeftCorner.width,0),this.topEdge.setSize(t,this.topRightCorner.height),this.bottomEdge.setPosition(this.bottomLeftCorner.width,this.size.height-this.bottomLeftCorner.height),this.bottomEdge.setSize(t,this.bottomLeftCorner.height),this.leftEdge.setPosition(0,this.topRightCorner.height),this.leftEdge.setSize(this.topRightCorner.width,e),this.rightEdge.setPosition(this.size.width-this.topRightCorner.width,this.topLeftCorner.height),this.rightEdge.setSize(this.topRightCorner.width,e),this.middle.setPosition(this.topRightCorner.width-1,this.topRightCorner.height-1),this.middle.setSize(t+2,e+2)}}function r(e,t,i){return new n(e,0,0,"atlas",`${t}/tile-${i}`)}function o(e,t,i){const n=new s(e,0,0,100,100,"atlas",`${t}/tile-${i}`);return n.setOrigin(0,0),n}t.ResizableFrame=a;t.Plate=class extends a{constructor(e,t){super(e,"ui/plate",t)}};t.RoundedPlate=class extends a{constructor(e,t){super(e,"ui/rounded-plate",t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AdaptiveGameObject=void 0;var n=Phaser.GameObjects.Layer;const s=i(2);t.AdaptiveGameObject=class extends n{constructor(e,t={}){super(e),this.options=t,this.instances=new Map,this.factories=new Map,this.activeObject=null}addVariant(e,t){return this.factories.set(e,t),this}current(){return s.assert.defined(this.activeObject),this.activeObject}setVariant(e){let t=this.instances.get(e);if(!t){const i=this.factories.get(e);if(!i)throw new Error(`No factory found for key "${e}"`);t=i(),this.instances.set(e,t),this.options.commonInitializer&&this.options.commonInitializer(t)}this.activeObject!==t&&(this.activeObject&&this.remove(this.activeObject),this.add(t)),this.activeObject=t}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleNewGameState=void 0;const n=i(19),s=i(8),a=i(0),r=i(56),o=i(244),d=i(74);t.handleNewGameState=function(e,t){let i=a.inject.uiState.transitionsMode,c=!1;[s.NewGameStateContext.LoadedGameStateForDebug,s.NewGameStateContext.Undo].includes(t.context)&&(i=n.TransitionsMode.Disabled,c=!0),a.inject.uiState.with({transitionsMode:n.TransitionsMode.Disabled},()=>{e.worldMapScene.loadNewGameState(t.state),t.context!==s.NewGameStateContext.StartingNewGame&&t.context!==s.NewGameStateContext.RestoredSavedGame||e.worldMapScene.cameraController.center();const i=a.inject.worldUi.selectedRegion();c&&(null==i?void 0:i.exists)&&i.isAlive()?e.worldMapScene.setSelectedRegion(a.inject.worldUi.selectedRegion()):a.inject.worldUi.selectedRegion.set(void 0),e.uiScene.refreshRegionPanel()});const h=()=>{a.inject.gameStateModel.currentPhase.isLocalPlayerTurn()?(e.worldMapScene.pawns.beginJumping(a.inject.gameStateModel.currentPhase.getMovablePawns().map(e=>e.hex.id)),e.setMode(new r.PlayMode(e))):e.setMode(new d.SpectatorMode(e))};i!==n.TransitionsMode.Disabled?e.setMode(new o.CinematicMode(e,e.worldMapScene.cinematics.worldCreation,h)):h()}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BuyingPawnMode=void 0;const n=i(0),s=i(8),a=i(56),r=i(41),o=i(1),d=i(21),c=i(123),h=i(29),l=i(2),u=o.logger.for("BuyingPawnMode");class g extends r.BaseMode{constructor(e,t){super(e),this.buyingPawn=t,this.bought=!1}activate(){this.scene.showConquerableHexesBasedOn(this.buyingPawn),this.scene.worldMapScene.showHexDefenseMarkers(),n.inject.config.debug.ai&&n.inject.worldUi.selectedRegion()&&window.debug.opportunistAttackPriority(n.inject.worldUi.selectedRegion().id,n.inject.gameStateModel.rules.pawns(this.buyingPawn).might)}deactivate(){this.bought||(this.scene.uiScene.returnPawnToShop(this.buyingPawn,()=>{}),this.scene.pointerEventsController.abortPawnDrag()),this.scene.worldMapScene.hideHexDefenseMarkers()}canDropPawn(e){const t=n.inject.worldUi.selectedRegion();if(!t)return!1;const i=n.inject.gameStateModel.units.getDropPawnResult(e,this.buyingPawn,t);return i.type!==d.DropPawnResultType.Invalid||i.reason===d.InvalidDropPawnReason.PreventedByPawn}handleDropPawn(e){const t=this.buyingPawn,i=n.inject.worldUi.selectedRegion();l.assert.defined(t),l.assert.defined(i);const r=()=>(this.scene.uiScene.restockPawnInShop(this.buyingPawn),this.scene.dropHeldPawnAtHex(e.id).then(()=>{n.inject.gameStateController.executePlay(s.Plays.BuyPawn({pawnType:t,destinationHexId:e.id,buyerRegionId:n.inject.worldUi.selectedRegion().id})),n.inject.audio.playEffect(h.SoundEffects.Drop)})),o=n.inject.gameStateModel.units.getDropPawnResult(e,this.buyingPawn,i);switch(o.type){case d.DropPawnResultType.Reposition:case d.DropPawnResultType.EradicatePest:case d.DropPawnResultType.Combine:return r().then(()=>{this.bought=!0,this.scene.setMode(new a.PlayMode(this.scene))}),!0;case d.DropPawnResultType.Conquest:return this.bought=!0,this.scene.uiScene.restockPawnInShop(this.buyingPawn),n.inject.gameStateController.executePlay(s.Plays.BuyPawn({pawnType:t,destinationHexId:e.id,buyerRegionId:n.inject.worldUi.selectedRegion().id})),!0;case d.DropPawnResultType.Invalid:return n.inject.audio.playEffect(h.SoundEffects.Deny),o.reason===d.InvalidDropPawnReason.PreventedByPawn&&this.scene.worldMapScene.cinematics.tileDefense(e,o.blockers).play(),!1}}handleDropPawnOnShop(e,t){return l.assert.defined(this.buyingPawn),this.scene.uiScene.returnPawnToShop(this.buyingPawn,()=>{}),e!==this.buyingPawn&&t?(this.scene.uiScene.grabPawnFromShop(e),this.buyingPawn=e,this.scene.showConquerableHexesBasedOn(this.buyingPawn),!1):(this.scene.setMode(new a.PlayMode(this.scene)),!0)}handleReturnPawn(){l.assert.defined(this.buyingPawn),this.scene.uiScene.returnPawnToShop(this.buyingPawn,()=>{this.scene.setMode(new a.PlayMode(this.scene))})}handleHexCaptured(e){e.sourceHexId?u.warning(`ignoring hexCaptured as the capture originated from pawn at hex ${e.sourceHexId}, rather than freshly bought pawn`):(this.scene.dropHeldPawnAtHex(e.capturedHexId).then(()=>{e.coinTransactions&&(this.scene.worldMapScene.cinematics.coinTransaction(e.coinTransactions).play(),this.scene.worldMapScene.pawns.add(e.capturedHexId,this.buyingPawn)),n.inject.audio.playEffect(h.SoundEffects.Drop)}),this.scene.setMode(new a.PlayMode(this.scene)))}handleNewHexUnderCursor(e){c.updateHighlightWhileMovingPawn(this.scene,e,this.buyingPawn,n.inject.worldUi.selectedRegion())}}t.BuyingPawnMode=g},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CinematicMode=void 0;const n=i(41);class s extends n.BaseMode{constructor(e,t,i){super(e),this.cinematic=t,this.callback=i,this.callback||(this.callback=this.getDefaultCallback())}activate(){this.scene.uiScene.shoppingDesk.hide(),this.cinematic.play(this.callback)}getDefaultCallback(){const e=this.scene.mode;return()=>this.scene.setMode(e)}isReadyForMoreGameEvents(){return!1}}t.CinematicMode=s},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleFactionEconomyUpdated=void 0;const n=i(25),s=i(0),a=i(5);t.handleFactionEconomyUpdated=function(e,t){const i=new n.ParallelCinematic(e);s.inject.gameStateModel.currentPhase.isLocalPlayerTurn()?t.regionReports.forEach(t=>{i.add(e.worldMapScene.cinematics.coinTransaction(t.coinTransfers))}):t.regionReports.forEach(t=>{e.worldMapScene.coins.applyTransactions(t.coinTransfers)}),i.play(()=>{t.regionReports.forEach(t=>{t.unitsTurnedBandits.map(t=>{e.worldMapScene.pawns.replace(t,a.PawnType.Bandit)})})}),e.uiScene.refreshRegionPanel()}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handlePawnMoved=void 0;const n=i(74);t.handlePawnMoved=function(e,t){t.eradicatedPest&&(e.worldMapScene.pawns.destroy(t.destinationHexId),e.uiScene.refreshRegionPanel()),t.mergedInto?(e.worldMapScene.pawns.destroy(t.sourceHexId),e.worldMapScene.pawns.replace(t.destinationHexId,t.mergedInto),e.uiScene.refreshRegionPanel()):(e.worldMapScene.pawns.move(t.sourceHexId,t.destinationHexId),e.worldMapScene.pawns.show(t.destinationHexId),t.eradicatedPest?e.worldMapScene.pawns.stopJumping([t.destinationHexId]):e.mode.name!==n.SpectatorMode.name&&e.worldMapScene.pawns.beginJumping([t.destinationHexId]))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handlePawnBought=void 0;const n=i(72),s=i(0),a=i(13);t.handlePawnBought=function(e,t){const i=s.inject.gameStateModel.currentPhase.isLocalPlayerTurn();i?e.worldMapScene.cinematics.coinTransaction(t.payment).play():e.worldMapScene.coins.applyTransactions(t.payment),s.inject.gameStateModel.rules.pawns(t.pawnType).hasTrait(a.PawnTraits.Wall)?e.worldMapScene.tileBorders.setTileFortificationType(t.destinationHexId,n.getFortificationLevelByPawnType(t.pawnType)):(t.eradicatedPest&&e.worldMapScene.pawns.destroy(t.destinationHexId),t.mergedInto?e.worldMapScene.pawns.replace(t.destinationHexId,t.mergedInto):(e.worldMapScene.pawns.add(t.destinationHexId,t.pawnType),!t.eradicatedPest&&i&&e.worldMapScene.pawns.beginJumping([t.destinationHexId]))),e.uiScene.refreshRegionPanel()}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleHexCaptured=void 0;const n=i(0),s=i(72);t.handleHexCaptured=function(e,t){var i;const a=t.capturedHexId;t.retreat?e.worldMapScene.pawns.move(a,t.retreat.destinationHexId):t.destroyedPawns.length>0&&e.worldMapScene.pawns.destroy(a),e.worldMapScene.tiles.getByHex(a).setFaction(t.capturingFactionId),e.worldMapScene.tileBorders.setTileData(a,{regionId:t.newRegionId,fortificationLevel:s.FortificationLevel.Plains});const r={};t.additionalConvertedHexes.forEach(({regionId:e,hexes:t})=>{t.forEach(t=>{r[t]={regionId:e}})}),e.worldMapScene.tileBorders.updateTileData(r),[t.newRegionId,t.originalRegionId,...Object.keys(t.additionalConvertedHexes).map(e=>Number(e))].includes(null===(i=n.inject.worldUi.selectedRegion())||void 0===i?void 0:i.id)&&e.worldMapScene.selectedRegionHighlight.set(n.inject.worldUi.selectedRegion()),t.lootTransactions&&e.worldMapScene.cinematics.coinTransaction(t.lootTransactions).play(),e.mode.handleHexCaptured({sourceHexId:t.originatingHexId,capturedHexId:t.capturedHexId,capturingPawnId:t.capturingPawnId,coinTransactions:t.boughtPawnTransactions,capturingPawnType:t.capturingPawnType}),e.uiScene.refreshRegionPanel()}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleFactionTurnStarted=void 0;const n=i(0),s=i(56),a=i(8),r=i(74),o=i(5),d=i(2);t.handleFactionTurnStarted=function(e,t){const i=n.inject.gameStateModel.factions.byId(t);switch(d.assert.defined(i),i.controller){case o.FactionController.LocalUser:e.uiScene.setFactionColor(i.landColor||16777215);const t=e.latestSelectedRegionByFaction[i.id],d=t&&e.isRegionControllable(t)?t:i.getLargestRegion();d&&d.exists?n.inject.worldUi.selectedRegion.set(d):n.inject.worldUi.selectedRegion.set(void 0),e.worldMapScene.pawns.clearAllJumping(),e.time.addEvent({callback:()=>e.worldMapScene.pawns.beginJumping(n.inject.gameStateModel.currentPhase.getMovablePawns().map(e=>e.hex.id)),delay:1500}),e.setMode(new s.PlayMode(e));break;case o.FactionController.Ai:e.setMode(new r.SpectatorMode(e)),n.inject.ai.play(i).then(()=>{n.inject.gameStateController.executePlay(a.Plays.EndTurn())});break;case o.FactionController.None:n.inject.gameStateController.executePlay(a.Plays.EndTurn());break;default:throw new Error(`Faction ${i} uses unsupported controller ${i.controller}`)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PointerEventsController=t.PointerState=void 0;const n=i(1),s=i(0);var a;!function(e){e.Idle="idle",e.CameraHoldDrag="camera-drag",e.PawnJustPickedUp="pawn-just-picked-up",e.PawnHoldDrag="pawn-hold-drag",e.PawnClickDrag="pawn-click-drag"}(a=t.PointerState||(t.PointerState={}));n.logger.for("ui:PointerEventsController");t.PointerEventsController=class{constructor(){this.pointerState=a.Idle}handlePointerDown(e){switch(this.pointerState){case a.Idle:e.selectHex&&e.selectHex(),e.pickupPawn?(this.setState(a.PawnJustPickedUp),e.pickupPawn(),this.triggerDragHoldTimeout=setTimeout(this.transitionToHoldDrag.bind(this),200)):e.startCameraDrag&&(this.setState(a.CameraHoldDrag),e.startCameraDrag());break;case a.PawnClickDrag:e.dropPawn&&e.dropPawn(!0)&&this.setState(a.Idle)}}handlePointerUp(e){switch(this.pointerState){case a.PawnJustPickedUp:this.triggerDragHoldTimeout&&(clearTimeout(this.triggerDragHoldTimeout),this.triggerDragHoldTimeout=null),this.setState(a.PawnClickDrag);break;case a.PawnHoldDrag:e.dropPawn&&e.dropPawn(!1)||e.returnPawn&&e.returnPawn(),this.setState(a.Idle);break;case a.CameraHoldDrag:e.endCameraDrag&&e.endCameraDrag(),this.setState(a.Idle)}}setState(e){this.pointerState=e,e!==a.Idle?s.inject.debugData.set("playScene.pointerState",e):s.inject.debugData.clear("playScene.pointerState")}transitionToHoldDrag(){this.pointerState===a.PawnJustPickedUp&&this.setState(a.PawnHoldDrag)}abortPawnDrag(){[a.PawnClickDrag,a.PawnHoldDrag,a.PawnJustPickedUp].includes(this.pointerState)&&this.setState(a.Idle)}}},function(e,t,i){"use strict";var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{d(n.next(e))}catch(e){a(e)}}function o(e){try{d(n.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DebugScene=void 0;const s=i(75),a=i(27),r=i(0),o=i(14),d=i(4),c=i(9),h=i(33);class l extends s.Scene{constructor(){super({key:a.Scenes.Debug,pixelArt:!1}),this.debugData=r.inject.debugData,this.suppressBreakPoints=!1}create(){this.controller=r.inject.gameStateController,this.cursorPosLabel=new h.DebugTextBox(this,100,100,"(left, top)"),this.topLeftLabel=new h.DebugTextBox(this,10,40,"[left, top] - [left,top]",{dropShadow:!1}),this.pointer=this.input.activePointer,this.horizontalGuideLine=this.add.line(0,0,1,1).setOrigin(0,0).setStrokeStyle(1,255,.25),this.verticalGuideLine=this.add.line(0,0,1,1).setOrigin(0,0).setStrokeStyle(1,255,.25),this.breakpointLabel=this.add.text(0,0,"",{fontFamily:'"Monospace"',color:"#0000ff",fontSize:"24px"}).setVisible(!1).setOrigin(.5);const e=this.input.keyboard.addKey("N"),t=this.input.keyboard.addKey("C");e.on("down",e=>{this.resumeFromBreakpoint()}),t.on("down",e=>{this.suppressBreakPoints=!0,this.resumeFromBreakpoint(),setTimeout(()=>this.suppressBreakPoints=!1,3e3)}),r.inject.worldUi.hexUnderCursor.watch(e=>{if(e){const t=this.scene.get(a.Scenes.WorldMap).chunkedRenderer.getByHex(e);this.debugData.set("hexInfo",function(e,t){var i;try{const n=r.inject.gameStateModel,s=n.regions.byHex(e),a=n.factions.byHex(e),l=s?`\n⚐ ${s.name||"region"} #${s.id} ${function(e){const t=r.inject.gameStateModel;if(!d.isDataSetActive(t.state,c.GameState.economy.budgetByRegion))return"";const i=t.economy.budgetOf(e);return`(${e.hexes.length}${h.GLYPH.hex} ${t.economy.treasuryOf(e)}${h.GLYPH.coin}/${o.withSign(i.balance)})`}(s)}`:"",u=a?"\n owned by "+a:"",g=n.pawns.byHex(e).map(e=>`${e.type}${1!==e.count?" ×"+e.count:""} #${e.id} ${n.currentPhase.isMovable(e)?"👣":""}`).join("\n♖ "),p=g.length?"\n♖ "+g:"";let f="";return"blank"!==r.inject.debugLayers.activeLayer.name&&(f=`\n${r.inject.debugLayers.activeLayer.name}:\n  ${null===(i=r.inject.debugLayers.activeLayer.getDetail(e))||void 0===i?void 0:i.replace(/\n/g,"\n  ")}`),`${e}[chunk #${t}]${l}${u}${p}${f}`}catch(e){return"⛔ "+e.toString()}}(e,t.id))}else this.debugData.clear("hexInfo")})}resumeFromBreakpoint(){this.resumeFromBreakpointCallback&&(this.resumeFromBreakpointCallback(),this.resumeFromBreakpointCallback=void 0,this.breakpointLabel.setVisible(!1))}update(){const e=this.scene.get(a.Scenes.WorldMap);this.pointer.updateWorldPoint(e.cameras.main),this.cursorPosLabel.setText(`C(${Math.round(this.pointer.x)},${Math.round(this.pointer.y)}) W(${Math.round(this.pointer.worldX)},${Math.round(this.pointer.worldY)})\n${this.debugData.get("hexInfo")||""}`);const t=this.cameras.main;this.topLeftLabel.setText(`v1 ${t.width}x${t.height} ${Math.floor(this.game.loop.actualFps)} FPS\nscenes: ${this.game.scene.getScenes(!0).map(e=>e.scene.key).join(",")}\n${r.inject.debugData.getText()}`),this.cursorPosLabel.setPosition(this.pointer.x+20,this.pointer.y+20),this.horizontalGuideLine.setTo(0,this.pointer.y,this.cameras.main.width,this.pointer.y),this.verticalGuideLine.setTo(this.pointer.x,0,this.pointer.x,this.cameras.main.height)}handleBreakpoint(e){return n(this,void 0,void 0,(function*(){if(!this.suppressBreakPoints)return new Promise(t=>{this.resumeFromBreakpointCallback=t,this.breakpointLabel.setVisible(!0),this.breakpointLabel.setText("⏸️ "+e+"\n [N] step [C] continue"),this.breakpointLabel.setPosition(this.cameras.main.centerX,this.cameras.main.height-100)})}))}}t.DebugScene=l}]);